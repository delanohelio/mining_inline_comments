{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgxOTYwNTM1", "number": 211, "title": "Fix interceptor bugs uncovered by tests", "bodyText": "Thanks for taking the time to contribute. Please take a moment to fill out the information below.\nFixes #209 & #210.\nChanges Proposed in this pull request:\n\nCorrected the behavior of the LoggingInterceptor to adhere to the design guidelines.\nCorrected the behavior of the CurlLoggingInterceptor to adhere to the design guidelines.\nSubsequently made some changes to the LogUtils class considering the aforementioned.\n\nMore details can be found in each commit message of this PR.", "createdAt": "2020-03-01T00:04:21Z", "url": "https://github.com/Azure/azure-sdk-for-android/pull/211", "merged": true, "mergeCommit": {"oid": "c53f70a1ec6b37c35a4c49834706981544346887"}, "closed": true, "closedAt": "2020-03-13T20:48:00Z", "author": {"login": "vcolin7"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKg_fRAFqTM2OTIzNTYwOA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcNWjOWgFqTM3NDYwODc0NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MjM1NjA4", "url": "https://github.com/Azure/azure-sdk-for-android/pull/211#pullrequestreview-369235608", "createdAt": "2020-03-05T01:11:38Z", "commit": {"oid": "f7d7ecc07e7625df9c67856c57058d9e9ddb9a54"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQwMToxMTozOFrOFyDRmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQwMToxMTozOFrOFyDRmw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODAyNjc3OQ==", "bodyText": "What was causing this warning? It doesn't seem like it should be triggering.", "url": "https://github.com/Azure/azure-sdk-for-android/pull/211#discussion_r388026779", "createdAt": "2020-03-05T01:11:38Z", "author": {"login": "bsiegel"}, "path": "sdk/core/azure-core/src/main/java/com/azure/android/core/http/interceptor/LogUtils.java", "diffHunk": "@@ -40,33 +30,45 @@ static long getContentLength(Headers headers) {\n      * @return \"Log body\" if the body should be logged in its entirety, otherwise a message indicating why the body\n      * was not logged is returned.\n      */\n-    static String evaluateBody(Headers headers) {\n+    @SuppressWarnings(\"ConstantConditions\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7d7ecc07e7625df9c67856c57058d9e9ddb9a54"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MjM2MTgx", "url": "https://github.com/Azure/azure-sdk-for-android/pull/211#pullrequestreview-369236181", "createdAt": "2020-03-05T01:13:18Z", "commit": {"oid": "f7d7ecc07e7625df9c67856c57058d9e9ddb9a54"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQwMToxMzoxOFrOFyDTkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQwMToxMzoxOFrOFyDTkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODAyNzI4MQ==", "bodyText": "Why do these headers get special treatment?", "url": "https://github.com/Azure/azure-sdk-for-android/pull/211#discussion_r388027281", "createdAt": "2020-03-05T01:13:18Z", "author": {"login": "bsiegel"}, "path": "sdk/core/azure-core/src/main/java/com/azure/android/core/http/interceptor/LoggingInterceptor.java", "diffHunk": "@@ -96,24 +103,42 @@ public Response intercept(@NonNull Chain chain) throws IOException {\n      *\n      * @param request The HTTP request being sent to Azure.\n      */\n-    private void logRequest(final Request request) {\n+    private void logRequest(final Request request) throws IOException {\n         HttpUrl url = request.url();\n \n-        logger.info(\"--> [\" + request.header(CLIENT_REQUEST_ID) + \"]\"); // Request ID\n+        logger.info(\"--> [\" + request.header(REQUEST_ID_HEADER) + \"]\"); // Request ID\n         logger.info(request.method() + \" \" + url.encodedPath() + LogUtils.getRedactedQueryString(url,\n             allowedQueryParameterNames)); // URL path + query\n         logger.info(\"Host: \" + url.scheme() + \"://\" + url.host()); // URL host\n \n         // TODO: Add log level guard for headers and body.\n-        logHeaders(request.headers());\n-\n-        String bodyEvaluation = LogUtils.evaluateBody(request.headers());\n         RequestBody requestBody = request.body();\n+        boolean contentTypeLogged = false;\n+        boolean contentLengthLogged = false;\n+\n+        // According to the OkHttp documentation, the request body headers are only present when this is installed as a\n+        // network interceptor.\n+        // https://github.com/square/okhttp/blob/b189a382bccc1b9a01d4672210b69680d73b4306/okhttp-logging-interceptor/src/main/java/okhttp3/logging/HttpLoggingInterceptor.java#L173\n+        if (requestBody != null) {\n+            if (requestBody.contentType() != null  && allowedHeaderNames.contains(CONTENT_TYPE_HEADER)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7d7ecc07e7625df9c67856c57058d9e9ddb9a54"}, "originalPosition": 93}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MjM5NDM0", "url": "https://github.com/Azure/azure-sdk-for-android/pull/211#pullrequestreview-369239434", "createdAt": "2020-03-05T01:23:53Z", "commit": {"oid": "f7d7ecc07e7625df9c67856c57058d9e9ddb9a54"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQwMToyMzo1NFrOFyDfFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQwMToyMzo1NFrOFyDfFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODAzMDIyOQ==", "bodyText": "Definitely need to get rid of this magic string. Even if we made this into a constant, it's still a little suspicious. Why not name this method something like getBodySummary() and then if it returns null log the body text, otherwise log the summary?", "url": "https://github.com/Azure/azure-sdk-for-android/pull/211#discussion_r388030229", "createdAt": "2020-03-05T01:23:54Z", "author": {"login": "bsiegel"}, "path": "sdk/core/azure-core/src/main/java/com/azure/android/core/http/interceptor/LogUtils.java", "diffHunk": "@@ -40,33 +30,45 @@ static long getContentLength(Headers headers) {\n      * @return \"Log body\" if the body should be logged in its entirety, otherwise a message indicating why the body", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7d7ecc07e7625df9c67856c57058d9e9ddb9a54"}, "originalPosition": 44}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MjQwMDQ2", "url": "https://github.com/Azure/azure-sdk-for-android/pull/211#pullrequestreview-369240046", "createdAt": "2020-03-05T01:25:50Z", "commit": {"oid": "f7d7ecc07e7625df9c67856c57058d9e9ddb9a54"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ebfa2572982096786374e4deac2d64ec44b2daa8", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-android/commit/ebfa2572982096786374e4deac2d64ec44b2daa8", "committedDate": "2020-03-12T08:54:24Z", "message": "Refactor extraction of ContentType/ContentLength"}, "afterCommit": {"oid": "72b90d19ed9ab7b028fc620d4d31d6856f5109d3", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-android/commit/72b90d19ed9ab7b028fc620d4d31d6856f5109d3", "committedDate": "2020-03-12T09:45:30Z", "message": "Refactor extraction of ContentType/ContentLength"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b94ba2865b4dd3d162ce59d61f8aa7ac4fae1ea8", "author": {"user": {"login": "vcolin7", "name": null}}, "url": "https://github.com/Azure/azure-sdk-for-android/commit/b94ba2865b4dd3d162ce59d61f8aa7ac4fae1ea8", "committedDate": "2020-03-13T20:32:23Z", "message": "Fixed multiple problems with the LoggingInterceptor:\n\n1. We would not log the body of a request or response if the Content-Type was 'identity' or 'inline', when actually we should not log it when the value is 'gzip', 'attached' or 'compressed'.\n2. We would log the body of a request or response even if the Content-Length header is empty or not present.\n3. We would not log a request or response body if its size was smaller than a maximum value, when it should be the opposite (size > MAX_VALUE).\n4. We would generate a malformed query string when redacting sensitive data."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2738ffe86aabf3a28396da8f1b416664d984e519", "author": {"user": {"login": "vcolin7", "name": null}}, "url": "https://github.com/Azure/azure-sdk-for-android/commit/2738ffe86aabf3a28396da8f1b416664d984e519", "committedDate": "2020-03-13T20:32:23Z", "message": "Fixed another two issues with the LoggingInterceptor:\n\n1. We would try to add allowed headers and query parameters to an immutable empty set, instead of a mutable one.\n2. We would not catch and log internal failures (exceptions) when logging a request."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09b36dea1e32935e1ca16e21f8943f428f588273", "author": {"user": {"login": "vcolin7", "name": null}}, "url": "https://github.com/Azure/azure-sdk-for-android/commit/09b36dea1e32935e1ca16e21f8943f428f588273", "committedDate": "2020-03-13T20:32:23Z", "message": "Made more fixes to the LoggingInterceptor and CurlLoggingInterceptor:\n\nFor the LoggingInterceptor:\n\n1. Added ways for obtaining the Content-Length and Content-Type from the RequestBody and ResponseBody objects, in case they are somehow not set in the request or response headers.\n\nFor the CurlLoggingInterceptor:\n\n1. Removed the placeholder message that was logged if the request body was empty, not inline, not identity (gzip, compressed, etc.) or binary, to log the actual body of the request instead.\n2. Removed double quotation marks that surrounded the URL in the cURL command, since they are not necessary.\n3. Made a change to escape double quotation marks in header values instead of escaping them in the header names.\n4. Made a change to escape backslashes in header values.\n5. Made a change to add the --compressed flag when the Content-Encoding of the body is not 'identity', instead of adding it when the encoding is 'gzip'.\n6. Single quotation marks are escaped in the body now instead of double quotes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "534d0f7fbbda74a45760fad989d064da867522b8", "author": {"user": {"login": "vcolin7", "name": null}}, "url": "https://github.com/Azure/azure-sdk-for-android/commit/534d0f7fbbda74a45760fad989d064da867522b8", "committedDate": "2020-03-13T20:32:23Z", "message": "Addresses some comments left by @bsiegel in PR #211 (https://github.com/Azure/azure-sdk-for-android/pull/211)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89eabcacdede4f879161e5533d5971e647d01a9e", "author": {"user": {"login": "vcolin7", "name": null}}, "url": "https://github.com/Azure/azure-sdk-for-android/commit/89eabcacdede4f879161e5533d5971e647d01a9e", "committedDate": "2020-03-13T20:32:23Z", "message": "Added the @NonNull annotation to some parameters in LogUtils methods."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a7d56fc8e1a23b152ea6e42bcf64dd24c6a037b2", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-android/commit/a7d56fc8e1a23b152ea6e42bcf64dd24c6a037b2", "committedDate": "2020-03-13T20:32:23Z", "message": "Refactor extraction of ContentType/ContentLength"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cfdfedabf9ad3c17200b6aedc1f6b29af30e55a4", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-android/commit/cfdfedabf9ad3c17200b6aedc1f6b29af30e55a4", "committedDate": "2020-03-13T20:42:56Z", "message": "Extract HTTP header values to HttpHeader class"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f23215a806bd02e007a9f8a906ef0d26dcb49bb", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-android/commit/8f23215a806bd02e007a9f8a906ef0d26dcb49bb", "committedDate": "2020-03-13T20:42:56Z", "message": "Fix logic bugs in UserAgent & CurlLogging interceptors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13a011f394e03dda85ff8c28c958eca21e5395a0", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-android/commit/13a011f394e03dda85ff8c28c958eca21e5395a0", "committedDate": "2020-03-13T20:42:56Z", "message": "Re-integrate LogUtils back into LoggingInterceptor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "337662cac66d70d0a6bbdc88d8fe88e830577eef", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-android/commit/337662cac66d70d0a6bbdc88d8fe88e830577eef", "committedDate": "2020-03-13T20:42:56Z", "message": "Rename CoreUtils -> CoreUtil"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8fb7afacc44d187dfdaad9abc4e5b911aa9bc298", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-android/commit/8fb7afacc44d187dfdaad9abc4e5b911aa9bc298", "committedDate": "2020-03-13T20:42:56Z", "message": "DRY up AddDateInterceptor"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "acfae8aedd6402ef39b8015f3208777b5a294252", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-android/commit/acfae8aedd6402ef39b8015f3208777b5a294252", "committedDate": "2020-03-13T20:29:22Z", "message": "Rename CoreUtils -> CoreUtil"}, "afterCommit": {"oid": "8fb7afacc44d187dfdaad9abc4e5b911aa9bc298", "author": {"user": null}, "url": "https://github.com/Azure/azure-sdk-for-android/commit/8fb7afacc44d187dfdaad9abc4e5b911aa9bc298", "committedDate": "2020-03-13T20:42:56Z", "message": "DRY up AddDateInterceptor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0NjA4NzQ0", "url": "https://github.com/Azure/azure-sdk-for-android/pull/211#pullrequestreview-374608744", "createdAt": "2020-03-13T20:43:29Z", "commit": {"oid": "8fb7afacc44d187dfdaad9abc4e5b911aa9bc298"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1293, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}