{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY1MDU2NzA4", "number": 1309, "title": "TINKERPOP-2369 Replace Connection on server initiated Channel close", "bodyText": "https://issues.apache.org/jira/browse/TINKERPOP-2369\nMajor Change#1\nCurrent behaviour:\nThe client would do nothing on server initiated Channel close (applicable for cases when there were no active requests on the channel). This means that although the underlying Channel, a Connection would not be removed from the ConnectionPool. This would cause the load balancing logic to allocate a new request to a Connection which is already closed.\nNew behaviour:\nWith this change, we introduce a callback on Channel close which would remove the connection from the ConnectionPool and destroy it. This would ensure that any new request would not be assigned to the already closed Channel.\nMajor Change#2\nCurrent behaviour:\nOn failure of a request, we try to replaced the Connection from the ConnectionPool. If the Connection is dead, this attempt is done once per request. Since multiple requests can be assigned on the same Connection, the replace logic is called multiple times leading to multiple calls for new Connection creation even though only one Connection was impacted.\nNew behaviour:\nWith this change, we introduce a new lock on Connection which will ensure that replacement of a Connection is done only once.\nTesting\n\nAdded tests which fail before the fixes and then succeed after the changes.\nRan mvn clean install -DskipIntegrationTests=false locally for gremlin-server and gremlin-driver\nAll integ tests pass.\nFixed some integ tests where we weren't closing the client properly after the test has ended.\n\nDeployment plan\n\nMerge to 3.4-dev branch first and then merge 3.4-dev to master.\nChangelog has been updated.", "createdAt": "2020-08-08T17:46:48Z", "url": "https://github.com/apache/tinkerpop/pull/1309", "merged": true, "mergeCommit": {"oid": "b6a64aa07fba6c70c8727860112dd4e918017df3"}, "closed": true, "closedAt": "2020-08-22T01:02:17Z", "author": {"login": "divijvaidya"}, "timelineItems": {"totalCount": 41, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc88hTUgH2gAyNDY1MDU2NzA4OmE2OTBlNTBjYzA2NTUzNmU3MmRkYjJkMDZkMTlhOGI3Y2JkNmY2NzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdAzL0PAH2gAyNDY1MDU2NzA4OmY5YmZjMDI3YTUzZDE3MjVhMDkwMDkzNjUwMWQ5YjVjZDJjMDRlMDE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a690e50cc065536e72ddb2d06d19a8b7cbd6f671", "author": {"user": null}, "url": "https://github.com/apache/tinkerpop/commit/a690e50cc065536e72ddb2d06d19a8b7cbd6f671", "committedDate": "2020-08-08T17:32:13Z", "message": "TINKERPOP-2369 Replace Connection on server initiated Channel close\n\nWith this change, the following behaviour are modified:\n1. If server closes a Channel, the client would detect it and replace\n   the Connection. Prior to this change, the client would do nothing on\n   server initiated Channel close (applicable for cases when there were\n   no active requests on the channel).\n2. Do not throw a NPE when server sends a response for a request\n   which is not registered with the client. Ignore it silently.\n3. Ensure that replcement of a connection is done only once. Prior to\n   this change, for each failure of request using the connect, a new\n   connection was being created."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzODE3NDYw", "url": "https://github.com/apache/tinkerpop/pull/1309#pullrequestreview-463817460", "createdAt": "2020-08-08T17:48:10Z", "commit": {"oid": "a690e50cc065536e72ddb2d06d19a8b7cbd6f671"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOFQxNzo0ODoxMFrOG91M7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOFQxNzo0ODoxMFrOG91M7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzQ4Nzk4MA==", "bodyText": "This is an unused function. Removed to simplify code.", "url": "https://github.com/apache/tinkerpop/pull/1309#discussion_r467487980", "createdAt": "2020-08-08T17:48:10Z", "author": {"login": "divijvaidya"}, "path": "gremlin-driver/src/main/java/org/apache/tinkerpop/gremlin/driver/Connection.java", "diffHunk": "@@ -191,14 +209,6 @@ Client getClient() {\n         return future;\n     }\n \n-    public void close() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a690e50cc065536e72ddb2d06d19a8b7cbd6f671"}, "originalPosition": 82}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eab2d58d1931ff1dc5321a81beda155b6ddb8d22", "author": {"user": null}, "url": "https://github.com/apache/tinkerpop/commit/eab2d58d1931ff1dc5321a81beda155b6ddb8d22", "committedDate": "2020-08-08T19:10:56Z", "message": "Do not block executor thread to replace connection"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ee3d9596cca640ae900e40909988ba445d02a74", "author": {"user": null}, "url": "https://github.com/apache/tinkerpop/commit/2ee3d9596cca640ae900e40909988ba445d02a74", "committedDate": "2020-08-08T21:13:49Z", "message": "Do not replace connection if genuine closure"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28387d0a844a09ce449438ab421a8f0a921a241e", "author": {"user": null}, "url": "https://github.com/apache/tinkerpop/commit/28387d0a844a09ce449438ab421a8f0a921a241e", "committedDate": "2020-08-09T00:46:18Z", "message": "Register to recycle closed connection after first successfully connected"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6cbaee0b1793732894088e7b7442bdb4d05410d3", "author": {"user": null}, "url": "https://github.com/apache/tinkerpop/commit/6cbaee0b1793732894088e7b7442bdb4d05410d3", "committedDate": "2020-08-09T05:21:05Z", "message": "Revert some refactored changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cfc5ffd06cdcedcfde94e306113b38a1c5981126", "author": {"user": null}, "url": "https://github.com/apache/tinkerpop/commit/cfc5ffd06cdcedcfde94e306113b38a1c5981126", "committedDate": "2020-08-10T20:55:34Z", "message": "Make isBeingReplaced thread safe"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b42ac5b2012f45acfcb989a4082d935cd361db8", "author": {"user": {"login": "divijvaidya", "name": "Divij Vaidya"}}, "url": "https://github.com/apache/tinkerpop/commit/6b42ac5b2012f45acfcb989a4082d935cd361db8", "committedDate": "2020-08-10T21:21:15Z", "message": "Merge branch '3.4-dev' into TINKERPOP-2369"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92813ba3e4f12f6f620e87684d78c15739782d43", "author": {"user": null}, "url": "https://github.com/apache/tinkerpop/commit/92813ba3e4f12f6f620e87684d78c15739782d43", "committedDate": "2020-08-11T01:16:33Z", "message": "Adding debug logs to test integ failures"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8652e6944056dc99a58fff8ea673a5cab3c3659d", "author": {"user": null}, "url": "https://github.com/apache/tinkerpop/commit/8652e6944056dc99a58fff8ea673a5cab3c3659d", "committedDate": "2020-08-11T01:16:48Z", "message": "Merge branch 'TINKERPOP-2369' of github.com:divijvaidya/tinkerpop into TINKERPOP-2369"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fef829769442173b3aff01c358a9730ec46d5cb9", "author": {"user": null}, "url": "https://github.com/apache/tinkerpop/commit/fef829769442173b3aff01c358a9730ec46d5cb9", "committedDate": "2020-08-11T02:03:52Z", "message": "Add debugging code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "963c21135f78eaa6e9bcd0149a13366252cf4a29", "author": {"user": null}, "url": "https://github.com/apache/tinkerpop/commit/963c21135f78eaa6e9bcd0149a13366252cf4a29", "committedDate": "2020-08-11T02:04:43Z", "message": "Fix typo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "63e9fbd7229cdf719e2ff15244aa5c92aaf673d7", "author": {"user": null}, "url": "https://github.com/apache/tinkerpop/commit/63e9fbd7229cdf719e2ff15244aa5c92aaf673d7", "committedDate": "2020-08-11T19:39:56Z", "message": "Add debug logs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "488c81f7f4aac8a9927094c63da1aa920ce97348", "author": {"user": null}, "url": "https://github.com/apache/tinkerpop/commit/488c81f7f4aac8a9927094c63da1aa920ce97348", "committedDate": "2020-08-11T21:23:46Z", "message": "don't use event loop to process response"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9503a64901a6e8bff25214678dd9c0006a7163cb", "author": {"user": null}, "url": "https://github.com/apache/tinkerpop/commit/9503a64901a6e8bff25214678dd9c0006a7163cb", "committedDate": "2020-08-11T21:29:57Z", "message": "Add more debug logs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "536dc31afae480f4382d517678f3c58e69af6cd8", "author": {"user": null}, "url": "https://github.com/apache/tinkerpop/commit/536dc31afae480f4382d517678f3c58e69af6cd8", "committedDate": "2020-08-11T23:05:01Z", "message": "Debug logs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1368ed3d9edf441101f585de5ad491eb5cac4ada", "author": {"user": null}, "url": "https://github.com/apache/tinkerpop/commit/1368ed3d9edf441101f585de5ad491eb5cac4ada", "committedDate": "2020-08-12T00:44:32Z", "message": "Revert cconnect close code to debug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8501850bcc311810e2795b49761b53f73a9c8318", "author": {"user": null}, "url": "https://github.com/apache/tinkerpop/commit/8501850bcc311810e2795b49761b53f73a9c8318", "committedDate": "2020-08-12T01:14:19Z", "message": "Add back on close channel code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93fe2be98da8929efd9f7dbe4bd8903f8764c95b", "author": {"user": null}, "url": "https://github.com/apache/tinkerpop/commit/93fe2be98da8929efd9f7dbe4bd8903f8764c95b", "committedDate": "2020-08-12T01:52:07Z", "message": "Selective addition of code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1365234e8a4b190435c4a076a1d710eaeec2b380", "author": {"user": null}, "url": "https://github.com/apache/tinkerpop/commit/1365234e8a4b190435c4a076a1d710eaeec2b380", "committedDate": "2020-08-12T02:28:47Z", "message": "add more code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da21f3afcd0df6df1d1cc6ba2a917dd639c9f633", "author": {"user": null}, "url": "https://github.com/apache/tinkerpop/commit/da21f3afcd0df6df1d1cc6ba2a917dd639c9f633", "committedDate": "2020-08-12T03:09:32Z", "message": "add more code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11d4b7a857b53f592252e434fdb622f157eafe84", "author": {"user": null}, "url": "https://github.com/apache/tinkerpop/commit/11d4b7a857b53f592252e434fdb622f157eafe84", "committedDate": "2020-08-12T20:37:06Z", "message": "Add debug lines"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8eca4b14d43f6baebf2b9e29f32b1196f3dc763", "author": {"user": null}, "url": "https://github.com/apache/tinkerpop/commit/e8eca4b14d43f6baebf2b9e29f32b1196f3dc763", "committedDate": "2020-08-12T20:42:21Z", "message": "adddebug logs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "877b8161077fd77d999c66c9bc63e95de9b41bd2", "author": {"user": null}, "url": "https://github.com/apache/tinkerpop/commit/877b8161077fd77d999c66c9bc63e95de9b41bd2", "committedDate": "2020-08-12T22:00:07Z", "message": "Only destroy broken connection and not recycle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9558a744e5d82135935f8a7cf1f8821d9285dc99", "author": {"user": null}, "url": "https://github.com/apache/tinkerpop/commit/9558a744e5d82135935f8a7cf1f8821d9285dc99", "committedDate": "2020-08-12T22:46:08Z", "message": "Add atomic boolen to determine a connectio ppol status"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92884e27e62797a72584eb69cbba1dbea69139b2", "author": {"user": null}, "url": "https://github.com/apache/tinkerpop/commit/92884e27e62797a72584eb69cbba1dbea69139b2", "committedDate": "2020-08-12T23:35:29Z", "message": "revert code for onclose destroy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b435657501653f5075e3dc6ce5f6eb439fa7ae3", "author": {"user": null}, "url": "https://github.com/apache/tinkerpop/commit/9b435657501653f5075e3dc6ce5f6eb439fa7ae3", "committedDate": "2020-08-12T23:58:27Z", "message": "Fix bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a575f45e7226c4e92a2d6a3d4bff1e57c2681b37", "author": {"user": null}, "url": "https://github.com/apache/tinkerpop/commit/a575f45e7226c4e92a2d6a3d4bff1e57c2681b37", "committedDate": "2020-08-13T00:55:47Z", "message": "Disable all tests except server kerberos"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "952b79c633a261a24599247cb4922effa328274d", "author": {"user": null}, "url": "https://github.com/apache/tinkerpop/commit/952b79c633a261a24599247cb4922effa328274d", "committedDate": "2020-08-13T01:19:33Z", "message": "Add back on close behaviour"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5b050c7428c90b64a096e55aed7d4206fd9664c", "author": {"user": null}, "url": "https://github.com/apache/tinkerpop/commit/b5b050c7428c90b64a096e55aed7d4206fd9664c", "committedDate": "2020-08-13T01:22:14Z", "message": "add exception to debug logs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07ae33e754fdcadfa5a8a6ed44df9aaa8c7764b5", "author": {"user": null}, "url": "https://github.com/apache/tinkerpop/commit/07ae33e754fdcadfa5a8a6ed44df9aaa8c7764b5", "committedDate": "2020-08-13T01:37:07Z", "message": "Add more tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "096ccf11bd0112d1d77623659372bbca4b4d118c", "author": {"user": null}, "url": "https://github.com/apache/tinkerpop/commit/096ccf11bd0112d1d77623659372bbca4b4d118c", "committedDate": "2020-08-13T01:55:19Z", "message": "Enable all kerberos tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0043a6e8bb724c61bd09f0cdccc029dace580ce1", "author": {"user": null}, "url": "https://github.com/apache/tinkerpop/commit/0043a6e8bb724c61bd09f0cdccc029dace580ce1", "committedDate": "2020-08-13T23:11:53Z", "message": "Code clean up"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dbc58845eafad53f67189c97309f66f8e20ee8d7", "author": {"user": null}, "url": "https://github.com/apache/tinkerpop/commit/dbc58845eafad53f67189c97309f66f8e20ee8d7", "committedDate": "2020-08-13T23:35:40Z", "message": "Remove unnecessary changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d68bdb6e13a5832f0bd97fc43399c1e9ef2c1ac5", "author": {"user": null}, "url": "https://github.com/apache/tinkerpop/commit/d68bdb6e13a5832f0bd97fc43399c1e9ef2c1ac5", "committedDate": "2020-08-14T00:55:33Z", "message": "Remove a new behaviour in throwing exceptions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98e28387229d62890ae34cbd9f97d48172324514", "author": {"user": null}, "url": "https://github.com/apache/tinkerpop/commit/98e28387229d62890ae34cbd9f97d48172324514", "committedDate": "2020-08-14T20:02:15Z", "message": "Fix integ tests which don't close clients"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aace59212264632340824435e80f42f20f136ba8", "author": {"user": null}, "url": "https://github.com/apache/tinkerpop/commit/aace59212264632340824435e80f42f20f136ba8", "committedDate": "2020-08-14T20:40:50Z", "message": "Fix bug in promise completion"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e0ce6a96d27dcb5aceb7e61ec73ece08dffd1ed", "author": {"user": null}, "url": "https://github.com/apache/tinkerpop/commit/2e0ce6a96d27dcb5aceb7e61ec73ece08dffd1ed", "committedDate": "2020-08-14T21:55:33Z", "message": "Only destroy the connection. don't replace"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52ddb1581f54b954448faa2354ec2f77f877ed2f", "author": {"user": null}, "url": "https://github.com/apache/tinkerpop/commit/52ddb1581f54b954448faa2354ec2f77f877ed2f", "committedDate": "2020-08-15T00:05:03Z", "message": "cosmetic changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "235257b991d098d61ec298b78b4835a3099647c3", "author": {"user": null}, "url": "https://github.com/apache/tinkerpop/commit/235257b991d098d61ec298b78b4835a3099647c3", "committedDate": "2020-08-15T00:19:26Z", "message": "changelog update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9bfc027a53d1725a0900936501d9b5cd2c04e01", "author": {"user": null}, "url": "https://github.com/apache/tinkerpop/commit/f9bfc027a53d1725a0900936501d9b5cd2c04e01", "committedDate": "2020-08-20T16:55:18Z", "message": "Rename tests"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4361, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}