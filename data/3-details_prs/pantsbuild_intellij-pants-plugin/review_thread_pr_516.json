{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA1MTUzMzky", "number": 516, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxNDoyODoxNFrODy7GUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxMDoxODozMlrOD3-ypQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NzIzNjY1OnYy", "diffSide": "RIGHT", "path": "src/com/twitter/intellij/pants/ui/PantsToBspProjectAction.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxNDoyODoxNFrOGHQTfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxMDozMjozMFrOGIN9xw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI2MDM0OQ==", "bodyText": "Instead of hardcoding a version here I think we can use latest.stable instead, which will let Coursier figure out the latest stable Metals version.", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/516#discussion_r410260349", "createdAt": "2020-04-17T14:28:14Z", "author": {"login": "olafurpg"}, "path": "src/com/twitter/intellij/pants/ui/PantsToBspProjectAction.java", "diffHunk": "@@ -0,0 +1,130 @@\n+// Copyright 2020 Pants project contributors (see CONTRIBUTORS.md).\n+// Licensed under the Apache License, Version 2.0 (see LICENSE).\n+\n+package com.twitter.intellij.pants.ui;\n+\n+import com.intellij.execution.configurations.GeneralCommandLine;\n+import com.intellij.ide.impl.OpenProjectTask;\n+import com.intellij.ide.impl.ProjectUtil;\n+import com.intellij.openapi.actionSystem.AnAction;\n+import com.intellij.openapi.actionSystem.AnActionEvent;\n+import com.intellij.openapi.application.ApplicationManager;\n+import com.intellij.openapi.progress.ProgressIndicator;\n+import com.intellij.openapi.progress.ProgressManager;\n+import com.intellij.openapi.progress.Task;\n+import com.intellij.openapi.project.DumbAware;\n+import com.intellij.openapi.project.Project;\n+import com.intellij.openapi.ui.Messages;\n+import com.twitter.intellij.pants.settings.PantsSettings;\n+import com.twitter.intellij.pants.util.PantsUtil;\n+import org.apache.commons.io.IOUtils;\n+import org.jetbrains.annotations.NotNull;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+public class PantsToBspProjectAction extends AnAction implements DumbAware {\n+  private static final String METALS_VERSION = \"0.8.4\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad30af80ce2b33358897a30135f3934f2400a79b"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTI3MDU5OQ==", "bodyText": "I expected coursier to have something like this, but didn't find it initially. Changed.", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/516#discussion_r411270599", "createdAt": "2020-04-20T10:32:30Z", "author": {"login": "lukaszwawrzyk"}, "path": "src/com/twitter/intellij/pants/ui/PantsToBspProjectAction.java", "diffHunk": "@@ -0,0 +1,130 @@\n+// Copyright 2020 Pants project contributors (see CONTRIBUTORS.md).\n+// Licensed under the Apache License, Version 2.0 (see LICENSE).\n+\n+package com.twitter.intellij.pants.ui;\n+\n+import com.intellij.execution.configurations.GeneralCommandLine;\n+import com.intellij.ide.impl.OpenProjectTask;\n+import com.intellij.ide.impl.ProjectUtil;\n+import com.intellij.openapi.actionSystem.AnAction;\n+import com.intellij.openapi.actionSystem.AnActionEvent;\n+import com.intellij.openapi.application.ApplicationManager;\n+import com.intellij.openapi.progress.ProgressIndicator;\n+import com.intellij.openapi.progress.ProgressManager;\n+import com.intellij.openapi.progress.Task;\n+import com.intellij.openapi.project.DumbAware;\n+import com.intellij.openapi.project.Project;\n+import com.intellij.openapi.ui.Messages;\n+import com.twitter.intellij.pants.settings.PantsSettings;\n+import com.twitter.intellij.pants.util.PantsUtil;\n+import org.apache.commons.io.IOUtils;\n+import org.jetbrains.annotations.NotNull;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+public class PantsToBspProjectAction extends AnAction implements DumbAware {\n+  private static final String METALS_VERSION = \"0.8.4\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI2MDM0OQ=="}, "originalCommit": {"oid": "ad30af80ce2b33358897a30135f3934f2400a79b"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NzM1MDQ2OnYy", "diffSide": "RIGHT", "path": "resources/META-INF/plugin.xml", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxNDo1NzozMFrOGHRdLA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxMDozMjowMlrOGIN8wA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI3OTIxMg==", "bodyText": "To avoid confusion whether this action modifies the existing Pants project. Is it too verbose? We could also call it \"Create new BSP project\" \ud83e\udd14\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                          text=\"Convert to BSP project\">\n          \n          \n            \n                          text=\"Create new BSP project based on this Pants project\">", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/516#discussion_r410279212", "createdAt": "2020-04-17T14:57:30Z", "author": {"login": "olafurpg"}, "path": "resources/META-INF/plugin.xml", "diffHunk": "@@ -73,6 +73,10 @@\n               class=\"com.twitter.intellij.pants.compiler.actions.PantsCompileCurrentTargetAction\"\n               text=\"Compile target(s) in the selected editor\">\n       </action>\n+      <action id=\"com.twitter.intellij.pants.ui.PantsToBspProjectAction\"\n+              class=\"com.twitter.intellij.pants.ui.PantsToBspProjectAction\"\n+              text=\"Convert to BSP project\">", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad30af80ce2b33358897a30135f3934f2400a79b"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTI3MDMzNg==", "bodyText": "I did it with the longer one, I think we have space for it :)", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/516#discussion_r411270336", "createdAt": "2020-04-20T10:32:02Z", "author": {"login": "lukaszwawrzyk"}, "path": "resources/META-INF/plugin.xml", "diffHunk": "@@ -73,6 +73,10 @@\n               class=\"com.twitter.intellij.pants.compiler.actions.PantsCompileCurrentTargetAction\"\n               text=\"Compile target(s) in the selected editor\">\n       </action>\n+      <action id=\"com.twitter.intellij.pants.ui.PantsToBspProjectAction\"\n+              class=\"com.twitter.intellij.pants.ui.PantsToBspProjectAction\"\n+              text=\"Convert to BSP project\">", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI3OTIxMg=="}, "originalCommit": {"oid": "ad30af80ce2b33358897a30135f3934f2400a79b"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2MDQxNzQwOnYy", "diffSide": "RIGHT", "path": "src/com/twitter/intellij/pants/ui/PantsToBspProjectAction.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxMDo1NjowNlrOGI_ipw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxMzoyNzowMFrOGLXpJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjA4Mjg1NQ==", "bodyText": "It looks like these are absolute paths since the generated project is named .Users.lgeirsson.workspace.source...\n\nI think we can fix this by stripping the prefix containing the absolute path to the Pants workspace away\n- INFO  process: /Users/lgeirsson/workspace/source/pants ... /Users/lgeirsson/workspace/source/buildcache::\n+ INFO  process: /Users/lgeirsson/workspace/source/pants ... buildcache::", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/516#discussion_r412082855", "createdAt": "2020-04-21T10:56:06Z", "author": {"login": "olafurpg"}, "path": "src/com/twitter/intellij/pants/ui/PantsToBspProjectAction.java", "diffHunk": "@@ -0,0 +1,165 @@\n+// Copyright 2020 Pants project contributors (see CONTRIBUTORS.md).\n+// Licensed under the Apache License, Version 2.0 (see LICENSE).\n+\n+package com.twitter.intellij.pants.ui;\n+\n+import com.intellij.execution.configurations.GeneralCommandLine;\n+import com.intellij.ide.impl.OpenProjectTask;\n+import com.intellij.ide.impl.ProjectUtil;\n+import com.intellij.ide.util.PropertiesComponent;\n+import com.intellij.openapi.actionSystem.AnAction;\n+import com.intellij.openapi.actionSystem.AnActionEvent;\n+import com.intellij.openapi.application.ApplicationManager;\n+import com.intellij.openapi.progress.ProgressIndicator;\n+import com.intellij.openapi.progress.ProgressManager;\n+import com.intellij.openapi.progress.Task;\n+import com.intellij.openapi.project.DumbAware;\n+import com.intellij.openapi.project.Project;\n+import com.intellij.openapi.ui.Messages;\n+import com.intellij.openapi.vfs.LocalFileSystem;\n+import com.twitter.intellij.pants.settings.PantsSettings;\n+import com.twitter.intellij.pants.util.PantsUtil;\n+import org.apache.commons.io.IOUtils;\n+import org.jetbrains.annotations.NotNull;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.function.Consumer;\n+import java.util.stream.Collectors;\n+\n+public class PantsToBspProjectAction extends AnAction implements DumbAware {\n+  private static final String BSP_LINKED_PROJECT_PATH = \"bsp.linked_project_path\";\n+\n+  @Override\n+  public void update(@NotNull AnActionEvent e) {\n+    Project project = e.getProject();\n+    boolean isPants = project != null && PantsUtil.isPantsProject(project);\n+    e.getPresentation().setEnabledAndVisible(isPants);\n+    if (isPants) {\n+      dependingOnBspProjectExistence(\n+        project,\n+        () -> e.getPresentation().setText(\"Create new BSP project based on this Pants project\"),\n+        linkedBspProject -> e.getPresentation().setText(\"Open linked BSP project\")\n+      );\n+    }\n+  }\n+\n+  @Override\n+  public void actionPerformed(AnActionEvent e) {\n+    Project project = e.getProject();\n+    if (project == null) {\n+      Messages.showInfoMessage(\"Project not found.\", \"Error\");\n+      return;\n+    }\n+    dependingOnBspProjectExistence(\n+      project,\n+      () -> createBspProject(project),\n+      linkedBspProject -> ProjectUtil.openOrImport(Paths.get(linkedBspProject), new OpenProjectTask())\n+    );\n+  }\n+\n+  private void createBspProject(Project project) {\n+    ProgressManager.getInstance().run(new Task.Backgroundable(project, \"Preparing BSP Project\", false) {\n+      @Override\n+      public void run(@NotNull ProgressIndicator indicator) {\n+        try {\n+          GeneralCommandLine commandLine = createCommandLine(project);\n+          Process process = commandLine.createProcess();\n+          String output = readToString(process.getInputStream());\n+          String outputErr = readToString(process.getErrorStream());\n+          int result = process.waitFor();\n+          if (result != 0) {\n+            String message = formatError(output, outputErr);\n+            throw new RuntimeException(message);\n+          }\n+          else {\n+            Path projectPath = Paths.get(output).toAbsolutePath();\n+            PropertiesComponent.getInstance(project).setValue(BSP_LINKED_PROJECT_PATH, projectPath.toString());\n+            ProjectUtil.openOrImport(projectPath, new OpenProjectTask());\n+          }\n+        }\n+        catch (Exception ex) {\n+          ApplicationManager.getApplication()\n+            .invokeLater(() -> Messages.showErrorDialog(project, ex.getMessage(), \"Error\"));\n+        }\n+      }\n+    });\n+  }\n+\n+  private GeneralCommandLine createCommandLine(Project project) throws IOException {\n+    GeneralCommandLine commandLine = PantsUtil.defaultCommandLine(project);\n+\n+    String coursier = coursierPath().toString();\n+    commandLine.setExePath(coursier);\n+\n+    //String name = project.getName();\n+    List<String> commandBase = Arrays.asList(\n+      \"launch\", \"org.scalameta:metals_2.12:latest.stable\",\n+      \"--main\", \"scala.meta.internal.pantsbuild.BloopPants\",\n+      \"--\",\n+      \"create\",\n+      \"--intellij\",\n+      \"--intellijLauncher\", \"echo\"\n+    );\n+    commandLine.addParameters(commandBase);\n+\n+    List<String> targets = pantsTargets(project);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4faf3e61e343c892c6c6ce8c51e1d4c29517e414"}, "originalPosition": 113}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjg5MzI1OQ==", "bodyText": "@olafurpg I will push potential fix, Yet I couldn't reproduce. If you could tell me how you setup the pants project to get this problem I could test it.\nI just take bsp-pants repo on branch scratchfile, I do import pants project pointing to 'scratchfile' directory and proceed with defaults. This results in targets being a List(\"scratchfile/::\") and project is named \"scratchfile.\".", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/516#discussion_r412893259", "createdAt": "2020-04-22T11:17:24Z", "author": {"login": "lukaszwawrzyk"}, "path": "src/com/twitter/intellij/pants/ui/PantsToBspProjectAction.java", "diffHunk": "@@ -0,0 +1,165 @@\n+// Copyright 2020 Pants project contributors (see CONTRIBUTORS.md).\n+// Licensed under the Apache License, Version 2.0 (see LICENSE).\n+\n+package com.twitter.intellij.pants.ui;\n+\n+import com.intellij.execution.configurations.GeneralCommandLine;\n+import com.intellij.ide.impl.OpenProjectTask;\n+import com.intellij.ide.impl.ProjectUtil;\n+import com.intellij.ide.util.PropertiesComponent;\n+import com.intellij.openapi.actionSystem.AnAction;\n+import com.intellij.openapi.actionSystem.AnActionEvent;\n+import com.intellij.openapi.application.ApplicationManager;\n+import com.intellij.openapi.progress.ProgressIndicator;\n+import com.intellij.openapi.progress.ProgressManager;\n+import com.intellij.openapi.progress.Task;\n+import com.intellij.openapi.project.DumbAware;\n+import com.intellij.openapi.project.Project;\n+import com.intellij.openapi.ui.Messages;\n+import com.intellij.openapi.vfs.LocalFileSystem;\n+import com.twitter.intellij.pants.settings.PantsSettings;\n+import com.twitter.intellij.pants.util.PantsUtil;\n+import org.apache.commons.io.IOUtils;\n+import org.jetbrains.annotations.NotNull;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.function.Consumer;\n+import java.util.stream.Collectors;\n+\n+public class PantsToBspProjectAction extends AnAction implements DumbAware {\n+  private static final String BSP_LINKED_PROJECT_PATH = \"bsp.linked_project_path\";\n+\n+  @Override\n+  public void update(@NotNull AnActionEvent e) {\n+    Project project = e.getProject();\n+    boolean isPants = project != null && PantsUtil.isPantsProject(project);\n+    e.getPresentation().setEnabledAndVisible(isPants);\n+    if (isPants) {\n+      dependingOnBspProjectExistence(\n+        project,\n+        () -> e.getPresentation().setText(\"Create new BSP project based on this Pants project\"),\n+        linkedBspProject -> e.getPresentation().setText(\"Open linked BSP project\")\n+      );\n+    }\n+  }\n+\n+  @Override\n+  public void actionPerformed(AnActionEvent e) {\n+    Project project = e.getProject();\n+    if (project == null) {\n+      Messages.showInfoMessage(\"Project not found.\", \"Error\");\n+      return;\n+    }\n+    dependingOnBspProjectExistence(\n+      project,\n+      () -> createBspProject(project),\n+      linkedBspProject -> ProjectUtil.openOrImport(Paths.get(linkedBspProject), new OpenProjectTask())\n+    );\n+  }\n+\n+  private void createBspProject(Project project) {\n+    ProgressManager.getInstance().run(new Task.Backgroundable(project, \"Preparing BSP Project\", false) {\n+      @Override\n+      public void run(@NotNull ProgressIndicator indicator) {\n+        try {\n+          GeneralCommandLine commandLine = createCommandLine(project);\n+          Process process = commandLine.createProcess();\n+          String output = readToString(process.getInputStream());\n+          String outputErr = readToString(process.getErrorStream());\n+          int result = process.waitFor();\n+          if (result != 0) {\n+            String message = formatError(output, outputErr);\n+            throw new RuntimeException(message);\n+          }\n+          else {\n+            Path projectPath = Paths.get(output).toAbsolutePath();\n+            PropertiesComponent.getInstance(project).setValue(BSP_LINKED_PROJECT_PATH, projectPath.toString());\n+            ProjectUtil.openOrImport(projectPath, new OpenProjectTask());\n+          }\n+        }\n+        catch (Exception ex) {\n+          ApplicationManager.getApplication()\n+            .invokeLater(() -> Messages.showErrorDialog(project, ex.getMessage(), \"Error\"));\n+        }\n+      }\n+    });\n+  }\n+\n+  private GeneralCommandLine createCommandLine(Project project) throws IOException {\n+    GeneralCommandLine commandLine = PantsUtil.defaultCommandLine(project);\n+\n+    String coursier = coursierPath().toString();\n+    commandLine.setExePath(coursier);\n+\n+    //String name = project.getName();\n+    List<String> commandBase = Arrays.asList(\n+      \"launch\", \"org.scalameta:metals_2.12:latest.stable\",\n+      \"--main\", \"scala.meta.internal.pantsbuild.BloopPants\",\n+      \"--\",\n+      \"create\",\n+      \"--intellij\",\n+      \"--intellijLauncher\", \"echo\"\n+    );\n+    commandLine.addParameters(commandBase);\n+\n+    List<String> targets = pantsTargets(project);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjA4Mjg1NQ=="}, "originalCommit": {"oid": "4faf3e61e343c892c6c6ce8c51e1d4c29517e414"}, "originalPosition": 113}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDU3NDg4NA==", "bodyText": "That fixed the issue. Thanks!", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/516#discussion_r414574884", "createdAt": "2020-04-24T13:27:00Z", "author": {"login": "olafurpg"}, "path": "src/com/twitter/intellij/pants/ui/PantsToBspProjectAction.java", "diffHunk": "@@ -0,0 +1,165 @@\n+// Copyright 2020 Pants project contributors (see CONTRIBUTORS.md).\n+// Licensed under the Apache License, Version 2.0 (see LICENSE).\n+\n+package com.twitter.intellij.pants.ui;\n+\n+import com.intellij.execution.configurations.GeneralCommandLine;\n+import com.intellij.ide.impl.OpenProjectTask;\n+import com.intellij.ide.impl.ProjectUtil;\n+import com.intellij.ide.util.PropertiesComponent;\n+import com.intellij.openapi.actionSystem.AnAction;\n+import com.intellij.openapi.actionSystem.AnActionEvent;\n+import com.intellij.openapi.application.ApplicationManager;\n+import com.intellij.openapi.progress.ProgressIndicator;\n+import com.intellij.openapi.progress.ProgressManager;\n+import com.intellij.openapi.progress.Task;\n+import com.intellij.openapi.project.DumbAware;\n+import com.intellij.openapi.project.Project;\n+import com.intellij.openapi.ui.Messages;\n+import com.intellij.openapi.vfs.LocalFileSystem;\n+import com.twitter.intellij.pants.settings.PantsSettings;\n+import com.twitter.intellij.pants.util.PantsUtil;\n+import org.apache.commons.io.IOUtils;\n+import org.jetbrains.annotations.NotNull;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.function.Consumer;\n+import java.util.stream.Collectors;\n+\n+public class PantsToBspProjectAction extends AnAction implements DumbAware {\n+  private static final String BSP_LINKED_PROJECT_PATH = \"bsp.linked_project_path\";\n+\n+  @Override\n+  public void update(@NotNull AnActionEvent e) {\n+    Project project = e.getProject();\n+    boolean isPants = project != null && PantsUtil.isPantsProject(project);\n+    e.getPresentation().setEnabledAndVisible(isPants);\n+    if (isPants) {\n+      dependingOnBspProjectExistence(\n+        project,\n+        () -> e.getPresentation().setText(\"Create new BSP project based on this Pants project\"),\n+        linkedBspProject -> e.getPresentation().setText(\"Open linked BSP project\")\n+      );\n+    }\n+  }\n+\n+  @Override\n+  public void actionPerformed(AnActionEvent e) {\n+    Project project = e.getProject();\n+    if (project == null) {\n+      Messages.showInfoMessage(\"Project not found.\", \"Error\");\n+      return;\n+    }\n+    dependingOnBspProjectExistence(\n+      project,\n+      () -> createBspProject(project),\n+      linkedBspProject -> ProjectUtil.openOrImport(Paths.get(linkedBspProject), new OpenProjectTask())\n+    );\n+  }\n+\n+  private void createBspProject(Project project) {\n+    ProgressManager.getInstance().run(new Task.Backgroundable(project, \"Preparing BSP Project\", false) {\n+      @Override\n+      public void run(@NotNull ProgressIndicator indicator) {\n+        try {\n+          GeneralCommandLine commandLine = createCommandLine(project);\n+          Process process = commandLine.createProcess();\n+          String output = readToString(process.getInputStream());\n+          String outputErr = readToString(process.getErrorStream());\n+          int result = process.waitFor();\n+          if (result != 0) {\n+            String message = formatError(output, outputErr);\n+            throw new RuntimeException(message);\n+          }\n+          else {\n+            Path projectPath = Paths.get(output).toAbsolutePath();\n+            PropertiesComponent.getInstance(project).setValue(BSP_LINKED_PROJECT_PATH, projectPath.toString());\n+            ProjectUtil.openOrImport(projectPath, new OpenProjectTask());\n+          }\n+        }\n+        catch (Exception ex) {\n+          ApplicationManager.getApplication()\n+            .invokeLater(() -> Messages.showErrorDialog(project, ex.getMessage(), \"Error\"));\n+        }\n+      }\n+    });\n+  }\n+\n+  private GeneralCommandLine createCommandLine(Project project) throws IOException {\n+    GeneralCommandLine commandLine = PantsUtil.defaultCommandLine(project);\n+\n+    String coursier = coursierPath().toString();\n+    commandLine.setExePath(coursier);\n+\n+    //String name = project.getName();\n+    List<String> commandBase = Arrays.asList(\n+      \"launch\", \"org.scalameta:metals_2.12:latest.stable\",\n+      \"--main\", \"scala.meta.internal.pantsbuild.BloopPants\",\n+      \"--\",\n+      \"create\",\n+      \"--intellij\",\n+      \"--intellijLauncher\", \"echo\"\n+    );\n+    commandLine.addParameters(commandBase);\n+\n+    List<String> targets = pantsTargets(project);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjA4Mjg1NQ=="}, "originalCommit": {"oid": "4faf3e61e343c892c6c6ce8c51e1d4c29517e414"}, "originalPosition": 113}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2MTgzODgzOnYy", "diffSide": "RIGHT", "path": "src/com/twitter/intellij/pants/ui/PantsToBspProjectAction.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNjoxMzoyNFrOGJM0bQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNjo0MTo0OFrOGJNvpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjMwMDM5Nw==", "bodyText": "cc/ @wiwa can you elaborate on what is needed in order to collect the correct metrics here?", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/516#discussion_r412300397", "createdAt": "2020-04-21T16:13:24Z", "author": {"login": "olafurpg"}, "path": "src/com/twitter/intellij/pants/ui/PantsToBspProjectAction.java", "diffHunk": "@@ -0,0 +1,165 @@\n+// Copyright 2020 Pants project contributors (see CONTRIBUTORS.md).\n+// Licensed under the Apache License, Version 2.0 (see LICENSE).\n+\n+package com.twitter.intellij.pants.ui;\n+\n+import com.intellij.execution.configurations.GeneralCommandLine;\n+import com.intellij.ide.impl.OpenProjectTask;\n+import com.intellij.ide.impl.ProjectUtil;\n+import com.intellij.ide.util.PropertiesComponent;\n+import com.intellij.openapi.actionSystem.AnAction;\n+import com.intellij.openapi.actionSystem.AnActionEvent;\n+import com.intellij.openapi.application.ApplicationManager;\n+import com.intellij.openapi.progress.ProgressIndicator;\n+import com.intellij.openapi.progress.ProgressManager;\n+import com.intellij.openapi.progress.Task;\n+import com.intellij.openapi.project.DumbAware;\n+import com.intellij.openapi.project.Project;\n+import com.intellij.openapi.ui.Messages;\n+import com.intellij.openapi.vfs.LocalFileSystem;\n+import com.twitter.intellij.pants.settings.PantsSettings;\n+import com.twitter.intellij.pants.util.PantsUtil;\n+import org.apache.commons.io.IOUtils;\n+import org.jetbrains.annotations.NotNull;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.function.Consumer;\n+import java.util.stream.Collectors;\n+\n+public class PantsToBspProjectAction extends AnAction implements DumbAware {\n+  private static final String BSP_LINKED_PROJECT_PATH = \"bsp.linked_project_path\";\n+\n+  @Override\n+  public void update(@NotNull AnActionEvent e) {\n+    Project project = e.getProject();\n+    boolean isPants = project != null && PantsUtil.isPantsProject(project);\n+    e.getPresentation().setEnabledAndVisible(isPants);\n+    if (isPants) {\n+      dependingOnBspProjectExistence(\n+        project,\n+        () -> e.getPresentation().setText(\"Create new BSP project based on this Pants project\"),\n+        linkedBspProject -> e.getPresentation().setText(\"Open linked BSP project\")\n+      );\n+    }\n+  }\n+\n+  @Override\n+  public void actionPerformed(AnActionEvent e) {\n+    Project project = e.getProject();\n+    if (project == null) {\n+      Messages.showInfoMessage(\"Project not found.\", \"Error\");\n+      return;\n+    }\n+    dependingOnBspProjectExistence(\n+      project,\n+      () -> createBspProject(project),\n+      linkedBspProject -> ProjectUtil.openOrImport(Paths.get(linkedBspProject), new OpenProjectTask())\n+    );\n+  }\n+\n+  private void createBspProject(Project project) {\n+    ProgressManager.getInstance().run(new Task.Backgroundable(project, \"Preparing BSP Project\", false) {\n+      @Override\n+      public void run(@NotNull ProgressIndicator indicator) {\n+        try {\n+          GeneralCommandLine commandLine = createCommandLine(project);\n+          Process process = commandLine.createProcess();\n+          String output = readToString(process.getInputStream());\n+          String outputErr = readToString(process.getErrorStream());\n+          int result = process.waitFor();\n+          if (result != 0) {\n+            String message = formatError(output, outputErr);\n+            throw new RuntimeException(message);\n+          }\n+          else {\n+            Path projectPath = Paths.get(output).toAbsolutePath();\n+            PropertiesComponent.getInstance(project).setValue(BSP_LINKED_PROJECT_PATH, projectPath.toString());\n+            ProjectUtil.openOrImport(projectPath, new OpenProjectTask());\n+          }\n+        }\n+        catch (Exception ex) {\n+          ApplicationManager.getApplication()\n+            .invokeLater(() -> Messages.showErrorDialog(project, ex.getMessage(), \"Error\"));\n+        }\n+      }\n+    });\n+  }\n+\n+  private GeneralCommandLine createCommandLine(Project project) throws IOException {\n+    GeneralCommandLine commandLine = PantsUtil.defaultCommandLine(project);\n+\n+    String coursier = coursierPath().toString();\n+    commandLine.setExePath(coursier);\n+\n+    //String name = project.getName();\n+    List<String> commandBase = Arrays.asList(\n+      \"launch\", \"org.scalameta:metals_2.12:latest.stable\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4faf3e61e343c892c6c6ce8c51e1d4c29517e414"}, "originalPosition": 104}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjMwNDMyMg==", "bodyText": "We need to be able to have a fastpass.properties config file on the classpath as implemented in https://github.com/scalameta/metals/pull/1582/files#diff-1ff86c347afd6af0342fc1157784b735R39", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/516#discussion_r412304322", "createdAt": "2020-04-21T16:25:02Z", "author": {"login": "wiwa"}, "path": "src/com/twitter/intellij/pants/ui/PantsToBspProjectAction.java", "diffHunk": "@@ -0,0 +1,165 @@\n+// Copyright 2020 Pants project contributors (see CONTRIBUTORS.md).\n+// Licensed under the Apache License, Version 2.0 (see LICENSE).\n+\n+package com.twitter.intellij.pants.ui;\n+\n+import com.intellij.execution.configurations.GeneralCommandLine;\n+import com.intellij.ide.impl.OpenProjectTask;\n+import com.intellij.ide.impl.ProjectUtil;\n+import com.intellij.ide.util.PropertiesComponent;\n+import com.intellij.openapi.actionSystem.AnAction;\n+import com.intellij.openapi.actionSystem.AnActionEvent;\n+import com.intellij.openapi.application.ApplicationManager;\n+import com.intellij.openapi.progress.ProgressIndicator;\n+import com.intellij.openapi.progress.ProgressManager;\n+import com.intellij.openapi.progress.Task;\n+import com.intellij.openapi.project.DumbAware;\n+import com.intellij.openapi.project.Project;\n+import com.intellij.openapi.ui.Messages;\n+import com.intellij.openapi.vfs.LocalFileSystem;\n+import com.twitter.intellij.pants.settings.PantsSettings;\n+import com.twitter.intellij.pants.util.PantsUtil;\n+import org.apache.commons.io.IOUtils;\n+import org.jetbrains.annotations.NotNull;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.function.Consumer;\n+import java.util.stream.Collectors;\n+\n+public class PantsToBspProjectAction extends AnAction implements DumbAware {\n+  private static final String BSP_LINKED_PROJECT_PATH = \"bsp.linked_project_path\";\n+\n+  @Override\n+  public void update(@NotNull AnActionEvent e) {\n+    Project project = e.getProject();\n+    boolean isPants = project != null && PantsUtil.isPantsProject(project);\n+    e.getPresentation().setEnabledAndVisible(isPants);\n+    if (isPants) {\n+      dependingOnBspProjectExistence(\n+        project,\n+        () -> e.getPresentation().setText(\"Create new BSP project based on this Pants project\"),\n+        linkedBspProject -> e.getPresentation().setText(\"Open linked BSP project\")\n+      );\n+    }\n+  }\n+\n+  @Override\n+  public void actionPerformed(AnActionEvent e) {\n+    Project project = e.getProject();\n+    if (project == null) {\n+      Messages.showInfoMessage(\"Project not found.\", \"Error\");\n+      return;\n+    }\n+    dependingOnBspProjectExistence(\n+      project,\n+      () -> createBspProject(project),\n+      linkedBspProject -> ProjectUtil.openOrImport(Paths.get(linkedBspProject), new OpenProjectTask())\n+    );\n+  }\n+\n+  private void createBspProject(Project project) {\n+    ProgressManager.getInstance().run(new Task.Backgroundable(project, \"Preparing BSP Project\", false) {\n+      @Override\n+      public void run(@NotNull ProgressIndicator indicator) {\n+        try {\n+          GeneralCommandLine commandLine = createCommandLine(project);\n+          Process process = commandLine.createProcess();\n+          String output = readToString(process.getInputStream());\n+          String outputErr = readToString(process.getErrorStream());\n+          int result = process.waitFor();\n+          if (result != 0) {\n+            String message = formatError(output, outputErr);\n+            throw new RuntimeException(message);\n+          }\n+          else {\n+            Path projectPath = Paths.get(output).toAbsolutePath();\n+            PropertiesComponent.getInstance(project).setValue(BSP_LINKED_PROJECT_PATH, projectPath.toString());\n+            ProjectUtil.openOrImport(projectPath, new OpenProjectTask());\n+          }\n+        }\n+        catch (Exception ex) {\n+          ApplicationManager.getApplication()\n+            .invokeLater(() -> Messages.showErrorDialog(project, ex.getMessage(), \"Error\"));\n+        }\n+      }\n+    });\n+  }\n+\n+  private GeneralCommandLine createCommandLine(Project project) throws IOException {\n+    GeneralCommandLine commandLine = PantsUtil.defaultCommandLine(project);\n+\n+    String coursier = coursierPath().toString();\n+    commandLine.setExePath(coursier);\n+\n+    //String name = project.getName();\n+    List<String> commandBase = Arrays.asList(\n+      \"launch\", \"org.scalameta:metals_2.12:latest.stable\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjMwMDM5Nw=="}, "originalCommit": {"oid": "4faf3e61e343c892c6c6ce8c51e1d4c29517e414"}, "originalPosition": 104}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjMxNTU1OQ==", "bodyText": "@lukaszwawrzyk please ignore this comment, we figured out a way to solve this problem so that this coursier launch command works unchanged.", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/516#discussion_r412315559", "createdAt": "2020-04-21T16:41:48Z", "author": {"login": "olafurpg"}, "path": "src/com/twitter/intellij/pants/ui/PantsToBspProjectAction.java", "diffHunk": "@@ -0,0 +1,165 @@\n+// Copyright 2020 Pants project contributors (see CONTRIBUTORS.md).\n+// Licensed under the Apache License, Version 2.0 (see LICENSE).\n+\n+package com.twitter.intellij.pants.ui;\n+\n+import com.intellij.execution.configurations.GeneralCommandLine;\n+import com.intellij.ide.impl.OpenProjectTask;\n+import com.intellij.ide.impl.ProjectUtil;\n+import com.intellij.ide.util.PropertiesComponent;\n+import com.intellij.openapi.actionSystem.AnAction;\n+import com.intellij.openapi.actionSystem.AnActionEvent;\n+import com.intellij.openapi.application.ApplicationManager;\n+import com.intellij.openapi.progress.ProgressIndicator;\n+import com.intellij.openapi.progress.ProgressManager;\n+import com.intellij.openapi.progress.Task;\n+import com.intellij.openapi.project.DumbAware;\n+import com.intellij.openapi.project.Project;\n+import com.intellij.openapi.ui.Messages;\n+import com.intellij.openapi.vfs.LocalFileSystem;\n+import com.twitter.intellij.pants.settings.PantsSettings;\n+import com.twitter.intellij.pants.util.PantsUtil;\n+import org.apache.commons.io.IOUtils;\n+import org.jetbrains.annotations.NotNull;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.function.Consumer;\n+import java.util.stream.Collectors;\n+\n+public class PantsToBspProjectAction extends AnAction implements DumbAware {\n+  private static final String BSP_LINKED_PROJECT_PATH = \"bsp.linked_project_path\";\n+\n+  @Override\n+  public void update(@NotNull AnActionEvent e) {\n+    Project project = e.getProject();\n+    boolean isPants = project != null && PantsUtil.isPantsProject(project);\n+    e.getPresentation().setEnabledAndVisible(isPants);\n+    if (isPants) {\n+      dependingOnBspProjectExistence(\n+        project,\n+        () -> e.getPresentation().setText(\"Create new BSP project based on this Pants project\"),\n+        linkedBspProject -> e.getPresentation().setText(\"Open linked BSP project\")\n+      );\n+    }\n+  }\n+\n+  @Override\n+  public void actionPerformed(AnActionEvent e) {\n+    Project project = e.getProject();\n+    if (project == null) {\n+      Messages.showInfoMessage(\"Project not found.\", \"Error\");\n+      return;\n+    }\n+    dependingOnBspProjectExistence(\n+      project,\n+      () -> createBspProject(project),\n+      linkedBspProject -> ProjectUtil.openOrImport(Paths.get(linkedBspProject), new OpenProjectTask())\n+    );\n+  }\n+\n+  private void createBspProject(Project project) {\n+    ProgressManager.getInstance().run(new Task.Backgroundable(project, \"Preparing BSP Project\", false) {\n+      @Override\n+      public void run(@NotNull ProgressIndicator indicator) {\n+        try {\n+          GeneralCommandLine commandLine = createCommandLine(project);\n+          Process process = commandLine.createProcess();\n+          String output = readToString(process.getInputStream());\n+          String outputErr = readToString(process.getErrorStream());\n+          int result = process.waitFor();\n+          if (result != 0) {\n+            String message = formatError(output, outputErr);\n+            throw new RuntimeException(message);\n+          }\n+          else {\n+            Path projectPath = Paths.get(output).toAbsolutePath();\n+            PropertiesComponent.getInstance(project).setValue(BSP_LINKED_PROJECT_PATH, projectPath.toString());\n+            ProjectUtil.openOrImport(projectPath, new OpenProjectTask());\n+          }\n+        }\n+        catch (Exception ex) {\n+          ApplicationManager.getApplication()\n+            .invokeLater(() -> Messages.showErrorDialog(project, ex.getMessage(), \"Error\"));\n+        }\n+      }\n+    });\n+  }\n+\n+  private GeneralCommandLine createCommandLine(Project project) throws IOException {\n+    GeneralCommandLine commandLine = PantsUtil.defaultCommandLine(project);\n+\n+    String coursier = coursierPath().toString();\n+    commandLine.setExePath(coursier);\n+\n+    //String name = project.getName();\n+    List<String> commandBase = Arrays.asList(\n+      \"launch\", \"org.scalameta:metals_2.12:latest.stable\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjMwMDM5Nw=="}, "originalCommit": {"oid": "4faf3e61e343c892c6c6ce8c51e1d4c29517e414"}, "originalPosition": 104}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2NjM2NzU5OnYy", "diffSide": "RIGHT", "path": "src/com/twitter/intellij/pants/ui/PantsToBspProjectAction.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxMzowOToxM1rOGJ1fpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxMjo1NDo0N1rOGLWVSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjk2NjgyMg==", "bodyText": "This leaves a leading / in the start resulting in project names like .foo", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/516#discussion_r412966822", "createdAt": "2020-04-22T13:09:13Z", "author": {"login": "olafurpg"}, "path": "src/com/twitter/intellij/pants/ui/PantsToBspProjectAction.java", "diffHunk": "@@ -126,13 +127,19 @@ private Path coursierPath() throws IOException {\n   }\n \n   private List<String> pantsTargets(Project project) {\n+    String root = PantsUtil.findBuildRoot(project).map(VirtualFile::getPath).orElse(\"/\");\n     PantsSettings pantsSettings = PantsSettings.getInstance(project);\n     return pantsSettings.getLinkedProjectsSettings()\n       .stream()\n       .flatMap(projectSettings -> projectSettings.getSelectedTargetSpecs().stream())\n+      .map(target -> stripPrefix(target, root))\n       .collect(Collectors.toList());\n   }\n \n+  private String stripPrefix(String s, String prefix) {\n+    return s.startsWith(prefix) ? s.substring(prefix.length()) : s;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f216cdd96823f57255dff8eea60d8b8a04dba3d"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDU1MzQxOA==", "bodyText": "@olafurpg I implemented removing the \"/\" Hope it works now, as I don't have reproduction for full directory in target names.", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/516#discussion_r414553418", "createdAt": "2020-04-24T12:54:47Z", "author": {"login": "lukaszwawrzyk"}, "path": "src/com/twitter/intellij/pants/ui/PantsToBspProjectAction.java", "diffHunk": "@@ -126,13 +127,19 @@ private Path coursierPath() throws IOException {\n   }\n \n   private List<String> pantsTargets(Project project) {\n+    String root = PantsUtil.findBuildRoot(project).map(VirtualFile::getPath).orElse(\"/\");\n     PantsSettings pantsSettings = PantsSettings.getInstance(project);\n     return pantsSettings.getLinkedProjectsSettings()\n       .stream()\n       .flatMap(projectSettings -> projectSettings.getSelectedTargetSpecs().stream())\n+      .map(target -> stripPrefix(target, root))\n       .collect(Collectors.toList());\n   }\n \n+  private String stripPrefix(String s, String prefix) {\n+    return s.startsWith(prefix) ? s.substring(prefix.length()) : s;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjk2NjgyMg=="}, "originalCommit": {"oid": "8f216cdd96823f57255dff8eea60d8b8a04dba3d"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwMDI2MzQ1OnYy", "diffSide": "RIGHT", "path": "src/com/twitter/intellij/pants/ui/PantsToBspProjectAction.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxMDoxNjoyN1rOGOi5Ew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxMToxMjo0MVrOGOkquA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzkwNDkxNQ==", "bodyText": "We download the newest coursier here. Imo this should either be changed to  some fixed version, or logged. Without it we lose information about coursier version that may be essential to reproduce potential bugs.", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/516#discussion_r417904915", "createdAt": "2020-04-30T10:16:27Z", "author": {"login": "tpasternak"}, "path": "src/com/twitter/intellij/pants/ui/PantsToBspProjectAction.java", "diffHunk": "@@ -0,0 +1,192 @@\n+// Copyright 2020 Pants project contributors (see CONTRIBUTORS.md).\n+// Licensed under the Apache License, Version 2.0 (see LICENSE).\n+\n+package com.twitter.intellij.pants.ui;\n+\n+import com.intellij.execution.configurations.GeneralCommandLine;\n+import com.intellij.ide.impl.OpenProjectTask;\n+import com.intellij.ide.impl.ProjectUtil;\n+import com.intellij.ide.util.PropertiesComponent;\n+import com.intellij.openapi.actionSystem.AnAction;\n+import com.intellij.openapi.actionSystem.AnActionEvent;\n+import com.intellij.openapi.application.ApplicationManager;\n+import com.intellij.openapi.progress.ProgressIndicator;\n+import com.intellij.openapi.progress.ProgressManager;\n+import com.intellij.openapi.progress.Task;\n+import com.intellij.openapi.project.DumbAware;\n+import com.intellij.openapi.project.Project;\n+import com.intellij.openapi.ui.Messages;\n+import com.intellij.openapi.vfs.LocalFileSystem;\n+import com.intellij.openapi.vfs.VirtualFile;\n+import com.twitter.intellij.pants.settings.PantsSettings;\n+import com.twitter.intellij.pants.util.PantsUtil;\n+import org.apache.commons.io.IOUtils;\n+import org.jetbrains.annotations.NotNull;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.function.Consumer;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+import java.util.stream.Collectors;\n+\n+public class PantsToBspProjectAction extends AnAction implements DumbAware {\n+  private static final String BSP_LINKED_PROJECT_PATH = \"bsp.linked_project_path\";\n+\n+  @Override\n+  public void update(@NotNull AnActionEvent e) {\n+    Project project = e.getProject();\n+    boolean isPants = project != null && PantsUtil.isPantsProject(project);\n+    e.getPresentation().setEnabledAndVisible(isPants);\n+    if (isPants) {\n+      dependingOnBspProjectExistence(\n+        project,\n+        () -> e.getPresentation().setText(\"Create new BSP project based on this Pants project\"),\n+        linkedBspProject -> e.getPresentation().setText(\"Open linked BSP project\")\n+      );\n+    }\n+  }\n+\n+  @Override\n+  public void actionPerformed(AnActionEvent e) {\n+    Project project = e.getProject();\n+    if (project == null) {\n+      Messages.showInfoMessage(\"Project not found.\", \"Error\");\n+      return;\n+    }\n+    dependingOnBspProjectExistence(\n+      project,\n+      () -> createBspProject(project),\n+      linkedBspProject -> ProjectUtil.openOrImport(Paths.get(linkedBspProject), new OpenProjectTask())\n+    );\n+  }\n+\n+  private void createBspProject(Project project) {\n+    ProgressManager.getInstance().run(new Task.Backgroundable(project, \"Preparing BSP Project\", false) {\n+      @Override\n+      public void run(@NotNull ProgressIndicator indicator) {\n+        try {\n+          GeneralCommandLine commandLine = createCommandLine(project);\n+          Process process = commandLine.createProcess();\n+          String output = readToString(process.getInputStream());\n+          String outputErr = readToString(process.getErrorStream());\n+          int result = process.waitFor();\n+          if (result != 0) {\n+            Path workspace = commandLine.getWorkDirectory().toPath();\n+            Optional<Path> projectPath = existingProjectPath(outputErr, workspace);\n+\n+            projectPath.ifPresent(path -> registerNewBspProjectAndOpen(path, project));\n+            projectPath.orElseThrow(() -> new RuntimeException(formatError(output, outputErr)));\n+          } else {\n+            Path projectPath = Paths.get(output).toAbsolutePath();\n+            registerNewBspProjectAndOpen(projectPath, project);\n+          }\n+        }\n+        catch (Exception ex) {\n+          ApplicationManager.getApplication()\n+            .invokeLater(() -> Messages.showErrorDialog(project, ex.getMessage(), \"Error\"));\n+        }\n+      }\n+    });\n+  }\n+\n+  private void registerNewBspProjectAndOpen(Path projectPath, Project project) {\n+    PropertiesComponent.getInstance(project).setValue(BSP_LINKED_PROJECT_PATH, projectPath.toString());\n+    ApplicationManager.getApplication()\n+      .invokeLater(() -> ProjectUtil.openOrImport(projectPath, new OpenProjectTask()));\n+  }\n+\n+  private Optional<Path> existingProjectPath(String output, Path workspace) {\n+    Pattern pattern = Pattern.compile(\"can't create project named '(.*?)' because it already exists\");\n+    Matcher matcher = pattern.matcher(output);\n+    if (matcher.find()) {\n+      String name = matcher.group(1);\n+      return Optional.of(workspace.resolveSibling(\"bsp-projects\").resolve(name));\n+    } else {\n+      return Optional.empty();\n+    }\n+  }\n+\n+  private GeneralCommandLine createCommandLine(Project project) throws IOException {\n+    GeneralCommandLine commandLine = PantsUtil.defaultCommandLine(project);\n+\n+    String coursier = coursierPath().toString();\n+    commandLine.setExePath(coursier);\n+\n+    List<String> commandBase = Arrays.asList(\n+      \"launch\", \"org.scalameta:metals_2.12:latest.stable\",\n+      \"--main\", \"scala.meta.internal.pantsbuild.BloopPants\",\n+      \"--\",\n+      \"create\",\n+      \"--intellij\",\n+      \"--intellijLauncher\", \"echo\"\n+    );\n+    commandLine.addParameters(commandBase);\n+\n+    List<String> targets = pantsTargets(project);\n+    commandLine.addParameters(targets);\n+    return commandLine;\n+  }\n+\n+  private Path coursierPath() throws IOException {\n+    Path destination = Paths.get(System.getProperty(\"java.io.tmpdir\"), \"pants-plugin-coursier\");\n+    if (!Files.exists(destination)) {\n+      URL url = new URL(\"https://git.io/coursier-cli\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "064a4faee81434b3f72e9e257c0dd373fbec0862"}, "originalPosition": 142}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzkzNDAwOA==", "bodyText": "This is a good point. If we copy the coursier bootstrap script from resources then we always use the same coursier version", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/516#discussion_r417934008", "createdAt": "2020-04-30T11:12:41Z", "author": {"login": "olafurpg"}, "path": "src/com/twitter/intellij/pants/ui/PantsToBspProjectAction.java", "diffHunk": "@@ -0,0 +1,192 @@\n+// Copyright 2020 Pants project contributors (see CONTRIBUTORS.md).\n+// Licensed under the Apache License, Version 2.0 (see LICENSE).\n+\n+package com.twitter.intellij.pants.ui;\n+\n+import com.intellij.execution.configurations.GeneralCommandLine;\n+import com.intellij.ide.impl.OpenProjectTask;\n+import com.intellij.ide.impl.ProjectUtil;\n+import com.intellij.ide.util.PropertiesComponent;\n+import com.intellij.openapi.actionSystem.AnAction;\n+import com.intellij.openapi.actionSystem.AnActionEvent;\n+import com.intellij.openapi.application.ApplicationManager;\n+import com.intellij.openapi.progress.ProgressIndicator;\n+import com.intellij.openapi.progress.ProgressManager;\n+import com.intellij.openapi.progress.Task;\n+import com.intellij.openapi.project.DumbAware;\n+import com.intellij.openapi.project.Project;\n+import com.intellij.openapi.ui.Messages;\n+import com.intellij.openapi.vfs.LocalFileSystem;\n+import com.intellij.openapi.vfs.VirtualFile;\n+import com.twitter.intellij.pants.settings.PantsSettings;\n+import com.twitter.intellij.pants.util.PantsUtil;\n+import org.apache.commons.io.IOUtils;\n+import org.jetbrains.annotations.NotNull;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.function.Consumer;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+import java.util.stream.Collectors;\n+\n+public class PantsToBspProjectAction extends AnAction implements DumbAware {\n+  private static final String BSP_LINKED_PROJECT_PATH = \"bsp.linked_project_path\";\n+\n+  @Override\n+  public void update(@NotNull AnActionEvent e) {\n+    Project project = e.getProject();\n+    boolean isPants = project != null && PantsUtil.isPantsProject(project);\n+    e.getPresentation().setEnabledAndVisible(isPants);\n+    if (isPants) {\n+      dependingOnBspProjectExistence(\n+        project,\n+        () -> e.getPresentation().setText(\"Create new BSP project based on this Pants project\"),\n+        linkedBspProject -> e.getPresentation().setText(\"Open linked BSP project\")\n+      );\n+    }\n+  }\n+\n+  @Override\n+  public void actionPerformed(AnActionEvent e) {\n+    Project project = e.getProject();\n+    if (project == null) {\n+      Messages.showInfoMessage(\"Project not found.\", \"Error\");\n+      return;\n+    }\n+    dependingOnBspProjectExistence(\n+      project,\n+      () -> createBspProject(project),\n+      linkedBspProject -> ProjectUtil.openOrImport(Paths.get(linkedBspProject), new OpenProjectTask())\n+    );\n+  }\n+\n+  private void createBspProject(Project project) {\n+    ProgressManager.getInstance().run(new Task.Backgroundable(project, \"Preparing BSP Project\", false) {\n+      @Override\n+      public void run(@NotNull ProgressIndicator indicator) {\n+        try {\n+          GeneralCommandLine commandLine = createCommandLine(project);\n+          Process process = commandLine.createProcess();\n+          String output = readToString(process.getInputStream());\n+          String outputErr = readToString(process.getErrorStream());\n+          int result = process.waitFor();\n+          if (result != 0) {\n+            Path workspace = commandLine.getWorkDirectory().toPath();\n+            Optional<Path> projectPath = existingProjectPath(outputErr, workspace);\n+\n+            projectPath.ifPresent(path -> registerNewBspProjectAndOpen(path, project));\n+            projectPath.orElseThrow(() -> new RuntimeException(formatError(output, outputErr)));\n+          } else {\n+            Path projectPath = Paths.get(output).toAbsolutePath();\n+            registerNewBspProjectAndOpen(projectPath, project);\n+          }\n+        }\n+        catch (Exception ex) {\n+          ApplicationManager.getApplication()\n+            .invokeLater(() -> Messages.showErrorDialog(project, ex.getMessage(), \"Error\"));\n+        }\n+      }\n+    });\n+  }\n+\n+  private void registerNewBspProjectAndOpen(Path projectPath, Project project) {\n+    PropertiesComponent.getInstance(project).setValue(BSP_LINKED_PROJECT_PATH, projectPath.toString());\n+    ApplicationManager.getApplication()\n+      .invokeLater(() -> ProjectUtil.openOrImport(projectPath, new OpenProjectTask()));\n+  }\n+\n+  private Optional<Path> existingProjectPath(String output, Path workspace) {\n+    Pattern pattern = Pattern.compile(\"can't create project named '(.*?)' because it already exists\");\n+    Matcher matcher = pattern.matcher(output);\n+    if (matcher.find()) {\n+      String name = matcher.group(1);\n+      return Optional.of(workspace.resolveSibling(\"bsp-projects\").resolve(name));\n+    } else {\n+      return Optional.empty();\n+    }\n+  }\n+\n+  private GeneralCommandLine createCommandLine(Project project) throws IOException {\n+    GeneralCommandLine commandLine = PantsUtil.defaultCommandLine(project);\n+\n+    String coursier = coursierPath().toString();\n+    commandLine.setExePath(coursier);\n+\n+    List<String> commandBase = Arrays.asList(\n+      \"launch\", \"org.scalameta:metals_2.12:latest.stable\",\n+      \"--main\", \"scala.meta.internal.pantsbuild.BloopPants\",\n+      \"--\",\n+      \"create\",\n+      \"--intellij\",\n+      \"--intellijLauncher\", \"echo\"\n+    );\n+    commandLine.addParameters(commandBase);\n+\n+    List<String> targets = pantsTargets(project);\n+    commandLine.addParameters(targets);\n+    return commandLine;\n+  }\n+\n+  private Path coursierPath() throws IOException {\n+    Path destination = Paths.get(System.getProperty(\"java.io.tmpdir\"), \"pants-plugin-coursier\");\n+    if (!Files.exists(destination)) {\n+      URL url = new URL(\"https://git.io/coursier-cli\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzkwNDkxNQ=="}, "originalCommit": {"oid": "064a4faee81434b3f72e9e257c0dd373fbec0862"}, "originalPosition": 142}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwMDI3MDQ1OnYy", "diffSide": "RIGHT", "path": "src/com/twitter/intellij/pants/ui/PantsToBspProjectAction.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxMDoxODozMlrOGOi9ZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxMjoyOTo1M1rOGOnDQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzkwNjAyMA==", "bodyText": "It would be nice to log downloaded metals version or fix it in code.", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/516#discussion_r417906020", "createdAt": "2020-04-30T10:18:32Z", "author": {"login": "tpasternak"}, "path": "src/com/twitter/intellij/pants/ui/PantsToBspProjectAction.java", "diffHunk": "@@ -0,0 +1,192 @@\n+// Copyright 2020 Pants project contributors (see CONTRIBUTORS.md).\n+// Licensed under the Apache License, Version 2.0 (see LICENSE).\n+\n+package com.twitter.intellij.pants.ui;\n+\n+import com.intellij.execution.configurations.GeneralCommandLine;\n+import com.intellij.ide.impl.OpenProjectTask;\n+import com.intellij.ide.impl.ProjectUtil;\n+import com.intellij.ide.util.PropertiesComponent;\n+import com.intellij.openapi.actionSystem.AnAction;\n+import com.intellij.openapi.actionSystem.AnActionEvent;\n+import com.intellij.openapi.application.ApplicationManager;\n+import com.intellij.openapi.progress.ProgressIndicator;\n+import com.intellij.openapi.progress.ProgressManager;\n+import com.intellij.openapi.progress.Task;\n+import com.intellij.openapi.project.DumbAware;\n+import com.intellij.openapi.project.Project;\n+import com.intellij.openapi.ui.Messages;\n+import com.intellij.openapi.vfs.LocalFileSystem;\n+import com.intellij.openapi.vfs.VirtualFile;\n+import com.twitter.intellij.pants.settings.PantsSettings;\n+import com.twitter.intellij.pants.util.PantsUtil;\n+import org.apache.commons.io.IOUtils;\n+import org.jetbrains.annotations.NotNull;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.function.Consumer;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+import java.util.stream.Collectors;\n+\n+public class PantsToBspProjectAction extends AnAction implements DumbAware {\n+  private static final String BSP_LINKED_PROJECT_PATH = \"bsp.linked_project_path\";\n+\n+  @Override\n+  public void update(@NotNull AnActionEvent e) {\n+    Project project = e.getProject();\n+    boolean isPants = project != null && PantsUtil.isPantsProject(project);\n+    e.getPresentation().setEnabledAndVisible(isPants);\n+    if (isPants) {\n+      dependingOnBspProjectExistence(\n+        project,\n+        () -> e.getPresentation().setText(\"Create new BSP project based on this Pants project\"),\n+        linkedBspProject -> e.getPresentation().setText(\"Open linked BSP project\")\n+      );\n+    }\n+  }\n+\n+  @Override\n+  public void actionPerformed(AnActionEvent e) {\n+    Project project = e.getProject();\n+    if (project == null) {\n+      Messages.showInfoMessage(\"Project not found.\", \"Error\");\n+      return;\n+    }\n+    dependingOnBspProjectExistence(\n+      project,\n+      () -> createBspProject(project),\n+      linkedBspProject -> ProjectUtil.openOrImport(Paths.get(linkedBspProject), new OpenProjectTask())\n+    );\n+  }\n+\n+  private void createBspProject(Project project) {\n+    ProgressManager.getInstance().run(new Task.Backgroundable(project, \"Preparing BSP Project\", false) {\n+      @Override\n+      public void run(@NotNull ProgressIndicator indicator) {\n+        try {\n+          GeneralCommandLine commandLine = createCommandLine(project);\n+          Process process = commandLine.createProcess();\n+          String output = readToString(process.getInputStream());\n+          String outputErr = readToString(process.getErrorStream());\n+          int result = process.waitFor();\n+          if (result != 0) {\n+            Path workspace = commandLine.getWorkDirectory().toPath();\n+            Optional<Path> projectPath = existingProjectPath(outputErr, workspace);\n+\n+            projectPath.ifPresent(path -> registerNewBspProjectAndOpen(path, project));\n+            projectPath.orElseThrow(() -> new RuntimeException(formatError(output, outputErr)));\n+          } else {\n+            Path projectPath = Paths.get(output).toAbsolutePath();\n+            registerNewBspProjectAndOpen(projectPath, project);\n+          }\n+        }\n+        catch (Exception ex) {\n+          ApplicationManager.getApplication()\n+            .invokeLater(() -> Messages.showErrorDialog(project, ex.getMessage(), \"Error\"));\n+        }\n+      }\n+    });\n+  }\n+\n+  private void registerNewBspProjectAndOpen(Path projectPath, Project project) {\n+    PropertiesComponent.getInstance(project).setValue(BSP_LINKED_PROJECT_PATH, projectPath.toString());\n+    ApplicationManager.getApplication()\n+      .invokeLater(() -> ProjectUtil.openOrImport(projectPath, new OpenProjectTask()));\n+  }\n+\n+  private Optional<Path> existingProjectPath(String output, Path workspace) {\n+    Pattern pattern = Pattern.compile(\"can't create project named '(.*?)' because it already exists\");\n+    Matcher matcher = pattern.matcher(output);\n+    if (matcher.find()) {\n+      String name = matcher.group(1);\n+      return Optional.of(workspace.resolveSibling(\"bsp-projects\").resolve(name));\n+    } else {\n+      return Optional.empty();\n+    }\n+  }\n+\n+  private GeneralCommandLine createCommandLine(Project project) throws IOException {\n+    GeneralCommandLine commandLine = PantsUtil.defaultCommandLine(project);\n+\n+    String coursier = coursierPath().toString();\n+    commandLine.setExePath(coursier);\n+\n+    List<String> commandBase = Arrays.asList(\n+      \"launch\", \"org.scalameta:metals_2.12:latest.stable\",\n+      \"--main\", \"scala.meta.internal.pantsbuild.BloopPants\",\n+      \"--\",\n+      \"create\",\n+      \"--intellij\",\n+      \"--intellijLauncher\", \"echo\"\n+    );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "064a4faee81434b3f72e9e257c0dd373fbec0862"}, "originalPosition": 131}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzkzOTM5Ng==", "bodyText": "I don't think we can tell the exact Metals version from this command when using latest.stable. One alternative would be to additionally launch a version command so that we can log what version got picked up \ud83e\udd14", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/516#discussion_r417939396", "createdAt": "2020-04-30T11:24:11Z", "author": {"login": "olafurpg"}, "path": "src/com/twitter/intellij/pants/ui/PantsToBspProjectAction.java", "diffHunk": "@@ -0,0 +1,192 @@\n+// Copyright 2020 Pants project contributors (see CONTRIBUTORS.md).\n+// Licensed under the Apache License, Version 2.0 (see LICENSE).\n+\n+package com.twitter.intellij.pants.ui;\n+\n+import com.intellij.execution.configurations.GeneralCommandLine;\n+import com.intellij.ide.impl.OpenProjectTask;\n+import com.intellij.ide.impl.ProjectUtil;\n+import com.intellij.ide.util.PropertiesComponent;\n+import com.intellij.openapi.actionSystem.AnAction;\n+import com.intellij.openapi.actionSystem.AnActionEvent;\n+import com.intellij.openapi.application.ApplicationManager;\n+import com.intellij.openapi.progress.ProgressIndicator;\n+import com.intellij.openapi.progress.ProgressManager;\n+import com.intellij.openapi.progress.Task;\n+import com.intellij.openapi.project.DumbAware;\n+import com.intellij.openapi.project.Project;\n+import com.intellij.openapi.ui.Messages;\n+import com.intellij.openapi.vfs.LocalFileSystem;\n+import com.intellij.openapi.vfs.VirtualFile;\n+import com.twitter.intellij.pants.settings.PantsSettings;\n+import com.twitter.intellij.pants.util.PantsUtil;\n+import org.apache.commons.io.IOUtils;\n+import org.jetbrains.annotations.NotNull;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.function.Consumer;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+import java.util.stream.Collectors;\n+\n+public class PantsToBspProjectAction extends AnAction implements DumbAware {\n+  private static final String BSP_LINKED_PROJECT_PATH = \"bsp.linked_project_path\";\n+\n+  @Override\n+  public void update(@NotNull AnActionEvent e) {\n+    Project project = e.getProject();\n+    boolean isPants = project != null && PantsUtil.isPantsProject(project);\n+    e.getPresentation().setEnabledAndVisible(isPants);\n+    if (isPants) {\n+      dependingOnBspProjectExistence(\n+        project,\n+        () -> e.getPresentation().setText(\"Create new BSP project based on this Pants project\"),\n+        linkedBspProject -> e.getPresentation().setText(\"Open linked BSP project\")\n+      );\n+    }\n+  }\n+\n+  @Override\n+  public void actionPerformed(AnActionEvent e) {\n+    Project project = e.getProject();\n+    if (project == null) {\n+      Messages.showInfoMessage(\"Project not found.\", \"Error\");\n+      return;\n+    }\n+    dependingOnBspProjectExistence(\n+      project,\n+      () -> createBspProject(project),\n+      linkedBspProject -> ProjectUtil.openOrImport(Paths.get(linkedBspProject), new OpenProjectTask())\n+    );\n+  }\n+\n+  private void createBspProject(Project project) {\n+    ProgressManager.getInstance().run(new Task.Backgroundable(project, \"Preparing BSP Project\", false) {\n+      @Override\n+      public void run(@NotNull ProgressIndicator indicator) {\n+        try {\n+          GeneralCommandLine commandLine = createCommandLine(project);\n+          Process process = commandLine.createProcess();\n+          String output = readToString(process.getInputStream());\n+          String outputErr = readToString(process.getErrorStream());\n+          int result = process.waitFor();\n+          if (result != 0) {\n+            Path workspace = commandLine.getWorkDirectory().toPath();\n+            Optional<Path> projectPath = existingProjectPath(outputErr, workspace);\n+\n+            projectPath.ifPresent(path -> registerNewBspProjectAndOpen(path, project));\n+            projectPath.orElseThrow(() -> new RuntimeException(formatError(output, outputErr)));\n+          } else {\n+            Path projectPath = Paths.get(output).toAbsolutePath();\n+            registerNewBspProjectAndOpen(projectPath, project);\n+          }\n+        }\n+        catch (Exception ex) {\n+          ApplicationManager.getApplication()\n+            .invokeLater(() -> Messages.showErrorDialog(project, ex.getMessage(), \"Error\"));\n+        }\n+      }\n+    });\n+  }\n+\n+  private void registerNewBspProjectAndOpen(Path projectPath, Project project) {\n+    PropertiesComponent.getInstance(project).setValue(BSP_LINKED_PROJECT_PATH, projectPath.toString());\n+    ApplicationManager.getApplication()\n+      .invokeLater(() -> ProjectUtil.openOrImport(projectPath, new OpenProjectTask()));\n+  }\n+\n+  private Optional<Path> existingProjectPath(String output, Path workspace) {\n+    Pattern pattern = Pattern.compile(\"can't create project named '(.*?)' because it already exists\");\n+    Matcher matcher = pattern.matcher(output);\n+    if (matcher.find()) {\n+      String name = matcher.group(1);\n+      return Optional.of(workspace.resolveSibling(\"bsp-projects\").resolve(name));\n+    } else {\n+      return Optional.empty();\n+    }\n+  }\n+\n+  private GeneralCommandLine createCommandLine(Project project) throws IOException {\n+    GeneralCommandLine commandLine = PantsUtil.defaultCommandLine(project);\n+\n+    String coursier = coursierPath().toString();\n+    commandLine.setExePath(coursier);\n+\n+    List<String> commandBase = Arrays.asList(\n+      \"launch\", \"org.scalameta:metals_2.12:latest.stable\",\n+      \"--main\", \"scala.meta.internal.pantsbuild.BloopPants\",\n+      \"--\",\n+      \"create\",\n+      \"--intellij\",\n+      \"--intellijLauncher\", \"echo\"\n+    );", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzkwNjAyMA=="}, "originalCommit": {"oid": "064a4faee81434b3f72e9e257c0dd373fbec0862"}, "originalPosition": 131}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzk3MzA1Nw==", "bodyText": "Right, but I think it's not essential for this PR, so it can be done as a follow-up (as well as the cousier-verison related issue). Nevertheless it must be done soon, as bug fixing may be very hard without it, in some specific cases.", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/516#discussion_r417973057", "createdAt": "2020-04-30T12:29:53Z", "author": {"login": "tpasternak"}, "path": "src/com/twitter/intellij/pants/ui/PantsToBspProjectAction.java", "diffHunk": "@@ -0,0 +1,192 @@\n+// Copyright 2020 Pants project contributors (see CONTRIBUTORS.md).\n+// Licensed under the Apache License, Version 2.0 (see LICENSE).\n+\n+package com.twitter.intellij.pants.ui;\n+\n+import com.intellij.execution.configurations.GeneralCommandLine;\n+import com.intellij.ide.impl.OpenProjectTask;\n+import com.intellij.ide.impl.ProjectUtil;\n+import com.intellij.ide.util.PropertiesComponent;\n+import com.intellij.openapi.actionSystem.AnAction;\n+import com.intellij.openapi.actionSystem.AnActionEvent;\n+import com.intellij.openapi.application.ApplicationManager;\n+import com.intellij.openapi.progress.ProgressIndicator;\n+import com.intellij.openapi.progress.ProgressManager;\n+import com.intellij.openapi.progress.Task;\n+import com.intellij.openapi.project.DumbAware;\n+import com.intellij.openapi.project.Project;\n+import com.intellij.openapi.ui.Messages;\n+import com.intellij.openapi.vfs.LocalFileSystem;\n+import com.intellij.openapi.vfs.VirtualFile;\n+import com.twitter.intellij.pants.settings.PantsSettings;\n+import com.twitter.intellij.pants.util.PantsUtil;\n+import org.apache.commons.io.IOUtils;\n+import org.jetbrains.annotations.NotNull;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.function.Consumer;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+import java.util.stream.Collectors;\n+\n+public class PantsToBspProjectAction extends AnAction implements DumbAware {\n+  private static final String BSP_LINKED_PROJECT_PATH = \"bsp.linked_project_path\";\n+\n+  @Override\n+  public void update(@NotNull AnActionEvent e) {\n+    Project project = e.getProject();\n+    boolean isPants = project != null && PantsUtil.isPantsProject(project);\n+    e.getPresentation().setEnabledAndVisible(isPants);\n+    if (isPants) {\n+      dependingOnBspProjectExistence(\n+        project,\n+        () -> e.getPresentation().setText(\"Create new BSP project based on this Pants project\"),\n+        linkedBspProject -> e.getPresentation().setText(\"Open linked BSP project\")\n+      );\n+    }\n+  }\n+\n+  @Override\n+  public void actionPerformed(AnActionEvent e) {\n+    Project project = e.getProject();\n+    if (project == null) {\n+      Messages.showInfoMessage(\"Project not found.\", \"Error\");\n+      return;\n+    }\n+    dependingOnBspProjectExistence(\n+      project,\n+      () -> createBspProject(project),\n+      linkedBspProject -> ProjectUtil.openOrImport(Paths.get(linkedBspProject), new OpenProjectTask())\n+    );\n+  }\n+\n+  private void createBspProject(Project project) {\n+    ProgressManager.getInstance().run(new Task.Backgroundable(project, \"Preparing BSP Project\", false) {\n+      @Override\n+      public void run(@NotNull ProgressIndicator indicator) {\n+        try {\n+          GeneralCommandLine commandLine = createCommandLine(project);\n+          Process process = commandLine.createProcess();\n+          String output = readToString(process.getInputStream());\n+          String outputErr = readToString(process.getErrorStream());\n+          int result = process.waitFor();\n+          if (result != 0) {\n+            Path workspace = commandLine.getWorkDirectory().toPath();\n+            Optional<Path> projectPath = existingProjectPath(outputErr, workspace);\n+\n+            projectPath.ifPresent(path -> registerNewBspProjectAndOpen(path, project));\n+            projectPath.orElseThrow(() -> new RuntimeException(formatError(output, outputErr)));\n+          } else {\n+            Path projectPath = Paths.get(output).toAbsolutePath();\n+            registerNewBspProjectAndOpen(projectPath, project);\n+          }\n+        }\n+        catch (Exception ex) {\n+          ApplicationManager.getApplication()\n+            .invokeLater(() -> Messages.showErrorDialog(project, ex.getMessage(), \"Error\"));\n+        }\n+      }\n+    });\n+  }\n+\n+  private void registerNewBspProjectAndOpen(Path projectPath, Project project) {\n+    PropertiesComponent.getInstance(project).setValue(BSP_LINKED_PROJECT_PATH, projectPath.toString());\n+    ApplicationManager.getApplication()\n+      .invokeLater(() -> ProjectUtil.openOrImport(projectPath, new OpenProjectTask()));\n+  }\n+\n+  private Optional<Path> existingProjectPath(String output, Path workspace) {\n+    Pattern pattern = Pattern.compile(\"can't create project named '(.*?)' because it already exists\");\n+    Matcher matcher = pattern.matcher(output);\n+    if (matcher.find()) {\n+      String name = matcher.group(1);\n+      return Optional.of(workspace.resolveSibling(\"bsp-projects\").resolve(name));\n+    } else {\n+      return Optional.empty();\n+    }\n+  }\n+\n+  private GeneralCommandLine createCommandLine(Project project) throws IOException {\n+    GeneralCommandLine commandLine = PantsUtil.defaultCommandLine(project);\n+\n+    String coursier = coursierPath().toString();\n+    commandLine.setExePath(coursier);\n+\n+    List<String> commandBase = Arrays.asList(\n+      \"launch\", \"org.scalameta:metals_2.12:latest.stable\",\n+      \"--main\", \"scala.meta.internal.pantsbuild.BloopPants\",\n+      \"--\",\n+      \"create\",\n+      \"--intellij\",\n+      \"--intellijLauncher\", \"echo\"\n+    );", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzkwNjAyMA=="}, "originalCommit": {"oid": "064a4faee81434b3f72e9e257c0dd373fbec0862"}, "originalPosition": 131}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2049, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}