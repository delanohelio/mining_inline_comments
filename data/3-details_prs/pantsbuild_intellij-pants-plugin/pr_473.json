{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYwNDY2MTk1", "number": 473, "title": "Contribute available build target types for completions inside of BUILD files", "bodyText": "This is a follow up for #455 as I took this task from @tgodzik\nI rebased this branch on top of master and addressed the comment from the original PR so that full addresses are used instead of paths.\nI replaced PantsBuildFileIndex which was only used for completions with PantsAddressesIndex, so now for all indexed BUILD files I take all of the target names from PsiFiles and add the default name also (equal to name of parent dir of BUILD file).\nInitially I tried the suggested approach of reading all addresses from iml for all modules, but it made PantsCompletionTest#testAbsoluteAddress fail as it seems that project is not imported by this test properly.\nCurrent approach gives wider set of target paths for completion (includes non-imported modules) and is more similar to the original behavior. Also it doesn't require project refresh to pickup new targets that were added.\nIf we'd rather prefer the smaller scope and relay on iml files, I can change the code, but I think I'd delete that single failing test as it would be quite an effort to fix it and it is also kind of covered by the new tests in this PR.\n@wisechengyi Could you check if this PR is ok now?", "createdAt": "2020-01-08T13:45:10Z", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/473", "merged": true, "mergeCommit": {"oid": "687eb29ee0ad3b965ec4d3b386e5bf45cdbfa6fb"}, "closed": true, "closedAt": "2020-01-09T21:55:45Z", "author": {"login": "lukaszwawrzyk"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb4SlzMAH2gAyMzYwNDY2MTk1OjNmMzFhYmQwZjZkY2U5ZGVmMWEwN2JhNjg0NjVkNmI1ZTA5OTQxMzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb4xM-4gFqTM0MDgzNzEyOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3f31abd0f6dce9def1a07ba68465d6b5e0994130", "author": {"user": {"login": "tgodzik", "name": "Tomasz Godzik"}}, "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/3f31abd0f6dce9def1a07ba68465d6b5e0994130", "committedDate": "2020-01-08T10:14:16Z", "message": "Contribute avaialable build target types for completions inside of BUILD files."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af478bc194e1846ee342106aac91e9758a8f862e", "author": {"user": {"login": "tgodzik", "name": "Tomasz Godzik"}}, "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/af478bc194e1846ee342106aac91e9758a8f862e", "committedDate": "2020-01-08T10:14:16Z", "message": "Check based on context if both dependencies contributions and target ones are elegible"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "74300d392aa5541c38fca79b9c1e4292294ac931", "author": {"user": {"login": "lukaszwawrzyk", "name": "\u0141ukasz Wawrzyk"}}, "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/74300d392aa5541c38fca79b9c1e4292294ac931", "committedDate": "2020-01-09T11:01:15Z", "message": "test"}, "afterCommit": {"oid": "84fd1c573c0d88e401e8d45a25b5924ba032ee86", "author": {"user": {"login": "lukaszwawrzyk", "name": "\u0141ukasz Wawrzyk"}}, "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/84fd1c573c0d88e401e8d45a25b5924ba032ee86", "committedDate": "2020-01-09T15:15:45Z", "message": "Replace target path with full addresses"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "84fd1c573c0d88e401e8d45a25b5924ba032ee86", "author": {"user": {"login": "lukaszwawrzyk", "name": "\u0141ukasz Wawrzyk"}}, "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/84fd1c573c0d88e401e8d45a25b5924ba032ee86", "committedDate": "2020-01-09T15:15:45Z", "message": "Replace target path with full addresses"}, "afterCommit": {"oid": "8f760e88f95a2f7f91ef97bf7a631049869ed338", "author": {"user": {"login": "lukaszwawrzyk", "name": "\u0141ukasz Wawrzyk"}}, "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/8f760e88f95a2f7f91ef97bf7a631049869ed338", "committedDate": "2020-01-09T15:16:25Z", "message": "Replace target path with full addresses"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13332313c95e9b1a682873c19766680fe02ea8c2", "author": {"user": {"login": "lukaszwawrzyk", "name": "\u0141ukasz Wawrzyk"}}, "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/13332313c95e9b1a682873c19766680fe02ea8c2", "committedDate": "2020-01-09T15:24:24Z", "message": "Replace target path with full addresses"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8f760e88f95a2f7f91ef97bf7a631049869ed338", "author": {"user": {"login": "lukaszwawrzyk", "name": "\u0141ukasz Wawrzyk"}}, "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/8f760e88f95a2f7f91ef97bf7a631049869ed338", "committedDate": "2020-01-09T15:16:25Z", "message": "Replace target path with full addresses"}, "afterCommit": {"oid": "13332313c95e9b1a682873c19766680fe02ea8c2", "author": {"user": {"login": "lukaszwawrzyk", "name": "\u0141ukasz Wawrzyk"}}, "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/13332313c95e9b1a682873c19766680fe02ea8c2", "committedDate": "2020-01-09T15:24:24Z", "message": "Replace target path with full addresses"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwODM3MTI4", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/473#pullrequestreview-340837128", "createdAt": "2020-01-09T21:50:22Z", "commit": {"oid": "13332313c95e9b1a682873c19766680fe02ea8c2"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQyMTo1MDoyMlrOFcEbOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQyMTo1MDoyMlrOFcEbOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDk3Njk1NA==", "bodyText": "Thanks for the doc!", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/473#discussion_r364976954", "createdAt": "2020-01-09T21:50:22Z", "author": {"login": "wisechengyi"}, "path": "src/com/twitter/intellij/pants/index/PantsAddressesIndex.java", "diffHunk": "@@ -0,0 +1,114 @@\n+// Copyright 2016 Pants project contributors (see CONTRIBUTORS.md).\n+// Licensed under the Apache License, Version 2.0 (see LICENSE).\n+\n+package com.twitter.intellij.pants.index;\n+\n+import com.intellij.openapi.fileTypes.UnknownFileType;\n+import com.intellij.openapi.util.io.FileUtil;\n+import com.intellij.openapi.vfs.VirtualFile;\n+import com.intellij.psi.PsiFile;\n+import com.intellij.util.indexing.DataIndexer;\n+import com.intellij.util.indexing.FileBasedIndex;\n+import com.intellij.util.indexing.FileContent;\n+import com.intellij.util.indexing.ID;\n+import com.intellij.util.indexing.ScalarIndexExtension;\n+import com.intellij.util.io.EnumeratorStringDescriptor;\n+import com.intellij.util.io.KeyDescriptor;\n+import com.twitter.intellij.pants.model.PantsTargetAddress;\n+import com.twitter.intellij.pants.util.PantsPsiUtil;\n+import com.twitter.intellij.pants.util.PantsUtil;\n+import org.jetbrains.annotations.NotNull;\n+\n+import java.io.File;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+public class PantsAddressesIndex extends ScalarIndexExtension<String> {\n+  public static final ID<String, Void> NAME = ID.create(\"PantsAddressesIndex\");\n+\n+  public static Collection<String> getAddresses(@NotNull PsiFile file) {\n+    // We need to make sure that the files really belong to the project.\n+    // As stated in http://www.jetbrains.org/intellij/sdk/docs/basics/indexing_and_psi_stubs/file_based_indexes.html#accessing-a-file-based-index\n+    // it \"may also contain additional keys not currently found in the project.\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13332313c95e9b1a682873c19766680fe02ea8c2"}, "originalPosition": 38}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1939, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}