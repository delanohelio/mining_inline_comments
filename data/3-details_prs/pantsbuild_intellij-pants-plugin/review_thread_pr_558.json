{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY5OTk0ODEz", "number": 558, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwODozMToxOVrOEZ30_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwODozMzoyMVrOEZ335A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1NTY0NTQwOnYy", "diffSide": "RIGHT", "path": "src/com/twitter/intellij/pants/bsp/JarMappings.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwODozMToxOVrOHC85QQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwODozMToxOVrOHC85QQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjg1Njg5Nw==", "bodyText": "Maybe fix this awkward formatting ;p", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/558#discussion_r472856897", "createdAt": "2020-08-19T08:31:19Z", "author": {"login": "lukaszwawrzyk"}, "path": "src/com/twitter/intellij/pants/bsp/JarMappings.java", "diffHunk": "@@ -60,11 +60,14 @@ public void after(@NotNull List<? extends VFileEvent> events) {\n   private synchronized void ensureUpToDate() {\n     try {\n       if (!librariesFileIsUpToDate) {\n-        VirtualFile file = librariesFile();\n-        String content = new String(file.contentsToByteArray());\n-        Type mapType = new TypeToken<Map<String, String>>() {}.getType();\n-        libraryJarToLibrarySourceJar = new Gson().fromJson(content, mapType);\n-        librariesFileIsUpToDate = true;\n+        Optional<VirtualFile> file = librariesFile();\n+        if(file.isPresent()) {\n+          String content = new String(file.get().contentsToByteArray());\n+          Type mapType = new TypeToken<Map<String, String>>() {\n+          }.getType();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8cc8736aea80e2643f439b87fdb8e0ffb3f6b933"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1NTY0NjM0OnYy", "diffSide": "RIGHT", "path": "src/com/twitter/intellij/pants/bsp/JarMappings.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwODozMTozOVrOHC86AA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwODozMTozOVrOHC86AA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjg1NzA4OA==", "bodyText": "are these get calls safe?", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/558#discussion_r472857088", "createdAt": "2020-08-19T08:31:39Z", "author": {"login": "lukaszwawrzyk"}, "path": "src/com/twitter/intellij/pants/bsp/JarMappings.java", "diffHunk": "@@ -125,17 +128,27 @@ private String targetAddressFromSanitizedFileName(String jarName) {\n \n   private boolean isProjectInternalDependency(VirtualFile jar) {\n     Path jarPath = Paths.get(jar.getPath());\n-    Path bloopJarsPath = bloopJarsPath(project);\n-    return jarPath.startsWith(bloopJarsPath);\n+    Optional<Path> bloopJarsPath = bloopJarsPath(project);\n+    Optional<Path> sourcesJarPath = sourcesJarPath(project);\n+    return jarPath.startsWith(bloopJarsPath.get()) || jarPath.startsWith(sourcesJarPath.get());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8cc8736aea80e2643f439b87fdb8e0ffb3f6b933"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1NTY1Mjg0OnYy", "diffSide": "RIGHT", "path": "src/com/twitter/intellij/pants/bsp/JarMappings.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwODozMzoyMVrOHC89-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwODozMzoyMVrOHC89-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjg1ODEwNw==", "bodyText": "We could have a method to return bloop directory and then this and bloopJarsPath could just resolve single child. Or even better, to resolve the bsp path, so it can also be used for librariesFile", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/558#discussion_r472858107", "createdAt": "2020-08-19T08:33:21Z", "author": {"login": "lukaszwawrzyk"}, "path": "src/com/twitter/intellij/pants/bsp/JarMappings.java", "diffHunk": "@@ -125,17 +128,27 @@ private String targetAddressFromSanitizedFileName(String jarName) {\n \n   private boolean isProjectInternalDependency(VirtualFile jar) {\n     Path jarPath = Paths.get(jar.getPath());\n-    Path bloopJarsPath = bloopJarsPath(project);\n-    return jarPath.startsWith(bloopJarsPath);\n+    Optional<Path> bloopJarsPath = bloopJarsPath(project);\n+    Optional<Path> sourcesJarPath = sourcesJarPath(project);\n+    return jarPath.startsWith(bloopJarsPath.get()) || jarPath.startsWith(sourcesJarPath.get());\n   }\n \n-  private static Path bloopJarsPath(Project project) {\n-    return Paths.get(project.getBasePath(), \".bloop\", \"bloop-jars\");\n+  private static Optional<Path> bloopJarsPath(Project project) {\n+    return PantsBspData.importsFor(project).stream().findFirst()\n+      .map(path -> Paths.get(path.getBspPath().toString(), \".bloop\", \"bloop-jars\"));\n   }\n \n-  private VirtualFile librariesFile() {\n-    Path path = Paths.get(project.getBasePath(), \".pants\", \"libraries.json\");\n-    return LocalFileSystem.getInstance().findFileByIoFile(path.toFile());\n+  private static Optional<Path> sourcesJarPath(Project project) {\n+    return PantsBspData.importsFor(project).stream().findFirst()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8cc8736aea80e2643f439b87fdb8e0ffb3f6b933"}, "originalPosition": 53}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2007, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}