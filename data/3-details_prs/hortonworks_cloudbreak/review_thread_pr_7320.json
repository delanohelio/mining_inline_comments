{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc3MDM1MTc1", "number": 7320, "reviewThreads": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxMDozNDowM1rODhBQWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQwOTo1MjowMFrODiQ4Lw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1OTUwMTY4OnYy", "diffSide": "RIGHT", "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/AwsNetworkConnector.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxMDozNDowM1rOFrjDzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxMDozNTowNVrOFrjF0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTIwNzUwMw==", "bodyText": "I think an object would better here which contains all of the property", "url": "https://github.com/hortonworks/cloudbreak/pull/7320#discussion_r381207503", "createdAt": "2020-02-19T10:34:03Z", "author": {"login": "doktoric"}, "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/AwsNetworkConnector.java", "diffHunk": "@@ -126,6 +133,19 @@ public String getNetworkCidr(Network network, CloudCredential credential) {\n         return vpcCidrs.get(0);\n     }\n \n+    @Override\n+    public List<CloudSubnet> selectSubnets(List<CloudSubnet> subnetMetas, Tunnel tunnel, boolean ha, boolean preferPrivateAnyways) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f5ff1e1be1cff92ef4daa6501ca028157690307"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTIwODAxOA==", "bodyText": "Yes, definitely, I thought the same. Thanks.", "url": "https://github.com/hortonworks/cloudbreak/pull/7320#discussion_r381208018", "createdAt": "2020-02-19T10:35:05Z", "author": {"login": "gergopapi2"}, "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/AwsNetworkConnector.java", "diffHunk": "@@ -126,6 +133,19 @@ public String getNetworkCidr(Network network, CloudCredential credential) {\n         return vpcCidrs.get(0);\n     }\n \n+    @Override\n+    public List<CloudSubnet> selectSubnets(List<CloudSubnet> subnetMetas, Tunnel tunnel, boolean ha, boolean preferPrivateAnyways) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTIwNzUwMw=="}, "originalCommit": {"oid": "8f5ff1e1be1cff92ef4daa6501ca028157690307"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1OTUwNjc1OnYy", "diffSide": "RIGHT", "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorStrategySinglePreferPrivate.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxMDozNTo1MFrOFrjHYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxMDozNTo1MFrOFrjHYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTIwODQxNg==", "bodyText": "No suitable subnet found because ther eis no public subnet in {} list", "url": "https://github.com/hortonworks/cloudbreak/pull/7320#discussion_r381208416", "createdAt": "2020-02-19T10:35:50Z", "author": {"login": "doktoric"}, "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorStrategySinglePreferPrivate.java", "diffHunk": "@@ -0,0 +1,43 @@\n+package com.sequenceiq.cloudbreak.cloud.aws.service.subnetselector;\n+\n+import java.util.List;\n+import java.util.Optional;\n+\n+import javax.inject.Inject;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.cloud.model.CloudSubnet;\n+\n+@Component\n+public class SubnetSelectorStrategySinglePreferPrivate extends SubnetSelectorStrategy {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(SubnetSelectorStrategySinglePreferPrivate.class);\n+\n+    @Inject\n+    private SubnetSelectorService subnetSelectorService;\n+\n+    @Override\n+    public List<CloudSubnet> selectInternal(List<CloudSubnet> subnetMetas) {\n+        Optional<CloudSubnet> foundSubnet = subnetSelectorService.getOnePrivateSubnet(subnetMetas);\n+        if (foundSubnet.isEmpty()) {\n+            foundSubnet = subnetSelectorService.getOnePublicSubnet(subnetMetas);\n+            if (foundSubnet.isEmpty()) {\n+                error(\"No suitable subnet found.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f5ff1e1be1cff92ef4daa6501ca028157690307"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1OTUxNDcyOnYy", "diffSide": "RIGHT", "path": "cloud-aws/src/test/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorServiceTest.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxMDozODowNVrOFrjMSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxMDo0MjozMVrOFrjVow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTIwOTY3Mw==", "bodyText": "I think these test are great but would be beneficial to say what is happenning like testCollectOnePrivateSubnetPerAzWhenTwoInOneAZ -> testCollectOnePrivateSubnetPerAzWhenTwoInOneAZThenShouldReturnOneAZ", "url": "https://github.com/hortonworks/cloudbreak/pull/7320#discussion_r381209673", "createdAt": "2020-02-19T10:38:05Z", "author": {"login": "doktoric"}, "path": "cloud-aws/src/test/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorServiceTest.java", "diffHunk": "@@ -0,0 +1,329 @@\n+package com.sequenceiq.cloudbreak.cloud.aws.service.subnetselector;\n+\n+\n+import static com.sequenceiq.cloudbreak.cloud.aws.service.subnetselector.SubnetBuilder.AZ_A;\n+import static com.sequenceiq.cloudbreak.cloud.aws.service.subnetselector.SubnetBuilder.AZ_B;\n+import static com.sequenceiq.cloudbreak.cloud.aws.service.subnetselector.SubnetBuilder.AZ_C;\n+import static com.sequenceiq.cloudbreak.cloud.aws.service.subnetselector.SubnetBuilder.AZ_D;\n+import static org.hamcrest.Matchers.hasSize;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertThat;\n+import static org.junit.Assert.assertTrue;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.junit.MockitoJUnitRunner;\n+\n+import com.sequenceiq.cloudbreak.cloud.model.CloudSubnet;\n+\n+@RunWith(MockitoJUnitRunner.class)\n+public class SubnetSelectorServiceTest {\n+\n+    private final SubnetSelectorService subnetSelectorService = new SubnetSelectorService();\n+\n+    @Test\n+    public void testCollectOnePrivateSubnetPerAzWhenEmpty() {\n+        List<CloudSubnet> cloudSubnets = new SubnetBuilder()\n+                .build();\n+\n+        Map<String, CloudSubnet> privateSubnetsPerAz = subnetSelectorService.collectOnePrivateSubnetPerAz(cloudSubnets, 3);\n+\n+        assertTrue(privateSubnetsPerAz.isEmpty());\n+    }\n+\n+    @Test\n+    public void testCollectOnePrivateSubnetPerAz() {\n+        List<CloudSubnet> cloudSubnets = new SubnetBuilder()\n+                .withPrivateSubnet(AZ_A)\n+                .withPrivateSubnet(AZ_B)\n+                .withPrivateSubnet(AZ_C)\n+                .build();\n+\n+        Map<String, CloudSubnet> privateSubnetsPerAz = subnetSelectorService.collectOnePrivateSubnetPerAz(cloudSubnets, 3);\n+\n+        assertThat(privateSubnetsPerAz.values(), hasSize(3));\n+    }\n+\n+    @Test\n+    public void testCollectOnePrivateSubnetPerAzWhenMoreThanThree() {\n+        List<CloudSubnet> cloudSubnets = new SubnetBuilder()\n+                .withPrivateSubnet(AZ_A)\n+                .withPrivateSubnet(AZ_B)\n+                .withPrivateSubnet(AZ_C)\n+                .withPrivateSubnet(AZ_D)\n+                .build();\n+\n+        Map<String, CloudSubnet> privateSubnetsPerAz = subnetSelectorService.collectOnePrivateSubnetPerAz(cloudSubnets, 3);\n+\n+        assertThat(privateSubnetsPerAz.values(), hasSize(3));\n+    }\n+\n+    @Test\n+    public void testCollectOnePrivateSubnetPerAzWhenTwoInOneAZ() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f5ff1e1be1cff92ef4daa6501ca028157690307"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTIxMTAxMA==", "bodyText": "I agree, I like the test-when-then naming convention. However, without some separators the test names would become too long to read and so just skipped it for brevity. I would prefer some java \"illegal\" conventions like\ntestMethodname_whenCondition_thenExpectation\nto make it readable.", "url": "https://github.com/hortonworks/cloudbreak/pull/7320#discussion_r381211010", "createdAt": "2020-02-19T10:40:35Z", "author": {"login": "gergopapi2"}, "path": "cloud-aws/src/test/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorServiceTest.java", "diffHunk": "@@ -0,0 +1,329 @@\n+package com.sequenceiq.cloudbreak.cloud.aws.service.subnetselector;\n+\n+\n+import static com.sequenceiq.cloudbreak.cloud.aws.service.subnetselector.SubnetBuilder.AZ_A;\n+import static com.sequenceiq.cloudbreak.cloud.aws.service.subnetselector.SubnetBuilder.AZ_B;\n+import static com.sequenceiq.cloudbreak.cloud.aws.service.subnetselector.SubnetBuilder.AZ_C;\n+import static com.sequenceiq.cloudbreak.cloud.aws.service.subnetselector.SubnetBuilder.AZ_D;\n+import static org.hamcrest.Matchers.hasSize;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertThat;\n+import static org.junit.Assert.assertTrue;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.junit.MockitoJUnitRunner;\n+\n+import com.sequenceiq.cloudbreak.cloud.model.CloudSubnet;\n+\n+@RunWith(MockitoJUnitRunner.class)\n+public class SubnetSelectorServiceTest {\n+\n+    private final SubnetSelectorService subnetSelectorService = new SubnetSelectorService();\n+\n+    @Test\n+    public void testCollectOnePrivateSubnetPerAzWhenEmpty() {\n+        List<CloudSubnet> cloudSubnets = new SubnetBuilder()\n+                .build();\n+\n+        Map<String, CloudSubnet> privateSubnetsPerAz = subnetSelectorService.collectOnePrivateSubnetPerAz(cloudSubnets, 3);\n+\n+        assertTrue(privateSubnetsPerAz.isEmpty());\n+    }\n+\n+    @Test\n+    public void testCollectOnePrivateSubnetPerAz() {\n+        List<CloudSubnet> cloudSubnets = new SubnetBuilder()\n+                .withPrivateSubnet(AZ_A)\n+                .withPrivateSubnet(AZ_B)\n+                .withPrivateSubnet(AZ_C)\n+                .build();\n+\n+        Map<String, CloudSubnet> privateSubnetsPerAz = subnetSelectorService.collectOnePrivateSubnetPerAz(cloudSubnets, 3);\n+\n+        assertThat(privateSubnetsPerAz.values(), hasSize(3));\n+    }\n+\n+    @Test\n+    public void testCollectOnePrivateSubnetPerAzWhenMoreThanThree() {\n+        List<CloudSubnet> cloudSubnets = new SubnetBuilder()\n+                .withPrivateSubnet(AZ_A)\n+                .withPrivateSubnet(AZ_B)\n+                .withPrivateSubnet(AZ_C)\n+                .withPrivateSubnet(AZ_D)\n+                .build();\n+\n+        Map<String, CloudSubnet> privateSubnetsPerAz = subnetSelectorService.collectOnePrivateSubnetPerAz(cloudSubnets, 3);\n+\n+        assertThat(privateSubnetsPerAz.values(), hasSize(3));\n+    }\n+\n+    @Test\n+    public void testCollectOnePrivateSubnetPerAzWhenTwoInOneAZ() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTIwOTY3Mw=="}, "originalCommit": {"oid": "8f5ff1e1be1cff92ef4daa6501ca028157690307"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTIxMjA2Nw==", "bodyText": "I mostly using this testMethodnameWhenConditionThenExpectation", "url": "https://github.com/hortonworks/cloudbreak/pull/7320#discussion_r381212067", "createdAt": "2020-02-19T10:42:31Z", "author": {"login": "doktoric"}, "path": "cloud-aws/src/test/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorServiceTest.java", "diffHunk": "@@ -0,0 +1,329 @@\n+package com.sequenceiq.cloudbreak.cloud.aws.service.subnetselector;\n+\n+\n+import static com.sequenceiq.cloudbreak.cloud.aws.service.subnetselector.SubnetBuilder.AZ_A;\n+import static com.sequenceiq.cloudbreak.cloud.aws.service.subnetselector.SubnetBuilder.AZ_B;\n+import static com.sequenceiq.cloudbreak.cloud.aws.service.subnetselector.SubnetBuilder.AZ_C;\n+import static com.sequenceiq.cloudbreak.cloud.aws.service.subnetselector.SubnetBuilder.AZ_D;\n+import static org.hamcrest.Matchers.hasSize;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertThat;\n+import static org.junit.Assert.assertTrue;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.junit.MockitoJUnitRunner;\n+\n+import com.sequenceiq.cloudbreak.cloud.model.CloudSubnet;\n+\n+@RunWith(MockitoJUnitRunner.class)\n+public class SubnetSelectorServiceTest {\n+\n+    private final SubnetSelectorService subnetSelectorService = new SubnetSelectorService();\n+\n+    @Test\n+    public void testCollectOnePrivateSubnetPerAzWhenEmpty() {\n+        List<CloudSubnet> cloudSubnets = new SubnetBuilder()\n+                .build();\n+\n+        Map<String, CloudSubnet> privateSubnetsPerAz = subnetSelectorService.collectOnePrivateSubnetPerAz(cloudSubnets, 3);\n+\n+        assertTrue(privateSubnetsPerAz.isEmpty());\n+    }\n+\n+    @Test\n+    public void testCollectOnePrivateSubnetPerAz() {\n+        List<CloudSubnet> cloudSubnets = new SubnetBuilder()\n+                .withPrivateSubnet(AZ_A)\n+                .withPrivateSubnet(AZ_B)\n+                .withPrivateSubnet(AZ_C)\n+                .build();\n+\n+        Map<String, CloudSubnet> privateSubnetsPerAz = subnetSelectorService.collectOnePrivateSubnetPerAz(cloudSubnets, 3);\n+\n+        assertThat(privateSubnetsPerAz.values(), hasSize(3));\n+    }\n+\n+    @Test\n+    public void testCollectOnePrivateSubnetPerAzWhenMoreThanThree() {\n+        List<CloudSubnet> cloudSubnets = new SubnetBuilder()\n+                .withPrivateSubnet(AZ_A)\n+                .withPrivateSubnet(AZ_B)\n+                .withPrivateSubnet(AZ_C)\n+                .withPrivateSubnet(AZ_D)\n+                .build();\n+\n+        Map<String, CloudSubnet> privateSubnetsPerAz = subnetSelectorService.collectOnePrivateSubnetPerAz(cloudSubnets, 3);\n+\n+        assertThat(privateSubnetsPerAz.values(), hasSize(3));\n+    }\n+\n+    @Test\n+    public void testCollectOnePrivateSubnetPerAzWhenTwoInOneAZ() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTIwOTY3Mw=="}, "originalCommit": {"oid": "8f5ff1e1be1cff92ef4daa6501ca028157690307"}, "originalPosition": 68}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1OTUxODk0OnYy", "diffSide": "RIGHT", "path": "cloud-aws/src/test/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorStrategySinglePreferPrivateTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxMDozOToxN1rOFrjO2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxMDozOToxN1rOFrjO2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTIxMDMzMA==", "bodyText": "the name of the test should be more specific", "url": "https://github.com/hortonworks/cloudbreak/pull/7320#discussion_r381210330", "createdAt": "2020-02-19T10:39:17Z", "author": {"login": "doktoric"}, "path": "cloud-aws/src/test/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorStrategySinglePreferPrivateTest.java", "diffHunk": "@@ -0,0 +1,100 @@\n+package com.sequenceiq.cloudbreak.cloud.aws.service.subnetselector;\n+\n+import static com.sequenceiq.cloudbreak.cloud.aws.service.subnetselector.SubnetBuilder.AZ_A;\n+import static org.hamcrest.Matchers.hasItem;\n+import static org.hamcrest.Matchers.hasProperty;\n+import static org.hamcrest.Matchers.hasSize;\n+import static org.hamcrest.Matchers.is;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertThat;\n+import static org.mockito.Mockito.when;\n+\n+import java.util.List;\n+\n+import javax.ws.rs.BadRequestException;\n+\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.ExpectedException;\n+import org.junit.runner.RunWith;\n+import org.mockito.ArgumentMatchers;\n+import org.mockito.InjectMocks;\n+import org.mockito.Mock;\n+import org.mockito.junit.MockitoJUnitRunner;\n+\n+import com.sequenceiq.cloudbreak.cloud.model.CloudSubnet;\n+\n+@RunWith(MockitoJUnitRunner.class)\n+public class SubnetSelectorStrategySinglePreferPrivateTest {\n+    @Rule\n+    public final ExpectedException thrown = ExpectedException.none();\n+\n+    @Mock\n+    private SubnetSelectorService subnetSelectorService;\n+\n+    @InjectMocks\n+    private SubnetSelectorStrategySinglePreferPrivate underTest;\n+\n+    private final SubnetHelper subnetHelper = new SubnetHelper();\n+\n+    @Before\n+    public void setup() {\n+        when(subnetSelectorService.getOnePrivateSubnet(ArgumentMatchers.any())).thenCallRealMethod();\n+        when(subnetSelectorService.getOnePublicSubnet(ArgumentMatchers.any())).thenCallRealMethod();\n+    }\n+\n+    @Test\n+    public void testWhenOnePrivateSubnet() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f5ff1e1be1cff92ef4daa6501ca028157690307"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3MjQzMTM4OnYy", "diffSide": "RIGHT", "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorService.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQwOToxNzozN1rOFtZijQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxNjowOTowMlrOFuMPDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE0ODY4NQ==", "bodyText": "this could be simplified with stream, like:\nsubnetMetas.stream().filter(isPrivate).limit(max).collect(Collectors.toMap(key,value,(existing, new)->existing))", "url": "https://github.com/hortonworks/cloudbreak/pull/7320#discussion_r383148685", "createdAt": "2020-02-24T09:17:37Z", "author": {"login": "lacikaaa"}, "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorService.java", "diffHunk": "@@ -0,0 +1,78 @@\n+package com.sequenceiq.cloudbreak.cloud.aws.service.subnetselector;\n+\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Service;\n+\n+import com.sequenceiq.cloudbreak.cloud.model.CloudSubnet;\n+\n+@Service\n+class SubnetSelectorService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(SubnetSelectorService.class);\n+\n+    Map<String, CloudSubnet> collectOnePrivateSubnetPerAz(List<CloudSubnet> subnetMetas, int max) {\n+        Map<String, CloudSubnet> subnetsPerAz = new HashMap<>();\n+        Iterator<CloudSubnet> subnetIterator = subnetMetas.iterator();\n+        while (subnetsPerAz.size() < max && subnetIterator.hasNext()) {\n+            CloudSubnet nextSubnet = subnetIterator.next();\n+            if (nextSubnet.isPrivateSubnet()) {\n+                subnetsPerAz.putIfAbsent(nextSubnet.getAvailabilityZone(), nextSubnet);\n+            }\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2cbf1fe59e511ba0f734de74b0fb86f974515c44"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzkzODQ5MQ==", "bodyText": "Thank you for the suggestion, did it.", "url": "https://github.com/hortonworks/cloudbreak/pull/7320#discussion_r383938491", "createdAt": "2020-02-25T15:08:34Z", "author": {"login": "gergopapi2"}, "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorService.java", "diffHunk": "@@ -0,0 +1,78 @@\n+package com.sequenceiq.cloudbreak.cloud.aws.service.subnetselector;\n+\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Service;\n+\n+import com.sequenceiq.cloudbreak.cloud.model.CloudSubnet;\n+\n+@Service\n+class SubnetSelectorService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(SubnetSelectorService.class);\n+\n+    Map<String, CloudSubnet> collectOnePrivateSubnetPerAz(List<CloudSubnet> subnetMetas, int max) {\n+        Map<String, CloudSubnet> subnetsPerAz = new HashMap<>();\n+        Iterator<CloudSubnet> subnetIterator = subnetMetas.iterator();\n+        while (subnetsPerAz.size() < max && subnetIterator.hasNext()) {\n+            CloudSubnet nextSubnet = subnetIterator.next();\n+            if (nextSubnet.isPrivateSubnet()) {\n+                subnetsPerAz.putIfAbsent(nextSubnet.getAvailabilityZone(), nextSubnet);\n+            }\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE0ODY4NQ=="}, "originalCommit": {"oid": "2cbf1fe59e511ba0f734de74b0fb86f974515c44"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzk3OTI3Ng==", "bodyText": "Hm, it does not work. I think limit will stop checking for more private subnets when it reached the desired count, irrespective of their AZ.", "url": "https://github.com/hortonworks/cloudbreak/pull/7320#discussion_r383979276", "createdAt": "2020-02-25T16:09:02Z", "author": {"login": "gergopapi2"}, "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorService.java", "diffHunk": "@@ -0,0 +1,78 @@\n+package com.sequenceiq.cloudbreak.cloud.aws.service.subnetselector;\n+\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Service;\n+\n+import com.sequenceiq.cloudbreak.cloud.model.CloudSubnet;\n+\n+@Service\n+class SubnetSelectorService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(SubnetSelectorService.class);\n+\n+    Map<String, CloudSubnet> collectOnePrivateSubnetPerAz(List<CloudSubnet> subnetMetas, int max) {\n+        Map<String, CloudSubnet> subnetsPerAz = new HashMap<>();\n+        Iterator<CloudSubnet> subnetIterator = subnetMetas.iterator();\n+        while (subnetsPerAz.size() < max && subnetIterator.hasNext()) {\n+            CloudSubnet nextSubnet = subnetIterator.next();\n+            if (nextSubnet.isPrivateSubnet()) {\n+                subnetsPerAz.putIfAbsent(nextSubnet.getAvailabilityZone(), nextSubnet);\n+            }\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE0ODY4NQ=="}, "originalCommit": {"oid": "2cbf1fe59e511ba0f734de74b0fb86f974515c44"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3MjQ1MDg0OnYy", "diffSide": "RIGHT", "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorService.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQwOToyNDoxMVrOFtZt3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxNjoxNjoxMlrOFuMiRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE1MTU4Mw==", "bodyText": "it's similar to the private one, could be replaced with stream.", "url": "https://github.com/hortonworks/cloudbreak/pull/7320#discussion_r383151583", "createdAt": "2020-02-24T09:24:11Z", "author": {"login": "lacikaaa"}, "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorService.java", "diffHunk": "@@ -0,0 +1,78 @@\n+package com.sequenceiq.cloudbreak.cloud.aws.service.subnetselector;\n+\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Service;\n+\n+import com.sequenceiq.cloudbreak.cloud.model.CloudSubnet;\n+\n+@Service\n+class SubnetSelectorService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(SubnetSelectorService.class);\n+\n+    Map<String, CloudSubnet> collectOnePrivateSubnetPerAz(List<CloudSubnet> subnetMetas, int max) {\n+        Map<String, CloudSubnet> subnetsPerAz = new HashMap<>();\n+        Iterator<CloudSubnet> subnetIterator = subnetMetas.iterator();\n+        while (subnetsPerAz.size() < max && subnetIterator.hasNext()) {\n+            CloudSubnet nextSubnet = subnetIterator.next();\n+            if (nextSubnet.isPrivateSubnet()) {\n+                subnetsPerAz.putIfAbsent(nextSubnet.getAvailabilityZone(), nextSubnet);\n+            }\n+        }\n+        LOGGER.debug(\"Private subnets per AZ: {}\", subnetsPerAz.values().stream().map(CloudSubnet::getId).collect(Collectors.joining(\",\")));\n+        return subnetsPerAz;\n+    }\n+\n+    Optional<CloudSubnet> getOnePrivateSubnet(List<CloudSubnet> subnetMetas) {\n+        Optional<CloudSubnet> foundCloudSubnet = subnetMetas.stream()\n+                .filter(CloudSubnet::isPrivateSubnet)\n+                .findFirst();\n+        LOGGER.debug(\"Found private subnet: {}\", foundCloudSubnet.map(CloudSubnet::getId).orElse(\"Not found\"));\n+        return foundCloudSubnet;\n+    }\n+\n+    Map<String, CloudSubnet> collectOnePublicSubnetPerAz(List<CloudSubnet> subnetMetas, int max) {\n+        Map<String, CloudSubnet> subnetsPerAz = new HashMap<>();\n+        Iterator<CloudSubnet> subnetIterator = subnetMetas.iterator();\n+        while (subnetsPerAz.size() < max && subnetIterator.hasNext()) {\n+            CloudSubnet nextSubnet = subnetIterator.next();\n+            if (isUsablePublicSubnet(nextSubnet)) {\n+                subnetsPerAz.putIfAbsent(nextSubnet.getAvailabilityZone(), nextSubnet);\n+            }\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2cbf1fe59e511ba0f734de74b0fb86f974515c44"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzkzODU3Nw==", "bodyText": "Thanks, did it.", "url": "https://github.com/hortonworks/cloudbreak/pull/7320#discussion_r383938577", "createdAt": "2020-02-25T15:08:41Z", "author": {"login": "gergopapi2"}, "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorService.java", "diffHunk": "@@ -0,0 +1,78 @@\n+package com.sequenceiq.cloudbreak.cloud.aws.service.subnetselector;\n+\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Service;\n+\n+import com.sequenceiq.cloudbreak.cloud.model.CloudSubnet;\n+\n+@Service\n+class SubnetSelectorService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(SubnetSelectorService.class);\n+\n+    Map<String, CloudSubnet> collectOnePrivateSubnetPerAz(List<CloudSubnet> subnetMetas, int max) {\n+        Map<String, CloudSubnet> subnetsPerAz = new HashMap<>();\n+        Iterator<CloudSubnet> subnetIterator = subnetMetas.iterator();\n+        while (subnetsPerAz.size() < max && subnetIterator.hasNext()) {\n+            CloudSubnet nextSubnet = subnetIterator.next();\n+            if (nextSubnet.isPrivateSubnet()) {\n+                subnetsPerAz.putIfAbsent(nextSubnet.getAvailabilityZone(), nextSubnet);\n+            }\n+        }\n+        LOGGER.debug(\"Private subnets per AZ: {}\", subnetsPerAz.values().stream().map(CloudSubnet::getId).collect(Collectors.joining(\",\")));\n+        return subnetsPerAz;\n+    }\n+\n+    Optional<CloudSubnet> getOnePrivateSubnet(List<CloudSubnet> subnetMetas) {\n+        Optional<CloudSubnet> foundCloudSubnet = subnetMetas.stream()\n+                .filter(CloudSubnet::isPrivateSubnet)\n+                .findFirst();\n+        LOGGER.debug(\"Found private subnet: {}\", foundCloudSubnet.map(CloudSubnet::getId).orElse(\"Not found\"));\n+        return foundCloudSubnet;\n+    }\n+\n+    Map<String, CloudSubnet> collectOnePublicSubnetPerAz(List<CloudSubnet> subnetMetas, int max) {\n+        Map<String, CloudSubnet> subnetsPerAz = new HashMap<>();\n+        Iterator<CloudSubnet> subnetIterator = subnetMetas.iterator();\n+        while (subnetsPerAz.size() < max && subnetIterator.hasNext()) {\n+            CloudSubnet nextSubnet = subnetIterator.next();\n+            if (isUsablePublicSubnet(nextSubnet)) {\n+                subnetsPerAz.putIfAbsent(nextSubnet.getAvailabilityZone(), nextSubnet);\n+            }\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE1MTU4Mw=="}, "originalCommit": {"oid": "2cbf1fe59e511ba0f734de74b0fb86f974515c44"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzk4NDE5OA==", "bodyText": "Finally I kept the original implementation.", "url": "https://github.com/hortonworks/cloudbreak/pull/7320#discussion_r383984198", "createdAt": "2020-02-25T16:16:12Z", "author": {"login": "gergopapi2"}, "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorService.java", "diffHunk": "@@ -0,0 +1,78 @@\n+package com.sequenceiq.cloudbreak.cloud.aws.service.subnetselector;\n+\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Service;\n+\n+import com.sequenceiq.cloudbreak.cloud.model.CloudSubnet;\n+\n+@Service\n+class SubnetSelectorService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(SubnetSelectorService.class);\n+\n+    Map<String, CloudSubnet> collectOnePrivateSubnetPerAz(List<CloudSubnet> subnetMetas, int max) {\n+        Map<String, CloudSubnet> subnetsPerAz = new HashMap<>();\n+        Iterator<CloudSubnet> subnetIterator = subnetMetas.iterator();\n+        while (subnetsPerAz.size() < max && subnetIterator.hasNext()) {\n+            CloudSubnet nextSubnet = subnetIterator.next();\n+            if (nextSubnet.isPrivateSubnet()) {\n+                subnetsPerAz.putIfAbsent(nextSubnet.getAvailabilityZone(), nextSubnet);\n+            }\n+        }\n+        LOGGER.debug(\"Private subnets per AZ: {}\", subnetsPerAz.values().stream().map(CloudSubnet::getId).collect(Collectors.joining(\",\")));\n+        return subnetsPerAz;\n+    }\n+\n+    Optional<CloudSubnet> getOnePrivateSubnet(List<CloudSubnet> subnetMetas) {\n+        Optional<CloudSubnet> foundCloudSubnet = subnetMetas.stream()\n+                .filter(CloudSubnet::isPrivateSubnet)\n+                .findFirst();\n+        LOGGER.debug(\"Found private subnet: {}\", foundCloudSubnet.map(CloudSubnet::getId).orElse(\"Not found\"));\n+        return foundCloudSubnet;\n+    }\n+\n+    Map<String, CloudSubnet> collectOnePublicSubnetPerAz(List<CloudSubnet> subnetMetas, int max) {\n+        Map<String, CloudSubnet> subnetsPerAz = new HashMap<>();\n+        Iterator<CloudSubnet> subnetIterator = subnetMetas.iterator();\n+        while (subnetsPerAz.size() < max && subnetIterator.hasNext()) {\n+            CloudSubnet nextSubnet = subnetIterator.next();\n+            if (isUsablePublicSubnet(nextSubnet)) {\n+                subnetsPerAz.putIfAbsent(nextSubnet.getAvailabilityZone(), nextSubnet);\n+            }\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE1MTU4Mw=="}, "originalCommit": {"oid": "2cbf1fe59e511ba0f734de74b0fb86f974515c44"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3MjQ4ODI4OnYy", "diffSide": "RIGHT", "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorStrategyMultiplePreferPrivate.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQwOTozNTo0NlrOFtaDuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxNjoxNjoyN1rOFuMi0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE1NzE3Ng==", "bodyText": "could you move this into @Values so we can modify it easily if needed", "url": "https://github.com/hortonworks/cloudbreak/pull/7320#discussion_r383157176", "createdAt": "2020-02-24T09:35:46Z", "author": {"login": "lacikaaa"}, "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorStrategyMultiplePreferPrivate.java", "diffHunk": "@@ -0,0 +1,50 @@\n+package com.sequenceiq.cloudbreak.cloud.aws.service.subnetselector;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+\n+import javax.inject.Inject;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.cloud.model.CloudSubnet;\n+\n+@Component\n+public class SubnetSelectorStrategyMultiplePreferPrivate extends SubnetSelectorStrategy {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(SubnetSelectorStrategyMultiplePreferPrivate.class);\n+\n+    private static final int MIN_SUBNET_IN_DIFFERENT_AZ = 2;\n+\n+    private static final int MAX_SUBNET_IN_DIFFERENT_AZ = 3;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2cbf1fe59e511ba0f734de74b0fb86f974515c44"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzk4NDMzNw==", "bodyText": "Yes, did it, thanks.", "url": "https://github.com/hortonworks/cloudbreak/pull/7320#discussion_r383984337", "createdAt": "2020-02-25T16:16:27Z", "author": {"login": "gergopapi2"}, "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorStrategyMultiplePreferPrivate.java", "diffHunk": "@@ -0,0 +1,50 @@\n+package com.sequenceiq.cloudbreak.cloud.aws.service.subnetselector;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+\n+import javax.inject.Inject;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.cloud.model.CloudSubnet;\n+\n+@Component\n+public class SubnetSelectorStrategyMultiplePreferPrivate extends SubnetSelectorStrategy {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(SubnetSelectorStrategyMultiplePreferPrivate.class);\n+\n+    private static final int MIN_SUBNET_IN_DIFFERENT_AZ = 2;\n+\n+    private static final int MAX_SUBNET_IN_DIFFERENT_AZ = 3;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE1NzE3Ng=="}, "originalCommit": {"oid": "2cbf1fe59e511ba0f734de74b0fb86f974515c44"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3MjQ5NTYxOnYy", "diffSide": "RIGHT", "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorStrategyMultiplePreferPrivate.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQwOTozODowNFrOFtaH0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxNjoxNjo0NFrOFuMjqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE1ODIyNw==", "bodyText": "line break seems unnecessary", "url": "https://github.com/hortonworks/cloudbreak/pull/7320#discussion_r383158227", "createdAt": "2020-02-24T09:38:04Z", "author": {"login": "lacikaaa"}, "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorStrategyMultiplePreferPrivate.java", "diffHunk": "@@ -0,0 +1,50 @@\n+package com.sequenceiq.cloudbreak.cloud.aws.service.subnetselector;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+\n+import javax.inject.Inject;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.cloud.model.CloudSubnet;\n+\n+@Component\n+public class SubnetSelectorStrategyMultiplePreferPrivate extends SubnetSelectorStrategy {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(SubnetSelectorStrategyMultiplePreferPrivate.class);\n+\n+    private static final int MIN_SUBNET_IN_DIFFERENT_AZ = 2;\n+\n+    private static final int MAX_SUBNET_IN_DIFFERENT_AZ = 3;\n+\n+    @Inject\n+    private SubnetSelectorService subnetSelectorService;\n+\n+    @Override\n+    public List<CloudSubnet> selectInternal(List<CloudSubnet> subnetMetas) {\n+        Map<String, CloudSubnet> selectedSubnets = subnetSelectorService.collectOnePrivateSubnetPerAz(subnetMetas, MAX_SUBNET_IN_DIFFERENT_AZ);\n+        if (selectedSubnets.size() < MIN_SUBNET_IN_DIFFERENT_AZ) {\n+            Map<String, CloudSubnet> publicSubnetsPerAz = subnetSelectorService.collectOnePublicSubnetPerAz(subnetMetas, MIN_SUBNET_IN_DIFFERENT_AZ);\n+            subnetSelectorService.collectSubnetsOfMissingAz(selectedSubnets, publicSubnetsPerAz,\n+                    MIN_SUBNET_IN_DIFFERENT_AZ);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2cbf1fe59e511ba0f734de74b0fb86f974515c44"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzk4NDU1NQ==", "bodyText": "Ops, you are right. I corrected it.", "url": "https://github.com/hortonworks/cloudbreak/pull/7320#discussion_r383984555", "createdAt": "2020-02-25T16:16:44Z", "author": {"login": "gergopapi2"}, "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorStrategyMultiplePreferPrivate.java", "diffHunk": "@@ -0,0 +1,50 @@\n+package com.sequenceiq.cloudbreak.cloud.aws.service.subnetselector;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+\n+import javax.inject.Inject;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.cloud.model.CloudSubnet;\n+\n+@Component\n+public class SubnetSelectorStrategyMultiplePreferPrivate extends SubnetSelectorStrategy {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(SubnetSelectorStrategyMultiplePreferPrivate.class);\n+\n+    private static final int MIN_SUBNET_IN_DIFFERENT_AZ = 2;\n+\n+    private static final int MAX_SUBNET_IN_DIFFERENT_AZ = 3;\n+\n+    @Inject\n+    private SubnetSelectorService subnetSelectorService;\n+\n+    @Override\n+    public List<CloudSubnet> selectInternal(List<CloudSubnet> subnetMetas) {\n+        Map<String, CloudSubnet> selectedSubnets = subnetSelectorService.collectOnePrivateSubnetPerAz(subnetMetas, MAX_SUBNET_IN_DIFFERENT_AZ);\n+        if (selectedSubnets.size() < MIN_SUBNET_IN_DIFFERENT_AZ) {\n+            Map<String, CloudSubnet> publicSubnetsPerAz = subnetSelectorService.collectOnePublicSubnetPerAz(subnetMetas, MIN_SUBNET_IN_DIFFERENT_AZ);\n+            subnetSelectorService.collectSubnetsOfMissingAz(selectedSubnets, publicSubnetsPerAz,\n+                    MIN_SUBNET_IN_DIFFERENT_AZ);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE1ODIyNw=="}, "originalCommit": {"oid": "2cbf1fe59e511ba0f734de74b0fb86f974515c44"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3MjUwMzc5OnYy", "diffSide": "RIGHT", "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorStrategyMultiplePreferPublic.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQwOTo0MDozNFrOFtaMjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxNjoxODowNVrOFuMnKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE1OTQzOA==", "bodyText": "same as above", "url": "https://github.com/hortonworks/cloudbreak/pull/7320#discussion_r383159438", "createdAt": "2020-02-24T09:40:34Z", "author": {"login": "lacikaaa"}, "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorStrategyMultiplePreferPublic.java", "diffHunk": "@@ -0,0 +1,46 @@\n+package com.sequenceiq.cloudbreak.cloud.aws.service.subnetselector;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+\n+import javax.inject.Inject;\n+\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.cloud.model.CloudSubnet;\n+\n+@Component\n+public class SubnetSelectorStrategyMultiplePreferPublic extends SubnetSelectorStrategy {\n+\n+    private static final int MIN_SUBNET_IN_DIFFERENT_AZ = 2;\n+\n+    private static final int MAX_SUBNET_IN_DIFFERENT_AZ = 3;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2cbf1fe59e511ba0f734de74b0fb86f974515c44"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzk4NTQ0OQ==", "bodyText": "Yes, I made it injectable via Value.", "url": "https://github.com/hortonworks/cloudbreak/pull/7320#discussion_r383985449", "createdAt": "2020-02-25T16:18:05Z", "author": {"login": "gergopapi2"}, "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/service/subnetselector/SubnetSelectorStrategyMultiplePreferPublic.java", "diffHunk": "@@ -0,0 +1,46 @@\n+package com.sequenceiq.cloudbreak.cloud.aws.service.subnetselector;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+\n+import javax.inject.Inject;\n+\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.cloud.model.CloudSubnet;\n+\n+@Component\n+public class SubnetSelectorStrategyMultiplePreferPublic extends SubnetSelectorStrategy {\n+\n+    private static final int MIN_SUBNET_IN_DIFFERENT_AZ = 2;\n+\n+    private static final int MAX_SUBNET_IN_DIFFERENT_AZ = 3;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE1OTQzOA=="}, "originalCommit": {"oid": "2cbf1fe59e511ba0f734de74b0fb86f974515c44"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3MjUyMDk2OnYy", "diffSide": "RIGHT", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/AzureNetworkConnector.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQwOTo0NTowNFrOFtaWCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxNjoxODoxNFrOFuMnnQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE2MTg2Nw==", "bodyText": "on AWS implementation there is a validation if subnetMetas is null. I think it would make sense to have the same here", "url": "https://github.com/hortonworks/cloudbreak/pull/7320#discussion_r383161867", "createdAt": "2020-02-24T09:45:04Z", "author": {"login": "lacikaaa"}, "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/AzureNetworkConnector.java", "diffHunk": "@@ -137,6 +139,16 @@ public String getNetworkCidr(Network network, CloudCredential credential) {\n         return networkCidrs.get(0);\n     }\n \n+    @Override\n+    public List<CloudSubnet> selectSubnets(List<CloudSubnet> subnetMetas, SubnetSelectionParameters subnetSelectionParameters) {\n+        if (subnetMetas.isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2cbf1fe59e511ba0f734de74b0fb86f974515c44"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzk4NTU2NQ==", "bodyText": "Yes, thanks, I added it.", "url": "https://github.com/hortonworks/cloudbreak/pull/7320#discussion_r383985565", "createdAt": "2020-02-25T16:18:14Z", "author": {"login": "gergopapi2"}, "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/AzureNetworkConnector.java", "diffHunk": "@@ -137,6 +139,16 @@ public String getNetworkCidr(Network network, CloudCredential credential) {\n         return networkCidrs.get(0);\n     }\n \n+    @Override\n+    public List<CloudSubnet> selectSubnets(List<CloudSubnet> subnetMetas, SubnetSelectionParameters subnetSelectionParameters) {\n+        if (subnetMetas.isEmpty()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE2MTg2Nw=="}, "originalCommit": {"oid": "2cbf1fe59e511ba0f734de74b0fb86f974515c44"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3MjUyMzQ2OnYy", "diffSide": "RIGHT", "path": "cloud-mock/src/main/java/com/sequenceiq/cloudbreak/cloud/mock/MockNetworkConnector.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQwOTo0NTo0N1rOFtaXeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxNjoxODoyMFrOFuMn4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE2MjIzMg==", "bodyText": "same here, check if it's null", "url": "https://github.com/hortonworks/cloudbreak/pull/7320#discussion_r383162232", "createdAt": "2020-02-24T09:45:47Z", "author": {"login": "lacikaaa"}, "path": "cloud-mock/src/main/java/com/sequenceiq/cloudbreak/cloud/mock/MockNetworkConnector.java", "diffHunk": "@@ -45,6 +55,16 @@ public String getNetworkCidr(Network network, CloudCredential credential) {\n         return \"10.0.0.0/8\";\n     }\n \n+    @Override\n+    public List<CloudSubnet> selectSubnets(List<CloudSubnet> subnetMetas, SubnetSelectionParameters subnetSelectionParameters) {\n+        if (subnetMetas.isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2cbf1fe59e511ba0f734de74b0fb86f974515c44"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzk4NTYzMg==", "bodyText": "Did it.", "url": "https://github.com/hortonworks/cloudbreak/pull/7320#discussion_r383985632", "createdAt": "2020-02-25T16:18:20Z", "author": {"login": "gergopapi2"}, "path": "cloud-mock/src/main/java/com/sequenceiq/cloudbreak/cloud/mock/MockNetworkConnector.java", "diffHunk": "@@ -45,6 +55,16 @@ public String getNetworkCidr(Network network, CloudCredential credential) {\n         return \"10.0.0.0/8\";\n     }\n \n+    @Override\n+    public List<CloudSubnet> selectSubnets(List<CloudSubnet> subnetMetas, SubnetSelectionParameters subnetSelectionParameters) {\n+        if (subnetMetas.isEmpty()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE2MjIzMg=="}, "originalCommit": {"oid": "2cbf1fe59e511ba0f734de74b0fb86f974515c44"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3MjU0NzAzOnYy", "diffSide": "RIGHT", "path": "redbeams/src/main/java/com/sequenceiq/redbeams/service/network/SubnetChooserService.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQwOTo1MjowMFrOFtakjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQwNzozNDoxMlrOFugs6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE2NTU4MQ==", "bodyText": "I would move this logic into DBStack as it could be reused there.\nalso the CloudPlatform parameter is not necessary, as it's in dbStack", "url": "https://github.com/hortonworks/cloudbreak/pull/7320#discussion_r383165581", "createdAt": "2020-02-24T09:52:00Z", "author": {"login": "lacikaaa"}, "path": "redbeams/src/main/java/com/sequenceiq/redbeams/service/network/SubnetChooserService.java", "diffHunk": "@@ -7,38 +7,41 @@\n \n import org.springframework.stereotype.Service;\n \n+import com.sequenceiq.cloudbreak.cloud.init.CloudPlatformConnectors;\n+import com.sequenceiq.cloudbreak.cloud.model.CloudPlatformVariant;\n import com.sequenceiq.cloudbreak.cloud.model.CloudSubnet;\n+import com.sequenceiq.cloudbreak.cloud.model.SubnetSelectionParameters;\n import com.sequenceiq.cloudbreak.common.mappable.CloudPlatform;\n-import com.sequenceiq.redbeams.exception.BadRequestException;\n-import com.sequenceiq.redbeams.exception.RedbeamsException;\n+import com.sequenceiq.redbeams.api.endpoint.v4.stacks.aws.AwsDatabaseServerV4Parameters;\n+import com.sequenceiq.redbeams.domain.stack.DBStack;\n \n @Service\n public class SubnetChooserService {\n \n     @Inject\n-    private AwsSubnetChooser awsSubnetChooser;\n-\n-    public List<CloudSubnet> chooseSubnets(List<CloudSubnet> subnetMetas, CloudPlatform cloudPlatform, Map<String, String> dbParameters) {\n-        switch (cloudPlatform) {\n-            case AWS:\n-                return awsSubnetChooser.chooseSubnets(subnetMetas, dbParameters);\n-            case AZURE:\n-                return chooseSubnetsAzure(subnetMetas);\n-            case MOCK:\n-                return chooseSubnetsMock(subnetMetas);\n-            default:\n-                throw new RedbeamsException(String.format(\"Support for cloud platform %s not yet added\", cloudPlatform.name()));\n-        }\n+    private CloudPlatformConnectors cloudPlatformConnectors;\n+\n+    public List<CloudSubnet> chooseSubnets(List<CloudSubnet> subnetMetas, CloudPlatform cloudPlatform, DBStack dbStack) {\n+        return cloudPlatformConnectors.get(new CloudPlatformVariant(dbStack.getCloudPlatform(), dbStack.getPlatformVariant()))\n+                .networkConnector()\n+                .selectSubnets(\n+                        subnetMetas,\n+                        SubnetSelectionParameters.builder()\n+                                .withHa(isHa(cloudPlatform, dbStack))\n+                                .withPreferPrivateNetwork()\n+                                .build()\n+                );\n     }\n \n-    private List<CloudSubnet> chooseSubnetsAzure(List<CloudSubnet> subnetMetas) {\n-        if (subnetMetas.isEmpty()) {\n-            throw new BadRequestException(\"Insufficient number of subnets: at least one subnet needed\");\n+    private boolean isHa(CloudPlatform cloudPlatform, DBStack dbStack) {\n+        boolean ha = true;\n+        if (CloudPlatform.AWS.equals(cloudPlatform)) {\n+            ha = !isAwsNoHaRequested(dbStack.getParameters());\n         }\n-        return subnetMetas.subList(0, 1);\n+        return ha;\n     }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2cbf1fe59e511ba0f734de74b0fb86f974515c44"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDMxNDYwMA==", "bodyText": "Great idea, this belongs there. Did it.\nOn the other hand, cloudPlatform in DBStack is a string. I did not want to convert again.", "url": "https://github.com/hortonworks/cloudbreak/pull/7320#discussion_r384314600", "createdAt": "2020-02-26T07:34:12Z", "author": {"login": "gergopapi2"}, "path": "redbeams/src/main/java/com/sequenceiq/redbeams/service/network/SubnetChooserService.java", "diffHunk": "@@ -7,38 +7,41 @@\n \n import org.springframework.stereotype.Service;\n \n+import com.sequenceiq.cloudbreak.cloud.init.CloudPlatformConnectors;\n+import com.sequenceiq.cloudbreak.cloud.model.CloudPlatformVariant;\n import com.sequenceiq.cloudbreak.cloud.model.CloudSubnet;\n+import com.sequenceiq.cloudbreak.cloud.model.SubnetSelectionParameters;\n import com.sequenceiq.cloudbreak.common.mappable.CloudPlatform;\n-import com.sequenceiq.redbeams.exception.BadRequestException;\n-import com.sequenceiq.redbeams.exception.RedbeamsException;\n+import com.sequenceiq.redbeams.api.endpoint.v4.stacks.aws.AwsDatabaseServerV4Parameters;\n+import com.sequenceiq.redbeams.domain.stack.DBStack;\n \n @Service\n public class SubnetChooserService {\n \n     @Inject\n-    private AwsSubnetChooser awsSubnetChooser;\n-\n-    public List<CloudSubnet> chooseSubnets(List<CloudSubnet> subnetMetas, CloudPlatform cloudPlatform, Map<String, String> dbParameters) {\n-        switch (cloudPlatform) {\n-            case AWS:\n-                return awsSubnetChooser.chooseSubnets(subnetMetas, dbParameters);\n-            case AZURE:\n-                return chooseSubnetsAzure(subnetMetas);\n-            case MOCK:\n-                return chooseSubnetsMock(subnetMetas);\n-            default:\n-                throw new RedbeamsException(String.format(\"Support for cloud platform %s not yet added\", cloudPlatform.name()));\n-        }\n+    private CloudPlatformConnectors cloudPlatformConnectors;\n+\n+    public List<CloudSubnet> chooseSubnets(List<CloudSubnet> subnetMetas, CloudPlatform cloudPlatform, DBStack dbStack) {\n+        return cloudPlatformConnectors.get(new CloudPlatformVariant(dbStack.getCloudPlatform(), dbStack.getPlatformVariant()))\n+                .networkConnector()\n+                .selectSubnets(\n+                        subnetMetas,\n+                        SubnetSelectionParameters.builder()\n+                                .withHa(isHa(cloudPlatform, dbStack))\n+                                .withPreferPrivateNetwork()\n+                                .build()\n+                );\n     }\n \n-    private List<CloudSubnet> chooseSubnetsAzure(List<CloudSubnet> subnetMetas) {\n-        if (subnetMetas.isEmpty()) {\n-            throw new BadRequestException(\"Insufficient number of subnets: at least one subnet needed\");\n+    private boolean isHa(CloudPlatform cloudPlatform, DBStack dbStack) {\n+        boolean ha = true;\n+        if (CloudPlatform.AWS.equals(cloudPlatform)) {\n+            ha = !isAwsNoHaRequested(dbStack.getParameters());\n         }\n-        return subnetMetas.subList(0, 1);\n+        return ha;\n     }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE2NTU4MQ=="}, "originalCommit": {"oid": "2cbf1fe59e511ba0f734de74b0fb86f974515c44"}, "originalPosition": 55}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2863, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}