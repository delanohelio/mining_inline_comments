{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA4NzY1MzUz", "number": 7895, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQyMTozNzoxOFrOD191dw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxMTozNDoxMlrOD2ohzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3OTE0MjMxOnYy", "diffSide": "RIGHT", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/controller/UserV1Controller.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQyMTozNzoxOFrOGLqIHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QwNzowMzo0NFrOGMT2Og==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg3NzcyNA==", "bodyText": "you should also allow setting the account id to your own account", "url": "https://github.com/hortonworks/cloudbreak/pull/7895#discussion_r414877724", "createdAt": "2020-04-24T21:37:18Z", "author": {"login": "handavid"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/controller/UserV1Controller.java", "diffHunk": "@@ -107,6 +109,16 @@ public SyncOperationStatus getSyncOperationStatus(@NotNull String operationId) {\n                 operationService.getOperationForAccountIdAndOperationId(accountId, operationId));\n     }\n \n+    private String determineAccountId(String callingActor, String requestedAccountId) {\n+        if (requestedAccountId == null) {\n+            return ThreadBasedUserCrnProvider.getAccountId();\n+        }\n+        if (!InternalCrnBuilder.isInternalCrn(callingActor)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "407e1094f8a84f499a3849c34ee8f48fd1d2bfff"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU2MTI3NA==", "bodyText": "Fixed.", "url": "https://github.com/hortonworks/cloudbreak/pull/7895#discussion_r415561274", "createdAt": "2020-04-27T07:03:44Z", "author": {"login": "aarman-cloudera"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/controller/UserV1Controller.java", "diffHunk": "@@ -107,6 +109,16 @@ public SyncOperationStatus getSyncOperationStatus(@NotNull String operationId) {\n                 operationService.getOperationForAccountIdAndOperationId(accountId, operationId));\n     }\n \n+    private String determineAccountId(String callingActor, String requestedAccountId) {\n+        if (requestedAccountId == null) {\n+            return ThreadBasedUserCrnProvider.getAccountId();\n+        }\n+        if (!InternalCrnBuilder.isInternalCrn(callingActor)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg3NzcyNA=="}, "originalCommit": {"oid": "407e1094f8a84f499a3849c34ee8f48fd1d2bfff"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3OTE1MTg1OnYy", "diffSide": "RIGHT", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQyMTo0MDozN1rOGLqNnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQyMTo0MDozN1rOGLqNnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg3OTEzMg==", "bodyText": "actor crn not needed here", "url": "https://github.com/hortonworks/cloudbreak/pull/7895#discussion_r414879132", "createdAt": "2020-04-24T21:40:37Z", "author": {"login": "handavid"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java", "diffHunk": "@@ -402,6 +402,16 @@ void validateParameters(String accountId, String actorCrn, Set<String> environme\n         validateCrnFilter(environmentCrnFilter, Crn.ResourceType.ENVIRONMENT);\n         validateCrnFilter(userCrnFilter, Crn.ResourceType.USER);\n         validateCrnFilter(machineUserCrnFilter, Crn.ResourceType.MACHINE_USER);\n+        validateSameAccount(actorCrn, accountId, Iterables.concat(environmentCrnFilter, userCrnFilter, machineUserCrnFilter));\n+    }\n+\n+    private void validateSameAccount(String actorCrn, String accountId, Iterable<String> crns) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "407e1094f8a84f499a3849c34ee8f48fd1d2bfff"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU4NjEzNzExOnYy", "diffSide": "RIGHT", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/controller/UserV1Controller.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxMTozNDoxMlrOGMegbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQwNjo0MDoyNFrOGNE86w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTczNTkxNw==", "bodyText": "do we really want to propagate that information to customers if somehow they can invoke it with different accountid?", "url": "https://github.com/hortonworks/cloudbreak/pull/7895#discussion_r415735917", "createdAt": "2020-04-27T11:34:12Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/controller/UserV1Controller.java", "diffHunk": "@@ -107,6 +109,17 @@ public SyncOperationStatus getSyncOperationStatus(@NotNull String operationId) {\n                 operationService.getOperationForAccountIdAndOperationId(accountId, operationId));\n     }\n \n+    private String determineAccountId(String callingActor, String requestedAccountId) {\n+        if (requestedAccountId == null) {\n+            return ThreadBasedUserCrnProvider.getAccountId();\n+        }\n+        String callingActorAccountId = Crn.safeFromString(callingActor).getAccountId();\n+        if (!callingActorAccountId.equals(requestedAccountId) && !InternalCrnBuilder.isInternalCrn(callingActor)) {\n+            throw new BadRequestException(\"Only the internal actor can set a different accountId\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18458c58ca756886234e29dcee497c257752a9b7"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTk3ODQyNA==", "bodyText": "I think that permission denied be more appropriate than bad request then.\nThe message should just say that the user isn't allowed to make this call. I agree that we don't want to reveal that internal actors exist.", "url": "https://github.com/hortonworks/cloudbreak/pull/7895#discussion_r415978424", "createdAt": "2020-04-27T16:48:57Z", "author": {"login": "handavid"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/controller/UserV1Controller.java", "diffHunk": "@@ -107,6 +109,17 @@ public SyncOperationStatus getSyncOperationStatus(@NotNull String operationId) {\n                 operationService.getOperationForAccountIdAndOperationId(accountId, operationId));\n     }\n \n+    private String determineAccountId(String callingActor, String requestedAccountId) {\n+        if (requestedAccountId == null) {\n+            return ThreadBasedUserCrnProvider.getAccountId();\n+        }\n+        String callingActorAccountId = Crn.safeFromString(callingActor).getAccountId();\n+        if (!callingActorAccountId.equals(requestedAccountId) && !InternalCrnBuilder.isInternalCrn(callingActor)) {\n+            throw new BadRequestException(\"Only the internal actor can set a different accountId\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTczNTkxNw=="}, "originalCommit": {"oid": "18458c58ca756886234e29dcee497c257752a9b7"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjA1NjE5NQ==", "bodyText": "We're not exposing this to customers (they won't have an option to set an accountId through public api). They might somehow figure out how to call this endpoint without going through the public api but we don't need to give friendly message in this case. The message as it is right now is more useful to internal developers.", "url": "https://github.com/hortonworks/cloudbreak/pull/7895#discussion_r416056195", "createdAt": "2020-04-27T18:37:51Z", "author": {"login": "aarman-cloudera"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/controller/UserV1Controller.java", "diffHunk": "@@ -107,6 +109,17 @@ public SyncOperationStatus getSyncOperationStatus(@NotNull String operationId) {\n                 operationService.getOperationForAccountIdAndOperationId(accountId, operationId));\n     }\n \n+    private String determineAccountId(String callingActor, String requestedAccountId) {\n+        if (requestedAccountId == null) {\n+            return ThreadBasedUserCrnProvider.getAccountId();\n+        }\n+        String callingActorAccountId = Crn.safeFromString(callingActor).getAccountId();\n+        if (!callingActorAccountId.equals(requestedAccountId) && !InternalCrnBuilder.isInternalCrn(callingActor)) {\n+            throw new BadRequestException(\"Only the internal actor can set a different accountId\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTczNTkxNw=="}, "originalCommit": {"oid": "18458c58ca756886234e29dcee497c257752a9b7"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjA4NTI3MA==", "bodyText": "I agree that it should be Permission Denied.  I would prefer to have the same exception message as thrown by the Scrutinizer (see validateActorCrnInAccountOrInternal). You can put any other information you think is useful in a log message.", "url": "https://github.com/hortonworks/cloudbreak/pull/7895#discussion_r416085270", "createdAt": "2020-04-27T19:22:40Z", "author": {"login": "giladwolff"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/controller/UserV1Controller.java", "diffHunk": "@@ -107,6 +109,17 @@ public SyncOperationStatus getSyncOperationStatus(@NotNull String operationId) {\n                 operationService.getOperationForAccountIdAndOperationId(accountId, operationId));\n     }\n \n+    private String determineAccountId(String callingActor, String requestedAccountId) {\n+        if (requestedAccountId == null) {\n+            return ThreadBasedUserCrnProvider.getAccountId();\n+        }\n+        String callingActorAccountId = Crn.safeFromString(callingActor).getAccountId();\n+        if (!callingActorAccountId.equals(requestedAccountId) && !InternalCrnBuilder.isInternalCrn(callingActor)) {\n+            throw new BadRequestException(\"Only the internal actor can set a different accountId\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTczNTkxNw=="}, "originalCommit": {"oid": "18458c58ca756886234e29dcee497c257752a9b7"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjM2NTgwMw==", "bodyText": "Thanks, I've made the changes.", "url": "https://github.com/hortonworks/cloudbreak/pull/7895#discussion_r416365803", "createdAt": "2020-04-28T06:40:24Z", "author": {"login": "aarman-cloudera"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/controller/UserV1Controller.java", "diffHunk": "@@ -107,6 +109,17 @@ public SyncOperationStatus getSyncOperationStatus(@NotNull String operationId) {\n                 operationService.getOperationForAccountIdAndOperationId(accountId, operationId));\n     }\n \n+    private String determineAccountId(String callingActor, String requestedAccountId) {\n+        if (requestedAccountId == null) {\n+            return ThreadBasedUserCrnProvider.getAccountId();\n+        }\n+        String callingActorAccountId = Crn.safeFromString(callingActor).getAccountId();\n+        if (!callingActorAccountId.equals(requestedAccountId) && !InternalCrnBuilder.isInternalCrn(callingActor)) {\n+            throw new BadRequestException(\"Only the internal actor can set a different accountId\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTczNTkxNw=="}, "originalCommit": {"oid": "18458c58ca756886234e29dcee497c257752a9b7"}, "originalPosition": 28}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2497, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}