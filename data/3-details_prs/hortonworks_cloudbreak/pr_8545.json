{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ4Njg3OTQw", "number": 8545, "title": "CB-7741: Allow upgrade with same runtime and different GBN", "bodyText": "See detailed description in the commit message.", "createdAt": "2020-07-14T06:59:34Z", "url": "https://github.com/hortonworks/cloudbreak/pull/8545", "merged": true, "mergeCommit": {"oid": "5ac55a7722b2550c4bafbea45c2e74f8d2d1c86f"}, "closed": true, "closedAt": "2020-07-17T17:00:19Z", "author": {"login": "tiborpopovics"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc06raDgBqjM1NDU0NzYxMTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc12bABAFqTQ1MDc5NjI3OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4d8dbcd29e58ba72d564d25b00ecc05641ffab4b", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/4d8dbcd29e58ba72d564d25b00ecc05641ffab4b", "committedDate": "2020-07-14T06:58:39Z", "message": "CB-7741: Allow upgrade with same runtime and different GBN"}, "afterCommit": {"oid": "a3371c42292c1a89011901621c8e7b04ad4e02a8", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/a3371c42292c1a89011901621c8e7b04ad4e02a8", "committedDate": "2020-07-14T18:51:47Z", "message": "CB-7741: Allow upgrade with same runtime and different GBN"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4ODU3MDUy", "url": "https://github.com/hortonworks/cloudbreak/pull/8545#pullrequestreview-448857052", "createdAt": "2020-07-15T11:16:34Z", "commit": {"oid": "a3371c42292c1a89011901621c8e7b04ad4e02a8"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxMToxNjozNFrOGx5iCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxMToyODo0NlrOGx54hA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk3NjAwOA==", "bodyText": "pls do this in an NPE safe way", "url": "https://github.com/hortonworks/cloudbreak/pull/8545#discussion_r454976008", "createdAt": "2020-07-15T11:16:34Z", "author": {"login": "pdarvasi"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/service/upgrade/ClusterUpgradeImageFilter.java", "diffHunk": "@@ -109,9 +116,11 @@ private boolean permitLockedComponentsUpgrade(Image currentImage, Image image) {\n         return currentImagePackageVersions.equals(imagePackageVersions);\n     }\n \n-    private boolean permitCmAndStackUpgrade(Image currentImage, Image image, String key) {\n-        return upgradePermissionProvider.permitCmAndStackUpgrade(currentImage.getPackageVersions().get(key),\n-                image.getPackageVersions().get(key));\n+    private boolean permitCmAndStackUpgrade(Image currentImage, Image image, String versionKey, String buildNumberKey) {\n+        String currentVersion = currentImage.getPackageVersions().get(versionKey);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3371c42292c1a89011901621c8e7b04ad4e02a8"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk3NjI2MQ==", "bodyText": "pls do this in an NPE safe way", "url": "https://github.com/hortonworks/cloudbreak/pull/8545#discussion_r454976261", "createdAt": "2020-07-15T11:17:08Z", "author": {"login": "pdarvasi"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/service/upgrade/ClusterUpgradeImageFilter.java", "diffHunk": "@@ -109,9 +116,11 @@ private boolean permitLockedComponentsUpgrade(Image currentImage, Image image) {\n         return currentImagePackageVersions.equals(imagePackageVersions);\n     }\n \n-    private boolean permitCmAndStackUpgrade(Image currentImage, Image image, String key) {\n-        return upgradePermissionProvider.permitCmAndStackUpgrade(currentImage.getPackageVersions().get(key),\n-                image.getPackageVersions().get(key));\n+    private boolean permitCmAndStackUpgrade(Image currentImage, Image image, String versionKey, String buildNumberKey) {\n+        String currentVersion = currentImage.getPackageVersions().get(versionKey);\n+        String newVersion = image.getPackageVersions().get(versionKey);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3371c42292c1a89011901621c8e7b04ad4e02a8"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk4MTc2NA==", "bodyText": "logically, this should be part of permitCmAndStackUpgrade method otherwise, it might be misleading, couldn't it?", "url": "https://github.com/hortonworks/cloudbreak/pull/8545#discussion_r454981764", "createdAt": "2020-07-15T11:28:46Z", "author": {"login": "pdarvasi"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/service/upgrade/ClusterUpgradeImageFilter.java", "diffHunk": "@@ -109,9 +116,11 @@ private boolean permitLockedComponentsUpgrade(Image currentImage, Image image) {\n         return currentImagePackageVersions.equals(imagePackageVersions);\n     }\n \n-    private boolean permitCmAndStackUpgrade(Image currentImage, Image image, String key) {\n-        return upgradePermissionProvider.permitCmAndStackUpgrade(currentImage.getPackageVersions().get(key),\n-                image.getPackageVersions().get(key));\n+    private boolean permitCmAndStackUpgrade(Image currentImage, Image image, String versionKey, String buildNumberKey) {\n+        String currentVersion = currentImage.getPackageVersions().get(versionKey);\n+        String newVersion = image.getPackageVersions().get(versionKey);\n+        return upgradePermissionProvider.permitCmAndStackUpgrade(currentVersion, newVersion)\n+                || (currentVersion.equals(newVersion) && componentBuildNumberComparator.compare(currentImage, image, buildNumberKey));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3371c42292c1a89011901621c8e7b04ad4e02a8"}, "originalPosition": 42}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a3371c42292c1a89011901621c8e7b04ad4e02a8", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/a3371c42292c1a89011901621c8e7b04ad4e02a8", "committedDate": "2020-07-14T18:51:47Z", "message": "CB-7741: Allow upgrade with same runtime and different GBN"}, "afterCommit": {"oid": "dca7652530d006b32d03dc71d2e8efdbcc8ed33b", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/dca7652530d006b32d03dc71d2e8efdbcc8ed33b", "committedDate": "2020-07-17T08:22:45Z", "message": "CB-7741: Allow upgrade with same runtime and different GBN"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dca7652530d006b32d03dc71d2e8efdbcc8ed33b", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/dca7652530d006b32d03dc71d2e8efdbcc8ed33b", "committedDate": "2020-07-17T08:22:45Z", "message": "CB-7741: Allow upgrade with same runtime and different GBN"}, "afterCommit": {"oid": "cb4786a9167697cc9d6432a5fdf508454827995d", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/cb4786a9167697cc9d6432a5fdf508454827995d", "committedDate": "2020-07-17T14:45:24Z", "message": "CB-7741: Allow upgrade with same runtime and different GBN"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82a588d5127bb8b91ea457c3540e2805e4694b92", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/82a588d5127bb8b91ea457c3540e2805e4694b92", "committedDate": "2020-07-17T15:19:43Z", "message": "CB-7741: Allow upgrade with same runtime and different GBN"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cb4786a9167697cc9d6432a5fdf508454827995d", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/cb4786a9167697cc9d6432a5fdf508454827995d", "committedDate": "2020-07-17T14:45:24Z", "message": "CB-7741: Allow upgrade with same runtime and different GBN"}, "afterCommit": {"oid": "82a588d5127bb8b91ea457c3540e2805e4694b92", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/82a588d5127bb8b91ea457c3540e2805e4694b92", "committedDate": "2020-07-17T15:19:43Z", "message": "CB-7741: Allow upgrade with same runtime and different GBN"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwNzk2Mjc4", "url": "https://github.com/hortonworks/cloudbreak/pull/8545#pullrequestreview-450796278", "createdAt": "2020-07-17T16:28:26Z", "commit": {"oid": "82a588d5127bb8b91ea457c3540e2805e4694b92"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2577, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}