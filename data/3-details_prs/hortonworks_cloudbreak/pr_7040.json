{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYxMDA2MjY5", "number": 7040, "title": "CB-4952 Add last heartbeat check when waiting for agents", "bodyText": "", "createdAt": "2020-01-09T15:07:18Z", "url": "https://github.com/hortonworks/cloudbreak/pull/7040", "merged": true, "mergeCommit": {"oid": "2d4f62333d7ef90a68b566b89ab6e42b62cc9258"}, "closed": true, "closedAt": "2020-01-11T07:03:51Z", "author": {"login": "lacikaaa"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb4rdjQgFqTM0MDU5MTMyNw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb5CnPYgBqjI5Mzk0MDE3MDc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwNTkxMzI3", "url": "https://github.com/hortonworks/cloudbreak/pull/7040#pullrequestreview-340591327", "createdAt": "2020-01-09T15:12:52Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQxNToxMjo1MlrOFb5Lng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQxNToxMjo1MlrOFb5Lng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDc5MjczNA==", "bodyText": "Instead of now I would call it start as it's kind of misleading.", "url": "https://github.com/hortonworks/cloudbreak/pull/7040#discussion_r364792734", "createdAt": "2020-01-09T15:12:52Z", "author": {"login": "keyki"}, "path": "cluster-cm/src/main/java/com/sequenceiq/cloudbreak/cm/polling/task/ClouderaManagerHostStatusChecker.java", "diffHunk": "@@ -48,6 +41,31 @@ protected boolean doStatusCheck(ClouderaManagerPollerObject pollerObject, Comman\n         }\n     }\n \n+    private List<InstanceMetaData> collectNotKnownInstancesByManager(ClouderaManagerPollerObject pollerObject, List<String> hostIpsFromManager) {\n+        return pollerObject.getStack().getInstanceMetaDataAsList().stream()\n+                    .filter(metaData -> metaData.getDiscoveryFQDN() != null)\n+                    .filter(metaData -> !metaData.isTerminated() && !metaData.isDeletedOnProvider())\n+                    .filter(metaData -> !hostIpsFromManager.contains(metaData.getPrivateIp()))\n+                    .collect(Collectors.toList());\n+    }\n+\n+    private List<String> fetchHeartbeatedHostIpsFromManager(ClouderaManagerPollerObject pollerObject) throws ApiException {\n+        HostsResourceApi hostsResourceApi = new HostsResourceApi(pollerObject.getApiClient());\n+        String viewType = \"FULL\";\n+        ApiHostList hostList = hostsResourceApi.readHosts(viewType);\n+        List<String> hostIpsFromManager = filterForHeartBeatedIps(hostList);\n+        LOGGER.debug(\"Hosts in the list from manager: \" + hostIpsFromManager);\n+        return hostIpsFromManager;\n+    }\n+\n+    private List<String> filterForHeartBeatedIps(ApiHostList hostList) {\n+        return hostList.getItems().stream()\n+                    .filter(item -> StringUtils.isNotBlank(item.getLastHeartbeat()))\n+                    .filter(item -> now.isBefore(Instant.parse(item.getLastHeartbeat())))", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 67}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "febe1d35993cead833d1ddc95f1dd99d517757f0", "author": {"user": {"login": "lacikaaa", "name": "Mihaly Laszlo Molnar"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/febe1d35993cead833d1ddc95f1dd99d517757f0", "committedDate": "2020-01-09T15:18:33Z", "message": "CB-4952 Add last heartbeat check when waiting for agents"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwNjAxMTYw", "url": "https://github.com/hortonworks/cloudbreak/pull/7040#pullrequestreview-340601160", "createdAt": "2020-01-09T15:25:13Z", "commit": {"oid": "febe1d35993cead833d1ddc95f1dd99d517757f0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxMDEzMDkw", "url": "https://github.com/hortonworks/cloudbreak/pull/7040#pullrequestreview-341013090", "createdAt": "2020-01-10T08:31:54Z", "commit": {"oid": "febe1d35993cead833d1ddc95f1dd99d517757f0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxMDEzNTY1", "url": "https://github.com/hortonworks/cloudbreak/pull/7040#pullrequestreview-341013565", "createdAt": "2020-01-10T08:33:00Z", "commit": {"oid": "febe1d35993cead833d1ddc95f1dd99d517757f0"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "febe1d35993cead833d1ddc95f1dd99d517757f0", "author": {"user": {"login": "lacikaaa", "name": "Mihaly Laszlo Molnar"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/febe1d35993cead833d1ddc95f1dd99d517757f0", "committedDate": "2020-01-09T15:18:33Z", "message": "CB-4952 Add last heartbeat check when waiting for agents"}, "afterCommit": {"oid": "615a003b582bad268bc27adca50f8107285d0dac", "author": {"user": {"login": "lacikaaa", "name": "Mihaly Laszlo Molnar"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/615a003b582bad268bc27adca50f8107285d0dac", "committedDate": "2020-01-10T11:19:52Z", "message": "CB-4952 Add last heartbeat check when waiting for agents"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "615a003b582bad268bc27adca50f8107285d0dac", "author": {"user": {"login": "lacikaaa", "name": "Mihaly Laszlo Molnar"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/615a003b582bad268bc27adca50f8107285d0dac", "committedDate": "2020-01-10T11:19:52Z", "message": "CB-4952 Add last heartbeat check when waiting for agents"}, "afterCommit": {"oid": "31ea1d9f7d5cdfb7ae2041e260ab86e29c52cb69", "author": {"user": {"login": "lacikaaa", "name": "Mihaly Laszlo Molnar"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/31ea1d9f7d5cdfb7ae2041e260ab86e29c52cb69", "committedDate": "2020-01-10T14:00:14Z", "message": "CB-4952 Add last heartbeat check when waiting for agents"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxMTg1OTk2", "url": "https://github.com/hortonworks/cloudbreak/pull/7040#pullrequestreview-341185996", "createdAt": "2020-01-10T14:12:58Z", "commit": {"oid": "31ea1d9f7d5cdfb7ae2041e260ab86e29c52cb69"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c16399e9caafe908ec4129e210e2c5195f6e4ac5", "author": {"user": {"login": "lacikaaa", "name": "Mihaly Laszlo Molnar"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/c16399e9caafe908ec4129e210e2c5195f6e4ac5", "committedDate": "2020-01-10T18:10:55Z", "message": "CB-4952 Add last heartbeat check when waiting for agents"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "31ea1d9f7d5cdfb7ae2041e260ab86e29c52cb69", "author": {"user": {"login": "lacikaaa", "name": "Mihaly Laszlo Molnar"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/31ea1d9f7d5cdfb7ae2041e260ab86e29c52cb69", "committedDate": "2020-01-10T14:00:14Z", "message": "CB-4952 Add last heartbeat check when waiting for agents"}, "afterCommit": {"oid": "c16399e9caafe908ec4129e210e2c5195f6e4ac5", "author": {"user": {"login": "lacikaaa", "name": "Mihaly Laszlo Molnar"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/c16399e9caafe908ec4129e210e2c5195f6e4ac5", "committedDate": "2020-01-10T18:10:55Z", "message": "CB-4952 Add last heartbeat check when waiting for agents"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1958, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}