{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkzMzQzMzQz", "number": 7643, "title": "CB-6251: Could not reboot stopped FreeIPA", "bodyText": "This change adjusts the reboot to properly reboot only started instances and\nto call start on stopped instances. Because of AWS lifecycle\nhttps://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-lifecycle.html\nother statuses cannot be started or rebooted.\nManually tested against 3 node FreeIPA with instances in various states, including\nstarted, stopped, terminated.", "createdAt": "2020-03-25T02:04:17Z", "url": "https://github.com/hortonworks/cloudbreak/pull/7643", "merged": true, "mergeCommit": {"oid": "50f8a95712e150c95c005a19f225e95f23e0b5cc"}, "closed": true, "closedAt": "2020-03-26T07:17:01Z", "author": {"login": "holleyism"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcQ96y7ABqjMxNjIyMTg4NjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcRJ38pgFqTM4MTMwNzA3Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2832102dbff25dd4888d37e60edfdb5bf83f8126", "author": {"user": {"login": "holleyism", "name": "Adam Holley"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/2832102dbff25dd4888d37e60edfdb5bf83f8126", "committedDate": "2020-03-25T01:59:52Z", "message": "CB-6251: Could not reboot stopped FreeIPA\n\nThis change adjusts the reboot to properly reboot only started instances and\nto call start on stopped instances. Because of AWS lifecycle\nhttps://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-lifecycle.html\nother statuses cannot be started or rebooted."}, "afterCommit": {"oid": "50d22c381bf23d0715363758a054aa29b0b46e06", "author": {"user": {"login": "holleyism", "name": "Adam Holley"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/50d22c381bf23d0715363758a054aa29b0b46e06", "committedDate": "2020-03-25T02:17:03Z", "message": "CB-6251: Could not reboot stopped FreeIPA\n\nThis change adjusts the reboot to properly reboot only started instances and\nto call start on stopped instances. Because of AWS lifecycle\nhttps://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-lifecycle.html\nother statuses cannot be started or rebooted."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwOTEzNjkx", "url": "https://github.com/hortonworks/cloudbreak/pull/7643#pullrequestreview-380913691", "createdAt": "2020-03-25T07:45:02Z", "commit": {"oid": "50d22c381bf23d0715363758a054aa29b0b46e06"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwNzo0NTowMlrOF7PIaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwNzo0NTowMlrOF7PIaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzY1ODIxOQ==", "bodyText": "could you move these stream parameters into variables or even to methods?", "url": "https://github.com/hortonworks/cloudbreak/pull/7643#discussion_r397658219", "createdAt": "2020-03-25T07:45:02Z", "author": {"login": "lacikaaa"}, "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/AwsInstanceConnector.java", "diffHunk": "@@ -133,18 +133,52 @@ public String getConsoleOutput(AuthenticatedContext authenticatedContext, CloudI\n     public List<CloudVmInstanceStatus> reboot(AuthenticatedContext ac, List<CloudInstance> vms) {\n         AmazonEC2Client amazonEC2Client = awsClient.createAccess(new AwsCredentialView(ac.getCloudCredential()),\n                 ac.getCloudContext().getLocation().getRegion().value());\n+        List<CloudInstance> affectedVms = new ArrayList<>();\n         try {\n-            Collection<String> instances = vms.stream().map(CloudInstance::getInstanceId).collect(Collectors.toSet());\n-            if (!instances.isEmpty()) {\n-                amazonEC2Client.rebootInstances(new RebootInstancesRequest().withInstanceIds(instances));\n+            if (!vms.isEmpty()) {\n+                List<CloudVmInstanceStatus> statuses = check(ac, vms);\n+                doReboot(affectedVms, amazonEC2Client, statuses.stream().filter(status -> status.getStatus() == InstanceStatus.STARTED)\n+                        .map(status -> status.getCloudInstance()).collect(Collectors.toList()));\n+                doStart(affectedVms, ac, statuses.stream().filter(status -> status.getStatus() == InstanceStatus.STOPPED)\n+                        .map(status -> status.getCloudInstance()).collect(Collectors.toList()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50d22c381bf23d0715363758a054aa29b0b46e06"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e788ac7cee2161e64fcfeb4d4725b8e7c61cd11", "author": {"user": {"login": "holleyism", "name": "Adam Holley"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/0e788ac7cee2161e64fcfeb4d4725b8e7c61cd11", "committedDate": "2020-03-25T14:31:28Z", "message": "CB-6251: Could not reboot stopped FreeIPA\n\nThis change adjusts the reboot to properly reboot only started instances and\nto call start on stopped instances. Because of AWS lifecycle\nhttps://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-lifecycle.html\nother statuses cannot be started or rebooted."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "50d22c381bf23d0715363758a054aa29b0b46e06", "author": {"user": {"login": "holleyism", "name": "Adam Holley"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/50d22c381bf23d0715363758a054aa29b0b46e06", "committedDate": "2020-03-25T02:17:03Z", "message": "CB-6251: Could not reboot stopped FreeIPA\n\nThis change adjusts the reboot to properly reboot only started instances and\nto call start on stopped instances. Because of AWS lifecycle\nhttps://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-lifecycle.html\nother statuses cannot be started or rebooted."}, "afterCommit": {"oid": "0e788ac7cee2161e64fcfeb4d4725b8e7c61cd11", "author": {"user": {"login": "holleyism", "name": "Adam Holley"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/0e788ac7cee2161e64fcfeb4d4725b8e7c61cd11", "committedDate": "2020-03-25T14:31:28Z", "message": "CB-6251: Could not reboot stopped FreeIPA\n\nThis change adjusts the reboot to properly reboot only started instances and\nto call start on stopped instances. Because of AWS lifecycle\nhttps://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-lifecycle.html\nother statuses cannot be started or rebooted."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxMzA3MDcz", "url": "https://github.com/hortonworks/cloudbreak/pull/7643#pullrequestreview-381307073", "createdAt": "2020-03-25T16:13:03Z", "commit": {"oid": "0e788ac7cee2161e64fcfeb4d4725b8e7c61cd11"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2510, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}