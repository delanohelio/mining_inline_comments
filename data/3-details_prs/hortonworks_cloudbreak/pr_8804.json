{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY3MjkyMTgw", "number": 8804, "title": "DISTX-529 Autoscaling Notification", "bodyText": "Periscope should send Autoscaling Config Update\\History Event update notifications to UI app.\nSee detailed description in the commit message.", "createdAt": "2020-08-13T10:21:13Z", "url": "https://github.com/hortonworks/cloudbreak/pull/8804", "merged": true, "mergeCommit": {"oid": "723db598a6f793c7b704e2d1911b1948b5547b57"}, "closed": true, "closedAt": "2020-08-14T07:52:04Z", "author": {"login": "smaniraju"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-dba3gBqjM2NTE0Mjk4ODg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-viejgFqTQ2NzM2NDQ1NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "27ecaa4a29a180484f699c1587ce95a4af671467", "author": {"user": {"login": "smaniraju", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/27ecaa4a29a180484f699c1587ce95a4af671467", "committedDate": "2020-08-13T10:17:17Z", "message": "DISTX-529 Autoscaling Notification\n\nPeriscope should send Autoscaling Config Update\\History Event update notifications to UI app."}, "afterCommit": {"oid": "91b1e6135231493c39eb106c7edc2e21b3b69fce", "author": {"user": {"login": "smaniraju", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/91b1e6135231493c39eb106c7edc2e21b3b69fce", "committedDate": "2020-08-13T10:25:41Z", "message": "DISTX-529 Autoscaling Notification\n\nPeriscope should send Autoscaling Config Update\\History Event update notifications to UI app."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2NjM5NDgw", "url": "https://github.com/hortonworks/cloudbreak/pull/8804#pullrequestreview-466639480", "createdAt": "2020-08-13T10:32:06Z", "commit": {"oid": "91b1e6135231493c39eb106c7edc2e21b3b69fce"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxMDozMjowNlrOHAFwEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxMDozMjowNlrOHAFwEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTg1NjI3Mg==", "bodyText": "Defaulting to the same naming convention as in CB .", "url": "https://github.com/hortonworks/cloudbreak/pull/8804#discussion_r469856272", "createdAt": "2020-08-13T10:32:06Z", "author": {"login": "smaniraju"}, "path": "autoscale/src/main/java/com/sequenceiq/periscope/init/DefaultSubscriptionService.java", "diffHunk": "@@ -19,7 +19,7 @@\n \n     private static final String DEFAULT_CLIENT_ID = \"default\";\n \n-    @Value(\"${cb.default.subscription.address:}\")\n+    @Value(\"${cb.notification.endpoint:}\")\n     private String defaultSubscriptionAddress;\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91b1e6135231493c39eb106c7edc2e21b3b69fce"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "281daf11dcfddf3c4af2d8c03248f9a26edc36d2", "author": {"user": {"login": "smaniraju", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/281daf11dcfddf3c4af2d8c03248f9a26edc36d2", "committedDate": "2020-08-13T13:42:01Z", "message": "DISTX-529 Autoscaling Notification\n\nPeriscope should send Autoscaling Config Update\\History Event update notifications to UI app."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "91b1e6135231493c39eb106c7edc2e21b3b69fce", "author": {"user": {"login": "smaniraju", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/91b1e6135231493c39eb106c7edc2e21b3b69fce", "committedDate": "2020-08-13T10:25:41Z", "message": "DISTX-529 Autoscaling Notification\n\nPeriscope should send Autoscaling Config Update\\History Event update notifications to UI app."}, "afterCommit": {"oid": "281daf11dcfddf3c4af2d8c03248f9a26edc36d2", "author": {"user": {"login": "smaniraju", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/281daf11dcfddf3c4af2d8c03248f9a26edc36d2", "committedDate": "2020-08-13T13:42:01Z", "message": "DISTX-529 Autoscaling Notification\n\nPeriscope should send Autoscaling Config Update\\History Event update notifications to UI app."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2NzgyNDUy", "url": "https://github.com/hortonworks/cloudbreak/pull/8804#pullrequestreview-466782452", "createdAt": "2020-08-13T13:52:50Z", "commit": {"oid": "281daf11dcfddf3c4af2d8c03248f9a26edc36d2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxMzo1Mjo1MFrOHAMjGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxMzo1Mjo1MFrOHAMjGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk2NzY0MQ==", "bodyText": "Defaulting to same naming convention as in CB i.e periscope.notification.endpoint.\nThis will also be initialized with pod specific environment value in dps-k8s repository as done in CB.", "url": "https://github.com/hortonworks/cloudbreak/pull/8804#discussion_r469967641", "createdAt": "2020-08-13T13:52:50Z", "author": {"login": "smaniraju"}, "path": "autoscale/src/main/resources/application.yml", "diffHunk": "@@ -44,6 +44,8 @@ periscope:\n       addr: localhost\n       port: 5432\n   cloudbreak.url: http://localhost:9091\n+  notification:\n+    endpoint: http://localhost:3000/notifications\n   entitlementCheckEnabled: true", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "281daf11dcfddf3c4af2d8c03248f9a26edc36d2"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3Mjc2NjY4", "url": "https://github.com/hortonworks/cloudbreak/pull/8804#pullrequestreview-467276668", "createdAt": "2020-08-14T02:57:58Z", "commit": {"oid": "281daf11dcfddf3c4af2d8c03248f9a26edc36d2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwMjo1Nzo1OFrOHAl3zA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwMjo1Nzo1OFrOHAl3zA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM4MjU0MA==", "bodyText": "How will this be rendered on the UI?\ni.e. Will the UI show the eventMessage, or the eventPayload?, and if the eventPayload - is AutoScaleClusterResponse too much information?\nSimilarly for sendConfigUpdateNotification", "url": "https://github.com/hortonworks/cloudbreak/pull/8804#discussion_r470382540", "createdAt": "2020-08-14T02:57:58Z", "author": {"login": "sidseth"}, "path": "autoscale/src/main/java/com/sequenceiq/periscope/notification/HttpNotificationSender.java", "diffHunk": "@@ -26,19 +32,43 @@\n     @Inject\n     private SubscriptionRepository subscriptionRepository;\n \n+    @Inject\n+    private CloudbreakMessagesService messagesService;\n+\n+    @Inject\n+    private HistoryConverter historyConverter;\n+\n+    @Inject\n+    private DistroXAutoscaleClusterResponseConverter autoscaleClusterResponseConverter;\n+\n     private final Client restClient = RestClientUtil.get(new ConfigKey(false, false, false));\n \n-    public void send(Cluster cluster, History history) {\n-        send(convertHistory(cluster, history));\n+    public void sendHistoryUpdateNotification(History historyUpdate, Cluster cluster) {\n+        Notification historyNotification = new Notification();\n+        historyNotification.setTenantName(cluster.getClusterPertain().getTenant());\n+        historyNotification.setEventType(NotificationType.AUTOSCALE_HISTORY_UPDATE.name());\n+        historyNotification.setEventTimestamp(historyUpdate.getTimestamp());\n+        historyNotification.setEventMessage(\n+                messagesService.getMessage(MessageCode.NOTIFICATION_HISTORY_UPDATE));\n+\n+        AutoscaleClusterHistoryResponse historyResponse = historyConverter.convert(historyUpdate);\n+        historyNotification.setPayload(historyResponse);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "281daf11dcfddf3c4af2d8c03248f9a26edc36d2"}, "originalPosition": 47}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3MzY0NDU1", "url": "https://github.com/hortonworks/cloudbreak/pull/8804#pullrequestreview-467364455", "createdAt": "2020-08-14T07:32:35Z", "commit": {"oid": "281daf11dcfddf3c4af2d8c03248f9a26edc36d2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2461, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}