{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIxMDU4MTk1", "number": 8119, "title": "CDPCP-2094. Add API to retrieve user sync state for an environment", "bodyText": "This commit adds a new endpoint for retrieving user sync state for an environment.\nThe state is calculated by looking at the last started full user sync. If the last\nstarted full user sync completed successfully, then the event generation ids for\nthat sync are compared against the current event generation ids from the UMS.", "createdAt": "2020-05-20T22:49:54Z", "url": "https://github.com/hortonworks/cloudbreak/pull/8119", "merged": true, "mergeCommit": {"oid": "af0c05dd9e8465c534ba072a7ef31690df7e511f"}, "closed": true, "closedAt": "2020-05-29T09:02:02Z", "author": {"login": "handavid"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcjaCCFgFqTQxNTk3MzM3MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcl8lDDgFqTQyMDY4NjU3MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1OTczMzcw", "url": "https://github.com/hortonworks/cloudbreak/pull/8119#pullrequestreview-415973370", "createdAt": "2020-05-21T08:36:44Z", "commit": {"oid": "bef06f1a1cf8fd23c35d4a4f33e8cae3deb2142d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwODozNjo0NFrOGYq1RA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwOToxMDoyNlrOGYr0fQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUyMDc3Mg==", "bodyText": "missing @JsonIgnoreProperties(ignoreUnknown = true)", "url": "https://github.com/hortonworks/cloudbreak/pull/8119#discussion_r428520772", "createdAt": "2020-05-21T08:36:44Z", "author": {"login": "lacikaaa"}, "path": "freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/user/model/EnvironmentUserSyncState.java", "diffHunk": "@@ -0,0 +1,31 @@\n+package com.sequenceiq.freeipa.api.v1.freeipa.user.model;\n+\n+import com.sequenceiq.freeipa.api.v1.freeipa.user.doc.UserModelDescriptions;\n+\n+import io.swagger.annotations.ApiModel;\n+import io.swagger.annotations.ApiModelProperty;\n+\n+@ApiModel(\"EnvironmentUserSyncV1State\")\n+public class EnvironmentUserSyncState {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bef06f1a1cf8fd23c35d4a4f33e8cae3deb2142d"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUyMTM2Ng==", "bodyText": "missing @NotNull", "url": "https://github.com/hortonworks/cloudbreak/pull/8119#discussion_r428521366", "createdAt": "2020-05-21T08:38:01Z", "author": {"login": "lacikaaa"}, "path": "freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/user/model/EnvironmentUserSyncState.java", "diffHunk": "@@ -0,0 +1,31 @@\n+package com.sequenceiq.freeipa.api.v1.freeipa.user.model;\n+\n+import com.sequenceiq.freeipa.api.v1.freeipa.user.doc.UserModelDescriptions;\n+\n+import io.swagger.annotations.ApiModel;\n+import io.swagger.annotations.ApiModelProperty;\n+\n+@ApiModel(\"EnvironmentUserSyncV1State\")\n+public class EnvironmentUserSyncState {\n+    @ApiModelProperty(value = UserModelDescriptions.USERSYNC_STATE, required = true)\n+    private UserSyncState state;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bef06f1a1cf8fd23c35d4a4f33e8cae3deb2142d"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUyMzk4OA==", "bodyText": "can we rename these to be a bit more obvious?\nlike: IN_SYNC -> UP_TO_DATE\nSYNCING -> SYNC_IN_PROGRESS\nI'm open to other values, but IN_SYNC is a bit ambiguous for me.", "url": "https://github.com/hortonworks/cloudbreak/pull/8119#discussion_r428523988", "createdAt": "2020-05-21T08:43:11Z", "author": {"login": "lacikaaa"}, "path": "freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/user/model/UserSyncState.java", "diffHunk": "@@ -0,0 +1,7 @@\n+package com.sequenceiq.freeipa.api.v1.freeipa.user.model;\n+\n+public enum UserSyncState {\n+    IN_SYNC,\n+    STALE,\n+    SYNCING", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bef06f1a1cf8fd23c35d4a4f33e8cae3deb2142d"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUyNjYwOQ==", "bodyText": "@NotNull -> @NotEmpty", "url": "https://github.com/hortonworks/cloudbreak/pull/8119#discussion_r428526609", "createdAt": "2020-05-21T08:48:35Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/controller/UserV1Controller.java", "diffHunk": "@@ -109,6 +114,14 @@ public SyncOperationStatus getSyncOperationStatus(@NotNull String operationId) {\n                 operationService.getOperationForAccountIdAndOperationId(accountId, operationId));\n     }\n \n+    @Override\n+    @CheckPermissionByAccount(action = AuthorizationResourceAction.ENVIRONMENT_READ)\n+    public EnvironmentUserSyncState getUserSyncState(@NotNull String environmentCrn) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bef06f1a1cf8fd23c35d4a4f33e8cae3deb2142d"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUyNjk2OA==", "bodyText": "actually ControllerLogContextAspects should log this", "url": "https://github.com/hortonworks/cloudbreak/pull/8119#discussion_r428526968", "createdAt": "2020-05-21T08:49:26Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/controller/UserV1Controller.java", "diffHunk": "@@ -109,6 +114,14 @@ public SyncOperationStatus getSyncOperationStatus(@NotNull String operationId) {\n                 operationService.getOperationForAccountIdAndOperationId(accountId, operationId));\n     }\n \n+    @Override\n+    @CheckPermissionByAccount(action = AuthorizationResourceAction.ENVIRONMENT_READ)\n+    public EnvironmentUserSyncState getUserSyncState(@NotNull String environmentCrn) {\n+        LOGGER.debug(\"getUserSyncState() requested for environment '{}'\", environmentCrn);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bef06f1a1cf8fd23c35d4a4f33e8cae3deb2142d"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUyOTIxMg==", "bodyText": "we should pass the accountId here from ThreadBasedUserCrnProvider", "url": "https://github.com/hortonworks/cloudbreak/pull/8119#discussion_r428529212", "createdAt": "2020-05-21T08:54:10Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/controller/UserV1Controller.java", "diffHunk": "@@ -109,6 +114,14 @@ public SyncOperationStatus getSyncOperationStatus(@NotNull String operationId) {\n                 operationService.getOperationForAccountIdAndOperationId(accountId, operationId));\n     }\n \n+    @Override\n+    @CheckPermissionByAccount(action = AuthorizationResourceAction.ENVIRONMENT_READ)\n+    public EnvironmentUserSyncState getUserSyncState(@NotNull String environmentCrn) {\n+        LOGGER.debug(\"getUserSyncState() requested for environment '{}'\", environmentCrn);\n+\n+        return environmentUserSyncStateCalculator.calculateEnvironmentUserSyncState(Crn.safeFromString(environmentCrn));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bef06f1a1cf8fd23c35d4a4f33e8cae3deb2142d"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUyOTkzMA==", "bodyText": "accountId shouldn't come from the env crn, we might check if it is the same", "url": "https://github.com/hortonworks/cloudbreak/pull/8119#discussion_r428529930", "createdAt": "2020-05-21T08:55:28Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/EnvironmentUserSyncStateCalculator.java", "diffHunk": "@@ -0,0 +1,93 @@\n+package com.sequenceiq.freeipa.service.freeipa.user;\n+\n+import javax.inject.Inject;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Service;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.sequenceiq.cloudbreak.auth.altus.Crn;\n+import com.sequenceiq.cloudbreak.logger.MDCUtils;\n+import com.sequenceiq.freeipa.api.v1.freeipa.user.model.EnvironmentUserSyncState;\n+import com.sequenceiq.freeipa.api.v1.freeipa.user.model.UserSyncState;\n+import com.sequenceiq.freeipa.entity.Operation;\n+import com.sequenceiq.freeipa.entity.Stack;\n+import com.sequenceiq.freeipa.entity.UserSyncStatus;\n+import com.sequenceiq.freeipa.service.freeipa.user.model.UmsEventGenerationIds;\n+import com.sequenceiq.freeipa.service.stack.StackService;\n+\n+@Service\n+public class EnvironmentUserSyncStateCalculator {\n+    private static final Logger LOGGER = LoggerFactory.getLogger(EnvironmentUserSyncStateCalculator.class);\n+\n+    @Inject\n+    private StackService stackService;\n+\n+    @Inject\n+    private UserSyncStatusService userSyncStatusService;\n+\n+    @Inject\n+    private UmsEventGenerationIdsProvider umsEventGenerationIdsProvider;\n+\n+    @Inject\n+    private EventGenerationIdsChecker eventGenerationIdsChecker;\n+\n+    public EnvironmentUserSyncState calculateEnvironmentUserSyncState(Crn environmentCrn) {\n+        String accountId = environmentCrn.getAccountId();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bef06f1a1cf8fd23c35d4a4f33e8cae3deb2142d"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUzMTI1NA==", "bodyText": "build MdcContext from Stack", "url": "https://github.com/hortonworks/cloudbreak/pull/8119#discussion_r428531254", "createdAt": "2020-05-21T08:58:13Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/EnvironmentUserSyncStateCalculator.java", "diffHunk": "@@ -0,0 +1,93 @@\n+package com.sequenceiq.freeipa.service.freeipa.user;\n+\n+import javax.inject.Inject;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Service;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.sequenceiq.cloudbreak.auth.altus.Crn;\n+import com.sequenceiq.cloudbreak.logger.MDCUtils;\n+import com.sequenceiq.freeipa.api.v1.freeipa.user.model.EnvironmentUserSyncState;\n+import com.sequenceiq.freeipa.api.v1.freeipa.user.model.UserSyncState;\n+import com.sequenceiq.freeipa.entity.Operation;\n+import com.sequenceiq.freeipa.entity.Stack;\n+import com.sequenceiq.freeipa.entity.UserSyncStatus;\n+import com.sequenceiq.freeipa.service.freeipa.user.model.UmsEventGenerationIds;\n+import com.sequenceiq.freeipa.service.stack.StackService;\n+\n+@Service\n+public class EnvironmentUserSyncStateCalculator {\n+    private static final Logger LOGGER = LoggerFactory.getLogger(EnvironmentUserSyncStateCalculator.class);\n+\n+    @Inject\n+    private StackService stackService;\n+\n+    @Inject\n+    private UserSyncStatusService userSyncStatusService;\n+\n+    @Inject\n+    private UmsEventGenerationIdsProvider umsEventGenerationIdsProvider;\n+\n+    @Inject\n+    private EventGenerationIdsChecker eventGenerationIdsChecker;\n+\n+    public EnvironmentUserSyncState calculateEnvironmentUserSyncState(Crn environmentCrn) {\n+        String accountId = environmentCrn.getAccountId();\n+        String envCrnString = environmentCrn.toString();\n+\n+        Stack stack = stackService.getByEnvironmentCrnAndAccountId(envCrnString, accountId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bef06f1a1cf8fd23c35d4a4f33e8cae3deb2142d"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUzNTM4Mg==", "bodyText": "move this to a method/variable", "url": "https://github.com/hortonworks/cloudbreak/pull/8119#discussion_r428535382", "createdAt": "2020-05-21T09:07:02Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/EnvironmentUserSyncStateCalculator.java", "diffHunk": "@@ -0,0 +1,93 @@\n+package com.sequenceiq.freeipa.service.freeipa.user;\n+\n+import javax.inject.Inject;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Service;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.sequenceiq.cloudbreak.auth.altus.Crn;\n+import com.sequenceiq.cloudbreak.logger.MDCUtils;\n+import com.sequenceiq.freeipa.api.v1.freeipa.user.model.EnvironmentUserSyncState;\n+import com.sequenceiq.freeipa.api.v1.freeipa.user.model.UserSyncState;\n+import com.sequenceiq.freeipa.entity.Operation;\n+import com.sequenceiq.freeipa.entity.Stack;\n+import com.sequenceiq.freeipa.entity.UserSyncStatus;\n+import com.sequenceiq.freeipa.service.freeipa.user.model.UmsEventGenerationIds;\n+import com.sequenceiq.freeipa.service.stack.StackService;\n+\n+@Service\n+public class EnvironmentUserSyncStateCalculator {\n+    private static final Logger LOGGER = LoggerFactory.getLogger(EnvironmentUserSyncStateCalculator.class);\n+\n+    @Inject\n+    private StackService stackService;\n+\n+    @Inject\n+    private UserSyncStatusService userSyncStatusService;\n+\n+    @Inject\n+    private UmsEventGenerationIdsProvider umsEventGenerationIdsProvider;\n+\n+    @Inject\n+    private EventGenerationIdsChecker eventGenerationIdsChecker;\n+\n+    public EnvironmentUserSyncState calculateEnvironmentUserSyncState(Crn environmentCrn) {\n+        String accountId = environmentCrn.getAccountId();\n+        String envCrnString = environmentCrn.toString();\n+\n+        Stack stack = stackService.getByEnvironmentCrnAndAccountId(envCrnString, accountId);\n+        UserSyncStatus userSyncStatus = userSyncStatusService.findByStack(stack);\n+\n+        return internalCalculateEnvironmentUserSyncState(accountId, envCrnString, userSyncStatus);\n+    }\n+\n+    @VisibleForTesting\n+    EnvironmentUserSyncState internalCalculateEnvironmentUserSyncState(String accountId, String envCrnString, UserSyncStatus userSyncStatus) {\n+        EnvironmentUserSyncState environmentUserSyncState = new EnvironmentUserSyncState();\n+        if (null == userSyncStatus || null == userSyncStatus.getLastStartedFullSync()) {\n+            environmentUserSyncState.setState(UserSyncState.STALE);\n+        } else {\n+            environmentUserSyncState.setLastUserSyncOperationId(userSyncStatus.getLastStartedFullSync().getOperationId());\n+            environmentUserSyncState.setState(calculateUserSyncState(accountId, envCrnString, userSyncStatus));\n+        }\n+\n+        return environmentUserSyncState;\n+    }\n+\n+    private UserSyncState calculateUserSyncState(String accountId, String envCrnString, UserSyncStatus userSyncStatus) {\n+        Operation lastSync = userSyncStatus.getLastStartedFullSync();\n+        UserSyncState state = UserSyncState.STALE;\n+        switch (lastSync.getStatus()) {\n+            case RUNNING:\n+                state = UserSyncState.SYNCING;\n+                break;\n+            case COMPLETED:\n+                if (lastSync.getSuccessList().stream()\n+                        .anyMatch(details -> envCrnString.equals(details.getEnvironment()))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bef06f1a1cf8fd23c35d4a4f33e8cae3deb2142d"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUzNjI0Nw==", "bodyText": "move the whole to a method", "url": "https://github.com/hortonworks/cloudbreak/pull/8119#discussion_r428536247", "createdAt": "2020-05-21T09:08:49Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/EnvironmentUserSyncStateCalculator.java", "diffHunk": "@@ -0,0 +1,93 @@\n+package com.sequenceiq.freeipa.service.freeipa.user;\n+\n+import javax.inject.Inject;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Service;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.sequenceiq.cloudbreak.auth.altus.Crn;\n+import com.sequenceiq.cloudbreak.logger.MDCUtils;\n+import com.sequenceiq.freeipa.api.v1.freeipa.user.model.EnvironmentUserSyncState;\n+import com.sequenceiq.freeipa.api.v1.freeipa.user.model.UserSyncState;\n+import com.sequenceiq.freeipa.entity.Operation;\n+import com.sequenceiq.freeipa.entity.Stack;\n+import com.sequenceiq.freeipa.entity.UserSyncStatus;\n+import com.sequenceiq.freeipa.service.freeipa.user.model.UmsEventGenerationIds;\n+import com.sequenceiq.freeipa.service.stack.StackService;\n+\n+@Service\n+public class EnvironmentUserSyncStateCalculator {\n+    private static final Logger LOGGER = LoggerFactory.getLogger(EnvironmentUserSyncStateCalculator.class);\n+\n+    @Inject\n+    private StackService stackService;\n+\n+    @Inject\n+    private UserSyncStatusService userSyncStatusService;\n+\n+    @Inject\n+    private UmsEventGenerationIdsProvider umsEventGenerationIdsProvider;\n+\n+    @Inject\n+    private EventGenerationIdsChecker eventGenerationIdsChecker;\n+\n+    public EnvironmentUserSyncState calculateEnvironmentUserSyncState(Crn environmentCrn) {\n+        String accountId = environmentCrn.getAccountId();\n+        String envCrnString = environmentCrn.toString();\n+\n+        Stack stack = stackService.getByEnvironmentCrnAndAccountId(envCrnString, accountId);\n+        UserSyncStatus userSyncStatus = userSyncStatusService.findByStack(stack);\n+\n+        return internalCalculateEnvironmentUserSyncState(accountId, envCrnString, userSyncStatus);\n+    }\n+\n+    @VisibleForTesting\n+    EnvironmentUserSyncState internalCalculateEnvironmentUserSyncState(String accountId, String envCrnString, UserSyncStatus userSyncStatus) {\n+        EnvironmentUserSyncState environmentUserSyncState = new EnvironmentUserSyncState();\n+        if (null == userSyncStatus || null == userSyncStatus.getLastStartedFullSync()) {\n+            environmentUserSyncState.setState(UserSyncState.STALE);\n+        } else {\n+            environmentUserSyncState.setLastUserSyncOperationId(userSyncStatus.getLastStartedFullSync().getOperationId());\n+            environmentUserSyncState.setState(calculateUserSyncState(accountId, envCrnString, userSyncStatus));\n+        }\n+\n+        return environmentUserSyncState;\n+    }\n+\n+    private UserSyncState calculateUserSyncState(String accountId, String envCrnString, UserSyncStatus userSyncStatus) {\n+        Operation lastSync = userSyncStatus.getLastStartedFullSync();\n+        UserSyncState state = UserSyncState.STALE;\n+        switch (lastSync.getStatus()) {\n+            case RUNNING:\n+                state = UserSyncState.SYNCING;\n+                break;\n+            case COMPLETED:\n+                if (lastSync.getSuccessList().stream()\n+                        .anyMatch(details -> envCrnString.equals(details.getEnvironment()))) {\n+                    UmsEventGenerationIds currentEventGenerationIds = umsEventGenerationIdsProvider.getEventGenerationIds(accountId, MDCUtils.getRequestId());\n+                    if (eventGenerationIdsChecker.isInSync(userSyncStatus, currentEventGenerationIds)) {\n+                        state = UserSyncState.IN_SYNC;\n+                    }\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bef06f1a1cf8fd23c35d4a4f33e8cae3deb2142d"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUzNjM2MQ==", "bodyText": "move to a method", "url": "https://github.com/hortonworks/cloudbreak/pull/8119#discussion_r428536361", "createdAt": "2020-05-21T09:09:07Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/EnvironmentUserSyncStateCalculator.java", "diffHunk": "@@ -0,0 +1,93 @@\n+package com.sequenceiq.freeipa.service.freeipa.user;\n+\n+import javax.inject.Inject;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Service;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.sequenceiq.cloudbreak.auth.altus.Crn;\n+import com.sequenceiq.cloudbreak.logger.MDCUtils;\n+import com.sequenceiq.freeipa.api.v1.freeipa.user.model.EnvironmentUserSyncState;\n+import com.sequenceiq.freeipa.api.v1.freeipa.user.model.UserSyncState;\n+import com.sequenceiq.freeipa.entity.Operation;\n+import com.sequenceiq.freeipa.entity.Stack;\n+import com.sequenceiq.freeipa.entity.UserSyncStatus;\n+import com.sequenceiq.freeipa.service.freeipa.user.model.UmsEventGenerationIds;\n+import com.sequenceiq.freeipa.service.stack.StackService;\n+\n+@Service\n+public class EnvironmentUserSyncStateCalculator {\n+    private static final Logger LOGGER = LoggerFactory.getLogger(EnvironmentUserSyncStateCalculator.class);\n+\n+    @Inject\n+    private StackService stackService;\n+\n+    @Inject\n+    private UserSyncStatusService userSyncStatusService;\n+\n+    @Inject\n+    private UmsEventGenerationIdsProvider umsEventGenerationIdsProvider;\n+\n+    @Inject\n+    private EventGenerationIdsChecker eventGenerationIdsChecker;\n+\n+    public EnvironmentUserSyncState calculateEnvironmentUserSyncState(Crn environmentCrn) {\n+        String accountId = environmentCrn.getAccountId();\n+        String envCrnString = environmentCrn.toString();\n+\n+        Stack stack = stackService.getByEnvironmentCrnAndAccountId(envCrnString, accountId);\n+        UserSyncStatus userSyncStatus = userSyncStatusService.findByStack(stack);\n+\n+        return internalCalculateEnvironmentUserSyncState(accountId, envCrnString, userSyncStatus);\n+    }\n+\n+    @VisibleForTesting\n+    EnvironmentUserSyncState internalCalculateEnvironmentUserSyncState(String accountId, String envCrnString, UserSyncStatus userSyncStatus) {\n+        EnvironmentUserSyncState environmentUserSyncState = new EnvironmentUserSyncState();\n+        if (null == userSyncStatus || null == userSyncStatus.getLastStartedFullSync()) {\n+            environmentUserSyncState.setState(UserSyncState.STALE);\n+        } else {\n+            environmentUserSyncState.setLastUserSyncOperationId(userSyncStatus.getLastStartedFullSync().getOperationId());\n+            environmentUserSyncState.setState(calculateUserSyncState(accountId, envCrnString, userSyncStatus));\n+        }\n+\n+        return environmentUserSyncState;\n+    }\n+\n+    private UserSyncState calculateUserSyncState(String accountId, String envCrnString, UserSyncStatus userSyncStatus) {\n+        Operation lastSync = userSyncStatus.getLastStartedFullSync();\n+        UserSyncState state = UserSyncState.STALE;\n+        switch (lastSync.getStatus()) {\n+            case RUNNING:\n+                state = UserSyncState.SYNCING;\n+                break;\n+            case COMPLETED:\n+                if (lastSync.getSuccessList().stream()\n+                        .anyMatch(details -> envCrnString.equals(details.getEnvironment()))) {\n+                    UmsEventGenerationIds currentEventGenerationIds = umsEventGenerationIdsProvider.getEventGenerationIds(accountId, MDCUtils.getRequestId());\n+                    if (eventGenerationIdsChecker.isInSync(userSyncStatus, currentEventGenerationIds)) {\n+                        state = UserSyncState.IN_SYNC;\n+                    }\n+                }\n+                break;\n+            case REQUESTED:\n+            case REJECTED:\n+                // REQUESTED or REJECTED operations will never be saved as part of the UserSyncStatus\n+                LOGGER.error(\"UserSyncStatus.lastStartedFullSync '{}' in unexpected state {} for environment '{}'\",\n+                        lastSync, lastSync.getStatus(), envCrnString);\n+                throw new IllegalStateException(\n+                        String.format(\"Last sync operation [%s] for environment '%s' is in unexpected state %s\",\n+                                lastSync.getOperationId(), envCrnString, lastSync.getStatus()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bef06f1a1cf8fd23c35d4a4f33e8cae3deb2142d"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUzNjk1Nw==", "bodyText": "it would be easier to read if every case would set the state instead of we initialize with a value and we have to go through all case to check if it's overridden", "url": "https://github.com/hortonworks/cloudbreak/pull/8119#discussion_r428536957", "createdAt": "2020-05-21T09:10:26Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/EnvironmentUserSyncStateCalculator.java", "diffHunk": "@@ -0,0 +1,93 @@\n+package com.sequenceiq.freeipa.service.freeipa.user;\n+\n+import javax.inject.Inject;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Service;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.sequenceiq.cloudbreak.auth.altus.Crn;\n+import com.sequenceiq.cloudbreak.logger.MDCUtils;\n+import com.sequenceiq.freeipa.api.v1.freeipa.user.model.EnvironmentUserSyncState;\n+import com.sequenceiq.freeipa.api.v1.freeipa.user.model.UserSyncState;\n+import com.sequenceiq.freeipa.entity.Operation;\n+import com.sequenceiq.freeipa.entity.Stack;\n+import com.sequenceiq.freeipa.entity.UserSyncStatus;\n+import com.sequenceiq.freeipa.service.freeipa.user.model.UmsEventGenerationIds;\n+import com.sequenceiq.freeipa.service.stack.StackService;\n+\n+@Service\n+public class EnvironmentUserSyncStateCalculator {\n+    private static final Logger LOGGER = LoggerFactory.getLogger(EnvironmentUserSyncStateCalculator.class);\n+\n+    @Inject\n+    private StackService stackService;\n+\n+    @Inject\n+    private UserSyncStatusService userSyncStatusService;\n+\n+    @Inject\n+    private UmsEventGenerationIdsProvider umsEventGenerationIdsProvider;\n+\n+    @Inject\n+    private EventGenerationIdsChecker eventGenerationIdsChecker;\n+\n+    public EnvironmentUserSyncState calculateEnvironmentUserSyncState(Crn environmentCrn) {\n+        String accountId = environmentCrn.getAccountId();\n+        String envCrnString = environmentCrn.toString();\n+\n+        Stack stack = stackService.getByEnvironmentCrnAndAccountId(envCrnString, accountId);\n+        UserSyncStatus userSyncStatus = userSyncStatusService.findByStack(stack);\n+\n+        return internalCalculateEnvironmentUserSyncState(accountId, envCrnString, userSyncStatus);\n+    }\n+\n+    @VisibleForTesting\n+    EnvironmentUserSyncState internalCalculateEnvironmentUserSyncState(String accountId, String envCrnString, UserSyncStatus userSyncStatus) {\n+        EnvironmentUserSyncState environmentUserSyncState = new EnvironmentUserSyncState();\n+        if (null == userSyncStatus || null == userSyncStatus.getLastStartedFullSync()) {\n+            environmentUserSyncState.setState(UserSyncState.STALE);\n+        } else {\n+            environmentUserSyncState.setLastUserSyncOperationId(userSyncStatus.getLastStartedFullSync().getOperationId());\n+            environmentUserSyncState.setState(calculateUserSyncState(accountId, envCrnString, userSyncStatus));\n+        }\n+\n+        return environmentUserSyncState;\n+    }\n+\n+    private UserSyncState calculateUserSyncState(String accountId, String envCrnString, UserSyncStatus userSyncStatus) {\n+        Operation lastSync = userSyncStatus.getLastStartedFullSync();\n+        UserSyncState state = UserSyncState.STALE;\n+        switch (lastSync.getStatus()) {\n+            case RUNNING:\n+                state = UserSyncState.SYNCING;\n+                break;\n+            case COMPLETED:\n+                if (lastSync.getSuccessList().stream()\n+                        .anyMatch(details -> envCrnString.equals(details.getEnvironment()))) {\n+                    UmsEventGenerationIds currentEventGenerationIds = umsEventGenerationIdsProvider.getEventGenerationIds(accountId, MDCUtils.getRequestId());\n+                    if (eventGenerationIdsChecker.isInSync(userSyncStatus, currentEventGenerationIds)) {\n+                        state = UserSyncState.IN_SYNC;\n+                    }\n+                }\n+                break;\n+            case REQUESTED:\n+            case REJECTED:\n+                // REQUESTED or REJECTED operations will never be saved as part of the UserSyncStatus\n+                LOGGER.error(\"UserSyncStatus.lastStartedFullSync '{}' in unexpected state {} for environment '{}'\",\n+                        lastSync, lastSync.getStatus(), envCrnString);\n+                throw new IllegalStateException(\n+                        String.format(\"Last sync operation [%s] for environment '%s' is in unexpected state %s\",\n+                                lastSync.getOperationId(), envCrnString, lastSync.getStatus()));\n+            case TIMEDOUT:\n+                LOGGER.warn(\"UserSyncStatus.lastStartedFullSync '{}' is timed out for environment '{}'\", lastSync.getOperationId(), envCrnString);\n+                break;\n+            case FAILED:\n+            default:\n+                // state already set to STALE", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bef06f1a1cf8fd23c35d4a4f33e8cae3deb2142d"}, "originalPosition": 88}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bef06f1a1cf8fd23c35d4a4f33e8cae3deb2142d", "author": {"user": {"login": "handavid", "name": "David Han"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/bef06f1a1cf8fd23c35d4a4f33e8cae3deb2142d", "committedDate": "2020-05-20T22:43:12Z", "message": "CDPCP-2094. Add API to retrieve user sync state for an environment\n\nThis commit adds a new endpoint for retrieving user sync state for an environment.\nThe state is calculated by looking at the last started full user sync. If the last\nstarted full user sync completed successfully, then the event generation ids for\nthat sync are compared against the current event generation ids from the UMS."}, "afterCommit": {"oid": "3e34bce09418822500b931c519266e00e599195d", "author": {"user": {"login": "handavid", "name": "David Han"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/3e34bce09418822500b931c519266e00e599195d", "committedDate": "2020-05-21T20:23:05Z", "message": "CDPCP-2094. Add API to retrieve user sync state for an environment\n\nThis commit adds a new endpoint for retrieving user sync state for an environment.\nThe state is calculated by looking at the last started full user sync. If the last\nstarted full user sync completed successfully, then the event generation ids for\nthat sync are compared against the current event generation ids from the UMS."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3e34bce09418822500b931c519266e00e599195d", "author": {"user": {"login": "handavid", "name": "David Han"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/3e34bce09418822500b931c519266e00e599195d", "committedDate": "2020-05-21T20:23:05Z", "message": "CDPCP-2094. Add API to retrieve user sync state for an environment\n\nThis commit adds a new endpoint for retrieving user sync state for an environment.\nThe state is calculated by looking at the last started full user sync. If the last\nstarted full user sync completed successfully, then the event generation ids for\nthat sync are compared against the current event generation ids from the UMS."}, "afterCommit": {"oid": "a2c7f074a944a4486953fc205eaca294373cf46b", "author": {"user": {"login": "handavid", "name": "David Han"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/a2c7f074a944a4486953fc205eaca294373cf46b", "committedDate": "2020-05-21T21:42:18Z", "message": "CDPCP-2094. Add API to retrieve user sync state for an environment\n\nThis commit adds a new endpoint for retrieving user sync state for an environment.\nThe state is calculated by looking at the last started full user sync. If the last\nstarted full user sync completed successfully, then the event generation ids for\nthat sync are compared against the current event generation ids from the UMS."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a2c7f074a944a4486953fc205eaca294373cf46b", "author": {"user": {"login": "handavid", "name": "David Han"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/a2c7f074a944a4486953fc205eaca294373cf46b", "committedDate": "2020-05-21T21:42:18Z", "message": "CDPCP-2094. Add API to retrieve user sync state for an environment\n\nThis commit adds a new endpoint for retrieving user sync state for an environment.\nThe state is calculated by looking at the last started full user sync. If the last\nstarted full user sync completed successfully, then the event generation ids for\nthat sync are compared against the current event generation ids from the UMS."}, "afterCommit": {"oid": "072797b43fc9eeebc55c98d1b4a1e7b9ceb58571", "author": {"user": {"login": "handavid", "name": "David Han"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/072797b43fc9eeebc55c98d1b4a1e7b9ceb58571", "committedDate": "2020-05-22T20:46:01Z", "message": "CDPCP-2094. Add API to retrieve user sync state for an environment\n\nThis commit adds a new endpoint for retrieving user sync state for an environment.\nThe state is calculated by looking at the last started full user sync. If the last\nstarted full user sync completed successfully, then the event generation ids for\nthat sync are compared against the current event generation ids from the UMS."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "072797b43fc9eeebc55c98d1b4a1e7b9ceb58571", "author": {"user": {"login": "handavid", "name": "David Han"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/072797b43fc9eeebc55c98d1b4a1e7b9ceb58571", "committedDate": "2020-05-22T20:46:01Z", "message": "CDPCP-2094. Add API to retrieve user sync state for an environment\n\nThis commit adds a new endpoint for retrieving user sync state for an environment.\nThe state is calculated by looking at the last started full user sync. If the last\nstarted full user sync completed successfully, then the event generation ids for\nthat sync are compared against the current event generation ids from the UMS."}, "afterCommit": {"oid": "ccd239a255401283530b582b2c1875e24b5b2857", "author": {"user": {"login": "handavid", "name": "David Han"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/ccd239a255401283530b582b2c1875e24b5b2857", "committedDate": "2020-05-22T21:41:26Z", "message": "CDPCP-2094. Add API to retrieve user sync state for an environment\n\nThis commit adds a new endpoint for retrieving user sync state for an environment.\nThe state is calculated by looking at the last started full user sync. If the last\nstarted full user sync completed successfully, then the event generation ids for\nthat sync are compared against the current event generation ids from the UMS."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ccd239a255401283530b582b2c1875e24b5b2857", "author": {"user": {"login": "handavid", "name": "David Han"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/ccd239a255401283530b582b2c1875e24b5b2857", "committedDate": "2020-05-22T21:41:26Z", "message": "CDPCP-2094. Add API to retrieve user sync state for an environment\n\nThis commit adds a new endpoint for retrieving user sync state for an environment.\nThe state is calculated by looking at the last started full user sync. If the last\nstarted full user sync completed successfully, then the event generation ids for\nthat sync are compared against the current event generation ids from the UMS."}, "afterCommit": {"oid": "5eeb08aafadff3e44d022c5de532330c4c19b887", "author": {"user": {"login": "handavid", "name": "David Han"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/5eeb08aafadff3e44d022c5de532330c4c19b887", "committedDate": "2020-05-22T22:11:54Z", "message": "CDPCP-2094. Add API to retrieve user sync state for an environment\n\nThis commit adds a new endpoint for retrieving user sync state for an environment.\nThe state is calculated by looking at the last started full user sync. If the last\nstarted full user sync completed successfully, then the event generation ids for\nthat sync are compared against the current event generation ids from the UMS."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4OTMyNjA4", "url": "https://github.com/hortonworks/cloudbreak/pull/8119#pullrequestreview-418932608", "createdAt": "2020-05-27T07:40:41Z", "commit": {"oid": "5eeb08aafadff3e44d022c5de532330c4c19b887"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwNzo0MDo0MVrOGa9G-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwNzo0MDo0MVrOGa9G-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkxNzM3MQ==", "bodyText": "this name is a bit misleading as I would expect it would set the state, but instead it will throw an exception. also this method should be void as it won't return anything ever.", "url": "https://github.com/hortonworks/cloudbreak/pull/8119#discussion_r430917371", "createdAt": "2020-05-27T07:40:41Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/EnvironmentUserSyncStateCalculator.java", "diffHunk": "@@ -0,0 +1,115 @@\n+package com.sequenceiq.freeipa.service.freeipa.user;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+\n+import javax.inject.Inject;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Service;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.sequenceiq.cloudbreak.auth.altus.Crn;\n+import com.sequenceiq.cloudbreak.logger.MDCBuilder;\n+import com.sequenceiq.cloudbreak.logger.MDCUtils;\n+import com.sequenceiq.freeipa.api.v1.freeipa.user.model.EnvironmentUserSyncState;\n+import com.sequenceiq.freeipa.api.v1.freeipa.user.model.UserSyncState;\n+import com.sequenceiq.freeipa.entity.Operation;\n+import com.sequenceiq.freeipa.entity.Stack;\n+import com.sequenceiq.freeipa.entity.UserSyncStatus;\n+import com.sequenceiq.freeipa.service.freeipa.user.model.UmsEventGenerationIds;\n+import com.sequenceiq.freeipa.service.stack.StackService;\n+\n+@Service\n+public class EnvironmentUserSyncStateCalculator {\n+    private static final Logger LOGGER = LoggerFactory.getLogger(EnvironmentUserSyncStateCalculator.class);\n+\n+    @Inject\n+    private StackService stackService;\n+\n+    @Inject\n+    private UserSyncStatusService userSyncStatusService;\n+\n+    @Inject\n+    private UmsEventGenerationIdsProvider umsEventGenerationIdsProvider;\n+\n+    @Inject\n+    private EventGenerationIdsChecker eventGenerationIdsChecker;\n+\n+    public EnvironmentUserSyncState calculateEnvironmentUserSyncState(String accountId, Crn environmentCrn) {\n+        checkArgument(accountId.equals(environmentCrn.getAccountId()), \"environmentCrn does not match account id\");\n+        String envCrnString = environmentCrn.toString();\n+\n+        Stack stack = stackService.getByEnvironmentCrnAndAccountId(envCrnString, accountId);\n+        MDCBuilder.buildMdcContext(stack);\n+\n+        UserSyncStatus userSyncStatus = userSyncStatusService.findByStack(stack);\n+\n+        return internalCalculateEnvironmentUserSyncState(accountId, envCrnString, userSyncStatus);\n+    }\n+\n+    @VisibleForTesting\n+    EnvironmentUserSyncState internalCalculateEnvironmentUserSyncState(String accountId, String envCrnString, UserSyncStatus userSyncStatus) {\n+        EnvironmentUserSyncState environmentUserSyncState = new EnvironmentUserSyncState();\n+        if (null == userSyncStatus || null == userSyncStatus.getLastStartedFullSync()) {\n+            environmentUserSyncState.setState(UserSyncState.STALE);\n+        } else {\n+            environmentUserSyncState.setLastUserSyncOperationId(userSyncStatus.getLastStartedFullSync().getOperationId());\n+            environmentUserSyncState.setState(calculateUserSyncState(accountId, envCrnString, userSyncStatus));\n+        }\n+\n+        return environmentUserSyncState;\n+    }\n+\n+    private UserSyncState calculateUserSyncState(String accountId, String envCrnString, UserSyncStatus userSyncStatus) {\n+        Operation lastSync = userSyncStatus.getLastStartedFullSync();\n+        UserSyncState state;\n+        switch (lastSync.getStatus()) {\n+            case RUNNING:\n+                state = UserSyncState.SYNC_IN_PROGRESS;\n+                break;\n+            case COMPLETED:\n+                state = calculateStateForCompletedOperation(accountId, envCrnString, userSyncStatus);\n+                break;\n+            case REQUESTED:\n+            case REJECTED:\n+                // REQUESTED or REJECTED operations will never be saved as part of the UserSyncStatus\n+                state = calculateStateForUnexpectedOperationStatus(envCrnString, userSyncStatus);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5eeb08aafadff3e44d022c5de532330c4c19b887"}, "originalPosition": 77}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4OTQwNDg5", "url": "https://github.com/hortonworks/cloudbreak/pull/8119#pullrequestreview-418940489", "createdAt": "2020-05-27T07:51:56Z", "commit": {"oid": "5eeb08aafadff3e44d022c5de532330c4c19b887"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwNzo1MTo1NlrOGa9fzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwNzo1MTo1NlrOGa9fzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkyMzcyNw==", "bodyText": "I think you should use @CheckPermissionByAccount here (similarly to other methods), now every permission check on API methods happens on account level in freeipa (resource based checks are happening explicitly in service layer as i have seen), internal calls ( with @TenantAwareParam) still will work, resource based authz implementation is in progress in other PR", "url": "https://github.com/hortonworks/cloudbreak/pull/8119#discussion_r430923727", "createdAt": "2020-05-27T07:51:56Z", "author": {"login": "horadla23"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/controller/UserV1Controller.java", "diffHunk": "@@ -102,13 +113,22 @@ public SyncOperationStatus setPassword(SetPasswordRequest request) {\n     @Override\n     @CheckPermissionByAccount(action = AuthorizationResourceAction.ENVIRONMENT_WRITE)\n     public SyncOperationStatus getSyncOperationStatus(@NotNull String operationId) {\n-        checkUserCrn();\n+        checkActorCrn();\n         String accountId = ThreadBasedUserCrnProvider.getAccountId();\n         LOGGER.debug(\"getSyncOperationStatus() requested for operation '{}' in account '{}'\", operationId, accountId);\n         return operationToSyncOperationStatus.convert(\n                 operationService.getOperationForAccountIdAndOperationId(accountId, operationId));\n     }\n \n+    @Override\n+    @CheckPermissionByResourceCrn(action = AuthorizationResourceAction.ENVIRONMENT_READ)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5eeb08aafadff3e44d022c5de532330c4c19b887"}, "originalPosition": 89}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a7433fdbfde669e5333f5a19aeb1c0dae67597d2", "author": {"user": {"login": "handavid", "name": "David Han"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/a7433fdbfde669e5333f5a19aeb1c0dae67597d2", "committedDate": "2020-05-28T19:11:34Z", "message": "CDPCP-2094. Add API to retrieve user sync state for an environment\n\nThis commit adds a new endpoint for retrieving user sync state for an environment.\nThe state is calculated by looking at the last started full user sync. If the last\nstarted full user sync completed successfully, then the event generation ids for\nthat sync are compared against the current event generation ids from the UMS."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5eeb08aafadff3e44d022c5de532330c4c19b887", "author": {"user": {"login": "handavid", "name": "David Han"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/5eeb08aafadff3e44d022c5de532330c4c19b887", "committedDate": "2020-05-22T22:11:54Z", "message": "CDPCP-2094. Add API to retrieve user sync state for an environment\n\nThis commit adds a new endpoint for retrieving user sync state for an environment.\nThe state is calculated by looking at the last started full user sync. If the last\nstarted full user sync completed successfully, then the event generation ids for\nthat sync are compared against the current event generation ids from the UMS."}, "afterCommit": {"oid": "a7433fdbfde669e5333f5a19aeb1c0dae67597d2", "author": {"user": {"login": "handavid", "name": "David Han"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/a7433fdbfde669e5333f5a19aeb1c0dae67597d2", "committedDate": "2020-05-28T19:11:34Z", "message": "CDPCP-2094. Add API to retrieve user sync state for an environment\n\nThis commit adds a new endpoint for retrieving user sync state for an environment.\nThe state is calculated by looking at the last started full user sync. If the last\nstarted full user sync completed successfully, then the event generation ids for\nthat sync are compared against the current event generation ids from the UMS."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwNDkyNzk5", "url": "https://github.com/hortonworks/cloudbreak/pull/8119#pullrequestreview-420492799", "createdAt": "2020-05-28T21:07:26Z", "commit": {"oid": "a7433fdbfde669e5333f5a19aeb1c0dae67597d2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwNjg2NTcx", "url": "https://github.com/hortonworks/cloudbreak/pull/8119#pullrequestreview-420686571", "createdAt": "2020-05-29T06:36:03Z", "commit": {"oid": "a7433fdbfde669e5333f5a19aeb1c0dae67597d2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1868, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}