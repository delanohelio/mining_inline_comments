{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ2MzM0MTg0", "number": 8512, "title": "Cb-7808 Flow events are missing from Structuctured events", "bodyText": "We filtered the structured events to datalake and datahub only but before 2.25 the CB stored as stacks. The legacy resource type added", "createdAt": "2020-07-08T15:53:00Z", "url": "https://github.com/hortonworks/cloudbreak/pull/8512", "merged": true, "mergeCommit": {"oid": "a2e66965ab1b7626d05c210c077d6eb4d1024db0"}, "closed": true, "closedAt": "2020-07-13T08:15:34Z", "author": {"login": "topolyai5"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABczADnRAFqTQ0NTA4NzA2Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABczLaBgAFqTQ0NTQzMjgxMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MDg3MDYy", "url": "https://github.com/hortonworks/cloudbreak/pull/8512#pullrequestreview-445087062", "createdAt": "2020-07-08T20:00:09Z", "commit": {"oid": "5e1d94f5ebf97e58d00a2fec8763b44e7466f08f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQyMDowMDowOVrOGu3Ptw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQyMDowMDowOVrOGu3Ptw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTc5MjgyMw==", "bodyText": "egacy -> legacy", "url": "https://github.com/hortonworks/cloudbreak/pull/8512#discussion_r451792823", "createdAt": "2020-07-08T20:00:09Z", "author": {"login": "doktoric"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/service/decorator/responseprovider/StackResponseEventProvider.java", "diffHunk": "@@ -15,17 +19,34 @@\n \n @Component\n public class StackResponseEventProvider implements ResponseProvider {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(StackResponseEventProvider.class);\n+\n     @Inject\n     private CloudbreakEventsFacade cloudbreakEventsFacade;\n \n     @Override\n     public StackV4Response providerEntriesToStackResponse(Stack stack, StackV4Response stackResponse) {\n+        List<CloudbreakEventV4Response> events = new ArrayList<>();\n         List<CloudbreakEventV4Response> cloudbreakEvents = cloudbreakEventsFacade\n                 .retrieveEventsByStack(stack.getId(), stack.getType(), PageRequest.of(0, Integer.MAX_VALUE)).getContent();\n-        stackResponse.setCloudbreakEvents(cloudbreakEvents);\n+        events.addAll(cloudbreakEvents);\n+        events.addAll(getLegacyStackType(stack));\n+        stackResponse.setCloudbreakEvents(events);\n         return stackResponse;\n     }\n \n+    private List<CloudbreakEventV4Response> getLegacyStackType(Stack stack) {\n+        List<CloudbreakEventV4Response> events = cloudbreakEventsFacade\n+                .retrieveEventsByStack(stack.getId(), StackType.LEGACY, PageRequest.of(0, Integer.MAX_VALUE)).getContent();\n+        if (events.isEmpty()) {\n+            LOGGER.info(\"Cannot find any legacy events for stack: {}, crn: {}\", stack.getId(), stack.getResourceCrn());\n+        } else {\n+            LOGGER.info(\"{} egacy events for stack: {}, crn: {}\", events.size(), stack.getId(), stack.getResourceCrn());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e1d94f5ebf97e58d00a2fec8763b44e7466f08f"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b766a05a8cdb0e8aea8b9b401cd485b298c1fd0", "author": {"user": {"login": "topolyai5", "name": "Gergely Topolyai"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/8b766a05a8cdb0e8aea8b9b401cd485b298c1fd0", "committedDate": "2020-07-09T05:58:56Z", "message": "Cb-7808 Flow events are missing from Structuctured events\nWe filtered the structured events to datalake and datahub only but before 2.25 the CB stored as stacks. The legacy resource type added"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5e1d94f5ebf97e58d00a2fec8763b44e7466f08f", "author": {"user": {"login": "topolyai5", "name": "Gergely Topolyai"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/5e1d94f5ebf97e58d00a2fec8763b44e7466f08f", "committedDate": "2020-07-08T15:48:45Z", "message": "Cb-7808 Flow events are missing from Structuctured events\nWe filtered the structured events to datalake and datahub only but before 2.25 the CB stored as stacks. The legacy resource type added"}, "afterCommit": {"oid": "8b766a05a8cdb0e8aea8b9b401cd485b298c1fd0", "author": {"user": {"login": "topolyai5", "name": "Gergely Topolyai"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/8b766a05a8cdb0e8aea8b9b401cd485b298c1fd0", "committedDate": "2020-07-09T05:58:56Z", "message": "Cb-7808 Flow events are missing from Structuctured events\nWe filtered the structured events to datalake and datahub only but before 2.25 the CB stored as stacks. The legacy resource type added"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1NDMyODEx", "url": "https://github.com/hortonworks/cloudbreak/pull/8512#pullrequestreview-445432811", "createdAt": "2020-07-09T09:13:35Z", "commit": {"oid": "8b766a05a8cdb0e8aea8b9b401cd485b298c1fd0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwOToxMzozNVrOGvIpFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwOToxMzozNVrOGvIpFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA3Nzg0NA==", "bodyText": "I don't see any tests which ensure that events are not broken again.", "url": "https://github.com/hortonworks/cloudbreak/pull/8512#discussion_r452077844", "createdAt": "2020-07-09T09:13:35Z", "author": {"login": "akanto"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/service/decorator/responseprovider/StackResponseEventProvider.java", "diffHunk": "@@ -15,17 +19,34 @@\n \n @Component\n public class StackResponseEventProvider implements ResponseProvider {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(StackResponseEventProvider.class);\n+\n     @Inject\n     private CloudbreakEventsFacade cloudbreakEventsFacade;\n \n     @Override\n     public StackV4Response providerEntriesToStackResponse(Stack stack, StackV4Response stackResponse) {\n+        List<CloudbreakEventV4Response> events = new ArrayList<>();\n         List<CloudbreakEventV4Response> cloudbreakEvents = cloudbreakEventsFacade\n                 .retrieveEventsByStack(stack.getId(), stack.getType(), PageRequest.of(0, Integer.MAX_VALUE)).getContent();\n-        stackResponse.setCloudbreakEvents(cloudbreakEvents);\n+        events.addAll(cloudbreakEvents);\n+        events.addAll(getLegacyStackType(stack));\n+        stackResponse.setCloudbreakEvents(events);\n         return stackResponse;\n     }\n \n+    private List<CloudbreakEventV4Response> getLegacyStackType(Stack stack) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b766a05a8cdb0e8aea8b9b401cd485b298c1fd0"}, "originalPosition": 39}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2679, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}