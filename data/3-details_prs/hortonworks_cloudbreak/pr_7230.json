{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcxODA0ODgw", "number": 7230, "title": "CB-5031 Ycloud support for hybrid cloud approach", "bodyText": "", "createdAt": "2020-02-06T09:54:21Z", "url": "https://github.com/hortonworks/cloudbreak/pull/7230", "merged": true, "mergeCommit": {"oid": "7baa294adc5da906445f74bee4047430fde9b55f"}, "closed": true, "closedAt": "2020-02-21T16:15:48Z", "author": {"login": "biharitomi"}, "timelineItems": {"totalCount": 39, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcB_HnwgBqjMwMTc1OTYwNTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcGb_2EABqjMwNTk3NDMwNzE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "531b7d545578d6f205d6f7ea97f130898bacea04", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/531b7d545578d6f205d6f7ea97f130898bacea04", "committedDate": "2020-02-07T13:02:36Z", "message": "CB-5395 Update keytabs in case of YARN as a child environment."}, "afterCommit": {"oid": "2724bab1bc544ce642df533f76b6a1e9c97eb82d", "author": {"user": {"login": "biharitomi", "name": "Tamas Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/2724bab1bc544ce642df533f76b6a1e9c97eb82d", "committedDate": "2020-02-07T13:11:33Z", "message": "CB-5162 fix FreeIPA and core orchestration for child environment related calls, reenable systemctl hack for YARN"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3f0d4eecfe58e1ab5f073dbc2d7cddf6a408f96d", "author": {"user": {"login": "pkedvessy", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/3f0d4eecfe58e1ab5f073dbc2d7cddf6a408f96d", "committedDate": "2020-02-11T15:31:18Z", "message": "CB-5494 Instead of environment crns, use environment names in the error message"}, "afterCommit": {"oid": "d19d0066d771099d98678da8d0d062375a4722e9", "author": {"user": {"login": "pkedvessy", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/d19d0066d771099d98678da8d0d062375a4722e9", "committedDate": "2020-02-11T21:21:02Z", "message": "CB-5494 There can not be active child environment in case of parent environment deletion"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4MDY0NTUw", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#pullrequestreview-358064550", "createdAt": "2020-02-13T09:27:09Z", "commit": {"oid": "d19d0066d771099d98678da8d0d062375a4722e9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwOToyNzoxMFrOFpMgpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwOToyNzoxMFrOFpMgpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc0MDkwMw==", "bodyText": "can we use name or crn here ?", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#discussion_r378740903", "createdAt": "2020-02-13T09:27:10Z", "author": {"login": "doktoric"}, "path": "environment-api/src/main/java/com/sequenceiq/environment/api/v1/environment/model/request/EnvironmentRequest.java", "diffHunk": "@@ -79,6 +79,9 @@\n     @ApiModelProperty(EnvironmentModelDescription.AWS_PARAMETERS)\n     private AwsEnvironmentParameters aws;\n \n+    @ApiModelProperty(value = EnvironmentModelDescription.PARENT_ENVIRONMENT_CRN)\n+    private String parentEnvironmentCrn;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d19d0066d771099d98678da8d0d062375a4722e9"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4MDY0ODI5", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#pullrequestreview-358064829", "createdAt": "2020-02-13T09:27:34Z", "commit": {"oid": "d19d0066d771099d98678da8d0d062375a4722e9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwOToyNzozNFrOFpMhdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwOToyNzozNFrOFpMhdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc0MTEwOQ==", "bodyText": "I think it should be great to show the name as well", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#discussion_r378741109", "createdAt": "2020-02-13T09:27:34Z", "author": {"login": "doktoric"}, "path": "environment-api/src/main/java/com/sequenceiq/environment/api/v1/environment/model/response/DetailedEnvironmentResponse.java", "diffHunk": "@@ -70,6 +70,8 @@ public void setCredential(CredentialResponse credential) {\n \n         private AwsEnvironmentParameters aws;\n \n+        private String parentEnvironmentCrn;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d19d0066d771099d98678da8d0d062375a4722e9"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4MDY1NzUy", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#pullrequestreview-358065752", "createdAt": "2020-02-13T09:28:57Z", "commit": {"oid": "d19d0066d771099d98678da8d0d062375a4722e9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwOToyODo1N1rOFpMkgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwOToyODo1N1rOFpMkgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc0MTg4OA==", "bodyText": "I think it should be an application property", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#discussion_r378741888", "createdAt": "2020-02-13T09:28:57Z", "author": {"login": "doktoric"}, "path": "environment/src/main/java/com/sequenceiq/environment/environment/flow/creation/handler/freeipa/FreeIpaCreationHandler.java", "diffHunk": "@@ -70,6 +74,8 @@\n \n     private static final List<String> DEFAULT_SECURITY_GROUP_PORTS = List.of(\"22\");\n \n+    private static final String YARN_NETWORK_CIDR = \"172.27.0.0/16\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d19d0066d771099d98678da8d0d062375a4722e9"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4MDY2Nzk4", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#pullrequestreview-358066798", "createdAt": "2020-02-13T09:30:29Z", "commit": {"oid": "d19d0066d771099d98678da8d0d062375a4722e9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwOTozMDoyOVrOFpMnwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwOTozMDoyOVrOFpMnwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc0MjcyMQ==", "bodyText": "should we use the mock as well ? If we dont have this option for mock I am afraid that we can easily break this feature.", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#discussion_r378742721", "createdAt": "2020-02-13T09:30:29Z", "author": {"login": "doktoric"}, "path": "environment/src/main/java/com/sequenceiq/environment/environment/flow/creation/handler/freeipa/FreeIpaCreationHandler.java", "diffHunk": "@@ -143,13 +151,33 @@ private void createFreeIpa(Event<EnvironmentDto> environmentDtoEvent, Environmen\n                 dnsV1Endpoint.addDnsZoneForSubnetIds(addDnsZoneForSubnetIdsRequest);\n             }\n         } else {\n-            LOGGER.info(\"FreeIpa for environmentCrn '{}' already exists. Using this one.\", environment.getResourceCrn());\n+            LOGGER.info(\"FreeIpa for environmentCrn '{}' already exists. Using this one.\", environmentDto.getResourceCrn());\n             if (CREATE_IN_PROGRESS == freeIpa.get().getStatus()) {\n                 awaitFreeIpaCreation(environmentDtoEvent, environmentDto);\n             }\n         }\n     }\n \n+    private void attachParentFreeIpa(EnvironmentDto environmentDto) throws Exception {\n+        String parentEnvironmentCrn = environmentDto.getParentEnvironmentCrn();\n+        Optional<DescribeFreeIpaResponse> freeIpa = freeIpaService.describe(parentEnvironmentCrn);\n+        if (freeIpa.isPresent() && CloudPlatform.YARN.name().equalsIgnoreCase(environmentDto.getCloudPlatform())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d19d0066d771099d98678da8d0d062375a4722e9"}, "originalPosition": 82}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4MDY3NjA4", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#pullrequestreview-358067608", "createdAt": "2020-02-13T09:31:36Z", "commit": {"oid": "d19d0066d771099d98678da8d0d062375a4722e9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwOTozMTozNlrOFpMqTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwOTozMTozNlrOFpMqTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc0MzM3Mg==", "bodyText": "I think the name is more useful here", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#discussion_r378743372", "createdAt": "2020-02-13T09:31:36Z", "author": {"login": "doktoric"}, "path": "environment/src/main/java/com/sequenceiq/environment/environment/validation/EnvironmentValidatorService.java", "diffHunk": "@@ -73,6 +75,25 @@ public ValidationResultBuilder validateNetworkCreation(Environment environment,\n         return networkCreationValidator.validateNetworkCreation(environment, network, subnetMetas);\n     }\n \n+    public ValidationResult validateParentChildRelation(Environment environment, String parentEnvironmentCrn) {\n+        ValidationResultBuilder resultBuilder = new ValidationResultBuilder();\n+\n+        resultBuilder.ifError(() -> Objects.nonNull(parentEnvironmentCrn) && Objects.isNull(environment.getParentEnvironment()),\n+                String.format(\"Active parent environment with crn '%s' is not available in account '%s'.\", parentEnvironmentCrn, environment.getAccountId()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d19d0066d771099d98678da8d0d062375a4722e9"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4MDY4MDYw", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#pullrequestreview-358068060", "createdAt": "2020-02-13T09:32:13Z", "commit": {"oid": "d19d0066d771099d98678da8d0d062375a4722e9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwOTozMjoxM1rOFpMruQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwOTozMjoxM1rOFpMruQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc0MzczNw==", "bodyText": "can we expose the supported platforms to an application property ?", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#discussion_r378743737", "createdAt": "2020-02-13T09:32:13Z", "author": {"login": "doktoric"}, "path": "environment/src/main/java/com/sequenceiq/environment/environment/validation/EnvironmentValidatorService.java", "diffHunk": "@@ -73,6 +75,25 @@ public ValidationResultBuilder validateNetworkCreation(Environment environment,\n         return networkCreationValidator.validateNetworkCreation(environment, network, subnetMetas);\n     }\n \n+    public ValidationResult validateParentChildRelation(Environment environment, String parentEnvironmentCrn) {\n+        ValidationResultBuilder resultBuilder = new ValidationResultBuilder();\n+\n+        resultBuilder.ifError(() -> Objects.nonNull(parentEnvironmentCrn) && Objects.isNull(environment.getParentEnvironment()),\n+                String.format(\"Active parent environment with crn '%s' is not available in account '%s'.\", parentEnvironmentCrn, environment.getAccountId()));\n+        if (Objects.nonNull(environment.getParentEnvironment())) {\n+            resultBuilder.ifError(() -> environment.getParentEnvironment().getStatus() != EnvironmentStatus.AVAILABLE,\n+                    \"Parent environment should be in 'AVAILABLE' status.\");\n+            resultBuilder.ifError(() -> Objects.nonNull(environment.getParentEnvironment().getParentEnvironment()),\n+                    \"Parent environment is already a child environment.\");\n+            resultBuilder.ifError(() -> !CloudPlatform.YARN.name().equalsIgnoreCase(environment.getCloudPlatform()),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d19d0066d771099d98678da8d0d062375a4722e9"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4MDY4Njgy", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#pullrequestreview-358068682", "createdAt": "2020-02-13T09:33:08Z", "commit": {"oid": "d19d0066d771099d98678da8d0d062375a4722e9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwOTozMzowOFrOFpMtmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwOTozMzowOFrOFpMtmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc0NDIxOA==", "bodyText": "attach ?", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#discussion_r378744218", "createdAt": "2020-02-13T09:33:08Z", "author": {"login": "doktoric"}, "path": "freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/stack/FreeIpaV1Endpoint.java", "diffHunk": "@@ -39,6 +41,20 @@\n             nickname = \"createFreeIpaV1\")\n     DescribeFreeIpaResponse create(@Valid CreateFreeIpaRequest request);\n \n+    @POST\n+    @Path(\"/register_child_environment\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d19d0066d771099d98678da8d0d062375a4722e9"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4MDY4NzMz", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#pullrequestreview-358068733", "createdAt": "2020-02-13T09:33:13Z", "commit": {"oid": "d19d0066d771099d98678da8d0d062375a4722e9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwOTozMzoxM1rOFpMtxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwOTozMzoxM1rOFpMtxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc0NDI2MA==", "bodyText": "detach ?", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#discussion_r378744260", "createdAt": "2020-02-13T09:33:13Z", "author": {"login": "doktoric"}, "path": "freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/stack/FreeIpaV1Endpoint.java", "diffHunk": "@@ -39,6 +41,20 @@\n             nickname = \"createFreeIpaV1\")\n     DescribeFreeIpaResponse create(@Valid CreateFreeIpaRequest request);\n \n+    @POST\n+    @Path(\"/register_child_environment\")\n+    @Produces(MediaType.APPLICATION_JSON)\n+    @ApiOperation(value = FreeIpaOperationDescriptions.REGISTER_CHILD_ENVIRONMENT, produces = MediaType.APPLICATION_JSON, notes = FreeIpaNotes.FREEIPA_NOTES,\n+            nickname = \"registerChildEnvironmentV1\")\n+    void registerChildEnvironment(@Valid RegisterChildEnvironmentRequest request);\n+\n+    @POST\n+    @Path(\"/deregister_child_environment\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d19d0066d771099d98678da8d0d062375a4722e9"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4MDY4OTg2", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#pullrequestreview-358068986", "createdAt": "2020-02-13T09:33:35Z", "commit": {"oid": "d19d0066d771099d98678da8d0d062375a4722e9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwOTozMzozNVrOFpMujA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwOTozMzozNVrOFpMujA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc0NDQ2MA==", "bodyText": "childEnvironmentNames ?", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#discussion_r378744460", "createdAt": "2020-02-13T09:33:35Z", "author": {"login": "doktoric"}, "path": "freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/stack/model/describe/DescribeFreeIpaResponse.java", "diffHunk": "@@ -30,6 +30,9 @@\n     @ApiModelProperty(value = ModelDescriptions.ENVIRONMENT_CRN, required = true)\n     private String environmentCrn;\n \n+    @ApiModelProperty(ModelDescriptions.CHILD_ENVIRONMENT_CRN_LIST)\n+    private List<String> childEnvironmentCrns;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d19d0066d771099d98678da8d0d062375a4722e9"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4MDcwMDgw", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#pullrequestreview-358070080", "createdAt": "2020-02-13T09:35:13Z", "commit": {"oid": "d19d0066d771099d98678da8d0d062375a4722e9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwOTozNToxM1rOFpMyFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwOTozNToxM1rOFpMyFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc0NTM2NA==", "bodyText": "can we check for the status? I am afraid if somebody change the terminated = -1 we will be broken", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#discussion_r378745364", "createdAt": "2020-02-13T09:35:13Z", "author": {"login": "doktoric"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/repository/StackRepository.java", "diffHunk": "@@ -67,6 +67,11 @@\n             + \"LEFT JOIN FETCH ig.instanceMetaData WHERE s.environmentCrn = :environmentCrn AND s.accountId = :accountId AND s.terminated = -1\")\n     Optional<Stack> findByEnvironmentCrnAndAccountIdWithList(@Param(\"environmentCrn\") String environmentCrn, @Param(\"accountId\") String accountId);\n \n+    @CheckPermission(action = ResourceAction.READ)\n+    @Query(\"SELECT s FROM Stack s LEFT JOIN FETCH s.childEnvironments c LEFT JOIN FETCH s.instanceGroups ig \"\n+            + \"LEFT JOIN FETCH ig.instanceMetaData WHERE c.environmentCrn = :environmentCrn AND s.accountId = :accountId AND s.terminated = -1\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d19d0066d771099d98678da8d0d062375a4722e9"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4MDcxMzEw", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#pullrequestreview-358071310", "createdAt": "2020-02-13T09:37:01Z", "commit": {"oid": "d19d0066d771099d98678da8d0d062375a4722e9"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4MDg2MTU1", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#pullrequestreview-358086155", "createdAt": "2020-02-13T09:58:43Z", "commit": {"oid": "d19d0066d771099d98678da8d0d062375a4722e9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwOTo1ODo0M1rOFpNjcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwOTo1ODo0M1rOFpNjcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc1ODAwMA==", "bodyText": "do we really need it eagerly? this would mean an extra join every time we fetch the stack", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#discussion_r378758000", "createdAt": "2020-02-13T09:58:43Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/entity/Stack.java", "diffHunk": "@@ -48,6 +50,9 @@\n \n     private String environmentCrn;\n \n+    @OneToMany(mappedBy = \"stack\", fetch = FetchType.EAGER, cascade = CascadeType.ALL, orphanRemoval = true)\n+    private List<ChildEnvironment> childEnvironments = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d19d0066d771099d98678da8d0d062375a4722e9"}, "originalPosition": 21}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d19d0066d771099d98678da8d0d062375a4722e9", "author": {"user": {"login": "pkedvessy", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/d19d0066d771099d98678da8d0d062375a4722e9", "committedDate": "2020-02-11T21:21:02Z", "message": "CB-5494 There can not be active child environment in case of parent environment deletion"}, "afterCommit": {"oid": "16e14673b95d41497329f021f2e583c16910bacb", "author": {"user": {"login": "pkedvessy", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/16e14673b95d41497329f021f2e583c16910bacb", "committedDate": "2020-02-13T10:03:27Z", "message": "CB-5494 There can not be active child environment in case of parent environment deletion"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4MDk5Mjkz", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#pullrequestreview-358099293", "createdAt": "2020-02-13T10:18:10Z", "commit": {"oid": "16e14673b95d41497329f021f2e583c16910bacb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMDoxODoxMFrOFpOMBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMDoxODoxMFrOFpOMBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc2ODM5MA==", "bodyText": "could you refactor into smaller methods?", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#discussion_r378768390", "createdAt": "2020-02-13T10:18:10Z", "author": {"login": "lacikaaa"}, "path": "environment/src/main/java/com/sequenceiq/environment/environment/flow/deletion/handler/freeipa/FreeIpaDeletionHandler.java", "diffHunk": "@@ -52,24 +54,29 @@ protected FreeIpaDeletionHandler(EventSender eventSender, EnvironmentService env\n     @Override\n     public void accept(Event<EnvironmentDto> environmentDtoEvent) {\n         EnvironmentDto environmentDto = environmentDtoEvent.getData();\n-        Optional<Environment> env = environmentService.findEnvironmentById(environmentDto.getId());\n+        Optional<Environment> envOptional = environmentService.findEnvironmentById(environmentDto.getId());\n         try {\n-            if (env.isPresent() && env.get().isCreateFreeIpa() && freeIpaExistsForEnvironment(env.get())) {\n-                freeIpaService.delete(env.get().getResourceCrn());\n-                Pair<PollingResult, Exception> result = freeIpaPollingService.pollWithTimeout(\n-                        new FreeIpaDeletionRetrievalTask(freeIpaService),\n-                        new FreeIpaPollerObject(env.get().getId(), env.get().getResourceCrn()),\n-                        FreeIpaDeletionRetrievalTask.FREEIPA_RETRYING_INTERVAL,\n-                        FreeIpaDeletionRetrievalTask.FREEIPA_RETRYING_COUNT,\n-                        SINGLE_FAILURE);\n-                if (isSuccess(result.getLeft())) {\n-                    eventSender().sendEvent(getNextStepObject(environmentDto), environmentDtoEvent.getHeaders());\n+            if (envOptional.isPresent() && envOptional.get().isCreateFreeIpa() && freeIpaExistsForEnvironment(envOptional.get())) {\n+                Environment environment = envOptional.get();\n+                if (isNull(environment.getParentEnvironment())) {\n+                    freeIpaService.delete(environment.getResourceCrn());\n+                    Pair<PollingResult, Exception> result = freeIpaPollingService.pollWithTimeout(\n+                            new FreeIpaDeletionRetrievalTask(freeIpaService),\n+                            new FreeIpaPollerObject(environment.getId(), environment.getResourceCrn()),\n+                            FreeIpaDeletionRetrievalTask.FREEIPA_RETRYING_INTERVAL,\n+                            FreeIpaDeletionRetrievalTask.FREEIPA_RETRYING_COUNT,\n+                            SINGLE_FAILURE);\n+                    if (!isSuccess(result.getLeft())) {\n+                        throw new FreeIpaOperationFailedException(\"Failed to delete FreeIpa! \" + getIfNotNull(result.getRight(), Throwable::getMessage));\n+                    }\n                 } else {\n-                    throw new FreeIpaOperationFailedException(\"Failed to delete FreeIpa! \" + getIfNotNull(result.getRight(), Throwable::getMessage));\n+                    DeregisterChildEnvironmentRequest deregisterChildEnvironmentRequest = new DeregisterChildEnvironmentRequest();\n+                    deregisterChildEnvironmentRequest.setParentEnvironmentCrn(environment.getParentEnvironment().getResourceCrn());\n+                    deregisterChildEnvironmentRequest.setChildEnvironmentCrn(environment.getResourceCrn());\n+                    freeIpaService.deregisterChildEnvironment(deregisterChildEnvironmentRequest);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16e14673b95d41497329f021f2e583c16910bacb"}, "originalPosition": 51}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4MTEyMzMy", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#pullrequestreview-358112332", "createdAt": "2020-02-13T10:37:41Z", "commit": {"oid": "16e14673b95d41497329f021f2e583c16910bacb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMDozNzo0MVrOFpOz2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMDozNzo0MVrOFpOz2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc3ODU4Nw==", "bodyText": "not FreeIPA request, it's RegisterChildEnvironmentRequest", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#discussion_r378778587", "createdAt": "2020-02-13T10:37:41Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/controller/FreeIpaV1Controller.java", "diffHunk": "@@ -86,6 +96,23 @@ public DescribeFreeIpaResponse create(@Valid CreateFreeIpaRequest request) {\n         return freeIpaCreationService.launchFreeIpa(request, accountId);\n     }\n \n+    @Override\n+    public void registerChildEnvironment(@Valid RegisterChildEnvironmentRequest request) {\n+        ValidationResult validationResult = registerChildEnvironmentRequestValidator.validate(request);\n+        if (validationResult.hasError()) {\n+            LOGGER.debug(\"FreeIPA request has validation error(s): {}.\", validationResult.getFormattedErrors());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16e14673b95d41497329f021f2e583c16910bacb"}, "originalPosition": 55}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d3d2e76c3fa03753f1abcf34bdaf76270b4965cf", "author": {"user": {"login": "pkedvessy", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/d3d2e76c3fa03753f1abcf34bdaf76270b4965cf", "committedDate": "2020-02-17T10:18:03Z", "message": "CB-5121 Apply review comments\n\nCB-5121 Revert unnecessary e2e test changes"}, "afterCommit": {"oid": "cb1e6cdada50bb461fdcab9ffde35ef57f2fb8c6", "author": {"user": {"login": "biharitomi", "name": "Tamas Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/cb1e6cdada50bb461fdcab9ffde35ef57f2fb8c6", "committedDate": "2020-02-17T10:33:20Z", "message": "CB-5031 update hostname on Ycloud based on CB-1367 to avoid DNS healt check failures in CM"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cb1e6cdada50bb461fdcab9ffde35ef57f2fb8c6", "author": {"user": {"login": "biharitomi", "name": "Tamas Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/cb1e6cdada50bb461fdcab9ffde35ef57f2fb8c6", "committedDate": "2020-02-17T10:33:20Z", "message": "CB-5031 update hostname on Ycloud based on CB-1367 to avoid DNS healt check failures in CM"}, "afterCommit": {"oid": "c80bfcd71389644b55cd0a71e7ace3412b7ee8b9", "author": {"user": {"login": "biharitomi", "name": "Tamas Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/c80bfcd71389644b55cd0a71e7ace3412b7ee8b9", "committedDate": "2020-02-17T15:08:03Z", "message": "CB-5031 update hostname on Ycloud based on CB-1367 to avoid DNS healt check failures in CM"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e6f29733c7005527ff7609b83a66d8fdd324f344", "author": {"user": {"login": "Bajzathd", "name": "Bajz\u00e1th D\u00e1vid"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/e6f29733c7005527ff7609b83a66d8fdd324f344", "committedDate": "2020-02-17T16:46:06Z", "message": "CB-5122 Validate delete freeipa request"}, "afterCommit": {"oid": "bafc3b7c5c997922560ed9d20c1984f24095de4c", "author": {"user": {"login": "Bajzathd", "name": "Bajz\u00e1th D\u00e1vid"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/bafc3b7c5c997922560ed9d20c1984f24095de4c", "committedDate": "2020-02-18T13:21:15Z", "message": "CB-5122 Validate delete freeipa request"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNDI4MDA2", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#pullrequestreview-360428006", "createdAt": "2020-02-18T15:22:54Z", "commit": {"oid": "bafc3b7c5c997922560ed9d20c1984f24095de4c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNjkyNjc5", "url": "https://github.com/hortonworks/cloudbreak/pull/7230#pullrequestreview-360692679", "createdAt": "2020-02-18T21:40:05Z", "commit": {"oid": "bafc3b7c5c997922560ed9d20c1984f24095de4c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f875719b8db02bb3c87e0db5c07ac5150d4d6b56", "author": {"user": {"login": "Bajzathd", "name": "Bajz\u00e1th D\u00e1vid"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/f875719b8db02bb3c87e0db5c07ac5150d4d6b56", "committedDate": "2020-02-21T09:06:29Z", "message": "CB-5122 Draft of child environment relation in freeipa service"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d22b71f0e56f07adcfd2e2065b401c4a0f57cf8", "author": {"user": {"login": "pkedvessy", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/0d22b71f0e56f07adcfd2e2065b401c4a0f57cf8", "committedDate": "2020-02-21T09:06:29Z", "message": "CB-5121 Hybrid environment creation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23240a55f91e7ef5733465175764a6da0b94d60b", "author": {"user": {"login": "biharitomi", "name": "Tamas Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/23240a55f91e7ef5733465175764a6da0b94d60b", "committedDate": "2020-02-21T09:06:29Z", "message": "CB-5162 CB managed FreeIPA support for Ycloud with feature switch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24c5bfe3658dbe7baee9441b027f604e8fb94ae1", "author": {"user": {"login": "Bajzathd", "name": "Bajz\u00e1th D\u00e1vid"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/24c5bfe3658dbe7baee9441b027f604e8fb94ae1", "committedDate": "2020-02-21T09:06:29Z", "message": "CB-5122 Add parentEnvironmentCrn to SimpleEnvironmentResponse"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc90b5092b7311b61104d23bfde4619482d45a46", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/fc90b5092b7311b61104d23bfde4619482d45a46", "committedDate": "2020-02-21T09:06:30Z", "message": "CB-5395 Deregister child relation in case of deleting an environment with parent environment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b60d2f38ab9797086336448705a5251a352a902", "author": {"user": {"login": "biharitomi", "name": "Tamas Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/6b60d2f38ab9797086336448705a5251a352a902", "committedDate": "2020-02-21T09:06:30Z", "message": "CB-5162 fix FreeIPA and core orchestration for child environment related calls, reenable systemctl hack for YARN"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "080bbf528687956ac5ec917bfb55a10edd343c81", "author": {"user": {"login": "biharitomi", "name": "Tamas Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/080bbf528687956ac5ec917bfb55a10edd343c81", "committedDate": "2020-02-21T09:06:30Z", "message": "CB-5122 FreeIPA's LdapConfig and KerbConfig entity cleanup in case of child environment (#7266)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "402eacfd0cf1b7c03cca938666552c23e2c8cd1e", "author": {"user": {"login": "pkedvessy", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/402eacfd0cf1b7c03cca938666552c23e2c8cd1e", "committedDate": "2020-02-21T09:06:30Z", "message": "CB-5494 There can not be active child environment in case of parent environment deletion"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1986dbacca58bd8a82956ae3456a3b1de30824c6", "author": {"user": {"login": "Bajzathd", "name": "Bajz\u00e1th D\u00e1vid"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/1986dbacca58bd8a82956ae3456a3b1de30824c6", "committedDate": "2020-02-21T09:06:30Z", "message": "CB-5122 Rename freeipa child environment management"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b70415ae2b5782875aa58d8c1788151df580623a", "author": {"user": {"login": "pkedvessy", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/b70415ae2b5782875aa58d8c1788151df580623a", "committedDate": "2020-02-21T09:06:30Z", "message": "CB-5121 Apply review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54a4b768587145d7dd22998b670f68b61b87e8d3", "author": {"user": {"login": "biharitomi", "name": "Tamas Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/54a4b768587145d7dd22998b670f68b61b87e8d3", "committedDate": "2020-02-21T09:06:30Z", "message": "CB-5031 update hostname on Ycloud based on CB-1367 to avoid DNS healt check failures in CM"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "067b65f3c31808c6dcd872d590e62773984b2a85", "author": {"user": {"login": "Bajzathd", "name": "Bajz\u00e1th D\u00e1vid"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/067b65f3c31808c6dcd872d590e62773984b2a85", "committedDate": "2020-02-21T09:06:30Z", "message": "CB-5122 Validate delete freeipa request"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "baf9392cbd93e7e4913b47e44352ec97e058b905", "author": {"user": {"login": "Bajzathd", "name": "Bajz\u00e1th D\u00e1vid"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/baf9392cbd93e7e4913b47e44352ec97e058b905", "committedDate": "2020-02-21T09:06:30Z", "message": "CB-5122 Remove eager fetching of child environments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "448230ac70847b668aa93b3c6c105ae0461d7d96", "author": {"user": {"login": "Bajzathd", "name": "Bajz\u00e1th D\u00e1vid"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/448230ac70847b668aa93b3c6c105ae0461d7d96", "committedDate": "2020-02-21T09:06:30Z", "message": "CB-5122 Only fetch ChildEnvironment when necessary"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6923618f9c6f1433819f8e14c146c1f2ff69ef91", "author": {"user": {"login": "Bajzathd", "name": "Bajz\u00e1th D\u00e1vid"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/6923618f9c6f1433819f8e14c146c1f2ff69ef91", "committedDate": "2020-02-21T09:06:30Z", "message": "CB-5122 Remove childEnvironment references from stack"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9144e66f182265370e85e9db228968a63c8f2949", "author": {"user": {"login": "Bajzathd", "name": "Bajz\u00e1th D\u00e1vid"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/9144e66f182265370e85e9db228968a63c8f2949", "committedDate": "2020-02-21T09:06:30Z", "message": "CB-5395 Fix FreeIpa delete/detach conditions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d3a5a48f4048ada10e99a31b5321dc3e5967bfcb", "author": {"user": {"login": "Bajzathd", "name": "Bajz\u00e1th D\u00e1vid"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/d3a5a48f4048ada10e99a31b5321dc3e5967bfcb", "committedDate": "2020-02-19T15:31:18Z", "message": "CB-5395 Fix FreeIpa delete/detach conditions"}, "afterCommit": {"oid": "9144e66f182265370e85e9db228968a63c8f2949", "author": {"user": {"login": "Bajzathd", "name": "Bajz\u00e1th D\u00e1vid"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/9144e66f182265370e85e9db228968a63c8f2949", "committedDate": "2020-02-21T09:06:30Z", "message": "CB-5395 Fix FreeIpa delete/detach conditions"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1952, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}