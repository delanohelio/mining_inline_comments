{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI4Nzc5MDAy", "number": 8228, "title": "CB-7217 Add necessary salt stack changes to invoke the database backup restore scripts.", "bodyText": "Invoke PostgreSQL backup and restore salt scripts.\n\nAdd Salt States for:\n\nCopying scripts to master node\nCopying .pgpass for credentials\nRunning backup and restore scripts\n\n\nMove PostgreSQL scripts to disaster_recovery directory.\nAdd Pillar value for backup location\n\nCloses CB-7217", "createdAt": "2020-06-05T21:35:52Z", "url": "https://github.com/hortonworks/cloudbreak/pull/8228", "merged": true, "mergeCommit": {"oid": "05021e1f428a4749f34629a4e863ad27d95a0501"}, "closed": true, "closedAt": "2020-06-09T17:47:58Z", "author": {"login": "brycederriso"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpMrotAFqTQyNjAzOTMxNw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcpm-KWABqjM0MjU1NjU2MTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2MDM5MzE3", "url": "https://github.com/hortonworks/cloudbreak/pull/8228#pullrequestreview-426039317", "createdAt": "2020-06-08T09:03:29Z", "commit": {"oid": "96269172387a21a55149ff4a3703b58b4b379e18"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwOTowMzoyOVrOGgVFMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwOTowMzoyOVrOGgVFMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU1MzAwOQ==", "bodyText": "Please use 750 for these files.", "url": "https://github.com/hortonworks/cloudbreak/pull/8228#discussion_r436553009", "createdAt": "2020-06-08T09:03:29Z", "author": {"login": "keyki"}, "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/disaster_recovery/init.sls", "diffHunk": "@@ -0,0 +1,27 @@\n+/opt/salt/scripts/backup_db.sh:\n+  file.managed:\n+    - makedirs: True\n+    - mode: 755", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96269172387a21a55149ff4a3703b58b4b379e18"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2MDQyMTIy", "url": "https://github.com/hortonworks/cloudbreak/pull/8228#pullrequestreview-426042122", "createdAt": "2020-06-08T09:07:08Z", "commit": {"oid": "96269172387a21a55149ff4a3703b58b4b379e18"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwOTowNzowOFrOGgVNZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwOTowNzowOFrOGgVNZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU1NTEwOA==", "bodyText": "I don't think we need to include it here. Whenever we invoke restore or backup it will include the init.sls and create the scripts.", "url": "https://github.com/hortonworks/cloudbreak/pull/8228#discussion_r436555108", "createdAt": "2020-06-08T09:07:08Z", "author": {"login": "keyki"}, "path": "orchestrator-salt/src/main/resources/salt/salt/top.sls", "diffHunk": "@@ -28,6 +28,7 @@ base:\n \n   'G@roles:manager_server':\n     - postgresql\n+    - postgresql.disaster_recovery", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96269172387a21a55149ff4a3703b58b4b379e18"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2MDQ1NDI0", "url": "https://github.com/hortonworks/cloudbreak/pull/8228#pullrequestreview-426045424", "createdAt": "2020-06-08T09:10:33Z", "commit": {"oid": "96269172387a21a55149ff4a3703b58b4b379e18"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwOToxMDozM1rOGgVVDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwOToxMDozM1rOGgVVDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU1NzA3MQ==", "bodyText": "Not all of our clusters use external DB. Many tests use embedded DB where these pillar configs will be missing. We should add a condition to only execute this if it's external DB. See: example", "url": "https://github.com/hortonworks/cloudbreak/pull/8228#discussion_r436557071", "createdAt": "2020-06-08T09:10:33Z", "author": {"login": "keyki"}, "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/disaster_recovery/restore.sls", "diffHunk": "@@ -0,0 +1,9 @@\n+include:\n+  - postgresql.disaster_recovery\n+\n+restore_postgresql_db:\n+  cmd.run:\n+    - name: /opt/salt/scripts/restore_db.sh {{salt['pillar.get']('platform')}} {{salt['pillar.get']('disaster_recovery:object_storage_url')}} {{salt['pillar.get']('postgres:remote_db_url')}} {{salt['pillar.get']('postgres:remote_db_port')}} {{salt['pillar.get']('postgres:remote_admin')}}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96269172387a21a55149ff4a3703b58b4b379e18"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2MDQ4NTY5", "url": "https://github.com/hortonworks/cloudbreak/pull/8228#pullrequestreview-426048569", "createdAt": "2020-06-08T09:14:45Z", "commit": {"oid": "96269172387a21a55149ff4a3703b58b4b379e18"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwOToxNDo0NVrOGgVfQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwOToxNDo0NVrOGgVfQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU1OTY4MA==", "bodyText": "Similarily check if it's external DB, otherwise, this state should not do anything.", "url": "https://github.com/hortonworks/cloudbreak/pull/8228#discussion_r436559680", "createdAt": "2020-06-08T09:14:45Z", "author": {"login": "keyki"}, "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/disaster_recovery/backup.sls", "diffHunk": "@@ -0,0 +1,9 @@\n+include:\n+  - postgresql.disaster_recovery\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96269172387a21a55149ff4a3703b58b4b379e18"}, "originalPosition": 3}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2MDU1ODQ3", "url": "https://github.com/hortonworks/cloudbreak/pull/8228#pullrequestreview-426055847", "createdAt": "2020-06-08T09:24:40Z", "commit": {"oid": "96269172387a21a55149ff4a3703b58b4b379e18"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwOToyNDo0MFrOGgV1OA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwOToyNDo0MFrOGgV1OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU2NTMwNA==", "bodyText": "The value of this variable will be passed in a later commit?", "url": "https://github.com/hortonworks/cloudbreak/pull/8228#discussion_r436565304", "createdAt": "2020-06-08T09:24:40Z", "author": {"login": "keyki"}, "path": "orchestrator-salt/src/main/resources/salt/pillar/postgresql/disaster_recovery.sls", "diffHunk": "@@ -0,0 +1,3 @@\n+disaster_recovery:\n+  object_storage_url:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96269172387a21a55149ff4a3703b58b4b379e18"}, "originalPosition": 2}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ac2cec8fbe51c24a85a7f890d62b6689f9a504ea", "author": {"user": {"login": "brycederriso", "name": "Bryce"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/ac2cec8fbe51c24a85a7f890d62b6689f9a504ea", "committedDate": "2020-06-08T16:51:36Z", "message": "Fix curly brace typo in backup/restore states."}, "afterCommit": {"oid": "1e8c9acedf3b28b595547bbfcbeeddbb584230b4", "author": {"user": {"login": "brycederriso", "name": "Bryce"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/1e8c9acedf3b28b595547bbfcbeeddbb584230b4", "committedDate": "2020-06-08T18:24:30Z", "message": "CB-7217 Add Salt Stack changes to backup/restore postgres.\n\nChange salt stack and pillar to:\n* Create `.pgpass`\n* Copy backup script to minion\n* Copy restore script to minion\n* Be able to run backup script to a particular S3 location\n* Be able to run restore script from a particular S3 location"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f24c03d4dfb65c9ddfbc6826ca0151483fd63fd8", "author": {"user": {"login": "brycederriso", "name": "Bryce"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/f24c03d4dfb65c9ddfbc6826ca0151483fd63fd8", "committedDate": "2020-06-09T15:40:48Z", "message": "CB-7217 Add Salt Stack changes to backup/restore postgres.\n\nChange salt stack and pillar to:\n* Create `.pgpass`\n* Copy backup script to minion\n* Copy restore script to minion\n* Be able to run backup script to a particular S3 location\n* Be able to run restore script from a particular S3 location"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1e8c9acedf3b28b595547bbfcbeeddbb584230b4", "author": {"user": {"login": "brycederriso", "name": "Bryce"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/1e8c9acedf3b28b595547bbfcbeeddbb584230b4", "committedDate": "2020-06-08T18:24:30Z", "message": "CB-7217 Add Salt Stack changes to backup/restore postgres.\n\nChange salt stack and pillar to:\n* Create `.pgpass`\n* Copy backup script to minion\n* Copy restore script to minion\n* Be able to run backup script to a particular S3 location\n* Be able to run restore script from a particular S3 location"}, "afterCommit": {"oid": "f24c03d4dfb65c9ddfbc6826ca0151483fd63fd8", "author": {"user": {"login": "brycederriso", "name": "Bryce"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/f24c03d4dfb65c9ddfbc6826ca0151483fd63fd8", "committedDate": "2020-06-09T15:40:48Z", "message": "CB-7217 Add Salt Stack changes to backup/restore postgres.\n\nChange salt stack and pillar to:\n* Create `.pgpass`\n* Copy backup script to minion\n* Copy restore script to minion\n* Be able to run backup script to a particular S3 location\n* Be able to run restore script from a particular S3 location"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1812, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}