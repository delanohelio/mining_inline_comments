{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ4MjE2OTEy", "number": 8541, "title": "On-demand log collection for FreeIpa", "bodyText": "See detailed description in the commit message.", "createdAt": "2020-07-13T12:15:04Z", "url": "https://github.com/hortonworks/cloudbreak/pull/8541", "merged": true, "mergeCommit": {"oid": "fde59770ac466fb0f546e6415f76cca83f0f191f"}, "closed": true, "closedAt": "2020-07-17T12:58:09Z", "author": {"login": "attilapalfi92"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc0i5ipABqjM1Mzk5OTkyMzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc1yY9XgBqjM1NTc3NzU5MjE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "930579374f894c61d478a725a20db6d7c68686f1", "author": {"user": {"login": "attilapalfi92", "name": "Attila P\u00e1lfi"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/930579374f894c61d478a725a20db6d7c68686f1", "committedDate": "2020-07-13T13:40:09Z", "message": "checkstyle fixes"}, "afterCommit": {"oid": "6be8983e892811a890a79a21a09a5888b2f0a436", "author": {"user": {"login": "attilapalfi92", "name": "Attila P\u00e1lfi"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/6be8983e892811a890a79a21a09a5888b2f0a436", "committedDate": "2020-07-13T15:06:39Z", "message": "CB-7484. Create diagnostics collection flow (FreeIPA)\n\ndetails:\n- creating a new flow (+ API) for freeipa log collection\n- the new api has 2 endpoint: POST that starts the diagnostics flow, GET which shows files that will be collected\n- flow has 4 phases: init, collect, upload and cleanup\n- each phase executes a salt state in filecollector module like: filecollector.init or filecollector.collect etc.\n- extend salt java module to add pillar parameters for the commands and run executions in concurrent mode (see ParametrizedStateRunner and CuncurrentParameterizedStateRunner)\n- refactor hostOrchestrator a bit by extending telemetry related operations and create stack service for commonly used operations\n- add / fix some unit tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6be8983e892811a890a79a21a09a5888b2f0a436", "author": {"user": {"login": "attilapalfi92", "name": "Attila P\u00e1lfi"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/6be8983e892811a890a79a21a09a5888b2f0a436", "committedDate": "2020-07-13T15:06:39Z", "message": "CB-7484. Create diagnostics collection flow (FreeIPA)\n\ndetails:\n- creating a new flow (+ API) for freeipa log collection\n- the new api has 2 endpoint: POST that starts the diagnostics flow, GET which shows files that will be collected\n- flow has 4 phases: init, collect, upload and cleanup\n- each phase executes a salt state in filecollector module like: filecollector.init or filecollector.collect etc.\n- extend salt java module to add pillar parameters for the commands and run executions in concurrent mode (see ParametrizedStateRunner and CuncurrentParameterizedStateRunner)\n- refactor hostOrchestrator a bit by extending telemetry related operations and create stack service for commonly used operations\n- add / fix some unit tests"}, "afterCommit": {"oid": "5de69cbdd30720559e56d2437c3f8b185610d9bc", "author": {"user": {"login": "attilapalfi92", "name": "Attila P\u00e1lfi"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/5de69cbdd30720559e56d2437c3f8b185610d9bc", "committedDate": "2020-07-14T09:21:01Z", "message": "CB-7484. Create diagnostics collection flow (FreeIPA)\n\ndetails:\n- creating a new flow (+ API) for freeipa log collection\n- the new api has 2 endpoint: POST that starts the diagnostics flow, GET which shows files that will be collected\n- flow has 4 phases: init, collect, upload and cleanup\n- each phase executes a salt state in filecollector module like: filecollector.init or filecollector.collect etc.\n- extend salt java module to add pillar parameters for the commands and run executions in concurrent mode (see ParametrizedStateRunner and CuncurrentParameterizedStateRunner)\n- refactor hostOrchestrator a bit by extending telemetry related operations and create stack service for commonly used operations\n- add / fix some unit tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5de69cbdd30720559e56d2437c3f8b185610d9bc", "author": {"user": {"login": "attilapalfi92", "name": "Attila P\u00e1lfi"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/5de69cbdd30720559e56d2437c3f8b185610d9bc", "committedDate": "2020-07-14T09:21:01Z", "message": "CB-7484. Create diagnostics collection flow (FreeIPA)\n\ndetails:\n- creating a new flow (+ API) for freeipa log collection\n- the new api has 2 endpoint: POST that starts the diagnostics flow, GET which shows files that will be collected\n- flow has 4 phases: init, collect, upload and cleanup\n- each phase executes a salt state in filecollector module like: filecollector.init or filecollector.collect etc.\n- extend salt java module to add pillar parameters for the commands and run executions in concurrent mode (see ParametrizedStateRunner and CuncurrentParameterizedStateRunner)\n- refactor hostOrchestrator a bit by extending telemetry related operations and create stack service for commonly used operations\n- add / fix some unit tests"}, "afterCommit": {"oid": "6ed49dd5fda8a53ceeb5ed2dfafb307a05a1a4c5", "author": {"user": {"login": "attilapalfi92", "name": "Attila P\u00e1lfi"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/6ed49dd5fda8a53ceeb5ed2dfafb307a05a1a4c5", "committedDate": "2020-07-14T12:29:23Z", "message": "CB-7484. Create diagnostics collection flow (FreeIPA)\n\ndetails:\n- creating a new flow (+ API) for freeipa log collection\n- the new api has 2 endpoint: POST that starts the diagnostics flow, GET which shows files that will be collected\n- flow has 4 phases: init, collect, upload and cleanup\n- each phase executes a salt state in filecollector module like: filecollector.init or filecollector.collect etc.\n- extend salt java module to add pillar parameters for the commands and run executions in concurrent mode (see ParametrizedStateRunner and CuncurrentParameterizedStateRunner)\n- refactor hostOrchestrator a bit by extending telemetry related operations and create stack service for commonly used operations\n- add / fix some unit tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6ed49dd5fda8a53ceeb5ed2dfafb307a05a1a4c5", "author": {"user": {"login": "attilapalfi92", "name": "Attila P\u00e1lfi"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/6ed49dd5fda8a53ceeb5ed2dfafb307a05a1a4c5", "committedDate": "2020-07-14T12:29:23Z", "message": "CB-7484. Create diagnostics collection flow (FreeIPA)\n\ndetails:\n- creating a new flow (+ API) for freeipa log collection\n- the new api has 2 endpoint: POST that starts the diagnostics flow, GET which shows files that will be collected\n- flow has 4 phases: init, collect, upload and cleanup\n- each phase executes a salt state in filecollector module like: filecollector.init or filecollector.collect etc.\n- extend salt java module to add pillar parameters for the commands and run executions in concurrent mode (see ParametrizedStateRunner and CuncurrentParameterizedStateRunner)\n- refactor hostOrchestrator a bit by extending telemetry related operations and create stack service for commonly used operations\n- add / fix some unit tests"}, "afterCommit": {"oid": "ea7c16df4859e8626d096b2bc40c778a8a11780c", "author": {"user": {"login": "attilapalfi92", "name": "Attila P\u00e1lfi"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/ea7c16df4859e8626d096b2bc40c778a8a11780c", "committedDate": "2020-07-15T08:10:48Z", "message": "CB-7484. Create diagnostics collection flow (FreeIPA)\n\ndetails:\n- creating a new flow (+ API) for freeipa log collection\n- the new api has 2 endpoint: POST that starts the diagnostics flow, GET which shows files that will be collected\n- flow has 4 phases: init, collect, upload and cleanup\n- each phase executes a salt state in filecollector module like: filecollector.init or filecollector.collect etc.\n- extend salt java module to add pillar parameters for the commands and run executions in concurrent mode (see ParametrizedStateRunner and CuncurrentParameterizedStateRunner)\n- refactor hostOrchestrator a bit by extending telemetry related operations and create stack service for commonly used operations\n- add / fix some unit tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4OTEwOTQ4", "url": "https://github.com/hortonworks/cloudbreak/pull/8541#pullrequestreview-448910948", "createdAt": "2020-07-15T12:38:52Z", "commit": {"oid": "ea7c16df4859e8626d096b2bc40c778a8a11780c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxMjozODo1M1rOGx8Jcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxMjozODo1M1rOGx8Jcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTAxODg2Ng==", "bodyText": "We need new images with these packages otherwise the no-internet test will fail and it will be a blocker for promotion.", "url": "https://github.com/hortonworks/cloudbreak/pull/8541#discussion_r455018866", "createdAt": "2020-07-15T12:38:53Z", "author": {"login": "keyki"}, "path": "orchestrator-salt/src/main/resources/salt-common/salt/filecollector/init.sls", "diffHunk": "@@ -0,0 +1,88 @@\n+{%- from 'telemetry/settings.sls' import telemetry with context %}\n+{%- from 'filecollector/settings.sls' import filecollector with context %}\n+{%- from 'fluent/settings.sls' import fluent with context %}\n+\n+install_fluent_logger:\n+  cmd.run:\n+    - name: pip install fluent-logger>=0.9.6 --ignore-installed", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea7c16df4859e8626d096b2bc40c778a8a11780c"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5NTM2NTE5", "url": "https://github.com/hortonworks/cloudbreak/pull/8541#pullrequestreview-449536519", "createdAt": "2020-07-16T06:21:50Z", "commit": {"oid": "ea7c16df4859e8626d096b2bc40c778a8a11780c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwNjoyMTo1MVrOGybrBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwNjoyMTo1MVrOGybrBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTUzNTM2Nw==", "bodyText": "We will need to deal with encryption + the region must be a parameter otherwise it won't work with S3 VPC endpoint.\nBoth of them are handled in the freeipa_backup script.", "url": "https://github.com/hortonworks/cloudbreak/pull/8541#discussion_r455535367", "createdAt": "2020-07-16T06:21:51Z", "author": {"login": "keyki"}, "path": "orchestrator-salt/src/main/resources/salt-common/salt/filecollector/template/cloud_storage_upload.sh.j2", "diffHunk": "@@ -0,0 +1,56 @@\n+#!/bin/sh\n+{%- from 'filecollector/settings.sls' import filecollector with context %}\n+{%- from 'telemetry/settings.sls' import telemetry with context %}\n+\n+function log() {\n+  echo \"$1\"\n+}\n+\n+function error_exit() {\n+  log \"ERROR $1\"\n+  exit 1\n+}\n+\n+function upload_file() {\n+   local platform=\"$2\"\n+   if [[ \"$platform\" == \"AWS\" ]]; then\n+      upload_to_s3 \"$1\"\n+   elif [[ \"$platform\" == \"AZURE\" ]]; then\n+      upload_to_azure_storage \"$1\"\n+   else\n+     log \"Upload file to cloud storage is not supported from platform '${platform}'\"\n+   fi\n+}\n+\n+function upload_to_s3() {\n+  local filename=$1\n+  s3_filename=\"$(basename -- $filename)\"\n+  s3_file_path=\"{{ filecollector.s3BaseUrl }}/${s3_filename}\"\n+  # --sse AES256\n+  /usr/bin/aws s3 cp --no-progress \"${filename}\" \"${s3_file_path}\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea7c16df4859e8626d096b2bc40c778a8a11780c"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5NTM3NDgx", "url": "https://github.com/hortonworks/cloudbreak/pull/8541#pullrequestreview-449537481", "createdAt": "2020-07-16T06:23:55Z", "commit": {"oid": "ea7c16df4859e8626d096b2bc40c778a8a11780c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwNjoyMzo1NVrOGybuEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwNjoyMzo1NVrOGybuEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTUzNjE0NQ==", "bodyText": "Can this port change?", "url": "https://github.com/hortonworks/cloudbreak/pull/8541#discussion_r455536145", "createdAt": "2020-07-16T06:23:55Z", "author": {"login": "keyki"}, "path": "orchestrator-salt/src/main/resources/salt-common/salt/fluent/settings.sls", "diffHunk": "@@ -140,6 +140,8 @@\n   {% set proxy_full_url = None %}\n {% endif %}\n \n+{% set forward_port = 24224 %}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea7c16df4859e8626d096b2bc40c778a8a11780c"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5NTM4MTc1", "url": "https://github.com/hortonworks/cloudbreak/pull/8541#pullrequestreview-449538175", "createdAt": "2020-07-16T06:25:28Z", "commit": {"oid": "ea7c16df4859e8626d096b2bc40c778a8a11780c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwNjoyNToyOVrOGybwqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwNjoyNToyOVrOGybwqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTUzNjgxMQ==", "bodyText": "There are lots of files being managed and have 740 and 750 mode. Do any of these files contain sensitive data or should we use 700 and 600 regardless? Why would a regular user need to read these files?", "url": "https://github.com/hortonworks/cloudbreak/pull/8541#discussion_r455536811", "createdAt": "2020-07-16T06:25:29Z", "author": {"login": "keyki"}, "path": "orchestrator-salt/src/main/resources/salt-common/salt/filecollector/init.sls", "diffHunk": "@@ -0,0 +1,88 @@\n+{%- from 'telemetry/settings.sls' import telemetry with context %}\n+{%- from 'filecollector/settings.sls' import filecollector with context %}\n+{%- from 'fluent/settings.sls' import fluent with context %}\n+\n+install_fluent_logger:\n+  cmd.run:\n+    - name: pip install fluent-logger>=0.9.6 --ignore-installed\n+    - unless: pip list --no-index | grep -E 'fluent-logger'\n+\n+install_yaml:\n+  cmd.run:\n+    - name: pip install PyYAML --ignore-installed\n+    - unless: pip list --no-index | grep -E 'PyYAML'\n+\n+install_pid:\n+  cmd.run:\n+    - name: pip install pid --ignore-installed\n+    - unless: pip list --no-index | grep -E 'pid'\n+\n+/opt/filecollector:\n+  file.directory:\n+    - name: /opt/filecollector\n+    - user: \"root\"\n+    - group: \"root\"\n+    - mode: 740", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea7c16df4859e8626d096b2bc40c778a8a11780c"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5NjEyNzg2", "url": "https://github.com/hortonworks/cloudbreak/pull/8541#pullrequestreview-449612786", "createdAt": "2020-07-16T08:04:41Z", "commit": {"oid": "ea7c16df4859e8626d096b2bc40c778a8a11780c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwODowNDo0MVrOGyfUuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwODowNDo0MVrOGyfUuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTU5NTE5Mg==", "bodyText": "For this we will need a new image or it will break the no-internet test again. This will run on a regular highstate.", "url": "https://github.com/hortonworks/cloudbreak/pull/8541#discussion_r455595192", "createdAt": "2020-07-16T08:04:41Z", "author": {"login": "keyki"}, "path": "orchestrator-salt/src/main/resources/salt-common/salt/fluent/settings.sls", "diffHunk": "@@ -84,7 +84,7 @@\n {% set cloudera_public_gem_repo = 'https://repository.cloudera.com/cloudera/api/gems/cloudera-gems/' %}\n {% set cloudera_azure_plugin_version = '1.0.1' %}\n {% set cloudera_azure_gen2_plugin_version = '0.3.1' %}\n-{% set cloudera_databus_plugin_version = '1.0.4' %}\n+{% set cloudera_databus_plugin_version = '1.0.5' %}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea7c16df4859e8626d096b2bc40c778a8a11780c"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7bb358e140c8e0261f5f3da1a36be3598189558e", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/7bb358e140c8e0261f5f3da1a36be3598189558e", "committedDate": "2020-07-17T11:39:57Z", "message": "CB-7397. Implement filecollector on CB side (freeipa/datalake/datahub) for on demand diagnostic collection\n\ndetails:\n- Creating a new \"filecollector\" module in salt definitions (salt-common)\n- Creating a new \"telemetry\" module in salt definitions which can be used to store common configurations between different telemtry components (fluent,monitoring,filecollector)\n(as salt upgrade has not done yet properly for freeipa, we still uses many duplicated configs in telemetry and fluent pillars)\n- Basic usage of filecollector: there is a filecollector.py and a specific yaml configuration that is deployed/configured by salt\n- filecollection has 4 different outputs (only first 3 is implemented): local (collection only, you need to ssh into the node for that), customer cloud storage and ENG Kibana (by databus)\n- for the common configurations vm_logs.json files are creadted, in the fututre that will be used as a common source for both fluentd (monitored files) and filecollector (files that are needed to be collected)\n- also added for some default converters and services for VM logs or creating data as a map for the diagnostics flow"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fbec8f8b9cd327b29e7c0e416c93c01ae419218e", "author": {"user": {"login": "attilapalfi92", "name": "Attila P\u00e1lfi"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/fbec8f8b9cd327b29e7c0e416c93c01ae419218e", "committedDate": "2020-07-17T11:45:55Z", "message": "CB-7484. Create diagnostics collection flow (FreeIPA)\n\ndetails:\n- creating a new flow (+ API) for freeipa log collection\n- the new api has 2 endpoint: POST that starts the diagnostics flow, GET which shows files that will be collected\n- flow has 4 phases: init, collect, upload and cleanup\n- each phase executes a salt state in filecollector module like: filecollector.init or filecollector.collect etc.\n- extend salt java module to add pillar parameters for the commands and run executions in concurrent mode (see ParametrizedStateRunner and CuncurrentParameterizedStateRunner)\n- refactor hostOrchestrator a bit by extending telemetry related operations and create stack service for commonly used operations\n- add / fix some unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0cea53f6c71072b20206438df3a61373a37ba151", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/0cea53f6c71072b20206438df3a61373a37ba151", "committedDate": "2020-07-17T11:45:56Z", "message": "CB-7397. Fix folder permissions for filecollector"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "da86ea69e086abc8eaae7c75918eb678fa4a63b2", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/da86ea69e086abc8eaae7c75918eb678fa4a63b2", "committedDate": "2020-07-17T10:38:36Z", "message": "CB-7397. Fix folder permissions for filecollector"}, "afterCommit": {"oid": "0cea53f6c71072b20206438df3a61373a37ba151", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/0cea53f6c71072b20206438df3a61373a37ba151", "committedDate": "2020-07-17T11:45:56Z", "message": "CB-7397. Fix folder permissions for filecollector"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2704, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}