{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY3MzU1NjE5", "number": 8807, "title": "CDPCP-2673. Fix role refresh on cloud identity sync", "bodyText": "The previous behavior for syncing azure oids into CM was to only\ntrigger role refresh if CM reported the configs to be stale. This\ndoes not always work as expected because the staleness status that\nCM reports is eventually consistent.\nTo fix this, instead of relying on staleness check we only set\nthe configs if they are different than the existing configs. Under\nrare circumstances we still need to fallback on checking staleness\nstatus (as explained in the code comment).\nSee detailed description in the commit message.", "createdAt": "2020-08-13T12:33:40Z", "url": "https://github.com/hortonworks/cloudbreak/pull/8807", "merged": true, "mergeCommit": {"oid": "0fbfae9104189932c5c5db24a2d7854de8e41e96"}, "closed": true, "closedAt": "2020-08-18T12:12:37Z", "author": {"login": "handavid"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-f8IBgFqTQ2Njc0MDEwNw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc_ZkHRgBqjM2NTkxMzQ5MzA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2NzQwMTA3", "url": "https://github.com/hortonworks/cloudbreak/pull/8807#pullrequestreview-466740107", "createdAt": "2020-08-13T13:04:36Z", "commit": {"oid": "d6754dc074a6e51c86c2414fb24adb41a2edd393"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxMzowNDozNlrOHAKkQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxMzoyMDo1NFrOHALNFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTkzNTE2OA==", "bodyText": "could you give this variable a meaningful name?", "url": "https://github.com/hortonworks/cloudbreak/pull/8807#discussion_r469935168", "createdAt": "2020-08-13T13:04:36Z", "author": {"login": "lacikaaa"}, "path": "datalake/src/main/java/com/sequenceiq/datalake/cm/ClouderaManagerRangerUtil.java", "diffHunk": "@@ -118,17 +109,61 @@ public boolean isCloudIdMappingSupported(String stackCrn) throws ApiException {\n         return isCloudIdMappingSupported(rolesResourceApi, clusterName, rangerUserSyncRoleName);\n     }\n \n-    public Optional<ApiCommand> setAzureCloudIdentityMapping(String stackCrn, Map<String, String> azureUserMapping) throws ApiException {\n+    private Map<String, String> userMappingStrToMap(String userMappingStr) {\n+        userMappingStr = userMappingStr.trim();\n+        if (userMappingStr.isEmpty()) {\n+            return Collections.emptyMap();\n+        }\n+        Map<String, String> ret = new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6754dc074a6e51c86c2414fb24adb41a2edd393"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTkzNjk0Mg==", "bodyText": "I don't prefer returns in the middle of a method. Could you add an else branch for the rest f the code, so it's obvious there is 2 exit point?", "url": "https://github.com/hortonworks/cloudbreak/pull/8807#discussion_r469936942", "createdAt": "2020-08-13T13:07:25Z", "author": {"login": "lacikaaa"}, "path": "datalake/src/main/java/com/sequenceiq/datalake/cm/ClouderaManagerRangerUtil.java", "diffHunk": "@@ -118,17 +109,61 @@ public boolean isCloudIdMappingSupported(String stackCrn) throws ApiException {\n         return isCloudIdMappingSupported(rolesResourceApi, clusterName, rangerUserSyncRoleName);\n     }\n \n-    public Optional<ApiCommand> setAzureCloudIdentityMapping(String stackCrn, Map<String, String> azureUserMapping) throws ApiException {\n+    private Map<String, String> userMappingStrToMap(String userMappingStr) {\n+        userMappingStr = userMappingStr.trim();\n+        if (userMappingStr.isEmpty()) {\n+            return Collections.emptyMap();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6754dc074a6e51c86c2414fb24adb41a2edd393"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTkzNzQ1Nw==", "bodyText": "shall we log here it's empty?", "url": "https://github.com/hortonworks/cloudbreak/pull/8807#discussion_r469937457", "createdAt": "2020-08-13T13:08:17Z", "author": {"login": "lacikaaa"}, "path": "datalake/src/main/java/com/sequenceiq/datalake/cm/ClouderaManagerRangerUtil.java", "diffHunk": "@@ -118,17 +109,61 @@ public boolean isCloudIdMappingSupported(String stackCrn) throws ApiException {\n         return isCloudIdMappingSupported(rolesResourceApi, clusterName, rangerUserSyncRoleName);\n     }\n \n-    public Optional<ApiCommand> setAzureCloudIdentityMapping(String stackCrn, Map<String, String> azureUserMapping) throws ApiException {\n+    private Map<String, String> userMappingStrToMap(String userMappingStr) {\n+        userMappingStr = userMappingStr.trim();\n+        if (userMappingStr.isEmpty()) {\n+            return Collections.emptyMap();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTkzNjk0Mg=="}, "originalCommit": {"oid": "d6754dc074a6e51c86c2414fb24adb41a2edd393"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTkzODY4OA==", "bodyText": "what happens if there is no = sign? I think it would throw an exception when you try to assign value to val. Shouldn't we handle this somehow?", "url": "https://github.com/hortonworks/cloudbreak/pull/8807#discussion_r469938688", "createdAt": "2020-08-13T13:10:10Z", "author": {"login": "lacikaaa"}, "path": "datalake/src/main/java/com/sequenceiq/datalake/cm/ClouderaManagerRangerUtil.java", "diffHunk": "@@ -118,17 +109,61 @@ public boolean isCloudIdMappingSupported(String stackCrn) throws ApiException {\n         return isCloudIdMappingSupported(rolesResourceApi, clusterName, rangerUserSyncRoleName);\n     }\n \n-    public Optional<ApiCommand> setAzureCloudIdentityMapping(String stackCrn, Map<String, String> azureUserMapping) throws ApiException {\n+    private Map<String, String> userMappingStrToMap(String userMappingStr) {\n+        userMappingStr = userMappingStr.trim();\n+        if (userMappingStr.isEmpty()) {\n+            return Collections.emptyMap();\n+        }\n+        Map<String, String> ret = new HashMap<>();\n+        String[] mappings = userMappingStr.split(\";\");\n+        Arrays.stream(mappings).forEach(mapping -> {\n+            String[] entry = mapping.split(\"=\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6754dc074a6e51c86c2414fb24adb41a2edd393"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk0NTYyMA==", "bodyText": "what if none found? are we sure there is at least one?", "url": "https://github.com/hortonworks/cloudbreak/pull/8807#discussion_r469945620", "createdAt": "2020-08-13T13:20:54Z", "author": {"login": "lacikaaa"}, "path": "datalake/src/main/java/com/sequenceiq/datalake/cm/ClouderaManagerRangerUtil.java", "diffHunk": "@@ -118,17 +109,61 @@ public boolean isCloudIdMappingSupported(String stackCrn) throws ApiException {\n         return isCloudIdMappingSupported(rolesResourceApi, clusterName, rangerUserSyncRoleName);\n     }\n \n-    public Optional<ApiCommand> setAzureCloudIdentityMapping(String stackCrn, Map<String, String> azureUserMapping) throws ApiException {\n+    private Map<String, String> userMappingStrToMap(String userMappingStr) {\n+        userMappingStr = userMappingStr.trim();\n+        if (userMappingStr.isEmpty()) {\n+            return Collections.emptyMap();\n+        }\n+        Map<String, String> ret = new HashMap<>();\n+        String[] mappings = userMappingStr.split(\";\");\n+        Arrays.stream(mappings).forEach(mapping -> {\n+            String[] entry = mapping.split(\"=\");\n+            String key = entry[0];\n+            String val = entry[1];\n+            ret.put(key, val);\n+        });\n+        return ret;\n+    }\n+\n+    private Map<String, String> getExistingAzureUserMapping(RolesResourceApi rolesResourceApi, String clusterName, String rangerUserSyncRoleName)\n+            throws ApiException {\n+        ApiConfigList roleConfigList = rolesResourceApi.readRoleConfig(clusterName, rangerUserSyncRoleName, RANGER_SERVICE_NAME, \"summary\");\n+        ApiConfig azureUserMappingConfig = roleConfigList.getItems().stream()\n+                .filter(apiConfig -> apiConfig.getName().equals(AZURE_USER_MAPPING))\n+                .findFirst()\n+                .get();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6754dc074a6e51c86c2414fb24adb41a2edd393"}, "originalPosition": 73}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "76c12c2428f0bfa2458af486dc6e829c70f753f5", "author": {"user": {"login": "gitmfox", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/76c12c2428f0bfa2458af486dc6e829c70f753f5", "committedDate": "2020-08-13T22:14:26Z", "message": "CDPCP-2673 Remove unnecessary creation of empty map value\n\nThis fixes an inefficiency in the previous commit addressing review\nfeedback: don't create an empty map unnecessarily in\nClouderaManagerRangerUtil.getExistingAzureUserMapping()."}, "afterCommit": {"oid": "8fed8c0112ed8edef6bd4f7f9ae970642d8ea915", "author": {"user": {"login": "aarman-cloudera", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/8fed8c0112ed8edef6bd4f7f9ae970642d8ea915", "committedDate": "2020-08-14T15:13:39Z", "message": "CDPCP-2673. Fix role refresh on cloud identity sync\n\nThe previous behavior for syncing azure oids into CM was to only\ntrigger role refresh if CM reported the configs to be stale. This\ndoes not always work as expected because the staleness status that\nCM reports is eventually consistent.\n\nTo fix this, instead of relying on staleness check we only set\nthe configs if they are different than the existing configs. Under\nrare circumstances we still need to fallback on checking staleness\nstatus (as explained in the code comment)."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3ODEzNzY0", "url": "https://github.com/hortonworks/cloudbreak/pull/8807#pullrequestreview-467813764", "createdAt": "2020-08-14T19:05:09Z", "commit": {"oid": "8fed8c0112ed8edef6bd4f7f9ae970642d8ea915"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8fed8c0112ed8edef6bd4f7f9ae970642d8ea915", "author": {"user": {"login": "aarman-cloudera", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/8fed8c0112ed8edef6bd4f7f9ae970642d8ea915", "committedDate": "2020-08-14T15:13:39Z", "message": "CDPCP-2673. Fix role refresh on cloud identity sync\n\nThe previous behavior for syncing azure oids into CM was to only\ntrigger role refresh if CM reported the configs to be stale. This\ndoes not always work as expected because the staleness status that\nCM reports is eventually consistent.\n\nTo fix this, instead of relying on staleness check we only set\nthe configs if they are different than the existing configs. Under\nrare circumstances we still need to fallback on checking staleness\nstatus (as explained in the code comment)."}, "afterCommit": {"oid": "ccc8a1ecb8dd859a7b5ed8641b4782fb99056820", "author": {"user": {"login": "aarman-cloudera", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/ccc8a1ecb8dd859a7b5ed8641b4782fb99056820", "committedDate": "2020-08-14T20:08:24Z", "message": "CDPCP-2673. Fix role refresh on cloud identity sync\n\nThe previous behavior for syncing azure oids into CM was to only\ntrigger role refresh if CM reported the configs to be stale. This\ndoes not always work as expected because the staleness status that\nCM reports is eventually consistent.\n\nTo fix this, instead of relying on staleness check we only set\nthe configs if they are different than the existing configs. Under\nrare circumstances we still need to fallback on checking staleness\nstatus (as explained in the code comment)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a6afed21b88cbe54a798b5ed20eb28a09048809", "author": {"user": {"login": "aarman-cloudera", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/2a6afed21b88cbe54a798b5ed20eb28a09048809", "committedDate": "2020-08-16T08:29:53Z", "message": "CDPCP-2673. Fix role refresh on cloud identity sync\n\nThe previous behavior for syncing azure oids into CM was to only\ntrigger role refresh if CM reported the configs to be stale. This\ndoes not always work as expected because the staleness status that\nCM reports is eventually consistent.\n\nTo fix this, instead of relying on staleness check we only set\nthe configs if they are different than the existing configs. Under\nrare circumstances we still need to fallback on checking staleness\nstatus (as explained in the code comment)."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ccc8a1ecb8dd859a7b5ed8641b4782fb99056820", "author": {"user": {"login": "aarman-cloudera", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/ccc8a1ecb8dd859a7b5ed8641b4782fb99056820", "committedDate": "2020-08-14T20:08:24Z", "message": "CDPCP-2673. Fix role refresh on cloud identity sync\n\nThe previous behavior for syncing azure oids into CM was to only\ntrigger role refresh if CM reported the configs to be stale. This\ndoes not always work as expected because the staleness status that\nCM reports is eventually consistent.\n\nTo fix this, instead of relying on staleness check we only set\nthe configs if they are different than the existing configs. Under\nrare circumstances we still need to fallback on checking staleness\nstatus (as explained in the code comment)."}, "afterCommit": {"oid": "2a6afed21b88cbe54a798b5ed20eb28a09048809", "author": {"user": {"login": "aarman-cloudera", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/2a6afed21b88cbe54a798b5ed20eb28a09048809", "committedDate": "2020-08-16T08:29:53Z", "message": "CDPCP-2673. Fix role refresh on cloud identity sync\n\nThe previous behavior for syncing azure oids into CM was to only\ntrigger role refresh if CM reported the configs to be stale. This\ndoes not always work as expected because the staleness status that\nCM reports is eventually consistent.\n\nTo fix this, instead of relying on staleness check we only set\nthe configs if they are different than the existing configs. Under\nrare circumstances we still need to fallback on checking staleness\nstatus (as explained in the code comment)."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2467, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}