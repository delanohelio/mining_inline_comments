{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcxODE1NjEx", "number": 7231, "title": "CB-5271: get images from cm for stack upgrade", "bodyText": "", "createdAt": "2020-02-06T10:16:11Z", "url": "https://github.com/hortonworks/cloudbreak/pull/7231", "merged": true, "mergeCommit": {"oid": "6cfde82983bbe631b7a5cd82f63f8970deafb42e"}, "closed": true, "closedAt": "2020-02-13T15:48:09Z", "author": {"login": "tiborpopovics"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBqs1-AFqTM1NDQ0MDY1NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcD88UzgFqTM1ODMyNzE5MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0NDQwNjU1", "url": "https://github.com/hortonworks/cloudbreak/pull/7231#pullrequestreview-354440655", "createdAt": "2020-02-06T13:18:08Z", "commit": {"oid": "ff2374836b74e9654472c94e862cf25100261ae9"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxMzoxODowOFrOFmarSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxMzoyNDo0N1rOFma25g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTgyNzI3NQ==", "bodyText": "According to the name of this class, when we eventually will support minor and major upgrades, new comparators will be needed for those, which smells like code duplication. I would advise to extend the already existing Version class with segment-specific comparison reusing parts of the code there.", "url": "https://github.com/hortonworks/cloudbreak/pull/7231#discussion_r375827275", "createdAt": "2020-02-06T13:18:08Z", "author": {"login": "daszabo"}, "path": "core-api/src/main/java/com/sequenceiq/cloudbreak/cloud/MaintenanceVersionComparator.java", "diffHunk": "@@ -0,0 +1,44 @@\n+package com.sequenceiq.cloudbreak.cloud;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+/**\n+ * This comparator supports only the three-part version number format like 1.2.3\n+ */\n+@Component\n+public class MaintenanceVersionComparator {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff2374836b74e9654472c94e862cf25100261ae9"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTgyOTg0Ng==", "bodyText": "Shouldn't this filter images also based on supported cb versions?", "url": "https://github.com/hortonworks/cloudbreak/pull/7231#discussion_r375829846", "createdAt": "2020-02-06T13:23:57Z", "author": {"login": "daszabo"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/service/image/StackUpgradeImageFilter.java", "diffHunk": "@@ -0,0 +1,82 @@\n+package com.sequenceiq.cloudbreak.service.image;\n+\n+import java.util.function.Predicate;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.cloud.MaintenanceVersionComparator;\n+import com.sequenceiq.cloudbreak.cloud.model.Image;\n+import com.sequenceiq.cloudbreak.cloud.model.catalog.Images;\n+\n+@Component\n+public class StackUpgradeImageFilter {\n+\n+    private static final String CM_PACKAGE_KEY = \"cm\";\n+\n+    private static final String STACK_PACKAGE_KEY = \"stack\";\n+\n+    private static final String CFM_PACKAGE_KEY = \"cfm\";\n+\n+    private static final String CSP_PACKAGE_KEY = \"csp\";\n+\n+    private static final String SALT_PACKAGE_KEY = \"salt\";\n+\n+    @Inject\n+    private MaintenanceVersionComparator maintenanceVersionComparator;\n+\n+    Images filter(Images availableImages, Image currentImage, String cloudPlatform) {\n+        return new Images(null, null, null, availableImages.getCdhImages().stream()\n+                .filter(validateCmVersion(currentImage).or(validateStackVersion(currentImage)))\n+                .filter(validateCloudPlatform(cloudPlatform))\n+                .filter(validateOsVersion(currentImage))\n+                .filter(validateCfmVersion(currentImage))\n+                .filter(validateCspVersion(currentImage))\n+                .filter(validateSaltVersion(currentImage))\n+                .filter(filterCurrentImage(currentImage))\n+                .collect(Collectors.toList()), null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff2374836b74e9654472c94e862cf25100261ae9"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTgzMDI0Ng==", "bodyText": "This only filters CDH images. Might as-well only pass that list to the filter method.", "url": "https://github.com/hortonworks/cloudbreak/pull/7231#discussion_r375830246", "createdAt": "2020-02-06T13:24:47Z", "author": {"login": "daszabo"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/service/image/StackUpgradeImagesService.java", "diffHunk": "@@ -0,0 +1,63 @@\n+package com.sequenceiq.cloudbreak.service.image;\n+\n+import javax.inject.Inject;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.cloud.model.Image;\n+import com.sequenceiq.cloudbreak.cloud.model.catalog.Images;\n+import com.sequenceiq.cloudbreak.core.CloudbreakImageCatalogException;\n+import com.sequenceiq.cloudbreak.core.CloudbreakImageNotFoundException;\n+import com.sequenceiq.cloudbreak.domain.stack.Stack;\n+import com.sequenceiq.cloudbreak.service.stack.StackService;\n+\n+@Component\n+public class StackUpgradeImagesService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(StackUpgradeImagesService.class);\n+\n+    @Inject\n+    private StackService stackService;\n+\n+    @Inject\n+    private ImageCatalogProvider imageCatalogProvider;\n+\n+    @Inject\n+    private ImageService imageService;\n+\n+    @Inject\n+    private StackUpgradeImageFilter stackUpgradeImageFilter;\n+\n+    public Images getImagesToUpgrade(Long workspaceId, String stackName) {\n+        Images filteredImages = null;\n+        try {\n+            LOGGER.info(String.format(\"Retrieving images for upgrade stack %s\", stackName));\n+            Stack stack = getStack(workspaceId, stackName);\n+            Image currentImage = getImage(stack);\n+            Images imagesFromCatalog = getImagesFromCatalog(currentImage.getImageCatalogUrl());\n+            filteredImages = filterImages(imagesFromCatalog, currentImage, stack.cloudPlatform());\n+            LOGGER.info(String.format(\"%d possible image found for stack upgrade.\", filteredImages.getCdhImages().size()));\n+        } catch (CloudbreakImageNotFoundException | CloudbreakImageCatalogException e) {\n+            LOGGER.error(\"Failed to get images\", e);\n+        }\n+        return filteredImages;\n+    }\n+\n+    private Stack getStack(Long workspaceId, String stackName) {\n+        return stackService.getByNameInWorkspace(stackName, workspaceId);\n+    }\n+\n+    private Image getImage(Stack stack) throws CloudbreakImageNotFoundException {\n+        return imageService.getImage(stack.getId());\n+    }\n+\n+    private Images getImagesFromCatalog(String imageCatalogUrl) throws CloudbreakImageCatalogException {\n+        return imageCatalogProvider.getImageCatalogV2(imageCatalogUrl).getImages();\n+    }\n+\n+    private Images filterImages(Images images, Image currentImage, String cloudPlatform) {\n+        return stackUpgradeImageFilter.filter(images, currentImage, cloudPlatform);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff2374836b74e9654472c94e862cf25100261ae9"}, "originalPosition": 61}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ff2374836b74e9654472c94e862cf25100261ae9", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/ff2374836b74e9654472c94e862cf25100261ae9", "committedDate": "2020-02-06T10:13:38Z", "message": "CB-5271: get images from cm for stack upgrade"}, "afterCommit": {"oid": "99f710d9abf18d5753aaee00cd863adebb47d5c3", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/99f710d9abf18d5753aaee00cd863adebb47d5c3", "committedDate": "2020-02-11T09:42:35Z", "message": "CB-5271: get images from cm for stack upgrade"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "99f710d9abf18d5753aaee00cd863adebb47d5c3", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/99f710d9abf18d5753aaee00cd863adebb47d5c3", "committedDate": "2020-02-11T09:42:35Z", "message": "CB-5271: get images from cm for stack upgrade"}, "afterCommit": {"oid": "f183c3f99a25f66685fc75c0ccb6540c41a1ccb1", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/f183c3f99a25f66685fc75c0ccb6540c41a1ccb1", "committedDate": "2020-02-11T09:43:20Z", "message": "CB-5271: get images from cm for stack upgrade"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f183c3f99a25f66685fc75c0ccb6540c41a1ccb1", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/f183c3f99a25f66685fc75c0ccb6540c41a1ccb1", "committedDate": "2020-02-11T09:43:20Z", "message": "CB-5271: get images from cm for stack upgrade"}, "afterCommit": {"oid": "6a6796baaf934ba42ad0eab9197fcfb0ea52c4fb", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/6a6796baaf934ba42ad0eab9197fcfb0ea52c4fb", "committedDate": "2020-02-11T10:13:52Z", "message": "CB-5271: get images from cm for stack upgrade"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2NTU1NDY0", "url": "https://github.com/hortonworks/cloudbreak/pull/7231#pullrequestreview-356555464", "createdAt": "2020-02-11T10:41:08Z", "commit": {"oid": "6a6796baaf934ba42ad0eab9197fcfb0ea52c4fb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6a6796baaf934ba42ad0eab9197fcfb0ea52c4fb", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/6a6796baaf934ba42ad0eab9197fcfb0ea52c4fb", "committedDate": "2020-02-11T10:13:52Z", "message": "CB-5271: get images from cm for stack upgrade"}, "afterCommit": {"oid": "22cde33c4ea79224af9244c7dfe11504af991d50", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/22cde33c4ea79224af9244c7dfe11504af991d50", "committedDate": "2020-02-13T10:24:38Z", "message": "CB-5540: get images from cm for stack upgrade"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fa27f263645f10ab3dea620b9c3da6c63afa12a", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/4fa27f263645f10ab3dea620b9c3da6c63afa12a", "committedDate": "2020-02-13T13:51:39Z", "message": "CB-5540: get images from cm for stack upgrade"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "22cde33c4ea79224af9244c7dfe11504af991d50", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/22cde33c4ea79224af9244c7dfe11504af991d50", "committedDate": "2020-02-13T10:24:38Z", "message": "CB-5540: get images from cm for stack upgrade"}, "afterCommit": {"oid": "4fa27f263645f10ab3dea620b9c3da6c63afa12a", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/4fa27f263645f10ab3dea620b9c3da6c63afa12a", "committedDate": "2020-02-13T13:51:39Z", "message": "CB-5540: get images from cm for stack upgrade"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4MzI3MTkx", "url": "https://github.com/hortonworks/cloudbreak/pull/7231#pullrequestreview-358327191", "createdAt": "2020-02-13T15:48:03Z", "commit": {"oid": "4fa27f263645f10ab3dea620b9c3da6c63afa12a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1955, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}