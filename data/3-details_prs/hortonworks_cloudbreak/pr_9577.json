{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMyNjU1Nzk2", "number": 9577, "title": "CB-10157 Store the original tags in our services and transform GCP la\u2026", "bodyText": "\u2026bels only in cloud-gcp module. This is necessary because we stored the label transformed tags previously. This way we can get the original tags in the pillar which are fundamental from telemtry perspective\n@oleewere the pillars will look like this:\ncat /srv/pillar/tags/init.sls #!json { \"tags\": { \"Cloudera-Creator-Resource-Name\": \"crn:cdp:iam:us-west-1:cloudera:user:tbihari\", \"Cloudera-Environment-Resource-Name\": \"crn:cdp:environments:us-west-1:cloudera:environment:7d322e9f-5085-4154-80f1-effafa52ac01\", \"Cloudera-Resource-Name\": \"crn:cdp:datahub:us-west-1:cloudera:cluster:d5cc4415-7a30-4760-aa23-d9981c28c47d\", \"Cloudera-Service-Type\": \"DATAHUB\", \"Owner\": \"tbihari@ums.mock\", \"creation-timestamp\": \"1607345447\", \"owner\": \"tbihari@ums.mock\" } }", "createdAt": "2020-12-04T16:52:58Z", "url": "https://github.com/hortonworks/cloudbreak/pull/9577", "merged": true, "mergeCommit": {"oid": "18e98990b688a285866994d4ff18fc5a7384a5e4"}, "closed": true, "closedAt": "2020-12-07T14:55:19Z", "author": {"login": "biharitomi"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdjwkNtgBqjQwNzgxNTA3NzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdj3nghgFqTU0NjI4MjU3OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f13ac7dfe2fea403153aec17fb3197165c71d9ad", "author": {"user": {"login": "biharitomi", "name": "Tamas Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/f13ac7dfe2fea403153aec17fb3197165c71d9ad", "committedDate": "2020-12-04T16:51:55Z", "message": "CB-10157 Store the original tags in our services and transform GCP labels only in cloud-gcp module. This is necessary because we stored the label transformed tags previously. This way we can get the original tags in the pillar which are fundamental from telemtry perspective"}, "afterCommit": {"oid": "343c4472c0bcc283c27353a4840e1b762a82f009", "author": {"user": {"login": "biharitomi", "name": "Tamas Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/343c4472c0bcc283c27353a4840e1b762a82f009", "committedDate": "2020-12-07T07:39:09Z", "message": "CB-10157 Store the original tags in our services and transform GCP labels only in cloud-gcp module. This is necessary because we stored the label transformed tags previously. This way we can get the original tags in the pillar which are fundamental from telemtry perspective"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1ODkyOTA2", "url": "https://github.com/hortonworks/cloudbreak/pull/9577#pullrequestreview-545892906", "createdAt": "2020-12-07T07:44:04Z", "commit": {"oid": "343c4472c0bcc283c27353a4840e1b762a82f009"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QwNzo0NDowNFrOIAZpwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QwNzo0NDowNFrOIAZpwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzI5MTIwMQ==", "bodyText": "I think it would be beneficial to log the generated value", "url": "https://github.com/hortonworks/cloudbreak/pull/9577#discussion_r537291201", "createdAt": "2020-12-07T07:44:04Z", "author": {"login": "doktoric"}, "path": "cloud-gcp/src/main/java/com/sequenceiq/cloudbreak/cloud/gcp/util/GcpLabelUtil.java", "diffHunk": "@@ -0,0 +1,44 @@\n+package com.sequenceiq.cloudbreak.cloud.gcp.util;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.sequenceiq.cloudbreak.auth.altus.Crn;\n+import com.sequenceiq.cloudbreak.cloud.model.CloudStack;\n+\n+public final class GcpLabelUtil {\n+    private static final Logger LOGGER = LoggerFactory.getLogger(GcpLabelUtil.class);\n+\n+    private static final int GCP_MAX_TAG_LEN = 63;\n+\n+    private GcpLabelUtil() {\n+    }\n+\n+    public static Map<String, String> createLabelsFromTags(CloudStack cloudStack) {\n+        Map<String, String> result = new HashMap<>();\n+        Map<String, String> tags = cloudStack.getTags();\n+        if (tags != null) {\n+            tags.forEach((key, value) -> result.put(transform(key), transform(value)));\n+        }\n+        return result;\n+    }\n+\n+    private static String transform(String value) {\n+        // GCP labels have strict rules https://cloud.google.com/compute/docs/labeling-resources\n+        LOGGER.debug(\"Transforming tag key/value for GCP.\");\n+        if (Crn.isCrn(value)) {\n+            try {\n+                Crn crn = Crn.fromString(value);\n+                value = crn == null ? value : crn.getResource();\n+            } catch (Exception e) {\n+                LOGGER.debug(\"Ignoring CRN ({}) parse error during tag value generation : {}\", value, e.getMessage());\n+            }\n+        }\n+        String sanitized = value.split(\"@\")[0].toLowerCase().replaceAll(\"[^\\\\w]\", \"-\");\n+        return StringUtils.right(sanitized, GCP_MAX_TAG_LEN);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "343c4472c0bcc283c27353a4840e1b762a82f009"}, "originalPosition": 42}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "343c4472c0bcc283c27353a4840e1b762a82f009", "author": {"user": {"login": "biharitomi", "name": "Tamas Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/343c4472c0bcc283c27353a4840e1b762a82f009", "committedDate": "2020-12-07T07:39:09Z", "message": "CB-10157 Store the original tags in our services and transform GCP labels only in cloud-gcp module. This is necessary because we stored the label transformed tags previously. This way we can get the original tags in the pillar which are fundamental from telemtry perspective"}, "afterCommit": {"oid": "8d0823cde23d1c8f44830817ebf39ce557828d41", "author": {"user": {"login": "biharitomi", "name": "Tamas Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/8d0823cde23d1c8f44830817ebf39ce557828d41", "committedDate": "2020-12-07T09:06:34Z", "message": "CB-10157 Store the original tags in our services and transform GCP labels only in cloud-gcp module. This is necessary because we stored the label transformed tags previously. This way we can get the original tags in the pillar which are fundamental from telemtry perspective"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8d0823cde23d1c8f44830817ebf39ce557828d41", "author": {"user": {"login": "biharitomi", "name": "Tamas Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/8d0823cde23d1c8f44830817ebf39ce557828d41", "committedDate": "2020-12-07T09:06:34Z", "message": "CB-10157 Store the original tags in our services and transform GCP labels only in cloud-gcp module. This is necessary because we stored the label transformed tags previously. This way we can get the original tags in the pillar which are fundamental from telemtry perspective"}, "afterCommit": {"oid": "f794749c2f9863b6fd84192b94da6919647bfe12", "author": {"user": {"login": "biharitomi", "name": "Tamas Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/f794749c2f9863b6fd84192b94da6919647bfe12", "committedDate": "2020-12-07T09:20:20Z", "message": "CB-10157 Store the original tags in our services and transform GCP labels only in cloud-gcp module. This is necessary because we stored the label transformed tags previously. This way we can get the original tags in the pillar which are fundamental from telemtry perspective"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6643723adf45bb0762c39fe3c32b9126946d185", "author": {"user": {"login": "biharitomi", "name": "Tamas Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/d6643723adf45bb0762c39fe3c32b9126946d185", "committedDate": "2020-12-07T13:21:36Z", "message": "CB-10157 Store the original tags in our services and transform GCP labels only in cloud-gcp module. This is necessary because we stored the label transformed tags previously. This way we can get the original tags in the pillar which are fundamental from telemtry perspective"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f794749c2f9863b6fd84192b94da6919647bfe12", "author": {"user": {"login": "biharitomi", "name": "Tamas Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/f794749c2f9863b6fd84192b94da6919647bfe12", "committedDate": "2020-12-07T09:20:20Z", "message": "CB-10157 Store the original tags in our services and transform GCP labels only in cloud-gcp module. This is necessary because we stored the label transformed tags previously. This way we can get the original tags in the pillar which are fundamental from telemtry perspective"}, "afterCommit": {"oid": "d6643723adf45bb0762c39fe3c32b9126946d185", "author": {"user": {"login": "biharitomi", "name": "Tamas Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/d6643723adf45bb0762c39fe3c32b9126946d185", "committedDate": "2020-12-07T13:21:36Z", "message": "CB-10157 Store the original tags in our services and transform GCP labels only in cloud-gcp module. This is necessary because we stored the label transformed tags previously. This way we can get the original tags in the pillar which are fundamental from telemtry perspective"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2MTc4Mzkw", "url": "https://github.com/hortonworks/cloudbreak/pull/9577#pullrequestreview-546178390", "createdAt": "2020-12-07T14:06:34Z", "commit": {"oid": "d6643723adf45bb0762c39fe3c32b9126946d185"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2MjgyNTc5", "url": "https://github.com/hortonworks/cloudbreak/pull/9577#pullrequestreview-546282579", "createdAt": "2020-12-07T15:52:31Z", "commit": {"oid": "d6643723adf45bb0762c39fe3c32b9126946d185"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1931, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}