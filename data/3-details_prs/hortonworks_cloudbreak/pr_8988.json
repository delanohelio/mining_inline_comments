{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg0MTk1MjUx", "number": 8988, "title": "CDPCP-2998. Support deleted user as part of user sync", "bodyText": "This updates the existing synchronizeAllUsers request to\nallow specifying a single workload user to be deleted\nfrom the freeipa. Currently this won't remove CM ranger\ncloud identities (azure object ids). That will come in\na following commit.", "createdAt": "2020-09-10T18:34:35Z", "url": "https://github.com/hortonworks/cloudbreak/pull/8988", "merged": true, "mergeCommit": {"oid": "f2cc02e39fbeffe906a7539661058e9c36776953"}, "closed": true, "closedAt": "2020-09-18T08:38:34Z", "author": {"login": "aarman-cloudera"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdHlsFugBqjM3NTI3MDM0Nzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdKBdFWgFqTQ5MTI2MzA5NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b553ec3658acbfe1316d4e435605dc5263d0fdfa", "author": {"user": {"login": "aarman-cloudera", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/b553ec3658acbfe1316d4e435605dc5263d0fdfa", "committedDate": "2020-09-10T18:27:56Z", "message": "CDPCP-2998. Support deleted user as part of user sync\n\nThis updates the existing synchronizeAllUsers request to\nallow specifying a single workload user to be deleted\nfrom the freeipa. Currently this won't remove CM ranger\ncloud identities (azure object ids). That will come in\na following commit."}, "afterCommit": {"oid": "df6fe7b6723ac58edb359f5c948af3f6e861e666", "author": {"user": {"login": "aarman-cloudera", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/df6fe7b6723ac58edb359f5c948af3f6e861e666", "committedDate": "2020-09-10T19:08:49Z", "message": "CDPCP-2998. Support deleted user as part of user sync\n\nThis updates the existing synchronizeAllUsers request to\nallow specifying a single workload user to be deleted\nfrom the freeipa. Currently this won't remove CM ranger\ncloud identities (azure object ids). That will come in\na following commit."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2Mjc2OTU1", "url": "https://github.com/hortonworks/cloudbreak/pull/8988#pullrequestreview-486276955", "createdAt": "2020-09-10T20:14:55Z", "commit": {"oid": "df6fe7b6723ac58edb359f5c948af3f6e861e666"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMDoxNDo1NVrOHQEJkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMDozNzozN1rOHQE3jA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYwNzI0OQ==", "bodyText": "I think we want to be clear that this is a workload username, not a user crn, username, etc.\nWe should also indicate that this workload username corresponds to the single user or machine user crn in the filters.", "url": "https://github.com/hortonworks/cloudbreak/pull/8988#discussion_r486607249", "createdAt": "2020-09-10T20:14:55Z", "author": {"login": "handavid"}, "path": "freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/user/doc/UserModelDescriptions.java", "diffHunk": "@@ -6,6 +6,7 @@\n     public static final String USERSYNC_ENVIRONMENT_CRNS = \"Optional environment crns to sync\";\n     public static final String USERSYNC_USER_CRNS = \"Optional user crns to sync\";\n     public static final String USERSYNC_MACHINEUSER_CRNS = \"Optional machine user crns to sync\";\n+    public static final String DELETED_WORKLOAD_USER = \"An Optional workload user to be deleted\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df6fe7b6723ac58edb359f5c948af3f6e861e666"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYxMzQ3MQ==", "bodyText": "validateParameters should be updated for your userSyncRequestFilter including the users+machineUsers size when a deletedWorkloadUsername is included", "url": "https://github.com/hortonworks/cloudbreak/pull/8988#discussion_r486613471", "createdAt": "2020-09-10T20:26:50Z", "author": {"login": "handavid"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java", "diffHunk": "@@ -184,11 +187,9 @@ private void logAffectedStacks(List<Stack> stacks) {\n         LOGGER.info(\"Affected stacks: {}\", stacksAffected);\n     }\n \n-    private List<Stack> getStacksForSync(String accountId, String actorCrn, Set<String> environmentCrnFilter,\n-            Set<String> userCrnFilter, Set<String> machineUserCrnFilter) {\n-        validateParameters(accountId, actorCrn, environmentCrnFilter, userCrnFilter, machineUserCrnFilter);\n-        LOGGER.debug(\"Synchronizing users in account {} for environmentCrns {}, userCrns {}, and machineUserCrns {}\",\n-                accountId, environmentCrnFilter, userCrnFilter, machineUserCrnFilter);\n+    private List<Stack> getStacksForSync(String accountId, String actorCrn, Set<String> environmentCrnFilter, UserSyncRequestFilter useSyncFilter) {\n+        validateParameters(accountId, actorCrn, environmentCrnFilter, useSyncFilter.getUserCrnFilter(), useSyncFilter.getMachineUserCrnFilter());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df6fe7b6723ac58edb359f5c948af3f6e861e666"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYxMzY1MQ==", "bodyText": "useSyncFilter --> userSyncRequestFilter", "url": "https://github.com/hortonworks/cloudbreak/pull/8988#discussion_r486613651", "createdAt": "2020-09-10T20:27:10Z", "author": {"login": "handavid"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java", "diffHunk": "@@ -184,11 +187,9 @@ private void logAffectedStacks(List<Stack> stacks) {\n         LOGGER.info(\"Affected stacks: {}\", stacksAffected);\n     }\n \n-    private List<Stack> getStacksForSync(String accountId, String actorCrn, Set<String> environmentCrnFilter,\n-            Set<String> userCrnFilter, Set<String> machineUserCrnFilter) {\n-        validateParameters(accountId, actorCrn, environmentCrnFilter, userCrnFilter, machineUserCrnFilter);\n-        LOGGER.debug(\"Synchronizing users in account {} for environmentCrns {}, userCrns {}, and machineUserCrns {}\",\n-                accountId, environmentCrnFilter, userCrnFilter, machineUserCrnFilter);\n+    private List<Stack> getStacksForSync(String accountId, String actorCrn, Set<String> environmentCrnFilter, UserSyncRequestFilter useSyncFilter) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df6fe7b6723ac58edb359f5c948af3f6e861e666"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYxNjA3NA==", "bodyText": "I don't see a matching Finished log for USER_SYNC_DELETE. I think you need to move this logging into internalSynchronizeStackForDeleteUser", "url": "https://github.com/hortonworks/cloudbreak/pull/8988#discussion_r486616074", "createdAt": "2020-09-10T20:31:53Z", "author": {"login": "handavid"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java", "diffHunk": "@@ -243,20 +242,30 @@ private void internalSynchronizeUsers(String operationId, String accountId, Stri\n \n             LogEvent logUserSyncEvent = fullSync ? LogEvent.FULL_USER_SYNC : LogEvent.PARTIAL_USER_SYNC;\n             LOGGER.info(\"Starting {} for environments {} with operationId {} ...\", logUserSyncEvent, environmentCrns, operationId);\n-            LogEvent logRetrieveUmsEvent = fullSync ? LogEvent.RETRIEVE_FULL_UMS_STATE : LogEvent.RETRIEVE_PARTIAL_UMS_STATE;\n-            LOGGER.debug(\"Starting {} for environments {} ...\", logRetrieveUmsEvent, environmentCrns);\n-            Map<String, UmsUsersState> envToUmsStateMap = umsUsersStateProvider\n-                    .getEnvToUmsUsersStateMap(accountId, actorCrn, environmentCrns, userCrnFilter, machineUserCrnFilter, requestId);\n-            LOGGER.debug(\"Finished {}.\", logRetrieveUmsEvent);\n+\n+            Map<String, Future<SyncStatusDetail>> statusFutures;\n+\n+            if (userSyncFilter.getDeletedWorkloadUser().isEmpty()) {\n+                LogEvent logRetrieveUmsEvent = fullSync ? LogEvent.RETRIEVE_FULL_UMS_STATE : LogEvent.RETRIEVE_PARTIAL_UMS_STATE;\n+                LOGGER.debug(\"Starting {} for environments {} ...\", logRetrieveUmsEvent, environmentCrns);\n+                Map<String, UmsUsersState> envToUmsStateMap = umsUsersStateProvider\n+                        .getEnvToUmsUsersStateMap(accountId, actorCrn, environmentCrns, userSyncFilter.getUserCrnFilter(),\n+                                userSyncFilter.getMachineUserCrnFilter(), requestId);\n+                LOGGER.debug(\"Finished {}.\", logRetrieveUmsEvent);\n+                statusFutures = stacks.stream()\n+                        .collect(Collectors.toMap(Stack::getEnvironmentCrn,\n+                                stack -> asyncSynchronizeStack(stack, envToUmsStateMap.get(stack.getEnvironmentCrn()), umsEventGenerationIds, fullSync,\n+                                        operationId, accountId)));\n+            } else {\n+                String deletedWorkloadUser = userSyncFilter.getDeletedWorkloadUser().get();\n+                LOGGER.debug(\"Starting {} for environments {} and deleted user {} ...\", LogEvent.USER_SYNC_DELETE, environmentCrns, deletedWorkloadUser);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df6fe7b6723ac58edb359f5c948af3f6e861e666"}, "originalPosition": 136}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYxOTAyMA==", "bodyText": "I think we need a test that checks the parameter validation and ensures that we reject requests with a deleted workload username that contain 0 or >1 crns.", "url": "https://github.com/hortonworks/cloudbreak/pull/8988#discussion_r486619020", "createdAt": "2020-09-10T20:37:37Z", "author": {"login": "handavid"}, "path": "freeipa/src/test/java/com/sequenceiq/freeipa/controller/UserV1ControllerTest.java", "diffHunk": "@@ -115,14 +120,36 @@ void synchronizeAllUsers() {\n         request.setMachineUsers(machineUsers);\n \n         Operation operation = mock(Operation.class);\n-        when(userSyncService.synchronizeUsersWithCustomPermissionCheck(any(), any(), any(), any(), any(), any())).thenReturn(operation);\n+        when(userSyncService.synchronizeUsersWithCustomPermissionCheck(any(), any(), any(), any(), any())).thenReturn(operation);\n         SyncOperationStatus status = mock(SyncOperationStatus.class);\n         when(operationToSyncOperationStatus.convert(operation)).thenReturn(status);\n \n         assertEquals(status, ThreadBasedUserCrnProvider.doAs(USER_CRN, () -> underTest.synchronizeAllUsers(request)));\n \n+        UserSyncRequestFilter userSyncFilter = new UserSyncRequestFilter(users, machineUsers, Optional.empty());\n         verify(userSyncService, times(1)).synchronizeUsersWithCustomPermissionCheck(ACCOUNT_ID, USER_CRN, environments,\n-                users, machineUsers, AuthorizationResourceAction.DESCRIBE_ENVIRONMENT);\n+                userSyncFilter, AuthorizationResourceAction.DESCRIBE_ENVIRONMENT);\n+    }\n+\n+    @Test\n+    void synchronizeAllUsersDeleteWorkloadUser() {\n+        Set<String> users = Set.of(USER_CRN);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df6fe7b6723ac58edb359f5c948af3f6e861e666"}, "originalPosition": 77}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "df6fe7b6723ac58edb359f5c948af3f6e861e666", "author": {"user": {"login": "aarman-cloudera", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/df6fe7b6723ac58edb359f5c948af3f6e861e666", "committedDate": "2020-09-10T19:08:49Z", "message": "CDPCP-2998. Support deleted user as part of user sync\n\nThis updates the existing synchronizeAllUsers request to\nallow specifying a single workload user to be deleted\nfrom the freeipa. Currently this won't remove CM ranger\ncloud identities (azure object ids). That will come in\na following commit."}, "afterCommit": {"oid": "6f61dd42fb0b819c9744528540c998fdc3b06565", "author": {"user": {"login": "aarman-cloudera", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/6f61dd42fb0b819c9744528540c998fdc3b06565", "committedDate": "2020-09-11T04:32:27Z", "message": "CDPCP-2998. Support deleted user as part of user sync\n\nThis updates the existing synchronizeAllUsers request to\nallow specifying a single workload user to be deleted\nfrom the freeipa. Currently this won't remove CM ranger\ncloud identities (azure object ids). That will come in\na following commit."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2ODgxMTk4", "url": "https://github.com/hortonworks/cloudbreak/pull/8988#pullrequestreview-486881198", "createdAt": "2020-09-11T14:55:20Z", "commit": {"oid": "6f61dd42fb0b819c9744528540c998fdc3b06565"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxNDo1NToyMFrOHQiTyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxNDo1NToyMFrOHQiTyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzEwMTM4Nw==", "bodyText": "typo: corresponds", "url": "https://github.com/hortonworks/cloudbreak/pull/8988#discussion_r487101387", "createdAt": "2020-09-11T14:55:20Z", "author": {"login": "handavid"}, "path": "freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/user/doc/UserModelDescriptions.java", "diffHunk": "@@ -6,6 +6,8 @@\n     public static final String USERSYNC_ENVIRONMENT_CRNS = \"Optional environment crns to sync\";\n     public static final String USERSYNC_USER_CRNS = \"Optional user crns to sync\";\n     public static final String USERSYNC_MACHINEUSER_CRNS = \"Optional machine user crns to sync\";\n+    public static final String DELETED_WORKLOAD_USER = \"An Optional workload user name to be deleted. When this is included, there should also be\" +\n+            \" exactly 1 crn in the machineUsers or users set that coreesponds to the deleted workload user.\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f61dd42fb0b819c9744528540c998fdc3b06565"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6f61dd42fb0b819c9744528540c998fdc3b06565", "author": {"user": {"login": "aarman-cloudera", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/6f61dd42fb0b819c9744528540c998fdc3b06565", "committedDate": "2020-09-11T04:32:27Z", "message": "CDPCP-2998. Support deleted user as part of user sync\n\nThis updates the existing synchronizeAllUsers request to\nallow specifying a single workload user to be deleted\nfrom the freeipa. Currently this won't remove CM ranger\ncloud identities (azure object ids). That will come in\na following commit."}, "afterCommit": {"oid": "d6c4ab5b6740560561d808affd21dc42fae99e94", "author": {"user": {"login": "aarman-cloudera", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/d6c4ab5b6740560561d808affd21dc42fae99e94", "committedDate": "2020-09-11T15:15:15Z", "message": "CDPCP-2998. Support deleted user as part of user sync\n\nThis updates the existing synchronizeAllUsers request to\nallow specifying a single workload user to be deleted\nfrom the freeipa. Currently this won't remove CM ranger\ncloud identities (azure object ids). That will come in\na following commit."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3NjYzNzc3", "url": "https://github.com/hortonworks/cloudbreak/pull/8988#pullrequestreview-487663777", "createdAt": "2020-09-14T11:32:54Z", "commit": {"oid": "d6c4ab5b6740560561d808affd21dc42fae99e94"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxMTozMjo1NFrOHRPkjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxMTozMjo1NFrOHRPkjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg0Mjk1OQ==", "bodyText": "is there any reason this can't be a set? it looks more flexible and I don't see why can't we delete 2 user at once", "url": "https://github.com/hortonworks/cloudbreak/pull/8988#discussion_r487842959", "createdAt": "2020-09-14T11:32:54Z", "author": {"login": "lacikaaa"}, "path": "freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/user/model/SynchronizeAllUsersRequest.java", "diffHunk": "@@ -18,6 +18,9 @@\n     @ApiModelProperty(value = UserModelDescriptions.USERSYNC_USER_CRNS)\n     private Set<String> users = new HashSet<>();\n \n+    @ApiModelProperty(value = UserModelDescriptions.DELETED_WORKLOAD_USER)\n+    private String deletedWorkloadUser;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6c4ab5b6740560561d808affd21dc42fae99e94"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3Njg4OTg2", "url": "https://github.com/hortonworks/cloudbreak/pull/8988#pullrequestreview-487688986", "createdAt": "2020-09-14T12:11:17Z", "commit": {"oid": "d6c4ab5b6740560561d808affd21dc42fae99e94"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxMjoxMToxOFrOHRQxTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxMjoxMToxOFrOHRQxTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg2MjYwNg==", "bodyText": "I would prefer if you pass UserSyncRequestFilter instead of adding a new parameter.\nalso moving the whole validation to a separate class would be nice (@VisibleForTesting annotation already a sign this method should be in another class)", "url": "https://github.com/hortonworks/cloudbreak/pull/8988#discussion_r487862606", "createdAt": "2020-09-14T12:11:18Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java", "diffHunk": "@@ -529,16 +583,24 @@ private void checkIfClientStillUsable(FreeIpaClientException e) throws FreeIpaCl\n \n     @VisibleForTesting\n     void validateParameters(String accountId, String actorCrn, Set<String> environmentCrnFilter,\n-            Set<String> userCrnFilter, Set<String> machineUserCrnFilter) {\n+            Set<String> userCrnFilter, Set<String> machineUserCrnFilter, Optional<String> deletedWorkoadUser) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6c4ab5b6740560561d808affd21dc42fae99e94"}, "originalPosition": 223}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3NzAxMzYx", "url": "https://github.com/hortonworks/cloudbreak/pull/8988#pullrequestreview-487701361", "createdAt": "2020-09-14T12:28:28Z", "commit": {"oid": "d6c4ab5b6740560561d808affd21dc42fae99e94"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxMjoyODoyOFrOHRRXYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxMjoyODoyOFrOHRRXYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg3MjM1NA==", "bodyText": "could you move this to a separate class and refactor into multiple shorter methods", "url": "https://github.com/hortonworks/cloudbreak/pull/8988#discussion_r487872354", "createdAt": "2020-09-14T12:28:28Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java", "diffHunk": "@@ -355,13 +368,54 @@ private SyncStatusDetail internalSynchronizeStack(Stack stack, UmsUsersState ums\n         }\n     }\n \n+    private SyncStatusDetail internalSynchronizeStackForDeleteUser(Stack stack, String deletedWorkloadUser) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6c4ab5b6740560561d808affd21dc42fae99e94"}, "originalPosition": 167}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3NzAyMzY3", "url": "https://github.com/hortonworks/cloudbreak/pull/8988#pullrequestreview-487702367", "createdAt": "2020-09-14T12:29:41Z", "commit": {"oid": "d6c4ab5b6740560561d808affd21dc42fae99e94"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxMjoyOTo0MlrOHRRaVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxMjoyOTo0MlrOHRRaVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg3MzExMQ==", "bodyText": "I think it should fit into one log line", "url": "https://github.com/hortonworks/cloudbreak/pull/8988#discussion_r487873111", "createdAt": "2020-09-14T12:29:42Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java", "diffHunk": "@@ -355,13 +368,54 @@ private SyncStatusDetail internalSynchronizeStack(Stack stack, UmsUsersState ums\n         }\n     }\n \n+    private SyncStatusDetail internalSynchronizeStackForDeleteUser(Stack stack, String deletedWorkloadUser) {\n+        MDCBuilder.buildMdcContext(stack);\n+        String environmentCrn = stack.getEnvironmentCrn();\n+        Multimap<String, String> warnings = ArrayListMultimap.create();\n+        try {\n+            FreeIpaClient freeIpaClient = freeIpaClientFactory.getFreeIpaClientForStack(stack);\n+\n+            LOGGER.debug(\"Starting {} for environment {} and deleted user {} ...\", LogEvent.USER_SYNC_DELETE, environmentCrn, deletedWorkloadUser);\n+\n+            LogEvent logEvent = LogEvent.RETRIEVE_PARTIAL_IPA_STATE;\n+            LOGGER.debug(\"Starting {} ...\", LogEvent.RETRIEVE_PARTIAL_IPA_STATE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6c4ab5b6740560561d808affd21dc42fae99e94"}, "originalPosition": 177}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3NzA2Njcy", "url": "https://github.com/hortonworks/cloudbreak/pull/8988#pullrequestreview-487706672", "createdAt": "2020-09-14T12:35:08Z", "commit": {"oid": "d6c4ab5b6740560561d808affd21dc42fae99e94"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxMjozNTowOFrOHRRnZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxMjozNTowOFrOHRRnZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg3NjQ1Mw==", "bodyText": "I think you should either delete logEvent variable or use it in the next line also", "url": "https://github.com/hortonworks/cloudbreak/pull/8988#discussion_r487876453", "createdAt": "2020-09-14T12:35:08Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java", "diffHunk": "@@ -355,13 +368,54 @@ private SyncStatusDetail internalSynchronizeStack(Stack stack, UmsUsersState ums\n         }\n     }\n \n+    private SyncStatusDetail internalSynchronizeStackForDeleteUser(Stack stack, String deletedWorkloadUser) {\n+        MDCBuilder.buildMdcContext(stack);\n+        String environmentCrn = stack.getEnvironmentCrn();\n+        Multimap<String, String> warnings = ArrayListMultimap.create();\n+        try {\n+            FreeIpaClient freeIpaClient = freeIpaClientFactory.getFreeIpaClientForStack(stack);\n+\n+            LOGGER.debug(\"Starting {} for environment {} and deleted user {} ...\", LogEvent.USER_SYNC_DELETE, environmentCrn, deletedWorkloadUser);\n+\n+            LogEvent logEvent = LogEvent.RETRIEVE_PARTIAL_IPA_STATE;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6c4ab5b6740560561d808affd21dc42fae99e94"}, "originalPosition": 176}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d6c4ab5b6740560561d808affd21dc42fae99e94", "author": {"user": {"login": "aarman-cloudera", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/d6c4ab5b6740560561d808affd21dc42fae99e94", "committedDate": "2020-09-11T15:15:15Z", "message": "CDPCP-2998. Support deleted user as part of user sync\n\nThis updates the existing synchronizeAllUsers request to\nallow specifying a single workload user to be deleted\nfrom the freeipa. Currently this won't remove CM ranger\ncloud identities (azure object ids). That will come in\na following commit."}, "afterCommit": {"oid": "bad2b4f67bc9998044ca3c88a8c293cf61b3714e", "author": {"user": {"login": "aarman-cloudera", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/bad2b4f67bc9998044ca3c88a8c293cf61b3714e", "committedDate": "2020-09-14T20:18:19Z", "message": "CDPCP-2998. Support deleted user as part of user sync\n\nThis updates the existing synchronizeAllUsers request to\nallow specifying a single workload user to be deleted\nfrom the freeipa. Currently this won't remove CM ranger\ncloud identities (azure object ids). That will come in\na following commit."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4NDQyODc2", "url": "https://github.com/hortonworks/cloudbreak/pull/8988#pullrequestreview-488442876", "createdAt": "2020-09-15T08:23:58Z", "commit": {"oid": "bad2b4f67bc9998044ca3c88a8c293cf61b3714e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4NDQzNTI5", "url": "https://github.com/hortonworks/cloudbreak/pull/8988#pullrequestreview-488443529", "createdAt": "2020-09-15T08:24:49Z", "commit": {"oid": "bad2b4f67bc9998044ca3c88a8c293cf61b3714e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bad2b4f67bc9998044ca3c88a8c293cf61b3714e", "author": {"user": {"login": "aarman-cloudera", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/bad2b4f67bc9998044ca3c88a8c293cf61b3714e", "committedDate": "2020-09-14T20:18:19Z", "message": "CDPCP-2998. Support deleted user as part of user sync\n\nThis updates the existing synchronizeAllUsers request to\nallow specifying a single workload user to be deleted\nfrom the freeipa. Currently this won't remove CM ranger\ncloud identities (azure object ids). That will come in\na following commit."}, "afterCommit": {"oid": "58507dbcb73caa1d6bda42383a66588acdd4fe10", "author": {"user": {"login": "aarman-cloudera", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/58507dbcb73caa1d6bda42383a66588acdd4fe10", "committedDate": "2020-09-17T20:27:22Z", "message": "CDPCP-2998. Support deleted user as part of user sync\n\nThis updates the existing synchronizeAllUsers request to\nallow specifying a single workload user to be deleted\nfrom the freeipa. Currently this won't remove CM ranger\ncloud identities (azure object ids). That will come in\na following commit."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e601ef2f55e0bb5e54d42de8115cde6eaa6dadbb", "author": {"user": {"login": "aarman-cloudera", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/e601ef2f55e0bb5e54d42de8115cde6eaa6dadbb", "committedDate": "2020-09-18T07:39:32Z", "message": "CDPCP-2998. Support deleted user as part of user sync\n\nThis updates the existing synchronizeAllUsers request to\nallow specifying a single workload user to be deleted\nfrom the freeipa. Currently this won't remove CM ranger\ncloud identities (azure object ids). That will come in\na following commit."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "58507dbcb73caa1d6bda42383a66588acdd4fe10", "author": {"user": {"login": "aarman-cloudera", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/58507dbcb73caa1d6bda42383a66588acdd4fe10", "committedDate": "2020-09-17T20:27:22Z", "message": "CDPCP-2998. Support deleted user as part of user sync\n\nThis updates the existing synchronizeAllUsers request to\nallow specifying a single workload user to be deleted\nfrom the freeipa. Currently this won't remove CM ranger\ncloud identities (azure object ids). That will come in\na following commit."}, "afterCommit": {"oid": "e601ef2f55e0bb5e54d42de8115cde6eaa6dadbb", "author": {"user": {"login": "aarman-cloudera", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/e601ef2f55e0bb5e54d42de8115cde6eaa6dadbb", "committedDate": "2020-09-18T07:39:32Z", "message": "CDPCP-2998. Support deleted user as part of user sync\n\nThis updates the existing synchronizeAllUsers request to\nallow specifying a single workload user to be deleted\nfrom the freeipa. Currently this won't remove CM ranger\ncloud identities (azure object ids). That will come in\na following commit."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxMjYzMDk1", "url": "https://github.com/hortonworks/cloudbreak/pull/8988#pullrequestreview-491263095", "createdAt": "2020-09-18T08:38:10Z", "commit": {"oid": "e601ef2f55e0bb5e54d42de8115cde6eaa6dadbb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2308, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}