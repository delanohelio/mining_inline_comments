{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU1MDcwNzc0", "number": 8618, "title": "CB-8088 Periscope Downscaling should use YARN downscale recommendation", "bodyText": "Periscope Downscaling Candidates selection is integrated with Yarn Response.\nYarn Scaling Response refactored to be reused between Schedule-Based and Load-Based Autoscaling.", "createdAt": "2020-07-22T11:55:04Z", "url": "https://github.com/hortonworks/cloudbreak/pull/8618", "merged": true, "mergeCommit": {"oid": "1df6c744bf8840954f7ceb555b48c9341b3eee99"}, "closed": true, "closedAt": "2020-07-24T00:10:02Z", "author": {"login": "smaniraju"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3nzFqgFqTQ1MzgyODAwNg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc34liUAFqTQ1NDU3MjY4NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzODI4MDA2", "url": "https://github.com/hortonworks/cloudbreak/pull/8618#pullrequestreview-453828006", "createdAt": "2020-07-23T04:23:27Z", "commit": {"oid": "7ace5107cdbcce8a68711189fde7a107f32cce7b"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QwNDoyMzoyN1rOG17zHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QwNDozMToxMFrOG175Gg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTIwNzQ1NQ==", "bodyText": "All of the history changes here are part of another patch right? Can you please backport that independently of this change?", "url": "https://github.com/hortonworks/cloudbreak/pull/8618#discussion_r459207455", "createdAt": "2020-07-23T04:23:27Z", "author": {"login": "sidseth"}, "path": "autoscale/src/main/java/com/sequenceiq/periscope/monitor/evaluator/CronTimeEvaluator.java", "diffHunk": "@@ -80,15 +108,21 @@ public void execute() {\n         long start = System.currentTimeMillis();\n         Cluster cluster = clusterService.findById(clusterId);\n         MDCBuilder.buildMdcContext(cluster);\n-        publishIfNeeded(alertRepository.findAllByCluster(clusterId));\n+        publishIfNeeded(alertRepository.findAllByClusterIdOrderById(clusterId));\n         LOGGER.debug(\"Finished cronTimeEvaluator for cluster {} in {} ms\", cluster.getStackCrn(), System.currentTimeMillis() - start);\n     }\n \n-    private void publishIfNeeded(List<TimeAlert> alerts) {\n+    protected void publishIfNeeded(List<TimeAlert> alerts) {\n+        TimeAlert triggeredAlert = null;\n         for (TimeAlert alert : alerts) {\n-            if (isPolicyAttached(alert) && isTrigger(alert)) {\n+            boolean alertTriggerable = isTrigger(alert);\n+            if (isPolicyAttached(alert) && alertTriggerable && null == triggeredAlert) {\n                 publish(alert);\n-                break;\n+                triggeredAlert = alert;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ace5107cdbcce8a68711189fde7a107f32cce7b"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTIwODk4Ng==", "bodyText": "Is this needed if YARN is already processing this?", "url": "https://github.com/hortonworks/cloudbreak/pull/8618#discussion_r459208986", "createdAt": "2020-07-23T04:31:10Z", "author": {"login": "sidseth"}, "path": "autoscale/src/main/java/com/sequenceiq/periscope/monitor/evaluator/load/YarnResponseUtils.java", "diffHunk": "@@ -0,0 +1,72 @@\n+package com.sequenceiq.periscope.monitor.evaluator.load;\n+\n+import static com.sequenceiq.periscope.monitor.evaluator.ScalingConstants.DEFAULT_MAX_SCALE_UP_STEP_SIZE;\n+\n+import java.util.Comparator;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.IntStream;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.periscope.model.yarn.YarnScalingServiceV1Response;\n+\n+@Component\n+public class YarnResponseUtils {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(YarnResponseUtils.class);\n+\n+    public List<String> getYarnRecommendedDecommissionHostsForHostGroup(String clusterCrn, YarnScalingServiceV1Response yarnResponse,\n+            Map<String, String> hostFqdnsToInstanceId, int maxAllowedDownScale, Optional<Integer> mandatoryDownScaleCount) {\n+        Set<String> consideredNodeIds = new HashSet<>();\n+        Integer allowedDownscale = Math.max(maxAllowedDownScale, mandatoryDownScaleCount.orElse(0));\n+        List<String> decommissionNodes = yarnResponse.getScaleDownCandidates().orElse(List.of()).stream()\n+                .sorted(Comparator.comparingInt(YarnScalingServiceV1Response.DecommissionCandidate::getAmCount))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ace5107cdbcce8a68711189fde7a107f32cce7b"}, "originalPosition": 30}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7ace5107cdbcce8a68711189fde7a107f32cce7b", "author": {"user": {"login": "smaniraju", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/7ace5107cdbcce8a68711189fde7a107f32cce7b", "committedDate": "2020-07-22T11:49:07Z", "message": "DISTX-474 Schedule-Based downscaling integrated with YarnResponse\n\nSchedule-Based Downscaling integrated with Yarn Response.\nYarn Scaling Response refactored to be reused between Schedule-Based and Load-Based Autoscaling."}, "afterCommit": {"oid": "2227619d9d0f047085f76afad0d07484d5b38835", "author": {"user": {"login": "smaniraju", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/2227619d9d0f047085f76afad0d07484d5b38835", "committedDate": "2020-07-23T06:23:15Z", "message": "DISTX-474 Schedule-Based downscaling integrated with YarnResponse\n\nSchedule-Based Downscaling integrated with Yarn Response.\nYarn Scaling Response refactored to be reused between Schedule-Based and Load-Based Autoscaling."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41e347a84ed633aa7cf927d391862a6276a03ddf", "author": {"user": {"login": "smaniraju", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/41e347a84ed633aa7cf927d391862a6276a03ddf", "committedDate": "2020-07-23T07:30:55Z", "message": "DISTX-474 Schedule-Based downscaling integrated with YarnResponse\n\nSchedule-Based Downscaling integrated with Yarn Response.\nYarn Scaling Response refactored to be reused between Schedule-Based and Load-Based Autoscaling."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2227619d9d0f047085f76afad0d07484d5b38835", "author": {"user": {"login": "smaniraju", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/2227619d9d0f047085f76afad0d07484d5b38835", "committedDate": "2020-07-23T06:23:15Z", "message": "DISTX-474 Schedule-Based downscaling integrated with YarnResponse\n\nSchedule-Based Downscaling integrated with Yarn Response.\nYarn Scaling Response refactored to be reused between Schedule-Based and Load-Based Autoscaling."}, "afterCommit": {"oid": "41e347a84ed633aa7cf927d391862a6276a03ddf", "author": {"user": {"login": "smaniraju", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/41e347a84ed633aa7cf927d391862a6276a03ddf", "committedDate": "2020-07-23T07:30:55Z", "message": "DISTX-474 Schedule-Based downscaling integrated with YarnResponse\n\nSchedule-Based Downscaling integrated with Yarn Response.\nYarn Scaling Response refactored to be reused between Schedule-Based and Load-Based Autoscaling."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0NTcyNjg1", "url": "https://github.com/hortonworks/cloudbreak/pull/8618#pullrequestreview-454572685", "createdAt": "2020-07-24T00:07:36Z", "commit": {"oid": "41e347a84ed633aa7cf927d391862a6276a03ddf"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2619, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}