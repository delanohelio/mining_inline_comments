{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI2NDYwOTg2", "number": 9504, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNjowNjowMVrOE8zo8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxNTowODo0OVrOFC-WNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyMTk2MDgyOnYy", "diffSide": "RIGHT", "path": "authorization-common/src/main/java/com/sequenceiq/authorization/service/ResourceAuthorizationService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNjowNjowMVrOH5Jq1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNjoxOTozMlrOH5KkIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTY4OTMwMg==", "bodyText": "cc: @lnardai , @sodre90\nThis structure can be quite inefficient when we have a bunch of resources and the user doesn't have right on most of them (delete 100 datahubs and the user doesn't have rights on them maps to 101 different database queries, 1 for the env and 100 for the datahubs). Basically the underlying behaviour is like you do this:\nfor (String crn : crns) {\n  String name = db.query(\"SELECT name FROM xy WHERE crn = :crn\")\n}\n\ninstead of SELECT name FROM xy WHERE crn IN (:crns) with all the .\nI would restructure the logic based on the followings:\n\ncollect the crns from the failedAuthorization to a Set<String>,\nsort them into a Map<ResourceType, Set<String>>, basically crns by resource types,\nchange the String ResourceNameProvider.getNameByCrn(String) to Map<String, String> ResourceNameProvider.getNamesByCrns(Set<String>) and use the IN sql stament in the underlying implementations (most of the time this is easily achiavable except EnvironmentClientService),\npass the result Map<String, String> name-crn map to the AuthorizationRule.\n\nI checked the code, the above solution wouldn't complicate the code at all and we wouldn't have worse and worse performance with increasing request size. I can even give a few ours to implement this and compare the solution if you wan't it, or we can add a followup task to refactor it. I don't think we need to cover this with lot of evidence, executing one sql statement is way faster than executing only the parts of it in a cycle with lots of network round-trip.", "url": "https://github.com/hortonworks/cloudbreak/pull/9504#discussion_r529689302", "createdAt": "2020-11-24T16:06:01Z", "author": {"login": "foldik"}, "path": "authorization-common/src/main/java/com/sequenceiq/authorization/service/ResourceAuthorizationService.java", "diffHunk": "@@ -64,7 +68,7 @@ public void authorize(String userCrn, ProceedingJoinPoint proceedingJoinPoint, M\n                     LOGGER.debug(\"Resource authorization failed: {}\", failedAuthorization.toString(rightMapper));\n                 }\n                 if (authzEntitled) {\n-                    throw new AccessDeniedException(failedAuthorization.getAsFailureMessage(rightMapper));\n+                    throw new AccessDeniedException(failedAuthorization.getAsFailureMessage(rightMapper, nameMapper));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c94e524469df590011c88d961ae6e34b1eb99d6"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTcwMzk3MA==", "bodyText": "I don't think that this would cause performance issues. The names only collected in the case of failed authorizations (in most cases there is only one crn)\nthe code would be more complicated, and different form the already implemented logic (e.g. rightMapper)", "url": "https://github.com/hortonworks/cloudbreak/pull/9504#discussion_r529703970", "createdAt": "2020-11-24T16:19:32Z", "author": {"login": "bbihari"}, "path": "authorization-common/src/main/java/com/sequenceiq/authorization/service/ResourceAuthorizationService.java", "diffHunk": "@@ -64,7 +68,7 @@ public void authorize(String userCrn, ProceedingJoinPoint proceedingJoinPoint, M\n                     LOGGER.debug(\"Resource authorization failed: {}\", failedAuthorization.toString(rightMapper));\n                 }\n                 if (authzEntitled) {\n-                    throw new AccessDeniedException(failedAuthorization.getAsFailureMessage(rightMapper));\n+                    throw new AccessDeniedException(failedAuthorization.getAsFailureMessage(rightMapper, nameMapper));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTY4OTMwMg=="}, "originalCommit": {"oid": "9c94e524469df590011c88d961ae6e34b1eb99d6"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM4NjYyOTY0OnYy", "diffSide": "RIGHT", "path": "authorization-common/src/test/java/com/sequenceiq/authorization/service/ResourceAuthorizationServiceTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxNTowODo0OVrOICZfTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxNToyNjoyN1rOICab-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTM4NTY3Ng==", "bodyText": "Do we need this?", "url": "https://github.com/hortonworks/cloudbreak/pull/9504#discussion_r539385676", "createdAt": "2020-12-09T15:08:49Z", "author": {"login": "foldik"}, "path": "authorization-common/src/test/java/com/sequenceiq/authorization/service/ResourceAuthorizationServiceTest.java", "diffHunk": "@@ -82,6 +85,7 @@ public void setUp() {\n         when(authorizationFactory1.supportedAnnotation()).thenReturn(CheckPermissionByResourceCrn.class);\n         when(authorizationFactory2.supportedAnnotation()).thenReturn(CheckPermissionByResourceName.class);\n         lenient().when(umsRightProvider.getRightMapper(true)).thenReturn(AuthorizationResourceAction::getRight);\n+        //when(resourceNameFactoryService.getNames(any())).thenReturn(Map.of(\"crn\", empty(), \"crn1\", empty(), \"crn2\", empty()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d749cb4a8339321413958864ab47dff51212450"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQwMTIxMA==", "bodyText": "nope, thanks finding it :)", "url": "https://github.com/hortonworks/cloudbreak/pull/9504#discussion_r539401210", "createdAt": "2020-12-09T15:26:27Z", "author": {"login": "bbihari"}, "path": "authorization-common/src/test/java/com/sequenceiq/authorization/service/ResourceAuthorizationServiceTest.java", "diffHunk": "@@ -82,6 +85,7 @@ public void setUp() {\n         when(authorizationFactory1.supportedAnnotation()).thenReturn(CheckPermissionByResourceCrn.class);\n         when(authorizationFactory2.supportedAnnotation()).thenReturn(CheckPermissionByResourceName.class);\n         lenient().when(umsRightProvider.getRightMapper(true)).thenReturn(AuthorizationResourceAction::getRight);\n+        //when(resourceNameFactoryService.getNames(any())).thenReturn(Map.of(\"crn\", empty(), \"crn1\", empty(), \"crn2\", empty()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTM4NTY3Ng=="}, "originalCommit": {"oid": "0d749cb4a8339321413958864ab47dff51212450"}, "originalPosition": 14}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3515, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}