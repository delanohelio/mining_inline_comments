{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA2NzM0NTE1", "number": 7856, "title": "CB-6613 Fix OS upgrade for lauch templates", "bodyText": "", "createdAt": "2020-04-21T15:05:31Z", "url": "https://github.com/hortonworks/cloudbreak/pull/7856", "merged": true, "mergeCommit": {"oid": "eaed9374fc0398769bf7b0d56ddc4b37d6e220e0"}, "closed": true, "closedAt": "2020-04-23T14:36:13Z", "author": {"login": "Bajzathd"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcaIdIDAH2gAyNDA2NzM0NTE1OmU1MTJlYTc4YjBjZmNjM2RkNmU4MWRlZjJlYzM3NjA0ZGZiNGNhY2E=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcad0NNgFqTM5OTE1ODk1NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e512ea78b0cfcc3dd6e81def2ec37604dfb4caca", "author": {"user": {"login": "Bajzathd", "name": "Bajz\u00e1th D\u00e1vid"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/e512ea78b0cfcc3dd6e81def2ec37604dfb4caca", "committedDate": "2020-04-22T13:39:10Z", "message": "CB-6613 Fix OS upgrade for lauch templates"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "26a4e4b31b86612dea7550de1f559f5743f798e3", "author": {"user": {"login": "Bajzathd", "name": "Bajz\u00e1th D\u00e1vid"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/26a4e4b31b86612dea7550de1f559f5743f798e3", "committedDate": "2020-04-21T14:49:33Z", "message": "CB-6613 Fix OS upgrade for lauch templates"}, "afterCommit": {"oid": "e512ea78b0cfcc3dd6e81def2ec37604dfb4caca", "author": {"user": {"login": "Bajzathd", "name": "Bajz\u00e1th D\u00e1vid"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/e512ea78b0cfcc3dd6e81def2ec37604dfb4caca", "committedDate": "2020-04-22T13:39:10Z", "message": "CB-6613 Fix OS upgrade for lauch templates"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fcda9ed06f2a2cc13f185fe165c2f1d2c44d4d95", "author": {"user": {"login": "Bajzathd", "name": "Bajz\u00e1th D\u00e1vid"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/fcda9ed06f2a2cc13f185fe165c2f1d2c44d4d95", "committedDate": "2020-04-22T20:58:45Z", "message": "CB-6613 Fix freeIpaSpotPercentage nullability"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4OTMyNDEx", "url": "https://github.com/hortonworks/cloudbreak/pull/7856#pullrequestreview-398932411", "createdAt": "2020-04-23T09:42:27Z", "commit": {"oid": "fcda9ed06f2a2cc13f185fe165c2f1d2c44d4d95"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwOTo0MjoyN1rOGKgakg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxMDoxNTozMlrOGKhxVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzY3MDAzNA==", "bodyText": "refactor into a method like getTemplateBody", "url": "https://github.com/hortonworks/cloudbreak/pull/7856#discussion_r413670034", "createdAt": "2020-04-23T09:42:27Z", "author": {"login": "lacikaaa"}, "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/AwsImageUpdateService.java", "diffHunk": "@@ -43,17 +49,33 @@\n     @Inject\n     private AutoScalingGroupHandler autoScalingGroupHandler;\n \n+    @Inject\n+    private AwsStackRequestHelper awsStackRequestHelper;\n+\n     public void updateImage(AuthenticatedContext authenticatedContext, CloudStack stack, CloudResource cfResource) {\n         AwsCredentialView credentialView = new AwsCredentialView(authenticatedContext.getCloudCredential());\n         String regionName = authenticatedContext.getCloudContext().getLocation().getRegion().getRegionName();\n         AmazonCloudFormationClient cloudFormationClient = awsClient.createCloudFormationClient(credentialView, regionName);\n         AmazonAutoScalingClient autoScalingClient = awsClient.createAutoScalingClient(credentialView, regionName);\n \n-        Map<AutoScalingGroup, String> scalingGroups = autoScalingGroupHandler.getAutoScalingGroups(cloudFormationClient, autoScalingClient, cfResource);\n-        List<LaunchConfiguration> oldLaunchConfigurations = launchConfigurationHandler.getLaunchConfigurations(autoScalingClient, scalingGroups.keySet());\n+        String cfStackName = cfResource.getName();\n+        GetTemplateResult template = cloudFormationClient.getTemplate(new GetTemplateRequest().withStackName(cfStackName));\n+        String templateBody = template.getTemplateBody();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcda9ed06f2a2cc13f185fe165c2f1d2c44d4d95"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzY3OTI3MQ==", "bodyText": "could you refactor it into a method like updateImageInGroup?", "url": "https://github.com/hortonworks/cloudbreak/pull/7856#discussion_r413679271", "createdAt": "2020-04-23T09:56:06Z", "author": {"login": "lacikaaa"}, "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/AwsImageUpdateService.java", "diffHunk": "@@ -87,4 +109,26 @@ private void changeImageInAutoscalingGroup(AuthenticatedContext authenticatedCon\n         return encryptedImageCopyService.createEncryptedImages(authenticatedContext, stack, resourceNotifier).entrySet()\n                     .stream().collect(Collectors.toMap(entry -> AwsGroupView.getAutoScalingGroupName(entry.getKey()), Entry::getValue));\n     }\n+\n+    private void updateImagesInCloudFormationTemplate(AuthenticatedContext authenticatedContext, AmazonCloudFormationClient cloudFormationClient,\n+            CloudResource cfResource, Map<String, String> encryptedImages, CloudStack stack, String templateBody) {\n+        String imageName = stack.getImage().getImageName();\n+        String cfStackName = cfResource.getName();\n+        Json templateJson = new Json(templateBody);\n+\n+        stack.getGroups().forEach(group -> {\n+            String imageIdPath = String.format(\"Resources.%s.Properties.LaunchTemplateData.ImageId\", AwsGroupView.getLaunchTemplateName(group.getName()));\n+            Object oldImageId = templateJson.getValue(imageIdPath);\n+            if (!\"{\\\"Ref\\\":\\\"AMI\\\"}\".equals(oldImageId.toString())) {\n+                String autoScalingGroupName = AwsGroupView.getAutoScalingGroupName(group.getName());\n+                String encryptedImageName = encryptedImages.get(autoScalingGroupName);\n+                String selectedImageName = StringUtils.isBlank(encryptedImageName) ? imageName : encryptedImageName;\n+                templateJson.replaceValue(imageIdPath, selectedImageName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcda9ed06f2a2cc13f185fe165c2f1d2c44d4d95"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzY4MDAyNw==", "bodyText": "I don't really get what we check here. Could you refactor the condition into a method and name it so it would be obvious what we check here?", "url": "https://github.com/hortonworks/cloudbreak/pull/7856#discussion_r413680027", "createdAt": "2020-04-23T09:57:05Z", "author": {"login": "lacikaaa"}, "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/AwsImageUpdateService.java", "diffHunk": "@@ -87,4 +109,26 @@ private void changeImageInAutoscalingGroup(AuthenticatedContext authenticatedCon\n         return encryptedImageCopyService.createEncryptedImages(authenticatedContext, stack, resourceNotifier).entrySet()\n                     .stream().collect(Collectors.toMap(entry -> AwsGroupView.getAutoScalingGroupName(entry.getKey()), Entry::getValue));\n     }\n+\n+    private void updateImagesInCloudFormationTemplate(AuthenticatedContext authenticatedContext, AmazonCloudFormationClient cloudFormationClient,\n+            CloudResource cfResource, Map<String, String> encryptedImages, CloudStack stack, String templateBody) {\n+        String imageName = stack.getImage().getImageName();\n+        String cfStackName = cfResource.getName();\n+        Json templateJson = new Json(templateBody);\n+\n+        stack.getGroups().forEach(group -> {\n+            String imageIdPath = String.format(\"Resources.%s.Properties.LaunchTemplateData.ImageId\", AwsGroupView.getLaunchTemplateName(group.getName()));\n+            Object oldImageId = templateJson.getValue(imageIdPath);\n+            if (!\"{\\\"Ref\\\":\\\"AMI\\\"}\".equals(oldImageId.toString())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcda9ed06f2a2cc13f185fe165c2f1d2c44d4d95"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzY4MTExMQ==", "bodyText": "could you make 2 separate classes which contains only the methods related to the 2 different update type?", "url": "https://github.com/hortonworks/cloudbreak/pull/7856#discussion_r413681111", "createdAt": "2020-04-23T09:58:45Z", "author": {"login": "lacikaaa"}, "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/AwsImageUpdateService.java", "diffHunk": "@@ -43,17 +49,33 @@\n     @Inject\n     private AutoScalingGroupHandler autoScalingGroupHandler;\n \n+    @Inject\n+    private AwsStackRequestHelper awsStackRequestHelper;\n+\n     public void updateImage(AuthenticatedContext authenticatedContext, CloudStack stack, CloudResource cfResource) {\n         AwsCredentialView credentialView = new AwsCredentialView(authenticatedContext.getCloudCredential());\n         String regionName = authenticatedContext.getCloudContext().getLocation().getRegion().getRegionName();\n         AmazonCloudFormationClient cloudFormationClient = awsClient.createCloudFormationClient(credentialView, regionName);\n         AmazonAutoScalingClient autoScalingClient = awsClient.createAutoScalingClient(credentialView, regionName);\n \n-        Map<AutoScalingGroup, String> scalingGroups = autoScalingGroupHandler.getAutoScalingGroups(cloudFormationClient, autoScalingClient, cfResource);\n-        List<LaunchConfiguration> oldLaunchConfigurations = launchConfigurationHandler.getLaunchConfigurations(autoScalingClient, scalingGroups.keySet());\n+        String cfStackName = cfResource.getName();\n+        GetTemplateResult template = cloudFormationClient.getTemplate(new GetTemplateRequest().withStackName(cfStackName));\n+        String templateBody = template.getTemplateBody();\n \n         Map<String, String> encryptedImages = getEncryptedImagesMappedByAutoscalingGroupName(authenticatedContext, stack);\n+        if (templateBody.contains(\"AWS::AutoScaling::LaunchConfiguration\")) {\n+            updateImagesInLaunchConfigurations(authenticatedContext, stack, autoScalingClient, encryptedImages, cloudFormationClient, cfResource);\n+        } else if (templateBody.contains(\"AWS::EC2::LaunchTemplate\")) {\n+            updateImagesInCloudFormationTemplate(authenticatedContext, cloudFormationClient, cfResource, encryptedImages, stack, templateBody);\n+        } else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcda9ed06f2a2cc13f185fe165c2f1d2c44d4d95"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzY5MjI0NA==", "bodyText": "and I think we don't have test for that case when we have to skip the if body", "url": "https://github.com/hortonworks/cloudbreak/pull/7856#discussion_r413692244", "createdAt": "2020-04-23T10:15:32Z", "author": {"login": "lacikaaa"}, "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/AwsImageUpdateService.java", "diffHunk": "@@ -87,4 +109,26 @@ private void changeImageInAutoscalingGroup(AuthenticatedContext authenticatedCon\n         return encryptedImageCopyService.createEncryptedImages(authenticatedContext, stack, resourceNotifier).entrySet()\n                     .stream().collect(Collectors.toMap(entry -> AwsGroupView.getAutoScalingGroupName(entry.getKey()), Entry::getValue));\n     }\n+\n+    private void updateImagesInCloudFormationTemplate(AuthenticatedContext authenticatedContext, AmazonCloudFormationClient cloudFormationClient,\n+            CloudResource cfResource, Map<String, String> encryptedImages, CloudStack stack, String templateBody) {\n+        String imageName = stack.getImage().getImageName();\n+        String cfStackName = cfResource.getName();\n+        Json templateJson = new Json(templateBody);\n+\n+        stack.getGroups().forEach(group -> {\n+            String imageIdPath = String.format(\"Resources.%s.Properties.LaunchTemplateData.ImageId\", AwsGroupView.getLaunchTemplateName(group.getName()));\n+            Object oldImageId = templateJson.getValue(imageIdPath);\n+            if (!\"{\\\"Ref\\\":\\\"AMI\\\"}\".equals(oldImageId.toString())) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzY4MDAyNw=="}, "originalCommit": {"oid": "fcda9ed06f2a2cc13f185fe165c2f1d2c44d4d95"}, "originalPosition": 77}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb86db259bf03e12097cd24500cacb2a0d225298", "author": {"user": {"login": "Bajzathd", "name": "Bajz\u00e1th D\u00e1vid"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/cb86db259bf03e12097cd24500cacb2a0d225298", "committedDate": "2020-04-23T12:42:45Z", "message": "CB-6613 Refactor aws image update"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5MTU4OTU1", "url": "https://github.com/hortonworks/cloudbreak/pull/7856#pullrequestreview-399158955", "createdAt": "2020-04-23T14:32:23Z", "commit": {"oid": "cb86db259bf03e12097cd24500cacb2a0d225298"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2224, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}