{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM1MDYxMDg2", "number": 8288, "title": "CB-7225 Usersync and setpassword APIs should authorized in case of empty list too", "bodyText": "In case of freeipa usersync and setPassword, environments list should not be empty.\nNeed to wait for UI and CLI change.", "createdAt": "2020-06-16T08:35:48Z", "url": "https://github.com/hortonworks/cloudbreak/pull/8288", "merged": true, "mergeCommit": {"oid": "d0acbc5e43e3bbf1c5ac88c1d0868a72d128360e"}, "closed": true, "closedAt": "2020-06-22T18:01:27Z", "author": {"login": "horadla23"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcrx7hJgBqjM0NDgxMTUzNTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABctznK4gFqTQzNTA5ODMyMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "84a8433c65f1b8d21b72e61c3404e222757d5ad1", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/84a8433c65f1b8d21b72e61c3404e222757d5ad1", "committedDate": "2020-06-16T08:33:55Z", "message": "CB-7225 API's that don't fit current schema"}, "afterCommit": {"oid": "d74180185d262a9c07a8ab9e0ae0d8f47aec9ea1", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/d74180185d262a9c07a8ab9e0ae0d8f47aec9ea1", "committedDate": "2020-06-16T09:34:37Z", "message": "CB-7225 Usersync and setpassword APIs should not handle empty env list"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d74180185d262a9c07a8ab9e0ae0d8f47aec9ea1", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/d74180185d262a9c07a8ab9e0ae0d8f47aec9ea1", "committedDate": "2020-06-16T09:34:37Z", "message": "CB-7225 Usersync and setpassword APIs should not handle empty env list"}, "afterCommit": {"oid": "b42e21e65119f09457cf153fb70502ce6b68ca32", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/b42e21e65119f09457cf153fb70502ce6b68ca32", "committedDate": "2020-06-17T09:38:43Z", "message": "CB-7225 Usersync and setpassword APIs should not handle empty env list"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b42e21e65119f09457cf153fb70502ce6b68ca32", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/b42e21e65119f09457cf153fb70502ce6b68ca32", "committedDate": "2020-06-17T09:38:43Z", "message": "CB-7225 Usersync and setpassword APIs should not handle empty env list"}, "afterCommit": {"oid": "ad7c42f948b25cc0b5376e56712e98e984bd7a70", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/ad7c42f948b25cc0b5376e56712e98e984bd7a70", "committedDate": "2020-06-17T15:51:35Z", "message": "CB-7225 Usersync and setpassword APIs should not handle empty env list"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyOTg1OTE2", "url": "https://github.com/hortonworks/cloudbreak/pull/8288#pullrequestreview-432985916", "createdAt": "2020-06-18T06:49:31Z", "commit": {"oid": "ad7c42f948b25cc0b5376e56712e98e984bd7a70"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ad7c42f948b25cc0b5376e56712e98e984bd7a70", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/ad7c42f948b25cc0b5376e56712e98e984bd7a70", "committedDate": "2020-06-17T15:51:35Z", "message": "CB-7225 Usersync and setpassword APIs should not handle empty env list"}, "afterCommit": {"oid": "f90298057418e5b2251299ebc6cfef90df3e1408", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/f90298057418e5b2251299ebc6cfef90df3e1408", "committedDate": "2020-06-18T15:34:16Z", "message": "CB-7225 Usersync and setpassword APIs should not handle empty env list"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f90298057418e5b2251299ebc6cfef90df3e1408", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/f90298057418e5b2251299ebc6cfef90df3e1408", "committedDate": "2020-06-18T15:34:16Z", "message": "CB-7225 Usersync and setpassword APIs should not handle empty env list"}, "afterCommit": {"oid": "cb4a1d65f677db07d86fa2a5185b0e0be2318db2", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/cb4a1d65f677db07d86fa2a5185b0e0be2318db2", "committedDate": "2020-06-22T05:56:56Z", "message": "CB-7225 Usersync and setpassword APIs should not handle empty env list"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cb4a1d65f677db07d86fa2a5185b0e0be2318db2", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/cb4a1d65f677db07d86fa2a5185b0e0be2318db2", "committedDate": "2020-06-22T05:56:56Z", "message": "CB-7225 Usersync and setpassword APIs should not handle empty env list"}, "afterCommit": {"oid": "3883edfd204adb8477e81fa9fe8800b197d98ac9", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/3883edfd204adb8477e81fa9fe8800b197d98ac9", "committedDate": "2020-06-22T09:16:16Z", "message": "CB-7225 Usersync and setpassword APIs should not handle empty env list"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3883edfd204adb8477e81fa9fe8800b197d98ac9", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/3883edfd204adb8477e81fa9fe8800b197d98ac9", "committedDate": "2020-06-22T09:16:16Z", "message": "CB-7225 Usersync and setpassword APIs should not handle empty env list"}, "afterCommit": {"oid": "0158cae02767cee9305af37bc5d4fc4322cdea9d", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/0158cae02767cee9305af37bc5d4fc4322cdea9d", "committedDate": "2020-06-22T09:43:55Z", "message": "CB-7225 Usersync and setpassword APIs should authorized in case of empty list too"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0158cae02767cee9305af37bc5d4fc4322cdea9d", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/0158cae02767cee9305af37bc5d4fc4322cdea9d", "committedDate": "2020-06-22T09:43:55Z", "message": "CB-7225 Usersync and setpassword APIs should authorized in case of empty list too"}, "afterCommit": {"oid": "ff61d10d7f6684b8896c138554897a84dcc19d4f", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/ff61d10d7f6684b8896c138554897a84dcc19d4f", "committedDate": "2020-06-22T10:52:03Z", "message": "CB-7225 Usersync and setpassword APIs should authorized in case of empty list too"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ff61d10d7f6684b8896c138554897a84dcc19d4f", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/ff61d10d7f6684b8896c138554897a84dcc19d4f", "committedDate": "2020-06-22T10:52:03Z", "message": "CB-7225 Usersync and setpassword APIs should authorized in case of empty list too"}, "afterCommit": {"oid": "b087aa31b34b85dfe14a61fbefb462d12afebe1b", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/b087aa31b34b85dfe14a61fbefb462d12afebe1b", "committedDate": "2020-06-22T11:19:44Z", "message": "CB-7225 Usersync and setpassword APIs should authorized in case of empty list too"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b087aa31b34b85dfe14a61fbefb462d12afebe1b", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/b087aa31b34b85dfe14a61fbefb462d12afebe1b", "committedDate": "2020-06-22T11:19:44Z", "message": "CB-7225 Usersync and setpassword APIs should authorized in case of empty list too"}, "afterCommit": {"oid": "a5e7315a7e2e5b7c89bcc349394a3491248dbad9", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/a5e7315a7e2e5b7c89bcc349394a3491248dbad9", "committedDate": "2020-06-22T11:28:01Z", "message": "CB-7225 Usersync and setpassword APIs should authorized in case of empty list too"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1MDA1NDQw", "url": "https://github.com/hortonworks/cloudbreak/pull/8288#pullrequestreview-435005440", "createdAt": "2020-06-22T14:55:15Z", "commit": {"oid": "a5e7315a7e2e5b7c89bcc349394a3491248dbad9"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQxNDo1NToxNVrOGnEbmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQxNDo1NToxNVrOGnEbmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzYyMDI1MA==", "bodyText": "I don't think we need the environmentCrnFilter here because we've already gotten the relevant stacks.", "url": "https://github.com/hortonworks/cloudbreak/pull/8288#discussion_r443620250", "createdAt": "2020-06-22T14:55:15Z", "author": {"login": "handavid"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java", "diffHunk": "@@ -102,15 +104,25 @@\n     @Inject\n     private WorkloadCredentialService workloadCredentialService;\n \n+    @Inject\n+    private CommonPermissionCheckingUtils commonPermissionCheckingUtils;\n+\n     public Operation synchronizeUsers(String accountId, String actorCrn, Set<String> environmentCrnFilter,\n             Set<String> userCrnFilter, Set<String> machineUserCrnFilter) {\n+        List<Stack> stacks = getStacksForSync(accountId, actorCrn, environmentCrnFilter, userCrnFilter, machineUserCrnFilter);\n+        return performSyncForStacks(accountId, actorCrn, environmentCrnFilter, userCrnFilter, machineUserCrnFilter, stacks);\n+    }\n \n-        validateParameters(accountId, actorCrn, environmentCrnFilter, userCrnFilter, machineUserCrnFilter);\n-        LOGGER.debug(\"Synchronizing users in account {} for environmentCrns {}, userCrns {}, and machineUserCrns {}\",\n-                accountId, environmentCrnFilter, userCrnFilter, machineUserCrnFilter);\n+    public Operation synchronizeUsersWithCustomPermissionCheck(String accountId, String actorCrn, Set<String> environmentCrnFilter,\n+            Set<String> userCrnFilter, Set<String> machineUserCrnFilter, AuthorizationResourceAction action) {\n+        List<Stack> stacks = getStacksForSync(accountId, actorCrn, environmentCrnFilter, userCrnFilter, machineUserCrnFilter);\n+        List<String> relatedEnvironmentCrns = stacks.stream().map(stack -> stack.getEnvironmentCrn()).collect(Collectors.toList());\n+        commonPermissionCheckingUtils.checkPermissionForUserOnResources(action, actorCrn, relatedEnvironmentCrns);\n+        return performSyncForStacks(accountId, actorCrn, environmentCrnFilter, userCrnFilter, machineUserCrnFilter, stacks);\n+    }\n \n-        List<Stack> stacks = stackService.getMultipleByEnvironmentCrnOrChildEnvironmantCrnAndAccountId(environmentCrnFilter, accountId);\n-        LOGGER.debug(\"Found {} stacks\", stacks.size());\n+    private Operation performSyncForStacks(String accountId, String actorCrn, Set<String> environmentCrnFilter,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a5e7315a7e2e5b7c89bcc349394a3491248dbad9"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d372b8d880471beaa9c2eb50c6fc938bbf38a13", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/0d372b8d880471beaa9c2eb50c6fc938bbf38a13", "committedDate": "2020-06-22T15:02:29Z", "message": "CB-7225 Usersync and setpassword APIs should authorized in case of empty list too"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a5e7315a7e2e5b7c89bcc349394a3491248dbad9", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/a5e7315a7e2e5b7c89bcc349394a3491248dbad9", "committedDate": "2020-06-22T11:28:01Z", "message": "CB-7225 Usersync and setpassword APIs should authorized in case of empty list too"}, "afterCommit": {"oid": "0d372b8d880471beaa9c2eb50c6fc938bbf38a13", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/0d372b8d880471beaa9c2eb50c6fc938bbf38a13", "committedDate": "2020-06-22T15:02:29Z", "message": "CB-7225 Usersync and setpassword APIs should authorized in case of empty list too"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1MDk4MzIw", "url": "https://github.com/hortonworks/cloudbreak/pull/8288#pullrequestreview-435098320", "createdAt": "2020-06-22T16:40:37Z", "commit": {"oid": "0d372b8d880471beaa9c2eb50c6fc938bbf38a13"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1720, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}