{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgzNDk1ODYw", "number": 8973, "title": "CB-8698 In this commit, I change to 'FETCH' the findAllActive's query\u2026", "bodyText": "\u2026. Reason:\nThe original hibernate OneToOne fetching execute two separated SQL to fetch the object and the reference. If the SQL is too slow, then another thread can delete the reference object. In this case, the second SQL will throw a not found exception.\nThe integration tests are running parallel and all the cluster template tests running at the same time, therefore, we have a big chance to run the deletion while the other test selects the templates from the DB.\nMy suspected timeline\n\nexecute the select of cluster templates\nthe other test (thread in CB) delete the USER_DEFINED template\ntry to fetch the referenced stack, but this deleted by the other thread\n\nSee detailed description in the commit message.", "createdAt": "2020-09-10T07:46:15Z", "url": "https://github.com/hortonworks/cloudbreak/pull/8973", "merged": true, "mergeCommit": {"oid": "943eafe8cf239b703665c97487a65a5b4c337b48"}, "closed": true, "closedAt": "2020-09-10T12:04:41Z", "author": {"login": "topolyai5"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdHe6hrgBqjM3NTA0MzUxNzM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHfOh9AFqTQ4NTg0MDk2MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "905765f7dbf3e77c6bc89ff66291d91c3c51fcf1", "author": {"user": {"login": "topolyai5", "name": "Gergely Topolyai"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/905765f7dbf3e77c6bc89ff66291d91c3c51fcf1", "committedDate": "2020-09-10T07:44:22Z", "message": "CB-8698 In this commit, I change to 'FETCH' the findAllActive's query. Reason:\nThe original hibernate OneToOne fetching execute two separated SQL to fetch the object and the reference. If the SQL is too slow, then another thread can delete the reference object. In this case, the second SQL will throw a not found exception.\nThe integration tests are running parallel and all the cluster template tests running at the same time, therefore, we have a big chance to run the deletion while the other test selects the templates from the DB.\nMy suspected timeline\n* execute the select of cluster templates\n* the other test (thread in CB) delete the USER_DEFINED template\n* try to fetch the referenced stack, but this deleted by the other thread"}, "afterCommit": {"oid": "cbeb1ab02d589ea0ac8eb167b087a2b994136eea", "author": {"user": {"login": "topolyai5", "name": "Gergely Topolyai"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/cbeb1ab02d589ea0ac8eb167b087a2b994136eea", "committedDate": "2020-09-10T11:15:15Z", "message": "CB-8698 In this commit, I change to 'FETCH' the findAllActive's query. Reason:\nThe original hibernate OneToOne fetching execute two separated SQL to fetch the object and the reference. If the SQL is too slow, then another thread can delete the reference object. In this case, the second SQL will throw a not found exception.\nThe integration tests are running parallel and all the cluster template tests running at the same time, therefore, we have a big chance to run the deletion while the other test selects the templates from the DB.\nMy suspected timeline\n* execute the select of cluster templates\n* the other test (thread in CB) delete the USER_DEFINED template\n* try to fetch the referenced stack, but this deleted by the other thread"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5630159ecbd64185051273bc82a3ec548efc475", "author": {"user": {"login": "topolyai5", "name": "Gergely Topolyai"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/e5630159ecbd64185051273bc82a3ec548efc475", "committedDate": "2020-09-10T11:15:58Z", "message": "CB-8698 In this commit, I change to 'FETCH' the findAllActive's query. Reason:\nThe original hibernate OneToOne fetching execute two separated SQL to fetch the object and the reference. If the SQL is too slow, then another thread can delete the reference object. In this case, the second SQL will throw a not found exception.\nThe integration tests are running parallel and all the cluster template tests running at the same time, therefore, we have a big chance to run the deletion while the other test selects the templates from the DB.\nMy suspected timeline\n* execute the select of cluster templates\n* the other test (thread in CB) delete the USER_DEFINED template\n* try to fetch the referenced stack, but this deleted by the other thread"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cbeb1ab02d589ea0ac8eb167b087a2b994136eea", "author": {"user": {"login": "topolyai5", "name": "Gergely Topolyai"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/cbeb1ab02d589ea0ac8eb167b087a2b994136eea", "committedDate": "2020-09-10T11:15:15Z", "message": "CB-8698 In this commit, I change to 'FETCH' the findAllActive's query. Reason:\nThe original hibernate OneToOne fetching execute two separated SQL to fetch the object and the reference. If the SQL is too slow, then another thread can delete the reference object. In this case, the second SQL will throw a not found exception.\nThe integration tests are running parallel and all the cluster template tests running at the same time, therefore, we have a big chance to run the deletion while the other test selects the templates from the DB.\nMy suspected timeline\n* execute the select of cluster templates\n* the other test (thread in CB) delete the USER_DEFINED template\n* try to fetch the referenced stack, but this deleted by the other thread"}, "afterCommit": {"oid": "e5630159ecbd64185051273bc82a3ec548efc475", "author": {"user": {"login": "topolyai5", "name": "Gergely Topolyai"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/e5630159ecbd64185051273bc82a3ec548efc475", "committedDate": "2020-09-10T11:15:58Z", "message": "CB-8698 In this commit, I change to 'FETCH' the findAllActive's query. Reason:\nThe original hibernate OneToOne fetching execute two separated SQL to fetch the object and the reference. If the SQL is too slow, then another thread can delete the reference object. In this case, the second SQL will throw a not found exception.\nThe integration tests are running parallel and all the cluster template tests running at the same time, therefore, we have a big chance to run the deletion while the other test selects the templates from the DB.\nMy suspected timeline\n* execute the select of cluster templates\n* the other test (thread in CB) delete the USER_DEFINED template\n* try to fetch the referenced stack, but this deleted by the other thread"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1ODQwODQy", "url": "https://github.com/hortonworks/cloudbreak/pull/8973#pullrequestreview-485840842", "createdAt": "2020-09-10T11:37:28Z", "commit": {"oid": "e5630159ecbd64185051273bc82a3ec548efc475"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxMTozNzoyOFrOHPvbkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxMTozNzoyOFrOHPvbkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjI2Nzc5Mw==", "bodyText": "We need to be careful with this and monitor mow-dev how it will behave.", "url": "https://github.com/hortonworks/cloudbreak/pull/8973#discussion_r486267793", "createdAt": "2020-09-10T11:37:28Z", "author": {"login": "doktoric"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/repository/cluster/ClusterTemplateViewRepository.java", "diffHunk": "@@ -16,7 +16,9 @@\n @Transactional(TxType.REQUIRED)\n public interface ClusterTemplateViewRepository extends WorkspaceResourceRepository<ClusterTemplateView, Long> {\n \n-    @Query(\"SELECT b FROM ClusterTemplateView b WHERE b.workspace.id= :workspaceId AND b.status <> 'DEFAULT_DELETED'\")\n+    @Query(\"SELECT b FROM ClusterTemplateView b \" +\n+            \"LEFT JOIN FETCH b.stackTemplate \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e5630159ecbd64185051273bc82a3ec548efc475"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1ODQwOTYw", "url": "https://github.com/hortonworks/cloudbreak/pull/8973#pullrequestreview-485840960", "createdAt": "2020-09-10T11:37:38Z", "commit": {"oid": "e5630159ecbd64185051273bc82a3ec548efc475"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2296, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}