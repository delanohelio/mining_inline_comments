{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg5MzUzNDkz", "number": 7598, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxNjozNjowNVrODoaT8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QwODowNjo0MFrODonfoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzNzAwNzIzOnYy", "diffSide": "RIGHT", "path": "freeipa/src/main/resources/freeipa-salt/salt/freeipa/scripts/freeipa_install.sh", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxNjozNjowNVrOF28X_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxODo1MDo1N1rOF6ThIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzE1NjYwNQ==", "bodyText": "please do it from java", "url": "https://github.com/hortonworks/cloudbreak/pull/7598#discussion_r393156605", "createdAt": "2020-03-16T16:36:05Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/resources/freeipa-salt/salt/freeipa/scripts/freeipa_install.sh", "diffHunk": "@@ -23,4 +23,13 @@ ipa-server-install \\\n           --auto-forwarders \\\n           --unattended\n \n+# Setup basic CNAME records for pointing to FreeIPA services\n+echo \"$FPW\" | kinit admin\n+ipa dnsrecord-add $DOMAIN kdc --cname-rec=\"ipa-ca.$DOMAIN.\"\n+ipa dnsrecord-add $DOMAIN kerberos --cname-rec=\"ipa-ca.$DOMAIN.\"\n+ipa dnsrecord-add $DOMAIN ldap --cname-rec=\"ipa-ca.$DOMAIN.\"\n+ipa dnsrecord-add $DOMAIN freeipa --cname-rec=\"ipa-ca.$DOMAIN.\"\n+ipa dnsrecord-add $DOMAIN ipa --cname-rec=\"ipa-ca.$DOMAIN.\"\n+kdestroy", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "14a2d81143d447282f29e8ea3196baa69ce99363"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY3Njk4OQ==", "bodyText": "I would like to understand why we needed to take something that was 8 lines in a salt script, was only going to be run once on an install of the server and move it to Java.  Now we have a lot more code to maintain.  Isn't this what using salt as the node management supposed to give us.  I am just wanting to understand where the demarkation oh what is supposed to be controlled by java and what the salt scripts are supposed to do.", "url": "https://github.com/hortonworks/cloudbreak/pull/7598#discussion_r396676989", "createdAt": "2020-03-23T18:43:11Z", "author": {"login": "wonderslug"}, "path": "freeipa/src/main/resources/freeipa-salt/salt/freeipa/scripts/freeipa_install.sh", "diffHunk": "@@ -23,4 +23,13 @@ ipa-server-install \\\n           --auto-forwarders \\\n           --unattended\n \n+# Setup basic CNAME records for pointing to FreeIPA services\n+echo \"$FPW\" | kinit admin\n+ipa dnsrecord-add $DOMAIN kdc --cname-rec=\"ipa-ca.$DOMAIN.\"\n+ipa dnsrecord-add $DOMAIN kerberos --cname-rec=\"ipa-ca.$DOMAIN.\"\n+ipa dnsrecord-add $DOMAIN ldap --cname-rec=\"ipa-ca.$DOMAIN.\"\n+ipa dnsrecord-add $DOMAIN freeipa --cname-rec=\"ipa-ca.$DOMAIN.\"\n+ipa dnsrecord-add $DOMAIN ipa --cname-rec=\"ipa-ca.$DOMAIN.\"\n+kdestroy", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzE1NjYwNQ=="}, "originalCommit": {"oid": "14a2d81143d447282f29e8ea3196baa69ce99363"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY3ODUwNw==", "bodyText": "Right now we cannot update the Salt states on an existing cluster. If we need to change here something that we cannot do.", "url": "https://github.com/hortonworks/cloudbreak/pull/7598#discussion_r396678507", "createdAt": "2020-03-23T18:45:41Z", "author": {"login": "keyki"}, "path": "freeipa/src/main/resources/freeipa-salt/salt/freeipa/scripts/freeipa_install.sh", "diffHunk": "@@ -23,4 +23,13 @@ ipa-server-install \\\n           --auto-forwarders \\\n           --unattended\n \n+# Setup basic CNAME records for pointing to FreeIPA services\n+echo \"$FPW\" | kinit admin\n+ipa dnsrecord-add $DOMAIN kdc --cname-rec=\"ipa-ca.$DOMAIN.\"\n+ipa dnsrecord-add $DOMAIN kerberos --cname-rec=\"ipa-ca.$DOMAIN.\"\n+ipa dnsrecord-add $DOMAIN ldap --cname-rec=\"ipa-ca.$DOMAIN.\"\n+ipa dnsrecord-add $DOMAIN freeipa --cname-rec=\"ipa-ca.$DOMAIN.\"\n+ipa dnsrecord-add $DOMAIN ipa --cname-rec=\"ipa-ca.$DOMAIN.\"\n+kdestroy", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzE1NjYwNQ=="}, "originalCommit": {"oid": "14a2d81143d447282f29e8ea3196baa69ce99363"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY4MTUwNg==", "bodyText": "Think of it as Cloudera Manager. We could install a cluster from Salt also, but we use its API. We would lose lots of capabilities if we would implement everything in Salt.", "url": "https://github.com/hortonworks/cloudbreak/pull/7598#discussion_r396681506", "createdAt": "2020-03-23T18:50:57Z", "author": {"login": "keyki"}, "path": "freeipa/src/main/resources/freeipa-salt/salt/freeipa/scripts/freeipa_install.sh", "diffHunk": "@@ -23,4 +23,13 @@ ipa-server-install \\\n           --auto-forwarders \\\n           --unattended\n \n+# Setup basic CNAME records for pointing to FreeIPA services\n+echo \"$FPW\" | kinit admin\n+ipa dnsrecord-add $DOMAIN kdc --cname-rec=\"ipa-ca.$DOMAIN.\"\n+ipa dnsrecord-add $DOMAIN kerberos --cname-rec=\"ipa-ca.$DOMAIN.\"\n+ipa dnsrecord-add $DOMAIN ldap --cname-rec=\"ipa-ca.$DOMAIN.\"\n+ipa dnsrecord-add $DOMAIN freeipa --cname-rec=\"ipa-ca.$DOMAIN.\"\n+ipa dnsrecord-add $DOMAIN ipa --cname-rec=\"ipa-ca.$DOMAIN.\"\n+kdestroy", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzE1NjYwNQ=="}, "originalCommit": {"oid": "14a2d81143d447282f29e8ea3196baa69ce99363"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzOTE1MzI1OnYy", "diffSide": "RIGHT", "path": "freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/stack/doc/FreeIpaModelDescriptions.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QwODowMToyNVrOF3RR9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QwODowMToyNVrOF3RR9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQ5OTEyNw==", "bodyText": "please remove these too", "url": "https://github.com/hortonworks/cloudbreak/pull/7598#discussion_r393499127", "createdAt": "2020-03-17T08:01:25Z", "author": {"login": "lacikaaa"}, "path": "freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/stack/doc/FreeIpaModelDescriptions.java", "diffHunk": "@@ -89,5 +89,9 @@ private FreeIpaModelDescriptions() {\n         public static final String HOSTNAME = \"Base hostname for FreeIPA servers\";\n         public static final String ADMIN_GROUP_NAME = \"Name of the admin group to be used for all the services.\";\n         public static final String TAGS = \"Tags on freeipa.\";\n+        public static final String FREEIPA_HOST = \"A DNS load balanced FQDN to the FreeIPA servers\";\n+        public static final String FREEIPA_PORT = \"The port for the load balanced FQDN to the FreeIPA servers\";\n+        public static final String IPA_HOST = \"A DNS load balanced FQDN to the FreeIPA servers\";\n+        public static final String IPA_PORT = \"The port for the load balanced FQDN to the FreeIPA servers\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "434c4ef67b8e73a7dedc2db4a162cb3838ebb362"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzOTE2MDQyOnYy", "diffSide": "RIGHT", "path": "freeipa-client/src/main/java/com/sequenceiq/freeipa/client/FreeIpaClient.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QwODowNDowMlrOF3RWlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNDowNzozOVrOF3d1_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzUwMDMwOQ==", "bodyText": "why error? asdj?", "url": "https://github.com/hortonworks/cloudbreak/pull/7598#discussion_r393500309", "createdAt": "2020-03-17T08:04:02Z", "author": {"login": "lacikaaa"}, "path": "freeipa-client/src/main/java/com/sequenceiq/freeipa/client/FreeIpaClient.java", "diffHunk": "@@ -468,6 +468,20 @@ public DnsZone addReverseDnsZone(String cidr) throws FreeIpaClientException {\n         return (DnsZone) invoke(\"dnszone_add\", flags, params, DnsZone.class).getResult();\n     }\n \n+    public DnsRecord getDnsRecord(String dnsZoneName, String recordName) throws FreeIpaClientException {\n+        List<String> flags = List.of(dnsZoneName, recordName);\n+        Map<String, Object> params = Map.of();\n+        return (DnsRecord) invoke(\"dnsrecord_show\", flags, params, DnsRecord.class).getResult();\n+    }\n+\n+    public DnsRecord addDnsCnameRecord(String dnsZoneName, String recordName, String cnameRecord) throws FreeIpaClientException {\n+        LOGGER.error(\"ASDJ CNAME \" + dnsZoneName + \" -- \" + recordName + \"  -- \" + cnameRecord + \" -- \");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "434c4ef67b8e73a7dedc2db4a162cb3838ebb362"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzcwNDk1Ng==", "bodyText": "I removed this log statement. The caller of this method logs debug messages.", "url": "https://github.com/hortonworks/cloudbreak/pull/7598#discussion_r393704956", "createdAt": "2020-03-17T14:07:39Z", "author": {"login": "jamisonbennett"}, "path": "freeipa-client/src/main/java/com/sequenceiq/freeipa/client/FreeIpaClient.java", "diffHunk": "@@ -468,6 +468,20 @@ public DnsZone addReverseDnsZone(String cidr) throws FreeIpaClientException {\n         return (DnsZone) invoke(\"dnszone_add\", flags, params, DnsZone.class).getResult();\n     }\n \n+    public DnsRecord getDnsRecord(String dnsZoneName, String recordName) throws FreeIpaClientException {\n+        List<String> flags = List.of(dnsZoneName, recordName);\n+        Map<String, Object> params = Map.of();\n+        return (DnsRecord) invoke(\"dnsrecord_show\", flags, params, DnsRecord.class).getResult();\n+    }\n+\n+    public DnsRecord addDnsCnameRecord(String dnsZoneName, String recordName, String cnameRecord) throws FreeIpaClientException {\n+        LOGGER.error(\"ASDJ CNAME \" + dnsZoneName + \" -- \" + recordName + \"  -- \" + cnameRecord + \" -- \");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzUwMDMwOQ=="}, "originalCommit": {"oid": "434c4ef67b8e73a7dedc2db4a162cb3838ebb362"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzOTE2NzA1OnYy", "diffSide": "RIGHT", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/flow/FreeIpaPostInstallService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QwODowNjo0MFrOF3Ra2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QwODowNjo0MFrOF3Ra2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzUwMTQwMg==", "bodyText": "could you move these to a separate class?", "url": "https://github.com/hortonworks/cloudbreak/pull/7598#discussion_r393501402", "createdAt": "2020-03-17T08:06:40Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/flow/FreeIpaPostInstallService.java", "diffHunk": "@@ -95,4 +104,35 @@ private void modifyAdminPasswordExpirationIfNeeded(FreeIpaClient client) throws\n             LOGGER.debug(\"Password expiration is already set.\");\n         }\n     }\n+\n+    private void addDnsLoadBalancedEntries(FreeIpaClient client, FreeIpa freeIpa) throws FreeIpaClientException {\n+\n+        String domain = freeIpa.getDomain();\n+        String loadBalancedName = FreeIpaDomainUtils.getBuiltInFreeIpaDnsLoadBalancedName(domain);\n+        Set<String> cnames = Set.of(\n+                FreeIpaDomainUtils.getKdcHost(),\n+                FreeIpaDomainUtils.getKerberosHost(),\n+                FreeIpaDomainUtils.getLdapHost(),\n+                FreeIpaDomainUtils.getFreeIpaHost());\n+\n+        for (String cname : cnames) {\n+            if (!hasDnsRecord(client, domain, cname)) {\n+                client.addDnsCnameRecord(domain, cname, loadBalancedName);\n+            } else {\n+                LOGGER.debug(\"Skipping adding DNS cname for {} because it already exists\", cname);\n+            }\n+        }\n+    }\n+\n+    private boolean hasDnsRecord(FreeIpaClient client, String domain, String cname) throws FreeIpaClientException {\n+        try {\n+            client.getDnsRecord(domain, cname);\n+            return true;\n+        } catch (FreeIpaClientException e) {\n+            if (FreeIpaClientExceptionUtil.isNotFoundException(e)) {\n+                return false;\n+            }\n+            throw e;\n+        }\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "434c4ef67b8e73a7dedc2db4a162cb3838ebb362"}, "originalPosition": 72}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2678, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}