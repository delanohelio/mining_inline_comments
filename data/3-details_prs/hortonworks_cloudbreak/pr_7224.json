{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcxNDQzODU5", "number": 7224, "title": "CB-5303. Add stop telemetry agents action before termination.", "bodyText": "Shutdown in some cases are too agressive or too fast (like for AWS) and the shutdown scripts are not finishing for td-agent on the nodes.\nSolution for that is to run fluent.agent-stop.sls salt script on the nodes before termination\n\nAdd as an action for freeipa\nAdd as an another task for core code (to pre stack termination)\n\nIf command fails, that should not be considered as an error, so put the salt execution in try catch block and just log the errors\ntested manually", "createdAt": "2020-02-05T15:44:23Z", "url": "https://github.com/hortonworks/cloudbreak/pull/7224", "merged": true, "mergeCommit": {"oid": "d1e94eda178be39889831238d199c917aa6182c3"}, "closed": true, "closedAt": "2020-02-07T10:08:14Z", "author": {"login": "oleewere"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBYYljgBqjMwMTA1OTY1OTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcB6TcIAFqTM1NDk3MjQzMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b6b27420741921e67f775095436dab7a765fe8ea", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/b6b27420741921e67f775095436dab7a765fe8ea", "committedDate": "2020-02-05T15:40:57Z", "message": "CB-5303. Add stop telemetry agent action before termination."}, "afterCommit": {"oid": "eb3c032ebc9dffb55284c061c22cc5bf1a4f5338", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/eb3c032ebc9dffb55284c061c22cc5bf1a4f5338", "committedDate": "2020-02-05T16:03:12Z", "message": "CB-5303. Add stop telemetry agent action before termination."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eb3c032ebc9dffb55284c061c22cc5bf1a4f5338", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/eb3c032ebc9dffb55284c061c22cc5bf1a4f5338", "committedDate": "2020-02-05T16:03:12Z", "message": "CB-5303. Add stop telemetry agent action before termination."}, "afterCommit": {"oid": "9a50e33c8c01ef3ef32c70d48dc8e4be19ac2e66", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/9a50e33c8c01ef3ef32c70d48dc8e4be19ac2e66", "committedDate": "2020-02-05T16:28:11Z", "message": "CB-5303. Add stop telemetry agent action before termination."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0MjgyODMw", "url": "https://github.com/hortonworks/cloudbreak/pull/7224#pullrequestreview-354282830", "createdAt": "2020-02-06T08:54:40Z", "commit": {"oid": "9a50e33c8c01ef3ef32c70d48dc8e4be19ac2e66"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQwODo1NDo0MFrOFmTURg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQwODo1Njo0NlrOFmTYNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTcwNjY5NA==", "bodyText": "this doesn't seem right in case of CCM. if we deregister freeipa from CCM and CP we won't be able to communicate with it anymore.", "url": "https://github.com/hortonworks/cloudbreak/pull/7224#discussion_r375706694", "createdAt": "2020-02-06T08:54:40Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/flow/stack/termination/StackTerminationFlowConfig.java", "diffHunk": "@@ -32,7 +34,8 @@\n                     .defaultFailureEvent(TERMINATION_FAILED_EVENT)\n                     .from(INIT_STATE).to(DEREGISTER_CLUSTERPROXY_STATE).event(TERMINATION_EVENT).noFailureEvent()\n                     .from(DEREGISTER_CLUSTERPROXY_STATE).to(DEREGISTER_CCMKEY_STATE).event(CLUSTER_PROXY_DEREGISTRATION_FINISHED_EVENT).noFailureEvent()\n-                    .from(DEREGISTER_CCMKEY_STATE).to(REMOVE_MACHINE_USER_STATE).event(CCM_KEY_DEREGISTRATION_FINISHED_EVENT).noFailureEvent()\n+                    .from(DEREGISTER_CCMKEY_STATE).to(STOP_TELEMETRY_AGENT_STATE).event(CCM_KEY_DEREGISTRATION_FINISHED_EVENT).noFailureEvent()\n+                    .from(STOP_TELEMETRY_AGENT_STATE).to(REMOVE_MACHINE_USER_STATE).event(STOP_TELEMETRY_AGENT_FINISHED_EVENT).noFailureEvent()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a50e33c8c01ef3ef32c70d48dc8e4be19ac2e66"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTcwNzcwMQ==", "bodyText": "could you move this out?", "url": "https://github.com/hortonworks/cloudbreak/pull/7224#discussion_r375707701", "createdAt": "2020-02-06T08:56:46Z", "author": {"login": "lacikaaa"}, "path": "orchestrator-salt/src/main/java/com/sequenceiq/cloudbreak/orchestrator/salt/SaltOrchestrator.java", "diffHunk": "@@ -195,6 +195,27 @@ public String submit(SaltConnector saltConnector) {\n         }\n     }\n \n+    @Override\n+    public void stopTelemetryAgent(List<GatewayConfig> allGateway, Set<Node> nodes, ExitCriteriaModel exitModel)\n+            throws CloudbreakOrchestratorFailedException {\n+        GatewayConfig primaryGateway = getPrimaryGatewayConfig(allGateway);\n+        Set<String> gatewayTargets = getGatewayPrivateIps(allGateway);\n+        try (SaltConnector sc = createSaltConnector(primaryGateway)) {\n+            BaseSaltJobRunner baseSaltJobRunner = new BaseSaltJobRunner(gatewayTargets, nodes) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a50e33c8c01ef3ef32c70d48dc8e4be19ac2e66"}, "originalPosition": 10}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9a50e33c8c01ef3ef32c70d48dc8e4be19ac2e66", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/9a50e33c8c01ef3ef32c70d48dc8e4be19ac2e66", "committedDate": "2020-02-05T16:28:11Z", "message": "CB-5303. Add stop telemetry agent action before termination."}, "afterCommit": {"oid": "f70f3fc322ea51a13eef97e2212b1024b7e099d4", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/f70f3fc322ea51a13eef97e2212b1024b7e099d4", "committedDate": "2020-02-06T09:25:21Z", "message": "CB-5303. Add stop telemetry agent action before termination."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f70f3fc322ea51a13eef97e2212b1024b7e099d4", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/f70f3fc322ea51a13eef97e2212b1024b7e099d4", "committedDate": "2020-02-06T09:25:21Z", "message": "CB-5303. Add stop telemetry agent action before termination."}, "afterCommit": {"oid": "69b8274f956aa6abd16876e3246e665ed8e4d447", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/69b8274f956aa6abd16876e3246e665ed8e4d447", "committedDate": "2020-02-06T09:53:54Z", "message": "CB-5303. Add stop telemetry agent action before termination."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "69b8274f956aa6abd16876e3246e665ed8e4d447", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/69b8274f956aa6abd16876e3246e665ed8e4d447", "committedDate": "2020-02-06T09:53:54Z", "message": "CB-5303. Add stop telemetry agent action before termination."}, "afterCommit": {"oid": "b86a500d87104be48a41aba2468ab8ea4174b4c8", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/b86a500d87104be48a41aba2468ab8ea4174b4c8", "committedDate": "2020-02-06T12:32:41Z", "message": "CB-5303. Add stop telemetry agent action before termination."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9163f2524f79f5f6475e207068b4bc5997fc2046", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/9163f2524f79f5f6475e207068b4bc5997fc2046", "committedDate": "2020-02-06T18:00:56Z", "message": "CB-5303. Add stop telemetry agent action before termination."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b86a500d87104be48a41aba2468ab8ea4174b4c8", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/b86a500d87104be48a41aba2468ab8ea4174b4c8", "committedDate": "2020-02-06T12:32:41Z", "message": "CB-5303. Add stop telemetry agent action before termination."}, "afterCommit": {"oid": "9163f2524f79f5f6475e207068b4bc5997fc2046", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/9163f2524f79f5f6475e207068b4bc5997fc2046", "committedDate": "2020-02-06T18:00:56Z", "message": "CB-5303. Add stop telemetry agent action before termination."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0OTcyNDMz", "url": "https://github.com/hortonworks/cloudbreak/pull/7224#pullrequestreview-354972433", "createdAt": "2020-02-07T07:35:44Z", "commit": {"oid": "9163f2524f79f5f6475e207068b4bc5997fc2046"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1946, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}