{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcyOTE0NzUz", "number": 7249, "title": "CB 5486: Add Instance ID to health check response.", "bodyText": "Adding instance ID to the health check response.\nUpdated unit tests initialization.  Additionally ran manual tests.", "createdAt": "2020-02-10T02:47:17Z", "url": "https://github.com/hortonworks/cloudbreak/pull/7249", "merged": true, "mergeCommit": {"oid": "fc268869fe37c1b568b31a2779ae48e03b47e6df"}, "closed": true, "closedAt": "2020-02-14T15:00:45Z", "author": {"login": "holleyism"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcC6axaAFqTM1NTgxODMzMg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcDoP2NABqjMwMzEzMjQwNTA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1ODE4MzMy", "url": "https://github.com/hortonworks/cloudbreak/pull/7249#pullrequestreview-355818332", "createdAt": "2020-02-10T10:13:09Z", "commit": {"oid": "052eaaea3ddc80a26d212586f52fa80656387391"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMDoxMzowOVrOFngcvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMDoxMzowOVrOFngcvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk3MDQzMA==", "bodyText": "You can do it inline", "url": "https://github.com/hortonworks/cloudbreak/pull/7249#discussion_r376970430", "createdAt": "2020-02-10T10:13:09Z", "author": {"login": "topolyai5"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/stack/FreeIpaHealthDetailsService.java", "diffHunk": "@@ -0,0 +1,152 @@\n+package com.sequenceiq.freeipa.service.stack;\n+\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Service;\n+\n+\n+import com.sequenceiq.freeipa.api.v1.freeipa.stack.model.common.DetailedStackStatus;\n+import com.sequenceiq.freeipa.api.v1.freeipa.stack.model.common.Status;\n+import com.sequenceiq.freeipa.api.v1.freeipa.stack.model.common.instance.InstanceGroupType;\n+import com.sequenceiq.freeipa.api.v1.freeipa.stack.model.health.HealthDetailsFreeIpaResponse;\n+import com.sequenceiq.freeipa.api.v1.freeipa.stack.model.health.NodeHealthDetails;\n+import com.sequenceiq.freeipa.client.FreeIpaClient;\n+import com.sequenceiq.freeipa.client.FreeIpaClientException;\n+import com.sequenceiq.freeipa.client.model.RPCMessage;\n+import com.sequenceiq.freeipa.client.model.RPCResponse;\n+import com.sequenceiq.freeipa.entity.InstanceGroup;\n+import com.sequenceiq.freeipa.entity.InstanceMetaData;\n+import com.sequenceiq.freeipa.entity.Stack;\n+import com.sequenceiq.freeipa.service.freeipa.FreeIpaClientFactory;\n+\n+@Service\n+public class FreeIpaHealthDetailsService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(FreeIpaHealthDetailsService.class);\n+\n+    private static final String EXTERNAL_COMMAND_OUTPUT = \"ExternalCommandOutput\";\n+\n+    private static final String STATUS_OK = \"OK\";\n+\n+    private static final int STATUS_GROUP = 2;\n+\n+    private static final int NODE_GROUP = 1;\n+\n+    private static final String MESSAGE_UNAVAILABLE = \"Message Unavailable\";\n+\n+    private static final Pattern RESULT_PATTERN = Pattern.compile(\"(ecure port|: TCP) \\\\([0-9]*\\\\): (.*)\");\n+\n+    private static final Pattern NEW_NODE_PATTERN = Pattern.compile(\"Check connection from master to remote replica '(.[^\\']*)\");\n+\n+    @Inject\n+    private StackService stackService;\n+\n+    @Inject\n+    private FreeIpaClientFactory freeIpaClientFactory;\n+\n+    public HealthDetailsFreeIpaResponse getHealthDetails(String environmentCrn, String accountId) {\n+        Stack stack = stackService.getByEnvironmentCrnAndAccountIdWithLists(environmentCrn, accountId);\n+        InstanceMetaData master = findMaster(stack);\n+        Optional<RPCResponse<Boolean>> rpcResponse = Optional.empty();\n+        try {\n+            rpcResponse = Optional.ofNullable(checkFreeIpaHealth(stack, master));\n+        } catch (FreeIpaClientException e) {\n+            LOGGER.error(\"Unable to check the health of FreeIPA.\", e);\n+        }\n+        return createResponse(stack, rpcResponse, master);\n+    }\n+\n+    private HealthDetailsFreeIpaResponse createResponse(Stack stack, Optional<RPCResponse<Boolean>> rpcResponse, InstanceMetaData master) {\n+        HealthDetailsFreeIpaResponse response = new HealthDetailsFreeIpaResponse();\n+        response.setEnvironmentCrn(stack.getEnvironmentCrn());\n+        response.setCrn(stack.getResourceCrn());\n+        if (rpcResponse.isPresent()) {\n+            response.setName((String) rpcResponse.get().getValue());\n+            parseMessages(rpcResponse.get(), response);\n+            if (isOverallHealthy(response)) {\n+                response.setStatus(DetailedStackStatus.PROVISIONED.getStatus());\n+            } else {\n+                response.setStatus(DetailedStackStatus.UNHEALTHY.getStatus());\n+            }\n+        } else {\n+            response.setStatus(DetailedStackStatus.UNREACHABLE.getStatus());\n+            NodeHealthDetails nodeResponse = null;\n+            nodeResponse = new NodeHealthDetails();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "052eaaea3ddc80a26d212586f52fa80656387391"}, "originalPosition": 82}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "052eaaea3ddc80a26d212586f52fa80656387391", "author": {"user": {"login": "holleyism", "name": "Adam Holley"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/052eaaea3ddc80a26d212586f52fa80656387391", "committedDate": "2020-02-10T02:43:00Z", "message": "CB-5486: Add instanceID to the response for the health check\n\nThis patch adds the instanceID for the nodes to the reponse\nfor the health check."}, "afterCommit": {"oid": "fb205991672a48287aae67730a0240d5e0b66486", "author": {"user": {"login": "holleyism", "name": "Adam Holley"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/fb205991672a48287aae67730a0240d5e0b66486", "committedDate": "2020-02-10T14:32:12Z", "message": "CB-5486: Add instanceID to the response for the health check\n\nThis patch adds the instanceID for the nodes to the reponse\nfor the health check."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fb205991672a48287aae67730a0240d5e0b66486", "author": {"user": {"login": "holleyism", "name": "Adam Holley"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/fb205991672a48287aae67730a0240d5e0b66486", "committedDate": "2020-02-10T14:32:12Z", "message": "CB-5486: Add instanceID to the response for the health check\n\nThis patch adds the instanceID for the nodes to the reponse\nfor the health check."}, "afterCommit": {"oid": "998e6ebb485b1dfdf6d84f670d10a0ebc1f2cfa6", "author": {"user": {"login": "holleyism", "name": "Adam Holley"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/998e6ebb485b1dfdf6d84f670d10a0ebc1f2cfa6", "committedDate": "2020-02-10T14:41:41Z", "message": "CB-5486: Add instanceID to the response for the health check\n\nThis patch adds the instanceID for the nodes to the reponse\nfor the health check."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1OTk5ODk1", "url": "https://github.com/hortonworks/cloudbreak/pull/7249#pullrequestreview-355999895", "createdAt": "2020-02-10T14:55:26Z", "commit": {"oid": "998e6ebb485b1dfdf6d84f670d10a0ebc1f2cfa6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2MDE4OTE1", "url": "https://github.com/hortonworks/cloudbreak/pull/7249#pullrequestreview-356018915", "createdAt": "2020-02-10T15:17:15Z", "commit": {"oid": "998e6ebb485b1dfdf6d84f670d10a0ebc1f2cfa6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c632b89b922d395f10ac6125d02f2de6046aab66", "author": {"user": {"login": "holleyism", "name": "Adam Holley"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/c632b89b922d395f10ac6125d02f2de6046aab66", "committedDate": "2020-02-12T15:41:03Z", "message": "CB-5486: Add instanceID to the response for the health check\n\nThis patch adds the instanceID for the nodes to the reponse\nfor the health check."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "998e6ebb485b1dfdf6d84f670d10a0ebc1f2cfa6", "author": {"user": {"login": "holleyism", "name": "Adam Holley"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/998e6ebb485b1dfdf6d84f670d10a0ebc1f2cfa6", "committedDate": "2020-02-10T14:41:41Z", "message": "CB-5486: Add instanceID to the response for the health check\n\nThis patch adds the instanceID for the nodes to the reponse\nfor the health check."}, "afterCommit": {"oid": "c632b89b922d395f10ac6125d02f2de6046aab66", "author": {"user": {"login": "holleyism", "name": "Adam Holley"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/c632b89b922d395f10ac6125d02f2de6046aab66", "committedDate": "2020-02-12T15:41:03Z", "message": "CB-5486: Add instanceID to the response for the health check\n\nThis patch adds the instanceID for the nodes to the reponse\nfor the health check."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1853, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}