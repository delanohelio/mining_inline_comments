{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYzNjg5OTg2", "number": 7088, "title": "CB-5117 Update existing security groups of environments", "bodyText": "", "createdAt": "2020-01-16T14:59:35Z", "url": "https://github.com/hortonworks/cloudbreak/pull/7088", "merged": true, "mergeCommit": {"oid": "0291a5d4d4c086edee68bf2044e87ef1ef20063a"}, "closed": true, "closedAt": "2020-01-17T12:37:58Z", "author": {"login": "topolyai5"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb67p7eAFqTM0Mzk4NTYyMQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb7OCdUgFqTM0NDU1MDg2MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzOTg1NjIx", "url": "https://github.com/hortonworks/cloudbreak/pull/7088#pullrequestreview-343985621", "createdAt": "2020-01-16T15:12:43Z", "commit": {"oid": "56168b67b6e18975d149070cc655cd16828decef"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNToxMjo0M1rOFecy1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNToxMjo0M1rOFecy1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ3MzM2Nw==", "bodyText": "I think this should be IllegalStateException or some other one but definitely not IllegalArgumentException since we don't know whether this method has got some illegal input argument or just something happened.", "url": "https://github.com/hortonworks/cloudbreak/pull/7088#discussion_r367473367", "createdAt": "2020-01-16T15:12:43Z", "author": {"login": "gregito"}, "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/AwsPlatformResources.java", "diffHunk": "@@ -483,6 +484,18 @@ public CloudSecurityGroups securityGroups(CloudCredential cloudCredential, Regio\n         return new CloudSecurityGroups(result);\n     }\n \n+    private List<SecurityGroup> fetchSecurityGroups(AmazonEC2Client ec2Client, DescribeSecurityGroupsRequest describeSecurityGroupsRequest) {\n+        try {\n+            return ec2Client.describeSecurityGroups(describeSecurityGroupsRequest).getSecurityGroups();\n+        } catch (AmazonEC2Exception e) {\n+            if (e.getStatusCode() == HttpStatus.BAD_REQUEST.value() || e.getStatusCode() == HttpStatus.NOT_FOUND.value()) {\n+                throw new IllegalArgumentException(e.getErrorMessage(), e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56168b67b6e18975d149070cc655cd16828decef"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzOTg2MzE4", "url": "https://github.com/hortonworks/cloudbreak/pull/7088#pullrequestreview-343986318", "createdAt": "2020-01-16T15:13:37Z", "commit": {"oid": "56168b67b6e18975d149070cc655cd16828decef"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNToxMzozN1rOFec03g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNToxMzozN1rOFec03g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ3Mzg4Ng==", "bodyText": "same here. we don't know why the networkSecurityGroup is null, hence this is a state where we don't know what to do. -> IllegalStateException", "url": "https://github.com/hortonworks/cloudbreak/pull/7088#discussion_r367473886", "createdAt": "2020-01-16T15:13:37Z", "author": {"login": "gregito"}, "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/AzurePlatformResources.java", "diffHunk": "@@ -121,15 +122,17 @@ public CloudSshKeys sshKeys(CloudCredential cloudCredential, Region region, Map<\n     public CloudSecurityGroups securityGroups(CloudCredential cloudCredential, Region region, Map<String, String> filters) {\n         AzureClient client = azureClientService.getClient(cloudCredential);\n         Map<String, Set<CloudSecurityGroup>> result = new HashMap<>();\n-\n-        for (NetworkSecurityGroup securityGroup : client.getSecurityGroups().list()) {\n-            String actualRegion = securityGroup.region().label();\n-            if (regionMatch(actualRegion, region)) {\n-                Map<String, Object> properties = new HashMap<>();\n-                properties.put(\"resourceGroupName\", securityGroup.resourceGroupName());\n-                properties.put(\"networkInterfaceIds\", securityGroup.networkInterfaceIds());\n-                CloudSecurityGroup cloudSecurityGroup = new CloudSecurityGroup(securityGroup.name(), securityGroup.id(), properties);\n-                result.computeIfAbsent(actualRegion, s -> new HashSet<>()).add(cloudSecurityGroup);\n+        PlatformResourceSecurityGroupFilterView filter = new PlatformResourceSecurityGroupFilterView(filters);\n+        String groupId = filter.getGroupId();\n+        if (groupId != null) {\n+            NetworkSecurityGroup networkSecurityGroup = client.getSecurityGroups().getById(groupId);\n+            if (networkSecurityGroup == null) {\n+                throw new IllegalArgumentException(\"Nothing found on Azure with id: \" + groupId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56168b67b6e18975d149070cc655cd16828decef"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0MDIyNTQz", "url": "https://github.com/hortonworks/cloudbreak/pull/7088#pullrequestreview-344022543", "createdAt": "2020-01-16T15:58:35Z", "commit": {"oid": "56168b67b6e18975d149070cc655cd16828decef"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNTo1ODozNlrOFeegdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxODoyODo0N1rOFejRGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzUwMTQzMQ==", "bodyText": "or, throw CloudConnectorException.", "url": "https://github.com/hortonworks/cloudbreak/pull/7088#discussion_r367501431", "createdAt": "2020-01-16T15:58:36Z", "author": {"login": "bergerdenes"}, "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/AwsPlatformResources.java", "diffHunk": "@@ -483,6 +484,18 @@ public CloudSecurityGroups securityGroups(CloudCredential cloudCredential, Regio\n         return new CloudSecurityGroups(result);\n     }\n \n+    private List<SecurityGroup> fetchSecurityGroups(AmazonEC2Client ec2Client, DescribeSecurityGroupsRequest describeSecurityGroupsRequest) {\n+        try {\n+            return ec2Client.describeSecurityGroups(describeSecurityGroupsRequest).getSecurityGroups();\n+        } catch (AmazonEC2Exception e) {\n+            if (e.getStatusCode() == HttpStatus.BAD_REQUEST.value() || e.getStatusCode() == HttpStatus.NOT_FOUND.value()) {\n+                throw new IllegalArgumentException(e.getErrorMessage(), e);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ3MzM2Nw=="}, "originalCommit": {"oid": "56168b67b6e18975d149070cc655cd16828decef"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzUwNDQyNQ==", "bodyText": "or CloudConnectorException", "url": "https://github.com/hortonworks/cloudbreak/pull/7088#discussion_r367504425", "createdAt": "2020-01-16T16:03:14Z", "author": {"login": "bergerdenes"}, "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/AzurePlatformResources.java", "diffHunk": "@@ -121,15 +122,17 @@ public CloudSshKeys sshKeys(CloudCredential cloudCredential, Region region, Map<\n     public CloudSecurityGroups securityGroups(CloudCredential cloudCredential, Region region, Map<String, String> filters) {\n         AzureClient client = azureClientService.getClient(cloudCredential);\n         Map<String, Set<CloudSecurityGroup>> result = new HashMap<>();\n-\n-        for (NetworkSecurityGroup securityGroup : client.getSecurityGroups().list()) {\n-            String actualRegion = securityGroup.region().label();\n-            if (regionMatch(actualRegion, region)) {\n-                Map<String, Object> properties = new HashMap<>();\n-                properties.put(\"resourceGroupName\", securityGroup.resourceGroupName());\n-                properties.put(\"networkInterfaceIds\", securityGroup.networkInterfaceIds());\n-                CloudSecurityGroup cloudSecurityGroup = new CloudSecurityGroup(securityGroup.name(), securityGroup.id(), properties);\n-                result.computeIfAbsent(actualRegion, s -> new HashSet<>()).add(cloudSecurityGroup);\n+        PlatformResourceSecurityGroupFilterView filter = new PlatformResourceSecurityGroupFilterView(filters);\n+        String groupId = filter.getGroupId();\n+        if (groupId != null) {\n+            NetworkSecurityGroup networkSecurityGroup = client.getSecurityGroups().getById(groupId);\n+            if (networkSecurityGroup == null) {\n+                throw new IllegalArgumentException(\"Nothing found on Azure with id: \" + groupId);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ3Mzg4Ng=="}, "originalCommit": {"oid": "56168b67b6e18975d149070cc655cd16828decef"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzUwNDk4NA==", "bodyText": "use the exception class from earlier comments", "url": "https://github.com/hortonworks/cloudbreak/pull/7088#discussion_r367504984", "createdAt": "2020-01-16T16:04:10Z", "author": {"login": "bergerdenes"}, "path": "cloud-reactor/src/main/java/com/sequenceiq/cloudbreak/cloud/handler/GetPlatformSecurityGroupsHandler.java", "diffHunk": "@@ -44,6 +45,8 @@ public void accept(Event<GetPlatformSecurityGroupsRequest> getPlatformSecurityGr\n             GetPlatformSecurityGroupsResult getPlatformSecurityGroupsResult = new GetPlatformSecurityGroupsResult(request.getResourceId(), securityGroups);\n             request.getResult().onNext(getPlatformSecurityGroupsResult);\n             LOGGER.debug(\"Query platform networks types finished.\");\n+        } catch (IllegalArgumentException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56168b67b6e18975d149070cc655cd16828decef"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzU3OTAyNw==", "bodyText": "this is not good as EnvironmentCreationService is also using this method and CIDR setting is impossible with this change", "url": "https://github.com/hortonworks/cloudbreak/pull/7088#discussion_r367579027", "createdAt": "2020-01-16T18:27:54Z", "author": {"login": "bergerdenes"}, "path": "environment/src/main/java/com/sequenceiq/environment/environment/service/EnvironmentService.java", "diffHunk": "@@ -207,9 +208,25 @@ public CreateAWSEnvironmentRequest getCreateAWSEnvironmentForCli(EnvironmentDto\n         return environmentRepository.findByResourceCrnAndAccountIdAndArchivedIsFalse(resourceCrn, accountId);\n     }\n \n+    /**\n+     * The CIDR could not be edited so the first step we clear the the existed CIDR every time.\n+     * We are assuming the security access has the proper security group ids and we don't check it again.\n+     * If the knox or default security groups are blank we don't set\n+     * @param environment the security access will be update for this environment\n+     * @param securityAccess this should contains the knox and default security groups\n+     */\n+    void editSecurityAccess(Environment environment, SecurityAccessDto securityAccess) {\n+        environment.setCidr(null);\n+        if (StringUtils.isNotBlank(securityAccess.getDefaultSecurityGroupId())) {\n+            environment.setDefaultSecurityGroupId(securityAccess.getDefaultSecurityGroupId());\n+        }\n+        if (StringUtils.isNotBlank(securityAccess.getSecurityGroupIdForKnox())) {\n+            environment.setSecurityGroupIdForKnox(securityAccess.getSecurityGroupIdForKnox());\n+        }\n+    }\n+\n     void setSecurityAccess(Environment environment, SecurityAccessDto securityAccess) {\n         if (securityAccess != null) {\n-            environment.setCidr(securityAccess.getCidr());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56168b67b6e18975d149070cc655cd16828decef"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzU3OTM3Mw==", "bodyText": "is it a hard requirement?", "url": "https://github.com/hortonworks/cloudbreak/pull/7088#discussion_r367579373", "createdAt": "2020-01-16T18:28:41Z", "author": {"login": "bergerdenes"}, "path": "environment/src/main/java/com/sequenceiq/environment/environment/service/EnvironmentService.java", "diffHunk": "@@ -207,9 +208,25 @@ public CreateAWSEnvironmentRequest getCreateAWSEnvironmentForCli(EnvironmentDto\n         return environmentRepository.findByResourceCrnAndAccountIdAndArchivedIsFalse(resourceCrn, accountId);\n     }\n \n+    /**\n+     * The CIDR could not be edited so the first step we clear the the existed CIDR every time.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56168b67b6e18975d149070cc655cd16828decef"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzU3OTQxOQ==", "bodyText": "why?", "url": "https://github.com/hortonworks/cloudbreak/pull/7088#discussion_r367579419", "createdAt": "2020-01-16T18:28:47Z", "author": {"login": "bergerdenes"}, "path": "environment/src/main/java/com/sequenceiq/environment/environment/service/EnvironmentService.java", "diffHunk": "@@ -207,9 +208,25 @@ public CreateAWSEnvironmentRequest getCreateAWSEnvironmentForCli(EnvironmentDto\n         return environmentRepository.findByResourceCrnAndAccountIdAndArchivedIsFalse(resourceCrn, accountId);\n     }\n \n+    /**\n+     * The CIDR could not be edited so the first step we clear the the existed CIDR every time.\n+     * We are assuming the security access has the proper security group ids and we don't check it again.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56168b67b6e18975d149070cc655cd16828decef"}, "originalPosition": 14}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "56168b67b6e18975d149070cc655cd16828decef", "author": {"user": {"login": "topolyai5", "name": "Gergely Topolyai"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/56168b67b6e18975d149070cc655cd16828decef", "committedDate": "2020-01-16T14:57:20Z", "message": "CB-5117 Update existing security groups of environments"}, "afterCommit": {"oid": "2d39e3c927b0d099043694ea2432c5595672139c", "author": {"user": {"login": "topolyai5", "name": "Gergely Topolyai"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/2d39e3c927b0d099043694ea2432c5595672139c", "committedDate": "2020-01-17T09:50:03Z", "message": "CB-5117 Update existing security groups of environments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2d39e3c927b0d099043694ea2432c5595672139c", "author": {"user": {"login": "topolyai5", "name": "Gergely Topolyai"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/2d39e3c927b0d099043694ea2432c5595672139c", "committedDate": "2020-01-17T09:50:03Z", "message": "CB-5117 Update existing security groups of environments"}, "afterCommit": {"oid": "2222a9edfee55372ecb49dcc7ee73d737e95f460", "author": {"user": {"login": "topolyai5", "name": "Gergely Topolyai"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/2222a9edfee55372ecb49dcc7ee73d737e95f460", "committedDate": "2020-01-17T09:55:42Z", "message": "CB-5117 Update existing security groups of environments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94699c78c529e625edee73b3028e51c4c2c93d74", "author": {"user": {"login": "topolyai5", "name": "Gergely Topolyai"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/94699c78c529e625edee73b3028e51c4c2c93d74", "committedDate": "2020-01-17T10:30:19Z", "message": "CB-5117 Update existing security groups of environments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2222a9edfee55372ecb49dcc7ee73d737e95f460", "author": {"user": {"login": "topolyai5", "name": "Gergely Topolyai"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/2222a9edfee55372ecb49dcc7ee73d737e95f460", "committedDate": "2020-01-17T09:55:42Z", "message": "CB-5117 Update existing security groups of environments"}, "afterCommit": {"oid": "94699c78c529e625edee73b3028e51c4c2c93d74", "author": {"user": {"login": "topolyai5", "name": "Gergely Topolyai"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/94699c78c529e625edee73b3028e51c4c2c93d74", "committedDate": "2020-01-17T10:30:19Z", "message": "CB-5117 Update existing security groups of environments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0NTUwODYw", "url": "https://github.com/hortonworks/cloudbreak/pull/7088#pullrequestreview-344550860", "createdAt": "2020-01-17T12:37:49Z", "commit": {"oid": "94699c78c529e625edee73b3028e51c4c2c93d74"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1977, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}