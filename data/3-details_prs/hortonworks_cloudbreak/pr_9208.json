{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAxNzcyMjgz", "number": 9208, "title": "CB-9086 Enable host cert rotation on older runtimes", "bodyText": "CB-9086 Enable host cert rotation on older runtimes\nOn clusters with older than 7.2.1 version for CM host certificates rotation root ssh access is needed.\nThe following changes are introduced  for this:\n\nExtend HostOrchestrator / SaltOrchestrator with new method for execute specific saltstates\nIntroducing new salt states for ssh key adding / removal for given users on hosts\nExtend host certs rotation with adding temporary ssh access for root user during host cert rotation api call. This is only needed on clusters with older than 7.2.1 version.\n\nCB-9297 add 755 permission for CM agent cert directory after host certs rotation on all hosts. This is needed to workaround OPSAPS-58475.", "createdAt": "2020-10-12T19:37:55Z", "url": "https://github.com/hortonworks/cloudbreak/pull/9208", "merged": true, "mergeCommit": {"oid": "636a8e315b5661433faed4a51e16776e93b79661"}, "closed": true, "closedAt": "2020-10-16T08:48:48Z", "author": {"login": "schfeca75"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdR5v1VgBqjM4NjgxMzM5NTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSxeAsABqjM4ODE0NTgwNjI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "15f725fd0a2b02cbcfb88c005c9f6894a3d66abb", "author": {"user": {"login": "schfeca75", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/15f725fd0a2b02cbcfb88c005c9f6894a3d66abb", "committedDate": "2020-10-12T19:34:52Z", "message": "CB-9086 Enable host cert rotation on older runtimes"}, "afterCommit": {"oid": "2335b29cbd4c8dc9c8cc114e197795cf5ec24e5f", "author": {"user": {"login": "schfeca75", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/2335b29cbd4c8dc9c8cc114e197795cf5ec24e5f", "committedDate": "2020-10-12T20:10:17Z", "message": "CB-9086 Enable host cert rotation on older runtimes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2335b29cbd4c8dc9c8cc114e197795cf5ec24e5f", "author": {"user": {"login": "schfeca75", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/2335b29cbd4c8dc9c8cc114e197795cf5ec24e5f", "committedDate": "2020-10-12T20:10:17Z", "message": "CB-9086 Enable host cert rotation on older runtimes"}, "afterCommit": {"oid": "483605a02bf93ab7f554e73e46e912caa1869004", "author": {"user": {"login": "schfeca75", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/483605a02bf93ab7f554e73e46e912caa1869004", "committedDate": "2020-10-13T14:20:59Z", "message": "CB-9086 Enable host cert rotation on older runtimes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "483605a02bf93ab7f554e73e46e912caa1869004", "author": {"user": {"login": "schfeca75", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/483605a02bf93ab7f554e73e46e912caa1869004", "committedDate": "2020-10-13T14:20:59Z", "message": "CB-9086 Enable host cert rotation on older runtimes"}, "afterCommit": {"oid": "2c6f89d5010c9eb23b5233fed47ac94ebf5e8e41", "author": {"user": {"login": "schfeca75", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/2c6f89d5010c9eb23b5233fed47ac94ebf5e8e41", "committedDate": "2020-10-13T15:37:28Z", "message": "CB-9086 Enable host cert rotation on older runtimes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2c6f89d5010c9eb23b5233fed47ac94ebf5e8e41", "author": {"user": {"login": "schfeca75", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/2c6f89d5010c9eb23b5233fed47ac94ebf5e8e41", "committedDate": "2020-10-13T15:37:28Z", "message": "CB-9086 Enable host cert rotation on older runtimes"}, "afterCommit": {"oid": "8c1164f88521850bc6c4bba66d7e5ad9d354c184", "author": {"user": {"login": "schfeca75", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/8c1164f88521850bc6c4bba66d7e5ad9d354c184", "committedDate": "2020-10-13T18:03:28Z", "message": "CB-9086 Enable host cert rotation on older runtimes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8c1164f88521850bc6c4bba66d7e5ad9d354c184", "author": {"user": {"login": "schfeca75", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/8c1164f88521850bc6c4bba66d7e5ad9d354c184", "committedDate": "2020-10-13T18:03:28Z", "message": "CB-9086 Enable host cert rotation on older runtimes"}, "afterCommit": {"oid": "10042b431ec52c1796f346123b5a26974e6285ac", "author": {"user": {"login": "schfeca75", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/10042b431ec52c1796f346123b5a26974e6285ac", "committedDate": "2020-10-14T09:16:01Z", "message": "CB-9086 Enable host cert rotation on older runtimes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4MjAwNjcx", "url": "https://github.com/hortonworks/cloudbreak/pull/9208#pullrequestreview-508200671", "createdAt": "2020-10-14T10:18:13Z", "commit": {"oid": "10042b431ec52c1796f346123b5a26974e6285ac"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4NDA1ODU3", "url": "https://github.com/hortonworks/cloudbreak/pull/9208#pullrequestreview-508405857", "createdAt": "2020-10-14T14:26:22Z", "commit": {"oid": "10042b431ec52c1796f346123b5a26974e6285ac"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxNDoyNjoyMlrOHhVy_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxNDoyNjoyMlrOHhVy_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcyMjE3NQ==", "bodyText": "StringUtils.removeEnd(String str, String remove) would be a bit simpler", "url": "https://github.com/hortonworks/cloudbreak/pull/9208#discussion_r504722175", "createdAt": "2020-10-14T14:26:22Z", "author": {"login": "lacikaaa"}, "path": "cluster-cm/src/main/java/com/sequenceiq/cloudbreak/cm/ClouderaManagerSecurityService.java", "diffHunk": "@@ -405,4 +417,12 @@ private void processHostCertsBatchResponse(ApiClient client, ApiBatchResponse ap\n             throw new ClouderaManagerOperationFailedException(\"Host certificates rotation batch operation failed: \" + apiBatchResponse);\n         }\n     }\n+\n+    private String createPrivateKeyString(KeyPair sshKeyPair) {\n+        String privateKeyStr = PkiUtil.convert(sshKeyPair.getPrivate());\n+        if (privateKeyStr.endsWith(\"\\n\")) {\n+            privateKeyStr = privateKeyStr.substring(0, privateKeyStr.length() - 1);\n+        }\n+        return privateKeyStr;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10042b431ec52c1796f346123b5a26974e6285ac"}, "originalPosition": 82}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4NDIwMTAx", "url": "https://github.com/hortonworks/cloudbreak/pull/9208#pullrequestreview-508420101", "createdAt": "2020-10-14T14:39:34Z", "commit": {"oid": "10042b431ec52c1796f346123b5a26974e6285ac"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxNDozOTozNVrOHhWdNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxNDozOTozNVrOHhWdNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDczMjk4Mw==", "bodyText": "I would refactor this bit as there is almost a condition for every line:\n    protected Selectable doAccept(HandlerEvent event) {\n        LOGGER.debug(\"Accepting Cluster Manager host certificates rotation request...\");\n        ClusterHostCertificatesRotationRequest request = event.getData();\n        Selectable result;\n        try {\n            Stack stack = stackService.getByIdWithListsInTransaction(request.getResourceId());\n            ClusterApi clusterApi = apiConnectors.getConnector(stack);\n            if (isRootSshAccessNeededForHostCertRotation(stack)) {\n                rotateCertsWithSsh(stack, clusterApi);\n            } else {\n                clusterApi.rotateHostCertificates(null, null);\n            }\n            result = new ClusterHostCertificatesRotationSuccess(request.getResourceId());\n        } catch (Exception e) {\n            LOGGER.info(\"Cluster Manager host certificates rotation failed\", e);\n            result = new ClusterCertificatesRotationFailed(request.getResourceId(), e);\n        }\n        return result;\n    }\n\n    private boolean isRootSshAccessNeededForHostCertRotation(Stack stack) {\n        return CMRepositoryVersionUtil.isRootSshAccessNeededForHostCertRotation(\n                clusterComponentConfigProvider.getClouderaManagerRepoDetails(stack.getCluster().getId()));\n    }\n\n    private void rotateCertsWithSsh(Stack stack, ClusterApi clusterApi) throws Exception {\n        KeyPair sshKeyPair = sshKeyService.generateKeyPair();\n        sshKeyService.addSshPublicKeyToHosts(stack, ROOT_USER, sshKeyPair, TEMPORARY_SSH_KEY);\n        clusterApi.rotateHostCertificates(ROOT_USER, sshKeyPair);\n        sshKeyService.removeSshPublicKeyFromHosts(stack, ROOT_USER, TEMPORARY_SSH_KEY);\n    }", "url": "https://github.com/hortonworks/cloudbreak/pull/9208#discussion_r504732983", "createdAt": "2020-10-14T14:39:35Z", "author": {"login": "lacikaaa"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/reactor/handler/cluster/certrotate/ClusterHostCertificatesRotationHandler.java", "diffHunk": "@@ -46,8 +61,18 @@ protected Selectable doAccept(HandlerEvent event) {\n         Selectable result;\n         try {\n             Stack stack = stackService.getByIdWithListsInTransaction(request.getResourceId());\n+            boolean rootSshAccessNeeded = CMRepositoryVersionUtil.isRootSshAccessNeededForHostCertRotation(\n+                    clusterComponentConfigProvider.getClouderaManagerRepoDetails(stack.getCluster().getId()));\n+            KeyPair sshKeyPair = null;\n+            if (rootSshAccessNeeded) {\n+                sshKeyPair = sshKeyService.generateKeyPair();\n+                sshKeyService.addSshPublicKeyToHosts(stack, ROOT_USER, sshKeyPair, TEMPORARY_SSH_KEY);\n+            }\n             ClusterApi clusterApi = apiConnectors.getConnector(stack);\n-            clusterApi.rotateHostCertificates();\n+            clusterApi.rotateHostCertificates(rootSshAccessNeeded ? ROOT_USER : null, sshKeyPair);\n+            if (rootSshAccessNeeded) {\n+                sshKeyService.removeSshPublicKeyFromHosts(stack, ROOT_USER, TEMPORARY_SSH_KEY);\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10042b431ec52c1796f346123b5a26974e6285ac"}, "originalPosition": 64}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4NDMyNjMz", "url": "https://github.com/hortonworks/cloudbreak/pull/9208#pullrequestreview-508432633", "createdAt": "2020-10-14T14:51:31Z", "commit": {"oid": "10042b431ec52c1796f346123b5a26974e6285ac"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxNDo1MTozMVrOHhXC9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxNDo1MTozMVrOHhXC9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc0MjY0Ng==", "bodyText": "saltState is always \"ssh.remove_ssh_publickey\"\ncould be moved to a constant and inlined at line #54", "url": "https://github.com/hortonworks/cloudbreak/pull/9208#discussion_r504742646", "createdAt": "2020-10-14T14:51:31Z", "author": {"login": "lacikaaa"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/ssh/SshKeyService.java", "diffHunk": "@@ -0,0 +1,72 @@\n+package com.sequenceiq.cloudbreak.ssh;\n+\n+import java.security.KeyPair;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.certificate.PkiUtil;\n+import com.sequenceiq.cloudbreak.core.bootstrap.service.ClusterDeletionBasedExitCriteriaModel;\n+import com.sequenceiq.cloudbreak.domain.stack.Stack;\n+import com.sequenceiq.cloudbreak.domain.stack.cluster.Cluster;\n+import com.sequenceiq.cloudbreak.orchestrator.host.HostOrchestrator;\n+import com.sequenceiq.cloudbreak.orchestrator.host.OrchestratorStateParams;\n+import com.sequenceiq.cloudbreak.orchestrator.model.Node;\n+import com.sequenceiq.cloudbreak.service.GatewayConfigService;\n+import com.sequenceiq.cloudbreak.util.StackUtil;\n+\n+@Component\n+public class SshKeyService {\n+    @Inject\n+    private HostOrchestrator hostOrchestrator;\n+\n+    @Inject\n+    private GatewayConfigService gatewayConfigService;\n+\n+    @Inject\n+    private StackUtil stackUtil;\n+\n+    public KeyPair generateKeyPair() {\n+        return PkiUtil.generateKeypair();\n+    }\n+\n+    public void addSshPublicKeyToHosts(Stack stack, String user, KeyPair keyPair, String authKeysComment) throws Exception {\n+        OrchestratorStateParams stateParams = createSshStateParams(stack, user, keyPair, authKeysComment, \"ssh.remove_ssh_publickey\");\n+        hostOrchestrator.runOrchestratorState(stateParams);\n+        stateParams.setState(\"ssh.add_ssh_publickey\");\n+        hostOrchestrator.runOrchestratorState(stateParams);\n+    }\n+\n+    public void removeSshPublicKeyFromHosts(Stack stack, String user, String authKeysComment) throws Exception {\n+        OrchestratorStateParams stateParams = createSshStateParams(stack, user, null, authKeysComment, \"ssh.remove_ssh_publickey\");\n+        hostOrchestrator.runOrchestratorState(stateParams);\n+    }\n+\n+    private OrchestratorStateParams createSshStateParams(Stack stack, String user, KeyPair keyPair, String authKeysComment, String saltState) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10042b431ec52c1796f346123b5a26974e6285ac"}, "originalPosition": 50}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4NDUwMjY4", "url": "https://github.com/hortonworks/cloudbreak/pull/9208#pullrequestreview-508450268", "createdAt": "2020-10-14T15:08:14Z", "commit": {"oid": "10042b431ec52c1796f346123b5a26974e6285ac"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxNTowODoxNVrOHhX3Nw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxNTowODoxNVrOHhX3Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc1NjAyMw==", "bodyText": "why true?", "url": "https://github.com/hortonworks/cloudbreak/pull/9208#discussion_r504756023", "createdAt": "2020-10-14T15:08:15Z", "author": {"login": "lacikaaa"}, "path": "orchestrator-salt/src/main/resources/salt/salt/ssh/remove_ssh_publickey.sls", "diffHunk": "@@ -0,0 +1,19 @@\n+\n+{{ salt['user.info'](salt['pillar.get']('tmpssh:user')).home }}/.ssh/authorized_keys:\n+  file.blockreplace:\n+    - marker_start: \"# {{ salt['pillar.get']('tmpssh:comment') }}\"\n+    - marker_end: \"# end of {{ salt['pillar.get']('tmpssh:comment') }}\"\n+    - append_if_not_found: True", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10042b431ec52c1796f346123b5a26974e6285ac"}, "originalPosition": 6}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "10042b431ec52c1796f346123b5a26974e6285ac", "author": {"user": {"login": "schfeca75", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/10042b431ec52c1796f346123b5a26974e6285ac", "committedDate": "2020-10-14T09:16:01Z", "message": "CB-9086 Enable host cert rotation on older runtimes"}, "afterCommit": {"oid": "c6a38ca2f988c9d2935f4dc1796804c76454294c", "author": {"user": {"login": "schfeca75", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/c6a38ca2f988c9d2935f4dc1796804c76454294c", "committedDate": "2020-10-15T11:58:18Z", "message": "CB-9086 Enable host cert rotation on older runtimes\nOn clusters with older than 7.2.1 version for CM host certificates rotation root ssh access is needed.\nThe following changes are introduced  for this:\n- Extend HostOrchestrator / SaltOrchestrator with new method for execute specific saltstates\n- Introducing new salt states for ssh key adding / removal for given users on hosts\n- Extend host certs rotation with adding temporary ssh access for root user during host cert rotation api call. This is only needed on clusters with older than 7.2.1 version.\n\nCB-9297 add 755 permission for CM agent cert directory after host certs rotation on all hosts. This is needed to workaround OPSAPS-58475."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8d4691e4b155a348e6a1b68fed90f04e284e651", "author": {"user": {"login": "schfeca75", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/b8d4691e4b155a348e6a1b68fed90f04e284e651", "committedDate": "2020-10-15T13:05:30Z", "message": "CB-9086 Enable host cert rotation on older runtimes\nOn clusters with older than 7.2.1 version for CM host certificates rotation root ssh access is needed.\nThe following changes are introduced  for this:\n- Extend HostOrchestrator / SaltOrchestrator with new method for execute specific saltstates\n- Introducing new salt states for ssh key adding / removal for given users on hosts\n- Extend host certs rotation with adding temporary ssh access for root user during host cert rotation api call. This is only needed on clusters with older than 7.2.1 version.\n\nCB-9297 add 755 permission for CM agent cert directory after host certs rotation on all hosts. This is needed to workaround OPSAPS-58475."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c6a38ca2f988c9d2935f4dc1796804c76454294c", "author": {"user": {"login": "schfeca75", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/c6a38ca2f988c9d2935f4dc1796804c76454294c", "committedDate": "2020-10-15T11:58:18Z", "message": "CB-9086 Enable host cert rotation on older runtimes\nOn clusters with older than 7.2.1 version for CM host certificates rotation root ssh access is needed.\nThe following changes are introduced  for this:\n- Extend HostOrchestrator / SaltOrchestrator with new method for execute specific saltstates\n- Introducing new salt states for ssh key adding / removal for given users on hosts\n- Extend host certs rotation with adding temporary ssh access for root user during host cert rotation api call. This is only needed on clusters with older than 7.2.1 version.\n\nCB-9297 add 755 permission for CM agent cert directory after host certs rotation on all hosts. This is needed to workaround OPSAPS-58475."}, "afterCommit": {"oid": "b8d4691e4b155a348e6a1b68fed90f04e284e651", "author": {"user": {"login": "schfeca75", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/b8d4691e4b155a348e6a1b68fed90f04e284e651", "committedDate": "2020-10-15T13:05:30Z", "message": "CB-9086 Enable host cert rotation on older runtimes\nOn clusters with older than 7.2.1 version for CM host certificates rotation root ssh access is needed.\nThe following changes are introduced  for this:\n- Extend HostOrchestrator / SaltOrchestrator with new method for execute specific saltstates\n- Introducing new salt states for ssh key adding / removal for given users on hosts\n- Extend host certs rotation with adding temporary ssh access for root user during host cert rotation api call. This is only needed on clusters with older than 7.2.1 version.\n\nCB-9297 add 755 permission for CM agent cert directory after host certs rotation on all hosts. This is needed to workaround OPSAPS-58475."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2162, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}