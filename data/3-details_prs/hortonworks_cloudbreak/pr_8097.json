{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIwMTkzOTMx", "number": 8097, "title": "CB-6236 enable Ranger Raz on Azure in the datalake.", "bodyText": "", "createdAt": "2020-05-19T15:26:38Z", "url": "https://github.com/hortonworks/cloudbreak/pull/8097", "merged": true, "mergeCommit": {"oid": "d99dc46572e27b4ff7cc92be0322d4bfcef59d3c"}, "closed": true, "closedAt": "2020-05-21T15:13:48Z", "author": {"login": "frozenwizard"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABci2pkTgFqTQxNDU5NTYwMA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcjOKPIgBqjMzNTc5NzkzNjY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0NTk1NjAw", "url": "https://github.com/hortonworks/cloudbreak/pull/8097#pullrequestreview-414595600", "createdAt": "2020-05-19T15:59:46Z", "commit": {"oid": "6d2e8b3ce70433c5aefe530c30ae6f6e63af92f1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNTo1OTo0NlrOGXnbjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNTo1OTo0NlrOGXnbjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQxNjQ2Mg==", "bodyText": "razEntitlementEnabled", "url": "https://github.com/hortonworks/cloudbreak/pull/8097#discussion_r427416462", "createdAt": "2020-05-19T15:59:46Z", "author": {"login": "doktoric"}, "path": "datalake/src/main/java/com/sequenceiq/datalake/service/sdx/SdxService.java", "diffHunk": "@@ -413,6 +421,23 @@ private void validateCloudStorageRequest(SdxCloudStorageRequest cloudStorage, De\n         }\n     }\n \n+    private void validateRazEnablement(SdxClusterRequest sdxClusterRequest, DetailedEnvironmentResponse environment) {\n+        ValidationResultBuilder validationBuilder = new ValidationResultBuilder();\n+        boolean razEntitlement = entitlementService.razEnabled(environment.getCreator(), Crn.safeFromString(environment.getCreator()).getAccountId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d2e8b3ce70433c5aefe530c30ae6f6e63af92f1"}, "originalPosition": 55}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0NTk4NDQz", "url": "https://github.com/hortonworks/cloudbreak/pull/8097#pullrequestreview-414598443", "createdAt": "2020-05-19T16:02:56Z", "commit": {"oid": "6d2e8b3ce70433c5aefe530c30ae6f6e63af92f1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNjowMjo1NlrOGXnkgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNjowMjo1NlrOGXnkgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQxODc1NA==", "bodyText": "should we check this in case of sdx app as well ? I mean based on the runtime we should not enable the raz configuration if runtime < 7.2.0", "url": "https://github.com/hortonworks/cloudbreak/pull/8097#discussion_r427418754", "createdAt": "2020-05-19T16:02:56Z", "author": {"login": "doktoric"}, "path": "template-manager-cmtemplate/src/main/java/com/sequenceiq/cloudbreak/cmtemplate/CMRepositoryVersionUtil.java", "diffHunk": "@@ -64,6 +64,11 @@ public static boolean isTagsResourceSupportedViaBlueprint(ClouderaManagerRepo cl\n         return isVersionNewerOrEqualThanLimited(clouderaManagerRepoDetails::getVersion, CLOUDERAMANAGER_VERSION_7_1_0);\n     }\n \n+    public static boolean isRazConfigurationSupported(ClouderaManagerRepo clouderaManagerRepoDetails) {\n+        LOGGER.info(\"ClouderaManagerRepo is compared for Raz Ranger support\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d2e8b3ce70433c5aefe530c30ae6f6e63af92f1"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6d2e8b3ce70433c5aefe530c30ae6f6e63af92f1", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/6d2e8b3ce70433c5aefe530c30ae6f6e63af92f1", "committedDate": "2020-05-19T15:23:36Z", "message": "CB-6236 enable Ranger Raz on Azure in the datalake."}, "afterCommit": {"oid": "c14ff1475f59015d58d3c23974213dd87602715d", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/c14ff1475f59015d58d3c23974213dd87602715d", "committedDate": "2020-05-19T19:31:56Z", "message": "CB-6236 enable Ranger Raz on Azure in the datalake."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c14ff1475f59015d58d3c23974213dd87602715d", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/c14ff1475f59015d58d3c23974213dd87602715d", "committedDate": "2020-05-19T19:31:56Z", "message": "CB-6236 enable Ranger Raz on Azure in the datalake."}, "afterCommit": {"oid": "0e504d5adfba0750b3b7d3850212cb41d94f9732", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/0e504d5adfba0750b3b7d3850212cb41d94f9732", "committedDate": "2020-05-19T22:15:34Z", "message": "CB-6236 enable Ranger Raz on Azure in the datalake."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1NDA2MTA2", "url": "https://github.com/hortonworks/cloudbreak/pull/8097#pullrequestreview-415406106", "createdAt": "2020-05-20T14:39:00Z", "commit": {"oid": "0e504d5adfba0750b3b7d3850212cb41d94f9732"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1NDI5MTE0", "url": "https://github.com/hortonworks/cloudbreak/pull/8097#pullrequestreview-415429114", "createdAt": "2020-05-20T15:00:30Z", "commit": {"oid": "0e504d5adfba0750b3b7d3850212cb41d94f9732"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxNTowMDozMFrOGYQKXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxNTowMDozMFrOGYQKXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA4MzgwNw==", "bodyText": "if runtime not empty. In case of sdx-internal this field is missing", "url": "https://github.com/hortonworks/cloudbreak/pull/8097#discussion_r428083807", "createdAt": "2020-05-20T15:00:30Z", "author": {"login": "doktoric"}, "path": "datalake/src/main/java/com/sequenceiq/datalake/service/sdx/SdxService.java", "diffHunk": "@@ -413,6 +424,31 @@ private void validateCloudStorageRequest(SdxCloudStorageRequest cloudStorage, De\n         }\n     }\n \n+    private void validateRazEnablement(SdxClusterRequest sdxClusterRequest, DetailedEnvironmentResponse environment) {\n+        ValidationResultBuilder validationBuilder = new ValidationResultBuilder();\n+        if (sdxClusterRequest.isEnableRangerRaz())  {\n+            boolean razEntitlementEnabled = entitlementService.razEnabled(environment.getCreator(), Crn.safeFromString(environment.getCreator()).getAccountId());\n+            if (!razEntitlementEnabled) {\n+                validationBuilder.error(\"Provisioning Ranger Raz is not enabled for this account.\");\n+            }\n+            if (!AZURE.name().equalsIgnoreCase(environment.getCloudPlatform())) {\n+                validationBuilder.error(\"Provisioning Ranger Raz is only valid for Microsft Azure.\");\n+            }\n+            if (!isRazSupported(sdxClusterRequest.getRuntime())) {\n+                validationBuilder.error(\"Provisioning Ranger Raz is only valid for CM version > 7.2.0 and not \" + sdxClusterRequest.getRuntime());\n+            }\n+        }\n+        ValidationResult validationResult = validationBuilder.build();\n+        if (validationResult.hasError()) {\n+            throw new BadRequestException(validationResult.getFormattedErrors());\n+        }\n+    }\n+\n+    private boolean isRazSupported(String runtime) {\n+        Comparator<Versioned> versionComparator = new VersionComparator();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e504d5adfba0750b3b7d3850212cb41d94f9732"}, "originalPosition": 90}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0e504d5adfba0750b3b7d3850212cb41d94f9732", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/0e504d5adfba0750b3b7d3850212cb41d94f9732", "committedDate": "2020-05-19T22:15:34Z", "message": "CB-6236 enable Ranger Raz on Azure in the datalake."}, "afterCommit": {"oid": "df8502fdc7d901b23b64b9da3af0b2d660d174c6", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/df8502fdc7d901b23b64b9da3af0b2d660d174c6", "committedDate": "2020-05-20T15:33:33Z", "message": "CB-6236 enable Ranger Raz on Azure in the datalake."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1NTQ2MjA1", "url": "https://github.com/hortonworks/cloudbreak/pull/8097#pullrequestreview-415546205", "createdAt": "2020-05-20T17:10:23Z", "commit": {"oid": "df8502fdc7d901b23b64b9da3af0b2d660d174c6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxNzoxMDoyM1rOGYVtBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxNzoxMDoyM1rOGYVtBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODE3NDU5OA==", "bodyText": "The default value should be added separately as it will lock the table. See:\nhttps://github.com/hortonworks/cloudbreak/blob/master/core/src/main/resources/schema/app/20200504164000_CB-6897_improve_instance_metadata_with_instance_lifecycle.sql", "url": "https://github.com/hortonworks/cloudbreak/pull/8097#discussion_r428174598", "createdAt": "2020-05-20T17:10:23Z", "author": {"login": "keyki"}, "path": "core/src/main/resources/schema/app/20200518154332_CB-6236_enable_Ranger_Raz_service.sql", "diffHunk": "@@ -0,0 +1,11 @@\n+-- // CB-6236 enable Ranger Raz service.\n+-- Migration SQL that makes the change goes here.\n+\n+ALTER TABLE cluster ADD COLUMN IF NOT EXISTS ranger_raz_enabled boolean NOT NULL DEFAULT false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df8502fdc7d901b23b64b9da3af0b2d660d174c6"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "df8502fdc7d901b23b64b9da3af0b2d660d174c6", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/df8502fdc7d901b23b64b9da3af0b2d660d174c6", "committedDate": "2020-05-20T15:33:33Z", "message": "CB-6236 enable Ranger Raz on Azure in the datalake."}, "afterCommit": {"oid": "c9d7580b603b103252e97750f595466efd4f5bdd", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/c9d7580b603b103252e97750f595466efd4f5bdd", "committedDate": "2020-05-20T19:03:14Z", "message": "CB-6236 enable Ranger Raz on Azure in the datalake."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c9d7580b603b103252e97750f595466efd4f5bdd", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/c9d7580b603b103252e97750f595466efd4f5bdd", "committedDate": "2020-05-20T19:03:14Z", "message": "CB-6236 enable Ranger Raz on Azure in the datalake."}, "afterCommit": {"oid": "6a4e0763022ca548831dc3079ccdd0d7a37be382", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/6a4e0763022ca548831dc3079ccdd0d7a37be382", "committedDate": "2020-05-20T19:18:01Z", "message": "CB-6236 enable Ranger Raz on Azure in the datalake."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a04709441071729e4019c2c487f2f7f0c9ee5fd9", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/a04709441071729e4019c2c487f2f7f0c9ee5fd9", "committedDate": "2020-05-20T19:22:58Z", "message": "CB-6236 enable Ranger Raz on Azure in the datalake."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6a4e0763022ca548831dc3079ccdd0d7a37be382", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/6a4e0763022ca548831dc3079ccdd0d7a37be382", "committedDate": "2020-05-20T19:18:01Z", "message": "CB-6236 enable Ranger Raz on Azure in the datalake."}, "afterCommit": {"oid": "a04709441071729e4019c2c487f2f7f0c9ee5fd9", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/a04709441071729e4019c2c487f2f7f0c9ee5fd9", "committedDate": "2020-05-20T19:22:58Z", "message": "CB-6236 enable Ranger Raz on Azure in the datalake."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1852, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}