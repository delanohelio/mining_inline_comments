{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk4NDIxNjc1", "number": 9151, "title": "CB-9149. Splitting large (> 16K) JSON logs on CB level in order to av\u2026", "bodyText": "\u2026oid log rotation related issues by docker logging driver on K8s\ndetails:\n\nin order to avoid large messages use a 12K max message length for JSON based logging (12K can be safe as we have many other fields, not only message)\nsplit message into chunks based on the max chunk length\nadd partial metadata about the chunks, that can be handled by fluentd\nusing the same field names for partial metadata that is used by docker fluentd logging driver: partial_message, partial_id, partial_ordinal and partial_last\nrefactor: removed loggerFilterName from masking pattern layout\n\nSee detailed description in the commit message.\nadditional info:\nfluent logger for docker: https://github.com/moby/moby/blob/master/daemon/logger/fluentd/fluentd.go#L116\nall the keys are deleted by fluent-conat plugin if the events are merged, see:  https://github.com/fluent-plugins-nursery/fluent-plugin-concat/blob/master/lib/fluent/plugin/filter_concat.rb#L149\nif this is deployed, it will split json logs, so until fluent-concat plugin config is not updated, the logs will be in splitted in kibana (!! but you can find those based on the component names)", "createdAt": "2020-10-06T10:06:46Z", "url": "https://github.com/hortonworks/cloudbreak/pull/9151", "merged": true, "mergeCommit": {"oid": "d0aad2df5a8f23fb503c26f3a541154e7e60475d"}, "closed": true, "closedAt": "2020-10-12T08:45:21Z", "author": {"login": "oleewere"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdP16MjABqjM4NDQ2OTI4MTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdRbHnPABqjM4NjM0Njg3NDA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "646292292e1755189a4e5c167f7c37752ff0f2d1", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/646292292e1755189a4e5c167f7c37752ff0f2d1", "committedDate": "2020-10-06T10:04:40Z", "message": "CB-9149. Splitting large (> 16K) JSON logs on CB level in order to avoid log rotation related issues by docker logging driver on K8s\ndetails:\n- in order to avoid large messages use a 12K max message length for JSON based logging (12K can be safe as we have many other fields, not only message)\n- split message into chunks based on the max chunk length\n- add partial metadata about the chunks, that can be handled by fluentd\n- using the same field names for partial metadata that is used by docker fluentd logging driver: partial_message, partial_id, partial_ordinal and partial_last"}, "afterCommit": {"oid": "76bda607c5980805763a09b9cf1e80dca813077d", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/76bda607c5980805763a09b9cf1e80dca813077d", "committedDate": "2020-10-06T10:34:11Z", "message": "CB-9149. Splitting large (> 16K) JSON logs on CB level in order to avoid log rotation related issues by docker logging driver on K8s\ndetails:\n- in order to avoid large messages use a 12K max message length for JSON based logging (12K can be safe as we have many other fields, not only message)\n- split message into chunks based on the max chunk length\n- add partial metadata about the chunks, that can be handled by fluentd\n- using the same field names for partial metadata that is used by docker fluentd logging driver: partial_message, partial_id, partial_ordinal and partial_last\n- added some basic UTs for custom json layout"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzNjI3MTEw", "url": "https://github.com/hortonworks/cloudbreak/pull/9151#pullrequestreview-503627110", "createdAt": "2020-10-07T08:11:49Z", "commit": {"oid": "76bda607c5980805763a09b9cf1e80dca813077d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwODoxMTo0OVrOHdnnTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwODozMjozNlrOHdobbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgxOTc4OA==", "bodyText": "Is there any reason why we are not using the @value annotation of Spring like in all the other property holder components?", "url": "https://github.com/hortonworks/cloudbreak/pull/9151#discussion_r500819788", "createdAt": "2020-10-07T08:11:49Z", "author": {"login": "biharitomi"}, "path": "common/src/main/java/com/sequenceiq/cloudbreak/logger/PropertyHelper.java", "diffHunk": "@@ -0,0 +1,31 @@\n+package com.sequenceiq.cloudbreak.logger;\n+\n+import org.apache.commons.lang3.StringUtils;\n+\n+public class PropertyHelper {\n+\n+    private PropertyHelper() {\n+    }\n+\n+    public static Boolean isJsonFormatEnabled() {\n+        return Boolean.parseBoolean(getProperty(\"logger.format.json.enabled\", null));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76bda607c5980805763a09b9cf1e80dca813077d"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgyMTE0NA==", "bodyText": "I would rename it to indicates that this class holds the logger related configurations that comes either from property or not. For example LoggerConfiguration.java", "url": "https://github.com/hortonworks/cloudbreak/pull/9151#discussion_r500821144", "createdAt": "2020-10-07T08:13:53Z", "author": {"login": "biharitomi"}, "path": "common/src/main/java/com/sequenceiq/cloudbreak/logger/PropertyHelper.java", "diffHunk": "@@ -0,0 +1,31 @@\n+package com.sequenceiq.cloudbreak.logger;\n+\n+import org.apache.commons.lang3.StringUtils;\n+\n+public class PropertyHelper {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76bda607c5980805763a09b9cf1e80dca813077d"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgzMzEzMw==", "bodyText": "Would you mind to create tests based on the size message bigger than the 12KB limit or not?", "url": "https://github.com/hortonworks/cloudbreak/pull/9151#discussion_r500833133", "createdAt": "2020-10-07T08:32:36Z", "author": {"login": "biharitomi"}, "path": "common/src/test/java/com/sequenceiq/cloudbreak/logger/format/CustomJsonLayoutTest.java", "diffHunk": "@@ -0,0 +1,33 @@\n+package com.sequenceiq.cloudbreak.logger.format;\n+\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertTrue;\n+\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import ch.qos.logback.classic.spi.LoggingEvent;\n+\n+public class CustomJsonLayoutTest {\n+\n+    private CustomJsonLayout underTest;\n+\n+    @Before\n+    public void setUp() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76bda607c5980805763a09b9cf1e80dca813077d"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzNjg1MDg4", "url": "https://github.com/hortonworks/cloudbreak/pull/9151#pullrequestreview-503685088", "createdAt": "2020-10-07T09:20:45Z", "commit": {"oid": "76bda607c5980805763a09b9cf1e80dca813077d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwOToyMDo0NVrOHdqUwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwOTozNzowNlrOHdq9Dg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDg2NDE5NA==", "bodyText": "this Splitter.fixedLength(this.maxChunkLength) could be initiated in the constructor", "url": "https://github.com/hortonworks/cloudbreak/pull/9151#discussion_r500864194", "createdAt": "2020-10-07T09:20:45Z", "author": {"login": "lacikaaa"}, "path": "common/src/main/java/com/sequenceiq/cloudbreak/logger/format/CustomJsonLayout.java", "diffHunk": "@@ -1,29 +1,65 @@\n package com.sequenceiq.cloudbreak.logger.format;\n \n+import java.util.Iterator;\n import java.util.LinkedHashMap;\n import java.util.Map;\n \n+import org.apache.commons.lang3.StringUtils;\n+\n+import com.google.common.base.Splitter;\n+import com.sequenceiq.cloudbreak.logger.PartialMessageMetadata;\n+\n import ch.qos.logback.classic.spi.ILoggingEvent;\n import ch.qos.logback.contrib.json.classic.JsonLayout;\n import ch.qos.logback.core.CoreConstants;\n \n public class CustomJsonLayout extends JsonLayout {\n \n+    private static final String PARTIAL_MESSAGE_FIELD = \"partial_message\";\n+\n+    private static final String PARTIAL_CHUNK_ID_FIELD = \"partial_id\";\n+\n+    private static final String PARTIAL_CHUNK_INDEX_FIELD = \"partial_ordinal\";\n+\n+    private static final String PARTIAL_LAST_FIELD = \"partial_last\";\n+\n+    private static final String PARTIAL_MESSAGE_FLAG = \"true\";\n+\n     private final String contextName;\n \n-    CustomJsonLayout(String contextName) {\n+    private final Integer maxChunkLength;\n+\n+    CustomJsonLayout(String contextName, Integer maxChunkLength) {\n         this.contextName = contextName;\n+        this.maxChunkLength = maxChunkLength;\n     }\n \n     public String doLayout(ILoggingEvent event, String fullLogMessage, String loggerNameFilter) {\n-        Map map = toJsonMap(event, fullLogMessage, loggerNameFilter);\n-        if (map == null || map.isEmpty()) {\n+        if (StringUtils.length(fullLogMessage) > this.maxChunkLength) {\n+            StringBuilder stringBuilder = new StringBuilder();\n+            String chunkId = Integer.toHexString(event.hashCode());\n+            Iterable<String> messages = Splitter.fixedLength(this.maxChunkLength).split(fullLogMessage);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76bda607c5980805763a09b9cf1e80dca813077d"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDg2NDUwNA==", "bodyText": "this. is unnecessary", "url": "https://github.com/hortonworks/cloudbreak/pull/9151#discussion_r500864504", "createdAt": "2020-10-07T09:21:18Z", "author": {"login": "lacikaaa"}, "path": "common/src/main/java/com/sequenceiq/cloudbreak/logger/format/CustomJsonLayout.java", "diffHunk": "@@ -1,29 +1,65 @@\n package com.sequenceiq.cloudbreak.logger.format;\n \n+import java.util.Iterator;\n import java.util.LinkedHashMap;\n import java.util.Map;\n \n+import org.apache.commons.lang3.StringUtils;\n+\n+import com.google.common.base.Splitter;\n+import com.sequenceiq.cloudbreak.logger.PartialMessageMetadata;\n+\n import ch.qos.logback.classic.spi.ILoggingEvent;\n import ch.qos.logback.contrib.json.classic.JsonLayout;\n import ch.qos.logback.core.CoreConstants;\n \n public class CustomJsonLayout extends JsonLayout {\n \n+    private static final String PARTIAL_MESSAGE_FIELD = \"partial_message\";\n+\n+    private static final String PARTIAL_CHUNK_ID_FIELD = \"partial_id\";\n+\n+    private static final String PARTIAL_CHUNK_INDEX_FIELD = \"partial_ordinal\";\n+\n+    private static final String PARTIAL_LAST_FIELD = \"partial_last\";\n+\n+    private static final String PARTIAL_MESSAGE_FLAG = \"true\";\n+\n     private final String contextName;\n \n-    CustomJsonLayout(String contextName) {\n+    private final Integer maxChunkLength;\n+\n+    CustomJsonLayout(String contextName, Integer maxChunkLength) {\n         this.contextName = contextName;\n+        this.maxChunkLength = maxChunkLength;\n     }\n \n     public String doLayout(ILoggingEvent event, String fullLogMessage, String loggerNameFilter) {\n-        Map map = toJsonMap(event, fullLogMessage, loggerNameFilter);\n-        if (map == null || map.isEmpty()) {\n+        if (StringUtils.length(fullLogMessage) > this.maxChunkLength) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76bda607c5980805763a09b9cf1e80dca813077d"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDg2NzUyNw==", "bodyText": "you can save one line here with:\nfor (int currentIndex = 0; messageIterator.hasNext(); currentIndex++) {", "url": "https://github.com/hortonworks/cloudbreak/pull/9151#discussion_r500867527", "createdAt": "2020-10-07T09:25:58Z", "author": {"login": "lacikaaa"}, "path": "common/src/main/java/com/sequenceiq/cloudbreak/logger/format/CustomJsonLayout.java", "diffHunk": "@@ -1,29 +1,65 @@\n package com.sequenceiq.cloudbreak.logger.format;\n \n+import java.util.Iterator;\n import java.util.LinkedHashMap;\n import java.util.Map;\n \n+import org.apache.commons.lang3.StringUtils;\n+\n+import com.google.common.base.Splitter;\n+import com.sequenceiq.cloudbreak.logger.PartialMessageMetadata;\n+\n import ch.qos.logback.classic.spi.ILoggingEvent;\n import ch.qos.logback.contrib.json.classic.JsonLayout;\n import ch.qos.logback.core.CoreConstants;\n \n public class CustomJsonLayout extends JsonLayout {\n \n+    private static final String PARTIAL_MESSAGE_FIELD = \"partial_message\";\n+\n+    private static final String PARTIAL_CHUNK_ID_FIELD = \"partial_id\";\n+\n+    private static final String PARTIAL_CHUNK_INDEX_FIELD = \"partial_ordinal\";\n+\n+    private static final String PARTIAL_LAST_FIELD = \"partial_last\";\n+\n+    private static final String PARTIAL_MESSAGE_FLAG = \"true\";\n+\n     private final String contextName;\n \n-    CustomJsonLayout(String contextName) {\n+    private final Integer maxChunkLength;\n+\n+    CustomJsonLayout(String contextName, Integer maxChunkLength) {\n         this.contextName = contextName;\n+        this.maxChunkLength = maxChunkLength;\n     }\n \n     public String doLayout(ILoggingEvent event, String fullLogMessage, String loggerNameFilter) {\n-        Map map = toJsonMap(event, fullLogMessage, loggerNameFilter);\n-        if (map == null || map.isEmpty()) {\n+        if (StringUtils.length(fullLogMessage) > this.maxChunkLength) {\n+            StringBuilder stringBuilder = new StringBuilder();\n+            String chunkId = Integer.toHexString(event.hashCode());\n+            Iterable<String> messages = Splitter.fixedLength(this.maxChunkLength).split(fullLogMessage);\n+            int currentIndex = 0;\n+            Iterator<String> messageIterator = messages.iterator();\n+            while (messageIterator.hasNext()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76bda607c5980805763a09b9cf1e80dca813077d"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDg3MjQ3Mg==", "bodyText": "loggerNameFilter is not used\nmethod definition should look like: private Map<String, Object> toJsonMap\n\ntoJsonRecordString and toJsonString parameter is also missing the same", "url": "https://github.com/hortonworks/cloudbreak/pull/9151#discussion_r500872472", "createdAt": "2020-10-07T09:33:52Z", "author": {"login": "lacikaaa"}, "path": "common/src/main/java/com/sequenceiq/cloudbreak/logger/format/CustomJsonLayout.java", "diffHunk": "@@ -1,29 +1,65 @@\n package com.sequenceiq.cloudbreak.logger.format;\n \n+import java.util.Iterator;\n import java.util.LinkedHashMap;\n import java.util.Map;\n \n+import org.apache.commons.lang3.StringUtils;\n+\n+import com.google.common.base.Splitter;\n+import com.sequenceiq.cloudbreak.logger.PartialMessageMetadata;\n+\n import ch.qos.logback.classic.spi.ILoggingEvent;\n import ch.qos.logback.contrib.json.classic.JsonLayout;\n import ch.qos.logback.core.CoreConstants;\n \n public class CustomJsonLayout extends JsonLayout {\n \n+    private static final String PARTIAL_MESSAGE_FIELD = \"partial_message\";\n+\n+    private static final String PARTIAL_CHUNK_ID_FIELD = \"partial_id\";\n+\n+    private static final String PARTIAL_CHUNK_INDEX_FIELD = \"partial_ordinal\";\n+\n+    private static final String PARTIAL_LAST_FIELD = \"partial_last\";\n+\n+    private static final String PARTIAL_MESSAGE_FLAG = \"true\";\n+\n     private final String contextName;\n \n-    CustomJsonLayout(String contextName) {\n+    private final Integer maxChunkLength;\n+\n+    CustomJsonLayout(String contextName, Integer maxChunkLength) {\n         this.contextName = contextName;\n+        this.maxChunkLength = maxChunkLength;\n     }\n \n     public String doLayout(ILoggingEvent event, String fullLogMessage, String loggerNameFilter) {\n-        Map map = toJsonMap(event, fullLogMessage, loggerNameFilter);\n-        if (map == null || map.isEmpty()) {\n+        if (StringUtils.length(fullLogMessage) > this.maxChunkLength) {\n+            StringBuilder stringBuilder = new StringBuilder();\n+            String chunkId = Integer.toHexString(event.hashCode());\n+            Iterable<String> messages = Splitter.fixedLength(this.maxChunkLength).split(fullLogMessage);\n+            int currentIndex = 0;\n+            Iterator<String> messageIterator = messages.iterator();\n+            while (messageIterator.hasNext()) {\n+                String message = messageIterator.next();\n+                PartialMessageMetadata partialMessageMetadata = new PartialMessageMetadata(chunkId, currentIndex, !messageIterator.hasNext());\n+                stringBuilder.append(toJsonRecordString(toJsonMap(event, message, loggerNameFilter, partialMessageMetadata)));\n+            }\n+            return stringBuilder.toString();\n+        } else {\n+            return toJsonRecordString(toJsonMap(event, fullLogMessage, loggerNameFilter, null));\n+        }\n+    }\n+\n+    private String toJsonRecordString(Map map) {\n+        if (map.isEmpty()) {\n             return null;\n         }\n         return toJsonString(map) + CoreConstants.LINE_SEPARATOR;\n     }\n \n-    private Map toJsonMap(ILoggingEvent event, String fullLogMessage, String loggerNameFilter) {\n+    private Map toJsonMap(ILoggingEvent event, String fullLogMessage, String loggerNameFilter, PartialMessageMetadata partialMessageMetadata) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76bda607c5980805763a09b9cf1e80dca813077d"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDg3NDUxMA==", "bodyText": "this. can be removed", "url": "https://github.com/hortonworks/cloudbreak/pull/9151#discussion_r500874510", "createdAt": "2020-10-07T09:37:06Z", "author": {"login": "lacikaaa"}, "path": "common/src/main/java/com/sequenceiq/cloudbreak/logger/format/JsonLayoutFormat.java", "diffHunk": "@@ -10,8 +10,8 @@\n \n     private final CustomJsonLayout jsonLayout;\n \n-    JsonLayoutFormat(String contextName) {\n-        this.jsonLayout = new CustomJsonLayout(contextName);\n+    JsonLayoutFormat(String contextName, Integer maxChunkLength) {\n+        this.jsonLayout = new CustomJsonLayout(contextName, maxChunkLength);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76bda607c5980805763a09b9cf1e80dca813077d"}, "originalPosition": 7}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "76bda607c5980805763a09b9cf1e80dca813077d", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/76bda607c5980805763a09b9cf1e80dca813077d", "committedDate": "2020-10-06T10:34:11Z", "message": "CB-9149. Splitting large (> 16K) JSON logs on CB level in order to avoid log rotation related issues by docker logging driver on K8s\ndetails:\n- in order to avoid large messages use a 12K max message length for JSON based logging (12K can be safe as we have many other fields, not only message)\n- split message into chunks based on the max chunk length\n- add partial metadata about the chunks, that can be handled by fluentd\n- using the same field names for partial metadata that is used by docker fluentd logging driver: partial_message, partial_id, partial_ordinal and partial_last\n- added some basic UTs for custom json layout"}, "afterCommit": {"oid": "eee008047453663df542c2d10b9bb018561ee3aa", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/eee008047453663df542c2d10b9bb018561ee3aa", "committedDate": "2020-10-07T17:18:42Z", "message": "CB-9149. Splitting large (> 16K) JSON logs on CB level in order to avoid log rotation related issues by docker logging driver on K8s\ndetails:\n- in order to avoid large messages use a 12K max message length for JSON based logging (12K can be safe as we have many other fields, not only message)\n- split message into chunks based on the max chunk length\n- add partial metadata about the chunks, that can be handled by fluentd\n- using the same field names for partial metadata that is used by docker fluentd logging driver: partial_message, partial_id, partial_ordinal and partial_last\n- added some basic UTs for custom json layout\n- cleaning up loggerNameFilter from masking pattern layout (not deleting that yet)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eee008047453663df542c2d10b9bb018561ee3aa", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/eee008047453663df542c2d10b9bb018561ee3aa", "committedDate": "2020-10-07T17:18:42Z", "message": "CB-9149. Splitting large (> 16K) JSON logs on CB level in order to avoid log rotation related issues by docker logging driver on K8s\ndetails:\n- in order to avoid large messages use a 12K max message length for JSON based logging (12K can be safe as we have many other fields, not only message)\n- split message into chunks based on the max chunk length\n- add partial metadata about the chunks, that can be handled by fluentd\n- using the same field names for partial metadata that is used by docker fluentd logging driver: partial_message, partial_id, partial_ordinal and partial_last\n- added some basic UTs for custom json layout\n- cleaning up loggerNameFilter from masking pattern layout (not deleting that yet)"}, "afterCommit": {"oid": "ed19623361d57d4e5f03fdfedd82ca26a2fe9add", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/ed19623361d57d4e5f03fdfedd82ca26a2fe9add", "committedDate": "2020-10-07T17:24:58Z", "message": "CB-9149. Splitting large (> 16K) JSON logs on CB level in order to avoid log rotation related issues by docker logging driver on K8s\ndetails:\n- in order to avoid large messages use a 12K max message length for JSON based logging (12K can be safe as we have many other fields, not only message)\n- split message into chunks based on the max chunk length\n- add partial metadata about the chunks, that can be handled by fluentd\n- using the same field names for partial metadata that is used by docker fluentd logging driver: partial_message, partial_id, partial_ordinal and partial_last\n- added some basic UTs for custom json layout\n- cleaning up loggerNameFilter from masking pattern layout (not deleting that yet)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NDcxNTI1", "url": "https://github.com/hortonworks/cloudbreak/pull/9151#pullrequestreview-504471525", "createdAt": "2020-10-08T06:46:55Z", "commit": {"oid": "ed19623361d57d4e5f03fdfedd82ca26a2fe9add"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwNjo0Njo1NVrOHeQJJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwNjo0Njo1NVrOHeQJJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQ4MzgxMw==", "bodyText": "I don't really get this. so there are 3 properties above, you wrote them with lowercase and dot separated and right after you convert them. wouldn't be it easier just to have them written the way we expect them?", "url": "https://github.com/hortonworks/cloudbreak/pull/9151#discussion_r501483813", "createdAt": "2020-10-08T06:46:55Z", "author": {"login": "lacikaaa"}, "path": "common/src/main/java/com/sequenceiq/cloudbreak/logger/LoggerConfiguration.java", "diffHunk": "@@ -0,0 +1,31 @@\n+package com.sequenceiq.cloudbreak.logger;\n+\n+import org.apache.commons.lang3.StringUtils;\n+\n+public class LoggerConfiguration {\n+\n+    private LoggerConfiguration() {\n+    }\n+\n+    public static Boolean isJsonFormatEnabled() {\n+        return Boolean.parseBoolean(getProperty(\"logger.format.json.enabled\", null));\n+    }\n+\n+    public static String getJsonFormatMdcName() {\n+        return getProperty(\"logger.format.json.mdc.name\", \"context\");\n+    }\n+\n+    public static Integer getSplitterMaxChunLength() {\n+        return Integer.parseInt(getProperty(\"logger.appender.splitter.max.chunk.length\", \"12000\"));\n+    }\n+\n+    private static String getProperty(String property, String defaultValue) {\n+        String envProperty = property.toUpperCase().replace(\".\", \"_\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed19623361d57d4e5f03fdfedd82ca26a2fe9add"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NDcyNzEw", "url": "https://github.com/hortonworks/cloudbreak/pull/9151#pullrequestreview-504472710", "createdAt": "2020-10-08T06:49:04Z", "commit": {"oid": "ed19623361d57d4e5f03fdfedd82ca26a2fe9add"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NzMxODYy", "url": "https://github.com/hortonworks/cloudbreak/pull/9151#pullrequestreview-504731862", "createdAt": "2020-10-08T12:32:40Z", "commit": {"oid": "ed19623361d57d4e5f03fdfedd82ca26a2fe9add"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f00d3dd71a139bbbfd75185fe044be745d07eb31", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/f00d3dd71a139bbbfd75185fe044be745d07eb31", "committedDate": "2020-10-11T08:29:12Z", "message": "CB-9149. Splitting large (> 16K) JSON logs on CB level in order to avoid log rotation related issues by docker logging driver on K8s\ndetails:\n- in order to avoid large messages use a 12K max message length for JSON based logging (12K can be safe as we have many other fields, not only message)\n- split message into chunks based on the max chunk length\n- add partial metadata about the chunks, that can be handled by fluentd\n- using the same field names for partial metadata that is used by docker fluentd logging driver: partial_message, partial_id, partial_ordinal and partial_last\n- added some basic UTs for custom json layout\n- cleaning up loggerNameFilter from masking pattern layout (not deleting that yet)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ed19623361d57d4e5f03fdfedd82ca26a2fe9add", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/ed19623361d57d4e5f03fdfedd82ca26a2fe9add", "committedDate": "2020-10-07T17:24:58Z", "message": "CB-9149. Splitting large (> 16K) JSON logs on CB level in order to avoid log rotation related issues by docker logging driver on K8s\ndetails:\n- in order to avoid large messages use a 12K max message length for JSON based logging (12K can be safe as we have many other fields, not only message)\n- split message into chunks based on the max chunk length\n- add partial metadata about the chunks, that can be handled by fluentd\n- using the same field names for partial metadata that is used by docker fluentd logging driver: partial_message, partial_id, partial_ordinal and partial_last\n- added some basic UTs for custom json layout\n- cleaning up loggerNameFilter from masking pattern layout (not deleting that yet)"}, "afterCommit": {"oid": "f00d3dd71a139bbbfd75185fe044be745d07eb31", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/f00d3dd71a139bbbfd75185fe044be745d07eb31", "committedDate": "2020-10-11T08:29:12Z", "message": "CB-9149. Splitting large (> 16K) JSON logs on CB level in order to avoid log rotation related issues by docker logging driver on K8s\ndetails:\n- in order to avoid large messages use a 12K max message length for JSON based logging (12K can be safe as we have many other fields, not only message)\n- split message into chunks based on the max chunk length\n- add partial metadata about the chunks, that can be handled by fluentd\n- using the same field names for partial metadata that is used by docker fluentd logging driver: partial_message, partial_id, partial_ordinal and partial_last\n- added some basic UTs for custom json layout\n- cleaning up loggerNameFilter from masking pattern layout (not deleting that yet)"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2107, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}