{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMyNjg1MDIw", "number": 9578, "title": "CB-9900 Determine if Subnet is Private or Public for Load Balancer.", "bodyText": "This deterines based on the subnet's route tables if there is an internet\ngateway attached to it making it either a private or public load balancer.\nSee detailed description in the commit message.", "createdAt": "2020-12-04T17:42:58Z", "url": "https://github.com/hortonworks/cloudbreak/pull/9578", "merged": true, "mergeCommit": {"oid": "9b58e641b2f631f279bbae3e9e30f5cbf105da9d"}, "closed": true, "closedAt": "2020-12-10T19:12:58Z", "author": {"login": "frozenwizard"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdi_SjugFqTU0NTMzNDE1OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdk2lbkAFqTU0OTQyMjkzOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1MzM0MTU5", "url": "https://github.com/hortonworks/cloudbreak/pull/9578#pullrequestreview-545334159", "createdAt": "2020-12-04T22:14:57Z", "commit": {"oid": "8f5964bf50dfa77ba7367a430b0249c3591a24ef"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1NjAwNjA4", "url": "https://github.com/hortonworks/cloudbreak/pull/9578#pullrequestreview-545600608", "createdAt": "2020-12-05T16:50:38Z", "commit": {"oid": "8f5964bf50dfa77ba7367a430b0249c3591a24ef"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNVQxNjo1MDozOVrOH_8-zQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNVQxNzo0Mjo0NlrOH_9e1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjgyMTQ1Mw==", "bodyText": "\"subnetId\" constanst is already present in AwsNetworkView or CloudInstance. I think you should use one of them.", "url": "https://github.com/hortonworks/cloudbreak/pull/9578#discussion_r536821453", "createdAt": "2020-12-05T16:50:39Z", "author": {"login": "lacikaaa"}, "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/connector/resource/AwsLaunchService.java", "diffHunk": "@@ -249,10 +254,16 @@ private void updateCloudformationWithLoadBalancers(AuthenticatedContext ac, Clou\n         }\n     }\n \n-    private AwsLoadBalancer convert(CloudLoadBalancer cloudLoadBalancer, CloudStack stack, List<CloudResource> instances) {\n+    private AwsLoadBalancer convert(CloudLoadBalancer cloudLoadBalancer, CloudStack stack,\n+            List<CloudResource> instances, Network network, AmazonEC2Client amazonEC2Client) {\n+\n+        String subnetId = network.getStringParameter(\"subnetId\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f5964bf50dfa77ba7367a430b0249c3591a24ef"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjgyMTU2Nw==", "bodyText": "CloudStack stack parameter is not used and after removing parameters should fit into one line", "url": "https://github.com/hortonworks/cloudbreak/pull/9578#discussion_r536821567", "createdAt": "2020-12-05T16:51:20Z", "author": {"login": "lacikaaa"}, "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/connector/resource/AwsLaunchService.java", "diffHunk": "@@ -249,10 +254,16 @@ private void updateCloudformationWithLoadBalancers(AuthenticatedContext ac, Clou\n         }\n     }\n \n-    private AwsLoadBalancer convert(CloudLoadBalancer cloudLoadBalancer, CloudStack stack, List<CloudResource> instances) {\n+    private AwsLoadBalancer convert(CloudLoadBalancer cloudLoadBalancer, CloudStack stack,\n+            List<CloudResource> instances, Network network, AmazonEC2Client amazonEC2Client) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f5964bf50dfa77ba7367a430b0249c3591a24ef"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjgyODY2MQ==", "bodyText": "actually, we have AwsNetworkView in the caller method, so if you pass it as an argument, or just the subnetId itself as the network is not used for anything else you could omit this part", "url": "https://github.com/hortonworks/cloudbreak/pull/9578#discussion_r536828661", "createdAt": "2020-12-05T17:36:39Z", "author": {"login": "lacikaaa"}, "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/connector/resource/AwsLaunchService.java", "diffHunk": "@@ -249,10 +254,16 @@ private void updateCloudformationWithLoadBalancers(AuthenticatedContext ac, Clou\n         }\n     }\n \n-    private AwsLoadBalancer convert(CloudLoadBalancer cloudLoadBalancer, CloudStack stack, List<CloudResource> instances) {\n+    private AwsLoadBalancer convert(CloudLoadBalancer cloudLoadBalancer, CloudStack stack,\n+            List<CloudResource> instances, Network network, AmazonEC2Client amazonEC2Client) {\n+\n+        String subnetId = network.getStringParameter(\"subnetId\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjgyMTQ1Mw=="}, "originalCommit": {"oid": "8f5964bf50dfa77ba7367a430b0249c3591a24ef"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjgyOTY1Mg==", "bodyText": "this scheme creation could be in a separate method", "url": "https://github.com/hortonworks/cloudbreak/pull/9578#discussion_r536829652", "createdAt": "2020-12-05T17:42:46Z", "author": {"login": "lacikaaa"}, "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/connector/resource/AwsLaunchService.java", "diffHunk": "@@ -249,10 +254,16 @@ private void updateCloudformationWithLoadBalancers(AuthenticatedContext ac, Clou\n         }\n     }\n \n-    private AwsLoadBalancer convert(CloudLoadBalancer cloudLoadBalancer, CloudStack stack, List<CloudResource> instances) {\n+    private AwsLoadBalancer convert(CloudLoadBalancer cloudLoadBalancer, CloudStack stack,\n+            List<CloudResource> instances, Network network, AmazonEC2Client amazonEC2Client) {\n+\n+        String subnetId = network.getStringParameter(\"subnetId\");\n+        DescribeRouteTablesResult describeRouteTablesResult = amazonEC2Client.describeRouteTables();\n+        AwsLoadBalancerScheme scheme = awsSubnetIgwExplorer.hasInternetGatewayOfSubnet(describeRouteTablesResult, subnetId)\n+                ? AwsLoadBalancerScheme.PUBLIC : AwsLoadBalancerScheme.PRIVATE;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f5964bf50dfa77ba7367a430b0249c3591a24ef"}, "originalPosition": 45}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8f5964bf50dfa77ba7367a430b0249c3591a24ef", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/8f5964bf50dfa77ba7367a430b0249c3591a24ef", "committedDate": "2020-12-04T17:41:07Z", "message": "CB-9900 Determine if Subnet is Private or Public for Load Balancer.\n\nThis deterines based on the subnet's route tables if there is an internet\ngateway attached to it making it either a private or public load balancer."}, "afterCommit": {"oid": "6dad38172340ae4c53caea878bc707ad565dfb2e", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/6dad38172340ae4c53caea878bc707ad565dfb2e", "committedDate": "2020-12-08T18:24:09Z", "message": "CB-9900 Determine if Subnet is Private or Public for Load Balancer.\n\nThis deterines based on the subnet's route tables if there is an internet\ngateway attached to it making it either a private or public load balancer."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5MDgzNzQ1", "url": "https://github.com/hortonworks/cloudbreak/pull/9578#pullrequestreview-549083745", "createdAt": "2020-12-10T11:03:16Z", "commit": {"oid": "6dad38172340ae4c53caea878bc707ad565dfb2e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQxMTowMzoxNlrOIDDrEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQxMTowMzoxNlrOIDDrEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDA3NjgxNw==", "bodyText": "are we sure it's not a subnet list here? shall we validate?", "url": "https://github.com/hortonworks/cloudbreak/pull/9578#discussion_r540076817", "createdAt": "2020-12-10T11:03:16Z", "author": {"login": "lacikaaa"}, "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/connector/resource/AwsLaunchService.java", "diffHunk": "@@ -249,10 +254,19 @@ private void updateCloudformationWithLoadBalancers(AuthenticatedContext ac, Clou\n         }\n     }\n \n-    private AwsLoadBalancer convert(CloudLoadBalancer cloudLoadBalancer, CloudStack stack, List<CloudResource> instances) {\n+    private AwsLoadBalancerScheme determinePublicVsPrivateSchema(AwsNetworkView awsNetworkView, AmazonEC2Client amazonEC2Client) {\n+        String subnetId = awsNetworkView.getExistingSubnet();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6dad38172340ae4c53caea878bc707ad565dfb2e"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5MDg0MDQy", "url": "https://github.com/hortonworks/cloudbreak/pull/9578#pullrequestreview-549084042", "createdAt": "2020-12-10T11:03:40Z", "commit": {"oid": "6dad38172340ae4c53caea878bc707ad565dfb2e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQxMTowMzo0MVrOIDDsBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQxMTowMzo0MVrOIDDsBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDA3NzA2Mw==", "bodyText": "could you give it a better name?", "url": "https://github.com/hortonworks/cloudbreak/pull/9578#discussion_r540077063", "createdAt": "2020-12-10T11:03:41Z", "author": {"login": "lacikaaa"}, "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/connector/resource/AwsLaunchService.java", "diffHunk": "@@ -249,10 +254,19 @@ private void updateCloudformationWithLoadBalancers(AuthenticatedContext ac, Clou\n         }\n     }\n \n-    private AwsLoadBalancer convert(CloudLoadBalancer cloudLoadBalancer, CloudStack stack, List<CloudResource> instances) {\n+    private AwsLoadBalancerScheme determinePublicVsPrivateSchema(AwsNetworkView awsNetworkView, AmazonEC2Client amazonEC2Client) {\n+        String subnetId = awsNetworkView.getExistingSubnet();\n+        DescribeRouteTablesResult describeRouteTablesResult = amazonEC2Client.describeRouteTables();\n+        return awsSubnetIgwExplorer.hasInternetGatewayOfSubnet(describeRouteTablesResult, subnetId)\n+                ? AwsLoadBalancerScheme.PUBLIC : AwsLoadBalancerScheme.PRIVATE;\n+    }\n+\n+    private AwsLoadBalancer convert(CloudLoadBalancer cloudLoadBalancer, List<CloudResource> instances,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6dad38172340ae4c53caea878bc707ad565dfb2e"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8bc04140baf37c4ebabe2972436756fd2ff846f", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/c8bc04140baf37c4ebabe2972436756fd2ff846f", "committedDate": "2020-12-10T17:09:43Z", "message": "CB-9900 Determine if Subnet is Private or Public for Load Balancer.\n\nThis deterines based on the subnet's route tables if there is an internet\ngateway attached to it making it either a private or public load balancer."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6dad38172340ae4c53caea878bc707ad565dfb2e", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/6dad38172340ae4c53caea878bc707ad565dfb2e", "committedDate": "2020-12-08T18:24:09Z", "message": "CB-9900 Determine if Subnet is Private or Public for Load Balancer.\n\nThis deterines based on the subnet's route tables if there is an internet\ngateway attached to it making it either a private or public load balancer."}, "afterCommit": {"oid": "c8bc04140baf37c4ebabe2972436756fd2ff846f", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/c8bc04140baf37c4ebabe2972436756fd2ff846f", "committedDate": "2020-12-10T17:09:43Z", "message": "CB-9900 Determine if Subnet is Private or Public for Load Balancer.\n\nThis deterines based on the subnet's route tables if there is an internet\ngateway attached to it making it either a private or public load balancer."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5NDIyOTM4", "url": "https://github.com/hortonworks/cloudbreak/pull/9578#pullrequestreview-549422938", "createdAt": "2020-12-10T17:14:16Z", "commit": {"oid": "c8bc04140baf37c4ebabe2972436756fd2ff846f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1934, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}