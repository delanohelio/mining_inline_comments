{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI4MTczODE5", "number": 9531, "title": "CB-9981 Add retry to FreeIPA healthcheck", "bodyText": "Unfortunately CCM is not stable and can cause random momentary network\noutage. If this happens during health check it would render FreeIPA\nunreachable/unusable for 3 minutes, until the next sync.\nTo handle this more gracefully this commit adds @Retryable to the\ncall which invokes FreeIPA API in FreeIpaHealthDetailsService.\nBy default it will try 3 times with 1 sec delay which should be\nenough for CCM to recover and fails fast enough to avoid congestion in\nquartz thread pool.", "createdAt": "2020-11-26T16:20:58Z", "url": "https://github.com/hortonworks/cloudbreak/pull/9531", "merged": true, "mergeCommit": {"oid": "5d18475be4d9f528c821ff6024116cf3a22c92e3"}, "closed": true, "closedAt": "2020-12-01T13:45:53Z", "author": {"login": "lacikaaa"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdgVUI-gH2gAyNTI4MTczODE5OmJkYmYxODkxYjUzOWVlMDNmOTZkMmY0NWExNzJhYzRjYTQ2MzNjYWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdh6JPBgFqTU0MTkwMzA2MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bdbf1891b539ee03f96d2f45a172ac4ca4633cac", "author": {"user": {"login": "lacikaaa", "name": "Mihaly Laszlo Molnar"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/bdbf1891b539ee03f96d2f45a172ac4ca4633cac", "committedDate": "2020-11-26T16:12:49Z", "message": "CB-9981 Add retry to FreeIPA healthcheck\n\nUnfortunately CCM is not stable and can cause random momentary network\noutage. If this happens during health check it would render FreeIPA\nunreachable/unusable for 3 minutes, until the next sync.\nTo handle this more gracefully this commit adds `@Retryable` to the\ncall which invokes FreeIPA API in `FreeIpaHealthDetailsService`.\nBy default it will try 3 times with 1 sec delay which should be\nenough for CCM to recover and fails fast enough to avoid congestion in\nquartz thread pool."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMDg5Njk1", "url": "https://github.com/hortonworks/cloudbreak/pull/9531#pullrequestreview-541089695", "createdAt": "2020-11-30T16:41:01Z", "commit": {"oid": "bdbf1891b539ee03f96d2f45a172ac4ca4633cac"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNjo0MTowMlrOH8DsBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNjo0MTowMlrOH8DsBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjczNzAzMQ==", "bodyText": "It is not clear to me that this type of exception is being thrown in the cases where the CCM failure is happening. The change in FreeIpaHealthCheckClientFactory.java will not affect this catch.\nI think this might work when using cluster proxy/CCM modes, but I still question if RetryableFreeIpaClientException is thrown. Can you point me to where it is thrown for this case?\nWhen using direct mode, I think getFreeIpaClientForDirectConnect() will throw FreeIpaClientException since lastInstance will be true on a health check.", "url": "https://github.com/hortonworks/cloudbreak/pull/9531#discussion_r532737031", "createdAt": "2020-11-30T16:41:02Z", "author": {"login": "jamisonbennett"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/FreeIpaClientFactory.java", "diffHunk": "@@ -129,6 +132,8 @@ private FreeIpaClient getFreeIpaClient(Stack stack, boolean withPing, boolean fo\n                     }\n                 }\n                 return client.orElseThrow(() -> createFreeIpaUnableToBuildClient(new FreeIpaHostNotAvailableException(\"No FreeIPA client was available\")));\n+            } catch (RetryableFreeIpaClientException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bdbf1891b539ee03f96d2f45a172ac4ca4633cac"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxOTAzMDYw", "url": "https://github.com/hortonworks/cloudbreak/pull/9531#pullrequestreview-541903060", "createdAt": "2020-12-01T13:41:19Z", "commit": {"oid": "bdbf1891b539ee03f96d2f45a172ac4ca4633cac"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2058, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}