{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI4MTczODE5", "number": 9531, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNjo0MTowMlrOE-vWUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNjo0MTowMlrOE-vWUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0MjIyOTI5OnYy", "diffSide": "RIGHT", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/FreeIpaClientFactory.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNjo0MTowMlrOH8DsBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxMzo0MTowNlrOH8tBcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjczNzAzMQ==", "bodyText": "It is not clear to me that this type of exception is being thrown in the cases where the CCM failure is happening. The change in FreeIpaHealthCheckClientFactory.java will not affect this catch.\nI think this might work when using cluster proxy/CCM modes, but I still question if RetryableFreeIpaClientException is thrown. Can you point me to where it is thrown for this case?\nWhen using direct mode, I think getFreeIpaClientForDirectConnect() will throw FreeIpaClientException since lastInstance will be true on a health check.", "url": "https://github.com/hortonworks/cloudbreak/pull/9531#discussion_r532737031", "createdAt": "2020-11-30T16:41:02Z", "author": {"login": "jamisonbennett"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/FreeIpaClientFactory.java", "diffHunk": "@@ -129,6 +132,8 @@ private FreeIpaClient getFreeIpaClient(Stack stack, boolean withPing, boolean fo\n                     }\n                 }\n                 return client.orElseThrow(() -> createFreeIpaUnableToBuildClient(new FreeIpaHostNotAvailableException(\"No FreeIPA client was available\")));\n+            } catch (RetryableFreeIpaClientException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bdbf1891b539ee03f96d2f45a172ac4ca4633cac"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzEyODM1OA==", "bodyText": "I think the only place we can have issues during building the client is the connect part where we do the login. There is a logic there which would build a retryable exception based on status code.\n\n  \n    \n      cloudbreak/freeipa/src/main/java/com/sequenceiq/freeipa/client/FreeIpaClientBuilder.java\n    \n    \n        Lines 232 to 236\n      in\n      8b19e19\n    \n    \n    \n    \n\n        \n          \n           throw FreeIpaClientExceptionUtil.convertToRetryableIfNeeded(new FreeIpaClientException(String.format( \n        \n\n        \n          \n                   \"Encountered unexpected response from FreeIPA; details:%n%n\" \n        \n\n        \n          \n                   + \"code: %s%n\" \n        \n\n        \n          \n                   + \"headers: %s\", response.getStatusLine().getStatusCode(), response.getAllHeaders()), \n        \n\n        \n          \n                   response.getStatusLine().getStatusCode())); \n        \n    \n  \n\n\nDo you think this would not work well for cluster proxy based connections? I can't remember if I tested this scenario last week, but I will (again) if you think this might be not handled here.", "url": "https://github.com/hortonworks/cloudbreak/pull/9531#discussion_r533128358", "createdAt": "2020-12-01T07:42:52Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/FreeIpaClientFactory.java", "diffHunk": "@@ -129,6 +132,8 @@ private FreeIpaClient getFreeIpaClient(Stack stack, boolean withPing, boolean fo\n                     }\n                 }\n                 return client.orElseThrow(() -> createFreeIpaUnableToBuildClient(new FreeIpaHostNotAvailableException(\"No FreeIPA client was available\")));\n+            } catch (RetryableFreeIpaClientException e) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjczNzAzMQ=="}, "originalCommit": {"oid": "bdbf1891b539ee03f96d2f45a172ac4ca4633cac"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQxNDI1Ng==", "bodyText": "Thanks.\nI think this will work for cluster proxy/CCM errors and some direct errors during the connections.", "url": "https://github.com/hortonworks/cloudbreak/pull/9531#discussion_r533414256", "createdAt": "2020-12-01T13:41:06Z", "author": {"login": "jamisonbennett"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/FreeIpaClientFactory.java", "diffHunk": "@@ -129,6 +132,8 @@ private FreeIpaClient getFreeIpaClient(Stack stack, boolean withPing, boolean fo\n                     }\n                 }\n                 return client.orElseThrow(() -> createFreeIpaUnableToBuildClient(new FreeIpaHostNotAvailableException(\"No FreeIPA client was available\")));\n+            } catch (RetryableFreeIpaClientException e) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjczNzAzMQ=="}, "originalCommit": {"oid": "bdbf1891b539ee03f96d2f45a172ac4ca4633cac"}, "originalPosition": 14}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3531, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}