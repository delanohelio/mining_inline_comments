{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEwNTYxMDMz", "number": 9292, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwODoyMDo0NFrOEyOtWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxNTo0NzozMlrOEya-VQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxMTA1MjQzOnYy", "diffSide": "RIGHT", "path": "auth-connector/src/main/java/com/sequenceiq/cloudbreak/auth/altus/GrpcUmsClient.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwODoyMDo0NFrOHowBeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwODoyNTo1OVrOHowNyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ5MTg5OA==", "bodyText": "Entitlement check for authz entitlement still not logged here. The main reason for jira task creation was to use EntitlementService here and also resolve circular dependency between GrpcUmsClient and EntitlementService", "url": "https://github.com/hortonworks/cloudbreak/pull/9292#discussion_r512491898", "createdAt": "2020-10-27T08:20:44Z", "author": {"login": "horadla23"}, "path": "auth-connector/src/main/java/com/sequenceiq/cloudbreak/auth/altus/GrpcUmsClient.java", "diffHunk": "@@ -511,7 +512,7 @@ public boolean isAuthorizationEntitlementRegistered(String actorCrn, String acco\n         return getAccountDetails(actorCrn, accountId, MDCUtils.getRequestId()).getEntitlementsList()\n                 .stream()\n                 .map(e -> e.getEntitlementName().toUpperCase())\n-                .anyMatch(e -> e.equalsIgnoreCase(\"CB_AUTHZ_POWER_USERS\"));\n+                .anyMatch(e -> e.equalsIgnoreCase(Entitlement.CB_AUTHZ_POWER_USERS.name()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd5f9263406405a5ba982525c70375102c0879a7"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ5Mjk5Nw==", "bodyText": "Yes, this is the reason why it is in do_not_merge state, but I'll put it into draft to make it more clear.", "url": "https://github.com/hortonworks/cloudbreak/pull/9292#discussion_r512492997", "createdAt": "2020-10-27T08:22:34Z", "author": {"login": "foldik"}, "path": "auth-connector/src/main/java/com/sequenceiq/cloudbreak/auth/altus/GrpcUmsClient.java", "diffHunk": "@@ -511,7 +512,7 @@ public boolean isAuthorizationEntitlementRegistered(String actorCrn, String acco\n         return getAccountDetails(actorCrn, accountId, MDCUtils.getRequestId()).getEntitlementsList()\n                 .stream()\n                 .map(e -> e.getEntitlementName().toUpperCase())\n-                .anyMatch(e -> e.equalsIgnoreCase(\"CB_AUTHZ_POWER_USERS\"));\n+                .anyMatch(e -> e.equalsIgnoreCase(Entitlement.CB_AUTHZ_POWER_USERS.name()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ5MTg5OA=="}, "originalCommit": {"oid": "fd5f9263406405a5ba982525c70375102c0879a7"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ5NDAxOQ==", "bodyText": "I'll leave it simply in DO_NOT_MERGE.", "url": "https://github.com/hortonworks/cloudbreak/pull/9292#discussion_r512494019", "createdAt": "2020-10-27T08:24:20Z", "author": {"login": "foldik"}, "path": "auth-connector/src/main/java/com/sequenceiq/cloudbreak/auth/altus/GrpcUmsClient.java", "diffHunk": "@@ -511,7 +512,7 @@ public boolean isAuthorizationEntitlementRegistered(String actorCrn, String acco\n         return getAccountDetails(actorCrn, accountId, MDCUtils.getRequestId()).getEntitlementsList()\n                 .stream()\n                 .map(e -> e.getEntitlementName().toUpperCase())\n-                .anyMatch(e -> e.equalsIgnoreCase(\"CB_AUTHZ_POWER_USERS\"));\n+                .anyMatch(e -> e.equalsIgnoreCase(Entitlement.CB_AUTHZ_POWER_USERS.name()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ5MTg5OA=="}, "originalCommit": {"oid": "fd5f9263406405a5ba982525c70375102c0879a7"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ5NTA0OA==", "bodyText": "oh, ok, yes, makes sense to make it draft for now", "url": "https://github.com/hortonworks/cloudbreak/pull/9292#discussion_r512495048", "createdAt": "2020-10-27T08:25:59Z", "author": {"login": "horadla23"}, "path": "auth-connector/src/main/java/com/sequenceiq/cloudbreak/auth/altus/GrpcUmsClient.java", "diffHunk": "@@ -511,7 +512,7 @@ public boolean isAuthorizationEntitlementRegistered(String actorCrn, String acco\n         return getAccountDetails(actorCrn, accountId, MDCUtils.getRequestId()).getEntitlementsList()\n                 .stream()\n                 .map(e -> e.getEntitlementName().toUpperCase())\n-                .anyMatch(e -> e.equalsIgnoreCase(\"CB_AUTHZ_POWER_USERS\"));\n+                .anyMatch(e -> e.equalsIgnoreCase(Entitlement.CB_AUTHZ_POWER_USERS.name()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ5MTg5OA=="}, "originalCommit": {"oid": "fd5f9263406405a5ba982525c70375102c0879a7"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxMzA2MTk3OnYy", "diffSide": "RIGHT", "path": "auth-connector/src/main/java/com/sequenceiq/cloudbreak/auth/altus/GrpcUmsClient.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxNTo0NzozMlrOHpDWSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxNjowMDowM1rOHpECiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjgwODUyMQ==", "bodyText": "maybe it is better to let UMS call fail here if account id is internal (which should not ever happen at this point), so i would not check for that, anyway CB will fail somewhere else also if internal account id reaches service layer", "url": "https://github.com/hortonworks/cloudbreak/pull/9292#discussion_r512808521", "createdAt": "2020-10-27T15:47:32Z", "author": {"login": "horadla23"}, "path": "auth-connector/src/main/java/com/sequenceiq/cloudbreak/auth/altus/GrpcUmsClient.java", "diffHunk": "@@ -503,15 +504,24 @@ public String rightCheckToString(AuthorizationProto.RightCheck rightCheck) {\n         }\n     }\n \n-    @Cacheable(cacheNames = \"umsAuthorizationEntitlementRegisteredCache\", key = \"{ #actorCrn, #accountId }\")\n-    public boolean isAuthorizationEntitlementRegistered(String actorCrn, String accountId) {\n-        if (StringUtils.equals(accountId, InternalCrnBuilder.INTERNAL_ACCOUNT)) {\n-            return false;\n+    @Cacheable(cacheNames = \"umsEntitlementRegisteredCache\", key = \"{ #actorCrn, #accountId, #entitlement }\")\n+    public boolean isEntitled(String actorCrn, String accountId, Entitlement entitlement) {\n+        boolean entitled;\n+        if (Entitlement.CB_AUTHZ_POWER_USERS.equals(entitlement) && StringUtils.equals(accountId, InternalCrnBuilder.INTERNAL_ACCOUNT)) {\n+            entitled = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b60742868058ea41ad40ca9bcdc67da6215bbc54"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjgxOTg1MQ==", "bodyText": "nvm i put that kind of if statement because of an issue", "url": "https://github.com/hortonworks/cloudbreak/pull/9292#discussion_r512819851", "createdAt": "2020-10-27T16:00:03Z", "author": {"login": "horadla23"}, "path": "auth-connector/src/main/java/com/sequenceiq/cloudbreak/auth/altus/GrpcUmsClient.java", "diffHunk": "@@ -503,15 +504,24 @@ public String rightCheckToString(AuthorizationProto.RightCheck rightCheck) {\n         }\n     }\n \n-    @Cacheable(cacheNames = \"umsAuthorizationEntitlementRegisteredCache\", key = \"{ #actorCrn, #accountId }\")\n-    public boolean isAuthorizationEntitlementRegistered(String actorCrn, String accountId) {\n-        if (StringUtils.equals(accountId, InternalCrnBuilder.INTERNAL_ACCOUNT)) {\n-            return false;\n+    @Cacheable(cacheNames = \"umsEntitlementRegisteredCache\", key = \"{ #actorCrn, #accountId, #entitlement }\")\n+    public boolean isEntitled(String actorCrn, String accountId, Entitlement entitlement) {\n+        boolean entitled;\n+        if (Entitlement.CB_AUTHZ_POWER_USERS.equals(entitlement) && StringUtils.equals(accountId, InternalCrnBuilder.INTERNAL_ACCOUNT)) {\n+            entitled = false;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjgwODUyMQ=="}, "originalCommit": {"oid": "b60742868058ea41ad40ca9bcdc67da6215bbc54"}, "originalPosition": 59}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2051, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}