{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU2NDcwMTkz", "number": 8639, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwNjo0NjowMlrOESQZiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwOTo0NDoxMFrOETLY-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3NTc4NTA1OnYy", "diffSide": "RIGHT", "path": "orchestrator-salt/src/main/resources/salt/salt/sssd/template/add_dns_record.j2", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwNjo0NjowMlrOG3VlQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwNzoyNzo0NFrOG4AC-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDY3ODQ2NQ==", "bodyText": "I think you should grep for .in-addr.arpa. here", "url": "https://github.com/hortonworks/cloudbreak/pull/8639#discussion_r460678465", "createdAt": "2020-07-27T06:46:02Z", "author": {"login": "lacikaaa"}, "path": "orchestrator-salt/src/main/resources/salt/salt/sssd/template/add_dns_record.j2", "diffHunk": "@@ -0,0 +1,43 @@\n+#!/usr/bin/env bash\n+\n+set -e\n+\n+echo \"$PW\" | kinit {{ pillar['sssd-ipa']['principal'] }}\n+\n+set -x\n+\n+HOSTNAME=$(hostname)\n+FQDN=$(hostname -f)\n+IPADDR=$(hostname -i)\n+REVERSE_IP=$(hostname -i | awk -F. '{print $4\".\"$3\".\" $2\".\"$1}')\n+\n+# dnsrecord-add must either add the record or modify it\n+if ! ipa dnsrecord-find {{ pillar['sssd-ipa']['domain'] }}. \"--name=${HOSTNAME}\" \"--a-rec=${IPADDR}\"  --ttl {{ pillar['sssd-ipa']['dns_ttl'] }} --all; then\n+  ipa dnsrecord-add {{ pillar['sssd-ipa']['domain'] }}. \"${HOSTNAME}\" \"--a-rec=${IPADDR}\" --ttl {{ pillar['sssd-ipa']['dns_ttl'] }}\n+fi\n+if ! ipa dnsrecord-find {{ pillar['sssd-ipa']['domain'] }}. \"--name=${HOSTNAME}\" \"--a-rec=${IPADDR}\"  --ttl {{ pillar['sssd-ipa']['dns_ttl'] }} --all; then\n+  echo \"Failed to set DNS A-record for ${HOSTNAME}\"\n+  false\n+fi\n+\n+for zone in $(ipa dnszone-find --raw | grep idnsname | cut -d':' -f2 | xargs)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9051e484b9dde8e0009673a569b3876b0d022457"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDY4MTgzMA==", "bodyText": "also I have a little concern here. if we have lets see the IP 10.10.1.2.\nAnd we have 2 zones:\n\n10.10.in-addr.arpa\n10.in-addr.arpa\n\nthis for loop will add the reverse record for both zone. Is it really what we want to do?", "url": "https://github.com/hortonworks/cloudbreak/pull/8639#discussion_r460681830", "createdAt": "2020-07-27T06:55:02Z", "author": {"login": "lacikaaa"}, "path": "orchestrator-salt/src/main/resources/salt/salt/sssd/template/add_dns_record.j2", "diffHunk": "@@ -0,0 +1,43 @@\n+#!/usr/bin/env bash\n+\n+set -e\n+\n+echo \"$PW\" | kinit {{ pillar['sssd-ipa']['principal'] }}\n+\n+set -x\n+\n+HOSTNAME=$(hostname)\n+FQDN=$(hostname -f)\n+IPADDR=$(hostname -i)\n+REVERSE_IP=$(hostname -i | awk -F. '{print $4\".\"$3\".\" $2\".\"$1}')\n+\n+# dnsrecord-add must either add the record or modify it\n+if ! ipa dnsrecord-find {{ pillar['sssd-ipa']['domain'] }}. \"--name=${HOSTNAME}\" \"--a-rec=${IPADDR}\"  --ttl {{ pillar['sssd-ipa']['dns_ttl'] }} --all; then\n+  ipa dnsrecord-add {{ pillar['sssd-ipa']['domain'] }}. \"${HOSTNAME}\" \"--a-rec=${IPADDR}\" --ttl {{ pillar['sssd-ipa']['dns_ttl'] }}\n+fi\n+if ! ipa dnsrecord-find {{ pillar['sssd-ipa']['domain'] }}. \"--name=${HOSTNAME}\" \"--a-rec=${IPADDR}\"  --ttl {{ pillar['sssd-ipa']['dns_ttl'] }} --all; then\n+  echo \"Failed to set DNS A-record for ${HOSTNAME}\"\n+  false\n+fi\n+\n+for zone in $(ipa dnszone-find --raw | grep idnsname | cut -d':' -f2 | xargs)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDY3ODQ2NQ=="}, "originalCommit": {"oid": "9051e484b9dde8e0009673a569b3876b0d022457"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA5NjY1Ng==", "bodyText": "I think you should grep for .in-addr.arpa. here\n\nDone, but its technically not needed as if echo \"$REVERSE_IP\" | grep -qE \"$ZONE_NET$\"; then should have handled this.\n\nalso I have a little concern here. if we have\nlets see the IP 10.10.1.2.\nAnd we have 2 zones:\n10.10.in-addr.arpa\n10.in-addr.arpa\nthis for loop will add the reverse record for both zone. Is it really what we want to do?\n\nI don't think we should have cases where there are different matching zones, but maybe there is a way to do it with submitting with our current deployment of CDP. Either way, I made the reverse DNS register with the more specific zone. So it should only register once.", "url": "https://github.com/hortonworks/cloudbreak/pull/8639#discussion_r461096656", "createdAt": "2020-07-27T18:47:39Z", "author": {"login": "jamisonbennett"}, "path": "orchestrator-salt/src/main/resources/salt/salt/sssd/template/add_dns_record.j2", "diffHunk": "@@ -0,0 +1,43 @@\n+#!/usr/bin/env bash\n+\n+set -e\n+\n+echo \"$PW\" | kinit {{ pillar['sssd-ipa']['principal'] }}\n+\n+set -x\n+\n+HOSTNAME=$(hostname)\n+FQDN=$(hostname -f)\n+IPADDR=$(hostname -i)\n+REVERSE_IP=$(hostname -i | awk -F. '{print $4\".\"$3\".\" $2\".\"$1}')\n+\n+# dnsrecord-add must either add the record or modify it\n+if ! ipa dnsrecord-find {{ pillar['sssd-ipa']['domain'] }}. \"--name=${HOSTNAME}\" \"--a-rec=${IPADDR}\"  --ttl {{ pillar['sssd-ipa']['dns_ttl'] }} --all; then\n+  ipa dnsrecord-add {{ pillar['sssd-ipa']['domain'] }}. \"${HOSTNAME}\" \"--a-rec=${IPADDR}\" --ttl {{ pillar['sssd-ipa']['dns_ttl'] }}\n+fi\n+if ! ipa dnsrecord-find {{ pillar['sssd-ipa']['domain'] }}. \"--name=${HOSTNAME}\" \"--a-rec=${IPADDR}\"  --ttl {{ pillar['sssd-ipa']['dns_ttl'] }} --all; then\n+  echo \"Failed to set DNS A-record for ${HOSTNAME}\"\n+  false\n+fi\n+\n+for zone in $(ipa dnszone-find --raw | grep idnsname | cut -d':' -f2 | xargs)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDY3ODQ2NQ=="}, "originalCommit": {"oid": "9051e484b9dde8e0009673a569b3876b0d022457"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM3NDIwMw==", "bodyText": "Done, but its technically not needed as...\n\nYes, but it will then loop for reverse zones only\nWe should not create but never know. Also customer might create it. I tested and FreeIPA will return the more exact match, but I think it's better to be prepared and add only for the right one.\nThanks for the modification!", "url": "https://github.com/hortonworks/cloudbreak/pull/8639#discussion_r461374203", "createdAt": "2020-07-28T07:27:44Z", "author": {"login": "lacikaaa"}, "path": "orchestrator-salt/src/main/resources/salt/salt/sssd/template/add_dns_record.j2", "diffHunk": "@@ -0,0 +1,43 @@\n+#!/usr/bin/env bash\n+\n+set -e\n+\n+echo \"$PW\" | kinit {{ pillar['sssd-ipa']['principal'] }}\n+\n+set -x\n+\n+HOSTNAME=$(hostname)\n+FQDN=$(hostname -f)\n+IPADDR=$(hostname -i)\n+REVERSE_IP=$(hostname -i | awk -F. '{print $4\".\"$3\".\" $2\".\"$1}')\n+\n+# dnsrecord-add must either add the record or modify it\n+if ! ipa dnsrecord-find {{ pillar['sssd-ipa']['domain'] }}. \"--name=${HOSTNAME}\" \"--a-rec=${IPADDR}\"  --ttl {{ pillar['sssd-ipa']['dns_ttl'] }} --all; then\n+  ipa dnsrecord-add {{ pillar['sssd-ipa']['domain'] }}. \"${HOSTNAME}\" \"--a-rec=${IPADDR}\" --ttl {{ pillar['sssd-ipa']['dns_ttl'] }}\n+fi\n+if ! ipa dnsrecord-find {{ pillar['sssd-ipa']['domain'] }}. \"--name=${HOSTNAME}\" \"--a-rec=${IPADDR}\"  --ttl {{ pillar['sssd-ipa']['dns_ttl'] }} --all; then\n+  echo \"Failed to set DNS A-record for ${HOSTNAME}\"\n+  false\n+fi\n+\n+for zone in $(ipa dnszone-find --raw | grep idnsname | cut -d':' -f2 | xargs)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDY3ODQ2NQ=="}, "originalCommit": {"oid": "9051e484b9dde8e0009673a569b3876b0d022457"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4MDMxNTExOnYy", "diffSide": "RIGHT", "path": "orchestrator-salt/src/main/resources/salt/salt/sssd/template/add_dns_record.j2", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwNzozMjoyOVrOG4AMcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwNzozMjoyOVrOG4AMcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM3NjYyNg==", "bodyText": "if this if is false, shouldn't we exit the loop? I mean in case we find the record, so it's successfully added we shouldn't iterate any more", "url": "https://github.com/hortonworks/cloudbreak/pull/8639#discussion_r461376626", "createdAt": "2020-07-28T07:32:29Z", "author": {"login": "lacikaaa"}, "path": "orchestrator-salt/src/main/resources/salt/salt/sssd/template/add_dns_record.j2", "diffHunk": "@@ -0,0 +1,45 @@\n+#!/usr/bin/env bash\n+\n+set -e\n+\n+echo \"$PW\" | kinit {{ pillar['sssd-ipa']['principal'] }}\n+\n+set -x\n+\n+HOSTNAME=$(hostname)\n+FQDN=$(hostname -f)\n+IPADDR=$(hostname -i)\n+REVERSE_IP=$(hostname -i | awk -F. '{print $4\".\"$3\".\" $2\".\"$1}')\n+\n+# dnsrecord-add must either add the record or modify it\n+if ! ipa dnsrecord-find {{ pillar['sssd-ipa']['domain'] }}. \"--name=${HOSTNAME}\" \"--a-rec=${IPADDR}\"  --ttl {{ pillar['sssd-ipa']['dns_ttl'] }} --all; then\n+  ipa dnsrecord-add {{ pillar['sssd-ipa']['domain'] }}. \"${HOSTNAME}\" \"--a-rec=${IPADDR}\" --ttl {{ pillar['sssd-ipa']['dns_ttl'] }}\n+fi\n+if ! ipa dnsrecord-find {{ pillar['sssd-ipa']['domain'] }}. \"--name=${HOSTNAME}\" \"--a-rec=${IPADDR}\"  --ttl {{ pillar['sssd-ipa']['dns_ttl'] }} --all; then\n+  echo \"Failed to set DNS A-record for ${HOSTNAME}\"\n+  false\n+fi\n+\n+LONGEST_MATCHING_ZONE_FOUND=0\n+for zone in $(ipa dnszone-find --raw | grep \"idnsname:.*\\.in-addr\\.arpa\\.\" | cut -d':' -f2 | awk '{ print length, $0 }' | sort -n -r | awk '{ print $2 }' | xargs)\n+do\n+    ZONE_NET=${zone//.in-addr.arpa./}\n+    if [[ $LONGEST_MATCHING_ZONE_FOUND -eq 0 ]] && echo \"$REVERSE_IP\" | grep -qE \"$ZONE_NET$\"; then\n+        LONGEST_MATCHING_ZONE_FOUND=1\n+        REVERSE_RECORD_NAME=$(echo \"$REVERSE_IP\" | sed \"s/.$ZONE_NET$//g\")\n+        # dnsrecord-add must either add the record or modify it\n+        if ! ipa dnsrecord-find \"$zone\" \"--name=$REVERSE_RECORD_NAME\" \"--ptr-rec=${FQDN}.\" --ttl {{ pillar['sssd-ipa']['dns_ttl'] }}; then\n+          ipa dnsrecord-add \"$zone\" \"$REVERSE_RECORD_NAME\" \"--ptr-rec=${FQDN}.\" --ttl {{ pillar['sssd-ipa']['dns_ttl'] }}\n+        fi\n+        if ! ipa dnsrecord-find \"$zone\" \"--name=$REVERSE_RECORD_NAME\" \"--ptr-rec=${FQDN}.\" --ttl {{ pillar['sssd-ipa']['dns_ttl'] }}; then", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5423f3b7cc542897814b46777c5e1a4f6f91530a"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4MDMyMDk0OnYy", "diffSide": "RIGHT", "path": "orchestrator-salt/src/main/resources/salt/salt/sssd/template/add_dns_record.j2", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwNzozNDoxM1rOG4AP7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwNzozNDoxM1rOG4AP7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM3NzUxOQ==", "bodyText": "due to set -e this won't run in case of failure. If we really want to destroy it we should use trap for this", "url": "https://github.com/hortonworks/cloudbreak/pull/8639#discussion_r461377519", "createdAt": "2020-07-28T07:34:13Z", "author": {"login": "lacikaaa"}, "path": "orchestrator-salt/src/main/resources/salt/salt/sssd/template/add_dns_record.j2", "diffHunk": "@@ -0,0 +1,45 @@\n+#!/usr/bin/env bash\n+\n+set -e\n+\n+echo \"$PW\" | kinit {{ pillar['sssd-ipa']['principal'] }}\n+\n+set -x\n+\n+HOSTNAME=$(hostname)\n+FQDN=$(hostname -f)\n+IPADDR=$(hostname -i)\n+REVERSE_IP=$(hostname -i | awk -F. '{print $4\".\"$3\".\" $2\".\"$1}')\n+\n+# dnsrecord-add must either add the record or modify it\n+if ! ipa dnsrecord-find {{ pillar['sssd-ipa']['domain'] }}. \"--name=${HOSTNAME}\" \"--a-rec=${IPADDR}\"  --ttl {{ pillar['sssd-ipa']['dns_ttl'] }} --all; then\n+  ipa dnsrecord-add {{ pillar['sssd-ipa']['domain'] }}. \"${HOSTNAME}\" \"--a-rec=${IPADDR}\" --ttl {{ pillar['sssd-ipa']['dns_ttl'] }}\n+fi\n+if ! ipa dnsrecord-find {{ pillar['sssd-ipa']['domain'] }}. \"--name=${HOSTNAME}\" \"--a-rec=${IPADDR}\"  --ttl {{ pillar['sssd-ipa']['dns_ttl'] }} --all; then\n+  echo \"Failed to set DNS A-record for ${HOSTNAME}\"\n+  false\n+fi\n+\n+LONGEST_MATCHING_ZONE_FOUND=0\n+for zone in $(ipa dnszone-find --raw | grep \"idnsname:.*\\.in-addr\\.arpa\\.\" | cut -d':' -f2 | awk '{ print length, $0 }' | sort -n -r | awk '{ print $2 }' | xargs)\n+do\n+    ZONE_NET=${zone//.in-addr.arpa./}\n+    if [[ $LONGEST_MATCHING_ZONE_FOUND -eq 0 ]] && echo \"$REVERSE_IP\" | grep -qE \"$ZONE_NET$\"; then\n+        LONGEST_MATCHING_ZONE_FOUND=1\n+        REVERSE_RECORD_NAME=$(echo \"$REVERSE_IP\" | sed \"s/.$ZONE_NET$//g\")\n+        # dnsrecord-add must either add the record or modify it\n+        if ! ipa dnsrecord-find \"$zone\" \"--name=$REVERSE_RECORD_NAME\" \"--ptr-rec=${FQDN}.\" --ttl {{ pillar['sssd-ipa']['dns_ttl'] }}; then\n+          ipa dnsrecord-add \"$zone\" \"$REVERSE_RECORD_NAME\" \"--ptr-rec=${FQDN}.\" --ttl {{ pillar['sssd-ipa']['dns_ttl'] }}\n+        fi\n+        if ! ipa dnsrecord-find \"$zone\" \"--name=$REVERSE_RECORD_NAME\" \"--ptr-rec=${FQDN}.\" --ttl {{ pillar['sssd-ipa']['dns_ttl'] }}; then\n+          echo \"Failed to set Reverse DNS PTR-record for ${FQDN}\"\n+          false\n+        fi\n+    fi\n+done\n+\n+# Destroy the krbtgt\n+kdestroy", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5423f3b7cc542897814b46777c5e1a4f6f91530a"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4NTQ1MDE2OnYy", "diffSide": "RIGHT", "path": "orchestrator-salt/src/main/resources/salt/salt/sssd/ipa.sls", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwOTo0NDoxMFrOG4w4Kg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwOTo0NDoxMFrOG4w4Kg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjE3NDI1MA==", "bodyText": "it looks like you have some extra character here", "url": "https://github.com/hortonworks/cloudbreak/pull/8639#discussion_r462174250", "createdAt": "2020-07-29T09:44:10Z", "author": {"login": "lacikaaa"}, "path": "orchestrator-salt/src/main/resources/salt/salt/sssd/ipa.sls", "diffHunk": "@@ -12,30 +12,27 @@ ipa_packages_install:\n     - unless:\n       - rpm -q ipa-client openldap openldap-clients\n \n+/opt/salt/scripts/join_ipa.sh:\n+  file.managed:\n+    - makedirs: True\n+    - user: root\n+    - group: root\n+    - mode: 700\n+    - source: salt://sssd/template/join_ipa.j2\n+    - template: jinja\n+\n join_ipa:\n   cmd.run:\n {% if metadata.platform != 'YARN' %}\n-    - name: |\n-        ipa-client-install --unattended --uninstall\n-        ipa-client-install --realm={{salt['pillar.get']('sssd-ipa:realm')}} \\\n-          --domain={{salt['pillar.get']('sssd-ipa:domain')}} --mkhomedir --principal={{salt['pillar.get']('sssd-ipa:principal')}} \\\n-          {%- if \"ID_BROKER_CLOUD_IDENTITY_ROLE\" in grains.get('roles', []) %}\n-          --no-sshd --no-ssh \\\n-          {%- endif %}\n-          --password $PW --unattended --force-join --ssh-trust-dns --no-ntp && echo $(date +%Y-%m-%d:%H:%M:%S) >> /var/log/ipa-join-executed\n+    - name: /opt/salt/scripts/join_ipa.sh && echo $(date +%Y-%m-%d:%H:%M:%S) >> /var/log/ipa-join-executed\n {% else %}\n-    - name: |\n-        runuser -l root -c 'ipa-client-install --unattended --uninstall\n-        runuser -l root -c 'ipa-client-install --realm={{salt['pillar.get']('sssd-ipa:realm')}} \\\n-          --domain={{salt['pillar.get']('sssd-ipa:domain')}} --mkhomedir --principal={{salt['pillar.get']('sssd-ipa:principal')}} \\\n-          {%- if \"ID_BROKER_CLOUD_IDENTITY_ROLE\" in grains.get('roles', []) %}\n-          --no-sshd --no-ssh \\\n-          {%- endif %}\n-          --password \"{{salt['pillar.get']('sssd-ipa:password')}}\" --unattended --force-join --ssh-trust-dns --no-ntp && echo $(date +%Y-%m-%d:%H:%M:%S) >> /var/log/ipa-join-executed'\n+    - name: runuser -l root -c '/opt/salt/scripts/join_ipa.sh && echo $(date +%Y-%m-%d:%H:%M:%S) >> /var/log/ipa-join-executed'\n {% endif %}\n-    - unless: test -f /var/log/ipa-join-executed || { echo $PW | kinit {{salt['pillar.get']('sssd-ipa:principal')}} && ipa env; }\n+    - unless: test -f /var/log/ipa-join-executed\n     - runas: root\n-    - failhard: True\n+    - failhard: True:$", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d45b411f92f725d56fdcd168ecf3c1f19105e4b"}, "originalPosition": 40}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3080, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}