{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE3NDk3NjM2", "number": 8040, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNzoyNToyMlrOD8Khfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxMToyMjowM1rOD81TUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NDEzNTY3OnYy", "diffSide": "RIGHT", "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/AwsNetworkCfTemplateProvider.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNzoyNToyMlrOGU7-8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNzoyNToyMlrOGU7-8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwNzQ3NA==", "bodyText": "Please add log lines to the different conditions.", "url": "https://github.com/hortonworks/cloudbreak/pull/8040#discussion_r424607474", "createdAt": "2020-05-13T17:25:22Z", "author": {"login": "keyki"}, "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/AwsNetworkCfTemplateProvider.java", "diffHunk": "@@ -42,13 +61,50 @@ public String provide(String envName, Long envId, String vpcCidr, List<SubnetReq\n         }\n     }\n \n-    private Map<String, Object> createModel(String envName, Long envId, String vpcCidr, List<SubnetRequest> subnets, boolean privateSubnetEnabled) {\n+    private Map<String, Object> createModel(NetworkCreationRequest networkCreationRequest, List<SubnetRequest> subnets) {\n         Map<String, Object> model = new HashMap<>();\n-        model.put(\"environmentName\", envName);\n-        model.put(\"environmentId\", envId);\n-        model.put(\"vpcCidr\", vpcCidr);\n+        model.put(\"environmentName\", networkCreationRequest.getEnvName());\n+        model.put(\"environmentId\", networkCreationRequest.getEnvId());\n+        model.put(\"vpcCidr\", networkCreationRequest.getNetworkCidr());\n         model.put(\"subnetDetails\", subnets);\n-        model.put(\"privateSubnetEnabled\", privateSubnetEnabled);\n+        model.put(\"privateSubnetEnabled\", privateSubnetEnabled(networkCreationRequest, subnets));\n+        model.put(\"vpcGatewayEndpoints\", gatewayServices);\n+        model.put(\"vpcInterfaceEndpointsMap\", createServiceSubnetMap(networkCreationRequest, subnets));\n         return model;\n     }\n+\n+    private Map<String, List<SubnetRequest>> createServiceSubnetMap(NetworkCreationRequest networkCreationRequest, List<SubnetRequest> subnets) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53cd1a9288f4b670c8b7d9a5b5f490104293ffb1"}, "originalPosition": 79}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0ODI5NDc2OnYy", "diffSide": "RIGHT", "path": "cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/model/network/SubnetRequest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNjozODoxNlrOGVk6eg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNjozODoxNlrOGVk6eg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI3ODA3NA==", "bodyText": "it looks like not all the field are in the toString. is it on purpose?", "url": "https://github.com/hortonworks/cloudbreak/pull/8040#discussion_r425278074", "createdAt": "2020-05-14T16:38:16Z", "author": {"login": "lacikaaa"}, "path": "cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/model/network/SubnetRequest.java", "diffHunk": "@@ -61,4 +61,14 @@ public void setType(SubnetType type) {\n     public SubnetType getType() {\n         return type;\n     }\n+\n+    @Override\n+    public String toString() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6391a2604990bc2407f6b97add549228a61eeab5"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0ODMwNDM1OnYy", "diffSide": "RIGHT", "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/AwsNetworkCfTemplateProvider.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNjo0MDo1MlrOGVlA8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNjo0MDo1MlrOGVlA8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI3OTczMA==", "bodyText": "please remove :", "url": "https://github.com/hortonworks/cloudbreak/pull/8040#discussion_r425279730", "createdAt": "2020-05-14T16:40:52Z", "author": {"login": "lacikaaa"}, "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/AwsNetworkCfTemplateProvider.java", "diffHunk": "@@ -20,19 +31,31 @@\n \n @Component\n public class AwsNetworkCfTemplateProvider {\n+    static final String VPC_INTERFACE_SERVICE_ENDPOINT_NAME_PATTERN = \"com.amazonaws.%s.%s\";\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(AwsNetworkCfTemplateProvider.class);\n \n     @Inject\n     private Configuration freemarkerConfiguration;\n \n     @Value(\"${cb.aws.cf.network.template.path:}\")\n     private String cloudFormationNetworkTemplatePath;\n \n+    @Value(\"${cb.aws.vpcendpoints.gateway.services:}\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6391a2604990bc2407f6b97add549228a61eeab5"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0ODMwNTAzOnYy", "diffSide": "RIGHT", "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/AwsNetworkCfTemplateProvider.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNjo0MTowMlrOGVlBbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNjo0MTowMlrOGVlBbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI3OTg1Mw==", "bodyText": "please remove :", "url": "https://github.com/hortonworks/cloudbreak/pull/8040#discussion_r425279853", "createdAt": "2020-05-14T16:41:02Z", "author": {"login": "lacikaaa"}, "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/AwsNetworkCfTemplateProvider.java", "diffHunk": "@@ -20,19 +31,31 @@\n \n @Component\n public class AwsNetworkCfTemplateProvider {\n+    static final String VPC_INTERFACE_SERVICE_ENDPOINT_NAME_PATTERN = \"com.amazonaws.%s.%s\";\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(AwsNetworkCfTemplateProvider.class);\n \n     @Inject\n     private Configuration freemarkerConfiguration;\n \n     @Value(\"${cb.aws.cf.network.template.path:}\")\n     private String cloudFormationNetworkTemplatePath;\n \n+    @Value(\"${cb.aws.vpcendpoints.gateway.services:}\")\n+    private List<String> gatewayServices;\n+\n+    @Value(\"${cb.aws.vpcendpoints.interface.services:}\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6391a2604990bc2407f6b97add549228a61eeab5"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0ODM5MzExOnYy", "diffSide": "RIGHT", "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/AwsNetworkCfTemplateProvider.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNzowMzoyMlrOGVl5fQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNzowMzoyMlrOGVl5fQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI5NDIwNQ==", "bodyText": "please refactor innto smaller parts", "url": "https://github.com/hortonworks/cloudbreak/pull/8040#discussion_r425294205", "createdAt": "2020-05-14T17:03:22Z", "author": {"login": "lacikaaa"}, "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/AwsNetworkCfTemplateProvider.java", "diffHunk": "@@ -42,13 +65,53 @@ public String provide(String envName, Long envId, String vpcCidr, List<SubnetReq\n         }\n     }\n \n-    private Map<String, Object> createModel(String envName, Long envId, String vpcCidr, List<SubnetRequest> subnets, boolean privateSubnetEnabled) {\n+    private Map<String, Object> createModel(NetworkCreationRequest networkCreationRequest, List<SubnetRequest> subnets) {\n         Map<String, Object> model = new HashMap<>();\n-        model.put(\"environmentName\", envName);\n-        model.put(\"environmentId\", envId);\n-        model.put(\"vpcCidr\", vpcCidr);\n+        model.put(\"environmentName\", networkCreationRequest.getEnvName());\n+        model.put(\"environmentId\", networkCreationRequest.getEnvId());\n+        model.put(\"vpcCidr\", networkCreationRequest.getNetworkCidr());\n         model.put(\"subnetDetails\", subnets);\n-        model.put(\"privateSubnetEnabled\", privateSubnetEnabled);\n+        model.put(\"privateSubnetEnabled\", privateSubnetEnabled(networkCreationRequest, subnets));\n+        model.put(\"vpcGatewayEndpoints\", gatewayServices);\n+        model.put(\"vpcInterfaceEndpointsMap\", createServiceSubnetMap(networkCreationRequest, subnets));\n         return model;\n     }\n+\n+    private Map<String, List<SubnetRequest>> createServiceSubnetMap(NetworkCreationRequest networkCreationRequest, List<SubnetRequest> subnets) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a33facf6d31719ff78215f158da5d8a49ee09ba7"}, "originalPosition": 83}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0ODM5OTQ0OnYy", "diffSide": "RIGHT", "path": "environment/src/main/resources/schema/app/20200513175538_CB-6764_introduce_serviceEndpointCreation_column_in_environment's_network_entity.sql", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNzowNTowMFrOGVl9gQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNzowNTowMFrOGVl9gQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI5NTIzMw==", "bodyText": "you have to add default in separate steps to avoid lock, like this:\nhttps://github.com/hortonworks/cloudbreak/blob/master/freeipa/src/main/resources/schema/app/20200406095012_CB-6385_add_version_to_stack.sql", "url": "https://github.com/hortonworks/cloudbreak/pull/8040#discussion_r425295233", "createdAt": "2020-05-14T17:05:00Z", "author": {"login": "lacikaaa"}, "path": "environment/src/main/resources/schema/app/20200513175538_CB-6764_introduce_serviceEndpointCreation_column_in_environment's_network_entity.sql", "diffHunk": "@@ -0,0 +1,9 @@\n+-- // CB-6764 introduce serviceEndpointCreation column in environment's network entity\n+-- Migration SQL that makes the change goes here.\n+\n+ALTER TABLE environment_network ADD COLUMN IF NOT EXISTS serviceEndpointCreation varchar(255) NOT NULL DEFAULT 'DISABLED';", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a33facf6d31719ff78215f158da5d8a49ee09ba7"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1MTEwNzU2OnYy", "diffSide": "RIGHT", "path": "cloud-aws/src/main/resources/templates/aws-cf-network.ftl", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxMTowODo0MFrOGWAftA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxMTowODo0MFrOGWAftA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTcyOTk3Mg==", "bodyText": "I think it would be nice to generate this on Java side", "url": "https://github.com/hortonworks/cloudbreak/pull/8040#discussion_r425729972", "createdAt": "2020-05-15T11:08:40Z", "author": {"login": "doktoric"}, "path": "cloud-aws/src/main/resources/templates/aws-cf-network.ftl", "diffHunk": "@@ -119,38 +136,42 @@\n     </#if>\n     </#list>\n \n-    <#if privateSubnetEnabled == true>\n-    \"S3Endpoint\" : {\n+    <#list vpcGatewayEndpoints as vpcGatewayEndpoint>\n+    \"${vpcGatewayEndpoint?replace(\"[-\\\\.]\", \"\")}Endpoint\" : {\n       \"Type\" : \"AWS::EC2::VPCEndpoint\",\n       \"Properties\" : {\n         \"RouteTableIds\" : [\n-         {\"Ref\" : \"PublicRouteTable\"} <#if privateSubnetEnabled == true>, </#if>\n-        <#list subnetDetails as subnet>\n+          {\"Ref\" : \"PublicRouteTable\"} <#if privateSubnetEnabled == true>, </#if>\n+          <#if privateSubnetEnabled == true>\n+          <#list subnetDetails as subnet>\n             <#if subnet.privateSubnetCidr?has_content>\n-             {\"Ref\" : \"PRT${subnet.index}\"}<#if subnet_has_next>,</#if>\n+              {\"Ref\" : \"PRT${subnet.index}\"}<#if subnet_has_next>,</#if>\n             </#if>\n-        </#list>\n+          </#list>\n+          </#if>\n         ],\n-        \"ServiceName\" : { \"Fn::Sub\": \"com.amazonaws.${r\"${AWS::Region}\"}.s3\" },\n+        \"ServiceName\" : { \"Fn::Sub\": \"com.amazonaws.${r\"${AWS::Region}\"}.${vpcGatewayEndpoint}\" },\n         \"VpcId\" : {\"Ref\" : \"VPC\"}\n       }\n     },\n-    \"DDBEndpoint\" : {\n+    </#list>\n+    <#list vpcInterfaceEndpointsMap as vpcInterfaceEndpoint, azSubnets>\n+    \"${vpcInterfaceEndpoint?replace(\"[-\\\\.]\", \"\", \"r\")}Endpoint\" : {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5f6d6286330c2f949ae5d82640294bb8aa2ceb42"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1MTE0NDUxOnYy", "diffSide": "RIGHT", "path": "environment/src/main/java/com/sequenceiq/environment/network/dao/domain/converter/ServiceEndpointCreationConverter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxMToyMjowM1rOGWA3Xw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxMToyMjowM1rOGWA3Xw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTczNjAzMQ==", "bodyText": "please write a unit test for this", "url": "https://github.com/hortonworks/cloudbreak/pull/8040#discussion_r425736031", "createdAt": "2020-05-15T11:22:03Z", "author": {"login": "doktoric"}, "path": "environment/src/main/java/com/sequenceiq/environment/network/dao/domain/converter/ServiceEndpointCreationConverter.java", "diffHunk": "@@ -0,0 +1,11 @@\n+package com.sequenceiq.environment.network.dao.domain.converter;\n+\n+import com.sequenceiq.cloudbreak.converter.DefaultEnumConverter;\n+import com.sequenceiq.environment.api.v1.environment.model.base.ServiceEndpointCreation;\n+\n+public class ServiceEndpointCreationConverter extends DefaultEnumConverter<ServiceEndpointCreation> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5f6d6286330c2f949ae5d82640294bb8aa2ceb42"}, "originalPosition": 6}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2465, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}