{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM1MjU3MTg1", "number": 9618, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxNTo1ODoxN1rOFDACqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxNjowMDowOVrOFDAG4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM4NjkwNzI5OnYy", "diffSide": "RIGHT", "path": "common/src/main/java/com/sequenceiq/cloudbreak/telemetry/DataBusEndpointProvider.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxNTo1ODoxN1rOICcIdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxNjowMzoxOVrOICcZIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQyODk4Mw==", "bodyText": "Are we sure this URL won't change? If not, then maybe it is worth to make a new config property for this in application.yml", "url": "https://github.com/hortonworks/cloudbreak/pull/9618#discussion_r539428983", "createdAt": "2020-12-09T15:58:17Z", "author": {"login": "horadla23"}, "path": "common/src/main/java/com/sequenceiq/cloudbreak/telemetry/DataBusEndpointProvider.java", "diffHunk": "@@ -0,0 +1,22 @@\n+package com.sequenceiq.cloudbreak.telemetry;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+@Component\n+public class DataBusEndpointProvider {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(DataBusEndpointProvider.class);\n+\n+    private static final String CNAME_ENDPOINT = \"https://dbusapi.us-west-1.altus.cloudera.com\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5aa9c8593707b9dec57468534a428653020ac5c8"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQzMjczNQ==", "bodyText": "does not seemed to be changed ever. I can do a follow-up change if that will be needed. although if it changes it should be changed everywhere so actually it sounds more like a constant still", "url": "https://github.com/hortonworks/cloudbreak/pull/9618#discussion_r539432735", "createdAt": "2020-12-09T16:02:41Z", "author": {"login": "oleewere"}, "path": "common/src/main/java/com/sequenceiq/cloudbreak/telemetry/DataBusEndpointProvider.java", "diffHunk": "@@ -0,0 +1,22 @@\n+package com.sequenceiq.cloudbreak.telemetry;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+@Component\n+public class DataBusEndpointProvider {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(DataBusEndpointProvider.class);\n+\n+    private static final String CNAME_ENDPOINT = \"https://dbusapi.us-west-1.altus.cloudera.com\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQyODk4Mw=="}, "originalCommit": {"oid": "5aa9c8593707b9dec57468534a428653020ac5c8"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQzMzI0OA==", "bodyText": "ok, then it is fine for me", "url": "https://github.com/hortonworks/cloudbreak/pull/9618#discussion_r539433248", "createdAt": "2020-12-09T16:03:19Z", "author": {"login": "horadla23"}, "path": "common/src/main/java/com/sequenceiq/cloudbreak/telemetry/DataBusEndpointProvider.java", "diffHunk": "@@ -0,0 +1,22 @@\n+package com.sequenceiq.cloudbreak.telemetry;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+@Component\n+public class DataBusEndpointProvider {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(DataBusEndpointProvider.class);\n+\n+    private static final String CNAME_ENDPOINT = \"https://dbusapi.us-west-1.altus.cloudera.com\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQyODk4Mw=="}, "originalCommit": {"oid": "5aa9c8593707b9dec57468534a428653020ac5c8"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM4NjkxODExOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/sequenceiq/cloudbreak/core/flow2/service/DiagnosticsTriggerService.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxNjowMDoxMFrOICcOxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxNjowMzozNFrOICcZ4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQzMDU5OA==", "bodyText": "This logic is very similar to the logic in TelemetryDecorator and in ClouderaManagerMgmtTelemetryService, might worth to make an own method for it somewhere, maybe in DataBusEndpointProvider, then you do not need to inject Entitlementservice  everywhere", "url": "https://github.com/hortonworks/cloudbreak/pull/9618#discussion_r539430598", "createdAt": "2020-12-09T16:00:10Z", "author": {"login": "horadla23"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/core/flow2/service/DiagnosticsTriggerService.java", "diffHunk": "@@ -71,9 +81,12 @@ public FlowIdentifier startDiagnosticsCollection(BaseDiagnosticsCollectionReques\n                 && StringUtils.isNotBlank(stack.getCluster().getBlueprint().getStackVersion())) {\n             clusterVersion = stack.getCluster().getBlueprint().getStackVersion();\n         }\n+        String accountId = Crn.fromString(stack.getResourceCrn()).getAccountId();\n+        boolean useDbusCnameEndpoint = entitlementService.useDataBusCNameEndpointEnabled(INTERNAL_ACTOR_CRN, accountId);\n+        String databusEndpoint = dataBusEndpointProvider.getDataBusEndpoint(telemetry.getDatabusEndpoint(), useDbusCnameEndpoint);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5aa9c8593707b9dec57468534a428653020ac5c8"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQzMjA4Mw==", "bodyText": "common has no auth-connector dependency, first i tried to put these kind of code together in auth-connector but @lnardai did not want that (I understand) - so i cannot include Entitlementservice in DataBusEndpointProvider", "url": "https://github.com/hortonworks/cloudbreak/pull/9618#discussion_r539432083", "createdAt": "2020-12-09T16:01:55Z", "author": {"login": "oleewere"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/core/flow2/service/DiagnosticsTriggerService.java", "diffHunk": "@@ -71,9 +81,12 @@ public FlowIdentifier startDiagnosticsCollection(BaseDiagnosticsCollectionReques\n                 && StringUtils.isNotBlank(stack.getCluster().getBlueprint().getStackVersion())) {\n             clusterVersion = stack.getCluster().getBlueprint().getStackVersion();\n         }\n+        String accountId = Crn.fromString(stack.getResourceCrn()).getAccountId();\n+        boolean useDbusCnameEndpoint = entitlementService.useDataBusCNameEndpointEnabled(INTERNAL_ACTOR_CRN, accountId);\n+        String databusEndpoint = dataBusEndpointProvider.getDataBusEndpoint(telemetry.getDatabusEndpoint(), useDbusCnameEndpoint);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQzMDU5OA=="}, "originalCommit": {"oid": "5aa9c8593707b9dec57468534a428653020ac5c8"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQzMzQ0Mg==", "bodyText": "ohh i see, makes sense", "url": "https://github.com/hortonworks/cloudbreak/pull/9618#discussion_r539433442", "createdAt": "2020-12-09T16:03:34Z", "author": {"login": "horadla23"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/core/flow2/service/DiagnosticsTriggerService.java", "diffHunk": "@@ -71,9 +81,12 @@ public FlowIdentifier startDiagnosticsCollection(BaseDiagnosticsCollectionReques\n                 && StringUtils.isNotBlank(stack.getCluster().getBlueprint().getStackVersion())) {\n             clusterVersion = stack.getCluster().getBlueprint().getStackVersion();\n         }\n+        String accountId = Crn.fromString(stack.getResourceCrn()).getAccountId();\n+        boolean useDbusCnameEndpoint = entitlementService.useDataBusCNameEndpointEnabled(INTERNAL_ACTOR_CRN, accountId);\n+        String databusEndpoint = dataBusEndpointProvider.getDataBusEndpoint(telemetry.getDatabusEndpoint(), useDbusCnameEndpoint);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQzMDU5OA=="}, "originalCommit": {"oid": "5aa9c8593707b9dec57468534a428653020ac5c8"}, "originalPosition": 43}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3443, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}