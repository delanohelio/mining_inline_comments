{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ1MDMzNDUz", "number": 9683, "title": "CB-9746: Adding LoadBalancer FQDN endpoints to the datalake services.", "bodyText": "This PR addresses the following Jiras:\nhttps://jira.cloudera.com/browse/CB-9746\nhttps://jira.cloudera.com/browse/CB-10123\nSpecifically, I am attempting to change the endpoints assigned to all of the Datalake services from being constructed with a Knox URL to being constructed with the LoadBalancer URL.\nThe end-goal is for this change to be reflected across both the CDP UI and any other way of attempting to access the individual service endpoints", "createdAt": "2020-12-23T21:18:25Z", "url": "https://github.com/hortonworks/cloudbreak/pull/9683", "merged": true, "mergeCommit": {"oid": "b43c26390590fc232957f4ac35c4f0bae6d32864"}, "closed": true, "closedAt": "2021-01-07T20:07:27Z", "author": {"login": "sxxgrc"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdpGO5fABqjQxNDU2MDAzMjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdt2k0ZgBqjQxODA2MTY2NDA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "97b9228866e01ae1825a9b5d64e1963b0f4c5607", "author": {"user": {"login": "sxxgrc", "name": "Santiago Garcia Acosta"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/97b9228866e01ae1825a9b5d64e1963b0f4c5607", "committedDate": "2020-12-23T21:13:40Z", "message": "CB-9746: Adding LoadBalancer FQDN endpoints to the datalake services."}, "afterCommit": {"oid": "c82f9d70907f91211c364777acc39e8dd1cf154a", "author": {"user": {"login": "sxxgrc", "name": "Santiago Garcia Acosta"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/c82f9d70907f91211c364777acc39e8dd1cf154a", "committedDate": "2020-12-23T21:43:26Z", "message": "CB-9746: Adding LoadBalancer FQDN endpoints to the datalake services."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYxMTMzMTM3", "url": "https://github.com/hortonworks/cloudbreak/pull/9683#pullrequestreview-561133137", "createdAt": "2021-01-04T15:47:53Z", "commit": {"oid": "c82f9d70907f91211c364777acc39e8dd1cf154a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQxNTo0Nzo1M1rOIN2nWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQxNjowMTozNFrOIN3Jcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTM5NzIwOQ==", "bodyText": "nit: This import is int the wrong place.", "url": "https://github.com/hortonworks/cloudbreak/pull/9683#discussion_r551397209", "createdAt": "2021-01-04T15:47:53Z", "author": {"login": "hreeve-cloudera"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/core/bootstrap/service/host/ClusterHostServiceRunner.java", "diffHunk": "@@ -28,6 +28,7 @@\n import javax.annotation.Nonnull;\n import javax.inject.Inject;\n \n+import com.sequenceiq.common.api.type.LoadBalancerType;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c82f9d70907f91211c364777acc39e8dd1cf154a"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTM5ODczMQ==", "bodyText": "This orElse is internal within the filter method, correct? It's hard to parse as-is, because it's indented to the same level as the calls that are directly on stream(), so it seems like it should also be directly on stream(). Could you either change the indentation, or break this call out into two lines so it's easier to read?", "url": "https://github.com/hortonworks/cloudbreak/pull/9683#discussion_r551398731", "createdAt": "2021-01-04T15:50:10Z", "author": {"login": "hreeve-cloudera"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/core/bootstrap/service/host/ClusterHostServiceRunner.java", "diffHunk": "@@ -629,7 +630,19 @@ private void addGatewayUserFacingCertAndFqdn(GatewayConfig gatewayConfig, Cluste\n             gateway.put(\"userfacingkey\", cluster.getStack().getSecurityConfig().getUserFacingKey());\n             gateway.put(\"userfacingcert\", cluster.getStack().getSecurityConfig().getUserFacingCert());\n         }\n-        String fqdn = cluster.getFqdn();\n+\n+        String fqdn = null;\n+        if (cluster.getStack().getLoadBalancers() != null && cluster.getStack().getLoadBalancers().size() > 0) {\n+            fqdn = (cluster.getStack().getLoadBalancers().stream()\n+                    .filter(lb -> lb.getType() == LoadBalancerType.PUBLIC).findAny()\n+                    .orElse(cluster.getStack().getLoadBalancers().iterator().next()))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c82f9d70907f91211c364777acc39e8dd1cf154a"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTM5OTc5Ng==", "bodyText": "We should make this check isNotEmpty, so we don't set the fqdn to an empty string.", "url": "https://github.com/hortonworks/cloudbreak/pull/9683#discussion_r551399796", "createdAt": "2021-01-04T15:51:49Z", "author": {"login": "hreeve-cloudera"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/core/bootstrap/service/host/ClusterHostServiceRunner.java", "diffHunk": "@@ -629,7 +630,19 @@ private void addGatewayUserFacingCertAndFqdn(GatewayConfig gatewayConfig, Cluste\n             gateway.put(\"userfacingkey\", cluster.getStack().getSecurityConfig().getUserFacingKey());\n             gateway.put(\"userfacingcert\", cluster.getStack().getSecurityConfig().getUserFacingCert());\n         }\n-        String fqdn = cluster.getFqdn();\n+\n+        String fqdn = null;\n+        if (cluster.getStack().getLoadBalancers() != null && cluster.getStack().getLoadBalancers().size() > 0) {\n+            fqdn = (cluster.getStack().getLoadBalancers().stream()\n+                    .filter(lb -> lb.getType() == LoadBalancerType.PUBLIC).findAny()\n+                    .orElse(cluster.getStack().getLoadBalancers().iterator().next()))\n+                    .getFqdn();\n+        }\n+\n+        if (fqdn == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c82f9d70907f91211c364777acc39e8dd1cf154a"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTQwMTQwNw==", "bodyText": "To be safe, we should make sure this logic isn't triggered if the DNS for the load balancer couldn't be registered. (See the else statement directly above this).", "url": "https://github.com/hortonworks/cloudbreak/pull/9683#discussion_r551401407", "createdAt": "2021-01-04T15:54:26Z", "author": {"login": "hreeve-cloudera"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/service/publicendpoint/GatewayPublicEndpointManagementService.java", "diffHunk": "@@ -132,6 +132,9 @@ public void updateDnsEntryForLoadBalancers(Stack stack) {\n                     LOGGER.warn(\"Could not find IP or cloud DNS info for load balancer with endpoint {} .\" +\n                         \"DNS registration will be skipped.\", loadBalancer.getEndpoint());\n                 }\n+\n+                loadBalancer.setFqdn(getDomainNameProvider().getFullyQualifiedEndpointName(\n+                        endpoint.get(), environment.getName(), getWorkloadSubdomain(userCrn)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c82f9d70907f91211c364777acc39e8dd1cf154a"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTQwMTU3Ng==", "bodyText": "nit: This import is in the wrong place.", "url": "https://github.com/hortonworks/cloudbreak/pull/9683#discussion_r551401576", "createdAt": "2021-01-04T15:54:40Z", "author": {"login": "hreeve-cloudera"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/util/StackUtil.java", "diffHunk": "@@ -11,6 +11,7 @@\n \n import javax.inject.Inject;\n \n+import com.sequenceiq.common.api.type.LoadBalancerType;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c82f9d70907f91211c364777acc39e8dd1cf154a"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTQwMjkwMw==", "bodyText": "Same note about the indentation here. Since this code looks the same as the other code block, it might be worth pulling it out into a common method. Maybe putting it directly in Stack, so you can just call something like stack.getLoadBalancerUserFacingFQDN().", "url": "https://github.com/hortonworks/cloudbreak/pull/9683#discussion_r551402903", "createdAt": "2021-01-04T15:56:43Z", "author": {"login": "hreeve-cloudera"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/util/StackUtil.java", "diffHunk": "@@ -177,6 +178,13 @@ private String extractClusterManagerIp(long stackId) {\n     }\n \n     public String extractClusterManagerAddress(Stack stack) {\n+        if (stack.getLoadBalancers() != null && stack.getLoadBalancers().size() != 0) {\n+            return (stack.getLoadBalancers().stream()\n+                    .filter(lb -> lb.getType() == LoadBalancerType.PUBLIC).findAny()\n+                    .orElse(stack.getLoadBalancers().iterator().next()))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c82f9d70907f91211c364777acc39e8dd1cf154a"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTQwNTUwNw==", "bodyText": "I don't think we should have the default be a string value. You're not checking the value of the load balancer FQDN name anywhere that I saw, so it seems like the code could see the string \"No Info\" and think that's a perfectly valid domain. I don't think we need a default value, since if it isn't set it should just be null, and then the statements that check if it's null will correctly evaluate to false.", "url": "https://github.com/hortonworks/cloudbreak/pull/9683#discussion_r551405507", "createdAt": "2021-01-04T16:00:50Z", "author": {"login": "hreeve-cloudera"}, "path": "core/src/main/resources/schema/app/20201221232206_CB-9746:_Use_new_loadbalancer_endpoints_for_DL_services.sql", "diffHunk": "@@ -0,0 +1,10 @@\n+-- // CB-9746: Use new loadbalancer endpoints for DL services\n+-- Migration SQL that makes the change goes here.\n+\n+ALTER TABLE loadbalancer ADD COLUMN IF NOT EXISTS fqdn character varying(255) DEFAULT 'No Info';\n+UPDATE loadbalancer SET fqdn = 'No Info' WHERE fqdn IS NULL;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c82f9d70907f91211c364777acc39e8dd1cf154a"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTQwNTkzOQ==", "bodyText": "I've been asked by the CB team to not enable this by default, since it only really works if you're using mow-dev UMS and most people won't be.", "url": "https://github.com/hortonworks/cloudbreak/pull/9683#discussion_r551405939", "createdAt": "2021-01-04T16:01:34Z", "author": {"login": "hreeve-cloudera"}, "path": "mock-thunderhead/src/main/resources/application.yml", "diffHunk": "@@ -34,4 +34,4 @@ auth:\n     database.wire.encryption.enable: true\n     datahub.runtime.upgrade.enable: true\n     embedded.database.on.attached.disk.enable: true\n-    datalake.loadbalancer.enable: false\n+    datalake.loadbalancer.enable: true", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c82f9d70907f91211c364777acc39e8dd1cf154a"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYxMjE5MDM1", "url": "https://github.com/hortonworks/cloudbreak/pull/9683#pullrequestreview-561219035", "createdAt": "2021-01-04T17:49:04Z", "commit": {"oid": "c82f9d70907f91211c364777acc39e8dd1cf154a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c82f9d70907f91211c364777acc39e8dd1cf154a", "author": {"user": {"login": "sxxgrc", "name": "Santiago Garcia Acosta"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/c82f9d70907f91211c364777acc39e8dd1cf154a", "committedDate": "2020-12-23T21:43:26Z", "message": "CB-9746: Adding LoadBalancer FQDN endpoints to the datalake services."}, "afterCommit": {"oid": "e18a4ae25eb87b57f9a61c55be608821d962d894", "author": {"user": {"login": "sxxgrc", "name": "Santiago Garcia Acosta"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/e18a4ae25eb87b57f9a61c55be608821d962d894", "committedDate": "2021-01-04T18:27:13Z", "message": "CB-9746: Adding LoadBalancer FQDN endpoints to the datalake services."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e18a4ae25eb87b57f9a61c55be608821d962d894", "author": {"user": {"login": "sxxgrc", "name": "Santiago Garcia Acosta"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/e18a4ae25eb87b57f9a61c55be608821d962d894", "committedDate": "2021-01-04T18:27:13Z", "message": "CB-9746: Adding LoadBalancer FQDN endpoints to the datalake services."}, "afterCommit": {"oid": "1a127096ae2637165f6969070eff37da2a353c08", "author": {"user": {"login": "sxxgrc", "name": "Santiago Garcia Acosta"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/1a127096ae2637165f6969070eff37da2a353c08", "committedDate": "2021-01-04T18:28:40Z", "message": "CB-9746: Adding LoadBalancer FQDN endpoints to the datalake services."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1a127096ae2637165f6969070eff37da2a353c08", "author": {"user": {"login": "sxxgrc", "name": "Santiago Garcia Acosta"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/1a127096ae2637165f6969070eff37da2a353c08", "committedDate": "2021-01-04T18:28:40Z", "message": "CB-9746: Adding LoadBalancer FQDN endpoints to the datalake services."}, "afterCommit": {"oid": "d3157258410ac9bddb0b080ae787a4eff14a8d38", "author": {"user": {"login": "sxxgrc", "name": "Santiago Garcia Acosta"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/d3157258410ac9bddb0b080ae787a4eff14a8d38", "committedDate": "2021-01-04T18:52:46Z", "message": "CB-9746: Adding LoadBalancer FQDN endpoints to the datalake services."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYyMjU3OTI1", "url": "https://github.com/hortonworks/cloudbreak/pull/9683#pullrequestreview-562257925", "createdAt": "2021-01-06T01:00:47Z", "commit": {"oid": "c7d5b13f51462e99384e4f64fa621e066ac7a9b9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c7d5b13f51462e99384e4f64fa621e066ac7a9b9", "author": {"user": {"login": "hreeve-cloudera", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/c7d5b13f51462e99384e4f64fa621e066ac7a9b9", "committedDate": "2021-01-04T22:35:13Z", "message": "Saving LB to database after setting FQDN, and loading directly from database instead of indirectly through Stack."}, "afterCommit": {"oid": "7ba987fa80cb312a435f05b5bf041effd97b8579", "author": {"user": {"login": "hreeve-cloudera", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/7ba987fa80cb312a435f05b5bf041effd97b8579", "committedDate": "2021-01-06T02:31:24Z", "message": "Saving LB to database after setting FQDN, and loading directly from database instead of indirectly through Stack."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYzMDUxMDk3", "url": "https://github.com/hortonworks/cloudbreak/pull/9683#pullrequestreview-563051097", "createdAt": "2021-01-06T21:34:44Z", "commit": {"oid": "7ba987fa80cb312a435f05b5bf041effd97b8579"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7ba987fa80cb312a435f05b5bf041effd97b8579", "author": {"user": {"login": "hreeve-cloudera", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/7ba987fa80cb312a435f05b5bf041effd97b8579", "committedDate": "2021-01-06T02:31:24Z", "message": "Saving LB to database after setting FQDN, and loading directly from database instead of indirectly through Stack."}, "afterCommit": {"oid": "ae86e7669905e482306296cfa4fa4ccf8303406a", "author": {"user": {"login": "hreeve-cloudera", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/ae86e7669905e482306296cfa4fa4ccf8303406a", "committedDate": "2021-01-07T00:50:36Z", "message": "Saving LB to database after setting FQDN, and loading directly from database instead of indirectly through Stack."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b526b793ba56b48f33638a815a0746b0ec82f7eb", "author": {"user": {"login": "sxxgrc", "name": "Santiago Garcia Acosta"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/b526b793ba56b48f33638a815a0746b0ec82f7eb", "committedDate": "2021-01-07T16:18:37Z", "message": "CB-9746: Adding LoadBalancer FQDN endpoints to the datalake services."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ae86e7669905e482306296cfa4fa4ccf8303406a", "author": {"user": {"login": "hreeve-cloudera", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/ae86e7669905e482306296cfa4fa4ccf8303406a", "committedDate": "2021-01-07T00:50:36Z", "message": "Saving LB to database after setting FQDN, and loading directly from database instead of indirectly through Stack."}, "afterCommit": {"oid": "b526b793ba56b48f33638a815a0746b0ec82f7eb", "author": {"user": {"login": "sxxgrc", "name": "Santiago Garcia Acosta"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/b526b793ba56b48f33638a815a0746b0ec82f7eb", "committedDate": "2021-01-07T16:18:37Z", "message": "CB-9746: Adding LoadBalancer FQDN endpoints to the datalake services."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1912, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}