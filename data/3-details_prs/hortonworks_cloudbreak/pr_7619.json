{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxNDE3NDg2", "number": 7619, "title": "CB-6161 Fix HDFS user home directory creation for HA configuration", "bodyText": "", "createdAt": "2020-03-20T08:53:44Z", "url": "https://github.com/hortonworks/cloudbreak/pull/7619", "merged": true, "mergeCommit": {"oid": "40c3c36dd320903dc203865aa1c9d4b20acc59bd"}, "closed": true, "closedAt": "2020-03-23T09:22:39Z", "author": {"login": "lacikaaa"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcPc7jQAFqTM3ODMyNDQ5NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcQZ-QjABqjMxNTQxMDQ3OTU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4MzI0NDk0", "url": "https://github.com/hortonworks/cloudbreak/pull/7619#pullrequestreview-378324494", "createdAt": "2020-03-20T09:16:44Z", "commit": {"oid": "1e216d8dd0f4fbbc442524729d4cad6492cee5f0"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQwOToxNjo0NFrOF5MQOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQwOToxNjo0NFrOF5MQOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTUxMzkxNA==", "bodyText": "I'm guessing you need the colon here between host and port if I'm reading this correctly?", "url": "https://github.com/hortonworks/cloudbreak/pull/7619#discussion_r395513914", "createdAt": "2020-03-20T09:16:44Z", "author": {"login": "risdenk"}, "path": "orchestrator-salt/src/main/resources/salt/salt/post-recipes/scripts/createuserhome.sh", "diffHunk": "@@ -71,25 +71,47 @@ PATH_PREFIX=\"/user\"\n \n export KRB5CCNAME=/tmp/krb5cc_cloudbreak_$EUID\n \n+\n+klist -s\n+if [[ $? -ne 0 ]]; then\n+  kinit_as_hdfs\n+fi\n+\n WEBHDFS_HTTP_POLICY=$(hdfs getconf -confkey dfs.http.policy)\n \n-if [ \"$WEBHDFS_HTTP_POLICY\" == \"HTTP_ONLY\" ]; then\n-  NAMENODE_HTTP_ADDRESS=$(hdfs getconf -confkey dfs.namenode.http-address)\n-  WEBHDFS_URL=http://$NAMENODE_HTTP_ADDRESS/webhdfs/v1\n+hdfs haadmin -getAllServiceState\n+if [[ $? -ne 0 ]]; then\n+  echo \"Single node configuration\"\n+  if [ \"$WEBHDFS_HTTP_POLICY\" == \"HTTP_ONLY\" ]; then\n+    NAMENODE_HTTP_ADDRESS=$(hdfs getconf -confkey dfs.namenode.http-address)\n+    WEBHDFS_URL=http://$NAMENODE_HTTP_ADDRESS/webhdfs/v1\n+  else\n+    NAMENODE_HTTP_ADDRESS=$(hdfs getconf -confkey dfs.namenode.https-address)\n+    WEBHDFS_URL=https://$NAMENODE_HTTP_ADDRESS/webhdfs/v1\n+  fi\n else\n-  NAMENODE_HTTP_ADDRESS=$(hdfs getconf -confkey dfs.namenode.https-address)\n-  WEBHDFS_URL=https://$NAMENODE_HTTP_ADDRESS/webhdfs/v1\n+  echo \"HA configuration\"\n+  NN_HOST=$(hdfs haadmin -getAllServiceState | grep active | cut -d':' -f 1)\n+  echo \"Active NAMENODE host: $NN_HOST\"\n+  if [ \"$NN_HOST\" != \"$(hostname -f)\" ]; then\n+    echo \"This is not the active host. Script will run on the active one\"\n+    exit 0\n+  fi\n+  if [ \"$WEBHDFS_HTTP_POLICY\" == \"HTTP_ONLY\" ]; then\n+    NAMENODE_PORT=$(hdfs getconf -confkey dfs.namenode.http-address | cut -d':' -f 2)\n+    echo \"NN port: $NAMENODE_PORT\"\n+    WEBHDFS_URL=http://$NN_HOST$NAMENODE_PORT/webhdfs/v1", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e216d8dd0f4fbbc442524729d4cad6492cee5f0"}, "originalPosition": 38}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1e216d8dd0f4fbbc442524729d4cad6492cee5f0", "author": {"user": {"login": "lacikaaa", "name": "Mihaly Laszlo Molnar"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/1e216d8dd0f4fbbc442524729d4cad6492cee5f0", "committedDate": "2020-03-20T08:51:57Z", "message": "CB-6161 Fix HDFS user home directory creation for HA configuration"}, "afterCommit": {"oid": "efdedbda44fabd04595adf6614c6f18bc16894cc", "author": {"user": {"login": "lacikaaa", "name": "Mihaly Laszlo Molnar"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/efdedbda44fabd04595adf6614c6f18bc16894cc", "committedDate": "2020-03-20T10:18:46Z", "message": "CB-6161 Fix HDFS user home directory creation for HA configuration"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4NDY5MDIw", "url": "https://github.com/hortonworks/cloudbreak/pull/7619#pullrequestreview-378469020", "createdAt": "2020-03-20T13:13:06Z", "commit": {"oid": "efdedbda44fabd04595adf6614c6f18bc16894cc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxMzoxMzowN1rOF5TG4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxMzoxMzowN1rOF5TG4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTYyNjIwOA==", "bodyText": "Do we need this check in the case of non HA? This to me looks like this script will be installed on all the nodes or maybe just the namenodes?", "url": "https://github.com/hortonworks/cloudbreak/pull/7619#discussion_r395626208", "createdAt": "2020-03-20T13:13:07Z", "author": {"login": "risdenk"}, "path": "orchestrator-salt/src/main/resources/salt/salt/post-recipes/scripts/createuserhome.sh", "diffHunk": "@@ -71,25 +71,47 @@ PATH_PREFIX=\"/user\"\n \n export KRB5CCNAME=/tmp/krb5cc_cloudbreak_$EUID\n \n+\n+klist -s\n+if [[ $? -ne 0 ]]; then\n+  kinit_as_hdfs\n+fi\n+\n WEBHDFS_HTTP_POLICY=$(hdfs getconf -confkey dfs.http.policy)\n \n-if [ \"$WEBHDFS_HTTP_POLICY\" == \"HTTP_ONLY\" ]; then\n-  NAMENODE_HTTP_ADDRESS=$(hdfs getconf -confkey dfs.namenode.http-address)\n-  WEBHDFS_URL=http://$NAMENODE_HTTP_ADDRESS/webhdfs/v1\n+hdfs haadmin -getAllServiceState\n+if [[ $? -ne 0 ]]; then\n+  echo \"Single node configuration\"\n+  if [ \"$WEBHDFS_HTTP_POLICY\" == \"HTTP_ONLY\" ]; then\n+    NAMENODE_HTTP_ADDRESS=$(hdfs getconf -confkey dfs.namenode.http-address)\n+    WEBHDFS_URL=http://$NAMENODE_HTTP_ADDRESS/webhdfs/v1\n+  else\n+    NAMENODE_HTTP_ADDRESS=$(hdfs getconf -confkey dfs.namenode.https-address)\n+    WEBHDFS_URL=https://$NAMENODE_HTTP_ADDRESS/webhdfs/v1\n+  fi\n else\n-  NAMENODE_HTTP_ADDRESS=$(hdfs getconf -confkey dfs.namenode.https-address)\n-  WEBHDFS_URL=https://$NAMENODE_HTTP_ADDRESS/webhdfs/v1\n+  echo \"HA configuration\"\n+  NN_HOST=$(hdfs haadmin -getAllServiceState | grep active | cut -d':' -f 1)\n+  echo \"Active NAMENODE host: $NN_HOST\"\n+  if [ \"$NN_HOST\" != \"$(hostname -f)\" ]; then", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "efdedbda44fabd04595adf6614c6f18bc16894cc"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4NDY5NDc0", "url": "https://github.com/hortonworks/cloudbreak/pull/7619#pullrequestreview-378469474", "createdAt": "2020-03-20T13:13:43Z", "commit": {"oid": "efdedbda44fabd04595adf6614c6f18bc16894cc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxMzoxMzo0M1rOF5TIQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxMzoxMzo0M1rOF5TIQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTYyNjU2MQ==", "bodyText": "nit: you can put this in the if statement itself to check status code instead of a separate line if you wanted.", "url": "https://github.com/hortonworks/cloudbreak/pull/7619#discussion_r395626561", "createdAt": "2020-03-20T13:13:43Z", "author": {"login": "risdenk"}, "path": "orchestrator-salt/src/main/resources/salt/salt/post-recipes/scripts/createuserhome.sh", "diffHunk": "@@ -71,25 +71,47 @@ PATH_PREFIX=\"/user\"\n \n export KRB5CCNAME=/tmp/krb5cc_cloudbreak_$EUID\n \n+\n+klist -s\n+if [[ $? -ne 0 ]]; then\n+  kinit_as_hdfs\n+fi\n+\n WEBHDFS_HTTP_POLICY=$(hdfs getconf -confkey dfs.http.policy)\n \n-if [ \"$WEBHDFS_HTTP_POLICY\" == \"HTTP_ONLY\" ]; then\n-  NAMENODE_HTTP_ADDRESS=$(hdfs getconf -confkey dfs.namenode.http-address)\n-  WEBHDFS_URL=http://$NAMENODE_HTTP_ADDRESS/webhdfs/v1\n+hdfs haadmin -getAllServiceState", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "efdedbda44fabd04595adf6614c6f18bc16894cc"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4NDY5NTUx", "url": "https://github.com/hortonworks/cloudbreak/pull/7619#pullrequestreview-378469551", "createdAt": "2020-03-20T13:13:48Z", "commit": {"oid": "efdedbda44fabd04595adf6614c6f18bc16894cc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4NTU1MjY2", "url": "https://github.com/hortonworks/cloudbreak/pull/7619#pullrequestreview-378555266", "createdAt": "2020-03-20T14:56:18Z", "commit": {"oid": "efdedbda44fabd04595adf6614c6f18bc16894cc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "efdedbda44fabd04595adf6614c6f18bc16894cc", "author": {"user": {"login": "lacikaaa", "name": "Mihaly Laszlo Molnar"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/efdedbda44fabd04595adf6614c6f18bc16894cc", "committedDate": "2020-03-20T10:18:46Z", "message": "CB-6161 Fix HDFS user home directory creation for HA configuration"}, "afterCommit": {"oid": "0314a03b1e82ce47de73c5bce5206c7c40e0150e", "author": {"user": {"login": "lacikaaa", "name": "Mihaly Laszlo Molnar"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/0314a03b1e82ce47de73c5bce5206c7c40e0150e", "committedDate": "2020-03-20T15:05:19Z", "message": "CB-6161 Fix HDFS user home directory creation for HA configuration"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0314a03b1e82ce47de73c5bce5206c7c40e0150e", "author": {"user": {"login": "lacikaaa", "name": "Mihaly Laszlo Molnar"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/0314a03b1e82ce47de73c5bce5206c7c40e0150e", "committedDate": "2020-03-20T15:05:19Z", "message": "CB-6161 Fix HDFS user home directory creation for HA configuration"}, "afterCommit": {"oid": "097e4401110a96142f42a93428bbb39e9db5961a", "author": {"user": {"login": "lacikaaa", "name": "Mihaly Laszlo Molnar"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/097e4401110a96142f42a93428bbb39e9db5961a", "committedDate": "2020-03-20T18:15:15Z", "message": "CB-6161 Fix HDFS user home directory creation for HA configuration"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4NzE1MjAy", "url": "https://github.com/hortonworks/cloudbreak/pull/7619#pullrequestreview-378715202", "createdAt": "2020-03-20T18:20:26Z", "commit": {"oid": "097e4401110a96142f42a93428bbb39e9db5961a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxODoyMDoyNlrOF5ep1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxODoyMDoyNlrOF5ep1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgxNTM4MA==", "bodyText": "this doesn't seem like a robust approach. I have two concerns:\n\nis it possible that this runs concurrently with the namenodes starting, in which case neither NN is active yet?\nit's definitely possible that one of the NNs fails around the same time these two scripts are running. In that case either neither or both of the copies of this script will run.\n\nit seems this script should be idempotent. How often does it get re-run? eg if for some reason we hit one of the above issues, would it run again a minute later and just be a transient problem, or would we be left in a persistent unsynced state?", "url": "https://github.com/hortonworks/cloudbreak/pull/7619#discussion_r395815380", "createdAt": "2020-03-20T18:20:26Z", "author": {"login": "toddlipcon"}, "path": "orchestrator-salt/src/main/resources/salt/salt/post-recipes/scripts/createuserhome.sh", "diffHunk": "@@ -71,25 +71,47 @@ PATH_PREFIX=\"/user\"\n \n export KRB5CCNAME=/tmp/krb5cc_cloudbreak_$EUID\n \n+\n+klist -s\n+if [[ $? -ne 0 ]]; then\n+  kinit_as_hdfs\n+fi\n+\n WEBHDFS_HTTP_POLICY=$(hdfs getconf -confkey dfs.http.policy)\n \n-if [ \"$WEBHDFS_HTTP_POLICY\" == \"HTTP_ONLY\" ]; then\n-  NAMENODE_HTTP_ADDRESS=$(hdfs getconf -confkey dfs.namenode.http-address)\n-  WEBHDFS_URL=http://$NAMENODE_HTTP_ADDRESS/webhdfs/v1\n+if ! hdfs haadmin -getAllServiceState\n+then\n+  echo \"Single node configuration\"\n+  if [ \"$WEBHDFS_HTTP_POLICY\" == \"HTTP_ONLY\" ]; then\n+    NAMENODE_HTTP_ADDRESS=$(hdfs getconf -confkey dfs.namenode.http-address)\n+    WEBHDFS_URL=http://$NAMENODE_HTTP_ADDRESS/webhdfs/v1\n+  else\n+    NAMENODE_HTTP_ADDRESS=$(hdfs getconf -confkey dfs.namenode.https-address)\n+    WEBHDFS_URL=https://$NAMENODE_HTTP_ADDRESS/webhdfs/v1\n+  fi\n else\n-  NAMENODE_HTTP_ADDRESS=$(hdfs getconf -confkey dfs.namenode.https-address)\n-  WEBHDFS_URL=https://$NAMENODE_HTTP_ADDRESS/webhdfs/v1\n+  echo \"HA configuration\"\n+  NN_HOST=$(hdfs haadmin -getAllServiceState | grep active | cut -d':' -f 1)\n+  echo \"Active NAMENODE host: $NN_HOST\"\n+  if [ \"$NN_HOST\" != \"$(hostname -f)\" ]; then\n+    echo \"This is not the active host. Script will run on the active one\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "097e4401110a96142f42a93428bbb39e9db5961a"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f79110e2ce84ebdf193db15e42f87f1c1166a67", "author": {"user": {"login": "lacikaaa", "name": "Mihaly Laszlo Molnar"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/3f79110e2ce84ebdf193db15e42f87f1c1166a67", "committedDate": "2020-03-23T08:23:38Z", "message": "CB-6161 Fix HDFS user home directory creation for HA configuration"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "097e4401110a96142f42a93428bbb39e9db5961a", "author": {"user": {"login": "lacikaaa", "name": "Mihaly Laszlo Molnar"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/097e4401110a96142f42a93428bbb39e9db5961a", "committedDate": "2020-03-20T18:15:15Z", "message": "CB-6161 Fix HDFS user home directory creation for HA configuration"}, "afterCommit": {"oid": "3f79110e2ce84ebdf193db15e42f87f1c1166a67", "author": {"user": {"login": "lacikaaa", "name": "Mihaly Laszlo Molnar"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/3f79110e2ce84ebdf193db15e42f87f1c1166a67", "committedDate": "2020-03-23T08:23:38Z", "message": "CB-6161 Fix HDFS user home directory creation for HA configuration"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2488, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}