{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDExMzE0NDY1", "number": 7943, "title": "CB-6830 Run AWS e2e tests on spot instances", "bodyText": "", "createdAt": "2020-04-30T10:10:37Z", "url": "https://github.com/hortonworks/cloudbreak/pull/7943", "merged": true, "mergeCommit": {"oid": "f49242c8841d42790b61a50db926b13527c15d54"}, "closed": true, "closedAt": "2020-06-02T09:09:37Z", "author": {"login": "Bajzathd"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABccq1z4gBqjMyODg3MDE4NTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcnRJ_xAFqTQyMjQ4NjAwMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "19bb96d7727a490091119dab419c9a1b75939722", "author": {"user": {"login": "Bajzathd", "name": "Bajz\u00e1th D\u00e1vid"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/19bb96d7727a490091119dab419c9a1b75939722", "committedDate": "2020-04-30T10:09:49Z", "message": "CB-6830 Run AWS integration tests on spot instances"}, "afterCommit": {"oid": "483615b0eb3a3c989c00fd999bb4e7cf2b257017", "author": {"user": {"login": "Bajzathd", "name": "Bajz\u00e1th D\u00e1vid"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/483615b0eb3a3c989c00fd999bb4e7cf2b257017", "committedDate": "2020-04-30T10:49:51Z", "message": "CB-6830 Run AWS integration tests on spot instances"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "483615b0eb3a3c989c00fd999bb4e7cf2b257017", "author": {"user": {"login": "Bajzathd", "name": "Bajz\u00e1th D\u00e1vid"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/483615b0eb3a3c989c00fd999bb4e7cf2b257017", "committedDate": "2020-04-30T10:49:51Z", "message": "CB-6830 Run AWS integration tests on spot instances"}, "afterCommit": {"oid": "283c9a8d36ba8ad706d5fa5d8567282584e99925", "author": {"user": {"login": "Bajzathd", "name": "Bajz\u00e1th D\u00e1vid"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/283c9a8d36ba8ad706d5fa5d8567282584e99925", "committedDate": "2020-05-15T14:10:36Z", "message": "CB-6830 Run AWS integration tests on spot instances"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzNTU2OTU3", "url": "https://github.com/hortonworks/cloudbreak/pull/7943#pullrequestreview-413556957", "createdAt": "2020-05-18T12:44:27Z", "commit": {"oid": "283c9a8d36ba8ad706d5fa5d8567282584e99925"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxMjo0NDoyN1rOGW1cIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxMjo0NDoyN1rOGW1cIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU5NzQwOQ==", "bodyText": "100 should be getSpotPercentage()", "url": "https://github.com/hortonworks/cloudbreak/pull/7943#discussion_r426597409", "createdAt": "2020-05-18T12:44:27Z", "author": {"login": "bergerdenes"}, "path": "integration-test/src/main/java/com/sequenceiq/it/cloudbreak/cloud/v4/aws/AwsCloudProvider.java", "diffHunk": "@@ -371,6 +391,28 @@ public void setInstanceTemplateV1Parameters(InstanceTemplateV1Request instanceTe\n         AwsEncryptionV1Parameters awsEncryptionV1Parameters = new AwsEncryptionV1Parameters();\n         awsEncryptionV1Parameters.setType(EncryptionType.DEFAULT);\n         awsInstanceTemplateV1Parameters.setEncryption(awsEncryptionV1Parameters);\n+        awsInstanceTemplateV1Parameters.setSpot(getAwsInstanceTemplateV1SpotParameters());\n         instanceTemplateV1Request.setAws(awsInstanceTemplateV1Parameters);\n     }\n+\n+    private AwsInstanceTemplateV1SpotParameters getAwsInstanceTemplateV1SpotParameters() {\n+        AwsInstanceTemplateV1SpotParameters awsInstanceTemplateV1SpotParameters = new AwsInstanceTemplateV1SpotParameters();\n+        awsInstanceTemplateV1SpotParameters.setPercentage(100);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "283c9a8d36ba8ad706d5fa5d8567282584e99925"}, "originalPosition": 84}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d2bef6dd3ded9e82b36f314f9aeb7677340ff914", "author": {"user": {"login": "Bajzathd", "name": "Bajz\u00e1th D\u00e1vid"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/d2bef6dd3ded9e82b36f314f9aeb7677340ff914", "committedDate": "2020-05-20T15:01:51Z", "message": "CB-6830 Revert unnecessary changes"}, "afterCommit": {"oid": "1f2519b78502937e7dad69ec6f5a9e08f318285a", "author": {"user": {"login": "Bajzathd", "name": "Bajz\u00e1th D\u00e1vid"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/1f2519b78502937e7dad69ec6f5a9e08f318285a", "committedDate": "2020-05-20T15:03:41Z", "message": "CB-6830 Revert unnecessary changes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "91aa09dd8c62df899c67ec8c52c209642a09bcec", "author": {"user": {"login": "Bajzathd", "name": "Bajz\u00e1th D\u00e1vid"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/91aa09dd8c62df899c67ec8c52c209642a09bcec", "committedDate": "2020-05-21T10:19:18Z", "message": "CB-6830 Add UseSpotInstances annotation to more test cases"}, "afterCommit": {"oid": "7464bc349dbe73ceb8ba057804fd2de47fdb2502", "author": {"user": {"login": "Bajzathd", "name": "Bajz\u00e1th D\u00e1vid"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/7464bc349dbe73ceb8ba057804fd2de47fdb2502", "committedDate": "2020-05-21T14:09:09Z", "message": "CB-6830 Run AWS e2e tests on spot instances"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7464bc349dbe73ceb8ba057804fd2de47fdb2502", "author": {"user": {"login": "Bajzathd", "name": "Bajz\u00e1th D\u00e1vid"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/7464bc349dbe73ceb8ba057804fd2de47fdb2502", "committedDate": "2020-05-21T14:09:09Z", "message": "CB-6830 Run AWS e2e tests on spot instances"}, "afterCommit": {"oid": "4540c07921aa4d00d69a01e6663dc1a3b32d14a5", "author": {"user": {"login": "Bajzathd", "name": "Bajz\u00e1th D\u00e1vid"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/4540c07921aa4d00d69a01e6663dc1a3b32d14a5", "committedDate": "2020-05-21T15:19:50Z", "message": "CB-6830 Run AWS e2e tests on spot instances"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2MTIwMTU4", "url": "https://github.com/hortonworks/cloudbreak/pull/7943#pullrequestreview-416120158", "createdAt": "2020-05-21T12:54:51Z", "commit": {"oid": "91aa09dd8c62df899c67ec8c52c209642a09bcec"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQxMjo1NDo1MVrOGYxsvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxMDo0MzozNFrOGbDqfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODYzMzI3Nw==", "bodyText": "this class uses DTOs only as return values. The AttachedFreeIpaRequest has its own DTO counterpart: FreeIpaCreationDto. Check please how could you utilize that.", "url": "https://github.com/hortonworks/cloudbreak/pull/7943#discussion_r428633277", "createdAt": "2020-05-21T12:54:51Z", "author": {"login": "bergerdenes"}, "path": "integration-test/src/main/java/com/sequenceiq/it/cloudbreak/cloud/v4/AbstractCloudProvider.java", "diffHunk": "@@ -173,6 +174,11 @@ public EnvironmentSecurityAccessTestDto environmentSecurityAccess(EnvironmentSec\n         return environmentSecurityAccessTestDto;\n     }\n \n+    @Override\n+    public AttachedFreeIpaRequest getAttachedFreeIpaRequest() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91aa09dd8c62df899c67ec8c52c209642a09bcec"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODYzMzY2OA==", "bodyText": "Use DTO please.", "url": "https://github.com/hortonworks/cloudbreak/pull/7943#discussion_r428633668", "createdAt": "2020-05-21T12:55:33Z", "author": {"login": "bergerdenes"}, "path": "integration-test/src/main/java/com/sequenceiq/it/cloudbreak/cloud/v4/CloudProvider.java", "diffHunk": "@@ -137,4 +138,6 @@\n \n     void setInstanceTemplateV1Parameters(InstanceTemplateV1Request instanceTemplateV1Request);\n \n+    AttachedFreeIpaRequest getAttachedFreeIpaRequest();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91aa09dd8c62df899c67ec8c52c209642a09bcec"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY0Mjk4NQ==", "bodyText": "might worth logging the retested method or some other metadata", "url": "https://github.com/hortonworks/cloudbreak/pull/7943#discussion_r428642985", "createdAt": "2020-05-21T13:14:17Z", "author": {"login": "bergerdenes"}, "path": "integration-test/src/main/java/com/sequenceiq/it/cloudbreak/util/spot/SpotRetryOnceTestListener.java", "diffHunk": "@@ -0,0 +1,38 @@\n+package com.sequenceiq.it.cloudbreak.util.spot;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+import org.testng.IRetryAnalyzer;\n+import org.testng.ITestListener;\n+import org.testng.ITestNGMethod;\n+import org.testng.ITestResult;\n+\n+@Component\n+public class SpotRetryOnceTestListener implements ITestListener {\n+\n+    /**\n+     * Add {@link SpotRetryOnce} retry analyzer to test methods that should be retried on failure.\n+     */\n+    @Override\n+    public void onTestStart(ITestResult result) {\n+        ITestNGMethod testNGMethod = result.getMethod();\n+        if (SpotUtil.shouldUseSpotInstances(testNGMethod.getConstructorOrMethod().getMethod())) {\n+            testNGMethod.setRetryAnalyzerClass(SpotRetryOnce.class);\n+        }\n+    }\n+\n+    public static class SpotRetryOnce implements IRetryAnalyzer {\n+\n+        private static final Logger LOGGER = LoggerFactory.getLogger(SpotRetryOnce.class);\n+\n+        @Override\n+        public boolean retry(ITestResult result) {\n+            if (SpotRetryUtil.willRetry(result.getMethod())) {\n+                LOGGER.info(\"Retrying test\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91aa09dd8c62df899c67ec8c52c209642a09bcec"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTAyNDc2NA==", "bodyText": "pls move this method to the bottom", "url": "https://github.com/hortonworks/cloudbreak/pull/7943#discussion_r431024764", "createdAt": "2020-05-27T10:43:34Z", "author": {"login": "bergerdenes"}, "path": "integration-test/src/main/java/com/sequenceiq/it/cloudbreak/util/spot/SpotUtil.java", "diffHunk": "@@ -0,0 +1,41 @@\n+package com.sequenceiq.it.cloudbreak.util.spot;\n+\n+import java.lang.reflect.Method;\n+import java.util.Optional;\n+\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.it.cloudbreak.cloud.v4.CommonCloudProperties;\n+import com.sequenceiq.it.cloudbreak.config.SpotProperties;\n+\n+@Component\n+public class SpotUtil {\n+\n+    private static final ThreadLocal<Boolean> USE_SPOT_INSTANCES = new ThreadLocal<>();\n+\n+    private final SpotProperties spotProperties;\n+\n+    private final CommonCloudProperties commonCloudProperties;\n+\n+    public SpotUtil(SpotProperties spotProperties, CommonCloudProperties commonCloudProperties) {\n+        this.spotProperties = spotProperties;\n+        this.commonCloudProperties = commonCloudProperties;\n+    }\n+\n+    public boolean shouldUseSpotInstancesForTest(Method testMethod) {\n+        return spotIsEnabledOnCurrentCloudPlatform()\n+                && testMethod.isAnnotationPresent(UseSpotInstances.class);\n+    }\n+\n+    private boolean spotIsEnabledOnCurrentCloudPlatform() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fa9d025eb6e99c94aca7164c3465c7e15672059f"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5Mzc4NDcy", "url": "https://github.com/hortonworks/cloudbreak/pull/7943#pullrequestreview-419378472", "createdAt": "2020-05-27T16:01:56Z", "commit": {"oid": "ccc791c864c85ae83b1db65d405ba21600f305ef"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce4508f1a25cff703ecc65c70b6bbbed5617557b", "author": {"user": {"login": "Bajzathd", "name": "Bajz\u00e1th D\u00e1vid"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/ce4508f1a25cff703ecc65c70b6bbbed5617557b", "committedDate": "2020-05-29T15:20:22Z", "message": "CB-6830 Run AWS e2e tests on spot instances"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a49fdd91b9982c8bc393f2154f76934b28f6f58", "author": {"user": {"login": "Bajzathd", "name": "Bajz\u00e1th D\u00e1vid"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/2a49fdd91b9982c8bc393f2154f76934b28f6f58", "committedDate": "2020-05-29T15:20:22Z", "message": "CB-6830 Restrict spot logic to AWS"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7999b135883b966c5cd6e601c27d8897e4638e7", "author": {"user": {"login": "Bajzathd", "name": "Bajz\u00e1th D\u00e1vid"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/c7999b135883b966c5cd6e601c27d8897e4638e7", "committedDate": "2020-05-29T15:20:22Z", "message": "CB-6830 Fix review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ed2551c4c853b32df18cf8c3aa74130f098842e", "author": {"user": {"login": "Bajzathd", "name": "Bajz\u00e1th D\u00e1vid"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/8ed2551c4c853b32df18cf8c3aa74130f098842e", "committedDate": "2020-05-29T15:20:22Z", "message": "CB-6830 Add AwsDistroXSpotInstanceTest to aws-e2e-tests test suite"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ccc791c864c85ae83b1db65d405ba21600f305ef", "author": {"user": {"login": "Bajzathd", "name": "Bajz\u00e1th D\u00e1vid"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/ccc791c864c85ae83b1db65d405ba21600f305ef", "committedDate": "2020-05-27T12:28:27Z", "message": "CB-6830 Fix review comments"}, "afterCommit": {"oid": "8ed2551c4c853b32df18cf8c3aa74130f098842e", "author": {"user": {"login": "Bajzathd", "name": "Bajz\u00e1th D\u00e1vid"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/8ed2551c4c853b32df18cf8c3aa74130f098842e", "committedDate": "2020-05-29T15:20:22Z", "message": "CB-6830 Add AwsDistroXSpotInstanceTest to aws-e2e-tests test suite"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyNDg2MDAw", "url": "https://github.com/hortonworks/cloudbreak/pull/7943#pullrequestreview-422486000", "createdAt": "2020-06-02T09:08:26Z", "commit": {"oid": "8ed2551c4c853b32df18cf8c3aa74130f098842e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2282, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}