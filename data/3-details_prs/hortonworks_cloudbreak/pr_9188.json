{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAwNTY0NjUz", "number": 9188, "title": "CB-8987 Extend Distrox and Sdx API endpoints with rotateCertificates method", "bodyText": "This commit adds the rotateCertificates to the distrox and sdx endpoints. Also creates a new flow\nin datalake service which initiates the flow in CB and wait until it finishes.\ndatahub/rotateCertDatahub and datalake/rotateCertDatalake are introduced new authorization\nresource actions.", "createdAt": "2020-10-09T12:43:38Z", "url": "https://github.com/hortonworks/cloudbreak/pull/9188", "merged": true, "mergeCommit": {"oid": "f3b83f2d0855ed6ad69307d37c6194f402bbdf75"}, "closed": true, "closedAt": "2020-10-12T10:18:01Z", "author": {"login": "lacikaaa"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQ1xFGAFqTUwNTY0NzY3MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdRwcGYgBqjM4NjU2NjY4ODM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1NjQ3Njcx", "url": "https://github.com/hortonworks/cloudbreak/pull/9188#pullrequestreview-505647671", "createdAt": "2020-10-09T12:58:35Z", "commit": {"oid": "987d2cc4030f9173e1d8f6a909639ef007e5692f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxMjo1ODozNVrOHfInYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxMjo1ODozNVrOHfInYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQwOTA1OQ==", "bodyText": "Should we call it rotateTlsCertDatalake instead? The reason I'm challenging this is that we will have other certs that need to be rotated as well. We already have the let's encrypt certs and soon we will have Database certs.", "url": "https://github.com/hortonworks/cloudbreak/pull/9188#discussion_r502409059", "createdAt": "2020-10-09T12:58:35Z", "author": {"login": "keyki"}, "path": "authorization-common-api/src/main/java/com/sequenceiq/authorization/resource/AuthorizationResourceAction.java", "diffHunk": "@@ -45,6 +45,7 @@\n     START_DATALAKE(\"datalake/startDatalake\", AuthorizationResourceType.DATALAKE),\n     STOP_DATALAKE(\"datalake/stopDatalake\", AuthorizationResourceType.DATALAKE),\n     UPGRADE_DATALAKE(\"datalake/upgradeDatalake\", AuthorizationResourceType.DATALAKE),\n+    ROTATE_CERT_DATALAKE(\"datalake/rotateCertDatalake\", AuthorizationResourceType.DATALAKE),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "987d2cc4030f9173e1d8f6a909639ef007e5692f"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1NjQ4Mjg3", "url": "https://github.com/hortonworks/cloudbreak/pull/9188#pullrequestreview-505648287", "createdAt": "2020-10-09T12:59:24Z", "commit": {"oid": "987d2cc4030f9173e1d8f6a909639ef007e5692f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxMjo1OToyNFrOHfIpOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxMjo1OToyNFrOHfIpOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQwOTUzMA==", "bodyText": "please add unit test for this", "url": "https://github.com/hortonworks/cloudbreak/pull/9188#discussion_r502409530", "createdAt": "2020-10-09T12:59:24Z", "author": {"login": "horadla23"}, "path": "datalake/src/main/java/com/sequenceiq/datalake/service/sdx/cert/CertRotationService.java", "diffHunk": "@@ -0,0 +1,164 @@\n+package com.sequenceiq.datalake.service.sdx.cert;\n+\n+import static com.sequenceiq.datalake.service.sdx.CloudbreakFlowService.FlowState.FINISHED;\n+import static com.sequenceiq.datalake.service.sdx.CloudbreakFlowService.FlowState.RUNNING;\n+\n+import java.util.Collections;\n+\n+import javax.inject.Inject;\n+import javax.ws.rs.NotFoundException;\n+import javax.ws.rs.WebApplicationException;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Service;\n+\n+import com.dyngr.Polling;\n+import com.dyngr.core.AttemptResult;\n+import com.dyngr.core.AttemptResults;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.sequenceiq.cloudbreak.api.endpoint.v4.common.Status;\n+import com.sequenceiq.cloudbreak.api.endpoint.v4.stacks.StackV4Endpoint;\n+import com.sequenceiq.cloudbreak.api.endpoint.v4.stacks.request.CertificatesRotationV4Request;\n+import com.sequenceiq.cloudbreak.api.endpoint.v4.stacks.response.CertificatesRotationV4Response;\n+import com.sequenceiq.cloudbreak.api.endpoint.v4.stacks.response.StackV4Response;\n+import com.sequenceiq.cloudbreak.api.endpoint.v4.stacks.response.cluster.ClusterV4Response;\n+import com.sequenceiq.cloudbreak.auth.ThreadBasedUserCrnProvider;\n+import com.sequenceiq.cloudbreak.cloud.scheduler.PollGroup;\n+import com.sequenceiq.cloudbreak.common.exception.WebApplicationExceptionMessageExtractor;\n+import com.sequenceiq.cloudbreak.common.json.JsonUtil;\n+import com.sequenceiq.cloudbreak.event.ResourceEvent;\n+import com.sequenceiq.cloudbreak.logger.MDCBuilder;\n+import com.sequenceiq.datalake.entity.DatalakeStatusEnum;\n+import com.sequenceiq.datalake.entity.SdxCluster;\n+import com.sequenceiq.datalake.flow.SdxReactorFlowManager;\n+import com.sequenceiq.datalake.flow.cert.rotation.event.SdxStartCertRotationEvent;\n+import com.sequenceiq.datalake.flow.statestore.DatalakeInMemoryStateStore;\n+import com.sequenceiq.datalake.service.sdx.CloudbreakFlowService;\n+import com.sequenceiq.datalake.service.sdx.CloudbreakFlowService.FlowState;\n+import com.sequenceiq.datalake.service.sdx.PollingConfig;\n+import com.sequenceiq.datalake.service.sdx.SdxService;\n+import com.sequenceiq.datalake.service.sdx.status.AvailabilityChecker;\n+import com.sequenceiq.datalake.service.sdx.status.SdxStatusService;\n+import com.sequenceiq.flow.api.model.FlowIdentifier;\n+\n+@Service\n+public class CertRotationService {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "987d2cc4030f9173e1d8f6a909639ef007e5692f"}, "originalPosition": 47}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "987d2cc4030f9173e1d8f6a909639ef007e5692f", "author": {"user": {"login": "lacikaaa", "name": "Mihaly Laszlo Molnar"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/987d2cc4030f9173e1d8f6a909639ef007e5692f", "committedDate": "2020-10-09T12:38:04Z", "message": "CB-8987 Extend Distrox and Sdx API endpoints with rotateCertificates() method\n\nThis commit adds the rotateCertificates to the distrox and sdx endpoints. Also creates a new flow\nin datalake service which initiates the flow in CB and wait until it finishes.\n`datahub/rotateCertDatahub` and `datalake/rotateCertDatalake` are introduced new authorization\nresource actions."}, "afterCommit": {"oid": "c6217de680b3374efffb18cca31f5add2cb9c759", "author": {"user": {"login": "lacikaaa", "name": "Mihaly Laszlo Molnar"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/c6217de680b3374efffb18cca31f5add2cb9c759", "committedDate": "2020-10-09T13:15:26Z", "message": "CB-8987 Extend Distrox and Sdx API endpoints with rotateCertificates() method\n\nThis commit adds the rotateCertificates to the distrox and sdx endpoints. Also creates a new flow\nin datalake service which initiates the flow in CB and wait until it finishes.\n`datahub/rotateCertDatahub` and `datalake/rotateCertDatalake` are introduced new authorization\nresource actions."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c6217de680b3374efffb18cca31f5add2cb9c759", "author": {"user": {"login": "lacikaaa", "name": "Mihaly Laszlo Molnar"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/c6217de680b3374efffb18cca31f5add2cb9c759", "committedDate": "2020-10-09T13:15:26Z", "message": "CB-8987 Extend Distrox and Sdx API endpoints with rotateCertificates() method\n\nThis commit adds the rotateCertificates to the distrox and sdx endpoints. Also creates a new flow\nin datalake service which initiates the flow in CB and wait until it finishes.\n`datahub/rotateCertDatahub` and `datalake/rotateCertDatalake` are introduced new authorization\nresource actions."}, "afterCommit": {"oid": "18e485fdde8598e13174efea44fb1c4a9f0e332c", "author": {"user": {"login": "lacikaaa", "name": "Mihaly Laszlo Molnar"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/18e485fdde8598e13174efea44fb1c4a9f0e332c", "committedDate": "2020-10-09T15:54:41Z", "message": "CB-8987 Extend Distrox and Sdx API endpoints with rotateCertificates() method\n\nThis commit adds the rotateCertificates to the distrox and sdx endpoints. Also creates a new flow\nin datalake service which initiates the flow in CB and wait until it finishes.\n`datahub/rotateCertDatahub` and `datalake/rotateCertDatalake` are introduced new authorization\nresource actions."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "18e485fdde8598e13174efea44fb1c4a9f0e332c", "author": {"user": {"login": "lacikaaa", "name": "Mihaly Laszlo Molnar"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/18e485fdde8598e13174efea44fb1c4a9f0e332c", "committedDate": "2020-10-09T15:54:41Z", "message": "CB-8987 Extend Distrox and Sdx API endpoints with rotateCertificates() method\n\nThis commit adds the rotateCertificates to the distrox and sdx endpoints. Also creates a new flow\nin datalake service which initiates the flow in CB and wait until it finishes.\n`datahub/rotateCertDatahub` and `datalake/rotateCertDatalake` are introduced new authorization\nresource actions."}, "afterCommit": {"oid": "ab2813cce637831f2f2676d9d2560169db1e6008", "author": {"user": {"login": "lacikaaa", "name": "Mihaly Laszlo Molnar"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/ab2813cce637831f2f2676d9d2560169db1e6008", "committedDate": "2020-10-09T16:39:55Z", "message": "CB-8987 Extend Distrox and Sdx API endpoints with rotateCertificates() method\n\nThis commit adds the rotateCertificates to the distrox and sdx endpoints. Also creates a new flow\nin datalake service which initiates the flow in CB and wait until it finishes.\n`datahub/rotateCertDatahub` and `datalake/rotateCertDatalake` are introduced new authorization\nresource actions."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MTkyNTY2", "url": "https://github.com/hortonworks/cloudbreak/pull/9188#pullrequestreview-506192566", "createdAt": "2020-10-11T15:52:44Z", "commit": {"oid": "ab2813cce637831f2f2676d9d2560169db1e6008"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMVQxNTo1Mjo0NFrOHfomFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMVQxNTo1Mjo0NFrOHfomFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjkzMzAxNQ==", "bodyText": "Should we call it rotate_autotls_certificates similarly to the permissions?", "url": "https://github.com/hortonworks/cloudbreak/pull/9188#discussion_r502933015", "createdAt": "2020-10-11T15:52:44Z", "author": {"login": "keyki"}, "path": "core-api/src/main/java/com/sequenceiq/distrox/api/v1/distrox/endpoint/DistroXV1Endpoint.java", "diffHunk": "@@ -359,4 +362,16 @@ void setClusterMaintenanceModeByCrn(@PathParam(\"crn\") String crn,\n     @ApiOperation(value = RENEW_CERTIFICATE, produces = MediaType.APPLICATION_JSON, notes = Notes.RENEW_CERTIFICATE_NOTES,\n             nickname = \"renewDistroXCertificate\")\n     FlowIdentifier renewCertificate(@PathParam(\"crn\") String crn);\n+\n+    @PUT\n+    @Path(\"name/{name}/rotate_certificates\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab2813cce637831f2f2676d9d2560169db1e6008"}, "originalPosition": 23}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ab2813cce637831f2f2676d9d2560169db1e6008", "author": {"user": {"login": "lacikaaa", "name": "Mihaly Laszlo Molnar"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/ab2813cce637831f2f2676d9d2560169db1e6008", "committedDate": "2020-10-09T16:39:55Z", "message": "CB-8987 Extend Distrox and Sdx API endpoints with rotateCertificates() method\n\nThis commit adds the rotateCertificates to the distrox and sdx endpoints. Also creates a new flow\nin datalake service which initiates the flow in CB and wait until it finishes.\n`datahub/rotateCertDatahub` and `datalake/rotateCertDatalake` are introduced new authorization\nresource actions."}, "afterCommit": {"oid": "cbd29fcba61a4dc583e5fef706d56528f6756ad2", "author": {"user": {"login": "lacikaaa", "name": "Mihaly Laszlo Molnar"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/cbd29fcba61a4dc583e5fef706d56528f6756ad2", "committedDate": "2020-10-12T08:42:44Z", "message": "CB-8987 Extend Distrox and Sdx API endpoints with rotateCertificates() method\n\nThis commit adds the rotateCertificates to the distrox and sdx endpoints. Also creates a new flow\nin datalake service which initiates the flow in CB and wait until it finishes.\n`datahub/rotateCertDatahub` and `datalake/rotateCertDatalake` are introduced new authorization\nresource actions."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cbd29fcba61a4dc583e5fef706d56528f6756ad2", "author": {"user": {"login": "lacikaaa", "name": "Mihaly Laszlo Molnar"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/cbd29fcba61a4dc583e5fef706d56528f6756ad2", "committedDate": "2020-10-12T08:42:44Z", "message": "CB-8987 Extend Distrox and Sdx API endpoints with rotateCertificates() method\n\nThis commit adds the rotateCertificates to the distrox and sdx endpoints. Also creates a new flow\nin datalake service which initiates the flow in CB and wait until it finishes.\n`datahub/rotateCertDatahub` and `datalake/rotateCertDatalake` are introduced new authorization\nresource actions."}, "afterCommit": {"oid": "d071568267b9a643c85979b7fd952462418a8c91", "author": {"user": {"login": "lacikaaa", "name": "Mihaly Laszlo Molnar"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/d071568267b9a643c85979b7fd952462418a8c91", "committedDate": "2020-10-12T08:48:14Z", "message": "CB-8987 Extend Distrox and Sdx API endpoints with rotateCertificates() method\n\nThis commit adds the rotateCertificates to the distrox and sdx endpoints. Also creates a new flow\nin datalake service which initiates the flow in CB and wait until it finishes.\n`datahub/rotateCertDatahub` and `datalake/rotateCertDatalake` are introduced new authorization\nresource actions."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ff4db681fded88f67890e8e993f331d0e07f8eb", "author": {"user": {"login": "lacikaaa", "name": "Mihaly Laszlo Molnar"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/7ff4db681fded88f67890e8e993f331d0e07f8eb", "committedDate": "2020-10-12T09:19:41Z", "message": "CB-8987 Extend Distrox and Sdx API endpoints with rotateCertificates() method\n\nThis commit adds the rotateCertificates to the distrox and sdx endpoints. Also creates a new flow\nin datalake service which initiates the flow in CB and wait until it finishes.\n`datahub/rotateCertDatahub` and `datalake/rotateCertDatalake` are introduced new authorization\nresource actions."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d071568267b9a643c85979b7fd952462418a8c91", "author": {"user": {"login": "lacikaaa", "name": "Mihaly Laszlo Molnar"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/d071568267b9a643c85979b7fd952462418a8c91", "committedDate": "2020-10-12T08:48:14Z", "message": "CB-8987 Extend Distrox and Sdx API endpoints with rotateCertificates() method\n\nThis commit adds the rotateCertificates to the distrox and sdx endpoints. Also creates a new flow\nin datalake service which initiates the flow in CB and wait until it finishes.\n`datahub/rotateCertDatahub` and `datalake/rotateCertDatalake` are introduced new authorization\nresource actions."}, "afterCommit": {"oid": "7ff4db681fded88f67890e8e993f331d0e07f8eb", "author": {"user": {"login": "lacikaaa", "name": "Mihaly Laszlo Molnar"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/7ff4db681fded88f67890e8e993f331d0e07f8eb", "committedDate": "2020-10-12T09:19:41Z", "message": "CB-8987 Extend Distrox and Sdx API endpoints with rotateCertificates() method\n\nThis commit adds the rotateCertificates to the distrox and sdx endpoints. Also creates a new flow\nin datalake service which initiates the flow in CB and wait until it finishes.\n`datahub/rotateCertDatahub` and `datalake/rotateCertDatalake` are introduced new authorization\nresource actions."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2139, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}