{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg0NjUwMjEx", "number": 7484, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQwOTo0NDo0MVrODlvEtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNToxNzozN1rODmugmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwODk1MTU3OnYy", "diffSide": "RIGHT", "path": "cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/model/CloudStack.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQwOTo0NDo0MVrOFyytXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwNToyMTowMlrOFzMsGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgwMzkzNQ==", "bodyText": "could you drop this field in favor of adding only an entry to the parameter map? As it is very spi specific I think we should not include this as a field in CloudStack", "url": "https://github.com/hortonworks/cloudbreak/pull/7484#discussion_r388803935", "createdAt": "2020-03-06T09:44:41Z", "author": {"login": "lacikaaa"}, "path": "cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/model/CloudStack.java", "diffHunk": "@@ -33,8 +33,11 @@\n \n     private final Optional<SpiFileSystem> fileSystem;\n \n+    private final boolean createCloudWatchAlarm;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f363f4a5268821f31856be790a200a215ed875ed"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIyOTU5Mw==", "bodyText": "fixed", "url": "https://github.com/hortonworks/cloudbreak/pull/7484#discussion_r389229593", "createdAt": "2020-03-07T05:21:02Z", "author": {"login": "holleyism"}, "path": "cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/model/CloudStack.java", "diffHunk": "@@ -33,8 +33,11 @@\n \n     private final Optional<SpiFileSystem> fileSystem;\n \n+    private final boolean createCloudWatchAlarm;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgwMzkzNQ=="}, "originalCommit": {"oid": "f363f4a5268821f31856be790a200a215ed875ed"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwODk3MTM0OnYy", "diffSide": "RIGHT", "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/connector/resource/AwsLaunchService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQwOTo1MDoyMVrOFyy5Og==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwNToyMTowOVrOFzMsIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgwNjk3MA==", "bodyText": "could you move cloudwatch related code/methods to a separate component?\nthat way it would be easier to write some simple unit test for it also. maybe the condition could be moved there, so you can cover all the pieces of the logic related to it", "url": "https://github.com/hortonworks/cloudbreak/pull/7484#discussion_r388806970", "createdAt": "2020-03-06T09:50:21Z", "author": {"login": "lacikaaa"}, "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/connector/resource/AwsLaunchService.java", "diffHunk": "@@ -163,9 +176,35 @@\n \n         awsTaggingService.tagRootVolumes(ac, amazonEC2Client, instances, stack.getTags());\n \n+        if (stack.isCreateCloudWatchAlarm()) {\n+            addCloudWatchAlarmsForSystemFailures(instances, regionName, credentialView);\n+        }\n         return awsResourceConnector.check(ac, instances);\n     }\n \n+    private void addCloudWatchAlarmsForSystemFailures(List<CloudResource> instances, String regionName, AwsCredentialView credentialView) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f363f4a5268821f31856be790a200a215ed875ed"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIyOTYwMw==", "bodyText": "moved", "url": "https://github.com/hortonworks/cloudbreak/pull/7484#discussion_r389229603", "createdAt": "2020-03-07T05:21:09Z", "author": {"login": "holleyism"}, "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/connector/resource/AwsLaunchService.java", "diffHunk": "@@ -163,9 +176,35 @@\n \n         awsTaggingService.tagRootVolumes(ac, amazonEC2Client, instances, stack.getTags());\n \n+        if (stack.isCreateCloudWatchAlarm()) {\n+            addCloudWatchAlarmsForSystemFailures(instances, regionName, credentialView);\n+        }\n         return awsResourceConnector.check(ac, instances);\n     }\n \n+    private void addCloudWatchAlarmsForSystemFailures(List<CloudResource> instances, String regionName, AwsCredentialView credentialView) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgwNjk3MA=="}, "originalCommit": {"oid": "f363f4a5268821f31856be790a200a215ed875ed"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxOTMzMTkwOnYy", "diffSide": "RIGHT", "path": "cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/model/CloudStack.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNToxNDo1OVrOF0TkXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNzo0OToyMlrOF0aPHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM5MDg3Nw==", "bodyText": "I think this would be better in PlatformParametersConsts", "url": "https://github.com/hortonworks/cloudbreak/pull/7484#discussion_r390390877", "createdAt": "2020-03-10T15:14:59Z", "author": {"login": "lacikaaa"}, "path": "cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/model/CloudStack.java", "diffHunk": "@@ -13,6 +13,8 @@\n  */\n public class CloudStack {\n \n+    public static final String CLOUDWATCH_CREATE_PARAMETER = \"createCloudWatchAlarm\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cbb849b6c655ea008a44239ddc4515ced5a1627c"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDUwMDEyNA==", "bodyText": "moved", "url": "https://github.com/hortonworks/cloudbreak/pull/7484#discussion_r390500124", "createdAt": "2020-03-10T17:49:22Z", "author": {"login": "holleyism"}, "path": "cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/model/CloudStack.java", "diffHunk": "@@ -13,6 +13,8 @@\n  */\n public class CloudStack {\n \n+    public static final String CLOUDWATCH_CREATE_PARAMETER = \"createCloudWatchAlarm\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM5MDg3Nw=="}, "originalCommit": {"oid": "cbb849b6c655ea008a44239ddc4515ced5a1627c"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxOTMzNjY4OnYy", "diffSide": "RIGHT", "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/connector/resource/AwsCloudWatchService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNToxNTo1NlrOF0TnRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxOToxNzoyNVrOF0defQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM5MTYyMg==", "bodyText": "Could you move these to @Values so we can easily override them?", "url": "https://github.com/hortonworks/cloudbreak/pull/7484#discussion_r390391622", "createdAt": "2020-03-10T15:15:56Z", "author": {"login": "lacikaaa"}, "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/connector/resource/AwsCloudWatchService.java", "diffHunk": "@@ -0,0 +1,85 @@\n+package com.sequenceiq.cloudbreak.cloud.aws.connector.resource;\n+\n+import static com.sequenceiq.cloudbreak.cloud.model.CloudStack.CLOUDWATCH_CREATE_PARAMETER;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Service;\n+\n+import com.amazonaws.services.cloudwatch.AmazonCloudWatchClient;\n+import com.amazonaws.services.cloudwatch.model.AmazonCloudWatchException;\n+import com.amazonaws.services.cloudwatch.model.DeleteAlarmsRequest;\n+import com.amazonaws.services.cloudwatch.model.Dimension;\n+import com.amazonaws.services.cloudwatch.model.PutMetricAlarmRequest;\n+import com.sequenceiq.cloudbreak.cloud.aws.AwsClient;\n+import com.sequenceiq.cloudbreak.cloud.aws.view.AwsCredentialView;\n+import com.sequenceiq.cloudbreak.cloud.model.CloudInstance;\n+import com.sequenceiq.cloudbreak.cloud.model.CloudResource;\n+import com.sequenceiq.cloudbreak.cloud.model.CloudStack;\n+\n+@Service\n+public class AwsCloudWatchService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(AwsCloudWatchService.class);\n+\n+    private  static final String ALARM_SUFFIX = \"-Status-Check-Failed-System\";\n+\n+    private static final int CLOUDWATCH_PERIOD = 60;\n+\n+    private static final int CLOUDWATCH_EVALUATION_PERIODS = 2;\n+\n+    private static final double CLOUDWATCH_THRESHOLD = 1.0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cbb849b6c655ea008a44239ddc4515ced5a1627c"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU1MzIxMw==", "bodyText": "done", "url": "https://github.com/hortonworks/cloudbreak/pull/7484#discussion_r390553213", "createdAt": "2020-03-10T19:17:25Z", "author": {"login": "holleyism"}, "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/connector/resource/AwsCloudWatchService.java", "diffHunk": "@@ -0,0 +1,85 @@\n+package com.sequenceiq.cloudbreak.cloud.aws.connector.resource;\n+\n+import static com.sequenceiq.cloudbreak.cloud.model.CloudStack.CLOUDWATCH_CREATE_PARAMETER;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Service;\n+\n+import com.amazonaws.services.cloudwatch.AmazonCloudWatchClient;\n+import com.amazonaws.services.cloudwatch.model.AmazonCloudWatchException;\n+import com.amazonaws.services.cloudwatch.model.DeleteAlarmsRequest;\n+import com.amazonaws.services.cloudwatch.model.Dimension;\n+import com.amazonaws.services.cloudwatch.model.PutMetricAlarmRequest;\n+import com.sequenceiq.cloudbreak.cloud.aws.AwsClient;\n+import com.sequenceiq.cloudbreak.cloud.aws.view.AwsCredentialView;\n+import com.sequenceiq.cloudbreak.cloud.model.CloudInstance;\n+import com.sequenceiq.cloudbreak.cloud.model.CloudResource;\n+import com.sequenceiq.cloudbreak.cloud.model.CloudStack;\n+\n+@Service\n+public class AwsCloudWatchService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(AwsCloudWatchService.class);\n+\n+    private  static final String ALARM_SUFFIX = \"-Status-Check-Failed-System\";\n+\n+    private static final int CLOUDWATCH_PERIOD = 60;\n+\n+    private static final int CLOUDWATCH_EVALUATION_PERIODS = 2;\n+\n+    private static final double CLOUDWATCH_THRESHOLD = 1.0;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM5MTYyMg=="}, "originalCommit": {"oid": "cbb849b6c655ea008a44239ddc4515ced5a1627c"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxOTM0NDg5OnYy", "diffSide": "RIGHT", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/converter/cloud/StackToCloudStackConverter.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNToxNzozN1rOF0TsSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxOToxNzozM1rOF0dewQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM5MjkwNA==", "bodyText": "this should be also come from a @Value so we can turn it off/on as we wish", "url": "https://github.com/hortonworks/cloudbreak/pull/7484#discussion_r390392904", "createdAt": "2020-03-10T15:17:37Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/converter/cloud/StackToCloudStackConverter.java", "diffHunk": "@@ -96,8 +97,9 @@ public CloudStack convert(Stack stack, Collection<String> deleteRequestedInstanc\n         Network network = buildNetwork(stack);\n         InstanceAuthentication instanceAuthentication = buildInstanceAuthentication(stack.getStackAuthentication());\n \n-        return new CloudStack(instanceGroups, network, image, Collections.emptyMap(), getUserDefinedTags(stack), stack.getTemplate(),\n-                instanceAuthentication, instanceAuthentication.getLoginUserName(), instanceAuthentication.getPublicKey(), null);\n+        return new CloudStack(instanceGroups, network, image, Map.of(CLOUDWATCH_CREATE_PARAMETER, Boolean.TRUE.toString()),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cbb849b6c655ea008a44239ddc4515ced5a1627c"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU1MzI4MQ==", "bodyText": "done", "url": "https://github.com/hortonworks/cloudbreak/pull/7484#discussion_r390553281", "createdAt": "2020-03-10T19:17:33Z", "author": {"login": "holleyism"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/converter/cloud/StackToCloudStackConverter.java", "diffHunk": "@@ -96,8 +97,9 @@ public CloudStack convert(Stack stack, Collection<String> deleteRequestedInstanc\n         Network network = buildNetwork(stack);\n         InstanceAuthentication instanceAuthentication = buildInstanceAuthentication(stack.getStackAuthentication());\n \n-        return new CloudStack(instanceGroups, network, image, Collections.emptyMap(), getUserDefinedTags(stack), stack.getTemplate(),\n-                instanceAuthentication, instanceAuthentication.getLoginUserName(), instanceAuthentication.getPublicKey(), null);\n+        return new CloudStack(instanceGroups, network, image, Map.of(CLOUDWATCH_CREATE_PARAMETER, Boolean.TRUE.toString()),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM5MjkwNA=="}, "originalCommit": {"oid": "cbb849b6c655ea008a44239ddc4515ced5a1627c"}, "originalPosition": 13}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2732, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}