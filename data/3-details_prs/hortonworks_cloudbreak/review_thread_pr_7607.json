{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkwMjg5NzQ2", "number": 7607, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwODoyNzo1NVrODpArJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxMDowMDoxNVrODpCqHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0MzI5MjU1OnYy", "diffSide": "RIGHT", "path": "datalake/src/test/java/com/sequenceiq/datalake/service/sdx/SdxServiceTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwODoyNzo1NVrOF36h4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwOTowNjowMFrOF37xBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE3NDk0NQ==", "bodyText": "typo in flowCancelServicel -> flowCancelService", "url": "https://github.com/hortonworks/cloudbreak/pull/7607#discussion_r394174945", "createdAt": "2020-03-18T08:27:55Z", "author": {"login": "topolyai5"}, "path": "datalake/src/test/java/com/sequenceiq/datalake/service/sdx/SdxServiceTest.java", "diffHunk": "@@ -124,6 +125,9 @@\n     @Mock\n     private CDPConfigService cdpConfigService;\n \n+    @Mock\n+    private FlowCancelService flowCancelServicel;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "afb8db51231bb0564405256e47f25ff3b9cd124f"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE5NTIwNg==", "bodyText": "fixed", "url": "https://github.com/hortonworks/cloudbreak/pull/7607#discussion_r394195206", "createdAt": "2020-03-18T09:06:00Z", "author": {"login": "lacikaaa"}, "path": "datalake/src/test/java/com/sequenceiq/datalake/service/sdx/SdxServiceTest.java", "diffHunk": "@@ -124,6 +125,9 @@\n     @Mock\n     private CDPConfigService cdpConfigService;\n \n+    @Mock\n+    private FlowCancelService flowCancelServicel;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE3NDk0NQ=="}, "originalCommit": {"oid": "afb8db51231bb0564405256e47f25ff3b9cd124f"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0MzMxMTExOnYy", "diffSide": "LEFT", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/flow/FreeIpaFlowManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwODozMzo0MlrOF36tig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwODozMzo0MlrOF36tig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE3NzkzMA==", "bodyText": "You should not remove the LOGGER, you should improve the logging in this class", "url": "https://github.com/hortonworks/cloudbreak/pull/7607#discussion_r394177930", "createdAt": "2020-03-18T08:33:42Z", "author": {"login": "topolyai5"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/flow/FreeIpaFlowManager.java", "diffHunk": "@@ -7,29 +7,22 @@\n import javax.inject.Inject;\n \n import org.apache.commons.lang3.StringUtils;\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n import org.springframework.stereotype.Component;\n \n import com.sequenceiq.cloudbreak.auth.ThreadBasedUserCrnProvider;\n import com.sequenceiq.cloudbreak.common.event.Acceptable;\n import com.sequenceiq.cloudbreak.common.event.Selectable;\n-import com.sequenceiq.flow.core.Flow2Handler;\n import com.sequenceiq.flow.core.FlowConstants;\n import com.sequenceiq.flow.core.model.FlowAcceptResult;\n import com.sequenceiq.flow.core.model.ResultType;\n import com.sequenceiq.flow.reactor.ErrorHandlerAwareReactorEventFactory;\n-import com.sequenceiq.freeipa.flow.stack.StackEvent;\n-import com.sequenceiq.freeipa.service.stack.StackService;\n \n import reactor.bus.Event;\n import reactor.bus.EventBus;\n \n @Component\n public class FreeIpaFlowManager {\n \n-    private static final Logger LOGGER = LoggerFactory.getLogger(FreeIpaFlowManager.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "afb8db51231bb0564405256e47f25ff3b9cd124f"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0MzMyNDQ1OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/sequenceiq/cloudbreak/core/flow2/service/TerminationTriggerService.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwODozODowN1rOF3616Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwODo0MDozN1rOF366vA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE4MDA3Mw==", "bodyText": "it is not informative. In the logs, we cannot find easily what flow does not have INIT_STATE", "url": "https://github.com/hortonworks/cloudbreak/pull/7607#discussion_r394180073", "createdAt": "2020-03-18T08:38:07Z", "author": {"login": "topolyai5"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/core/flow2/service/TerminationTriggerService.java", "diffHunk": "@@ -58,7 +59,7 @@ private void handleIfStackIsNotTerminated(Stack stack, boolean forced) {\n             LOGGER.debug(\"Found termination flowlog with id [{}] and payload [{}]\", flowLog.getFlowId(), flowLog.getPayload());\n             handleIfFlowLogExistsForTermination(stack, forced, flowLog);\n         } else {\n-            LOGGER.warn(\"Couldn't find FlowLog with 'PRE_TERMINATION_STATE'. Triggering termination\");\n+            LOGGER.warn(\"Couldn't find FlowLog with 'INIT_STATE'. Triggering termination\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "afb8db51231bb0564405256e47f25ff3b9cd124f"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE4MDkzOA==", "bodyText": "it's for indicating which path the code took if we are investigating an issue", "url": "https://github.com/hortonworks/cloudbreak/pull/7607#discussion_r394180938", "createdAt": "2020-03-18T08:39:57Z", "author": {"login": "lacikaaa"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/core/flow2/service/TerminationTriggerService.java", "diffHunk": "@@ -58,7 +59,7 @@ private void handleIfStackIsNotTerminated(Stack stack, boolean forced) {\n             LOGGER.debug(\"Found termination flowlog with id [{}] and payload [{}]\", flowLog.getFlowId(), flowLog.getPayload());\n             handleIfFlowLogExistsForTermination(stack, forced, flowLog);\n         } else {\n-            LOGGER.warn(\"Couldn't find FlowLog with 'PRE_TERMINATION_STATE'. Triggering termination\");\n+            LOGGER.warn(\"Couldn't find FlowLog with 'INIT_STATE'. Triggering termination\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE4MDA3Mw=="}, "originalCommit": {"oid": "afb8db51231bb0564405256e47f25ff3b9cd124f"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE4MTMwOA==", "bodyText": "but it should be debug level", "url": "https://github.com/hortonworks/cloudbreak/pull/7607#discussion_r394181308", "createdAt": "2020-03-18T08:40:37Z", "author": {"login": "lacikaaa"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/core/flow2/service/TerminationTriggerService.java", "diffHunk": "@@ -58,7 +59,7 @@ private void handleIfStackIsNotTerminated(Stack stack, boolean forced) {\n             LOGGER.debug(\"Found termination flowlog with id [{}] and payload [{}]\", flowLog.getFlowId(), flowLog.getPayload());\n             handleIfFlowLogExistsForTermination(stack, forced, flowLog);\n         } else {\n-            LOGGER.warn(\"Couldn't find FlowLog with 'PRE_TERMINATION_STATE'. Triggering termination\");\n+            LOGGER.warn(\"Couldn't find FlowLog with 'INIT_STATE'. Triggering termination\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE4MDA3Mw=="}, "originalCommit": {"oid": "afb8db51231bb0564405256e47f25ff3b9cd124f"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0MzMyNjE2OnYy", "diffSide": "RIGHT", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/stack/FreeIpaDeletionService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwODozODo0MFrOF362_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwODo0Nzo1NFrOF37KVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE4MDM0OA==", "bodyText": "it is not informative. In the logs, we cannot find easily what flow does not have INIT_STATE", "url": "https://github.com/hortonworks/cloudbreak/pull/7607#discussion_r394180348", "createdAt": "2020-03-18T08:38:40Z", "author": {"login": "topolyai5"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/stack/FreeIpaDeletionService.java", "diffHunk": "@@ -42,9 +61,39 @@ public void delete(String environmentCrn, String accountId) {\n     }\n \n     private void unscheduleAndTriggerTerminate(Stack stack) {\n+        flowCancelService.cancelTooOldTerminationFlowForResource(stack.getId(), stack.getName());\n         freeipaJobService.unschedule(stack);\n+        if (!stack.isDeleteCompleted()) {\n+            handleIfStackIsNotTerminated(stack);\n+        } else {\n+            LOGGER.debug(\"Stack is already deleted.\");\n+        }\n+    }\n+\n+    private void handleIfStackIsNotTerminated(Stack stack) {\n+        LOGGER.info(\"stack {} in environment {} is not deleted.\", stack.getName(), stack.getEnvironmentCrn());\n+        Optional<FlowLog> optionalFlowLog = findLatestTerminationFlowLogWithInitState(stack);\n+        if (optionalFlowLog.isPresent()) {\n+            FlowLog flowLog = optionalFlowLog.get();\n+            LOGGER.debug(\"Found termination flowlog with id [{}] and payload [{}]\", flowLog.getFlowId(), flowLog.getPayload());\n+        } else {\n+            fireTerminationEvent(stack);\n+        }\n+    }\n+\n+    private void fireTerminationEvent(Stack stack) {\n+        LOGGER.warn(\"Couldn't find FlowLog with 'INIT_STATE'. Triggering termination\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "afb8db51231bb0564405256e47f25ff3b9cd124f"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE4NTMwMA==", "bodyText": "modified to debug, it's only to check the flow of the code if there is an issue", "url": "https://github.com/hortonworks/cloudbreak/pull/7607#discussion_r394185300", "createdAt": "2020-03-18T08:47:54Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/stack/FreeIpaDeletionService.java", "diffHunk": "@@ -42,9 +61,39 @@ public void delete(String environmentCrn, String accountId) {\n     }\n \n     private void unscheduleAndTriggerTerminate(Stack stack) {\n+        flowCancelService.cancelTooOldTerminationFlowForResource(stack.getId(), stack.getName());\n         freeipaJobService.unschedule(stack);\n+        if (!stack.isDeleteCompleted()) {\n+            handleIfStackIsNotTerminated(stack);\n+        } else {\n+            LOGGER.debug(\"Stack is already deleted.\");\n+        }\n+    }\n+\n+    private void handleIfStackIsNotTerminated(Stack stack) {\n+        LOGGER.info(\"stack {} in environment {} is not deleted.\", stack.getName(), stack.getEnvironmentCrn());\n+        Optional<FlowLog> optionalFlowLog = findLatestTerminationFlowLogWithInitState(stack);\n+        if (optionalFlowLog.isPresent()) {\n+            FlowLog flowLog = optionalFlowLog.get();\n+            LOGGER.debug(\"Found termination flowlog with id [{}] and payload [{}]\", flowLog.getFlowId(), flowLog.getPayload());\n+        } else {\n+            fireTerminationEvent(stack);\n+        }\n+    }\n+\n+    private void fireTerminationEvent(Stack stack) {\n+        LOGGER.warn(\"Couldn't find FlowLog with 'INIT_STATE'. Triggering termination\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE4MDM0OA=="}, "originalCommit": {"oid": "afb8db51231bb0564405256e47f25ff3b9cd124f"}, "originalPosition": 78}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0MzYxNzU5OnYy", "diffSide": "RIGHT", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/stack/FreeIpaDeletionService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxMDowMDoxNVrOF39waA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxNToxOTowNFrOF4J7jA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDIyNzgxNg==", "bodyText": "Minor, capital S", "url": "https://github.com/hortonworks/cloudbreak/pull/7607#discussion_r394227816", "createdAt": "2020-03-18T10:00:15Z", "author": {"login": "keyki"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/stack/FreeIpaDeletionService.java", "diffHunk": "@@ -42,9 +61,39 @@ public void delete(String environmentCrn, String accountId) {\n     }\n \n     private void unscheduleAndTriggerTerminate(Stack stack) {\n+        flowCancelService.cancelTooOldTerminationFlowForResource(stack.getId(), stack.getName());\n         freeipaJobService.unschedule(stack);\n+        if (!stack.isDeleteCompleted()) {\n+            handleIfStackIsNotTerminated(stack);\n+        } else {\n+            LOGGER.debug(\"Stack is already deleted.\");\n+        }\n+    }\n+\n+    private void handleIfStackIsNotTerminated(Stack stack) {\n+        LOGGER.info(\"stack {} in environment {} is not deleted.\", stack.getName(), stack.getEnvironmentCrn());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "afb8db51231bb0564405256e47f25ff3b9cd124f"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQyNzI3Ng==", "bodyText": "fixed", "url": "https://github.com/hortonworks/cloudbreak/pull/7607#discussion_r394427276", "createdAt": "2020-03-18T15:19:04Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/stack/FreeIpaDeletionService.java", "diffHunk": "@@ -42,9 +61,39 @@ public void delete(String environmentCrn, String accountId) {\n     }\n \n     private void unscheduleAndTriggerTerminate(Stack stack) {\n+        flowCancelService.cancelTooOldTerminationFlowForResource(stack.getId(), stack.getName());\n         freeipaJobService.unschedule(stack);\n+        if (!stack.isDeleteCompleted()) {\n+            handleIfStackIsNotTerminated(stack);\n+        } else {\n+            LOGGER.debug(\"Stack is already deleted.\");\n+        }\n+    }\n+\n+    private void handleIfStackIsNotTerminated(Stack stack) {\n+        LOGGER.info(\"stack {} in environment {} is not deleted.\", stack.getName(), stack.getEnvironmentCrn());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDIyNzgxNg=="}, "originalCommit": {"oid": "afb8db51231bb0564405256e47f25ff3b9cd124f"}, "originalPosition": 67}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2684, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}