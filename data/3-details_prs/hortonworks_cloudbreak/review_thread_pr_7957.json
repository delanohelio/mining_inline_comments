{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEyNjgwMTU1", "number": 7957, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxMDozODowN1rOD47yxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxNDoxMzoxMVrOD5Agpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxMDI2NTAwOnYy", "diffSide": "RIGHT", "path": "freeipa/src/main/resources/freeipa-salt/salt/freeipa/backups.sls", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxMDozODowN1rOGP67-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxMjo0MjowM1rOGP-gIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM0NzQ0OQ==", "bodyText": "could you rename this state and move the command into the name parameter?\nalso this would be called every time a highstate is called, so I think you should place a file somewhere so it wouldn't run again", "url": "https://github.com/hortonworks/cloudbreak/pull/7957#discussion_r419347449", "createdAt": "2020-05-04T10:38:07Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/resources/freeipa-salt/salt/freeipa/backups.sls", "diffHunk": "@@ -15,6 +15,10 @@\n     - mode: 640\n \n {% if salt['pillar.get']('freeipa:backup:monthly_full_enabled') %}\n+'/sbin/anacron -u cron.monthly':", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c52f6e9c9537619f134893e1615756a5e72ed70"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM5NjcyMw==", "bodyText": "It will not be run again because of the onlyif.  The anacron state files (in /var/spool/anacron) start out as a zero byte file until it is run once.  From then on they are updated to a datestamp of when they were last run.   The anacron -u forces the update of the datestamp file without running the commands.", "url": "https://github.com/hortonworks/cloudbreak/pull/7957#discussion_r419396723", "createdAt": "2020-05-04T12:24:57Z", "author": {"login": "wonderslug"}, "path": "freeipa/src/main/resources/freeipa-salt/salt/freeipa/backups.sls", "diffHunk": "@@ -15,6 +15,10 @@\n     - mode: 640\n \n {% if salt['pillar.get']('freeipa:backup:monthly_full_enabled') %}\n+'/sbin/anacron -u cron.monthly':", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM0NzQ0OQ=="}, "originalCommit": {"oid": "5c52f6e9c9537619f134893e1615756a5e72ed70"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTQwNTg1Nw==", "bodyText": "thanks for the explanation!", "url": "https://github.com/hortonworks/cloudbreak/pull/7957#discussion_r419405857", "createdAt": "2020-05-04T12:42:03Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/resources/freeipa-salt/salt/freeipa/backups.sls", "diffHunk": "@@ -15,6 +15,10 @@\n     - mode: 640\n \n {% if salt['pillar.get']('freeipa:backup:monthly_full_enabled') %}\n+'/sbin/anacron -u cron.monthly':", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM0NzQ0OQ=="}, "originalCommit": {"oid": "5c52f6e9c9537619f134893e1615756a5e72ed70"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxMTAzNzgyOnYy", "diffSide": "RIGHT", "path": "freeipa/src/main/resources/freeipa-salt/salt/freeipa/backups.sls", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxNDoxMzoxMVrOGQCREg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxNjowMzo0MFrOGQHIjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTQ2NzUzOA==", "bodyText": "Is it possible that the anacron monthly backup runs once before the FreeIPA backup is added to it? If so, then this file would exist but the backup would not.", "url": "https://github.com/hortonworks/cloudbreak/pull/7957#discussion_r419467538", "createdAt": "2020-05-04T14:13:11Z", "author": {"login": "jamisonbennett"}, "path": "freeipa/src/main/resources/freeipa-salt/salt/freeipa/backups.sls", "diffHunk": "@@ -15,6 +15,11 @@\n     - mode: 640\n \n {% if salt['pillar.get']('freeipa:backup:monthly_full_enabled') %}\n+freeipa_backoff_monthly_full:\n+  cmd.run:\n+    - name: /sbin/anacron -u cron.monthly\n+    - onlyif: test ! -s /var/spool/anacron/cron.monthly", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d2c3a7462469344badcf4baa90010926c5d92ef"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTQ3MDQ0MQ==", "bodyText": "initial backup is a different state. also -u is for skipping the actual run", "url": "https://github.com/hortonworks/cloudbreak/pull/7957#discussion_r419470441", "createdAt": "2020-05-04T14:17:18Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/resources/freeipa-salt/salt/freeipa/backups.sls", "diffHunk": "@@ -15,6 +15,11 @@\n     - mode: 640\n \n {% if salt['pillar.get']('freeipa:backup:monthly_full_enabled') %}\n+freeipa_backoff_monthly_full:\n+  cmd.run:\n+    - name: /sbin/anacron -u cron.monthly\n+    - onlyif: test ! -s /var/spool/anacron/cron.monthly", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTQ2NzUzOA=="}, "originalCommit": {"oid": "2d2c3a7462469344badcf4baa90010926c5d92ef"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTQ4ODQzNg==", "bodyText": "no the anacron is not going to run the cron.monthly until at least 45 minutes after the initial instance creation and then have an up to 45 minute random delay added onto that.  Unless the instance creation is taking longer than that to reach that point it will be fine.  We can force this to not run by disabling anacron completely during the salt process and explicitly turn it on at the end of the salt run.  We can do this by putting 0anacron in the /etc/cron.hourly/jobs.deny file until we want to explicitly remove it.", "url": "https://github.com/hortonworks/cloudbreak/pull/7957#discussion_r419488436", "createdAt": "2020-05-04T14:41:28Z", "author": {"login": "wonderslug"}, "path": "freeipa/src/main/resources/freeipa-salt/salt/freeipa/backups.sls", "diffHunk": "@@ -15,6 +15,11 @@\n     - mode: 640\n \n {% if salt['pillar.get']('freeipa:backup:monthly_full_enabled') %}\n+freeipa_backoff_monthly_full:\n+  cmd.run:\n+    - name: /sbin/anacron -u cron.monthly\n+    - onlyif: test ! -s /var/spool/anacron/cron.monthly", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTQ2NzUzOA=="}, "originalCommit": {"oid": "2d2c3a7462469344badcf4baa90010926c5d92ef"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTU0NzI3Nw==", "bodyText": "And actually on thinking about this.  In this case if the cron.monthly does get run prior to this that's fine, means it wont run the monthly till next month which is what we want anyways.", "url": "https://github.com/hortonworks/cloudbreak/pull/7957#discussion_r419547277", "createdAt": "2020-05-04T16:03:40Z", "author": {"login": "wonderslug"}, "path": "freeipa/src/main/resources/freeipa-salt/salt/freeipa/backups.sls", "diffHunk": "@@ -15,6 +15,11 @@\n     - mode: 640\n \n {% if salt['pillar.get']('freeipa:backup:monthly_full_enabled') %}\n+freeipa_backoff_monthly_full:\n+  cmd.run:\n+    - name: /sbin/anacron -u cron.monthly\n+    - onlyif: test ! -s /var/spool/anacron/cron.monthly", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTQ2NzUzOA=="}, "originalCommit": {"oid": "2d2c3a7462469344badcf4baa90010926c5d92ef"}, "originalPosition": 7}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2419, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}