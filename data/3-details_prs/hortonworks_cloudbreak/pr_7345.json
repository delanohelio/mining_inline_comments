{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc3OTg1NTA3", "number": 7345, "title": "CDPCP-1291. Add support for retrieving a keytab in FMS", "bodyText": "This updates FreeIPA service to include a new endpoint that allows retrieving a keytab for a user or machine user under a provided environment.", "createdAt": "2020-02-20T21:34:01Z", "url": "https://github.com/hortonworks/cloudbreak/pull/7345", "merged": true, "mergeCommit": {"oid": "cba97e6d57452a10758843ea9c2eae37028a9b4f"}, "closed": true, "closedAt": "2020-03-10T15:20:15Z", "author": {"login": "aarman-cloudera"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcHj4z-gFqTM2MzY4NDA3MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMQTY9AFqTM3MTg0OTQ1Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzNjg0MDcw", "url": "https://github.com/hortonworks/cloudbreak/pull/7345#pullrequestreview-363684070", "createdAt": "2020-02-24T20:38:22Z", "commit": {"oid": "1b1ddcca9b04cd7dc79dfc5bfb4e9b2dd0f32856"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQyMDozODoyMlrOFtvCXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQyMDozODoyMlrOFtvCXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUwMDg5Mw==", "bodyText": "I'm not too fond of the location of this file. I'd prefer it to reside closer to the service that will actually use it.", "url": "https://github.com/hortonworks/cloudbreak/pull/7345#discussion_r383500893", "createdAt": "2020-02-24T20:38:22Z", "author": {"login": "handavid"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/util/KrbKeytabGenerator.java", "diffHunk": "@@ -0,0 +1,54 @@\n+package com.sequenceiq.freeipa.util;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b1ddcca9b04cd7dc79dfc5bfb4e9b2dd0f32856"}, "originalPosition": 1}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzNzkxMjk5", "url": "https://github.com/hortonworks/cloudbreak/pull/7345#pullrequestreview-363791299", "createdAt": "2020-02-25T00:13:35Z", "commit": {"oid": "1b1ddcca9b04cd7dc79dfc5bfb4e9b2dd0f32856"}, "state": "APPROVED", "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQwMDoxNDowNFrOFt0d_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQwMDoyMzoxMlrOFt0ovg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU4OTg4Ng==", "bodyText": "verify/assert parameters?", "url": "https://github.com/hortonworks/cloudbreak/pull/7345#discussion_r383589886", "createdAt": "2020-02-25T00:14:04Z", "author": {"login": "giladwolff"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/util/KrbKeytabGenerator.java", "diffHunk": "@@ -0,0 +1,54 @@\n+package com.sequenceiq.freeipa.util;\n+\n+import com.cloudera.thunderhead.service.usermanagement.UserManagementProto.ActorKerberosKey;\n+import com.sequenceiq.cloudbreak.common.service.Clock;\n+import org.apache.directory.server.kerberos.shared.keytab.KeytabEncoder;\n+import org.apache.directory.server.kerberos.shared.keytab.KeytabEntry;\n+import org.apache.directory.shared.kerberos.KerberosTime;\n+import org.apache.directory.shared.kerberos.codec.types.EncryptionType;\n+import org.apache.directory.shared.kerberos.components.EncryptionKey;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import javax.inject.Inject;\n+import java.util.Base64;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+@Component\n+public final class KrbKeytabGenerator {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(KrbKeytabGenerator.class);\n+\n+    private static final int PRINCIPAL_TYPE_1 = 1;\n+\n+    private static final byte[] KEYTAB_VERSION_0X502 = { (byte) 0x05, (byte) 0x02 };\n+\n+    private static final byte KEY_VERSION_NUMBER_ZERO = 0;\n+\n+    @Inject\n+    private Clock clock;\n+\n+    private KeytabEntry toKeytabEntry(String user, String realm, ActorKerberosKey actorKerberosKey) {\n+        String principalName = user + '@' + realm;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b1ddcca9b04cd7dc79dfc5bfb4e9b2dd0f32856"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU5MDEyOA==", "bodyText": "This is the kvno? Add a comment?", "url": "https://github.com/hortonworks/cloudbreak/pull/7345#discussion_r383590128", "createdAt": "2020-02-25T00:14:55Z", "author": {"login": "giladwolff"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/util/KrbKeytabGenerator.java", "diffHunk": "@@ -0,0 +1,54 @@\n+package com.sequenceiq.freeipa.util;\n+\n+import com.cloudera.thunderhead.service.usermanagement.UserManagementProto.ActorKerberosKey;\n+import com.sequenceiq.cloudbreak.common.service.Clock;\n+import org.apache.directory.server.kerberos.shared.keytab.KeytabEncoder;\n+import org.apache.directory.server.kerberos.shared.keytab.KeytabEntry;\n+import org.apache.directory.shared.kerberos.KerberosTime;\n+import org.apache.directory.shared.kerberos.codec.types.EncryptionType;\n+import org.apache.directory.shared.kerberos.components.EncryptionKey;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import javax.inject.Inject;\n+import java.util.Base64;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+@Component\n+public final class KrbKeytabGenerator {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(KrbKeytabGenerator.class);\n+\n+    private static final int PRINCIPAL_TYPE_1 = 1;\n+\n+    private static final byte[] KEYTAB_VERSION_0X502 = { (byte) 0x05, (byte) 0x02 };\n+\n+    private static final byte KEY_VERSION_NUMBER_ZERO = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b1ddcca9b04cd7dc79dfc5bfb4e9b2dd0f32856"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU5MDE5Mg==", "bodyText": "What is this principal type?", "url": "https://github.com/hortonworks/cloudbreak/pull/7345#discussion_r383590192", "createdAt": "2020-02-25T00:15:09Z", "author": {"login": "giladwolff"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/util/KrbKeytabGenerator.java", "diffHunk": "@@ -0,0 +1,54 @@\n+package com.sequenceiq.freeipa.util;\n+\n+import com.cloudera.thunderhead.service.usermanagement.UserManagementProto.ActorKerberosKey;\n+import com.sequenceiq.cloudbreak.common.service.Clock;\n+import org.apache.directory.server.kerberos.shared.keytab.KeytabEncoder;\n+import org.apache.directory.server.kerberos.shared.keytab.KeytabEntry;\n+import org.apache.directory.shared.kerberos.KerberosTime;\n+import org.apache.directory.shared.kerberos.codec.types.EncryptionType;\n+import org.apache.directory.shared.kerberos.components.EncryptionKey;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import javax.inject.Inject;\n+import java.util.Base64;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+@Component\n+public final class KrbKeytabGenerator {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(KrbKeytabGenerator.class);\n+\n+    private static final int PRINCIPAL_TYPE_1 = 1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b1ddcca9b04cd7dc79dfc5bfb4e9b2dd0f32856"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU5MDM5NQ==", "bodyText": "verify/assert parameters?", "url": "https://github.com/hortonworks/cloudbreak/pull/7345#discussion_r383590395", "createdAt": "2020-02-25T00:15:36Z", "author": {"login": "giladwolff"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/util/KrbKeytabGenerator.java", "diffHunk": "@@ -0,0 +1,54 @@\n+package com.sequenceiq.freeipa.util;\n+\n+import com.cloudera.thunderhead.service.usermanagement.UserManagementProto.ActorKerberosKey;\n+import com.sequenceiq.cloudbreak.common.service.Clock;\n+import org.apache.directory.server.kerberos.shared.keytab.KeytabEncoder;\n+import org.apache.directory.server.kerberos.shared.keytab.KeytabEntry;\n+import org.apache.directory.shared.kerberos.KerberosTime;\n+import org.apache.directory.shared.kerberos.codec.types.EncryptionType;\n+import org.apache.directory.shared.kerberos.components.EncryptionKey;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import javax.inject.Inject;\n+import java.util.Base64;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+@Component\n+public final class KrbKeytabGenerator {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(KrbKeytabGenerator.class);\n+\n+    private static final int PRINCIPAL_TYPE_1 = 1;\n+\n+    private static final byte[] KEYTAB_VERSION_0X502 = { (byte) 0x05, (byte) 0x02 };\n+\n+    private static final byte KEY_VERSION_NUMBER_ZERO = 0;\n+\n+    @Inject\n+    private Clock clock;\n+\n+    private KeytabEntry toKeytabEntry(String user, String realm, ActorKerberosKey actorKerberosKey) {\n+        String principalName = user + '@' + realm;\n+\n+        EncryptionType encryptionType = EncryptionType.getTypeByValue(actorKerberosKey.getKeyType());\n+        byte[] key = Base64.getDecoder().decode(actorKerberosKey.getKeyValue());\n+        EncryptionKey encryptionKey = new EncryptionKey(encryptionType, key);\n+\n+        KerberosTime time = new KerberosTime(clock.getCurrentTimeMillis());\n+\n+        return new KeytabEntry(principalName, PRINCIPAL_TYPE_1, time, KEY_VERSION_NUMBER_ZERO, encryptionKey);\n+    }\n+\n+    public String generateKeytabBase64(String workloadUserName, String realm, List<ActorKerberosKey> actorKerberosKeys) {\n+        LOGGER.info(\"Generating keytab for workloadUserName = {} with realm = {}\", workloadUserName, realm);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b1ddcca9b04cd7dc79dfc5bfb4e9b2dd0f32856"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU5MTA4OQ==", "bodyText": "So what is this needed for? You copied the code, no?", "url": "https://github.com/hortonworks/cloudbreak/pull/7345#discussion_r383591089", "createdAt": "2020-02-25T00:18:02Z", "author": {"login": "giladwolff"}, "path": "freeipa/build.gradle", "diffHunk": "@@ -51,6 +51,9 @@ dependencies {\n   implementation     group: 'io.opentracing.contrib',    name: 'opentracing-jaxrs2',                       version: opentracingJaxrs2Version\n   implementation     group: 'io.opentracing.contrib',    name: 'opentracing-jdbc',                         version: opentracingJdbcVersion\n \n+  implementation     group: 'org.apache.directory.api',  name: 'api-asn1-api',                         version: '2.0.0'\n+  implementation     group: 'org.apache.directory.api',  name: 'api-asn1-ber',                         version: '2.0.0'\n+  ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b1ddcca9b04cd7dc79dfc5bfb4e9b2dd0f32856"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU5MTUxMg==", "bodyText": "I would just drop the org/apache/directory from the package and move it to somewhere where the rest of you code lives (KeytabUtils?) You can put the readme and the classes there.", "url": "https://github.com/hortonworks/cloudbreak/pull/7345#discussion_r383591512", "createdAt": "2020-02-25T00:19:20Z", "author": {"login": "giladwolff"}, "path": "freeipa/src/main/java/org/apache/directory/README.md", "diffHunk": "@@ -0,0 +1,12 @@\n+This packge contains classes to aid in the generation of Kerberos Keytabs. The classes here are taken", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b1ddcca9b04cd7dc79dfc5bfb4e9b2dd0f32856"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU5MjAxNQ==", "bodyText": "Are there any meaningful tests you want to bring from apache.directory?", "url": "https://github.com/hortonworks/cloudbreak/pull/7345#discussion_r383592015", "createdAt": "2020-02-25T00:21:08Z", "author": {"login": "giladwolff"}, "path": "freeipa/src/test/java/com/sequenceiq/freeipa/util/KrbKeyTabGeneratorTest.java", "diffHunk": "@@ -0,0 +1,56 @@\n+package com.sequenceiq.freeipa.util;\n+\n+import com.cloudera.thunderhead.service.usermanagement.UserManagementProto.ActorKerberosKey;\n+import com.sequenceiq.cloudbreak.common.service.Clock;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.InjectMocks;\n+import org.mockito.Mock;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+\n+import java.util.List;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.mockito.Mockito.when;\n+\n+@ExtendWith(MockitoExtension.class)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b1ddcca9b04cd7dc79dfc5bfb4e9b2dd0f32856"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU5MjMwMg==", "bodyText": "So what is the apache license? Can we copy the code and use it/modify it as long as we have the copyright statement?", "url": "https://github.com/hortonworks/cloudbreak/pull/7345#discussion_r383592302", "createdAt": "2020-02-25T00:22:02Z", "author": {"login": "giladwolff"}, "path": "freeipa/src/main/java/org/apache/directory/shared/kerberos/components/EncryptionKey.java", "diffHunk": "@@ -0,0 +1,330 @@\n+/*\n+ *  Licensed to the Apache Software Foundation (ASF) under one\n+ *  or more contributor license agreements.  See the NOTICE file\n+ *  distributed with this work for additional information\n+ *  regarding copyright ownership.  The ASF licenses this file\n+ *  to you under the Apache License, Version 2.0 (the", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b1ddcca9b04cd7dc79dfc5bfb4e9b2dd0f32856"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU5MjYzOA==", "bodyText": "I think I answered my own question by doing a git grep on thunderhead git repo. I think it's fine.", "url": "https://github.com/hortonworks/cloudbreak/pull/7345#discussion_r383592638", "createdAt": "2020-02-25T00:23:12Z", "author": {"login": "giladwolff"}, "path": "freeipa/src/main/java/org/apache/directory/shared/kerberos/components/EncryptionKey.java", "diffHunk": "@@ -0,0 +1,330 @@\n+/*\n+ *  Licensed to the Apache Software Foundation (ASF) under one\n+ *  or more contributor license agreements.  See the NOTICE file\n+ *  distributed with this work for additional information\n+ *  regarding copyright ownership.  The ASF licenses this file\n+ *  to you under the Apache License, Version 2.0 (the", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU5MjMwMg=="}, "originalCommit": {"oid": "1b1ddcca9b04cd7dc79dfc5bfb4e9b2dd0f32856"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzOTQ4Mzg4", "url": "https://github.com/hortonworks/cloudbreak/pull/7345#pullrequestreview-363948388", "createdAt": "2020-02-25T08:32:13Z", "commit": {"oid": "1b1ddcca9b04cd7dc79dfc5bfb4e9b2dd0f32856"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQwODozMjoxM1rOFt8qdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQwOTowMjowOFrOFt9mNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzcyNDE1MQ==", "bodyText": "either this or put it in a different modul. I prefer the latter\nwhat's the reason we don't use the library? is it too big?", "url": "https://github.com/hortonworks/cloudbreak/pull/7345#discussion_r383724151", "createdAt": "2020-02-25T08:32:13Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/org/apache/directory/README.md", "diffHunk": "@@ -0,0 +1,12 @@\n+This packge contains classes to aid in the generation of Kerberos Keytabs. The classes here are taken", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU5MTUxMg=="}, "originalCommit": {"oid": "1b1ddcca9b04cd7dc79dfc5bfb4e9b2dd0f32856"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzcyNTEyMA==", "bodyText": "this definitely smells, please look for a better place", "url": "https://github.com/hortonworks/cloudbreak/pull/7345#discussion_r383725120", "createdAt": "2020-02-25T08:34:11Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/util/KrbKeytabGenerator.java", "diffHunk": "@@ -0,0 +1,54 @@\n+package com.sequenceiq.freeipa.util;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUwMDg5Mw=="}, "originalCommit": {"oid": "1b1ddcca9b04cd7dc79dfc5bfb4e9b2dd0f32856"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzcyNTIxOA==", "bodyText": "where is this class used?", "url": "https://github.com/hortonworks/cloudbreak/pull/7345#discussion_r383725218", "createdAt": "2020-02-25T08:34:24Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/util/KrbKeytabGenerator.java", "diffHunk": "@@ -0,0 +1,54 @@\n+package com.sequenceiq.freeipa.util;\n+\n+import com.cloudera.thunderhead.service.usermanagement.UserManagementProto.ActorKerberosKey;\n+import com.sequenceiq.cloudbreak.common.service.Clock;\n+import org.apache.directory.server.kerberos.shared.keytab.KeytabEncoder;\n+import org.apache.directory.server.kerberos.shared.keytab.KeytabEntry;\n+import org.apache.directory.shared.kerberos.KerberosTime;\n+import org.apache.directory.shared.kerberos.codec.types.EncryptionType;\n+import org.apache.directory.shared.kerberos.components.EncryptionKey;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import javax.inject.Inject;\n+import java.util.Base64;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+@Component\n+public final class KrbKeytabGenerator {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b1ddcca9b04cd7dc79dfc5bfb4e9b2dd0f32856"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzcyNTcwMQ==", "bodyText": "these variables need more meaningful name, or if it's really necessary add comments please", "url": "https://github.com/hortonworks/cloudbreak/pull/7345#discussion_r383725701", "createdAt": "2020-02-25T08:35:24Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/util/KrbKeytabGenerator.java", "diffHunk": "@@ -0,0 +1,54 @@\n+package com.sequenceiq.freeipa.util;\n+\n+import com.cloudera.thunderhead.service.usermanagement.UserManagementProto.ActorKerberosKey;\n+import com.sequenceiq.cloudbreak.common.service.Clock;\n+import org.apache.directory.server.kerberos.shared.keytab.KeytabEncoder;\n+import org.apache.directory.server.kerberos.shared.keytab.KeytabEntry;\n+import org.apache.directory.shared.kerberos.KerberosTime;\n+import org.apache.directory.shared.kerberos.codec.types.EncryptionType;\n+import org.apache.directory.shared.kerberos.components.EncryptionKey;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import javax.inject.Inject;\n+import java.util.Base64;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+@Component\n+public final class KrbKeytabGenerator {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(KrbKeytabGenerator.class);\n+\n+    private static final int PRINCIPAL_TYPE_1 = 1;\n+\n+    private static final byte[] KEYTAB_VERSION_0X502 = { (byte) 0x05, (byte) 0x02 };\n+\n+    private static final byte KEY_VERSION_NUMBER_ZERO = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b1ddcca9b04cd7dc79dfc5bfb4e9b2dd0f32856"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzczOTQ0NA==", "bodyText": "it looks like to me there is only 1 happy path tested. Are you sure there isn't anything which can go wrong here? Like a parameter is wrong", "url": "https://github.com/hortonworks/cloudbreak/pull/7345#discussion_r383739444", "createdAt": "2020-02-25T09:02:08Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/test/java/com/sequenceiq/freeipa/util/KrbKeyTabGeneratorTest.java", "diffHunk": "@@ -0,0 +1,56 @@\n+package com.sequenceiq.freeipa.util;\n+\n+import com.cloudera.thunderhead.service.usermanagement.UserManagementProto.ActorKerberosKey;\n+import com.sequenceiq.cloudbreak.common.service.Clock;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.InjectMocks;\n+import org.mockito.Mock;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+\n+import java.util.List;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.mockito.Mockito.when;\n+\n+@ExtendWith(MockitoExtension.class)\n+public class KrbKeyTabGeneratorTest {\n+\n+    private static final long MOCK_TIME = 1576171731141L;\n+\n+    @InjectMocks\n+    KrbKeytabGenerator underTest;\n+\n+    @Mock\n+    private Clock clock;\n+\n+    @Test\n+    void testGenerateKeytabBase64() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b1ddcca9b04cd7dc79dfc5bfb4e9b2dd0f32856"}, "originalPosition": 28}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1b1ddcca9b04cd7dc79dfc5bfb4e9b2dd0f32856", "author": {"user": {"login": "aarman-cloudera", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/1b1ddcca9b04cd7dc79dfc5bfb4e9b2dd0f32856", "committedDate": "2020-02-20T21:23:53Z", "message": "CDPCP-1522. Add support for generating keytab from actor kerberos key\n\nA KrbKeytabGenerator class has been added that allows generating\na kerberos keytab by using the keys from ActorKerberosKey's. To make\nthe implementation easier, helper classes (the classes under\norg.apache.directory package) have been taken directly from\nApache DS 2.0 source code."}, "afterCommit": {"oid": "aff2bd274d662265b21fcb38d535f03b3930f67e", "author": {"user": {"login": "aarman-cloudera", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/aff2bd274d662265b21fcb38d535f03b3930f67e", "committedDate": "2020-02-26T21:04:43Z", "message": "CDPCP-1522. Add support for generating keytab from actor kerberos key\n\nA KrbKeytabGenerator class has been added that allows generating\na kerberos keytab by using the keys within ActorKerberosKey's.\nThis pulls in kerb-utils dependency from the Apache Kerby project\nwhich contains the classes needed to encode the principal and\nkeys into the keytab format. In addition KrbKeySetEncoder which\ndoes something similar has been moved under the same package.\n\nThis functionality of this class will be exposed as an api endpoint\nin a follow-on commit."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1NTI3MjM4", "url": "https://github.com/hortonworks/cloudbreak/pull/7345#pullrequestreview-365527238", "createdAt": "2020-02-27T09:29:29Z", "commit": {"oid": "aff2bd274d662265b21fcb38d535f03b3930f67e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QwOToyOToyOVrOFvK1Sw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QwOTozNTowOFrOFvLBpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTAwNDg3NQ==", "bodyText": "Not a big deal, but could you drop krb in favor of kerberos? I think the package should be user.kerberos and the class name UserKeytabGenerator. This would reflect more of it's purpose in my opinion.", "url": "https://github.com/hortonworks/cloudbreak/pull/7345#discussion_r385004875", "createdAt": "2020-02-27T09:29:29Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/krb/KrbKeytabGenerator.java", "diffHunk": "@@ -0,0 +1,70 @@\n+package com.sequenceiq.freeipa.service.freeipa.user.krb;\n+\n+import com.cloudera.thunderhead.service.usermanagement.UserManagementProto.ActorKerberosKey;\n+import com.sequenceiq.cloudbreak.common.service.Clock;\n+import org.apache.kerby.kerberos.kerb.keytab.Keytab;\n+import org.apache.kerby.kerberos.kerb.keytab.KeytabEntry;\n+import org.apache.kerby.kerberos.kerb.type.KerberosTime;\n+import org.apache.kerby.kerberos.kerb.type.base.EncryptionKey;\n+import org.apache.kerby.kerberos.kerb.type.base.EncryptionType;\n+import org.apache.kerby.kerberos.kerb.type.base.PrincipalName;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import javax.inject.Inject;\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.util.Base64;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * Kerberos keytab generator - This class is repsonsible for generating a keytab using existing keys\n+ * belonging to an actor in User Management Service.\n+ */\n+@Component\n+public final class KrbKeytabGenerator {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aff2bd274d662265b21fcb38d535f03b3930f67e"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTAwNjMzNA==", "bodyText": "I see one try without catch, so my concern is if something goes wrong in this code, maybe we would like to convert it to a custom exception a propagate it upwards in that format. What do you think about it?", "url": "https://github.com/hortonworks/cloudbreak/pull/7345#discussion_r385006334", "createdAt": "2020-02-27T09:32:04Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/krb/KrbKeytabGenerator.java", "diffHunk": "@@ -0,0 +1,70 @@\n+package com.sequenceiq.freeipa.service.freeipa.user.krb;\n+\n+import com.cloudera.thunderhead.service.usermanagement.UserManagementProto.ActorKerberosKey;\n+import com.sequenceiq.cloudbreak.common.service.Clock;\n+import org.apache.kerby.kerberos.kerb.keytab.Keytab;\n+import org.apache.kerby.kerberos.kerb.keytab.KeytabEntry;\n+import org.apache.kerby.kerberos.kerb.type.KerberosTime;\n+import org.apache.kerby.kerberos.kerb.type.base.EncryptionKey;\n+import org.apache.kerby.kerberos.kerb.type.base.EncryptionType;\n+import org.apache.kerby.kerberos.kerb.type.base.PrincipalName;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import javax.inject.Inject;\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.util.Base64;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * Kerberos keytab generator - This class is repsonsible for generating a keytab using existing keys\n+ * belonging to an actor in User Management Service.\n+ */\n+@Component\n+public final class KrbKeytabGenerator {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(KrbKeytabGenerator.class);\n+\n+    // For the key version number (kvno) in the keytab entries, we use a value of 0. Based on\n+    // expirementiation we've found that for user principles, keytab entries with kvno of zero\n+    // works fine, regardless of what the actual key versions are set in the KDC / Directory Server.\n+    private static final int KEY_VERSION_NUMBER_ZERO = 0;\n+\n+    @Inject\n+    private Clock clock;\n+\n+    private KeytabEntry toKeytabEntry(String user, String realm, ActorKerberosKey actorKerberosKey) {\n+        requireNonNull(user, \"user must not be null\");\n+        requireNonNull(realm, \"realm must not be null\");\n+        requireNonNull(actorKerberosKey, \"actorKerberosKey must not be null\");\n+\n+        PrincipalName principalName = new PrincipalName(user + '@' + realm);\n+\n+        EncryptionType encryptionType = EncryptionType.fromValue(actorKerberosKey.getKeyType());\n+        byte[] key = Base64.getDecoder().decode(actorKerberosKey.getKeyValue());\n+        EncryptionKey encryptionKey = new EncryptionKey(encryptionType, key);\n+\n+        KerberosTime time = new KerberosTime(clock.getCurrentTimeMillis());\n+\n+        return new KeytabEntry(principalName, time, KEY_VERSION_NUMBER_ZERO, encryptionKey);\n+    }\n+\n+    public String generateKeytabBase64(String username, String realm, List<ActorKerberosKey> actorKerberosKeys) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aff2bd274d662265b21fcb38d535f03b3930f67e"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTAwODAzOA==", "bodyText": "I think we need test for those non null checks at least.\nCould you come up with any scenario where other part of the code breaks? I mean a lot static calls are used so this is not easy to test, but what if ActorKerberosKey holds wrong value, or the username holds the whole principal. I think we should cover some unhappy path here.", "url": "https://github.com/hortonworks/cloudbreak/pull/7345#discussion_r385008038", "createdAt": "2020-02-27T09:35:08Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/test/java/com/sequenceiq/freeipa/service/freeipa/user/krb/KrbKeyTabGeneratorTest.java", "diffHunk": "@@ -0,0 +1,57 @@\n+package com.sequenceiq.freeipa.service.freeipa.user.krb;\n+\n+import com.cloudera.thunderhead.service.usermanagement.UserManagementProto.ActorKerberosKey;\n+import com.sequenceiq.cloudbreak.common.service.Clock;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.InjectMocks;\n+import org.mockito.Mock;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+\n+import java.io.IOException;\n+import java.util.List;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.mockito.Mockito.when;\n+\n+@ExtendWith(MockitoExtension.class)\n+public class KrbKeyTabGeneratorTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aff2bd274d662265b21fcb38d535f03b3930f67e"}, "originalPosition": 18}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "aff2bd274d662265b21fcb38d535f03b3930f67e", "author": {"user": {"login": "aarman-cloudera", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/aff2bd274d662265b21fcb38d535f03b3930f67e", "committedDate": "2020-02-26T21:04:43Z", "message": "CDPCP-1522. Add support for generating keytab from actor kerberos key\n\nA KrbKeytabGenerator class has been added that allows generating\na kerberos keytab by using the keys within ActorKerberosKey's.\nThis pulls in kerb-utils dependency from the Apache Kerby project\nwhich contains the classes needed to encode the principal and\nkeys into the keytab format. In addition KrbKeySetEncoder which\ndoes something similar has been moved under the same package.\n\nThis functionality of this class will be exposed as an api endpoint\nin a follow-on commit."}, "afterCommit": {"oid": "a754e4a9b0330ce3840214f1babed1e87c1de9a9", "author": {"user": {"login": "aarman-cloudera", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/a754e4a9b0330ce3840214f1babed1e87c1de9a9", "committedDate": "2020-02-29T00:11:48Z", "message": "CDPCP-1539. Expose api endpoint to retrieve / generate keys for an actor\n\nThis exposes a new endpoint in FreeIPA service to retrieve a keytab\nfor an actor under an environment."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2NzYzNTAx", "url": "https://github.com/hortonworks/cloudbreak/pull/7345#pullrequestreview-366763501", "createdAt": "2020-02-29T01:13:50Z", "commit": {"oid": "a754e4a9b0330ce3840214f1babed1e87c1de9a9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOVQwMToxMzo1MFrOFwGvUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOVQwMToxMzo1MFrOFwGvUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk4NjM4NA==", "bodyText": "'the calling has' -> 'the calling user has'", "url": "https://github.com/hortonworks/cloudbreak/pull/7345#discussion_r385986384", "createdAt": "2020-02-29T01:13:50Z", "author": {"login": "aarman-cloudera"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/controller/UserV1Controller.java", "diffHunk": "@@ -98,6 +102,19 @@ public SyncOperationStatus getSyncOperationStatus(@NotNull String operationId) {\n                 operationService.getOperationForAccountIdAndOperationId(accountId, operationId));\n     }\n \n+    @Override\n+    public String getKeytab(@NotNull String environmentCrn, String targetUserCrn) {\n+        String callerUserCrn = checkUserCrn();\n+        LOGGER.debug(\"getKeytab() request for environmentCrn={}, callerUserCrn={}, targetUserCrn={}\", environmentCrn, callerUserCrn, targetUserCrn);\n+        // TODO For now, we ignore the optional targetUserCrn and only allow retrieving keytab for the calling user. When\n+        //      we later enable this, we need to make sure that the calling has the necessary authorization / right to get", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a754e4a9b0330ce3840214f1babed1e87c1de9a9"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3NzgyMzEw", "url": "https://github.com/hortonworks/cloudbreak/pull/7345#pullrequestreview-367782310", "createdAt": "2020-03-03T08:33:33Z", "commit": {"oid": "a754e4a9b0330ce3840214f1babed1e87c1de9a9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwODozMzozM1rOFw8SXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwODozMzozM1rOFw8SXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njg2MzcwOQ==", "bodyText": "I think this should be in KerberosMgmtV1Endpoint. What do you think @handavid ?", "url": "https://github.com/hortonworks/cloudbreak/pull/7345#discussion_r386863709", "createdAt": "2020-03-03T08:33:33Z", "author": {"login": "lacikaaa"}, "path": "freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/user/UserV1Endpoint.java", "diffHunk": "@@ -52,4 +52,11 @@\n     @ApiOperation(value = UserOperationDescriptions.SYNC_OPERATION_STATUS, notes = UserNotes.USER_NOTES, produces = MediaType.APPLICATION_JSON,\n             nickname = \"getSyncOperationStatusV1\")\n     SyncOperationStatus getSyncOperationStatus(@NotNull @QueryParam(\"operationId\") String operationId);\n+\n+    @GET\n+    @Path(\"getKeytab\")\n+    @Produces(MediaType.APPLICATION_JSON)\n+    @ApiOperation(value = UserOperationDescriptions.GET_KEYTAB, notes = UserNotes.USER_NOTES, produces = MediaType.APPLICATION_JSON,\n+            nickname = \"getKeytabV1\")\n+    String getKeytab(@NotNull @QueryParam(\"environment\") String environment, @QueryParam(\"user\") String user);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a754e4a9b0330ce3840214f1babed1e87c1de9a9"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3Nzg0ODM2", "url": "https://github.com/hortonworks/cloudbreak/pull/7345#pullrequestreview-367784836", "createdAt": "2020-03-03T08:37:51Z", "commit": {"oid": "a754e4a9b0330ce3840214f1babed1e87c1de9a9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwODozNzo1MVrOFw8aGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwODozNzo1MVrOFw8aGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njg2NTY5MA==", "bodyText": "We might take of that targetUserCrn from the API and add it when we support it, as it won't be a breaking change. If we keep this way I think we should not throw an exception when target and caller crn are the same.", "url": "https://github.com/hortonworks/cloudbreak/pull/7345#discussion_r386865690", "createdAt": "2020-03-03T08:37:51Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/controller/UserV1Controller.java", "diffHunk": "@@ -98,6 +102,19 @@ public SyncOperationStatus getSyncOperationStatus(@NotNull String operationId) {\n                 operationService.getOperationForAccountIdAndOperationId(accountId, operationId));\n     }\n \n+    @Override\n+    public String getKeytab(@NotNull String environmentCrn, String targetUserCrn) {\n+        String callerUserCrn = checkUserCrn();\n+        LOGGER.debug(\"getKeytab() request for environmentCrn={}, callerUserCrn={}, targetUserCrn={}\", environmentCrn, callerUserCrn, targetUserCrn);\n+        // TODO For now, we ignore the optional targetUserCrn and only allow retrieving keytab for the calling user. When\n+        //      we later enable this, we need to make sure that the calling has the necessary authorization / right to get\n+        //      keytab for another user.\n+        if (targetUserCrn != null) {\n+            throw new BadRequestException(\"Retrieving a keytab for another user is not yet supported\");\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a754e4a9b0330ce3840214f1babed1e87c1de9a9"}, "originalPosition": 31}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a754e4a9b0330ce3840214f1babed1e87c1de9a9", "author": {"user": {"login": "aarman-cloudera", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/a754e4a9b0330ce3840214f1babed1e87c1de9a9", "committedDate": "2020-02-29T00:11:48Z", "message": "CDPCP-1539. Expose api endpoint to retrieve / generate keys for an actor\n\nThis exposes a new endpoint in FreeIPA service to retrieve a keytab\nfor an actor under an environment."}, "afterCommit": {"oid": "00189074cc3555868cda818d9d3e1a80764ceab8", "author": {"user": {"login": "aarman-cloudera", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/00189074cc3555868cda818d9d3e1a80764ceab8", "committedDate": "2020-03-03T21:42:16Z", "message": "CDPCP-1539. Expose api endpoint to retrieve / generate keys for an actor\n\nThis exposes a new endpoint in FreeIPA service to retrieve a keytab\nfor an actor under an environment."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "00189074cc3555868cda818d9d3e1a80764ceab8", "author": {"user": {"login": "aarman-cloudera", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/00189074cc3555868cda818d9d3e1a80764ceab8", "committedDate": "2020-03-03T21:42:16Z", "message": "CDPCP-1539. Expose api endpoint to retrieve / generate keys for an actor\n\nThis exposes a new endpoint in FreeIPA service to retrieve a keytab\nfor an actor under an environment."}, "afterCommit": {"oid": "96f885d6c58bf64599edb274845fd2f2ea4b2de0", "author": {"user": {"login": "aarman-cloudera", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/96f885d6c58bf64599edb274845fd2f2ea4b2de0", "committedDate": "2020-03-04T00:06:48Z", "message": "CDPCP-1539. Expose api endpoint to retrieve / generate keys for an actor\n\nThis exposes a new endpoint in FreeIPA service to retrieve a keytab\nfor an actor under an environment."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5OTU5NTU0", "url": "https://github.com/hortonworks/cloudbreak/pull/7345#pullrequestreview-369959554", "createdAt": "2020-03-05T22:26:21Z", "commit": {"oid": "96f885d6c58bf64599edb274845fd2f2ea4b2de0"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMjoyNjoyMVrOFymd9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMzowMjo1MlrOFynUlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYwMzM4Mg==", "bodyText": "Thanks for making these contributions, I have a couple of thoughts on this which you may have already considered. Sorry for the lengthy comment.\nFirst, its cool how this is an HTTP get. It looks like you have lots of logic that creates a keytab without using the public FreeIPA API to retrieve the keytab. I am quite intrigued at how you were able to do this. I think the public FreeIPA get keytab API for user principals updates the KVNO every time. \ud83d\ude04\nAs an aside, avoiding incrementing the KVNO for users is one of the features the TGT generator provides. The TGT generator creates service principals for users. For example, principal myuser/cluster1.cloudera.site@CLOUDERA.SITE will be used rather than myuser@CLOUDERA.SITE. In both cases, the principal will be mapped hadoop user myuser. This was done because only service principals could be retrieved without invalidating prior keytabs. I am not sure if this is something that would be useful to know more about but reach out to me if it is and I can provide you with the design documentation.\nSecond, although this only is able to retrieve the keytab for a specific user, I think the KerberosMgmtV1Endpoint is a more logical location for the code. That endpoint already handles keytabs for service principals and host principals. At some point, we may have a need for user principals.\nThrid, I think the other keytab API calls returned a vault path with the principal and the keytab. Vault should probably be used. The data in vault was base64 encoded.", "url": "https://github.com/hortonworks/cloudbreak/pull/7345#discussion_r388603382", "createdAt": "2020-03-05T22:26:21Z", "author": {"login": "jamisonbennett"}, "path": "freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/user/UserV1Endpoint.java", "diffHunk": "@@ -52,4 +52,11 @@\n     @ApiOperation(value = UserOperationDescriptions.SYNC_OPERATION_STATUS, notes = UserNotes.USER_NOTES, produces = MediaType.APPLICATION_JSON,\n             nickname = \"getSyncOperationStatusV1\")\n     SyncOperationStatus getSyncOperationStatus(@NotNull @QueryParam(\"operationId\") String operationId);\n+\n+    @GET\n+    @Path(\"getKeytab\")\n+    @Produces(MediaType.APPLICATION_JSON)\n+    @ApiOperation(value = UserOperationDescriptions.GET_KEYTAB, notes = UserNotes.USER_NOTES, produces = MediaType.APPLICATION_JSON,\n+            nickname = \"getKeytabV1\")\n+    String getKeytab(@NotNull @QueryParam(\"environment\") String environment, @QueryParam(\"user\") String user);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njg2MzcwOQ=="}, "originalCommit": {"oid": "a754e4a9b0330ce3840214f1babed1e87c1de9a9"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYwMzg0Nw==", "bodyText": "You should also probably mention that the data is base64 encoded and that is is a vault path (assuming you make the vault change).", "url": "https://github.com/hortonworks/cloudbreak/pull/7345#discussion_r388603847", "createdAt": "2020-03-05T22:27:30Z", "author": {"login": "jamisonbennett"}, "path": "freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/user/doc/UserOperationDescriptions.java", "diffHunk": "@@ -5,6 +5,7 @@\n     public static final String SYNC_ALL = \"Synchronizes Groups and Users to the FreeIPA servers\";\n     public static final String SET_PASSWORD = \"Sets the user's password in the FreeIPA servers\";\n     public static final String SYNC_OPERATION_STATUS = \"Gets the status of a sync operation\";\n+    public static final String GET_KEYTAB = \"Gets a keytab as a base64 encoded string for a User under a specified Environment\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96f885d6c58bf64599edb274845fd2f2ea4b2de0"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYwNTEzMA==", "bodyText": "nit: \"yet\" is probably not needed.", "url": "https://github.com/hortonworks/cloudbreak/pull/7345#discussion_r388605130", "createdAt": "2020-03-05T22:30:53Z", "author": {"login": "jamisonbennett"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/controller/UserV1Controller.java", "diffHunk": "@@ -107,6 +111,19 @@ public SyncOperationStatus getSyncOperationStatus(@NotNull String operationId) {\n                 operationService.getOperationForAccountIdAndOperationId(accountId, operationId));\n     }\n \n+    @Override\n+    public String getKeytab(@NotNull String environmentCrn, String targetUserCrn) {\n+        String callerUserCrn = checkUserCrn();\n+        LOGGER.debug(\"getKeytab() request for environmentCrn={}, callerUserCrn={}, targetUserCrn={}\", environmentCrn, callerUserCrn, targetUserCrn);\n+        // TODO For now, we ignore the optional targetUserCrn and only allow retrieving keytab for the calling user. When\n+        //      we later enable this, we need to make sure that the calling user has the necessary authorization / right to get\n+        //      keytab for another user.\n+        if (targetUserCrn != null && !callerUserCrn.equals(targetUserCrn)) {\n+            throw new BadRequestException(\"Retrieving a keytab for another user is not yet supported\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96f885d6c58bf64599edb274845fd2f2ea4b2de0"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYwNTQ3OA==", "bodyText": "I am glad to see you using the IAM service here rather than FREEIPA. I had to make a similar correction today \ud83d\ude04", "url": "https://github.com/hortonworks/cloudbreak/pull/7345#discussion_r388605478", "createdAt": "2020-03-05T22:31:51Z", "author": {"login": "jamisonbennett"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserKeytabService.java", "diffHunk": "@@ -0,0 +1,72 @@\n+package com.sequenceiq.freeipa.service.freeipa.user;\n+\n+import com.cloudera.thunderhead.service.usermanagement.UserManagementProto.GetActorWorkloadCredentialsResponse;\n+import com.cloudera.thunderhead.service.usermanagement.UserManagementProto.ActorKerberosKey;\n+import com.sequenceiq.cloudbreak.auth.altus.Crn;\n+import com.sequenceiq.cloudbreak.auth.altus.GrpcUmsClient;\n+import com.sequenceiq.cloudbreak.auth.security.InternalCrnBuilder;\n+import com.sequenceiq.cloudbreak.logger.MDCUtils;\n+import com.sequenceiq.freeipa.controller.exception.BadRequestException;\n+import com.sequenceiq.freeipa.kerberos.KerberosConfig;\n+import com.sequenceiq.freeipa.kerberos.KerberosConfigRepository;\n+import com.sequenceiq.freeipa.service.freeipa.user.kerberos.UserKeytabGenerator;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Service;\n+\n+import javax.inject.Inject;\n+\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Objects;\n+\n+import static com.sequenceiq.freeipa.controller.exception.NotFoundException.notFound;\n+\n+@Service\n+public class UserKeytabService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(UserKeytabService.class);\n+\n+    private static final String IAM_INTERNAL_ACTOR_CRN = new InternalCrnBuilder(Crn.Service.IAM).getInternalCrnForServiceAsString();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96f885d6c58bf64599edb274845fd2f2ea4b2de0"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYxNzM2NA==", "bodyText": "This is interesting that the value of 0 always works.\nAt one point, I had tested the kvno and every time the public FreeIPA API was called to get a user keytab, the KVNO incremented and the old keytab would stop working. Maybe the first KVNO that is issued by the public FreeIPA API is 1 and thus 0 can still be treated specially. You might want to double check this to ensure the user's keytab can't be invalidated (although I suppose we are not calling that API today so maybe its a don't care).\nI believe that at one point @toddlipcon worked on a way to get user keytabs without invalidating them. Is this the same process? I am pretty curious about this.", "url": "https://github.com/hortonworks/cloudbreak/pull/7345#discussion_r388617364", "createdAt": "2020-03-05T23:02:52Z", "author": {"login": "jamisonbennett"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/kerberos/UserKeytabGenerator.java", "diffHunk": "@@ -0,0 +1,75 @@\n+package com.sequenceiq.freeipa.service.freeipa.user.kerberos;\n+\n+import com.cloudera.thunderhead.service.usermanagement.UserManagementProto.ActorKerberosKey;\n+import com.sequenceiq.cloudbreak.common.service.Clock;\n+import org.apache.kerby.kerberos.kerb.keytab.Keytab;\n+import org.apache.kerby.kerberos.kerb.keytab.KeytabEntry;\n+import org.apache.kerby.kerberos.kerb.type.KerberosTime;\n+import org.apache.kerby.kerberos.kerb.type.base.EncryptionKey;\n+import org.apache.kerby.kerberos.kerb.type.base.EncryptionType;\n+import org.apache.kerby.kerberos.kerb.type.base.PrincipalName;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import javax.inject.Inject;\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.util.Base64;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * Kerberos keytab generator - This class is repsonsible for generating a keytab using existing keys\n+ * belonging to an actor in User Management Service.\n+ */\n+@Component\n+public class UserKeytabGenerator {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(UserKeytabGenerator.class);\n+\n+    // For the key version number (kvno) in the keytab entries, we use a value of 0. Based on\n+    // expirementiation we've found that for user principles, keytab entries with kvno of zero\n+    // works fine, regardless of what the actual key versions are set in the KDC / Directory Server.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96f885d6c58bf64599edb274845fd2f2ea4b2de0"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwMDc3MjI1", "url": "https://github.com/hortonworks/cloudbreak/pull/7345#pullrequestreview-370077225", "createdAt": "2020-03-06T04:33:21Z", "commit": {"oid": "96f885d6c58bf64599edb274845fd2f2ea4b2de0"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQwNDozMzoyMVrOFys6Ng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQwNDo0NjozNlrOFytDYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODcwODkxOA==", "bodyText": "I'll defer to Jamison here regarding keytab generation. Based on his comments, I think that this API probably belongs next to the other keytab APIs", "url": "https://github.com/hortonworks/cloudbreak/pull/7345#discussion_r388708918", "createdAt": "2020-03-06T04:33:21Z", "author": {"login": "handavid"}, "path": "freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/user/UserV1Endpoint.java", "diffHunk": "@@ -52,4 +52,11 @@\n     @ApiOperation(value = UserOperationDescriptions.SYNC_OPERATION_STATUS, notes = UserNotes.USER_NOTES, produces = MediaType.APPLICATION_JSON,\n             nickname = \"getSyncOperationStatusV1\")\n     SyncOperationStatus getSyncOperationStatus(@NotNull @QueryParam(\"operationId\") String operationId);\n+\n+    @GET\n+    @Path(\"getKeytab\")\n+    @Produces(MediaType.APPLICATION_JSON)\n+    @ApiOperation(value = UserOperationDescriptions.GET_KEYTAB, notes = UserNotes.USER_NOTES, produces = MediaType.APPLICATION_JSON,\n+            nickname = \"getKeytabV1\")\n+    String getKeytab(@NotNull @QueryParam(\"environment\") String environment, @QueryParam(\"user\") String user);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njg2MzcwOQ=="}, "originalCommit": {"oid": "a754e4a9b0330ce3840214f1babed1e87c1de9a9"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODcwOTAzMA==", "bodyText": "if the query params are CRNs, then let's include CRN in the names. e.g., environmentCrn", "url": "https://github.com/hortonworks/cloudbreak/pull/7345#discussion_r388709030", "createdAt": "2020-03-06T04:33:57Z", "author": {"login": "handavid"}, "path": "freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/user/UserV1Endpoint.java", "diffHunk": "@@ -52,4 +52,11 @@\n     @ApiOperation(value = UserOperationDescriptions.SYNC_OPERATION_STATUS, notes = UserNotes.USER_NOTES, produces = MediaType.APPLICATION_JSON,\n             nickname = \"getSyncOperationStatusV1\")\n     SyncOperationStatus getSyncOperationStatus(@NotNull @QueryParam(\"operationId\") String operationId);\n+\n+    @GET\n+    @Path(\"getKeytab\")\n+    @Produces(MediaType.APPLICATION_JSON)\n+    @ApiOperation(value = UserOperationDescriptions.GET_KEYTAB, notes = UserNotes.USER_NOTES, produces = MediaType.APPLICATION_JSON,\n+            nickname = \"getKeytabV1\")\n+    String getKeytab(@NotNull @QueryParam(\"environment\") String environment, @QueryParam(\"user\") String user);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96f885d6c58bf64599edb274845fd2f2ea4b2de0"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODcwOTc5Mg==", "bodyText": "based on the expected future use-case, we should require the targetUserCrn field. i.e., mark it @NotNull.\nAs a design principle, we do not want to pull request arguments out of the actor or other metadata. All required information should be in the request itself. (yes, a bunch of the other APIs violate this but I'll fix this in the v2 API)\ncan we rename callerUserCrn to actorCrn?\nwe can keep the actorCrn.equals(targetUserCrn) check as a faux authorization check for now.", "url": "https://github.com/hortonworks/cloudbreak/pull/7345#discussion_r388709792", "createdAt": "2020-03-06T04:38:28Z", "author": {"login": "handavid"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/controller/UserV1Controller.java", "diffHunk": "@@ -107,6 +111,19 @@ public SyncOperationStatus getSyncOperationStatus(@NotNull String operationId) {\n                 operationService.getOperationForAccountIdAndOperationId(accountId, operationId));\n     }\n \n+    @Override\n+    public String getKeytab(@NotNull String environmentCrn, String targetUserCrn) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96f885d6c58bf64599edb274845fd2f2ea4b2de0"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODcwOTkwNQ==", "bodyText": "we had a talk ;)", "url": "https://github.com/hortonworks/cloudbreak/pull/7345#discussion_r388709905", "createdAt": "2020-03-06T04:39:00Z", "author": {"login": "handavid"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserKeytabService.java", "diffHunk": "@@ -0,0 +1,72 @@\n+package com.sequenceiq.freeipa.service.freeipa.user;\n+\n+import com.cloudera.thunderhead.service.usermanagement.UserManagementProto.GetActorWorkloadCredentialsResponse;\n+import com.cloudera.thunderhead.service.usermanagement.UserManagementProto.ActorKerberosKey;\n+import com.sequenceiq.cloudbreak.auth.altus.Crn;\n+import com.sequenceiq.cloudbreak.auth.altus.GrpcUmsClient;\n+import com.sequenceiq.cloudbreak.auth.security.InternalCrnBuilder;\n+import com.sequenceiq.cloudbreak.logger.MDCUtils;\n+import com.sequenceiq.freeipa.controller.exception.BadRequestException;\n+import com.sequenceiq.freeipa.kerberos.KerberosConfig;\n+import com.sequenceiq.freeipa.kerberos.KerberosConfigRepository;\n+import com.sequenceiq.freeipa.service.freeipa.user.kerberos.UserKeytabGenerator;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Service;\n+\n+import javax.inject.Inject;\n+\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Objects;\n+\n+import static com.sequenceiq.freeipa.controller.exception.NotFoundException.notFound;\n+\n+@Service\n+public class UserKeytabService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(UserKeytabService.class);\n+\n+    private static final String IAM_INTERNAL_ACTOR_CRN = new InternalCrnBuilder(Crn.Service.IAM).getInternalCrnForServiceAsString();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYwNTQ3OA=="}, "originalCommit": {"oid": "96f885d6c58bf64599edb274845fd2f2ea4b2de0"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODcxMDQ0Nw==", "bodyText": "call this with the targetUserCrn rather than the actorCrn. The actorCrn will be available to other code in through the ThreadBasedUserCrnProvider (I think I remembered that correctly)", "url": "https://github.com/hortonworks/cloudbreak/pull/7345#discussion_r388710447", "createdAt": "2020-03-06T04:42:10Z", "author": {"login": "handavid"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/controller/UserV1Controller.java", "diffHunk": "@@ -107,6 +111,19 @@ public SyncOperationStatus getSyncOperationStatus(@NotNull String operationId) {\n                 operationService.getOperationForAccountIdAndOperationId(accountId, operationId));\n     }\n \n+    @Override\n+    public String getKeytab(@NotNull String environmentCrn, String targetUserCrn) {\n+        String callerUserCrn = checkUserCrn();\n+        LOGGER.debug(\"getKeytab() request for environmentCrn={}, callerUserCrn={}, targetUserCrn={}\", environmentCrn, callerUserCrn, targetUserCrn);\n+        // TODO For now, we ignore the optional targetUserCrn and only allow retrieving keytab for the calling user. When\n+        //      we later enable this, we need to make sure that the calling user has the necessary authorization / right to get\n+        //      keytab for another user.\n+        if (targetUserCrn != null && !callerUserCrn.equals(targetUserCrn)) {\n+            throw new BadRequestException(\"Retrieving a keytab for another user is not yet supported\");\n+        }\n+        return userKeytabService.getKeytabBase64(callerUserCrn, environmentCrn);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96f885d6c58bf64599edb274845fd2f2ea4b2de0"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODcxMDc2OA==", "bodyText": "Crn.safeFromString instead of Objects.requireNonNull", "url": "https://github.com/hortonworks/cloudbreak/pull/7345#discussion_r388710768", "createdAt": "2020-03-06T04:43:52Z", "author": {"login": "handavid"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserKeytabService.java", "diffHunk": "@@ -0,0 +1,72 @@\n+package com.sequenceiq.freeipa.service.freeipa.user;\n+\n+import com.cloudera.thunderhead.service.usermanagement.UserManagementProto.GetActorWorkloadCredentialsResponse;\n+import com.cloudera.thunderhead.service.usermanagement.UserManagementProto.ActorKerberosKey;\n+import com.sequenceiq.cloudbreak.auth.altus.Crn;\n+import com.sequenceiq.cloudbreak.auth.altus.GrpcUmsClient;\n+import com.sequenceiq.cloudbreak.auth.security.InternalCrnBuilder;\n+import com.sequenceiq.cloudbreak.logger.MDCUtils;\n+import com.sequenceiq.freeipa.controller.exception.BadRequestException;\n+import com.sequenceiq.freeipa.kerberos.KerberosConfig;\n+import com.sequenceiq.freeipa.kerberos.KerberosConfigRepository;\n+import com.sequenceiq.freeipa.service.freeipa.user.kerberos.UserKeytabGenerator;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Service;\n+\n+import javax.inject.Inject;\n+\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Objects;\n+\n+import static com.sequenceiq.freeipa.controller.exception.NotFoundException.notFound;\n+\n+@Service\n+public class UserKeytabService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(UserKeytabService.class);\n+\n+    private static final String IAM_INTERNAL_ACTOR_CRN = new InternalCrnBuilder(Crn.Service.IAM).getInternalCrnForServiceAsString();\n+\n+    @Inject\n+    private KerberosConfigRepository kerberosConfigRepository;\n+\n+    @Inject\n+    private GrpcUmsClient grpcUmsClient;\n+\n+    @Inject\n+    private UserKeytabGenerator userKeytabGenerator;\n+\n+    private String getKerberosRealm(String accountId, String environmentCrn) {\n+        KerberosConfig krbConfig =  kerberosConfigRepository\n+                .findByAccountIdAndEnvironmentCrnAndClusterNameIsNull(accountId, environmentCrn)\n+                .orElseThrow(notFound(\"KerberosConfig for environment\", environmentCrn));\n+        return krbConfig.getRealm();\n+    }\n+\n+    private void validateSameAccount(String userAccountId, String environmentCrn) {\n+        String environmentCrnAccountId = Objects.requireNonNull(Crn.fromString(environmentCrn)).getAccountId();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96f885d6c58bf64599edb274845fd2f2ea4b2de0"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODcxMDgxMw==", "bodyText": "Crn.safeFromString instead of Objects.requireNonNull", "url": "https://github.com/hortonworks/cloudbreak/pull/7345#discussion_r388710813", "createdAt": "2020-03-06T04:44:09Z", "author": {"login": "handavid"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserKeytabService.java", "diffHunk": "@@ -0,0 +1,72 @@\n+package com.sequenceiq.freeipa.service.freeipa.user;\n+\n+import com.cloudera.thunderhead.service.usermanagement.UserManagementProto.GetActorWorkloadCredentialsResponse;\n+import com.cloudera.thunderhead.service.usermanagement.UserManagementProto.ActorKerberosKey;\n+import com.sequenceiq.cloudbreak.auth.altus.Crn;\n+import com.sequenceiq.cloudbreak.auth.altus.GrpcUmsClient;\n+import com.sequenceiq.cloudbreak.auth.security.InternalCrnBuilder;\n+import com.sequenceiq.cloudbreak.logger.MDCUtils;\n+import com.sequenceiq.freeipa.controller.exception.BadRequestException;\n+import com.sequenceiq.freeipa.kerberos.KerberosConfig;\n+import com.sequenceiq.freeipa.kerberos.KerberosConfigRepository;\n+import com.sequenceiq.freeipa.service.freeipa.user.kerberos.UserKeytabGenerator;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Service;\n+\n+import javax.inject.Inject;\n+\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Objects;\n+\n+import static com.sequenceiq.freeipa.controller.exception.NotFoundException.notFound;\n+\n+@Service\n+public class UserKeytabService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(UserKeytabService.class);\n+\n+    private static final String IAM_INTERNAL_ACTOR_CRN = new InternalCrnBuilder(Crn.Service.IAM).getInternalCrnForServiceAsString();\n+\n+    @Inject\n+    private KerberosConfigRepository kerberosConfigRepository;\n+\n+    @Inject\n+    private GrpcUmsClient grpcUmsClient;\n+\n+    @Inject\n+    private UserKeytabGenerator userKeytabGenerator;\n+\n+    private String getKerberosRealm(String accountId, String environmentCrn) {\n+        KerberosConfig krbConfig =  kerberosConfigRepository\n+                .findByAccountIdAndEnvironmentCrnAndClusterNameIsNull(accountId, environmentCrn)\n+                .orElseThrow(notFound(\"KerberosConfig for environment\", environmentCrn));\n+        return krbConfig.getRealm();\n+    }\n+\n+    private void validateSameAccount(String userAccountId, String environmentCrn) {\n+        String environmentCrnAccountId = Objects.requireNonNull(Crn.fromString(environmentCrn)).getAccountId();\n+        if (!environmentCrnAccountId.equals(userAccountId)) {\n+            throw new BadRequestException(\"User and Environment must be in the same account\");\n+        }\n+    }\n+\n+    public String getKeytabBase64(String userCrn, String environmentCrn) {\n+        String userAccountId = Objects.requireNonNull(Crn.fromString(userCrn)).getAccountId();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96f885d6c58bf64599edb274845fd2f2ea4b2de0"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODcxMTE0OA==", "bodyText": "can you throw a more meaningful exception? perhaps make a custom exception so that we can map it to a response code in the api layer", "url": "https://github.com/hortonworks/cloudbreak/pull/7345#discussion_r388711148", "createdAt": "2020-03-06T04:46:03Z", "author": {"login": "handavid"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserKeytabService.java", "diffHunk": "@@ -0,0 +1,72 @@\n+package com.sequenceiq.freeipa.service.freeipa.user;\n+\n+import com.cloudera.thunderhead.service.usermanagement.UserManagementProto.GetActorWorkloadCredentialsResponse;\n+import com.cloudera.thunderhead.service.usermanagement.UserManagementProto.ActorKerberosKey;\n+import com.sequenceiq.cloudbreak.auth.altus.Crn;\n+import com.sequenceiq.cloudbreak.auth.altus.GrpcUmsClient;\n+import com.sequenceiq.cloudbreak.auth.security.InternalCrnBuilder;\n+import com.sequenceiq.cloudbreak.logger.MDCUtils;\n+import com.sequenceiq.freeipa.controller.exception.BadRequestException;\n+import com.sequenceiq.freeipa.kerberos.KerberosConfig;\n+import com.sequenceiq.freeipa.kerberos.KerberosConfigRepository;\n+import com.sequenceiq.freeipa.service.freeipa.user.kerberos.UserKeytabGenerator;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Service;\n+\n+import javax.inject.Inject;\n+\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Objects;\n+\n+import static com.sequenceiq.freeipa.controller.exception.NotFoundException.notFound;\n+\n+@Service\n+public class UserKeytabService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(UserKeytabService.class);\n+\n+    private static final String IAM_INTERNAL_ACTOR_CRN = new InternalCrnBuilder(Crn.Service.IAM).getInternalCrnForServiceAsString();\n+\n+    @Inject\n+    private KerberosConfigRepository kerberosConfigRepository;\n+\n+    @Inject\n+    private GrpcUmsClient grpcUmsClient;\n+\n+    @Inject\n+    private UserKeytabGenerator userKeytabGenerator;\n+\n+    private String getKerberosRealm(String accountId, String environmentCrn) {\n+        KerberosConfig krbConfig =  kerberosConfigRepository\n+                .findByAccountIdAndEnvironmentCrnAndClusterNameIsNull(accountId, environmentCrn)\n+                .orElseThrow(notFound(\"KerberosConfig for environment\", environmentCrn));\n+        return krbConfig.getRealm();\n+    }\n+\n+    private void validateSameAccount(String userAccountId, String environmentCrn) {\n+        String environmentCrnAccountId = Objects.requireNonNull(Crn.fromString(environmentCrn)).getAccountId();\n+        if (!environmentCrnAccountId.equals(userAccountId)) {\n+            throw new BadRequestException(\"User and Environment must be in the same account\");\n+        }\n+    }\n+\n+    public String getKeytabBase64(String userCrn, String environmentCrn) {\n+        String userAccountId = Objects.requireNonNull(Crn.fromString(userCrn)).getAccountId();\n+        validateSameAccount(userAccountId, environmentCrn);\n+\n+        String realm = getKerberosRealm(userAccountId, environmentCrn);\n+\n+        GetActorWorkloadCredentialsResponse getActorWorkloadCredentialsResponse =\n+                grpcUmsClient.getActorWorkloadCredentials(IAM_INTERNAL_ACTOR_CRN, userCrn, MDCUtils.getRequestId());\n+        String workloadUsername = getActorWorkloadCredentialsResponse.getWorkloadUsername();\n+        List<ActorKerberosKey> actorKerberosKeys = getActorWorkloadCredentialsResponse.getKerberosKeysList();\n+\n+        try {\n+            return userKeytabGenerator.generateKeytabBase64(workloadUsername, realm, actorKerberosKeys);\n+        } catch (IOException e) {\n+            throw new RuntimeException(\"Failed to generate keytab\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96f885d6c58bf64599edb274845fd2f2ea4b2de0"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODcxMTI2Nw==", "bodyText": "thank you!", "url": "https://github.com/hortonworks/cloudbreak/pull/7345#discussion_r388711267", "createdAt": "2020-03-06T04:46:36Z", "author": {"login": "handavid"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/kerberos/KrbKeySetEncoder.java", "diffHunk": "@@ -1,4 +1,4 @@\n-package com.sequenceiq.freeipa.util;\n+package com.sequenceiq.freeipa.service.freeipa.user.kerberos;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96f885d6c58bf64599edb274845fd2f2ea4b2de0"}, "originalPosition": 2}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "42d1ab972808c5f68f25f3c330850c3e23f4e1f4", "author": {"user": {"login": "aarman-cloudera", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/42d1ab972808c5f68f25f3c330850c3e23f4e1f4", "committedDate": "2020-03-09T18:18:36Z", "message": "CDPCP-1522. Add support for generating keytab from actor kerberos key\n\nA UserKeytabGenerator class has been added that allows generating\na kerberos keytab by using the keys within ActorKerberosKey's.\nThis pulls in kerb-utils dependency from the Apache Kerby project\nwhich contains the classes needed to encode the principal and\nkeys into the keytab format. In addition KrbKeySetEncoder which\ndoes something similar has been moved under the same package.\n\nThis functionality of this class will be exposed as an api endpoint\nin a follow-on commit."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2aec23deb736b71b80caf2c119ca1ae5dd276dd6", "author": {"user": {"login": "aarman-cloudera", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/2aec23deb736b71b80caf2c119ca1ae5dd276dd6", "committedDate": "2020-03-09T18:18:36Z", "message": "CDPCP-1291. Update UMS client to include workload username in actor workload credentials\n\nThis will make it easier to generate keytab from actor workload credentials."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "96f885d6c58bf64599edb274845fd2f2ea4b2de0", "author": {"user": {"login": "aarman-cloudera", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/96f885d6c58bf64599edb274845fd2f2ea4b2de0", "committedDate": "2020-03-04T00:06:48Z", "message": "CDPCP-1539. Expose api endpoint to retrieve / generate keys for an actor\n\nThis exposes a new endpoint in FreeIPA service to retrieve a keytab\nfor an actor under an environment."}, "afterCommit": {"oid": "9854b39fed1500670ec79362d22084e72c8a6b6a", "author": {"user": {"login": "aarman-cloudera", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/9854b39fed1500670ec79362d22084e72c8a6b6a", "committedDate": "2020-03-09T22:37:46Z", "message": "CDPCP-1539. Expose api endpoint to retrieve / generate keys for an actor\n\nThis exposes a new endpoint in FreeIPA service to retrieve a keytab\nfor an actor under an environment."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc7f766029d25bd7a7cce8c87f067d5dbf44c8c7", "author": {"user": {"login": "aarman-cloudera", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/cc7f766029d25bd7a7cce8c87f067d5dbf44c8c7", "committedDate": "2020-03-09T23:24:33Z", "message": "CDPCP-1539. Expose api endpoint to retrieve / generate keys for an actor\n\nThis exposes a new endpoint in FreeIPA service to retrieve a keytab\nfor an actor under an environment."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9854b39fed1500670ec79362d22084e72c8a6b6a", "author": {"user": {"login": "aarman-cloudera", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/9854b39fed1500670ec79362d22084e72c8a6b6a", "committedDate": "2020-03-09T22:37:46Z", "message": "CDPCP-1539. Expose api endpoint to retrieve / generate keys for an actor\n\nThis exposes a new endpoint in FreeIPA service to retrieve a keytab\nfor an actor under an environment."}, "afterCommit": {"oid": "cc7f766029d25bd7a7cce8c87f067d5dbf44c8c7", "author": {"user": {"login": "aarman-cloudera", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/cc7f766029d25bd7a7cce8c87f067d5dbf44c8c7", "committedDate": "2020-03-09T23:24:33Z", "message": "CDPCP-1539. Expose api endpoint to retrieve / generate keys for an actor\n\nThis exposes a new endpoint in FreeIPA service to retrieve a keytab\nfor an actor under an environment."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxODQ5NDUy", "url": "https://github.com/hortonworks/cloudbreak/pull/7345#pullrequestreview-371849452", "createdAt": "2020-03-10T10:52:50Z", "commit": {"oid": "cc7f766029d25bd7a7cce8c87f067d5dbf44c8c7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2563, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}