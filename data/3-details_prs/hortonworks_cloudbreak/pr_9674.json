{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQzNTQxNjQ5", "number": 9674, "title": "CB-9182 Add Support for CCMV2", "bodyText": "Support for CB, FREEIPA Integration with CCMV2 Service behind an entitlement.\nDH, DL, FREEIPA Image User Data Generation enhanced to store CCMV2 config as user data variables.\nSupport for CB, FREEIPA Integration with Cluster-Proxy for CCMV2 configs\n\nSee detailed description in the commit message.", "createdAt": "2020-12-21T15:15:20Z", "url": "https://github.com/hortonworks/cloudbreak/pull/9674", "merged": true, "mergeCommit": {"oid": "a7514d7dfd36480c918bbd788971c8e4142f8e31"}, "closed": true, "closedAt": "2021-01-08T12:47:20Z", "author": {"login": "smaniraju"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdot_L6gBqjQxNDExMDAxNjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABduG2M1gFqTU2NDE4NDI5MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cd635592eba71b0bec1b46dcc09cebd98dd2ee1a", "author": {"user": {"login": "smaniraju", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/cd635592eba71b0bec1b46dcc09cebd98dd2ee1a", "committedDate": "2020-12-21T12:19:30Z", "message": "CB-9182 Add Support for CCMV2\n\n1. Support for CB,FREEIPA Integration with CCMV2 Service behind an entitlement.\n2. DH, DL, FREEIPA Image User Data Generation enhanced to store CCMV2 config as user data variables.\n3. Support for CB,FREEIPA Integration with Cluster-Proxy for CCMV2 configs"}, "afterCommit": {"oid": "8ae8085c2193cdabce84b24a418ac004d4d462eb", "author": {"user": {"login": "smaniraju", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/8ae8085c2193cdabce84b24a418ac004d4d462eb", "committedDate": "2020-12-22T16:52:15Z", "message": "CB-9182 Add Support for CCMV2\n\n1. Support for CB,FREEIPA Integration with CCMV2 Service behind an entitlement.\n2. DH, DL, FREEIPA Image User Data Generation enhanced to store CCMV2 config as user data variables.\n3. Support for CB,FREEIPA Integration with Cluster-Proxy for CCMV2 configs"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8ae8085c2193cdabce84b24a418ac004d4d462eb", "author": {"user": {"login": "smaniraju", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/8ae8085c2193cdabce84b24a418ac004d4d462eb", "committedDate": "2020-12-22T16:52:15Z", "message": "CB-9182 Add Support for CCMV2\n\n1. Support for CB,FREEIPA Integration with CCMV2 Service behind an entitlement.\n2. DH, DL, FREEIPA Image User Data Generation enhanced to store CCMV2 config as user data variables.\n3. Support for CB,FREEIPA Integration with Cluster-Proxy for CCMV2 configs"}, "afterCommit": {"oid": "e7e0393c64b29de6ef8d72dc182ec08e349b40ac", "author": {"user": {"login": "smaniraju", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/e7e0393c64b29de6ef8d72dc182ec08e349b40ac", "committedDate": "2021-01-04T04:34:14Z", "message": "CB-9182 Add Support for CCMV2\n\n1. Support for CB,FREEIPA Integration with CCMV2 Service behind an entitlement.\n2. DH, DL, FREEIPA Image User Data Generation enhanced to store CCMV2 config as user data variables.\n3. Support for CB,FREEIPA Integration with Cluster-Proxy for CCMV2 configs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYwOTAyNTQw", "url": "https://github.com/hortonworks/cloudbreak/pull/9674#pullrequestreview-560902540", "createdAt": "2021-01-04T09:57:21Z", "commit": {"oid": "e7e0393c64b29de6ef8d72dc182ec08e349b40ac"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 26, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQwOTo1NzoyMVrOINrjig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQxMTo1NzozM1rOINvIpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTIxNjAxMA==", "bodyText": "while this is a compact form I would prefer if you could split this into multiple lines and log the value of grpcCcmV2Client.getOrCreateInvertingProxy. This way we would be able to tell if it is null or the state is wrong", "url": "https://github.com/hortonworks/cloudbreak/pull/9674#discussion_r551216010", "createdAt": "2021-01-04T09:57:21Z", "author": {"login": "lacikaaa"}, "path": "ccm-connector/src/main/java/com/sequenceiq/cloudbreak/ccmimpl/ccmv2/CcmV2ManagementClient.java", "diffHunk": "@@ -0,0 +1,83 @@\n+package com.sequenceiq.cloudbreak.ccmimpl.ccmv2;\n+\n+import java.util.Optional;\n+\n+import javax.inject.Inject;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.retry.backoff.FixedBackOffPolicy;\n+import org.springframework.retry.policy.TimeoutRetryPolicy;\n+import org.springframework.retry.support.RetryTemplate;\n+import org.springframework.stereotype.Component;\n+\n+import com.cloudera.thunderhead.service.clusterconnectivitymanagementv2.ClusterConnectivityManagementV2Proto.UnregisterAgentResponse;\n+import com.cloudera.thunderhead.service.clusterconnectivitymanagementv2.ClusterConnectivityManagementV2Proto.InvertingProxy;\n+import com.cloudera.thunderhead.service.clusterconnectivitymanagementv2.ClusterConnectivityManagementV2Proto.InvertingProxyAgent;\n+import com.sequenceiq.cloudbreak.auth.ThreadBasedUserCrnProvider;\n+import com.sequenceiq.cloudbreak.ccmimpl.ccmv2.config.GrpcCcmV2Config;\n+\n+@Component\n+public class CcmV2ManagementClient {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(CcmV2ManagementClient.class);\n+\n+    @Inject\n+    private GrpcCcmV2Client grpcCcmV2Client;\n+\n+    @Inject\n+    private GrpcCcmV2Config grpcCcmV2Config;\n+\n+    public InvertingProxy awaitReadyInvertingProxyForAccount(String requestId, String accountId) {\n+        return getRetryTemplate().execute(\n+                retryContext -> {\n+                    LOGGER.debug(\"Retrieving InvertingProxy Config for accountId '{}'\", accountId);\n+                    return Optional.ofNullable(grpcCcmV2Client.getOrCreateInvertingProxy(requestId, accountId, ThreadBasedUserCrnProvider.getUserCrn()))\n+                            .filter(invertingProxy -> InvertingProxy.Status.READY.equals(invertingProxy.getStatus()))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7e0393c64b29de6ef8d72dc182ec08e349b40ac"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTIxNjI5OA==", "bodyText": "could you introduce a new exception for this? (and the others)\nalso I'm not sure if RuntimeException is the right way to go here. Shouldn't we enforce the handling of these expected exception on the callers side?", "url": "https://github.com/hortonworks/cloudbreak/pull/9674#discussion_r551216298", "createdAt": "2021-01-04T09:57:58Z", "author": {"login": "lacikaaa"}, "path": "ccm-connector/src/main/java/com/sequenceiq/cloudbreak/ccmimpl/ccmv2/CcmV2ManagementClient.java", "diffHunk": "@@ -0,0 +1,83 @@\n+package com.sequenceiq.cloudbreak.ccmimpl.ccmv2;\n+\n+import java.util.Optional;\n+\n+import javax.inject.Inject;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.retry.backoff.FixedBackOffPolicy;\n+import org.springframework.retry.policy.TimeoutRetryPolicy;\n+import org.springframework.retry.support.RetryTemplate;\n+import org.springframework.stereotype.Component;\n+\n+import com.cloudera.thunderhead.service.clusterconnectivitymanagementv2.ClusterConnectivityManagementV2Proto.UnregisterAgentResponse;\n+import com.cloudera.thunderhead.service.clusterconnectivitymanagementv2.ClusterConnectivityManagementV2Proto.InvertingProxy;\n+import com.cloudera.thunderhead.service.clusterconnectivitymanagementv2.ClusterConnectivityManagementV2Proto.InvertingProxyAgent;\n+import com.sequenceiq.cloudbreak.auth.ThreadBasedUserCrnProvider;\n+import com.sequenceiq.cloudbreak.ccmimpl.ccmv2.config.GrpcCcmV2Config;\n+\n+@Component\n+public class CcmV2ManagementClient {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(CcmV2ManagementClient.class);\n+\n+    @Inject\n+    private GrpcCcmV2Client grpcCcmV2Client;\n+\n+    @Inject\n+    private GrpcCcmV2Config grpcCcmV2Config;\n+\n+    public InvertingProxy awaitReadyInvertingProxyForAccount(String requestId, String accountId) {\n+        return getRetryTemplate().execute(\n+                retryContext -> {\n+                    LOGGER.debug(\"Retrieving InvertingProxy Config for accountId '{}'\", accountId);\n+                    return Optional.ofNullable(grpcCcmV2Client.getOrCreateInvertingProxy(requestId, accountId, ThreadBasedUserCrnProvider.getUserCrn()))\n+                            .filter(invertingProxy -> InvertingProxy.Status.READY.equals(invertingProxy.getStatus()))\n+                            .orElseThrow(() -> new RuntimeException(String.format(\"InvertingProxy not found in ready state for accountId '%s'\", accountId)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7e0393c64b29de6ef8d72dc182ec08e349b40ac"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTIyMjc5Ng==", "bodyText": "please add unit test", "url": "https://github.com/hortonworks/cloudbreak/pull/9674#discussion_r551222796", "createdAt": "2021-01-04T10:10:33Z", "author": {"login": "lacikaaa"}, "path": "ccm-connector/src/main/java/com/sequenceiq/cloudbreak/ccmimpl/ccmv2/CcmV2ManagementClient.java", "diffHunk": "@@ -0,0 +1,83 @@\n+package com.sequenceiq.cloudbreak.ccmimpl.ccmv2;\n+\n+import java.util.Optional;\n+\n+import javax.inject.Inject;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.retry.backoff.FixedBackOffPolicy;\n+import org.springframework.retry.policy.TimeoutRetryPolicy;\n+import org.springframework.retry.support.RetryTemplate;\n+import org.springframework.stereotype.Component;\n+\n+import com.cloudera.thunderhead.service.clusterconnectivitymanagementv2.ClusterConnectivityManagementV2Proto.UnregisterAgentResponse;\n+import com.cloudera.thunderhead.service.clusterconnectivitymanagementv2.ClusterConnectivityManagementV2Proto.InvertingProxy;\n+import com.cloudera.thunderhead.service.clusterconnectivitymanagementv2.ClusterConnectivityManagementV2Proto.InvertingProxyAgent;\n+import com.sequenceiq.cloudbreak.auth.ThreadBasedUserCrnProvider;\n+import com.sequenceiq.cloudbreak.ccmimpl.ccmv2.config.GrpcCcmV2Config;\n+\n+@Component\n+public class CcmV2ManagementClient {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7e0393c64b29de6ef8d72dc182ec08e349b40ac"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTIyNjkzMw==", "bodyText": "shall we log the requests here before calling the service?", "url": "https://github.com/hortonworks/cloudbreak/pull/9674#discussion_r551226933", "createdAt": "2021-01-04T10:18:19Z", "author": {"login": "lacikaaa"}, "path": "ccm-connector/src/main/java/com/sequenceiq/cloudbreak/ccmimpl/ccmv2/GrpcCcmV2Client.java", "diffHunk": "@@ -0,0 +1,97 @@\n+package com.sequenceiq.cloudbreak.ccmimpl.ccmv2;\n+\n+import static io.grpc.internal.GrpcUtil.DEFAULT_MAX_MESSAGE_SIZE;\n+\n+import javax.inject.Inject;\n+import org.springframework.stereotype.Component;\n+\n+import com.cloudera.thunderhead.service.clusterconnectivitymanagementv2.ClusterConnectivityManagementV2Grpc;\n+import com.cloudera.thunderhead.service.clusterconnectivitymanagementv2.ClusterConnectivityManagementV2Grpc.ClusterConnectivityManagementV2BlockingStub;\n+import com.cloudera.thunderhead.service.clusterconnectivitymanagementv2.ClusterConnectivityManagementV2Proto.UnregisterAgentResponse;\n+import com.cloudera.thunderhead.service.clusterconnectivitymanagementv2.ClusterConnectivityManagementV2Proto.CreateOrGetInvertingProxyRequest;\n+import com.cloudera.thunderhead.service.clusterconnectivitymanagementv2.ClusterConnectivityManagementV2Proto.CreateOrGetInvertingProxyResponse;\n+import com.cloudera.thunderhead.service.clusterconnectivitymanagementv2.ClusterConnectivityManagementV2Proto.InvertingProxy;\n+import com.cloudera.thunderhead.service.clusterconnectivitymanagementv2.ClusterConnectivityManagementV2Proto.InvertingProxyAgent;\n+import com.cloudera.thunderhead.service.clusterconnectivitymanagementv2.ClusterConnectivityManagementV2Proto.RegisterAgentRequest;\n+import com.cloudera.thunderhead.service.clusterconnectivitymanagementv2.ClusterConnectivityManagementV2Proto.RegisterAgentResponse;\n+import com.cloudera.thunderhead.service.clusterconnectivitymanagementv2.ClusterConnectivityManagementV2Proto.RemoveInvertingProxyResponse;\n+import com.cloudera.thunderhead.service.clusterconnectivitymanagementv2.ClusterConnectivityManagementV2Proto.RemoveInvertingProxyRequest;\n+import com.cloudera.thunderhead.service.clusterconnectivitymanagementv2.ClusterConnectivityManagementV2Proto.UnregisterAgentRequest;\n+import com.sequenceiq.cloudbreak.ccmimpl.ccmv2.config.GrpcCcmV2Config;\n+import com.sequenceiq.cloudbreak.grpc.ManagedChannelWrapper;\n+import com.sequenceiq.cloudbreak.grpc.altus.AltusMetadataInterceptor;\n+import com.sequenceiq.cloudbreak.grpc.util.GrpcUtil;\n+\n+import io.grpc.ManagedChannel;\n+import io.grpc.ManagedChannelBuilder;\n+import io.opentracing.Tracer;\n+\n+@Component\n+public class GrpcCcmV2Client {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7e0393c64b29de6ef8d72dc182ec08e349b40ac"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTIyNzk0OQ==", "bodyText": "the intent of @Configuration annotation is to define beans. You should use @Component here", "url": "https://github.com/hortonworks/cloudbreak/pull/9674#discussion_r551227949", "createdAt": "2021-01-04T10:20:16Z", "author": {"login": "lacikaaa"}, "path": "ccm-connector/src/main/java/com/sequenceiq/cloudbreak/ccmimpl/ccmv2/config/GrpcCcmV2Config.java", "diffHunk": "@@ -0,0 +1,36 @@\n+package com.sequenceiq.cloudbreak.ccmimpl.ccmv2.config;\n+\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Configuration;\n+\n+@Configuration", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7e0393c64b29de6ef8d72dc182ec08e349b40ac"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTIzNDI4Mw==", "bodyText": "could you move these validations to a separate method? thanks", "url": "https://github.com/hortonworks/cloudbreak/pull/9674#discussion_r551234283", "createdAt": "2021-01-04T10:32:02Z", "author": {"login": "lacikaaa"}, "path": "ccm-connector/src/main/java/com/sequenceiq/cloudbreak/ccmimpl/cloudinit/DefaultCcmV2ParameterSupplier.java", "diffHunk": "@@ -0,0 +1,53 @@\n+package com.sequenceiq.cloudbreak.ccmimpl.cloudinit;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+\n+import java.util.Optional;\n+import java.util.UUID;\n+\n+import javax.annotation.Nonnull;\n+import javax.inject.Inject;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import com.cloudera.thunderhead.service.clusterconnectivitymanagementv2.ClusterConnectivityManagementV2Proto.InvertingProxy;\n+import com.cloudera.thunderhead.service.clusterconnectivitymanagementv2.ClusterConnectivityManagementV2Proto.InvertingProxyAgent;\n+import com.sequenceiq.cloudbreak.ccm.cloudinit.CcmV2ParameterSupplier;\n+import com.sequenceiq.cloudbreak.ccm.cloudinit.CcmV2Parameters;\n+import com.sequenceiq.cloudbreak.ccm.cloudinit.DefaultCcmV2Parameters;\n+import com.sequenceiq.cloudbreak.ccmimpl.ccmv2.CcmV2ManagementClient;\n+import com.sequenceiq.cloudbreak.logger.LoggerContextKey;\n+import com.sequenceiq.cloudbreak.logger.MDCBuilder;\n+\n+@Component\n+public class DefaultCcmV2ParameterSupplier implements CcmV2ParameterSupplier {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(DefaultCcmV2ParameterSupplier.class);\n+\n+    @Inject\n+    private CcmV2ManagementClient ccmV2Client;\n+\n+    public CcmV2Parameters getCcmV2Parameters(@Nonnull String accountId, @Nonnull String clusterGatewayDomain, @Nonnull String agentKeyId) {\n+        String requestId = Optional.ofNullable(MDCBuilder.getMdcContextMap().get(LoggerContextKey.REQUEST_ID.toString())).orElse(UUID.randomUUID().toString());\n+        MDCBuilder.addRequestId(requestId);\n+\n+        InvertingProxy invertingProxy = ccmV2Client.awaitReadyInvertingProxyForAccount(requestId, accountId);\n+        InvertingProxyAgent invertingProxyAgent = ccmV2Client.registerInvertingProxyAgent(requestId, accountId, clusterGatewayDomain, agentKeyId);\n+\n+        checkArgument(StringUtils.isNotEmpty(invertingProxy.getHostname()), \"InvertingProxy Hostname is not initialized.\");\n+        checkArgument(StringUtils.isNotEmpty(invertingProxy.getCertificate()), \"InvertingProxy Certificate is not initialized.\");\n+        checkArgument(StringUtils.isNotEmpty(invertingProxyAgent.getAgentCrn()), \"InvertingProxyAgent Crn is not initialized.\");\n+        checkArgument(StringUtils.isNotEmpty(invertingProxyAgent.getEncipheredPrivateKey()), \"InvertingProxyAgent Enciphered Key is not initialized.\");\n+        checkArgument(StringUtils.isNotEmpty(invertingProxyAgent.getCertificate()), \"InvertingProxyAgent Certificate is not initialized.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7e0393c64b29de6ef8d72dc182ec08e349b40ac"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTIzNTM4OA==", "bodyText": "this seems to be a duplication of the code already in DefaultCcmV2ParameterSupplier. I think this could be moved to MDCBuilder", "url": "https://github.com/hortonworks/cloudbreak/pull/9674#discussion_r551235388", "createdAt": "2021-01-04T10:34:13Z", "author": {"login": "lacikaaa"}, "path": "ccm-connector/src/main/java/com/sequenceiq/cloudbreak/ccmimpl/termination/DefaultCcmV2AgentTerminationListener.java", "diffHunk": "@@ -0,0 +1,36 @@\n+package com.sequenceiq.cloudbreak.ccmimpl.termination;\n+\n+import java.util.Optional;\n+import java.util.UUID;\n+\n+import javax.inject.Inject;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.ccm.termination.CcmV2AgentTerminationListener;\n+import com.sequenceiq.cloudbreak.ccmimpl.ccmv2.CcmV2ManagementClient;\n+import com.sequenceiq.cloudbreak.logger.LoggerContextKey;\n+import com.sequenceiq.cloudbreak.logger.MDCBuilder;\n+\n+@Component\n+public class DefaultCcmV2AgentTerminationListener implements CcmV2AgentTerminationListener {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(DefaultCcmV2AgentTerminationListener.class);\n+\n+    @Inject\n+    private CcmV2ManagementClient ccmV2Client;\n+\n+    @Override\n+    public void deregisterInvertingProxyAgent(String ccmV2AgentCrn) {\n+        if (ccmV2AgentCrn != null) {\n+            String requestId = Optional.ofNullable(MDCBuilder.getMdcContextMap()\n+                    .get(LoggerContextKey.REQUEST_ID.toString())).orElse(UUID.randomUUID().toString());\n+            MDCBuilder.addRequestId(requestId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7e0393c64b29de6ef8d72dc182ec08e349b40ac"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI0MzEwNg==", "bodyText": "domain is a bit misleading here, as it's actually the gateway node's FQDN", "url": "https://github.com/hortonworks/cloudbreak/pull/9674#discussion_r551243106", "createdAt": "2021-01-04T10:48:22Z", "author": {"login": "lacikaaa"}, "path": "cloud-common/src/main/java/com/sequenceiq/cloudbreak/common/service/HostDiscoveryService.java", "diffHunk": "@@ -48,6 +50,10 @@ public String generateHostname(String customHostnamePrefix, String instanceGroup\n         return getHostname(customHostnamePrefix, instanceGroupName).replaceAll(\"_\", \"\") + privateId;\n     }\n \n+    public String determineDefaultDomainForStack(String gatewayHostName, String stackDomain) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7e0393c64b29de6ef8d72dc182ec08e349b40ac"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI0NDc0Mg==", "bodyText": "is there any particular reason the json field name is different from the java field name?", "url": "https://github.com/hortonworks/cloudbreak/pull/9674#discussion_r551244742", "createdAt": "2021-01-04T10:51:39Z", "author": {"login": "lacikaaa"}, "path": "cluster-proxy/src/main/java/com/sequenceiq/cloudbreak/clusterproxy/CcmV2Config.java", "diffHunk": "@@ -0,0 +1,57 @@\n+package com.sequenceiq.cloudbreak.clusterproxy;\n+\n+import java.util.Objects;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+public class CcmV2Config {\n+\n+    @JsonProperty(\"agentCrn\")\n+    private String agentCrn;\n+\n+    @JsonProperty(\"backendId\")\n+    private String backendId;\n+\n+    @JsonProperty(\"host\")\n+    private String gatewayHost;\n+\n+    @JsonProperty(\"port\")\n+    private int gatewayPort;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7e0393c64b29de6ef8d72dc182ec08e349b40ac"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI0Nzc2Ng==", "bodyText": "instead of instanceof it should be handled by catching this type of exception and add the logic there", "url": "https://github.com/hortonworks/cloudbreak/pull/9674#discussion_r551247766", "createdAt": "2021-01-04T10:57:25Z", "author": {"login": "lacikaaa"}, "path": "cluster-proxy/src/main/java/com/sequenceiq/cloudbreak/clusterproxy/ClusterProxyRegistrationClient.java", "diffHunk": "@@ -115,4 +116,11 @@ public ReadConfigResponse readConfig(String clusterIdentifier) {\n         headers.setContentType(MediaType.APPLICATION_JSON);\n         return new HttpEntity<>(JsonUtil.writeValueAsString(proxyConfigRequest), headers);\n     }\n+\n+    private void logErrorWithResponseBody(String message, Exception ex) {\n+        if (ex instanceof RestClientResponseException) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7e0393c64b29de6ef8d72dc182ec08e349b40ac"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI0ODM1NQ==", "bodyText": "modifying a method parameter is usually a bad practice and should be avoided if possible", "url": "https://github.com/hortonworks/cloudbreak/pull/9674#discussion_r551248355", "createdAt": "2021-01-04T10:58:41Z", "author": {"login": "lacikaaa"}, "path": "cluster-proxy/src/main/java/com/sequenceiq/cloudbreak/clusterproxy/ClusterProxyRegistrationClient.java", "diffHunk": "@@ -115,4 +116,11 @@ public ReadConfigResponse readConfig(String clusterIdentifier) {\n         headers.setContentType(MediaType.APPLICATION_JSON);\n         return new HttpEntity<>(JsonUtil.writeValueAsString(proxyConfigRequest), headers);\n     }\n+\n+    private void logErrorWithResponseBody(String message, Exception ex) {\n+        if (ex instanceof RestClientResponseException) {\n+            message += \" ,Error Response Body : \" + ((RestClientResponseException) ex).getResponseBodyAsString();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7e0393c64b29de6ef8d72dc182ec08e349b40ac"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI1NDY4NQ==", "bodyText": "I think this should be replaced with the default constructor, without parameter and that should set connectivity mode to NONE. So it would be obvious you can't define CCMv2 mode without passing the related parameters.", "url": "https://github.com/hortonworks/cloudbreak/pull/9674#discussion_r551254685", "createdAt": "2021-01-04T11:12:39Z", "author": {"login": "lacikaaa"}, "path": "common/src/main/java/com/sequenceiq/cloudbreak/ccm/cloudinit/CcmConnectivityParameters.java", "diffHunk": "@@ -0,0 +1,48 @@\n+package com.sequenceiq.cloudbreak.ccm.cloudinit;\n+\n+public class CcmConnectivityParameters {\n+\n+    private CcmParameters ccmParameters;\n+\n+    private CcmV2Parameters ccmV2Parameters;\n+\n+    private CcmConnectivityMode connectivityMode;\n+\n+    public CcmConnectivityParameters(CcmParameters ccmParameters) {\n+        this.ccmParameters = ccmParameters;\n+        this.connectivityMode = CcmConnectivityMode.CCMV1;\n+    }\n+\n+    public CcmConnectivityParameters(CcmV2Parameters ccmV2Parameters) {\n+        this.ccmV2Parameters = ccmV2Parameters;\n+        this.connectivityMode = CcmConnectivityMode.CCMV2;\n+    }\n+\n+    public CcmConnectivityParameters(CcmConnectivityMode connectivityMode) {\n+        this.connectivityMode = connectivityMode;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7e0393c64b29de6ef8d72dc182ec08e349b40ac"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI2MDE2OA==", "bodyText": "I think the tunnel should have a new value, CCMv2 and only if that is chosen should we go with CCMv2. This would ensure that old envs with CCMv1 would still start datahubs with it, even if the account has v2 enabled. It would be a bad idea to mix CCM versions in environments on the first run", "url": "https://github.com/hortonworks/cloudbreak/pull/9674#discussion_r551260168", "createdAt": "2021-01-04T11:24:35Z", "author": {"login": "lacikaaa"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/core/flow2/cluster/provision/clusterproxy/ClusterProxyService.java", "diffHunk": "@@ -99,7 +106,9 @@ public boolean isCreateConfigForClusterProxy(Stack stack) {\n     }\n \n     private void registerGateway(Stack stack) {\n-        ConfigUpdateRequest request = new ConfigUpdateRequest(stack.getResourceCrn(), knoxUrl(stack));\n+        String knoxUrl = stack.getTunnel().useCcm() && entitlementService.ccmV2Enabled(getAccountId(stack)) ?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7e0393c64b29de6ef8d72dc182ec08e349b40ac"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI2MTkxMg==", "bodyText": "CcmKeyDeregisterRequest should have Tunnel field instead of the boolean as it's already deprecated. The logic should depend on this value here", "url": "https://github.com/hortonworks/cloudbreak/pull/9674#discussion_r551261912", "createdAt": "2021-01-04T11:28:20Z", "author": {"login": "lacikaaa"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/reactor/handler/recipe/CcmKeyDeregisterHandler.java", "diffHunk": "@@ -34,24 +36,32 @@\n     @Inject\n     private CcmResourceTerminationListener ccmResourceTerminationListener;\n \n+    @Inject\n+    private CcmV2AgentTerminationListener ccmV2AgentTerminationListener;\n+\n+    @Inject\n+    private EntitlementService entitlementService;\n+\n     @Override\n     public void accept(Event<CcmKeyDeregisterRequest> requestEvent) {\n         CcmKeyDeregisterRequest request = requestEvent.getData();\n         Selectable result;\n         try {\n             Stack stack = stackService.getByIdWithListsInTransaction(request.getResourceId());\n             if (Boolean.TRUE.equals(request.getUseCcm())) {\n-                LOGGER.debug(\"De-registering key from CCM. Cluster CRN: {}\",\n-                        stack.getResourceCrn());\n+                LOGGER.debug(\"De-registering key from CCM. Cluster CRN: {}\", stack.getResourceCrn());\n                 try {\n-                    ccmResourceTerminationListener.deregisterCcmSshTunnelingKey(request.getActorCrn(), request.getAccountId(), request.getKeyId(),\n-                            stack.getMinaSshdServiceId());\n+                    if (!entitlementService.ccmV2Enabled(request.getAccountId())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7e0393c64b29de6ef8d72dc182ec08e349b40ac"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI2MzUyNg==", "bodyText": "this would change the current behavior, as we set CcmParameterConstants.CCM_ENABLED_KEY to false if CCM is not enabled, but with this change we won't set it anymore. Are you sure it won't break anything?", "url": "https://github.com/hortonworks/cloudbreak/pull/9674#discussion_r551263526", "createdAt": "2021-01-04T11:32:04Z", "author": {"login": "lacikaaa"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/service/image/userdata/UserDataBuilder.java", "diffHunk": "@@ -61,11 +64,19 @@ private String build(InstanceGroupType type, Platform cloudPlatform, byte[] cbSs\n         model.put(\"customUserData\", userDataBuilderParams.getCustomData());\n         model.put(\"saltBootPassword\", saltBootPassword);\n         model.put(\"cbCert\", cbCert);\n-        CcmParameters.addToTemplateModel(type, ccmParameters, model);\n+        extendModelWithCcmConnectivity(type, ccmConnectivityParameters, model);\n         extendModelWithProxyParams(type, proxyConfig, model);\n         return build(model);\n     }\n \n+    private void extendModelWithCcmConnectivity(InstanceGroupType type, CcmConnectivityParameters ccmConnectivityParameters, Map<String, Object> model) {\n+        if (CcmConnectivityMode.CCMV1.equals(ccmConnectivityParameters.getConnectivityMode())) {\n+            CcmParameters.addToTemplateModel(type, ccmConnectivityParameters.getCcmParameters(), model);\n+        } else if (CcmConnectivityMode.CCMV2.equals(ccmConnectivityParameters.getConnectivityMode())) {\n+            CcmV2Parameters.addToTemplateModel(type, ccmConnectivityParameters.getCcmV2Parameters(), model);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7e0393c64b29de6ef8d72dc182ec08e349b40ac"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI2NzA5NA==", "bodyText": "these should ensure that the parameters are not null so we can be sure later if we have eg CCMV1 set, then ccmParameters can't be null. The other way around, if we don't store CcmConnectivityMode, but the getter would calculate it from the fields. If none set then it's NONE, etc.", "url": "https://github.com/hortonworks/cloudbreak/pull/9674#discussion_r551267094", "createdAt": "2021-01-04T11:39:56Z", "author": {"login": "lacikaaa"}, "path": "common/src/main/java/com/sequenceiq/cloudbreak/ccm/cloudinit/CcmConnectivityParameters.java", "diffHunk": "@@ -0,0 +1,48 @@\n+package com.sequenceiq.cloudbreak.ccm.cloudinit;\n+\n+public class CcmConnectivityParameters {\n+\n+    private CcmParameters ccmParameters;\n+\n+    private CcmV2Parameters ccmV2Parameters;\n+\n+    private CcmConnectivityMode connectivityMode;\n+\n+    public CcmConnectivityParameters(CcmParameters ccmParameters) {\n+        this.ccmParameters = ccmParameters;\n+        this.connectivityMode = CcmConnectivityMode.CCMV1;\n+    }\n+\n+    public CcmConnectivityParameters(CcmV2Parameters ccmV2Parameters) {\n+        this.ccmV2Parameters = ccmV2Parameters;\n+        this.connectivityMode = CcmConnectivityMode.CCMV2;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7e0393c64b29de6ef8d72dc182ec08e349b40ac"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI2ODM5MQ==", "bodyText": "this method should be moved to a separate class and refactored into smaller ones, as it's pretty big, and already needs the @VisibleForTesting annotation", "url": "https://github.com/hortonworks/cloudbreak/pull/9674#discussion_r551268391", "createdAt": "2021-01-04T11:43:13Z", "author": {"login": "lacikaaa"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/service/image/userdata/UserDataService.java", "diffHunk": "@@ -88,45 +105,71 @@ public void createUserData(Long stackId) throws CloudbreakImageNotFoundException\n         String saltBootPassword = saltSecurityConfig.getSaltBootPassword();\n         try {\n             PlatformParameters platformParameters = platformParametersFuture.get();\n-            CcmParameters ccmParameters = fetchCcmParameters(stack);\n+            CcmConnectivityParameters ccmParameters = fetchCcmParameters(stack);\n             Optional<ProxyConfig> proxyConfig = proxyConfigDtoService.getByEnvironmentCrn(stack.getEnvironmentCrn());\n             Map<InstanceGroupType, String> userData = userDataBuilder.buildUserData(Platform.platform(stack.getCloudPlatform()), cbSshKeyDer,\n                     sshUser, platformParameters, saltBootPassword, cbCert, ccmParameters, proxyConfig.orElse(null));\n             imageService.decorateImageWithUserDataForStack(stack, userData);\n-            if (ccmParameters != null) {\n-                String minaSshdServiceId = ccmParameters.getServerParameters().getMinaSshdServiceId();\n-                if (StringUtils.isNotBlank(minaSshdServiceId)) {\n-                    LOGGER.debug(\"Add Minasshdserviceid [{}] to stack [{}]\", minaSshdServiceId, stack.getResourceCrn());\n-                    stackService.setMinaSshdServiceIdByStackId(stackId, minaSshdServiceId);\n-                }\n-            }\n+            saveStackCCMParameters(stack, ccmParameters);\n         } catch (InterruptedException | ExecutionException e) {\n             LOGGER.error(\"Failed to get Platform parmaters\", e);\n             throw new GetCloudParameterException(\"Failed to get Platform parmaters\", e);\n         }\n     }\n \n-    private CcmParameters fetchCcmParameters(Stack stack) {\n-        CcmParameters ccmParameters = null;\n-        if ((ccmParameterSupplier != null) && stack.getTunnel().useCcm()) {\n-            ImmutableMap.Builder<KnownServiceIdentifier, Integer> builder = ImmutableMap.builder();\n-            int gatewayPort = Optional.ofNullable(stack.getGatewayPort()).orElse(ServiceFamilies.GATEWAY.getDefaultPort());\n-            builder.put(KnownServiceIdentifier.GATEWAY, gatewayPort);\n-\n-            // Optionally configure a tunnel for (nginx fronting) Knox\n-            if (stack.getCluster().getGateway() != null) {\n-                // JSA TODO Do we support a non-default port for the nginx that fronts Knox?\n-                builder.put(KnownServiceIdentifier.KNOX, ServiceFamilies.KNOX.getDefaultPort());\n-            }\n-\n-            Map<KnownServiceIdentifier, Integer> tunneledServicePorts = builder.build();\n-\n+    @VisibleForTesting\n+    CcmConnectivityParameters fetchCcmParameters(Stack stack) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7e0393c64b29de6ef8d72dc182ec08e349b40ac"}, "originalPosition": 103}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI2ODcwOA==", "bodyText": "logic should be handled here by tunnel type and not by entitlement", "url": "https://github.com/hortonworks/cloudbreak/pull/9674#discussion_r551268708", "createdAt": "2021-01-04T11:43:56Z", "author": {"login": "lacikaaa"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/service/image/userdata/UserDataService.java", "diffHunk": "@@ -88,45 +105,71 @@ public void createUserData(Long stackId) throws CloudbreakImageNotFoundException\n         String saltBootPassword = saltSecurityConfig.getSaltBootPassword();\n         try {\n             PlatformParameters platformParameters = platformParametersFuture.get();\n-            CcmParameters ccmParameters = fetchCcmParameters(stack);\n+            CcmConnectivityParameters ccmParameters = fetchCcmParameters(stack);\n             Optional<ProxyConfig> proxyConfig = proxyConfigDtoService.getByEnvironmentCrn(stack.getEnvironmentCrn());\n             Map<InstanceGroupType, String> userData = userDataBuilder.buildUserData(Platform.platform(stack.getCloudPlatform()), cbSshKeyDer,\n                     sshUser, platformParameters, saltBootPassword, cbCert, ccmParameters, proxyConfig.orElse(null));\n             imageService.decorateImageWithUserDataForStack(stack, userData);\n-            if (ccmParameters != null) {\n-                String minaSshdServiceId = ccmParameters.getServerParameters().getMinaSshdServiceId();\n-                if (StringUtils.isNotBlank(minaSshdServiceId)) {\n-                    LOGGER.debug(\"Add Minasshdserviceid [{}] to stack [{}]\", minaSshdServiceId, stack.getResourceCrn());\n-                    stackService.setMinaSshdServiceIdByStackId(stackId, minaSshdServiceId);\n-                }\n-            }\n+            saveStackCCMParameters(stack, ccmParameters);\n         } catch (InterruptedException | ExecutionException e) {\n             LOGGER.error(\"Failed to get Platform parmaters\", e);\n             throw new GetCloudParameterException(\"Failed to get Platform parmaters\", e);\n         }\n     }\n \n-    private CcmParameters fetchCcmParameters(Stack stack) {\n-        CcmParameters ccmParameters = null;\n-        if ((ccmParameterSupplier != null) && stack.getTunnel().useCcm()) {\n-            ImmutableMap.Builder<KnownServiceIdentifier, Integer> builder = ImmutableMap.builder();\n-            int gatewayPort = Optional.ofNullable(stack.getGatewayPort()).orElse(ServiceFamilies.GATEWAY.getDefaultPort());\n-            builder.put(KnownServiceIdentifier.GATEWAY, gatewayPort);\n-\n-            // Optionally configure a tunnel for (nginx fronting) Knox\n-            if (stack.getCluster().getGateway() != null) {\n-                // JSA TODO Do we support a non-default port for the nginx that fronts Knox?\n-                builder.put(KnownServiceIdentifier.KNOX, ServiceFamilies.KNOX.getDefaultPort());\n-            }\n-\n-            Map<KnownServiceIdentifier, Integer> tunneledServicePorts = builder.build();\n-\n+    @VisibleForTesting\n+    CcmConnectivityParameters fetchCcmParameters(Stack stack) {\n+        CcmConnectivityParameters ccmConnectivityParameters = new CcmConnectivityParameters(CcmConnectivityMode.NONE);\n+        if (stack.getTunnel().useCcm()) {\n             String accountId = ThreadBasedUserCrnProvider.getAccountId();\n             String userCrn = ThreadBasedUserCrnProvider.getUserCrn();\n             String keyId = CcmResourceUtil.getKeyId(stack.getResourceCrn());\n             String actorCrn = Objects.requireNonNull(userCrn, \"userCrn is null\");\n-            ccmParameters = ccmParameterSupplier.getCcmParameters(actorCrn, accountId, keyId, tunneledServicePorts).orElse(null);\n+\n+            if (!entitlementService.ccmV2Enabled(accountId)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7e0393c64b29de6ef8d72dc182ec08e349b40ac"}, "originalPosition": 112}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI2OTE5Nw==", "bodyText": "stack id should be enough here as that's the only part you use. Crn is already should be added to MdcContext, logging it again is not necessary.", "url": "https://github.com/hortonworks/cloudbreak/pull/9674#discussion_r551269197", "createdAt": "2021-01-04T11:45:04Z", "author": {"login": "lacikaaa"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/service/image/userdata/UserDataService.java", "diffHunk": "@@ -88,45 +105,71 @@ public void createUserData(Long stackId) throws CloudbreakImageNotFoundException\n         String saltBootPassword = saltSecurityConfig.getSaltBootPassword();\n         try {\n             PlatformParameters platformParameters = platformParametersFuture.get();\n-            CcmParameters ccmParameters = fetchCcmParameters(stack);\n+            CcmConnectivityParameters ccmParameters = fetchCcmParameters(stack);\n             Optional<ProxyConfig> proxyConfig = proxyConfigDtoService.getByEnvironmentCrn(stack.getEnvironmentCrn());\n             Map<InstanceGroupType, String> userData = userDataBuilder.buildUserData(Platform.platform(stack.getCloudPlatform()), cbSshKeyDer,\n                     sshUser, platformParameters, saltBootPassword, cbCert, ccmParameters, proxyConfig.orElse(null));\n             imageService.decorateImageWithUserDataForStack(stack, userData);\n-            if (ccmParameters != null) {\n-                String minaSshdServiceId = ccmParameters.getServerParameters().getMinaSshdServiceId();\n-                if (StringUtils.isNotBlank(minaSshdServiceId)) {\n-                    LOGGER.debug(\"Add Minasshdserviceid [{}] to stack [{}]\", minaSshdServiceId, stack.getResourceCrn());\n-                    stackService.setMinaSshdServiceIdByStackId(stackId, minaSshdServiceId);\n-                }\n-            }\n+            saveStackCCMParameters(stack, ccmParameters);\n         } catch (InterruptedException | ExecutionException e) {\n             LOGGER.error(\"Failed to get Platform parmaters\", e);\n             throw new GetCloudParameterException(\"Failed to get Platform parmaters\", e);\n         }\n     }\n \n-    private CcmParameters fetchCcmParameters(Stack stack) {\n-        CcmParameters ccmParameters = null;\n-        if ((ccmParameterSupplier != null) && stack.getTunnel().useCcm()) {\n-            ImmutableMap.Builder<KnownServiceIdentifier, Integer> builder = ImmutableMap.builder();\n-            int gatewayPort = Optional.ofNullable(stack.getGatewayPort()).orElse(ServiceFamilies.GATEWAY.getDefaultPort());\n-            builder.put(KnownServiceIdentifier.GATEWAY, gatewayPort);\n-\n-            // Optionally configure a tunnel for (nginx fronting) Knox\n-            if (stack.getCluster().getGateway() != null) {\n-                // JSA TODO Do we support a non-default port for the nginx that fronts Knox?\n-                builder.put(KnownServiceIdentifier.KNOX, ServiceFamilies.KNOX.getDefaultPort());\n-            }\n-\n-            Map<KnownServiceIdentifier, Integer> tunneledServicePorts = builder.build();\n-\n+    @VisibleForTesting\n+    CcmConnectivityParameters fetchCcmParameters(Stack stack) {\n+        CcmConnectivityParameters ccmConnectivityParameters = new CcmConnectivityParameters(CcmConnectivityMode.NONE);\n+        if (stack.getTunnel().useCcm()) {\n             String accountId = ThreadBasedUserCrnProvider.getAccountId();\n             String userCrn = ThreadBasedUserCrnProvider.getUserCrn();\n             String keyId = CcmResourceUtil.getKeyId(stack.getResourceCrn());\n             String actorCrn = Objects.requireNonNull(userCrn, \"userCrn is null\");\n-            ccmParameters = ccmParameterSupplier.getCcmParameters(actorCrn, accountId, keyId, tunneledServicePorts).orElse(null);\n+\n+            if (!entitlementService.ccmV2Enabled(accountId)) {\n+                ImmutableMap.Builder<KnownServiceIdentifier, Integer> builder = ImmutableMap.builder();\n+                int gatewayPort = Optional.ofNullable(stack.getGatewayPort()).orElse(ServiceFamilies.GATEWAY.getDefaultPort());\n+                builder.put(KnownServiceIdentifier.GATEWAY, gatewayPort);\n+\n+                // Optionally configure a tunnel for (nginx fronting) Knox\n+                if (stack.getCluster().getGateway() != null) {\n+                    // JSA TODO Do we support a non-default port for the nginx that fronts Knox?\n+                    builder.put(KnownServiceIdentifier.KNOX, ServiceFamilies.KNOX.getDefaultPort());\n+                }\n+\n+                Map<KnownServiceIdentifier, Integer> tunneledServicePorts = builder.build();\n+                CcmParameters ccmV1Parameters = ccmParameterSupplier.getCcmParameters(actorCrn, accountId, keyId, tunneledServicePorts).orElse(null);\n+                ccmConnectivityParameters = new CcmConnectivityParameters(ccmV1Parameters);\n+            } else {\n+                String gatewayHostName = hostDiscoveryService.generateHostname(stack.getCustomHostname(),\n+                        stack.getGatewayHostGroup().map(InstanceGroup::getGroupName).orElse(\"\"), 0L,\n+                        stack.isClusterNameAsSubdomain());\n+                String stackDomain = hostDiscoveryService.determineDomain(stack.getCustomDomain(), stack.getName(), stack.isClusterNameAsSubdomain());\n+                String generatedClusterDomain = hostDiscoveryService.determineDefaultDomainForStack(gatewayHostName, stackDomain);\n+\n+                CcmV2Parameters ccmV2Parameters = ccmV2ParameterSupplier.getCcmV2Parameters(accountId, generatedClusterDomain, keyId);\n+                ccmConnectivityParameters = new CcmConnectivityParameters(ccmV2Parameters);\n+            }\n+        }\n+        return ccmConnectivityParameters;\n+    }\n+\n+    @VisibleForTesting\n+    void saveStackCCMParameters(Stack stack, CcmConnectivityParameters ccmConnectivityParameters) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7e0393c64b29de6ef8d72dc182ec08e349b40ac"}, "originalPosition": 141}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI2OTY5OA==", "bodyText": "if you modify the CcmConnectivityParameters implementation (and ensure it via unit tests) you could skip null check here", "url": "https://github.com/hortonworks/cloudbreak/pull/9674#discussion_r551269698", "createdAt": "2021-01-04T11:46:10Z", "author": {"login": "lacikaaa"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/service/image/userdata/UserDataService.java", "diffHunk": "@@ -88,45 +105,71 @@ public void createUserData(Long stackId) throws CloudbreakImageNotFoundException\n         String saltBootPassword = saltSecurityConfig.getSaltBootPassword();\n         try {\n             PlatformParameters platformParameters = platformParametersFuture.get();\n-            CcmParameters ccmParameters = fetchCcmParameters(stack);\n+            CcmConnectivityParameters ccmParameters = fetchCcmParameters(stack);\n             Optional<ProxyConfig> proxyConfig = proxyConfigDtoService.getByEnvironmentCrn(stack.getEnvironmentCrn());\n             Map<InstanceGroupType, String> userData = userDataBuilder.buildUserData(Platform.platform(stack.getCloudPlatform()), cbSshKeyDer,\n                     sshUser, platformParameters, saltBootPassword, cbCert, ccmParameters, proxyConfig.orElse(null));\n             imageService.decorateImageWithUserDataForStack(stack, userData);\n-            if (ccmParameters != null) {\n-                String minaSshdServiceId = ccmParameters.getServerParameters().getMinaSshdServiceId();\n-                if (StringUtils.isNotBlank(minaSshdServiceId)) {\n-                    LOGGER.debug(\"Add Minasshdserviceid [{}] to stack [{}]\", minaSshdServiceId, stack.getResourceCrn());\n-                    stackService.setMinaSshdServiceIdByStackId(stackId, minaSshdServiceId);\n-                }\n-            }\n+            saveStackCCMParameters(stack, ccmParameters);\n         } catch (InterruptedException | ExecutionException e) {\n             LOGGER.error(\"Failed to get Platform parmaters\", e);\n             throw new GetCloudParameterException(\"Failed to get Platform parmaters\", e);\n         }\n     }\n \n-    private CcmParameters fetchCcmParameters(Stack stack) {\n-        CcmParameters ccmParameters = null;\n-        if ((ccmParameterSupplier != null) && stack.getTunnel().useCcm()) {\n-            ImmutableMap.Builder<KnownServiceIdentifier, Integer> builder = ImmutableMap.builder();\n-            int gatewayPort = Optional.ofNullable(stack.getGatewayPort()).orElse(ServiceFamilies.GATEWAY.getDefaultPort());\n-            builder.put(KnownServiceIdentifier.GATEWAY, gatewayPort);\n-\n-            // Optionally configure a tunnel for (nginx fronting) Knox\n-            if (stack.getCluster().getGateway() != null) {\n-                // JSA TODO Do we support a non-default port for the nginx that fronts Knox?\n-                builder.put(KnownServiceIdentifier.KNOX, ServiceFamilies.KNOX.getDefaultPort());\n-            }\n-\n-            Map<KnownServiceIdentifier, Integer> tunneledServicePorts = builder.build();\n-\n+    @VisibleForTesting\n+    CcmConnectivityParameters fetchCcmParameters(Stack stack) {\n+        CcmConnectivityParameters ccmConnectivityParameters = new CcmConnectivityParameters(CcmConnectivityMode.NONE);\n+        if (stack.getTunnel().useCcm()) {\n             String accountId = ThreadBasedUserCrnProvider.getAccountId();\n             String userCrn = ThreadBasedUserCrnProvider.getUserCrn();\n             String keyId = CcmResourceUtil.getKeyId(stack.getResourceCrn());\n             String actorCrn = Objects.requireNonNull(userCrn, \"userCrn is null\");\n-            ccmParameters = ccmParameterSupplier.getCcmParameters(actorCrn, accountId, keyId, tunneledServicePorts).orElse(null);\n+\n+            if (!entitlementService.ccmV2Enabled(accountId)) {\n+                ImmutableMap.Builder<KnownServiceIdentifier, Integer> builder = ImmutableMap.builder();\n+                int gatewayPort = Optional.ofNullable(stack.getGatewayPort()).orElse(ServiceFamilies.GATEWAY.getDefaultPort());\n+                builder.put(KnownServiceIdentifier.GATEWAY, gatewayPort);\n+\n+                // Optionally configure a tunnel for (nginx fronting) Knox\n+                if (stack.getCluster().getGateway() != null) {\n+                    // JSA TODO Do we support a non-default port for the nginx that fronts Knox?\n+                    builder.put(KnownServiceIdentifier.KNOX, ServiceFamilies.KNOX.getDefaultPort());\n+                }\n+\n+                Map<KnownServiceIdentifier, Integer> tunneledServicePorts = builder.build();\n+                CcmParameters ccmV1Parameters = ccmParameterSupplier.getCcmParameters(actorCrn, accountId, keyId, tunneledServicePorts).orElse(null);\n+                ccmConnectivityParameters = new CcmConnectivityParameters(ccmV1Parameters);\n+            } else {\n+                String gatewayHostName = hostDiscoveryService.generateHostname(stack.getCustomHostname(),\n+                        stack.getGatewayHostGroup().map(InstanceGroup::getGroupName).orElse(\"\"), 0L,\n+                        stack.isClusterNameAsSubdomain());\n+                String stackDomain = hostDiscoveryService.determineDomain(stack.getCustomDomain(), stack.getName(), stack.isClusterNameAsSubdomain());\n+                String generatedClusterDomain = hostDiscoveryService.determineDefaultDomainForStack(gatewayHostName, stackDomain);\n+\n+                CcmV2Parameters ccmV2Parameters = ccmV2ParameterSupplier.getCcmV2Parameters(accountId, generatedClusterDomain, keyId);\n+                ccmConnectivityParameters = new CcmConnectivityParameters(ccmV2Parameters);\n+            }\n+        }\n+        return ccmConnectivityParameters;\n+    }\n+\n+    @VisibleForTesting\n+    void saveStackCCMParameters(Stack stack, CcmConnectivityParameters ccmConnectivityParameters) {\n+        long stackId = stack.getId();\n+        if (CcmConnectivityMode.CCMV1.equals(ccmConnectivityParameters.getConnectivityMode())\n+                && ccmConnectivityParameters.getCcmParameters() != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7e0393c64b29de6ef8d72dc182ec08e349b40ac"}, "originalPosition": 144}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI3MTMxNw==", "bodyText": "if you move the save next to the fetch, they might be moved out together and handled together. Also you might save some if condition regarding checking if it's CCMv1 or v2", "url": "https://github.com/hortonworks/cloudbreak/pull/9674#discussion_r551271317", "createdAt": "2021-01-04T11:49:53Z", "author": {"login": "lacikaaa"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/service/image/userdata/UserDataService.java", "diffHunk": "@@ -88,45 +105,71 @@ public void createUserData(Long stackId) throws CloudbreakImageNotFoundException\n         String saltBootPassword = saltSecurityConfig.getSaltBootPassword();\n         try {\n             PlatformParameters platformParameters = platformParametersFuture.get();\n-            CcmParameters ccmParameters = fetchCcmParameters(stack);\n+            CcmConnectivityParameters ccmParameters = fetchCcmParameters(stack);\n             Optional<ProxyConfig> proxyConfig = proxyConfigDtoService.getByEnvironmentCrn(stack.getEnvironmentCrn());\n             Map<InstanceGroupType, String> userData = userDataBuilder.buildUserData(Platform.platform(stack.getCloudPlatform()), cbSshKeyDer,\n                     sshUser, platformParameters, saltBootPassword, cbCert, ccmParameters, proxyConfig.orElse(null));\n             imageService.decorateImageWithUserDataForStack(stack, userData);\n-            if (ccmParameters != null) {\n-                String minaSshdServiceId = ccmParameters.getServerParameters().getMinaSshdServiceId();\n-                if (StringUtils.isNotBlank(minaSshdServiceId)) {\n-                    LOGGER.debug(\"Add Minasshdserviceid [{}] to stack [{}]\", minaSshdServiceId, stack.getResourceCrn());\n-                    stackService.setMinaSshdServiceIdByStackId(stackId, minaSshdServiceId);\n-                }\n-            }\n+            saveStackCCMParameters(stack, ccmParameters);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7e0393c64b29de6ef8d72dc182ec08e349b40ac"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI3MzQyMQ==", "bodyText": "the same for this request, include tunnel instead if boolean", "url": "https://github.com/hortonworks/cloudbreak/pull/9674#discussion_r551273421", "createdAt": "2021-01-04T11:54:44Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/flow/stack/termination/event/ccm/CcmKeyDeregistrationRequest.java", "diffHunk": "@@ -17,14 +17,18 @@\n \n     private final String minaSshdServiceId;\n \n+    private final String ccmV2AgentCrn;\n+\n+    @SuppressWarnings(\"ExecutableStatementCount\")\n     public CcmKeyDeregistrationRequest(Long stackId, Boolean forced, String actorCrn, String accountId, String keyId, Boolean useCcm,\n-            String minaSshdServiceId) {\n+            String minaSshdServiceId, String ccmV2AgentCrn) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7e0393c64b29de6ef8d72dc182ec08e349b40ac"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI3MzU3NQ==", "bodyText": "same for this handler. depend on tunnel, not on the entitlement", "url": "https://github.com/hortonworks/cloudbreak/pull/9674#discussion_r551273575", "createdAt": "2021-01-04T11:55:09Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/flow/stack/termination/handler/CcmKeyDeregistrationHandler.java", "diffHunk": "@@ -27,15 +29,25 @@\n     @Inject\n     private EventBus eventBus;\n \n+    @Inject\n+    private EntitlementService entitlementService;\n+\n+    @Inject\n+    private CcmV2AgentTerminationListener ccmV2AgentTerminationListener;\n+\n     @Override\n     public void accept(Event<CcmKeyDeregistrationRequest> requestEvent) {\n \n         CcmKeyDeregistrationRequest request = requestEvent.getData();\n         if (Boolean.TRUE.equals(request.getUseCcm())) {\n             LOGGER.debug(\"De-registering CCM key for freeipa stack {}\", request.getResourceId());\n             try {\n-                ccmResourceTerminationListener.deregisterCcmSshTunnelingKey(request.getActorCrn(), request.getAccountId(), request.getKeyId(),\n-                        request.getMinaSshdServiceId());\n+                if (!entitlementService.ccmV2Enabled(request.getAccountId())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7e0393c64b29de6ef8d72dc182ec08e349b40ac"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI3Mzk3Nw==", "bodyText": "the same question, would it break anything if you don't add CCMv1 false to the model?", "url": "https://github.com/hortonworks/cloudbreak/pull/9674#discussion_r551273977", "createdAt": "2021-01-04T11:56:04Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/image/userdata/UserDataBuilder.java", "diffHunk": "@@ -56,11 +60,19 @@ private String build(Platform cloudPlatform, byte[] cbSshKeyDer, String sshUser,\n         model.put(\"customUserData\", userDataBuilderParams.getCustomData());\n         model.put(\"saltBootPassword\", saltBootPassword);\n         model.put(\"cbCert\", cbCert);\n-        CcmParameters.addToTemplateModel(InstanceGroupType.GATEWAY, ccmParameters, model);\n+        extendModelWithCcmConnectivity(InstanceGroupType.GATEWAY, ccmConnectivityParameters, model);\n         extendModelWithProxyParams(proxyConfig, model);\n         return build(model);\n     }\n \n+    private void extendModelWithCcmConnectivity(InstanceGroupType type, CcmConnectivityParameters ccmConnectivityParameters, Map<String, Object> model) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7e0393c64b29de6ef8d72dc182ec08e349b40ac"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI3NDQyMw==", "bodyText": "just a note to keep this in sync with the other after refactor", "url": "https://github.com/hortonworks/cloudbreak/pull/9674#discussion_r551274423", "createdAt": "2021-01-04T11:56:59Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/image/userdata/UserDataService.java", "diffHunk": "@@ -88,34 +109,62 @@ public void createUserData(Long stackId) {\n         String saltBootPassword = saltSecurityConfig.getSaltBootPassword();\n         try {\n             PlatformParameters platformParameters = platformParametersFuture.get();\n-            CcmParameters ccmParameters = fetchCcmParameters(stack);\n+            CcmConnectivityParameters ccmParameters = fetchCcmParameters(stack);\n             Optional<ProxyConfig> proxyConfig = proxyConfigDtoService.getByEnvironmentCrn(stack.getEnvironmentCrn());\n             String userData = userDataBuilder.buildUserData(Platform.platform(stack.getCloudPlatform()), cbSshKeyDer, sshUser, platformParameters,\n                     saltBootPassword, cbCert, ccmParameters, proxyConfig.orElse(null));\n             imageService.decorateImageWithUserDataForStack(stack, userData);\n-            if (ccmParameters != null) {\n-                String minaSshdServiceId = ccmParameters.getServerParameters().getMinaSshdServiceId();\n-                if (StringUtils.isNotBlank(minaSshdServiceId)) {\n-                    LOGGER.debug(\"Add Minasshdserviceid [{}] to stack [{}]\", minaSshdServiceId, stack.getResourceCrn());\n-                    stack.setMinaSshdServiceId(minaSshdServiceId);\n-                    stackService.save(stack);\n-                }\n-            }\n+            saveStackCCMParameters(stack, ccmParameters);\n         } catch (InterruptedException | ExecutionException e) {\n             LOGGER.error(\"Failed to get Platform parmaters\", e);\n             throw new GetCloudParameterException(\"Failed to get Platform parmaters\", e);\n         }\n     }\n \n-    private CcmParameters fetchCcmParameters(Stack stack) {\n-        CcmParameters ccmParameters = null;\n-        if ((ccmParameterSupplier != null) && stack.getTunnel().useCcm()) {\n+    @VisibleForTesting\n+    CcmConnectivityParameters fetchCcmParameters(Stack stack) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7e0393c64b29de6ef8d72dc182ec08e349b40ac"}, "originalPosition": 93}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI3NDY2Mg==", "bodyText": "depend on tunnel instead of entitlement", "url": "https://github.com/hortonworks/cloudbreak/pull/9674#discussion_r551274662", "createdAt": "2021-01-04T11:57:33Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/stack/ClusterProxyService.java", "diffHunk": "@@ -174,8 +181,14 @@\n \n         ConfigRegistrationRequestBuilder requestBuilder = new ConfigRegistrationRequestBuilder(stack.getResourceCrn())\n                 .withServices(serviceConfigs)\n-                .withTunnelEntries(createTunnelEntries(stack, tunnelGatewayConfigs))\n                 .withAccountId(stack.getAccountId());\n+        if (stack.getTunnel().useCcm()) {\n+            if (!entitlementService.ccmV2Enabled(stack.getAccountId())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7e0393c64b29de6ef8d72dc182ec08e349b40ac"}, "originalPosition": 35}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e7e0393c64b29de6ef8d72dc182ec08e349b40ac", "author": {"user": {"login": "smaniraju", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/e7e0393c64b29de6ef8d72dc182ec08e349b40ac", "committedDate": "2021-01-04T04:34:14Z", "message": "CB-9182 Add Support for CCMV2\n\n1. Support for CB,FREEIPA Integration with CCMV2 Service behind an entitlement.\n2. DH, DL, FREEIPA Image User Data Generation enhanced to store CCMV2 config as user data variables.\n3. Support for CB,FREEIPA Integration with Cluster-Proxy for CCMV2 configs"}, "afterCommit": {"oid": "83e02a0069712a0d654c35d8020a277a65847256", "author": {"user": {"login": "smaniraju", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/83e02a0069712a0d654c35d8020a277a65847256", "committedDate": "2021-01-06T11:48:26Z", "message": "CB-9182 Add Support for CCMV2\n\n1. Support for CB,FREEIPA Integration with CCMV2 Service behind an entitlement.\n2. DH, DL, FREEIPA Image User Data Generation enhanced to store CCMV2 config as user data variables.\n3. Support for CB,FREEIPA Integration with Cluster-Proxy for CCMV2 configs"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "83e02a0069712a0d654c35d8020a277a65847256", "author": {"user": {"login": "smaniraju", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/83e02a0069712a0d654c35d8020a277a65847256", "committedDate": "2021-01-06T11:48:26Z", "message": "CB-9182 Add Support for CCMV2\n\n1. Support for CB,FREEIPA Integration with CCMV2 Service behind an entitlement.\n2. DH, DL, FREEIPA Image User Data Generation enhanced to store CCMV2 config as user data variables.\n3. Support for CB,FREEIPA Integration with Cluster-Proxy for CCMV2 configs"}, "afterCommit": {"oid": "8ff0cca20c3ba25f80a737a2d8b829f5a7e91676", "author": {"user": {"login": "smaniraju", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/8ff0cca20c3ba25f80a737a2d8b829f5a7e91676", "committedDate": "2021-01-06T13:03:07Z", "message": "CB-9182 Add Support for CCMV2\n\n1. Support for CB,FREEIPA Integration with CCMV2 Service behind an entitlement.\n2. DH, DL, FREEIPA Image User Data Generation enhanced to store CCMV2 config as user data variables.\n3. Support for CB,FREEIPA Integration with Cluster-Proxy for CCMV2 configs"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8ff0cca20c3ba25f80a737a2d8b829f5a7e91676", "author": {"user": {"login": "smaniraju", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/8ff0cca20c3ba25f80a737a2d8b829f5a7e91676", "committedDate": "2021-01-06T13:03:07Z", "message": "CB-9182 Add Support for CCMV2\n\n1. Support for CB,FREEIPA Integration with CCMV2 Service behind an entitlement.\n2. DH, DL, FREEIPA Image User Data Generation enhanced to store CCMV2 config as user data variables.\n3. Support for CB,FREEIPA Integration with Cluster-Proxy for CCMV2 configs"}, "afterCommit": {"oid": "ccabf23d50823f81579a2cf07267c19b3f532c32", "author": {"user": {"login": "smaniraju", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/ccabf23d50823f81579a2cf07267c19b3f532c32", "committedDate": "2021-01-06T14:13:12Z", "message": "CB-9182 Add Support for CCMV2\n\n1. Support for CB,FREEIPA Integration with CCMV2 Service behind an entitlement.\n2. DH, DL, FREEIPA Image User Data Generation enhanced to store CCMV2 config as user data variables.\n3. Support for CB,FREEIPA Integration with Cluster-Proxy for CCMV2 configs"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ccabf23d50823f81579a2cf07267c19b3f532c32", "author": {"user": {"login": "smaniraju", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/ccabf23d50823f81579a2cf07267c19b3f532c32", "committedDate": "2021-01-06T14:13:12Z", "message": "CB-9182 Add Support for CCMV2\n\n1. Support for CB,FREEIPA Integration with CCMV2 Service behind an entitlement.\n2. DH, DL, FREEIPA Image User Data Generation enhanced to store CCMV2 config as user data variables.\n3. Support for CB,FREEIPA Integration with Cluster-Proxy for CCMV2 configs"}, "afterCommit": {"oid": "8fdb7b0364b984679eef912b35ed1f25d533c7da", "author": {"user": {"login": "smaniraju", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/8fdb7b0364b984679eef912b35ed1f25d533c7da", "committedDate": "2021-01-07T03:22:50Z", "message": "CB-9182 Add Support for CCMV2\n\n1. Support for CB,FREEIPA Integration with CCMV2 Service behind an entitlement.\n2. DH, DL, FREEIPA Image User Data Generation enhanced to store CCMV2 config as user data variables.\n3. Support for CB,FREEIPA Integration with Cluster-Proxy for CCMV2 configs"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8fdb7b0364b984679eef912b35ed1f25d533c7da", "author": {"user": {"login": "smaniraju", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/8fdb7b0364b984679eef912b35ed1f25d533c7da", "committedDate": "2021-01-07T03:22:50Z", "message": "CB-9182 Add Support for CCMV2\n\n1. Support for CB,FREEIPA Integration with CCMV2 Service behind an entitlement.\n2. DH, DL, FREEIPA Image User Data Generation enhanced to store CCMV2 config as user data variables.\n3. Support for CB,FREEIPA Integration with Cluster-Proxy for CCMV2 configs"}, "afterCommit": {"oid": "5b702838fc560ff0d73abc4f6fdad5db9eeff6e3", "author": {"user": {"login": "smaniraju", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/5b702838fc560ff0d73abc4f6fdad5db9eeff6e3", "committedDate": "2021-01-07T07:55:48Z", "message": "CB-9182 Add Support for CCMV2\n\n1. Support for CB,FREEIPA Integration with CCMV2 Service behind an entitlement.\n2. DH, DL, FREEIPA Image User Data Generation enhanced to store CCMV2 config as user data variables.\n3. Support for CB,FREEIPA Integration with Cluster-Proxy for CCMV2 configs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYzNDc3MjE5", "url": "https://github.com/hortonworks/cloudbreak/pull/9674#pullrequestreview-563477219", "createdAt": "2021-01-07T13:19:06Z", "commit": {"oid": "5b702838fc560ff0d73abc4f6fdad5db9eeff6e3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QxMzoxOTowN1rOIPsEpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QxMzoxOTowN1rOIPsEpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzMyMTYzOQ==", "bodyText": "for reregistration you add knox url to the request. Is it missing here on purpose?", "url": "https://github.com/hortonworks/cloudbreak/pull/9674#discussion_r553321639", "createdAt": "2021-01-07T13:19:07Z", "author": {"login": "lacikaaa"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/core/flow2/cluster/provision/clusterproxy/ClusterProxyService.java", "diffHunk": "@@ -111,17 +115,22 @@ public void deregisterCluster(Stack stack) {\n     private ConfigRegistrationRequest createProxyConfigRequest(Stack stack) {\n         ConfigRegistrationRequestBuilder requestBuilder = new ConfigRegistrationRequestBuilder(stack.getResourceCrn())\n                 .withAliases(singletonList(clusterId(stack.getCluster()))).withServices(serviceConfigs(stack));\n-        if (stack.getTunnel().useCcm()) {\n+        if (stack.getTunnel().useCcmV1()) {\n             requestBuilder.withAccountId(getAccountId(stack)).withTunnelEntries(tunnelEntries(stack));\n+        } else if (stack.getTunnel().useCcmV2()) {\n+            requestBuilder.withAccountId(getAccountId(stack)).withCcmV2Entries(ccmV2Configs(stack));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b702838fc560ff0d73abc4f6fdad5db9eeff6e3"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYzNDc4OTYz", "url": "https://github.com/hortonworks/cloudbreak/pull/9674#pullrequestreview-563478963", "createdAt": "2021-01-07T13:21:49Z", "commit": {"oid": "5b702838fc560ff0d73abc4f6fdad5db9eeff6e3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QxMzoyMTo0OVrOIPsJtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QxMzoyMTo0OVrOIPsJtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzMyMjkzMw==", "bodyText": "If I remember well the decision was that there will be only one agent running of inverting proxy which would pass everything through nginx and it would mean we have to add a new context for knox in nginx. But in that case I don't think you need KNOX here.", "url": "https://github.com/hortonworks/cloudbreak/pull/9674#discussion_r553322933", "createdAt": "2021-01-07T13:21:49Z", "author": {"login": "lacikaaa"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/core/flow2/cluster/provision/clusterproxy/ClusterProxyService.java", "diffHunk": "@@ -147,6 +156,16 @@ private String getAccountId(Stack stack) {\n         return asList(gatewayTunnel, knoxTunnel);\n     }\n \n+    private List<CcmV2Config> ccmV2Configs(Stack stack) {\n+        InstanceMetaData primaryGateway = stack.getPrimaryGatewayInstance();\n+        return List.of(ServiceFamilies.GATEWAY.getDefaultPort(), ServiceFamilies.KNOX.getDefaultPort()).stream()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b702838fc560ff0d73abc4f6fdad5db9eeff6e3"}, "originalPosition": 63}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYzNDg3Nzkz", "url": "https://github.com/hortonworks/cloudbreak/pull/9674#pullrequestreview-563487793", "createdAt": "2021-01-07T13:35:03Z", "commit": {"oid": "5b702838fc560ff0d73abc4f6fdad5db9eeff6e3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QxMzozNTowM1rOIPsj4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QxMzozNTowM1rOIPsj4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzMyOTYzNQ==", "bodyText": "when could this happen: .orElse(\"\")? shouldn't we fail instead?\nI'm not sure how HA for SDX works, maybe with a single gateway, but would that 0L cause any problem?", "url": "https://github.com/hortonworks/cloudbreak/pull/9674#discussion_r553329635", "createdAt": "2021-01-07T13:35:03Z", "author": {"login": "lacikaaa"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/service/image/userdata/CcmUserDataService.java", "diffHunk": "@@ -0,0 +1,105 @@\n+package com.sequenceiq.cloudbreak.service.image.userdata;\n+\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.Optional;\n+\n+import javax.inject.Inject;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+\n+import com.google.common.collect.ImmutableMap;\n+import com.sequenceiq.cloudbreak.auth.ThreadBasedUserCrnProvider;\n+import com.sequenceiq.cloudbreak.ccm.cloudinit.CcmConnectivityParameters;\n+import com.sequenceiq.cloudbreak.ccm.cloudinit.CcmParameterSupplier;\n+import com.sequenceiq.cloudbreak.ccm.cloudinit.CcmParameters;\n+import com.sequenceiq.cloudbreak.ccm.cloudinit.CcmV2ParameterSupplier;\n+import com.sequenceiq.cloudbreak.ccm.cloudinit.CcmV2Parameters;\n+import com.sequenceiq.cloudbreak.ccm.endpoint.KnownServiceIdentifier;\n+import com.sequenceiq.cloudbreak.ccm.endpoint.ServiceFamilies;\n+import com.sequenceiq.cloudbreak.ccm.key.CcmResourceUtil;\n+import com.sequenceiq.cloudbreak.common.service.HostDiscoveryService;\n+import com.sequenceiq.cloudbreak.domain.stack.Stack;\n+import com.sequenceiq.cloudbreak.domain.stack.instance.InstanceGroup;\n+import com.sequenceiq.cloudbreak.service.stack.StackService;\n+\n+@Service\n+public class CcmUserDataService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(CcmUserDataService.class);\n+\n+    @Inject\n+    private StackService stackService;\n+\n+    @Inject\n+    private HostDiscoveryService hostDiscoveryService;\n+\n+    @Autowired\n+    private CcmParameterSupplier ccmParameterSupplier;\n+\n+    @Autowired\n+    private CcmV2ParameterSupplier ccmV2ParameterSupplier;\n+\n+    public CcmConnectivityParameters fetchAndSaveCcmParameters(Stack stack) {\n+        CcmConnectivityParameters ccmConnectivityParameters = new CcmConnectivityParameters();\n+        if (stack.getTunnel().useCcmV1()) {\n+            String userCrn = ThreadBasedUserCrnProvider.getUserCrn();\n+            String actorCrn = Objects.requireNonNull(userCrn, \"userCrn is null\");\n+\n+            ImmutableMap.Builder<KnownServiceIdentifier, Integer> builder = ImmutableMap.builder();\n+            int gatewayPort = Optional.ofNullable(stack.getGatewayPort()).orElse(ServiceFamilies.GATEWAY.getDefaultPort());\n+            builder.put(KnownServiceIdentifier.GATEWAY, gatewayPort);\n+\n+            // Optionally configure a tunnel for (nginx fronting) Knox\n+            if (stack.getCluster().getGateway() != null) {\n+                // JSA TODO Do we support a non-default port for the nginx that fronts Knox?\n+                builder.put(KnownServiceIdentifier.KNOX, ServiceFamilies.KNOX.getDefaultPort());\n+            }\n+\n+            Map<KnownServiceIdentifier, Integer> tunneledServicePorts = builder.build();\n+            CcmParameters ccmV1Parameters = ccmParameterSupplier.getCcmParameters(actorCrn, ThreadBasedUserCrnProvider.getAccountId(),\n+                    CcmResourceUtil.getKeyId(stack.getResourceCrn()), tunneledServicePorts).orElse(null);\n+            ccmConnectivityParameters = new CcmConnectivityParameters(ccmV1Parameters);\n+\n+            saveCcmV1Config(stack.getId(), ccmV1Parameters);\n+        } else if (stack.getTunnel().useCcmV2()) {\n+            String gatewayHostName = hostDiscoveryService.generateHostname(stack.getCustomHostname(),\n+                    stack.getGatewayHostGroup().map(InstanceGroup::getGroupName).orElse(\"\"), 0L,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b702838fc560ff0d73abc4f6fdad5db9eeff6e3"}, "originalPosition": 71}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYzNDkyOTY1", "url": "https://github.com/hortonworks/cloudbreak/pull/9674#pullrequestreview-563492965", "createdAt": "2021-01-07T13:42:26Z", "commit": {"oid": "5b702838fc560ff0d73abc4f6fdad5db9eeff6e3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QxMzo0MjoyNlrOIPsy6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QxMzo0MjoyNlrOIPsy6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzMzMzQ4MA==", "bodyText": "won't this fix 0 cause problems for freeipa HA?", "url": "https://github.com/hortonworks/cloudbreak/pull/9674#discussion_r553333480", "createdAt": "2021-01-07T13:42:26Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/image/userdata/CcmUserDataService.java", "diffHunk": "@@ -0,0 +1,105 @@\n+package com.sequenceiq.freeipa.service.image.userdata;\n+\n+import java.util.Collections;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.Optional;\n+\n+import javax.inject.Inject;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+\n+import com.sequenceiq.cloudbreak.ccm.cloudinit.CcmConnectivityParameters;\n+import com.sequenceiq.cloudbreak.ccm.cloudinit.CcmParameterSupplier;\n+import com.sequenceiq.cloudbreak.ccm.cloudinit.CcmParameters;\n+import com.sequenceiq.cloudbreak.ccm.cloudinit.CcmV2ParameterSupplier;\n+import com.sequenceiq.cloudbreak.ccm.cloudinit.CcmV2Parameters;\n+import com.sequenceiq.cloudbreak.ccm.endpoint.KnownServiceIdentifier;\n+import com.sequenceiq.cloudbreak.ccm.endpoint.ServiceFamilies;\n+import com.sequenceiq.cloudbreak.ccm.key.CcmResourceUtil;\n+import com.sequenceiq.cloudbreak.common.service.HostDiscoveryService;\n+import com.sequenceiq.freeipa.entity.FreeIpa;\n+import com.sequenceiq.freeipa.entity.Stack;\n+import com.sequenceiq.freeipa.service.freeipa.FreeIpaService;\n+import com.sequenceiq.freeipa.service.stack.StackService;\n+import com.sequenceiq.freeipa.util.CrnService;\n+\n+@Service\n+public class CcmUserDataService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(CcmUserDataService.class);\n+\n+    @Inject\n+    private CrnService crnService;\n+\n+    @Inject\n+    private StackService stackService;\n+\n+    @Inject\n+    private HostDiscoveryService hostDiscoveryService;\n+\n+    @Inject\n+    private FreeIpaService freeIpaService;\n+\n+    @Autowired\n+    private CcmParameterSupplier ccmParameterSupplier;\n+\n+    @Autowired\n+    private CcmV2ParameterSupplier ccmV2ParameterSupplier;\n+\n+    public CcmConnectivityParameters fetchAndSaveCcmParameters(Stack stack) {\n+        CcmConnectivityParameters ccmConnectivityParameters = new CcmConnectivityParameters();\n+        String keyId = CcmResourceUtil.getKeyId(stack.getResourceCrn());\n+\n+        if (stack.getTunnel().useCcmV1()) {\n+            String actorCrn = Objects.requireNonNull(crnService.getUserCrn(), \"userCrn is null\");\n+            int gatewayPort = Optional.ofNullable(stack.getGatewayport()).orElse(ServiceFamilies.GATEWAY.getDefaultPort());\n+            Map<KnownServiceIdentifier, Integer> tunneledServicePorts = Collections.singletonMap(KnownServiceIdentifier.GATEWAY, gatewayPort);\n+\n+            CcmParameters ccmV1Parameters = ccmParameterSupplier\n+                    .getCcmParameters(actorCrn, stack.getAccountId(), keyId, tunneledServicePorts)\n+                    .orElse(null);\n+            ccmConnectivityParameters = new CcmConnectivityParameters(ccmV1Parameters);\n+            saveCcmV1Config(stack.getId(), ccmV1Parameters);\n+        } else if (stack.getTunnel().useCcmV2()) {\n+            FreeIpa freeIpa = freeIpaService.findByStack(stack);\n+            String gatewayHostName = hostDiscoveryService.generateHostname(freeIpa.getHostname(), null, 0, false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b702838fc560ff0d73abc4f6fdad5db9eeff6e3"}, "originalPosition": 70}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYzNDk5NDY3", "url": "https://github.com/hortonworks/cloudbreak/pull/9674#pullrequestreview-563499467", "createdAt": "2021-01-07T13:51:33Z", "commit": {"oid": "5b702838fc560ff0d73abc4f6fdad5db9eeff6e3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QxMzo1MTozNFrOIPtG1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QxMzo1MTozNFrOIPtG1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzMzODU4MQ==", "bodyText": "So you shouldn't overwrite CCM with CCMv2. You should check the request, if it contains CCMv2 but the entitlement is disabled you must throw a badrequestexception with a reason.\nIf CCM is sent in the request,it should be used, even if the entitlement is enabled. We don't want to force users with enabled entitlement to use CCMv2, do we?", "url": "https://github.com/hortonworks/cloudbreak/pull/9674#discussion_r553338581", "createdAt": "2021-01-07T13:51:34Z", "author": {"login": "lacikaaa"}, "path": "environment/src/main/java/com/sequenceiq/environment/environment/service/EnvironmentCreationService.java", "diffHunk": "@@ -123,6 +126,15 @@ private Environment initializeEnvironment(EnvironmentCreationDto creationDto) {\n         return environment;\n     }\n \n+    private void initializeEnvironmentTunnel(Environment environment) {\n+        Tunnel tunnel = environment.getExperimentalFeaturesJson().getTunnel();\n+        if (Tunnel.CCM == tunnel && entitlementService.ccmV2Enabled(environment.getAccountId())) {\n+            ExperimentalFeatures experimentalFeaturesJson = environment.getExperimentalFeaturesJson();\n+            experimentalFeaturesJson.setTunnel(Tunnel.CCMV2);\n+            environment.setExperimentalFeaturesJson(experimentalFeaturesJson);\n+        }\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b702838fc560ff0d73abc4f6fdad5db9eeff6e3"}, "originalPosition": 31}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5b702838fc560ff0d73abc4f6fdad5db9eeff6e3", "author": {"user": {"login": "smaniraju", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/5b702838fc560ff0d73abc4f6fdad5db9eeff6e3", "committedDate": "2021-01-07T07:55:48Z", "message": "CB-9182 Add Support for CCMV2\n\n1. Support for CB,FREEIPA Integration with CCMV2 Service behind an entitlement.\n2. DH, DL, FREEIPA Image User Data Generation enhanced to store CCMV2 config as user data variables.\n3. Support for CB,FREEIPA Integration with Cluster-Proxy for CCMV2 configs"}, "afterCommit": {"oid": "a7e2e1bb1a7f368910b2cb9080d1b11955056a93", "author": {"user": {"login": "smaniraju", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/a7e2e1bb1a7f368910b2cb9080d1b11955056a93", "committedDate": "2021-01-08T07:24:27Z", "message": "CB-9182 Add Support for CCMV2\n\n1. Support for CB,FREEIPA Integration with CCMV2 Service behind an entitlement.\n2. DH, DL, FREEIPA Image User Data Generation enhanced to store CCMV2 config as user data variables.\n3. Support for CB,FREEIPA Integration with Cluster-Proxy for CCMV2 configs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY0MTY4Mzgy", "url": "https://github.com/hortonworks/cloudbreak/pull/9674#pullrequestreview-564168382", "createdAt": "2021-01-08T10:49:11Z", "commit": {"oid": "a7e2e1bb1a7f368910b2cb9080d1b11955056a93"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wOFQxMDo0OToxMVrOIQNxCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wOFQxMDo0OToxMVrOIQNxCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzg3MzY3NA==", "bodyText": "that's not true, it could be cluster proxied. although customer won't start that kind of cluster", "url": "https://github.com/hortonworks/cloudbreak/pull/9674#discussion_r553873674", "createdAt": "2021-01-08T10:49:11Z", "author": {"login": "lacikaaa"}, "path": "environment/src/main/java/com/sequenceiq/environment/environment/service/EnvironmentCreationService.java", "diffHunk": "@@ -123,6 +126,21 @@ private Environment initializeEnvironment(EnvironmentCreationDto creationDto) {\n         return environment;\n     }\n \n+    private void initializeEnvironmentTunnel(Environment environment) {\n+        Tunnel tunnel = environment.getExperimentalFeaturesJson().getTunnel();\n+        boolean ccmV2Enabled = entitlementService.ccmV2Enabled(environment.getAccountId());\n+        if (Tunnel.CCMV2 == tunnel && !ccmV2Enabled) {\n+            throw new BadRequestException(\"CCMV2 not enabled for account.\");\n+        } else if (Tunnel.CCM == tunnel && ccmV2Enabled) {\n+            ExperimentalFeatures experimentalFeaturesJson = environment.getExperimentalFeaturesJson();\n+            experimentalFeaturesJson.setTunnel(Tunnel.CCMV2);\n+            environment.setExperimentalFeaturesJson(experimentalFeaturesJson);\n+            LOGGER.info(\"Environment is initialized with CCMV2 tunnel.\");\n+        } else {\n+            LOGGER.info(\"Environment is initialized with Direct tunnel.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7e2e1bb1a7f368910b2cb9080d1b11955056a93"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY0MTY5MDQ4", "url": "https://github.com/hortonworks/cloudbreak/pull/9674#pullrequestreview-564169048", "createdAt": "2021-01-08T10:50:15Z", "commit": {"oid": "a7e2e1bb1a7f368910b2cb9080d1b11955056a93"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wOFQxMDo1MDoxNVrOIQNy1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wOFQxMDo1MDoxNVrOIQNy1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzg3NDEzMw==", "bodyText": "as this is a single item, the stream and list is an overkill here", "url": "https://github.com/hortonworks/cloudbreak/pull/9674#discussion_r553874133", "createdAt": "2021-01-08T10:50:15Z", "author": {"login": "lacikaaa"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/core/flow2/cluster/provision/clusterproxy/ClusterProxyService.java", "diffHunk": "@@ -147,6 +156,16 @@ private String getAccountId(Stack stack) {\n         return asList(gatewayTunnel, knoxTunnel);\n     }\n \n+    private List<CcmV2Config> ccmV2Configs(Stack stack) {\n+        InstanceMetaData primaryGateway = stack.getPrimaryGatewayInstance();\n+        return List.of(ServiceFamilies.GATEWAY.getDefaultPort()).stream()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7e2e1bb1a7f368910b2cb9080d1b11955056a93"}, "originalPosition": 63}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d9c1e6db3780f3138e89e4a64d9745ce174f35c", "author": {"user": {"login": "smaniraju", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/7d9c1e6db3780f3138e89e4a64d9745ce174f35c", "committedDate": "2021-01-08T11:14:03Z", "message": "CB-9182 Add Support for CCMV2\n\n1. Support for CB,FREEIPA Integration with CCMV2 Service behind an entitlement.\n2. DH, DL, FREEIPA Image User Data Generation enhanced to store CCMV2 config as user data variables.\n3. Support for CB,FREEIPA Integration with Cluster-Proxy for CCMV2 configs"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a7e2e1bb1a7f368910b2cb9080d1b11955056a93", "author": {"user": {"login": "smaniraju", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/a7e2e1bb1a7f368910b2cb9080d1b11955056a93", "committedDate": "2021-01-08T07:24:27Z", "message": "CB-9182 Add Support for CCMV2\n\n1. Support for CB,FREEIPA Integration with CCMV2 Service behind an entitlement.\n2. DH, DL, FREEIPA Image User Data Generation enhanced to store CCMV2 config as user data variables.\n3. Support for CB,FREEIPA Integration with Cluster-Proxy for CCMV2 configs"}, "afterCommit": {"oid": "7d9c1e6db3780f3138e89e4a64d9745ce174f35c", "author": {"user": {"login": "smaniraju", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/7d9c1e6db3780f3138e89e4a64d9745ce174f35c", "committedDate": "2021-01-08T11:14:03Z", "message": "CB-9182 Add Support for CCMV2\n\n1. Support for CB,FREEIPA Integration with CCMV2 Service behind an entitlement.\n2. DH, DL, FREEIPA Image User Data Generation enhanced to store CCMV2 config as user data variables.\n3. Support for CB,FREEIPA Integration with Cluster-Proxy for CCMV2 configs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY0MTg0Mjkx", "url": "https://github.com/hortonworks/cloudbreak/pull/9674#pullrequestreview-564184291", "createdAt": "2021-01-08T11:16:23Z", "commit": {"oid": "7d9c1e6db3780f3138e89e4a64d9745ce174f35c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1900, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}