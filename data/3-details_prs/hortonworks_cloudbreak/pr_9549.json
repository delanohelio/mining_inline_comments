{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMwNDY4NDI5", "number": 9549, "title": "CDPSDX-1981: missing DNS a record in ipa", "bodyText": "During datalake provisioning, an intermittent error of \"does not have corresponding DNS A/AAAA record\" happens. As we verified that dns a-record was first added and then went missing before adding service to kerbores later, we added 3 times retry with a random 10-15 seconds interval to remedy this. Also this will help to confirm how long the issue lasts and whether it comes back.\nSee detailed description in the commit message.", "createdAt": "2020-12-01T17:41:56Z", "url": "https://github.com/hortonworks/cloudbreak/pull/9549", "merged": true, "mergeCommit": {"oid": "c54ec674d4b48c79252d148a6416a91b7f142ad0"}, "closed": true, "closedAt": "2020-12-02T22:00:25Z", "author": {"login": "christmasferret"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdh9o4gABqjQwNTg0NjAwMTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdiSwqLABqjQwNjM3NzIxODI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ff7703ab4de26336dd46128888f30867288e7a38", "author": {"user": {"login": "christmasferret", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/ff7703ab4de26336dd46128888f30867288e7a38", "committedDate": "2020-12-01T17:40:40Z", "message": "CDPSDX-1981: missing DNS a record in ipa\n\nDuring datalake provisioning, an intermittent error of \"does not have corresponding DNS A/AAAA record\" happens. As we verified that dns a-record was first added and then went missing before adding service to kerbores later, we added 3 times retry with a random 10-15 seconds interval to remedy this. Also this will help to confirm how long the issue lasts and whether it comes back."}, "afterCommit": {"oid": "2c1785349b4768ce08b23536c49425392f6176c5", "author": {"user": {"login": "christmasferret", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/2c1785349b4768ce08b23536c49425392f6176c5", "committedDate": "2020-12-01T17:45:11Z", "message": "CDPSDX-1981: missing DNS a record in ipa\n\nDuring datalake provisioning, an intermittent error of \"does not have corresponding DNS A/AAAA record\" happens. As we verified that dns a-record was first added and then went missing before adding service to kerbores later, we added 3 times retry with a random 10-15 seconds interval to remedy this. Also this will help to confirm how long the issue lasts and whether it comes back."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyODY0Mzkw", "url": "https://github.com/hortonworks/cloudbreak/pull/9549#pullrequestreview-542864390", "createdAt": "2020-12-02T14:03:41Z", "commit": {"oid": "2c1785349b4768ce08b23536c49425392f6176c5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxNDowMzo0MVrOH9cXGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxNDowMzo0MVrOH9cXGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDE4OTg1MA==", "bodyText": "why random? I think we should stick with a fix value", "url": "https://github.com/hortonworks/cloudbreak/pull/9549#discussion_r534189850", "createdAt": "2020-12-02T14:03:41Z", "author": {"login": "lacikaaa"}, "path": "orchestrator-salt/src/main/resources/salt/salt/sssd/template/add_dns_record.j2", "diffHunk": "@@ -17,10 +17,15 @@ FQDN=$(hostname -f)\n IPADDR=$(hostname -i)\n REVERSE_IP=$(hostname -i | awk -F. '{print $4\".\"$3\".\" $2\".\"$1}')\n \n-# dnsrecord-add must either add the record or modify it\n-if ! ipa dnsrecord-find {{ pillar['sssd-ipa']['domain'] }}. \"--name=${HOSTNAME}\" \"--a-rec=${IPADDR}\"  --ttl {{ pillar['sssd-ipa']['dns_ttl'] }} --all; then\n-  ipa dnsrecord-add {{ pillar['sssd-ipa']['domain'] }}. \"${HOSTNAME}\" \"--a-rec=${IPADDR}\" --ttl {{ pillar['sssd-ipa']['dns_ttl'] }}\n-fi\n+# add dns a-record 3 times with a random 10-15 seconds interval (see CDPSDX-1981)\n+for attempt in {1..3}\n+do\n+  echo \"add dns a-record hostname for ${HOSTNAME}, attempt ${attempt}\"\n+  if ! ipa dnsrecord-find {{ pillar['sssd-ipa']['domain'] }}. \"--name=${HOSTNAME}\" \"--a-rec=${IPADDR}\"  --ttl {{ pillar['sssd-ipa']['dns_ttl'] }} --all; then\n+    ipa dnsrecord-add {{ pillar['sssd-ipa']['domain'] }}. \"${HOSTNAME}\" \"--a-rec=${IPADDR}\" --ttl {{ pillar['sssd-ipa']['dns_ttl'] }}\n+  fi\n+  sleep $(((RANDOM % 5) + 10))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c1785349b4768ce08b23536c49425392f6176c5"}, "originalPosition": 15}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2c1785349b4768ce08b23536c49425392f6176c5", "author": {"user": {"login": "christmasferret", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/2c1785349b4768ce08b23536c49425392f6176c5", "committedDate": "2020-12-01T17:45:11Z", "message": "CDPSDX-1981: missing DNS a record in ipa\n\nDuring datalake provisioning, an intermittent error of \"does not have corresponding DNS A/AAAA record\" happens. As we verified that dns a-record was first added and then went missing before adding service to kerbores later, we added 3 times retry with a random 10-15 seconds interval to remedy this. Also this will help to confirm how long the issue lasts and whether it comes back."}, "afterCommit": {"oid": "b9f1353ec2e7893d01d3e4da432c8599bab9b54c", "author": {"user": {"login": "christmasferret", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/b9f1353ec2e7893d01d3e4da432c8599bab9b54c", "committedDate": "2020-12-02T14:49:31Z", "message": "CDPSDX-1981: missing DNS a record in ipa\n\nDuring datalake provisioning, an intermittent error of \"does not have corresponding DNS A/AAAA record\" happens. As we verified that dns a-record was first added and then went missing before adding service to kerbores later, we added 3 times retry with a random 10-15 seconds interval to remedy this. Also this will help to confirm how long the issue lasts and whether it comes back."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMDc5OTQx", "url": "https://github.com/hortonworks/cloudbreak/pull/9549#pullrequestreview-543079941", "createdAt": "2020-12-02T17:36:23Z", "commit": {"oid": "b9f1353ec2e7893d01d3e4da432c8599bab9b54c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxNzozNjoyM1rOH9mc_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxNzozNjoyM1rOH9mc_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDM1NTE5Nw==", "bodyText": "please adjust the comment to the code, as it's not random now. thanks", "url": "https://github.com/hortonworks/cloudbreak/pull/9549#discussion_r534355197", "createdAt": "2020-12-02T17:36:23Z", "author": {"login": "lacikaaa"}, "path": "orchestrator-salt/src/main/resources/salt/salt/sssd/template/add_dns_record.j2", "diffHunk": "@@ -17,10 +17,15 @@ FQDN=$(hostname -f)\n IPADDR=$(hostname -i)\n REVERSE_IP=$(hostname -i | awk -F. '{print $4\".\"$3\".\" $2\".\"$1}')\n \n-# dnsrecord-add must either add the record or modify it\n-if ! ipa dnsrecord-find {{ pillar['sssd-ipa']['domain'] }}. \"--name=${HOSTNAME}\" \"--a-rec=${IPADDR}\"  --ttl {{ pillar['sssd-ipa']['dns_ttl'] }} --all; then\n-  ipa dnsrecord-add {{ pillar['sssd-ipa']['domain'] }}. \"${HOSTNAME}\" \"--a-rec=${IPADDR}\" --ttl {{ pillar['sssd-ipa']['dns_ttl'] }}\n-fi\n+# add dns a-record 3 times with a random 10-15 seconds interval (see CDPSDX-1981)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b9f1353ec2e7893d01d3e4da432c8599bab9b54c"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMDgwMDA4", "url": "https://github.com/hortonworks/cloudbreak/pull/9549#pullrequestreview-543080008", "createdAt": "2020-12-02T17:36:28Z", "commit": {"oid": "b9f1353ec2e7893d01d3e4da432c8599bab9b54c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "307977c070cdea2b22d19039091a1369347ad42e", "author": {"user": {"login": "christmasferret", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/307977c070cdea2b22d19039091a1369347ad42e", "committedDate": "2020-12-02T18:10:58Z", "message": "CDPSDX-1981: missing DNS a record in ipa\n\nDuring datalake provisioning, an intermittent error of \"does not have corresponding DNS A/AAAA record\" happens. As we verified that dns a-record was first added and then went missing before adding service to kerbores later, we added 3 times retry with a random 10-15 seconds interval to remedy this. Also this will help to confirm how long the issue lasts and whether it comes back."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b9f1353ec2e7893d01d3e4da432c8599bab9b54c", "author": {"user": {"login": "christmasferret", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/b9f1353ec2e7893d01d3e4da432c8599bab9b54c", "committedDate": "2020-12-02T14:49:31Z", "message": "CDPSDX-1981: missing DNS a record in ipa\n\nDuring datalake provisioning, an intermittent error of \"does not have corresponding DNS A/AAAA record\" happens. As we verified that dns a-record was first added and then went missing before adding service to kerbores later, we added 3 times retry with a random 10-15 seconds interval to remedy this. Also this will help to confirm how long the issue lasts and whether it comes back."}, "afterCommit": {"oid": "307977c070cdea2b22d19039091a1369347ad42e", "author": {"user": {"login": "christmasferret", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/307977c070cdea2b22d19039091a1369347ad42e", "committedDate": "2020-12-02T18:10:58Z", "message": "CDPSDX-1981: missing DNS a record in ipa\n\nDuring datalake provisioning, an intermittent error of \"does not have corresponding DNS A/AAAA record\" happens. As we verified that dns a-record was first added and then went missing before adding service to kerbores later, we added 3 times retry with a random 10-15 seconds interval to remedy this. Also this will help to confirm how long the issue lasts and whether it comes back."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2070, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}