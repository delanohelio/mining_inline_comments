{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQxNDUzNjY0", "number": 8453, "title": "CB-7701: Capture failures and log them when dropping and creating database for restore.", "bodyText": "Print to stderr when there are problems.\nCapture log output by redirecting to the LOGFILE.\nTested by running backup/restore procedure on a Data Lake.\nWhen restoring, I did not stop the running hive services, so PostgreSQL fails the drop statement.\nGot Salt output that looks like the following:\nID: restore_postgresql_db\n    Function: cmd.run\n        Name: /opt/salt/scripts/restore_db.sh AWS s3://eng-sdx-daily-datalake/bderriso-cranston/data/backup1 dbsvr-a40ba31f-6ff5-4323-8ef2-d758d8129ace.czhkrnzwtcwb.us-west-2.rds.amazonaws.com 5432 ucklnfysen\n      Result: False\n     Comment: Command \"/opt/salt/scripts/restore_db.sh AWS s3://eng-sdx-daily-datalake/bderriso-cranston/data/backup1 dbsvr-a40ba31f-6ff5-4323-8ef2-d758d8129ace.czhkrnzwtcwb.us-west-2.rds.amazonaws.com 5432 ucklnfysen\" run\n     Started: 15:53:54.617916\n    Duration: 6338.242 ms\n     Changes:\n              ----------\n              pid:\n                  26332\n              retcode:\n                  1\n              stderr:\n                  ERROR:  database \"hive\" is being accessed by other users\n                  DETAIL:  There are 40 other sessions using the database.\n              stdout:\n                  Logs at /var/log/dl_postgres_restore.log\n                  Completed 256.0 KiB/1.3 MiB (666.8 KiB/s) with 2 file(s) remaining\n                  Completed 512.0 KiB/1.3 MiB (1.3 MiB/s) with 2 file(s) remaining\n                  Completed 768.0 KiB/1.3 MiB (1.9 MiB/s) with 2 file(s) remaining\n                  Completed 1009.4 KiB/1.3 MiB (2.5 MiB/s) with 2 file(s) remaining\n                  download: s3://eng-sdx-daily-datalake/bderriso-cranston/data/backup1/ranger_backup to ../var/tmp/postgres_restore_staging/ranger_backup\n                  Completed 1009.4 KiB/1.3 MiB (2.5 MiB/s) with 1 file(s) remaining\n                  Completed 1.2 MiB/1.3 MiB (3.1 MiB/s) with 1 file(s) remaining\n                  Completed 1.3 MiB/1.3 MiB (3.2 MiB/s) with 1 file(s) remaining\n                  download: s3://eng-sdx-daily-datalake/bderriso-cranston/data/backup1/hive_backup to ../var/tmp/postgres_restore_staging/hive_backup\n\nVerified the failure showed up in the dl_postgres_restore.log file:\n2020-06-29T14:20:27Z INFO  Restoring hive\nERROR:  database \"hive\" is being accessed by other users\nDETAIL:  There are 40 other sessions using the database.\n2020-06-29T14:20:32Z ERROR Unable to drop database hive\n\nI also fixed a bug where the backup script was not exiting correctly.\nI made a change that only checked that the exit code was 1. I've fixed it to check for exit codes that are -ne 0.\nCloses CB-7701", "createdAt": "2020-06-29T14:28:55Z", "url": "https://github.com/hortonworks/cloudbreak/pull/8453", "merged": true, "mergeCommit": {"oid": "73a7550036804ac708d0ef22d0d57e04c4062512"}, "closed": true, "closedAt": "2020-07-06T20:47:58Z", "author": {"login": "brycederriso"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcwB9QyAFqTQzOTIwMzkzNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwHq-DgFqTQzOTUwMzE4NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5MjAzOTM1", "url": "https://github.com/hortonworks/cloudbreak/pull/8453#pullrequestreview-439203935", "createdAt": "2020-06-29T14:31:16Z", "commit": {"oid": "48a9c0000c996a04f150c04342e370c653275cd2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5MjMwNDY0", "url": "https://github.com/hortonworks/cloudbreak/pull/8453#pullrequestreview-439230464", "createdAt": "2020-06-29T14:58:17Z", "commit": {"oid": "48a9c0000c996a04f150c04342e370c653275cd2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNDo1ODoxN1rOGqU9QQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNDo1ODoxN1rOGqU9QQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzAzNjczNw==", "bodyText": "Commenting here primarily to do a \"request changes\" review. I think that'll prevent the change from being merged in accidentally. See my general comment for the requested changes.", "url": "https://github.com/hortonworks/cloudbreak/pull/8453#discussion_r447036737", "createdAt": "2020-06-29T14:58:17Z", "author": {"login": "hreeve-cloudera"}, "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/disaster_recovery/scripts/restore_db.sh", "diffHunk": "@@ -52,8 +52,8 @@ restore_db_from_local() {\n \n   doLog \"INFO Restoring $SERVICE\"\n \n-  psql --host=\"$HOST\" --port=\"$PORT\" --dbname=\"postgres\" --username=\"$USERNAME\" -c \"drop database ${SERVICE};\"\n-  psql --host=\"$HOST\" --port=\"$PORT\" --dbname=\"postgres\" --username=\"$USERNAME\" -c \"create database ${SERVICE};\"\n+  psql --host=\"$HOST\" --port=\"$PORT\" --dbname=\"postgres\" --username=\"$USERNAME\" -c \"drop database ${SERVICE};\" >>$LOGFILE 2>&1 || errorExit \"Unable to drop database ${SERVICE}\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48a9c0000c996a04f150c04342e370c653275cd2"}, "originalPosition": 6}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "48a9c0000c996a04f150c04342e370c653275cd2", "author": {"user": {"login": "brycederriso", "name": "Bryce"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/48a9c0000c996a04f150c04342e370c653275cd2", "committedDate": "2020-06-29T13:08:55Z", "message": "Try to log failures from psql restore."}, "afterCommit": {"oid": "2b768ddc77a7ed2ae477dc8b4c38742e805cc2e7", "author": {"user": {"login": "brycederriso", "name": "Bryce"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/2b768ddc77a7ed2ae477dc8b4c38742e805cc2e7", "committedDate": "2020-06-29T16:26:41Z", "message": "Try to log failures from psql restore.\n\nTee all stderr to log and stderr."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2b768ddc77a7ed2ae477dc8b4c38742e805cc2e7", "author": {"user": {"login": "brycederriso", "name": "Bryce"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/2b768ddc77a7ed2ae477dc8b4c38742e805cc2e7", "committedDate": "2020-06-29T16:26:41Z", "message": "Try to log failures from psql restore.\n\nTee all stderr to log and stderr."}, "afterCommit": {"oid": "494ca8fb2ce09cf20593ce51b7b2a68155857932", "author": {"user": {"login": "brycederriso", "name": "Bryce"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/494ca8fb2ce09cf20593ce51b7b2a68155857932", "committedDate": "2020-06-29T18:18:43Z", "message": "Try to log failures from psql restore.\n\nTee all stderr to log and stderr.\n\nFix not sending error to stderr."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5MzkxNDMx", "url": "https://github.com/hortonworks/cloudbreak/pull/8453#pullrequestreview-439391431", "createdAt": "2020-06-29T18:20:34Z", "commit": {"oid": "494ca8fb2ce09cf20593ce51b7b2a68155857932"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0aea6a130355b77c83f0dcdb41a661ccbe834368", "author": {"user": {"login": "brycederriso", "name": "Bryce"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/0aea6a130355b77c83f0dcdb41a661ccbe834368", "committedDate": "2020-06-29T18:30:39Z", "message": "Try to log failures from psql restore.\n\nTee all stderr to log and stderr.\n\nFix not sending error to stderr.\n\nFix over-exuberant logging to stdout."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "494ca8fb2ce09cf20593ce51b7b2a68155857932", "author": {"user": {"login": "brycederriso", "name": "Bryce"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/494ca8fb2ce09cf20593ce51b7b2a68155857932", "committedDate": "2020-06-29T18:18:43Z", "message": "Try to log failures from psql restore.\n\nTee all stderr to log and stderr.\n\nFix not sending error to stderr."}, "afterCommit": {"oid": "0aea6a130355b77c83f0dcdb41a661ccbe834368", "author": {"user": {"login": "brycederriso", "name": "Bryce"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/0aea6a130355b77c83f0dcdb41a661ccbe834368", "committedDate": "2020-06-29T18:30:39Z", "message": "Try to log failures from psql restore.\n\nTee all stderr to log and stderr.\n\nFix not sending error to stderr.\n\nFix over-exuberant logging to stdout."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NTAzMTg0", "url": "https://github.com/hortonworks/cloudbreak/pull/8453#pullrequestreview-439503184", "createdAt": "2020-06-29T21:10:43Z", "commit": {"oid": "0aea6a130355b77c83f0dcdb41a661ccbe834368"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2652, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}