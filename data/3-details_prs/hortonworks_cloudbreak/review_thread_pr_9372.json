{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE1MDAwMjA1", "number": 9372, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxOToxODoxM1rOE4T9Ag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMToyMToxNFrOE41vGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3NDgyNjI2OnYy", "diffSide": "RIGHT", "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/disaster_recovery/scripts/backup_db.sh", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxOToxODoxM1rOHyKCHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMDoxMDoxNVrOHy9bww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM1NTIyOA==", "bodyText": "This will work as long one of the service listed below are running in the gateway node where salt-master is running.\n\nJOURNALNODE\nDATANODE\nNAMENODE\n\nExtend this to use keytab's for Solr and Hbase services as well if the HDFS keytab's are not found.\nLater we could update the logic in CB to run this command on a host where Solr/Hbase services are running instead of always picking the gatewayFQDN node.", "url": "https://github.com/hortonworks/cloudbreak/pull/9372#discussion_r522355228", "createdAt": "2020-11-12T19:18:13Z", "author": {"login": "kkalvagadda1"}, "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/disaster_recovery/scripts/backup_db.sh", "diffHunk": "@@ -56,7 +56,7 @@ errorExit() {\n kinit_as_hdfs() {\n   # Use a new Kerberos credential cache, to keep from clobbering the default.\n   export KRB5CCNAME=/tmp/krb5cc_cloudbreak_$EUID\n-  HDFS_KEYTAB=/run/cloudera-scm-agent/process/$(ls -t /run/cloudera-scm-agent/process/ | grep hdfs-NAMENODE$ | head -n 1)/hdfs.keytab\n+  HDFS_KEYTAB=/run/cloudera-scm-agent/process/$(ls -t /run/cloudera-scm-agent/process/ | grep \"hdfs-\\(JOURNALNODE\\|DATANODE\\|NAMENODE\\)$\" | head -n 1)/hdfs.keytab", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09780909c0cbdb3dd505ab2ea08d5210ab396a51"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzE5NzM3OQ==", "bodyText": "Changed this to use find and look for hbase and solr keytabs.", "url": "https://github.com/hortonworks/cloudbreak/pull/9372#discussion_r523197379", "createdAt": "2020-11-13T20:10:15Z", "author": {"login": "brycederriso"}, "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/disaster_recovery/scripts/backup_db.sh", "diffHunk": "@@ -56,7 +56,7 @@ errorExit() {\n kinit_as_hdfs() {\n   # Use a new Kerberos credential cache, to keep from clobbering the default.\n   export KRB5CCNAME=/tmp/krb5cc_cloudbreak_$EUID\n-  HDFS_KEYTAB=/run/cloudera-scm-agent/process/$(ls -t /run/cloudera-scm-agent/process/ | grep hdfs-NAMENODE$ | head -n 1)/hdfs.keytab\n+  HDFS_KEYTAB=/run/cloudera-scm-agent/process/$(ls -t /run/cloudera-scm-agent/process/ | grep \"hdfs-\\(JOURNALNODE\\|DATANODE\\|NAMENODE\\)$\" | head -n 1)/hdfs.keytab", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM1NTIyOA=="}, "originalCommit": {"oid": "09780909c0cbdb3dd505ab2ea08d5210ab396a51"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4MDM0NDczOnYy", "diffSide": "LEFT", "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/disaster_recovery/scripts/restore_db.sh", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMToxNTo0OFrOHy_ziA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxMzo0ODoyN1rOHz_drQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIzNjIzMg==", "bodyText": "Was this the reason why the error was not logged?", "url": "https://github.com/hortonworks/cloudbreak/pull/9372#discussion_r523236232", "createdAt": "2020-11-13T21:15:48Z", "author": {"login": "kkalvagadda1"}, "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/disaster_recovery/scripts/restore_db.sh", "diffHunk": "@@ -3,7 +3,6 @@\n # This script uses the 'psql' cli to drop hive and ranger databases, create them, then read in a plain SQL file to restore data.\n # We retrieve the SQL files from a valid URL, which should be `s3a://` or `abfs://` for AWS or Azure clouds respectively.\n \n-set -o errexit", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c0441cfca17d8d575c826b0cc30eb3e00ec6e5ce"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI3OTIxMw==", "bodyText": "Yes.", "url": "https://github.com/hortonworks/cloudbreak/pull/9372#discussion_r524279213", "createdAt": "2020-11-16T13:48:27Z", "author": {"login": "brycederriso"}, "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/disaster_recovery/scripts/restore_db.sh", "diffHunk": "@@ -3,7 +3,6 @@\n # This script uses the 'psql' cli to drop hive and ranger databases, create them, then read in a plain SQL file to restore data.\n # We retrieve the SQL files from a valid URL, which should be `s3a://` or `abfs://` for AWS or Azure clouds respectively.\n \n-set -o errexit", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIzNjIzMg=="}, "originalCommit": {"oid": "c0441cfca17d8d575c826b0cc30eb3e00ec6e5ce"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4MDM1ODc5OnYy", "diffSide": "RIGHT", "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/disaster_recovery/scripts/backup_db.sh", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMToyMDoyNVrOHy_7jg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQyMTo0NTowOVrOH0UeWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIzODI4Ng==", "bodyText": "With the above change, you might use the key tab for hdfs/hbase/solr services but when you perform kinit you are always using hdfs as the principal name.", "url": "https://github.com/hortonworks/cloudbreak/pull/9372#discussion_r523238286", "createdAt": "2020-11-13T21:20:25Z", "author": {"login": "kkalvagadda1"}, "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/disaster_recovery/scripts/backup_db.sh", "diffHunk": "@@ -56,9 +55,15 @@ errorExit() {\n kinit_as_hdfs() {\n   # Use a new Kerberos credential cache, to keep from clobbering the default.\n   export KRB5CCNAME=/tmp/krb5cc_cloudbreak_$EUID\n-  HDFS_KEYTAB=/run/cloudera-scm-agent/process/$(ls -t /run/cloudera-scm-agent/process/ | grep hdfs-NAMENODE$ | head -n 1)/hdfs.keytab\n-  doLog \"kinit as hdfs using Keytab: $HDFS_KEYTAB\"\n-  kinit -kt \"$HDFS_KEYTAB\" \"hdfs/$(hostname -f)\"\n+\n+  KEYTAB=$(find /run/cloudera-scm-agent/process/ -name \"*.keytab\" -path \"*hdfs*\" -o \\\n+   -path \"*hbase-REGIONSERVER\" -o \\\n+   -path \"*hbase-MASTER\" -o \\\n+   -path \"*solr-SOLRSERVER\" \\\n+   | head -n 1)\n+\n+  doLog \"kinit as hdfs using Keytab: $KEYTAB\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c0441cfca17d8d575c826b0cc30eb3e00ec6e5ce"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDYyMzQ0OA==", "bodyText": "Thank you! This is definitely a bug. I've added handling for kiniting as different principals.", "url": "https://github.com/hortonworks/cloudbreak/pull/9372#discussion_r524623448", "createdAt": "2020-11-16T21:45:09Z", "author": {"login": "brycederriso"}, "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/disaster_recovery/scripts/backup_db.sh", "diffHunk": "@@ -56,9 +55,15 @@ errorExit() {\n kinit_as_hdfs() {\n   # Use a new Kerberos credential cache, to keep from clobbering the default.\n   export KRB5CCNAME=/tmp/krb5cc_cloudbreak_$EUID\n-  HDFS_KEYTAB=/run/cloudera-scm-agent/process/$(ls -t /run/cloudera-scm-agent/process/ | grep hdfs-NAMENODE$ | head -n 1)/hdfs.keytab\n-  doLog \"kinit as hdfs using Keytab: $HDFS_KEYTAB\"\n-  kinit -kt \"$HDFS_KEYTAB\" \"hdfs/$(hostname -f)\"\n+\n+  KEYTAB=$(find /run/cloudera-scm-agent/process/ -name \"*.keytab\" -path \"*hdfs*\" -o \\\n+   -path \"*hbase-REGIONSERVER\" -o \\\n+   -path \"*hbase-MASTER\" -o \\\n+   -path \"*solr-SOLRSERVER\" \\\n+   | head -n 1)\n+\n+  doLog \"kinit as hdfs using Keytab: $KEYTAB\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIzODI4Ng=="}, "originalCommit": {"oid": "c0441cfca17d8d575c826b0cc30eb3e00ec6e5ce"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4MDM1OTUxOnYy", "diffSide": "RIGHT", "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/disaster_recovery/scripts/restore_db.sh", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMToyMDozOVrOHy_78w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMToyMDozOVrOHy_78w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIzODM4Nw==", "bodyText": "With the above change, you might use the key tab for hdfs/hbase/solr services but when you perform kinit you are always using hdfs as the principal name.", "url": "https://github.com/hortonworks/cloudbreak/pull/9372#discussion_r523238387", "createdAt": "2020-11-13T21:20:39Z", "author": {"login": "kkalvagadda1"}, "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/disaster_recovery/scripts/restore_db.sh", "diffHunk": "@@ -57,9 +56,15 @@ errorExit() {\n kinit_as_hdfs() {\n   # Use a new Kerberos credential cache, to keep from clobbering the default.\n   export KRB5CCNAME=/tmp/krb5cc_cloudbreak_$EUID\n-  HDFS_KEYTAB=/run/cloudera-scm-agent/process/$(ls -t /run/cloudera-scm-agent/process/ | grep hdfs-NAMENODE$ | head -n 1)/hdfs.keytab\n-  doLog \"kinit as hdfs using Keytab: $HDFS_KEYTAB\"\n-  kinit -kt \"$HDFS_KEYTAB\" \"hdfs/$(hostname -f)\"\n+\n+  KEYTAB=$(find /run/cloudera-scm-agent/process/ -name \"*.keytab\" -path \"*hdfs*\" -o \\\n+   -path \"*hbase-REGIONSERVER\" -o \\\n+   -path \"*hbase-MASTER\" -o \\\n+   -path \"*solr-SOLRSERVER\" \\\n+   | head -n 1)\n+\n+  doLog \"kinit as hdfs using Keytab: $KEYTAB\"\n+  kinit -kt \"$KEYTAB\" \"hdfs/$(hostname -f)\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c0441cfca17d8d575c826b0cc30eb3e00ec6e5ce"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4MDM2MDc2OnYy", "diffSide": "RIGHT", "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/disaster_recovery/scripts/restore_db.sh", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMToyMTowN1rOHy_8rA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMToyMTowN1rOHy_8rA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIzODU3Mg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              doLog \"kinit as hdfs using Keytab: $KEYTAB\"\n          \n          \n            \n              doLog \"kinit using Keytab: $KEYTAB\"", "url": "https://github.com/hortonworks/cloudbreak/pull/9372#discussion_r523238572", "createdAt": "2020-11-13T21:21:07Z", "author": {"login": "kkalvagadda1"}, "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/disaster_recovery/scripts/restore_db.sh", "diffHunk": "@@ -57,9 +56,15 @@ errorExit() {\n kinit_as_hdfs() {\n   # Use a new Kerberos credential cache, to keep from clobbering the default.\n   export KRB5CCNAME=/tmp/krb5cc_cloudbreak_$EUID\n-  HDFS_KEYTAB=/run/cloudera-scm-agent/process/$(ls -t /run/cloudera-scm-agent/process/ | grep hdfs-NAMENODE$ | head -n 1)/hdfs.keytab\n-  doLog \"kinit as hdfs using Keytab: $HDFS_KEYTAB\"\n-  kinit -kt \"$HDFS_KEYTAB\" \"hdfs/$(hostname -f)\"\n+\n+  KEYTAB=$(find /run/cloudera-scm-agent/process/ -name \"*.keytab\" -path \"*hdfs*\" -o \\\n+   -path \"*hbase-REGIONSERVER\" -o \\\n+   -path \"*hbase-MASTER\" -o \\\n+   -path \"*solr-SOLRSERVER\" \\\n+   | head -n 1)\n+\n+  doLog \"kinit as hdfs using Keytab: $KEYTAB\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c0441cfca17d8d575c826b0cc30eb3e00ec6e5ce"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4MDM2MTIwOnYy", "diffSide": "RIGHT", "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/disaster_recovery/scripts/backup_db.sh", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMToyMToxNFrOHy_86Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQyMTo0NToyN1rOH0UfwA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIzODYzMw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              doLog \"kinit as hdfs using Keytab: $KEYTAB\"\n          \n          \n            \n              doLog \"kinit using Keytab: $KEYTAB\"", "url": "https://github.com/hortonworks/cloudbreak/pull/9372#discussion_r523238633", "createdAt": "2020-11-13T21:21:14Z", "author": {"login": "kkalvagadda1"}, "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/disaster_recovery/scripts/backup_db.sh", "diffHunk": "@@ -56,9 +55,15 @@ errorExit() {\n kinit_as_hdfs() {\n   # Use a new Kerberos credential cache, to keep from clobbering the default.\n   export KRB5CCNAME=/tmp/krb5cc_cloudbreak_$EUID\n-  HDFS_KEYTAB=/run/cloudera-scm-agent/process/$(ls -t /run/cloudera-scm-agent/process/ | grep hdfs-NAMENODE$ | head -n 1)/hdfs.keytab\n-  doLog \"kinit as hdfs using Keytab: $HDFS_KEYTAB\"\n-  kinit -kt \"$HDFS_KEYTAB\" \"hdfs/$(hostname -f)\"\n+\n+  KEYTAB=$(find /run/cloudera-scm-agent/process/ -name \"*.keytab\" -path \"*hdfs*\" -o \\\n+   -path \"*hbase-REGIONSERVER\" -o \\\n+   -path \"*hbase-MASTER\" -o \\\n+   -path \"*solr-SOLRSERVER\" \\\n+   | head -n 1)\n+\n+  doLog \"kinit as hdfs using Keytab: $KEYTAB\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c0441cfca17d8d575c826b0cc30eb3e00ec6e5ce"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDYyMzgwOA==", "bodyText": "done", "url": "https://github.com/hortonworks/cloudbreak/pull/9372#discussion_r524623808", "createdAt": "2020-11-16T21:45:27Z", "author": {"login": "brycederriso"}, "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/disaster_recovery/scripts/backup_db.sh", "diffHunk": "@@ -56,9 +55,15 @@ errorExit() {\n kinit_as_hdfs() {\n   # Use a new Kerberos credential cache, to keep from clobbering the default.\n   export KRB5CCNAME=/tmp/krb5cc_cloudbreak_$EUID\n-  HDFS_KEYTAB=/run/cloudera-scm-agent/process/$(ls -t /run/cloudera-scm-agent/process/ | grep hdfs-NAMENODE$ | head -n 1)/hdfs.keytab\n-  doLog \"kinit as hdfs using Keytab: $HDFS_KEYTAB\"\n-  kinit -kt \"$HDFS_KEYTAB\" \"hdfs/$(hostname -f)\"\n+\n+  KEYTAB=$(find /run/cloudera-scm-agent/process/ -name \"*.keytab\" -path \"*hdfs*\" -o \\\n+   -path \"*hbase-REGIONSERVER\" -o \\\n+   -path \"*hbase-MASTER\" -o \\\n+   -path \"*solr-SOLRSERVER\" \\\n+   | head -n 1)\n+\n+  doLog \"kinit as hdfs using Keytab: $KEYTAB\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIzODYzMw=="}, "originalCommit": {"oid": "c0441cfca17d8d575c826b0cc30eb3e00ec6e5ce"}, "originalPosition": 22}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3550, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}