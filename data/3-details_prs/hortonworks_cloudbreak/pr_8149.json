{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIyMjQ1NTA1", "number": 8149, "title": "DISTX-471 Periscope Entitlement Service Integration", "bodyText": "Introduce Entitlement Validations\nIntroduce SuspendedClusterMonitor which monitors suspended clusters and purges them if they are deleted in CB\nDisable AlertEndpoint\nIntroduce DistroXAutoscaleEndpointTests which runs endpoint tests against embedded tomcat and embedded db.\n\nCloses #DISTX-471", "createdAt": "2020-05-23T09:01:59Z", "url": "https://github.com/hortonworks/cloudbreak/pull/8149", "merged": true, "mergeCommit": {"oid": "e7ffef3b972b10d58aec760c53e9f1d777fa0f36"}, "closed": true, "closedAt": "2020-05-25T09:23:42Z", "author": {"login": "smaniraju"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABckEo0vABqjMzNjY5MjIyNzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcksH7HABqjMzNjk0MTA5NzI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "720ef82d456e6fa0bedabcbe251e6bbac15c17f3", "author": {"user": {"login": "smaniraju", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/720ef82d456e6fa0bedabcbe251e6bbac15c17f3", "committedDate": "2020-05-23T08:58:01Z", "message": "DISTX-399 Service Endpoint Tests"}, "afterCommit": {"oid": "1e0acc8d2678d3e2dcbd3d535d2c770621efc690", "author": {"user": {"login": "smaniraju", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/1e0acc8d2678d3e2dcbd3d535d2c770621efc690", "committedDate": "2020-05-23T10:50:33Z", "message": "DISTX-399 Service Endpoint Tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1e0acc8d2678d3e2dcbd3d535d2c770621efc690", "author": {"user": {"login": "smaniraju", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/1e0acc8d2678d3e2dcbd3d535d2c770621efc690", "committedDate": "2020-05-23T10:50:33Z", "message": "DISTX-399 Service Endpoint Tests"}, "afterCommit": {"oid": "03f0a153aa7bd1856f3e256b7efdbedbfb68628d", "author": {"user": {"login": "smaniraju", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/03f0a153aa7bd1856f3e256b7efdbedbfb68628d", "committedDate": "2020-05-23T16:22:13Z", "message": "DISTX-399 Service Endpoint Tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3MzEwMDUw", "url": "https://github.com/hortonworks/cloudbreak/pull/8149#pullrequestreview-417310050", "createdAt": "2020-05-23T21:25:04Z", "commit": {"oid": "03f0a153aa7bd1856f3e256b7efdbedbfb68628d"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yM1QyMToyNTowNFrOGZrctA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yM1QyMToyNzozMVrOGZrdLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU3OTQ0NA==", "bodyText": "The handler for this ends up putting a cluster in the SUSPENDED state even if it already in the SUSPENDED state, which will end up being an unnecessary DB operation every minute for STOPPED clusters. Would be useful to avoid that.\nAlso, this will result in all known clusters being polled every minute from Cloudbreak. I think we should introduce a more light weigh API than the on that returns all Stack details (obviously a different PR for this).", "url": "https://github.com/hortonworks/cloudbreak/pull/8149#discussion_r429579444", "createdAt": "2020-05-23T21:25:04Z", "author": {"login": "sidseth"}, "path": "autoscale/src/main/java/com/sequenceiq/periscope/monitor/evaluator/ClusterStateEvaluator.java", "diffHunk": "@@ -0,0 +1,44 @@\n+package com.sequenceiq.periscope.monitor.evaluator;\n+\n+import javax.annotation.Nonnull;\n+import javax.inject.Inject;\n+\n+import org.springframework.context.annotation.Scope;\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.periscope.monitor.context.ClusterIdEvaluatorContext;\n+import com.sequenceiq.periscope.monitor.context.EvaluatorContext;\n+import com.sequenceiq.periscope.monitor.event.UpdateFailedEvent;\n+\n+@Component(\"ClusterStateEvaluator\")\n+@Scope(\"prototype\")\n+public class ClusterStateEvaluator extends EvaluatorExecutor {\n+\n+    private static final String EVALUATOR_NAME = ClusterStateEvaluator.class.getName();\n+\n+    @Inject\n+    private EventPublisher eventPublisher;\n+\n+    private long clusterId;\n+\n+    @Override\n+    public void setContext(EvaluatorContext context) {\n+        clusterId = (long) context.getData();\n+    }\n+\n+    @Override\n+    @Nonnull\n+    public EvaluatorContext getContext() {\n+        return new ClusterIdEvaluatorContext(clusterId);\n+    }\n+\n+    @Override\n+    public String getName() {\n+        return EVALUATOR_NAME;\n+    }\n+\n+    @Override\n+    public void execute() {\n+        eventPublisher.publishEvent(new UpdateFailedEvent(clusterId));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03f0a153aa7bd1856f3e256b7efdbedbfb68628d"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU3OTUwMw==", "bodyText": "Accidental change? or should this be test. Also other places where this change is made.", "url": "https://github.com/hortonworks/cloudbreak/pull/8149#discussion_r429579503", "createdAt": "2020-05-23T21:26:04Z", "author": {"login": "sidseth"}, "path": "autoscale/src/test/java/com/sequenceiq/periscope/modul/rejected/RejectedThreadContext.java", "diffHunk": "@@ -59,6 +60,7 @@\n     @MockBean({Clock.class, ClusterService.class, CloudbreakClientConfiguration.class,\n             MetricUtils.class, InternalCrnBuilder.class, FailedNodeRepository.class})\n     @EnableAsync\n+    @Profile(\"dev\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03f0a153aa7bd1856f3e256b7efdbedbfb68628d"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU3OTU0OA==", "bodyText": "What should this be?", "url": "https://github.com/hortonworks/cloudbreak/pull/8149#discussion_r429579548", "createdAt": "2020-05-23T21:27:13Z", "author": {"login": "sidseth"}, "path": "autoscale/src/test/java/com/sequenceiq/periscope/testcontext/EndpointTestContext.java", "diffHunk": "@@ -0,0 +1,16 @@\n+package com.sequenceiq.periscope.testcontext;\n+\n+import org.springframework.boot.autoconfigure.domain.EntityScan;\n+import org.springframework.boot.test.context.TestConfiguration;\n+import org.springframework.boot.test.mock.mockito.MockBean;\n+import org.springframework.context.annotation.Profile;\n+\n+import com.sequenceiq.cloudbreak.service.secret.service.SecretService;\n+\n+@TestConfiguration\n+@EntityScan(basePackages = {\"com.sequenceiq.periscope\"})\n+@Profile(\"test\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03f0a153aa7bd1856f3e256b7efdbedbfb68628d"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU3OTU2NQ==", "bodyText": "Names changes to DATAHUB_ instead of CDP_", "url": "https://github.com/hortonworks/cloudbreak/pull/8149#discussion_r429579565", "createdAt": "2020-05-23T21:27:31Z", "author": {"login": "sidseth"}, "path": "autoscale/src/main/java/com/sequenceiq/periscope/service/EntitlementValidationService.java", "diffHunk": "@@ -0,0 +1,44 @@\n+package com.sequenceiq.periscope.service;\n+\n+import java.util.Map;\n+import java.util.Optional;\n+\n+import javax.inject.Inject;\n+\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.cache.annotation.Cacheable;\n+import org.springframework.stereotype.Service;\n+\n+import com.sequenceiq.cloudbreak.auth.altus.EntitlementService;\n+\n+@Service\n+public class EntitlementValidationService {\n+\n+    private static final String ALLOWED = \"ALLOWED_PLATFORM\";\n+\n+    private static final Map<String, String> PLATFORM_ENTITLEMENTS = Map.of(\n+            \"AWS\", \"CDP_AWS_AUTOSCALING\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03f0a153aa7bd1856f3e256b7efdbedbfb68628d"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bcbc0eb1bcea351df8c41b3e8709fa5fedcea5a8", "author": {"user": {"login": "smaniraju", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/bcbc0eb1bcea351df8c41b3e8709fa5fedcea5a8", "committedDate": "2020-05-25T08:34:40Z", "message": "DISTX-399 Service Endpoint Tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "03f0a153aa7bd1856f3e256b7efdbedbfb68628d", "author": {"user": {"login": "smaniraju", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/03f0a153aa7bd1856f3e256b7efdbedbfb68628d", "committedDate": "2020-05-23T16:22:13Z", "message": "DISTX-399 Service Endpoint Tests"}, "afterCommit": {"oid": "bcbc0eb1bcea351df8c41b3e8709fa5fedcea5a8", "author": {"user": {"login": "smaniraju", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/bcbc0eb1bcea351df8c41b3e8709fa5fedcea5a8", "committedDate": "2020-05-25T08:34:40Z", "message": "DISTX-399 Service Endpoint Tests"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1750, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}