{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc2NTI2MDAz", "number": 7312, "title": "CB-5546 Mock integration tests for parent-child environment relation", "bodyText": "CB-5546\nMock integration tests for parent-child environment relation", "createdAt": "2020-02-18T10:09:27Z", "url": "https://github.com/hortonworks/cloudbreak/pull/7312", "merged": true, "mergeCommit": {"oid": "9da4ef28af8940fa183625bd4092b183c5c20c21"}, "closed": true, "closedAt": "2020-02-27T16:07:50Z", "author": {"login": "pkedvessy"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcFfKA_ABqjMwNDY0OTgxNzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcIGWh_gFqTM2NDg3NzY1Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9d2b58c301759a270bdc8c3736944a660a89fda7", "author": {"user": {"login": "pkedvessy", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/9d2b58c301759a270bdc8c3736944a660a89fda7", "committedDate": "2020-02-18T10:06:36Z", "message": "CB-5546 Environment service mock tests to validate parent-child related operations"}, "afterCommit": {"oid": "654a4e2c929e5c48a265ee2acadfee55988a7648", "author": {"user": {"login": "pkedvessy", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/654a4e2c929e5c48a265ee2acadfee55988a7648", "committedDate": "2020-02-18T10:13:13Z", "message": "CB-5546 Environment service mock tests to validate parent-child related operations"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "654a4e2c929e5c48a265ee2acadfee55988a7648", "author": {"user": {"login": "pkedvessy", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/654a4e2c929e5c48a265ee2acadfee55988a7648", "committedDate": "2020-02-18T10:13:13Z", "message": "CB-5546 Environment service mock tests to validate parent-child related operations"}, "afterCommit": {"oid": "d6f7de7c897fdfcdc40a0035c61839fcc637d4d7", "author": {"user": {"login": "pkedvessy", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/d6f7de7c897fdfcdc40a0035c61839fcc637d4d7", "committedDate": "2020-02-18T10:14:44Z", "message": "CB-5546 Environment service mock tests to validate parent-child related operations"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d6f7de7c897fdfcdc40a0035c61839fcc637d4d7", "author": {"user": {"login": "pkedvessy", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/d6f7de7c897fdfcdc40a0035c61839fcc637d4d7", "committedDate": "2020-02-18T10:14:44Z", "message": "CB-5546 Environment service mock tests to validate parent-child related operations"}, "afterCommit": {"oid": "fdc434f38c7eff803caf14c4ddd497b2495af4eb", "author": {"user": {"login": "pkedvessy", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/fdc434f38c7eff803caf14c4ddd497b2495af4eb", "committedDate": "2020-02-18T11:39:58Z", "message": "CB-5546 Environment service mock tests to validate parent-child related operations"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fdc434f38c7eff803caf14c4ddd497b2495af4eb", "author": {"user": {"login": "pkedvessy", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/fdc434f38c7eff803caf14c4ddd497b2495af4eb", "committedDate": "2020-02-18T11:39:58Z", "message": "CB-5546 Environment service mock tests to validate parent-child related operations"}, "afterCommit": {"oid": "99b3873dac159241c6ea5c669bc7ffa52b366a6f", "author": {"user": {"login": "pkedvessy", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/99b3873dac159241c6ea5c669bc7ffa52b366a6f", "committedDate": "2020-02-19T08:45:00Z", "message": "CB-5546 Environment service mock tests to validate parent-child related operations"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxMDk4MDE1", "url": "https://github.com/hortonworks/cloudbreak/pull/7312#pullrequestreview-361098015", "createdAt": "2020-02-19T13:14:21Z", "commit": {"oid": "99b3873dac159241c6ea5c669bc7ffa52b366a6f"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxMzoxNDoyMVrOFrnkFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxMzoyMTowNVrOFrnxFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTI4MTMwMA==", "bodyText": "What is the point with this line? If it has a purpose shouldn't it be checked?", "url": "https://github.com/hortonworks/cloudbreak/pull/7312#discussion_r381281300", "createdAt": "2020-02-19T13:14:21Z", "author": {"login": "afarsang"}, "path": "integration-test/src/main/java/com/sequenceiq/it/cloudbreak/testcase/mock/EnvironmentTest.java", "diffHunk": "@@ -157,17 +162,155 @@ public void testWlClusterWithInternalGetRequest(MockedTestContext testContext) {\n                 .validate();\n     }\n \n-    private EnvironmentTestDto checkEnvIsListed(TestContext testContext, EnvironmentTestDto environment, EnvironmentClient environmentClient) {\n+    @Test(dataProvider = TEST_CONTEXT_WITH_MOCK)\n+    @Description(\n+            given = \"there is a running cloudbreak\",\n+            when = \"valid create environment requests are sent to create parent environment first and then a child one\",\n+            then = \"environments should be created and parent environment should be referenced in the child environment\")\n+    public void testCreateParentChildEnvironment(TestContext testContext) {\n+        testContext\n+                .given(CredentialTestDto.class)\n+                .when(credentialTestClient.create())\n+                .given(PARENT_ENVIRONMENT, EnvironmentTestDto.class)\n+                .when(environmentTestClient.create())\n+                .when(environmentTestClient.list())\n+                .then(this::checkEnvIsListedByNameAndParentName)\n+                .await(EnvironmentStatus.AVAILABLE)\n+                .given(CHILD_ENVIRONMENT, EnvironmentTestDto.class)\n+                .withParentEnvironmentName(testContext.get(PARENT_ENVIRONMENT).getName())\n+                .when(environmentTestClient.create())\n+                .when(environmentTestClient.list())\n+                .then(this::checkEnvIsListedByNameAndParentName)\n+                .validate();\n+    }\n+\n+    @Test(dataProvider = TEST_CONTEXT_WITH_MOCK)\n+    @Description(\n+            given = \"there is an available child environment with a referenced available parent environment\",\n+            when = \"child create request is sent but parent environment is a child environment\",\n+            then = \"a BadRequestException should be returned\")\n+    public void testCreateParentChildEnvironmentWhereParentIsAChild(TestContext testContext) {\n+        String forbiddenKey = resourcePropertyProvider().getName();\n+        testContext\n+                .given(CredentialTestDto.class)\n+                .when(credentialTestClient.create())\n+                .given(PARENT_ENVIRONMENT, EnvironmentTestDto.class)\n+                .when(environmentTestClient.create())\n+                .await(EnvironmentStatus.AVAILABLE)\n+                .given(CHILD_ENVIRONMENT, EnvironmentTestDto.class)\n+                .withParentEnvironmentName(testContext.get(PARENT_ENVIRONMENT).getName())\n+                .when(environmentTestClient.create())\n+                .await(EnvironmentStatus.AVAILABLE)\n+                .when(environmentTestClient.list())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99b3873dac159241c6ea5c669bc7ffa52b366a6f"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTI4NDYzMQ==", "bodyText": "it would make sense to implement this method with RunninParameter argument and let the method gain the environment name from the testcontext\nwithParentEnvironmentName(RunningParameter parentEnvKey) {\ngetRequest().setEnvironmentName(resource.get(parentEnvKey.getKey());\n...\nbut it is just nice to have", "url": "https://github.com/hortonworks/cloudbreak/pull/7312#discussion_r381284631", "createdAt": "2020-02-19T13:21:05Z", "author": {"login": "afarsang"}, "path": "integration-test/src/main/java/com/sequenceiq/it/cloudbreak/dto/environment/EnvironmentTestDto.java", "diffHunk": "@@ -202,6 +210,16 @@ public EnvironmentTestDto withS3Guard() {\n         return this;\n     }\n \n+    public EnvironmentTestDto withParentEnvironmentName(String parentEnvironmentName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99b3873dac159241c6ea5c669bc7ffa52b366a6f"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxNzk1MzE5", "url": "https://github.com/hortonworks/cloudbreak/pull/7312#pullrequestreview-361795319", "createdAt": "2020-02-20T10:36:16Z", "commit": {"oid": "40026131a865d88b97167b786f54cb4be659daa2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxMDozNjoxNlrOFsOTWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxMDozNzo1NVrOFsOWwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTkxNTk5Mg==", "bodyText": "Are these changes necessary? Seems unrelated", "url": "https://github.com/hortonworks/cloudbreak/pull/7312#discussion_r381915992", "createdAt": "2020-02-20T10:36:16Z", "author": {"login": "afarsang"}, "path": "integration-test/src/main/resources/application.yml", "diffHunk": "@@ -83,8 +83,8 @@ integrationtest:\n             - http://s3.amazonaws.com/dev.hortonworks.com/CFM/centos7/2.x/BUILDS/2.0.0.0-22/tars/parcel/NIFIREGISTRY-0.5.0.2.0.0.0-22.jar\n \n   user:\n-    accessKey: Y3JuOmFsdHVzOmlhbTp1cy13ZXN0LTE6Y2xvdWRlcmE6dXNlcjptb2NrdXNlcg==\n-    secretKey: nHkdxgZR0BaNHaSYM3ooS6rIlpV5E+k1CIkr+jFId2g=\n+    accesskey: Y3JuOmFsdHVzOmlhbTp1cy13ZXN0LTE6Y2xvdWRlcmE6dXNlcjptb2NrdXNlcg==\n+    secretkey: nHkdxgZR0BaNHaSYM3ooS6rIlpV5E+k1CIkr+jFId2g=", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40026131a865d88b97167b786f54cb4be659daa2"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTkxNjg2NQ==", "bodyText": "As I recall we planned to check freeipa mock calls as well, don't we?", "url": "https://github.com/hortonworks/cloudbreak/pull/7312#discussion_r381916865", "createdAt": "2020-02-20T10:37:55Z", "author": {"login": "afarsang"}, "path": "integration-test/src/main/java/com/sequenceiq/it/cloudbreak/testcase/mock/FreeIpaAttachChildEnvironmentTest.java", "diffHunk": "@@ -0,0 +1,70 @@\n+package com.sequenceiq.it.cloudbreak.testcase.mock;\n+\n+import javax.inject.Inject;\n+\n+import org.testng.annotations.Test;\n+\n+import com.sequenceiq.environment.api.v1.environment.model.response.EnvironmentStatus;\n+import com.sequenceiq.freeipa.api.v1.freeipa.stack.model.common.Status;\n+import com.sequenceiq.it.cloudbreak.assertion.freeipa.FreeIpaChildEnvironmentAssertion;\n+import com.sequenceiq.it.cloudbreak.client.CredentialTestClient;\n+import com.sequenceiq.it.cloudbreak.client.EnvironmentTestClient;\n+import com.sequenceiq.it.cloudbreak.client.FreeIPATestClient;\n+import com.sequenceiq.it.cloudbreak.context.Description;\n+import com.sequenceiq.it.cloudbreak.context.MockedTestContext;\n+import com.sequenceiq.it.cloudbreak.context.TestContext;\n+import com.sequenceiq.it.cloudbreak.dto.environment.EnvironmentTestDto;\n+import com.sequenceiq.it.cloudbreak.dto.freeipa.FreeIPAChildEnvironmentTestDto;\n+import com.sequenceiq.it.cloudbreak.dto.freeipa.FreeIPATestDto;\n+import com.sequenceiq.it.cloudbreak.mock.ITResponse;\n+import com.sequenceiq.it.cloudbreak.mock.freeipa.FreeIpaRouteHandler;\n+import com.sequenceiq.it.cloudbreak.spark.DynamicRouteStack;\n+import com.sequenceiq.it.cloudbreak.testcase.AbstractIntegrationTest;\n+\n+public class FreeIpaAttachChildEnvironmentTest extends AbstractIntegrationTest {\n+\n+    @Inject\n+    private FreeIPATestClient freeIPATestClient;\n+\n+    @Inject\n+    private CredentialTestClient credentialTestClient;\n+\n+    @Inject\n+    private EnvironmentTestClient environmentTestClient;\n+\n+    @Inject\n+    private FreeIpaRouteHandler freeIpaRouteHandler;\n+\n+    protected void setupTest(TestContext testContext) {\n+        createDefaultUser(testContext);\n+        createDefaultCredential(testContext);\n+        createDefaultEnvironmentWithNetwork(testContext);\n+        createDefaultImageCatalog(testContext);\n+        initializeDefaultBlueprints(testContext);\n+    }\n+\n+    @Test(dataProvider = TEST_CONTEXT_WITH_MOCK)\n+    @Description(\n+            given = \"environment is present\",\n+            when = \"calling a freeipa attach child environment\",\n+            then = \"freeipa should be available with kerberos and ldap config\")\n+    public void testAttachChildEnvironment(MockedTestContext testContext) {\n+        DynamicRouteStack dynamicRouteStack = testContext.getModel().getClouderaManagerMock().getDynamicRouteStack();\n+        dynamicRouteStack.post(ITResponse.FREEIPA_ROOT + \"/session/login_password\", (request, response) -> {\n+            response.cookie(\"ipa_session\", \"dummysession\");\n+            return \"\";\n+        });\n+        dynamicRouteStack.post(ITResponse.FREEIPA_ROOT + \"/session/json\", freeIpaRouteHandler);\n+        testContext\n+                .given(FreeIPATestDto.class).withCatalog(testContext.getImageCatalogMockServerSetup().getFreeIpaImageCatalogUrl())\n+                .when(freeIPATestClient.create())\n+                .await(Status.AVAILABLE)\n+                .given(FreeIPAChildEnvironmentTestDto.CHILD_ENVIRONMENT_KEY, EnvironmentTestDto.class).withCreateFreeIpa(false)\n+                .when(environmentTestClient.create())\n+                .await(EnvironmentStatus.AVAILABLE)\n+                .given(FreeIPAChildEnvironmentTestDto.class)\n+                .when(freeIPATestClient.attachChildEnvironment())\n+                .then(FreeIpaChildEnvironmentAssertion.validate())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40026131a865d88b97167b786f54cb4be659daa2"}, "originalPosition": 67}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2cee46e3863925f7789187d1779804599a489803", "author": {"user": {"login": "Bajzathd", "name": "Bajz\u00e1th D\u00e1vid"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/2cee46e3863925f7789187d1779804599a489803", "committedDate": "2020-02-21T10:25:15Z", "message": "CB-5546 Add mock FreeIpa child environment delete tests"}, "afterCommit": {"oid": "9cb0a0650c770679f2a1eb1ffa37cd6d7d2b3b5e", "author": {"user": {"login": "Bajzathd", "name": "Bajz\u00e1th D\u00e1vid"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/9cb0a0650c770679f2a1eb1ffa37cd6d7d2b3b5e", "committedDate": "2020-02-21T10:26:47Z", "message": "CB-5546 Add mock FreeIpa child environment delete tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d7b9a4f01ebbf8fb8ddd2b7b9fac4121b0fd8adf", "author": {"user": {"login": "Bajzathd", "name": "Bajz\u00e1th D\u00e1vid"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/d7b9a4f01ebbf8fb8ddd2b7b9fac4121b0fd8adf", "committedDate": "2020-02-21T14:46:58Z", "message": "CB-5546 Add FreeIpa tests to their suite"}, "afterCommit": {"oid": "f46119ed893f347d320a02f8af12d9c2bfc72bea", "author": {"user": {"login": "Bajzathd", "name": "Bajz\u00e1th D\u00e1vid"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/f46119ed893f347d320a02f8af12d9c2bfc72bea", "committedDate": "2020-02-24T13:46:41Z", "message": "CB-5546 Add FreeIpa tests to their suite"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "411a09d136c27c397c94de376be6c49fa5f12a2b", "author": {"user": {"login": "Bajzathd", "name": "Bajz\u00e1th D\u00e1vid"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/411a09d136c27c397c94de376be6c49fa5f12a2b", "committedDate": "2020-02-25T13:32:16Z", "message": "CB-5546 Add reverse DNS zone test, refactor child env test"}, "afterCommit": {"oid": "03f7d7893cf15954b39e2592cb3de3ed47f2948a", "author": {"user": {"login": "Bajzathd", "name": "Bajz\u00e1th D\u00e1vid"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/03f7d7893cf15954b39e2592cb3de3ed47f2948a", "committedDate": "2020-02-25T13:33:48Z", "message": "CB-5546 Add reverse DNS zone test, refactor child env test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56f45fdd63b6cb3ee4219db6242dbdd1d366e43f", "author": {"user": {"login": "pkedvessy", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/56f45fdd63b6cb3ee4219db6242dbdd1d366e43f", "committedDate": "2020-02-25T16:00:01Z", "message": "CB-5546 Environment service mock tests to validate parent-child related operations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1288a691338e47fae7488d725f375eb7ba5e0f97", "author": {"user": {"login": "pkedvessy", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/1288a691338e47fae7488d725f375eb7ba5e0f97", "committedDate": "2020-02-25T16:00:01Z", "message": "CB-5546 Implement review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d8e7ca89a46f61f71b45a87af04d740be7b74fc", "author": {"user": {"login": "Bajzathd", "name": "Bajz\u00e1th D\u00e1vid"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/1d8e7ca89a46f61f71b45a87af04d740be7b74fc", "committedDate": "2020-02-25T16:00:01Z", "message": "CB-5546 Add mock FreeIpa AttachChildEnvironment test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d87b43a0e3e232a06a0a957a12fbec163086c47", "author": {"user": {"login": "Bajzathd", "name": "Bajz\u00e1th D\u00e1vid"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/8d87b43a0e3e232a06a0a957a12fbec163086c47", "committedDate": "2020-02-25T16:00:01Z", "message": "CB-5546 Add mock FreeIpa child environment delete tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f0352e186110c46134edc0c59c821b1f06bf6a6", "author": {"user": {"login": "Bajzathd", "name": "Bajz\u00e1th D\u00e1vid"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/7f0352e186110c46134edc0c59c821b1f06bf6a6", "committedDate": "2020-02-25T16:00:01Z", "message": "CB-5546 Clean up attach/detach child env tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54941fa5ae263899a6637df5c0d0403f52df5e45", "author": {"user": {"login": "Bajzathd", "name": "Bajz\u00e1th D\u00e1vid"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/54941fa5ae263899a6637df5c0d0403f52df5e45", "committedDate": "2020-02-25T16:00:01Z", "message": "CB-5546 Add FreeIpa tests to their suite"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "748b8ea1fba5c4e5ed16a3267cbfbb50d3da5f41", "author": {"user": {"login": "Bajzathd", "name": "Bajz\u00e1th D\u00e1vid"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/748b8ea1fba5c4e5ed16a3267cbfbb50d3da5f41", "committedDate": "2020-02-25T16:00:01Z", "message": "CB-5546 Initialize freeipa response in IT"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "778fdacffd5592740c4e27350d9c245b4fe2513f", "author": {"user": {"login": "Bajzathd", "name": "Bajz\u00e1th D\u00e1vid"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/778fdacffd5592740c4e27350d9c245b4fe2513f", "committedDate": "2020-02-25T16:00:01Z", "message": "CB-5546 Add reverse DNS zone test, refactor child env test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "03f7d7893cf15954b39e2592cb3de3ed47f2948a", "author": {"user": {"login": "Bajzathd", "name": "Bajz\u00e1th D\u00e1vid"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/03f7d7893cf15954b39e2592cb3de3ed47f2948a", "committedDate": "2020-02-25T13:33:48Z", "message": "CB-5546 Add reverse DNS zone test, refactor child env test"}, "afterCommit": {"oid": "778fdacffd5592740c4e27350d9c245b4fe2513f", "author": {"user": {"login": "Bajzathd", "name": "Bajz\u00e1th D\u00e1vid"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/778fdacffd5592740c4e27350d9c245b4fe2513f", "committedDate": "2020-02-25T16:00:01Z", "message": "CB-5546 Add reverse DNS zone test, refactor child env test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0Nzc0NDc0", "url": "https://github.com/hortonworks/cloudbreak/pull/7312#pullrequestreview-364774474", "createdAt": "2020-02-26T10:14:47Z", "commit": {"oid": "778fdacffd5592740c4e27350d9c245b4fe2513f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0NzgzOTA2", "url": "https://github.com/hortonworks/cloudbreak/pull/7312#pullrequestreview-364783906", "createdAt": "2020-02-26T10:28:15Z", "commit": {"oid": "778fdacffd5592740c4e27350d9c245b4fe2513f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxMDoyODoxNVrOFumG6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxMDoyODoxNVrOFumG6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQwMzE3OQ==", "bodyText": "Although it is working, this is not the way what we use to follow in our mock tests. We are using a httpmock (for FreeIPA as well), and we are use to seek the http mock calls for validation. You can see examples in DistroXClusterCreationTest", "url": "https://github.com/hortonworks/cloudbreak/pull/7312#discussion_r384403179", "createdAt": "2020-02-26T10:28:15Z", "author": {"login": "afarsang"}, "path": "integration-test/src/main/java/com/sequenceiq/it/cloudbreak/testcase/mock/EnvironmentChildTest.java", "diffHunk": "@@ -0,0 +1,180 @@\n+package com.sequenceiq.it.cloudbreak.testcase.mock;\n+\n+import static java.util.Objects.isNull;\n+import static org.mockito.ArgumentMatchers.any;\n+\n+import java.util.Collection;\n+\n+import javax.inject.Inject;\n+import javax.ws.rs.BadRequestException;\n+\n+import org.mockito.Mockito;\n+import org.testng.annotations.Test;\n+\n+import com.sequenceiq.environment.api.v1.environment.model.response.EnvironmentStatus;\n+import com.sequenceiq.environment.api.v1.environment.model.response.SimpleEnvironmentResponse;\n+import com.sequenceiq.it.cloudbreak.EnvironmentClient;\n+import com.sequenceiq.it.cloudbreak.client.EnvironmentTestClient;\n+import com.sequenceiq.it.cloudbreak.context.Description;\n+import com.sequenceiq.it.cloudbreak.context.MockedTestContext;\n+import com.sequenceiq.it.cloudbreak.context.RunningParameter;\n+import com.sequenceiq.it.cloudbreak.context.TestContext;\n+import com.sequenceiq.it.cloudbreak.dto.environment.EnvironmentTestDto;\n+import com.sequenceiq.it.cloudbreak.exception.TestFailException;\n+import com.sequenceiq.it.cloudbreak.mock.freeipa.AbstractFreeIpaResponse;\n+import com.sequenceiq.it.cloudbreak.testcase.AbstractIntegrationTest;\n+\n+public class EnvironmentChildTest extends AbstractIntegrationTest {\n+\n+    private static final String PARENT_ENVIRONMENT = \"parent\";\n+\n+    private static final String CHILD_ENVIRONMENT = \"child\";\n+\n+    @Inject\n+    private EnvironmentTestClient environmentTestClient;\n+\n+    @Override\n+    protected void setupTest(TestContext testContext) {\n+        createDefaultUser(testContext);\n+        initializeDefaultBlueprints(testContext);\n+        createDefaultCredential(testContext);\n+        createDefaultEnvironmentWithNetwork(testContext);\n+        createDefaultFreeIPA(testContext);\n+    }\n+\n+    @Test(dataProvider = TEST_CONTEXT_WITH_MOCK)\n+    @Description(\n+            given = \"there is an available parent environment\",\n+            when = \"valid create child environment request is sent\",\n+            then = \"environment should be created and parent environment should be referenced in the child environment\")\n+    public void testCreateChildEnvironment(MockedTestContext testContext) {\n+        AbstractFreeIpaResponse<?> dnsZoneAddResponse = Mockito.mock(AbstractFreeIpaResponse.class);\n+        getFreeIpaRouteHandler().updateResponse(\"dnszone_add\", dnsZoneAddResponse);\n+\n+        testContext\n+                .given(EnvironmentTestDto.class)\n+                .when(environmentTestClient.list())\n+                .then(this::checkEnvIsListedByNameAndParentName)\n+                .given(CHILD_ENVIRONMENT, EnvironmentTestDto.class)\n+                    .withParentEnvironment()\n+                .when(environmentTestClient.create())\n+                .await(EnvironmentStatus.AVAILABLE)\n+                .when(environmentTestClient.list())\n+                .then(this::checkEnvIsListedByNameAndParentName)\n+                .then((testContext1, testDto, client) -> {\n+                    Mockito.verify(dnsZoneAddResponse).handle(any(), any());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "778fdacffd5592740c4e27350d9c245b4fe2513f"}, "originalPosition": 65}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd8fa50ba592c3c00f6b2579c507b886b14fb9b9", "author": {"user": {"login": "Bajzathd", "name": "Bajz\u00e1th D\u00e1vid"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/dd8fa50ba592c3c00f6b2579c507b886b14fb9b9", "committedDate": "2020-02-26T12:35:55Z", "message": "CB-5546 Refactor freeipa request verification"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0ODc3NjU2", "url": "https://github.com/hortonworks/cloudbreak/pull/7312#pullrequestreview-364877656", "createdAt": "2020-02-26T13:01:31Z", "commit": {"oid": "dd8fa50ba592c3c00f6b2579c507b886b14fb9b9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1882, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}