{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA1MzIyMTU3", "number": 9232, "reviewThreads": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxOTozMDozMlrOE6Lu1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQxNzozMDoyNFrOFDmLWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDQ1MDc4OnYy", "diffSide": "RIGHT", "path": "orchestrator-salt/src/main/resources/salt/salt/metadata/init.sls", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxOTozMDozMlrOH1Fx5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxOTo0MjozOFrOH1Gi8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQzMTI3MA==", "bodyText": "What happens if the hostattrs are empty? As part of an upgrade we upgrade the salt states and pillar as well, but they won't have any attributes.", "url": "https://github.com/hortonworks/cloudbreak/pull/9232#discussion_r525431270", "createdAt": "2020-11-17T19:30:32Z", "author": {"login": "keyki"}, "path": "orchestrator-salt/src/main/resources/salt/salt/metadata/init.sls", "diffHunk": "@@ -9,4 +9,11 @@ cluster_metadata:\n     - name: /opt/metadata/cluster.json\n     - dataset:\n         {{ metadata }}\n+    - formatter: json\n+\n+node_attributes:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e322a1c93e41fd3e42a2fb97de3b239710bf60d"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQ0MzgyNg==", "bodyText": "https://jira.cloudera.com/browse/CB-8147?focusedCommentId=4095583&page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-4095583\nhas the output in case there are no attributes defined. This isn't specifically for upgrades, but I'd expect an upgraded CB with this change to exercise the same code path and write out empty attributes.", "url": "https://github.com/hortonworks/cloudbreak/pull/9232#discussion_r525443826", "createdAt": "2020-11-17T19:42:38Z", "author": {"login": "sidseth"}, "path": "orchestrator-salt/src/main/resources/salt/salt/metadata/init.sls", "diffHunk": "@@ -9,4 +9,11 @@ cluster_metadata:\n     - name: /opt/metadata/cluster.json\n     - dataset:\n         {{ metadata }}\n+    - formatter: json\n+\n+node_attributes:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQzMTI3MA=="}, "originalCommit": {"oid": "5e322a1c93e41fd3e42a2fb97de3b239710bf60d"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwODU1OTA2OnYy", "diffSide": "RIGHT", "path": "orchestrator-api/src/main/java/com/sequenceiq/cloudbreak/orchestrator/model/Node.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMjo1Mjo1OVrOH3Ogzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMVQwNzoyMDozNFrOH3plBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY3MTUwMg==", "bodyText": "I don't think Node should contain this attributes map. It's used only to create a pillar. The main purpose of this class is to pass these data to SaltBootstrap installed on the instances to configure them.\nInstead of adding this info to the node you could calculate it when it's need in ClusterHostServiceRunner", "url": "https://github.com/hortonworks/cloudbreak/pull/9232#discussion_r527671502", "createdAt": "2020-11-20T12:52:59Z", "author": {"login": "lacikaaa"}, "path": "orchestrator-api/src/main/java/com/sequenceiq/cloudbreak/orchestrator/model/Node.java", "diffHunk": "@@ -23,19 +25,33 @@\n \n     private String uuids;\n \n+    // Used for generic attributes associated with the node. e.g. YARN attributes when running NMs, Spot vs non-spot, etc\n+    private Map<String, Map<String, String>> attributes;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e322a1c93e41fd3e42a2fb97de3b239710bf60d"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODExNDk0OQ==", "bodyText": "Will look into this as an option.", "url": "https://github.com/hortonworks/cloudbreak/pull/9232#discussion_r528114949", "createdAt": "2020-11-21T07:20:34Z", "author": {"login": "sidseth"}, "path": "orchestrator-api/src/main/java/com/sequenceiq/cloudbreak/orchestrator/model/Node.java", "diffHunk": "@@ -23,19 +25,33 @@\n \n     private String uuids;\n \n+    // Used for generic attributes associated with the node. e.g. YARN attributes when running NMs, Spot vs non-spot, etc\n+    private Map<String, Map<String, String>> attributes;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY3MTUwMg=="}, "originalCommit": {"oid": "5e322a1c93e41fd3e42a2fb97de3b239710bf60d"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwODYxMDE3OnYy", "diffSide": "RIGHT", "path": "template-manager-cmtemplate/src/main/java/com/sequenceiq/cloudbreak/cmtemplate/CmTemplateProcessor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMzowODoyN1rOH3O_HA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMVQwNzoyMToyN1rOH3pnRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY3OTI2MA==", "bodyText": "it would be nicer with stream:\nMap<String, Set<ServiceComponent>> hgToNonGwServiceComponentsWithYarnNMs = hgToNonGwServiceComponents.entrySet().stream()\n                .filter(this::isYarnNodemanager)\n                .collect(toMap(Entry::getKey, Entry::getValue));\n\nprivate boolean isYarnNodemanager(Entry<String, Set<ServiceComponent>> entry) {\n        return entry.getValue().stream().anyMatch(sc -> YarnRoles.YARN.equalsIgnoreCase(sc.getService())\n                && YarnRoles.NODEMANAGER.equalsIgnoreCase(sc.getComponent()));\n    }", "url": "https://github.com/hortonworks/cloudbreak/pull/9232#discussion_r527679260", "createdAt": "2020-11-20T13:08:27Z", "author": {"login": "lacikaaa"}, "path": "template-manager-cmtemplate/src/main/java/com/sequenceiq/cloudbreak/cmtemplate/CmTemplateProcessor.java", "diffHunk": "@@ -291,6 +311,52 @@ public String getStackVersion() {\n         return cmTemplate.getCdhVersion();\n     }\n \n+    @Override\n+    public Map<String, Map<String, ServiceAttributes>> getHostGroupBasedServiceAttributes() {\n+        // The only attributes required at the moment relate to the YARN NodeManager.\n+        // This functionality can be moved to an interface / separated if additional components\n+        // need this functionality.\n+        Map<String, Set<ServiceComponent>> hgToNonGwServiceComponents = getNonGatewayServicesByHostGroup();\n+        Map<String, Set<ServiceComponent>> hgToNonGwServiceComponentsWithYarnNMs = new HashMap<>();\n+        for (Entry<String, Set<ServiceComponent>> entry : hgToNonGwServiceComponents.entrySet()) {\n+            for (ServiceComponent sc : entry.getValue()) {\n+                if (sc.getService().equalsIgnoreCase(YarnRoles.YARN) && sc.getComponent()\n+                        .equalsIgnoreCase(YarnRoles.NODEMANAGER)) {\n+                    hgToNonGwServiceComponentsWithYarnNMs.put(entry.getKey(), entry.getValue());\n+                    break;\n+                }\n+            }\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e322a1c93e41fd3e42a2fb97de3b239710bf60d"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODExNTUyNw==", "bodyText": "I don't like using Java streams (not as easy to read). If that's the pattern that is generally used, I can switch it over. (Applies to other comments related to streams)", "url": "https://github.com/hortonworks/cloudbreak/pull/9232#discussion_r528115527", "createdAt": "2020-11-21T07:21:27Z", "author": {"login": "sidseth"}, "path": "template-manager-cmtemplate/src/main/java/com/sequenceiq/cloudbreak/cmtemplate/CmTemplateProcessor.java", "diffHunk": "@@ -291,6 +311,52 @@ public String getStackVersion() {\n         return cmTemplate.getCdhVersion();\n     }\n \n+    @Override\n+    public Map<String, Map<String, ServiceAttributes>> getHostGroupBasedServiceAttributes() {\n+        // The only attributes required at the moment relate to the YARN NodeManager.\n+        // This functionality can be moved to an interface / separated if additional components\n+        // need this functionality.\n+        Map<String, Set<ServiceComponent>> hgToNonGwServiceComponents = getNonGatewayServicesByHostGroup();\n+        Map<String, Set<ServiceComponent>> hgToNonGwServiceComponentsWithYarnNMs = new HashMap<>();\n+        for (Entry<String, Set<ServiceComponent>> entry : hgToNonGwServiceComponents.entrySet()) {\n+            for (ServiceComponent sc : entry.getValue()) {\n+                if (sc.getService().equalsIgnoreCase(YarnRoles.YARN) && sc.getComponent()\n+                        .equalsIgnoreCase(YarnRoles.NODEMANAGER)) {\n+                    hgToNonGwServiceComponentsWithYarnNMs.put(entry.getKey(), entry.getValue());\n+                    break;\n+                }\n+            }\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY3OTI2MA=="}, "originalCommit": {"oid": "5e322a1c93e41fd3e42a2fb97de3b239710bf60d"}, "originalPosition": 82}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwODYxMTE0OnYy", "diffSide": "RIGHT", "path": "template-manager-cmtemplate/src/main/java/com/sequenceiq/cloudbreak/cmtemplate/CmTemplateProcessor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMzowODo0NlrOH3O_tg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMVQwNzoyMjowMFrOH3po2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY3OTQxNA==", "bodyText": "doesn't seem relevant, could you drop these?", "url": "https://github.com/hortonworks/cloudbreak/pull/9232#discussion_r527679414", "createdAt": "2020-11-20T13:08:46Z", "author": {"login": "lacikaaa"}, "path": "template-manager-cmtemplate/src/main/java/com/sequenceiq/cloudbreak/cmtemplate/CmTemplateProcessor.java", "diffHunk": "@@ -291,6 +311,52 @@ public String getStackVersion() {\n         return cmTemplate.getCdhVersion();\n     }\n \n+    @Override\n+    public Map<String, Map<String, ServiceAttributes>> getHostGroupBasedServiceAttributes() {\n+        // The only attributes required at the moment relate to the YARN NodeManager.\n+        // This functionality can be moved to an interface / separated if additional components\n+        // need this functionality.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e322a1c93e41fd3e42a2fb97de3b239710bf60d"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODExNTkzMQ==", "bodyText": "Sure. This was a comment to indicate potential future changes.", "url": "https://github.com/hortonworks/cloudbreak/pull/9232#discussion_r528115931", "createdAt": "2020-11-21T07:22:00Z", "author": {"login": "sidseth"}, "path": "template-manager-cmtemplate/src/main/java/com/sequenceiq/cloudbreak/cmtemplate/CmTemplateProcessor.java", "diffHunk": "@@ -291,6 +311,52 @@ public String getStackVersion() {\n         return cmTemplate.getCdhVersion();\n     }\n \n+    @Override\n+    public Map<String, Map<String, ServiceAttributes>> getHostGroupBasedServiceAttributes() {\n+        // The only attributes required at the moment relate to the YARN NodeManager.\n+        // This functionality can be moved to an interface / separated if additional components\n+        // need this functionality.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY3OTQxNA=="}, "originalCommit": {"oid": "5e322a1c93e41fd3e42a2fb97de3b239710bf60d"}, "originalPosition": 71}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwODYxOTUyOnYy", "diffSide": "RIGHT", "path": "template-manager-cmtemplate/src/main/java/com/sequenceiq/cloudbreak/cmtemplate/CmTemplateProcessor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMzoxMToxM1rOH3PEtA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMzoxMToxM1rOH3PEtA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY4MDY5Mg==", "bodyText": "this part should be moved out and named in a separate method", "url": "https://github.com/hortonworks/cloudbreak/pull/9232#discussion_r527680692", "createdAt": "2020-11-20T13:11:13Z", "author": {"login": "lacikaaa"}, "path": "template-manager-cmtemplate/src/main/java/com/sequenceiq/cloudbreak/cmtemplate/CmTemplateProcessor.java", "diffHunk": "@@ -291,6 +311,52 @@ public String getStackVersion() {\n         return cmTemplate.getCdhVersion();\n     }\n \n+    @Override\n+    public Map<String, Map<String, ServiceAttributes>> getHostGroupBasedServiceAttributes() {\n+        // The only attributes required at the moment relate to the YARN NodeManager.\n+        // This functionality can be moved to an interface / separated if additional components\n+        // need this functionality.\n+        Map<String, Set<ServiceComponent>> hgToNonGwServiceComponents = getNonGatewayServicesByHostGroup();\n+        Map<String, Set<ServiceComponent>> hgToNonGwServiceComponentsWithYarnNMs = new HashMap<>();\n+        for (Entry<String, Set<ServiceComponent>> entry : hgToNonGwServiceComponents.entrySet()) {\n+            for (ServiceComponent sc : entry.getValue()) {\n+                if (sc.getService().equalsIgnoreCase(YarnRoles.YARN) && sc.getComponent()\n+                        .equalsIgnoreCase(YarnRoles.NODEMANAGER)) {\n+                    hgToNonGwServiceComponentsWithYarnNMs.put(entry.getKey(), entry.getValue());\n+                    break;\n+                }\n+            }\n+        }\n+        // We have the hostGroups without GATEWAY components with YARN NodeManagers\n+        Map<String, Set<String>> componentsByHostGroup = hgToNonGwServiceComponentsWithYarnNMs.entrySet()\n+                .stream().collect(\n+                        toMap(\n+                                Entry::getKey,\n+                                e -> e.getValue().stream()\n+                                .map(ServiceComponent::getComponent)\n+                                .collect(Collectors.toUnmodifiableSet())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e322a1c93e41fd3e42a2fb97de3b239710bf60d"}, "originalPosition": 90}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwODYyMjU5OnYy", "diffSide": "RIGHT", "path": "template-manager-cmtemplate/src/main/java/com/sequenceiq/cloudbreak/cmtemplate/CmTemplateProcessor.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMzoxMjoxMFrOH3PGiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxMjozMzoxNVrOH4LgTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY4MTE2MA==", "bodyText": "instead of comment could you use variable and methods name reflecting the same?", "url": "https://github.com/hortonworks/cloudbreak/pull/9232#discussion_r527681160", "createdAt": "2020-11-20T13:12:10Z", "author": {"login": "lacikaaa"}, "path": "template-manager-cmtemplate/src/main/java/com/sequenceiq/cloudbreak/cmtemplate/CmTemplateProcessor.java", "diffHunk": "@@ -291,6 +311,52 @@ public String getStackVersion() {\n         return cmTemplate.getCdhVersion();\n     }\n \n+    @Override\n+    public Map<String, Map<String, ServiceAttributes>> getHostGroupBasedServiceAttributes() {\n+        // The only attributes required at the moment relate to the YARN NodeManager.\n+        // This functionality can be moved to an interface / separated if additional components\n+        // need this functionality.\n+        Map<String, Set<ServiceComponent>> hgToNonGwServiceComponents = getNonGatewayServicesByHostGroup();\n+        Map<String, Set<ServiceComponent>> hgToNonGwServiceComponentsWithYarnNMs = new HashMap<>();\n+        for (Entry<String, Set<ServiceComponent>> entry : hgToNonGwServiceComponents.entrySet()) {\n+            for (ServiceComponent sc : entry.getValue()) {\n+                if (sc.getService().equalsIgnoreCase(YarnRoles.YARN) && sc.getComponent()\n+                        .equalsIgnoreCase(YarnRoles.NODEMANAGER)) {\n+                    hgToNonGwServiceComponentsWithYarnNMs.put(entry.getKey(), entry.getValue());\n+                    break;\n+                }\n+            }\n+        }\n+        // We have the hostGroups without GATEWAY components with YARN NodeManagers", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e322a1c93e41fd3e42a2fb97de3b239710bf60d"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODExNjYyOA==", "bodyText": "Think this is very specific to CB code style? I think comments in the code can be quite helpful.", "url": "https://github.com/hortonworks/cloudbreak/pull/9232#discussion_r528116628", "createdAt": "2020-11-21T07:23:00Z", "author": {"login": "sidseth"}, "path": "template-manager-cmtemplate/src/main/java/com/sequenceiq/cloudbreak/cmtemplate/CmTemplateProcessor.java", "diffHunk": "@@ -291,6 +311,52 @@ public String getStackVersion() {\n         return cmTemplate.getCdhVersion();\n     }\n \n+    @Override\n+    public Map<String, Map<String, ServiceAttributes>> getHostGroupBasedServiceAttributes() {\n+        // The only attributes required at the moment relate to the YARN NodeManager.\n+        // This functionality can be moved to an interface / separated if additional components\n+        // need this functionality.\n+        Map<String, Set<ServiceComponent>> hgToNonGwServiceComponents = getNonGatewayServicesByHostGroup();\n+        Map<String, Set<ServiceComponent>> hgToNonGwServiceComponentsWithYarnNMs = new HashMap<>();\n+        for (Entry<String, Set<ServiceComponent>> entry : hgToNonGwServiceComponents.entrySet()) {\n+            for (ServiceComponent sc : entry.getValue()) {\n+                if (sc.getService().equalsIgnoreCase(YarnRoles.YARN) && sc.getComponent()\n+                        .equalsIgnoreCase(YarnRoles.NODEMANAGER)) {\n+                    hgToNonGwServiceComponentsWithYarnNMs.put(entry.getKey(), entry.getValue());\n+                    break;\n+                }\n+            }\n+        }\n+        // We have the hostGroups without GATEWAY components with YARN NodeManagers", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY4MTE2MA=="}, "originalCommit": {"oid": "5e322a1c93e41fd3e42a2fb97de3b239710bf60d"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY3MDc5Nw==", "bodyText": "comments tends to be outdated, misleading. Usually indicates the code is not \"clean\", doesn't speak for itself which could be improved by refactoring, like breaking into methods with good names, etc\nWe generally avoid them as much as possible and leave comments where it's really necessary.", "url": "https://github.com/hortonworks/cloudbreak/pull/9232#discussion_r528670797", "createdAt": "2020-11-23T12:33:15Z", "author": {"login": "lacikaaa"}, "path": "template-manager-cmtemplate/src/main/java/com/sequenceiq/cloudbreak/cmtemplate/CmTemplateProcessor.java", "diffHunk": "@@ -291,6 +311,52 @@ public String getStackVersion() {\n         return cmTemplate.getCdhVersion();\n     }\n \n+    @Override\n+    public Map<String, Map<String, ServiceAttributes>> getHostGroupBasedServiceAttributes() {\n+        // The only attributes required at the moment relate to the YARN NodeManager.\n+        // This functionality can be moved to an interface / separated if additional components\n+        // need this functionality.\n+        Map<String, Set<ServiceComponent>> hgToNonGwServiceComponents = getNonGatewayServicesByHostGroup();\n+        Map<String, Set<ServiceComponent>> hgToNonGwServiceComponentsWithYarnNMs = new HashMap<>();\n+        for (Entry<String, Set<ServiceComponent>> entry : hgToNonGwServiceComponents.entrySet()) {\n+            for (ServiceComponent sc : entry.getValue()) {\n+                if (sc.getService().equalsIgnoreCase(YarnRoles.YARN) && sc.getComponent()\n+                        .equalsIgnoreCase(YarnRoles.NODEMANAGER)) {\n+                    hgToNonGwServiceComponentsWithYarnNMs.put(entry.getKey(), entry.getValue());\n+                    break;\n+                }\n+            }\n+        }\n+        // We have the hostGroups without GATEWAY components with YARN NodeManagers", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY4MTE2MA=="}, "originalCommit": {"oid": "5e322a1c93e41fd3e42a2fb97de3b239710bf60d"}, "originalPosition": 83}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwODYyOTE0OnYy", "diffSide": "RIGHT", "path": "template-manager-cmtemplate/src/main/java/com/sequenceiq/cloudbreak/cmtemplate/CmTemplateProcessor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMzoxNDoyM1rOH3PKmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwNjoyNzozMFrOH_Cqfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY4MjIwMw==", "bodyText": "this comment also seems unnecessary or I'm missing something", "url": "https://github.com/hortonworks/cloudbreak/pull/9232#discussion_r527682203", "createdAt": "2020-11-20T13:14:23Z", "author": {"login": "lacikaaa"}, "path": "template-manager-cmtemplate/src/main/java/com/sequenceiq/cloudbreak/cmtemplate/CmTemplateProcessor.java", "diffHunk": "@@ -291,6 +311,52 @@ public String getStackVersion() {\n         return cmTemplate.getCdhVersion();\n     }\n \n+    @Override\n+    public Map<String, Map<String, ServiceAttributes>> getHostGroupBasedServiceAttributes() {\n+        // The only attributes required at the moment relate to the YARN NodeManager.\n+        // This functionality can be moved to an interface / separated if additional components\n+        // need this functionality.\n+        Map<String, Set<ServiceComponent>> hgToNonGwServiceComponents = getNonGatewayServicesByHostGroup();\n+        Map<String, Set<ServiceComponent>> hgToNonGwServiceComponentsWithYarnNMs = new HashMap<>();\n+        for (Entry<String, Set<ServiceComponent>> entry : hgToNonGwServiceComponents.entrySet()) {\n+            for (ServiceComponent sc : entry.getValue()) {\n+                if (sc.getService().equalsIgnoreCase(YarnRoles.YARN) && sc.getComponent()\n+                        .equalsIgnoreCase(YarnRoles.NODEMANAGER)) {\n+                    hgToNonGwServiceComponentsWithYarnNMs.put(entry.getKey(), entry.getValue());\n+                    break;\n+                }\n+            }\n+        }\n+        // We have the hostGroups without GATEWAY components with YARN NodeManagers\n+        Map<String, Set<String>> componentsByHostGroup = hgToNonGwServiceComponentsWithYarnNMs.entrySet()\n+                .stream().collect(\n+                        toMap(\n+                                Entry::getKey,\n+                                e -> e.getValue().stream()\n+                                .map(ServiceComponent::getComponent)\n+                                .collect(Collectors.toUnmodifiableSet())\n+                ));\n+        // Re-using the current LoadBasedAutoScaling recommendation along with the above YARN filter.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e322a1c93e41fd3e42a2fb97de3b239710bf60d"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg2NTk4Mg==", "bodyText": "Goign to modify this comment a bit. It is relevant in the sense that determining a node as 'compute' means that it can be AutoScaled, and so it is important to re-use the autoscale recommendation logic.", "url": "https://github.com/hortonworks/cloudbreak/pull/9232#discussion_r535865982", "createdAt": "2020-12-04T06:27:30Z", "author": {"login": "sidseth"}, "path": "template-manager-cmtemplate/src/main/java/com/sequenceiq/cloudbreak/cmtemplate/CmTemplateProcessor.java", "diffHunk": "@@ -291,6 +311,52 @@ public String getStackVersion() {\n         return cmTemplate.getCdhVersion();\n     }\n \n+    @Override\n+    public Map<String, Map<String, ServiceAttributes>> getHostGroupBasedServiceAttributes() {\n+        // The only attributes required at the moment relate to the YARN NodeManager.\n+        // This functionality can be moved to an interface / separated if additional components\n+        // need this functionality.\n+        Map<String, Set<ServiceComponent>> hgToNonGwServiceComponents = getNonGatewayServicesByHostGroup();\n+        Map<String, Set<ServiceComponent>> hgToNonGwServiceComponentsWithYarnNMs = new HashMap<>();\n+        for (Entry<String, Set<ServiceComponent>> entry : hgToNonGwServiceComponents.entrySet()) {\n+            for (ServiceComponent sc : entry.getValue()) {\n+                if (sc.getService().equalsIgnoreCase(YarnRoles.YARN) && sc.getComponent()\n+                        .equalsIgnoreCase(YarnRoles.NODEMANAGER)) {\n+                    hgToNonGwServiceComponentsWithYarnNMs.put(entry.getKey(), entry.getValue());\n+                    break;\n+                }\n+            }\n+        }\n+        // We have the hostGroups without GATEWAY components with YARN NodeManagers\n+        Map<String, Set<String>> componentsByHostGroup = hgToNonGwServiceComponentsWithYarnNMs.entrySet()\n+                .stream().collect(\n+                        toMap(\n+                                Entry::getKey,\n+                                e -> e.getValue().stream()\n+                                .map(ServiceComponent::getComponent)\n+                                .collect(Collectors.toUnmodifiableSet())\n+                ));\n+        // Re-using the current LoadBasedAutoScaling recommendation along with the above YARN filter.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY4MjIwMw=="}, "originalCommit": {"oid": "5e322a1c93e41fd3e42a2fb97de3b239710bf60d"}, "originalPosition": 92}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwODY2MDU0OnYy", "diffSide": "RIGHT", "path": "template-manager-cmtemplate/src/main/java/com/sequenceiq/cloudbreak/cmtemplate/CmTemplateProcessor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMzoyMzozN1rOH3Pdsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMzoyNDo1MFrOH3Pgjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY4NzA5MQ==", "bodyText": "for (String hg : componentsByHostGroup.keySet()) {\n            String instanceType = computeHostGroups.contains(hg) ? YarnConstants.ATTRIBUTE_NODE_INSTANCE_TYPE_COMPUTE\n                    : YarnConstants.ATTRIBUTE_NODE_INSTANCE_TYPE_WORKER;\n            Map<String, ServiceAttributes> m = Collections.singletonMap(YarnRoles.YARN, new ServiceAttributes(ServiceComponent.of(YarnRoles.YARN, YarnRoles.NODEMANAGER),\n                    Collections.singletonMap(YarnConstants.ATTRIBUTE_NAME_NODE_INSTANCE_TYPE, instanceType)));\n            result.put(hg, m);\n        }\n\nseems a bit readable this way and could be moved to a separate method also", "url": "https://github.com/hortonworks/cloudbreak/pull/9232#discussion_r527687091", "createdAt": "2020-11-20T13:23:37Z", "author": {"login": "lacikaaa"}, "path": "template-manager-cmtemplate/src/main/java/com/sequenceiq/cloudbreak/cmtemplate/CmTemplateProcessor.java", "diffHunk": "@@ -291,6 +311,52 @@ public String getStackVersion() {\n         return cmTemplate.getCdhVersion();\n     }\n \n+    @Override\n+    public Map<String, Map<String, ServiceAttributes>> getHostGroupBasedServiceAttributes() {\n+        // The only attributes required at the moment relate to the YARN NodeManager.\n+        // This functionality can be moved to an interface / separated if additional components\n+        // need this functionality.\n+        Map<String, Set<ServiceComponent>> hgToNonGwServiceComponents = getNonGatewayServicesByHostGroup();\n+        Map<String, Set<ServiceComponent>> hgToNonGwServiceComponentsWithYarnNMs = new HashMap<>();\n+        for (Entry<String, Set<ServiceComponent>> entry : hgToNonGwServiceComponents.entrySet()) {\n+            for (ServiceComponent sc : entry.getValue()) {\n+                if (sc.getService().equalsIgnoreCase(YarnRoles.YARN) && sc.getComponent()\n+                        .equalsIgnoreCase(YarnRoles.NODEMANAGER)) {\n+                    hgToNonGwServiceComponentsWithYarnNMs.put(entry.getKey(), entry.getValue());\n+                    break;\n+                }\n+            }\n+        }\n+        // We have the hostGroups without GATEWAY components with YARN NodeManagers\n+        Map<String, Set<String>> componentsByHostGroup = hgToNonGwServiceComponentsWithYarnNMs.entrySet()\n+                .stream().collect(\n+                        toMap(\n+                                Entry::getKey,\n+                                e -> e.getValue().stream()\n+                                .map(ServiceComponent::getComponent)\n+                                .collect(Collectors.toUnmodifiableSet())\n+                ));\n+        // Re-using the current LoadBasedAutoScaling recommendation along with the above YARN filter.\n+        Set<String> computeHostGroups = getRecommendationByBlacklist(BlackListedLoadBasedAutoscaleRole.class,\n+                true, componentsByHostGroup);\n+\n+        Map<String, Map<String, ServiceAttributes>> result = new HashMap<>();\n+\n+        for (String hg : componentsByHostGroup.keySet()) {\n+            Map<String, ServiceAttributes> m;\n+            if (computeHostGroups.contains(hg)) {\n+                m = Collections.singletonMap(YarnRoles.YARN, new ServiceAttributes(ServiceComponent.of(YarnRoles.YARN, YarnRoles.NODEMANAGER),\n+                        Collections.singletonMap(YarnConstants.ATTRIBUTE_NAME_NODE_INSTANCE_TYPE, YarnConstants.ATTRIBUTE_NODE_INSTANCE_TYPE_COMPUTE)));\n+            } else {\n+                m = Collections.singletonMap(YarnRoles.YARN, new ServiceAttributes(ServiceComponent.of(YarnRoles.YARN, YarnRoles.NODEMANAGER),\n+                        Collections.singletonMap(YarnConstants.ATTRIBUTE_NAME_NODE_INSTANCE_TYPE, YarnConstants.ATTRIBUTE_NODE_INSTANCE_TYPE_WORKER)));\n+            }\n+            result.put(hg, m);\n+        }\n+        LOGGER.debug(\"ServiceAttributes: {}\", result);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e322a1c93e41fd3e42a2fb97de3b239710bf60d"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY4NzgyMw==", "bodyText": "Also m is not a good variable name, please rename it to something more helpful", "url": "https://github.com/hortonworks/cloudbreak/pull/9232#discussion_r527687823", "createdAt": "2020-11-20T13:24:50Z", "author": {"login": "lacikaaa"}, "path": "template-manager-cmtemplate/src/main/java/com/sequenceiq/cloudbreak/cmtemplate/CmTemplateProcessor.java", "diffHunk": "@@ -291,6 +311,52 @@ public String getStackVersion() {\n         return cmTemplate.getCdhVersion();\n     }\n \n+    @Override\n+    public Map<String, Map<String, ServiceAttributes>> getHostGroupBasedServiceAttributes() {\n+        // The only attributes required at the moment relate to the YARN NodeManager.\n+        // This functionality can be moved to an interface / separated if additional components\n+        // need this functionality.\n+        Map<String, Set<ServiceComponent>> hgToNonGwServiceComponents = getNonGatewayServicesByHostGroup();\n+        Map<String, Set<ServiceComponent>> hgToNonGwServiceComponentsWithYarnNMs = new HashMap<>();\n+        for (Entry<String, Set<ServiceComponent>> entry : hgToNonGwServiceComponents.entrySet()) {\n+            for (ServiceComponent sc : entry.getValue()) {\n+                if (sc.getService().equalsIgnoreCase(YarnRoles.YARN) && sc.getComponent()\n+                        .equalsIgnoreCase(YarnRoles.NODEMANAGER)) {\n+                    hgToNonGwServiceComponentsWithYarnNMs.put(entry.getKey(), entry.getValue());\n+                    break;\n+                }\n+            }\n+        }\n+        // We have the hostGroups without GATEWAY components with YARN NodeManagers\n+        Map<String, Set<String>> componentsByHostGroup = hgToNonGwServiceComponentsWithYarnNMs.entrySet()\n+                .stream().collect(\n+                        toMap(\n+                                Entry::getKey,\n+                                e -> e.getValue().stream()\n+                                .map(ServiceComponent::getComponent)\n+                                .collect(Collectors.toUnmodifiableSet())\n+                ));\n+        // Re-using the current LoadBasedAutoScaling recommendation along with the above YARN filter.\n+        Set<String> computeHostGroups = getRecommendationByBlacklist(BlackListedLoadBasedAutoscaleRole.class,\n+                true, componentsByHostGroup);\n+\n+        Map<String, Map<String, ServiceAttributes>> result = new HashMap<>();\n+\n+        for (String hg : componentsByHostGroup.keySet()) {\n+            Map<String, ServiceAttributes> m;\n+            if (computeHostGroups.contains(hg)) {\n+                m = Collections.singletonMap(YarnRoles.YARN, new ServiceAttributes(ServiceComponent.of(YarnRoles.YARN, YarnRoles.NODEMANAGER),\n+                        Collections.singletonMap(YarnConstants.ATTRIBUTE_NAME_NODE_INSTANCE_TYPE, YarnConstants.ATTRIBUTE_NODE_INSTANCE_TYPE_COMPUTE)));\n+            } else {\n+                m = Collections.singletonMap(YarnRoles.YARN, new ServiceAttributes(ServiceComponent.of(YarnRoles.YARN, YarnRoles.NODEMANAGER),\n+                        Collections.singletonMap(YarnConstants.ATTRIBUTE_NAME_NODE_INSTANCE_TYPE, YarnConstants.ATTRIBUTE_NODE_INSTANCE_TYPE_WORKER)));\n+            }\n+            result.put(hg, m);\n+        }\n+        LOGGER.debug(\"ServiceAttributes: {}\", result);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY4NzA5MQ=="}, "originalCommit": {"oid": "5e322a1c93e41fd3e42a2fb97de3b239710bf60d"}, "originalPosition": 109}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwODY4NjAzOnYy", "diffSide": "RIGHT", "path": "template-manager-cmtemplate/src/main/java/com/sequenceiq/cloudbreak/cmtemplate/CmTemplateProcessor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMzozMDoxMlrOH3PtEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwNjozMzo1NFrOH_CzYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY5MTAyNQ==", "bodyText": "I ended up with this, but the method and variable names should be changed with more meaningful one I think. This is just an example:\n\t@Override\n    public Map<String, Map<String, ServiceAttributes>> getHostGroupBasedServiceAttributes() {\n        Map<String, Set<String>> componentsByHostGroup = collectComponentsByHostrgoup();\n        Set<String> computeHostGroups = getRecommendationByBlacklist(BlackListedLoadBasedAutoscaleRole.class,\n                true, componentsByHostGroup);\n        Map<String, Map<String, ServiceAttributes>> result = createServiceAttributeMap(componentsByHostGroup, computeHostGroups);\n        LOGGER.debug(\"ServiceAttributes: {}\", result);\n        return result;\n    }\n\n    private Map<String, Map<String, ServiceAttributes>> createServiceAttributeMap(Map<String, Set<String>> componentsByHostGroup, Set<String> computeHostGroups) {\n        Map<String, Map<String, ServiceAttributes>> result = new HashMap<>();\n        for (String hg : componentsByHostGroup.keySet()) {\n            String instanceType = computeHostGroups.contains(hg) ? YarnConstants.ATTRIBUTE_NODE_INSTANCE_TYPE_COMPUTE\n                    : YarnConstants.ATTRIBUTE_NODE_INSTANCE_TYPE_WORKER;\n            Map<String, ServiceAttributes> m = Collections.singletonMap(YarnRoles.YARN, new ServiceAttributes(ServiceComponent.of(YarnRoles.YARN, YarnRoles.NODEMANAGER),\n                    Collections.singletonMap(YarnConstants.ATTRIBUTE_NAME_NODE_INSTANCE_TYPE, instanceType)));\n            result.put(hg, m);\n        }\n        return result;\n    }\n\n    private Map<String, Set<String>> collectComponentsByHostrgoup() {\n        Map<String, Set<ServiceComponent>> hgToNonGwServiceComponents = getNonGatewayServicesByHostGroup();\n        Map<String, Set<ServiceComponent>> hgToNonGwServiceComponentsWithYarnNMs = hgToNonGwServiceComponents.entrySet().stream()\n                .filter(this::isYarnNodemanager)\n                .collect(toMap(Entry::getKey, Entry::getValue));\n        Map<String, Set<String>> componentsByHostGroup = hgToNonGwServiceComponentsWithYarnNMs.entrySet()\n                .stream().collect(toMap(Entry::getKey, this::collectComponents));\n        return componentsByHostGroup;\n    }\n\n    private Set<String> collectComponents(Entry<String, Set<ServiceComponent>> e) {\n        return e.getValue().stream()\n                .map(ServiceComponent::getComponent)\n                .collect(Collectors.toUnmodifiableSet());\n    }\n\n    private boolean isYarnNodemanager(Entry<String, Set<ServiceComponent>> entry) {\n        return entry.getValue().stream().anyMatch(sc -> YarnRoles.YARN.equalsIgnoreCase(sc.getService())\n                && YarnRoles.NODEMANAGER.equalsIgnoreCase(sc.getComponent()));\n    }", "url": "https://github.com/hortonworks/cloudbreak/pull/9232#discussion_r527691025", "createdAt": "2020-11-20T13:30:12Z", "author": {"login": "lacikaaa"}, "path": "template-manager-cmtemplate/src/main/java/com/sequenceiq/cloudbreak/cmtemplate/CmTemplateProcessor.java", "diffHunk": "@@ -291,6 +311,52 @@ public String getStackVersion() {\n         return cmTemplate.getCdhVersion();\n     }\n \n+    @Override\n+    public Map<String, Map<String, ServiceAttributes>> getHostGroupBasedServiceAttributes() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e322a1c93e41fd3e42a2fb97de3b239710bf60d"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg2ODI1Ng==", "bodyText": "Thanks for the suggestions. Have broken up the method a bit, and made some other changes.", "url": "https://github.com/hortonworks/cloudbreak/pull/9232#discussion_r535868256", "createdAt": "2020-12-04T06:33:54Z", "author": {"login": "sidseth"}, "path": "template-manager-cmtemplate/src/main/java/com/sequenceiq/cloudbreak/cmtemplate/CmTemplateProcessor.java", "diffHunk": "@@ -291,6 +311,52 @@ public String getStackVersion() {\n         return cmTemplate.getCdhVersion();\n     }\n \n+    @Override\n+    public Map<String, Map<String, ServiceAttributes>> getHostGroupBasedServiceAttributes() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY5MTAyNQ=="}, "originalCommit": {"oid": "5e322a1c93e41fd3e42a2fb97de3b239710bf60d"}, "originalPosition": 68}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM5MzE0NDU0OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/sequenceiq/cloudbreak/core/bootstrap/service/host/ClusterHostServiceRunner.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQxNzoyODowMVrOIDU2ZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQyMzoyMjo0MFrOIDiBrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDM1ODI0NQ==", "bodyText": "I think this should be moved to a separate class together with getAttributesForHostGroup.\nAnd this method should return with a map, like:\nMap.of(\"hostattrs\", new SaltPillarProperties(\"/nodes/hostattrs.sls\", singletonMap(\"hostattrs\", attributes)))\nAnd in line 303 you would need only:\nservicePillar.putAll(createHostAttributes(..));\nI know there is a lot of code here (even written by me) where we add stuff to this map by passing it around but honestly it's not the best solution.\nMoving this method out would make @VisibleForTesting unnecessary which is already a sign that it should be in a separate class.", "url": "https://github.com/hortonworks/cloudbreak/pull/9232#discussion_r540358245", "createdAt": "2020-12-10T17:28:01Z", "author": {"login": "lacikaaa"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/core/bootstrap/service/host/ClusterHostServiceRunner.java", "diffHunk": "@@ -323,6 +331,26 @@ private SaltConfig createSaltConfig(Stack stack, Cluster cluster, GatewayConfig\n         return new SaltConfig(servicePillar, grainPropertiesService.createGrainProperties(gatewayConfigs, cluster, nodes));\n     }\n \n+    @VisibleForTesting\n+    void addHostAttributes(Stack stack, Map<String, SaltPillarProperties> servicePillar, Set<Node> nodes) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b892b6d11bce5c14d61158af64d45257dabbc7a9"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU3NDEyNg==", "bodyText": "Moving this into a HostAttributeDecorator, and having that set the PillarProperties instead of returning a map.\nI'm going to ask you to make changes to return a map if you feel strongly about that / other code style changes. Given I don't write a lot of CB patches - was avoiding any kind of re-structuring and following existing patterns as much as possible.", "url": "https://github.com/hortonworks/cloudbreak/pull/9232#discussion_r540574126", "createdAt": "2020-12-10T23:22:40Z", "author": {"login": "sidseth"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/core/bootstrap/service/host/ClusterHostServiceRunner.java", "diffHunk": "@@ -323,6 +331,26 @@ private SaltConfig createSaltConfig(Stack stack, Cluster cluster, GatewayConfig\n         return new SaltConfig(servicePillar, grainPropertiesService.createGrainProperties(gatewayConfigs, cluster, nodes));\n     }\n \n+    @VisibleForTesting\n+    void addHostAttributes(Stack stack, Map<String, SaltPillarProperties> servicePillar, Set<Node> nodes) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDM1ODI0NQ=="}, "originalCommit": {"oid": "b892b6d11bce5c14d61158af64d45257dabbc7a9"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM5MzE1NTQ1OnYy", "diffSide": "RIGHT", "path": "orchestrator-salt/src/main/resources/salt/salt/metadata/settings.sls", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQxNzozMDoyNFrOIDU89Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQyMjoyNDo0MVrOIDgDNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDM1OTkyNQ==", "bodyText": "what is this ~ for?", "url": "https://github.com/hortonworks/cloudbreak/pull/9232#discussion_r540359925", "createdAt": "2020-12-10T17:30:24Z", "author": {"login": "lacikaaa"}, "path": "orchestrator-salt/src/main/resources/salt/salt/metadata/settings.sls", "diffHunk": "@@ -20,3 +22,5 @@\n     'clusterName' : clusterName,\n     'cluster_in_childenvironment' : cluster_in_childenvironment\n }) %}\n+\n+{% set hostattrs = salt['pillar.get']('hostattrs:'~grains['fqdn']) %}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b892b6d11bce5c14d61158af64d45257dabbc7a9"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU0MTc0OA==", "bodyText": "The ~ is apparently required when accessing variables inside of a pillar get. i.e. pillar.get(blah(grains.get))", "url": "https://github.com/hortonworks/cloudbreak/pull/9232#discussion_r540541748", "createdAt": "2020-12-10T22:24:41Z", "author": {"login": "sidseth"}, "path": "orchestrator-salt/src/main/resources/salt/salt/metadata/settings.sls", "diffHunk": "@@ -20,3 +22,5 @@\n     'clusterName' : clusterName,\n     'cluster_in_childenvironment' : cluster_in_childenvironment\n }) %}\n+\n+{% set hostattrs = salt['pillar.get']('hostattrs:'~grains['fqdn']) %}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDM1OTkyNQ=="}, "originalCommit": {"oid": "b892b6d11bce5c14d61158af64d45257dabbc7a9"}, "originalPosition": 14}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2167, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}