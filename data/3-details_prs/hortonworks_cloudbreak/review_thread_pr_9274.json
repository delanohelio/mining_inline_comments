{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA4MzQwMDYy", "number": 9274, "reviewThreads": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwODo0MDoxNFrOE2qDsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwOToxMTozN1rOE2qzEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1NzQ3NjM1OnYy", "diffSide": "RIGHT", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/AzureDnsZoneService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwODo0MDoxNFrOHvj_rw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwODo0MDoxNFrOHvj_rw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTYzNDg2Mw==", "bodyText": "why do we still need to check networkLinksDeployed? I think this should be dropped and only dnsZonesDeployed checked", "url": "https://github.com/hortonworks/cloudbreak/pull/9274#discussion_r519634863", "createdAt": "2020-11-09T08:40:14Z", "author": {"login": "lacikaaa"}, "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/AzureDnsZoneService.java", "diffHunk": "@@ -1,307 +1,99 @@\n package com.sequenceiq.cloudbreak.cloud.azure;\n \n import static com.sequenceiq.common.api.type.ResourceType.AZURE_PRIVATE_DNS_ZONE;\n-import static com.sequenceiq.common.api.type.ResourceType.AZURE_VIRTUAL_NETWORK_LINK;\n \n import java.util.List;\n import java.util.Map;\n-import java.util.Objects;\n-import java.util.Optional;\n-import java.util.stream.Collectors;\n \n import javax.inject.Inject;\n \n-import org.apache.commons.lang3.StringUtils;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n-import org.springframework.beans.factory.annotation.Value;\n import org.springframework.dao.DataAccessException;\n import org.springframework.stereotype.Service;\n \n-import com.microsoft.azure.CloudException;\n-import com.microsoft.azure.PagedList;\n-import com.microsoft.azure.management.network.Network;\n-import com.microsoft.azure.management.privatedns.v2018_09_01.implementation.VirtualNetworkLinkInner;\n import com.sequenceiq.cloudbreak.cloud.azure.client.AzureClient;\n import com.sequenceiq.cloudbreak.cloud.azure.connector.resource.AzureDnsZoneDeploymentParameters;\n import com.sequenceiq.cloudbreak.cloud.azure.resource.AzureResourceIdProviderService;\n-import com.sequenceiq.cloudbreak.cloud.azure.task.dnszone.AzureDnsZoneCreationCheckerContext;\n-import com.sequenceiq.cloudbreak.cloud.azure.task.dnszone.AzureDnsZoneCreationPoller;\n import com.sequenceiq.cloudbreak.cloud.azure.view.AzureNetworkView;\n import com.sequenceiq.cloudbreak.cloud.context.AuthenticatedContext;\n import com.sequenceiq.cloudbreak.cloud.exception.CloudConnectorException;\n-import com.sequenceiq.cloudbreak.cloud.model.CloudResource;\n-import com.sequenceiq.cloudbreak.cloud.notification.PersistenceNotifier;\n-import com.sequenceiq.cloudbreak.cloud.notification.PersistenceRetriever;\n-import com.sequenceiq.cloudbreak.common.json.Json;\n import com.sequenceiq.common.api.type.CommonStatus;\n-import com.sequenceiq.common.api.type.ResourceType;\n \n @Service\n public class AzureDnsZoneService {\n \n     private static final Logger LOGGER = LoggerFactory.getLogger(AzureDnsZoneService.class);\n \n-    private static final int DEPLOYMENT_LENGTH_LIMIT = 64;\n-\n     private static final String DNS_ZONES = \"-dns-zones\";\n \n-    private static final String NETWORK_LINKS = \"-links\";\n-\n-    @Inject\n-    private AzureNetworkDnsZoneTemplateBuilder azureNetworkDnsZoneTemplateBuilder;\n-\n-    @Inject\n-    private PersistenceRetriever resourcePersistenceRetriever;\n-\n-    @Inject\n-    private PersistenceNotifier persistenceNotifier;\n-\n     @Inject\n-    private AzureDnsZoneCreationPoller azureDnsZoneCreationPoller;\n+    private AzureResourceCreationHelperService azureResourceCreationHelperService;\n \n     @Inject\n     private AzureResourceIdProviderService azureResourceIdProviderService;\n \n-    @Inject\n-    private AzureUtils azureUtils;\n-\n-    @Value(\"${cb.arm.privateendpoint.services:}\")\n-    private List<String> privateEndpointServices;\n-\n-    public void getOrCreateDnsZones(AuthenticatedContext authenticatedContext, AzureClient azureClient, AzureNetworkView networkView,\n+    public void checkOrCreateDnsZones(AuthenticatedContext authenticatedContext, AzureClient azureClient, AzureNetworkView networkView,\n             String resourceGroup, Map<String, String> tags) {\n \n         String networkId = networkView.getNetworkId();\n         String networkResourceGroup = networkView.getResourceGroupName();\n-        List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices = getEnabledPrivateEndpointServices();\n-\n+        List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices = azureResourceCreationHelperService.getEnabledPrivateEndpointServices();\n         boolean dnsZonesDeployed = azureClient.checkIfDnsZonesDeployed(resourceGroup, enabledPrivateEndpointServices);\n         boolean networkLinksDeployed = azureClient.checkIfNetworkLinksDeployed(resourceGroup, networkId, enabledPrivateEndpointServices);\n-        String deploymentName = generateDeploymentName(enabledPrivateEndpointServices, DNS_ZONES);\n+        String deploymentName = azureResourceCreationHelperService.generateDeploymentName(enabledPrivateEndpointServices, DNS_ZONES);\n         String dnsZoneDeploymentId = azureResourceIdProviderService.generateDeploymentId(azureClient.getCurrentSubscription().subscriptionId(),\n                 resourceGroup, deploymentName);\n \n         if (dnsZonesDeployed && networkLinksDeployed) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7e5910682b9006f265504e46123f909f8d9b2a8"}, "originalPosition": 89}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1NzQ4MjM4OnYy", "diffSide": "RIGHT", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/AzureDnsZoneService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwODo0MTo0OFrOHvkDTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwODo0MTo0OFrOHvkDTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTYzNTc4OQ==", "bodyText": "most of these variable could be moved into the if branch when dnsZonesDeployed is false.", "url": "https://github.com/hortonworks/cloudbreak/pull/9274#discussion_r519635789", "createdAt": "2020-11-09T08:41:48Z", "author": {"login": "lacikaaa"}, "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/AzureDnsZoneService.java", "diffHunk": "@@ -1,307 +1,99 @@\n package com.sequenceiq.cloudbreak.cloud.azure;\n \n import static com.sequenceiq.common.api.type.ResourceType.AZURE_PRIVATE_DNS_ZONE;\n-import static com.sequenceiq.common.api.type.ResourceType.AZURE_VIRTUAL_NETWORK_LINK;\n \n import java.util.List;\n import java.util.Map;\n-import java.util.Objects;\n-import java.util.Optional;\n-import java.util.stream.Collectors;\n \n import javax.inject.Inject;\n \n-import org.apache.commons.lang3.StringUtils;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n-import org.springframework.beans.factory.annotation.Value;\n import org.springframework.dao.DataAccessException;\n import org.springframework.stereotype.Service;\n \n-import com.microsoft.azure.CloudException;\n-import com.microsoft.azure.PagedList;\n-import com.microsoft.azure.management.network.Network;\n-import com.microsoft.azure.management.privatedns.v2018_09_01.implementation.VirtualNetworkLinkInner;\n import com.sequenceiq.cloudbreak.cloud.azure.client.AzureClient;\n import com.sequenceiq.cloudbreak.cloud.azure.connector.resource.AzureDnsZoneDeploymentParameters;\n import com.sequenceiq.cloudbreak.cloud.azure.resource.AzureResourceIdProviderService;\n-import com.sequenceiq.cloudbreak.cloud.azure.task.dnszone.AzureDnsZoneCreationCheckerContext;\n-import com.sequenceiq.cloudbreak.cloud.azure.task.dnszone.AzureDnsZoneCreationPoller;\n import com.sequenceiq.cloudbreak.cloud.azure.view.AzureNetworkView;\n import com.sequenceiq.cloudbreak.cloud.context.AuthenticatedContext;\n import com.sequenceiq.cloudbreak.cloud.exception.CloudConnectorException;\n-import com.sequenceiq.cloudbreak.cloud.model.CloudResource;\n-import com.sequenceiq.cloudbreak.cloud.notification.PersistenceNotifier;\n-import com.sequenceiq.cloudbreak.cloud.notification.PersistenceRetriever;\n-import com.sequenceiq.cloudbreak.common.json.Json;\n import com.sequenceiq.common.api.type.CommonStatus;\n-import com.sequenceiq.common.api.type.ResourceType;\n \n @Service\n public class AzureDnsZoneService {\n \n     private static final Logger LOGGER = LoggerFactory.getLogger(AzureDnsZoneService.class);\n \n-    private static final int DEPLOYMENT_LENGTH_LIMIT = 64;\n-\n     private static final String DNS_ZONES = \"-dns-zones\";\n \n-    private static final String NETWORK_LINKS = \"-links\";\n-\n-    @Inject\n-    private AzureNetworkDnsZoneTemplateBuilder azureNetworkDnsZoneTemplateBuilder;\n-\n-    @Inject\n-    private PersistenceRetriever resourcePersistenceRetriever;\n-\n-    @Inject\n-    private PersistenceNotifier persistenceNotifier;\n-\n     @Inject\n-    private AzureDnsZoneCreationPoller azureDnsZoneCreationPoller;\n+    private AzureResourceCreationHelperService azureResourceCreationHelperService;\n \n     @Inject\n     private AzureResourceIdProviderService azureResourceIdProviderService;\n \n-    @Inject\n-    private AzureUtils azureUtils;\n-\n-    @Value(\"${cb.arm.privateendpoint.services:}\")\n-    private List<String> privateEndpointServices;\n-\n-    public void getOrCreateDnsZones(AuthenticatedContext authenticatedContext, AzureClient azureClient, AzureNetworkView networkView,\n+    public void checkOrCreateDnsZones(AuthenticatedContext authenticatedContext, AzureClient azureClient, AzureNetworkView networkView,\n             String resourceGroup, Map<String, String> tags) {\n \n         String networkId = networkView.getNetworkId();\n         String networkResourceGroup = networkView.getResourceGroupName();\n-        List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices = getEnabledPrivateEndpointServices();\n-\n+        List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices = azureResourceCreationHelperService.getEnabledPrivateEndpointServices();\n         boolean dnsZonesDeployed = azureClient.checkIfDnsZonesDeployed(resourceGroup, enabledPrivateEndpointServices);\n         boolean networkLinksDeployed = azureClient.checkIfNetworkLinksDeployed(resourceGroup, networkId, enabledPrivateEndpointServices);\n-        String deploymentName = generateDeploymentName(enabledPrivateEndpointServices, DNS_ZONES);\n+        String deploymentName = azureResourceCreationHelperService.generateDeploymentName(enabledPrivateEndpointServices, DNS_ZONES);\n         String dnsZoneDeploymentId = azureResourceIdProviderService.generateDeploymentId(azureClient.getCurrentSubscription().subscriptionId(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7e5910682b9006f265504e46123f909f8d9b2a8"}, "originalPosition": 86}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1NzQ5Mzk2OnYy", "diffSide": "RIGHT", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/AzureDnsZoneService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwODo0NDozNVrOHvkKKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwODo0NDozNVrOHvkKKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTYzNzU0Ng==", "bodyText": "this branch should be splitted into smaller methods", "url": "https://github.com/hortonworks/cloudbreak/pull/9274#discussion_r519637546", "createdAt": "2020-11-09T08:44:35Z", "author": {"login": "lacikaaa"}, "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/AzureDnsZoneService.java", "diffHunk": "@@ -1,307 +1,99 @@\n package com.sequenceiq.cloudbreak.cloud.azure;\n \n import static com.sequenceiq.common.api.type.ResourceType.AZURE_PRIVATE_DNS_ZONE;\n-import static com.sequenceiq.common.api.type.ResourceType.AZURE_VIRTUAL_NETWORK_LINK;\n \n import java.util.List;\n import java.util.Map;\n-import java.util.Objects;\n-import java.util.Optional;\n-import java.util.stream.Collectors;\n \n import javax.inject.Inject;\n \n-import org.apache.commons.lang3.StringUtils;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n-import org.springframework.beans.factory.annotation.Value;\n import org.springframework.dao.DataAccessException;\n import org.springframework.stereotype.Service;\n \n-import com.microsoft.azure.CloudException;\n-import com.microsoft.azure.PagedList;\n-import com.microsoft.azure.management.network.Network;\n-import com.microsoft.azure.management.privatedns.v2018_09_01.implementation.VirtualNetworkLinkInner;\n import com.sequenceiq.cloudbreak.cloud.azure.client.AzureClient;\n import com.sequenceiq.cloudbreak.cloud.azure.connector.resource.AzureDnsZoneDeploymentParameters;\n import com.sequenceiq.cloudbreak.cloud.azure.resource.AzureResourceIdProviderService;\n-import com.sequenceiq.cloudbreak.cloud.azure.task.dnszone.AzureDnsZoneCreationCheckerContext;\n-import com.sequenceiq.cloudbreak.cloud.azure.task.dnszone.AzureDnsZoneCreationPoller;\n import com.sequenceiq.cloudbreak.cloud.azure.view.AzureNetworkView;\n import com.sequenceiq.cloudbreak.cloud.context.AuthenticatedContext;\n import com.sequenceiq.cloudbreak.cloud.exception.CloudConnectorException;\n-import com.sequenceiq.cloudbreak.cloud.model.CloudResource;\n-import com.sequenceiq.cloudbreak.cloud.notification.PersistenceNotifier;\n-import com.sequenceiq.cloudbreak.cloud.notification.PersistenceRetriever;\n-import com.sequenceiq.cloudbreak.common.json.Json;\n import com.sequenceiq.common.api.type.CommonStatus;\n-import com.sequenceiq.common.api.type.ResourceType;\n \n @Service\n public class AzureDnsZoneService {\n \n     private static final Logger LOGGER = LoggerFactory.getLogger(AzureDnsZoneService.class);\n \n-    private static final int DEPLOYMENT_LENGTH_LIMIT = 64;\n-\n     private static final String DNS_ZONES = \"-dns-zones\";\n \n-    private static final String NETWORK_LINKS = \"-links\";\n-\n-    @Inject\n-    private AzureNetworkDnsZoneTemplateBuilder azureNetworkDnsZoneTemplateBuilder;\n-\n-    @Inject\n-    private PersistenceRetriever resourcePersistenceRetriever;\n-\n-    @Inject\n-    private PersistenceNotifier persistenceNotifier;\n-\n     @Inject\n-    private AzureDnsZoneCreationPoller azureDnsZoneCreationPoller;\n+    private AzureResourceCreationHelperService azureResourceCreationHelperService;\n \n     @Inject\n     private AzureResourceIdProviderService azureResourceIdProviderService;\n \n-    @Inject\n-    private AzureUtils azureUtils;\n-\n-    @Value(\"${cb.arm.privateendpoint.services:}\")\n-    private List<String> privateEndpointServices;\n-\n-    public void getOrCreateDnsZones(AuthenticatedContext authenticatedContext, AzureClient azureClient, AzureNetworkView networkView,\n+    public void checkOrCreateDnsZones(AuthenticatedContext authenticatedContext, AzureClient azureClient, AzureNetworkView networkView,\n             String resourceGroup, Map<String, String> tags) {\n \n         String networkId = networkView.getNetworkId();\n         String networkResourceGroup = networkView.getResourceGroupName();\n-        List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices = getEnabledPrivateEndpointServices();\n-\n+        List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices = azureResourceCreationHelperService.getEnabledPrivateEndpointServices();\n         boolean dnsZonesDeployed = azureClient.checkIfDnsZonesDeployed(resourceGroup, enabledPrivateEndpointServices);\n         boolean networkLinksDeployed = azureClient.checkIfNetworkLinksDeployed(resourceGroup, networkId, enabledPrivateEndpointServices);\n-        String deploymentName = generateDeploymentName(enabledPrivateEndpointServices, DNS_ZONES);\n+        String deploymentName = azureResourceCreationHelperService.generateDeploymentName(enabledPrivateEndpointServices, DNS_ZONES);\n         String dnsZoneDeploymentId = azureResourceIdProviderService.generateDeploymentId(azureClient.getCurrentSubscription().subscriptionId(),\n                 resourceGroup, deploymentName);\n \n         if (dnsZonesDeployed && networkLinksDeployed) {\n             LOGGER.debug(\"Dns zones ({}) and network links already deployed in resource group {}\", enabledPrivateEndpointServices, resourceGroup);\n         } else if (!dnsZonesDeployed) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7e5910682b9006f265504e46123f909f8d9b2a8"}, "originalPosition": 91}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1NzUwMDY3OnYy", "diffSide": "RIGHT", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/AzureNetworkLinkService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwODo0NjoyNVrOHvkN9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwODo0NjoyNVrOHvkN9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTYzODUxNw==", "bodyText": "these 2 variables should be moved inside the if", "url": "https://github.com/hortonworks/cloudbreak/pull/9274#discussion_r519638517", "createdAt": "2020-11-09T08:46:25Z", "author": {"login": "lacikaaa"}, "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/AzureNetworkLinkService.java", "diffHunk": "@@ -0,0 +1,113 @@\n+package com.sequenceiq.cloudbreak.cloud.azure;\n+\n+import static com.sequenceiq.common.api.type.ResourceType.AZURE_VIRTUAL_NETWORK_LINK;\n+\n+import java.util.List;\n+import java.util.Map;\n+\n+import javax.inject.Inject;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.dao.DataAccessException;\n+import org.springframework.stereotype.Service;\n+\n+import com.microsoft.azure.PagedList;\n+import com.microsoft.azure.management.privatedns.v2018_09_01.implementation.VirtualNetworkLinkInner;\n+import com.sequenceiq.cloudbreak.cloud.azure.client.AzureClient;\n+import com.sequenceiq.cloudbreak.cloud.azure.connector.resource.AzureDnsZoneDeploymentParameters;\n+import com.sequenceiq.cloudbreak.cloud.azure.resource.AzureResourceIdProviderService;\n+import com.sequenceiq.cloudbreak.cloud.azure.view.AzureNetworkView;\n+import com.sequenceiq.cloudbreak.cloud.context.AuthenticatedContext;\n+import com.sequenceiq.cloudbreak.cloud.exception.CloudConnectorException;\n+import com.sequenceiq.common.api.type.CommonStatus;\n+\n+@Service\n+public class AzureNetworkLinkService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(AzureNetworkLinkService.class);\n+\n+    private static final String NETWORK_LINKS = \"-links\";\n+\n+    @Inject\n+    private AzureResourceCreationHelperService azureResourceCreationHelperService;\n+\n+    @Inject\n+    private AzureResourceIdProviderService azureResourceIdProviderService;\n+\n+    public String validateExistingNetworkLink(AzureClient azureClient, String networkId) {\n+        List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices = azureResourceCreationHelperService.getEnabledPrivateEndpointServices();\n+        return azureClient.validateNetworkLinkExistenceForDnsZones(networkId, enabledPrivateEndpointServices);\n+    }\n+\n+    public void checkOrCreateNetworkLinks(AuthenticatedContext authenticatedContext, AzureClient azureClient, AzureNetworkView networkView,\n+            String resourceGroup, Map<String, String> tags) {\n+\n+        String networkId = networkView.getNetworkId();\n+        String networkResourceGroup = networkView.getResourceGroupName();\n+        List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices = azureResourceCreationHelperService.getEnabledPrivateEndpointServices();\n+\n+        boolean networkLinksDeployed = azureClient.checkIfNetworkLinksDeployed(resourceGroup, networkId, enabledPrivateEndpointServices);\n+        String deploymentName = azureResourceCreationHelperService.generateDeploymentName(enabledPrivateEndpointServices, \"-\" + networkId + NETWORK_LINKS);\n+        String networkLinkDeploymentId = azureResourceIdProviderService.generateDeploymentId(azureClient.getCurrentSubscription().subscriptionId(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7e5910682b9006f265504e46123f909f8d9b2a8"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1NzUwNDc3OnYy", "diffSide": "RIGHT", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/AzureNetworkLinkService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwODo0NzoyNlrOHvkQWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwODo0NzoyNlrOHvkQWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTYzOTEyOQ==", "bodyText": "could you move this near to it's usage?", "url": "https://github.com/hortonworks/cloudbreak/pull/9274#discussion_r519639129", "createdAt": "2020-11-09T08:47:26Z", "author": {"login": "lacikaaa"}, "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/AzureNetworkLinkService.java", "diffHunk": "@@ -0,0 +1,113 @@\n+package com.sequenceiq.cloudbreak.cloud.azure;\n+\n+import static com.sequenceiq.common.api.type.ResourceType.AZURE_VIRTUAL_NETWORK_LINK;\n+\n+import java.util.List;\n+import java.util.Map;\n+\n+import javax.inject.Inject;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.dao.DataAccessException;\n+import org.springframework.stereotype.Service;\n+\n+import com.microsoft.azure.PagedList;\n+import com.microsoft.azure.management.privatedns.v2018_09_01.implementation.VirtualNetworkLinkInner;\n+import com.sequenceiq.cloudbreak.cloud.azure.client.AzureClient;\n+import com.sequenceiq.cloudbreak.cloud.azure.connector.resource.AzureDnsZoneDeploymentParameters;\n+import com.sequenceiq.cloudbreak.cloud.azure.resource.AzureResourceIdProviderService;\n+import com.sequenceiq.cloudbreak.cloud.azure.view.AzureNetworkView;\n+import com.sequenceiq.cloudbreak.cloud.context.AuthenticatedContext;\n+import com.sequenceiq.cloudbreak.cloud.exception.CloudConnectorException;\n+import com.sequenceiq.common.api.type.CommonStatus;\n+\n+@Service\n+public class AzureNetworkLinkService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(AzureNetworkLinkService.class);\n+\n+    private static final String NETWORK_LINKS = \"-links\";\n+\n+    @Inject\n+    private AzureResourceCreationHelperService azureResourceCreationHelperService;\n+\n+    @Inject\n+    private AzureResourceIdProviderService azureResourceIdProviderService;\n+\n+    public String validateExistingNetworkLink(AzureClient azureClient, String networkId) {\n+        List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices = azureResourceCreationHelperService.getEnabledPrivateEndpointServices();\n+        return azureClient.validateNetworkLinkExistenceForDnsZones(networkId, enabledPrivateEndpointServices);\n+    }\n+\n+    public void checkOrCreateNetworkLinks(AuthenticatedContext authenticatedContext, AzureClient azureClient, AzureNetworkView networkView,\n+            String resourceGroup, Map<String, String> tags) {\n+\n+        String networkId = networkView.getNetworkId();\n+        String networkResourceGroup = networkView.getResourceGroupName();\n+        List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices = azureResourceCreationHelperService.getEnabledPrivateEndpointServices();\n+\n+        boolean networkLinksDeployed = azureClient.checkIfNetworkLinksDeployed(resourceGroup, networkId, enabledPrivateEndpointServices);\n+        String deploymentName = azureResourceCreationHelperService.generateDeploymentName(enabledPrivateEndpointServices, \"-\" + networkId + NETWORK_LINKS);\n+        String networkLinkDeploymentId = azureResourceIdProviderService.generateDeploymentId(azureClient.getCurrentSubscription().subscriptionId(),\n+                resourceGroup, deploymentName);\n+\n+        if (!networkLinksDeployed) {\n+            LOGGER.debug(\"Deploying network links that are not deployed yet!\");\n+            String azureNetworkId = azureResourceCreationHelperService.getAzureNetwork(azureClient, networkId, networkResourceGroup).id();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7e5910682b9006f265504e46123f909f8d9b2a8"}, "originalPosition": 58}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1NzUxMzQ2OnYy", "diffSide": "RIGHT", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/AzureNetworkLinkService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwODo0OTo0OVrOHvkVkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwODo0OTo0OVrOHvkVkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY0MDQ2Nw==", "bodyText": "could you split this part into smaller methods?", "url": "https://github.com/hortonworks/cloudbreak/pull/9274#discussion_r519640467", "createdAt": "2020-11-09T08:49:49Z", "author": {"login": "lacikaaa"}, "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/AzureNetworkLinkService.java", "diffHunk": "@@ -0,0 +1,113 @@\n+package com.sequenceiq.cloudbreak.cloud.azure;\n+\n+import static com.sequenceiq.common.api.type.ResourceType.AZURE_VIRTUAL_NETWORK_LINK;\n+\n+import java.util.List;\n+import java.util.Map;\n+\n+import javax.inject.Inject;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.dao.DataAccessException;\n+import org.springframework.stereotype.Service;\n+\n+import com.microsoft.azure.PagedList;\n+import com.microsoft.azure.management.privatedns.v2018_09_01.implementation.VirtualNetworkLinkInner;\n+import com.sequenceiq.cloudbreak.cloud.azure.client.AzureClient;\n+import com.sequenceiq.cloudbreak.cloud.azure.connector.resource.AzureDnsZoneDeploymentParameters;\n+import com.sequenceiq.cloudbreak.cloud.azure.resource.AzureResourceIdProviderService;\n+import com.sequenceiq.cloudbreak.cloud.azure.view.AzureNetworkView;\n+import com.sequenceiq.cloudbreak.cloud.context.AuthenticatedContext;\n+import com.sequenceiq.cloudbreak.cloud.exception.CloudConnectorException;\n+import com.sequenceiq.common.api.type.CommonStatus;\n+\n+@Service\n+public class AzureNetworkLinkService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(AzureNetworkLinkService.class);\n+\n+    private static final String NETWORK_LINKS = \"-links\";\n+\n+    @Inject\n+    private AzureResourceCreationHelperService azureResourceCreationHelperService;\n+\n+    @Inject\n+    private AzureResourceIdProviderService azureResourceIdProviderService;\n+\n+    public String validateExistingNetworkLink(AzureClient azureClient, String networkId) {\n+        List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices = azureResourceCreationHelperService.getEnabledPrivateEndpointServices();\n+        return azureClient.validateNetworkLinkExistenceForDnsZones(networkId, enabledPrivateEndpointServices);\n+    }\n+\n+    public void checkOrCreateNetworkLinks(AuthenticatedContext authenticatedContext, AzureClient azureClient, AzureNetworkView networkView,\n+            String resourceGroup, Map<String, String> tags) {\n+\n+        String networkId = networkView.getNetworkId();\n+        String networkResourceGroup = networkView.getResourceGroupName();\n+        List<AzurePrivateDnsZoneServiceEnum> enabledPrivateEndpointServices = azureResourceCreationHelperService.getEnabledPrivateEndpointServices();\n+\n+        boolean networkLinksDeployed = azureClient.checkIfNetworkLinksDeployed(resourceGroup, networkId, enabledPrivateEndpointServices);\n+        String deploymentName = azureResourceCreationHelperService.generateDeploymentName(enabledPrivateEndpointServices, \"-\" + networkId + NETWORK_LINKS);\n+        String networkLinkDeploymentId = azureResourceIdProviderService.generateDeploymentId(azureClient.getCurrentSubscription().subscriptionId(),\n+                resourceGroup, deploymentName);\n+\n+        if (!networkLinksDeployed) {\n+            LOGGER.debug(\"Deploying network links that are not deployed yet!\");\n+            String azureNetworkId = azureResourceCreationHelperService.getAzureNetwork(azureClient, networkId, networkResourceGroup).id();\n+\n+            try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7e5910682b9006f265504e46123f909f8d9b2a8"}, "originalPosition": 60}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1NzUyMjI5OnYy", "diffSide": "RIGHT", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/AzureResourceCreationHelperService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwODo1MjoxMVrOHvka_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwODo1MjoxMVrOHvka_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY0MTg1NQ==", "bodyText": "you should consider a wrapper object for these parameters as there are already 7 of them", "url": "https://github.com/hortonworks/cloudbreak/pull/9274#discussion_r519641855", "createdAt": "2020-11-09T08:52:11Z", "author": {"login": "lacikaaa"}, "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/AzureResourceCreationHelperService.java", "diffHunk": "@@ -0,0 +1,169 @@\n+package com.sequenceiq.cloudbreak.cloud.azure;\n+\n+import static com.sequenceiq.common.api.type.ResourceType.AZURE_PRIVATE_DNS_ZONE;\n+import static com.sequenceiq.common.api.type.ResourceType.AZURE_VIRTUAL_NETWORK_LINK;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.stereotype.Service;\n+\n+import com.microsoft.azure.CloudException;\n+import com.microsoft.azure.management.network.Network;\n+import com.sequenceiq.cloudbreak.cloud.azure.client.AzureClient;\n+import com.sequenceiq.cloudbreak.cloud.azure.connector.resource.AzureDnsZoneDeploymentParameters;\n+import com.sequenceiq.cloudbreak.cloud.azure.task.dnszone.AzureDnsZoneCreationCheckerContext;\n+import com.sequenceiq.cloudbreak.cloud.azure.task.dnszone.AzureDnsZoneCreationPoller;\n+import com.sequenceiq.cloudbreak.cloud.context.AuthenticatedContext;\n+import com.sequenceiq.cloudbreak.cloud.exception.CloudConnectorException;\n+import com.sequenceiq.cloudbreak.cloud.model.CloudResource;\n+import com.sequenceiq.cloudbreak.cloud.notification.PersistenceNotifier;\n+import com.sequenceiq.cloudbreak.cloud.notification.PersistenceRetriever;\n+import com.sequenceiq.cloudbreak.common.json.Json;\n+import com.sequenceiq.common.api.type.CommonStatus;\n+import com.sequenceiq.common.api.type.ResourceType;\n+\n+@Service\n+public class AzureResourceCreationHelperService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(AzureResourceCreationHelperService.class);\n+\n+    private static final int DEPLOYMENT_LENGTH_LIMIT = 64;\n+\n+    private static final String DNS_ZONES = \"-dns-zones\";\n+\n+    private static final String NETWORK_LINKS = \"-links\";\n+\n+    @Inject\n+    private AzureNetworkDnsZoneTemplateBuilder azureNetworkDnsZoneTemplateBuilder;\n+\n+    @Inject\n+    private PersistenceRetriever resourcePersistenceRetriever;\n+\n+    @Inject\n+    private PersistenceNotifier persistenceNotifier;\n+\n+    @Inject\n+    private AzureDnsZoneCreationPoller azureDnsZoneCreationPoller;\n+\n+    @Inject\n+    private AzureUtils azureUtils;\n+\n+    @Value(\"${cb.arm.privateendpoint.services:}\")\n+    private List<String> privateEndpointServices;\n+\n+    public void pollForCreation(AuthenticatedContext authenticatedContext, AzureClient azureClient, String resourceGroup, String deploymentName,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7e5910682b9006f265504e46123f909f8d9b2a8"}, "originalPosition": 64}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1NzU0OTQ0OnYy", "diffSide": "RIGHT", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/AzureResourceCreationHelperService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwODo1OToxNlrOHvkrYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwODo1OToxNlrOHvkrYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY0NjA0OA==", "bodyText": "I think this class has a responsibility of doing at least 2 different things:\n\nresource persistence handling\ndeployment creation/polling etc\n\nthis means it could be splitted into 2 separate class", "url": "https://github.com/hortonworks/cloudbreak/pull/9274#discussion_r519646048", "createdAt": "2020-11-09T08:59:16Z", "author": {"login": "lacikaaa"}, "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/AzureResourceCreationHelperService.java", "diffHunk": "@@ -0,0 +1,169 @@\n+package com.sequenceiq.cloudbreak.cloud.azure;\n+\n+import static com.sequenceiq.common.api.type.ResourceType.AZURE_PRIVATE_DNS_ZONE;\n+import static com.sequenceiq.common.api.type.ResourceType.AZURE_VIRTUAL_NETWORK_LINK;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.stereotype.Service;\n+\n+import com.microsoft.azure.CloudException;\n+import com.microsoft.azure.management.network.Network;\n+import com.sequenceiq.cloudbreak.cloud.azure.client.AzureClient;\n+import com.sequenceiq.cloudbreak.cloud.azure.connector.resource.AzureDnsZoneDeploymentParameters;\n+import com.sequenceiq.cloudbreak.cloud.azure.task.dnszone.AzureDnsZoneCreationCheckerContext;\n+import com.sequenceiq.cloudbreak.cloud.azure.task.dnszone.AzureDnsZoneCreationPoller;\n+import com.sequenceiq.cloudbreak.cloud.context.AuthenticatedContext;\n+import com.sequenceiq.cloudbreak.cloud.exception.CloudConnectorException;\n+import com.sequenceiq.cloudbreak.cloud.model.CloudResource;\n+import com.sequenceiq.cloudbreak.cloud.notification.PersistenceNotifier;\n+import com.sequenceiq.cloudbreak.cloud.notification.PersistenceRetriever;\n+import com.sequenceiq.cloudbreak.common.json.Json;\n+import com.sequenceiq.common.api.type.CommonStatus;\n+import com.sequenceiq.common.api.type.ResourceType;\n+\n+@Service\n+public class AzureResourceCreationHelperService {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7e5910682b9006f265504e46123f909f8d9b2a8"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1NzU5NTk0OnYy", "diffSide": "RIGHT", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/client/AzureClient.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwOToxMToxMlrOHvlHeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwOToxMToxMlrOHvlHeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY1MzI0MA==", "bodyText": "instead of returning null please consider a different way, like using Optional", "url": "https://github.com/hortonworks/cloudbreak/pull/9274#discussion_r519653240", "createdAt": "2020-11-09T09:11:12Z", "author": {"login": "lacikaaa"}, "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/client/AzureClient.java", "diffHunk": "@@ -739,8 +739,29 @@ public void deleteGenericResourceById(String databaseServerId) {\n         handleAuthException(() -> azure.genericResources().deleteById(databaseServerId));\n     }\n \n-    public PrivateZone getPrivateDnsZoneByResourceGroup(String resourceGroupName, String dnsZoneName) {\n-        return privatednsManager.privateZones().getByResourceGroup(resourceGroupName, dnsZoneName);\n+    public PagedList<PrivateZone> getPrivateDnsZoneList() {\n+        return privatednsManager.privateZones().list();\n+    }\n+\n+    public String validateNetworkLinkExistenceForDnsZones(String networkLinkId, List<AzurePrivateDnsZoneServiceEnum> services) {\n+        PagedList<PrivateZone> privateDnsZoneList = getPrivateDnsZoneList();\n+        for (AzurePrivateDnsZoneServiceEnum service : services) {\n+            String dnsZoneName = service.getDnsZoneName();\n+            Optional<PrivateZone> privateZoneWithNetworkLink = privateDnsZoneList.stream()\n+                    .filter(privateZone -> privateZone.name().equals(dnsZoneName))\n+                    .filter(privateZone -> privateZone.provisioningState().equals(SUCCEEDED))\n+                    .filter(privateZone -> Objects.nonNull(getNetworkLinkByPrivateDnsZone(privateZone.resourceGroupName(), dnsZoneName, networkLinkId)))\n+                    .findFirst();\n+            if (privateZoneWithNetworkLink.isPresent()) {\n+                PrivateZone privateZone = privateZoneWithNetworkLink.get();\n+                String validationMessage = String.format(\"Network link for the network %s already exists for Private DNS Zone %s in resource group %s. \"\n+                            + \"Please ensure that there is no existing network link and try again!\",\n+                    networkLinkId, dnsZoneName, privateZone.resourceGroupName());\n+                LOGGER.warn(validationMessage);\n+                return validationMessage;\n+            }\n+        }\n+        return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7e5910682b9006f265504e46123f909f8d9b2a8"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1NzU5NzYxOnYy", "diffSide": "RIGHT", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/client/AzureClient.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwOToxMTozN1rOHvlIgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwOToxMTozN1rOHvlIgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY1MzUwNQ==", "bodyText": "please avoid in the middle return", "url": "https://github.com/hortonworks/cloudbreak/pull/9274#discussion_r519653505", "createdAt": "2020-11-09T09:11:37Z", "author": {"login": "lacikaaa"}, "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/client/AzureClient.java", "diffHunk": "@@ -739,8 +739,29 @@ public void deleteGenericResourceById(String databaseServerId) {\n         handleAuthException(() -> azure.genericResources().deleteById(databaseServerId));\n     }\n \n-    public PrivateZone getPrivateDnsZoneByResourceGroup(String resourceGroupName, String dnsZoneName) {\n-        return privatednsManager.privateZones().getByResourceGroup(resourceGroupName, dnsZoneName);\n+    public PagedList<PrivateZone> getPrivateDnsZoneList() {\n+        return privatednsManager.privateZones().list();\n+    }\n+\n+    public String validateNetworkLinkExistenceForDnsZones(String networkLinkId, List<AzurePrivateDnsZoneServiceEnum> services) {\n+        PagedList<PrivateZone> privateDnsZoneList = getPrivateDnsZoneList();\n+        for (AzurePrivateDnsZoneServiceEnum service : services) {\n+            String dnsZoneName = service.getDnsZoneName();\n+            Optional<PrivateZone> privateZoneWithNetworkLink = privateDnsZoneList.stream()\n+                    .filter(privateZone -> privateZone.name().equals(dnsZoneName))\n+                    .filter(privateZone -> privateZone.provisioningState().equals(SUCCEEDED))\n+                    .filter(privateZone -> Objects.nonNull(getNetworkLinkByPrivateDnsZone(privateZone.resourceGroupName(), dnsZoneName, networkLinkId)))\n+                    .findFirst();\n+            if (privateZoneWithNetworkLink.isPresent()) {\n+                PrivateZone privateZone = privateZoneWithNetworkLink.get();\n+                String validationMessage = String.format(\"Network link for the network %s already exists for Private DNS Zone %s in resource group %s. \"\n+                            + \"Please ensure that there is no existing network link and try again!\",\n+                    networkLinkId, dnsZoneName, privateZone.resourceGroupName());\n+                LOGGER.warn(validationMessage);\n+                return validationMessage;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7e5910682b9006f265504e46123f909f8d9b2a8"}, "originalPosition": 25}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2034, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}