{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk2MzI0MDQw", "number": 7697, "title": "CB-6366 FreeIPA stacks are not deleted, they remain in DELETE_COMPLETED state", "bodyText": "", "createdAt": "2020-03-31T13:09:22Z", "url": "https://github.com/hortonworks/cloudbreak/pull/7697", "merged": true, "mergeCommit": {"oid": "873de278a0c1ac8d6828a77c7a031e6bc74dec01"}, "closed": true, "closedAt": "2020-03-31T13:53:13Z", "author": {"login": "lacikaaa"}, "timelineItems": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcTCkSEgH2gAyMzk2MzI0MDQwOjY1ZDI2OTEzMTMwM2IwNWZlMmE1MjUxZWFiMmViZGE4MDMxMGY2NjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTHt8tAFqTM4NTAwNzk4NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "65d269131303b05fe2a5251eab2ebda80310f664", "author": {"user": {"login": "lacikaaa", "name": "Mihaly Laszlo Molnar"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/65d269131303b05fe2a5251eab2ebda80310f664", "committedDate": "2020-03-31T12:50:05Z", "message": "CB-6366 FreeIPA stacks are not deleted, they remain in DELETE_COMPLETED state"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1MDA3OTg0", "url": "https://github.com/hortonworks/cloudbreak/pull/7697#pullrequestreview-385007984", "createdAt": "2020-03-31T18:44:39Z", "commit": {"oid": "65d269131303b05fe2a5251eab2ebda80310f664"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxODo0NDo0MFrOF-jVRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxODo0ODowNVrOF-jdhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEzNDkxNg==", "bodyText": "is this save necessary since the stackUpdater also saves the stack? If we need to save it again, shouldn't we use the Stack that is returned from updateStackStatus instead? By my understanding, this stack should be detached at this point.", "url": "https://github.com/hortonworks/cloudbreak/pull/7697#discussion_r401134916", "createdAt": "2020-03-31T18:44:40Z", "author": {"login": "handavid"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/flow/stack/termination/action/TerminationService.java", "diffHunk": "@@ -54,22 +54,22 @@\n     private KerberosMgmtV1Service kerberosMgmtV1Service;\n \n     public void finalizeTermination(Long stackId) {\n-        Stack stack = stackService.getByIdWithListsInTransaction(stackId);\n-        Date now = new Date();\n-        String terminatedName = stack.getName() + DELIMITER + now.getTime();\n+        long currentTimeMillis = clock.getCurrentTimeMillis();\n         try {\n             transactionService.required(() -> {\n+                Stack stack = stackService.getByIdWithListsInTransaction(stackId);\n+                String terminatedName = stack.getName() + DELIMITER + currentTimeMillis;\n                 stack.setName(terminatedName);\n-                stack.setTerminated(clock.getCurrentTimeMillis());\n+                stack.setTerminated(currentTimeMillis);\n                 terminateInstanceGroups(stack);\n                 terminateMetaDataInstances(stack);\n                 cleanupVault(stack);\n+                stackUpdater.updateStackStatus(stack, DetailedStackStatus.DELETE_COMPLETED, \"Stack was terminated successfully.\");\n                 stackService.save(stack);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65d269131303b05fe2a5251eab2ebda80310f664"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEzNzAyOA==", "bodyText": "nit: do we refer to freeipa stacks as \"cluster\" elsewhere? I think it would be clearer to refer to this as \"freeipa infrastructure\"\nstackId is still available as a method parameter if you want to continue logging it.", "url": "https://github.com/hortonworks/cloudbreak/pull/7697#discussion_r401137028", "createdAt": "2020-03-31T18:48:05Z", "author": {"login": "handavid"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/flow/stack/termination/action/TerminationService.java", "diffHunk": "@@ -54,22 +54,22 @@\n     private KerberosMgmtV1Service kerberosMgmtV1Service;\n \n     public void finalizeTermination(Long stackId) {\n-        Stack stack = stackService.getByIdWithListsInTransaction(stackId);\n-        Date now = new Date();\n-        String terminatedName = stack.getName() + DELIMITER + now.getTime();\n+        long currentTimeMillis = clock.getCurrentTimeMillis();\n         try {\n             transactionService.required(() -> {\n+                Stack stack = stackService.getByIdWithListsInTransaction(stackId);\n+                String terminatedName = stack.getName() + DELIMITER + currentTimeMillis;\n                 stack.setName(terminatedName);\n-                stack.setTerminated(clock.getCurrentTimeMillis());\n+                stack.setTerminated(currentTimeMillis);\n                 terminateInstanceGroups(stack);\n                 terminateMetaDataInstances(stack);\n                 cleanupVault(stack);\n+                stackUpdater.updateStackStatus(stack, DetailedStackStatus.DELETE_COMPLETED, \"Stack was terminated successfully.\");\n                 stackService.save(stack);\n-                stackUpdater.updateStackStatus(stackId, DetailedStackStatus.DELETE_COMPLETED, \"Stack was terminated successfully.\");\n                 return null;\n             });\n-        } catch (TransactionService.TransactionExecutionException ex) {\n-            LOGGER.info(\"Failed to terminate cluster infrastructure. Stack id {}\", stack.getId());\n+        } catch (TransactionExecutionException ex) {\n+            LOGGER.info(\"Failed to terminate cluster infrastructure.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65d269131303b05fe2a5251eab2ebda80310f664"}, "originalPosition": 55}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2391, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}