{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIxMTc1ODk0", "number": 8121, "title": "CB-7104 Add resource based Auth for Freeipa api", "bodyText": "Adding environment based authorization for freeipa APIs", "createdAt": "2020-05-21T06:28:59Z", "url": "https://github.com/hortonworks/cloudbreak/pull/8121", "merged": true, "mergeCommit": {"oid": "12e1e93fc4688e6f994bd5a2eacc86cbb37ab249"}, "closed": true, "closedAt": "2020-06-03T08:26:11Z", "author": {"login": "horadla23"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcjXyrSABqjMzNTk0NDczMzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcnlFjggFqTQyMzMyNTA2Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f9373630150f598f86f54248e0ce59da2ba32845", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/f9373630150f598f86f54248e0ce59da2ba32845", "committedDate": "2020-05-21T06:27:29Z", "message": "CB-7104 Add resource based Auth for Freeipa api"}, "afterCommit": {"oid": "824a00904ef6e5b45bfa4d373cdb4dfab2790d16", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/824a00904ef6e5b45bfa4d373cdb4dfab2790d16", "committedDate": "2020-05-21T06:36:09Z", "message": "CB-7104 Add resource based Auth for Freeipa api"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "824a00904ef6e5b45bfa4d373cdb4dfab2790d16", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/824a00904ef6e5b45bfa4d373cdb4dfab2790d16", "committedDate": "2020-05-21T06:36:09Z", "message": "CB-7104 Add resource based Auth for Freeipa api"}, "afterCommit": {"oid": "a2ce477bcda66f384b903624f3b5f31e86bcedff", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/a2ce477bcda66f384b903624f3b5f31e86bcedff", "committedDate": "2020-05-21T07:38:18Z", "message": "CB-7104 Add resource based Auth for Freeipa api"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a2ce477bcda66f384b903624f3b5f31e86bcedff", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/a2ce477bcda66f384b903624f3b5f31e86bcedff", "committedDate": "2020-05-21T07:38:18Z", "message": "CB-7104 Add resource based Auth for Freeipa api"}, "afterCommit": {"oid": "8118e67f10d5758389294ce55bba3dbcc5df6612", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/8118e67f10d5758389294ce55bba3dbcc5df6612", "committedDate": "2020-05-21T14:41:53Z", "message": "CB-7104 Add resource based Auth for Freeipa api"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8118e67f10d5758389294ce55bba3dbcc5df6612", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/8118e67f10d5758389294ce55bba3dbcc5df6612", "committedDate": "2020-05-21T14:41:53Z", "message": "CB-7104 Add resource based Auth for Freeipa api"}, "afterCommit": {"oid": "a2a66bd8206e7dfb138c6d595b8b3fa5a1a0fa97", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/a2a66bd8206e7dfb138c6d595b8b3fa5a1a0fa97", "committedDate": "2020-05-21T16:15:44Z", "message": "CB-7104 Add resource based Auth for Freeipa api"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a2a66bd8206e7dfb138c6d595b8b3fa5a1a0fa97", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/a2a66bd8206e7dfb138c6d595b8b3fa5a1a0fa97", "committedDate": "2020-05-21T16:15:44Z", "message": "CB-7104 Add resource based Auth for Freeipa api"}, "afterCommit": {"oid": "ab017eec156381c78945ae8550f8378e4e79f7f5", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/ab017eec156381c78945ae8550f8378e4e79f7f5", "committedDate": "2020-05-22T09:25:42Z", "message": "CB-7104 Add resource based Auth for Freeipa api"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3MDIwODUw", "url": "https://github.com/hortonworks/cloudbreak/pull/8121#pullrequestreview-417020850", "createdAt": "2020-05-22T15:58:35Z", "commit": {"oid": "ab017eec156381c78945ae8550f8378e4e79f7f5"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNTo1ODozNVrOGZcOnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNjoyODoxNlrOGZc80g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMzMDA3OQ==", "bodyText": "User sync operations can apply to all environments in an account. This field is used to filter the environments and may be empty to indicate all environments. The SynchronizeAllUsersRequest does contain an accountID, but it is optional for backwards compatibility to callers that do not include it.\nIn short, there is no reliable way to get the account id from these user sync requests. I've made a suggestion in the UserV1Controller for a possible approach to work around this until we get a chance to redo all the user sync APIs to include either an resource crn", "url": "https://github.com/hortonworks/cloudbreak/pull/8121#discussion_r429330079", "createdAt": "2020-05-22T15:58:35Z", "author": {"login": "handavid"}, "path": "freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/user/model/SynchronizeOperationRequestBase.java", "diffHunk": "@@ -3,12 +3,16 @@\n import java.util.HashSet;\n import java.util.Set;\n \n+import com.sequenceiq.authorization.annotation.ResourceObjectField;\n+import com.sequenceiq.authorization.resource.AuthorizationResourceAction;\n+import com.sequenceiq.authorization.resource.AuthorizationVariableType;\n import com.sequenceiq.freeipa.api.v1.freeipa.user.doc.UserModelDescriptions;\n \n import io.swagger.annotations.ApiModelProperty;\n \n public class SynchronizeOperationRequestBase {\n     @ApiModelProperty(value = UserModelDescriptions.USERSYNC_ENVIRONMENT_CRNS)\n+    @ResourceObjectField(action = AuthorizationResourceAction.EDIT_ENVIRONMENT, variableType = AuthorizationVariableType.CRN_LIST)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab017eec156381c78945ae8550f8378e4e79f7f5"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM0MTkwNg==", "bodyText": "see my comment on the SyncOperationRequestBase for why we cannot reliable obtain the account id from the request objects.\nCan we treat the override methods as a facade, calculate the account id, then do the permission check? It's ugly and hopefully temporary until we fix this API.\nI didn't see an appropriate annotation for getting taking the account in as a parameter directly so there would have to be other changes to add account to the AuthorizationVariableType\n@Override\npublic SyncOperationStatus synchronizeUser(SynchronizeUserRequest request) {\n    String userCrn = checkUserCrn();\n    String accountId = ThreadBasedUserCrnProvider.getAccountId();\n    return internalSynchronizeUser(accountId, request);\n}\n\n@Override\n@CheckPermissionByResource(type = ACCOUNT_ID)\npublic SyncOperationStatus synchronizeUser(@ResourceObject String accountId, String actorCrn, SynchronizeUserRequest request) {\n    LOGGER.debug(\"synchronizeUser() requested for user {} in account {}\", userCrn, accountId);\n    ...\n}", "url": "https://github.com/hortonworks/cloudbreak/pull/8121#discussion_r429341906", "createdAt": "2020-05-22T16:28:16Z", "author": {"login": "handavid"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/controller/UserV1Controller.java", "diffHunk": "@@ -48,8 +50,8 @@\n     private OperationToSyncOperationStatus operationToSyncOperationStatus;\n \n     @Override\n-    @CheckPermissionByAccount(action = AuthorizationResourceAction.ENVIRONMENT_WRITE)\n-    public SyncOperationStatus synchronizeUser(SynchronizeUserRequest request) {\n+    @CheckPermissionByResourceObject", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab017eec156381c78945ae8550f8378e4e79f7f5"}, "originalPosition": 28}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ab017eec156381c78945ae8550f8378e4e79f7f5", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/ab017eec156381c78945ae8550f8378e4e79f7f5", "committedDate": "2020-05-22T09:25:42Z", "message": "CB-7104 Add resource based Auth for Freeipa api"}, "afterCommit": {"oid": "905a8de5c0ee6c394e58c09feed4830fe00a9049", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/905a8de5c0ee6c394e58c09feed4830fe00a9049", "committedDate": "2020-05-22T17:09:36Z", "message": "CB-7104 Add resource based Auth for Freeipa api"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "905a8de5c0ee6c394e58c09feed4830fe00a9049", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/905a8de5c0ee6c394e58c09feed4830fe00a9049", "committedDate": "2020-05-22T17:09:36Z", "message": "CB-7104 Add resource based Auth for Freeipa api"}, "afterCommit": {"oid": "b5fe53d733aa43a564b2bac26cdad0fad9a0cd0f", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/b5fe53d733aa43a564b2bac26cdad0fad9a0cd0f", "committedDate": "2020-05-27T08:27:59Z", "message": "CB-7104 Add resource based Auth for Freeipa api"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b5fe53d733aa43a564b2bac26cdad0fad9a0cd0f", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/b5fe53d733aa43a564b2bac26cdad0fad9a0cd0f", "committedDate": "2020-05-27T08:27:59Z", "message": "CB-7104 Add resource based Auth for Freeipa api"}, "afterCommit": {"oid": "5e1abc2cd60a6aa43c2f496e078f5eec560e00dd", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/5e1abc2cd60a6aa43c2f496e078f5eec560e00dd", "committedDate": "2020-05-27T08:44:51Z", "message": "CB-7104 Add resource based Auth for Freeipa api"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5e1abc2cd60a6aa43c2f496e078f5eec560e00dd", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/5e1abc2cd60a6aa43c2f496e078f5eec560e00dd", "committedDate": "2020-05-27T08:44:51Z", "message": "CB-7104 Add resource based Auth for Freeipa api"}, "afterCommit": {"oid": "296fb03150ce4d626602eed9aa5bf23c5b52feef", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/296fb03150ce4d626602eed9aa5bf23c5b52feef", "committedDate": "2020-05-27T15:31:40Z", "message": "CB-7104 Add resource based Auth for Freeipa api"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "296fb03150ce4d626602eed9aa5bf23c5b52feef", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/296fb03150ce4d626602eed9aa5bf23c5b52feef", "committedDate": "2020-05-27T15:31:40Z", "message": "CB-7104 Add resource based Auth for Freeipa api"}, "afterCommit": {"oid": "721a34f2335cc563c43d291fa2dd81e30d1c5c42", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/721a34f2335cc563c43d291fa2dd81e30d1c5c42", "committedDate": "2020-05-28T11:37:55Z", "message": "CB-7104 Add resource based Auth for Freeipa api"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwNDkwMTE5", "url": "https://github.com/hortonworks/cloudbreak/pull/8121#pullrequestreview-420490119", "createdAt": "2020-05-28T21:03:22Z", "commit": {"oid": "721a34f2335cc563c43d291fa2dd81e30d1c5c42"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "721a34f2335cc563c43d291fa2dd81e30d1c5c42", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/721a34f2335cc563c43d291fa2dd81e30d1c5c42", "committedDate": "2020-05-28T11:37:55Z", "message": "CB-7104 Add resource based Auth for Freeipa api"}, "afterCommit": {"oid": "ca6964e4b808af664099d6d67e71387591a8833c", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/ca6964e4b808af664099d6d67e71387591a8833c", "committedDate": "2020-05-29T10:09:35Z", "message": "CB-7104 Add resource based Auth for Freeipa api"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ca6964e4b808af664099d6d67e71387591a8833c", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/ca6964e4b808af664099d6d67e71387591a8833c", "committedDate": "2020-05-29T10:09:35Z", "message": "CB-7104 Add resource based Auth for Freeipa api"}, "afterCommit": {"oid": "d787926bfeeff982cf9263806076a39d4cbbc632", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/d787926bfeeff982cf9263806076a39d4cbbc632", "committedDate": "2020-05-29T10:16:09Z", "message": "CB-7104 Add resource based Auth for Freeipa api"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d787926bfeeff982cf9263806076a39d4cbbc632", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/d787926bfeeff982cf9263806076a39d4cbbc632", "committedDate": "2020-05-29T10:16:09Z", "message": "CB-7104 Add resource based Auth for Freeipa api"}, "afterCommit": {"oid": "a574d093ed8c0f44d4da5ab4cadebaeddacd36c6", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/a574d093ed8c0f44d4da5ab4cadebaeddacd36c6", "committedDate": "2020-06-02T11:56:33Z", "message": "CB-7104 Add resource based Auth for Freeipa api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0122b5160275ecee5dec618b25f29b30067defbb", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/0122b5160275ecee5dec618b25f29b30067defbb", "committedDate": "2020-06-03T05:49:06Z", "message": "CB-7104 Add resource based Auth for Freeipa api"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a574d093ed8c0f44d4da5ab4cadebaeddacd36c6", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/a574d093ed8c0f44d4da5ab4cadebaeddacd36c6", "committedDate": "2020-06-02T11:56:33Z", "message": "CB-7104 Add resource based Auth for Freeipa api"}, "afterCommit": {"oid": "0122b5160275ecee5dec618b25f29b30067defbb", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/0122b5160275ecee5dec618b25f29b30067defbb", "committedDate": "2020-06-03T05:49:06Z", "message": "CB-7104 Add resource based Auth for Freeipa api"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzMzI1MDY2", "url": "https://github.com/hortonworks/cloudbreak/pull/8121#pullrequestreview-423325066", "createdAt": "2020-06-03T08:21:41Z", "commit": {"oid": "0122b5160275ecee5dec618b25f29b30067defbb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1874, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}