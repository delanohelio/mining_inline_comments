{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM2NTc1NjUy", "number": 8334, "title": "CB-6013 Azure cluster creation fails due to interruption during subscription", "bodyText": "@keyki or @pdarvasi pls review", "createdAt": "2020-06-18T15:52:01Z", "url": "https://github.com/hortonworks/cloudbreak/pull/8334", "merged": true, "mergeCommit": {"oid": "c70eb9720b845a42530b43f60cba0a1382188777"}, "closed": true, "closedAt": "2020-06-23T09:54:25Z", "author": {"login": "schfeca75"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcshRtxABqjM0NTkwOTQxMTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABct3VivgBqjM0NzAxNDk5NzU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "51309b3acd7491b8b137717647e85129b37f0a21", "author": {"user": {"login": "schfeca75", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/51309b3acd7491b8b137717647e85129b37f0a21", "committedDate": "2020-06-18T15:42:37Z", "message": "CB-6013 Azure cluster creation fails due to interruption during subscription"}, "afterCommit": {"oid": "4d2d90daa4888b224b2f8fde4e9f66d3d16c4267", "author": {"user": {"login": "schfeca75", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/4d2d90daa4888b224b2f8fde4e9f66d3d16c4267", "committedDate": "2020-06-18T16:43:52Z", "message": "CB-6013 Azure cluster creation fails due to interruption during subscription"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4d2d90daa4888b224b2f8fde4e9f66d3d16c4267", "author": {"user": {"login": "schfeca75", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/4d2d90daa4888b224b2f8fde4e9f66d3d16c4267", "committedDate": "2020-06-18T16:43:52Z", "message": "CB-6013 Azure cluster creation fails due to interruption during subscription"}, "afterCommit": {"oid": "3ae18c5c243637ce2706b46479fd0ba2d30d9827", "author": {"user": {"login": "schfeca75", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/3ae18c5c243637ce2706b46479fd0ba2d30d9827", "committedDate": "2020-06-18T17:21:40Z", "message": "CB-6013 Azure cluster creation fails due to interruption during subscription"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3ae18c5c243637ce2706b46479fd0ba2d30d9827", "author": {"user": {"login": "schfeca75", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/3ae18c5c243637ce2706b46479fd0ba2d30d9827", "committedDate": "2020-06-18T17:21:40Z", "message": "CB-6013 Azure cluster creation fails due to interruption during subscription"}, "afterCommit": {"oid": "4920093688a1b570840fee1feadba79c29ec80f1", "author": {"user": {"login": "schfeca75", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/4920093688a1b570840fee1feadba79c29ec80f1", "committedDate": "2020-06-22T10:12:03Z", "message": "CB-6013 Azure cluster creation fails due to interruption during subscription"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0ODQ3NTEw", "url": "https://github.com/hortonworks/cloudbreak/pull/8334#pullrequestreview-434847510", "createdAt": "2020-06-22T11:49:02Z", "commit": {"oid": "4920093688a1b570840fee1feadba79c29ec80f1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQxMTo0OTowMlrOGm9O8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQxMTo0OTowMlrOGm9O8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzUwMjMyMQ==", "bodyText": "Can you add some log lines please that we're detaching the disk or fi we're not doing anything as it's already attached.", "url": "https://github.com/hortonworks/cloudbreak/pull/8334#discussion_r443502321", "createdAt": "2020-06-22T11:49:02Z", "author": {"login": "keyki"}, "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/resource/AzureAttachmentResourceBuilder.java", "diffHunk": "@@ -47,23 +50,30 @@\n                 .findFirst()\n                 .orElseThrow(() -> new AzureResourceException(\"Instance resource not found\"));\n \n+        CloudContext cloudContext = auth.getCloudContext();\n+        String resourceGroupName = azureResourceGroupMetadataProvider.getResourceGroupName(cloudContext, cloudStack);\n+        AzureClient client = getAzureClient(auth);\n+        VirtualMachine vm = client.getVirtualMachine(resourceGroupName, instance.getName());\n+        Set<String> diskIds = vm.dataDisks().values().stream().map(VirtualMachineDataDisk::id).collect(Collectors.toSet());\n+\n         CloudResource volumeSet = buildableResource.stream()\n                 .filter(cloudResource -> cloudResource.getType().equals(ResourceType.AZURE_VOLUMESET))\n                 .filter(cloudResource -> !instance.getInstanceId().equals(cloudResource.getInstanceId()))\n                 .findFirst()\n                 .orElseThrow(() -> new AzureResourceException(\"Volume set resource not found\"));\n \n-        CloudContext cloudContext = auth.getCloudContext();\n-        String resourceGroupName = azureResourceGroupMetadataProvider.getResourceGroupName(cloudContext, cloudStack);\n-        AzureClient client = getAzureClient(auth);\n \n         VolumeSetAttributes volumeSetAttributes = getVolumeSetAttributes(volumeSet);\n         volumeSetAttributes.getVolumes()\n                 .forEach(volume -> {\n-                            Disk disk = client.getDiskById(volume.getId());\n-                            VirtualMachine vm = client.getVirtualMachine(resourceGroupName, instance.getName());\n-                            client.attachDiskToVm(disk, vm);\n-                        });\n+                    Disk disk = client.getDiskById(volume.getId());\n+                    if (!diskIds.contains(disk.id())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4920093688a1b570840fee1feadba79c29ec80f1"}, "originalPosition": 45}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0ODQ4NjM1", "url": "https://github.com/hortonworks/cloudbreak/pull/8334#pullrequestreview-434848635", "createdAt": "2020-06-22T11:50:47Z", "commit": {"oid": "4920093688a1b570840fee1feadba79c29ec80f1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQxMTo1MDo0OFrOGm9STQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQxMTo1MDo0OFrOGm9STQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzUwMzE4MQ==", "bodyText": "Can you add a logline that the disk already exists and we're not doing anything.", "url": "https://github.com/hortonworks/cloudbreak/pull/8334#discussion_r443503181", "createdAt": "2020-06-22T11:50:48Z", "author": {"login": "keyki"}, "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/resource/AzureVolumeResourceBuilder.java", "diffHunk": "@@ -155,9 +157,12 @@ private String getAvailabilityZone(AuthenticatedContext auth, CloudResource vm)\n             DeviceNameGenerator generator = new DeviceNameGenerator();\n             futures.addAll(volumeSet.getVolumes().stream()\n                     .map(volume -> intermediateBuilderExecutor.submit(() -> {\n-                        Disk result = client.createManagedDisk(\n-                                volume.getId(), volume.getSize(), AzureDiskType.getByValue(\n-                                        volume.getType()), region, resourceGroupName, cloudStack.getTags());\n+                        Disk result = client.getDiskByName(resourceGroupName, volume.getId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4920093688a1b570840fee1feadba79c29ec80f1"}, "originalPosition": 51}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0ODgzNDg2", "url": "https://github.com/hortonworks/cloudbreak/pull/8334#pullrequestreview-434883486", "createdAt": "2020-06-22T12:41:20Z", "commit": {"oid": "4920093688a1b570840fee1feadba79c29ec80f1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQxMjo0MToyMFrOGm-4Lw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQxMjo0MToyMFrOGm-4Lw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzUyOTI2Mw==", "bodyText": "Can you change it to 60 please?", "url": "https://github.com/hortonworks/cloudbreak/pull/8334#discussion_r443529263", "createdAt": "2020-06-22T12:41:20Z", "author": {"login": "keyki"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/conf/AppConfig.java", "diffHunk": "@@ -61,9 +61,10 @@\n @Configuration\n @EnableRetry\n public class AppConfig implements ResourceLoaderAware {\n-\n     private static final Logger LOGGER = LoggerFactory.getLogger(AppConfig.class);\n \n+    private static final int AWAIT_TERMINATION_SECONDS = 120;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4920093688a1b570840fee1feadba79c29ec80f1"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1MDM1MzQ3", "url": "https://github.com/hortonworks/cloudbreak/pull/8334#pullrequestreview-435035347", "createdAt": "2020-06-22T15:26:34Z", "commit": {"oid": "4920093688a1b570840fee1feadba79c29ec80f1"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQxNToyNjozNFrOGnFxkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQxNTo0NTo0OVrOGnGk4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY0MjI1OA==", "bodyText": "We should at least log if RESOURCE_CRN_PARAMETER is not set in the stack, that should never happen, right?", "url": "https://github.com/hortonworks/cloudbreak/pull/8334#discussion_r443642258", "createdAt": "2020-06-22T15:26:34Z", "author": {"login": "pdarvasi"}, "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/connector/resource/AzureComputeResourceService.java", "diffHunk": "@@ -59,10 +58,16 @@\n \n     public List<CloudResourceStatus> deleteComputeResources(AuthenticatedContext ac, CloudStack stack, List<CloudResource> cloudResources,\n             List<CloudResource> networkResources) {\n-        CloudContext cloudContext = ac.getCloudContext();\n-        ResourceBuilderContext context = contextBuilder.contextInit(cloudContext, ac, stack.getNetwork(), null, true);\n+        ResourceBuilderContext context = initContext(ac, stack);\n         context.addNetworkResources(networkResources);\n \n         return computeResourceService.deleteResources(context, ac, cloudResources, false);\n     }\n+\n+    private AzureContext initContext(AuthenticatedContext ac, CloudStack cloudStack) {\n+        AzureContext context = contextBuilder.contextInit(ac.getCloudContext(), ac, cloudStack.getNetwork(), null, true);\n+        context.putParameter(PlatformParametersConsts.RESOURCE_CRN_PARAMETER,\n+                cloudStack.getParameters().getOrDefault(PlatformParametersConsts.RESOURCE_CRN_PARAMETER, \"\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4920093688a1b570840fee1feadba79c29ec80f1"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY0NjAyMQ==", "bodyText": "Detaching has the log in detachDiskFromVm() method, attaching in attachDiskToVm()", "url": "https://github.com/hortonworks/cloudbreak/pull/8334#discussion_r443646021", "createdAt": "2020-06-22T15:31:56Z", "author": {"login": "pdarvasi"}, "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/resource/AzureAttachmentResourceBuilder.java", "diffHunk": "@@ -47,23 +50,30 @@\n                 .findFirst()\n                 .orElseThrow(() -> new AzureResourceException(\"Instance resource not found\"));\n \n+        CloudContext cloudContext = auth.getCloudContext();\n+        String resourceGroupName = azureResourceGroupMetadataProvider.getResourceGroupName(cloudContext, cloudStack);\n+        AzureClient client = getAzureClient(auth);\n+        VirtualMachine vm = client.getVirtualMachine(resourceGroupName, instance.getName());\n+        Set<String> diskIds = vm.dataDisks().values().stream().map(VirtualMachineDataDisk::id).collect(Collectors.toSet());\n+\n         CloudResource volumeSet = buildableResource.stream()\n                 .filter(cloudResource -> cloudResource.getType().equals(ResourceType.AZURE_VOLUMESET))\n                 .filter(cloudResource -> !instance.getInstanceId().equals(cloudResource.getInstanceId()))\n                 .findFirst()\n                 .orElseThrow(() -> new AzureResourceException(\"Volume set resource not found\"));\n \n-        CloudContext cloudContext = auth.getCloudContext();\n-        String resourceGroupName = azureResourceGroupMetadataProvider.getResourceGroupName(cloudContext, cloudStack);\n-        AzureClient client = getAzureClient(auth);\n \n         VolumeSetAttributes volumeSetAttributes = getVolumeSetAttributes(volumeSet);\n         volumeSetAttributes.getVolumes()\n                 .forEach(volume -> {\n-                            Disk disk = client.getDiskById(volume.getId());\n-                            VirtualMachine vm = client.getVirtualMachine(resourceGroupName, instance.getName());\n-                            client.attachDiskToVm(disk, vm);\n-                        });\n+                    Disk disk = client.getDiskById(volume.getId());\n+                    if (!diskIds.contains(disk.id())) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzUwMjMyMQ=="}, "originalCommit": {"oid": "4920093688a1b570840fee1feadba79c29ec80f1"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY0ODA0OA==", "bodyText": "Not scope of PR, but detaching and attaching could be done parallel for multiple volumes if they are longish-running", "url": "https://github.com/hortonworks/cloudbreak/pull/8334#discussion_r443648048", "createdAt": "2020-06-22T15:35:02Z", "author": {"login": "pdarvasi"}, "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/resource/AzureAttachmentResourceBuilder.java", "diffHunk": "@@ -47,23 +50,30 @@\n                 .findFirst()\n                 .orElseThrow(() -> new AzureResourceException(\"Instance resource not found\"));\n \n+        CloudContext cloudContext = auth.getCloudContext();\n+        String resourceGroupName = azureResourceGroupMetadataProvider.getResourceGroupName(cloudContext, cloudStack);\n+        AzureClient client = getAzureClient(auth);\n+        VirtualMachine vm = client.getVirtualMachine(resourceGroupName, instance.getName());\n+        Set<String> diskIds = vm.dataDisks().values().stream().map(VirtualMachineDataDisk::id).collect(Collectors.toSet());\n+\n         CloudResource volumeSet = buildableResource.stream()\n                 .filter(cloudResource -> cloudResource.getType().equals(ResourceType.AZURE_VOLUMESET))\n                 .filter(cloudResource -> !instance.getInstanceId().equals(cloudResource.getInstanceId()))\n                 .findFirst()\n                 .orElseThrow(() -> new AzureResourceException(\"Volume set resource not found\"));\n \n-        CloudContext cloudContext = auth.getCloudContext();\n-        String resourceGroupName = azureResourceGroupMetadataProvider.getResourceGroupName(cloudContext, cloudStack);\n-        AzureClient client = getAzureClient(auth);\n \n         VolumeSetAttributes volumeSetAttributes = getVolumeSetAttributes(volumeSet);\n         volumeSetAttributes.getVolumes()\n                 .forEach(volume -> {\n-                            Disk disk = client.getDiskById(volume.getId());\n-                            VirtualMachine vm = client.getVirtualMachine(resourceGroupName, instance.getName());\n-                            client.attachDiskToVm(disk, vm);\n-                        });\n+                    Disk disk = client.getDiskById(volume.getId());\n+                    if (!diskIds.contains(disk.id())) {\n+                        if (disk.isAttachedToVirtualMachine()) {\n+                            client.detachDiskFromVm(disk.id(), client.getVirtualMachine(disk.virtualMachineId()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4920093688a1b570840fee1feadba79c29ec80f1"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY1MjExMg==", "bodyText": "We should log all the generated resource names here.", "url": "https://github.com/hortonworks/cloudbreak/pull/8334#discussion_r443652112", "createdAt": "2020-06-22T15:40:57Z", "author": {"login": "pdarvasi"}, "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/service/AzureResourceNameService.java", "diffHunk": "@@ -43,20 +41,20 @@ public String resourceName(ResourceType resourceType, Object... parts) {\n \n     private String volumeSetResourceName(Object[] parts) {\n         checkArgs(VOLUMESET_PART_COUNT, parts);\n+        String hash = String.valueOf(parts[VOLUMESET_PART_COUNT - 1]);\n         String name = instanceName(parts);\n-        name = trimHash(name);\n-        name = appendHash(name, new Date());\n+        name = appendHash(name, hash);\n         name = adjustBaseLength(name, maxResourceNameLength);\n         return name;\n     }\n \n     private String attachedDiskResourceName(Object[] parts) {\n         checkArgs(ATTACHED_DISKS_PART_COUNT, parts);\n-        String cnt = String.valueOf(parts[ATTACHED_DISKS_PART_COUNT - 1]);\n+        String cnt = String.valueOf(parts[ATTACHED_DISKS_PART_COUNT - 2]);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4920093688a1b570840fee1feadba79c29ec80f1"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY1MzQwNg==", "bodyText": "minor typo: it has thrown --> it has been thrown", "url": "https://github.com/hortonworks/cloudbreak/pull/8334#discussion_r443653406", "createdAt": "2020-06-22T15:42:51Z", "author": {"login": "pdarvasi"}, "path": "cloud-reactor/src/main/java/com/sequenceiq/cloudbreak/cloud/handler/LaunchStackHandler.java", "diffHunk": "@@ -73,6 +74,9 @@ public void accept(Event<LaunchStackRequest> launchStackRequestEvent) {\n             eventBus.notify(result.selector(), new Event<>(launchStackRequestEvent.getHeaders(), result));\n             LOGGER.debug(\"Launching the stack successfully finished for {}\", cloudContext);\n         } catch (Exception e) {\n+            if (ExceptionUtils.getRootCause(e) instanceof InterruptedException) {\n+                LOGGER.info(\"Interrupted exception is ignored as it has thrown because of graceful shutdown of the java process.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4920093688a1b570840fee1feadba79c29ec80f1"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY1NTM5NA==", "bodyText": "I would pass the cut length as param instead of always taking DATE_FORMAT.length", "url": "https://github.com/hortonworks/cloudbreak/pull/8334#discussion_r443655394", "createdAt": "2020-06-22T15:45:49Z", "author": {"login": "pdarvasi"}, "path": "cloud-reactor/src/main/java/com/sequenceiq/cloudbreak/cloud/service/CloudbreakResourceNameService.java", "diffHunk": "@@ -119,6 +120,8 @@ protected String appendHash(String name, Date timestamp) {\n         DateFormat df = new SimpleDateFormat(DATE_FORMAT);\n         return Joiner.on(\"\").join(name, DELIMITER, df.format(timestamp));\n     }\n-}\n-\n \n+    protected String appendHash(String name, String toBeHashed) {\n+        return Joiner.on(\"\").join(name, DELIMITER, DigestUtils.md5DigestAsHex(toBeHashed.getBytes()).substring(0, DATE_FORMAT.length()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4920093688a1b570840fee1feadba79c29ec80f1"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0219e77e54107970794ffb746208c7fc88dcc593", "author": {"user": {"login": "schfeca75", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/0219e77e54107970794ffb746208c7fc88dcc593", "committedDate": "2020-06-22T21:00:37Z", "message": "CB-6013 Azure cluster creation fails due to interruption during subscription"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4920093688a1b570840fee1feadba79c29ec80f1", "author": {"user": {"login": "schfeca75", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/4920093688a1b570840fee1feadba79c29ec80f1", "committedDate": "2020-06-22T10:12:03Z", "message": "CB-6013 Azure cluster creation fails due to interruption during subscription"}, "afterCommit": {"oid": "0219e77e54107970794ffb746208c7fc88dcc593", "author": {"user": {"login": "schfeca75", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/0219e77e54107970794ffb746208c7fc88dcc593", "committedDate": "2020-06-22T21:00:37Z", "message": "CB-6013 Azure cluster creation fails due to interruption during subscription"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1737, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}