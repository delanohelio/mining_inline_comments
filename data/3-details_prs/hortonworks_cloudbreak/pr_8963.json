{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgzMDEzMzU0", "number": 8963, "title": "CB-8659 restart services after repair", "bodyText": "See detailed description in the commit message.", "createdAt": "2020-09-09T17:32:05Z", "url": "https://github.com/hortonworks/cloudbreak/pull/8963", "merged": true, "mergeCommit": {"oid": "78201171dc9a5581f062072fbac14611d482a27f"}, "closed": true, "closedAt": "2020-10-02T08:14:53Z", "author": {"login": "sodre90"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdHeHeGgBqjM3NTAyMDM0Nzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdONA-EAFqTUwMDExMzM2MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b4eeac10dace2c277a91a0660d6847a107b7302e", "author": {"user": {"login": "sodre90", "name": "Erd\u0151s P\u00e9ter"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/b4eeac10dace2c277a91a0660d6847a107b7302e", "committedDate": "2020-09-09T17:30:11Z", "message": "CB-8659 restart services after repair"}, "afterCommit": {"oid": "bd519bc7f139e1bb455ce3fc5d8a6e175bc65656", "author": {"user": {"login": "sodre90", "name": "Erd\u0151s P\u00e9ter"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/bd519bc7f139e1bb455ce3fc5d8a6e175bc65656", "committedDate": "2020-09-10T10:19:41Z", "message": "CB-8659 restart services after repair"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2MDEyODcx", "url": "https://github.com/hortonworks/cloudbreak/pull/8963#pullrequestreview-486012871", "createdAt": "2020-09-10T14:45:16Z", "commit": {"oid": "bd519bc7f139e1bb455ce3fc5d8a6e175bc65656"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNDo0NToxNlrOHP3pkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNDo0NToxNlrOHP3pkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQwMjQ1MQ==", "bodyText": "Is this going to work if both master and idbroker are down? I think after we replace the master we will try to restart the services which is going to fail.", "url": "https://github.com/hortonworks/cloudbreak/pull/8963#discussion_r486402451", "createdAt": "2020-09-10T14:45:16Z", "author": {"login": "keyki"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/core/cluster/ClusterUpscaleService.java", "diffHunk": "@@ -103,6 +103,14 @@ public void installServicesOnNewHosts(Long stackId, String hostGroupName) throws\n         recipeEngine.executePostAmbariStartRecipes(stack, hostGroup.getRecipes());\n         ClusterApi connector = clusterApiConnectors.getConnector(stack);\n         List<String> upscaledHosts = connector.upscaleCluster(hostGroup, runningInstanceMetaDataSet);\n+        if (repair) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd519bc7f139e1bb455ce3fc5d8a6e175bc65656"}, "originalPosition": 13}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "68279e742b18b7a2ea05fd3b6764b706ac3a9330", "author": {"user": {"login": "sodre90", "name": "Erd\u0151s P\u00e9ter"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/68279e742b18b7a2ea05fd3b6764b706ac3a9330", "committedDate": "2020-09-21T10:31:11Z", "message": "CB-8700 optimizations for IT test"}, "afterCommit": {"oid": "769a8de31b28c95f181644be17b62b8d694ad215", "author": {"user": {"login": "foldik", "name": "Attila Kristof Foldi"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/769a8de31b28c95f181644be17b62b8d694ad215", "committedDate": "2020-09-22T10:04:58Z", "message": "CB-8824 Can't repair SDX if both hostgroup is stopped"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "769a8de31b28c95f181644be17b62b8d694ad215", "author": {"user": {"login": "foldik", "name": "Attila Kristof Foldi"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/769a8de31b28c95f181644be17b62b8d694ad215", "committedDate": "2020-09-22T10:04:58Z", "message": "CB-8824 Can't repair SDX if both hostgroup is stopped"}, "afterCommit": {"oid": "0242a3a3d402ce37dbb53d0ac0cf5889647c998b", "author": {"user": {"login": "foldik", "name": "Attila Kristof Foldi"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/0242a3a3d402ce37dbb53d0ac0cf5889647c998b", "committedDate": "2020-09-22T10:29:23Z", "message": "CB-8824 Can't repair SDX if both hostgroup is stopped"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0242a3a3d402ce37dbb53d0ac0cf5889647c998b", "author": {"user": {"login": "foldik", "name": "Attila Kristof Foldi"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/0242a3a3d402ce37dbb53d0ac0cf5889647c998b", "committedDate": "2020-09-22T10:29:23Z", "message": "CB-8824 Can't repair SDX if both hostgroup is stopped"}, "afterCommit": {"oid": "2d25a0c803931c997454c0cfb8b431931e1e3dd2", "author": {"user": {"login": "sodre90", "name": "Erd\u0151s P\u00e9ter"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/2d25a0c803931c997454c0cfb8b431931e1e3dd2", "committedDate": "2020-09-23T15:08:57Z", "message": "CB-8659 restart services after repair"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2d25a0c803931c997454c0cfb8b431931e1e3dd2", "author": {"user": {"login": "sodre90", "name": "Erd\u0151s P\u00e9ter"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/2d25a0c803931c997454c0cfb8b431931e1e3dd2", "committedDate": "2020-09-23T15:08:57Z", "message": "CB-8659 restart services after repair"}, "afterCommit": {"oid": "988c3ac64232023b3ebfd81a2243f60d485e0b97", "author": {"user": {"login": "sodre90", "name": "Erd\u0151s P\u00e9ter"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/988c3ac64232023b3ebfd81a2243f60d485e0b97", "committedDate": "2020-09-24T08:16:54Z", "message": "CB-8659 restart services after repair"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59478ff8d9834ab659f8092d2ee85665ee94d439", "author": {"user": {"login": "sodre90", "name": "Erd\u0151s P\u00e9ter"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/59478ff8d9834ab659f8092d2ee85665ee94d439", "committedDate": "2020-09-24T13:49:40Z", "message": "CB-8659 restart services after repair"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "988c3ac64232023b3ebfd81a2243f60d485e0b97", "author": {"user": {"login": "sodre90", "name": "Erd\u0151s P\u00e9ter"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/988c3ac64232023b3ebfd81a2243f60d485e0b97", "committedDate": "2020-09-24T08:16:54Z", "message": "CB-8659 restart services after repair"}, "afterCommit": {"oid": "59478ff8d9834ab659f8092d2ee85665ee94d439", "author": {"user": {"login": "sodre90", "name": "Erd\u0151s P\u00e9ter"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/59478ff8d9834ab659f8092d2ee85665ee94d439", "committedDate": "2020-09-24T13:49:40Z", "message": "CB-8659 restart services after repair"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5MjA1MDg2", "url": "https://github.com/hortonworks/cloudbreak/pull/8963#pullrequestreview-499205086", "createdAt": "2020-09-30T08:37:07Z", "commit": {"oid": "59478ff8d9834ab659f8092d2ee85665ee94d439"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQwODozNzowN1rOHaTIaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQwODo0Mjo1M1rOHaTWhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzMzODQ3Mg==", "bodyText": "Why the wrapper type instead of the primitive?", "url": "https://github.com/hortonworks/cloudbreak/pull/8963#discussion_r497338472", "createdAt": "2020-09-30T08:37:07Z", "author": {"login": "foldik"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/core/flow2/cluster/upscale/ClusterUpscaleContext.java", "diffHunk": "@@ -16,14 +16,20 @@\n \n     private final ClusterManagerType clusterManagerType;\n \n+    private final Boolean repair;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59478ff8d9834ab659f8092d2ee85665ee94d439"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM0MDg2Nw==", "bodyText": "How much time does it take to restart all the services? Does it make the repair a lot longer?", "url": "https://github.com/hortonworks/cloudbreak/pull/8963#discussion_r497340867", "createdAt": "2020-09-30T08:40:51Z", "author": {"login": "foldik"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/core/cluster/ClusterUpscaleService.java", "diffHunk": "@@ -94,15 +94,23 @@ public void uploadRecipesOnNewHosts(Long stackId, String hostGroupName) throws C\n         recipeEngine.uploadUpscaleRecipes(stack, hostGroup, hostGroups);\n     }\n \n-    public void installServicesOnNewHosts(Long stackId, String hostGroupName) throws CloudbreakException {\n+    public void installServicesOnNewHosts(Long stackId, String hostGroupName, Boolean repair, Boolean restartServices) throws CloudbreakException {\n         Stack stack = stackService.getByIdWithClusterInTransaction(stackId);\n-        LOGGER.debug(\"Start installing Ambari services\");\n+        LOGGER.debug(\"Start installing CM services\");\n         HostGroup hostGroup = Optional.ofNullable(hostGroupService.getByClusterIdAndNameWithRecipes(stack.getCluster().getId(), hostGroupName))\n                 .orElseThrow(NotFoundException.notFound(\"hostgroup\", hostGroupName));\n         Set<InstanceMetaData> runningInstanceMetaDataSet = hostGroup.getInstanceGroup().getRunningInstanceMetaDataSet();\n         recipeEngine.executePostAmbariStartRecipes(stack, hostGroup.getRecipes());\n         ClusterApi connector = clusterApiConnectors.getConnector(stack);\n         List<String> upscaledHosts = connector.upscaleCluster(hostGroup, runningInstanceMetaDataSet);\n+        if (shouldRestartServices(repair, restartServices, stack)) {\n+            try {\n+                LOGGER.info(\"Trying to restart services\");\n+                connector.restartAll();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59478ff8d9834ab659f8092d2ee85665ee94d439"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM0MjA4NA==", "bodyText": "What if all restartAll fail? Will we show the cluster as healthy or the flow will fail later?", "url": "https://github.com/hortonworks/cloudbreak/pull/8963#discussion_r497342084", "createdAt": "2020-09-30T08:42:53Z", "author": {"login": "foldik"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/core/cluster/ClusterUpscaleService.java", "diffHunk": "@@ -94,15 +94,23 @@ public void uploadRecipesOnNewHosts(Long stackId, String hostGroupName) throws C\n         recipeEngine.uploadUpscaleRecipes(stack, hostGroup, hostGroups);\n     }\n \n-    public void installServicesOnNewHosts(Long stackId, String hostGroupName) throws CloudbreakException {\n+    public void installServicesOnNewHosts(Long stackId, String hostGroupName, Boolean repair, Boolean restartServices) throws CloudbreakException {\n         Stack stack = stackService.getByIdWithClusterInTransaction(stackId);\n-        LOGGER.debug(\"Start installing Ambari services\");\n+        LOGGER.debug(\"Start installing CM services\");\n         HostGroup hostGroup = Optional.ofNullable(hostGroupService.getByClusterIdAndNameWithRecipes(stack.getCluster().getId(), hostGroupName))\n                 .orElseThrow(NotFoundException.notFound(\"hostgroup\", hostGroupName));\n         Set<InstanceMetaData> runningInstanceMetaDataSet = hostGroup.getInstanceGroup().getRunningInstanceMetaDataSet();\n         recipeEngine.executePostAmbariStartRecipes(stack, hostGroup.getRecipes());\n         ClusterApi connector = clusterApiConnectors.getConnector(stack);\n         List<String> upscaledHosts = connector.upscaleCluster(hostGroup, runningInstanceMetaDataSet);\n+        if (shouldRestartServices(repair, restartServices, stack)) {\n+            try {\n+                LOGGER.info(\"Trying to restart services\");\n+                connector.restartAll();\n+            } catch (RuntimeException e) {\n+                LOGGER.info(\"Restart services failed\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59478ff8d9834ab659f8092d2ee85665ee94d439"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwMTEzMzYx", "url": "https://github.com/hortonworks/cloudbreak/pull/8963#pullrequestreview-500113361", "createdAt": "2020-10-01T08:22:00Z", "commit": {"oid": "59478ff8d9834ab659f8092d2ee85665ee94d439"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2288, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}