{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYzOTQyNTE2", "number": 8733, "title": "CB-8152 stopped stack sync wont state delete failed status when insta\u2026", "bodyText": "when stack was in stopped state and some instances was deleted on provided then the sync put the stack delete failed status. this fix will let it in stop status\nCloses CB-8152", "createdAt": "2020-08-06T10:37:31Z", "url": "https://github.com/hortonworks/cloudbreak/pull/8733", "merged": true, "mergeCommit": {"oid": "13130303917b8cb203203b295378d05bc1e39932"}, "closed": true, "closedAt": "2020-08-17T11:08:57Z", "author": {"login": "afarsang"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc8f6BLAFqTQ2MzExOTAxMQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc_wbhegFqTQ2ODM3MDc4OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzMTE5MDEx", "url": "https://github.com/hortonworks/cloudbreak/pull/8733#pullrequestreview-463119011", "createdAt": "2020-08-07T08:11:58Z", "commit": {"oid": "48a03d20956d4d30c5873138e10985ae29867019"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwODoxMTo1OFrOG9Qv_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwODoxMTo1OFrOG9Qv_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njg5MDc1MQ==", "bodyText": "what if every nodes are stopped?", "url": "https://github.com/hortonworks/cloudbreak/pull/8733#discussion_r466890751", "createdAt": "2020-08-07T08:11:58Z", "author": {"login": "sodre90"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/service/stack/flow/StackSyncService.java", "diffHunk": "@@ -206,24 +206,20 @@ private void deleteResourceIfNeeded(Stack stack, InstanceMetaData instance) {\n     }\n \n     private void handleSyncResult(Stack stack, Map<InstanceSyncState, Integer> instanceStateCounts, boolean stackStatusUpdateEnabled) {\n-        Set<InstanceMetaData> instances = instanceMetaDataRepository.findNotTerminatedForStack(stack.getId());\n         if (instanceStateCounts.get(InstanceSyncState.UNKNOWN) > 0) {\n             eventService.fireCloudbreakEvent(stack.getId(), AVAILABLE.name(),\n                     cloudbreakMessagesService.getMessage(Msg.STACK_SYNC_INSTANCE_STATUS_COULDNT_DETERMINE.code()));\n         } else if (instanceStateCounts.get(InstanceSyncState.IN_PROGRESS) > 0) {\n             eventService.fireCloudbreakEvent(stack.getId(), AVAILABLE.name(),\n                     cloudbreakMessagesService.getMessage(Msg.STACK_SYNC_INSTANCE_OPERATION_IN_PROGRESS.code()));\n-        } else if (instanceStateCounts.get(InstanceSyncState.RUNNING) > 0 && instanceStateCounts.get(InstanceSyncState.STOPPED) > 0) {\n+        } else if ((instanceStateCounts.get(InstanceSyncState.RUNNING) >= 0 || (instanceStateCounts.get(InstanceSyncState.DELETED_ON_PROVIDER_SIDE) >= 0))\n+                && instanceStateCounts.get(InstanceSyncState.STOPPED) > 0) {\n             eventService.fireCloudbreakEvent(stack.getId(), STOPPED.name(),\n                     cloudbreakMessagesService.getMessage(Msg.STACK_SYNC_INSTANCE_STOPPED_ON_PROVIDER.code()));\n         } else if (instanceStateCounts.get(InstanceSyncState.RUNNING) > 0) {\n             updateStackStatusIfEnabled(stack.getId(), DetailedStackStatus.AVAILABLE, SYNC_STATUS_REASON, stackStatusUpdateEnabled);\n             eventService.fireCloudbreakEvent(stack.getId(), AVAILABLE.name(),\n                     cloudbreakMessagesService.getMessage(Msg.STACK_SYNC_INSTANCE_STATE_SYNCED.code()));\n-        } else if (instanceStateCounts.get(InstanceSyncState.STOPPED).equals(instances.size())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48a03d20956d4d30c5873138e10985ae29867019"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0OTAxNjY3", "url": "https://github.com/hortonworks/cloudbreak/pull/8733#pullrequestreview-464901667", "createdAt": "2020-08-11T09:31:51Z", "commit": {"oid": "48a03d20956d4d30c5873138e10985ae29867019"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwOTozMTo1MlrOG-v8PQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwOTozMjo0MVrOG-v-Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQ1MDM2NQ==", "bodyText": "Which if clause handles that use-case? Why was the original \"else if\" deleted?", "url": "https://github.com/hortonworks/cloudbreak/pull/8733#discussion_r468450365", "createdAt": "2020-08-11T09:31:52Z", "author": {"login": "pdarvasi"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/service/stack/flow/StackSyncService.java", "diffHunk": "@@ -206,24 +206,20 @@ private void deleteResourceIfNeeded(Stack stack, InstanceMetaData instance) {\n     }\n \n     private void handleSyncResult(Stack stack, Map<InstanceSyncState, Integer> instanceStateCounts, boolean stackStatusUpdateEnabled) {\n-        Set<InstanceMetaData> instances = instanceMetaDataRepository.findNotTerminatedForStack(stack.getId());\n         if (instanceStateCounts.get(InstanceSyncState.UNKNOWN) > 0) {\n             eventService.fireCloudbreakEvent(stack.getId(), AVAILABLE.name(),\n                     cloudbreakMessagesService.getMessage(Msg.STACK_SYNC_INSTANCE_STATUS_COULDNT_DETERMINE.code()));\n         } else if (instanceStateCounts.get(InstanceSyncState.IN_PROGRESS) > 0) {\n             eventService.fireCloudbreakEvent(stack.getId(), AVAILABLE.name(),\n                     cloudbreakMessagesService.getMessage(Msg.STACK_SYNC_INSTANCE_OPERATION_IN_PROGRESS.code()));\n-        } else if (instanceStateCounts.get(InstanceSyncState.RUNNING) > 0 && instanceStateCounts.get(InstanceSyncState.STOPPED) > 0) {\n+        } else if ((instanceStateCounts.get(InstanceSyncState.RUNNING) >= 0 || (instanceStateCounts.get(InstanceSyncState.DELETED_ON_PROVIDER_SIDE) >= 0))\n+                && instanceStateCounts.get(InstanceSyncState.STOPPED) > 0) {\n             eventService.fireCloudbreakEvent(stack.getId(), STOPPED.name(),\n                     cloudbreakMessagesService.getMessage(Msg.STACK_SYNC_INSTANCE_STOPPED_ON_PROVIDER.code()));\n         } else if (instanceStateCounts.get(InstanceSyncState.RUNNING) > 0) {\n             updateStackStatusIfEnabled(stack.getId(), DetailedStackStatus.AVAILABLE, SYNC_STATUS_REASON, stackStatusUpdateEnabled);\n             eventService.fireCloudbreakEvent(stack.getId(), AVAILABLE.name(),\n                     cloudbreakMessagesService.getMessage(Msg.STACK_SYNC_INSTANCE_STATE_SYNCED.code()));\n-        } else if (instanceStateCounts.get(InstanceSyncState.STOPPED).equals(instances.size())) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njg5MDc1MQ=="}, "originalCommit": {"oid": "48a03d20956d4d30c5873138e10985ae29867019"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQ1MDg3MA==", "bodyText": "I thought we agreed to put the status to STOPPED_FAILED if we find deleted instances. https://jira.cloudera.com/browse/ENGESC-3354?focusedCommentId=3950763&page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-3950763\nHas this changed?", "url": "https://github.com/hortonworks/cloudbreak/pull/8733#discussion_r468450870", "createdAt": "2020-08-11T09:32:41Z", "author": {"login": "pdarvasi"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/service/stack/flow/StackSyncService.java", "diffHunk": "@@ -206,24 +206,20 @@ private void deleteResourceIfNeeded(Stack stack, InstanceMetaData instance) {\n     }\n \n     private void handleSyncResult(Stack stack, Map<InstanceSyncState, Integer> instanceStateCounts, boolean stackStatusUpdateEnabled) {\n-        Set<InstanceMetaData> instances = instanceMetaDataRepository.findNotTerminatedForStack(stack.getId());\n         if (instanceStateCounts.get(InstanceSyncState.UNKNOWN) > 0) {\n             eventService.fireCloudbreakEvent(stack.getId(), AVAILABLE.name(),\n                     cloudbreakMessagesService.getMessage(Msg.STACK_SYNC_INSTANCE_STATUS_COULDNT_DETERMINE.code()));\n         } else if (instanceStateCounts.get(InstanceSyncState.IN_PROGRESS) > 0) {\n             eventService.fireCloudbreakEvent(stack.getId(), AVAILABLE.name(),\n                     cloudbreakMessagesService.getMessage(Msg.STACK_SYNC_INSTANCE_OPERATION_IN_PROGRESS.code()));\n-        } else if (instanceStateCounts.get(InstanceSyncState.RUNNING) > 0 && instanceStateCounts.get(InstanceSyncState.STOPPED) > 0) {\n+        } else if ((instanceStateCounts.get(InstanceSyncState.RUNNING) >= 0 || (instanceStateCounts.get(InstanceSyncState.DELETED_ON_PROVIDER_SIDE) >= 0))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48a03d20956d4d30c5873138e10985ae29867019"}, "originalPosition": 12}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "48a03d20956d4d30c5873138e10985ae29867019", "author": {"user": {"login": "afarsang", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/48a03d20956d4d30c5873138e10985ae29867019", "committedDate": "2020-08-06T09:58:35Z", "message": "CB-8152 stopped stack sync wont state delete failed status when instances deleted on provider side"}, "afterCommit": {"oid": "1f66245ab00404099d4fbfd1d5ca4e693a6e431e", "author": {"user": {"login": "afarsang", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/1f66245ab00404099d4fbfd1d5ca4e693a6e431e", "committedDate": "2020-08-11T14:24:59Z", "message": "CB-8152 stopped stack sync wont state delete failed status when instances deleted on provider side"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2NDk2ODc0", "url": "https://github.com/hortonworks/cloudbreak/pull/8733#pullrequestreview-466496874", "createdAt": "2020-08-13T07:08:12Z", "commit": {"oid": "1f66245ab00404099d4fbfd1d5ca4e693a6e431e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QwNzowODoxMlrOG_-vHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QwNzowODoxMlrOG_-vHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTc0MTM0Mw==", "bodyText": "whitespace added", "url": "https://github.com/hortonworks/cloudbreak/pull/8733#discussion_r469741343", "createdAt": "2020-08-13T07:08:12Z", "author": {"login": "sodre90"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/service/stack/flow/StackSyncService.java", "diffHunk": "@@ -224,7 +226,7 @@ private void handleSyncResult(Stack stack, Map<InstanceSyncState, Integer> insta\n             updateStackStatusIfEnabled(stack.getId(), DetailedStackStatus.STOPPED, SYNC_STATUS_REASON, stackStatusUpdateEnabled);\n             eventService.fireCloudbreakEvent(stack.getId(), STOPPED.name(),\n                     cloudbreakMessagesService.getMessage(Msg.STACK_SYNC_INSTANCE_STATE_SYNCED.code()));\n-        } else {\n+        }  else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f66245ab00404099d4fbfd1d5ca4e693a6e431e"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d18d6a46fb15a891a6f2f4f9f1a252314f99acc7", "author": {"user": {"login": "afarsang", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/d18d6a46fb15a891a6f2f4f9f1a252314f99acc7", "committedDate": "2020-08-14T10:35:40Z", "message": "CB-8152 stopped stack sync wont state delete failed status when instances deleted on provider side"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1f66245ab00404099d4fbfd1d5ca4e693a6e431e", "author": {"user": {"login": "afarsang", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/1f66245ab00404099d4fbfd1d5ca4e693a6e431e", "committedDate": "2020-08-11T14:24:59Z", "message": "CB-8152 stopped stack sync wont state delete failed status when instances deleted on provider side"}, "afterCommit": {"oid": "d18d6a46fb15a891a6f2f4f9f1a252314f99acc7", "author": {"user": {"login": "afarsang", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/d18d6a46fb15a891a6f2f4f9f1a252314f99acc7", "committedDate": "2020-08-14T10:35:40Z", "message": "CB-8152 stopped stack sync wont state delete failed status when instances deleted on provider side"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4MzcwNzg4", "url": "https://github.com/hortonworks/cloudbreak/pull/8733#pullrequestreview-468370788", "createdAt": "2020-08-17T11:08:49Z", "commit": {"oid": "d18d6a46fb15a891a6f2f4f9f1a252314f99acc7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2562, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}