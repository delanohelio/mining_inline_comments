{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMxMTIzMzM4", "number": 9563, "title": "CB-9525 DB SSL root cert file location customization", "bodyText": "Extract DB SSL root cert file name /hadoopfs/fs1/database-cacerts/certs.pem as the new property cb.externaldatabase.ssl.rootcerts.path in core/src/main/resources/application.yml\nRemove all other former occurrences of /hadoopfs/fs1/database-cacerts/certs.pem and let them be populated from the above application property (for Java) and the new pillar property postgres_root_certs:ssl_certs_file_path (for Salt)\n\nNote: RedbeamsDbCertificateProvider.getSslCertsFilePath() depends on neither the Stack nor the Cluster at the moment. Conditional calculation of the file path may be added later as needed.\n\n\nIntroduce a new Python dict for DB SSL settings; see orchestrator-salt/src/main/resources/salt/salt/postgresql/settings.sls\nAdd new unit tests and adapt / migrate existing ones to JUnit 5 & AspectJ\n\nUse org.junit.jupiter.api.Assertions.assertThrows() instead of org.assertj.core.api.Assertions.assertThatCode() for better readability.", "createdAt": "2020-12-02T16:08:25Z", "url": "https://github.com/hortonworks/cloudbreak/pull/9563", "merged": true, "mergeCommit": {"oid": "696ec8b1c5c72bdf55706788aa28fa0dd591dfc1"}, "closed": true, "closedAt": "2020-12-09T18:22:30Z", "author": {"login": "lajosrodek"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdifZTGgBqjQwNjYzMDg2MDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdkgjD5AFqTU0ODMwODA0Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1bd2d710ba09b8be79848b2c1702a8320fbcb2f3", "author": {"user": {"login": "lajosrodek", "name": "Lajos Rodek"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/1bd2d710ba09b8be79848b2c1702a8320fbcb2f3", "committedDate": "2020-12-02T16:05:31Z", "message": "CB-9525 DB SSL root cert file location customization\n\nTODO:\n* List of changes\n* Testing"}, "afterCommit": {"oid": "50115ae649c1bab8a7e423be3aa72b58a6e9ebb0", "author": {"user": {"login": "lajosrodek", "name": "Lajos Rodek"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/50115ae649c1bab8a7e423be3aa72b58a6e9ebb0", "committedDate": "2020-12-03T09:03:52Z", "message": "CB-9525 DB SSL root cert file location customization\n\nTODO:\n* List of changes\n* Testing"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "50115ae649c1bab8a7e423be3aa72b58a6e9ebb0", "author": {"user": {"login": "lajosrodek", "name": "Lajos Rodek"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/50115ae649c1bab8a7e423be3aa72b58a6e9ebb0", "committedDate": "2020-12-03T09:03:52Z", "message": "CB-9525 DB SSL root cert file location customization\n\nTODO:\n* List of changes\n* Testing"}, "afterCommit": {"oid": "93834f59eeec167b7354b56f5778256ebea75fb9", "author": {"user": {"login": "lajosrodek", "name": "Lajos Rodek"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/93834f59eeec167b7354b56f5778256ebea75fb9", "committedDate": "2020-12-05T02:42:05Z", "message": "CB-9525 DB SSL root cert file location customization\n\n* Extract DB SSL root cert file name\n  /hadoopfs/fs1/database-cacerts/certs.pem as the new property\n  cb.externaldatabase.ssl.rootcerts.path in\n  core/src/main/resources/application.yml\n* Remove all other former occurrences of\n  /hadoopfs/fs1/database-cacerts/certs.pem and let them be populated\n  from the above application property (for Java) and the new pillar\n  property postgres_root_certs:ssl_certs_file_path (for Salt)\n  * Note: RedbeamsDbCertificateProvider.getSslCertsFilePath() depends\n    on neither the Stack nor the Cluster at the moment. Conditional\n    calculation of the file path may be added later as needed.\n* Introduce a new Python dict for DB SSL settings; see\n  orchestrator-salt/src/main/resources/salt/salt/postgresql/settings.sls\n* Add new unit tests and adapt / migrate existing ones to JUnit 5 &\n  AspectJ"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1Nzk5MzI3", "url": "https://github.com/hortonworks/cloudbreak/pull/9563#pullrequestreview-545799327", "createdAt": "2020-12-07T02:55:17Z", "commit": {"oid": "93834f59eeec167b7354b56f5778256ebea75fb9"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QwMjo1NToxN1rOIAT5Kw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QwMzo1MDoxOVrOIAU2SQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzE5Njg0Mw==", "bodyText": "praise: I really like this way of exception testing. Are we trying to move CB to AssertJ?", "url": "https://github.com/hortonworks/cloudbreak/pull/9563#discussion_r537196843", "createdAt": "2020-12-07T02:55:17Z", "author": {"login": "brycederriso"}, "path": "core/src/test/java/com/sequenceiq/cloudbreak/converter/v2/StackToTemplatePreparationObjectConverterTest.java", "diffHunk": "@@ -366,11 +371,10 @@ public void testConvertIfTheAttemptOfObtainingBaseFileSystemConfigurationsViewTh\n                 eq(configQueryEntries))).thenThrow(invokedException);\n         when(cmCloudStorageConfigProvider.getConfigQueryEntries()).thenReturn(configQueryEntries);\n \n-        expectedException.expect(CloudbreakServiceException.class);\n-        expectedException.expectMessage(iOExceptionMessage);\n-        expectedException.expectCause(is(invokedException));\n-\n-        underTest.convert(stackMock);\n+        assertThatCode(() -> underTest.convert(stackMock))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93834f59eeec167b7354b56f5778256ebea75fb9"}, "originalPosition": 149}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzIwMDU2Mw==", "bodyText": "praise: Thanks for refactoring!", "url": "https://github.com/hortonworks/cloudbreak/pull/9563#discussion_r537200563", "createdAt": "2020-12-07T03:08:02Z", "author": {"login": "brycederriso"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/service/rdsconfig/RedbeamsDbCertificateProvider.java", "diffHunk": "@@ -70,10 +79,10 @@ private void getDatalakeDatabaseRootCerts(Stack stack, Set<String> result) {\n             LOGGER.info(\"Gathering cluster's(crn:'{}', name: '{}') remote database root certificates\", stackResourceCrn, clusterName);\n             String databaseServerCrn = cluster.getDatabaseServerCrn();\n             DatabaseServerV4Response databaseServer = dbServerConfigurer.getDatabaseServer(databaseServerCrn);\n-            if (databaseServer.getSslConfig() != null) {\n-                SslMode sslMode = databaseServer.getSslConfig().getSslMode();\n-                if (SslMode.ENABLED.equals(sslMode)) {\n-                    Set<String> sslCertificates = databaseServer.getSslConfig().getSslCertificates();\n+            SslConfigV4Response sslConfig = databaseServer.getSslConfig();\n+            if (sslConfig != null) {\n+                if (SslMode.isEnabled(sslConfig.getSslMode())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93834f59eeec167b7354b56f5778256ebea75fb9"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzIwMTMxMw==", "bodyText": "question: This looks like the only new test in this file, is that the case? (I'm not missing any?)\nThe rest of the changes are conversions to AssertJ?", "url": "https://github.com/hortonworks/cloudbreak/pull/9563#discussion_r537201313", "createdAt": "2020-12-07T03:10:55Z", "author": {"login": "brycederriso"}, "path": "core/src/test/java/com/sequenceiq/cloudbreak/converter/v2/StackToTemplatePreparationObjectConverterTest.java", "diffHunk": "@@ -526,7 +534,17 @@ public void testMissingClouderaManagerIp() {\n         when(stackMock.getPrimaryGatewayInstance()).thenReturn(dummyMetadata);\n \n         TemplatePreparationObject result = underTest.convert(stackMock);\n-        assertEquals(\"10.0.0.1\", result.getGeneralClusterConfigs().getClusterManagerIp());\n+\n+        assertThat(result.getGeneralClusterConfigs().getClusterManagerIp()).isEqualTo(\"10.0.0.1\");\n         verify(gatewayConfigService, times(1)).getPrimaryGatewayIp(any(Stack.class));\n     }\n+\n+    @Test\n+    void testRdsSslCertificateFile() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93834f59eeec167b7354b56f5778256ebea75fb9"}, "originalPosition": 308}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzIxMjQ4OQ==", "bodyText": "question: What is this TemplatePreparationObject for? It looks like just a plain old value object.\nI see it's in the template namespace, but I don't actually know what that means in the broader context of CB.", "url": "https://github.com/hortonworks/cloudbreak/pull/9563#discussion_r537212489", "createdAt": "2020-12-07T03:50:19Z", "author": {"login": "brycederriso"}, "path": "template-manager-core/src/main/java/com/sequenceiq/cloudbreak/template/TemplatePreparationObject.java", "diffHunk": "@@ -53,6 +53,8 @@\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93834f59eeec167b7354b56f5778256ebea75fb9"}, "originalPosition": 1}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "93834f59eeec167b7354b56f5778256ebea75fb9", "author": {"user": {"login": "lajosrodek", "name": "Lajos Rodek"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/93834f59eeec167b7354b56f5778256ebea75fb9", "committedDate": "2020-12-05T02:42:05Z", "message": "CB-9525 DB SSL root cert file location customization\n\n* Extract DB SSL root cert file name\n  /hadoopfs/fs1/database-cacerts/certs.pem as the new property\n  cb.externaldatabase.ssl.rootcerts.path in\n  core/src/main/resources/application.yml\n* Remove all other former occurrences of\n  /hadoopfs/fs1/database-cacerts/certs.pem and let them be populated\n  from the above application property (for Java) and the new pillar\n  property postgres_root_certs:ssl_certs_file_path (for Salt)\n  * Note: RedbeamsDbCertificateProvider.getSslCertsFilePath() depends\n    on neither the Stack nor the Cluster at the moment. Conditional\n    calculation of the file path may be added later as needed.\n* Introduce a new Python dict for DB SSL settings; see\n  orchestrator-salt/src/main/resources/salt/salt/postgresql/settings.sls\n* Add new unit tests and adapt / migrate existing ones to JUnit 5 &\n  AspectJ"}, "afterCommit": {"oid": "499fda4f800d15d654255c3c1d6192cfe9b978c7", "author": {"user": {"login": "lajosrodek", "name": "Lajos Rodek"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/499fda4f800d15d654255c3c1d6192cfe9b978c7", "committedDate": "2020-12-07T10:54:33Z", "message": "CB-9525 DB SSL root cert file location customization\n\n* Extract DB SSL root cert file name\n  /hadoopfs/fs1/database-cacerts/certs.pem as the new property\n  cb.externaldatabase.ssl.rootcerts.path in\n  core/src/main/resources/application.yml\n* Remove all other former occurrences of\n  /hadoopfs/fs1/database-cacerts/certs.pem and let them be populated\n  from the above application property (for Java) and the new pillar\n  property postgres_root_certs:ssl_certs_file_path (for Salt)\n  * Note: RedbeamsDbCertificateProvider.getSslCertsFilePath() depends\n    on neither the Stack nor the Cluster at the moment. Conditional\n    calculation of the file path may be added later as needed.\n* Introduce a new Python dict for DB SSL settings; see\n  orchestrator-salt/src/main/resources/salt/salt/postgresql/settings.sls\n* Add new unit tests and adapt / migrate existing ones to JUnit 5 &\n  AspectJ\n  * Use org.junit.jupiter.api.Assertions.assertThrows instead of\n    org.assertj.core.api.Assertions.assertThatCode for better\n    readability."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4MjA2OTE0", "url": "https://github.com/hortonworks/cloudbreak/pull/9563#pullrequestreview-548206914", "createdAt": "2020-12-09T13:57:34Z", "commit": {"oid": "499fda4f800d15d654255c3c1d6192cfe9b978c7"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxMzo1NzozNVrOICV5Mg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxNDowOTo1NlrOICWe3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTMyNjc3MA==", "bodyText": "Shouldn't the builder's method name relate to the file path too?", "url": "https://github.com/hortonworks/cloudbreak/pull/9563#discussion_r539326770", "createdAt": "2020-12-09T13:57:35Z", "author": {"login": "biharitomi"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/converter/StackToTemplatePreparationObjectConverter.java", "diffHunk": "@@ -210,6 +214,7 @@ public TemplatePreparationObject convert(Stack source) {\n             Builder builder = Builder.builder()\n                     .withCloudPlatform(CloudPlatform.valueOf(source.getCloudPlatform()))\n                     .withRdsConfigs(postgresConfigService.createRdsConfigIfNeeded(source, cluster))\n+                    .withRdsSslCertificateFile(dbCertificateProvider.getSslCertsFilePath())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "499fda4f800d15d654255c3c1d6192cfe9b978c7"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTMzNTM0Mg==", "bodyText": "Can we name it {{rdsSslCertificateFilePath}} or ending with location? I think it would be more straightforward that way.", "url": "https://github.com/hortonworks/cloudbreak/pull/9563#discussion_r539335342", "createdAt": "2020-12-09T14:08:40Z", "author": {"login": "biharitomi"}, "path": "template-manager-core/src/main/java/com/sequenceiq/cloudbreak/template/TemplatePreparationObject.java", "diffHunk": "@@ -53,6 +53,8 @@\n \n     private final Map<String, RDSConfig> rdsConfigs;\n \n+    private final String rdsSslCertificateFile;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "499fda4f800d15d654255c3c1d6192cfe9b978c7"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTMzNjQxNQ==", "bodyText": "The same here, it is not the file, it's just the location/path of the file.", "url": "https://github.com/hortonworks/cloudbreak/pull/9563#discussion_r539336415", "createdAt": "2020-12-09T14:09:56Z", "author": {"login": "biharitomi"}, "path": "template-manager-core/src/main/java/com/sequenceiq/cloudbreak/template/views/RdsView.java", "diffHunk": "@@ -59,6 +58,12 @@\n     private final RdsViewDialect rdsViewDialect;\n \n     public RdsView(RDSConfig rdsConfig) {\n+        this(rdsConfig, \"\");\n+    }\n+\n+    public RdsView(RDSConfig rdsConfig, String sslCertificateFile) {\n+        // Note: any value is valid for sslCertificateFile for sake of backward compatibility.\n+        this.sslCertificateFile = Objects.requireNonNullElse(sslCertificateFile, \"\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "499fda4f800d15d654255c3c1d6192cfe9b978c7"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a9af93448d22c05f6725412a475795f93e50059", "author": {"user": {"login": "lajosrodek", "name": "Lajos Rodek"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/2a9af93448d22c05f6725412a475795f93e50059", "committedDate": "2020-12-09T15:29:04Z", "message": "CB-9525 DB SSL root cert file location customization\n\n* Extract DB SSL root cert file name\n  /hadoopfs/fs1/database-cacerts/certs.pem as the new property\n  cb.externaldatabase.ssl.rootcerts.path in\n  core/src/main/resources/application.yml\n* Remove all other former occurrences of\n  /hadoopfs/fs1/database-cacerts/certs.pem and let them be populated\n  from the above application property (for Java) and the new pillar\n  property postgres_root_certs:ssl_certs_file_path (for Salt)\n  * Note: RedbeamsDbCertificateProvider.getSslCertsFilePath() depends\n    on neither the Stack nor the Cluster at the moment. Conditional\n    calculation of the file path may be added later as needed.\n* Introduce a new Python dict for DB SSL settings; see\n  orchestrator-salt/src/main/resources/salt/salt/postgresql/settings.sls\n* Add new unit tests and adapt / migrate existing ones to JUnit 5 &\n  AspectJ\n  * Use org.junit.jupiter.api.Assertions.assertThrows instead of\n    org.assertj.core.api.Assertions.assertThatCode for better\n    readability."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "499fda4f800d15d654255c3c1d6192cfe9b978c7", "author": {"user": {"login": "lajosrodek", "name": "Lajos Rodek"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/499fda4f800d15d654255c3c1d6192cfe9b978c7", "committedDate": "2020-12-07T10:54:33Z", "message": "CB-9525 DB SSL root cert file location customization\n\n* Extract DB SSL root cert file name\n  /hadoopfs/fs1/database-cacerts/certs.pem as the new property\n  cb.externaldatabase.ssl.rootcerts.path in\n  core/src/main/resources/application.yml\n* Remove all other former occurrences of\n  /hadoopfs/fs1/database-cacerts/certs.pem and let them be populated\n  from the above application property (for Java) and the new pillar\n  property postgres_root_certs:ssl_certs_file_path (for Salt)\n  * Note: RedbeamsDbCertificateProvider.getSslCertsFilePath() depends\n    on neither the Stack nor the Cluster at the moment. Conditional\n    calculation of the file path may be added later as needed.\n* Introduce a new Python dict for DB SSL settings; see\n  orchestrator-salt/src/main/resources/salt/salt/postgresql/settings.sls\n* Add new unit tests and adapt / migrate existing ones to JUnit 5 &\n  AspectJ\n  * Use org.junit.jupiter.api.Assertions.assertThrows instead of\n    org.assertj.core.api.Assertions.assertThatCode for better\n    readability."}, "afterCommit": {"oid": "2a9af93448d22c05f6725412a475795f93e50059", "author": {"user": {"login": "lajosrodek", "name": "Lajos Rodek"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/2a9af93448d22c05f6725412a475795f93e50059", "committedDate": "2020-12-09T15:29:04Z", "message": "CB-9525 DB SSL root cert file location customization\n\n* Extract DB SSL root cert file name\n  /hadoopfs/fs1/database-cacerts/certs.pem as the new property\n  cb.externaldatabase.ssl.rootcerts.path in\n  core/src/main/resources/application.yml\n* Remove all other former occurrences of\n  /hadoopfs/fs1/database-cacerts/certs.pem and let them be populated\n  from the above application property (for Java) and the new pillar\n  property postgres_root_certs:ssl_certs_file_path (for Salt)\n  * Note: RedbeamsDbCertificateProvider.getSslCertsFilePath() depends\n    on neither the Stack nor the Cluster at the moment. Conditional\n    calculation of the file path may be added later as needed.\n* Introduce a new Python dict for DB SSL settings; see\n  orchestrator-salt/src/main/resources/salt/salt/postgresql/settings.sls\n* Add new unit tests and adapt / migrate existing ones to JUnit 5 &\n  AspectJ\n  * Use org.junit.jupiter.api.Assertions.assertThrows instead of\n    org.assertj.core.api.Assertions.assertThatCode for better\n    readability."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4MzA4MDQ3", "url": "https://github.com/hortonworks/cloudbreak/pull/9563#pullrequestreview-548308047", "createdAt": "2020-12-09T15:33:46Z", "commit": {"oid": "2a9af93448d22c05f6725412a475795f93e50059"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1922, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}