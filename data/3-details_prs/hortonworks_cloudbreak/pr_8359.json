{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM4MDEyMjg1", "number": 8359, "title": "CB-7508 Attempt to use KMS for SSE when AES fails.", "bodyText": "Add an if/else branch to attempt an S3 upload using aws:kms instead of AES encryption.\nTested two ways. One test was uploading to a standard S3 bucket, which used the AES encrypted s3 upload.\nTo test KMS encryption, I created a new bucket and applied the following policy:\n{\n    \"Version\": \"2012-10-17\",\n    \"Id\": \"PutObjPolicy\",\n    \"Statement\": [\n        {\n            \"Sid\": \"DenySSE-S3\",\n            \"Effect\": \"Deny\",\n            \"Principal\": \"*\",\n            \"Action\": \"s3:PutObject\",\n            \"Resource\": \"arn:aws:s3:::bderriso-test-aws-kms-upload/*\",\n            \"Condition\": {\n                \"StringEquals\": {\n                    \"s3:x-amz-server-side-encryption\": \"AES256\"\n                }\n            }\n        }\n    ]\n}\nThen confirmed upload works and logs contain ouput indicating that upload fell back to aws:kms.\nSalt output:\nstdout:\n                  Logs at /var/log/dl_postgres_backup.log\n                  try to upload with aws:kms encryption\n                  try to upload with aws:kms encryption\n\nCloses CB-7508", "createdAt": "2020-06-22T15:17:24Z", "url": "https://github.com/hortonworks/cloudbreak/pull/8359", "merged": true, "mergeCommit": {"oid": "a9688f31a3b42f263f0202b50187179952a41fe8"}, "closed": true, "closedAt": "2020-06-23T14:12:57Z", "author": {"login": "brycederriso"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABct157dgFqTQzNTIwNzQyNw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcuFqkMgFqTQzNTc5NDkwNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1MjA3NDI3", "url": "https://github.com/hortonworks/cloudbreak/pull/8359#pullrequestreview-435207427", "createdAt": "2020-06-22T19:20:55Z", "commit": {"oid": "69a952ed6ea4c5ff6efcb61fe5a9d3da26d809c7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1NzYxMDA0", "url": "https://github.com/hortonworks/cloudbreak/pull/8359#pullrequestreview-435761004", "createdAt": "2020-06-23T13:06:32Z", "commit": {"oid": "42049ce4912b144dcf1679f40a667f49e0d30df9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxMzowNjozMlrOGnoTdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxMzowNjozMlrOGnoTdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDIwNzk4OA==", "bodyText": "Pls add log like: echo \"try to upload with AES256 encryption\"", "url": "https://github.com/hortonworks/cloudbreak/pull/8359#discussion_r444207988", "createdAt": "2020-06-23T13:06:32Z", "author": {"login": "pdarvasi"}, "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/disaster_recovery/scripts/backup_db.sh", "diffHunk": "@@ -77,19 +77,30 @@ dump_to_s3() {\n   SERVICE=$1\n   S3_LOCATION=\"${BACKUP_LOCATION}/${SERVICE}_backup\"\n   doLog \"INFO Dumping ${SERVICE} to ${S3_LOCATION}\"\n-  pg_dump --host=\"$HOST\" --port=\"$PORT\" --username=\"$USERNAME\" --dbname=\"${SERVICE}\" --format=plain 2>>$LOGFILE | /usr/bin/aws s3 cp --sse AES256 --no-progress - \"${S3_LOCATION}\" 2>>$LOGFILE || errorExit \"Unable to dump ${SERVICE}.\"\n-  doLog \"INFO ${SERVICE} dumped to ${S3_LOCATION}\"\n+\n+  ret_code=$(pg_dump --host=\"$HOST\" --port=\"$PORT\" --username=\"$USERNAME\" --dbname=\"${SERVICE}\" --format=plain 2>>$LOGFILE | /usr/bin/aws s3 cp --sse AES256 --no-progress - \"${S3_LOCATION}\" 2>>$LOGFILE || echo $?)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "42049ce4912b144dcf1679f40a667f49e0d30df9"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dac66b2cb420854c7b68c83981d82445c1ec578b", "author": {"user": {"login": "brycederriso", "name": "Bryce"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/dac66b2cb420854c7b68c83981d82445c1ec578b", "committedDate": "2020-06-23T13:25:31Z", "message": "CB-7508 Attempt to use KMS for SSE when AES fails."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d451f9e0cc5b6cde153e8a832f9e708a47c8d4db", "author": {"user": {"login": "brycederriso", "name": "Bryce"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/d451f9e0cc5b6cde153e8a832f9e708a47c8d4db", "committedDate": "2020-06-23T13:22:52Z", "message": "Use `doLog` instead of `echo`."}, "afterCommit": {"oid": "dac66b2cb420854c7b68c83981d82445c1ec578b", "author": {"user": {"login": "brycederriso", "name": "Bryce"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/dac66b2cb420854c7b68c83981d82445c1ec578b", "committedDate": "2020-06-23T13:25:31Z", "message": "CB-7508 Attempt to use KMS for SSE when AES fails."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1Nzk0OTA0", "url": "https://github.com/hortonworks/cloudbreak/pull/8359#pullrequestreview-435794904", "createdAt": "2020-06-23T13:42:37Z", "commit": {"oid": "dac66b2cb420854c7b68c83981d82445c1ec578b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2728, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}