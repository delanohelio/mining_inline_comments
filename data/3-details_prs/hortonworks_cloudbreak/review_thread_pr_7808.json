{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAzOTM4MjY3", "number": 7808, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQwOToyMjowMVrOD0JF1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQwOTo1MzozNlrOD0J9Sg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2MDAxNDk0OnYy", "diffSide": "RIGHT", "path": "integration-test/src/main/java/com/sequenceiq/it/cloudbreak/testcase/e2e/distrox/DistroXImagesTests.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQwOToyMjowMVrOGI7w-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxMzoyNToxNlrOGJFkpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjAyMDk4NA==", "bodyText": "I don't really like the Idea that the return type of this method was changed to void.\nBreaks the flow in the testcase.", "url": "https://github.com/hortonworks/cloudbreak/pull/7808#discussion_r412020984", "createdAt": "2020-04-21T09:22:01Z", "author": {"login": "lnardai"}, "path": "integration-test/src/main/java/com/sequenceiq/it/cloudbreak/testcase/e2e/distrox/DistroXImagesTests.java", "diffHunk": "@@ -96,7 +96,8 @@ public void testDistroXWithBaseImageCanBeCreatedSuccessfully(TestContext testCon\n                 .when(distroXTestClient.create(), key(distrox))\n                 .await(STACK_AVAILABLE)\n                 .then((tc, testDto, client) -> {\n-                    return waitUtil.waitForDistroxInstancesStatus(testDto, client, instancesHealthy);\n+                    waitUtil.waitForDistroxInstanceStatus(testDto.getResponse().getName(), tc, instancesHealthy);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ab7c65519457d83d3416c0f58d8389532ebaaca"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjE4MTY2OQ==", "bodyText": "I could revert this change only for here (for waitForDistroxInstancesStatus method). In case of waitForSdxInstancesStatus this was part of the required change.", "url": "https://github.com/hortonworks/cloudbreak/pull/7808#discussion_r412181669", "createdAt": "2020-04-21T13:25:16Z", "author": {"login": "aszegedi"}, "path": "integration-test/src/main/java/com/sequenceiq/it/cloudbreak/testcase/e2e/distrox/DistroXImagesTests.java", "diffHunk": "@@ -96,7 +96,8 @@ public void testDistroXWithBaseImageCanBeCreatedSuccessfully(TestContext testCon\n                 .when(distroXTestClient.create(), key(distrox))\n                 .await(STACK_AVAILABLE)\n                 .then((tc, testDto, client) -> {\n-                    return waitUtil.waitForDistroxInstancesStatus(testDto, client, instancesHealthy);\n+                    waitUtil.waitForDistroxInstanceStatus(testDto.getResponse().getName(), tc, instancesHealthy);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjAyMDk4NA=="}, "originalCommit": {"oid": "8ab7c65519457d83d3416c0f58d8389532ebaaca"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2MDA1ODkwOnYy", "diffSide": "RIGHT", "path": "integration-test/src/main/java/com/sequenceiq/it/cloudbreak/util/wait/WaitUtil.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQwOTozMToyN1rOGI8MLA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxMzoyODoxMlrOGJFtng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjAyNzk0OA==", "bodyText": "This method got even more complicated.\nThe status and reason reason field always set together, please refactor that to a separate method.\nAlso a lot of \"freeIpaResponse.getStatusReason() != null ?\", This could be incorporated to that method as a default value or it could be set by default.", "url": "https://github.com/hortonworks/cloudbreak/pull/7808#discussion_r412027948", "createdAt": "2020-04-21T09:31:27Z", "author": {"login": "lnardai"}, "path": "integration-test/src/main/java/com/sequenceiq/it/cloudbreak/util/wait/WaitUtil.java", "diffHunk": "@@ -321,27 +336,36 @@ private boolean checkFailedStatuses(EnvironmentStatus currentStatus) {\n             com.sequenceiq.freeipa.api.v1.freeipa.stack.model.common.Status desiredStatus, long pollingInterval) {\n         Map<String, String> errors = new HashMap<>();\n         WaitResult waitResult = WaitResult.SUCCESSFUL;\n+        String status = \"\";\n+        String reason = \"\";\n+        DescribeFreeIpaResponse freeIpaResponse;\n         for (int retryBecauseOfWrongStatusHandlingInCB = 0; retryBecauseOfWrongStatusHandlingInCB < 3; retryBecauseOfWrongStatusHandlingInCB++) {\n             waitResult = waitForStatuses(freeIPAClient, name, desiredStatus);\n         }\n         if (waitResult == WaitResult.FAILED) {\n-            StringBuilder builder = new StringBuilder(\"The stack has failed: \").append(System.lineSeparator());\n-            DescribeFreeIpaResponse freeIpaResponse = getFreeIPAResponse(freeIPAClient, name);\n-            if (freeIpaResponse != null && freeIpaResponse.getStatus() != null) {\n-                builder.append(\"statusReason: \").append(freeIpaResponse.getStatusReason());\n-            }\n+            StringBuilder builder = new StringBuilder(\"FreeIPA has failed: \").append(System.lineSeparator());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ab7c65519457d83d3416c0f58d8389532ebaaca"}, "originalPosition": 101}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjE4Mzk2Ng==", "bodyText": "Original methods were tidied up. Supporting methods were placed here as well.", "url": "https://github.com/hortonworks/cloudbreak/pull/7808#discussion_r412183966", "createdAt": "2020-04-21T13:28:12Z", "author": {"login": "aszegedi"}, "path": "integration-test/src/main/java/com/sequenceiq/it/cloudbreak/util/wait/WaitUtil.java", "diffHunk": "@@ -321,27 +336,36 @@ private boolean checkFailedStatuses(EnvironmentStatus currentStatus) {\n             com.sequenceiq.freeipa.api.v1.freeipa.stack.model.common.Status desiredStatus, long pollingInterval) {\n         Map<String, String> errors = new HashMap<>();\n         WaitResult waitResult = WaitResult.SUCCESSFUL;\n+        String status = \"\";\n+        String reason = \"\";\n+        DescribeFreeIpaResponse freeIpaResponse;\n         for (int retryBecauseOfWrongStatusHandlingInCB = 0; retryBecauseOfWrongStatusHandlingInCB < 3; retryBecauseOfWrongStatusHandlingInCB++) {\n             waitResult = waitForStatuses(freeIPAClient, name, desiredStatus);\n         }\n         if (waitResult == WaitResult.FAILED) {\n-            StringBuilder builder = new StringBuilder(\"The stack has failed: \").append(System.lineSeparator());\n-            DescribeFreeIpaResponse freeIpaResponse = getFreeIPAResponse(freeIPAClient, name);\n-            if (freeIpaResponse != null && freeIpaResponse.getStatus() != null) {\n-                builder.append(\"statusReason: \").append(freeIpaResponse.getStatusReason());\n-            }\n+            StringBuilder builder = new StringBuilder(\"FreeIPA has failed: \").append(System.lineSeparator());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjAyNzk0OA=="}, "originalCommit": {"oid": "8ab7c65519457d83d3416c0f58d8389532ebaaca"}, "originalPosition": 101}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2MDE1NjkwOnYy", "diffSide": "LEFT", "path": "integration-test/src/main/java/com/sequenceiq/it/cloudbreak/util/wait/WaitUtil.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQwOTo1MzozNlrOGI9H9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxMzoyOTowMlrOGJFwYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjA0MzI1NQ==", "bodyText": "By eliminating these methods the original ones got even more complex.", "url": "https://github.com/hortonworks/cloudbreak/pull/7808#discussion_r412043255", "createdAt": "2020-04-21T09:53:36Z", "author": {"login": "lnardai"}, "path": "integration-test/src/main/java/com/sequenceiq/it/cloudbreak/util/wait/WaitUtil.java", "diffHunk": "@@ -379,136 +414,130 @@ private boolean checkFailedStatuses(EnvironmentStatus currentStatus) {\n             SdxClusterStatusResponse desiredStatus, long pollingInterval) {\n         Map<String, String> errors = new HashMap<>();\n         WaitResult waitResult = WaitResult.SUCCESSFUL;\n+        String status = \"\";\n+        String reason = \"\";\n+        SdxClusterResponse sdxResponse;\n         for (int retryBecauseOfWrongStatusHandlingInCB = 0; retryBecauseOfWrongStatusHandlingInCB < 3; retryBecauseOfWrongStatusHandlingInCB++) {\n             waitResult = waitForStatuses(sdxClient, name, desiredStatus);\n         }\n         if (waitResult == WaitResult.FAILED) {\n-            StringBuilder builder = new StringBuilder(\"The stack has failed: \").append(System.lineSeparator());\n-            SdxClusterResponse sdxResponse = getSDXClusterResponse(sdxClient, name);\n-            if (sdxResponse != null && sdxResponse.getStatus() != null) {\n-                builder.append(\"statusReason: \").append(sdxResponse.getStatusReason());\n-            }\n+            StringBuilder builder = new StringBuilder(\"SDX has failed: \").append(System.lineSeparator());\n+            sdxResponse = getSDXClusterResponse(sdxClient, name);\n+            status = sdxResponse.getStatus().name();\n+            reason = sdxResponse.getStatusReason() != null ? sdxResponse.getStatusReason()\n+                    : \"SDX Status Reason is not available\";\n+            builder.append(\"statusReason: \").append(reason);\n             LOGGER.error(builder.toString());\n-            throw new TestFailException(builder.toString());\n+            errors = Map.of(\"status\", status, \"reason\", reason);\n         } else if (waitResult == WaitResult.TIMEOUT) {\n-            SdxClusterResponse sdxResponse = getSDXClusterResponse(sdxClient, name);\n-            LOGGER.error(\"Timeout happened while waiting for {} status at {}, the current status is {}\", desiredStatus.name(), name,\n-                    sdxResponse.getStatus().name());\n-            throw new TestFailException(\"Timeout happened while waiting for \" + desiredStatus.name() + \" status at \" + name + \", the current status is \"\n-                    + sdxResponse.getStatus().name());\n+            sdxResponse = getSDXClusterResponse(sdxClient, name);\n+            status = sdxResponse.getStatus().name();\n+            reason = sdxResponse.getStatusReason() != null ? sdxResponse.getStatusReason()\n+                    : \"SDX Status Reason is not available\";\n+            LOGGER.error(\"Timeout happened while waiting for {} status at {}, the current status is {} with reason: {}\", desiredStatus.name(),\n+                    name, status, reason);\n+            errors = Map.of(\"status\", status, \"reason\", reason);\n         } else if (DELETED != desiredStatus) {\n-            SdxClusterResponse sdxResponse = getSDXClusterResponse(sdxClient, name);\n+            sdxResponse = getSDXClusterResponse(sdxClient, name);\n             if (sdxResponse != null) {\n-                errors = Map.of(\"status\", sdxResponse.getStatus().name());\n+                status = sdxResponse.getStatus().name();\n+                reason = sdxResponse.getStatusReason() != null ? sdxResponse.getStatusReason()\n+                        : \"SDX Status Reason is not available\";\n+                errors = Map.of(\"status\", status, \"reason\", reason);\n             }\n         }\n         return errors;\n     }\n \n-    public SdxTestDto waitForSdxInstanceStatus(SdxTestDto sdxTestDto, SdxClient sdxClient, String hostGroup, InstanceStatus desiredState) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ab7c65519457d83d3416c0f58d8389532ebaaca"}, "originalPosition": 236}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjE4NDY3Mw==", "bodyText": "This change was required.", "url": "https://github.com/hortonworks/cloudbreak/pull/7808#discussion_r412184673", "createdAt": "2020-04-21T13:29:02Z", "author": {"login": "aszegedi"}, "path": "integration-test/src/main/java/com/sequenceiq/it/cloudbreak/util/wait/WaitUtil.java", "diffHunk": "@@ -379,136 +414,130 @@ private boolean checkFailedStatuses(EnvironmentStatus currentStatus) {\n             SdxClusterStatusResponse desiredStatus, long pollingInterval) {\n         Map<String, String> errors = new HashMap<>();\n         WaitResult waitResult = WaitResult.SUCCESSFUL;\n+        String status = \"\";\n+        String reason = \"\";\n+        SdxClusterResponse sdxResponse;\n         for (int retryBecauseOfWrongStatusHandlingInCB = 0; retryBecauseOfWrongStatusHandlingInCB < 3; retryBecauseOfWrongStatusHandlingInCB++) {\n             waitResult = waitForStatuses(sdxClient, name, desiredStatus);\n         }\n         if (waitResult == WaitResult.FAILED) {\n-            StringBuilder builder = new StringBuilder(\"The stack has failed: \").append(System.lineSeparator());\n-            SdxClusterResponse sdxResponse = getSDXClusterResponse(sdxClient, name);\n-            if (sdxResponse != null && sdxResponse.getStatus() != null) {\n-                builder.append(\"statusReason: \").append(sdxResponse.getStatusReason());\n-            }\n+            StringBuilder builder = new StringBuilder(\"SDX has failed: \").append(System.lineSeparator());\n+            sdxResponse = getSDXClusterResponse(sdxClient, name);\n+            status = sdxResponse.getStatus().name();\n+            reason = sdxResponse.getStatusReason() != null ? sdxResponse.getStatusReason()\n+                    : \"SDX Status Reason is not available\";\n+            builder.append(\"statusReason: \").append(reason);\n             LOGGER.error(builder.toString());\n-            throw new TestFailException(builder.toString());\n+            errors = Map.of(\"status\", status, \"reason\", reason);\n         } else if (waitResult == WaitResult.TIMEOUT) {\n-            SdxClusterResponse sdxResponse = getSDXClusterResponse(sdxClient, name);\n-            LOGGER.error(\"Timeout happened while waiting for {} status at {}, the current status is {}\", desiredStatus.name(), name,\n-                    sdxResponse.getStatus().name());\n-            throw new TestFailException(\"Timeout happened while waiting for \" + desiredStatus.name() + \" status at \" + name + \", the current status is \"\n-                    + sdxResponse.getStatus().name());\n+            sdxResponse = getSDXClusterResponse(sdxClient, name);\n+            status = sdxResponse.getStatus().name();\n+            reason = sdxResponse.getStatusReason() != null ? sdxResponse.getStatusReason()\n+                    : \"SDX Status Reason is not available\";\n+            LOGGER.error(\"Timeout happened while waiting for {} status at {}, the current status is {} with reason: {}\", desiredStatus.name(),\n+                    name, status, reason);\n+            errors = Map.of(\"status\", status, \"reason\", reason);\n         } else if (DELETED != desiredStatus) {\n-            SdxClusterResponse sdxResponse = getSDXClusterResponse(sdxClient, name);\n+            sdxResponse = getSDXClusterResponse(sdxClient, name);\n             if (sdxResponse != null) {\n-                errors = Map.of(\"status\", sdxResponse.getStatus().name());\n+                status = sdxResponse.getStatus().name();\n+                reason = sdxResponse.getStatusReason() != null ? sdxResponse.getStatusReason()\n+                        : \"SDX Status Reason is not available\";\n+                errors = Map.of(\"status\", status, \"reason\", reason);\n             }\n         }\n         return errors;\n     }\n \n-    public SdxTestDto waitForSdxInstanceStatus(SdxTestDto sdxTestDto, SdxClient sdxClient, String hostGroup, InstanceStatus desiredState) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjA0MzI1NQ=="}, "originalCommit": {"oid": "8ab7c65519457d83d3416c0f58d8389532ebaaca"}, "originalPosition": 236}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2557, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}