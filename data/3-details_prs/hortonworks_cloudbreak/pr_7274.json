{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc0MjI4OTI1", "number": 7274, "title": "CB-5526 Subnet should be private if it has no IG", "bodyText": "", "createdAt": "2020-02-12T10:32:21Z", "url": "https://github.com/hortonworks/cloudbreak/pull/7274", "merged": true, "mergeCommit": {"oid": "5ec247704b5cb5ae7a602faf766fcdb3488d9fb4"}, "closed": true, "closedAt": "2020-02-14T09:14:45Z", "author": {"login": "gergopapi2"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcDldwvgFqTM1NzQxMTU2Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcD_D-cgBqjMwMzU5OTAwMDg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3NDExNTYy", "url": "https://github.com/hortonworks/cloudbreak/pull/7274#pullrequestreview-357411562", "createdAt": "2020-02-12T12:26:45Z", "commit": {"oid": "573f1db7fea0504727a0ac9d9ef419e11bacca41"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQxMjoyNjo0NVrOFossPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQxMjoyNjo0NVrOFossPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODIxOTU4MQ==", "bodyText": "We use this method here AwsNetworkService#80. Is it same?", "url": "https://github.com/hortonworks/cloudbreak/pull/7274#discussion_r378219581", "createdAt": "2020-02-12T12:26:45Z", "author": {"login": "topolyai5"}, "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/AwsPlatformResources.java", "diffHunk": "@@ -389,7 +389,7 @@ private DescribeVpcsRequest getDescribeVpcsRequestWIthFilters(Map<String, String\n                             subnetName.orElse(subnet.getSubnetId()),\n                             subnet.getAvailabilityZone(),\n                             subnet.getCidrBlock(),\n-                            !subnet.isMapPublicIpOnLaunch(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "573f1db7fea0504727a0ac9d9ef419e11bacca41"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3NDYzNjIz", "url": "https://github.com/hortonworks/cloudbreak/pull/7274#pullrequestreview-357463623", "createdAt": "2020-02-12T13:48:52Z", "commit": {"oid": "573f1db7fea0504727a0ac9d9ef419e11bacca41"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "573f1db7fea0504727a0ac9d9ef419e11bacca41", "author": {"user": {"login": "gergopapi2", "name": "Gergely Papp"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/573f1db7fea0504727a0ac9d9ef419e11bacca41", "committedDate": "2020-02-12T10:30:11Z", "message": "CB-5526 Subnet should be private if it has no IG"}, "afterCommit": {"oid": "d2825eaa28aaf219564f16d3e0ad71b8fcb7d53e", "author": {"user": {"login": "gergopapi2", "name": "Gergely Papp"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/d2825eaa28aaf219564f16d3e0ad71b8fcb7d53e", "committedDate": "2020-02-13T08:38:12Z", "message": "CB-5526 Subnet should be private if it has no IG"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d2825eaa28aaf219564f16d3e0ad71b8fcb7d53e", "author": {"user": {"login": "gergopapi2", "name": "Gergely Papp"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/d2825eaa28aaf219564f16d3e0ad71b8fcb7d53e", "committedDate": "2020-02-13T08:38:12Z", "message": "CB-5526 Subnet should be private if it has no IG"}, "afterCommit": {"oid": "7d578002716ff7a165098fee2b6a470c036e5290", "author": {"user": {"login": "gergopapi2", "name": "Gergely Papp"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/7d578002716ff7a165098fee2b6a470c036e5290", "committedDate": "2020-02-13T09:24:37Z", "message": "CB-5526 Subnet should be private if it has no IG"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7d578002716ff7a165098fee2b6a470c036e5290", "author": {"user": {"login": "gergopapi2", "name": "Gergely Papp"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/7d578002716ff7a165098fee2b6a470c036e5290", "committedDate": "2020-02-13T09:24:37Z", "message": "CB-5526 Subnet should be private if it has no IG"}, "afterCommit": {"oid": "65d879a6e4c53c009d13680f08b3c46b79ac4516", "author": {"user": {"login": "gergopapi2", "name": "Gergely Papp"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/65d879a6e4c53c009d13680f08b3c46b79ac4516", "committedDate": "2020-02-13T09:29:51Z", "message": "CB-5526 Subnet should be private if it has no IG"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4MTQ1NjQ0", "url": "https://github.com/hortonworks/cloudbreak/pull/7274#pullrequestreview-358145644", "createdAt": "2020-02-13T11:31:02Z", "commit": {"oid": "65d879a6e4c53c009d13680f08b3c46b79ac4516"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMTozMTowMlrOFpQcWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMTozMTowMlrOFpQcWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODgwNTMzOQ==", "bodyText": "We are passing hasInternetGateway's value 2 times here.", "url": "https://github.com/hortonworks/cloudbreak/pull/7274#discussion_r378805339", "createdAt": "2020-02-13T11:31:02Z", "author": {"login": "keyki"}, "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/AwsPlatformResources.java", "diffHunk": "@@ -389,7 +389,7 @@ private DescribeVpcsRequest getDescribeVpcsRequestWIthFilters(Map<String, String\n                             subnetName.orElse(subnet.getSubnetId()),\n                             subnet.getAvailabilityZone(),\n                             subnet.getCidrBlock(),\n-                            !subnet.isMapPublicIpOnLaunch(),\n+                            !hasInternetGateway,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65d879a6e4c53c009d13680f08b3c46b79ac4516"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4MTQ3MDA0", "url": "https://github.com/hortonworks/cloudbreak/pull/7274#pullrequestreview-358147004", "createdAt": "2020-02-13T11:33:43Z", "commit": {"oid": "65d879a6e4c53c009d13680f08b3c46b79ac4516"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMTozMzo0M1rOFpQgpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMTozMzo0M1rOFpQgpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODgwNjQzNw==", "bodyText": "return with the optional here", "url": "https://github.com/hortonworks/cloudbreak/pull/7274#discussion_r378806437", "createdAt": "2020-02-13T11:33:43Z", "author": {"login": "lacikaaa"}, "path": "environment/src/main/java/com/sequenceiq/environment/network/service/SubnetIdProvider.java", "diffHunk": "@@ -1,27 +1,58 @@\n package com.sequenceiq.environment.network.service;\n \n+import static com.sequenceiq.cloudbreak.common.mappable.CloudPlatform.AZURE;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n import java.util.Optional;\n \n+import org.apache.commons.lang3.StringUtils;\n import org.springframework.stereotype.Component;\n \n import com.sequenceiq.cloudbreak.cloud.model.CloudSubnet;\n+import com.sequenceiq.cloudbreak.common.mappable.CloudPlatform;\n import com.sequenceiq.common.api.type.Tunnel;\n import com.sequenceiq.environment.network.dto.NetworkDto;\n \n @Component\n public class SubnetIdProvider {\n \n-    public String provide(NetworkDto network, Tunnel tunnel) {\n-        if (network != null && network.getSubnetIds() != null && !network.getSubnetIds().isEmpty()) {\n-            return getSubnetIdByPreferedSubnetType(network, tunnel.useCcm());\n-        } else {\n-            return null;\n+    public String provide(NetworkDto network, Tunnel tunnel, CloudPlatform cloudPlatform) {\n+        return network != null && network.getSubnetIds() != null && !network.getSubnetIds().isEmpty() && !network.getSubnetMetas().isEmpty()\n+                ? getSubnetIdByPreferedSubnetType(network, tunnel.useCcm(), cloudPlatform)\n+                : null;\n+    }\n+\n+    private String getSubnetIdByPreferedSubnetType(NetworkDto network, boolean preferPrivate, CloudPlatform cloudPlatform) {\n+        List<CloudSubnet> subnetMetas = new ArrayList<>(network.getSubnetMetas().values());\n+        return AZURE.equals(cloudPlatform)\n+                ? subnetMetas.get(0).getId()\n+                : getSubnetIdByPreferedSubnetTypeAws(subnetMetas, preferPrivate);\n+    }\n+\n+    private String getSubnetIdByPreferedSubnetTypeAws(List<CloudSubnet> subnetMetas, boolean preferPrivate) {\n+        String chosenSubnetId = preferPrivate ? tryGetOnePrivateSubnet(subnetMetas) : tryGetOnePublicSubnet(subnetMetas);\n+        if (StringUtils.isEmpty(chosenSubnetId) && !preferPrivate) {\n+            chosenSubnetId = tryGetOnePrivateSubnet(subnetMetas);\n         }\n+        if (StringUtils.isEmpty(chosenSubnetId)) {\n+            chosenSubnetId = subnetMetas.get(0).getId();\n+        }\n+        return chosenSubnetId;\n+    }\n+\n+    private String tryGetOnePublicSubnet(List<CloudSubnet> subnetMetas) {\n+        Optional<CloudSubnet> publicSubnet = subnetMetas.stream()\n+                .filter(sn -> !sn.isPrivateSubnet() && sn.isMapPublicIpOnLaunch())\n+                .findAny();\n+        return publicSubnet.isPresent() ? publicSubnet.get().getId() : \"\";\n     }\n \n-    private String getSubnetIdByPreferedSubnetType(NetworkDto network, boolean preferPrivate) {\n-        Optional<CloudSubnet> subnet =\n-                network.getSubnetMetas().values().stream().filter(cloudSubnet -> preferPrivate == cloudSubnet.isPrivateSubnet()).findAny();\n-        return subnet.isPresent() ? subnet.get().getId() : network.getSubnetIds().iterator().next();\n+    private String tryGetOnePrivateSubnet(List<CloudSubnet> subnetMetas) {\n+        Optional<CloudSubnet> privateSubnet = subnetMetas.stream()\n+                .filter(CloudSubnet::isPrivateSubnet)\n+                .findFirst();\n+        return privateSubnet.isPresent() ? privateSubnet.get().getId() : \"\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65d879a6e4c53c009d13680f08b3c46b79ac4516"}, "originalPosition": 64}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4MTQ3Mjk4", "url": "https://github.com/hortonworks/cloudbreak/pull/7274#pullrequestreview-358147298", "createdAt": "2020-02-13T11:34:19Z", "commit": {"oid": "65d879a6e4c53c009d13680f08b3c46b79ac4516"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMTozNDoxOVrOFpQhtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMTozNDoxOVrOFpQhtw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODgwNjcxMQ==", "bodyText": "return with optional here", "url": "https://github.com/hortonworks/cloudbreak/pull/7274#discussion_r378806711", "createdAt": "2020-02-13T11:34:19Z", "author": {"login": "lacikaaa"}, "path": "environment/src/main/java/com/sequenceiq/environment/network/service/SubnetIdProvider.java", "diffHunk": "@@ -1,27 +1,58 @@\n package com.sequenceiq.environment.network.service;\n \n+import static com.sequenceiq.cloudbreak.common.mappable.CloudPlatform.AZURE;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n import java.util.Optional;\n \n+import org.apache.commons.lang3.StringUtils;\n import org.springframework.stereotype.Component;\n \n import com.sequenceiq.cloudbreak.cloud.model.CloudSubnet;\n+import com.sequenceiq.cloudbreak.common.mappable.CloudPlatform;\n import com.sequenceiq.common.api.type.Tunnel;\n import com.sequenceiq.environment.network.dto.NetworkDto;\n \n @Component\n public class SubnetIdProvider {\n \n-    public String provide(NetworkDto network, Tunnel tunnel) {\n-        if (network != null && network.getSubnetIds() != null && !network.getSubnetIds().isEmpty()) {\n-            return getSubnetIdByPreferedSubnetType(network, tunnel.useCcm());\n-        } else {\n-            return null;\n+    public String provide(NetworkDto network, Tunnel tunnel, CloudPlatform cloudPlatform) {\n+        return network != null && network.getSubnetIds() != null && !network.getSubnetIds().isEmpty() && !network.getSubnetMetas().isEmpty()\n+                ? getSubnetIdByPreferedSubnetType(network, tunnel.useCcm(), cloudPlatform)\n+                : null;\n+    }\n+\n+    private String getSubnetIdByPreferedSubnetType(NetworkDto network, boolean preferPrivate, CloudPlatform cloudPlatform) {\n+        List<CloudSubnet> subnetMetas = new ArrayList<>(network.getSubnetMetas().values());\n+        return AZURE.equals(cloudPlatform)\n+                ? subnetMetas.get(0).getId()\n+                : getSubnetIdByPreferedSubnetTypeAws(subnetMetas, preferPrivate);\n+    }\n+\n+    private String getSubnetIdByPreferedSubnetTypeAws(List<CloudSubnet> subnetMetas, boolean preferPrivate) {\n+        String chosenSubnetId = preferPrivate ? tryGetOnePrivateSubnet(subnetMetas) : tryGetOnePublicSubnet(subnetMetas);\n+        if (StringUtils.isEmpty(chosenSubnetId) && !preferPrivate) {\n+            chosenSubnetId = tryGetOnePrivateSubnet(subnetMetas);\n         }\n+        if (StringUtils.isEmpty(chosenSubnetId)) {\n+            chosenSubnetId = subnetMetas.get(0).getId();\n+        }\n+        return chosenSubnetId;\n+    }\n+\n+    private String tryGetOnePublicSubnet(List<CloudSubnet> subnetMetas) {\n+        Optional<CloudSubnet> publicSubnet = subnetMetas.stream()\n+                .filter(sn -> !sn.isPrivateSubnet() && sn.isMapPublicIpOnLaunch())\n+                .findAny();\n+        return publicSubnet.isPresent() ? publicSubnet.get().getId() : \"\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65d879a6e4c53c009d13680f08b3c46b79ac4516"}, "originalPosition": 53}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4MTUwMTYy", "url": "https://github.com/hortonworks/cloudbreak/pull/7274#pullrequestreview-358150162", "createdAt": "2020-02-13T11:39:47Z", "commit": {"oid": "65d879a6e4c53c009d13680f08b3c46b79ac4516"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMTozOTo0N1rOFpQqeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMTozOTo0N1rOFpQqeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODgwODk1Mg==", "bodyText": "I'm missing the scenario here, when we prefer private, but we don't have one, we should choose a public with mapPublicIpOnLaunch enabled if it's possible, and fall back to any subnet if it fails", "url": "https://github.com/hortonworks/cloudbreak/pull/7274#discussion_r378808952", "createdAt": "2020-02-13T11:39:47Z", "author": {"login": "lacikaaa"}, "path": "environment/src/main/java/com/sequenceiq/environment/network/service/SubnetIdProvider.java", "diffHunk": "@@ -1,27 +1,58 @@\n package com.sequenceiq.environment.network.service;\n \n+import static com.sequenceiq.cloudbreak.common.mappable.CloudPlatform.AZURE;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n import java.util.Optional;\n \n+import org.apache.commons.lang3.StringUtils;\n import org.springframework.stereotype.Component;\n \n import com.sequenceiq.cloudbreak.cloud.model.CloudSubnet;\n+import com.sequenceiq.cloudbreak.common.mappable.CloudPlatform;\n import com.sequenceiq.common.api.type.Tunnel;\n import com.sequenceiq.environment.network.dto.NetworkDto;\n \n @Component\n public class SubnetIdProvider {\n \n-    public String provide(NetworkDto network, Tunnel tunnel) {\n-        if (network != null && network.getSubnetIds() != null && !network.getSubnetIds().isEmpty()) {\n-            return getSubnetIdByPreferedSubnetType(network, tunnel.useCcm());\n-        } else {\n-            return null;\n+    public String provide(NetworkDto network, Tunnel tunnel, CloudPlatform cloudPlatform) {\n+        return network != null && network.getSubnetIds() != null && !network.getSubnetIds().isEmpty() && !network.getSubnetMetas().isEmpty()\n+                ? getSubnetIdByPreferedSubnetType(network, tunnel.useCcm(), cloudPlatform)\n+                : null;\n+    }\n+\n+    private String getSubnetIdByPreferedSubnetType(NetworkDto network, boolean preferPrivate, CloudPlatform cloudPlatform) {\n+        List<CloudSubnet> subnetMetas = new ArrayList<>(network.getSubnetMetas().values());\n+        return AZURE.equals(cloudPlatform)\n+                ? subnetMetas.get(0).getId()\n+                : getSubnetIdByPreferedSubnetTypeAws(subnetMetas, preferPrivate);\n+    }\n+\n+    private String getSubnetIdByPreferedSubnetTypeAws(List<CloudSubnet> subnetMetas, boolean preferPrivate) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65d879a6e4c53c009d13680f08b3c46b79ac4516"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4MTUxNDEw", "url": "https://github.com/hortonworks/cloudbreak/pull/7274#pullrequestreview-358151410", "createdAt": "2020-02-13T11:42:13Z", "commit": {"oid": "65d879a6e4c53c009d13680f08b3c46b79ac4516"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "65d879a6e4c53c009d13680f08b3c46b79ac4516", "author": {"user": {"login": "gergopapi2", "name": "Gergely Papp"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/65d879a6e4c53c009d13680f08b3c46b79ac4516", "committedDate": "2020-02-13T09:29:51Z", "message": "CB-5526 Subnet should be private if it has no IG"}, "afterCommit": {"oid": "c0f05ac94d668948ad4b694bcf6f01b7c61e4270", "author": {"user": {"login": "gergopapi2", "name": "Gergely Papp"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/c0f05ac94d668948ad4b694bcf6f01b7c61e4270", "committedDate": "2020-02-13T15:07:51Z", "message": "CB-5526 Subnet should be private if it has no IG"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4MzA3Nzkx", "url": "https://github.com/hortonworks/cloudbreak/pull/7274#pullrequestreview-358307791", "createdAt": "2020-02-13T15:26:04Z", "commit": {"oid": "c0f05ac94d668948ad4b694bcf6f01b7c61e4270"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxNToyNjowNVrOFpYH6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxNToyNjowNVrOFpYH6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODkzMTE3OA==", "bodyText": "it would reflect the logic more if you move this if into the upper one", "url": "https://github.com/hortonworks/cloudbreak/pull/7274#discussion_r378931178", "createdAt": "2020-02-13T15:26:05Z", "author": {"login": "lacikaaa"}, "path": "environment/src/main/java/com/sequenceiq/environment/network/service/SubnetIdProvider.java", "diffHunk": "@@ -1,27 +1,66 @@\n package com.sequenceiq.environment.network.service;\n \n+import static com.sequenceiq.cloudbreak.common.mappable.CloudPlatform.AZURE;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n import java.util.Optional;\n \n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n import org.springframework.stereotype.Component;\n \n import com.sequenceiq.cloudbreak.cloud.model.CloudSubnet;\n+import com.sequenceiq.cloudbreak.common.mappable.CloudPlatform;\n import com.sequenceiq.common.api.type.Tunnel;\n import com.sequenceiq.environment.network.dto.NetworkDto;\n \n @Component\n public class SubnetIdProvider {\n+    private static final Logger LOGGER = LoggerFactory.getLogger(SubnetIdProvider.class);\n \n-    public String provide(NetworkDto network, Tunnel tunnel) {\n-        if (network != null && network.getSubnetIds() != null && !network.getSubnetIds().isEmpty()) {\n-            return getSubnetIdByPreferedSubnetType(network, tunnel.useCcm());\n-        } else {\n+    public String provide(NetworkDto network, Tunnel tunnel, CloudPlatform cloudPlatform) {\n+        LOGGER.debug(\"Choosing subnet, network: {},  platform: {}, tunnel: {}\", network, cloudPlatform, tunnel);\n+        if (network == null || network.getSubnetIds() == null || network.getSubnetIds().isEmpty() || network.getSubnetMetas().isEmpty()) {\n+            LOGGER.debug(\"Check failed, returning null\");\n             return null;\n         }\n+        return getSubnetIdByPreferedSubnetType(network, tunnel.useCcm(), cloudPlatform);\n+    }\n+\n+    private String getSubnetIdByPreferedSubnetType(NetworkDto network, boolean preferPrivate, CloudPlatform cloudPlatform) {\n+        List<CloudSubnet> subnetMetas = new ArrayList<>(network.getSubnetMetas().values());\n+        return AZURE.equals(cloudPlatform)\n+                ? subnetMetas.get(0).getId()\n+                : getSubnetIdByPreferedSubnetTypeAws(subnetMetas, preferPrivate);\n+    }\n+\n+    private String getSubnetIdByPreferedSubnetTypeAws(List<CloudSubnet> subnetMetas, boolean preferPrivate) {\n+        LOGGER.debug(\"Choosing aws subnet, preferring private: {}, available\", preferPrivate);\n+        Optional<CloudSubnet> foundCloudSubnet = preferPrivate ? tryGetOnePrivateSubnet(subnetMetas) : tryGetOnePublicSubnet(subnetMetas);\n+        if (foundCloudSubnet.isEmpty()) {\n+            LOGGER.debug(\"Choosing subnet alternate strategy\");\n+            // This is just trying the reverse option, i.e. if we preferred private but there was no private then let's look for a suitable public subnet\n+            foundCloudSubnet = preferPrivate ? tryGetOnePublicSubnet(subnetMetas) : tryGetOnePrivateSubnet(subnetMetas);\n+        }\n+        if (foundCloudSubnet.isEmpty()) {\n+            LOGGER.debug(\"Choosing subnet, fallback to any subnet\");\n+            foundCloudSubnet = Optional.of(subnetMetas.get(0));\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c0f05ac94d668948ad4b694bcf6f01b7c61e4270"}, "originalPosition": 53}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4MzE0ODY3", "url": "https://github.com/hortonworks/cloudbreak/pull/7274#pullrequestreview-358314867", "createdAt": "2020-02-13T15:33:49Z", "commit": {"oid": "c0f05ac94d668948ad4b694bcf6f01b7c61e4270"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxNTozMzo0OVrOFpYcaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxNTozMzo0OVrOFpYcaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODkzNjQyNQ==", "bodyText": "this could be moved out and givne a meaningful name so we don't need the comment", "url": "https://github.com/hortonworks/cloudbreak/pull/7274#discussion_r378936425", "createdAt": "2020-02-13T15:33:49Z", "author": {"login": "lacikaaa"}, "path": "environment/src/main/java/com/sequenceiq/environment/network/service/SubnetIdProvider.java", "diffHunk": "@@ -1,27 +1,66 @@\n package com.sequenceiq.environment.network.service;\n \n+import static com.sequenceiq.cloudbreak.common.mappable.CloudPlatform.AZURE;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n import java.util.Optional;\n \n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n import org.springframework.stereotype.Component;\n \n import com.sequenceiq.cloudbreak.cloud.model.CloudSubnet;\n+import com.sequenceiq.cloudbreak.common.mappable.CloudPlatform;\n import com.sequenceiq.common.api.type.Tunnel;\n import com.sequenceiq.environment.network.dto.NetworkDto;\n \n @Component\n public class SubnetIdProvider {\n+    private static final Logger LOGGER = LoggerFactory.getLogger(SubnetIdProvider.class);\n \n-    public String provide(NetworkDto network, Tunnel tunnel) {\n-        if (network != null && network.getSubnetIds() != null && !network.getSubnetIds().isEmpty()) {\n-            return getSubnetIdByPreferedSubnetType(network, tunnel.useCcm());\n-        } else {\n+    public String provide(NetworkDto network, Tunnel tunnel, CloudPlatform cloudPlatform) {\n+        LOGGER.debug(\"Choosing subnet, network: {},  platform: {}, tunnel: {}\", network, cloudPlatform, tunnel);\n+        if (network == null || network.getSubnetIds() == null || network.getSubnetIds().isEmpty() || network.getSubnetMetas().isEmpty()) {\n+            LOGGER.debug(\"Check failed, returning null\");\n             return null;\n         }\n+        return getSubnetIdByPreferedSubnetType(network, tunnel.useCcm(), cloudPlatform);\n+    }\n+\n+    private String getSubnetIdByPreferedSubnetType(NetworkDto network, boolean preferPrivate, CloudPlatform cloudPlatform) {\n+        List<CloudSubnet> subnetMetas = new ArrayList<>(network.getSubnetMetas().values());\n+        return AZURE.equals(cloudPlatform)\n+                ? subnetMetas.get(0).getId()\n+                : getSubnetIdByPreferedSubnetTypeAws(subnetMetas, preferPrivate);\n+    }\n+\n+    private String getSubnetIdByPreferedSubnetTypeAws(List<CloudSubnet> subnetMetas, boolean preferPrivate) {\n+        LOGGER.debug(\"Choosing aws subnet, preferring private: {}, available\", preferPrivate);\n+        Optional<CloudSubnet> foundCloudSubnet = preferPrivate ? tryGetOnePrivateSubnet(subnetMetas) : tryGetOnePublicSubnet(subnetMetas);\n+        if (foundCloudSubnet.isEmpty()) {\n+            LOGGER.debug(\"Choosing subnet alternate strategy\");\n+            // This is just trying the reverse option, i.e. if we preferred private but there was no private then let's look for a suitable public subnet\n+            foundCloudSubnet = preferPrivate ? tryGetOnePublicSubnet(subnetMetas) : tryGetOnePrivateSubnet(subnetMetas);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c0f05ac94d668948ad4b694bcf6f01b7c61e4270"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4MzE4MjIy", "url": "https://github.com/hortonworks/cloudbreak/pull/7274#pullrequestreview-358318222", "createdAt": "2020-02-13T15:37:44Z", "commit": {"oid": "c0f05ac94d668948ad4b694bcf6f01b7c61e4270"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxNTozNzo0NVrOFpYmUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxNTozNzo0NVrOFpYmUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODkzODk2Mw==", "bodyText": "I don't like it's called privateSubnet and we set the IGW from it. We request the IGW setting boolean hasInternetGateway = awsSubnetIgwExplorer.hasInternetGatewayOfSubnet(describeRouteTablesResult, subnet.getSubnetId()); from AWS so it would make sense, that the parameter is called IGW, and we set the privateSubnet from it's value and not reversed.", "url": "https://github.com/hortonworks/cloudbreak/pull/7274#discussion_r378938963", "createdAt": "2020-02-13T15:37:45Z", "author": {"login": "lacikaaa"}, "path": "cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/model/CloudSubnet.java", "diffHunk": "@@ -39,6 +39,16 @@ public CloudSubnet(String id, String name, String availabilityZone, String cidr)\n         this.cidr = cidr;\n     }\n \n+    public CloudSubnet(String id, String name, String availabilityZone, String cidr, boolean privateSubnet, boolean mapPublicIpOnLaunch) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c0f05ac94d668948ad4b694bcf6f01b7c61e4270"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c0f05ac94d668948ad4b694bcf6f01b7c61e4270", "author": {"user": {"login": "gergopapi2", "name": "Gergely Papp"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/c0f05ac94d668948ad4b694bcf6f01b7c61e4270", "committedDate": "2020-02-13T15:07:51Z", "message": "CB-5526 Subnet should be private if it has no IG"}, "afterCommit": {"oid": "4f935b7f4a84db806438c1a9c28eded56d67a30f", "author": {"user": {"login": "gergopapi2", "name": "Gergely Papp"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/4f935b7f4a84db806438c1a9c28eded56d67a30f", "committedDate": "2020-02-13T16:01:58Z", "message": "CB-5526 Subnet should be private if it has no IG"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4MzQ0MDkw", "url": "https://github.com/hortonworks/cloudbreak/pull/7274#pullrequestreview-358344090", "createdAt": "2020-02-13T16:04:57Z", "commit": {"oid": "4f935b7f4a84db806438c1a9c28eded56d67a30f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae9d508abd4cdb842f193a494ee1b002bb280ec7", "author": {"user": {"login": "gergopapi2", "name": "Gergely Papp"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/ae9d508abd4cdb842f193a494ee1b002bb280ec7", "committedDate": "2020-02-13T18:15:50Z", "message": "CB-5526 Subnet should be private if it has no IG"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4f935b7f4a84db806438c1a9c28eded56d67a30f", "author": {"user": {"login": "gergopapi2", "name": "Gergely Papp"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/4f935b7f4a84db806438c1a9c28eded56d67a30f", "committedDate": "2020-02-13T16:01:58Z", "message": "CB-5526 Subnet should be private if it has no IG"}, "afterCommit": {"oid": "ae9d508abd4cdb842f193a494ee1b002bb280ec7", "author": {"user": {"login": "gergopapi2", "name": "Gergely Papp"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/ae9d508abd4cdb842f193a494ee1b002bb280ec7", "committedDate": "2020-02-13T18:15:50Z", "message": "CB-5526 Subnet should be private if it has no IG"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1861, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}