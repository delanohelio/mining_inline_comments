{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA2OTQ4NzE3", "number": 9252, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMTowMTowOVrOEx2Z7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQwOTowNTo1M1rOEytpUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwNzA3MDUyOnYy", "diffSide": "RIGHT", "path": "environment/src/main/java/com/sequenceiq/environment/telemetry/service/AccountTelemetryService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMTowMTowOVrOHoKfsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMTowMTowOVrOHoKfsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg3NzA0MA==", "bodyText": "I think we won't notice this issue when something is wrong if we let the app start", "url": "https://github.com/hortonworks/cloudbreak/pull/9252#discussion_r511877040", "createdAt": "2020-10-26T11:01:09Z", "author": {"login": "lacikaaa"}, "path": "environment/src/main/java/com/sequenceiq/environment/telemetry/service/AccountTelemetryService.java", "diffHunk": "@@ -28,28 +38,25 @@\n \n     private static final Logger LOGGER = LoggerFactory.getLogger(AccountTelemetryService.class);\n \n-    private static final String EMAIL_PATTERN = \"\\\\b([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\\\\-\\\\._]\" +\n-            \"*[A-Za-z0-9])@(([A-Za-z0-9]|[A-Za-z][A-Za-z0-9\\\\-]*[A-Za-z0-9])\\\\.)+([A-Za-z0-9]\" +\n-            \"|[A-Za-z0-9][A-Za-z0-9\\\\-]*[A-Za-z0-9])\\\\b\";\n-\n-    private static final String EMAIL_REPLACEMENT = \"email@redacted.host\";\n-\n-    private static final String CREDIT_CARD_PATTERN = \"\\\\d{4}[^\\\\w]\\\\d{4}[^\\\\w]\\\\d{4}[^\\\\w]\\\\d{4}\";\n-\n-    private static final String CREDIT_CARD_REPLACEMENT = \"XXXX-XXXX-XXXX-XXXX\";\n-\n-    private static final String SSN_PATTERN = \"\\\\d{3}[^\\\\w]\\\\d{2}[^\\\\w]\\\\d{4}\";\n-\n-    private static final String SSN_REPLACEMENT = \"XXX-XX-XXXX\";\n-\n-    private static final String FREEIPA_PWD_PATTERN = \"FPW\\\\:\\\\s+[\\\\w|\\\\W].*\";\n+    private final AccountTelemetryRepository accountTelemetryRepository;\n \n-    private static final String FREEIPA_PWD_REPLACEMENT = \"FPW: [REDACTED]\";\n+    private final String rulesFileLocation;\n \n-    private final AccountTelemetryRepository accountTelemetryRepository;\n+    private List<AnonymizationRule> defaultRules = new ArrayList<>();\n \n-    public AccountTelemetryService(AccountTelemetryRepository accountTelemetryRepository) {\n+    public AccountTelemetryService(AccountTelemetryRepository accountTelemetryRepository,\n+            @Value(\"${environment.telemetry.default.rules.file:telemetry/default-anonymization-rules.yaml\") String rulesFileLocation) {\n         this.accountTelemetryRepository = accountTelemetryRepository;\n+        this.rulesFileLocation = rulesFileLocation;\n+    }\n+\n+    @PostConstruct\n+    public void init() {\n+        try {\n+            defaultRules = loadAnonymizationRules();\n+        } catch (IOException e) {\n+            LOGGER.error(\"Error during loading default anonymization rules.\", e);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "260282c2433a40c7065a9ca3b260c2f11a482e84"}, "originalPosition": 67}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwNzA3OTEwOnYy", "diffSide": "RIGHT", "path": "environment/src/test/resources/default-anonymization-rules.yaml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMTowMzo1MVrOHoKlPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxNToxMzowNlrOHpBfpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg3ODQ2Mg==", "bodyText": "we should test the same file we use in prod, and not a different one.", "url": "https://github.com/hortonworks/cloudbreak/pull/9252#discussion_r511878462", "createdAt": "2020-10-26T11:03:51Z", "author": {"login": "lacikaaa"}, "path": "environment/src/test/resources/default-anonymization-rules.yaml", "diffHunk": "@@ -0,0 +1,10 @@\n+- pattern: \\b([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\\-\\._]*[A-Za-z0-9])@(([A-Za-z0-9]|[A-Za-z][A-Za-z0-9\\-]*[A-Za-z0-9])\\.)+([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\\-]*[A-Za-z0-9])\\b\n+  replacement: \"email@redacted.host\"\n+- pattern: \\d{4}[^\\w]\\d{4}[^\\w]\\d{4}[^\\w]\\d{4}\n+  replacement: \"XXXX-XXXX-XXXX-XXXX\"\n+- pattern: \\d{3}[^\\w]\\d{2}[^\\w]\\d{4}\n+  replacement: \"XXX-XX-XXXX\"\n+- pattern: FPW\\:\\s+[\\w|\\W].*\n+  replacement: \"FPW: [REDACTED]\"\n+- pattern: cdpHashedPassword=.*[']\n+  replacement: \"[CDP PWD ATTRS REDACTED]\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "260282c2433a40c7065a9ca3b260c2f11a482e84"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjc3ODE1MA==", "bodyText": "now the objects are mocked as the tests are not about to parsing the files (as config read from application.yml)", "url": "https://github.com/hortonworks/cloudbreak/pull/9252#discussion_r512778150", "createdAt": "2020-10-27T15:13:06Z", "author": {"login": "oleewere"}, "path": "environment/src/test/resources/default-anonymization-rules.yaml", "diffHunk": "@@ -0,0 +1,10 @@\n+- pattern: \\b([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\\-\\._]*[A-Za-z0-9])@(([A-Za-z0-9]|[A-Za-z][A-Za-z0-9\\-]*[A-Za-z0-9])\\.)+([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\\-]*[A-Za-z0-9])\\b\n+  replacement: \"email@redacted.host\"\n+- pattern: \\d{4}[^\\w]\\d{4}[^\\w]\\d{4}[^\\w]\\d{4}\n+  replacement: \"XXXX-XXXX-XXXX-XXXX\"\n+- pattern: \\d{3}[^\\w]\\d{2}[^\\w]\\d{4}\n+  replacement: \"XXX-XX-XXXX\"\n+- pattern: FPW\\:\\s+[\\w|\\W].*\n+  replacement: \"FPW: [REDACTED]\"\n+- pattern: cdpHashedPassword=.*[']\n+  replacement: \"[CDP PWD ATTRS REDACTED]\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg3ODQ2Mg=="}, "originalCommit": {"oid": "260282c2433a40c7065a9ca3b260c2f11a482e84"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwNzExMTE0OnYy", "diffSide": "RIGHT", "path": "environment/src/main/java/com/sequenceiq/environment/telemetry/service/AccountTelemetryService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMToxMzowMlrOHoK4Pw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMToxMzowMlrOHoK4Pw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg4MzMyNw==", "bodyText": "instead of reading the file manually, wouldn't be it better if we would use spring for this? like in InstanceMetadataUpdater we use it for reading the packages info.", "url": "https://github.com/hortonworks/cloudbreak/pull/9252#discussion_r511883327", "createdAt": "2020-10-26T11:13:02Z", "author": {"login": "lacikaaa"}, "path": "environment/src/main/java/com/sequenceiq/environment/telemetry/service/AccountTelemetryService.java", "diffHunk": "@@ -190,4 +178,26 @@ private String createCRN(String accountId) {\n                 .build()\n                 .toString();\n     }\n+\n+    private List<AnonymizationRule> loadAnonymizationRules() throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "260282c2433a40c7065a9ca3b260c2f11a482e84"}, "originalPosition": 122}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwNzExMzgyOnYy", "diffSide": "RIGHT", "path": "environment/src/main/resources/telemetry/default-anonymization-rules.yaml", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMToxMzo1N1rOHoK57w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMToxMzo1N1rOHoK57w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg4Mzc1OQ==", "bodyText": "unnecessary space as first char", "url": "https://github.com/hortonworks/cloudbreak/pull/9252#discussion_r511883759", "createdAt": "2020-10-26T11:13:57Z", "author": {"login": "lacikaaa"}, "path": "environment/src/main/resources/telemetry/default-anonymization-rules.yaml", "diffHunk": "@@ -0,0 +1,10 @@\n+- pattern: \\b([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\\-\\._]*[A-Za-z0-9])@(([A-Za-z0-9]|[A-Za-z][A-Za-z0-9\\-]*[A-Za-z0-9])\\.)+([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\\-]*[A-Za-z0-9])\\b\n+  replacement: \"email@redacted.host\"\n+- pattern: \\d{4}[^\\w]\\d{4}[^\\w]\\d{4}[^\\w]\\d{4}\n+  replacement: \"XXXX-XXXX-XXXX-XXXX\"\n+- pattern: \\d{3}[^\\w]\\d{2}[^\\w]\\d{4}\n+  replacement: \"XXX-XX-XXXX\"\n+- pattern: FPW\\:\\s+[\\w|\\W].*\n+  replacement: \"FPW: [REDACTED]\"\n+ - pattern: cdpHashedPassword=.*[']", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "260282c2433a40c7065a9ca3b260c2f11a482e84"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxNjEyMTEyOnYy", "diffSide": "RIGHT", "path": "environment/src/main/java/com/sequenceiq/environment/configuration/telemetry/AccountTelemetryConfig.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQwOTowNTo1M1rOHpgJUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQwOTowNTo1M1rOHpgJUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzI4MDMzOA==", "bodyText": "the main purpose of @Configuration is to indicate the class declares Beans\nI think here we should go with @Component", "url": "https://github.com/hortonworks/cloudbreak/pull/9252#discussion_r513280338", "createdAt": "2020-10-28T09:05:53Z", "author": {"login": "lacikaaa"}, "path": "environment/src/main/java/com/sequenceiq/environment/configuration/telemetry/AccountTelemetryConfig.java", "diffHunk": "@@ -0,0 +1,24 @@\n+package com.sequenceiq.environment.configuration.telemetry;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.springframework.boot.context.properties.ConfigurationProperties;\n+import org.springframework.context.annotation.Configuration;\n+\n+import com.sequenceiq.common.api.telemetry.model.AnonymizationRule;\n+\n+@Configuration", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "83bbde7a33a5aa8479394b51a4fd72ea958ba5d1"}, "originalPosition": 11}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2022, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}