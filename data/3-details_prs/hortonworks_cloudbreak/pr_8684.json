{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYwMjU1OTk0", "number": 8684, "title": "CB-7930 adding UMSClient to tests so we can assign resourceRoles", "bodyText": "added example of assigning resource roles\nwill add more testcases and datahub creation usecase", "createdAt": "2020-07-31T15:36:55Z", "url": "https://github.com/hortonworks/cloudbreak/pull/8684", "merged": true, "mergeCommit": {"oid": "0466d3211ad9e739008dc9f81afbda2a67a1cced"}, "closed": true, "closedAt": "2020-08-05T17:26:00Z", "author": {"login": "lnardai"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc7MqoDABqjM2MTQ1NjkxNTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc79zoUgBqjM2MjU0OTMyODA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "68176417144dc7a9a6f69c9b522dae95c584203b", "author": {"user": {"login": "lnardai", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/68176417144dc7a9a6f69c9b522dae95c584203b", "committedDate": "2020-07-31T07:22:47Z", "message": "CB-7930 adding UMSClient to tests so we can assign resourceRoles"}, "afterCommit": {"oid": "2d25e56456cf804e568cdcdf7cb49c9102d68277", "author": {"user": {"login": "lnardai", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/2d25e56456cf804e568cdcdf7cb49c9102d68277", "committedDate": "2020-08-03T06:09:44Z", "message": "CB-7930 adding UMSClient to tests so we can assign resourceRoles"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2d25e56456cf804e568cdcdf7cb49c9102d68277", "author": {"user": {"login": "lnardai", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/2d25e56456cf804e568cdcdf7cb49c9102d68277", "committedDate": "2020-08-03T06:09:44Z", "message": "CB-7930 adding UMSClient to tests so we can assign resourceRoles"}, "afterCommit": {"oid": "fd758d4549eee171e1ed044c1805f090f640f844", "author": {"user": {"login": "lnardai", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/fd758d4549eee171e1ed044c1805f090f640f844", "committedDate": "2020-08-03T08:55:01Z", "message": "CB-7930 adding UMSClient to tests so we can assign resourceRoles"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fd758d4549eee171e1ed044c1805f090f640f844", "author": {"user": {"login": "lnardai", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/fd758d4549eee171e1ed044c1805f090f640f844", "committedDate": "2020-08-03T08:55:01Z", "message": "CB-7930 adding UMSClient to tests so we can assign resourceRoles"}, "afterCommit": {"oid": "6ec9369e63c2b0dd33803a0df5808f71ec88503b", "author": {"user": {"login": "lnardai", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/6ec9369e63c2b0dd33803a0df5808f71ec88503b", "committedDate": "2020-08-03T12:11:41Z", "message": "CB-7930 adding UMSClient to tests so we can assign resourceRoles"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5OTc2MDA4", "url": "https://github.com/hortonworks/cloudbreak/pull/8684#pullrequestreview-459976008", "createdAt": "2020-08-03T12:13:47Z", "commit": {"oid": "fd758d4549eee171e1ed044c1805f090f640f844"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxMjoxNDoxMVrOG63K4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxMjozODoxM1rOG6327A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDM3NDQ5Nw==", "bodyText": "if you can use the it framework log message too then it will be on the test report as well (it is logWhen, or something, I'll check for you if you couldn't find)", "url": "https://github.com/hortonworks/cloudbreak/pull/8684#discussion_r464374497", "createdAt": "2020-08-03T12:14:11Z", "author": {"login": "afarsang"}, "path": "integration-test/src/main/java/com/sequenceiq/it/cloudbreak/action/ums/AssignUmsRoleAction.java", "diffHunk": "@@ -0,0 +1,34 @@\n+package com.sequenceiq.it.cloudbreak.action.ums;\n+\n+import java.util.Optional;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.sequenceiq.it.cloudbreak.UmsClient;\n+import com.sequenceiq.it.cloudbreak.action.Action;\n+import com.sequenceiq.it.cloudbreak.actor.CloudbreakUser;\n+import com.sequenceiq.it.cloudbreak.context.TestContext;\n+import com.sequenceiq.it.cloudbreak.dto.environment.EnvironmentTestDto;\n+\n+public class AssignUmsRoleAction implements Action<EnvironmentTestDto, UmsClient> {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(AssignUmsRoleAction.class);\n+\n+    private String userKey;\n+\n+    private String userRoleCrn;\n+\n+    public AssignUmsRoleAction(String userKey, String userRoleCrn) {\n+        this.userKey = userKey;\n+        this.userRoleCrn = userRoleCrn;\n+    }\n+\n+    @Override\n+    public EnvironmentTestDto action(TestContext testContext, EnvironmentTestDto testDto, UmsClient client) throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ec9369e63c2b0dd33803a0df5808f71ec88503b"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDM3ODczMQ==", "bodyText": "I wouldn't enhance the basic vocabulary (given, when, then, ...), isn't it a kind of \"when\" at least \"whenAssignRole\". So the basic idea is \"given an entity/resource, when action, then assertion\".", "url": "https://github.com/hortonworks/cloudbreak/pull/8684#discussion_r464378731", "createdAt": "2020-08-03T12:23:22Z", "author": {"login": "afarsang"}, "path": "integration-test/src/main/java/com/sequenceiq/it/cloudbreak/dto/AbstractEnvironmentTestDto.java", "diffHunk": "@@ -45,6 +46,10 @@ public T when(Action<T, EnvironmentClient> action) {\n         return getTestContext().when((T) this, EnvironmentClient.class, action, emptyRunningParameter());\n     }\n \n+    public T assignRole(Action<T, UmsClient> action) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ec9369e63c2b0dd33803a0df5808f71ec88503b"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDM4NTc3Mg==", "bodyText": "Frankly I am not fond of the testContext argument in the test. It feels somehow strange (I'm already calling testContext's method, and shall I pass a testContext). Could we find some way to solve this?", "url": "https://github.com/hortonworks/cloudbreak/pull/8684#discussion_r464385772", "createdAt": "2020-08-03T12:38:13Z", "author": {"login": "afarsang"}, "path": "integration-test/src/main/java/com/sequenceiq/it/cloudbreak/testcase/authorization/DatalakeDatahubCreateAuthTest.java", "diffHunk": "@@ -81,11 +81,11 @@ public void testCreateEnvironment(MockedTestContext testContext) {\n                 .when(sdxTestClient.createInternal(), key(sdxInternal))\n                 .awaitForFlow(key(sdxInternal))\n                 .await(SdxClusterStatusResponse.RUNNING)\n-                .when(sdxTestClient.describeInternal(), RunningParameter.who(Actor.useRealUmsUser(AuthUserKeys.MGMT_CONSOLE_ADMIN_B)))\n+                .when(sdxTestClient.describeInternal(), RunningParameter.who(Actor.useRealUmsUser(AuthUserKeys.MGMT_CONSOLE_ADMIN_B, testContext)))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ec9369e63c2b0dd33803a0df5808f71ec88503b"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6ec9369e63c2b0dd33803a0df5808f71ec88503b", "author": {"user": {"login": "lnardai", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/6ec9369e63c2b0dd33803a0df5808f71ec88503b", "committedDate": "2020-08-03T12:11:41Z", "message": "CB-7930 adding UMSClient to tests so we can assign resourceRoles"}, "afterCommit": {"oid": "ea2532c19044f1da3b0a982a9b2219fb7ed562b6", "author": {"user": {"login": "lnardai", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/ea2532c19044f1da3b0a982a9b2219fb7ed562b6", "committedDate": "2020-08-05T13:10:46Z", "message": "CB-7930 adding UMSClient to tests so we can assign resourceRoles"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxNjU1OTI4", "url": "https://github.com/hortonworks/cloudbreak/pull/8684#pullrequestreview-461655928", "createdAt": "2020-08-05T13:20:13Z", "commit": {"oid": "ea2532c19044f1da3b0a982a9b2219fb7ed562b6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxNjg3NDAw", "url": "https://github.com/hortonworks/cloudbreak/pull/8684#pullrequestreview-461687400", "createdAt": "2020-08-05T13:54:59Z", "commit": {"oid": "ea2532c19044f1da3b0a982a9b2219fb7ed562b6"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxMzo1NDo1OVrOG8KwbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxMzo1NjoxMFrOG8Kz_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTc0Mzk4MA==", "bodyText": "it seems like a test although no test in the name, and testannotation on the method", "url": "https://github.com/hortonworks/cloudbreak/pull/8684#discussion_r465743980", "createdAt": "2020-08-05T13:54:59Z", "author": {"login": "afarsang"}, "path": "integration-test/src/main/java/com/sequenceiq/it/cloudbreak/testcase/authorization/CreateDhWithDatahubCreator.java", "diffHunk": "@@ -0,0 +1,97 @@\n+package com.sequenceiq.it.cloudbreak.testcase.authorization;\n+\n+import static com.sequenceiq.it.cloudbreak.context.RunningParameter.key;\n+\n+import javax.inject.Inject;\n+import javax.ws.rs.ForbiddenException;\n+\n+import com.sequenceiq.environment.api.v1.environment.model.response.EnvironmentStatus;\n+import com.sequenceiq.it.cloudbreak.actor.Actor;\n+import com.sequenceiq.it.cloudbreak.client.CredentialTestClient;\n+import com.sequenceiq.it.cloudbreak.client.DistroXTestClient;\n+import com.sequenceiq.it.cloudbreak.client.EnvironmentTestClient;\n+import com.sequenceiq.it.cloudbreak.client.FreeIpaTestClient;\n+import com.sequenceiq.it.cloudbreak.context.MockedTestContext;\n+import com.sequenceiq.it.cloudbreak.context.RunningParameter;\n+import com.sequenceiq.it.cloudbreak.context.TestContext;\n+import com.sequenceiq.it.cloudbreak.dto.credential.CredentialTestDto;\n+import com.sequenceiq.it.cloudbreak.dto.distrox.DistroXTestDto;\n+import com.sequenceiq.it.cloudbreak.dto.environment.EnvironmentTestDto;\n+import com.sequenceiq.it.cloudbreak.dto.ums.UmsTestDto;\n+import com.sequenceiq.it.cloudbreak.mock.ITResponse;\n+import com.sequenceiq.it.cloudbreak.mock.freeipa.FreeIpaRouteHandler;\n+import com.sequenceiq.it.cloudbreak.spark.DynamicRouteStack;\n+import com.sequenceiq.it.cloudbreak.testcase.AbstractIntegrationTest;\n+\n+public class CreateDhWithDatahubCreator extends AbstractIntegrationTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea2532c19044f1da3b0a982a9b2219fb7ed562b6"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTc0NDYyMA==", "bodyText": "getResponsecan be null", "url": "https://github.com/hortonworks/cloudbreak/pull/8684#discussion_r465744620", "createdAt": "2020-08-05T13:55:51Z", "author": {"login": "afarsang"}, "path": "integration-test/src/main/java/com/sequenceiq/it/cloudbreak/dto/environment/EnvironmentTestDto.java", "diffHunk": "@@ -370,4 +371,8 @@ private String getResourceGroupUsage() {\n         return getTestParameter().get(ResourceGroupTest.AZURE_RESOURCE_GROUP_USAGE);\n     }\n \n+    @Override\n+    public String getCrn() {\n+        return getResponse().getCrn();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea2532c19044f1da3b0a982a9b2219fb7ed562b6"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTc0NDg5Mg==", "bodyText": "agree :)", "url": "https://github.com/hortonworks/cloudbreak/pull/8684#discussion_r465744892", "createdAt": "2020-08-05T13:56:10Z", "author": {"login": "afarsang"}, "path": "integration-test/src/main/java/com/sequenceiq/it/cloudbreak/dto/ums/UmsTestDto.java", "diffHunk": "@@ -0,0 +1,49 @@\n+package com.sequenceiq.it.cloudbreak.dto.ums;\n+\n+import static com.sequenceiq.it.cloudbreak.context.RunningParameter.emptyRunningParameter;\n+\n+import com.sequenceiq.it.cloudbreak.Prototype;\n+import com.sequenceiq.it.cloudbreak.UmsClient;\n+import com.sequenceiq.it.cloudbreak.action.Action;\n+import com.sequenceiq.it.cloudbreak.action.ums.AssignResourceRequest;\n+import com.sequenceiq.it.cloudbreak.assign.Assignable;\n+import com.sequenceiq.it.cloudbreak.context.TestContext;\n+import com.sequenceiq.it.cloudbreak.dto.AbstractTestDto;\n+\n+@Prototype\n+public class UmsTestDto extends AbstractTestDto<AssignResourceRequest, Object, UmsTestDto, UmsClient> {\n+\n+    private static final String UMS = \"UMS\";\n+\n+    private static final String DH_CREATOR_CRN = \"crn:altus:iam:us-west-1:altus:resourceRole:DataHubCreator\";\n+\n+    public UmsTestDto(TestContext testContext) {\n+        super(new AssignResourceRequest(), testContext);\n+    }\n+\n+    public UmsTestDto() {\n+        super(UmsTestDto.class.getSimpleName().toUpperCase());\n+        setRequest(new AssignResourceRequest());\n+    }\n+\n+    public UmsTestDto withDatahubCreator() {\n+        getRequest().setRoleCrn(DH_CREATOR_CRN);\n+        return this;\n+    }\n+\n+    public UmsTestDto assignTarget(String key) {\n+        // TODO castExceptionHandling", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea2532c19044f1da3b0a982a9b2219fb7ed562b6"}, "originalPosition": 35}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ea2532c19044f1da3b0a982a9b2219fb7ed562b6", "author": {"user": {"login": "lnardai", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/ea2532c19044f1da3b0a982a9b2219fb7ed562b6", "committedDate": "2020-08-05T13:10:46Z", "message": "CB-7930 adding UMSClient to tests so we can assign resourceRoles"}, "afterCommit": {"oid": "31de010e02c02035ab8c288dbab4ca482d6d2ab5", "author": {"user": {"login": "lnardai", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/31de010e02c02035ab8c288dbab4ca482d6d2ab5", "committedDate": "2020-08-05T15:20:24Z", "message": "CB-7930 adding UMSClient to tests so we can assign resourceRoles"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f57127abfbff2281a05b31272c5a0f8c804cd8f9", "author": {"user": {"login": "lnardai", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/f57127abfbff2281a05b31272c5a0f8c804cd8f9", "committedDate": "2020-08-05T16:27:52Z", "message": "CB-7930 adding UMSClient to tests so we can assign resourceRoles"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "31de010e02c02035ab8c288dbab4ca482d6d2ab5", "author": {"user": {"login": "lnardai", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/31de010e02c02035ab8c288dbab4ca482d6d2ab5", "committedDate": "2020-08-05T15:20:24Z", "message": "CB-7930 adding UMSClient to tests so we can assign resourceRoles"}, "afterCommit": {"oid": "f57127abfbff2281a05b31272c5a0f8c804cd8f9", "author": {"user": {"login": "lnardai", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/f57127abfbff2281a05b31272c5a0f8c804cd8f9", "committedDate": "2020-08-05T16:27:52Z", "message": "CB-7930 adding UMSClient to tests so we can assign resourceRoles"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2528, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}