{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg5MzUzNDkz", "number": 7598, "title": "CB-5904: Use CA DNS name for Kerberos and LDAP", "bodyText": "The kerberos configuration and ldap configuration will use a DNS load\nbalanced entry. This will allow a failed client to reconnect to a\ndifferent server.\nSome of the unit tests were updated and it was manually tested with an\nLDAP client. The LDAP client tries the first DNS entry and on failure,\nit can retry. FreeIPA returns the entries in a random order, so it\nwill eventually try a working node. Java can be configured to cache\ngood and bad nodes.\nCloses #CB-5904", "createdAt": "2020-03-16T16:26:04Z", "url": "https://github.com/hortonworks/cloudbreak/pull/7598", "merged": true, "mergeCommit": {"oid": "a327e7c47eae250ffab2f83657e9c9c5df2969b7"}, "closed": true, "closedAt": "2020-03-20T13:03:50Z", "author": {"login": "jamisonbennett"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcOQzRFAFqTM3NTM4NjU2OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcPQB1jABqjMxNDY3MjY5NDk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1Mzg2NTY5", "url": "https://github.com/hortonworks/cloudbreak/pull/7598#pullrequestreview-375386569", "createdAt": "2020-03-16T16:35:30Z", "commit": {"oid": "14a2d81143d447282f29e8ea3196baa69ce99363"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1Mzg3MDAz", "url": "https://github.com/hortonworks/cloudbreak/pull/7598#pullrequestreview-375387003", "createdAt": "2020-03-16T16:36:05Z", "commit": {"oid": "14a2d81143d447282f29e8ea3196baa69ce99363"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxNjozNjowNVrOF28X_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxNjozNjowNVrOF28X_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzE1NjYwNQ==", "bodyText": "please do it from java", "url": "https://github.com/hortonworks/cloudbreak/pull/7598#discussion_r393156605", "createdAt": "2020-03-16T16:36:05Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/resources/freeipa-salt/salt/freeipa/scripts/freeipa_install.sh", "diffHunk": "@@ -23,4 +23,13 @@ ipa-server-install \\\n           --auto-forwarders \\\n           --unattended\n \n+# Setup basic CNAME records for pointing to FreeIPA services\n+echo \"$FPW\" | kinit admin\n+ipa dnsrecord-add $DOMAIN kdc --cname-rec=\"ipa-ca.$DOMAIN.\"\n+ipa dnsrecord-add $DOMAIN kerberos --cname-rec=\"ipa-ca.$DOMAIN.\"\n+ipa dnsrecord-add $DOMAIN ldap --cname-rec=\"ipa-ca.$DOMAIN.\"\n+ipa dnsrecord-add $DOMAIN freeipa --cname-rec=\"ipa-ca.$DOMAIN.\"\n+ipa dnsrecord-add $DOMAIN ipa --cname-rec=\"ipa-ca.$DOMAIN.\"\n+kdestroy", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "14a2d81143d447282f29e8ea3196baa69ce99363"}, "originalPosition": 11}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "14a2d81143d447282f29e8ea3196baa69ce99363", "author": {"user": {"login": "jamisonbennett", "name": "Jamison Bennett"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/14a2d81143d447282f29e8ea3196baa69ce99363", "committedDate": "2020-03-16T16:14:22Z", "message": "CB-5904: Use CA DNS name for Kerberos and LDAP\n\nThe kerberos configuration and ldap configuration will use a DNS load\nbalanced entry. This will allow a failed client to reconnect to a\ndifferent server.\n\nSome of the unit tests were updated and it was manually tested with an\nLDAP client. The LDAP client tries the first DNS entry and on failure,\nit can retry. FreeIPA returns the entries in a random order, so it\nwill eventually try a working node. Java can be configured to cache\ngood and bad nodes."}, "afterCommit": {"oid": "434c4ef67b8e73a7dedc2db4a162cb3838ebb362", "author": {"user": {"login": "jamisonbennett", "name": "Jamison Bennett"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/434c4ef67b8e73a7dedc2db4a162cb3838ebb362", "committedDate": "2020-03-17T03:56:34Z", "message": "CB-5904: Use CA DNS name for Kerberos and LDAP\n\nThe kerberos configuration and ldap configuration will use a DNS load\nbalanced entry. This will allow a failed client to reconnect to a\ndifferent server.\n\nSome of the unit tests were updated and it was manually tested with an\nLDAP client. The LDAP client tries the first DNS entry and on failure,\nit can retry. FreeIPA returns the entries in a random order, so it\nwill eventually try a working node. Java can be configured to cache\ngood and bad nodes."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1ODA3NTYy", "url": "https://github.com/hortonworks/cloudbreak/pull/7598#pullrequestreview-375807562", "createdAt": "2020-03-17T08:01:25Z", "commit": {"oid": "434c4ef67b8e73a7dedc2db4a162cb3838ebb362"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QwODowMToyNVrOF3RR9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QwODowNjo0MFrOF3Ra2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQ5OTEyNw==", "bodyText": "please remove these too", "url": "https://github.com/hortonworks/cloudbreak/pull/7598#discussion_r393499127", "createdAt": "2020-03-17T08:01:25Z", "author": {"login": "lacikaaa"}, "path": "freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/stack/doc/FreeIpaModelDescriptions.java", "diffHunk": "@@ -89,5 +89,9 @@ private FreeIpaModelDescriptions() {\n         public static final String HOSTNAME = \"Base hostname for FreeIPA servers\";\n         public static final String ADMIN_GROUP_NAME = \"Name of the admin group to be used for all the services.\";\n         public static final String TAGS = \"Tags on freeipa.\";\n+        public static final String FREEIPA_HOST = \"A DNS load balanced FQDN to the FreeIPA servers\";\n+        public static final String FREEIPA_PORT = \"The port for the load balanced FQDN to the FreeIPA servers\";\n+        public static final String IPA_HOST = \"A DNS load balanced FQDN to the FreeIPA servers\";\n+        public static final String IPA_PORT = \"The port for the load balanced FQDN to the FreeIPA servers\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "434c4ef67b8e73a7dedc2db4a162cb3838ebb362"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzUwMDMwOQ==", "bodyText": "why error? asdj?", "url": "https://github.com/hortonworks/cloudbreak/pull/7598#discussion_r393500309", "createdAt": "2020-03-17T08:04:02Z", "author": {"login": "lacikaaa"}, "path": "freeipa-client/src/main/java/com/sequenceiq/freeipa/client/FreeIpaClient.java", "diffHunk": "@@ -468,6 +468,20 @@ public DnsZone addReverseDnsZone(String cidr) throws FreeIpaClientException {\n         return (DnsZone) invoke(\"dnszone_add\", flags, params, DnsZone.class).getResult();\n     }\n \n+    public DnsRecord getDnsRecord(String dnsZoneName, String recordName) throws FreeIpaClientException {\n+        List<String> flags = List.of(dnsZoneName, recordName);\n+        Map<String, Object> params = Map.of();\n+        return (DnsRecord) invoke(\"dnsrecord_show\", flags, params, DnsRecord.class).getResult();\n+    }\n+\n+    public DnsRecord addDnsCnameRecord(String dnsZoneName, String recordName, String cnameRecord) throws FreeIpaClientException {\n+        LOGGER.error(\"ASDJ CNAME \" + dnsZoneName + \" -- \" + recordName + \"  -- \" + cnameRecord + \" -- \");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "434c4ef67b8e73a7dedc2db4a162cb3838ebb362"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzUwMTQwMg==", "bodyText": "could you move these to a separate class?", "url": "https://github.com/hortonworks/cloudbreak/pull/7598#discussion_r393501402", "createdAt": "2020-03-17T08:06:40Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/flow/FreeIpaPostInstallService.java", "diffHunk": "@@ -95,4 +104,35 @@ private void modifyAdminPasswordExpirationIfNeeded(FreeIpaClient client) throws\n             LOGGER.debug(\"Password expiration is already set.\");\n         }\n     }\n+\n+    private void addDnsLoadBalancedEntries(FreeIpaClient client, FreeIpa freeIpa) throws FreeIpaClientException {\n+\n+        String domain = freeIpa.getDomain();\n+        String loadBalancedName = FreeIpaDomainUtils.getBuiltInFreeIpaDnsLoadBalancedName(domain);\n+        Set<String> cnames = Set.of(\n+                FreeIpaDomainUtils.getKdcHost(),\n+                FreeIpaDomainUtils.getKerberosHost(),\n+                FreeIpaDomainUtils.getLdapHost(),\n+                FreeIpaDomainUtils.getFreeIpaHost());\n+\n+        for (String cname : cnames) {\n+            if (!hasDnsRecord(client, domain, cname)) {\n+                client.addDnsCnameRecord(domain, cname, loadBalancedName);\n+            } else {\n+                LOGGER.debug(\"Skipping adding DNS cname for {} because it already exists\", cname);\n+            }\n+        }\n+    }\n+\n+    private boolean hasDnsRecord(FreeIpaClient client, String domain, String cname) throws FreeIpaClientException {\n+        try {\n+            client.getDnsRecord(domain, cname);\n+            return true;\n+        } catch (FreeIpaClientException e) {\n+            if (FreeIpaClientExceptionUtil.isNotFoundException(e)) {\n+                return false;\n+            }\n+            throw e;\n+        }\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "434c4ef67b8e73a7dedc2db4a162cb3838ebb362"}, "originalPosition": 72}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "434c4ef67b8e73a7dedc2db4a162cb3838ebb362", "author": {"user": {"login": "jamisonbennett", "name": "Jamison Bennett"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/434c4ef67b8e73a7dedc2db4a162cb3838ebb362", "committedDate": "2020-03-17T03:56:34Z", "message": "CB-5904: Use CA DNS name for Kerberos and LDAP\n\nThe kerberos configuration and ldap configuration will use a DNS load\nbalanced entry. This will allow a failed client to reconnect to a\ndifferent server.\n\nSome of the unit tests were updated and it was manually tested with an\nLDAP client. The LDAP client tries the first DNS entry and on failure,\nit can retry. FreeIPA returns the entries in a random order, so it\nwill eventually try a working node. Java can be configured to cache\ngood and bad nodes."}, "afterCommit": {"oid": "8365f247770a54055ad815a9ceee8eda9a3228fc", "author": {"user": {"login": "jamisonbennett", "name": "Jamison Bennett"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/8365f247770a54055ad815a9ceee8eda9a3228fc", "committedDate": "2020-03-17T14:05:47Z", "message": "CB-5904: Use CA DNS name for Kerberos and LDAP\n\nThe kerberos configuration and ldap configuration will use a DNS load\nbalanced entry. This will allow a failed client to reconnect to a\ndifferent server.\n\nSome of the unit tests were updated and it was manually tested with an\nLDAP client. The LDAP client tries the first DNS entry and on failure,\nit can retry. FreeIPA returns the entries in a random order, so it\nwill eventually try a working node. Java can be configured to cache\ngood and bad nodes."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2NjkyMzE4", "url": "https://github.com/hortonworks/cloudbreak/pull/7598#pullrequestreview-376692318", "createdAt": "2020-03-18T09:30:48Z", "commit": {"oid": "8365f247770a54055ad815a9ceee8eda9a3228fc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8365f247770a54055ad815a9ceee8eda9a3228fc", "author": {"user": {"login": "jamisonbennett", "name": "Jamison Bennett"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/8365f247770a54055ad815a9ceee8eda9a3228fc", "committedDate": "2020-03-17T14:05:47Z", "message": "CB-5904: Use CA DNS name for Kerberos and LDAP\n\nThe kerberos configuration and ldap configuration will use a DNS load\nbalanced entry. This will allow a failed client to reconnect to a\ndifferent server.\n\nSome of the unit tests were updated and it was manually tested with an\nLDAP client. The LDAP client tries the first DNS entry and on failure,\nit can retry. FreeIPA returns the entries in a random order, so it\nwill eventually try a working node. Java can be configured to cache\ngood and bad nodes."}, "afterCommit": {"oid": "7a722caaaeec47c6a7800e690617223b70395179", "author": {"user": {"login": "jamisonbennett", "name": "Jamison Bennett"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/7a722caaaeec47c6a7800e690617223b70395179", "committedDate": "2020-03-19T13:18:21Z", "message": "CB-5904: Use CA DNS name for Kerberos and LDAP\n\nThe kerberos configuration and ldap configuration will use a DNS load\nbalanced entry. This will allow a failed client to reconnect to a\ndifferent server.\n\nSome of the unit tests were updated and it was manually tested with an\nLDAP client. The LDAP client tries the first DNS entry and on failure,\nit can retry. FreeIPA returns the entries in a random order, so it\nwill eventually try a working node. Java can be configured to cache\ngood and bad nodes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6610c4bb5862e6952e94f3a62e2108b98a80673", "author": {"user": {"login": "jamisonbennett", "name": "Jamison Bennett"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/c6610c4bb5862e6952e94f3a62e2108b98a80673", "committedDate": "2020-03-19T18:14:51Z", "message": "CB-5904: Use CA DNS name for Kerberos and LDAP\n\nThe kerberos configuration and ldap configuration will use a DNS load\nbalanced entry. This will allow a failed client to reconnect to a\ndifferent server.\n\nSome of the unit tests were updated and it was manually tested with an\nLDAP client. The LDAP client tries the first DNS entry and on failure,\nit can retry. FreeIPA returns the entries in a random order, so it\nwill eventually try a working node. Java can be configured to cache\ngood and bad nodes."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7a722caaaeec47c6a7800e690617223b70395179", "author": {"user": {"login": "jamisonbennett", "name": "Jamison Bennett"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/7a722caaaeec47c6a7800e690617223b70395179", "committedDate": "2020-03-19T13:18:21Z", "message": "CB-5904: Use CA DNS name for Kerberos and LDAP\n\nThe kerberos configuration and ldap configuration will use a DNS load\nbalanced entry. This will allow a failed client to reconnect to a\ndifferent server.\n\nSome of the unit tests were updated and it was manually tested with an\nLDAP client. The LDAP client tries the first DNS entry and on failure,\nit can retry. FreeIPA returns the entries in a random order, so it\nwill eventually try a working node. Java can be configured to cache\ngood and bad nodes."}, "afterCommit": {"oid": "c6610c4bb5862e6952e94f3a62e2108b98a80673", "author": {"user": {"login": "jamisonbennett", "name": "Jamison Bennett"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/c6610c4bb5862e6952e94f3a62e2108b98a80673", "committedDate": "2020-03-19T18:14:51Z", "message": "CB-5904: Use CA DNS name for Kerberos and LDAP\n\nThe kerberos configuration and ldap configuration will use a DNS load\nbalanced entry. This will allow a failed client to reconnect to a\ndifferent server.\n\nSome of the unit tests were updated and it was manually tested with an\nLDAP client. The LDAP client tries the first DNS entry and on failure,\nit can retry. FreeIPA returns the entries in a random order, so it\nwill eventually try a working node. Java can be configured to cache\ngood and bad nodes."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2470, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}