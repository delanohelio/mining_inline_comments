{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg0NDAxMDc5", "number": 7480, "title": "CB-5913 flow fixes", "bodyText": "", "createdAt": "2020-03-05T17:15:14Z", "url": "https://github.com/hortonworks/cloudbreak/pull/7480", "merged": true, "mergeCommit": {"oid": "f1e84f1c6cbb7f5189cad58c265770bff75e8fb0"}, "closed": true, "closedAt": "2020-03-10T17:45:57Z", "author": {"login": "sodre90"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKu8uQgBqjMxMDIxNzk5MjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMQhSmgFqTM3MTg1OTE3MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "04fb7e31e75c273f20cb0746cc2e903e0c7ec209", "author": {"user": {"login": "sodre90", "name": "Erd\u0151s P\u00e9ter"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/04fb7e31e75c273f20cb0746cc2e903e0c7ec209", "committedDate": "2020-03-05T17:12:54Z", "message": "CB-5913 flow fixes"}, "afterCommit": {"oid": "3a3f61996a3911de6770339d5e3112600acb62df", "author": {"user": {"login": "sodre90", "name": "Erd\u0151s P\u00e9ter"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/3a3f61996a3911de6770339d5e3112600acb62df", "committedDate": "2020-03-05T17:26:54Z", "message": "CB-5914 Flow cancel does not work when exception comes from handler"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3a3f61996a3911de6770339d5e3112600acb62df", "author": {"user": {"login": "sodre90", "name": "Erd\u0151s P\u00e9ter"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/3a3f61996a3911de6770339d5e3112600acb62df", "committedDate": "2020-03-05T17:26:54Z", "message": "CB-5914 Flow cancel does not work when exception comes from handler"}, "afterCommit": {"oid": "841284b807bb802c293c6ec87ce30e58496861bb", "author": {"user": {"login": "sodre90", "name": "Erd\u0151s P\u00e9ter"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/841284b807bb802c293c6ec87ce30e58496861bb", "committedDate": "2020-03-05T18:45:09Z", "message": "CB-5914 Flow cancel does not work when exception comes from handler"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a8f6dfb30f6838f8c07d44314cc7220f34a5cbc", "author": {"user": {"login": "sodre90", "name": "Erd\u0151s P\u00e9ter"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/2a8f6dfb30f6838f8c07d44314cc7220f34a5cbc", "committedDate": "2020-03-06T08:28:07Z", "message": "CB-5914 Flow cancel does not work when exception comes from handler"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db6ed8c8c1b51d059a9bcba6456974380a2d9a15", "author": {"user": {"login": "sodre90", "name": "Erd\u0151s P\u00e9ter"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/db6ed8c8c1b51d059a9bcba6456974380a2d9a15", "committedDate": "2020-03-06T09:54:54Z", "message": "CB-5913 flow fixes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "841284b807bb802c293c6ec87ce30e58496861bb", "author": {"user": {"login": "sodre90", "name": "Erd\u0151s P\u00e9ter"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/841284b807bb802c293c6ec87ce30e58496861bb", "committedDate": "2020-03-05T18:45:09Z", "message": "CB-5914 Flow cancel does not work when exception comes from handler"}, "afterCommit": {"oid": "db6ed8c8c1b51d059a9bcba6456974380a2d9a15", "author": {"user": {"login": "sodre90", "name": "Erd\u0151s P\u00e9ter"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/db6ed8c8c1b51d059a9bcba6456974380a2d9a15", "committedDate": "2020-03-06T09:54:54Z", "message": "CB-5913 flow fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxODU0NTMy", "url": "https://github.com/hortonworks/cloudbreak/pull/7480#pullrequestreview-371854532", "createdAt": "2020-03-10T11:00:24Z", "commit": {"oid": "db6ed8c8c1b51d059a9bcba6456974380a2d9a15"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxMTowMDoyNFrOF0KLFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxMTowMDoyNFrOF0KLFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIzNjk1MA==", "bodyText": "What's wrong with StateStatus? Why introduce a new Enum?", "url": "https://github.com/hortonworks/cloudbreak/pull/7480#discussion_r390236950", "createdAt": "2020-03-10T11:00:24Z", "author": {"login": "lnardai"}, "path": "datalake/src/main/java/com/sequenceiq/datalake/service/sdx/CloudbreakFlowService.java", "diffHunk": "@@ -35,18 +35,30 @@ public void getAndSaveLastCloudbreakFlowChainId(SdxCluster sdxCluster) {\n         sdxClusterRepository.save(sdxCluster);\n     }\n \n-    public boolean isLastKnownFlowRunning(SdxCluster sdxCluster) {\n+    public FlowState getLastKnownFlowState(SdxCluster sdxCluster) {\n         try {\n             String actualCbFlowChainId = sdxCluster.getLastCbFlowChainId();\n             if (actualCbFlowChainId != null) {\n-                return flowEndpoint.hasFlowRunningByChainId(sdxCluster.getLastCbFlowChainId()).getHasActiveFlow();\n+                LOGGER.info(\"Check if flow is running: {}\", actualCbFlowChainId);\n+                Boolean hasActiveFlow = flowEndpoint.hasFlowRunningByChainId(sdxCluster.getLastCbFlowChainId()).getHasActiveFlow();\n+                if (hasActiveFlow) {\n+                    return FlowState.RUNNING;\n+                } else {\n+                    return FlowState.FINISHED;\n+                }\n+            } else  {\n+                return FlowState.UNKNOWN;\n             }\n         } catch (NotFoundException e) {\n             LOGGER.error(\"Flow chain id or resource {} not found in CB: {}, so there is no active flow!\", sdxCluster.getClusterName(), e.getMessage());\n+            return FlowState.UNKNOWN;\n         } catch (Exception e) {\n             LOGGER.error(\"Exception occured during checking if there is a flow for cluster {} in CB: {}\", sdxCluster.getClusterName(), e.getMessage());\n-            return true;\n+            return FlowState.UNKNOWN;\n         }\n-        return false;\n+    }\n+\n+    public enum FlowState {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db6ed8c8c1b51d059a9bcba6456974380a2d9a15"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxODU5MTcx", "url": "https://github.com/hortonworks/cloudbreak/pull/7480#pullrequestreview-371859171", "createdAt": "2020-03-10T11:08:01Z", "commit": {"oid": "db6ed8c8c1b51d059a9bcba6456974380a2d9a15"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2527, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}