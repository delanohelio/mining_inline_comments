{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI0MzIwNTM2", "number": 9483, "title": "CB-7210: Ensure that RAZ role is included when RAZ is requested, and isn't when it is not.", "bodyText": "Jira: https://jira.cloudera.com/browse/CB-7210\nSpecifically this should make it so that RAZ datalakes cannot be created if they don't include the rangerraz IDBMMS role. Similarly, if they do include the role and are note trying to create a RAZ datalake, should return an error.\nNote that while we definitely want the first of these changes, we are not sure if the second is ideal. I hope these changes facilitate a discussion on this.\nI also included some quick tests that kind of test this, please let me know if I need to expand on them in any way.", "createdAt": "2020-11-20T00:02:15Z", "url": "https://github.com/hortonworks/cloudbreak/pull/9483", "merged": true, "mergeCommit": {"oid": "8518122826eeb3b0a5447b95cd4c65c194000c78"}, "closed": true, "closedAt": "2020-12-02T16:29:15Z", "author": {"login": "sxxgrc"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdeMGflgBqjQwMTg1MDE3ODE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdiRJODgFqTU0MzAxNTU2Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5cda02b420e62a071509545b1fa6eeb1ca2afca2", "author": {"user": {"login": "sxxgrc", "name": "Santiago Garcia Acosta"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/5cda02b420e62a071509545b1fa6eeb1ca2afca2", "committedDate": "2020-11-19T23:59:29Z", "message": "CB-7210: Ensure that RAZ role is included when RAZ is requested, and isn't when it is not."}, "afterCommit": {"oid": "75fa182b419056a7ead3893de2811ab2793b1744", "author": {"user": {"login": "sxxgrc", "name": "Santiago Garcia Acosta"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/75fa182b419056a7ead3893de2811ab2793b1744", "committedDate": "2020-11-20T00:20:34Z", "message": "CB-7210: Ensure that RAZ role is included when RAZ is requested, and isn't when it is not."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1MzQ0MjAw", "url": "https://github.com/hortonworks/cloudbreak/pull/9483#pullrequestreview-535344200", "createdAt": "2020-11-20T11:23:12Z", "commit": {"oid": "75fa182b419056a7ead3893de2811ab2793b1744"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMToyMzoxMlrOH3LyLA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMToyMzoxMlrOH3LyLA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYyNjc5Ng==", "bodyText": "Minor: I would rather directly throw BadRequestException since the latter more appropriately expresses that the problem is due to a conflict of cluster settings vs IDBroker mappings. IdbmmsOperationException is supposed to  denote problems specific to IDBMMS, e.g. due to missing mappings, communication error or some other internal service error.", "url": "https://github.com/hortonworks/cloudbreak/pull/9483#discussion_r527626796", "createdAt": "2020-11-20T11:23:12Z", "author": {"login": "lajosrodek"}, "path": "datalake/src/main/java/com/sequenceiq/datalake/service/sdx/StackRequestManifester.java", "diffHunk": "@@ -269,6 +270,27 @@ void setupCloudStorageAccountMapping(StackV4Request stackRequest, String environ\n         }\n     }\n \n+    void validateMappingsConfig(MappingsConfig mappingsConfig, StackV4Request stackRequest) {\n+        String errorMessage = null;\n+\n+        // Validate RAZ if enabled, making sure that the RAZ mapping exists only when it is required.\n+        if (stackRequest.getCluster().isRangerRazEnabled()) {\n+            if (!mappingsConfig.getActorMappings().containsKey(\"rangerraz\")) {\n+                errorMessage = \"IDBMMS mappings must contain the RAZ role if RAZ is to be created!\";\n+            }\n+        } else {\n+            if (mappingsConfig.getActorMappings().containsKey(\"rangerraz\")) {\n+                errorMessage = \"IDBMMS mappings cannot contain the RAZ role if RAZ is not enabled for the cluster!\";\n+            }\n+        }\n+\n+        // Throw error if validation failed.\n+        if (errorMessage != null) {\n+            LOGGER.error(errorMessage);\n+            throw new IdbmmsOperationException(errorMessage);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "75fa182b419056a7ead3893de2811ab2793b1744"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1MzQ2MzA5", "url": "https://github.com/hortonworks/cloudbreak/pull/9483#pullrequestreview-535346309", "createdAt": "2020-11-20T11:26:21Z", "commit": {"oid": "75fa182b419056a7ead3893de2811ab2793b1744"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMToyNjoyMVrOH3L4yQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMToyNjoyMVrOH3L4yQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYyODQ4OQ==", "bodyText": "I see the general intent of this check, but IDBMMS always includes mappings for other service principals even if they will never be used by any clusters. So I see no real benefit of prohibiting this mapping rule if no RAZ is to be installed. (No other users are supposed to be able to ever impersonate themselves as rangerraz.)", "url": "https://github.com/hortonworks/cloudbreak/pull/9483#discussion_r527628489", "createdAt": "2020-11-20T11:26:21Z", "author": {"login": "lajosrodek"}, "path": "datalake/src/main/java/com/sequenceiq/datalake/service/sdx/StackRequestManifester.java", "diffHunk": "@@ -269,6 +270,27 @@ void setupCloudStorageAccountMapping(StackV4Request stackRequest, String environ\n         }\n     }\n \n+    void validateMappingsConfig(MappingsConfig mappingsConfig, StackV4Request stackRequest) {\n+        String errorMessage = null;\n+\n+        // Validate RAZ if enabled, making sure that the RAZ mapping exists only when it is required.\n+        if (stackRequest.getCluster().isRangerRazEnabled()) {\n+            if (!mappingsConfig.getActorMappings().containsKey(\"rangerraz\")) {\n+                errorMessage = \"IDBMMS mappings must contain the RAZ role if RAZ is to be created!\";\n+            }\n+        } else {\n+            if (mappingsConfig.getActorMappings().containsKey(\"rangerraz\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "75fa182b419056a7ead3893de2811ab2793b1744"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1NTUwNDUz", "url": "https://github.com/hortonworks/cloudbreak/pull/9483#pullrequestreview-535550453", "createdAt": "2020-11-20T15:54:43Z", "commit": {"oid": "75fa182b419056a7ead3893de2811ab2793b1744"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxNTo1NDo0M1rOH3Vflw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxNjowNToxN1rOH3V6dQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzc4NTg3OQ==", "bodyText": "Split this into 3 tests.  Unit tests in general should only test 1 thing.    once an exception has been thrown, the unit test is considered to be dirty.  So in some cases if you try to test something immediately after, it may or may not be in a good state so the assert isn't valid.  So you could get false positives/negatives after.", "url": "https://github.com/hortonworks/cloudbreak/pull/9483#discussion_r527785879", "createdAt": "2020-11-20T15:54:43Z", "author": {"login": "frozenwizard"}, "path": "datalake/src/test/java/com/sequenceiq/datalake/service/sdx/StackRequestManifesterTest.java", "diffHunk": "@@ -216,6 +216,36 @@ public void testSetupCloudStorageAccountMappingWhenCloudStorageWithNoAccountMapp\n         assertThat(clusterV4Request.getCloudStorage().getAccountMapping()).isNull();\n     }\n \n+    @Test\n+    void testSetupCloudStorageAccountMappingsWithRAZ() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "75fa182b419056a7ead3893de2811ab2793b1744"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzc5Mjc1Nw==", "bodyText": "Badrequest does sound better.", "url": "https://github.com/hortonworks/cloudbreak/pull/9483#discussion_r527792757", "createdAt": "2020-11-20T16:05:17Z", "author": {"login": "frozenwizard"}, "path": "datalake/src/main/java/com/sequenceiq/datalake/service/sdx/StackRequestManifester.java", "diffHunk": "@@ -269,6 +270,27 @@ void setupCloudStorageAccountMapping(StackV4Request stackRequest, String environ\n         }\n     }\n \n+    void validateMappingsConfig(MappingsConfig mappingsConfig, StackV4Request stackRequest) {\n+        String errorMessage = null;\n+\n+        // Validate RAZ if enabled, making sure that the RAZ mapping exists only when it is required.\n+        if (stackRequest.getCluster().isRangerRazEnabled()) {\n+            if (!mappingsConfig.getActorMappings().containsKey(\"rangerraz\")) {\n+                errorMessage = \"IDBMMS mappings must contain the RAZ role if RAZ is to be created!\";\n+            }\n+        } else {\n+            if (mappingsConfig.getActorMappings().containsKey(\"rangerraz\")) {\n+                errorMessage = \"IDBMMS mappings cannot contain the RAZ role if RAZ is not enabled for the cluster!\";\n+            }\n+        }\n+\n+        // Throw error if validation failed.\n+        if (errorMessage != null) {\n+            LOGGER.error(errorMessage);\n+            throw new IdbmmsOperationException(errorMessage);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYyNjc5Ng=="}, "originalCommit": {"oid": "75fa182b419056a7ead3893de2811ab2793b1744"}, "originalPosition": 29}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "75fa182b419056a7ead3893de2811ab2793b1744", "author": {"user": {"login": "sxxgrc", "name": "Santiago Garcia Acosta"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/75fa182b419056a7ead3893de2811ab2793b1744", "committedDate": "2020-11-20T00:20:34Z", "message": "CB-7210: Ensure that RAZ role is included when RAZ is requested, and isn't when it is not."}, "afterCommit": {"oid": "eeae6b763bb2056ed575b3b7e72093628af8d15b", "author": {"user": {"login": "sxxgrc", "name": "Santiago Garcia Acosta"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/eeae6b763bb2056ed575b3b7e72093628af8d15b", "committedDate": "2020-11-20T19:00:08Z", "message": "CB-7210: Ensure that RAZ role is included when RAZ is requested, and isn't when it is not."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eeae6b763bb2056ed575b3b7e72093628af8d15b", "author": {"user": {"login": "sxxgrc", "name": "Santiago Garcia Acosta"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/eeae6b763bb2056ed575b3b7e72093628af8d15b", "committedDate": "2020-11-20T19:00:08Z", "message": "CB-7210: Ensure that RAZ role is included when RAZ is requested, and isn't when it is not."}, "afterCommit": {"oid": "98440262bf580298402e8e4feebe25132fc5c1b0", "author": {"user": {"login": "sxxgrc", "name": "Santiago Garcia Acosta"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/98440262bf580298402e8e4feebe25132fc5c1b0", "committedDate": "2020-11-20T19:01:41Z", "message": "CB-7210: Ensure that RAZ role is included when RAZ is requested, and isn't when it is not."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3MzM4Nzgy", "url": "https://github.com/hortonworks/cloudbreak/pull/9483#pullrequestreview-537338782", "createdAt": "2020-11-24T10:15:14Z", "commit": {"oid": "98440262bf580298402e8e4feebe25132fc5c1b0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyMzIzNTY3", "url": "https://github.com/hortonworks/cloudbreak/pull/9483#pullrequestreview-542323567", "createdAt": "2020-12-01T21:47:42Z", "commit": {"oid": "98440262bf580298402e8e4feebe25132fc5c1b0"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQyMTo0Nzo0M1rOH9BEmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQyMTo0Nzo0M1rOH9BEmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzc0Mjc0NQ==", "bodyText": "Just throw the exception here.  Remove the errorMessage variable.", "url": "https://github.com/hortonworks/cloudbreak/pull/9483#discussion_r533742745", "createdAt": "2020-12-01T21:47:43Z", "author": {"login": "frozenwizard"}, "path": "datalake/src/main/java/com/sequenceiq/datalake/service/sdx/StackRequestManifester.java", "diffHunk": "@@ -269,6 +270,23 @@ void setupCloudStorageAccountMapping(StackV4Request stackRequest, String environ\n         }\n     }\n \n+    void validateMappingsConfig(MappingsConfig mappingsConfig, StackV4Request stackRequest) {\n+        String errorMessage = null;\n+\n+        // Validate RAZ if enabled, making sure that the RAZ mapping exists when it is required.\n+        if (stackRequest.getCluster().isRangerRazEnabled()) {\n+            if (!mappingsConfig.getActorMappings().containsKey(\"rangerraz\")) {\n+                errorMessage = \"IDBMMS mappings must contain the RAZ role if RAZ is to be created!\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98440262bf580298402e8e4feebe25132fc5c1b0"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2fd2b0d2a7cf3f18b00bb47860ce5e840ff5768b", "author": {"user": {"login": "sxxgrc", "name": "Santiago Garcia Acosta"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/2fd2b0d2a7cf3f18b00bb47860ce5e840ff5768b", "committedDate": "2020-12-01T23:45:29Z", "message": "CB-7210: Ensure that RAZ role is included when RAZ is requested, and isn't when it is not."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "98440262bf580298402e8e4feebe25132fc5c1b0", "author": {"user": {"login": "sxxgrc", "name": "Santiago Garcia Acosta"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/98440262bf580298402e8e4feebe25132fc5c1b0", "committedDate": "2020-11-20T19:01:41Z", "message": "CB-7210: Ensure that RAZ role is included when RAZ is requested, and isn't when it is not."}, "afterCommit": {"oid": "2fd2b0d2a7cf3f18b00bb47860ce5e840ff5768b", "author": {"user": {"login": "sxxgrc", "name": "Santiago Garcia Acosta"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/2fd2b0d2a7cf3f18b00bb47860ce5e840ff5768b", "committedDate": "2020-12-01T23:45:29Z", "message": "CB-7210: Ensure that RAZ role is included when RAZ is requested, and isn't when it is not."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMDE1NTY2", "url": "https://github.com/hortonworks/cloudbreak/pull/9483#pullrequestreview-543015566", "createdAt": "2020-12-02T16:29:08Z", "commit": {"oid": "2fd2b0d2a7cf3f18b00bb47860ce5e840ff5768b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2024, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}