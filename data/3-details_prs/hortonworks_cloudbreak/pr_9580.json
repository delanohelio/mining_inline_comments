{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMyNzUwODgx", "number": 9580, "title": "CB-10162 Add log message every time the FreeIPA status is checked", "bodyText": "During ENGESC-5655, we had a hard time debugging the freeipa status. Currently we only log freeipa status when there is a transition (eg. from healthy to unreachable) and it was determined that adding a log message for both freeipa status and instance status during health check would be helpful. Now we added logging for every health check.\nSee detailed description in the commit message.", "createdAt": "2020-12-04T19:50:17Z", "url": "https://github.com/hortonworks/cloudbreak/pull/9580", "merged": true, "mergeCommit": {"oid": "0a082ef4e4cc251b25deeab4b37bba4e913f5d38"}, "closed": true, "closedAt": "2020-12-09T18:33:42Z", "author": {"login": "christmasferret"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdi9P8WgBqjQwNzQyMzIwNjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdkgQAKgBqjQwOTA0NDM5NDM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "33b40dde54edb16ad797c426b2e376183118f5e2", "author": {"user": {"login": "christmasferret", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/33b40dde54edb16ad797c426b2e376183118f5e2", "committedDate": "2020-12-04T19:48:58Z", "message": "CB-10162 Add log message every time the FreeIPA status is checked\n\nDuring ENGESC-5655, we had a hard time debugging the freeipa status. Currently we only log freeipa status when there is a transition (eg. from healthy to unreachable) and it was determined that adding a log message for both freeipa status and instance status during health check would be helpful. Now we added logging for every health check."}, "afterCommit": {"oid": "5ab6486ddff1b6c0f70c6b1cc06b9800e6320253", "author": {"user": {"login": "christmasferret", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/5ab6486ddff1b6c0f70c6b1cc06b9800e6320253", "committedDate": "2020-12-04T19:51:53Z", "message": "CB-10162 Add log message every time the FreeIPA status is checked\n\nDuring ENGESC-5655, we had a hard time debugging the freeipa status. Currently we only log freeipa status when there is a transition (eg. from healthy to unreachable) and it was determined that adding a log message for both freeipa status and instance status during health check would be helpful. Now we added logging for every health check."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1MjY5MTQy", "url": "https://github.com/hortonworks/cloudbreak/pull/9580#pullrequestreview-545269142", "createdAt": "2020-12-04T20:19:14Z", "commit": {"oid": "5ab6486ddff1b6c0f70c6b1cc06b9800e6320253"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQyMDoxOToxNFrOH_gnmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQyMDoyMDoxMVrOH_gpdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM1Njc2MA==", "bodyText": "I think the old way of looping outside of the updateInstanceStatus() was cleaner.", "url": "https://github.com/hortonworks/cloudbreak/pull/9580#discussion_r536356760", "createdAt": "2020-12-04T20:19:14Z", "author": {"login": "jamisonbennett"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/sync/StackStatusCheckerJob.java", "diffHunk": "@@ -105,23 +105,28 @@ public void syncAStack(Stack stack) {\n                     if (!checkableInstances.isEmpty()) {\n                         SyncResult syncResult = freeipaChecker.getStatus(stack, checkableInstances);\n                         if (DetailedStackStatus.AVAILABLE == syncResult.getStatus()) {\n-                            for (Map.Entry<InstanceMetaData, DetailedStackStatus> entry : syncResult.getInstanceStatusMap().entrySet()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ab6486ddff1b6c0f70c6b1cc06b9800e6320253"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM1NzIzNg==", "bodyText": "I am not sure what log level we should have for this. If debug output is enabled in prod, then it probably should be debug level.", "url": "https://github.com/hortonworks/cloudbreak/pull/9580#discussion_r536357236", "createdAt": "2020-12-04T20:20:11Z", "author": {"login": "jamisonbennett"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/sync/StackStatusCheckerJob.java", "diffHunk": "@@ -105,23 +105,28 @@ public void syncAStack(Stack stack) {\n                     if (!checkableInstances.isEmpty()) {\n                         SyncResult syncResult = freeipaChecker.getStatus(stack, checkableInstances);\n                         if (DetailedStackStatus.AVAILABLE == syncResult.getStatus()) {\n-                            for (Map.Entry<InstanceMetaData, DetailedStackStatus> entry : syncResult.getInstanceStatusMap().entrySet()) {\n-                                updateInstanceStatus(entry.getKey(), entry.getValue());\n-                            }\n-                            updateStackStatus(stack, syncResult, null, alreadyDeletedCount);\n+                            String instanceStatusInfo = updateInstanceStatus(syncResult.getInstanceStatusMap());\n+                            String freeipaStatusInfo = updateStackStatus(stack, syncResult, null, alreadyDeletedCount);\n+                            LOGGER.info(\":::Auto sync::: freeipa status from healtch check: \" + freeipaStatusInfo + instanceStatusInfo);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ab6486ddff1b6c0f70c6b1cc06b9800e6320253"}, "originalPosition": 10}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5ab6486ddff1b6c0f70c6b1cc06b9800e6320253", "author": {"user": {"login": "christmasferret", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/5ab6486ddff1b6c0f70c6b1cc06b9800e6320253", "committedDate": "2020-12-04T19:51:53Z", "message": "CB-10162 Add log message every time the FreeIPA status is checked\n\nDuring ENGESC-5655, we had a hard time debugging the freeipa status. Currently we only log freeipa status when there is a transition (eg. from healthy to unreachable) and it was determined that adding a log message for both freeipa status and instance status during health check would be helpful. Now we added logging for every health check."}, "afterCommit": {"oid": "8cebc6ff05311b08c4804cc165acc2b094e4cfc0", "author": {"user": {"login": "christmasferret", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/8cebc6ff05311b08c4804cc165acc2b094e4cfc0", "committedDate": "2020-12-04T21:49:50Z", "message": "CB-10162 Add log message every time the FreeIPA status is checked\n\nDuring ENGESC-5655, we had a hard time debugging the freeipa status. Currently we only log freeipa status when there is a transition (eg. from healthy to unreachable) and it was determined that adding a log message for both freeipa status and instance status during health check would be helpful. Now we added logging for every health check."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1NTk3NDY2", "url": "https://github.com/hortonworks/cloudbreak/pull/9580#pullrequestreview-545597466", "createdAt": "2020-12-05T16:02:44Z", "commit": {"oid": "8cebc6ff05311b08c4804cc165acc2b094e4cfc0"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNVQxNjowMjo0NVrOH_8iag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNVQxNjowMzozMlrOH_8izA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjgxNDE4Ng==", "bodyText": ".toString() is not necessary", "url": "https://github.com/hortonworks/cloudbreak/pull/9580#discussion_r536814186", "createdAt": "2020-12-05T16:02:45Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/sync/StackStatusCheckerJob.java", "diffHunk": "@@ -105,23 +105,31 @@ public void syncAStack(Stack stack) {\n                     if (!checkableInstances.isEmpty()) {\n                         SyncResult syncResult = freeipaChecker.getStatus(stack, checkableInstances);\n                         if (DetailedStackStatus.AVAILABLE == syncResult.getStatus()) {\n+                            StringBuilder allInstanceStatusInfo = new StringBuilder();\n                             for (Map.Entry<InstanceMetaData, DetailedStackStatus> entry : syncResult.getInstanceStatusMap().entrySet()) {\n-                                updateInstanceStatus(entry.getKey(), entry.getValue());\n+                                allInstanceStatusInfo.append(updateInstanceStatus(entry.getKey(), entry.getValue()));\n                             }\n-                            updateStackStatus(stack, syncResult, null, alreadyDeletedCount);\n+                            String freeipaStatusInfo = updateStackStatus(stack, syncResult, null, alreadyDeletedCount);\n+                            LOGGER.debug(\":::Auto sync::: freeipa status from healtch check: \" + freeipaStatusInfo + allInstanceStatusInfo.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8cebc6ff05311b08c4804cc165acc2b094e4cfc0"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjgxNDI1Mw==", "bodyText": ".toString() is not necessary", "url": "https://github.com/hortonworks/cloudbreak/pull/9580#discussion_r536814253", "createdAt": "2020-12-05T16:03:16Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/sync/StackStatusCheckerJob.java", "diffHunk": "@@ -131,23 +139,28 @@ public void syncAStack(Stack stack) {\n         }\n     }\n \n-    private void updateInstanceStatus(InstanceMetaData instanceMetaData, DetailedStackStatus detailedStackStatus) {\n+    private String updateInstanceStatus(InstanceMetaData instanceMetaData, DetailedStackStatus detailedStackStatus) {\n+        String instanceStatusInfo = \"\";\n         switch (detailedStackStatus) {\n             case AVAILABLE:\n                 setStatusIfNotTheSame(instanceMetaData, InstanceStatus.CREATED);\n+                instanceStatusInfo = String.format(\"instance %s is %s. \", instanceMetaData.getInstanceId(), InstanceStatus.CREATED.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8cebc6ff05311b08c4804cc165acc2b094e4cfc0"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjgxNDI2Mg==", "bodyText": ".toString() is not necessary", "url": "https://github.com/hortonworks/cloudbreak/pull/9580#discussion_r536814262", "createdAt": "2020-12-05T16:03:21Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/sync/StackStatusCheckerJob.java", "diffHunk": "@@ -131,23 +139,28 @@ public void syncAStack(Stack stack) {\n         }\n     }\n \n-    private void updateInstanceStatus(InstanceMetaData instanceMetaData, DetailedStackStatus detailedStackStatus) {\n+    private String updateInstanceStatus(InstanceMetaData instanceMetaData, DetailedStackStatus detailedStackStatus) {\n+        String instanceStatusInfo = \"\";\n         switch (detailedStackStatus) {\n             case AVAILABLE:\n                 setStatusIfNotTheSame(instanceMetaData, InstanceStatus.CREATED);\n+                instanceStatusInfo = String.format(\"instance %s is %s. \", instanceMetaData.getInstanceId(), InstanceStatus.CREATED.toString());\n                 break;\n             case UNHEALTHY:\n                 setStatusIfNotTheSame(instanceMetaData, InstanceStatus.UNHEALTHY);\n+                instanceStatusInfo = String.format(\"instance %s is %s. \", instanceMetaData.getInstanceId(), InstanceStatus.UNHEALTHY.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8cebc6ff05311b08c4804cc165acc2b094e4cfc0"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjgxNDI2Nw==", "bodyText": ".toString() is not necessary", "url": "https://github.com/hortonworks/cloudbreak/pull/9580#discussion_r536814267", "createdAt": "2020-12-05T16:03:25Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/sync/StackStatusCheckerJob.java", "diffHunk": "@@ -131,23 +139,28 @@ public void syncAStack(Stack stack) {\n         }\n     }\n \n-    private void updateInstanceStatus(InstanceMetaData instanceMetaData, DetailedStackStatus detailedStackStatus) {\n+    private String updateInstanceStatus(InstanceMetaData instanceMetaData, DetailedStackStatus detailedStackStatus) {\n+        String instanceStatusInfo = \"\";\n         switch (detailedStackStatus) {\n             case AVAILABLE:\n                 setStatusIfNotTheSame(instanceMetaData, InstanceStatus.CREATED);\n+                instanceStatusInfo = String.format(\"instance %s is %s. \", instanceMetaData.getInstanceId(), InstanceStatus.CREATED.toString());\n                 break;\n             case UNHEALTHY:\n                 setStatusIfNotTheSame(instanceMetaData, InstanceStatus.UNHEALTHY);\n+                instanceStatusInfo = String.format(\"instance %s is %s. \", instanceMetaData.getInstanceId(), InstanceStatus.UNHEALTHY.toString());\n                 break;\n             case UNREACHABLE:\n                 setStatusIfNotTheSame(instanceMetaData, InstanceStatus.UNREACHABLE);\n+                instanceStatusInfo = String.format(\"instance %s is %s. \", instanceMetaData.getInstanceId(), InstanceStatus.UNREACHABLE.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8cebc6ff05311b08c4804cc165acc2b094e4cfc0"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjgxNDI4NA==", "bodyText": ".toString() is not necessary", "url": "https://github.com/hortonworks/cloudbreak/pull/9580#discussion_r536814284", "createdAt": "2020-12-05T16:03:32Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/sync/StackStatusCheckerJob.java", "diffHunk": "@@ -162,6 +175,7 @@ private void updateStackStatus(Stack stack, SyncResult result, List<ProviderSync\n                         stack.getStackStatus().getDetailedStackStatus(), status);\n             }\n         }\n+        return String.format(\"freeipa %s is %s. \", stack.getResourceCrn(), status.getStatus().toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8cebc6ff05311b08c4804cc165acc2b094e4cfc0"}, "originalPosition": 71}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8cebc6ff05311b08c4804cc165acc2b094e4cfc0", "author": {"user": {"login": "christmasferret", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/8cebc6ff05311b08c4804cc165acc2b094e4cfc0", "committedDate": "2020-12-04T21:49:50Z", "message": "CB-10162 Add log message every time the FreeIPA status is checked\n\nDuring ENGESC-5655, we had a hard time debugging the freeipa status. Currently we only log freeipa status when there is a transition (eg. from healthy to unreachable) and it was determined that adding a log message for both freeipa status and instance status during health check would be helpful. Now we added logging for every health check."}, "afterCommit": {"oid": "7fe6cb09691ee64db692c7a16c025a8e7039af1c", "author": {"user": {"login": "christmasferret", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/7fe6cb09691ee64db692c7a16c025a8e7039af1c", "committedDate": "2020-12-07T06:20:06Z", "message": "CB-10162 Add log message every time the FreeIPA status is checked\n\nDuring ENGESC-5655, we had a hard time debugging the freeipa status. Currently we only log freeipa status when there is a transition (eg. from healthy to unreachable) and it was determined that adding a log message for both freeipa status and instance status during health check would be helpful. Now we added logging for every health check."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2MzYzODY5", "url": "https://github.com/hortonworks/cloudbreak/pull/9580#pullrequestreview-546363869", "createdAt": "2020-12-07T17:18:28Z", "commit": {"oid": "7fe6cb09691ee64db692c7a16c025a8e7039af1c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNzoxODoyOFrOIAxiYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNzozNzo0OFrOIAyY3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY4MjUyOQ==", "bodyText": "for this to work right I think you have to fetch stack or stack status from db or you would have to modify StackStatusCheckerJob#updateStackStatus to return the modified stack and use that.\nYou could use StackStatusService#findFirstByStackIdOrderByCreatedDesc to fetch the current status.\nAlso resource crn logging shouldn't be necessary, the MDCContext should have all the filed set.", "url": "https://github.com/hortonworks/cloudbreak/pull/9580#discussion_r537682529", "createdAt": "2020-12-07T17:18:28Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/sync/FreeipaStatusInfoLogger.java", "diffHunk": "@@ -0,0 +1,36 @@\n+package com.sequenceiq.freeipa.sync;\n+\n+import com.sequenceiq.freeipa.entity.InstanceMetaData;\n+import com.sequenceiq.freeipa.entity.Stack;\n+import com.sequenceiq.freeipa.service.stack.instance.InstanceMetaDataService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import javax.inject.Inject;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+@Component\n+public class FreeipaStatusInfoLogger {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(FreeipaStatusInfoLogger.class);\n+\n+    @Inject\n+    private InstanceMetaDataService instanceMetaDataService;\n+\n+    public void logFreeipaStatus(Stack stack, Set<InstanceMetaData> checkableInstances) {\n+        String freeipaStatusInfo = String.format(\"freeipa %s is %s. \", stack.getResourceCrn(), stack.getStackStatus().getStatus());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7fe6cb09691ee64db692c7a16c025a8e7039af1c"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY5Mzg1MA==", "bodyText": "I would suggest some refactor:\n    public void logFreeipaStatus(Stack stack, Set<InstanceMetaData> checkableInstances) {\n        String freeipaStatusInfo = String.format(\"freeipa %s is %s.\", stack.getResourceCrn(), stack.getStackStatus().getStatus());\n        String allInstanceStatusInfo = createInstancesStatusInfo(checkableInstances);\n        LOGGER.debug(\":::Auto sync::: freeipa status from healtch check: {} {}\", freeipaStatusInfo, allInstanceStatusInfo);\n    }\n\n    private String createInstancesStatusInfo(Set<InstanceMetaData> checkableInstances) {\n        Set<InstanceMetaData> allInstanceMetaData = fetchCheckableInstancesFromDb(checkableInstances);\n        String allInstanceStatusInfo = allInstanceMetaData.stream().map(instance -> String.format(\"%s is %s\", instance.getInstanceId(),\n                instance.getInstanceStatus())).collect(Collectors.joining(\"; \"));\n        return allInstanceStatusInfo;\n    }\n\n    private Set<InstanceMetaData> fetchCheckableInstancesFromDb(Set<InstanceMetaData> checkableInstances) {\n        Set<String> checkableInstanceIds = collectCheckableInstanceIds(checkableInstances);\n        Set<InstanceMetaData> allInstanceMetaData = instanceMetaDataService\n                .getByInstanceIds(checkableInstanceIds);\n        return allInstanceMetaData;\n    }\n\n    private Set<String> collectCheckableInstanceIds(Set<InstanceMetaData> checkableInstances) {\n        return checkableInstances.stream()\n                .map(InstanceMetaData::getInstanceId)\n                .collect(Collectors.toSet());\n    }\n\nthe main just next to breaking it into smaller parts that I have switched to stream and used the built in collector instead of creating a StringBuilder. Also I modified the log line and removed the trailing space from freeipaStatusInfo. It's a bit odd to add a space there.\nFeel free to modify the delimiter in joining, I just added something.\nPlease also note I haven't added the fix for the Stack status", "url": "https://github.com/hortonworks/cloudbreak/pull/9580#discussion_r537693850", "createdAt": "2020-12-07T17:34:04Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/sync/FreeipaStatusInfoLogger.java", "diffHunk": "@@ -0,0 +1,36 @@\n+package com.sequenceiq.freeipa.sync;\n+\n+import com.sequenceiq.freeipa.entity.InstanceMetaData;\n+import com.sequenceiq.freeipa.entity.Stack;\n+import com.sequenceiq.freeipa.service.stack.instance.InstanceMetaDataService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import javax.inject.Inject;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+@Component\n+public class FreeipaStatusInfoLogger {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(FreeipaStatusInfoLogger.class);\n+\n+    @Inject\n+    private InstanceMetaDataService instanceMetaDataService;\n+\n+    public void logFreeipaStatus(Stack stack, Set<InstanceMetaData> checkableInstances) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7fe6cb09691ee64db692c7a16c025a8e7039af1c"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY5NjQ3Ng==", "bodyText": "I think it might be saved via stack but I'm not sure. If you seen a missing status maybe it's best to save it here, but please test around with a few changes, even with HA when only one instance's status change to see if there is no issue. thanks", "url": "https://github.com/hortonworks/cloudbreak/pull/9580#discussion_r537696476", "createdAt": "2020-12-07T17:37:48Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/sync/StackStatusCheckerJob.java", "diffHunk": "@@ -189,6 +197,7 @@ private void setStatusIfNotTheSame(InstanceMetaData instanceMetaData, InstanceSt\n         if (instanceMetaData.getInstanceStatus() != newStatus) {\n             if (updateStatus) {\n                 instanceMetaData.setInstanceStatus(newStatus);\n+                instanceMetaDataService.save(instanceMetaData);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7fe6cb09691ee64db692c7a16c025a8e7039af1c"}, "originalPosition": 33}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7fe6cb09691ee64db692c7a16c025a8e7039af1c", "author": {"user": {"login": "christmasferret", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/7fe6cb09691ee64db692c7a16c025a8e7039af1c", "committedDate": "2020-12-07T06:20:06Z", "message": "CB-10162 Add log message every time the FreeIPA status is checked\n\nDuring ENGESC-5655, we had a hard time debugging the freeipa status. Currently we only log freeipa status when there is a transition (eg. from healthy to unreachable) and it was determined that adding a log message for both freeipa status and instance status during health check would be helpful. Now we added logging for every health check."}, "afterCommit": {"oid": "d7268571a35900a0116478c31972a0103f640c3f", "author": {"user": {"login": "christmasferret", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/d7268571a35900a0116478c31972a0103f640c3f", "committedDate": "2020-12-08T17:24:32Z", "message": "CB-10162 Add log message every time the FreeIPA status is checked\n\nDuring ENGESC-5655, we had a hard time debugging the freeipa status. Currently we only log freeipa status when there is a transition (eg. from healthy to unreachable) and it was determined that adding a log message for both freeipa status and instance status during health check would be helpful. Now we added logging for every health check."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d7268571a35900a0116478c31972a0103f640c3f", "author": {"user": {"login": "christmasferret", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/d7268571a35900a0116478c31972a0103f640c3f", "committedDate": "2020-12-08T17:24:32Z", "message": "CB-10162 Add log message every time the FreeIPA status is checked\n\nDuring ENGESC-5655, we had a hard time debugging the freeipa status. Currently we only log freeipa status when there is a transition (eg. from healthy to unreachable) and it was determined that adding a log message for both freeipa status and instance status during health check would be helpful. Now we added logging for every health check."}, "afterCommit": {"oid": "c5e966c5044c0580810442775dacd01587e789fd", "author": {"user": {"login": "christmasferret", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/c5e966c5044c0580810442775dacd01587e789fd", "committedDate": "2020-12-08T17:40:37Z", "message": "CB-10162 Add log message every time the FreeIPA status is checked\n\nDuring ENGESC-5655, we had a hard time debugging the freeipa status. Currently we only log freeipa status when there is a transition (eg. from healthy to unreachable) and it was determined that adding a log message for both freeipa status and instance status during health check would be helpful. Now we added logging for every health check."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4MDIwMzk3", "url": "https://github.com/hortonworks/cloudbreak/pull/9580#pullrequestreview-548020397", "createdAt": "2020-12-09T10:03:11Z", "commit": {"oid": "c5e966c5044c0580810442775dacd01587e789fd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4MDIxOTY5", "url": "https://github.com/hortonworks/cloudbreak/pull/9580#pullrequestreview-548021969", "createdAt": "2020-12-09T10:04:55Z", "commit": {"oid": "c5e966c5044c0580810442775dacd01587e789fd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxMDowNDo1NVrOICMcNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxMDowNDo1NVrOICMcNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE3MTg5Mw==", "bodyText": "I think you could replace Stack stack with Long stackId as stack is only used for getting it's id", "url": "https://github.com/hortonworks/cloudbreak/pull/9580#discussion_r539171893", "createdAt": "2020-12-09T10:04:55Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/sync/FreeipaStatusInfoLogger.java", "diffHunk": "@@ -0,0 +1,53 @@\n+package com.sequenceiq.freeipa.sync;\n+\n+import com.sequenceiq.freeipa.entity.InstanceMetaData;\n+import com.sequenceiq.freeipa.entity.Stack;\n+import com.sequenceiq.freeipa.entity.StackStatus;\n+import com.sequenceiq.freeipa.service.stack.StackStatusService;\n+import com.sequenceiq.freeipa.service.stack.instance.InstanceMetaDataService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import javax.inject.Inject;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+@Component\n+public class FreeipaStatusInfoLogger {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(FreeipaStatusInfoLogger.class);\n+\n+    @Inject\n+    private InstanceMetaDataService instanceMetaDataService;\n+\n+    @Inject\n+    private StackStatusService stackStatusService;\n+\n+    public void logFreeipaStatus(Stack stack, Set<InstanceMetaData> checkableInstances) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5e966c5044c0580810442775dacd01587e789fd"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4MDIzMDQw", "url": "https://github.com/hortonworks/cloudbreak/pull/9580#pullrequestreview-548023040", "createdAt": "2020-12-09T10:06:10Z", "commit": {"oid": "c5e966c5044c0580810442775dacd01587e789fd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxMDowNjoxMFrOICMfow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxMDowNjoxMFrOICMfow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE3Mjc3MQ==", "bodyText": "it would be more readable if you break lines at stream methods, like map or/and collect instead of in the middle of String.format", "url": "https://github.com/hortonworks/cloudbreak/pull/9580#discussion_r539172771", "createdAt": "2020-12-09T10:06:10Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/sync/FreeipaStatusInfoLogger.java", "diffHunk": "@@ -0,0 +1,53 @@\n+package com.sequenceiq.freeipa.sync;\n+\n+import com.sequenceiq.freeipa.entity.InstanceMetaData;\n+import com.sequenceiq.freeipa.entity.Stack;\n+import com.sequenceiq.freeipa.entity.StackStatus;\n+import com.sequenceiq.freeipa.service.stack.StackStatusService;\n+import com.sequenceiq.freeipa.service.stack.instance.InstanceMetaDataService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import javax.inject.Inject;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+@Component\n+public class FreeipaStatusInfoLogger {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(FreeipaStatusInfoLogger.class);\n+\n+    @Inject\n+    private InstanceMetaDataService instanceMetaDataService;\n+\n+    @Inject\n+    private StackStatusService stackStatusService;\n+\n+    public void logFreeipaStatus(Stack stack, Set<InstanceMetaData> checkableInstances) {\n+        StackStatus freeipaStatus = stackStatusService.findFirstByStackIdOrderByCreatedDesc(stack.getId());\n+        String freeipaStatusInfo = String.format(\"freeipa stack is %s.\", freeipaStatus.getStatus());\n+        String allInstanceStatusInfo = createInstancesStatusInfo(checkableInstances);\n+        LOGGER.debug(\":::Auto sync::: freeipa status from healtch check: {} {}\", freeipaStatusInfo, allInstanceStatusInfo);\n+    }\n+\n+    private String createInstancesStatusInfo(Set<InstanceMetaData> checkableInstances) {\n+        Set<InstanceMetaData> allInstanceMetaData = fetchCheckableInstancesFromDb(checkableInstances);\n+        String allInstanceStatusInfo = allInstanceMetaData.stream().map(instance -> String.format(\"instance %s is %s\", instance.getInstanceId(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5e966c5044c0580810442775dacd01587e789fd"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4MDIzMjIx", "url": "https://github.com/hortonworks/cloudbreak/pull/9580#pullrequestreview-548023221", "createdAt": "2020-12-09T10:06:26Z", "commit": {"oid": "c5e966c5044c0580810442775dacd01587e789fd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxMDowNjoyNlrOICMgOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxMDowNjoyNlrOICMgOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE3MjkyMQ==", "bodyText": "unnecessary extra spaces", "url": "https://github.com/hortonworks/cloudbreak/pull/9580#discussion_r539172921", "createdAt": "2020-12-09T10:06:26Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/sync/StackStatusCheckerJob.java", "diffHunk": "@@ -108,7 +115,7 @@ public void syncAStack(Stack stack) {\n                             for (Map.Entry<InstanceMetaData, DetailedStackStatus> entry : syncResult.getInstanceStatusMap().entrySet()) {\n                                 updateInstanceStatus(entry.getKey(), entry.getValue());\n                             }\n-                            updateStackStatus(stack, syncResult, null, alreadyDeletedCount);\n+                            updateStackStatus(stack, syncResult, null,   alreadyDeletedCount);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5e966c5044c0580810442775dacd01587e789fd"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e41142c39c50939c4a70f75234b3bcc8a708cc0", "author": {"user": {"login": "christmasferret", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/3e41142c39c50939c4a70f75234b3bcc8a708cc0", "committedDate": "2020-12-09T15:12:25Z", "message": "CB-10162 Add log message every time the FreeIPA status is checked\n\nDuring ENGESC-5655, we had a hard time debugging the freeipa status. Currently we only log freeipa status when there is a transition (eg. from healthy to unreachable) and it was determined that adding a log message for both freeipa status and instance status during health check would be helpful. Now we added logging for every health check."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7aa170e1fc2a6f8233067e7a82832d0121c3091e", "author": {"user": {"login": "christmasferret", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/7aa170e1fc2a6f8233067e7a82832d0121c3091e", "committedDate": "2020-12-09T15:09:09Z", "message": "CB-10162 Add log message every time the FreeIPA status is checked\n\nDuring ENGESC-5655, we had a hard time debugging the freeipa status. Currently we only log freeipa status when there is a transition (eg. from healthy to unreachable) and it was determined that adding a log message for both freeipa status and instance status during health check would be helpful. Now we added logging for every health check."}, "afterCommit": {"oid": "3e41142c39c50939c4a70f75234b3bcc8a708cc0", "author": {"user": {"login": "christmasferret", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/3e41142c39c50939c4a70f75234b3bcc8a708cc0", "committedDate": "2020-12-09T15:12:25Z", "message": "CB-10162 Add log message every time the FreeIPA status is checked\n\nDuring ENGESC-5655, we had a hard time debugging the freeipa status. Currently we only log freeipa status when there is a transition (eg. from healthy to unreachable) and it was determined that adding a log message for both freeipa status and instance status during health check would be helpful. Now we added logging for every health check."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1937, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}