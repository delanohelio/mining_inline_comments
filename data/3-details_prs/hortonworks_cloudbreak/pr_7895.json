{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA4NzY1MzUz", "number": 7895, "title": "CDPCP-1561. Allow internal actor to call user sync endpoint", "bodyText": "Previously the accountId to sync was inferred from the calling\nuser, which doesn't work when the calling user is the internal\nactor. This is fixed by including accountId as an optional\nparameter to the user sync request.", "createdAt": "2020-04-24T21:06:42Z", "url": "https://github.com/hortonworks/cloudbreak/pull/7895", "merged": true, "mergeCommit": {"oid": "b8cebfff08c3a27355bef4c1b85678ff1429d338"}, "closed": true, "closedAt": "2020-04-29T12:03:22Z", "author": {"login": "aarman-cloudera"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABca4kcOAFqTQwMDI4NTg4OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABccF3bpAFqTQwMTk3MTQ0Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwMjg1ODg4", "url": "https://github.com/hortonworks/cloudbreak/pull/7895#pullrequestreview-400285888", "createdAt": "2020-04-24T21:37:18Z", "commit": {"oid": "407e1094f8a84f499a3849c34ee8f48fd1d2bfff"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQyMTozNzoxOFrOGLqIHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQyMTo0MDozN1rOGLqNnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg3NzcyNA==", "bodyText": "you should also allow setting the account id to your own account", "url": "https://github.com/hortonworks/cloudbreak/pull/7895#discussion_r414877724", "createdAt": "2020-04-24T21:37:18Z", "author": {"login": "handavid"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/controller/UserV1Controller.java", "diffHunk": "@@ -107,6 +109,16 @@ public SyncOperationStatus getSyncOperationStatus(@NotNull String operationId) {\n                 operationService.getOperationForAccountIdAndOperationId(accountId, operationId));\n     }\n \n+    private String determineAccountId(String callingActor, String requestedAccountId) {\n+        if (requestedAccountId == null) {\n+            return ThreadBasedUserCrnProvider.getAccountId();\n+        }\n+        if (!InternalCrnBuilder.isInternalCrn(callingActor)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "407e1094f8a84f499a3849c34ee8f48fd1d2bfff"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg3OTEzMg==", "bodyText": "actor crn not needed here", "url": "https://github.com/hortonworks/cloudbreak/pull/7895#discussion_r414879132", "createdAt": "2020-04-24T21:40:37Z", "author": {"login": "handavid"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/freeipa/user/UserSyncService.java", "diffHunk": "@@ -402,6 +402,16 @@ void validateParameters(String accountId, String actorCrn, Set<String> environme\n         validateCrnFilter(environmentCrnFilter, Crn.ResourceType.ENVIRONMENT);\n         validateCrnFilter(userCrnFilter, Crn.ResourceType.USER);\n         validateCrnFilter(machineUserCrnFilter, Crn.ResourceType.MACHINE_USER);\n+        validateSameAccount(actorCrn, accountId, Iterables.concat(environmentCrnFilter, userCrnFilter, machineUserCrnFilter));\n+    }\n+\n+    private void validateSameAccount(String actorCrn, String accountId, Iterable<String> crns) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "407e1094f8a84f499a3849c34ee8f48fd1d2bfff"}, "originalPosition": 7}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "407e1094f8a84f499a3849c34ee8f48fd1d2bfff", "author": {"user": {"login": "aarman-cloudera", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/407e1094f8a84f499a3849c34ee8f48fd1d2bfff", "committedDate": "2020-04-24T21:03:00Z", "message": "CDPCP-1561. Allow internal actor to call user sync endpoint\n\nPreviously the accountId to sync was inferred from the calling\nuser, which doesn't work when the calling user is the internal\nactor. This is fixed by including accountId as an optional\nparameter to the user sync request."}, "afterCommit": {"oid": "18458c58ca756886234e29dcee497c257752a9b7", "author": {"user": {"login": "aarman-cloudera", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/18458c58ca756886234e29dcee497c257752a9b7", "committedDate": "2020-04-27T07:00:35Z", "message": "CDPCP-1561. Allow internal actor to call user sync endpoint\n\nPreviously the accountId to sync was inferred from the calling\nuser, which doesn't work when the calling user is the internal\nactor. This is fixed by including accountId as an optional\nparameter to the user sync request."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwODY1Nzkz", "url": "https://github.com/hortonworks/cloudbreak/pull/7895#pullrequestreview-400865793", "createdAt": "2020-04-27T11:34:12Z", "commit": {"oid": "18458c58ca756886234e29dcee497c257752a9b7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxMTozNDoxMlrOGMegbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxMTozNDoxMlrOGMegbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTczNTkxNw==", "bodyText": "do we really want to propagate that information to customers if somehow they can invoke it with different accountid?", "url": "https://github.com/hortonworks/cloudbreak/pull/7895#discussion_r415735917", "createdAt": "2020-04-27T11:34:12Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/controller/UserV1Controller.java", "diffHunk": "@@ -107,6 +109,17 @@ public SyncOperationStatus getSyncOperationStatus(@NotNull String operationId) {\n                 operationService.getOperationForAccountIdAndOperationId(accountId, operationId));\n     }\n \n+    private String determineAccountId(String callingActor, String requestedAccountId) {\n+        if (requestedAccountId == null) {\n+            return ThreadBasedUserCrnProvider.getAccountId();\n+        }\n+        String callingActorAccountId = Crn.safeFromString(callingActor).getAccountId();\n+        if (!callingActorAccountId.equals(requestedAccountId) && !InternalCrnBuilder.isInternalCrn(callingActor)) {\n+            throw new BadRequestException(\"Only the internal actor can set a different accountId\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18458c58ca756886234e29dcee497c257752a9b7"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxMjYxODY0", "url": "https://github.com/hortonworks/cloudbreak/pull/7895#pullrequestreview-401261864", "createdAt": "2020-04-27T19:30:29Z", "commit": {"oid": "18458c58ca756886234e29dcee497c257752a9b7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6514f6fc345a2d2ac1362d6d526589832497e633", "author": {"user": {"login": "aarman-cloudera", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/6514f6fc345a2d2ac1362d6d526589832497e633", "committedDate": "2020-04-28T06:38:13Z", "message": "CDPCP-1561. Allow internal actor to call user sync endpoint\n\nPreviously the accountId to sync was inferred from the calling\nuser, which doesn't work when the calling user is the internal\nactor. This is fixed by including accountId as an optional\nparameter to the user sync request."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "18458c58ca756886234e29dcee497c257752a9b7", "author": {"user": {"login": "aarman-cloudera", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/18458c58ca756886234e29dcee497c257752a9b7", "committedDate": "2020-04-27T07:00:35Z", "message": "CDPCP-1561. Allow internal actor to call user sync endpoint\n\nPreviously the accountId to sync was inferred from the calling\nuser, which doesn't work when the calling user is the internal\nactor. This is fixed by including accountId as an optional\nparameter to the user sync request."}, "afterCommit": {"oid": "6514f6fc345a2d2ac1362d6d526589832497e633", "author": {"user": {"login": "aarman-cloudera", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/6514f6fc345a2d2ac1362d6d526589832497e633", "committedDate": "2020-04-28T06:38:13Z", "message": "CDPCP-1561. Allow internal actor to call user sync endpoint\n\nPreviously the accountId to sync was inferred from the calling\nuser, which doesn't work when the calling user is the internal\nactor. This is fixed by including accountId as an optional\nparameter to the user sync request."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxNjU2OTE5", "url": "https://github.com/hortonworks/cloudbreak/pull/7895#pullrequestreview-401656919", "createdAt": "2020-04-28T09:26:34Z", "commit": {"oid": "6514f6fc345a2d2ac1362d6d526589832497e633"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxOTcxNDQ3", "url": "https://github.com/hortonworks/cloudbreak/pull/7895#pullrequestreview-401971447", "createdAt": "2020-04-28T15:46:02Z", "commit": {"oid": "6514f6fc345a2d2ac1362d6d526589832497e633"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2246, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}