{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcyOTE0NzUz", "number": 7249, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMDoxMzowOVrODeZYfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMDoxMzowOVrODeZYfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMTk5NzQzOnYy", "diffSide": "RIGHT", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/stack/FreeIpaHealthDetailsService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMDoxMzowOVrOFngcvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxNDo0MjowM1rOFnojpA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk3MDQzMA==", "bodyText": "You can do it inline", "url": "https://github.com/hortonworks/cloudbreak/pull/7249#discussion_r376970430", "createdAt": "2020-02-10T10:13:09Z", "author": {"login": "topolyai5"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/stack/FreeIpaHealthDetailsService.java", "diffHunk": "@@ -0,0 +1,152 @@\n+package com.sequenceiq.freeipa.service.stack;\n+\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Service;\n+\n+\n+import com.sequenceiq.freeipa.api.v1.freeipa.stack.model.common.DetailedStackStatus;\n+import com.sequenceiq.freeipa.api.v1.freeipa.stack.model.common.Status;\n+import com.sequenceiq.freeipa.api.v1.freeipa.stack.model.common.instance.InstanceGroupType;\n+import com.sequenceiq.freeipa.api.v1.freeipa.stack.model.health.HealthDetailsFreeIpaResponse;\n+import com.sequenceiq.freeipa.api.v1.freeipa.stack.model.health.NodeHealthDetails;\n+import com.sequenceiq.freeipa.client.FreeIpaClient;\n+import com.sequenceiq.freeipa.client.FreeIpaClientException;\n+import com.sequenceiq.freeipa.client.model.RPCMessage;\n+import com.sequenceiq.freeipa.client.model.RPCResponse;\n+import com.sequenceiq.freeipa.entity.InstanceGroup;\n+import com.sequenceiq.freeipa.entity.InstanceMetaData;\n+import com.sequenceiq.freeipa.entity.Stack;\n+import com.sequenceiq.freeipa.service.freeipa.FreeIpaClientFactory;\n+\n+@Service\n+public class FreeIpaHealthDetailsService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(FreeIpaHealthDetailsService.class);\n+\n+    private static final String EXTERNAL_COMMAND_OUTPUT = \"ExternalCommandOutput\";\n+\n+    private static final String STATUS_OK = \"OK\";\n+\n+    private static final int STATUS_GROUP = 2;\n+\n+    private static final int NODE_GROUP = 1;\n+\n+    private static final String MESSAGE_UNAVAILABLE = \"Message Unavailable\";\n+\n+    private static final Pattern RESULT_PATTERN = Pattern.compile(\"(ecure port|: TCP) \\\\([0-9]*\\\\): (.*)\");\n+\n+    private static final Pattern NEW_NODE_PATTERN = Pattern.compile(\"Check connection from master to remote replica '(.[^\\']*)\");\n+\n+    @Inject\n+    private StackService stackService;\n+\n+    @Inject\n+    private FreeIpaClientFactory freeIpaClientFactory;\n+\n+    public HealthDetailsFreeIpaResponse getHealthDetails(String environmentCrn, String accountId) {\n+        Stack stack = stackService.getByEnvironmentCrnAndAccountIdWithLists(environmentCrn, accountId);\n+        InstanceMetaData master = findMaster(stack);\n+        Optional<RPCResponse<Boolean>> rpcResponse = Optional.empty();\n+        try {\n+            rpcResponse = Optional.ofNullable(checkFreeIpaHealth(stack, master));\n+        } catch (FreeIpaClientException e) {\n+            LOGGER.error(\"Unable to check the health of FreeIPA.\", e);\n+        }\n+        return createResponse(stack, rpcResponse, master);\n+    }\n+\n+    private HealthDetailsFreeIpaResponse createResponse(Stack stack, Optional<RPCResponse<Boolean>> rpcResponse, InstanceMetaData master) {\n+        HealthDetailsFreeIpaResponse response = new HealthDetailsFreeIpaResponse();\n+        response.setEnvironmentCrn(stack.getEnvironmentCrn());\n+        response.setCrn(stack.getResourceCrn());\n+        if (rpcResponse.isPresent()) {\n+            response.setName((String) rpcResponse.get().getValue());\n+            parseMessages(rpcResponse.get(), response);\n+            if (isOverallHealthy(response)) {\n+                response.setStatus(DetailedStackStatus.PROVISIONED.getStatus());\n+            } else {\n+                response.setStatus(DetailedStackStatus.UNHEALTHY.getStatus());\n+            }\n+        } else {\n+            response.setStatus(DetailedStackStatus.UNREACHABLE.getStatus());\n+            NodeHealthDetails nodeResponse = null;\n+            nodeResponse = new NodeHealthDetails();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "052eaaea3ddc80a26d212586f52fa80656387391"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzEwMzI2OA==", "bodyText": "missed this in the refactoring.  Fixed.", "url": "https://github.com/hortonworks/cloudbreak/pull/7249#discussion_r377103268", "createdAt": "2020-02-10T14:42:03Z", "author": {"login": "holleyism"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/service/stack/FreeIpaHealthDetailsService.java", "diffHunk": "@@ -0,0 +1,152 @@\n+package com.sequenceiq.freeipa.service.stack;\n+\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Service;\n+\n+\n+import com.sequenceiq.freeipa.api.v1.freeipa.stack.model.common.DetailedStackStatus;\n+import com.sequenceiq.freeipa.api.v1.freeipa.stack.model.common.Status;\n+import com.sequenceiq.freeipa.api.v1.freeipa.stack.model.common.instance.InstanceGroupType;\n+import com.sequenceiq.freeipa.api.v1.freeipa.stack.model.health.HealthDetailsFreeIpaResponse;\n+import com.sequenceiq.freeipa.api.v1.freeipa.stack.model.health.NodeHealthDetails;\n+import com.sequenceiq.freeipa.client.FreeIpaClient;\n+import com.sequenceiq.freeipa.client.FreeIpaClientException;\n+import com.sequenceiq.freeipa.client.model.RPCMessage;\n+import com.sequenceiq.freeipa.client.model.RPCResponse;\n+import com.sequenceiq.freeipa.entity.InstanceGroup;\n+import com.sequenceiq.freeipa.entity.InstanceMetaData;\n+import com.sequenceiq.freeipa.entity.Stack;\n+import com.sequenceiq.freeipa.service.freeipa.FreeIpaClientFactory;\n+\n+@Service\n+public class FreeIpaHealthDetailsService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(FreeIpaHealthDetailsService.class);\n+\n+    private static final String EXTERNAL_COMMAND_OUTPUT = \"ExternalCommandOutput\";\n+\n+    private static final String STATUS_OK = \"OK\";\n+\n+    private static final int STATUS_GROUP = 2;\n+\n+    private static final int NODE_GROUP = 1;\n+\n+    private static final String MESSAGE_UNAVAILABLE = \"Message Unavailable\";\n+\n+    private static final Pattern RESULT_PATTERN = Pattern.compile(\"(ecure port|: TCP) \\\\([0-9]*\\\\): (.*)\");\n+\n+    private static final Pattern NEW_NODE_PATTERN = Pattern.compile(\"Check connection from master to remote replica '(.[^\\']*)\");\n+\n+    @Inject\n+    private StackService stackService;\n+\n+    @Inject\n+    private FreeIpaClientFactory freeIpaClientFactory;\n+\n+    public HealthDetailsFreeIpaResponse getHealthDetails(String environmentCrn, String accountId) {\n+        Stack stack = stackService.getByEnvironmentCrnAndAccountIdWithLists(environmentCrn, accountId);\n+        InstanceMetaData master = findMaster(stack);\n+        Optional<RPCResponse<Boolean>> rpcResponse = Optional.empty();\n+        try {\n+            rpcResponse = Optional.ofNullable(checkFreeIpaHealth(stack, master));\n+        } catch (FreeIpaClientException e) {\n+            LOGGER.error(\"Unable to check the health of FreeIPA.\", e);\n+        }\n+        return createResponse(stack, rpcResponse, master);\n+    }\n+\n+    private HealthDetailsFreeIpaResponse createResponse(Stack stack, Optional<RPCResponse<Boolean>> rpcResponse, InstanceMetaData master) {\n+        HealthDetailsFreeIpaResponse response = new HealthDetailsFreeIpaResponse();\n+        response.setEnvironmentCrn(stack.getEnvironmentCrn());\n+        response.setCrn(stack.getResourceCrn());\n+        if (rpcResponse.isPresent()) {\n+            response.setName((String) rpcResponse.get().getValue());\n+            parseMessages(rpcResponse.get(), response);\n+            if (isOverallHealthy(response)) {\n+                response.setStatus(DetailedStackStatus.PROVISIONED.getStatus());\n+            } else {\n+                response.setStatus(DetailedStackStatus.UNHEALTHY.getStatus());\n+            }\n+        } else {\n+            response.setStatus(DetailedStackStatus.UNREACHABLE.getStatus());\n+            NodeHealthDetails nodeResponse = null;\n+            nodeResponse = new NodeHealthDetails();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk3MDQzMA=="}, "originalCommit": {"oid": "052eaaea3ddc80a26d212586f52fa80656387391"}, "originalPosition": 82}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2833, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}