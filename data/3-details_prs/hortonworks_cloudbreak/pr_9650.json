{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM5ODQxMzQw", "number": 9650, "title": "CB-9744 Export Ranger on gateway for SDX HA.", "bodyText": "This exports just the Ranger nodes for Knox that are on the gateway nodes.\nThis also includes a change to Stack to persist the SDX shape and carry it\nacross to the Salt config.\nSee detailed description in the commit message.", "createdAt": "2020-12-14T22:29:23Z", "url": "https://github.com/hortonworks/cloudbreak/pull/9650", "merged": true, "mergeCommit": {"oid": "298de5fc9c924159c42102f98073aee581937124"}, "closed": true, "closedAt": "2021-01-06T15:54:47Z", "author": {"login": "frozenwizard"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmYG6pAFqTU1MjMyMTM3Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdtXYnkABqjQxNzMyNjM1MDg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyMzIxMzcy", "url": "https://github.com/hortonworks/cloudbreak/pull/9650#pullrequestreview-552321372", "createdAt": "2020-12-15T10:43:00Z", "commit": {"oid": "cc426dff5988d3c06f8150b2572cf742d70722f5"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxMDo0MzowMFrOIGEbxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxMDo1MToyNlrOIGEyhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzIzNTAxMw==", "bodyText": "this doesn't seems to be a good long term solution. I would suggest to fetch the gateways' hostnames/fqdns and filter in them instead of the magic gateway string", "url": "https://github.com/hortonworks/cloudbreak/pull/9650#discussion_r543235013", "createdAt": "2020-12-15T10:43:00Z", "author": {"login": "lacikaaa"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/core/bootstrap/service/host/ClusterHostServiceRunner.java", "diffHunk": "@@ -600,8 +601,13 @@ private void saveGatewayPillar(GatewayConfig gatewayConfig, Cluster cluster,\n \n         ExposedService rangerService = exposedServiceCollector.getRangerService();\n         List<String> rangerLocations = serviceLocations.get(rangerService.getServiceName());\n+\n         if (!CollectionUtils.isEmpty(rangerLocations)) {\n-            serviceLocations.put(rangerService.getServiceName(), getSingleRangerFqdn(gatewayConfig.getHostname(), rangerLocations));\n+            if (SdxClusterShape.LIGHT_DUTY.equals(cluster.getStack().getSdxClusterShape())) {\n+                serviceLocations.put(rangerService.getServiceName(), getSingleRangerFqdn(gatewayConfig.getHostname(), rangerLocations));\n+            } else if (SdxClusterShape.MEDIUM_DUTY_HA.equals(cluster.getStack().getSdxClusterShape())) {\n+                serviceLocations.put(rangerService.getServiceName(), rangerLocations.stream().filter(s -> s.contains(\"gateway\")).collect(Collectors.toList()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc426dff5988d3c06f8150b2572cf742d70722f5"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzIzNjU3MA==", "bodyText": "as this must match with the other SdxClusterShape it must be ensured via unit tests", "url": "https://github.com/hortonworks/cloudbreak/pull/9650#discussion_r543236570", "createdAt": "2020-12-15T10:45:15Z", "author": {"login": "lacikaaa"}, "path": "core-api/src/main/java/com/sequenceiq/cloudbreak/api/endpoint/v4/common/SdxClusterShape.java", "diffHunk": "@@ -0,0 +1,8 @@\n+package com.sequenceiq.cloudbreak.api.endpoint.v4.common;\n+\n+public enum SdxClusterShape {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc426dff5988d3c06f8150b2572cf742d70722f5"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzI0MDgzOQ==", "bodyText": "is it possible to have multiple gateway node for LIGHT_DUTY? I mean do we need this if-else at all? couldn't be it like all gateway node has ranger and LIGHT_DUTY has only one GW while MEDIUM has multiple and the result would be the same. In this case we won't need the cluster shape on CB side", "url": "https://github.com/hortonworks/cloudbreak/pull/9650#discussion_r543240839", "createdAt": "2020-12-15T10:51:26Z", "author": {"login": "lacikaaa"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/core/bootstrap/service/host/ClusterHostServiceRunner.java", "diffHunk": "@@ -600,8 +601,13 @@ private void saveGatewayPillar(GatewayConfig gatewayConfig, Cluster cluster,\n \n         ExposedService rangerService = exposedServiceCollector.getRangerService();\n         List<String> rangerLocations = serviceLocations.get(rangerService.getServiceName());\n+\n         if (!CollectionUtils.isEmpty(rangerLocations)) {\n-            serviceLocations.put(rangerService.getServiceName(), getSingleRangerFqdn(gatewayConfig.getHostname(), rangerLocations));\n+            if (SdxClusterShape.LIGHT_DUTY.equals(cluster.getStack().getSdxClusterShape())) {\n+                serviceLocations.put(rangerService.getServiceName(), getSingleRangerFqdn(gatewayConfig.getHostname(), rangerLocations));\n+            } else if (SdxClusterShape.MEDIUM_DUTY_HA.equals(cluster.getStack().getSdxClusterShape())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc426dff5988d3c06f8150b2572cf742d70722f5"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyMzM5ODEw", "url": "https://github.com/hortonworks/cloudbreak/pull/9650#pullrequestreview-552339810", "createdAt": "2020-12-15T11:06:37Z", "commit": {"oid": "cc426dff5988d3c06f8150b2572cf742d70722f5"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyNjU3MjQ4", "url": "https://github.com/hortonworks/cloudbreak/pull/9650#pullrequestreview-552657248", "createdAt": "2020-12-15T16:45:35Z", "commit": {"oid": "cc426dff5988d3c06f8150b2572cf742d70722f5"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxNjo0NTozNVrOIGVGlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxNjo1MzoxOFrOIGVfyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzUwODExNw==", "bodyText": "This is a very basic description. Can you add more information, like explaining what a cluster shape is?", "url": "https://github.com/hortonworks/cloudbreak/pull/9650#discussion_r543508117", "createdAt": "2020-12-15T16:45:35Z", "author": {"login": "hreeve-cloudera"}, "path": "core-api/src/main/java/com/sequenceiq/cloudbreak/doc/ModelDescriptions.java", "diffHunk": "@@ -241,6 +241,7 @@ private ModelDescriptions() {\n         public static final String TUNNEL = \"Configuration that the connection going directly or with cluster proxy or with ccm and cluster proxy.\";\n         public static final String FLOW_ID = \"Flow identifier for the current stack creation. Only returned during the stack create request/response.\";\n         public static final String EXTERNAL_DATABASE = \"External database parameters for the stack.\";\n+        public static final String SDX_CLUSTER_SHAPE = \"SDX Cluster Shape\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc426dff5988d3c06f8150b2572cf742d70722f5"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzUxNDU2OA==", "bodyText": "I think you can filter on stack.getPrimaryGatewayInstance().getInstanceGroup().getGroupName(). For medium duty the group name should be \"gateway\", and for light duty it would be \"master\".", "url": "https://github.com/hortonworks/cloudbreak/pull/9650#discussion_r543514568", "createdAt": "2020-12-15T16:53:18Z", "author": {"login": "hreeve-cloudera"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/core/bootstrap/service/host/ClusterHostServiceRunner.java", "diffHunk": "@@ -600,8 +601,13 @@ private void saveGatewayPillar(GatewayConfig gatewayConfig, Cluster cluster,\n \n         ExposedService rangerService = exposedServiceCollector.getRangerService();\n         List<String> rangerLocations = serviceLocations.get(rangerService.getServiceName());\n+\n         if (!CollectionUtils.isEmpty(rangerLocations)) {\n-            serviceLocations.put(rangerService.getServiceName(), getSingleRangerFqdn(gatewayConfig.getHostname(), rangerLocations));\n+            if (SdxClusterShape.LIGHT_DUTY.equals(cluster.getStack().getSdxClusterShape())) {\n+                serviceLocations.put(rangerService.getServiceName(), getSingleRangerFqdn(gatewayConfig.getHostname(), rangerLocations));\n+            } else if (SdxClusterShape.MEDIUM_DUTY_HA.equals(cluster.getStack().getSdxClusterShape())) {\n+                serviceLocations.put(rangerService.getServiceName(), rangerLocations.stream().filter(s -> s.contains(\"gateway\")).collect(Collectors.toList()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzIzNTAxMw=="}, "originalCommit": {"oid": "cc426dff5988d3c06f8150b2572cf742d70722f5"}, "originalPosition": 18}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cc426dff5988d3c06f8150b2572cf742d70722f5", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/cc426dff5988d3c06f8150b2572cf742d70722f5", "committedDate": "2020-12-14T22:25:49Z", "message": "CB-9744 Export Ranger on gateway for SDX HA.\n\nThis exports just the Ranger nodes for Knox that are on the gateway nodes.\nThis also includes a change to Stack to persist the SDX shape and carry it\nacross to the Salt config."}, "afterCommit": {"oid": "b13f52c4f669073c44dcafd076344867eac17caa", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/b13f52c4f669073c44dcafd076344867eac17caa", "committedDate": "2020-12-16T21:05:58Z", "message": "CB-9744 Export Ranger on gateway for SDX HA.\n\nThis exports all of the Ranger nodes for Knox on the gateway nodes."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b13f52c4f669073c44dcafd076344867eac17caa", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/b13f52c4f669073c44dcafd076344867eac17caa", "committedDate": "2020-12-16T21:05:58Z", "message": "CB-9744 Export Ranger on gateway for SDX HA.\n\nThis exports all of the Ranger nodes for Knox on the gateway nodes."}, "afterCommit": {"oid": "7a8b08dd3553638282c1057032674bdc6333907a", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/7a8b08dd3553638282c1057032674bdc6333907a", "committedDate": "2020-12-16T21:30:01Z", "message": "CB-9744 Export Ranger on gateway for SDX HA.\n\nThis exports all of the Ranger nodes for Knox on the gateway nodes."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYwODQ3Mzcw", "url": "https://github.com/hortonworks/cloudbreak/pull/9650#pullrequestreview-560847370", "createdAt": "2021-01-04T08:27:45Z", "commit": {"oid": "7a8b08dd3553638282c1057032674bdc6333907a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYwODc3OTcx", "url": "https://github.com/hortonworks/cloudbreak/pull/9650#pullrequestreview-560877971", "createdAt": "2021-01-04T09:19:59Z", "commit": {"oid": "7a8b08dd3553638282c1057032674bdc6333907a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYwOTgwMTM3", "url": "https://github.com/hortonworks/cloudbreak/pull/9650#pullrequestreview-560980137", "createdAt": "2021-01-04T12:05:25Z", "commit": {"oid": "7a8b08dd3553638282c1057032674bdc6333907a"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7a8b08dd3553638282c1057032674bdc6333907a", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/7a8b08dd3553638282c1057032674bdc6333907a", "committedDate": "2020-12-16T21:30:01Z", "message": "CB-9744 Export Ranger on gateway for SDX HA.\n\nThis exports all of the Ranger nodes for Knox on the gateway nodes."}, "afterCommit": {"oid": "3872d1382929050c1ef0569b98ab531c985ca25d", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/3872d1382929050c1ef0569b98ab531c985ca25d", "committedDate": "2021-01-04T17:03:13Z", "message": "CB-9744 Export Ranger on gateway for SDX HA.\n\nThis exports all of the Ranger nodes for Knox on the Gateway nodes."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3872d1382929050c1ef0569b98ab531c985ca25d", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/3872d1382929050c1ef0569b98ab531c985ca25d", "committedDate": "2021-01-04T17:03:13Z", "message": "CB-9744 Export Ranger on gateway for SDX HA.\n\nThis exports all of the Ranger nodes for Knox on the Gateway nodes."}, "afterCommit": {"oid": "6cc7d758b8bf9e768c90afaf4745d52f89ebdd6e", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/6cc7d758b8bf9e768c90afaf4745d52f89ebdd6e", "committedDate": "2021-01-04T20:57:48Z", "message": "CB-9744 Export Ranger on gateway for SDX HA.\n\nThis exports all of the Ranger nodes for Knox on the Gateway nodes."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6cc7d758b8bf9e768c90afaf4745d52f89ebdd6e", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/6cc7d758b8bf9e768c90afaf4745d52f89ebdd6e", "committedDate": "2021-01-04T20:57:48Z", "message": "CB-9744 Export Ranger on gateway for SDX HA.\n\nThis exports all of the Ranger nodes for Knox on the Gateway nodes."}, "afterCommit": {"oid": "51ed0ce2b640f9e2e74d46aa2e60cbf49711c42e", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/51ed0ce2b640f9e2e74d46aa2e60cbf49711c42e", "committedDate": "2021-01-04T22:02:15Z", "message": "CB-9744 Export Ranger on gateway for SDX HA.\n\nThis exports all of the Ranger nodes for Knox on the Gateway nodes."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "51ed0ce2b640f9e2e74d46aa2e60cbf49711c42e", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/51ed0ce2b640f9e2e74d46aa2e60cbf49711c42e", "committedDate": "2021-01-04T22:02:15Z", "message": "CB-9744 Export Ranger on gateway for SDX HA.\n\nThis exports all of the Ranger nodes for Knox on the Gateway nodes."}, "afterCommit": {"oid": "6d63089b084371ecd570330d7df0158bdd367439", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/6d63089b084371ecd570330d7df0158bdd367439", "committedDate": "2021-01-04T23:13:02Z", "message": "CB-9744 Export Ranger on gateway for SDX HA.\n\nThis exports all of the Ranger nodes for Knox on the Gateway nodes."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6d63089b084371ecd570330d7df0158bdd367439", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/6d63089b084371ecd570330d7df0158bdd367439", "committedDate": "2021-01-04T23:13:02Z", "message": "CB-9744 Export Ranger on gateway for SDX HA.\n\nThis exports all of the Ranger nodes for Knox on the Gateway nodes."}, "afterCommit": {"oid": "719b42e517e4203448ed727cfc4cf47d86f3634d", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/719b42e517e4203448ed727cfc4cf47d86f3634d", "committedDate": "2021-01-05T16:44:54Z", "message": "CB-9744 Export Ranger on gateway for SDX HA.\n\nThis exports all of the Ranger nodes for Knox on the Gateway nodes."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "719b42e517e4203448ed727cfc4cf47d86f3634d", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/719b42e517e4203448ed727cfc4cf47d86f3634d", "committedDate": "2021-01-05T16:44:54Z", "message": "CB-9744 Export Ranger on gateway for SDX HA.\n\nThis exports all of the Ranger nodes for Knox on the Gateway nodes."}, "afterCommit": {"oid": "7fdd1498e0ac114e3aeab72a17fcfb9e6bf18e78", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/7fdd1498e0ac114e3aeab72a17fcfb9e6bf18e78", "committedDate": "2021-01-05T21:46:03Z", "message": "CB-9744 Export Ranger on gateway for SDX HA.\n\nThis exports all of the Ranger nodes for Knox on the Gateway nodes."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7fdd1498e0ac114e3aeab72a17fcfb9e6bf18e78", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/7fdd1498e0ac114e3aeab72a17fcfb9e6bf18e78", "committedDate": "2021-01-05T21:46:03Z", "message": "CB-9744 Export Ranger on gateway for SDX HA.\n\nThis exports all of the Ranger nodes for Knox on the Gateway nodes."}, "afterCommit": {"oid": "9077e17ce39112327eaf92bf1aae340889e96dbc", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/9077e17ce39112327eaf92bf1aae340889e96dbc", "committedDate": "2021-01-05T22:56:04Z", "message": "CB-9744 Export Ranger on gateway for SDX HA.\n\nThis exports all of the Ranger nodes for Knox on the Gateway nodes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8426838a6ecc629024f7519dd246401fef1cefdf", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/8426838a6ecc629024f7519dd246401fef1cefdf", "committedDate": "2021-01-06T03:58:17Z", "message": "CB-9744 Export Ranger on gateway for SDX HA.\n\nThis exports all of the Ranger nodes for Knox on the Gateway nodes."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9077e17ce39112327eaf92bf1aae340889e96dbc", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/9077e17ce39112327eaf92bf1aae340889e96dbc", "committedDate": "2021-01-05T22:56:04Z", "message": "CB-9744 Export Ranger on gateway for SDX HA.\n\nThis exports all of the Ranger nodes for Knox on the Gateway nodes."}, "afterCommit": {"oid": "8426838a6ecc629024f7519dd246401fef1cefdf", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/8426838a6ecc629024f7519dd246401fef1cefdf", "committedDate": "2021-01-06T03:58:17Z", "message": "CB-9744 Export Ranger on gateway for SDX HA.\n\nThis exports all of the Ranger nodes for Knox on the Gateway nodes."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1992, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}