{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk1NDMyMDcz", "number": 9109, "title": "CB-9056. Prevent restart of clusters creating new machines user acces\u2026", "bodyText": "\u2026s keys in UMS.\ndetails:\n\ncreate a new column (secret) for cluster in order to store databus access/private keys\n(could not use component table properly with secrets and cluster attributes are not really used I think, so i have created a new one)\nget this value during salt pillar config update (or during deployment), if not set, generate a new keypair and save it in the cluster entity\nthe exact same thing will be needed for freeipa as well (not needed yet as no salt pillar config upgrade there yet)\n\nSee detailed description in the commit message.\nalso it requires some local testing as well (against UMS, using shared credential + local setup)\nupdate: testing with local setup + with using remote UMS has finished (first one with the logic, second one is just for the calls to make sure those will work)", "createdAt": "2020-09-30T11:10:49Z", "url": "https://github.com/hortonworks/cloudbreak/pull/9109", "merged": true, "mergeCommit": {"oid": "bf1b3dd71e2e6e24a8a3c82438ada7e3235af2dd"}, "closed": true, "closedAt": "2020-10-06T11:04:50Z", "author": {"login": "oleewere"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdN9YwZABqjM4MjQ3MTczMzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdP2Uq4gFqTUwMjgyMjQ0Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1b770ecd333b3b7199e76aa8a1fa8e7a23ef8b93", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/1b770ecd333b3b7199e76aa8a1fa8e7a23ef8b93", "committedDate": "2020-09-30T11:08:12Z", "message": "CB-9056. Prevent restart of clusters creating new machines user access keys in UMS.\ndetails:\n- create a new column (secret) for cluster in order to store databus access/private keys\n(could not use component table properly with secrets and cluster attributes are not really used I think, so i have created a new one)\n- get this value during salt pillar config update (or during deployment), if not set, generate a new keypair and save it in the cluster entity\n- the exact same thing will be needed for freeipa as well (not needed yet as no salt pillar config upgrade there yet)"}, "afterCommit": {"oid": "5202f294020798d5e5459209ff2d60167ad2affa", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/5202f294020798d5e5459209ff2d60167ad2affa", "committedDate": "2020-09-30T14:09:00Z", "message": "CB-9056. Prevent restart of clusters creating new machines user access keys in UMS.\ndetails:\n- create a new column (secret) for cluster in order to store databus access/private keys\n(could not use component table properly with secrets and cluster attributes are not really used I think, so i have created a new one)\n- get this value during salt pillar config update (or during deployment), if not set, generate a new keypair and save it in the cluster entity\n- the exact same thing will be needed for freeipa as well (not needed yet as no salt pillar config upgrade there yet)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5202f294020798d5e5459209ff2d60167ad2affa", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/5202f294020798d5e5459209ff2d60167ad2affa", "committedDate": "2020-09-30T14:09:00Z", "message": "CB-9056. Prevent restart of clusters creating new machines user access keys in UMS.\ndetails:\n- create a new column (secret) for cluster in order to store databus access/private keys\n(could not use component table properly with secrets and cluster attributes are not really used I think, so i have created a new one)\n- get this value during salt pillar config update (or during deployment), if not set, generate a new keypair and save it in the cluster entity\n- the exact same thing will be needed for freeipa as well (not needed yet as no salt pillar config upgrade there yet)"}, "afterCommit": {"oid": "de4adef7bb6f990bd12a33c549222b29b8901e1e", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/de4adef7bb6f990bd12a33c549222b29b8901e1e", "committedDate": "2020-09-30T16:00:51Z", "message": "CB-9056. Prevent restart of clusters creating new machines user access keys in UMS.\ndetails:\n- create a new column (secret) for cluster in order to store databus access/private keys\n(could not use component table properly with secrets and cluster attributes are not really used I think, so i have created a new one)\n- get this value during salt pillar config update (or during deployment), if not set, generate a new keypair and save it in the cluster entity\n- the exact same thing will be needed for freeipa as well (not needed yet as no salt pillar config upgrade there yet)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "de4adef7bb6f990bd12a33c549222b29b8901e1e", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/de4adef7bb6f990bd12a33c549222b29b8901e1e", "committedDate": "2020-09-30T16:00:51Z", "message": "CB-9056. Prevent restart of clusters creating new machines user access keys in UMS.\ndetails:\n- create a new column (secret) for cluster in order to store databus access/private keys\n(could not use component table properly with secrets and cluster attributes are not really used I think, so i have created a new one)\n- get this value during salt pillar config update (or during deployment), if not set, generate a new keypair and save it in the cluster entity\n- the exact same thing will be needed for freeipa as well (not needed yet as no salt pillar config upgrade there yet)"}, "afterCommit": {"oid": "c7b335d16bad0478cf1c08b34e05a0dcd04a0257", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/c7b335d16bad0478cf1c08b34e05a0dcd04a0257", "committedDate": "2020-10-01T10:23:06Z", "message": "CB-9056. Prevent restart of clusters creating new machines user access keys in UMS.\ndetails:\n- create a new column (secret) for cluster in order to store databus access/private keys + machine user\n(could not use component table properly with secrets and cluster attributes are not really used I think, so i have created a new one)\n- get this value during salt pillar config update (or during deployment), if not set, generate a new keypair and save it in the cluster entity\n- if dbus credential exists in the db, still ... check that against UMS as well, if the access key id or machine user does not exist on UMS side, genereate a new machine user or access key\n- the exact same thing will be needed for freeipa as well (not needed yet as no salt pillar config upgrade there yet)\n\n# Conflicts:\n#\tauth-connector/src/main/java/com/sequenceiq/cloudbreak/auth/altus/service/AltusIAMService.java"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c7b335d16bad0478cf1c08b34e05a0dcd04a0257", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/c7b335d16bad0478cf1c08b34e05a0dcd04a0257", "committedDate": "2020-10-01T10:23:06Z", "message": "CB-9056. Prevent restart of clusters creating new machines user access keys in UMS.\ndetails:\n- create a new column (secret) for cluster in order to store databus access/private keys + machine user\n(could not use component table properly with secrets and cluster attributes are not really used I think, so i have created a new one)\n- get this value during salt pillar config update (or during deployment), if not set, generate a new keypair and save it in the cluster entity\n- if dbus credential exists in the db, still ... check that against UMS as well, if the access key id or machine user does not exist on UMS side, genereate a new machine user or access key\n- the exact same thing will be needed for freeipa as well (not needed yet as no salt pillar config upgrade there yet)\n\n# Conflicts:\n#\tauth-connector/src/main/java/com/sequenceiq/cloudbreak/auth/altus/service/AltusIAMService.java"}, "afterCommit": {"oid": "ff9f605e06d55399da933e12e54ee3234ed03eb6", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/ff9f605e06d55399da933e12e54ee3234ed03eb6", "committedDate": "2020-10-01T10:38:01Z", "message": "CB-9056. Prevent restart of clusters creating new machines user access keys in UMS.\ndetails:\n- create a new column (secret) for cluster in order to store databus access/private keys + machine user\n(could not use component table properly with secrets and cluster attributes are not really used I think, so i have created a new one)\n- get this value during salt pillar config update (or during deployment), if not set, generate a new keypair and save it in the cluster entity\n- if dbus credential exists in the db, still ... check that against UMS as well, if the access key id or machine user does not exist on UMS side, genereate a new machine user or access key\n- the exact same thing will be needed for freeipa as well (not needed yet as no salt pillar config upgrade there yet)\n\n# Conflicts:\n#\tauth-connector/src/main/java/com/sequenceiq/cloudbreak/auth/altus/service/AltusIAMService.java"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ff9f605e06d55399da933e12e54ee3234ed03eb6", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/ff9f605e06d55399da933e12e54ee3234ed03eb6", "committedDate": "2020-10-01T10:38:01Z", "message": "CB-9056. Prevent restart of clusters creating new machines user access keys in UMS.\ndetails:\n- create a new column (secret) for cluster in order to store databus access/private keys + machine user\n(could not use component table properly with secrets and cluster attributes are not really used I think, so i have created a new one)\n- get this value during salt pillar config update (or during deployment), if not set, generate a new keypair and save it in the cluster entity\n- if dbus credential exists in the db, still ... check that against UMS as well, if the access key id or machine user does not exist on UMS side, genereate a new machine user or access key\n- the exact same thing will be needed for freeipa as well (not needed yet as no salt pillar config upgrade there yet)\n\n# Conflicts:\n#\tauth-connector/src/main/java/com/sequenceiq/cloudbreak/auth/altus/service/AltusIAMService.java"}, "afterCommit": {"oid": "e128612b7ed269492c0655d66453a28d1f115df7", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/e128612b7ed269492c0655d66453a28d1f115df7", "committedDate": "2020-10-02T16:11:16Z", "message": "CB-9056. Prevent restart of clusters creating new machines user access keys in UMS.\ndetails:\n- create a new column (secret) for cluster in order to store databus access/private keys + machine user\n(could not use component table properly with secrets and cluster attributes are not really used I think, so i have created a new one)\n- get this value during salt pillar config update (or during deployment), if not set, generate a new keypair and save it in the cluster entity\n- if dbus credential exists in the db, still ... check that against UMS as well, if the access key id or machine user does not exist on UMS side, genereate a new machine user or access key\n- the exact same thing will be needed for freeipa as well (not needed yet as no salt pillar config upgrade there yet)\n\n# Conflicts:\n#\tauth-connector/src/main/java/com/sequenceiq/cloudbreak/auth/altus/service/AltusIAMService.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxODQ4NDky", "url": "https://github.com/hortonworks/cloudbreak/pull/9109#pullrequestreview-501848492", "createdAt": "2020-10-05T08:55:41Z", "commit": {"oid": "e128612b7ed269492c0655d66453a28d1f115df7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwODo1NTo0MVrOHcTiqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwODo1NTo0MVrOHcTiqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTQ0MjM0Ng==", "bodyText": "Isn't there a cheaper method of validating wether and access key exists or works?\nGetAccessKeyVerificationData? I'm not sure it's better, but listing all keys seems tedious.", "url": "https://github.com/hortonworks/cloudbreak/pull/9109#discussion_r499442346", "createdAt": "2020-10-05T08:55:41Z", "author": {"login": "lnardai"}, "path": "auth-connector/src/main/java/com/sequenceiq/cloudbreak/auth/altus/GrpcUmsClient.java", "diffHunk": "@@ -640,6 +640,24 @@ public void deleteMachineUserAccessKeys(String actorCrn, String accountId, Strin\n         }\n     }\n \n+    /**\n+     * Check that machine user has a specific access key in UMS\n+     * @param actorCrn actor for the machine user request\n+     * @param accountId the account ID\n+     * @param machineUserCrn machine user crn that own the access key\n+     * @param accessKeyId access key id that we need to check\n+     * @return result that is true if the machine user has the queried access key in UMS\n+     */\n+    public boolean doesMachineUserHasAccessKey(String actorCrn, String accountId,\n+            String machineUserCrn, String accessKeyId) {\n+        try (ManagedChannelWrapper channelWrapper = makeWrapper()) {\n+            UmsClient client = makeClient(channelWrapper.getChannel(), actorCrn);\n+            String requestId = UUID.randomUUID().toString();\n+            List<String> accessKeys = client.listMachineUserAccessKeys(requestId, actorCrn, accountId, machineUserCrn, true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e128612b7ed269492c0655d66453a28d1f115df7"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxODkzNjQ5", "url": "https://github.com/hortonworks/cloudbreak/pull/9109#pullrequestreview-501893649", "createdAt": "2020-10-05T09:51:36Z", "commit": {"oid": "e128612b7ed269492c0655d66453a28d1f115df7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwOTo1MTozNlrOHcVp7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwOTo1MTozNlrOHcVp7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTQ3Njk3Mg==", "bodyText": "It's quite confusing that you did not kept the order of variables but used the same name for the method! Somewhere the actorCrn is first, but here machineUserName is the first sine. Since we are only using strings here it's easy to misuse these methods.", "url": "https://github.com/hortonworks/cloudbreak/pull/9109#discussion_r499476972", "createdAt": "2020-10-05T09:51:36Z", "author": {"login": "lnardai"}, "path": "auth-connector/src/main/java/com/sequenceiq/cloudbreak/auth/altus/service/AltusIAMService.java", "diffHunk": "@@ -40,6 +40,27 @@ public AltusIAMService(GrpcUmsClient umsClient,\n                         UserManagementProto.AccessKeyType.Value.ED25519)));\n     }\n \n+    /**\n+     * Checks that machine user has a specific access key on UMS side\n+     */\n+    public boolean doesMachineUserHasAccessKey(String machineUserName, String accessKey, String actorCrn, String accountId,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e128612b7ed269492c0655d66453a28d1f115df7"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e733188cfcefcb969aad98e890cc24e611f152ed", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/e733188cfcefcb969aad98e890cc24e611f152ed", "committedDate": "2020-10-05T13:10:31Z", "message": "CB-9056. Prevent restart of clusters creating new machines user access keys in UMS.\ndetails:\n- create a new column (secret) for cluster in order to store databus access/private keys + machine user\n(could not use component table properly with secrets and cluster attributes are not really used I think, so i have created a new one)\n- get this value during salt pillar config update (or during deployment), if not set, generate a new keypair and save it in the cluster entity\n- if dbus credential exists in the db, still ... check that against UMS as well, if the access key id or machine user does not exist on UMS side, genereate a new machine user or access key\n- the exact same thing will be needed for freeipa as well (not needed yet as no salt pillar config upgrade there yet)\n\n# Conflicts:\n#\tauth-connector/src/main/java/com/sequenceiq/cloudbreak/auth/altus/service/AltusIAMService.java"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e128612b7ed269492c0655d66453a28d1f115df7", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/e128612b7ed269492c0655d66453a28d1f115df7", "committedDate": "2020-10-02T16:11:16Z", "message": "CB-9056. Prevent restart of clusters creating new machines user access keys in UMS.\ndetails:\n- create a new column (secret) for cluster in order to store databus access/private keys + machine user\n(could not use component table properly with secrets and cluster attributes are not really used I think, so i have created a new one)\n- get this value during salt pillar config update (or during deployment), if not set, generate a new keypair and save it in the cluster entity\n- if dbus credential exists in the db, still ... check that against UMS as well, if the access key id or machine user does not exist on UMS side, genereate a new machine user or access key\n- the exact same thing will be needed for freeipa as well (not needed yet as no salt pillar config upgrade there yet)\n\n# Conflicts:\n#\tauth-connector/src/main/java/com/sequenceiq/cloudbreak/auth/altus/service/AltusIAMService.java"}, "afterCommit": {"oid": "e733188cfcefcb969aad98e890cc24e611f152ed", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/e733188cfcefcb969aad98e890cc24e611f152ed", "committedDate": "2020-10-05T13:10:31Z", "message": "CB-9056. Prevent restart of clusters creating new machines user access keys in UMS.\ndetails:\n- create a new column (secret) for cluster in order to store databus access/private keys + machine user\n(could not use component table properly with secrets and cluster attributes are not really used I think, so i have created a new one)\n- get this value during salt pillar config update (or during deployment), if not set, generate a new keypair and save it in the cluster entity\n- if dbus credential exists in the db, still ... check that against UMS as well, if the access key id or machine user does not exist on UMS side, genereate a new machine user or access key\n- the exact same thing will be needed for freeipa as well (not needed yet as no salt pillar config upgrade there yet)\n\n# Conflicts:\n#\tauth-connector/src/main/java/com/sequenceiq/cloudbreak/auth/altus/service/AltusIAMService.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyODIyNDQz", "url": "https://github.com/hortonworks/cloudbreak/pull/9109#pullrequestreview-502822443", "createdAt": "2020-10-06T11:03:33Z", "commit": {"oid": "e733188cfcefcb969aad98e890cc24e611f152ed"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2258, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}