{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI2MzYwODc5", "number": 9503, "title": "CB-9957 in case of DH cluster we can provision external databases. Th\u2026", "bodyText": "\u2026e problem was that somehow the external db reference was null. We should investigate further how it caused but this fix is basically checking the existence of the external rds crn before initiate the start/stop/delete.\nSee detailed description in the commit message.", "createdAt": "2020-11-24T10:06:05Z", "url": "https://github.com/hortonworks/cloudbreak/pull/9503", "merged": true, "mergeCommit": {"oid": "1518ca02a90ae1f60f9353111eba91140a5e5e2e"}, "closed": true, "closedAt": "2020-11-24T11:24:18Z", "author": {"login": "doktoric"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdfm5ycAFqTUzNzMzMjY5Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdfnGprgFqTUzNzM0NTUwMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3MzMyNjky", "url": "https://github.com/hortonworks/cloudbreak/pull/9503#pullrequestreview-537332692", "createdAt": "2020-11-24T10:08:24Z", "commit": {"oid": "2e4f0ffaf2a9e3bef6196325599ccc92b11f57e8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxMDowODoyNFrOH43qoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxMDowODoyNFrOH43qoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTM5NDMzNw==", "bodyText": "please set as private", "url": "https://github.com/hortonworks/cloudbreak/pull/9503#discussion_r529394337", "createdAt": "2020-11-24T10:08:24Z", "author": {"login": "bergerdenes"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/core/flow2/externaldatabase/ExternalDatabaseService.java", "diffHunk": "@@ -87,20 +92,32 @@ public void startDatabase(Cluster cluster, DatabaseAvailabilityType externalData\n                 externalDatabase.name(), environment.getName(), cluster.getName());\n         String databaseCrn = cluster.getDatabaseServerCrn();\n         try {\n-            redbeamsClient.startByCrn(databaseCrn);\n-            waitAndGetDatabase(cluster, databaseCrn, DatabaseOperation.START, false);\n+            if (externalDatabaseReferenceExist(databaseCrn)) {\n+                redbeamsClient.startByCrn(databaseCrn);\n+                waitAndGetDatabase(cluster, databaseCrn, DatabaseOperation.START, false);\n+            } else {\n+                LOGGER.warn(\"[INVESTIGATE] The external database type was {} but there was no crn\", externalDatabase);\n+            }\n         } catch (NotFoundException notFoundException) {\n             LOGGER.info(\"Database server not found on redbeams side {}\", databaseCrn);\n         }\n     }\n \n+    public boolean externalDatabaseReferenceExist(String databaseCrn) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e4f0ffaf2a9e3bef6196325599ccc92b11f57e8"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3MzMyODQy", "url": "https://github.com/hortonworks/cloudbreak/pull/9503#pullrequestreview-537332842", "createdAt": "2020-11-24T10:08:35Z", "commit": {"oid": "2e4f0ffaf2a9e3bef6196325599ccc92b11f57e8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "def8d4cde79f7e73b6f734e15afd739528d705f4", "author": {"user": {"login": "doktoric", "name": "Richard Doktorics"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/def8d4cde79f7e73b6f734e15afd739528d705f4", "committedDate": "2020-11-24T10:17:35Z", "message": "CB-9957 in case of DH cluster we can provision external databases. The problem was that somehow the external db reference was null. We should investigate further how it caused but this fix is basically checking the existence of the external rds crn before initiate the start/stop/delete."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2e4f0ffaf2a9e3bef6196325599ccc92b11f57e8", "author": {"user": {"login": "doktoric", "name": "Richard Doktorics"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/2e4f0ffaf2a9e3bef6196325599ccc92b11f57e8", "committedDate": "2020-11-24T10:04:31Z", "message": "CB-9957 in case of DH cluster we can provision external databases. The problem was that somehow the external db reference was null. We should investigate further how it caused but this fix is basically checking the existence of the external rds crn before initiate the start/stop/delete."}, "afterCommit": {"oid": "def8d4cde79f7e73b6f734e15afd739528d705f4", "author": {"user": {"login": "doktoric", "name": "Richard Doktorics"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/def8d4cde79f7e73b6f734e15afd739528d705f4", "committedDate": "2020-11-24T10:17:35Z", "message": "CB-9957 in case of DH cluster we can provision external databases. The problem was that somehow the external db reference was null. We should investigate further how it caused but this fix is basically checking the existence of the external rds crn before initiate the start/stop/delete."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3MzQ1NTAz", "url": "https://github.com/hortonworks/cloudbreak/pull/9503#pullrequestreview-537345503", "createdAt": "2020-11-24T10:22:26Z", "commit": {"oid": "def8d4cde79f7e73b6f734e15afd739528d705f4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxMDoyMjoyN1rOH44uQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxMDoyMjoyN1rOH44uQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTQxMTY0OQ==", "bodyText": "Not sure if the MDCcontext is correct at these places, but if not then probably it would be better to include more information in the logs, like data hub name or crn.", "url": "https://github.com/hortonworks/cloudbreak/pull/9503#discussion_r529411649", "createdAt": "2020-11-24T10:22:27Z", "author": {"login": "keyki"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/core/flow2/externaldatabase/ExternalDatabaseService.java", "diffHunk": "@@ -99,13 +108,21 @@ public void stopDatabase(Cluster cluster, DatabaseAvailabilityType externalDatab\n                 externalDatabase.name(), environment.getName(), cluster.getName());\n         String databaseCrn = cluster.getDatabaseServerCrn();\n         try {\n-            redbeamsClient.stopByCrn(databaseCrn);\n-            waitAndGetDatabase(cluster, databaseCrn, DatabaseOperation.STOP, false);\n+            if (externalDatabaseReferenceExist(databaseCrn)) {\n+                redbeamsClient.stopByCrn(databaseCrn);\n+                waitAndGetDatabase(cluster, databaseCrn, DatabaseOperation.STOP, false);\n+            } else {\n+                LOGGER.warn(\"[INVESTIGATE] The external database type was {} but there was no crn\", externalDatabase);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "def8d4cde79f7e73b6f734e15afd739528d705f4"}, "originalPosition": 48}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2040, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}