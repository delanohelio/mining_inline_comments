{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAzNTIxODU1", "number": 7795, "title": "CB-6497: Update Nginx config and other setup for freeipa healthagent", "bodyText": "This patch adds a new Nginx config, and several salt setup scripts\nto enable the new FreeIpa health agent to run.  The agent will\nbe installed as an RPM and will be a separate code review. CB-6399\nManually tested on 1,2, and 3 node FreeIPA clusters.", "createdAt": "2020-04-15T03:35:14Z", "url": "https://github.com/hortonworks/cloudbreak/pull/7795", "merged": true, "mergeCommit": {"oid": "afeb8f6cc2c695818a3335ae324bbb08688b8e9d"}, "closed": true, "closedAt": "2020-04-21T15:31:15Z", "author": {"login": "holleyism"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcXyu9QgFqTM5MzUxMDAwNg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcZ1cY9AFqTM5NzQ0ODA4Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzNTEwMDA2", "url": "https://github.com/hortonworks/cloudbreak/pull/7795#pullrequestreview-393510006", "createdAt": "2020-04-15T07:12:53Z", "commit": {"oid": "7d61cf9f116c837b96033686672690f7ea95018a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQwNzoxMjo1M1rOGFspDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQwNzoxMjo1M1rOGFspDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODYyNzQ2OQ==", "bodyText": "I'm not sure it's a good idea to put a new folder under /. Couldn't we just put it under /opt somewhere?", "url": "https://github.com/hortonworks/cloudbreak/pull/7795#discussion_r408627469", "createdAt": "2020-04-15T07:12:53Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/resources/freeipa-salt/salt/freeipa/init.sls", "diffHunk": "@@ -18,6 +18,16 @@ net.ipv6.conf.lo.disable_ipv6:\n       - {{ host['fqdn'] }}\n {% endfor %}\n \n+{% if salt['pillar.get']('freeipa:hosts') > 1 %}\n+/cdp/ipahealthagent/freeipa_cluster_node:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d61cf9f116c837b96033686672690f7ea95018a"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzNTIxMzcy", "url": "https://github.com/hortonworks/cloudbreak/pull/7795#pullrequestreview-393521372", "createdAt": "2020-04-15T07:30:57Z", "commit": {"oid": "7d61cf9f116c837b96033686672690f7ea95018a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQwNzozMDo1N1rOGFtN2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQwNzozMDo1N1rOGFtN2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODYzNjg4OQ==", "bodyText": "do we really need a separate file for this unless?", "url": "https://github.com/hortonworks/cloudbreak/pull/7795#discussion_r408636889", "createdAt": "2020-04-15T07:30:57Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/resources/freeipa-salt/salt/freeipa/common-install.sls", "diffHunk": "@@ -65,3 +65,20 @@ restart_httpd:\n     - watch:\n       - file: /etc/httpd/conf.d/ipa-rewrite.conf\n \n+install-healthagent:\n+  cmd.run:\n+    - name: /opt/salt/scripts/freeipa_healthagent_setup.sh\n+    - env:\n+        - FPW: {{salt['pillar.get']('freeipa:password')}}\n+    - failhard: True\n+    - unless: /opt/salt/scripts/freeipa_check_replication.sh", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d61cf9f116c837b96033686672690f7ea95018a"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0MzgwMzM5", "url": "https://github.com/hortonworks/cloudbreak/pull/7795#pullrequestreview-394380339", "createdAt": "2020-04-16T07:50:50Z", "commit": {"oid": "7d61cf9f116c837b96033686672690f7ea95018a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwNzo1MDo1MFrOGGY2Yg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwNzo1MDo1MFrOGGY2Yg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM1MTc3OA==", "bodyText": "does it cause any issue on a system which doesn't have the agent installed?", "url": "https://github.com/hortonworks/cloudbreak/pull/7795#discussion_r409351778", "createdAt": "2020-04-16T07:50:50Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/resources/freeipa-salt/salt/freeipa/scripts/freeipa_healthagent_setup.sh", "diffHunk": "@@ -0,0 +1,20 @@\n+#!/usr/bin/env bash\n+\n+set -e\n+\n+#\n+# Add anonymous access only for replication agreements\n+#\n+export HOSTCN=`hostname -f| sed -E 's/^|\\./,dc=/g' | sed 's/^,[^,]*,//g'`\n+\n+ldapmodify -x -D \"cn=directory manager\" -w $FPW  -h $HOSTNAME << EOF\n+dn: cn=\"$HOSTCN\",cn=mapping tree,cn=config\n+changetype: modify\n+add: aci\n+aci: (targetattr=*)(targetfilter=\"(|(objectclass=nsds5replicationagreement)(objectclass=nsDSWindowsReplicationAgreement))\")(version 3.0; aci \"permission:Read Replication Agreements\"; allow (read, search, compare) groupdn = \"ldap:///anyone\";)\n+EOF\n+\n+#\n+# Add the cert extraction to run when the certificate is updated\n+#\n+ipa-getcert start-tracking -n Server-Cert -d /etc/httpd/alias -C \"/usr/libexec/ipa/certmonger/restart_httpd;systemctl restart freeipa_healthagent\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d61cf9f116c837b96033686672690f7ea95018a"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0MzgzMzE1", "url": "https://github.com/hortonworks/cloudbreak/pull/7795#pullrequestreview-394383315", "createdAt": "2020-04-16T07:54:48Z", "commit": {"oid": "7d61cf9f116c837b96033686672690f7ea95018a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwNzo1NDo0OFrOGGZAaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwNzo1NDo0OFrOGGZAaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM1NDM0NA==", "bodyText": "using hostname -d would simplify the sed a bit I think", "url": "https://github.com/hortonworks/cloudbreak/pull/7795#discussion_r409354344", "createdAt": "2020-04-16T07:54:48Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/resources/freeipa-salt/salt/freeipa/scripts/freeipa_healthagent_setup.sh", "diffHunk": "@@ -0,0 +1,20 @@\n+#!/usr/bin/env bash\n+\n+set -e\n+\n+#\n+# Add anonymous access only for replication agreements\n+#\n+export HOSTCN=`hostname -f| sed -E 's/^|\\./,dc=/g' | sed 's/^,[^,]*,//g'`", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d61cf9f116c837b96033686672690f7ea95018a"}, "originalPosition": 8}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7d61cf9f116c837b96033686672690f7ea95018a", "author": {"user": {"login": "holleyism", "name": "Adam Holley"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/7d61cf9f116c837b96033686672690f7ea95018a", "committedDate": "2020-04-15T03:32:18Z", "message": "CB-6497: Update Nginx config and other setup for freeipa healthagent\n\nThis patch adds a new Nginx config, and several salt setup scripts\nto enable the new FreeIpa health agent to run.  The agent will\nbe installed as an RPM and will be a separate code review. CB-6399"}, "afterCommit": {"oid": "cdc9d02274f7002f6c66bc9d48e6d6985cee398d", "author": {"user": {"login": "holleyism", "name": "Adam Holley"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/cdc9d02274f7002f6c66bc9d48e6d6985cee398d", "committedDate": "2020-04-16T14:15:38Z", "message": "CB-6497: Update Nginx config and other setup for freeipa healthagent\n\nThis patch adds a new Nginx config, and several salt setup scripts\nto enable the new FreeIpa health agent to run.  The agent will\nbe installed as an RPM and will be a separate code review. CB-6399"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0ODM4MDgz", "url": "https://github.com/hortonworks/cloudbreak/pull/7795#pullrequestreview-394838083", "createdAt": "2020-04-16T17:13:25Z", "commit": {"oid": "cdc9d02274f7002f6c66bc9d48e6d6985cee398d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf6e38f4fba74e26eccf1fd8a590c581c2f49050", "author": {"user": {"login": "holleyism", "name": "Adam Holley"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/bf6e38f4fba74e26eccf1fd8a590c581c2f49050", "committedDate": "2020-04-20T14:03:24Z", "message": "CB-6497: Update Nginx config and other setup for freeipa healthagent\n\nThis patch adds a new Nginx config, and several salt setup scripts\nto enable the new FreeIpa health agent to run.  The agent will\nbe installed as an RPM and will be a separate code review. CB-6399"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cdc9d02274f7002f6c66bc9d48e6d6985cee398d", "author": {"user": {"login": "holleyism", "name": "Adam Holley"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/cdc9d02274f7002f6c66bc9d48e6d6985cee398d", "committedDate": "2020-04-16T14:15:38Z", "message": "CB-6497: Update Nginx config and other setup for freeipa healthagent\n\nThis patch adds a new Nginx config, and several salt setup scripts\nto enable the new FreeIpa health agent to run.  The agent will\nbe installed as an RPM and will be a separate code review. CB-6399"}, "afterCommit": {"oid": "bf6e38f4fba74e26eccf1fd8a590c581c2f49050", "author": {"user": {"login": "holleyism", "name": "Adam Holley"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/bf6e38f4fba74e26eccf1fd8a590c581c2f49050", "committedDate": "2020-04-20T14:03:24Z", "message": "CB-6497: Update Nginx config and other setup for freeipa healthagent\n\nThis patch adds a new Nginx config, and several salt setup scripts\nto enable the new FreeIpa health agent to run.  The agent will\nbe installed as an RPM and will be a separate code review. CB-6399"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NDQ4MDgz", "url": "https://github.com/hortonworks/cloudbreak/pull/7795#pullrequestreview-397448083", "createdAt": "2020-04-21T15:30:10Z", "commit": {"oid": "bf6e38f4fba74e26eccf1fd8a590c581c2f49050"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2327, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}