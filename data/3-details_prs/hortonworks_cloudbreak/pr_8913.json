{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc3OTg4ODMw", "number": 8913, "title": "CB-8611. Implement CB flow for CM based diagnostics collection (DistroX)", "bodyText": "some UTs will be needed for these changes as well, see description in the commit message", "createdAt": "2020-09-02T17:11:03Z", "url": "https://github.com/hortonworks/cloudbreak/pull/8913", "merged": true, "mergeCommit": {"oid": "3b3e04ca933b6539bafd53924824d873aa417161"}, "closed": true, "closedAt": "2020-09-07T12:00:22Z", "author": {"login": "oleewere"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdFTZkjgBqjM3MjU2NDM4MTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdGhwKJgFqTQ4MzUwMDQyNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "46c84f500b6cf00da2c90d45dc604df169e3392f", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/46c84f500b6cf00da2c90d45dc604df169e3392f", "committedDate": "2020-09-02T17:09:52Z", "message": "CB-8611. Implement CB flow for CM based diagnostics collection (DistroX)"}, "afterCommit": {"oid": "fa8e4dfca64f9c08e610e3a2d8c875d79850afda", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/fa8e4dfca64f9c08e610e3a2d8c875d79850afda", "committedDate": "2020-09-03T16:42:18Z", "message": "CB-8611. Implement CB flow for CM based diagnostics collection (DistroX)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fa8e4dfca64f9c08e610e3a2d8c875d79850afda", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/fa8e4dfca64f9c08e610e3a2d8c875d79850afda", "committedDate": "2020-09-03T16:42:18Z", "message": "CB-8611. Implement CB flow for CM based diagnostics collection (DistroX)"}, "afterCommit": {"oid": "490b4f5d41934e51ddf71357a4e28aa97f37f0ee", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/490b4f5d41934e51ddf71357a4e28aa97f37f0ee", "committedDate": "2020-09-03T18:48:37Z", "message": "CB-8611. Implement CB flow for CM based diagnostics collection (DistroX)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "490b4f5d41934e51ddf71357a4e28aa97f37f0ee", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/490b4f5d41934e51ddf71357a4e28aa97f37f0ee", "committedDate": "2020-09-03T18:48:37Z", "message": "CB-8611. Implement CB flow for CM based diagnostics collection (DistroX)"}, "afterCommit": {"oid": "f7aaeb95bc9b32a12e69d450ee9dbf3a71227067", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/f7aaeb95bc9b32a12e69d450ee9dbf3a71227067", "committedDate": "2020-09-04T17:57:04Z", "message": "CB-8611. Implement CB flow for CM based diagnostics collection (DistroX)\ndetails:\n- adding new CM based diagnostics flow for distrox & stack (stack api will be used for SDX flow)\n= flow has 4 steps (similar as filecollector based), init/collect/upload/cleanup\n- init/upload/cleanup steps are reused from the filecollector flow (initialization: create required configs for filecollector, upload - send data to cloud storage, cleanup - delete files from filecollector location)\n- collect phase: run diagnostics command against CM, wait for it to finish, then copy collected file from /tmp folder (to fit into the filecollector flow, so we can upload the file)\n- disable PHONE_HOME parameter globally for CM, there is no phone home option for the Api command, so that's the easiest way\n- adding roles endpoint in order to know what roles can be filtered"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f7aaeb95bc9b32a12e69d450ee9dbf3a71227067", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/f7aaeb95bc9b32a12e69d450ee9dbf3a71227067", "committedDate": "2020-09-04T17:57:04Z", "message": "CB-8611. Implement CB flow for CM based diagnostics collection (DistroX)\ndetails:\n- adding new CM based diagnostics flow for distrox & stack (stack api will be used for SDX flow)\n= flow has 4 steps (similar as filecollector based), init/collect/upload/cleanup\n- init/upload/cleanup steps are reused from the filecollector flow (initialization: create required configs for filecollector, upload - send data to cloud storage, cleanup - delete files from filecollector location)\n- collect phase: run diagnostics command against CM, wait for it to finish, then copy collected file from /tmp folder (to fit into the filecollector flow, so we can upload the file)\n- disable PHONE_HOME parameter globally for CM, there is no phone home option for the Api command, so that's the easiest way\n- adding roles endpoint in order to know what roles can be filtered"}, "afterCommit": {"oid": "8e0551fc33856e8bde6774abaff70933b24446c0", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/8e0551fc33856e8bde6774abaff70933b24446c0", "committedDate": "2020-09-04T18:07:56Z", "message": "CB-8611. Implement CB flow for CM based diagnostics collection (DistroX)\ndetails:\n- adding new CM based diagnostics flow for distrox & stack (stack api will be used for SDX flow)\n= flow has 4 steps (similar as filecollector based), init/collect/upload/cleanup\n- init/upload/cleanup steps are reused from the filecollector flow (initialization: create required configs for filecollector, upload - send data to cloud storage, cleanup - delete files from filecollector location)\n- collect phase: run diagnostics command against CM, wait for it to finish, then copy collected file from /tmp folder (to fit into the filecollector flow, so we can upload the file)\n- disable PHONE_HOME parameter globally for CM, there is no phone home option for the Api command, so that's the easiest way\n- adding roles endpoint in order to know what roles can be filtered"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8e0551fc33856e8bde6774abaff70933b24446c0", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/8e0551fc33856e8bde6774abaff70933b24446c0", "committedDate": "2020-09-04T18:07:56Z", "message": "CB-8611. Implement CB flow for CM based diagnostics collection (DistroX)\ndetails:\n- adding new CM based diagnostics flow for distrox & stack (stack api will be used for SDX flow)\n= flow has 4 steps (similar as filecollector based), init/collect/upload/cleanup\n- init/upload/cleanup steps are reused from the filecollector flow (initialization: create required configs for filecollector, upload - send data to cloud storage, cleanup - delete files from filecollector location)\n- collect phase: run diagnostics command against CM, wait for it to finish, then copy collected file from /tmp folder (to fit into the filecollector flow, so we can upload the file)\n- disable PHONE_HOME parameter globally for CM, there is no phone home option for the Api command, so that's the easiest way\n- adding roles endpoint in order to know what roles can be filtered"}, "afterCommit": {"oid": "98766359af3fe8704c7e9bb9c713a9969fb033b7", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/98766359af3fe8704c7e9bb9c713a9969fb033b7", "committedDate": "2020-09-04T18:26:12Z", "message": "CB-8611. Implement CB flow for CM based diagnostics collection (DistroX)\ndetails:\n- adding new CM based diagnostics flow for distrox & stack (stack api will be used for SDX flow)\n= flow has 4 steps (similar as filecollector based), init/collect/upload/cleanup\n- init/upload/cleanup steps are reused from the filecollector flow (initialization: create required configs for filecollector, upload - send data to cloud storage, cleanup - delete files from filecollector location)\n- collect phase: run diagnostics command against CM, wait for it to finish, then copy collected file from /tmp folder (to fit into the filecollector flow, so we can upload the file)\n- disable PHONE_HOME parameter globally for CM, there is no phone home option for the Api command, so that's the easiest way\n- adding roles endpoint in order to know what roles can be filtered"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "98766359af3fe8704c7e9bb9c713a9969fb033b7", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/98766359af3fe8704c7e9bb9c713a9969fb033b7", "committedDate": "2020-09-04T18:26:12Z", "message": "CB-8611. Implement CB flow for CM based diagnostics collection (DistroX)\ndetails:\n- adding new CM based diagnostics flow for distrox & stack (stack api will be used for SDX flow)\n= flow has 4 steps (similar as filecollector based), init/collect/upload/cleanup\n- init/upload/cleanup steps are reused from the filecollector flow (initialization: create required configs for filecollector, upload - send data to cloud storage, cleanup - delete files from filecollector location)\n- collect phase: run diagnostics command against CM, wait for it to finish, then copy collected file from /tmp folder (to fit into the filecollector flow, so we can upload the file)\n- disable PHONE_HOME parameter globally for CM, there is no phone home option for the Api command, so that's the easiest way\n- adding roles endpoint in order to know what roles can be filtered"}, "afterCommit": {"oid": "aa3ebd48efc9ae0755cfd0ca095bf365d1101955", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/aa3ebd48efc9ae0755cfd0ca095bf365d1101955", "committedDate": "2020-09-07T08:11:04Z", "message": "CB-8611. Implement CB flow for CM based diagnostics collection (DistroX)\ndetails:\n- adding new CM based diagnostics flow for distrox & stack (stack api will be used for SDX flow)\n= flow has 4 steps (similar as filecollector based), init/collect/upload/cleanup\n- init/upload/cleanup steps are reused from the filecollector flow (initialization: create required configs for filecollector, upload - send data to cloud storage, cleanup - delete files from filecollector location)\n- collect phase: run diagnostics command against CM, wait for it to finish, then copy collected file from /tmp folder (to fit into the filecollector flow, so we can upload the file)\n- disable PHONE_HOME parameter globally for CM, there is no phone home option for the Api command, so that's the easiest way\n- adding roles endpoint in order to know what roles can be filtered"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "753353f32edced1debb744c87b5483e6aa8f32c1", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/753353f32edced1debb744c87b5483e6aa8f32c1", "committedDate": "2020-09-07T09:18:45Z", "message": "CB-8611. Implement CB flow for CM based diagnostics collection (DistroX)\ndetails:\n- adding new CM based diagnostics flow for distrox & stack (stack api will be used for SDX flow)\n= flow has 4 steps (similar as filecollector based), init/collect/upload/cleanup\n- init/upload/cleanup steps are reused from the filecollector flow (initialization: create required configs for filecollector, upload - send data to cloud storage, cleanup - delete files from filecollector location)\n- collect phase: run diagnostics command against CM, wait for it to finish, then copy collected file from /tmp folder (to fit into the filecollector flow, so we can upload the file)\n- disable PHONE_HOME parameter globally for CM, there is no phone home option for the Api command, so that's the easiest way\n- adding roles endpoint in order to know what roles can be filtered"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "aa3ebd48efc9ae0755cfd0ca095bf365d1101955", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/aa3ebd48efc9ae0755cfd0ca095bf365d1101955", "committedDate": "2020-09-07T08:11:04Z", "message": "CB-8611. Implement CB flow for CM based diagnostics collection (DistroX)\ndetails:\n- adding new CM based diagnostics flow for distrox & stack (stack api will be used for SDX flow)\n= flow has 4 steps (similar as filecollector based), init/collect/upload/cleanup\n- init/upload/cleanup steps are reused from the filecollector flow (initialization: create required configs for filecollector, upload - send data to cloud storage, cleanup - delete files from filecollector location)\n- collect phase: run diagnostics command against CM, wait for it to finish, then copy collected file from /tmp folder (to fit into the filecollector flow, so we can upload the file)\n- disable PHONE_HOME parameter globally for CM, there is no phone home option for the Api command, so that's the easiest way\n- adding roles endpoint in order to know what roles can be filtered"}, "afterCommit": {"oid": "753353f32edced1debb744c87b5483e6aa8f32c1", "author": {"user": {"login": "oleewere", "name": "Oliv\u00e9r Szabo"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/753353f32edced1debb744c87b5483e6aa8f32c1", "committedDate": "2020-09-07T09:18:45Z", "message": "CB-8611. Implement CB flow for CM based diagnostics collection (DistroX)\ndetails:\n- adding new CM based diagnostics flow for distrox & stack (stack api will be used for SDX flow)\n= flow has 4 steps (similar as filecollector based), init/collect/upload/cleanup\n- init/upload/cleanup steps are reused from the filecollector flow (initialization: create required configs for filecollector, upload - send data to cloud storage, cleanup - delete files from filecollector location)\n- collect phase: run diagnostics command against CM, wait for it to finish, then copy collected file from /tmp folder (to fit into the filecollector flow, so we can upload the file)\n- disable PHONE_HOME parameter globally for CM, there is no phone home option for the Api command, so that's the easiest way\n- adding roles endpoint in order to know what roles can be filtered"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzNDkwODcy", "url": "https://github.com/hortonworks/cloudbreak/pull/8913#pullrequestreview-483490872", "createdAt": "2020-09-07T11:43:23Z", "commit": {"oid": "753353f32edced1debb744c87b5483e6aa8f32c1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QxMTo0MzoyNFrOHN8MvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QxMTo0MzoyNFrOHN8MvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDM3OTgzNw==", "bodyText": "a log would be nice here. \"starting polling blabla...\" or something", "url": "https://github.com/hortonworks/cloudbreak/pull/8913#discussion_r484379837", "createdAt": "2020-09-07T11:43:24Z", "author": {"login": "attilapalfi92"}, "path": "cluster-cm/src/main/java/com/sequenceiq/cloudbreak/cm/ClouderaManagerDiagnosticsService.java", "diffHunk": "@@ -0,0 +1,108 @@\n+package com.sequenceiq.cloudbreak.cm;\n+\n+import static com.sequenceiq.cloudbreak.polling.PollingResult.isExited;\n+import static com.sequenceiq.cloudbreak.polling.PollingResult.isTimeout;\n+\n+import java.math.BigDecimal;\n+\n+import javax.annotation.PostConstruct;\n+import javax.inject.Inject;\n+\n+import org.apache.commons.collections.CollectionUtils;\n+import org.joda.time.DateTime;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.context.annotation.Scope;\n+import org.springframework.stereotype.Service;\n+\n+import com.cloudera.api.swagger.ClouderaManagerResourceApi;\n+import com.cloudera.api.swagger.client.ApiClient;\n+import com.cloudera.api.swagger.client.ApiException;\n+import com.cloudera.api.swagger.model.ApiCollectDiagnosticDataArguments;\n+import com.cloudera.api.swagger.model.ApiCommand;\n+import com.sequenceiq.cloudbreak.client.HttpClientConfig;\n+import com.sequenceiq.cloudbreak.cloud.scheduler.CancellationException;\n+import com.sequenceiq.cloudbreak.cluster.api.ClusterDiagnosticsService;\n+import com.sequenceiq.cloudbreak.cluster.service.ClusterClientInitException;\n+import com.sequenceiq.cloudbreak.cm.client.ClouderaManagerApiClientProvider;\n+import com.sequenceiq.cloudbreak.cm.client.ClouderaManagerClientInitException;\n+import com.sequenceiq.cloudbreak.cm.client.retry.ClouderaManagerApiFactory;\n+import com.sequenceiq.cloudbreak.cm.polling.ClouderaManagerPollingServiceProvider;\n+import com.sequenceiq.cloudbreak.domain.stack.Stack;\n+import com.sequenceiq.cloudbreak.domain.stack.cluster.Cluster;\n+import com.sequenceiq.cloudbreak.polling.PollingResult;\n+import com.sequenceiq.cloudbreak.service.CloudbreakException;\n+import com.sequenceiq.common.model.diagnostics.CmDiagnosticsParameters;\n+\n+@Service\n+@Scope(\"prototype\")\n+public class ClouderaManagerDiagnosticsService implements ClusterDiagnosticsService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(ClouderaManagerDiagnosticsService.class);\n+\n+    @Inject\n+    private ClouderaManagerApiClientProvider clouderaManagerApiClientProvider;\n+\n+    @Inject\n+    private ClouderaManagerApiFactory clouderaManagerApiFactory;\n+\n+    @Inject\n+    private ClouderaManagerPollingServiceProvider clouderaManagerPollingServiceProvider;\n+\n+    private final Stack stack;\n+\n+    private final HttpClientConfig clientConfig;\n+\n+    private ApiClient client;\n+\n+    public ClouderaManagerDiagnosticsService(Stack stack, HttpClientConfig clientConfig) {\n+        this.stack = stack;\n+        this.clientConfig = clientConfig;\n+    }\n+\n+    @PostConstruct\n+    public void initApiClient() throws ClusterClientInitException {\n+        Cluster cluster = stack.getCluster();\n+        String cloudbreakAmbariUser = cluster.getCloudbreakAmbariUser();\n+        String cloudbreakAmbariPassword = cluster.getCloudbreakAmbariPassword();\n+        try {\n+            client = clouderaManagerApiClientProvider\n+                    .getClient(stack.getGatewayPort(), cloudbreakAmbariUser, cloudbreakAmbariPassword, clientConfig);\n+        } catch (ClouderaManagerClientInitException e) {\n+            throw new ClusterClientInitException(e);\n+        }\n+    }\n+\n+    @Override\n+    public void collectDiagnostics(CmDiagnosticsParameters parameters) throws CloudbreakException {\n+        ClouderaManagerResourceApi resourceApi = clouderaManagerApiFactory.getClouderaManagerResourceApi(client);\n+        try {\n+            ApiCommand collectDiagnostics = resourceApi.collectDiagnosticDataCommand(convertToCollectDiagnosticDataArguments(parameters));\n+            PollingResult pollingResult = clouderaManagerPollingServiceProvider.startPollingCollectDiagnostics(stack, client, collectDiagnostics.getId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "753353f32edced1debb744c87b5483e6aa8f32c1"}, "originalPosition": 81}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzNTAwNDI2", "url": "https://github.com/hortonworks/cloudbreak/pull/8913#pullrequestreview-483500426", "createdAt": "2020-09-07T12:00:15Z", "commit": {"oid": "753353f32edced1debb744c87b5483e6aa8f32c1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2401, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}