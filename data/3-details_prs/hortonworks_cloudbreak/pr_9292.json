{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEwNTYxMDMz", "number": 9292, "title": "CB-9325 All entitlements in one place and entitlement check result is logged", "bodyText": "See detailed description in the commit message.", "createdAt": "2020-10-27T08:11:38Z", "url": "https://github.com/hortonworks/cloudbreak/pull/9292", "merged": true, "mergeCommit": {"oid": "793aa5304760737007fc9426c5d28e2e4e072906"}, "closed": true, "closedAt": "2020-10-28T13:40:17Z", "author": {"login": "foldik"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdWklQrgFqTUxNzQ0MjcyNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdW8wuxAFqTUxODYwODUzNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3NDQyNzI1", "url": "https://github.com/hortonworks/cloudbreak/pull/9292#pullrequestreview-517442725", "createdAt": "2020-10-27T08:20:44Z", "commit": {"oid": "fd5f9263406405a5ba982525c70375102c0879a7"}, "state": "DISMISSED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwODoyMDo0NFrOHowBeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwODoyMDo0NFrOHowBeg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ5MTg5OA==", "bodyText": "Entitlement check for authz entitlement still not logged here. The main reason for jira task creation was to use EntitlementService here and also resolve circular dependency between GrpcUmsClient and EntitlementService", "url": "https://github.com/hortonworks/cloudbreak/pull/9292#discussion_r512491898", "createdAt": "2020-10-27T08:20:44Z", "author": {"login": "horadla23"}, "path": "auth-connector/src/main/java/com/sequenceiq/cloudbreak/auth/altus/GrpcUmsClient.java", "diffHunk": "@@ -511,7 +512,7 @@ public boolean isAuthorizationEntitlementRegistered(String actorCrn, String acco\n         return getAccountDetails(actorCrn, accountId, MDCUtils.getRequestId()).getEntitlementsList()\n                 .stream()\n                 .map(e -> e.getEntitlementName().toUpperCase())\n-                .anyMatch(e -> e.equalsIgnoreCase(\"CB_AUTHZ_POWER_USERS\"));\n+                .anyMatch(e -> e.equalsIgnoreCase(Entitlement.CB_AUTHZ_POWER_USERS.name()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd5f9263406405a5ba982525c70375102c0879a7"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b60742868058ea41ad40ca9bcdc67da6215bbc54", "author": {"user": {"login": "foldik", "name": "Attila Kristof Foldi"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/b60742868058ea41ad40ca9bcdc67da6215bbc54", "committedDate": "2020-10-27T15:00:58Z", "message": "CB-9325 All entitlements in one place and entitlement check result is logged"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fd5f9263406405a5ba982525c70375102c0879a7", "author": {"user": {"login": "foldik", "name": "Attila Kristof Foldi"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/fd5f9263406405a5ba982525c70375102c0879a7", "committedDate": "2020-10-27T08:04:52Z", "message": "CB-9325 All entitlements in one place and entitlement check result is logged"}, "afterCommit": {"oid": "b60742868058ea41ad40ca9bcdc67da6215bbc54", "author": {"user": {"login": "foldik", "name": "Attila Kristof Foldi"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/b60742868058ea41ad40ca9bcdc67da6215bbc54", "committedDate": "2020-10-27T15:00:58Z", "message": "CB-9325 All entitlements in one place and entitlement check result is logged"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3ODU5NTI1", "url": "https://github.com/hortonworks/cloudbreak/pull/9292#pullrequestreview-517859525", "createdAt": "2020-10-27T15:47:32Z", "commit": {"oid": "b60742868058ea41ad40ca9bcdc67da6215bbc54"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxNTo0NzozMlrOHpDWSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxNTo0NzozMlrOHpDWSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjgwODUyMQ==", "bodyText": "maybe it is better to let UMS call fail here if account id is internal (which should not ever happen at this point), so i would not check for that, anyway CB will fail somewhere else also if internal account id reaches service layer", "url": "https://github.com/hortonworks/cloudbreak/pull/9292#discussion_r512808521", "createdAt": "2020-10-27T15:47:32Z", "author": {"login": "horadla23"}, "path": "auth-connector/src/main/java/com/sequenceiq/cloudbreak/auth/altus/GrpcUmsClient.java", "diffHunk": "@@ -503,15 +504,24 @@ public String rightCheckToString(AuthorizationProto.RightCheck rightCheck) {\n         }\n     }\n \n-    @Cacheable(cacheNames = \"umsAuthorizationEntitlementRegisteredCache\", key = \"{ #actorCrn, #accountId }\")\n-    public boolean isAuthorizationEntitlementRegistered(String actorCrn, String accountId) {\n-        if (StringUtils.equals(accountId, InternalCrnBuilder.INTERNAL_ACCOUNT)) {\n-            return false;\n+    @Cacheable(cacheNames = \"umsEntitlementRegisteredCache\", key = \"{ #actorCrn, #accountId, #entitlement }\")\n+    public boolean isEntitled(String actorCrn, String accountId, Entitlement entitlement) {\n+        boolean entitled;\n+        if (Entitlement.CB_AUTHZ_POWER_USERS.equals(entitlement) && StringUtils.equals(accountId, InternalCrnBuilder.INTERNAL_ACCOUNT)) {\n+            entitled = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b60742868058ea41ad40ca9bcdc67da6215bbc54"}, "originalPosition": 59}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3ODc0MDUw", "url": "https://github.com/hortonworks/cloudbreak/pull/9292#pullrequestreview-517874050", "createdAt": "2020-10-27T16:00:16Z", "commit": {"oid": "b60742868058ea41ad40ca9bcdc67da6215bbc54"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4NjA4NTM2", "url": "https://github.com/hortonworks/cloudbreak/pull/9292#pullrequestreview-518608536", "createdAt": "2020-10-28T12:31:06Z", "commit": {"oid": "b60742868058ea41ad40ca9bcdc67da6215bbc54"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2066, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}