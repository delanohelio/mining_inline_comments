{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEwMzczOTAz", "number": 7922, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQxNTowNDozMVrOD4ZDfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQxMTo1ODo0MFrOD7NYGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwNDU3MzQzOnYy", "diffSide": "RIGHT", "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/scripts/backup_db.sh", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQxNTowNDozMVrOGPMLpA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxMzoxMjoyNVrOGP_oLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU4MTQxMg==", "bodyText": "The date directory part of the backup location will be coming from the datalake DR service calls, since we need to sync that across the different backup types. So you don't need to generate it dynamically in the the scripts.", "url": "https://github.com/hortonworks/cloudbreak/pull/7922#discussion_r418581412", "createdAt": "2020-05-01T15:04:31Z", "author": {"login": "hreeve-cloudera"}, "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/scripts/backup_db.sh", "diffHunk": "@@ -0,0 +1,98 @@\n+#!/bin/bash\n+set -o errexit\n+set -o nounset\n+set -o pipefail\n+\n+if [ $# -ne 6 ]; then\n+  echo \"Invalid inputs provided\"\n+  echo \"Script accepts five inputs:\"\n+  echo \"  1. Cloud Provider (azure | aws)\"\n+  echo \"  2. PostgreSQL host name.\"\n+  echo \"  3. PostgreSQL port.\"\n+  echo \"  4. Object Storage Service url to place backups.\"\n+  echo \"  5. PostgreSQL user name.\"\n+  echo \"  6. PostgreSQL password.\"\n+  exit 1\n+fi\n+\n+CLOUD_PROVIDER=\"$1\"\n+HOST=\"$2\"\n+PORT=\"$3\"\n+BACKUP_LOCATION=\"$4\"\n+USERNAME=\"$5\"\n+export PGPASSWORD=\"$6\" # We can provide the password to pg_dump through this variable, or in ~/.pgpass\n+\n+BACKUP_DATE=$(date '+%Y-%m-%dT%H:%M:%SZ')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97fd4d2451504c8db77a2f7dc6fab01ce598abce"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTQyNDMwMw==", "bodyText": "Done, but I'm still generating a date for the temp files that Azure must create before uploading to blob storage -- if you notice the $(date '+%Y-%m-%dT%H:%M:%SZ') still hanging around.", "url": "https://github.com/hortonworks/cloudbreak/pull/7922#discussion_r419424303", "createdAt": "2020-05-04T13:12:25Z", "author": {"login": "brycederriso"}, "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/scripts/backup_db.sh", "diffHunk": "@@ -0,0 +1,98 @@\n+#!/bin/bash\n+set -o errexit\n+set -o nounset\n+set -o pipefail\n+\n+if [ $# -ne 6 ]; then\n+  echo \"Invalid inputs provided\"\n+  echo \"Script accepts five inputs:\"\n+  echo \"  1. Cloud Provider (azure | aws)\"\n+  echo \"  2. PostgreSQL host name.\"\n+  echo \"  3. PostgreSQL port.\"\n+  echo \"  4. Object Storage Service url to place backups.\"\n+  echo \"  5. PostgreSQL user name.\"\n+  echo \"  6. PostgreSQL password.\"\n+  exit 1\n+fi\n+\n+CLOUD_PROVIDER=\"$1\"\n+HOST=\"$2\"\n+PORT=\"$3\"\n+BACKUP_LOCATION=\"$4\"\n+USERNAME=\"$5\"\n+export PGPASSWORD=\"$6\" # We can provide the password to pg_dump through this variable, or in ~/.pgpass\n+\n+BACKUP_DATE=$(date '+%Y-%m-%dT%H:%M:%SZ')", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU4MTQxMg=="}, "originalCommit": {"oid": "97fd4d2451504c8db77a2f7dc6fab01ce598abce"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwNDU3ODg2OnYy", "diffSide": "RIGHT", "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/scripts/backup_db.sh", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQxNTowNjozNFrOGPMPIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxODo0ODoyOVrOGQNfEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU4MjMwNA==", "bodyText": "If you're exporting this, you might want to unset it at the end of the script. I don't actually think it'll live outside the script's context, but just in case.", "url": "https://github.com/hortonworks/cloudbreak/pull/7922#discussion_r418582304", "createdAt": "2020-05-01T15:06:34Z", "author": {"login": "hreeve-cloudera"}, "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/scripts/backup_db.sh", "diffHunk": "@@ -0,0 +1,98 @@\n+#!/bin/bash\n+set -o errexit\n+set -o nounset\n+set -o pipefail\n+\n+if [ $# -ne 6 ]; then\n+  echo \"Invalid inputs provided\"\n+  echo \"Script accepts five inputs:\"\n+  echo \"  1. Cloud Provider (azure | aws)\"\n+  echo \"  2. PostgreSQL host name.\"\n+  echo \"  3. PostgreSQL port.\"\n+  echo \"  4. Object Storage Service url to place backups.\"\n+  echo \"  5. PostgreSQL user name.\"\n+  echo \"  6. PostgreSQL password.\"\n+  exit 1\n+fi\n+\n+CLOUD_PROVIDER=\"$1\"\n+HOST=\"$2\"\n+PORT=\"$3\"\n+BACKUP_LOCATION=\"$4\"\n+USERNAME=\"$5\"\n+export PGPASSWORD=\"$6\" # We can provide the password to pg_dump through this variable, or in ~/.pgpass", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97fd4d2451504c8db77a2f7dc6fab01ce598abce"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODY3NDM1Mg==", "bodyText": "I think this should really live in the .pgpass file for proper security. I'll think\n(talk) about whether we need to that now or later.", "url": "https://github.com/hortonworks/cloudbreak/pull/7922#discussion_r418674352", "createdAt": "2020-05-01T18:29:31Z", "author": {"login": "brycederriso"}, "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/scripts/backup_db.sh", "diffHunk": "@@ -0,0 +1,98 @@\n+#!/bin/bash\n+set -o errexit\n+set -o nounset\n+set -o pipefail\n+\n+if [ $# -ne 6 ]; then\n+  echo \"Invalid inputs provided\"\n+  echo \"Script accepts five inputs:\"\n+  echo \"  1. Cloud Provider (azure | aws)\"\n+  echo \"  2. PostgreSQL host name.\"\n+  echo \"  3. PostgreSQL port.\"\n+  echo \"  4. Object Storage Service url to place backups.\"\n+  echo \"  5. PostgreSQL user name.\"\n+  echo \"  6. PostgreSQL password.\"\n+  exit 1\n+fi\n+\n+CLOUD_PROVIDER=\"$1\"\n+HOST=\"$2\"\n+PORT=\"$3\"\n+BACKUP_LOCATION=\"$4\"\n+USERNAME=\"$5\"\n+export PGPASSWORD=\"$6\" # We can provide the password to pg_dump through this variable, or in ~/.pgpass", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU4MjMwNA=="}, "originalCommit": {"oid": "97fd4d2451504c8db77a2f7dc6fab01ce598abce"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTY1MTM0Ng==", "bodyText": "Postgres will attempt to read the ~/.pgpass file if it's present. So we should see about adding that to Cloudbreak.", "url": "https://github.com/hortonworks/cloudbreak/pull/7922#discussion_r419651346", "createdAt": "2020-05-04T18:48:29Z", "author": {"login": "brycederriso"}, "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/scripts/backup_db.sh", "diffHunk": "@@ -0,0 +1,98 @@\n+#!/bin/bash\n+set -o errexit\n+set -o nounset\n+set -o pipefail\n+\n+if [ $# -ne 6 ]; then\n+  echo \"Invalid inputs provided\"\n+  echo \"Script accepts five inputs:\"\n+  echo \"  1. Cloud Provider (azure | aws)\"\n+  echo \"  2. PostgreSQL host name.\"\n+  echo \"  3. PostgreSQL port.\"\n+  echo \"  4. Object Storage Service url to place backups.\"\n+  echo \"  5. PostgreSQL user name.\"\n+  echo \"  6. PostgreSQL password.\"\n+  exit 1\n+fi\n+\n+CLOUD_PROVIDER=\"$1\"\n+HOST=\"$2\"\n+PORT=\"$3\"\n+BACKUP_LOCATION=\"$4\"\n+USERNAME=\"$5\"\n+export PGPASSWORD=\"$6\" # We can provide the password to pg_dump through this variable, or in ~/.pgpass", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU4MjMwNA=="}, "originalCommit": {"oid": "97fd4d2451504c8db77a2f7dc6fab01ce598abce"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwNDU4MTc0OnYy", "diffSide": "RIGHT", "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/scripts/backup_db.sh", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQxNTowNzozOVrOGPMRAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQxNTowNzozOVrOGPMRAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU4Mjc4Ng==", "bodyText": "\"Script accepts six inputs:\"", "url": "https://github.com/hortonworks/cloudbreak/pull/7922#discussion_r418582786", "createdAt": "2020-05-01T15:07:39Z", "author": {"login": "hreeve-cloudera"}, "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/scripts/backup_db.sh", "diffHunk": "@@ -0,0 +1,98 @@\n+#!/bin/bash\n+set -o errexit\n+set -o nounset\n+set -o pipefail\n+\n+if [ $# -ne 6 ]; then\n+  echo \"Invalid inputs provided\"\n+  echo \"Script accepts five inputs:\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97fd4d2451504c8db77a2f7dc6fab01ce598abce"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwNDU4MjE3OnYy", "diffSide": "RIGHT", "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/scripts/restore_db.sh", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQxNTowNzo1MlrOGPMRTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQxNTowNzo1MlrOGPMRTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU4Mjg2Mw==", "bodyText": "\"Script accepts six inputs:\"", "url": "https://github.com/hortonworks/cloudbreak/pull/7922#discussion_r418582863", "createdAt": "2020-05-01T15:07:52Z", "author": {"login": "hreeve-cloudera"}, "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/scripts/restore_db.sh", "diffHunk": "@@ -0,0 +1,95 @@\n+#!/bin/bash\n+set -o errexit\n+set -o nounset\n+set -o pipefail\n+\n+if [ $# -ne 6 ]; then\n+  echo \"Invalid inputs provided\"\n+  echo \"Script accepts five inputs:\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97fd4d2451504c8db77a2f7dc6fab01ce598abce"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwNDgxNjU4OnYy", "diffSide": "RIGHT", "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/scripts/backup_db.sh", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQxNjozMDo1N1rOGPOj2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQxODo0MDowM1rOGPSImQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODYyMDM3OQ==", "bodyText": "If the S3 location is created here, How will the Caller provide an appropriate location for restore?", "url": "https://github.com/hortonworks/cloudbreak/pull/7922#discussion_r418620379", "createdAt": "2020-05-01T16:30:57Z", "author": {"login": "kkalvagadda1"}, "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/scripts/backup_db.sh", "diffHunk": "@@ -0,0 +1,98 @@\n+#!/bin/bash\n+set -o errexit\n+set -o nounset\n+set -o pipefail\n+\n+if [ $# -ne 6 ]; then\n+  echo \"Invalid inputs provided\"\n+  echo \"Script accepts five inputs:\"\n+  echo \"  1. Cloud Provider (azure | aws)\"\n+  echo \"  2. PostgreSQL host name.\"\n+  echo \"  3. PostgreSQL port.\"\n+  echo \"  4. Object Storage Service url to place backups.\"\n+  echo \"  5. PostgreSQL user name.\"\n+  echo \"  6. PostgreSQL password.\"\n+  exit 1\n+fi\n+\n+CLOUD_PROVIDER=\"$1\"\n+HOST=\"$2\"\n+PORT=\"$3\"\n+BACKUP_LOCATION=\"$4\"\n+USERNAME=\"$5\"\n+export PGPASSWORD=\"$6\" # We can provide the password to pg_dump through this variable, or in ~/.pgpass\n+\n+BACKUP_DATE=$(date '+%Y-%m-%dT%H:%M:%SZ')\n+LOGFILE=/var/log/dl_postgres_backup.log\n+\n+echo \"Logs at ${LOGFILE}\"\n+\n+doLog() {\n+  type_of_msg=$(echo $* | cut -d\" \" -f1)\n+  msg=$(echo \"$*\" | cut -d\" \" -f2-)\n+  [[ $type_of_msg == INFO ]] && type_of_msg=\"INFO \" # one space for aligning\n+  [[ $type_of_msg == WARN ]] && type_of_msg=\"WARN \" # as well\n+\n+  # print to the terminal if we have one\n+  test -t 1 && echo \"$(date \"+%Y-%m-%dT%H:%M:%SZ\") $type_of_msg \"\"$msg\"\n+  echo \"$(date \"+%Y-%m-%dT%H:%M:%SZ\") $type_of_msg \"\"$msg\" >>$LOGFILE\n+}\n+\n+errorExit() {\n+  doLog \"ERROR $1\"\n+  exit 1\n+}\n+\n+dump_to_azure() {\n+  SERVICE=\"$1\"\n+  doLog \"INFO Dumping ${SERVICE}\"\n+  LOCAL_BACKUP=${DATE_DIR}/${SERVICE}_backup\n+  pg_dump --host=\"$HOST\" --port=\"$PORT\" --username=\"$USERNAME\" --dbname=\"$SERVICE\" --format=custom --file=\"$LOCAL_BACKUP\" >>$LOGFILE 2>&1 || errorExit \"Unable to dump ${SERVICE}\"\n+\n+  doLog \"INFO Uploading to ${BACKUP_LOCATION}\"\n+  # todo: strip trailing slash from BACKUP_LOCATION if it's there\n+  AZURE_LOCATION=\"${BACKUP_LOCATION}/${BACKUP_DATE}/${SERVICE}_backup\"\n+  azcopy copy \"$LOCAL_BACKUP\" \"$AZURE_LOCATION\" >>$LOGFILE 2>&1 || errorExit \"Unable to upload $SERVICE backup\"\n+  doLog \"INFO Completed upload to ${BACKUP_LOCATION}\"\n+\n+  rm -v \"$LOCAL_BACKUP\" >>$LOGFILE 2>&1\n+\n+  doLog \"INFO ${SERVICE} dumped to \"\n+}\n+run_azure_backup () {\n+  BACKUPS_DIR=\"/var/tmp/\" # Is this appropriate for keeping backups that are staged before uploading to Azure Blob Storage?\n+  DATE_DIR=${BACKUPS_DIR}/${BACKUP_DATE}\n+  mkdir -p \"$DATE_DIR\" || error_exit \"Could not create local directory for backups.\"\n+\n+  azcopy login --identity || errorExit \"Could not login to Azure\"\n+  dump_to_azure \"hive\"\n+  dump_to_azure \"ranger\"\n+\n+  rmdir -v \"$DATE_DIR\" >>$LOGFILE 2>&1\n+}\n+\n+dump_to_s3() {\n+  SERVICE=$1\n+  # todo: strip trailing slash from BACKUP_LOCATION if it's there\n+  S3_LOCATION=\"${BACKUP_LOCATION}/${BACKUP_DATE}/${SERVICE}_backup\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97fd4d2451504c8db77a2f7dc6fab01ce598abce"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODY3ODkzNw==", "bodyText": "I'll change this to only create the ${SERVICE}_backup portion at the end of the s3 location.", "url": "https://github.com/hortonworks/cloudbreak/pull/7922#discussion_r418678937", "createdAt": "2020-05-01T18:40:03Z", "author": {"login": "brycederriso"}, "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/scripts/backup_db.sh", "diffHunk": "@@ -0,0 +1,98 @@\n+#!/bin/bash\n+set -o errexit\n+set -o nounset\n+set -o pipefail\n+\n+if [ $# -ne 6 ]; then\n+  echo \"Invalid inputs provided\"\n+  echo \"Script accepts five inputs:\"\n+  echo \"  1. Cloud Provider (azure | aws)\"\n+  echo \"  2. PostgreSQL host name.\"\n+  echo \"  3. PostgreSQL port.\"\n+  echo \"  4. Object Storage Service url to place backups.\"\n+  echo \"  5. PostgreSQL user name.\"\n+  echo \"  6. PostgreSQL password.\"\n+  exit 1\n+fi\n+\n+CLOUD_PROVIDER=\"$1\"\n+HOST=\"$2\"\n+PORT=\"$3\"\n+BACKUP_LOCATION=\"$4\"\n+USERNAME=\"$5\"\n+export PGPASSWORD=\"$6\" # We can provide the password to pg_dump through this variable, or in ~/.pgpass\n+\n+BACKUP_DATE=$(date '+%Y-%m-%dT%H:%M:%SZ')\n+LOGFILE=/var/log/dl_postgres_backup.log\n+\n+echo \"Logs at ${LOGFILE}\"\n+\n+doLog() {\n+  type_of_msg=$(echo $* | cut -d\" \" -f1)\n+  msg=$(echo \"$*\" | cut -d\" \" -f2-)\n+  [[ $type_of_msg == INFO ]] && type_of_msg=\"INFO \" # one space for aligning\n+  [[ $type_of_msg == WARN ]] && type_of_msg=\"WARN \" # as well\n+\n+  # print to the terminal if we have one\n+  test -t 1 && echo \"$(date \"+%Y-%m-%dT%H:%M:%SZ\") $type_of_msg \"\"$msg\"\n+  echo \"$(date \"+%Y-%m-%dT%H:%M:%SZ\") $type_of_msg \"\"$msg\" >>$LOGFILE\n+}\n+\n+errorExit() {\n+  doLog \"ERROR $1\"\n+  exit 1\n+}\n+\n+dump_to_azure() {\n+  SERVICE=\"$1\"\n+  doLog \"INFO Dumping ${SERVICE}\"\n+  LOCAL_BACKUP=${DATE_DIR}/${SERVICE}_backup\n+  pg_dump --host=\"$HOST\" --port=\"$PORT\" --username=\"$USERNAME\" --dbname=\"$SERVICE\" --format=custom --file=\"$LOCAL_BACKUP\" >>$LOGFILE 2>&1 || errorExit \"Unable to dump ${SERVICE}\"\n+\n+  doLog \"INFO Uploading to ${BACKUP_LOCATION}\"\n+  # todo: strip trailing slash from BACKUP_LOCATION if it's there\n+  AZURE_LOCATION=\"${BACKUP_LOCATION}/${BACKUP_DATE}/${SERVICE}_backup\"\n+  azcopy copy \"$LOCAL_BACKUP\" \"$AZURE_LOCATION\" >>$LOGFILE 2>&1 || errorExit \"Unable to upload $SERVICE backup\"\n+  doLog \"INFO Completed upload to ${BACKUP_LOCATION}\"\n+\n+  rm -v \"$LOCAL_BACKUP\" >>$LOGFILE 2>&1\n+\n+  doLog \"INFO ${SERVICE} dumped to \"\n+}\n+run_azure_backup () {\n+  BACKUPS_DIR=\"/var/tmp/\" # Is this appropriate for keeping backups that are staged before uploading to Azure Blob Storage?\n+  DATE_DIR=${BACKUPS_DIR}/${BACKUP_DATE}\n+  mkdir -p \"$DATE_DIR\" || error_exit \"Could not create local directory for backups.\"\n+\n+  azcopy login --identity || errorExit \"Could not login to Azure\"\n+  dump_to_azure \"hive\"\n+  dump_to_azure \"ranger\"\n+\n+  rmdir -v \"$DATE_DIR\" >>$LOGFILE 2>&1\n+}\n+\n+dump_to_s3() {\n+  SERVICE=$1\n+  # todo: strip trailing slash from BACKUP_LOCATION if it's there\n+  S3_LOCATION=\"${BACKUP_LOCATION}/${BACKUP_DATE}/${SERVICE}_backup\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODYyMDM3OQ=="}, "originalCommit": {"oid": "97fd4d2451504c8db77a2f7dc6fab01ce598abce"}, "originalPosition": 77}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwNDgzNDg1OnYy", "diffSide": "RIGHT", "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/scripts/backup_db.sh", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQxNjozNzoxMVrOGPOusg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQxODo0OToxM1rOGPSYnQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODYyMzE1NA==", "bodyText": "Re-order the inputs to be in-order. Move Object store URL to the end so that all the database configurations will be together.", "url": "https://github.com/hortonworks/cloudbreak/pull/7922#discussion_r418623154", "createdAt": "2020-05-01T16:37:11Z", "author": {"login": "kkalvagadda1"}, "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/scripts/backup_db.sh", "diffHunk": "@@ -0,0 +1,98 @@\n+#!/bin/bash\n+set -o errexit\n+set -o nounset\n+set -o pipefail\n+\n+if [ $# -ne 6 ]; then\n+  echo \"Invalid inputs provided\"\n+  echo \"Script accepts five inputs:\"\n+  echo \"  1. Cloud Provider (azure | aws)\"\n+  echo \"  2. PostgreSQL host name.\"\n+  echo \"  3. PostgreSQL port.\"\n+  echo \"  4. Object Storage Service url to place backups.\"\n+  echo \"  5. PostgreSQL user name.\"\n+  echo \"  6. PostgreSQL password.\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97fd4d2451504c8db77a2f7dc6fab01ce598abce"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODY1NDM0OA==", "bodyText": "My intent with password last was to make it easier to remove the password altogether if/when we migrate to using the recommended .pgpass file for passwords.\nHow about\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              echo \"Invalid inputs provided\"\n          \n          \n            \n              echo \"Script accepts five inputs:\"\n          \n          \n            \n              echo \"  1. Cloud Provider (azure | aws)\"\n          \n          \n            \n              echo \"  2. PostgreSQL host name.\"\n          \n          \n            \n              echo \"  3. PostgreSQL port.\"\n          \n          \n            \n              echo \"  4. Object Storage Service url to place backups.\"\n          \n          \n            \n              echo \"  5. PostgreSQL user name.\"\n          \n          \n            \n              echo \"  6. PostgreSQL password.\"\n          \n          \n            \n              echo \"  1. Cloud Provider (azure | aws)\"\n          \n          \n            \n              echo \"  2. Object Storage Service url to place backups.\"\n          \n          \n            \n              echo \"  3. PostgreSQL host name.\"\n          \n          \n            \n              echo \"  4. PostgreSQL port.\"\n          \n          \n            \n              echo \"  5. PostgreSQL user name.\"\n          \n          \n            \n              echo \"  6. PostgreSQL password.\"", "url": "https://github.com/hortonworks/cloudbreak/pull/7922#discussion_r418654348", "createdAt": "2020-05-01T17:45:48Z", "author": {"login": "brycederriso"}, "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/scripts/backup_db.sh", "diffHunk": "@@ -0,0 +1,98 @@\n+#!/bin/bash\n+set -o errexit\n+set -o nounset\n+set -o pipefail\n+\n+if [ $# -ne 6 ]; then\n+  echo \"Invalid inputs provided\"\n+  echo \"Script accepts five inputs:\"\n+  echo \"  1. Cloud Provider (azure | aws)\"\n+  echo \"  2. PostgreSQL host name.\"\n+  echo \"  3. PostgreSQL port.\"\n+  echo \"  4. Object Storage Service url to place backups.\"\n+  echo \"  5. PostgreSQL user name.\"\n+  echo \"  6. PostgreSQL password.\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODYyMzE1NA=="}, "originalCommit": {"oid": "97fd4d2451504c8db77a2f7dc6fab01ce598abce"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODY1ODc2Nw==", "bodyText": "Make sure you don't actually delete the part that explains they're missing parameters. And you might explicitly mark PostgresSQL password as optional. I didn't realize it was, which is why I ticked the mentioned number of parameters.", "url": "https://github.com/hortonworks/cloudbreak/pull/7922#discussion_r418658767", "createdAt": "2020-05-01T17:54:59Z", "author": {"login": "hreeve-cloudera"}, "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/scripts/backup_db.sh", "diffHunk": "@@ -0,0 +1,98 @@\n+#!/bin/bash\n+set -o errexit\n+set -o nounset\n+set -o pipefail\n+\n+if [ $# -ne 6 ]; then\n+  echo \"Invalid inputs provided\"\n+  echo \"Script accepts five inputs:\"\n+  echo \"  1. Cloud Provider (azure | aws)\"\n+  echo \"  2. PostgreSQL host name.\"\n+  echo \"  3. PostgreSQL port.\"\n+  echo \"  4. Object Storage Service url to place backups.\"\n+  echo \"  5. PostgreSQL user name.\"\n+  echo \"  6. PostgreSQL password.\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODYyMzE1NA=="}, "originalCommit": {"oid": "97fd4d2451504c8db77a2f7dc6fab01ce598abce"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODY4MzAzNw==", "bodyText": "Ah, you're giving me too much credit, I hadn't thought of making it optional. I'll add the accoutrements to make it so.", "url": "https://github.com/hortonworks/cloudbreak/pull/7922#discussion_r418683037", "createdAt": "2020-05-01T18:49:13Z", "author": {"login": "brycederriso"}, "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/scripts/backup_db.sh", "diffHunk": "@@ -0,0 +1,98 @@\n+#!/bin/bash\n+set -o errexit\n+set -o nounset\n+set -o pipefail\n+\n+if [ $# -ne 6 ]; then\n+  echo \"Invalid inputs provided\"\n+  echo \"Script accepts five inputs:\"\n+  echo \"  1. Cloud Provider (azure | aws)\"\n+  echo \"  2. PostgreSQL host name.\"\n+  echo \"  3. PostgreSQL port.\"\n+  echo \"  4. Object Storage Service url to place backups.\"\n+  echo \"  5. PostgreSQL user name.\"\n+  echo \"  6. PostgreSQL password.\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODYyMzE1NA=="}, "originalCommit": {"oid": "97fd4d2451504c8db77a2f7dc6fab01ce598abce"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzNDExNzM2OnYy", "diffSide": "RIGHT", "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/scripts/backup_db.sh", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQxMTo1ODo0MFrOGTZIww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxNDo0Nzo1NFrOGUKYDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk4Nzk3MQ==", "bodyText": "I would not export the password as it will be part of the logs. In Salt we can simply pass passwords to the script without exposing it. Example: \n  \n    \n      cloudbreak/freeipa/src/main/resources/freeipa-salt/salt/freeipa/common-install.sls\n    \n    \n         Line 5\n      in\n      bb5ebdf\n    \n    \n    \n    \n\n        \n          \n           - FPW: {{salt['pillar.get']('freeipa:password')}}", "url": "https://github.com/hortonworks/cloudbreak/pull/7922#discussion_r422987971", "createdAt": "2020-05-11T11:58:40Z", "author": {"login": "keyki"}, "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/scripts/backup_db.sh", "diffHunk": "@@ -0,0 +1,96 @@\n+#!/bin/bash\n+set -o errexit\n+set -o nounset\n+set -o pipefail\n+\n+if [ $# -ne 5 ] && [ $# -ne 6 ]; then\n+  echo \"Invalid inputs provided\"\n+  echo \"Script accepts 5 inputs:\"\n+  echo \"  1. Cloud Provider (azure | aws)\"\n+  echo \"  2. Object Storage Service url to retrieve backups.\"\n+  echo \"  3. PostgreSQL host name.\"\n+  echo \"  4. PostgreSQL port.\"\n+  echo \"  5. PostgreSQL user name.\"\n+  echo\n+  echo \"  Optional: PostgreSQL password.\"\n+  exit 1\n+fi\n+\n+CLOUD_PROVIDER=\"$1\"\n+BACKUP_LOCATION=$(echo \"$2\"| sed 's/\\/\\+$//g') # Clear trailng '/' (if present) for later path joining.\n+HOST=\"$3\"\n+PORT=\"$4\"\n+USERNAME=\"$5\"\n+export PGPASSWORD=\"$6\" # We can provide the password to pg_dump through this variable, or in ~/.pgpass", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d09d266742261a0fd6ba34df0fa172f04119b1a3"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMwMDc1MA==", "bodyText": "The problem actually lies in passing the password to the pg_dump command. There isn't any option to provide it as a command line argument. If we stick to using a password we need to either:\n\nProvide it interactively\nPut the password in the special PGPASSWORD variable\nPut the password as a connection string in ~/.pgpass and chmod 0600 it for root.\n\nStackOverflow suggests using an alternative to password authentication as well.", "url": "https://github.com/hortonworks/cloudbreak/pull/7922#discussion_r423300750", "createdAt": "2020-05-11T20:30:28Z", "author": {"login": "brycederriso"}, "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/scripts/backup_db.sh", "diffHunk": "@@ -0,0 +1,96 @@\n+#!/bin/bash\n+set -o errexit\n+set -o nounset\n+set -o pipefail\n+\n+if [ $# -ne 5 ] && [ $# -ne 6 ]; then\n+  echo \"Invalid inputs provided\"\n+  echo \"Script accepts 5 inputs:\"\n+  echo \"  1. Cloud Provider (azure | aws)\"\n+  echo \"  2. Object Storage Service url to retrieve backups.\"\n+  echo \"  3. PostgreSQL host name.\"\n+  echo \"  4. PostgreSQL port.\"\n+  echo \"  5. PostgreSQL user name.\"\n+  echo\n+  echo \"  Optional: PostgreSQL password.\"\n+  exit 1\n+fi\n+\n+CLOUD_PROVIDER=\"$1\"\n+BACKUP_LOCATION=$(echo \"$2\"| sed 's/\\/\\+$//g') # Clear trailng '/' (if present) for later path joining.\n+HOST=\"$3\"\n+PORT=\"$4\"\n+USERNAME=\"$5\"\n+export PGPASSWORD=\"$6\" # We can provide the password to pg_dump through this variable, or in ~/.pgpass", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk4Nzk3MQ=="}, "originalCommit": {"oid": "d09d266742261a0fd6ba34df0fa172f04119b1a3"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzc5NDcwMA==", "bodyText": "@keyki has explained that we can use Salt to define the PGPASSWORD variable in the environment, so there's no need to set it + export it in the backup or restore scripts.\nThis prevents accidental exposure of the password by set -x.", "url": "https://github.com/hortonworks/cloudbreak/pull/7922#discussion_r423794700", "createdAt": "2020-05-12T14:47:54Z", "author": {"login": "brycederriso"}, "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/scripts/backup_db.sh", "diffHunk": "@@ -0,0 +1,96 @@\n+#!/bin/bash\n+set -o errexit\n+set -o nounset\n+set -o pipefail\n+\n+if [ $# -ne 5 ] && [ $# -ne 6 ]; then\n+  echo \"Invalid inputs provided\"\n+  echo \"Script accepts 5 inputs:\"\n+  echo \"  1. Cloud Provider (azure | aws)\"\n+  echo \"  2. Object Storage Service url to retrieve backups.\"\n+  echo \"  3. PostgreSQL host name.\"\n+  echo \"  4. PostgreSQL port.\"\n+  echo \"  5. PostgreSQL user name.\"\n+  echo\n+  echo \"  Optional: PostgreSQL password.\"\n+  exit 1\n+fi\n+\n+CLOUD_PROVIDER=\"$1\"\n+BACKUP_LOCATION=$(echo \"$2\"| sed 's/\\/\\+$//g') # Clear trailng '/' (if present) for later path joining.\n+HOST=\"$3\"\n+PORT=\"$4\"\n+USERNAME=\"$5\"\n+export PGPASSWORD=\"$6\" # We can provide the password to pg_dump through this variable, or in ~/.pgpass", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk4Nzk3MQ=="}, "originalCommit": {"oid": "d09d266742261a0fd6ba34df0fa172f04119b1a3"}, "originalPosition": 24}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2509, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}