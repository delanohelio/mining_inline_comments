{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIwMzQxNTg3", "number": 8100, "title": "DISTX-421 DISTX-427 Recommendation for host groups' scalability", "bodyText": "Added recommendations for auto-scalability and manual scalability.\nImplemented both CM service based recommendations and fallback recommendations.\n\n./gradlew build", "createdAt": "2020-05-19T20:14:36Z", "url": "https://github.com/hortonworks/cloudbreak/pull/8100", "merged": true, "mergeCommit": {"oid": "c3797bbc0a56e83a899a46b0e798664625cee71c"}, "closed": true, "closedAt": "2020-06-05T14:24:05Z", "author": {"login": "cegganesh84"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcjCdt3ABqjMzNTQ3OTcwNjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcoTd7GAFqTQyNTM0ODQ4Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "587165e79ad66fbd222ea84425ee2c7cfdacf348", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/587165e79ad66fbd222ea84425ee2c7cfdacf348", "committedDate": "2020-05-19T20:12:02Z", "message": "DISTX-421 DISTX-427 Recommendation for host groups' scalability\n\n1. Added recommendations for auto-scalability and manual scalability.\n2. Implemented the fallback recommendations.\n3. CM service based recommendations needs to be implemented.\n4. This has the basic plumbing needed for the UI to integrate."}, "afterCommit": {"oid": "fd9e74b9be22955e108ab9df21a1800b5964c3d0", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/fd9e74b9be22955e108ab9df21a1800b5964c3d0", "committedDate": "2020-05-20T05:45:08Z", "message": "DISTX-421 DISTX-427 Recommendation for host groups' scalability\n\n1. Added recommendations for auto-scalability and manual scalability.\n2. Implemented CM service based recommendations."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fd9e74b9be22955e108ab9df21a1800b5964c3d0", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/fd9e74b9be22955e108ab9df21a1800b5964c3d0", "committedDate": "2020-05-20T05:45:08Z", "message": "DISTX-421 DISTX-427 Recommendation for host groups' scalability\n\n1. Added recommendations for auto-scalability and manual scalability.\n2. Implemented CM service based recommendations."}, "afterCommit": {"oid": "5b07e74f8115a6232c571a3397d497694025b00a", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/5b07e74f8115a6232c571a3397d497694025b00a", "committedDate": "2020-05-21T02:01:02Z", "message": "DISTX-421 DISTX-427 Recommendation for host groups' scalability\n\n1. Fixed a bug with respect to HA template. Added a fix and unit test."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1OTI1NzUw", "url": "https://github.com/hortonworks/cloudbreak/pull/8100#pullrequestreview-415925750", "createdAt": "2020-05-21T07:08:39Z", "commit": {"oid": "5b07e74f8115a6232c571a3397d497694025b00a"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwNzowODozOVrOGYoi_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwNzozOTo1M1rOGYpSrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQ4MzMyNw==", "bodyText": "Splitting this into loadBasedScaling \\ timeBasedScaling will be good.", "url": "https://github.com/hortonworks/cloudbreak/pull/8100#discussion_r428483327", "createdAt": "2020-05-21T07:08:39Z", "author": {"login": "smaniraju"}, "path": "cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/model/AutoscaleRecommendation.java", "diffHunk": "@@ -0,0 +1,41 @@\n+package com.sequenceiq.cloudbreak.cloud.model;\n+\n+import java.util.Objects;\n+import java.util.Set;\n+\n+public class AutoscaleRecommendation {\n+\n+    private final Set<String> hostGroups;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b07e74f8115a6232c571a3397d497694025b00a"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQ5NTUzNQ==", "bodyText": "Also will AutoscaleRecommendation be exposed as top level api BlueprintUtilV4Endpoint::getAutoscaleRecommendation(workspaceId,blueprintName) for validation in periscope against Autoscale CLI requests?  Something similar to BlueprintUtilV4Endpoint::getServicesByBlueprint. BlueprintUtilV4Endpoint::createRecommendation will not be usable from periscope since parameters like credentialName, region are not available.", "url": "https://github.com/hortonworks/cloudbreak/pull/8100#discussion_r428495535", "createdAt": "2020-05-21T07:39:53Z", "author": {"login": "smaniraju"}, "path": "cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/model/AutoscaleRecommendation.java", "diffHunk": "@@ -0,0 +1,41 @@\n+package com.sequenceiq.cloudbreak.cloud.model;\n+\n+import java.util.Objects;\n+import java.util.Set;\n+\n+public class AutoscaleRecommendation {\n+\n+    private final Set<String> hostGroups;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQ4MzMyNw=="}, "originalCommit": {"oid": "5b07e74f8115a6232c571a3397d497694025b00a"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1OTUwNzgy", "url": "https://github.com/hortonworks/cloudbreak/pull/8100#pullrequestreview-415950782", "createdAt": "2020-05-21T07:57:47Z", "commit": {"oid": "5b07e74f8115a6232c571a3397d497694025b00a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwNzo1Nzo0OFrOGYpxhg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwNzo1Nzo0OFrOGYpxhg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUwMzQzMA==", "bodyText": "please include only compute.", "url": "https://github.com/hortonworks/cloudbreak/pull/8100#discussion_r428503430", "createdAt": "2020-05-21T07:57:48Z", "author": {"login": "smaniraju"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/service/stack/CloudResourceAdvisor.java", "diffHunk": "@@ -166,6 +177,56 @@ private boolean fallbackGatewayFilter(String hostGroupName) {\n                 || lowerName.contains(\"services\");\n     }\n \n+    private ResizeRecommendation recommendResize(BlueprintTextProcessor blueprintTextProcessor) {\n+        ResizeRecommendation resizeRecommendation = blueprintTextProcessor.recommendResize();\n+\n+        if (resizeRecommendation.getScaleUpHostGroups().isEmpty()) {\n+            Set<String> scaleUpHostGroups = filterHostGroupByPredicate(blueprintTextProcessor, this::fallbackScaleUpFilter);\n+            if (!scaleUpHostGroups.isEmpty()) {\n+                resizeRecommendation.setScaleUpHostGroups(scaleUpHostGroups);\n+            }\n+        }\n+        if (resizeRecommendation.getScaleDownHostGroups().isEmpty()) {\n+            Set<String> scaleDownHostGroups = filterHostGroupByPredicate(blueprintTextProcessor, this::fallbackScaleDownFilter);\n+            if (!scaleDownHostGroups.isEmpty()) {\n+                resizeRecommendation.setScaleDownHostGroups(scaleDownHostGroups);\n+            }\n+        }\n+\n+        return resizeRecommendation;\n+    }\n+\n+    private boolean fallbackScaleUpFilter(String hostGroupName) {\n+        String lowerCaseName = hostGroupName.toLowerCase();\n+        return !lowerCaseName.contains(\"master\")\n+                && !lowerCaseName.contains(\"manager\");\n+    }\n+\n+    private boolean fallbackScaleDownFilter(String hostGroupName) {\n+        String lowerCaseName = hostGroupName.toLowerCase();\n+        return !lowerCaseName.contains(\"master\")\n+                && !lowerCaseName.contains(\"manager\");\n+    }\n+\n+    private AutoscaleRecommendation recommendAutoscale(BlueprintTextProcessor blueprintTextProcessor) {\n+        AutoscaleRecommendation autoscaleRecommendation = blueprintTextProcessor.recommendAutoscale();\n+\n+        if (autoscaleRecommendation.getHostGroups().isEmpty()) {\n+            Set<String> autoscaleGroups = filterHostGroupByPredicate(blueprintTextProcessor, this::fallbackAutoscaleFilter);\n+            if (!autoscaleGroups.isEmpty()) {\n+                autoscaleRecommendation = new AutoscaleRecommendation(autoscaleGroups);\n+            }\n+        }\n+\n+        return autoscaleRecommendation;\n+    }\n+\n+    private boolean fallbackAutoscaleFilter(String hostGroupName) {\n+        String lowerCaseName = hostGroupName.toLowerCase();\n+        return lowerCaseName.contains(\"compute\")\n+                || lowerCaseName.contains(\"gateway\");\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b07e74f8115a6232c571a3397d497694025b00a"}, "originalPosition": 112}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5b07e74f8115a6232c571a3397d497694025b00a", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/5b07e74f8115a6232c571a3397d497694025b00a", "committedDate": "2020-05-21T02:01:02Z", "message": "DISTX-421 DISTX-427 Recommendation for host groups' scalability\n\n1. Fixed a bug with respect to HA template. Added a fix and unit test."}, "afterCommit": {"oid": "ec21277bfa4a6a628228de47979c328d757d0a38", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/ec21277bfa4a6a628228de47979c328d757d0a38", "committedDate": "2020-05-21T22:11:51Z", "message": "DISTX-421 DISTX-427 Recommendation for host groups' scalability\n\n1. Added recommendations for auto-scalability and manual scalability.\n2. Implemented both fallback recommendations and CM service based recommendations.\n3. Tested in private stack."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2NTY5NzUz", "url": "https://github.com/hortonworks/cloudbreak/pull/8100#pullrequestreview-416569753", "createdAt": "2020-05-22T00:05:43Z", "commit": {"oid": "ec21277bfa4a6a628228de47979c328d757d0a38"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQwMDowNTo0M1rOGZGtNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQwMDoxNToyOFrOGZG3Yw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk3NzQ2MQ==", "bodyText": "All of these will likely need to be qualified as ServiceName.RoleName at some point.\ne.g. Both HDFS and YARN have a Role called 'GATEWAY' - and I'm guessing other services do as well.", "url": "https://github.com/hortonworks/cloudbreak/pull/8100#discussion_r428977461", "createdAt": "2020-05-22T00:05:43Z", "author": {"login": "sidseth"}, "path": "template-manager-cmtemplate/src/main/java/com/sequenceiq/cloudbreak/cmtemplate/BlackListedLoadBasedAutoscaleRole.java", "diffHunk": "@@ -0,0 +1,12 @@\n+package com.sequenceiq.cloudbreak.cmtemplate;\n+\n+public enum BlackListedLoadBasedAutoscaleRole {\n+    DATANODE,\n+    ZEPPELIN_SERVER,\n+    KAFKA_BROKER,\n+    NIFI_NODE,\n+    NAMENODE,\n+    // This is counter intuitive. Gateway and compute host groups have identical GATEWAY roles. So compute host group will be blacklisted initially.\n+    // The fallback filter will add only compute host group for load based auto-scale role.\n+    GATEWAY", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ec21277bfa4a6a628228de47979c328d757d0a38"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk4MDA2Nw==", "bodyText": "Using a blacklist will need all services from CM to be added in here; or make a new release of CB when we add new services.\nIf I'm not mistaken, with this set of services - the OperationDB (HBase) clusters will qualify for both Time and Load based AutoScaling.\nA Whitelist is an alternate, which comes with its own set of problems. i.e. if \"NODEMANAGER\" is the only role there, the GATEWAY roles that go along with the NODEMANAGER in a hostgroup will cause trouble.\nMaybe the GATEWAYs just need to be removed from processing. i.e. A GATEWAY (unless it is special) does not block a whitelisted role from being scaled, or in case of BLACKLISTING - GATEWAY roles are just filtered out. If that leads to no roles left for a hostGroup - the hostGroup is not scalable (but maybe we should allow this to be time scalable).\nI had a slightly different take on how this would work - based more on a 'Role' -> Capability mechanism - with all roles on a hostGroup combined together. A separate enum per capability (this patch) works as well.", "url": "https://github.com/hortonworks/cloudbreak/pull/8100#discussion_r428980067", "createdAt": "2020-05-22T00:15:28Z", "author": {"login": "sidseth"}, "path": "template-manager-cmtemplate/src/main/java/com/sequenceiq/cloudbreak/cmtemplate/BlackListedLoadBasedAutoscaleRole.java", "diffHunk": "@@ -0,0 +1,12 @@\n+package com.sequenceiq.cloudbreak.cmtemplate;\n+\n+public enum BlackListedLoadBasedAutoscaleRole {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ec21277bfa4a6a628228de47979c328d757d0a38"}, "originalPosition": 3}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5ODQwMDE0", "url": "https://github.com/hortonworks/cloudbreak/pull/8100#pullrequestreview-419840014", "createdAt": "2020-05-28T07:21:39Z", "commit": {"oid": "ec21277bfa4a6a628228de47979c328d757d0a38"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwNzoyMTozOVrOGbosbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwNzoyMTozOVrOGbosbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTYzMTQ2OA==", "bodyText": "Does it make sense to disable 'gateway' hosts from AutoScaling?, since we are not testing them.", "url": "https://github.com/hortonworks/cloudbreak/pull/8100#discussion_r431631468", "createdAt": "2020-05-28T07:21:39Z", "author": {"login": "sidseth"}, "path": "template-manager-cmtemplate/src/main/java/com/sequenceiq/cloudbreak/cmtemplate/BlackListedLoadBasedAutoscaleRole.java", "diffHunk": "@@ -0,0 +1,12 @@\n+package com.sequenceiq.cloudbreak.cmtemplate;\n+\n+public enum BlackListedLoadBasedAutoscaleRole {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk4MDA2Nw=="}, "originalCommit": {"oid": "ec21277bfa4a6a628228de47979c328d757d0a38"}, "originalPosition": 3}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f01e264abe83b6922f2c38af61ec565f91715dd0", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/f01e264abe83b6922f2c38af61ec565f91715dd0", "committedDate": "2020-05-29T01:16:47Z", "message": "DISTX-421 DISTX-427 Recommendation for host groups' scalability\n\n1. Added recommendations for auto-scalability and manual scalability.\n2. Implemented both fallback recommendations and CM service based recommendations.\n3. Tested in private stack."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ec21277bfa4a6a628228de47979c328d757d0a38", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/ec21277bfa4a6a628228de47979c328d757d0a38", "committedDate": "2020-05-21T22:11:51Z", "message": "DISTX-421 DISTX-427 Recommendation for host groups' scalability\n\n1. Added recommendations for auto-scalability and manual scalability.\n2. Implemented both fallback recommendations and CM service based recommendations.\n3. Tested in private stack."}, "afterCommit": {"oid": "f01e264abe83b6922f2c38af61ec565f91715dd0", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/f01e264abe83b6922f2c38af61ec565f91715dd0", "committedDate": "2020-05-29T01:16:47Z", "message": "DISTX-421 DISTX-427 Recommendation for host groups' scalability\n\n1. Added recommendations for auto-scalability and manual scalability.\n2. Implemented both fallback recommendations and CM service based recommendations.\n3. Tested in private stack."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyNTc0OTI5", "url": "https://github.com/hortonworks/cloudbreak/pull/8100#pullrequestreview-422574929", "createdAt": "2020-06-02T11:13:23Z", "commit": {"oid": "f01e264abe83b6922f2c38af61ec565f91715dd0"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxMToxMzoyM1rOGds8eg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxMToxMzo1NFrOGds9bA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzc5ODI2Ng==", "bodyText": "Set.copyOf, below line as well please", "url": "https://github.com/hortonworks/cloudbreak/pull/8100#discussion_r433798266", "createdAt": "2020-06-02T11:13:23Z", "author": {"login": "bergerdenes"}, "path": "core-api/src/main/java/com/sequenceiq/cloudbreak/api/endpoint/v4/connector/responses/AutoscaleRecommendationV4Response.java", "diffHunk": "@@ -0,0 +1,27 @@\n+package com.sequenceiq.cloudbreak.api.endpoint.v4.connector.responses;\n+\n+import java.util.Set;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.sequenceiq.common.model.JsonEntity;\n+\n+@JsonIgnoreProperties(ignoreUnknown = true)\n+public class AutoscaleRecommendationV4Response implements JsonEntity {\n+\n+    private final Set<String> timeBasedHostGroups;\n+\n+    private final Set<String> loadBasedHostGroups;\n+\n+    public AutoscaleRecommendationV4Response(Set<String> timeBasedHostGroups, Set<String> loadBasedHostGroups) {\n+        this.timeBasedHostGroups = timeBasedHostGroups;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f01e264abe83b6922f2c38af61ec565f91715dd0"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzc5ODUwOA==", "bodyText": "Set.copyOf, below line as well please", "url": "https://github.com/hortonworks/cloudbreak/pull/8100#discussion_r433798508", "createdAt": "2020-06-02T11:13:54Z", "author": {"login": "bergerdenes"}, "path": "core-api/src/main/java/com/sequenceiq/cloudbreak/api/endpoint/v4/connector/responses/ResizeRecommendationV4Response.java", "diffHunk": "@@ -0,0 +1,27 @@\n+package com.sequenceiq.cloudbreak.api.endpoint.v4.connector.responses;\n+\n+import java.util.Set;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.sequenceiq.common.model.JsonEntity;\n+\n+@JsonIgnoreProperties(ignoreUnknown = true)\n+public class ResizeRecommendationV4Response implements JsonEntity {\n+\n+    private final Set<String> scaleUpHostGroups;\n+\n+    private final Set<String> scaleDownHostGroups;\n+\n+    public ResizeRecommendationV4Response(Set<String> scaleUpHostGroups, Set<String> scaleDownHostGroups) {\n+        this.scaleUpHostGroups = scaleUpHostGroups;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f01e264abe83b6922f2c38af61ec565f91715dd0"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70fa74b1ed16e26cf32ecd91de1de87b6a57c54b", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/70fa74b1ed16e26cf32ecd91de1de87b6a57c54b", "committedDate": "2020-06-03T22:47:38Z", "message": "Address review comments from Denes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1MzQ4NDg2", "url": "https://github.com/hortonworks/cloudbreak/pull/8100#pullrequestreview-425348486", "createdAt": "2020-06-05T14:23:56Z", "commit": {"oid": "70fa74b1ed16e26cf32ecd91de1de87b6a57c54b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1854, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}