{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAwNzkwOTY3", "number": 9190, "title": "CB-8668: FreeIPA status updates should not incorrectly overwrite the \u2026", "bodyText": "\u2026status\nAdded health check to the end of a successful freeipa repair operation to update the stack status to available. Also change freeipa status from \"available\" to \"repair failed\" when a freeipa repair operation fails. Currently FreeIPA status is updated based on a flow completing rather than what the status should be regardless of whether it was in an available statue before. In case of a failed operation, the stack will report a false available status.\nSee detailed description in the commit message.", "createdAt": "2020-10-09T19:54:17Z", "url": "https://github.com/hortonworks/cloudbreak/pull/9190", "merged": true, "mergeCommit": {"oid": "c64286ddb370df86f400afd8fcb56bc5d3d725cf"}, "closed": true, "closedAt": "2020-10-21T16:04:02Z", "author": {"login": "christmasferret"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQ9E7egFqTUwNTk5MzgxNw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUufjUgBqjM5MDQzMjI0MjU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1OTkzODE3", "url": "https://github.com/hortonworks/cloudbreak/pull/9190#pullrequestreview-505993817", "createdAt": "2020-10-09T21:16:18Z", "commit": {"oid": "0abee58dc4e10d75b310a4ac11ce7869ec568850"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQyMToxNjoxOFrOHfY1bA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQyMToxNzowMlrOHfY2jw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY3NDc5Ng==", "bodyText": "shouldn't the stack be available if it has the UPSCALE_COMPLETED, DOWNSCALE_COMPLETED, or REPAIR_COMPLETED status? There are places we check whether a stack is available before performing an operation on it.", "url": "https://github.com/hortonworks/cloudbreak/pull/9190#discussion_r502674796", "createdAt": "2020-10-09T21:16:18Z", "author": {"login": "handavid"}, "path": "freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/stack/model/common/Status.java", "diffHunk": "@@ -33,10 +41,10 @@\n     public static final Collection<Status> AVAILABLE_STATUSES = List.of(AVAILABLE, MAINTENANCE_MODE_ENABLED);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0abee58dc4e10d75b310a4ac11ce7869ec568850"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY3NTA4Nw==", "bodyText": "should UPSCALE_COMPLETED, DOWNSCALE_COMPLETED, and REPAIR_COMPLETED also be removable? I'm not sure what isRemovable is used for.", "url": "https://github.com/hortonworks/cloudbreak/pull/9190#discussion_r502675087", "createdAt": "2020-10-09T21:17:02Z", "author": {"login": "handavid"}, "path": "freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/stack/model/common/Status.java", "diffHunk": "@@ -33,10 +41,10 @@\n     public static final Collection<Status> AVAILABLE_STATUSES = List.of(AVAILABLE, MAINTENANCE_MODE_ENABLED);\n \n     public static final Collection<Status> REMOVABLE_STATUSES = List.of(AVAILABLE, UPDATE_FAILED, CREATE_FAILED, DELETE_FAILED,\n-            DELETE_COMPLETED, STOPPED, START_FAILED, STOP_FAILED);\n+            DELETE_COMPLETED, STOPPED, START_FAILED, STOP_FAILED, REPAIR_FAILED, UPSCALE_FAILED, DOWNSCALE_FAILED);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0abee58dc4e10d75b310a4ac11ce7869ec568850"}, "originalPosition": 27}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0abee58dc4e10d75b310a4ac11ce7869ec568850", "author": {"user": {"login": "christmasferret", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/0abee58dc4e10d75b310a4ac11ce7869ec568850", "committedDate": "2020-10-09T18:41:00Z", "message": "CB-8668: FreeIPA status updates should not incorrectly overwrite the status\n\nChange freeipa status from \"available\" to \"repair completed\" when a freeipa repair operation succeeds. Also change freeipa status from \"available\" to \"repair failed\" when a freeipa repair operation fails. Currently FreeIPA status is updated based on a flow completing rather than what the status should be regardless of whether it was in an available statue before. Every 3 minutes, freeipa health check quartz job will automatically check the freeipa status and then update it to \"available\"."}, "afterCommit": {"oid": "0385c7df986c0b12a1010c729c8c18bc8436e2c0", "author": {"user": {"login": "christmasferret", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/0385c7df986c0b12a1010c729c8c18bc8436e2c0", "committedDate": "2020-10-12T22:15:55Z", "message": "CB-8668: FreeIPA status updates should not incorrectly overwrite the status\n\nChange freeipa status from \"available\" to \"repair completed\" when a freeipa repair operation succeeds. Also change freeipa status from \"available\" to \"repair failed\" when a freeipa repair operation fails. Currently FreeIPA status is updated based on a flow completing rather than what the status should be regardless of whether it was in an available statue before. Every 3 minutes, freeipa health check quartz job will automatically check the freeipa status and then update it to \"available\"."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0385c7df986c0b12a1010c729c8c18bc8436e2c0", "author": {"user": {"login": "christmasferret", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/0385c7df986c0b12a1010c729c8c18bc8436e2c0", "committedDate": "2020-10-12T22:15:55Z", "message": "CB-8668: FreeIPA status updates should not incorrectly overwrite the status\n\nChange freeipa status from \"available\" to \"repair completed\" when a freeipa repair operation succeeds. Also change freeipa status from \"available\" to \"repair failed\" when a freeipa repair operation fails. Currently FreeIPA status is updated based on a flow completing rather than what the status should be regardless of whether it was in an available statue before. Every 3 minutes, freeipa health check quartz job will automatically check the freeipa status and then update it to \"available\"."}, "afterCommit": {"oid": "5f49d3dd48b3a51c62287dcda4a0ea598260b937", "author": {"user": {"login": "christmasferret", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/5f49d3dd48b3a51c62287dcda4a0ea598260b937", "committedDate": "2020-10-14T12:49:10Z", "message": "CB-8668: FreeIPA status updates should not incorrectly overwrite the status\n\nAdded health check to the end of a successful freeipa repair operation to update the stack status to available. Also change freeipa status from \"available\" to \"repair failed\" when a freeipa repair operation fails. Currently FreeIPA status is updated based on a flow completing rather than what the status should be regardless of whether it was in an available statue before. In case of a failed operation, the stack will report a false available status."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4Njk3MDkx", "url": "https://github.com/hortonworks/cloudbreak/pull/9190#pullrequestreview-508697091", "createdAt": "2020-10-14T20:18:59Z", "commit": {"oid": "5f49d3dd48b3a51c62287dcda4a0ea598260b937"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMDoxOTowMFrOHhjkbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMDoxOTowMFrOHhjkbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk0NzgyMQ==", "bodyText": "this if can be combined with the if starting on line 162.", "url": "https://github.com/hortonworks/cloudbreak/pull/9190#discussion_r504947821", "createdAt": "2020-10-14T20:19:00Z", "author": {"login": "handavid"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/flow/freeipa/repair/changeprimarygw/action/ChangePrimaryGatewayActions.java", "diffHunk": "@@ -150,7 +154,11 @@ protected void doExecute(ChangePrimaryGatewayContext context, StackEvent payload\n                 Stack stack = context.getStack();\n                 SuccessDetails successDetails = new SuccessDetails(stack.getEnvironmentCrn());\n \n-                stackUpdater.updateStackStatus(stack.getId(), getChangePrimaryGatewayCompleteStatus(variables), \"Finished changing the primary gateway\");\n+                if (isFinalChain(variables)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5f49d3dd48b3a51c62287dcda4a0ea598260b937"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExNDc2MDky", "url": "https://github.com/hortonworks/cloudbreak/pull/9190#pullrequestreview-511476092", "createdAt": "2020-10-19T07:25:48Z", "commit": {"oid": "5f49d3dd48b3a51c62287dcda4a0ea598260b937"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwNzoyNTo0OFrOHkA_mQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwNzozMDowMlrOHkBINw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzUyNzA2NQ==", "bodyText": "still missing the failure states from here", "url": "https://github.com/hortonworks/cloudbreak/pull/9190#discussion_r507527065", "createdAt": "2020-10-19T07:25:48Z", "author": {"login": "lacikaaa"}, "path": "freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/stack/model/common/Status.java", "diffHunk": "@@ -32,11 +37,11 @@\n \n     public static final Collection<Status> AVAILABLE_STATUSES = List.of(AVAILABLE, MAINTENANCE_MODE_ENABLED);\n \n-    public static final Collection<Status> REMOVABLE_STATUSES = List.of(AVAILABLE, UPDATE_FAILED, CREATE_FAILED, DELETE_FAILED,\n+    public static final Collection<Status>  REMOVABLE_STATUSES = List.of(AVAILABLE, UPDATE_FAILED, CREATE_FAILED, DELETE_FAILED,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5f49d3dd48b3a51c62287dcda4a0ea598260b937"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzUyOTI3MQ==", "bodyText": "getChangePrimaryGatewayCompleteStatus implementation also checks isFinalChain(variables) which doesn't make too much sense after this change. most probably you should replace the method call with DetailedStackStatus.REPAIR_IN_PROGRESS", "url": "https://github.com/hortonworks/cloudbreak/pull/9190#discussion_r507529271", "createdAt": "2020-10-19T07:30:02Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/flow/freeipa/repair/changeprimarygw/action/ChangePrimaryGatewayActions.java", "diffHunk": "@@ -150,7 +154,11 @@ protected void doExecute(ChangePrimaryGatewayContext context, StackEvent payload\n                 Stack stack = context.getStack();\n                 SuccessDetails successDetails = new SuccessDetails(stack.getEnvironmentCrn());\n \n-                stackUpdater.updateStackStatus(stack.getId(), getChangePrimaryGatewayCompleteStatus(variables), \"Finished changing the primary gateway\");\n+                if (isFinalChain(variables)) {\n+                    stackStatusCheckerJob.syncAStack(stack);\n+                } else {\n+                    stackUpdater.updateStackStatus(stack.getId(), getChangePrimaryGatewayCompleteStatus(variables), \"Finished changing the primary gateway\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5f49d3dd48b3a51c62287dcda4a0ea598260b937"}, "originalPosition": 25}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5f49d3dd48b3a51c62287dcda4a0ea598260b937", "author": {"user": {"login": "christmasferret", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/5f49d3dd48b3a51c62287dcda4a0ea598260b937", "committedDate": "2020-10-14T12:49:10Z", "message": "CB-8668: FreeIPA status updates should not incorrectly overwrite the status\n\nAdded health check to the end of a successful freeipa repair operation to update the stack status to available. Also change freeipa status from \"available\" to \"repair failed\" when a freeipa repair operation fails. Currently FreeIPA status is updated based on a flow completing rather than what the status should be regardless of whether it was in an available statue before. In case of a failed operation, the stack will report a false available status."}, "afterCommit": {"oid": "59a4e79b48a74caa04cd98940585d7b44a575e68", "author": {"user": {"login": "christmasferret", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/59a4e79b48a74caa04cd98940585d7b44a575e68", "committedDate": "2020-10-20T01:27:59Z", "message": "CB-8668: FreeIPA status updates should not incorrectly overwrite the status\n\nChange freeipa status from \"available\" to \"repair completed\" when a freeipa repair operation succeeds. Also change freeipa status from \"available\" to \"repair failed\" when a freeipa repair operation fails. Currently FreeIPA status is updated based on a flow completing rather than what the status should be regardless of whether it was in an available statue before. Every 3 minutes, freeipa health check quartz job will automatically check the freeipa status and then update it to \"available\"."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyMjY4MTM3", "url": "https://github.com/hortonworks/cloudbreak/pull/9190#pullrequestreview-512268137", "createdAt": "2020-10-20T01:30:12Z", "commit": {"oid": "59a4e79b48a74caa04cd98940585d7b44a575e68"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQwMTozMDoxMlrOHknUQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQwMTozMjozMlrOHknWpA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODE1NDk0NQ==", "bodyText": "I added the newly added failed states (REPAIR_FAILED, UPSCALE_FAILED, DOWNSCALE_FAILED) to removable states now. Thanks!", "url": "https://github.com/hortonworks/cloudbreak/pull/9190#discussion_r508154945", "createdAt": "2020-10-20T01:30:12Z", "author": {"login": "christmasferret"}, "path": "freeipa-api/src/main/java/com/sequenceiq/freeipa/api/v1/freeipa/stack/model/common/Status.java", "diffHunk": "@@ -33,10 +41,10 @@\n     public static final Collection<Status> AVAILABLE_STATUSES = List.of(AVAILABLE, MAINTENANCE_MODE_ENABLED);\n \n     public static final Collection<Status> REMOVABLE_STATUSES = List.of(AVAILABLE, UPDATE_FAILED, CREATE_FAILED, DELETE_FAILED,\n-            DELETE_COMPLETED, STOPPED, START_FAILED, STOP_FAILED);\n+            DELETE_COMPLETED, STOPPED, START_FAILED, STOP_FAILED, REPAIR_FAILED, UPSCALE_FAILED, DOWNSCALE_FAILED);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY3NTA4Nw=="}, "originalCommit": {"oid": "0abee58dc4e10d75b310a4ac11ce7869ec568850"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODE1NTU1Ng==", "bodyText": "Thanks a lot for the suggestion. I've combined the two \"if\"s and tested the flow again.\nAfter repair, the status check updates it to available.", "url": "https://github.com/hortonworks/cloudbreak/pull/9190#discussion_r508155556", "createdAt": "2020-10-20T01:32:32Z", "author": {"login": "christmasferret"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/flow/freeipa/repair/changeprimarygw/action/ChangePrimaryGatewayActions.java", "diffHunk": "@@ -150,7 +154,11 @@ protected void doExecute(ChangePrimaryGatewayContext context, StackEvent payload\n                 Stack stack = context.getStack();\n                 SuccessDetails successDetails = new SuccessDetails(stack.getEnvironmentCrn());\n \n-                stackUpdater.updateStackStatus(stack.getId(), getChangePrimaryGatewayCompleteStatus(variables), \"Finished changing the primary gateway\");\n+                if (isFinalChain(variables)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk0NzgyMQ=="}, "originalCommit": {"oid": "5f49d3dd48b3a51c62287dcda4a0ea598260b937"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyNTA5NDkx", "url": "https://github.com/hortonworks/cloudbreak/pull/9190#pullrequestreview-512509491", "createdAt": "2020-10-20T09:27:32Z", "commit": {"oid": "59a4e79b48a74caa04cd98940585d7b44a575e68"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzMTQ0MDk0", "url": "https://github.com/hortonworks/cloudbreak/pull/9190#pullrequestreview-513144094", "createdAt": "2020-10-20T21:22:00Z", "commit": {"oid": "59a4e79b48a74caa04cd98940585d7b44a575e68"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "59a4e79b48a74caa04cd98940585d7b44a575e68", "author": {"user": {"login": "christmasferret", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/59a4e79b48a74caa04cd98940585d7b44a575e68", "committedDate": "2020-10-20T01:27:59Z", "message": "CB-8668: FreeIPA status updates should not incorrectly overwrite the status\n\nChange freeipa status from \"available\" to \"repair completed\" when a freeipa repair operation succeeds. Also change freeipa status from \"available\" to \"repair failed\" when a freeipa repair operation fails. Currently FreeIPA status is updated based on a flow completing rather than what the status should be regardless of whether it was in an available statue before. Every 3 minutes, freeipa health check quartz job will automatically check the freeipa status and then update it to \"available\"."}, "afterCommit": {"oid": "0597a180cc7abd7b1a17fe721cec8d5065ea2715", "author": {"user": {"login": "christmasferret", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/0597a180cc7abd7b1a17fe721cec8d5065ea2715", "committedDate": "2020-10-21T13:56:18Z", "message": "CB-8668: FreeIPA status updates should not incorrectly overwrite the status\n\nChange freeipa status from \"available\" to \"repair completed\" when a freeipa repair operation succeeds. Also change freeipa status from \"available\" to \"repair failed\" when a freeipa repair operation fails. Currently FreeIPA status is updated based on a flow completing rather than what the status should be regardless of whether it was in an available statue before. Every 3 minutes, freeipa health check quartz job will automatically check the freeipa status and then update it to \"available\"."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b387009d590a3bd76077ebc429a3463c0190ddcf", "author": {"user": {"login": "christmasferret", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/b387009d590a3bd76077ebc429a3463c0190ddcf", "committedDate": "2020-10-21T14:44:37Z", "message": "CB-8668: FreeIPA status updates should not incorrectly overwrite the status\n\nChange freeipa status from \"available\" to \"repair completed\" when a freeipa repair operation succeeds. Also change freeipa status from \"available\" to \"repair failed\" when a freeipa repair operation fails. Currently FreeIPA status is updated based on a flow completing rather than what the status should be regardless of whether it was in an available statue before. Every 3 minutes, freeipa health check quartz job will automatically check the freeipa status and then update it to \"available\"."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0597a180cc7abd7b1a17fe721cec8d5065ea2715", "author": {"user": {"login": "christmasferret", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/0597a180cc7abd7b1a17fe721cec8d5065ea2715", "committedDate": "2020-10-21T13:56:18Z", "message": "CB-8668: FreeIPA status updates should not incorrectly overwrite the status\n\nChange freeipa status from \"available\" to \"repair completed\" when a freeipa repair operation succeeds. Also change freeipa status from \"available\" to \"repair failed\" when a freeipa repair operation fails. Currently FreeIPA status is updated based on a flow completing rather than what the status should be regardless of whether it was in an available statue before. Every 3 minutes, freeipa health check quartz job will automatically check the freeipa status and then update it to \"available\"."}, "afterCommit": {"oid": "b387009d590a3bd76077ebc429a3463c0190ddcf", "author": {"user": {"login": "christmasferret", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/b387009d590a3bd76077ebc429a3463c0190ddcf", "committedDate": "2020-10-21T14:44:37Z", "message": "CB-8668: FreeIPA status updates should not incorrectly overwrite the status\n\nChange freeipa status from \"available\" to \"repair completed\" when a freeipa repair operation succeeds. Also change freeipa status from \"available\" to \"repair failed\" when a freeipa repair operation fails. Currently FreeIPA status is updated based on a flow completing rather than what the status should be regardless of whether it was in an available statue before. Every 3 minutes, freeipa health check quartz job will automatically check the freeipa status and then update it to \"available\"."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2142, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}