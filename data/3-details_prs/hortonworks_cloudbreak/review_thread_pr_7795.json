{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAzNTIxODU1", "number": 7795, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQwNzoxMjo1M1rODx8V8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwNzo1NDo0OFrODyYeYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzNjk1NDc0OnYy", "diffSide": "RIGHT", "path": "freeipa/src/main/resources/freeipa-salt/salt/freeipa/init.sls", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQwNzoxMjo1M1rOGFspDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxMzozNToyNFrOGF590Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODYyNzQ2OQ==", "bodyText": "I'm not sure it's a good idea to put a new folder under /. Couldn't we just put it under /opt somewhere?", "url": "https://github.com/hortonworks/cloudbreak/pull/7795#discussion_r408627469", "createdAt": "2020-04-15T07:12:53Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/resources/freeipa-salt/salt/freeipa/init.sls", "diffHunk": "@@ -18,6 +18,16 @@ net.ipv6.conf.lo.disable_ipv6:\n       - {{ host['fqdn'] }}\n {% endfor %}\n \n+{% if salt['pillar.get']('freeipa:hosts') > 1 %}\n+/cdp/ipahealthagent/freeipa_cluster_node:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d61cf9f116c837b96033686672690f7ea95018a"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg0NTc3Nw==", "bodyText": "/cdp already existed from cluster proxy so seemed like a reasonable place to put it.\nThese already exist:\n/cdp/bin/reverse-tunnel.sh\n/cdp/bin/reverse-tunnel-values.sh\n/cdp/bin/update-reverse-tunnel-values.sh", "url": "https://github.com/hortonworks/cloudbreak/pull/7795#discussion_r408845777", "createdAt": "2020-04-15T13:35:24Z", "author": {"login": "holleyism"}, "path": "freeipa/src/main/resources/freeipa-salt/salt/freeipa/init.sls", "diffHunk": "@@ -18,6 +18,16 @@ net.ipv6.conf.lo.disable_ipv6:\n       - {{ host['fqdn'] }}\n {% endfor %}\n \n+{% if salt['pillar.get']('freeipa:hosts') > 1 %}\n+/cdp/ipahealthagent/freeipa_cluster_node:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODYyNzQ2OQ=="}, "originalCommit": {"oid": "7d61cf9f116c837b96033686672690f7ea95018a"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzNzAxNDU5OnYy", "diffSide": "RIGHT", "path": "freeipa/src/main/resources/freeipa-salt/salt/freeipa/common-install.sls", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQwNzozMDo1N1rOGFtN2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxMzozMjoyNVrOGF51KQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODYzNjg4OQ==", "bodyText": "do we really need a separate file for this unless?", "url": "https://github.com/hortonworks/cloudbreak/pull/7795#discussion_r408636889", "createdAt": "2020-04-15T07:30:57Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/resources/freeipa-salt/salt/freeipa/common-install.sls", "diffHunk": "@@ -65,3 +65,20 @@ restart_httpd:\n     - watch:\n       - file: /etc/httpd/conf.d/ipa-rewrite.conf\n \n+install-healthagent:\n+  cmd.run:\n+    - name: /opt/salt/scripts/freeipa_healthagent_setup.sh\n+    - env:\n+        - FPW: {{salt['pillar.get']('freeipa:password')}}\n+    - failhard: True\n+    - unless: /opt/salt/scripts/freeipa_check_replication.sh", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d61cf9f116c837b96033686672690f7ea95018a"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg0MzU2MQ==", "bodyText": "Yes.  Because of the '|', salt seems to have problems with it.  I tried several different permutations of escaping the character and using cmd.shell, but I kept receiving this error:Failed: Orchestrator component went failed in 4 min(s), message: Salt execution went wrong: Rendering SLS 'base:freeipa.common-install' failed: mapping values are not allowed here; line 60 --- [...] cmd.run: - name: /opt/salt/scripts/freeipa_healthagent_setup.sh - env: - FPW: gnM3.B3J3G3l+-55j?Fe6V7CzDbdmkE_ - failhard: True - unless: ldapsearch -x -h localhost -b cn=config '(objectclass=nsds5replicationagreement)' | grep \"^objectClass: nsds5replicationagreement\"", "url": "https://github.com/hortonworks/cloudbreak/pull/7795#discussion_r408843561", "createdAt": "2020-04-15T13:32:25Z", "author": {"login": "holleyism"}, "path": "freeipa/src/main/resources/freeipa-salt/salt/freeipa/common-install.sls", "diffHunk": "@@ -65,3 +65,20 @@ restart_httpd:\n     - watch:\n       - file: /etc/httpd/conf.d/ipa-rewrite.conf\n \n+install-healthagent:\n+  cmd.run:\n+    - name: /opt/salt/scripts/freeipa_healthagent_setup.sh\n+    - env:\n+        - FPW: {{salt['pillar.get']('freeipa:password')}}\n+    - failhard: True\n+    - unless: /opt/salt/scripts/freeipa_check_replication.sh", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODYzNjg4OQ=="}, "originalCommit": {"oid": "7d61cf9f116c837b96033686672690f7ea95018a"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0MTU0NzI3OnYy", "diffSide": "RIGHT", "path": "freeipa/src/main/resources/freeipa-salt/salt/freeipa/scripts/freeipa_healthagent_setup.sh", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwNzo1MDo1MFrOGGY2Yg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxNDoxNjowNVrOGGngTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM1MTc3OA==", "bodyText": "does it cause any issue on a system which doesn't have the agent installed?", "url": "https://github.com/hortonworks/cloudbreak/pull/7795#discussion_r409351778", "createdAt": "2020-04-16T07:50:50Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/resources/freeipa-salt/salt/freeipa/scripts/freeipa_healthagent_setup.sh", "diffHunk": "@@ -0,0 +1,20 @@\n+#!/usr/bin/env bash\n+\n+set -e\n+\n+#\n+# Add anonymous access only for replication agreements\n+#\n+export HOSTCN=`hostname -f| sed -E 's/^|\\./,dc=/g' | sed 's/^,[^,]*,//g'`\n+\n+ldapmodify -x -D \"cn=directory manager\" -w $FPW  -h $HOSTNAME << EOF\n+dn: cn=\"$HOSTCN\",cn=mapping tree,cn=config\n+changetype: modify\n+add: aci\n+aci: (targetattr=*)(targetfilter=\"(|(objectclass=nsds5replicationagreement)(objectclass=nsDSWindowsReplicationAgreement))\")(version 3.0; aci \"permission:Read Replication Agreements\"; allow (read, search, compare) groupdn = \"ldap:///anyone\";)\n+EOF\n+\n+#\n+# Add the cert extraction to run when the certificate is updated\n+#\n+ipa-getcert start-tracking -n Server-Cert -d /etc/httpd/alias -C \"/usr/libexec/ipa/certmonger/restart_httpd;systemctl restart freeipa_healthagent\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d61cf9f116c837b96033686672690f7ea95018a"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU5MTg4Nw==", "bodyText": "removed.  will make it part of the RPM", "url": "https://github.com/hortonworks/cloudbreak/pull/7795#discussion_r409591887", "createdAt": "2020-04-16T14:16:05Z", "author": {"login": "holleyism"}, "path": "freeipa/src/main/resources/freeipa-salt/salt/freeipa/scripts/freeipa_healthagent_setup.sh", "diffHunk": "@@ -0,0 +1,20 @@\n+#!/usr/bin/env bash\n+\n+set -e\n+\n+#\n+# Add anonymous access only for replication agreements\n+#\n+export HOSTCN=`hostname -f| sed -E 's/^|\\./,dc=/g' | sed 's/^,[^,]*,//g'`\n+\n+ldapmodify -x -D \"cn=directory manager\" -w $FPW  -h $HOSTNAME << EOF\n+dn: cn=\"$HOSTCN\",cn=mapping tree,cn=config\n+changetype: modify\n+add: aci\n+aci: (targetattr=*)(targetfilter=\"(|(objectclass=nsds5replicationagreement)(objectclass=nsDSWindowsReplicationAgreement))\")(version 3.0; aci \"permission:Read Replication Agreements\"; allow (read, search, compare) groupdn = \"ldap:///anyone\";)\n+EOF\n+\n+#\n+# Add the cert extraction to run when the certificate is updated\n+#\n+ipa-getcert start-tracking -n Server-Cert -d /etc/httpd/alias -C \"/usr/libexec/ipa/certmonger/restart_httpd;systemctl restart freeipa_healthagent\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM1MTc3OA=="}, "originalCommit": {"oid": "7d61cf9f116c837b96033686672690f7ea95018a"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0MTU2Mzg3OnYy", "diffSide": "RIGHT", "path": "freeipa/src/main/resources/freeipa-salt/salt/freeipa/scripts/freeipa_healthagent_setup.sh", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwNzo1NDo0OFrOGGZAaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxNDoxNTo1NVrOGGnfsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM1NDM0NA==", "bodyText": "using hostname -d would simplify the sed a bit I think", "url": "https://github.com/hortonworks/cloudbreak/pull/7795#discussion_r409354344", "createdAt": "2020-04-16T07:54:48Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/resources/freeipa-salt/salt/freeipa/scripts/freeipa_healthagent_setup.sh", "diffHunk": "@@ -0,0 +1,20 @@\n+#!/usr/bin/env bash\n+\n+set -e\n+\n+#\n+# Add anonymous access only for replication agreements\n+#\n+export HOSTCN=`hostname -f| sed -E 's/^|\\./,dc=/g' | sed 's/^,[^,]*,//g'`", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d61cf9f116c837b96033686672690f7ea95018a"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU5MTczMA==", "bodyText": "changed.", "url": "https://github.com/hortonworks/cloudbreak/pull/7795#discussion_r409591730", "createdAt": "2020-04-16T14:15:55Z", "author": {"login": "holleyism"}, "path": "freeipa/src/main/resources/freeipa-salt/salt/freeipa/scripts/freeipa_healthagent_setup.sh", "diffHunk": "@@ -0,0 +1,20 @@\n+#!/usr/bin/env bash\n+\n+set -e\n+\n+#\n+# Add anonymous access only for replication agreements\n+#\n+export HOSTCN=`hostname -f| sed -E 's/^|\\./,dc=/g' | sed 's/^,[^,]*,//g'`", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM1NDM0NA=="}, "originalCommit": {"oid": "7d61cf9f116c837b96033686672690f7ea95018a"}, "originalPosition": 8}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2555, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}