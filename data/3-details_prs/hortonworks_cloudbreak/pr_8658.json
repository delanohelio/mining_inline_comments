{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU3ODQyNDU2", "number": 8658, "title": "CB-7729 Retrieve errors from Data Lake Database backup/restore failures", "bodyText": "Pulls the status reason for failed database backup/restore operations from the\nsalt stderr ouput, instead of from the command comment. The is achieved by\nadding a new YAML file used by SaltErrorResolver, stderrcommands.yaml. When a\ncommand listed in that file is run, the stderr output will be used as the\nresolved error message. The getErrorResultSummary() method in RunnerInfo now\nreturns the summary in map form for simpler parsing in SaltErrorResolver.\nTested with unit tests and by testing in my local cloudbreak dev environment.\nSee detailed description in the commit message.", "createdAt": "2020-07-28T14:19:36Z", "url": "https://github.com/hortonworks/cloudbreak/pull/8658", "merged": true, "mergeCommit": {"oid": "d97ffdd825574e07a507e61bde8079608b0bb0a3"}, "closed": true, "closedAt": "2020-08-03T21:09:47Z", "author": {"login": "hreeve-cloudera"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5X3-HgFqTQ1NjczMzYyOA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7YobxAFqTQ2MDM0Mjg2NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2NzMzNjI4", "url": "https://github.com/hortonworks/cloudbreak/pull/8658#pullrequestreview-456733628", "createdAt": "2020-07-28T15:08:42Z", "commit": {"oid": "17dd626c6d4cbc749ef7f1e8b91a1585f3ad8d80"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNTowODo0M1rOG4RXtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNTowODo0M1rOG4RXtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTY1ODAzNw==", "bodyText": "Perhaps worth extracting as a (private) constant. \ud83d\ude04", "url": "https://github.com/hortonworks/cloudbreak/pull/8658#discussion_r461658037", "createdAt": "2020-07-28T15:08:43Z", "author": {"login": "lajosrodek"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/core/flow2/cluster/datalake/dr/BackupRestoreStatusService.java", "diffHunk": "@@ -61,7 +61,15 @@ public void restoreDatabaseFinished(long stackId) {\n \n     public void handleDatabaseRestoreFailure(long stackId, String errorReason, DetailedStackStatus detailedStatus) {\n         clusterService.updateClusterStatusByStackId(stackId, Status.RESTORE_FAILED, errorReason);\n-        stackUpdater.updateStackStatus(stackId, detailedStatus);\n+        stackUpdater.updateStackStatus(stackId, detailedStatus, extractSaltErrorIfAvailable(errorReason));\n         flowMessageService.fireEventAndLog(stackId, Status.UPDATE_FAILED.name(), DATALAKE_DATABASE_RESTORE_FAILED, errorReason);\n     }\n+\n+    private String extractSaltErrorIfAvailable(String errorReason) {\n+        String errors = \"Error(s): \";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17dd626c6d4cbc749ef7f1e8b91a1585f3ad8d80"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2NzYyNTI4", "url": "https://github.com/hortonworks/cloudbreak/pull/8658#pullrequestreview-456762528", "createdAt": "2020-07-28T15:39:49Z", "commit": {"oid": "17dd626c6d4cbc749ef7f1e8b91a1585f3ad8d80"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNTozOTo0OVrOG4Su9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNTozOTo0OVrOG4Su9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTY4MDM3NQ==", "bodyText": "Do we know when the error is available in salt/errormessages.yaml and salt/stderrcommands.yaml files?", "url": "https://github.com/hortonworks/cloudbreak/pull/8658#discussion_r461680375", "createdAt": "2020-07-28T15:39:49Z", "author": {"login": "kkalvagadda1"}, "path": "orchestrator-salt/src/main/java/com/sequenceiq/cloudbreak/orchestrator/salt/SaltErrorResolver.java", "diffHunk": "@@ -49,12 +55,15 @@ public void init() {\n             String file = FileReaderUtils.readFileFromClasspath(\"salt/errormessages.yaml\");\n             errorMessages = new Yaml().load(file);\n             LOGGER.info(\"Error messages for salt: {}\", errorMessages);\n+            file = FileReaderUtils.readFileFromClasspath(\"salt/stderrcommands.yaml\");\n+            commandsWithStderrFailures = new Yaml().load(file);\n+            LOGGER.info(\"Salt commands that will pull the failure from stderr: {}\", commandsWithStderrFailures);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17dd626c6d4cbc749ef7f1e8b91a1585f3ad8d80"}, "originalPosition": 59}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "17dd626c6d4cbc749ef7f1e8b91a1585f3ad8d80", "author": {"user": {"login": "hreeve-cloudera", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/17dd626c6d4cbc749ef7f1e8b91a1585f3ad8d80", "committedDate": "2020-07-28T14:09:23Z", "message": "CB-7729 Retrieve errors from Data Lake Database backup/restore failures\n\nPulls the status reason for failed database backup/restore operations from the\nsalt stderr ouput, instead of from the command comment. The is achieved by\nadding a new YAML file used by SaltErrorResolver, stderrcommands.yaml. When a\ncommand listed in that file is run, the stderr output will be used as the\nresolved error message. The getErrorResultSummary() method in RunnerInfo now\nreturns the summary in map form for simpler parsing in SaltErrorResolver.\n\nTested with unit tests and by testing in my local cloudbreak dev environment."}, "afterCommit": {"oid": "6c9f755615191990a7fcd5532a78fda1290953fb", "author": {"user": {"login": "hreeve-cloudera", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/6c9f755615191990a7fcd5532a78fda1290953fb", "committedDate": "2020-07-28T15:25:03Z", "message": "CB-7729 Retrieve errors from Data Lake Database backup/restore failures\n\nPulls the status reason for failed database backup/restore operations from the\nsalt stderr ouput, instead of from the command comment. The is achieved by\nadding a new YAML file used by SaltErrorResolver, stderrcommands.yaml. When a\ncommand listed in that file is run, the stderr output will be used as the\nresolved error message. The getErrorResultSummary() method in RunnerInfo now\nreturns the summary in map form for simpler parsing in SaltErrorResolver.\n\nTested with unit tests and by testing in my local cloudbreak dev environment."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwMjI5NzI5", "url": "https://github.com/hortonworks/cloudbreak/pull/8658#pullrequestreview-460229729", "createdAt": "2020-08-03T17:56:38Z", "commit": {"oid": "6c9f755615191990a7fcd5532a78fda1290953fb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d4b4c6a18fa830ce9c32b109b8960308c36b261", "author": {"user": {"login": "hreeve-cloudera", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/0d4b4c6a18fa830ce9c32b109b8960308c36b261", "committedDate": "2020-08-03T18:13:40Z", "message": "CB-7729 Retrieve errors from Data Lake Database backup/restore failures\n\nPulls the status reason for failed database backup/restore operations from the\nsalt stderr ouput, instead of from the command comment. The is achieved by\nadding a new YAML file used by SaltErrorResolver, stderrcommands.yaml. When a\ncommand listed in that file is run, the stderr output will be used as the\nresolved error message. The getErrorResultSummary() method in RunnerInfo now\nreturns the summary in map form for simpler parsing in SaltErrorResolver.\n\nTested with unit tests and by testing in my local cloudbreak dev environment."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6c9f755615191990a7fcd5532a78fda1290953fb", "author": {"user": {"login": "hreeve-cloudera", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/6c9f755615191990a7fcd5532a78fda1290953fb", "committedDate": "2020-07-28T15:25:03Z", "message": "CB-7729 Retrieve errors from Data Lake Database backup/restore failures\n\nPulls the status reason for failed database backup/restore operations from the\nsalt stderr ouput, instead of from the command comment. The is achieved by\nadding a new YAML file used by SaltErrorResolver, stderrcommands.yaml. When a\ncommand listed in that file is run, the stderr output will be used as the\nresolved error message. The getErrorResultSummary() method in RunnerInfo now\nreturns the summary in map form for simpler parsing in SaltErrorResolver.\n\nTested with unit tests and by testing in my local cloudbreak dev environment."}, "afterCommit": {"oid": "0d4b4c6a18fa830ce9c32b109b8960308c36b261", "author": {"user": {"login": "hreeve-cloudera", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/0d4b4c6a18fa830ce9c32b109b8960308c36b261", "committedDate": "2020-08-03T18:13:40Z", "message": "CB-7729 Retrieve errors from Data Lake Database backup/restore failures\n\nPulls the status reason for failed database backup/restore operations from the\nsalt stderr ouput, instead of from the command comment. The is achieved by\nadding a new YAML file used by SaltErrorResolver, stderrcommands.yaml. When a\ncommand listed in that file is run, the stderr output will be used as the\nresolved error message. The getErrorResultSummary() method in RunnerInfo now\nreturns the summary in map form for simpler parsing in SaltErrorResolver.\n\nTested with unit tests and by testing in my local cloudbreak dev environment."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwMzQyODY1", "url": "https://github.com/hortonworks/cloudbreak/pull/8658#pullrequestreview-460342865", "createdAt": "2020-08-03T21:09:30Z", "commit": {"oid": "0d4b4c6a18fa830ce9c32b109b8960308c36b261"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2509, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}