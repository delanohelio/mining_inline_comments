{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM0MzczOTMw", "number": 9600, "title": "CB-10075 Upgrade image selection logic should not depend on image catalog URL", "bodyText": "CB-10075 Upgrade image selection logic should not depend on image catalog URL\n\nFirst try to use imagecatalog by name given in the current image\nif image catalog is not found by name, use the stored imagecatalog url instead", "createdAt": "2020-12-08T11:07:50Z", "url": "https://github.com/hortonworks/cloudbreak/pull/9600", "merged": true, "mergeCommit": {"oid": "608ce9ed3a65ca3551022c6299ef1e5220be744e"}, "closed": true, "closedAt": "2020-12-09T15:07:47Z", "author": {"login": "schfeca75"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdkLv2oAFqTU0NzMzNjU4Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdke_f0gFqTU0ODE5NTEyMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3MzM2NTgy", "url": "https://github.com/hortonworks/cloudbreak/pull/9600#pullrequestreview-547336582", "createdAt": "2020-12-08T15:19:43Z", "commit": {"oid": "36b451f2bfe48187ac02459aa663015211f2e391"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxNToxOTo0NFrOIBiwww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxNToxOTo0NFrOIBiwww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODQ4OTAyNw==", "bodyText": "Perhaps you could extend these branches with log messages why we are using a certain url.", "url": "https://github.com/hortonworks/cloudbreak/pull/9600#discussion_r538489027", "createdAt": "2020-12-08T15:19:44Z", "author": {"login": "keyki"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/service/upgrade/ClusterUpgradeAvailabilityService.java", "diffHunk": "@@ -180,7 +185,14 @@ private Image getCurrentImageFromCatalog(String currentImageId, CloudbreakImageC\n         return imageService.getImage(stack.getId());\n     }\n \n-    private CloudbreakImageCatalogV3 getImagesFromCatalog(String imageCatalogUrl) throws CloudbreakImageCatalogException {\n+    private CloudbreakImageCatalogV3 getImagesFromCatalog(Workspace workspace,\n+            com.sequenceiq.cloudbreak.cloud.model.Image image) throws CloudbreakImageCatalogException {\n+        String imageCatalogUrl;\n+        try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36b451f2bfe48187ac02459aa663015211f2e391"}, "originalPosition": 54}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3MzQ3MDIy", "url": "https://github.com/hortonworks/cloudbreak/pull/9600#pullrequestreview-547347022", "createdAt": "2020-12-08T15:30:08Z", "commit": {"oid": "36b451f2bfe48187ac02459aa663015211f2e391"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxNTozMDowOFrOIBjd8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxNTozMjozNFrOIBjpSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODUwMDU5NQ==", "bodyText": "typo: returns -> return", "url": "https://github.com/hortonworks/cloudbreak/pull/9600#discussion_r538500595", "createdAt": "2020-12-08T15:30:08Z", "author": {"login": "pdarvasi"}, "path": "core/src/test/java/com/sequenceiq/cloudbreak/service/upgrade/ClusterUpgradeAvailabilityServiceTest.java", "diffHunk": "@@ -155,18 +167,56 @@ public void testCheckForUpgradesByNameShouldReturnsImagesWhenThereAreAvailableIm\n                 currentImage.getImageCatalogName());\n     }\n \n+    @Test\n+    public void testCheckForUpgradesByNameShouldReturnsImagesFromFallbackCatalogWhenThereAreAvailableImagesButImageCatalogByNameNotFound()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36b451f2bfe48187ac02459aa663015211f2e391"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODUwMzA3NQ==", "bodyText": "could you pls have a unit test to cover \"ImageCatalogByNameFound()\"", "url": "https://github.com/hortonworks/cloudbreak/pull/9600#discussion_r538503075", "createdAt": "2020-12-08T15:32:15Z", "author": {"login": "pdarvasi"}, "path": "core/src/test/java/com/sequenceiq/cloudbreak/service/upgrade/ClusterUpgradeAvailabilityServiceTest.java", "diffHunk": "@@ -155,18 +167,56 @@ public void testCheckForUpgradesByNameShouldReturnsImagesWhenThereAreAvailableIm\n                 currentImage.getImageCatalogName());\n     }\n \n+    @Test\n+    public void testCheckForUpgradesByNameShouldReturnsImagesFromFallbackCatalogWhenThereAreAvailableImagesButImageCatalogByNameNotFound()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36b451f2bfe48187ac02459aa663015211f2e391"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODUwMzQ5Nw==", "bodyText": "+1", "url": "https://github.com/hortonworks/cloudbreak/pull/9600#discussion_r538503497", "createdAt": "2020-12-08T15:32:34Z", "author": {"login": "pdarvasi"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/service/upgrade/ClusterUpgradeAvailabilityService.java", "diffHunk": "@@ -180,7 +185,14 @@ private Image getCurrentImageFromCatalog(String currentImageId, CloudbreakImageC\n         return imageService.getImage(stack.getId());\n     }\n \n-    private CloudbreakImageCatalogV3 getImagesFromCatalog(String imageCatalogUrl) throws CloudbreakImageCatalogException {\n+    private CloudbreakImageCatalogV3 getImagesFromCatalog(Workspace workspace,\n+            com.sequenceiq.cloudbreak.cloud.model.Image image) throws CloudbreakImageCatalogException {\n+        String imageCatalogUrl;\n+        try {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODQ4OTAyNw=="}, "originalCommit": {"oid": "36b451f2bfe48187ac02459aa663015211f2e391"}, "originalPosition": 54}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "36b451f2bfe48187ac02459aa663015211f2e391", "author": {"user": {"login": "schfeca75", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/36b451f2bfe48187ac02459aa663015211f2e391", "committedDate": "2020-12-08T11:04:20Z", "message": "CB-10075 Upgrade image selection logic should not depend on image catalog URL\n* First try to use imagecatalog by name given in the current image\n* if image catalog is not found by name, use the stored imagecatalog url instead"}, "afterCommit": {"oid": "abd27eb1ab854ed9bfadcc21753eaff970ad172e", "author": {"user": {"login": "schfeca75", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/abd27eb1ab854ed9bfadcc21753eaff970ad172e", "committedDate": "2020-12-09T11:04:38Z", "message": "CB-10075 Upgrade image selection logic should not depend on image catalog URL\n* First try to use imagecatalog by name given in the current image\n* if image catalog is not found by name, use the stored imagecatalog url instead"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4MTM2NTMx", "url": "https://github.com/hortonworks/cloudbreak/pull/9600#pullrequestreview-548136531", "createdAt": "2020-12-09T12:32:57Z", "commit": {"oid": "abd27eb1ab854ed9bfadcc21753eaff970ad172e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4MTQ2NjQ1", "url": "https://github.com/hortonworks/cloudbreak/pull/9600#pullrequestreview-548146645", "createdAt": "2020-12-09T12:46:21Z", "commit": {"oid": "abd27eb1ab854ed9bfadcc21753eaff970ad172e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxMjo0NjoyMVrOICS3NQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxMjo0NjoyMVrOICS3NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTI3NzEwOQ==", "bodyText": "if you declare imageCatalogUrl on line 191 with this as a default value, then you can omit this", "url": "https://github.com/hortonworks/cloudbreak/pull/9600#discussion_r539277109", "createdAt": "2020-12-09T12:46:21Z", "author": {"login": "lacikaaa"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/service/upgrade/ClusterUpgradeAvailabilityService.java", "diffHunk": "@@ -180,7 +185,18 @@ private Image getCurrentImageFromCatalog(String currentImageId, CloudbreakImageC\n         return imageService.getImage(stack.getId());\n     }\n \n-    private CloudbreakImageCatalogV3 getImagesFromCatalog(String imageCatalogUrl) throws CloudbreakImageCatalogException {\n+    private CloudbreakImageCatalogV3 getImagesFromCatalog(Workspace workspace,\n+            com.sequenceiq.cloudbreak.cloud.model.Image image) throws CloudbreakImageCatalogException {\n+        String imageCatalogName = image.getImageCatalogName();\n+        String imageCatalogUrl;\n+        try {\n+            imageCatalogUrl = imageCatalogService.get(workspace.getId(), imageCatalogName).getImageCatalogUrl();\n+            LOGGER.info(\"Image catalog with name {} and url {} is used for image filtering.\", imageCatalogName, imageCatalogUrl);\n+        } catch (NotFoundException ex) {\n+            imageCatalogUrl = image.getImageCatalogUrl();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "abd27eb1ab854ed9bfadcc21753eaff970ad172e"}, "originalPosition": 59}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2597e4e9596dcdf9931eac607c411d6b78e916d7", "author": {"user": {"login": "schfeca75", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/2597e4e9596dcdf9931eac607c411d6b78e916d7", "committedDate": "2020-12-09T13:43:25Z", "message": "CB-10075 Upgrade image selection logic should not depend on image catalog URL\n* First try to use imagecatalog by name given in the current image\n* if image catalog is not found by name, use the stored imagecatalog url instead"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "abd27eb1ab854ed9bfadcc21753eaff970ad172e", "author": {"user": {"login": "schfeca75", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/abd27eb1ab854ed9bfadcc21753eaff970ad172e", "committedDate": "2020-12-09T11:04:38Z", "message": "CB-10075 Upgrade image selection logic should not depend on image catalog URL\n* First try to use imagecatalog by name given in the current image\n* if image catalog is not found by name, use the stored imagecatalog url instead"}, "afterCommit": {"oid": "2597e4e9596dcdf9931eac607c411d6b78e916d7", "author": {"user": {"login": "schfeca75", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/2597e4e9596dcdf9931eac607c411d6b78e916d7", "committedDate": "2020-12-09T13:43:25Z", "message": "CB-10075 Upgrade image selection logic should not depend on image catalog URL\n* First try to use imagecatalog by name given in the current image\n* if image catalog is not found by name, use the stored imagecatalog url instead"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4MTk1MTIw", "url": "https://github.com/hortonworks/cloudbreak/pull/9600#pullrequestreview-548195120", "createdAt": "2020-12-09T13:45:01Z", "commit": {"oid": "2597e4e9596dcdf9931eac607c411d6b78e916d7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1953, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}