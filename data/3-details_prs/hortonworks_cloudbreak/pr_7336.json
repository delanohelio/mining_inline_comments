{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc3NzM4MzMx", "number": 7336, "title": "CB-5540: get available images for upgrade", "bodyText": "", "createdAt": "2020-02-20T12:52:03Z", "url": "https://github.com/hortonworks/cloudbreak/pull/7336", "merged": true, "mergeCommit": {"oid": "d5ce795fda7a1300315a8d6e59b7e46d95fe8040"}, "closed": true, "closedAt": "2020-02-27T08:33:49Z", "author": {"login": "tiborpopovics"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcHY4VEABqjMwNjQzNzM2MzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcIGDG1ABqjMwNzM1MjUzOTA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2ff0049a734e9d8debf7e22a01ca3f14a6166487", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/2ff0049a734e9d8debf7e22a01ca3f14a6166487", "committedDate": "2020-02-20T12:50:40Z", "message": "CB-5540: get available images for upgrade"}, "afterCommit": {"oid": "63ba7047b93c326898e81f6658acbd266accab81", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/63ba7047b93c326898e81f6658acbd266accab81", "committedDate": "2020-02-24T08:02:33Z", "message": "CB-5540: get available images for upgrade"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "63ba7047b93c326898e81f6658acbd266accab81", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/63ba7047b93c326898e81f6658acbd266accab81", "committedDate": "2020-02-24T08:02:33Z", "message": "CB-5540: get available images for upgrade"}, "afterCommit": {"oid": "135751b1d02e9fa335210ead7dd9f1dd89d6a0c0", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/135751b1d02e9fa335210ead7dd9f1dd89d6a0c0", "committedDate": "2020-02-24T13:08:52Z", "message": "CB-5540: get available images for upgrade"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzNDIyMDA0", "url": "https://github.com/hortonworks/cloudbreak/pull/7336#pullrequestreview-363422004", "createdAt": "2020-02-24T14:21:08Z", "commit": {"oid": "63ba7047b93c326898e81f6658acbd266accab81"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxNDoyNDo0MFrOFtiW7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxNTo1MToxOFrOFtlq7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI5MzE2NQ==", "bodyText": "pls. move to OperationDescriptions and specify the resource used for \"by name\"", "url": "https://github.com/hortonworks/cloudbreak/pull/7336#discussion_r383293165", "createdAt": "2020-02-24T14:24:40Z", "author": {"login": "pdarvasi"}, "path": "core-api/src/main/java/com/sequenceiq/cloudbreak/api/endpoint/v4/stacks/StackV4Endpoint.java", "diffHunk": "@@ -239,4 +240,16 @@ FlowIdentifier setClusterMaintenanceMode(@PathParam(\"workspaceId\") Long workspac\n     @ApiOperation(value = GENERATE_HOSTS_INVENTORY, produces = MediaType.TEXT_PLAIN, nickname = \"getClusterHostsInventory\")\n     String getClusterHostsInventory(@PathParam(\"workspaceId\") Long workspaceId, @PathParam(\"name\") String name);\n \n+    @GET\n+    @Path(\"{name}/check_platform_upgrade\")\n+    @Produces(MediaType.APPLICATION_JSON)\n+    @ApiOperation(value = \"checks for upgrade options by name\", nickname = \"checkForUpgradeByName\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "135751b1d02e9fa335210ead7dd9f1dd89d6a0c0"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI5MzQ0Mw==", "bodyText": "pls. rename platform to stack", "url": "https://github.com/hortonworks/cloudbreak/pull/7336#discussion_r383293443", "createdAt": "2020-02-24T14:25:06Z", "author": {"login": "pdarvasi"}, "path": "core-api/src/main/java/com/sequenceiq/cloudbreak/api/endpoint/v4/stacks/StackV4Endpoint.java", "diffHunk": "@@ -239,4 +240,16 @@ FlowIdentifier setClusterMaintenanceMode(@PathParam(\"workspaceId\") Long workspac\n     @ApiOperation(value = GENERATE_HOSTS_INVENTORY, produces = MediaType.TEXT_PLAIN, nickname = \"getClusterHostsInventory\")\n     String getClusterHostsInventory(@PathParam(\"workspaceId\") Long workspaceId, @PathParam(\"name\") String name);\n \n+    @GET\n+    @Path(\"{name}/check_platform_upgrade\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "135751b1d02e9fa335210ead7dd9f1dd89d6a0c0"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI5MzU3NQ==", "bodyText": "pls. move to OperationDescriptions", "url": "https://github.com/hortonworks/cloudbreak/pull/7336#discussion_r383293575", "createdAt": "2020-02-24T14:25:21Z", "author": {"login": "pdarvasi"}, "path": "core-api/src/main/java/com/sequenceiq/cloudbreak/api/endpoint/v4/stacks/StackV4Endpoint.java", "diffHunk": "@@ -239,4 +240,16 @@ FlowIdentifier setClusterMaintenanceMode(@PathParam(\"workspaceId\") Long workspac\n     @ApiOperation(value = GENERATE_HOSTS_INVENTORY, produces = MediaType.TEXT_PLAIN, nickname = \"getClusterHostsInventory\")\n     String getClusterHostsInventory(@PathParam(\"workspaceId\") Long workspaceId, @PathParam(\"name\") String name);\n \n+    @GET\n+    @Path(\"{name}/check_platform_upgrade\")\n+    @Produces(MediaType.APPLICATION_JSON)\n+    @ApiOperation(value = \"checks for upgrade options by name\", nickname = \"checkForUpgradeByName\")\n+    UpgradeOptionsV4Response checkForPlatformUpgradeByName(@PathParam(\"workspaceId\") Long workspaceId, @PathParam(\"name\") String name);\n+\n+    @POST\n+    @Path(\"{name}/platform_upgrade\")\n+    @Produces(MediaType.APPLICATION_JSON)\n+    @ApiOperation(value = \"upgrades a cluster to the latest CM or CDH version\", nickname = \"upgradeClusterPlatformByName\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "135751b1d02e9fa335210ead7dd9f1dd89d6a0c0"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI5NDU5OA==", "bodyText": "pls rename to upgradeCandidates", "url": "https://github.com/hortonworks/cloudbreak/pull/7336#discussion_r383294598", "createdAt": "2020-02-24T14:27:07Z", "author": {"login": "pdarvasi"}, "path": "core-api/src/main/java/com/sequenceiq/cloudbreak/api/endpoint/v4/stacks/response/UpgradeOptionsV4Response.java", "diffHunk": "@@ -0,0 +1,45 @@\n+package com.sequenceiq.cloudbreak.api.endpoint.v4.stacks.response;\n+\n+import java.util.List;\n+\n+public class UpgradeOptionsV4Response {\n+\n+    private ImageInfoV4Response current;\n+\n+    private List<ImageInfoV4Response> upgrade;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "135751b1d02e9fa335210ead7dd9f1dd89d6a0c0"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI5NTQwMw==", "bodyText": "Pls rename platform to stack", "url": "https://github.com/hortonworks/cloudbreak/pull/7336#discussion_r383295403", "createdAt": "2020-02-24T14:28:24Z", "author": {"login": "pdarvasi"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/controller/v4/StackV4Controller.java", "diffHunk": "@@ -168,4 +169,14 @@ public FlowIdentifier putCluster(Long workspaceId, String name, @Valid UpdateClu\n     public String getClusterHostsInventory(Long workspaceId, String name) {\n         return stackOperations.getClusterHostsInventory(workspaceId, name);\n     }\n+\n+    @Override\n+    public UpgradeOptionsV4Response checkForPlatformUpgradeByName(Long workspaceId, String name) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "135751b1d02e9fa335210ead7dd9f1dd89d6a0c0"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI5NTQ4OA==", "bodyText": "Pls rename platform to stack", "url": "https://github.com/hortonworks/cloudbreak/pull/7336#discussion_r383295488", "createdAt": "2020-02-24T14:28:30Z", "author": {"login": "pdarvasi"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/controller/v4/StackV4Controller.java", "diffHunk": "@@ -168,4 +169,14 @@ public FlowIdentifier putCluster(Long workspaceId, String name, @Valid UpdateClu\n     public String getClusterHostsInventory(Long workspaceId, String name) {\n         return stackOperations.getClusterHostsInventory(workspaceId, name);\n     }\n+\n+    @Override\n+    public UpgradeOptionsV4Response checkForPlatformUpgradeByName(Long workspaceId, String name) {\n+        return stackOperations.checkForPlatformUpgrade(NameOrCrn.ofName(name), workspaceId);\n+    }\n+\n+    @Override\n+    public void upgradeClusterPlatformByName(Long workspaceId, String name) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "135751b1d02e9fa335210ead7dd9f1dd89d6a0c0"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI5NjI3Mg==", "bodyText": "upgrade --> upgrading", "url": "https://github.com/hortonworks/cloudbreak/pull/7336#discussion_r383296272", "createdAt": "2020-02-24T14:29:49Z", "author": {"login": "pdarvasi"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/service/upgrade/PlatformUpgradeService.java", "diffHunk": "@@ -0,0 +1,86 @@\n+package com.sequenceiq.cloudbreak.service.upgrade;\n+\n+import java.util.List;\n+\n+import javax.inject.Inject;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.api.endpoint.v4.stacks.response.UpgradeOptionsV4Response;\n+import com.sequenceiq.cloudbreak.cloud.model.catalog.CloudbreakImageCatalogV2;\n+import com.sequenceiq.cloudbreak.cloud.model.catalog.Image;\n+import com.sequenceiq.cloudbreak.cloud.model.catalog.Images;\n+import com.sequenceiq.cloudbreak.core.CloudbreakImageCatalogException;\n+import com.sequenceiq.cloudbreak.core.CloudbreakImageNotFoundException;\n+import com.sequenceiq.cloudbreak.domain.stack.Stack;\n+import com.sequenceiq.cloudbreak.service.image.ImageCatalogProvider;\n+import com.sequenceiq.cloudbreak.service.image.ImageService;\n+import com.sequenceiq.cloudbreak.service.stack.StackService;\n+\n+@Component\n+public class PlatformUpgradeService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(PlatformUpgradeService.class);\n+\n+    @Inject\n+    private StackService stackService;\n+\n+    @Inject\n+    private ImageCatalogProvider imageCatalogProvider;\n+\n+    @Inject\n+    private ImageService imageService;\n+\n+    @Inject\n+    private StackUpgradeImageFilter stackUpgradeImageFilter;\n+\n+    @Inject\n+    private UpgradeOptionsResponseFactory upgradeOptionsResponseFactory;\n+\n+    public UpgradeOptionsV4Response checkForUpgradesByName(Long workspaceId, String stackName) {\n+        UpgradeOptionsV4Response upgradeOptions = new UpgradeOptionsV4Response();\n+        try {\n+            Stack stack = stackService.getByNameInWorkspace(stackName, workspaceId);\n+            LOGGER.info(String.format(\"Retrieving images for upgrade stack %s\", stack.getName()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "135751b1d02e9fa335210ead7dd9f1dd89d6a0c0"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzMyNzI3OQ==", "bodyText": "we might set statusMessage with the error here", "url": "https://github.com/hortonworks/cloudbreak/pull/7336#discussion_r383327279", "createdAt": "2020-02-24T15:20:28Z", "author": {"login": "pdarvasi"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/service/upgrade/PlatformUpgradeService.java", "diffHunk": "@@ -0,0 +1,86 @@\n+package com.sequenceiq.cloudbreak.service.upgrade;\n+\n+import java.util.List;\n+\n+import javax.inject.Inject;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.api.endpoint.v4.stacks.response.UpgradeOptionsV4Response;\n+import com.sequenceiq.cloudbreak.cloud.model.catalog.CloudbreakImageCatalogV2;\n+import com.sequenceiq.cloudbreak.cloud.model.catalog.Image;\n+import com.sequenceiq.cloudbreak.cloud.model.catalog.Images;\n+import com.sequenceiq.cloudbreak.core.CloudbreakImageCatalogException;\n+import com.sequenceiq.cloudbreak.core.CloudbreakImageNotFoundException;\n+import com.sequenceiq.cloudbreak.domain.stack.Stack;\n+import com.sequenceiq.cloudbreak.service.image.ImageCatalogProvider;\n+import com.sequenceiq.cloudbreak.service.image.ImageService;\n+import com.sequenceiq.cloudbreak.service.stack.StackService;\n+\n+@Component\n+public class PlatformUpgradeService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(PlatformUpgradeService.class);\n+\n+    @Inject\n+    private StackService stackService;\n+\n+    @Inject\n+    private ImageCatalogProvider imageCatalogProvider;\n+\n+    @Inject\n+    private ImageService imageService;\n+\n+    @Inject\n+    private StackUpgradeImageFilter stackUpgradeImageFilter;\n+\n+    @Inject\n+    private UpgradeOptionsResponseFactory upgradeOptionsResponseFactory;\n+\n+    public UpgradeOptionsV4Response checkForUpgradesByName(Long workspaceId, String stackName) {\n+        UpgradeOptionsV4Response upgradeOptions = new UpgradeOptionsV4Response();\n+        try {\n+            Stack stack = stackService.getByNameInWorkspace(stackName, workspaceId);\n+            LOGGER.info(String.format(\"Retrieving images for upgrade stack %s\", stack.getName()));\n+            com.sequenceiq.cloudbreak.cloud.model.Image currentImage = getImage(stack);\n+            CloudbreakImageCatalogV2 imageCatalog = getImagesFromCatalog(currentImage.getImageCatalogUrl());\n+            Image image = getCurrentImageFromCatalog(currentImage.getImageId(), imageCatalog);\n+            Images filteredImages = filterImages(imageCatalog, image, stack.cloudPlatform());\n+            LOGGER.info(String.format(\"%d possible image found for stack upgrade.\", filteredImages.getCdhImages().size()));\n+            upgradeOptions = createResponse(image, filteredImages, stack.getCloudPlatform(), stack.getRegion(), currentImage.getImageCatalogName());\n+        } catch (CloudbreakImageNotFoundException | CloudbreakImageCatalogException e) {\n+            LOGGER.error(\"Failed to get images\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "135751b1d02e9fa335210ead7dd9f1dd89d6a0c0"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzMzMzU3OA==", "bodyText": "this could be part of ImageCatalogService to be reusable", "url": "https://github.com/hortonworks/cloudbreak/pull/7336#discussion_r383333578", "createdAt": "2020-02-24T15:30:12Z", "author": {"login": "pdarvasi"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/service/upgrade/PlatformUpgradeService.java", "diffHunk": "@@ -0,0 +1,86 @@\n+package com.sequenceiq.cloudbreak.service.upgrade;\n+\n+import java.util.List;\n+\n+import javax.inject.Inject;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.api.endpoint.v4.stacks.response.UpgradeOptionsV4Response;\n+import com.sequenceiq.cloudbreak.cloud.model.catalog.CloudbreakImageCatalogV2;\n+import com.sequenceiq.cloudbreak.cloud.model.catalog.Image;\n+import com.sequenceiq.cloudbreak.cloud.model.catalog.Images;\n+import com.sequenceiq.cloudbreak.core.CloudbreakImageCatalogException;\n+import com.sequenceiq.cloudbreak.core.CloudbreakImageNotFoundException;\n+import com.sequenceiq.cloudbreak.domain.stack.Stack;\n+import com.sequenceiq.cloudbreak.service.image.ImageCatalogProvider;\n+import com.sequenceiq.cloudbreak.service.image.ImageService;\n+import com.sequenceiq.cloudbreak.service.stack.StackService;\n+\n+@Component\n+public class PlatformUpgradeService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(PlatformUpgradeService.class);\n+\n+    @Inject\n+    private StackService stackService;\n+\n+    @Inject\n+    private ImageCatalogProvider imageCatalogProvider;\n+\n+    @Inject\n+    private ImageService imageService;\n+\n+    @Inject\n+    private StackUpgradeImageFilter stackUpgradeImageFilter;\n+\n+    @Inject\n+    private UpgradeOptionsResponseFactory upgradeOptionsResponseFactory;\n+\n+    public UpgradeOptionsV4Response checkForUpgradesByName(Long workspaceId, String stackName) {\n+        UpgradeOptionsV4Response upgradeOptions = new UpgradeOptionsV4Response();\n+        try {\n+            Stack stack = stackService.getByNameInWorkspace(stackName, workspaceId);\n+            LOGGER.info(String.format(\"Retrieving images for upgrade stack %s\", stack.getName()));\n+            com.sequenceiq.cloudbreak.cloud.model.Image currentImage = getImage(stack);\n+            CloudbreakImageCatalogV2 imageCatalog = getImagesFromCatalog(currentImage.getImageCatalogUrl());\n+            Image image = getCurrentImageFromCatalog(currentImage.getImageId(), imageCatalog);\n+            Images filteredImages = filterImages(imageCatalog, image, stack.cloudPlatform());\n+            LOGGER.info(String.format(\"%d possible image found for stack upgrade.\", filteredImages.getCdhImages().size()));\n+            upgradeOptions = createResponse(image, filteredImages, stack.getCloudPlatform(), stack.getRegion(), currentImage.getImageCatalogName());\n+        } catch (CloudbreakImageNotFoundException | CloudbreakImageCatalogException e) {\n+            LOGGER.error(\"Failed to get images\", e);\n+        }\n+        return upgradeOptions;\n+    }\n+\n+    private Image getCurrentImageFromCatalog(String currentImageId, CloudbreakImageCatalogV2 imageCatalog)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "135751b1d02e9fa335210ead7dd9f1dd89d6a0c0"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzMzNjE5MA==", "bodyText": "This should be part of ClusterManagerVariant.CLOUDERA_MANAGER", "url": "https://github.com/hortonworks/cloudbreak/pull/7336#discussion_r383336190", "createdAt": "2020-02-24T15:34:06Z", "author": {"login": "pdarvasi"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/service/upgrade/UpgradeOptionsResponseFactory.java", "diffHunk": "@@ -0,0 +1,48 @@\n+package com.sequenceiq.cloudbreak.service.upgrade;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.api.endpoint.v4.stacks.response.ImageInfoV4Response;\n+import com.sequenceiq.cloudbreak.api.endpoint.v4.stacks.response.UpgradeOptionsV4Response;\n+import com.sequenceiq.cloudbreak.cloud.model.catalog.Image;\n+import com.sequenceiq.cloudbreak.cloud.model.catalog.Images;\n+\n+@Component\n+public class UpgradeOptionsResponseFactory {\n+\n+    public UpgradeOptionsV4Response createV4Response(Image currentImage, Images filteredImages, String cloudPlatform, String region, String imageCatalogName) {\n+        return new UpgradeOptionsV4Response(\n+                createImageInfoFromCurrentImage(currentImage, cloudPlatform, region, imageCatalogName),\n+                createImageInfoFromFilteredImages(filteredImages, imageCatalogName, cloudPlatform, region));\n+    }\n+\n+    private ImageInfoV4Response createImageInfoFromCurrentImage(Image currentImage, String cloudPlatform, String region, String imageCatalogName) {\n+        return new ImageInfoV4Response(getImageName(currentImage, cloudPlatform, region), currentImage.getUuid(), imageCatalogName, currentImage.getCreated(),\n+                getComponentVersions(currentImage.getPackageVersions()));\n+    }\n+\n+    private List<ImageInfoV4Response> createImageInfoFromFilteredImages(Images filteredImages, String imageCatalogName, String cloudPlatform, String region) {\n+        return filteredImages.getCdhImages().stream()\n+                .map(image -> createImageInfo(image, imageCatalogName, cloudPlatform, region))\n+                .collect(Collectors.toList());\n+    }\n+\n+    private ImageInfoV4Response createImageInfo(Image image, String imageCatalogName, String cloudPlatform, String region) {\n+        return new ImageInfoV4Response(getImageName(image, cloudPlatform, region), image.getUuid(), imageCatalogName, image.getCreated(),\n+                getComponentVersions(image.getPackageVersions()));\n+    }\n+\n+    private Map<String, String> getComponentVersions(Map<String, String> packageVersions) {\n+        return Map.of(\n+                \"Cloudera Manager\", packageVersions.get(\"cm\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "135751b1d02e9fa335210ead7dd9f1dd89d6a0c0"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzMzODU2NA==", "bodyText": "This should be part of StackType", "url": "https://github.com/hortonworks/cloudbreak/pull/7336#discussion_r383338564", "createdAt": "2020-02-24T15:37:44Z", "author": {"login": "pdarvasi"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/service/upgrade/UpgradeOptionsResponseFactory.java", "diffHunk": "@@ -0,0 +1,48 @@\n+package com.sequenceiq.cloudbreak.service.upgrade;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.api.endpoint.v4.stacks.response.ImageInfoV4Response;\n+import com.sequenceiq.cloudbreak.api.endpoint.v4.stacks.response.UpgradeOptionsV4Response;\n+import com.sequenceiq.cloudbreak.cloud.model.catalog.Image;\n+import com.sequenceiq.cloudbreak.cloud.model.catalog.Images;\n+\n+@Component\n+public class UpgradeOptionsResponseFactory {\n+\n+    public UpgradeOptionsV4Response createV4Response(Image currentImage, Images filteredImages, String cloudPlatform, String region, String imageCatalogName) {\n+        return new UpgradeOptionsV4Response(\n+                createImageInfoFromCurrentImage(currentImage, cloudPlatform, region, imageCatalogName),\n+                createImageInfoFromFilteredImages(filteredImages, imageCatalogName, cloudPlatform, region));\n+    }\n+\n+    private ImageInfoV4Response createImageInfoFromCurrentImage(Image currentImage, String cloudPlatform, String region, String imageCatalogName) {\n+        return new ImageInfoV4Response(getImageName(currentImage, cloudPlatform, region), currentImage.getUuid(), imageCatalogName, currentImage.getCreated(),\n+                getComponentVersions(currentImage.getPackageVersions()));\n+    }\n+\n+    private List<ImageInfoV4Response> createImageInfoFromFilteredImages(Images filteredImages, String imageCatalogName, String cloudPlatform, String region) {\n+        return filteredImages.getCdhImages().stream()\n+                .map(image -> createImageInfo(image, imageCatalogName, cloudPlatform, region))\n+                .collect(Collectors.toList());\n+    }\n+\n+    private ImageInfoV4Response createImageInfo(Image image, String imageCatalogName, String cloudPlatform, String region) {\n+        return new ImageInfoV4Response(getImageName(image, cloudPlatform, region), image.getUuid(), imageCatalogName, image.getCreated(),\n+                getComponentVersions(image.getPackageVersions()));\n+    }\n+\n+    private Map<String, String> getComponentVersions(Map<String, String> packageVersions) {\n+        return Map.of(\n+                \"Cloudera Manager\", packageVersions.get(\"cm\"),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzMzNjE5MA=="}, "originalCommit": {"oid": "135751b1d02e9fa335210ead7dd9f1dd89d6a0c0"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM0MDQyOQ==", "bodyText": "may be part of ImageService", "url": "https://github.com/hortonworks/cloudbreak/pull/7336#discussion_r383340429", "createdAt": "2020-02-24T15:40:32Z", "author": {"login": "pdarvasi"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/service/upgrade/UpgradeOptionsResponseFactory.java", "diffHunk": "@@ -0,0 +1,48 @@\n+package com.sequenceiq.cloudbreak.service.upgrade;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.api.endpoint.v4.stacks.response.ImageInfoV4Response;\n+import com.sequenceiq.cloudbreak.api.endpoint.v4.stacks.response.UpgradeOptionsV4Response;\n+import com.sequenceiq.cloudbreak.cloud.model.catalog.Image;\n+import com.sequenceiq.cloudbreak.cloud.model.catalog.Images;\n+\n+@Component\n+public class UpgradeOptionsResponseFactory {\n+\n+    public UpgradeOptionsV4Response createV4Response(Image currentImage, Images filteredImages, String cloudPlatform, String region, String imageCatalogName) {\n+        return new UpgradeOptionsV4Response(\n+                createImageInfoFromCurrentImage(currentImage, cloudPlatform, region, imageCatalogName),\n+                createImageInfoFromFilteredImages(filteredImages, imageCatalogName, cloudPlatform, region));\n+    }\n+\n+    private ImageInfoV4Response createImageInfoFromCurrentImage(Image currentImage, String cloudPlatform, String region, String imageCatalogName) {\n+        return new ImageInfoV4Response(getImageName(currentImage, cloudPlatform, region), currentImage.getUuid(), imageCatalogName, currentImage.getCreated(),\n+                getComponentVersions(currentImage.getPackageVersions()));\n+    }\n+\n+    private List<ImageInfoV4Response> createImageInfoFromFilteredImages(Images filteredImages, String imageCatalogName, String cloudPlatform, String region) {\n+        return filteredImages.getCdhImages().stream()\n+                .map(image -> createImageInfo(image, imageCatalogName, cloudPlatform, region))\n+                .collect(Collectors.toList());\n+    }\n+\n+    private ImageInfoV4Response createImageInfo(Image image, String imageCatalogName, String cloudPlatform, String region) {\n+        return new ImageInfoV4Response(getImageName(image, cloudPlatform, region), image.getUuid(), imageCatalogName, image.getCreated(),\n+                getComponentVersions(image.getPackageVersions()));\n+    }\n+\n+    private Map<String, String> getComponentVersions(Map<String, String> packageVersions) {\n+        return Map.of(\n+                \"Cloudera Manager\", packageVersions.get(\"cm\"),\n+                \"Cloudera Runtime\", packageVersions.get(\"stack\"));\n+    }\n+\n+    private String getImageName(Image image, String cloudPlatform, String region) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "135751b1d02e9fa335210ead7dd9f1dd89d6a0c0"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM0MDczNw==", "bodyText": "rename to stack pls.", "url": "https://github.com/hortonworks/cloudbreak/pull/7336#discussion_r383340737", "createdAt": "2020-02-24T15:41:00Z", "author": {"login": "pdarvasi"}, "path": "core/src/main/java/com/sequenceiq/distrox/v1/distrox/StackOperations.java", "diffHunk": "@@ -196,6 +201,19 @@ public UpgradeOptionV4Response checkForUpgrade(@NotNull NameOrCrn nameOrCrn, Lon\n         }\n     }\n \n+    public void upgradeClusterPlatform(@NotNull NameOrCrn nameOrCrn, Long workspaceId) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "135751b1d02e9fa335210ead7dd9f1dd89d6a0c0"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM0MTc5Nw==", "bodyText": "pls. rename platforms to stack.", "url": "https://github.com/hortonworks/cloudbreak/pull/7336#discussion_r383341797", "createdAt": "2020-02-24T15:42:33Z", "author": {"login": "pdarvasi"}, "path": "datalake-api/src/main/java/com/sequenceiq/sdx/api/endpoint/SdxEndpoint.java", "diffHunk": "@@ -182,4 +183,28 @@ SdxClusterResponse create(@ValidStackNameFormat @ValidStackNameLength @PathParam\n     @Produces(MediaType.APPLICATION_JSON)\n     @ApiOperation(value = \"list datalake versions\", produces = MediaType.APPLICATION_JSON, nickname = \"versions\")\n     List<String> versions();\n+\n+    @GET\n+    @Path(\"{name}/check_platform_upgrade\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "135751b1d02e9fa335210ead7dd9f1dd89d6a0c0"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM0NzQzNw==", "bodyText": "pls externalize 0L in both places", "url": "https://github.com/hortonworks/cloudbreak/pull/7336#discussion_r383347437", "createdAt": "2020-02-24T15:51:18Z", "author": {"login": "pdarvasi"}, "path": "datalake/src/main/java/com/sequenceiq/datalake/service/upgrade/SdxDataPlatformUpgradeService.java", "diffHunk": "@@ -0,0 +1,38 @@\n+package com.sequenceiq.datalake.service.upgrade;\n+\n+import javax.inject.Inject;\n+\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.api.endpoint.v4.stacks.StackV4Endpoint;\n+import com.sequenceiq.cloudbreak.api.endpoint.v4.stacks.response.UpgradeOptionsV4Response;\n+import com.sequenceiq.datalake.entity.SdxCluster;\n+import com.sequenceiq.datalake.service.sdx.SdxService;\n+\n+@Component\n+public class SdxDataPlatformUpgradeService {\n+\n+    @Inject\n+    private StackV4Endpoint stackV4Endpoint;\n+\n+    @Inject\n+    private SdxService sdxService;\n+\n+    public UpgradeOptionsV4Response checkForPlatformUpgradeByName(String name) {\n+        return stackV4Endpoint.checkForPlatformUpgradeByName(0L, name);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "135751b1d02e9fa335210ead7dd9f1dd89d6a0c0"}, "originalPosition": 22}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "135751b1d02e9fa335210ead7dd9f1dd89d6a0c0", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/135751b1d02e9fa335210ead7dd9f1dd89d6a0c0", "committedDate": "2020-02-24T13:08:52Z", "message": "CB-5540: get available images for upgrade"}, "afterCommit": {"oid": "dec599696acb5e95cf373471c89438eef35b766f", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/dec599696acb5e95cf373471c89438eef35b766f", "committedDate": "2020-02-25T14:22:03Z", "message": "CB-5540: get available images for upgrade"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dec599696acb5e95cf373471c89438eef35b766f", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/dec599696acb5e95cf373471c89438eef35b766f", "committedDate": "2020-02-25T14:22:03Z", "message": "CB-5540: get available images for upgrade"}, "afterCommit": {"oid": "3c926eb8fdcce82495ceb9288c4de1258240d2a6", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/3c926eb8fdcce82495ceb9288c4de1258240d2a6", "committedDate": "2020-02-25T15:35:55Z", "message": "CB-5540: get available images for upgrade"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3c926eb8fdcce82495ceb9288c4de1258240d2a6", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/3c926eb8fdcce82495ceb9288c4de1258240d2a6", "committedDate": "2020-02-25T15:35:55Z", "message": "CB-5540: get available images for upgrade"}, "afterCommit": {"oid": "e327a5184cb75fd2fb2a10412de43b626297a8dc", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/e327a5184cb75fd2fb2a10412de43b626297a8dc", "committedDate": "2020-02-26T08:39:21Z", "message": "CB-5540: get available images for upgrade"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e327a5184cb75fd2fb2a10412de43b626297a8dc", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/e327a5184cb75fd2fb2a10412de43b626297a8dc", "committedDate": "2020-02-26T08:39:21Z", "message": "CB-5540: get available images for upgrade"}, "afterCommit": {"oid": "f3cdb190f5f2c5e25e3a2053a3bb3cbffd2c4361", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/f3cdb190f5f2c5e25e3a2053a3bb3cbffd2c4361", "committedDate": "2020-02-26T10:19:34Z", "message": "CB-5540: get available images for upgrade"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0ODU1NDUx", "url": "https://github.com/hortonworks/cloudbreak/pull/7336#pullrequestreview-364855451", "createdAt": "2020-02-26T12:24:57Z", "commit": {"oid": "f3cdb190f5f2c5e25e3a2053a3bb3cbffd2c4361"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76d28744832bd75abe48980539386668286f8efc", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/76d28744832bd75abe48980539386668286f8efc", "committedDate": "2020-02-26T12:40:01Z", "message": "CB-5540: get available images for upgrade"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f3cdb190f5f2c5e25e3a2053a3bb3cbffd2c4361", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/f3cdb190f5f2c5e25e3a2053a3bb3cbffd2c4361", "committedDate": "2020-02-26T10:19:34Z", "message": "CB-5540: get available images for upgrade"}, "afterCommit": {"oid": "76d28744832bd75abe48980539386668286f8efc", "author": {"user": null}, "url": "https://github.com/hortonworks/cloudbreak/commit/76d28744832bd75abe48980539386668286f8efc", "committedDate": "2020-02-26T12:40:01Z", "message": "CB-5540: get available images for upgrade"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2642, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}