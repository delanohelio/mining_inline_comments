{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQwOTgzOTI4", "number": 8441, "title": "CB-7360 Speed up handling of encrypted EBS", "bodyText": "This PR adds the ability to provision clusters with encrypted EBS in a fast way, avoiding unnecessary resource creations. Notes:\n\nApplies to FreeIPA & DL (#7833) as well as DH clusters.\nAffects root (always EBS) as well as EBS data / attached volumes.\nNo change to service APIs; the flag controlling the fast logic is included as a new dynamic parameter in InstanceTemplate. The parameter key has been added to AwsInstanceTemplate introduced earlier in #8340.\nThe fast logic is guarded by the new entitlement CDP_CB_FAST_EBS_ENCRYPTION. This entitlement gets checked by both FreeIPA and Cloudbreak / Core Svc; the absence of the entitlement grant will result in the legacy behavior.\nWhen testing with local CB, mock-caas defaults to presenting CDP_FREEIPA_DL_EBS_ENCRYPTION (#7833) and CDP_CB_FAST_EBS_ENCRYPTION always granted. The following VM argument shall be added to MockCaasApplication to disable these entitlements: -Dauth.mock.freeipadlebsencryption.enable=false -Dauth.mock.fastebsencryption.enable=false. The new defaults also revert the setting made in #8309.\nUnit tests have been added for all logic changes. These are all based on JUnit 5 and AssertJ, sometimes using ParameterizedTests. Any existing tests have been ported to the above libraries.", "createdAt": "2020-06-28T01:18:35Z", "url": "https://github.com/hortonworks/cloudbreak/pull/8441", "merged": true, "mergeCommit": {"oid": "0b24deb37efdda54f92fedcf24ce93ca0cd8b0fe"}, "closed": true, "closedAt": "2020-06-30T10:17:07Z", "author": {"login": "lajosrodek"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcvhrSIAH2gAyNDQwOTgzOTI4OjAzMDNlNDhjYTc5ZDhmNWE1YzQ5MjQ5ZmU2OGE4Y2I5OGE2YzI0NGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwSJ_XgFqTQzOTgzMzQ0NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0303e48ca79d8f5a5c49249fe68a8cb98a6c244f", "author": {"user": {"login": "lajosrodek", "name": "Lajos Rodek"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/0303e48ca79d8f5a5c49249fe68a8cb98a6c244f", "committedDate": "2020-06-28T00:54:40Z", "message": "CB-7360 Speed up handling of encrypted EBS\n\nSquashed commits:\nCB-7360 Add unit tests; fix aws-cf-dbstack.ftl JSON error"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5ODMwMzE1", "url": "https://github.com/hortonworks/cloudbreak/pull/8441#pullrequestreview-439830315", "createdAt": "2020-06-30T09:19:48Z", "commit": {"oid": "0303e48ca79d8f5a5c49249fe68a8cb98a6c244f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwOToxOTo0OVrOGqzoCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwOToxOTo0OVrOGqzoCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzUzOTIxMA==", "bodyText": "Minor, we could introduce a new method to replace group.getReferenceInstanceConfiguration().getTemplate() with getReferenceTemplate as it is used at many places.", "url": "https://github.com/hortonworks/cloudbreak/pull/8441#discussion_r447539210", "createdAt": "2020-06-30T09:19:49Z", "author": {"login": "keyki"}, "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/resource/AwsVolumeResourceBuilder.java", "diffHunk": "@@ -226,18 +229,39 @@ private String getAvailabilityZoneFromSubnet(AuthenticatedContext auth, CloudRes\n                 .build();\n     }\n \n-    private Function<VolumeSetAttributes.Volume, CreateVolumeRequest> createVolumeRequest(String snapshotId, TagSpecification tagSpecification,\n-            VolumeSetAttributes volumeSet) {\n-        return volume -> new CreateVolumeRequest()\n-                .withAvailabilityZone(volumeSet.getAvailabilityZone())\n-                .withSize(volume.getSize())\n-                .withSnapshotId(snapshotId)\n-                .withTagSpecifications(tagSpecification)\n-                .withVolumeType(volume.getType());\n+    private boolean isFastEbsEncryptionEnabled(Group group) {\n+        return new AwsInstanceView(group.getReferenceInstanceConfiguration().getTemplate()).isFastEbsEncryptionEnabled();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0303e48ca79d8f5a5c49249fe68a8cb98a6c244f"}, "originalPosition": 39}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5ODMzNDQ0", "url": "https://github.com/hortonworks/cloudbreak/pull/8441#pullrequestreview-439833444", "createdAt": "2020-06-30T09:23:38Z", "commit": {"oid": "0303e48ca79d8f5a5c49249fe68a8cb98a6c244f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwOToyMzozOFrOGqzxaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwOToyMzozOFrOGqzxaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU0MTYwOQ==", "bodyText": "Is this a bug being fixed? What does it cause if we have the , there?", "url": "https://github.com/hortonworks/cloudbreak/pull/8441#discussion_r447541609", "createdAt": "2020-06-30T09:23:38Z", "author": {"login": "keyki"}, "path": "cloud-aws/src/main/resources/templates/aws-cf-dbstack.ftl", "diffHunk": "@@ -89,7 +89,7 @@\n     \"VPCSecurityGroupsParameter\": {\n         \"Type\": \"List<AWS::EC2::SecurityGroup::Id>\",\n         \"Description\": \"VPC security groups\"\n-    },\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0303e48ca79d8f5a5c49249fe68a8cb98a6c244f"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1674, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}