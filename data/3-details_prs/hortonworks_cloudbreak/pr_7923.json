{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEwNTMxNTIw", "number": 7923, "title": "CB-6050 [FAILED AZURE E2E] SDX polling failed when stack is available and cluster is requested", "bodyText": "Manually tested with:\n\nDL create\nDL repair\n\nWith one terminated node (idborker)\nWith two nodes (master stopped, idbroker terminated)\n\n\nDL delete\nDH create\nDH upscale\nDH downscale\nDH repair (2 stopped compute nodes)\nDH delete", "createdAt": "2020-04-29T07:11:35Z", "url": "https://github.com/hortonworks/cloudbreak/pull/7923", "merged": true, "mergeCommit": {"oid": "146dee4a7ce2598170e32309b79fce7859711688"}, "closed": true, "closedAt": "2020-05-07T09:03:49Z", "author": {"login": "foldik"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABccWJpygBqjMyODQwMTkwMzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABceWmhiAFqTQwNTk1MTkwMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f267c4018988bd02f8f5b844143b47faebe49197", "author": {"user": {"login": "foldik", "name": "Attila Kristof Foldi"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/f267c4018988bd02f8f5b844143b47faebe49197", "committedDate": "2020-04-29T07:07:02Z", "message": "CB-6050 Change flow chain waiting structure"}, "afterCommit": {"oid": "06fef3213a93e8f61959891ee1d6fdf881d1f2b6", "author": {"user": {"login": "foldik", "name": "Attila Kristof Foldi"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/06fef3213a93e8f61959891ee1d6fdf881d1f2b6", "committedDate": "2020-04-29T10:43:43Z", "message": "CB-6050 Change flow chain waiting structure"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "06fef3213a93e8f61959891ee1d6fdf881d1f2b6", "author": {"user": {"login": "foldik", "name": "Attila Kristof Foldi"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/06fef3213a93e8f61959891ee1d6fdf881d1f2b6", "committedDate": "2020-04-29T10:43:43Z", "message": "CB-6050 Change flow chain waiting structure"}, "afterCommit": {"oid": "55096447718800bc378873e8ea47b111478980d4", "author": {"user": {"login": "foldik", "name": "Attila Kristof Foldi"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/55096447718800bc378873e8ea47b111478980d4", "committedDate": "2020-04-29T16:04:04Z", "message": "CB-6050 Change flow chain waiting structure"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9656f8562857dc5fbfe8508ad468ebd463e649c3", "author": {"user": {"login": "foldik", "name": "Attila Kristof Foldi"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/9656f8562857dc5fbfe8508ad468ebd463e649c3", "committedDate": "2020-04-30T10:30:32Z", "message": "CB-6050 Change flow chain waiting structure"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "55096447718800bc378873e8ea47b111478980d4", "author": {"user": {"login": "foldik", "name": "Attila Kristof Foldi"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/55096447718800bc378873e8ea47b111478980d4", "committedDate": "2020-04-29T16:04:04Z", "message": "CB-6050 Change flow chain waiting structure"}, "afterCommit": {"oid": "9656f8562857dc5fbfe8508ad468ebd463e649c3", "author": {"user": {"login": "foldik", "name": "Attila Kristof Foldi"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/9656f8562857dc5fbfe8508ad468ebd463e649c3", "committedDate": "2020-04-30T10:30:32Z", "message": "CB-6050 Change flow chain waiting structure"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0ODA1MjQz", "url": "https://github.com/hortonworks/cloudbreak/pull/7923#pullrequestreview-404805243", "createdAt": "2020-05-04T08:47:53Z", "commit": {"oid": "9656f8562857dc5fbfe8508ad468ebd463e649c3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1ODEyODQz", "url": "https://github.com/hortonworks/cloudbreak/pull/7923#pullrequestreview-405812843", "createdAt": "2020-05-05T13:56:21Z", "commit": {"oid": "9656f8562857dc5fbfe8508ad468ebd463e649c3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMzo1NjoyMVrOGQqoYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMzo1NjoyMVrOGQqoYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDEyODg2NA==", "bodyText": "Can't rootFlowChain be null here?", "url": "https://github.com/hortonworks/cloudbreak/pull/7923#discussion_r420128864", "createdAt": "2020-05-05T13:56:21Z", "author": {"login": "lnardai"}, "path": "flow/src/main/java/com/sequenceiq/flow/service/flowlog/FlowChainLogService.java", "diffHunk": "@@ -40,50 +39,50 @@\n         return repository.findByFlowChainIdOrderByCreatedDesc(flowChainId);\n     }\n \n-    public Set<FlowChainLog> collectRelatedFlowChains(FlowChainLog flowChain) {\n+    public List<FlowChainLog> collectRelatedFlowChains(FlowChainLog flowChain) {\n         LOGGER.info(\"Finding out master flow chain based on chain id {}\", flowChain.getFlowChainId());\n-        FlowChainLog masterFlowChain = collectMasterFlowChain(flowChain);\n-        LOGGER.info(\"Collecting child flow chains based on master chain id {}\", masterFlowChain.getFlowChainId());\n-        Set<FlowChainLog> flowChainList = Sets.newHashSet(masterFlowChain);\n-        collectChildFlowChains(flowChainList, masterFlowChain);\n+        FlowChainLog rootFlowChain = collectRootFlowChain(flowChain);\n+        LOGGER.info(\"Collecting child flow chains based on master chain id {}\", rootFlowChain.getFlowChainId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9656f8562857dc5fbfe8508ad468ebd463e649c3"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1OTI2Nzgy", "url": "https://github.com/hortonworks/cloudbreak/pull/7923#pullrequestreview-405926782", "createdAt": "2020-05-05T15:55:46Z", "commit": {"oid": "9656f8562857dc5fbfe8508ad468ebd463e649c3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxNTo1NTo0NlrOGQwI2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxNTo1NTo0NlrOGQwI2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDIxOTA5OA==", "bodyText": "Nice one! Readable tests.", "url": "https://github.com/hortonworks/cloudbreak/pull/7923#discussion_r420219098", "createdAt": "2020-05-05T15:55:46Z", "author": {"login": "lnardai"}, "path": "flow/src/test/java/com/sequenceiq/flow/service/flowlog/FlowChainLogServiceTest.java", "diffHunk": "@@ -34,87 +26,107 @@\n \n     private static final String FLOWCHAIN_PARENT_SUFFIX = \"Parent\";\n \n+    private static final String NO_PARENT = null;\n+\n     @InjectMocks\n     private FlowChainLogService underTest;\n \n     @Mock\n     private FlowChainLogRepository flowLogRepository;\n \n     @Test\n-    public void testGetRelatedFlowChainIds() {\n-        String flowChainId = \"flowChainId\";\n-        String otherFlowChainId = \"otherFlowChainId\";\n-        String childFlowChainId = \"childFlowChainId\";\n-        String parentFlowChainId = \"parentFlowChainId\";\n-        when(flowLogRepository.findByParentFlowChainIdOrderByCreatedDesc(eq(parentFlowChainId)))\n-                .thenReturn(Lists.newArrayList(create(flowChainId), create(otherFlowChainId)));\n-        when(flowLogRepository.findByParentFlowChainIdOrderByCreatedDesc(eq(flowChainId))).thenReturn(Lists.newArrayList(create(childFlowChainId)));\n-        when(flowLogRepository.findByParentFlowChainIdOrderByCreatedDesc(eq(otherFlowChainId))).thenReturn(Lists.newArrayList());\n-        when(flowLogRepository.findByParentFlowChainIdOrderByCreatedDesc(eq(childFlowChainId))).thenReturn(Lists.newArrayList());\n-        when(flowLogRepository.findFirstByFlowChainIdOrderByCreatedDesc(eq(flowChainId + FLOWCHAIN_PARENT_SUFFIX)))\n-                .thenReturn(Optional.of(create(parentFlowChainId)));\n-        when(flowLogRepository.findFirstByFlowChainIdOrderByCreatedDesc(eq(parentFlowChainId + FLOWCHAIN_PARENT_SUFFIX))).thenReturn(Optional.empty());\n-\n-        Set<FlowChainLog> flowChains = underTest.collectRelatedFlowChains(create(flowChainId));\n-        List<String> flowChainIds = flowChains.stream().map(flowChainLog -> flowChainLog.getFlowChainId()).collect(Collectors.toList());\n-\n-        assertEquals(4, flowChainIds.size());\n-        assertTrue(flowChainIds.contains(flowChainId));\n-        assertTrue(flowChainIds.contains(childFlowChainId));\n-        assertTrue(flowChainIds.contains(parentFlowChainId));\n-\n-        verify(flowLogRepository, times(4)).findByParentFlowChainIdOrderByCreatedDesc(any());\n-        verify(flowLogRepository, times(2)).findFirstByFlowChainIdOrderByCreatedDesc(any());\n+    public void testFindAllFlowChainsInTree() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9656f8562857dc5fbfe8508ad468ebd463e649c3"}, "originalPosition": 66}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1OTUxOTAw", "url": "https://github.com/hortonworks/cloudbreak/pull/7923#pullrequestreview-405951900", "createdAt": "2020-05-05T16:23:48Z", "commit": {"oid": "9656f8562857dc5fbfe8508ad468ebd463e649c3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2268, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}