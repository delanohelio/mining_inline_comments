{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA1NzQ5OTc0", "number": 7833, "title": "CB-4925 Enable EBS encryption for FreeIPA and DL", "bodyText": "As per one-pager design doc linked to CB-4925, this PR unconditionally enables the encryption of EBS volumes for FreeIPA and DL clusters (but note the exception below for the latter). Notes:\n\nThis applies to root (always EBS) as well as EBS data volumes. (There is no way to define encryption settings separately in cloud-api; they apply to all the volumes of the whole host group when given.)\nThe current logic always uses the region-default EBS encryption key. The handling of customer-provided KMS CMK is out of scope here and will be covered in a follow-up JIRA & PR.\nNo change to service APIs; settings are currently hard-wired into the service logic. Any possible API enhancement (e.g. to introduce custom encryption key choices) will be, again, treated in a future JIRA & PR. In other words, users have, in general, no way to tweak or disable EBS encryption for FreeIPA and DL clusters.\n\nThe only exception is the DL logic; StackRequestManifester honors any existing AwsEncryptionV4Parameters in the incoming StackV4Request with getType() != null, leaving the input setting untouched. This is only possible when using the SdxInternalEndpoint; specifying getType() == EncryptionType.NONE will thus always result in unencrypted EBS. On the other hand, the getType() == null setting will be overwritten with EncryptionType.DEFAULT, which is the path normally encountered when using the public SdxEndpoint.\n\n\nThe above logic is guarded by the new entitlement CDP_FREEIPA_DL_EBS_ENCRYPTION. This entitlement gets checked by both FreeIPA and DL Svc; the absence of the entitlement grant will result in the legacy behavior.\nWhen testing with local CB, mock-caas defaults to presenting CDP_FREEIPA_DL_EBS_ENCRYPTION always granted. The following VM argument shall be added to MockCaasApplication to disable this entitlement: -Dauth.mock.freeipadlebsencryption.enable=false.\nSome extra logging have been added to cloud-aws and cloud-template that help determine the exact time spent with various cloud infra steps due to EBS encryption.\nUnit tests have been added for all logic changes, except for logging related enhancements. These are all based on JUnit 5 and AssertJ, sometimes using ParameterizedTests. The exisiting InstanceGroupRequestToInstanceGroupConverterTest and MockUserManagementServiceTest have been ported to the above libraries. (The latter also retains the ExpectedException Rule from JUnit 4 via the experimental junit-jupiter-migrationsupport package.)\n\nFollow-up tasks:\n\nAdd customization options in service APIs, including the handling of customer-managed KMS keys. [No JIRA ticket yet.]\nHide cloud provider specific parts of the above FreeIPA and DL logic behind interfaces & respective provider implementations. [CB-7455]\nThe usage of magic string literals (\"encrypted\", \"type\", \"key\" and \"spotPercentage\") for instance template attributes is not best practice. To be discussed how to refactor this by exposing them as public constants (e.g. in cloud-aws / AwsInstanceView). [CB-7365]", "createdAt": "2020-04-19T22:42:56Z", "url": "https://github.com/hortonworks/cloudbreak/pull/7833", "merged": true, "mergeCommit": {"oid": "3e0930ff4b19b2dddfd66293a73ab93d8646ec36"}, "closed": true, "closedAt": "2020-06-16T14:00:47Z", "author": {"login": "lajosrodek"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcaem_NgBqjMyNjU1NDA5Mzg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcry9tegFqTQzMTM4MTg5Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "abb0dbdf53ea8b86125a9ae16d4f73c9dcb4e4ea", "author": {"user": {"login": "lajosrodek", "name": "Lajos Rodek"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/abb0dbdf53ea8b86125a9ae16d4f73c9dcb4e4ea", "committedDate": "2020-04-19T22:36:02Z", "message": "CB-4925 Enable EBS encryption for FreeIPA and DL"}, "afterCommit": {"oid": "015ca1a966b9af3fa253e1a94a5651cf721dac30", "author": {"user": {"login": "lajosrodek", "name": "Lajos Rodek"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/015ca1a966b9af3fa253e1a94a5651cf721dac30", "committedDate": "2020-04-23T15:27:05Z", "message": "CB-4925 Enable EBS encryption for FreeIPA and DL\n\nSquashed commits:\nCB-4925 Add further logging for encrypted images, volumes & snapshots"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "015ca1a966b9af3fa253e1a94a5651cf721dac30", "author": {"user": {"login": "lajosrodek", "name": "Lajos Rodek"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/015ca1a966b9af3fa253e1a94a5651cf721dac30", "committedDate": "2020-04-23T15:27:05Z", "message": "CB-4925 Enable EBS encryption for FreeIPA and DL\n\nSquashed commits:\nCB-4925 Add further logging for encrypted images, volumes & snapshots"}, "afterCommit": {"oid": "6c10c63b015094ce2eef5fbd32986de68e631436", "author": {"user": {"login": "lajosrodek", "name": "Lajos Rodek"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/6c10c63b015094ce2eef5fbd32986de68e631436", "committedDate": "2020-04-28T13:35:45Z", "message": "CB-4925 Enable EBS encryption for FreeIPA and DL\n\nSquashed commits:\nCB-4925 Add further logging for encrypted images, volumes & snapshots"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6c10c63b015094ce2eef5fbd32986de68e631436", "author": {"user": {"login": "lajosrodek", "name": "Lajos Rodek"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/6c10c63b015094ce2eef5fbd32986de68e631436", "committedDate": "2020-04-28T13:35:45Z", "message": "CB-4925 Enable EBS encryption for FreeIPA and DL\n\nSquashed commits:\nCB-4925 Add further logging for encrypted images, volumes & snapshots"}, "afterCommit": {"oid": "bcc8235b8e7221fe43ef73f780d5dd175fe37651", "author": {"user": {"login": "lajosrodek", "name": "Lajos Rodek"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/bcc8235b8e7221fe43ef73f780d5dd175fe37651", "committedDate": "2020-05-23T17:16:40Z", "message": "CB-4925 Enable EBS encryption for FreeIPA and DL\n\nSquashed commits:\nCB-4925 Add further logging for encrypted images, volumes & snapshots\nCB-4925 Add entitlement check\nCB-4925 Add logs to AwsVolumeResourceBuilder"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bcc8235b8e7221fe43ef73f780d5dd175fe37651", "author": {"user": {"login": "lajosrodek", "name": "Lajos Rodek"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/bcc8235b8e7221fe43ef73f780d5dd175fe37651", "committedDate": "2020-05-23T17:16:40Z", "message": "CB-4925 Enable EBS encryption for FreeIPA and DL\n\nSquashed commits:\nCB-4925 Add further logging for encrypted images, volumes & snapshots\nCB-4925 Add entitlement check\nCB-4925 Add logs to AwsVolumeResourceBuilder"}, "afterCommit": {"oid": "6cc9dece5558d0530bfefe85eae8792e16c27c47", "author": {"user": {"login": "lajosrodek", "name": "Lajos Rodek"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/6cc9dece5558d0530bfefe85eae8792e16c27c47", "committedDate": "2020-06-06T18:41:51Z", "message": "CB-4925 Enable EBS encryption for FreeIPA and DL\n\nSquashed commits:\nCB-4925 Add further logging for encrypted images, volumes & snapshots\nCB-4925 Add entitlement check\nCB-4925 Add logs to AwsVolumeResourceBuilder\nCB-4925 Add logs to ResourceCreateThread;\n        fix logs in AwsVolumeResourceBuilder\nCB-4925 Fix comment & log formatting in\n        StackRequestManifester.setupCloudStorageAccountMapping"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3ODIwNjg1", "url": "https://github.com/hortonworks/cloudbreak/pull/7833#pullrequestreview-427820685", "createdAt": "2020-06-10T08:19:51Z", "commit": {"oid": "6cc9dece5558d0530bfefe85eae8792e16c27c47"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQwODoxOTo1MlrOGhqGcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQwODoxOTo1MlrOGhqGcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzk0NTk3MQ==", "bodyText": "I think it could be on info level, as it is an important info. This log should have been added by me years ago :)", "url": "https://github.com/hortonworks/cloudbreak/pull/7833#discussion_r437945971", "createdAt": "2020-06-10T08:19:52Z", "author": {"login": "biharitomi"}, "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/encryption/EncryptedImageCopyService.java", "diffHunk": "@@ -78,8 +78,9 @@\n                 .collect(Collectors.toMap(Entry::getKey, e -> e.getValue().getImageId()));\n         if (!imageIdByGroupName.isEmpty()) {\n             Collection<String> imageIds = new HashSet<>(imageIdByGroupName.values());\n-            LOGGER.debug(\"Start polling the availability of the created AMIs: '{}'\", String.join(\",\", imageIds));\n+            LOGGER.debug(\"Start polling the availability of the created encrypted AMIs: '{}'\", String.join(\",\", imageIds));\n             checkBooleanPollTask(awsPollTaskFactory.newAMICopyStatusCheckerTask(ac, imageIds, client));\n+            LOGGER.debug(\"All created encrypted AMIs are available: '{}'\", String.join(\",\", imageIds));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6cc9dece5558d0530bfefe85eae8792e16c27c47"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "150d7a32ed5c80961389e8a84c452a7a0eb6a544", "author": {"user": {"login": "lajosrodek", "name": "Lajos Rodek"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/150d7a32ed5c80961389e8a84c452a7a0eb6a544", "committedDate": "2020-06-13T22:57:19Z", "message": "CB-4925 Enable EBS encryption for FreeIPA and DL\n\nSquashed commits:\nCB-4925 Add further logging for encrypted images, volumes & snapshots\nCB-4925 Add entitlement check\nCB-4925 Add logs to AwsVolumeResourceBuilder\nCB-4925 Add logs to ResourceCreateThread;\n        fix logs in AwsVolumeResourceBuilder\nCB-4925 Fix comment & log formatting in\n        StackRequestManifester.setupCloudStorageAccountMapping\nCB-4925 Add unit tests; honor all user-specified encryption setting in\n        StackRequestManifester, including EncryptionType.NONE"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6cc9dece5558d0530bfefe85eae8792e16c27c47", "author": {"user": {"login": "lajosrodek", "name": "Lajos Rodek"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/6cc9dece5558d0530bfefe85eae8792e16c27c47", "committedDate": "2020-06-06T18:41:51Z", "message": "CB-4925 Enable EBS encryption for FreeIPA and DL\n\nSquashed commits:\nCB-4925 Add further logging for encrypted images, volumes & snapshots\nCB-4925 Add entitlement check\nCB-4925 Add logs to AwsVolumeResourceBuilder\nCB-4925 Add logs to ResourceCreateThread;\n        fix logs in AwsVolumeResourceBuilder\nCB-4925 Fix comment & log formatting in\n        StackRequestManifester.setupCloudStorageAccountMapping"}, "afterCommit": {"oid": "150d7a32ed5c80961389e8a84c452a7a0eb6a544", "author": {"user": {"login": "lajosrodek", "name": "Lajos Rodek"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/150d7a32ed5c80961389e8a84c452a7a0eb6a544", "committedDate": "2020-06-13T22:57:19Z", "message": "CB-4925 Enable EBS encryption for FreeIPA and DL\n\nSquashed commits:\nCB-4925 Add further logging for encrypted images, volumes & snapshots\nCB-4925 Add entitlement check\nCB-4925 Add logs to AwsVolumeResourceBuilder\nCB-4925 Add logs to ResourceCreateThread;\n        fix logs in AwsVolumeResourceBuilder\nCB-4925 Fix comment & log formatting in\n        StackRequestManifester.setupCloudStorageAccountMapping\nCB-4925 Add unit tests; honor all user-specified encryption setting in\n        StackRequestManifester, including EncryptionType.NONE"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwNTgwMzY2", "url": "https://github.com/hortonworks/cloudbreak/pull/7833#pullrequestreview-430580366", "createdAt": "2020-06-15T12:07:53Z", "commit": {"oid": "150d7a32ed5c80961389e8a84c452a7a0eb6a544"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwNTkxNTE1", "url": "https://github.com/hortonworks/cloudbreak/pull/7833#pullrequestreview-430591515", "createdAt": "2020-06-15T12:23:49Z", "commit": {"oid": "150d7a32ed5c80961389e8a84c452a7a0eb6a544"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxMzgxODk2", "url": "https://github.com/hortonworks/cloudbreak/pull/7833#pullrequestreview-431381896", "createdAt": "2020-06-16T10:47:29Z", "commit": {"oid": "150d7a32ed5c80961389e8a84c452a7a0eb6a544"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2338, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}