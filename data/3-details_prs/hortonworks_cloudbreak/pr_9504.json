{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI2NDYwOTg2", "number": 9504, "title": "CB-9646 [AuthZ] Improve error pop up message: display resource name i\u2026", "bodyText": "\u2026nstead of crn\nTo help users understand what is happening on the UI we added the resource name to the authorization error message where it is possible and won't consume too much resources.\nreal ums tests: http://ci-cloudbreak.eng.hortonworks.com/job/cloudbreak-real-ums-test/2246/", "createdAt": "2020-11-24T12:58:25Z", "url": "https://github.com/hortonworks/cloudbreak/pull/9504", "merged": true, "mergeCommit": {"oid": "ddff9b561212215083f43ffa85dea78c34b9a942"}, "closed": true, "closedAt": "2020-12-10T14:20:20Z", "author": {"login": "bbihari"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdfqOUAABqjQwMzI5NTcwMTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdkx7nBABqjQwOTQ2OTU4MjY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "44f8cb480baa482466d2d3625030e329a0a4c75e", "author": {"user": {"login": "bbihari", "name": "Bal\u00e1zs Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/44f8cb480baa482466d2d3625030e329a0a4c75e", "committedDate": "2020-11-24T12:55:29Z", "message": "CB-9646 [AuthZ] Improve error pop up message: display resource name instead of crn"}, "afterCommit": {"oid": "248023381ebdfb86c74924117a5ce901f84e69a3", "author": {"user": {"login": "bbihari", "name": "Bal\u00e1zs Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/248023381ebdfb86c74924117a5ce901f84e69a3", "committedDate": "2020-11-24T14:00:13Z", "message": "CB-9646 [AuthZ] Improve error pop up message: display resource name instead of crn"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "248023381ebdfb86c74924117a5ce901f84e69a3", "author": {"user": {"login": "bbihari", "name": "Bal\u00e1zs Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/248023381ebdfb86c74924117a5ce901f84e69a3", "committedDate": "2020-11-24T14:00:13Z", "message": "CB-9646 [AuthZ] Improve error pop up message: display resource name instead of crn"}, "afterCommit": {"oid": "fa3a06de942c6878c312c02ee429c30fbae95c86", "author": {"user": {"login": "bbihari", "name": "Bal\u00e1zs Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/fa3a06de942c6878c312c02ee429c30fbae95c86", "committedDate": "2020-11-24T15:05:48Z", "message": "CB-9646 [AuthZ] Improve error pop up message: display resource name instead of crn"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fa3a06de942c6878c312c02ee429c30fbae95c86", "author": {"user": {"login": "bbihari", "name": "Bal\u00e1zs Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/fa3a06de942c6878c312c02ee429c30fbae95c86", "committedDate": "2020-11-24T15:05:48Z", "message": "CB-9646 [AuthZ] Improve error pop up message: display resource name instead of crn"}, "afterCommit": {"oid": "9c94e524469df590011c88d961ae6e34b1eb99d6", "author": {"user": {"login": "bbihari", "name": "Bal\u00e1zs Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/9c94e524469df590011c88d961ae6e34b1eb99d6", "committedDate": "2020-11-24T15:49:08Z", "message": "CB-9646 [AuthZ] Improve error pop up message: display resource name instead of crn"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3NjcwMzU2", "url": "https://github.com/hortonworks/cloudbreak/pull/9504#pullrequestreview-537670356", "createdAt": "2020-11-24T16:05:28Z", "commit": {"oid": "fa3a06de942c6878c312c02ee429c30fbae95c86"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNjowNjowMVrOH5Jq1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNjowNjowMVrOH5Jq1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTY4OTMwMg==", "bodyText": "cc: @lnardai , @sodre90\nThis structure can be quite inefficient when we have a bunch of resources and the user doesn't have right on most of them (delete 100 datahubs and the user doesn't have rights on them maps to 101 different database queries, 1 for the env and 100 for the datahubs). Basically the underlying behaviour is like you do this:\nfor (String crn : crns) {\n  String name = db.query(\"SELECT name FROM xy WHERE crn = :crn\")\n}\n\ninstead of SELECT name FROM xy WHERE crn IN (:crns) with all the .\nI would restructure the logic based on the followings:\n\ncollect the crns from the failedAuthorization to a Set<String>,\nsort them into a Map<ResourceType, Set<String>>, basically crns by resource types,\nchange the String ResourceNameProvider.getNameByCrn(String) to Map<String, String> ResourceNameProvider.getNamesByCrns(Set<String>) and use the IN sql stament in the underlying implementations (most of the time this is easily achiavable except EnvironmentClientService),\npass the result Map<String, String> name-crn map to the AuthorizationRule.\n\nI checked the code, the above solution wouldn't complicate the code at all and we wouldn't have worse and worse performance with increasing request size. I can even give a few ours to implement this and compare the solution if you wan't it, or we can add a followup task to refactor it. I don't think we need to cover this with lot of evidence, executing one sql statement is way faster than executing only the parts of it in a cycle with lots of network round-trip.", "url": "https://github.com/hortonworks/cloudbreak/pull/9504#discussion_r529689302", "createdAt": "2020-11-24T16:06:01Z", "author": {"login": "foldik"}, "path": "authorization-common/src/main/java/com/sequenceiq/authorization/service/ResourceAuthorizationService.java", "diffHunk": "@@ -64,7 +68,7 @@ public void authorize(String userCrn, ProceedingJoinPoint proceedingJoinPoint, M\n                     LOGGER.debug(\"Resource authorization failed: {}\", failedAuthorization.toString(rightMapper));\n                 }\n                 if (authzEntitled) {\n-                    throw new AccessDeniedException(failedAuthorization.getAsFailureMessage(rightMapper));\n+                    throw new AccessDeniedException(failedAuthorization.getAsFailureMessage(rightMapper, nameMapper));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c94e524469df590011c88d961ae6e34b1eb99d6"}, "originalPosition": 19}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9c94e524469df590011c88d961ae6e34b1eb99d6", "author": {"user": {"login": "bbihari", "name": "Bal\u00e1zs Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/9c94e524469df590011c88d961ae6e34b1eb99d6", "committedDate": "2020-11-24T15:49:08Z", "message": "CB-9646 [AuthZ] Improve error pop up message: display resource name instead of crn"}, "afterCommit": {"oid": "9291fa45a496d7fd89041da92b9d49d078d67048", "author": {"user": {"login": "bbihari", "name": "Bal\u00e1zs Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/9291fa45a496d7fd89041da92b9d49d078d67048", "committedDate": "2020-11-24T17:42:13Z", "message": "CB-9646 [AuthZ] Improve error pop up message: display resource name instead of crn"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9291fa45a496d7fd89041da92b9d49d078d67048", "author": {"user": {"login": "bbihari", "name": "Bal\u00e1zs Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/9291fa45a496d7fd89041da92b9d49d078d67048", "committedDate": "2020-11-24T17:42:13Z", "message": "CB-9646 [AuthZ] Improve error pop up message: display resource name instead of crn"}, "afterCommit": {"oid": "b3643f303c8b6bc908d31b54e73ec31b37e3ebf3", "author": {"user": {"login": "bbihari", "name": "Bal\u00e1zs Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/b3643f303c8b6bc908d31b54e73ec31b37e3ebf3", "committedDate": "2020-11-25T14:47:25Z", "message": "CB-9646 [AuthZ] Improve error pop up message: display resource name instead of crn"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b3643f303c8b6bc908d31b54e73ec31b37e3ebf3", "author": {"user": {"login": "bbihari", "name": "Bal\u00e1zs Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/b3643f303c8b6bc908d31b54e73ec31b37e3ebf3", "committedDate": "2020-11-25T14:47:25Z", "message": "CB-9646 [AuthZ] Improve error pop up message: display resource name instead of crn"}, "afterCommit": {"oid": "ed4994046a4d67adc5e67c9f1069f5ecaffe63c6", "author": {"user": {"login": "bbihari", "name": "Bal\u00e1zs Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/ed4994046a4d67adc5e67c9f1069f5ecaffe63c6", "committedDate": "2020-11-30T13:43:22Z", "message": "CB-9646 [AuthZ] Improve error pop up message: display resource name instead of crn"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ed4994046a4d67adc5e67c9f1069f5ecaffe63c6", "author": {"user": {"login": "bbihari", "name": "Bal\u00e1zs Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/ed4994046a4d67adc5e67c9f1069f5ecaffe63c6", "committedDate": "2020-11-30T13:43:22Z", "message": "CB-9646 [AuthZ] Improve error pop up message: display resource name instead of crn"}, "afterCommit": {"oid": "3fd0a5a346f818923f91c46a746338391b08b045", "author": {"user": {"login": "bbihari", "name": "Bal\u00e1zs Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/3fd0a5a346f818923f91c46a746338391b08b045", "committedDate": "2020-12-07T16:30:25Z", "message": "CB-9646 [AuthZ] Improve error pop up message: display resource name instead of crn"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3fd0a5a346f818923f91c46a746338391b08b045", "author": {"user": {"login": "bbihari", "name": "Bal\u00e1zs Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/3fd0a5a346f818923f91c46a746338391b08b045", "committedDate": "2020-12-07T16:30:25Z", "message": "CB-9646 [AuthZ] Improve error pop up message: display resource name instead of crn"}, "afterCommit": {"oid": "2c5fddd2b78b3022f7b7aa6d0257e4d3b9453156", "author": {"user": {"login": "bbihari", "name": "Bal\u00e1zs Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/2c5fddd2b78b3022f7b7aa6d0257e4d3b9453156", "committedDate": "2020-12-08T09:32:39Z", "message": "CB-9646 [AuthZ] Improve error pop up message: display resource name instead of crn"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2c5fddd2b78b3022f7b7aa6d0257e4d3b9453156", "author": {"user": {"login": "bbihari", "name": "Bal\u00e1zs Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/2c5fddd2b78b3022f7b7aa6d0257e4d3b9453156", "committedDate": "2020-12-08T09:32:39Z", "message": "CB-9646 [AuthZ] Improve error pop up message: display resource name instead of crn"}, "afterCommit": {"oid": "dfc6876c21563f099426b17392bf1b378a3f1035", "author": {"user": {"login": "bbihari", "name": "Bal\u00e1zs Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/dfc6876c21563f099426b17392bf1b378a3f1035", "committedDate": "2020-12-08T13:49:44Z", "message": "CB-9646 [AuthZ] Improve error pop up message: display resource name instead of crn"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dfc6876c21563f099426b17392bf1b378a3f1035", "author": {"user": {"login": "bbihari", "name": "Bal\u00e1zs Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/dfc6876c21563f099426b17392bf1b378a3f1035", "committedDate": "2020-12-08T13:49:44Z", "message": "CB-9646 [AuthZ] Improve error pop up message: display resource name instead of crn"}, "afterCommit": {"oid": "22acb10ada864c00c8d02ad0924ad324f4247532", "author": {"user": {"login": "bbihari", "name": "Bal\u00e1zs Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/22acb10ada864c00c8d02ad0924ad324f4247532", "committedDate": "2020-12-08T16:26:02Z", "message": "CB-9646 [AuthZ] Improve error pop up message: display resource name instead of crn"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "22acb10ada864c00c8d02ad0924ad324f4247532", "author": {"user": {"login": "bbihari", "name": "Bal\u00e1zs Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/22acb10ada864c00c8d02ad0924ad324f4247532", "committedDate": "2020-12-08T16:26:02Z", "message": "CB-9646 [AuthZ] Improve error pop up message: display resource name instead of crn"}, "afterCommit": {"oid": "8db6a7a2744c21a62f6cf6bed9cf44fcc2b00613", "author": {"user": {"login": "bbihari", "name": "Bal\u00e1zs Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/8db6a7a2744c21a62f6cf6bed9cf44fcc2b00613", "committedDate": "2020-12-09T09:47:12Z", "message": "CB-9646 [AuthZ] Improve error pop up message: display resource name instead of crn"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8db6a7a2744c21a62f6cf6bed9cf44fcc2b00613", "author": {"user": {"login": "bbihari", "name": "Bal\u00e1zs Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/8db6a7a2744c21a62f6cf6bed9cf44fcc2b00613", "committedDate": "2020-12-09T09:47:12Z", "message": "CB-9646 [AuthZ] Improve error pop up message: display resource name instead of crn"}, "afterCommit": {"oid": "65095d877798e42f4e079cfa4f006c6ae6b3cd82", "author": {"user": {"login": "bbihari", "name": "Bal\u00e1zs Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/65095d877798e42f4e079cfa4f006c6ae6b3cd82", "committedDate": "2020-12-09T12:25:03Z", "message": "CB-9646 [AuthZ] Improve error pop up message: display resource name instead of crn"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "65095d877798e42f4e079cfa4f006c6ae6b3cd82", "author": {"user": {"login": "bbihari", "name": "Bal\u00e1zs Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/65095d877798e42f4e079cfa4f006c6ae6b3cd82", "committedDate": "2020-12-09T12:25:03Z", "message": "CB-9646 [AuthZ] Improve error pop up message: display resource name instead of crn"}, "afterCommit": {"oid": "0d749cb4a8339321413958864ab47dff51212450", "author": {"user": {"login": "bbihari", "name": "Bal\u00e1zs Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/0d749cb4a8339321413958864ab47dff51212450", "committedDate": "2020-12-09T12:33:51Z", "message": "CB-9646 [AuthZ] Improve error pop up message: display resource name instead of crn"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4MjgwNDc4", "url": "https://github.com/hortonworks/cloudbreak/pull/9504#pullrequestreview-548280478", "createdAt": "2020-12-09T15:08:49Z", "commit": {"oid": "0d749cb4a8339321413958864ab47dff51212450"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxNTowODo0OVrOICZfTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxNTowODo0OVrOICZfTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTM4NTY3Ng==", "bodyText": "Do we need this?", "url": "https://github.com/hortonworks/cloudbreak/pull/9504#discussion_r539385676", "createdAt": "2020-12-09T15:08:49Z", "author": {"login": "foldik"}, "path": "authorization-common/src/test/java/com/sequenceiq/authorization/service/ResourceAuthorizationServiceTest.java", "diffHunk": "@@ -82,6 +85,7 @@ public void setUp() {\n         when(authorizationFactory1.supportedAnnotation()).thenReturn(CheckPermissionByResourceCrn.class);\n         when(authorizationFactory2.supportedAnnotation()).thenReturn(CheckPermissionByResourceName.class);\n         lenient().when(umsRightProvider.getRightMapper(true)).thenReturn(AuthorizationResourceAction::getRight);\n+        //when(resourceNameFactoryService.getNames(any())).thenReturn(Map.of(\"crn\", empty(), \"crn1\", empty(), \"crn2\", empty()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d749cb4a8339321413958864ab47dff51212450"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4MjgxMDMw", "url": "https://github.com/hortonworks/cloudbreak/pull/9504#pullrequestreview-548281030", "createdAt": "2020-12-09T15:09:18Z", "commit": {"oid": "0d749cb4a8339321413958864ab47dff51212450"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0d749cb4a8339321413958864ab47dff51212450", "author": {"user": {"login": "bbihari", "name": "Bal\u00e1zs Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/0d749cb4a8339321413958864ab47dff51212450", "committedDate": "2020-12-09T12:33:51Z", "message": "CB-9646 [AuthZ] Improve error pop up message: display resource name instead of crn"}, "afterCommit": {"oid": "3e9ce23297f4fc1b6714b7b0f771e4f35ff75f85", "author": {"user": {"login": "bbihari", "name": "Bal\u00e1zs Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/3e9ce23297f4fc1b6714b7b0f771e4f35ff75f85", "committedDate": "2020-12-09T15:28:14Z", "message": "CB-9646 [AuthZ] Improve error pop up message: display resource name instead of crn"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3e9ce23297f4fc1b6714b7b0f771e4f35ff75f85", "author": {"user": {"login": "bbihari", "name": "Bal\u00e1zs Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/3e9ce23297f4fc1b6714b7b0f771e4f35ff75f85", "committedDate": "2020-12-09T15:28:14Z", "message": "CB-9646 [AuthZ] Improve error pop up message: display resource name instead of crn"}, "afterCommit": {"oid": "22ad2d7f36aa7c42e55ac65947e1553e8a555e47", "author": {"user": {"login": "bbihari", "name": "Bal\u00e1zs Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/22ad2d7f36aa7c42e55ac65947e1553e8a555e47", "committedDate": "2020-12-10T08:38:37Z", "message": "CB-9646 [AuthZ] Improve error pop up message: display resource name instead of crn"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ce22f770888b8bf951e8867da45bb70bd234eaa", "author": {"user": {"login": "bbihari", "name": "Bal\u00e1zs Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/2ce22f770888b8bf951e8867da45bb70bd234eaa", "committedDate": "2020-12-10T11:48:40Z", "message": "CB-9646 [AuthZ] Improve error pop up message: display resource name instead of crn"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "22ad2d7f36aa7c42e55ac65947e1553e8a555e47", "author": {"user": {"login": "bbihari", "name": "Bal\u00e1zs Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/22ad2d7f36aa7c42e55ac65947e1553e8a555e47", "committedDate": "2020-12-10T08:38:37Z", "message": "CB-9646 [AuthZ] Improve error pop up message: display resource name instead of crn"}, "afterCommit": {"oid": "2ce22f770888b8bf951e8867da45bb70bd234eaa", "author": {"user": {"login": "bbihari", "name": "Bal\u00e1zs Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/2ce22f770888b8bf951e8867da45bb70bd234eaa", "committedDate": "2020-12-10T11:48:40Z", "message": "CB-9646 [AuthZ] Improve error pop up message: display resource name instead of crn"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2043, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}