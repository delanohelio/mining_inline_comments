{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIxNDI2Mzg2", "number": 8129, "title": "CB-6585 ClusterDefinition and ClusterTemplate should accessible for M\u2026", "bodyText": "\u2026anagement Console owner", "createdAt": "2020-05-21T15:37:13Z", "url": "https://github.com/hortonworks/cloudbreak/pull/8129", "merged": true, "mergeCommit": {"oid": "23e48236e3f775ba93ba61f00eb745a4f2667a12"}, "closed": true, "closedAt": "2020-05-29T08:50:03Z", "author": {"login": "bbihari"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcjyPSbgBqjMzNjQ2ODQ2NDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABclu1HoAFqTQyMDE3NjU5MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "87d56e2d1e9df44d8dd974379745a1da5148c1bb", "author": {"user": {"login": "bbihari", "name": "Bal\u00e1zs Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/87d56e2d1e9df44d8dd974379745a1da5148c1bb", "committedDate": "2020-05-21T15:36:06Z", "message": "CB-6585 ClusterDefinition and ClusterTemplate should accessible for Management Console owner"}, "afterCommit": {"oid": "da24ad2dcbc6e9e2296555e0951ceb548de6f21f", "author": {"user": {"login": "bbihari", "name": "Bal\u00e1zs Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/da24ad2dcbc6e9e2296555e0951ceb548de6f21f", "committedDate": "2020-05-22T13:25:01Z", "message": "CB-6585 ClusterDefinition and ClusterTemplate should accessible for Management Console owner"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "da24ad2dcbc6e9e2296555e0951ceb548de6f21f", "author": {"user": {"login": "bbihari", "name": "Bal\u00e1zs Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/da24ad2dcbc6e9e2296555e0951ceb548de6f21f", "committedDate": "2020-05-22T13:25:01Z", "message": "CB-6585 ClusterDefinition and ClusterTemplate should accessible for Management Console owner"}, "afterCommit": {"oid": "d31c154ea7e5e86ee92ccb9013fed3d304daf869", "author": {"user": {"login": "bbihari", "name": "Bal\u00e1zs Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/d31c154ea7e5e86ee92ccb9013fed3d304daf869", "committedDate": "2020-05-22T13:52:48Z", "message": "CB-6585 ClusterDefinition and ClusterTemplate should accessible for Management Console owner"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d31c154ea7e5e86ee92ccb9013fed3d304daf869", "author": {"user": {"login": "bbihari", "name": "Bal\u00e1zs Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/d31c154ea7e5e86ee92ccb9013fed3d304daf869", "committedDate": "2020-05-22T13:52:48Z", "message": "CB-6585 ClusterDefinition and ClusterTemplate should accessible for Management Console owner"}, "afterCommit": {"oid": "052ca6299fccf9dd050788d6680b8e8912f18033", "author": {"user": {"login": "bbihari", "name": "Bal\u00e1zs Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/052ca6299fccf9dd050788d6680b8e8912f18033", "committedDate": "2020-05-27T09:01:46Z", "message": "CB-6585 ClusterDefinition and ClusterTemplate should accessible for Management Console owner"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "052ca6299fccf9dd050788d6680b8e8912f18033", "author": {"user": {"login": "bbihari", "name": "Bal\u00e1zs Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/052ca6299fccf9dd050788d6680b8e8912f18033", "committedDate": "2020-05-27T09:01:46Z", "message": "CB-6585 ClusterDefinition and ClusterTemplate should accessible for Management Console owner"}, "afterCommit": {"oid": "9810139b2dd53c36b86fdd3d8e58e7d27ddc3780", "author": {"user": {"login": "bbihari", "name": "Bal\u00e1zs Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/9810139b2dd53c36b86fdd3d8e58e7d27ddc3780", "committedDate": "2020-05-27T11:00:29Z", "message": "CB-6585 ClusterDefinition and ClusterTemplate should accessible for Management Console owner"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9810139b2dd53c36b86fdd3d8e58e7d27ddc3780", "author": {"user": {"login": "bbihari", "name": "Bal\u00e1zs Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/9810139b2dd53c36b86fdd3d8e58e7d27ddc3780", "committedDate": "2020-05-27T11:00:29Z", "message": "CB-6585 ClusterDefinition and ClusterTemplate should accessible for Management Console owner"}, "afterCommit": {"oid": "91b32e103a9514dc328529dac462c6ede6ce0736", "author": {"user": {"login": "bbihari", "name": "Bal\u00e1zs Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/91b32e103a9514dc328529dac462c6ede6ce0736", "committedDate": "2020-05-27T13:34:57Z", "message": "CB-6585 ClusterDefinition and ClusterTemplate should accessible for Management Console owner"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5ODg3Mjg4", "url": "https://github.com/hortonworks/cloudbreak/pull/8129#pullrequestreview-419887288", "createdAt": "2020-05-28T08:27:57Z", "commit": {"oid": "91b32e103a9514dc328529dac462c6ede6ce0736"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwMDgzMTQ2", "url": "https://github.com/hortonworks/cloudbreak/pull/8129#pullrequestreview-420083146", "createdAt": "2020-05-28T13:02:50Z", "commit": {"oid": "91b32e103a9514dc328529dac462c6ede6ce0736"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxMzowMjo1MVrOGb0CMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxMzoyMDo0NlrOGb0wEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTgxNzI2NQ==", "bodyText": "Why not \"environments/createClusterDefinition\"? Other rights follow this convention.", "url": "https://github.com/hortonworks/cloudbreak/pull/8129#discussion_r431817265", "createdAt": "2020-05-28T13:02:51Z", "author": {"login": "foldik"}, "path": "authorization-common/src/main/resources/actions.json", "diffHunk": "@@ -142,5 +142,41 @@\n     \"resourceType\": \"IMAGE_CATALOG\",\n     \"actionType\": \"RESOURCE_DEPENDENT\",\n     \"legacyRight\": \"datahub/write\"\n+  },\n+  \"CREATE_CLUSTER_DEFINITION\": {\n+    \"right\": \"environments/createClusterDefinitions\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91b32e103a9514dc328529dac462c6ede6ce0736"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTgyNTk3OA==", "bodyText": "Can you please do something like this:\nSELECT just_the_necessary_fields WHERE crn in (:crns);\n\ninstead of\nfor ... {\n  SELECT one where crn = :crn\n}", "url": "https://github.com/hortonworks/cloudbreak/pull/8129#discussion_r431825978", "createdAt": "2020-05-28T13:16:08Z", "author": {"login": "foldik"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/service/blueprint/DefaultBlueprintChecker.java", "diffHunk": "@@ -0,0 +1,53 @@\n+package com.sequenceiq.cloudbreak.service.blueprint;\n+\n+import static com.sequenceiq.authorization.resource.AuthorizationResourceAction.DESCRIBE_CLUSTER_TEMPLATE;\n+import static java.util.Collections.emptyList;\n+\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.authorization.resource.AuthorizationResourceAction;\n+import com.sequenceiq.authorization.resource.AuthorizationResourceType;\n+import com.sequenceiq.authorization.service.CrnsByCategory;\n+import com.sequenceiq.authorization.service.DefaultResourceChecker;\n+import com.sequenceiq.cloudbreak.api.endpoint.v4.common.ResourceStatus;\n+import com.sequenceiq.cloudbreak.domain.Blueprint;\n+\n+@Component\n+public class DefaultBlueprintChecker implements DefaultResourceChecker {\n+\n+    @Inject\n+    private BlueprintService blueprintService;\n+\n+    @Override\n+    public AuthorizationResourceType getResourceType() {\n+        return AuthorizationResourceType.CLUSTER_TEMPLATE;\n+    }\n+\n+    @Override\n+    public boolean isDefault(String resourceCrn) {\n+        Blueprint b = blueprintService.getByResourceCrn(resourceCrn);\n+        return b != null && ResourceStatus.DEFAULT == b.getStatus();\n+    }\n+\n+    @Override\n+    public boolean isAllowedAction(AuthorizationResourceAction action) {\n+        return DESCRIBE_CLUSTER_TEMPLATE.equals(action);\n+    }\n+\n+    @Override\n+    public CrnsByCategory getDefaultResourceCrns(Collection<String> resourceCrns) {\n+        Map<Boolean, List<String>> byDefault = resourceCrns.stream().collect(Collectors.partitioningBy(this::isDefault));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91b32e103a9514dc328529dac462c6ede6ce0736"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTgyOTAwOA==", "bodyText": "Can you please rewrite it as the DefaultBlueprintChecker?", "url": "https://github.com/hortonworks/cloudbreak/pull/8129#discussion_r431829008", "createdAt": "2020-05-28T13:20:46Z", "author": {"login": "foldik"}, "path": "core/src/main/java/com/sequenceiq/cloudbreak/service/template/DefaultClusterTemplateChecker.java", "diffHunk": "@@ -0,0 +1,53 @@\n+package com.sequenceiq.cloudbreak.service.template;\n+\n+import static com.sequenceiq.authorization.resource.AuthorizationResourceAction.DESCRIBE_CLUSTER_DEFINITION;\n+import static com.sequenceiq.authorization.resource.AuthorizationResourceType.CLUSTER_DEFINITION;\n+import static java.util.Collections.emptyList;\n+\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.authorization.resource.AuthorizationResourceAction;\n+import com.sequenceiq.authorization.resource.AuthorizationResourceType;\n+import com.sequenceiq.authorization.service.CrnsByCategory;\n+import com.sequenceiq.authorization.service.DefaultResourceChecker;\n+import com.sequenceiq.cloudbreak.api.endpoint.v4.common.ResourceStatus;\n+import com.sequenceiq.cloudbreak.domain.stack.cluster.ClusterTemplate;\n+\n+@Component\n+public class DefaultClusterTemplateChecker implements DefaultResourceChecker {\n+\n+    @Inject\n+    private ClusterTemplateService clusterTemplateService;\n+\n+    @Override\n+    public AuthorizationResourceType getResourceType() {\n+        return CLUSTER_DEFINITION;\n+    }\n+\n+    @Override\n+    public boolean isDefault(String resourceCrn) {\n+        ClusterTemplate b = clusterTemplateService.getByResourceCrn(resourceCrn);\n+        return b != null && ResourceStatus.DEFAULT == b.getStatus();\n+    }\n+\n+    @Override\n+    public boolean isAllowedAction(AuthorizationResourceAction action) {\n+        return DESCRIBE_CLUSTER_DEFINITION == action;\n+    }\n+\n+    @Override\n+    public CrnsByCategory getDefaultResourceCrns(Collection<String> resourceCrns) {\n+        Map<Boolean, List<String>> byDefault = resourceCrns.stream().collect(Collectors.partitioningBy(this::isDefault));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91b32e103a9514dc328529dac462c6ede6ce0736"}, "originalPosition": 47}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b036a4932d927a8c01509759a94e64ae48490fd7", "author": {"user": {"login": "bbihari", "name": "Bal\u00e1zs Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/b036a4932d927a8c01509759a94e64ae48490fd7", "committedDate": "2020-05-28T14:26:14Z", "message": "CB-6585 ClusterDefinition and ClusterTemplate should accessible for Management Console owner"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "91b32e103a9514dc328529dac462c6ede6ce0736", "author": {"user": {"login": "bbihari", "name": "Bal\u00e1zs Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/91b32e103a9514dc328529dac462c6ede6ce0736", "committedDate": "2020-05-27T13:34:57Z", "message": "CB-6585 ClusterDefinition and ClusterTemplate should accessible for Management Console owner"}, "afterCommit": {"oid": "b036a4932d927a8c01509759a94e64ae48490fd7", "author": {"user": {"login": "bbihari", "name": "Bal\u00e1zs Bihari"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/b036a4932d927a8c01509759a94e64ae48490fd7", "committedDate": "2020-05-28T14:26:14Z", "message": "CB-6585 ClusterDefinition and ClusterTemplate should accessible for Management Console owner"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwMTc2NTkw", "url": "https://github.com/hortonworks/cloudbreak/pull/8129#pullrequestreview-420176590", "createdAt": "2020-05-28T14:34:56Z", "commit": {"oid": "b036a4932d927a8c01509759a94e64ae48490fd7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1880, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}