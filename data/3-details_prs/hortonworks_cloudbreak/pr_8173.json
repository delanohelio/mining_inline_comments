{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI0NTA3ODgw", "number": 8173, "title": "CB-5738 Disable ClusterManagerHostHealthEvaluator", "bodyText": "Disable ClusterManagerHostHealthEvaluator.\nIncluding autoscaling disabled clusters for removable check.\n\nCloses CB-5738", "createdAt": "2020-05-28T14:03:15Z", "url": "https://github.com/hortonworks/cloudbreak/pull/8173", "merged": true, "mergeCommit": {"oid": "472be199c49ee07eec86e27fa45d170a7112a43d"}, "closed": true, "closedAt": "2020-05-29T11:56:05Z", "author": {"login": "smaniraju"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcluom2ABqjMzODMwMjczNzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcl5kPNgBqjMzODU0Mzg0NTU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eeb1545081fda5d260e554758e86e5e9c797bc13", "author": {"user": {"login": "smaniraju", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/eeb1545081fda5d260e554758e86e5e9c797bc13", "committedDate": "2020-05-28T11:56:44Z", "message": "CB-5738 Disable ClusterManagerHostHealthEvaluator\n\n1. Disable ClusterManagerHostHealthEvaluator.\n2. Including autoscaling disabled clusters for removalbe check."}, "afterCommit": {"oid": "5d4b649d9ba6dfb0bb634467573112045a298460", "author": {"user": {"login": "smaniraju", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/5d4b649d9ba6dfb0bb634467573112045a298460", "committedDate": "2020-05-28T14:10:09Z", "message": "CB-5738 Disable ClusterManagerHostHealthEvaluator\n\n1. Disable ClusterManagerHostHealthEvaluator.\n2. Including autoscaling disabled clusters for removalbe check."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5d4b649d9ba6dfb0bb634467573112045a298460", "author": {"user": {"login": "smaniraju", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/5d4b649d9ba6dfb0bb634467573112045a298460", "committedDate": "2020-05-28T14:10:09Z", "message": "CB-5738 Disable ClusterManagerHostHealthEvaluator\n\n1. Disable ClusterManagerHostHealthEvaluator.\n2. Including autoscaling disabled clusters for removalbe check."}, "afterCommit": {"oid": "57f869da7868de42daa98da800ccb63b277a3d1c", "author": {"user": {"login": "smaniraju", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/57f869da7868de42daa98da800ccb63b277a3d1c", "committedDate": "2020-05-28T15:17:01Z", "message": "CB-5738 Disable ClusterManagerHostHealthEvaluator\n\n1. Disable ClusterManagerHostHealthEvaluator.\n2. Including autoscaling disabled clusters for removalbe check."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwMjI4MDA4", "url": "https://github.com/hortonworks/cloudbreak/pull/8173#pullrequestreview-420228008", "createdAt": "2020-05-28T15:26:13Z", "commit": {"oid": "57f869da7868de42daa98da800ccb63b277a3d1c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNToyNjoxM1rOGb6lAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNToyNjoxM1rOGb6lAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkyNDQ4MA==", "bodyText": "Including subset of clusters to monitor instead of ClusterManagerHostHealthEvaluator's all running clusters.\nAlso one corner case was not covered in existing flow related to \"PENDING\" cluster deleted in CB.", "url": "https://github.com/hortonworks/cloudbreak/pull/8173#discussion_r431924480", "createdAt": "2020-05-28T15:26:13Z", "author": {"login": "smaniraju"}, "path": "autoscale/src/main/java/com/sequenceiq/periscope/monitor/RemovableClusterMonitor.java", "diffHunk": "@@ -0,0 +1,42 @@\n+package com.sequenceiq.periscope.monitor;\n+\n+import java.util.List;\n+\n+import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.periscope.api.model.ClusterState;\n+import com.sequenceiq.periscope.domain.Cluster;\n+import com.sequenceiq.periscope.monitor.evaluator.ClusterStateEvaluator;\n+\n+@Component(\"RemovableClusterMonitor\")\n+@ConditionalOnProperty(prefix = \"periscope.enabledAutoscaleMonitors.removable-cluster-monitor\", name = \"enabled\", havingValue = \"true\")\n+public class RemovableClusterMonitor extends ClusterMonitor {\n+\n+    @Override\n+    public String getIdentifier() {\n+        return \"removable-cluster-monitor\";\n+    }\n+\n+    @Override\n+    public String getTriggerExpression() {\n+        return MonitorUpdateRate.EVERY_MIN_RATE_CRON;\n+    }\n+\n+    @Override\n+    public Class<?> getEvaluatorType(Cluster cluster) {\n+        return ClusterStateEvaluator.class;\n+    }\n+\n+    @Override\n+    protected List<Cluster> getMonitored() {\n+        //To monitor Suspended & Clusters with AutoScaling disabled and purge them in periscope when they are deleted in CB.\n+        List removableClustersCheck = getClusterService()\n+                .findAllByStateAndNode(ClusterState.SUSPENDED, getPeriscopeNodeConfig().getId());\n+        removableClustersCheck.addAll(getClusterService()\n+                        .findAllByStateAndNode(ClusterState.PENDING, getPeriscopeNodeConfig().getId()));\n+        removableClustersCheck.addAll(getClusterService()\n+                .findAllForNode(ClusterState.RUNNING, false, getPeriscopeNodeConfig().getId()));\n+        return removableClustersCheck;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57f869da7868de42daa98da800ccb63b277a3d1c"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99f588e65dda62d2a5495626868bf579535288ad", "author": {"user": {"login": "smaniraju", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/99f588e65dda62d2a5495626868bf579535288ad", "committedDate": "2020-05-29T02:19:20Z", "message": "CB-5738 Disable ClusterManagerHostHealthEvaluator\n\n1. Disable ClusterManagerHostHealthEvaluator.\n2. Including autoscaling disabled clusters for removalbe check."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "57f869da7868de42daa98da800ccb63b277a3d1c", "author": {"user": {"login": "smaniraju", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/57f869da7868de42daa98da800ccb63b277a3d1c", "committedDate": "2020-05-28T15:17:01Z", "message": "CB-5738 Disable ClusterManagerHostHealthEvaluator\n\n1. Disable ClusterManagerHostHealthEvaluator.\n2. Including autoscaling disabled clusters for removalbe check."}, "afterCommit": {"oid": "99f588e65dda62d2a5495626868bf579535288ad", "author": {"user": {"login": "smaniraju", "name": null}}, "url": "https://github.com/hortonworks/cloudbreak/commit/99f588e65dda62d2a5495626868bf579535288ad", "committedDate": "2020-05-29T02:19:20Z", "message": "CB-5738 Disable ClusterManagerHostHealthEvaluator\n\n1. Disable ClusterManagerHostHealthEvaluator.\n2. Including autoscaling disabled clusters for removalbe check."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1766, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}