{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkxNDEwNTYw", "number": 9065, "title": "CB-8137: Fix FreeIPA status for deleted, stopped, available, unreac...", "bodyText": "...hable, and unhealthy\nFixed FreeIPA status for HA clusters.\n\nStopped + Running = Unhealthy\nStopped + Terminated = Unhealthy (It may temporarily be unreachable)\nUnreachable + Unreachable = Unreachable\nUnreahable + Running = Unhealthy\nRunning + Deleted = Unhealthy\n\nThis was tested with unit tests and also manually with a local\ndeployment of cloudbreak.\nSee detailed description in the commit message.", "createdAt": "2020-09-23T02:38:52Z", "url": "https://github.com/hortonworks/cloudbreak/pull/9065", "merged": true, "mergeCommit": {"oid": "9a5d5a38f845cdaef57a7e07b161f223f80bd0e2"}, "closed": true, "closedAt": "2020-09-24T08:44:48Z", "author": {"login": "jamisonbennett"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLoE1SgFqTQ5NDM4MzgwMg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdL8_ZQgFqTQ5NTMzOTg1OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0MzgzODAy", "url": "https://github.com/hortonworks/cloudbreak/pull/9065#pullrequestreview-494383802", "createdAt": "2020-09-23T07:48:18Z", "commit": {"oid": "d9329dd6b6e248cf8cd321d47bd13f60bde32e3c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwNzo0ODoxOFrOHWax4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwODowMTozN1rOHWbf7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzI2OTQ3NA==", "bodyText": "this became unused", "url": "https://github.com/hortonworks/cloudbreak/pull/9065#discussion_r493269474", "createdAt": "2020-09-23T07:48:18Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/sync/FreeipaChecker.java", "diffHunk": "@@ -35,41 +34,60 @@\n     @Inject\n     private InstanceMetaDataService instanceMetaDataService;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9329dd6b6e248cf8cd321d47bd13f60bde32e3c"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzI3NTYyMw==", "bodyText": "what's the purpose of this result? the name and the thing it's a boolean makes me confused. Also I don't see any usage of SyncResult#getResult so we might drop it", "url": "https://github.com/hortonworks/cloudbreak/pull/9065#discussion_r493275623", "createdAt": "2020-09-23T07:56:02Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/sync/FreeipaChecker.java", "diffHunk": "@@ -35,41 +34,60 @@\n     @Inject\n     private InstanceMetaDataService instanceMetaDataService;\n \n-    private List<RPCResponse<Boolean>> checkStatus(Stack stack, Set<InstanceMetaData> checkableInstances) throws Exception {\n+    private Pair<List<DetailedStackStatus>, String> checkStatus(Stack stack, Set<InstanceMetaData> checkableInstances) throws Exception {\n         return checkedMeasure(() -> {\n-            List<RPCResponse<Boolean>> statuses = new LinkedList<>();\n+            List<DetailedStackStatus> statuses = new LinkedList<>();\n+            List<RPCResponse<Boolean>> responses = new LinkedList<>();\n             for (InstanceMetaData instanceMetaData : checkableInstances) {\n                 String hostname = instanceMetaData.getDiscoveryFQDN();\n-                FreeIpaClient freeIpaClient = checkedMeasure(() -> freeIpaClientFactory.getFreeIpaClientForStackWithPing(stack, hostname), LOGGER,\n-                        \":::Auto sync::: freeipa client is created in {}ms\");\n-                statuses.add(checkedMeasure(() -> freeIpaClient.serverConnCheck(freeIpaClient.getHostname(), hostname), LOGGER,\n-                        \":::Auto sync::: freeipa server_conncheck ran in {}ms\"));\n+                try {\n+                    FreeIpaClient freeIpaClient = checkedMeasure(() -> freeIpaClientFactory.getFreeIpaClientForStackWithPing(stack, hostname), LOGGER,\n+                            \":::Auto sync::: freeipa client is created in {}ms\");\n+                    RPCResponse<Boolean> response = checkedMeasure(() -> freeIpaClient.serverConnCheck(freeIpaClient.getHostname(), hostname), LOGGER,\n+                            \":::Auto sync::: freeipa server_conncheck ran in {}ms\");\n+                    responses.add(response);\n+                    if (response.getResult()) {\n+                        statuses.add(DetailedStackStatus.AVAILABLE);\n+                    } else {\n+                        statuses.add(DetailedStackStatus.UNHEALTHY);\n+                    }\n+                } catch (Exception e) {\n+                    LOGGER.info(\"FreeIpaClientException occurred during status fetch: \" + e.getMessage(), e);\n+                    statuses.add(DetailedStackStatus.UNREACHABLE);\n+                }\n             }\n-            return statuses;\n+            String message = getMessages(responses);\n+            return Pair.of(statuses, message);\n         }, LOGGER, \":::Auto sync::: freeipa server status is checked in {}ms\");\n     }\n \n     public SyncResult getStatus(Stack stack, Set<InstanceMetaData> checkableInstances) {\n         try {\n-            Set<InstanceMetaData> notTermiatedStackInstances = instanceMetaDataService.findNotTerminatedForStack(stack.getId());\n-            List<RPCResponse<Boolean>> responses = checkStatus(stack, checkableInstances);\n+            // Exclude terminated but include deleted\n+            Set<InstanceMetaData> notTermiatedStackInstances = stack.getAllInstanceMetaDataList().stream()\n+                    .filter(Predicate.not(InstanceMetaData::isTerminated))\n+                    .collect(Collectors.toSet());\n+            Pair<List<DetailedStackStatus>, String> statusCheckPair = checkStatus(stack, checkableInstances);\n+            List<DetailedStackStatus> responses = statusCheckPair.getFirst();\n             DetailedStackStatus status;\n             String postFix = \"\";\n-            Boolean result = !responses.isEmpty() && responses.stream().allMatch(RPCResponse::getResult);\n-            if (result && responses.size() == notTermiatedStackInstances.size()) {\n-                status = DetailedStackStatus.PROVISIONED;\n+            Boolean result = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9329dd6b6e248cf8cd321d47bd13f60bde32e3c"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzI3NzU2OA==", "bodyText": "could you refactor this condition. at least I think the stream on should be moved to a method/variable called something like isAllStatusTheSame if I guess well it's purpose", "url": "https://github.com/hortonworks/cloudbreak/pull/9065#discussion_r493277568", "createdAt": "2020-09-23T07:57:56Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/sync/FreeipaChecker.java", "diffHunk": "@@ -35,41 +34,60 @@\n     @Inject\n     private InstanceMetaDataService instanceMetaDataService;\n \n-    private List<RPCResponse<Boolean>> checkStatus(Stack stack, Set<InstanceMetaData> checkableInstances) throws Exception {\n+    private Pair<List<DetailedStackStatus>, String> checkStatus(Stack stack, Set<InstanceMetaData> checkableInstances) throws Exception {\n         return checkedMeasure(() -> {\n-            List<RPCResponse<Boolean>> statuses = new LinkedList<>();\n+            List<DetailedStackStatus> statuses = new LinkedList<>();\n+            List<RPCResponse<Boolean>> responses = new LinkedList<>();\n             for (InstanceMetaData instanceMetaData : checkableInstances) {\n                 String hostname = instanceMetaData.getDiscoveryFQDN();\n-                FreeIpaClient freeIpaClient = checkedMeasure(() -> freeIpaClientFactory.getFreeIpaClientForStackWithPing(stack, hostname), LOGGER,\n-                        \":::Auto sync::: freeipa client is created in {}ms\");\n-                statuses.add(checkedMeasure(() -> freeIpaClient.serverConnCheck(freeIpaClient.getHostname(), hostname), LOGGER,\n-                        \":::Auto sync::: freeipa server_conncheck ran in {}ms\"));\n+                try {\n+                    FreeIpaClient freeIpaClient = checkedMeasure(() -> freeIpaClientFactory.getFreeIpaClientForStackWithPing(stack, hostname), LOGGER,\n+                            \":::Auto sync::: freeipa client is created in {}ms\");\n+                    RPCResponse<Boolean> response = checkedMeasure(() -> freeIpaClient.serverConnCheck(freeIpaClient.getHostname(), hostname), LOGGER,\n+                            \":::Auto sync::: freeipa server_conncheck ran in {}ms\");\n+                    responses.add(response);\n+                    if (response.getResult()) {\n+                        statuses.add(DetailedStackStatus.AVAILABLE);\n+                    } else {\n+                        statuses.add(DetailedStackStatus.UNHEALTHY);\n+                    }\n+                } catch (Exception e) {\n+                    LOGGER.info(\"FreeIpaClientException occurred during status fetch: \" + e.getMessage(), e);\n+                    statuses.add(DetailedStackStatus.UNREACHABLE);\n+                }\n             }\n-            return statuses;\n+            String message = getMessages(responses);\n+            return Pair.of(statuses, message);\n         }, LOGGER, \":::Auto sync::: freeipa server status is checked in {}ms\");\n     }\n \n     public SyncResult getStatus(Stack stack, Set<InstanceMetaData> checkableInstances) {\n         try {\n-            Set<InstanceMetaData> notTermiatedStackInstances = instanceMetaDataService.findNotTerminatedForStack(stack.getId());\n-            List<RPCResponse<Boolean>> responses = checkStatus(stack, checkableInstances);\n+            // Exclude terminated but include deleted\n+            Set<InstanceMetaData> notTermiatedStackInstances = stack.getAllInstanceMetaDataList().stream()\n+                    .filter(Predicate.not(InstanceMetaData::isTerminated))\n+                    .collect(Collectors.toSet());\n+            Pair<List<DetailedStackStatus>, String> statusCheckPair = checkStatus(stack, checkableInstances);\n+            List<DetailedStackStatus> responses = statusCheckPair.getFirst();\n             DetailedStackStatus status;\n             String postFix = \"\";\n-            Boolean result = !responses.isEmpty() && responses.stream().allMatch(RPCResponse::getResult);\n-            if (result && responses.size() == notTermiatedStackInstances.size()) {\n-                status = DetailedStackStatus.PROVISIONED;\n+            Boolean result = false;\n+            if (responses.isEmpty()) {\n+                status = DetailedStackStatus.UNREACHABLE;\n+                postFix = \"Freeipa is unreachable, \";\n             } else {\n-                status = DetailedStackStatus.UNHEALTHY;\n-                postFix = \"Freeipa is unhealthy, \";\n+                DetailedStackStatus first = responses.get(0);\n+                if (responses.stream().allMatch(Predicate.isEqual(first)) && responses.size() == notTermiatedStackInstances.size()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9329dd6b6e248cf8cd321d47bd13f60bde32e3c"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzI4MTI2MA==", "bodyText": "InstanceMetaDataService is not used anymore, please remove", "url": "https://github.com/hortonworks/cloudbreak/pull/9065#discussion_r493281260", "createdAt": "2020-09-23T08:01:37Z", "author": {"login": "lacikaaa"}, "path": "freeipa/src/main/java/com/sequenceiq/freeipa/sync/StackStatusCheckerJob.java", "diffHunk": "@@ -88,8 +88,12 @@ private void syncAStack(Stack stack) {\n         try {\n             checkedMeasure(() -> {\n                 ThreadBasedUserCrnProvider.doAsInternalActor(() -> {\n-                    Set<InstanceMetaData> notTerminatedForStack = instanceMetaDataService.findNotTerminatedForStack(stack.getId());\n-                    Set<InstanceMetaData> checkableInstances = notTerminatedForStack.stream().filter(i -> !i.isDeletedOnProvider())\n+                    // Exclude terminated but include deleted", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9329dd6b6e248cf8cd321d47bd13f60bde32e3c"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0NDU4MjYz", "url": "https://github.com/hortonworks/cloudbreak/pull/9065#pullrequestreview-494458263", "createdAt": "2020-09-23T09:13:09Z", "commit": {"oid": "d9329dd6b6e248cf8cd321d47bd13f60bde32e3c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwOToxMzowOVrOHWfv_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwOToxMzowOVrOHWfv_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzM1MDkwOA==", "bodyText": "I guess this should be INSTANCE_2. Same applies to someStoppped.\nHowever the test is green, so this case should be investigated.", "url": "https://github.com/hortonworks/cloudbreak/pull/9065#discussion_r493350908", "createdAt": "2020-09-23T09:13:09Z", "author": {"login": "Bajzathd"}, "path": "freeipa/src/test/java/com/sequenceiq/freeipa/sync/StackStatusTest.java", "diffHunk": "@@ -152,6 +174,82 @@ void deleted() throws JobExecutionException {\n         verify(stackUpdater).updateStackStatus(eq(stack), eq(DetailedStackStatus.DELETED_ON_PROVIDER_SIDE), any());\n     }\n \n+    @Test\n+    @DisplayName(\n+            \"GIVEN an available stack \" +\n+                    \"WHEN FreeIpa instance is stopped \" +\n+                    \"THEN stack status should change\"\n+    )\n+    void stoppped() throws Exception {\n+        setUp(1);\n+        setUpFreeIpaAvailabilityResponse(false);\n+        when(stackInstanceProviderChecker.checkStatus(stack, notTerminatedInstances)).thenReturn(List.of(\n+                createCloudVmInstanceStatus(INSTANCE_1, com.sequenceiq.cloudbreak.cloud.model.InstanceStatus.STOPPED)\n+        ));\n+\n+        underTest.executeInternal(jobExecutionContext);\n+\n+        verify(stackUpdater).updateStackStatus(eq(stack), eq(DetailedStackStatus.STOPPED), any());\n+    }\n+\n+    @Test\n+    @DisplayName(\n+            \"GIVEN an available stack \" +\n+                    \"WHEN All FreeIpa instance are stopped \" +\n+                    \"THEN stack status should change\"\n+    )\n+    void allStoppped() throws Exception {\n+        setUp(2);\n+        setUpFreeIpaAvailabilityResponse(false);\n+        when(stackInstanceProviderChecker.checkStatus(stack, notTerminatedInstances)).thenReturn(List.of(\n+                createCloudVmInstanceStatus(INSTANCE_1, com.sequenceiq.cloudbreak.cloud.model.InstanceStatus.STOPPED),\n+                createCloudVmInstanceStatus(INSTANCE_1, com.sequenceiq.cloudbreak.cloud.model.InstanceStatus.STOPPED)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9329dd6b6e248cf8cd321d47bd13f60bde32e3c"}, "originalPosition": 138}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "048497f6143c64fa8739c2d8be21ee44d38cff3e", "author": {"user": {"login": "jamisonbennett", "name": "Jamison Bennett"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/048497f6143c64fa8739c2d8be21ee44d38cff3e", "committedDate": "2020-09-23T22:48:21Z", "message": "CB-8137: Fix FreeIPA status for deleted, stopped, available, unreac...\n...hable, and unhealthy\n\nFixed FreeIPA status for HA clusters.\n * Stopped + Running = Unhealthy\n * Stopped + Terminated = Unhealthy\n * Unreachable + Unreachable = Unreachable\n * Unreahable + Running = Unhealthy\n * Running + Deleted = Unhealthy\n\nThis was tested with unit tests and also manually with a local\ndeployment of cloudbreak."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d9329dd6b6e248cf8cd321d47bd13f60bde32e3c", "author": {"user": {"login": "jamisonbennett", "name": "Jamison Bennett"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/d9329dd6b6e248cf8cd321d47bd13f60bde32e3c", "committedDate": "2020-09-23T02:33:54Z", "message": "CB-8137: Fix FreeIPA status for deleted, stopped, available, unreac...\n...hable, and unhealthy\n\nFixed FreeIPA status for HA clusters.\n * Stopped + Running = Unhealthy\n * Stopped + Terminated = Unhealthy (It may temporarily be unreachable)\n * Unreachable + Unreachable = Unreachable\n * Unreahable + Running = Unhealthy\n * Running + Deleted = Unhealthy\n\nThis was tested with unit tests and also manually with a local\ndeployment of cloudbreak."}, "afterCommit": {"oid": "048497f6143c64fa8739c2d8be21ee44d38cff3e", "author": {"user": {"login": "jamisonbennett", "name": "Jamison Bennett"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/048497f6143c64fa8739c2d8be21ee44d38cff3e", "committedDate": "2020-09-23T22:48:21Z", "message": "CB-8137: Fix FreeIPA status for deleted, stopped, available, unreac...\n...hable, and unhealthy\n\nFixed FreeIPA status for HA clusters.\n * Stopped + Running = Unhealthy\n * Stopped + Terminated = Unhealthy\n * Unreachable + Unreachable = Unreachable\n * Unreahable + Running = Unhealthy\n * Running + Deleted = Unhealthy\n\nThis was tested with unit tests and also manually with a local\ndeployment of cloudbreak."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MjUzNzkw", "url": "https://github.com/hortonworks/cloudbreak/pull/9065#pullrequestreview-495253790", "createdAt": "2020-09-24T06:28:03Z", "commit": {"oid": "048497f6143c64fa8739c2d8be21ee44d38cff3e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MzM5ODU4", "url": "https://github.com/hortonworks/cloudbreak/pull/9065#pullrequestreview-495339858", "createdAt": "2020-09-24T08:33:57Z", "commit": {"oid": "048497f6143c64fa8739c2d8be21ee44d38cff3e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2230, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}