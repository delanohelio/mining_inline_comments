{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxNTIwMjEx", "number": 7622, "title": "CB-5944 List api methods should be filtered correctly based on Crn", "bodyText": "", "createdAt": "2020-03-20T13:02:48Z", "url": "https://github.com/hortonworks/cloudbreak/pull/7622", "merged": true, "mergeCommit": {"oid": "28265d0e4681ec9d8bef425e0ad6e339584127ed"}, "closed": true, "closedAt": "2020-03-25T12:02:52Z", "author": {"login": "horadla23"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcQankGgBqjMxNTQyNjkxNjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcRGO8igFqTM4MTA4MTA3NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ac6868f27a466c2b303fc87a59cc513ca84ce55f", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/ac6868f27a466c2b303fc87a59cc513ca84ce55f", "committedDate": "2020-03-20T13:00:57Z", "message": "CB-5944 List api methods should be filtered correctly based on Crn"}, "afterCommit": {"oid": "c3d4ed6d70aec9a9cb75989eaae849f8974d2a8f", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/c3d4ed6d70aec9a9cb75989eaae849f8974d2a8f", "committedDate": "2020-03-23T09:09:18Z", "message": "CB-5944 List api methods should be filtered correctly based on Crn"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c3d4ed6d70aec9a9cb75989eaae849f8974d2a8f", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/c3d4ed6d70aec9a9cb75989eaae849f8974d2a8f", "committedDate": "2020-03-23T09:09:18Z", "message": "CB-5944 List api methods should be filtered correctly based on Crn"}, "afterCommit": {"oid": "b6dd243b005d49d6fadb7d90d6a527f72aec3e4e", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/b6dd243b005d49d6fadb7d90d6a527f72aec3e4e", "committedDate": "2020-03-23T11:05:02Z", "message": "CB-5944 List api methods should be filtered correctly based on Crn"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b6dd243b005d49d6fadb7d90d6a527f72aec3e4e", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/b6dd243b005d49d6fadb7d90d6a527f72aec3e4e", "committedDate": "2020-03-23T11:05:02Z", "message": "CB-5944 List api methods should be filtered correctly based on Crn"}, "afterCommit": {"oid": "7a2e0217fb47b39f5b4e43b905a793647bffc373", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/7a2e0217fb47b39f5b4e43b905a793647bffc373", "committedDate": "2020-03-23T11:06:51Z", "message": "CB-5944 List api methods should be filtered correctly based on Crn"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7a2e0217fb47b39f5b4e43b905a793647bffc373", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/7a2e0217fb47b39f5b4e43b905a793647bffc373", "committedDate": "2020-03-23T11:06:51Z", "message": "CB-5944 List api methods should be filtered correctly based on Crn"}, "afterCommit": {"oid": "0499ccefea1f4d1541048a7ce3322fa3c7ea08ed", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/0499ccefea1f4d1541048a7ce3322fa3c7ea08ed", "committedDate": "2020-03-23T16:08:52Z", "message": "CB-5944 List api methods should be filtered correctly based on Crn"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0499ccefea1f4d1541048a7ce3322fa3c7ea08ed", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/0499ccefea1f4d1541048a7ce3322fa3c7ea08ed", "committedDate": "2020-03-23T16:08:52Z", "message": "CB-5944 List api methods should be filtered correctly based on Crn"}, "afterCommit": {"oid": "835d3ff6d85aef58e64491af46d42a2e66484ef1", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/835d3ff6d85aef58e64491af46d42a2e66484ef1", "committedDate": "2020-03-23T16:15:26Z", "message": "CB-5944 List api methods should be filtered correctly based on Crn"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "835d3ff6d85aef58e64491af46d42a2e66484ef1", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/835d3ff6d85aef58e64491af46d42a2e66484ef1", "committedDate": "2020-03-23T16:15:26Z", "message": "CB-5944 List api methods should be filtered correctly based on Crn"}, "afterCommit": {"oid": "03af418e57bdeabcc8ce0cb82e24b6f24ef7d4bf", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/03af418e57bdeabcc8ce0cb82e24b6f24ef7d4bf", "committedDate": "2020-03-23T16:38:00Z", "message": "CB-5944 List api methods should be filtered correctly based on Crn"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "03af418e57bdeabcc8ce0cb82e24b6f24ef7d4bf", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/03af418e57bdeabcc8ce0cb82e24b6f24ef7d4bf", "committedDate": "2020-03-23T16:38:00Z", "message": "CB-5944 List api methods should be filtered correctly based on Crn"}, "afterCommit": {"oid": "1d81befa0ba1340066f4f990ec7074bca5df7cf9", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/1d81befa0ba1340066f4f990ec7074bca5df7cf9", "committedDate": "2020-03-24T07:56:42Z", "message": "CB-5944 List api methods should be filtered correctly based on Crn"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1d81befa0ba1340066f4f990ec7074bca5df7cf9", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/1d81befa0ba1340066f4f990ec7074bca5df7cf9", "committedDate": "2020-03-24T07:56:42Z", "message": "CB-5944 List api methods should be filtered correctly based on Crn"}, "afterCommit": {"oid": "4758cd546246015a349b4503104e8e56535ad78f", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/4758cd546246015a349b4503104e8e56535ad78f", "committedDate": "2020-03-24T12:05:54Z", "message": "CB-5944 List api methods should be filtered correctly based on Crn"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4758cd546246015a349b4503104e8e56535ad78f", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/4758cd546246015a349b4503104e8e56535ad78f", "committedDate": "2020-03-24T12:05:54Z", "message": "CB-5944 List api methods should be filtered correctly based on Crn"}, "afterCommit": {"oid": "0d48fa6c265dbedf3f9fae58b14d2fcbbbae7693", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/0d48fa6c265dbedf3f9fae58b14d2fcbbbae7693", "committedDate": "2020-03-25T08:18:39Z", "message": "CB-5944 List api methods should be filtered correctly based on Crn"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0d48fa6c265dbedf3f9fae58b14d2fcbbbae7693", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/0d48fa6c265dbedf3f9fae58b14d2fcbbbae7693", "committedDate": "2020-03-25T08:18:39Z", "message": "CB-5944 List api methods should be filtered correctly based on Crn"}, "afterCommit": {"oid": "8339d970c0a7485333d2610b3b0e566bbceba566", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/8339d970c0a7485333d2610b3b0e566bbceba566", "committedDate": "2020-03-25T08:23:07Z", "message": "CB-5944 List api methods should be filtered correctly based on Crn"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwOTc1ODQy", "url": "https://github.com/hortonworks/cloudbreak/pull/7622#pullrequestreview-380975842", "createdAt": "2020-03-25T09:24:55Z", "commit": {"oid": "8339d970c0a7485333d2610b3b0e566bbceba566"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwOToyNDo1NVrOF7SUNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwOTo1NToyMVrOF7TeZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzcxMDM4OA==", "bodyText": "The hasRights method before has an incorrect logging (called with 2 args although the log will contain only the first argument). Can you please fix that?\n\t        LOGGER.info(\"Checking whether member [] has rights [{}]\",\n                memberCrn,\n                rightChecks.stream().map(AuthorizationProto.RightCheck::getRight).collect(Collectors.toList()));\t                rightChecks.stream().map(AuthorizationProto.RightCheck::getRight).collect(Collectors.toList()))", "url": "https://github.com/hortonworks/cloudbreak/pull/7622#discussion_r397710388", "createdAt": "2020-03-25T09:24:55Z", "author": {"login": "foldik"}, "path": "auth-connector/src/main/java/com/sequenceiq/cloudbreak/auth/altus/GrpcUmsClient.java", "diffHunk": "@@ -379,13 +379,15 @@ public boolean checkRight(String actorCrn, String userCrn, String right, Optiona\n         }\n     }\n \n-    public List<Boolean> hasRights(String actorCrn, String memberCrn, Map<String, String> rightCheckMap, Optional<String> requestId) {\n+    public Map<String, Boolean> hasRights(String actorCrn, String memberCrn, List<String> resources, String right, Optional<String> requestId) {\n         List<AuthorizationProto.RightCheck> rightChecks = Lists.newArrayList();\n-        rightCheckMap.entrySet().stream().forEach(entry -> rightChecks.add(AuthorizationProto.RightCheck.newBuilder()\n-                .setResource(entry.getKey())\n-                .setRight(entry.getValue())\n+        resources.stream().forEach(resource -> rightChecks.add(AuthorizationProto.RightCheck.newBuilder()\n+                .setResource(resource)\n+                .setRight(right)\n                 .build()));\n-        return hasRights(actorCrn, memberCrn, rightChecks, requestId);\n+        List<Boolean> result = hasRights(actorCrn, memberCrn, rightChecks, requestId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8339d970c0a7485333d2610b3b0e566bbceba566"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzcxNjY4OQ==", "bodyText": "Please rewire it to stream().map(...).collect() format.", "url": "https://github.com/hortonworks/cloudbreak/pull/7622#discussion_r397716689", "createdAt": "2020-03-25T09:34:47Z", "author": {"login": "foldik"}, "path": "auth-connector/src/main/java/com/sequenceiq/cloudbreak/auth/altus/GrpcUmsClient.java", "diffHunk": "@@ -379,13 +379,15 @@ public boolean checkRight(String actorCrn, String userCrn, String right, Optiona\n         }\n     }\n \n-    public List<Boolean> hasRights(String actorCrn, String memberCrn, Map<String, String> rightCheckMap, Optional<String> requestId) {\n+    public Map<String, Boolean> hasRights(String actorCrn, String memberCrn, List<String> resources, String right, Optional<String> requestId) {\n         List<AuthorizationProto.RightCheck> rightChecks = Lists.newArrayList();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8339d970c0a7485333d2610b3b0e566bbceba566"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzcyOTM4Mw==", "bodyText": "Please use a Collectors.toSet() here.", "url": "https://github.com/hortonworks/cloudbreak/pull/7622#discussion_r397729383", "createdAt": "2020-03-25T09:55:21Z", "author": {"login": "foldik"}, "path": "authorization-common/src/main/java/com/sequenceiq/authorization/service/ListPermissionChecker.java", "diffHunk": "@@ -0,0 +1,117 @@\n+package com.sequenceiq.authorization.service;\n+\n+import java.lang.annotation.Annotation;\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.function.Predicate;\n+import java.util.stream.Collectors;\n+\n+import javax.annotation.PostConstruct;\n+import javax.inject.Inject;\n+\n+import org.aspectj.lang.ProceedingJoinPoint;\n+import org.aspectj.lang.reflect.MethodSignature;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.authorization.annotation.FilterListBasedOnPermissions;\n+import com.sequenceiq.authorization.resource.AuthorizationFilterableResponseCollection;\n+import com.sequenceiq.authorization.resource.AuthorizationResourceAction;\n+import com.sequenceiq.authorization.resource.AuthorizationResourceType;\n+import com.sequenceiq.authorization.resource.ResourceCrnAwareApiModel;\n+import com.sequenceiq.authorization.resource.ListResponseAuthorizationType;\n+\n+@Component\n+public class ListPermissionChecker implements PermissionChecker<FilterListBasedOnPermissions> {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(ListPermissionChecker.class);\n+\n+    @Inject\n+    private CommonPermissionCheckingUtils commonPermissionCheckingUtils;\n+\n+    @Inject\n+    private List<ResourceBasedCrnProvider> resourceBasedCrnProviders;\n+\n+    private final Map<AuthorizationResourceType, ResourceBasedCrnProvider> resourceBasedCrnProviderMap = new HashMap<>();\n+\n+    @PostConstruct\n+    public void populateResourceBasedCrnProviderMap() {\n+        resourceBasedCrnProviders.forEach(resourceBasedCrnProvider ->\n+                resourceBasedCrnProviderMap.put(resourceBasedCrnProvider.getResourceType(), resourceBasedCrnProvider));\n+    }\n+\n+    @Override\n+    public <T extends Annotation> Object checkPermissions(T rawMethodAnnotation, AuthorizationResourceType resourceType, String userCrn,\n+            ProceedingJoinPoint proceedingJoinPoint, MethodSignature methodSignature, long startTime) {\n+        FilterListBasedOnPermissions methodAnnotation = (FilterListBasedOnPermissions) rawMethodAnnotation;\n+        AuthorizationResourceAction action = methodAnnotation.action();\n+        List<String> allResourceCrns = resourceBasedCrnProviderMap.get(resourceType).getResourceCrnsInAccount();\n+        List<String> filteredResourceCrns = commonPermissionCheckingUtils.getPermissionsForUserOnResources(resourceType, action, userCrn, allResourceCrns)\n+                .entrySet()\n+                .stream()\n+                .filter(Map.Entry::getValue)\n+                .map(Map.Entry::getKey)\n+                .collect(Collectors.toList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8339d970c0a7485333d2610b3b0e566bbceba566"}, "originalPosition": 58}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8339d970c0a7485333d2610b3b0e566bbceba566", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/8339d970c0a7485333d2610b3b0e566bbceba566", "committedDate": "2020-03-25T08:23:07Z", "message": "CB-5944 List api methods should be filtered correctly based on Crn"}, "afterCommit": {"oid": "2fc7ac44ef5aed31351e873d3e644a05b3524368", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/2fc7ac44ef5aed31351e873d3e644a05b3524368", "committedDate": "2020-03-25T10:27:17Z", "message": "CB-5944 List api methods should be filtered correctly based on Crn"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aff9bb4a8be51e42675d6c4b6bee5a43636df04b", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/aff9bb4a8be51e42675d6c4b6bee5a43636df04b", "committedDate": "2020-03-25T10:55:03Z", "message": "CB-5944 List api methods should be filtered correctly based on Crn"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2fc7ac44ef5aed31351e873d3e644a05b3524368", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/2fc7ac44ef5aed31351e873d3e644a05b3524368", "committedDate": "2020-03-25T10:27:17Z", "message": "CB-5944 List api methods should be filtered correctly based on Crn"}, "afterCommit": {"oid": "aff9bb4a8be51e42675d6c4b6bee5a43636df04b", "author": {"user": {"login": "horadla23", "name": "Adam Horvath"}}, "url": "https://github.com/hortonworks/cloudbreak/commit/aff9bb4a8be51e42675d6c4b6bee5a43636df04b", "committedDate": "2020-03-25T10:55:03Z", "message": "CB-5944 List api methods should be filtered correctly based on Crn"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxMDc3Nzc4", "url": "https://github.com/hortonworks/cloudbreak/pull/7622#pullrequestreview-381077778", "createdAt": "2020-03-25T11:53:21Z", "commit": {"oid": "aff9bb4a8be51e42675d6c4b6bee5a43636df04b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxMDgxMDc1", "url": "https://github.com/hortonworks/cloudbreak/pull/7622#pullrequestreview-381081075", "createdAt": "2020-03-25T11:58:33Z", "commit": {"oid": "aff9bb4a8be51e42675d6c4b6bee5a43636df04b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2491, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}