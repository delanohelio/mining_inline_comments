{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMxMjU2NzMz", "number": 4700, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMDoxOTo0NVrOE_yyYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMDo0MDoyNlrOE_zOmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1MzI3ODQzOnYy", "diffSide": "RIGHT", "path": "nifi-nar-bundles/nifi-framework-bundle/nifi-stateless-bundle/nifi-stateless-engine/src/main/java/org/apache/nifi/stateless/repository/VolatileProvenanceRepository.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMDoxOTo0NVrOH9skkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMDozNTo1MFrOH9tHTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ1NTQ0Mw==", "bodyText": "Given the usage pattern, that this will only be used in stateless, and it's not loaded via the service loader, I don't think we even need the no-arg constructor.", "url": "https://github.com/apache/nifi/pull/4700#discussion_r534455443", "createdAt": "2020-12-02T20:19:45Z", "author": {"login": "markap14"}, "path": "nifi-nar-bundles/nifi-framework-bundle/nifi-stateless-bundle/nifi-stateless-engine/src/main/java/org/apache/nifi/stateless/repository/VolatileProvenanceRepository.java", "diffHunk": "@@ -0,0 +1,409 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.nifi.stateless.repository;\n+\n+import org.apache.nifi.authorization.Authorizer;\n+import org.apache.nifi.authorization.user.NiFiUser;\n+import org.apache.nifi.events.EventReporter;\n+import org.apache.nifi.provenance.AsyncLineageSubmission;\n+import org.apache.nifi.provenance.IdentifierLookup;\n+import org.apache.nifi.provenance.ProvenanceAuthorizableFactory;\n+import org.apache.nifi.provenance.ProvenanceEventBuilder;\n+import org.apache.nifi.provenance.ProvenanceEventRecord;\n+import org.apache.nifi.provenance.ProvenanceEventRepository;\n+import org.apache.nifi.provenance.ProvenanceEventType;\n+import org.apache.nifi.provenance.ProvenanceRepository;\n+import org.apache.nifi.provenance.StandardProvenanceEventRecord;\n+import org.apache.nifi.provenance.lineage.ComputeLineageSubmission;\n+import org.apache.nifi.provenance.search.Query;\n+import org.apache.nifi.provenance.search.QuerySubmission;\n+import org.apache.nifi.provenance.search.SearchableField;\n+import org.apache.nifi.util.RingBuffer;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+public class VolatileProvenanceRepository implements ProvenanceRepository {\n+\n+    // default property values\n+    public static final int DEFAULT_BUFFER_SIZE = 10000;\n+\n+    public static String CONTAINER_NAME = \"in-memory\";\n+\n+    private final RingBuffer<ProvenanceEventRecord> ringBuffer;\n+    private final int maxSize;\n+\n+    private final AtomicLong idGenerator = new AtomicLong(0L);\n+    private final AtomicBoolean initialized = new AtomicBoolean(false);\n+\n+    /**\n+     * Default no args constructor for service loading only\n+     */\n+    public VolatileProvenanceRepository() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "292e776df86c5cb972663035a50eae0fc5b33b15"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ2NDMzMg==", "bodyText": "Agree", "url": "https://github.com/apache/nifi/pull/4700#discussion_r534464332", "createdAt": "2020-12-02T20:35:50Z", "author": {"login": "bbende"}, "path": "nifi-nar-bundles/nifi-framework-bundle/nifi-stateless-bundle/nifi-stateless-engine/src/main/java/org/apache/nifi/stateless/repository/VolatileProvenanceRepository.java", "diffHunk": "@@ -0,0 +1,409 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.nifi.stateless.repository;\n+\n+import org.apache.nifi.authorization.Authorizer;\n+import org.apache.nifi.authorization.user.NiFiUser;\n+import org.apache.nifi.events.EventReporter;\n+import org.apache.nifi.provenance.AsyncLineageSubmission;\n+import org.apache.nifi.provenance.IdentifierLookup;\n+import org.apache.nifi.provenance.ProvenanceAuthorizableFactory;\n+import org.apache.nifi.provenance.ProvenanceEventBuilder;\n+import org.apache.nifi.provenance.ProvenanceEventRecord;\n+import org.apache.nifi.provenance.ProvenanceEventRepository;\n+import org.apache.nifi.provenance.ProvenanceEventType;\n+import org.apache.nifi.provenance.ProvenanceRepository;\n+import org.apache.nifi.provenance.StandardProvenanceEventRecord;\n+import org.apache.nifi.provenance.lineage.ComputeLineageSubmission;\n+import org.apache.nifi.provenance.search.Query;\n+import org.apache.nifi.provenance.search.QuerySubmission;\n+import org.apache.nifi.provenance.search.SearchableField;\n+import org.apache.nifi.util.RingBuffer;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+public class VolatileProvenanceRepository implements ProvenanceRepository {\n+\n+    // default property values\n+    public static final int DEFAULT_BUFFER_SIZE = 10000;\n+\n+    public static String CONTAINER_NAME = \"in-memory\";\n+\n+    private final RingBuffer<ProvenanceEventRecord> ringBuffer;\n+    private final int maxSize;\n+\n+    private final AtomicLong idGenerator = new AtomicLong(0L);\n+    private final AtomicBoolean initialized = new AtomicBoolean(false);\n+\n+    /**\n+     * Default no args constructor for service loading only\n+     */\n+    public VolatileProvenanceRepository() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ1NTQ0Mw=="}, "originalCommit": {"oid": "292e776df86c5cb972663035a50eae0fc5b33b15"}, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1MzI4MTE5OnYy", "diffSide": "RIGHT", "path": "nifi-nar-bundles/nifi-framework-bundle/nifi-stateless-bundle/nifi-stateless-engine/src/main/java/org/apache/nifi/stateless/repository/VolatileProvenanceRepository.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMDoyMDoyOVrOH9smPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMDozNTo1OVrOH9tHlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ1NTg2OA==", "bodyText": "I think we can just make this a no-op and remove the initialized - doesn't appear to serve any particular function?", "url": "https://github.com/apache/nifi/pull/4700#discussion_r534455868", "createdAt": "2020-12-02T20:20:29Z", "author": {"login": "markap14"}, "path": "nifi-nar-bundles/nifi-framework-bundle/nifi-stateless-bundle/nifi-stateless-engine/src/main/java/org/apache/nifi/stateless/repository/VolatileProvenanceRepository.java", "diffHunk": "@@ -0,0 +1,409 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.nifi.stateless.repository;\n+\n+import org.apache.nifi.authorization.Authorizer;\n+import org.apache.nifi.authorization.user.NiFiUser;\n+import org.apache.nifi.events.EventReporter;\n+import org.apache.nifi.provenance.AsyncLineageSubmission;\n+import org.apache.nifi.provenance.IdentifierLookup;\n+import org.apache.nifi.provenance.ProvenanceAuthorizableFactory;\n+import org.apache.nifi.provenance.ProvenanceEventBuilder;\n+import org.apache.nifi.provenance.ProvenanceEventRecord;\n+import org.apache.nifi.provenance.ProvenanceEventRepository;\n+import org.apache.nifi.provenance.ProvenanceEventType;\n+import org.apache.nifi.provenance.ProvenanceRepository;\n+import org.apache.nifi.provenance.StandardProvenanceEventRecord;\n+import org.apache.nifi.provenance.lineage.ComputeLineageSubmission;\n+import org.apache.nifi.provenance.search.Query;\n+import org.apache.nifi.provenance.search.QuerySubmission;\n+import org.apache.nifi.provenance.search.SearchableField;\n+import org.apache.nifi.util.RingBuffer;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+public class VolatileProvenanceRepository implements ProvenanceRepository {\n+\n+    // default property values\n+    public static final int DEFAULT_BUFFER_SIZE = 10000;\n+\n+    public static String CONTAINER_NAME = \"in-memory\";\n+\n+    private final RingBuffer<ProvenanceEventRecord> ringBuffer;\n+    private final int maxSize;\n+\n+    private final AtomicLong idGenerator = new AtomicLong(0L);\n+    private final AtomicBoolean initialized = new AtomicBoolean(false);\n+\n+    /**\n+     * Default no args constructor for service loading only\n+     */\n+    public VolatileProvenanceRepository() {\n+        ringBuffer = null;\n+        maxSize = DEFAULT_BUFFER_SIZE;\n+    }\n+\n+    public VolatileProvenanceRepository(final int maxEvents) {\n+        maxSize = maxEvents;\n+        ringBuffer = new RingBuffer<>(maxSize);\n+    }\n+\n+    @Override\n+    public void initialize(final EventReporter eventReporter, final Authorizer authorizer, final ProvenanceAuthorizableFactory resourceFactory,\n+                           final IdentifierLookup idLookup) throws IOException {\n+        if (initialized.getAndSet(true)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "292e776df86c5cb972663035a50eae0fc5b33b15"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ2NDQwNA==", "bodyText": "Agree", "url": "https://github.com/apache/nifi/pull/4700#discussion_r534464404", "createdAt": "2020-12-02T20:35:59Z", "author": {"login": "bbende"}, "path": "nifi-nar-bundles/nifi-framework-bundle/nifi-stateless-bundle/nifi-stateless-engine/src/main/java/org/apache/nifi/stateless/repository/VolatileProvenanceRepository.java", "diffHunk": "@@ -0,0 +1,409 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.nifi.stateless.repository;\n+\n+import org.apache.nifi.authorization.Authorizer;\n+import org.apache.nifi.authorization.user.NiFiUser;\n+import org.apache.nifi.events.EventReporter;\n+import org.apache.nifi.provenance.AsyncLineageSubmission;\n+import org.apache.nifi.provenance.IdentifierLookup;\n+import org.apache.nifi.provenance.ProvenanceAuthorizableFactory;\n+import org.apache.nifi.provenance.ProvenanceEventBuilder;\n+import org.apache.nifi.provenance.ProvenanceEventRecord;\n+import org.apache.nifi.provenance.ProvenanceEventRepository;\n+import org.apache.nifi.provenance.ProvenanceEventType;\n+import org.apache.nifi.provenance.ProvenanceRepository;\n+import org.apache.nifi.provenance.StandardProvenanceEventRecord;\n+import org.apache.nifi.provenance.lineage.ComputeLineageSubmission;\n+import org.apache.nifi.provenance.search.Query;\n+import org.apache.nifi.provenance.search.QuerySubmission;\n+import org.apache.nifi.provenance.search.SearchableField;\n+import org.apache.nifi.util.RingBuffer;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+public class VolatileProvenanceRepository implements ProvenanceRepository {\n+\n+    // default property values\n+    public static final int DEFAULT_BUFFER_SIZE = 10000;\n+\n+    public static String CONTAINER_NAME = \"in-memory\";\n+\n+    private final RingBuffer<ProvenanceEventRecord> ringBuffer;\n+    private final int maxSize;\n+\n+    private final AtomicLong idGenerator = new AtomicLong(0L);\n+    private final AtomicBoolean initialized = new AtomicBoolean(false);\n+\n+    /**\n+     * Default no args constructor for service loading only\n+     */\n+    public VolatileProvenanceRepository() {\n+        ringBuffer = null;\n+        maxSize = DEFAULT_BUFFER_SIZE;\n+    }\n+\n+    public VolatileProvenanceRepository(final int maxEvents) {\n+        maxSize = maxEvents;\n+        ringBuffer = new RingBuffer<>(maxSize);\n+    }\n+\n+    @Override\n+    public void initialize(final EventReporter eventReporter, final Authorizer authorizer, final ProvenanceAuthorizableFactory resourceFactory,\n+                           final IdentifierLookup idLookup) throws IOException {\n+        if (initialized.getAndSet(true)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ1NTg2OA=="}, "originalCommit": {"oid": "292e776df86c5cb972663035a50eae0fc5b33b15"}, "originalPosition": 74}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1MzI4ODgyOnYy", "diffSide": "RIGHT", "path": "nifi-nar-bundles/nifi-framework-bundle/nifi-stateless-bundle/nifi-stateless-engine/src/main/java/org/apache/nifi/stateless/repository/VolatileProvenanceRepository.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMDoyMjo0MlrOH9srCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMDozNjoyMFrOH9tISA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ1NzA5Nw==", "bodyText": "Don't think we need to actually call this, given that isAuthorized will always return true", "url": "https://github.com/apache/nifi/pull/4700#discussion_r534457097", "createdAt": "2020-12-02T20:22:42Z", "author": {"login": "markap14"}, "path": "nifi-nar-bundles/nifi-framework-bundle/nifi-stateless-bundle/nifi-stateless-engine/src/main/java/org/apache/nifi/stateless/repository/VolatileProvenanceRepository.java", "diffHunk": "@@ -0,0 +1,409 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.nifi.stateless.repository;\n+\n+import org.apache.nifi.authorization.Authorizer;\n+import org.apache.nifi.authorization.user.NiFiUser;\n+import org.apache.nifi.events.EventReporter;\n+import org.apache.nifi.provenance.AsyncLineageSubmission;\n+import org.apache.nifi.provenance.IdentifierLookup;\n+import org.apache.nifi.provenance.ProvenanceAuthorizableFactory;\n+import org.apache.nifi.provenance.ProvenanceEventBuilder;\n+import org.apache.nifi.provenance.ProvenanceEventRecord;\n+import org.apache.nifi.provenance.ProvenanceEventRepository;\n+import org.apache.nifi.provenance.ProvenanceEventType;\n+import org.apache.nifi.provenance.ProvenanceRepository;\n+import org.apache.nifi.provenance.StandardProvenanceEventRecord;\n+import org.apache.nifi.provenance.lineage.ComputeLineageSubmission;\n+import org.apache.nifi.provenance.search.Query;\n+import org.apache.nifi.provenance.search.QuerySubmission;\n+import org.apache.nifi.provenance.search.SearchableField;\n+import org.apache.nifi.util.RingBuffer;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+public class VolatileProvenanceRepository implements ProvenanceRepository {\n+\n+    // default property values\n+    public static final int DEFAULT_BUFFER_SIZE = 10000;\n+\n+    public static String CONTAINER_NAME = \"in-memory\";\n+\n+    private final RingBuffer<ProvenanceEventRecord> ringBuffer;\n+    private final int maxSize;\n+\n+    private final AtomicLong idGenerator = new AtomicLong(0L);\n+    private final AtomicBoolean initialized = new AtomicBoolean(false);\n+\n+    /**\n+     * Default no args constructor for service loading only\n+     */\n+    public VolatileProvenanceRepository() {\n+        ringBuffer = null;\n+        maxSize = DEFAULT_BUFFER_SIZE;\n+    }\n+\n+    public VolatileProvenanceRepository(final int maxEvents) {\n+        maxSize = maxEvents;\n+        ringBuffer = new RingBuffer<>(maxSize);\n+    }\n+\n+    @Override\n+    public void initialize(final EventReporter eventReporter, final Authorizer authorizer, final ProvenanceAuthorizableFactory resourceFactory,\n+                           final IdentifierLookup idLookup) throws IOException {\n+        if (initialized.getAndSet(true)) {\n+            return;\n+        }\n+    }\n+\n+    @Override\n+    public ProvenanceEventRepository getProvenanceEventRepository() {\n+        return this;\n+    }\n+\n+    @Override\n+    public ProvenanceEventBuilder eventBuilder() {\n+        return new StandardProvenanceEventRecord.Builder();\n+    }\n+\n+    @Override\n+    public void registerEvent(final ProvenanceEventRecord event) {\n+        final long id = idGenerator.getAndIncrement();\n+        ringBuffer.add(new IdEnrichedProvEvent(event, id));\n+    }\n+\n+    @Override\n+    public void registerEvents(final Iterable<ProvenanceEventRecord> events) {\n+        for (final ProvenanceEventRecord event : events) {\n+            registerEvent(event);\n+        }\n+    }\n+\n+    @Override\n+    public List<ProvenanceEventRecord> getEvents(final long firstRecordId, final int maxRecords) throws IOException {\n+        return getEvents(firstRecordId, maxRecords, null);\n+    }\n+\n+    @Override\n+    public List<ProvenanceEventRecord> getEvents(final long firstRecordId, final int maxRecords, final NiFiUser user) throws IOException {\n+        return ringBuffer.getSelectedElements(new RingBuffer.Filter<ProvenanceEventRecord>() {\n+            @Override\n+            public boolean select(final ProvenanceEventRecord value) {\n+                if (!isAuthorized(value, user)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "292e776df86c5cb972663035a50eae0fc5b33b15"}, "originalPosition": 112}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ2NDU4NA==", "bodyText": "Agree", "url": "https://github.com/apache/nifi/pull/4700#discussion_r534464584", "createdAt": "2020-12-02T20:36:20Z", "author": {"login": "bbende"}, "path": "nifi-nar-bundles/nifi-framework-bundle/nifi-stateless-bundle/nifi-stateless-engine/src/main/java/org/apache/nifi/stateless/repository/VolatileProvenanceRepository.java", "diffHunk": "@@ -0,0 +1,409 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.nifi.stateless.repository;\n+\n+import org.apache.nifi.authorization.Authorizer;\n+import org.apache.nifi.authorization.user.NiFiUser;\n+import org.apache.nifi.events.EventReporter;\n+import org.apache.nifi.provenance.AsyncLineageSubmission;\n+import org.apache.nifi.provenance.IdentifierLookup;\n+import org.apache.nifi.provenance.ProvenanceAuthorizableFactory;\n+import org.apache.nifi.provenance.ProvenanceEventBuilder;\n+import org.apache.nifi.provenance.ProvenanceEventRecord;\n+import org.apache.nifi.provenance.ProvenanceEventRepository;\n+import org.apache.nifi.provenance.ProvenanceEventType;\n+import org.apache.nifi.provenance.ProvenanceRepository;\n+import org.apache.nifi.provenance.StandardProvenanceEventRecord;\n+import org.apache.nifi.provenance.lineage.ComputeLineageSubmission;\n+import org.apache.nifi.provenance.search.Query;\n+import org.apache.nifi.provenance.search.QuerySubmission;\n+import org.apache.nifi.provenance.search.SearchableField;\n+import org.apache.nifi.util.RingBuffer;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+public class VolatileProvenanceRepository implements ProvenanceRepository {\n+\n+    // default property values\n+    public static final int DEFAULT_BUFFER_SIZE = 10000;\n+\n+    public static String CONTAINER_NAME = \"in-memory\";\n+\n+    private final RingBuffer<ProvenanceEventRecord> ringBuffer;\n+    private final int maxSize;\n+\n+    private final AtomicLong idGenerator = new AtomicLong(0L);\n+    private final AtomicBoolean initialized = new AtomicBoolean(false);\n+\n+    /**\n+     * Default no args constructor for service loading only\n+     */\n+    public VolatileProvenanceRepository() {\n+        ringBuffer = null;\n+        maxSize = DEFAULT_BUFFER_SIZE;\n+    }\n+\n+    public VolatileProvenanceRepository(final int maxEvents) {\n+        maxSize = maxEvents;\n+        ringBuffer = new RingBuffer<>(maxSize);\n+    }\n+\n+    @Override\n+    public void initialize(final EventReporter eventReporter, final Authorizer authorizer, final ProvenanceAuthorizableFactory resourceFactory,\n+                           final IdentifierLookup idLookup) throws IOException {\n+        if (initialized.getAndSet(true)) {\n+            return;\n+        }\n+    }\n+\n+    @Override\n+    public ProvenanceEventRepository getProvenanceEventRepository() {\n+        return this;\n+    }\n+\n+    @Override\n+    public ProvenanceEventBuilder eventBuilder() {\n+        return new StandardProvenanceEventRecord.Builder();\n+    }\n+\n+    @Override\n+    public void registerEvent(final ProvenanceEventRecord event) {\n+        final long id = idGenerator.getAndIncrement();\n+        ringBuffer.add(new IdEnrichedProvEvent(event, id));\n+    }\n+\n+    @Override\n+    public void registerEvents(final Iterable<ProvenanceEventRecord> events) {\n+        for (final ProvenanceEventRecord event : events) {\n+            registerEvent(event);\n+        }\n+    }\n+\n+    @Override\n+    public List<ProvenanceEventRecord> getEvents(final long firstRecordId, final int maxRecords) throws IOException {\n+        return getEvents(firstRecordId, maxRecords, null);\n+    }\n+\n+    @Override\n+    public List<ProvenanceEventRecord> getEvents(final long firstRecordId, final int maxRecords, final NiFiUser user) throws IOException {\n+        return ringBuffer.getSelectedElements(new RingBuffer.Filter<ProvenanceEventRecord>() {\n+            @Override\n+            public boolean select(final ProvenanceEventRecord value) {\n+                if (!isAuthorized(value, user)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ1NzA5Nw=="}, "originalCommit": {"oid": "292e776df86c5cb972663035a50eae0fc5b33b15"}, "originalPosition": 112}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1MzI5ODMwOnYy", "diffSide": "RIGHT", "path": "nifi-nar-bundles/nifi-framework-bundle/nifi-stateless-bundle/nifi-stateless-engine/src/main/java/org/apache/nifi/stateless/repository/VolatileProvenanceRepository.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMDoyNToyNFrOH9sw0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMDozNjowNlrOH9tHxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ1ODU3Ng==", "bodyText": "I think we can avoid even calling authorize, no?", "url": "https://github.com/apache/nifi/pull/4700#discussion_r534458576", "createdAt": "2020-12-02T20:25:24Z", "author": {"login": "markap14"}, "path": "nifi-nar-bundles/nifi-framework-bundle/nifi-stateless-bundle/nifi-stateless-engine/src/main/java/org/apache/nifi/stateless/repository/VolatileProvenanceRepository.java", "diffHunk": "@@ -0,0 +1,409 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.nifi.stateless.repository;\n+\n+import org.apache.nifi.authorization.Authorizer;\n+import org.apache.nifi.authorization.user.NiFiUser;\n+import org.apache.nifi.events.EventReporter;\n+import org.apache.nifi.provenance.AsyncLineageSubmission;\n+import org.apache.nifi.provenance.IdentifierLookup;\n+import org.apache.nifi.provenance.ProvenanceAuthorizableFactory;\n+import org.apache.nifi.provenance.ProvenanceEventBuilder;\n+import org.apache.nifi.provenance.ProvenanceEventRecord;\n+import org.apache.nifi.provenance.ProvenanceEventRepository;\n+import org.apache.nifi.provenance.ProvenanceEventType;\n+import org.apache.nifi.provenance.ProvenanceRepository;\n+import org.apache.nifi.provenance.StandardProvenanceEventRecord;\n+import org.apache.nifi.provenance.lineage.ComputeLineageSubmission;\n+import org.apache.nifi.provenance.search.Query;\n+import org.apache.nifi.provenance.search.QuerySubmission;\n+import org.apache.nifi.provenance.search.SearchableField;\n+import org.apache.nifi.util.RingBuffer;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+public class VolatileProvenanceRepository implements ProvenanceRepository {\n+\n+    // default property values\n+    public static final int DEFAULT_BUFFER_SIZE = 10000;\n+\n+    public static String CONTAINER_NAME = \"in-memory\";\n+\n+    private final RingBuffer<ProvenanceEventRecord> ringBuffer;\n+    private final int maxSize;\n+\n+    private final AtomicLong idGenerator = new AtomicLong(0L);\n+    private final AtomicBoolean initialized = new AtomicBoolean(false);\n+\n+    /**\n+     * Default no args constructor for service loading only\n+     */\n+    public VolatileProvenanceRepository() {\n+        ringBuffer = null;\n+        maxSize = DEFAULT_BUFFER_SIZE;\n+    }\n+\n+    public VolatileProvenanceRepository(final int maxEvents) {\n+        maxSize = maxEvents;\n+        ringBuffer = new RingBuffer<>(maxSize);\n+    }\n+\n+    @Override\n+    public void initialize(final EventReporter eventReporter, final Authorizer authorizer, final ProvenanceAuthorizableFactory resourceFactory,\n+                           final IdentifierLookup idLookup) throws IOException {\n+        if (initialized.getAndSet(true)) {\n+            return;\n+        }\n+    }\n+\n+    @Override\n+    public ProvenanceEventRepository getProvenanceEventRepository() {\n+        return this;\n+    }\n+\n+    @Override\n+    public ProvenanceEventBuilder eventBuilder() {\n+        return new StandardProvenanceEventRecord.Builder();\n+    }\n+\n+    @Override\n+    public void registerEvent(final ProvenanceEventRecord event) {\n+        final long id = idGenerator.getAndIncrement();\n+        ringBuffer.add(new IdEnrichedProvEvent(event, id));\n+    }\n+\n+    @Override\n+    public void registerEvents(final Iterable<ProvenanceEventRecord> events) {\n+        for (final ProvenanceEventRecord event : events) {\n+            registerEvent(event);\n+        }\n+    }\n+\n+    @Override\n+    public List<ProvenanceEventRecord> getEvents(final long firstRecordId, final int maxRecords) throws IOException {\n+        return getEvents(firstRecordId, maxRecords, null);\n+    }\n+\n+    @Override\n+    public List<ProvenanceEventRecord> getEvents(final long firstRecordId, final int maxRecords, final NiFiUser user) throws IOException {\n+        return ringBuffer.getSelectedElements(new RingBuffer.Filter<ProvenanceEventRecord>() {\n+            @Override\n+            public boolean select(final ProvenanceEventRecord value) {\n+                if (!isAuthorized(value, user)) {\n+                    return false;\n+                }\n+\n+                return value.getEventId() >= firstRecordId;\n+            }\n+        }, maxRecords);\n+    }\n+\n+    @Override\n+    public Long getMaxEventId() {\n+        final ProvenanceEventRecord newest = ringBuffer.getNewestElement();\n+        return (newest == null) ? null : newest.getEventId();\n+    }\n+\n+    public ProvenanceEventRecord getEvent(final String identifier) throws IOException {\n+        final List<ProvenanceEventRecord> records = ringBuffer.getSelectedElements(new RingBuffer.Filter<ProvenanceEventRecord>() {\n+            @Override\n+            public boolean select(final ProvenanceEventRecord event) {\n+                return identifier.equals(event.getFlowFileUuid());\n+            }\n+        }, 1);\n+        return records.isEmpty() ? null : records.get(0);\n+    }\n+\n+    @Override\n+    public ProvenanceEventRecord getEvent(final long id) {\n+        final List<ProvenanceEventRecord> records = ringBuffer.getSelectedElements(new RingBuffer.Filter<ProvenanceEventRecord>() {\n+            @Override\n+            public boolean select(final ProvenanceEventRecord event) {\n+                return event.getEventId() == id;\n+            }\n+        }, 1);\n+\n+        return records.isEmpty() ? null : records.get(0);\n+    }\n+\n+    @Override\n+    public ProvenanceEventRecord getEvent(final long id, final NiFiUser user) {\n+        final ProvenanceEventRecord event = getEvent(id);\n+        if (event == null) {\n+            return null;\n+        }\n+\n+        authorize(event, user);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "292e776df86c5cb972663035a50eae0fc5b33b15"}, "originalPosition": 156}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ2NDQ1NQ==", "bodyText": "Agree", "url": "https://github.com/apache/nifi/pull/4700#discussion_r534464455", "createdAt": "2020-12-02T20:36:06Z", "author": {"login": "bbende"}, "path": "nifi-nar-bundles/nifi-framework-bundle/nifi-stateless-bundle/nifi-stateless-engine/src/main/java/org/apache/nifi/stateless/repository/VolatileProvenanceRepository.java", "diffHunk": "@@ -0,0 +1,409 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.nifi.stateless.repository;\n+\n+import org.apache.nifi.authorization.Authorizer;\n+import org.apache.nifi.authorization.user.NiFiUser;\n+import org.apache.nifi.events.EventReporter;\n+import org.apache.nifi.provenance.AsyncLineageSubmission;\n+import org.apache.nifi.provenance.IdentifierLookup;\n+import org.apache.nifi.provenance.ProvenanceAuthorizableFactory;\n+import org.apache.nifi.provenance.ProvenanceEventBuilder;\n+import org.apache.nifi.provenance.ProvenanceEventRecord;\n+import org.apache.nifi.provenance.ProvenanceEventRepository;\n+import org.apache.nifi.provenance.ProvenanceEventType;\n+import org.apache.nifi.provenance.ProvenanceRepository;\n+import org.apache.nifi.provenance.StandardProvenanceEventRecord;\n+import org.apache.nifi.provenance.lineage.ComputeLineageSubmission;\n+import org.apache.nifi.provenance.search.Query;\n+import org.apache.nifi.provenance.search.QuerySubmission;\n+import org.apache.nifi.provenance.search.SearchableField;\n+import org.apache.nifi.util.RingBuffer;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+public class VolatileProvenanceRepository implements ProvenanceRepository {\n+\n+    // default property values\n+    public static final int DEFAULT_BUFFER_SIZE = 10000;\n+\n+    public static String CONTAINER_NAME = \"in-memory\";\n+\n+    private final RingBuffer<ProvenanceEventRecord> ringBuffer;\n+    private final int maxSize;\n+\n+    private final AtomicLong idGenerator = new AtomicLong(0L);\n+    private final AtomicBoolean initialized = new AtomicBoolean(false);\n+\n+    /**\n+     * Default no args constructor for service loading only\n+     */\n+    public VolatileProvenanceRepository() {\n+        ringBuffer = null;\n+        maxSize = DEFAULT_BUFFER_SIZE;\n+    }\n+\n+    public VolatileProvenanceRepository(final int maxEvents) {\n+        maxSize = maxEvents;\n+        ringBuffer = new RingBuffer<>(maxSize);\n+    }\n+\n+    @Override\n+    public void initialize(final EventReporter eventReporter, final Authorizer authorizer, final ProvenanceAuthorizableFactory resourceFactory,\n+                           final IdentifierLookup idLookup) throws IOException {\n+        if (initialized.getAndSet(true)) {\n+            return;\n+        }\n+    }\n+\n+    @Override\n+    public ProvenanceEventRepository getProvenanceEventRepository() {\n+        return this;\n+    }\n+\n+    @Override\n+    public ProvenanceEventBuilder eventBuilder() {\n+        return new StandardProvenanceEventRecord.Builder();\n+    }\n+\n+    @Override\n+    public void registerEvent(final ProvenanceEventRecord event) {\n+        final long id = idGenerator.getAndIncrement();\n+        ringBuffer.add(new IdEnrichedProvEvent(event, id));\n+    }\n+\n+    @Override\n+    public void registerEvents(final Iterable<ProvenanceEventRecord> events) {\n+        for (final ProvenanceEventRecord event : events) {\n+            registerEvent(event);\n+        }\n+    }\n+\n+    @Override\n+    public List<ProvenanceEventRecord> getEvents(final long firstRecordId, final int maxRecords) throws IOException {\n+        return getEvents(firstRecordId, maxRecords, null);\n+    }\n+\n+    @Override\n+    public List<ProvenanceEventRecord> getEvents(final long firstRecordId, final int maxRecords, final NiFiUser user) throws IOException {\n+        return ringBuffer.getSelectedElements(new RingBuffer.Filter<ProvenanceEventRecord>() {\n+            @Override\n+            public boolean select(final ProvenanceEventRecord value) {\n+                if (!isAuthorized(value, user)) {\n+                    return false;\n+                }\n+\n+                return value.getEventId() >= firstRecordId;\n+            }\n+        }, maxRecords);\n+    }\n+\n+    @Override\n+    public Long getMaxEventId() {\n+        final ProvenanceEventRecord newest = ringBuffer.getNewestElement();\n+        return (newest == null) ? null : newest.getEventId();\n+    }\n+\n+    public ProvenanceEventRecord getEvent(final String identifier) throws IOException {\n+        final List<ProvenanceEventRecord> records = ringBuffer.getSelectedElements(new RingBuffer.Filter<ProvenanceEventRecord>() {\n+            @Override\n+            public boolean select(final ProvenanceEventRecord event) {\n+                return identifier.equals(event.getFlowFileUuid());\n+            }\n+        }, 1);\n+        return records.isEmpty() ? null : records.get(0);\n+    }\n+\n+    @Override\n+    public ProvenanceEventRecord getEvent(final long id) {\n+        final List<ProvenanceEventRecord> records = ringBuffer.getSelectedElements(new RingBuffer.Filter<ProvenanceEventRecord>() {\n+            @Override\n+            public boolean select(final ProvenanceEventRecord event) {\n+                return event.getEventId() == id;\n+            }\n+        }, 1);\n+\n+        return records.isEmpty() ? null : records.get(0);\n+    }\n+\n+    @Override\n+    public ProvenanceEventRecord getEvent(final long id, final NiFiUser user) {\n+        final ProvenanceEventRecord event = getEvent(id);\n+        if (event == null) {\n+            return null;\n+        }\n+\n+        authorize(event, user);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ1ODU3Ng=="}, "originalCommit": {"oid": "292e776df86c5cb972663035a50eae0fc5b33b15"}, "originalPosition": 156}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1MzMwNzI2OnYy", "diffSide": "RIGHT", "path": "nifi-nar-bundles/nifi-framework-bundle/nifi-stateless-bundle/nifi-stateless-engine/src/main/java/org/apache/nifi/stateless/repository/VolatileProvenanceRepository.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMDoyNzo0NVrOH9s2Iw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMDozNjoxM1rOH9tH_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ1OTkzOQ==", "bodyText": "It might make sense to call this StatelessProvenanceRepository or perhaps RingBufferProvenanceRepository just to avoid confusion with the existing VolatileProvenanceRepository?", "url": "https://github.com/apache/nifi/pull/4700#discussion_r534459939", "createdAt": "2020-12-02T20:27:45Z", "author": {"login": "markap14"}, "path": "nifi-nar-bundles/nifi-framework-bundle/nifi-stateless-bundle/nifi-stateless-engine/src/main/java/org/apache/nifi/stateless/repository/VolatileProvenanceRepository.java", "diffHunk": "@@ -0,0 +1,409 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.nifi.stateless.repository;\n+\n+import org.apache.nifi.authorization.Authorizer;\n+import org.apache.nifi.authorization.user.NiFiUser;\n+import org.apache.nifi.events.EventReporter;\n+import org.apache.nifi.provenance.AsyncLineageSubmission;\n+import org.apache.nifi.provenance.IdentifierLookup;\n+import org.apache.nifi.provenance.ProvenanceAuthorizableFactory;\n+import org.apache.nifi.provenance.ProvenanceEventBuilder;\n+import org.apache.nifi.provenance.ProvenanceEventRecord;\n+import org.apache.nifi.provenance.ProvenanceEventRepository;\n+import org.apache.nifi.provenance.ProvenanceEventType;\n+import org.apache.nifi.provenance.ProvenanceRepository;\n+import org.apache.nifi.provenance.StandardProvenanceEventRecord;\n+import org.apache.nifi.provenance.lineage.ComputeLineageSubmission;\n+import org.apache.nifi.provenance.search.Query;\n+import org.apache.nifi.provenance.search.QuerySubmission;\n+import org.apache.nifi.provenance.search.SearchableField;\n+import org.apache.nifi.util.RingBuffer;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+public class VolatileProvenanceRepository implements ProvenanceRepository {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "292e776df86c5cb972663035a50eae0fc5b33b15"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ2NDUxMA==", "bodyText": "Agree", "url": "https://github.com/apache/nifi/pull/4700#discussion_r534464510", "createdAt": "2020-12-02T20:36:13Z", "author": {"login": "bbende"}, "path": "nifi-nar-bundles/nifi-framework-bundle/nifi-stateless-bundle/nifi-stateless-engine/src/main/java/org/apache/nifi/stateless/repository/VolatileProvenanceRepository.java", "diffHunk": "@@ -0,0 +1,409 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.nifi.stateless.repository;\n+\n+import org.apache.nifi.authorization.Authorizer;\n+import org.apache.nifi.authorization.user.NiFiUser;\n+import org.apache.nifi.events.EventReporter;\n+import org.apache.nifi.provenance.AsyncLineageSubmission;\n+import org.apache.nifi.provenance.IdentifierLookup;\n+import org.apache.nifi.provenance.ProvenanceAuthorizableFactory;\n+import org.apache.nifi.provenance.ProvenanceEventBuilder;\n+import org.apache.nifi.provenance.ProvenanceEventRecord;\n+import org.apache.nifi.provenance.ProvenanceEventRepository;\n+import org.apache.nifi.provenance.ProvenanceEventType;\n+import org.apache.nifi.provenance.ProvenanceRepository;\n+import org.apache.nifi.provenance.StandardProvenanceEventRecord;\n+import org.apache.nifi.provenance.lineage.ComputeLineageSubmission;\n+import org.apache.nifi.provenance.search.Query;\n+import org.apache.nifi.provenance.search.QuerySubmission;\n+import org.apache.nifi.provenance.search.SearchableField;\n+import org.apache.nifi.util.RingBuffer;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+public class VolatileProvenanceRepository implements ProvenanceRepository {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ1OTkzOQ=="}, "originalCommit": {"oid": "292e776df86c5cb972663035a50eae0fc5b33b15"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1MzM1MDY1OnYy", "diffSide": "RIGHT", "path": "nifi-nar-bundles/nifi-framework-bundle/nifi-stateless-bundle/nifi-stateless-engine/src/main/java/org/apache/nifi/stateless/repository/StatelessProvenanceRepository.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMDo0MDoyNlrOH9tQxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMDo0MDoyNlrOH9tQxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ2Njc1OQ==", "bodyText": "Can we change this whole method to simply return getEvent(id); now?", "url": "https://github.com/apache/nifi/pull/4700#discussion_r534466759", "createdAt": "2020-12-02T20:40:26Z", "author": {"login": "markap14"}, "path": "nifi-nar-bundles/nifi-framework-bundle/nifi-stateless-bundle/nifi-stateless-engine/src/main/java/org/apache/nifi/stateless/repository/StatelessProvenanceRepository.java", "diffHunk": "@@ -0,0 +1,380 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.nifi.stateless.repository;\n+\n+import org.apache.nifi.authorization.Authorizer;\n+import org.apache.nifi.authorization.user.NiFiUser;\n+import org.apache.nifi.events.EventReporter;\n+import org.apache.nifi.provenance.AsyncLineageSubmission;\n+import org.apache.nifi.provenance.IdentifierLookup;\n+import org.apache.nifi.provenance.ProvenanceAuthorizableFactory;\n+import org.apache.nifi.provenance.ProvenanceEventBuilder;\n+import org.apache.nifi.provenance.ProvenanceEventRecord;\n+import org.apache.nifi.provenance.ProvenanceEventRepository;\n+import org.apache.nifi.provenance.ProvenanceEventType;\n+import org.apache.nifi.provenance.ProvenanceRepository;\n+import org.apache.nifi.provenance.StandardProvenanceEventRecord;\n+import org.apache.nifi.provenance.lineage.ComputeLineageSubmission;\n+import org.apache.nifi.provenance.search.Query;\n+import org.apache.nifi.provenance.search.QuerySubmission;\n+import org.apache.nifi.provenance.search.SearchableField;\n+import org.apache.nifi.util.RingBuffer;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+public class StatelessProvenanceRepository implements ProvenanceRepository {\n+\n+    public static String CONTAINER_NAME = \"in-memory\";\n+\n+    private final RingBuffer<ProvenanceEventRecord> ringBuffer;\n+    private final int maxSize;\n+\n+    private final AtomicLong idGenerator = new AtomicLong(0L);\n+\n+    public StatelessProvenanceRepository(final int maxEvents) {\n+        maxSize = maxEvents;\n+        ringBuffer = new RingBuffer<>(maxSize);\n+    }\n+\n+    @Override\n+    public void initialize(final EventReporter eventReporter, final Authorizer authorizer, final ProvenanceAuthorizableFactory resourceFactory,\n+                           final IdentifierLookup idLookup) throws IOException {\n+\n+    }\n+\n+    @Override\n+    public ProvenanceEventRepository getProvenanceEventRepository() {\n+        return this;\n+    }\n+\n+    @Override\n+    public ProvenanceEventBuilder eventBuilder() {\n+        return new StandardProvenanceEventRecord.Builder();\n+    }\n+\n+    @Override\n+    public void registerEvent(final ProvenanceEventRecord event) {\n+        final long id = idGenerator.getAndIncrement();\n+        ringBuffer.add(new IdEnrichedProvEvent(event, id));\n+    }\n+\n+    @Override\n+    public void registerEvents(final Iterable<ProvenanceEventRecord> events) {\n+        for (final ProvenanceEventRecord event : events) {\n+            registerEvent(event);\n+        }\n+    }\n+\n+    @Override\n+    public List<ProvenanceEventRecord> getEvents(final long firstRecordId, final int maxRecords) throws IOException {\n+        return getEvents(firstRecordId, maxRecords, null);\n+    }\n+\n+    @Override\n+    public List<ProvenanceEventRecord> getEvents(final long firstRecordId, final int maxRecords, final NiFiUser user) throws IOException {\n+        return ringBuffer.getSelectedElements(new RingBuffer.Filter<ProvenanceEventRecord>() {\n+            @Override\n+            public boolean select(final ProvenanceEventRecord value) {\n+                return value.getEventId() >= firstRecordId;\n+            }\n+        }, maxRecords);\n+    }\n+\n+    @Override\n+    public Long getMaxEventId() {\n+        final ProvenanceEventRecord newest = ringBuffer.getNewestElement();\n+        return (newest == null) ? null : newest.getEventId();\n+    }\n+\n+    public ProvenanceEventRecord getEvent(final String identifier) throws IOException {\n+        final List<ProvenanceEventRecord> records = ringBuffer.getSelectedElements(new RingBuffer.Filter<ProvenanceEventRecord>() {\n+            @Override\n+            public boolean select(final ProvenanceEventRecord event) {\n+                return identifier.equals(event.getFlowFileUuid());\n+            }\n+        }, 1);\n+        return records.isEmpty() ? null : records.get(0);\n+    }\n+\n+    @Override\n+    public ProvenanceEventRecord getEvent(final long id) {\n+        final List<ProvenanceEventRecord> records = ringBuffer.getSelectedElements(new RingBuffer.Filter<ProvenanceEventRecord>() {\n+            @Override\n+            public boolean select(final ProvenanceEventRecord event) {\n+                return event.getEventId() == id;\n+            }\n+        }, 1);\n+\n+        return records.isEmpty() ? null : records.get(0);\n+    }\n+\n+    @Override\n+    public ProvenanceEventRecord getEvent(final long id, final NiFiUser user) {\n+        final ProvenanceEventRecord event = getEvent(id);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4f7168e40d2f9b757bae5d0d18b6f6e41699439"}, "originalPosition": 132}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 207, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}