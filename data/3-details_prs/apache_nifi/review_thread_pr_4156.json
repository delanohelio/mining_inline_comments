{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkyNDAxODI0", "number": 4156, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxNTowMDo0M1rODqan2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxNTowMDo1N1rODuakiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1ODAyOTcwOnYy", "diffSide": "RIGHT", "path": "nifi-nar-bundles/nifi-prometheus-bundle/nifi-prometheus-reporting-task/src/main/java/org/apache/nifi/reporting/prometheus/PrometheusRecordSink.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxNTowMDo0M1rOF6JdDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxNToyMDo0NVrOF6KX3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUxNjYyMA==", "bodyText": "Maybe require HTTPS by default, and require explicit override to allow plaintext listening? Idea being, make it harder to misconfigure NiFi --you would have to explicitly shoot yourself in the foot.", "url": "https://github.com/apache/nifi/pull/4156#discussion_r396516620", "createdAt": "2020-03-23T15:00:43Z", "author": {"login": "achristianson"}, "path": "nifi-nar-bundles/nifi-prometheus-bundle/nifi-prometheus-reporting-task/src/main/java/org/apache/nifi/reporting/prometheus/PrometheusRecordSink.java", "diffHunk": "@@ -62,13 +63,22 @@\n     private volatile Map<String, Gauge> gauges;\n     private static final CollectorRegistry RECORD_REGISTRY = new CollectorRegistry();\n \n+    public static final PropertyDescriptor SSL_CONTEXT = new PropertyDescriptor.Builder()\n+            .name(\"prometheus-reporting-task-ssl-context\")\n+            .displayName(\"SSL Context Service\")\n+            .description(\"The SSL Context Service to use in order to secure the server. If specified, the server will\"\n+                    + \"accept only HTTPS requests; otherwise, the server will accept only HTTP requests\")\n+            .required(false)\n+            .identifiesControllerService(RestrictedSSLContextService.class)\n+            .build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eaf7d51a0e65564ea452017597f92817687b5268"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUyNTk5NQ==", "bodyText": "That's a good point, but this was just moving the existing properties into the existing Prometheus components (since we don't have a dependency on things like RestrictedSSLContextService in the module I added the REST call, I just moved the other common components to a util JAR), changing the default would prevent anyone from running over HTTP. I think that's why these properties default to false everywhere in NiFi, otherwise you must run a secure instance to use the \"securable\" components.", "url": "https://github.com/apache/nifi/pull/4156#discussion_r396525995", "createdAt": "2020-03-23T15:13:15Z", "author": {"login": "mattyb149"}, "path": "nifi-nar-bundles/nifi-prometheus-bundle/nifi-prometheus-reporting-task/src/main/java/org/apache/nifi/reporting/prometheus/PrometheusRecordSink.java", "diffHunk": "@@ -62,13 +63,22 @@\n     private volatile Map<String, Gauge> gauges;\n     private static final CollectorRegistry RECORD_REGISTRY = new CollectorRegistry();\n \n+    public static final PropertyDescriptor SSL_CONTEXT = new PropertyDescriptor.Builder()\n+            .name(\"prometheus-reporting-task-ssl-context\")\n+            .displayName(\"SSL Context Service\")\n+            .description(\"The SSL Context Service to use in order to secure the server. If specified, the server will\"\n+                    + \"accept only HTTPS requests; otherwise, the server will accept only HTTP requests\")\n+            .required(false)\n+            .identifiesControllerService(RestrictedSSLContextService.class)\n+            .build();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUxNjYyMA=="}, "originalCommit": {"oid": "eaf7d51a0e65564ea452017597f92817687b5268"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUzMTY3OA==", "bodyText": "Fair enough... changing all that would be well out of scope for this PR. I think it's something to look into in the future (changing all of NiFi to be secure by default), but not a worry for now.", "url": "https://github.com/apache/nifi/pull/4156#discussion_r396531678", "createdAt": "2020-03-23T15:20:45Z", "author": {"login": "achristianson"}, "path": "nifi-nar-bundles/nifi-prometheus-bundle/nifi-prometheus-reporting-task/src/main/java/org/apache/nifi/reporting/prometheus/PrometheusRecordSink.java", "diffHunk": "@@ -62,13 +63,22 @@\n     private volatile Map<String, Gauge> gauges;\n     private static final CollectorRegistry RECORD_REGISTRY = new CollectorRegistry();\n \n+    public static final PropertyDescriptor SSL_CONTEXT = new PropertyDescriptor.Builder()\n+            .name(\"prometheus-reporting-task-ssl-context\")\n+            .displayName(\"SSL Context Service\")\n+            .description(\"The SSL Context Service to use in order to secure the server. If specified, the server will\"\n+                    + \"accept only HTTPS requests; otherwise, the server will accept only HTTP requests\")\n+            .required(false)\n+            .identifiesControllerService(RestrictedSSLContextService.class)\n+            .build();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUxNjYyMA=="}, "originalCommit": {"oid": "eaf7d51a0e65564ea452017597f92817687b5268"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1ODAzMjkxOnYy", "diffSide": "RIGHT", "path": "nifi-nar-bundles/nifi-prometheus-bundle/nifi-prometheus-reporting-task/src/main/java/org/apache/nifi/reporting/prometheus/PrometheusReportingTask.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxNTowMTozMlrOF6JfRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxNTowMTozMlrOF6JfRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUxNzE4OQ==", "bodyText": "Same default-to-TLS note as above.", "url": "https://github.com/apache/nifi/pull/4156#discussion_r396517189", "createdAt": "2020-03-23T15:01:32Z", "author": {"login": "achristianson"}, "path": "nifi-nar-bundles/nifi-prometheus-bundle/nifi-prometheus-reporting-task/src/main/java/org/apache/nifi/reporting/prometheus/PrometheusReportingTask.java", "diffHunk": "@@ -53,6 +54,15 @@\n \n     private PrometheusServer prometheusServer;\n \n+    public static final PropertyDescriptor SSL_CONTEXT = new PropertyDescriptor.Builder()\n+            .name(\"prometheus-reporting-task-ssl-context\")\n+            .displayName(\"SSL Context Service\")\n+            .description(\"The SSL Context Service to use in order to secure the server. If specified, the server will\"\n+                    + \"accept only HTTPS requests; otherwise, the server will accept only HTTP requests\")\n+            .required(false)\n+            .identifiesControllerService(RestrictedSSLContextService.class)\n+            .build();\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eaf7d51a0e65564ea452017597f92817687b5268"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3MTg2ODk4OnYy", "diffSide": "RIGHT", "path": "nifi-nar-bundles/nifi-framework-bundle/nifi-framework/nifi-web/nifi-web-api/src/main/java/org/apache/nifi/web/NiFiServiceFacade.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNjo0NTozMVrOF8QQVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxNToxNzowMVrOF81xvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODcyNTIwNg==", "bodyText": "minor: feels odd to call this a get when we don't return anything", "url": "https://github.com/apache/nifi/pull/4156#discussion_r398725206", "createdAt": "2020-03-26T16:45:31Z", "author": {"login": "apiri"}, "path": "nifi-nar-bundles/nifi-framework-bundle/nifi-framework/nifi-web/nifi-web-api/src/main/java/org/apache/nifi/web/NiFiServiceFacade.java", "diffHunk": "@@ -313,6 +313,11 @@\n      */\n     FlowConfigurationEntity getFlowConfiguration();\n \n+    /**\n+     * Gets the metrics for the flow.\n+     */\n+    void getFlowMetrics();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eaf7d51a0e65564ea452017597f92817687b5268"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMzOTk2Ng==", "bodyText": "Changed to generateFlowMetrics() (I didn't use create as it appears to be meant for creating components via the facade)", "url": "https://github.com/apache/nifi/pull/4156#discussion_r399339966", "createdAt": "2020-03-27T15:17:01Z", "author": {"login": "mattyb149"}, "path": "nifi-nar-bundles/nifi-framework-bundle/nifi-framework/nifi-web/nifi-web-api/src/main/java/org/apache/nifi/web/NiFiServiceFacade.java", "diffHunk": "@@ -313,6 +313,11 @@\n      */\n     FlowConfigurationEntity getFlowConfiguration();\n \n+    /**\n+     * Gets the metrics for the flow.\n+     */\n+    void getFlowMetrics();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODcyNTIwNg=="}, "originalCommit": {"oid": "eaf7d51a0e65564ea452017597f92817687b5268"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5OTk2NDI0OnYy", "diffSide": "RIGHT", "path": "nifi-nar-bundles/nifi-framework-bundle/nifi-framework/nifi-web/nifi-web-api/src/main/java/org/apache/nifi/web/api/FlowResource.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxNTowMDo1N1rOGAZVww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxNjo1MTowMVrOGAdzNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA2ODM1NQ==", "bodyText": "@mattyb149 this line (along with line 441) isn't needed (it's causing the metrics be be downloaded as a file vs visible in a browser).  Prometheus works fine with it however it may cause an issue for others attempting to simply view metrics", "url": "https://github.com/apache/nifi/pull/4156#discussion_r403068355", "createdAt": "2020-04-03T15:00:57Z", "author": {"login": "YolandaMDavis"}, "path": "nifi-nar-bundles/nifi-framework-bundle/nifi-framework/nifi-web/nifi-web-api/src/main/java/org/apache/nifi/web/api/FlowResource.java", "diffHunk": "@@ -381,6 +388,66 @@ public Response getFlow(\n         return generateOkResponse(entity).build();\n     }\n \n+    /**\n+     * Retrieves the metrics of the entire flow.\n+     *\n+     * @return A flowMetricsEntity.\n+     * @throws InterruptedException if interrupted\n+     */\n+    @GET\n+    @Consumes(MediaType.WILDCARD)\n+    @Produces(MediaType.WILDCARD)\n+    @Path(\"metrics/{producer}\")\n+    @ApiOperation(\n+            value = \"Gets all metrics for the flow from a particular node\",\n+            response = StreamingOutput.class,\n+            authorizations = {\n+                    @Authorization(value = \"Read - /flow\")\n+            }\n+    )\n+    @ApiResponses(\n+            value = {\n+                    @ApiResponse(code = 400, message = \"NiFi was unable to complete the request because it was invalid. The request should not be retried without modification.\"),\n+                    @ApiResponse(code = 401, message = \"Client could not be authenticated.\"),\n+                    @ApiResponse(code = 403, message = \"Client is not authorized to make this request.\"),\n+                    @ApiResponse(code = 404, message = \"The specified resource could not be found.\"),\n+                    @ApiResponse(code = 409, message = \"The request was valid but NiFi was not in the appropriate state to process it. Retrying the same request later may be successful.\")\n+            }\n+    )\n+    public Response getFlowMetrics(\n+            @ApiParam(\n+                    value = \"The producer for flow file metrics. Each producer may have its own output format.\",\n+                    required = true\n+            )\n+            @PathParam(\"producer\") final String producer) throws InterruptedException {\n+\n+        authorizeFlow();\n+\n+        if (\"prometheus\".equalsIgnoreCase(producer)) {\n+            // get this process group flow\n+            serviceFacade.generateFlowMetrics();\n+            // generate a streaming response\n+            final StreamingOutput response = output -> {\n+                Writer writer = new BufferedWriter(new OutputStreamWriter(output));\n+                for (CollectorRegistry collectorRegistry : PrometheusMetricsUtil.ALL_REGISTRIES) {\n+                    TextFormat.write004(writer, collectorRegistry.metricFamilySamples());\n+                    // flush the response\n+                    output.flush();\n+                }\n+                writer.flush();\n+                writer.close();\n+            };\n+\n+            String generatedFilename = \"flowMetrics_\" + System.currentTimeMillis();\n+            return generateOkResponse(response)\n+                    .type(MediaType.TEXT_PLAIN_TYPE)\n+                    .header(\"Content-Disposition\", String.format(\"attachment; filename=\\\"%s\\\"\", generatedFilename))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "449b330c9b8f8ccf9470f1cbc9783868654c9ec9"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzE0MTQzMQ==", "bodyText": "Good point, will change", "url": "https://github.com/apache/nifi/pull/4156#discussion_r403141431", "createdAt": "2020-04-03T16:51:01Z", "author": {"login": "mattyb149"}, "path": "nifi-nar-bundles/nifi-framework-bundle/nifi-framework/nifi-web/nifi-web-api/src/main/java/org/apache/nifi/web/api/FlowResource.java", "diffHunk": "@@ -381,6 +388,66 @@ public Response getFlow(\n         return generateOkResponse(entity).build();\n     }\n \n+    /**\n+     * Retrieves the metrics of the entire flow.\n+     *\n+     * @return A flowMetricsEntity.\n+     * @throws InterruptedException if interrupted\n+     */\n+    @GET\n+    @Consumes(MediaType.WILDCARD)\n+    @Produces(MediaType.WILDCARD)\n+    @Path(\"metrics/{producer}\")\n+    @ApiOperation(\n+            value = \"Gets all metrics for the flow from a particular node\",\n+            response = StreamingOutput.class,\n+            authorizations = {\n+                    @Authorization(value = \"Read - /flow\")\n+            }\n+    )\n+    @ApiResponses(\n+            value = {\n+                    @ApiResponse(code = 400, message = \"NiFi was unable to complete the request because it was invalid. The request should not be retried without modification.\"),\n+                    @ApiResponse(code = 401, message = \"Client could not be authenticated.\"),\n+                    @ApiResponse(code = 403, message = \"Client is not authorized to make this request.\"),\n+                    @ApiResponse(code = 404, message = \"The specified resource could not be found.\"),\n+                    @ApiResponse(code = 409, message = \"The request was valid but NiFi was not in the appropriate state to process it. Retrying the same request later may be successful.\")\n+            }\n+    )\n+    public Response getFlowMetrics(\n+            @ApiParam(\n+                    value = \"The producer for flow file metrics. Each producer may have its own output format.\",\n+                    required = true\n+            )\n+            @PathParam(\"producer\") final String producer) throws InterruptedException {\n+\n+        authorizeFlow();\n+\n+        if (\"prometheus\".equalsIgnoreCase(producer)) {\n+            // get this process group flow\n+            serviceFacade.generateFlowMetrics();\n+            // generate a streaming response\n+            final StreamingOutput response = output -> {\n+                Writer writer = new BufferedWriter(new OutputStreamWriter(output));\n+                for (CollectorRegistry collectorRegistry : PrometheusMetricsUtil.ALL_REGISTRIES) {\n+                    TextFormat.write004(writer, collectorRegistry.metricFamilySamples());\n+                    // flush the response\n+                    output.flush();\n+                }\n+                writer.flush();\n+                writer.close();\n+            };\n+\n+            String generatedFilename = \"flowMetrics_\" + System.currentTimeMillis();\n+            return generateOkResponse(response)\n+                    .type(MediaType.TEXT_PLAIN_TYPE)\n+                    .header(\"Content-Disposition\", String.format(\"attachment; filename=\\\"%s\\\"\", generatedFilename))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA2ODM1NQ=="}, "originalCommit": {"oid": "449b330c9b8f8ccf9470f1cbc9783868654c9ec9"}, "originalPosition": 85}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 186, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}