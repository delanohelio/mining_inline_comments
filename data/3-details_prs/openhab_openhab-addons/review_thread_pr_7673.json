{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE5NTk1MDIw", "number": 7673, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQyMjo0MzozNFrOD9k30w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxOTo1NTozOVrOD-XsZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1ODkzODQzOnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/accessories/HomekitValveImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQyMjo0MzozNFrOGXJ1GQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQyMjo0MzozNFrOGXJ1GQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkzMTQ4MQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            remainingTime = java.lang.Math.toIntExact(future.getDelay(TimeUnit.SECONDS));\n          \n          \n            \n                            remainingTime = Math.toIntExact(future.getDelay(TimeUnit.SECONDS));", "url": "https://github.com/openhab/openhab-addons/pull/7673#discussion_r426931481", "createdAt": "2020-05-18T22:43:34Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/accessories/HomekitValveImpl.java", "diffHunk": "@@ -73,6 +78,73 @@ public HomekitValveImpl(HomekitTaggedItem taggedItem, List<HomekitTaggedItem> ma\n         this.activeReader = new BooleanItemReader(getItem(HomekitCharacteristicType.ACTIVE_STATUS, GenericItem.class),\n                 OnOffType.ON, OpenClosedType.OPEN);\n         getServices().add(new ValveService(this));\n+        final String timerConfig = getAccessoryConfiguration(CONFIG_TIMER, \"\");\n+        homekitTimer = timerConfig.equalsIgnoreCase(\"yes\") || timerConfig.equalsIgnoreCase(\"true\");\n+        if (homekitTimer) {\n+            addRemainingDurationCharacteristic(taggedItem, updater);\n+        }\n+    }\n+\n+    private void addRemainingDurationCharacteristic(HomekitTaggedItem taggedItem, HomekitAccessoryUpdater updater) {\n+        logger.trace(\"addRemainingDurationCharacteristic for {}\", taggedItem);\n+        ((ValveService) getPrimaryService()).addOptionalCharacteristic(new RemainingDurationCharacteristic(() -> {\n+            int remainingTime = 0;\n+            ScheduledFuture<?> future = valveTimer;\n+            if (future != null && !future.isDone()) {\n+                remainingTime = java.lang.Math.toIntExact(future.getDelay(TimeUnit.SECONDS));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aea5a1f87a9e89510ad8144d99c611e51df8818f"}, "originalPosition": 65}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1ODk3OTQ2OnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/accessories/HomekitValveImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQyMzowMTo0NlrOGXKN5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwNzo1NjozNlrOGXUPQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkzNzgzMA==", "bodyText": "Couldn't getSubscriber and getUnsubscriber be used here?", "url": "https://github.com/openhab/openhab-addons/pull/7673#discussion_r426937830", "createdAt": "2020-05-18T23:01:46Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/accessories/HomekitValveImpl.java", "diffHunk": "@@ -73,6 +78,73 @@ public HomekitValveImpl(HomekitTaggedItem taggedItem, List<HomekitTaggedItem> ma\n         this.activeReader = new BooleanItemReader(getItem(HomekitCharacteristicType.ACTIVE_STATUS, GenericItem.class),\n                 OnOffType.ON, OpenClosedType.OPEN);\n         getServices().add(new ValveService(this));\n+        final String timerConfig = getAccessoryConfiguration(CONFIG_TIMER, \"\");\n+        homekitTimer = timerConfig.equalsIgnoreCase(\"yes\") || timerConfig.equalsIgnoreCase(\"true\");\n+        if (homekitTimer) {\n+            addRemainingDurationCharacteristic(taggedItem, updater);\n+        }\n+    }\n+\n+    private void addRemainingDurationCharacteristic(HomekitTaggedItem taggedItem, HomekitAccessoryUpdater updater) {\n+        logger.trace(\"addRemainingDurationCharacteristic for {}\", taggedItem);\n+        ((ValveService) getPrimaryService()).addOptionalCharacteristic(new RemainingDurationCharacteristic(() -> {\n+            int remainingTime = 0;\n+            ScheduledFuture<?> future = valveTimer;\n+            if (future != null && !future.isDone()) {\n+                remainingTime = java.lang.Math.toIntExact(future.getDelay(TimeUnit.SECONDS));\n+            }\n+            return CompletableFuture.completedFuture(remainingTime);\n+        }, (callback) -> updater.subscribe((GenericItem) taggedItem.getItem(), REMAINING_DURATION.getTag(), callback),\n+                () -> updater.unsubscribe((GenericItem) taggedItem.getItem(), REMAINING_DURATION.getTag())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aea5a1f87a9e89510ad8144d99c611e51df8818f"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzEwMjAxOQ==", "bodyText": "good one. missed that one.", "url": "https://github.com/openhab/openhab-addons/pull/7673#discussion_r427102019", "createdAt": "2020-05-19T07:56:36Z", "author": {"login": "yfre"}, "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/accessories/HomekitValveImpl.java", "diffHunk": "@@ -73,6 +78,73 @@ public HomekitValveImpl(HomekitTaggedItem taggedItem, List<HomekitTaggedItem> ma\n         this.activeReader = new BooleanItemReader(getItem(HomekitCharacteristicType.ACTIVE_STATUS, GenericItem.class),\n                 OnOffType.ON, OpenClosedType.OPEN);\n         getServices().add(new ValveService(this));\n+        final String timerConfig = getAccessoryConfiguration(CONFIG_TIMER, \"\");\n+        homekitTimer = timerConfig.equalsIgnoreCase(\"yes\") || timerConfig.equalsIgnoreCase(\"true\");\n+        if (homekitTimer) {\n+            addRemainingDurationCharacteristic(taggedItem, updater);\n+        }\n+    }\n+\n+    private void addRemainingDurationCharacteristic(HomekitTaggedItem taggedItem, HomekitAccessoryUpdater updater) {\n+        logger.trace(\"addRemainingDurationCharacteristic for {}\", taggedItem);\n+        ((ValveService) getPrimaryService()).addOptionalCharacteristic(new RemainingDurationCharacteristic(() -> {\n+            int remainingTime = 0;\n+            ScheduledFuture<?> future = valveTimer;\n+            if (future != null && !future.isDone()) {\n+                remainingTime = java.lang.Math.toIntExact(future.getDelay(TimeUnit.SECONDS));\n+            }\n+            return CompletableFuture.completedFuture(remainingTime);\n+        }, (callback) -> updater.subscribe((GenericItem) taggedItem.getItem(), REMAINING_DURATION.getTag(), callback),\n+                () -> updater.unsubscribe((GenericItem) taggedItem.getItem(), REMAINING_DURATION.getTag())", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkzNzgzMA=="}, "originalCommit": {"oid": "aea5a1f87a9e89510ad8144d99c611e51df8818f"}, "originalPosition": 69}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1ODk5MTU1OnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/accessories/HomekitValveImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQyMzowNzowNFrOGXKVIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwNzo0ODozNFrOGXT87w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkzOTY4MQ==", "bodyText": "Why not have ValveService be passed in as a parameter to the addRemainingDurationCharacteristic function instead of having to lookup and cast it here?", "url": "https://github.com/openhab/openhab-addons/pull/7673#discussion_r426939681", "createdAt": "2020-05-18T23:07:04Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/accessories/HomekitValveImpl.java", "diffHunk": "@@ -73,6 +78,73 @@ public HomekitValveImpl(HomekitTaggedItem taggedItem, List<HomekitTaggedItem> ma\n         this.activeReader = new BooleanItemReader(getItem(HomekitCharacteristicType.ACTIVE_STATUS, GenericItem.class),\n                 OnOffType.ON, OpenClosedType.OPEN);\n         getServices().add(new ValveService(this));\n+        final String timerConfig = getAccessoryConfiguration(CONFIG_TIMER, \"\");\n+        homekitTimer = timerConfig.equalsIgnoreCase(\"yes\") || timerConfig.equalsIgnoreCase(\"true\");\n+        if (homekitTimer) {\n+            addRemainingDurationCharacteristic(taggedItem, updater);\n+        }\n+    }\n+\n+    private void addRemainingDurationCharacteristic(HomekitTaggedItem taggedItem, HomekitAccessoryUpdater updater) {\n+        logger.trace(\"addRemainingDurationCharacteristic for {}\", taggedItem);\n+        ((ValveService) getPrimaryService()).addOptionalCharacteristic(new RemainingDurationCharacteristic(() -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aea5a1f87a9e89510ad8144d99c611e51df8818f"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA5NzMyNw==", "bodyText": "right. good point", "url": "https://github.com/openhab/openhab-addons/pull/7673#discussion_r427097327", "createdAt": "2020-05-19T07:48:34Z", "author": {"login": "yfre"}, "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/accessories/HomekitValveImpl.java", "diffHunk": "@@ -73,6 +78,73 @@ public HomekitValveImpl(HomekitTaggedItem taggedItem, List<HomekitTaggedItem> ma\n         this.activeReader = new BooleanItemReader(getItem(HomekitCharacteristicType.ACTIVE_STATUS, GenericItem.class),\n                 OnOffType.ON, OpenClosedType.OPEN);\n         getServices().add(new ValveService(this));\n+        final String timerConfig = getAccessoryConfiguration(CONFIG_TIMER, \"\");\n+        homekitTimer = timerConfig.equalsIgnoreCase(\"yes\") || timerConfig.equalsIgnoreCase(\"true\");\n+        if (homekitTimer) {\n+            addRemainingDurationCharacteristic(taggedItem, updater);\n+        }\n+    }\n+\n+    private void addRemainingDurationCharacteristic(HomekitTaggedItem taggedItem, HomekitAccessoryUpdater updater) {\n+        logger.trace(\"addRemainingDurationCharacteristic for {}\", taggedItem);\n+        ((ValveService) getPrimaryService()).addOptionalCharacteristic(new RemainingDurationCharacteristic(() -> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkzOTY4MQ=="}, "originalCommit": {"oid": "aea5a1f87a9e89510ad8144d99c611e51df8818f"}, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1OTAwMTkxOnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/accessories/HomekitValveImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQyMzoxMjoyN1rOGXKbTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwODowMjo1OFrOGXUenA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk0MTI2MA==", "bodyText": "This should be equivalent unless you really need the valveTimer to be assigned before the refresh command is sent.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        ScheduledFuture<?> future = valveTimer;\n          \n          \n            \n                        if (future != null && !future.isDone()) {\n          \n          \n            \n                            future.cancel(true);\n          \n          \n            \n                        }\n          \n          \n            \n                        valveTimer = timerService.schedule(() -> {\n          \n          \n            \n                            logger.trace(\"valve timer is over. switching off the valve\");\n          \n          \n            \n                            switchOffValve();\n          \n          \n            \n                            // let home app refresh the remaining duration, which is 0\n          \n          \n            \n                            ((GenericItem) getRootAccessory().getItem()).send(RefreshType.REFRESH);\n          \n          \n            \n                        }, duration, TimeUnit.SECONDS);\n          \n          \n            \n            \n          \n          \n            \n                        // let home app refresh the remaining duration, which is 0\n          \n          \n            \n                        ((GenericItem) getRootAccessory().getItem()).send(RefreshType.REFRESH);\n          \n          \n            \n                        stopTimer();\n          \n          \n            \n                        valveTimer = timerService.schedule(() -> {\n          \n          \n            \n                            logger.trace(\"valve timer is over. switching off the valve\");\n          \n          \n            \n                            switchOffValve();\n          \n          \n            \n                            // let home app refresh the remaining duration, which is 0\n          \n          \n            \n                            ((GenericItem) getRootAccessory().getItem()).send(RefreshType.REFRESH);\n          \n          \n            \n                        }, duration, TimeUnit.SECONDS);", "url": "https://github.com/openhab/openhab-addons/pull/7673#discussion_r426941260", "createdAt": "2020-05-18T23:12:27Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/accessories/HomekitValveImpl.java", "diffHunk": "@@ -73,6 +78,73 @@ public HomekitValveImpl(HomekitTaggedItem taggedItem, List<HomekitTaggedItem> ma\n         this.activeReader = new BooleanItemReader(getItem(HomekitCharacteristicType.ACTIVE_STATUS, GenericItem.class),\n                 OnOffType.ON, OpenClosedType.OPEN);\n         getServices().add(new ValveService(this));\n+        final String timerConfig = getAccessoryConfiguration(CONFIG_TIMER, \"\");\n+        homekitTimer = timerConfig.equalsIgnoreCase(\"yes\") || timerConfig.equalsIgnoreCase(\"true\");\n+        if (homekitTimer) {\n+            addRemainingDurationCharacteristic(taggedItem, updater);\n+        }\n+    }\n+\n+    private void addRemainingDurationCharacteristic(HomekitTaggedItem taggedItem, HomekitAccessoryUpdater updater) {\n+        logger.trace(\"addRemainingDurationCharacteristic for {}\", taggedItem);\n+        ((ValveService) getPrimaryService()).addOptionalCharacteristic(new RemainingDurationCharacteristic(() -> {\n+            int remainingTime = 0;\n+            ScheduledFuture<?> future = valveTimer;\n+            if (future != null && !future.isDone()) {\n+                remainingTime = java.lang.Math.toIntExact(future.getDelay(TimeUnit.SECONDS));\n+            }\n+            return CompletableFuture.completedFuture(remainingTime);\n+        }, (callback) -> updater.subscribe((GenericItem) taggedItem.getItem(), REMAINING_DURATION.getTag(), callback),\n+                () -> updater.unsubscribe((GenericItem) taggedItem.getItem(), REMAINING_DURATION.getTag())\n+\n+        ));\n+    }\n+\n+    /**\n+     * return duration set by home app at corresponding OH items. if ot set, then return the default duration from\n+     * configuration.\n+     * \n+     * @return duraion\n+     */\n+    private int getDuration() {\n+        int duration = 0;\n+        final @Nullable DecimalType durationState = getStateAs(HomekitCharacteristicType.DURATION, DecimalType.class);\n+        if (durationState != null) {\n+            duration = durationState.intValue();\n+        }\n+        return duration;\n+    }\n+\n+    private void startTimer() {\n+        int duration = getDuration();\n+        logger.trace(\"start timer for duration {}\", duration);\n+        if (duration > 0) {\n+            ScheduledFuture<?> future = valveTimer;\n+            if (future != null && !future.isDone()) {\n+                future.cancel(true);\n+            }\n+            valveTimer = timerService.schedule(() -> {\n+                logger.trace(\"valve timer is over. switching off the valve\");\n+                switchOffValve();\n+                // let home app refresh the remaining duration, which is 0\n+                ((GenericItem) getRootAccessory().getItem()).send(RefreshType.REFRESH);\n+            }, duration, TimeUnit.SECONDS);\n+\n+            // let home app refresh the remaining duration, which is 0\n+            ((GenericItem) getRootAccessory().getItem()).send(RefreshType.REFRESH);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aea5a1f87a9e89510ad8144d99c611e51df8818f"}, "originalPosition": 105}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzEwNTk0OA==", "bodyText": "good one.\ni will also move REFRESH to the caller method so that we have it once, after the timer is set or stopped.", "url": "https://github.com/openhab/openhab-addons/pull/7673#discussion_r427105948", "createdAt": "2020-05-19T08:02:58Z", "author": {"login": "yfre"}, "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/accessories/HomekitValveImpl.java", "diffHunk": "@@ -73,6 +78,73 @@ public HomekitValveImpl(HomekitTaggedItem taggedItem, List<HomekitTaggedItem> ma\n         this.activeReader = new BooleanItemReader(getItem(HomekitCharacteristicType.ACTIVE_STATUS, GenericItem.class),\n                 OnOffType.ON, OpenClosedType.OPEN);\n         getServices().add(new ValveService(this));\n+        final String timerConfig = getAccessoryConfiguration(CONFIG_TIMER, \"\");\n+        homekitTimer = timerConfig.equalsIgnoreCase(\"yes\") || timerConfig.equalsIgnoreCase(\"true\");\n+        if (homekitTimer) {\n+            addRemainingDurationCharacteristic(taggedItem, updater);\n+        }\n+    }\n+\n+    private void addRemainingDurationCharacteristic(HomekitTaggedItem taggedItem, HomekitAccessoryUpdater updater) {\n+        logger.trace(\"addRemainingDurationCharacteristic for {}\", taggedItem);\n+        ((ValveService) getPrimaryService()).addOptionalCharacteristic(new RemainingDurationCharacteristic(() -> {\n+            int remainingTime = 0;\n+            ScheduledFuture<?> future = valveTimer;\n+            if (future != null && !future.isDone()) {\n+                remainingTime = java.lang.Math.toIntExact(future.getDelay(TimeUnit.SECONDS));\n+            }\n+            return CompletableFuture.completedFuture(remainingTime);\n+        }, (callback) -> updater.subscribe((GenericItem) taggedItem.getItem(), REMAINING_DURATION.getTag(), callback),\n+                () -> updater.unsubscribe((GenericItem) taggedItem.getItem(), REMAINING_DURATION.getTag())\n+\n+        ));\n+    }\n+\n+    /**\n+     * return duration set by home app at corresponding OH items. if ot set, then return the default duration from\n+     * configuration.\n+     * \n+     * @return duraion\n+     */\n+    private int getDuration() {\n+        int duration = 0;\n+        final @Nullable DecimalType durationState = getStateAs(HomekitCharacteristicType.DURATION, DecimalType.class);\n+        if (durationState != null) {\n+            duration = durationState.intValue();\n+        }\n+        return duration;\n+    }\n+\n+    private void startTimer() {\n+        int duration = getDuration();\n+        logger.trace(\"start timer for duration {}\", duration);\n+        if (duration > 0) {\n+            ScheduledFuture<?> future = valveTimer;\n+            if (future != null && !future.isDone()) {\n+                future.cancel(true);\n+            }\n+            valveTimer = timerService.schedule(() -> {\n+                logger.trace(\"valve timer is over. switching off the valve\");\n+                switchOffValve();\n+                // let home app refresh the remaining duration, which is 0\n+                ((GenericItem) getRootAccessory().getItem()).send(RefreshType.REFRESH);\n+            }, duration, TimeUnit.SECONDS);\n+\n+            // let home app refresh the remaining duration, which is 0\n+            ((GenericItem) getRootAccessory().getItem()).send(RefreshType.REFRESH);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk0MTI2MA=="}, "originalCommit": {"oid": "aea5a1f87a9e89510ad8144d99c611e51df8818f"}, "originalPosition": 105}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1OTAyNDQzOnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/accessories/HomekitCharacteristicFactory.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQyMzoyMzozNlrOGXKong==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwNzo1Mzo0MFrOGXUInQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk0NDY3MA==", "bodyText": "I don't like that all this code is duplicated from getIntSupplier. Can you refactor it?", "url": "https://github.com/openhab/openhab-addons/pull/7673#discussion_r426944670", "createdAt": "2020-05-18T23:23:36Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/accessories/HomekitCharacteristicFactory.java", "diffHunk": "@@ -195,315 +200,330 @@ private static void setValueFromEnum(GenericItem item, CharacteristicEnum value,\n                         \"Item state {} is not supported for {}. Only PercentType and DecimalType (0/100) are supported.\",\n                         state, item.getName());\n             }\n-            logger.trace(\" Get Int for {} value {}\", item.getLabel(), value);\n+            logger.trace(\" Get Int for {} value {}\", item.getName(), value);\n             return CompletableFuture.completedFuture(value);\n         };\n     }\n \n-    private static ExceptionalConsumer<Integer> setIntConsumer(final GenericItem item) {\n+    private static ExceptionalConsumer<Integer> setIntConsumer(final HomekitTaggedItem item) {\n         return (value) -> {\n-            if (item instanceof NumberItem) {\n-                ((NumberItem) item).send(new DecimalType(value));\n+            if (item.getItem() instanceof NumberItem) {\n+                ((NumberItem) item.getItem()).send(new DecimalType(value));\n             } else {\n-                logger.warn(\"Item type {} is not supported for {}. Only Number type is supported.\", item.getType(),\n-                        item.getName());\n+                logger.warn(\"Item type {} is not supported for {}. Only Number type is supported.\",\n+                        item.getItem().getType(), item.getName());\n             }\n         };\n     }\n \n-    private static Supplier<CompletableFuture<Double>> getDoubleSupplier(Item item) {\n+    private static Supplier<CompletableFuture<Double>> getDoubleSupplier(final HomekitTaggedItem item) {\n         return () -> {\n-            final DecimalType value = item.getStateAs(DecimalType.class);\n+            final DecimalType value = item.getItem().getStateAs(DecimalType.class);\n             return CompletableFuture.completedFuture(value != null ? value.doubleValue() : 0.0);\n         };\n     }\n \n+    private static Consumer<HomekitCharacteristicChangeCallback> getSubscriber(final HomekitTaggedItem item,\n+            final HomekitCharacteristicType key, final HomekitAccessoryUpdater updater) {\n+        return (callback) -> updater.subscribe((GenericItem) item.getItem(), key.getTag(), callback);\n+    }\n+\n+    private static Runnable getUnsubscriber(final HomekitTaggedItem item, final HomekitCharacteristicType key,\n+            final HomekitAccessoryUpdater updater) {\n+        return () -> updater.unsubscribe((GenericItem) item.getItem(), key.getTag());\n+    }\n+\n     // create method for characteristic\n-    private static StatusLowBatteryCharacteristic createStatusLowBatteryCharacteristic(final GenericItem item,\n-            HomekitAccessoryUpdater updater) {\n+    private static StatusLowBatteryCharacteristic createStatusLowBatteryCharacteristic(final HomekitTaggedItem item,\n+            final HomekitAccessoryUpdater updater) {\n         return new StatusLowBatteryCharacteristic(\n                 () -> getEnumFromItem(item, StatusLowBatteryEnum.NORMAL, StatusLowBatteryEnum.LOW,\n                         StatusLowBatteryEnum.NORMAL),\n-                (callback) -> updater.subscribe(item, BATTERY_LOW_STATUS.getTag(), callback),\n-                () -> updater.unsubscribe(item, BATTERY_LOW_STATUS.getTag()));\n+                getSubscriber(item, BATTERY_LOW_STATUS, updater), getUnsubscriber(item, BATTERY_LOW_STATUS, updater));\n     }\n \n-    private static StatusFaultCharacteristic createStatusFaultCharacteristic(final GenericItem item,\n-            HomekitAccessoryUpdater updater) {\n+    private static StatusFaultCharacteristic createStatusFaultCharacteristic(final HomekitTaggedItem item,\n+            final HomekitAccessoryUpdater updater) {\n         return new StatusFaultCharacteristic(\n                 () -> getEnumFromItem(item, StatusFaultEnum.NO_FAULT, StatusFaultEnum.GENERAL_FAULT,\n                         StatusFaultEnum.NO_FAULT),\n-                (callback) -> updater.subscribe(item, FAULT_STATUS.getTag(), callback),\n-                () -> updater.unsubscribe(item, FAULT_STATUS.getTag()));\n+                getSubscriber(item, FAULT_STATUS, updater), getUnsubscriber(item, FAULT_STATUS, updater));\n     }\n \n-    private static StatusTamperedCharacteristic createStatusTamperedCharacteristic(final GenericItem item,\n-            HomekitAccessoryUpdater updater) {\n+    private static StatusTamperedCharacteristic createStatusTamperedCharacteristic(final HomekitTaggedItem item,\n+            final HomekitAccessoryUpdater updater) {\n         return new StatusTamperedCharacteristic(\n                 () -> getEnumFromItem(item, StatusTamperedEnum.NOT_TAMPERED, StatusTamperedEnum.TAMPERED,\n                         StatusTamperedEnum.NOT_TAMPERED),\n-                (callback) -> updater.subscribe(item, TAMPERED_STATUS.getTag(), callback),\n-                () -> updater.unsubscribe(item, TAMPERED_STATUS.getTag()));\n+                getSubscriber(item, TAMPERED_STATUS, updater), getUnsubscriber(item, TAMPERED_STATUS, updater));\n     }\n \n-    private static ObstructionDetectedCharacteristic createObstructionDetectedCharacteristic(final GenericItem item,\n-            HomekitAccessoryUpdater updater) {\n+    private static ObstructionDetectedCharacteristic createObstructionDetectedCharacteristic(\n+            final HomekitTaggedItem item, HomekitAccessoryUpdater updater) {\n         return new ObstructionDetectedCharacteristic(\n-                () -> CompletableFuture\n-                        .completedFuture(item.getState() == OnOffType.ON || item.getState() == OpenClosedType.OPEN),\n-                (callback) -> updater.subscribe(item, OBSTRUCTION_STATUS.getTag(), callback),\n-                () -> updater.unsubscribe(item, OBSTRUCTION_STATUS.getTag()));\n+                () -> CompletableFuture.completedFuture(\n+                        item.getItem().getState() == OnOffType.ON || item.getItem().getState() == OpenClosedType.OPEN),\n+                getSubscriber(item, OBSTRUCTION_STATUS, updater), getUnsubscriber(item, OBSTRUCTION_STATUS, updater));\n     }\n \n-    private static StatusActiveCharacteristic createStatusActiveCharacteristic(final GenericItem item,\n+    private static StatusActiveCharacteristic createStatusActiveCharacteristic(final HomekitTaggedItem item,\n             HomekitAccessoryUpdater updater) {\n         return new StatusActiveCharacteristic(\n-                () -> CompletableFuture\n-                        .completedFuture(item.getState() == OnOffType.ON || item.getState() == OpenClosedType.OPEN),\n-                (callback) -> updater.subscribe(item, ACTIVE_STATUS.getTag(), callback),\n-                () -> updater.unsubscribe(item, ACTIVE_STATUS.getTag()));\n+                () -> CompletableFuture.completedFuture(\n+                        item.getItem().getState() == OnOffType.ON || item.getItem().getState() == OpenClosedType.OPEN),\n+                getSubscriber(item, ACTIVE_STATUS, updater), getUnsubscriber(item, ACTIVE_STATUS, updater));\n     }\n \n-    private static NameCharacteristic createNameCharacteristic(final GenericItem item,\n+    private static NameCharacteristic createNameCharacteristic(final HomekitTaggedItem item,\n             HomekitAccessoryUpdater updater) {\n         return new NameCharacteristic(() -> {\n-            final State state = item.getState();\n+            final State state = item.getItem().getState();\n             return CompletableFuture.completedFuture(state instanceof UnDefType ? \"\" : state.toString());\n         });\n     }\n \n-    private static HoldPositionCharacteristic createHoldPositionCharacteristic(final GenericItem item,\n+    private static HoldPositionCharacteristic createHoldPositionCharacteristic(final HomekitTaggedItem item,\n             HomekitAccessoryUpdater updater) {\n         return new HoldPositionCharacteristic(OnOffType::from);\n     }\n \n-    private static CarbonMonoxideLevelCharacteristic createCarbonMonoxideLevelCharacteristic(final GenericItem item,\n-            HomekitAccessoryUpdater updater) {\n+    private static CarbonMonoxideLevelCharacteristic createCarbonMonoxideLevelCharacteristic(\n+            final HomekitTaggedItem item, HomekitAccessoryUpdater updater) {\n         return new CarbonMonoxideLevelCharacteristic(getDoubleSupplier(item),\n-                (callback) -> updater.subscribe(item, CARBON_DIOXIDE_LEVEL.getTag(), callback),\n-                () -> updater.unsubscribe(item, CARBON_DIOXIDE_LEVEL.getTag()));\n+                getSubscriber(item, CARBON_DIOXIDE_LEVEL, updater),\n+                getUnsubscriber(item, CARBON_DIOXIDE_LEVEL, updater));\n     }\n \n     private static CarbonMonoxidePeakLevelCharacteristic createCarbonMonoxidePeakLevelCharacteristic(\n-            final GenericItem item, HomekitAccessoryUpdater updater) {\n+            final HomekitTaggedItem item, HomekitAccessoryUpdater updater) {\n         return new CarbonMonoxidePeakLevelCharacteristic(getDoubleSupplier(item),\n-                (callback) -> updater.subscribe(item, CARBON_DIOXIDE_PEAK_LEVEL.getTag(), callback),\n-                () -> updater.unsubscribe(item, CARBON_DIOXIDE_PEAK_LEVEL.getTag()));\n+                getSubscriber(item, CARBON_DIOXIDE_PEAK_LEVEL, updater),\n+                getUnsubscriber(item, CARBON_DIOXIDE_PEAK_LEVEL, updater));\n     }\n \n-    private static CarbonDioxideLevelCharacteristic createCarbonDioxideLevelCharacteristic(final GenericItem item,\n+    private static CarbonDioxideLevelCharacteristic createCarbonDioxideLevelCharacteristic(final HomekitTaggedItem item,\n             HomekitAccessoryUpdater updater) {\n         return new CarbonDioxideLevelCharacteristic(getDoubleSupplier(item),\n-                (callback) -> updater.subscribe(item, CARBON_MONOXIDE_LEVEL.getTag(), callback),\n-                () -> updater.unsubscribe(item, CARBON_MONOXIDE_LEVEL.getTag()));\n+                getSubscriber(item, CARBON_MONOXIDE_LEVEL, updater),\n+                getUnsubscriber(item, CARBON_MONOXIDE_LEVEL, updater));\n     }\n \n     private static CarbonDioxidePeakLevelCharacteristic createCarbonDioxidePeakLevelCharacteristic(\n-            final GenericItem item, HomekitAccessoryUpdater updater) {\n+            final HomekitTaggedItem item, HomekitAccessoryUpdater updater) {\n         return new CarbonDioxidePeakLevelCharacteristic(getDoubleSupplier(item),\n-                (callback) -> updater.subscribe(item, CARBON_MONOXIDE_PEAK_LEVEL.getTag(), callback),\n-                () -> updater.unsubscribe(item, CARBON_MONOXIDE_PEAK_LEVEL.getTag()));\n+                getSubscriber(item, CARBON_MONOXIDE_PEAK_LEVEL, updater),\n+                getUnsubscriber(item, CARBON_MONOXIDE_PEAK_LEVEL, updater));\n     }\n \n     private static CurrentHorizontalTiltAngleCharacteristic createCurrentHorizontalTiltAngleCharacteristic(\n-            final GenericItem item, HomekitAccessoryUpdater updater) {\n+            final HomekitTaggedItem item, HomekitAccessoryUpdater updater) {\n         return new CurrentHorizontalTiltAngleCharacteristic(getIntSupplier(item),\n-                (callback) -> updater.subscribe(item, CURRENT_HORIZONTAL_TILT_ANGLE.getTag(), callback),\n-                () -> updater.unsubscribe(item, CURRENT_HORIZONTAL_TILT_ANGLE.getTag()));\n+                getSubscriber(item, CURRENT_HORIZONTAL_TILT_ANGLE, updater),\n+                getUnsubscriber(item, CURRENT_HORIZONTAL_TILT_ANGLE, updater));\n     }\n \n     private static CurrentVerticalTiltAngleCharacteristic createCurrentVerticalTiltAngleCharacteristic(\n-            final GenericItem item, HomekitAccessoryUpdater updater) {\n+            final HomekitTaggedItem item, HomekitAccessoryUpdater updater) {\n         return new CurrentVerticalTiltAngleCharacteristic(getIntSupplier(item),\n-                (callback) -> updater.subscribe(item, CURRENT_VERTICAL_TILT_ANGLE.getTag(), callback),\n-                () -> updater.unsubscribe(item, CURRENT_VERTICAL_TILT_ANGLE.getTag()));\n+                getSubscriber(item, CURRENT_VERTICAL_TILT_ANGLE, updater),\n+                getUnsubscriber(item, CURRENT_VERTICAL_TILT_ANGLE, updater));\n     }\n \n     private static TargetHorizontalTiltAngleCharacteristic createTargetHorizontalTiltAngleCharacteristic(\n-            final GenericItem item, HomekitAccessoryUpdater updater) {\n+            final HomekitTaggedItem item, HomekitAccessoryUpdater updater) {\n         return new TargetHorizontalTiltAngleCharacteristic(getIntSupplier(item), setIntConsumer(item),\n-                (callback) -> updater.subscribe(item, TARGET_HORIZONTAL_TILT_ANGLE.getTag(), callback),\n-                () -> updater.unsubscribe(item, TARGET_HORIZONTAL_TILT_ANGLE.getTag()));\n+                getSubscriber(item, TARGET_HORIZONTAL_TILT_ANGLE, updater),\n+                getUnsubscriber(item, TARGET_HORIZONTAL_TILT_ANGLE, updater));\n     }\n \n     private static TargetVerticalTiltAngleCharacteristic createTargetVerticalTiltAngleCharacteristic(\n-            final GenericItem item, HomekitAccessoryUpdater updater) {\n+            final HomekitTaggedItem item, HomekitAccessoryUpdater updater) {\n         return new TargetVerticalTiltAngleCharacteristic(getIntSupplier(item), setIntConsumer(item),\n-                (callback) -> updater.subscribe(item, TARGET_VERTICAL_TILT_ANGLE.getTag(), callback),\n-                () -> updater.unsubscribe(item, TARGET_VERTICAL_TILT_ANGLE.getTag()));\n+                getSubscriber(item, TARGET_HORIZONTAL_TILT_ANGLE, updater),\n+                getUnsubscriber(item, TARGET_HORIZONTAL_TILT_ANGLE, updater));\n     }\n \n-    private static HueCharacteristic createHueCharacteristic(final GenericItem item, HomekitAccessoryUpdater updater) {\n+    private static HueCharacteristic createHueCharacteristic(final HomekitTaggedItem item,\n+            HomekitAccessoryUpdater updater) {\n         return new HueCharacteristic(() -> {\n             Double value = 0.0;\n-            State state = item.getState();\n+            State state = item.getItem().getState();\n             if (state instanceof HSBType) {\n                 value = ((HSBType) state).getHue().doubleValue();\n             }\n             return CompletableFuture.completedFuture(value);\n         }, (hue) -> {\n-            State state = item.getState();\n-            if (item instanceof ColorItem) {\n-                ((ColorItem) item).send(new HSBType(new DecimalType(hue), ((HSBType) state).getSaturation(),\n+            State state = item.getItem().getState();\n+            if (item.getItem() instanceof ColorItem) {\n+                ((ColorItem) item.getItem()).send(new HSBType(new DecimalType(hue), ((HSBType) state).getSaturation(),\n                         ((HSBType) state).getBrightness()));\n             } else {\n-                logger.warn(\"Item type {} is not supported for {}. Only Color type is supported.\", item.getType(),\n-                        item.getName());\n+                logger.warn(\"Item type {} is not supported for {}. Only Color type is supported.\",\n+                        item.getItem().getType(), item.getName());\n             }\n-        }, (callback) -> updater.subscribe(item, HUE.getTag(), callback),\n-                () -> updater.unsubscribe(item, HUE.getTag()));\n+        }, getSubscriber(item, HUE, updater), getUnsubscriber(item, HUE, updater));\n     }\n \n-    private static BrightnessCharacteristic createBrightnessCharacteristic(final GenericItem item,\n+    private static BrightnessCharacteristic createBrightnessCharacteristic(final HomekitTaggedItem item,\n             HomekitAccessoryUpdater updater) {\n         return new BrightnessCharacteristic(() -> {\n             int value = 0;\n-            final State state = item.getState();\n+            final State state = item.getItem().getState();\n             if (state instanceof HSBType) {\n                 value = ((HSBType) state).getBrightness().intValue();\n             } else if (state instanceof PercentType) {\n                 value = ((PercentType) state).intValue();\n             }\n             return CompletableFuture.completedFuture(value);\n         }, (brightness) -> {\n-            final State state = item.getState();\n-            if (item instanceof ColorItem) {\n-                ((ColorItem) item).send(new HSBType(((HSBType) state).getHue(), ((HSBType) state).getSaturation(),\n+            final Item oItem = item.getItem();\n+            final State state = oItem.getState();\n+            if (oItem instanceof ColorItem) {\n+                ((ColorItem) oItem).send(new HSBType(((HSBType) state).getHue(), ((HSBType) state).getSaturation(),\n                         new PercentType(brightness)));\n-            } else if (item instanceof DimmerItem) {\n-                ((DimmerItem) item).send(new PercentType(brightness));\n+            } else if (oItem instanceof DimmerItem) {\n+                ((DimmerItem) oItem).send(new PercentType(brightness));\n             } else {\n-                logger.warn(\"Item type {} is not supported for {}. Only ColorItem and DimmerIterm are supported.\",\n-                        item.getType(), item.getName());\n+                logger.warn(\"Item type {} is not supported for {}. Only Color type is supported.\", oItem.getType(),\n+                        item.getName());\n             }\n-        }, (callback) -> updater.subscribe(item, BRIGHTNESS.getTag(), callback),\n-                () -> updater.unsubscribe(item, BRIGHTNESS.getTag()));\n+        }, getSubscriber(item, BRIGHTNESS, updater), getUnsubscriber(item, BRIGHTNESS, updater));\n     }\n \n-    private static SaturationCharacteristic createSaturationCharacteristic(final GenericItem item,\n+    private static SaturationCharacteristic createSaturationCharacteristic(final HomekitTaggedItem item,\n             HomekitAccessoryUpdater updater) {\n         return new SaturationCharacteristic(() -> {\n             Double value = 0.0;\n-            State state = item.getState();\n+            State state = item.getItem().getState();\n             if (state instanceof HSBType) {\n                 value = ((HSBType) state).getSaturation().doubleValue();\n             } else if (state instanceof PercentType) {\n                 value = ((PercentType) state).doubleValue();\n             }\n             return CompletableFuture.completedFuture(value);\n         }, (saturation) -> {\n-            final State state = item.getState();\n-            if (item instanceof ColorItem) {\n-                ((ColorItem) item).send(new HSBType(((HSBType) state).getHue(), new PercentType(saturation.intValue()),\n-                        ((HSBType) state).getBrightness()));\n+            final State state = item.getItem().getState();\n+            if (item.getItem() instanceof ColorItem) {\n+                ((ColorItem) item.getItem()).send(new HSBType(((HSBType) state).getHue(),\n+                        new PercentType(saturation.intValue()), ((HSBType) state).getBrightness()));\n             } else {\n-                logger.warn(\"Item type {} is not supported for {}. Only Color type is supported.\", item.getType(),\n-                        item.getName());\n+                logger.warn(\"Item type {} is not supported for {}. Only Color type is supported.\",\n+                        item.getItem().getType(), item.getName());\n             }\n-        }, (callback) -> updater.subscribe(item, SATURATION.getTag(), callback),\n-                () -> updater.unsubscribe(item, SATURATION.getTag()));\n+        }, getSubscriber(item, SATURATION, updater), getUnsubscriber(item, SATURATION, updater));\n     }\n \n-    private static ColorTemperatureCharacteristic createColorTemperatureCharacteristic(final GenericItem item,\n+    private static ColorTemperatureCharacteristic createColorTemperatureCharacteristic(final HomekitTaggedItem item,\n             HomekitAccessoryUpdater updater) {\n         return new ColorTemperatureCharacteristic(getIntSupplier(item), setIntConsumer(item),\n-                (callback) -> updater.subscribe(item, COLOR_TEMPERATURE.getTag(), callback),\n-                () -> updater.unsubscribe(item, COLOR_TEMPERATURE.getTag()));\n+                getSubscriber(item, COLOR_TEMPERATURE, updater), getUnsubscriber(item, COLOR_TEMPERATURE, updater));\n     }\n \n-    private static CurrentFanStateCharacteristic createCurrentFanStateCharacteristic(final GenericItem item,\n+    private static CurrentFanStateCharacteristic createCurrentFanStateCharacteristic(final HomekitTaggedItem item,\n             HomekitAccessoryUpdater updater) {\n         return new CurrentFanStateCharacteristic(() -> {\n-            final DecimalType value = item.getStateAs(DecimalType.class);\n+            final DecimalType value = item.getItem().getStateAs(DecimalType.class);\n             CurrentFanStateEnum currentFanStateEnum = value != null ? CurrentFanStateEnum.fromCode(value.intValue())\n                     : null;\n             if (currentFanStateEnum == null) {\n                 currentFanStateEnum = CurrentFanStateEnum.INACTIVE;\n             }\n             return CompletableFuture.completedFuture(currentFanStateEnum);\n-        }, (callback) -> updater.subscribe(item, CURRENT_FAN_STATE.getTag(), callback),\n-                () -> updater.unsubscribe(item, CURRENT_FAN_STATE.getTag()));\n+        }, getSubscriber(item, CURRENT_FAN_STATE, updater), getUnsubscriber(item, CURRENT_FAN_STATE, updater));\n     }\n \n-    private static TargetFanStateCharacteristic createTargetFanStateCharacteristic(final GenericItem item,\n+    private static TargetFanStateCharacteristic createTargetFanStateCharacteristic(final HomekitTaggedItem item,\n             HomekitAccessoryUpdater updater) {\n         return new TargetFanStateCharacteristic(() -> {\n-            final DecimalType value = item.getStateAs(DecimalType.class);\n+            final DecimalType value = item.getItem().getStateAs(DecimalType.class);\n             TargetFanStateEnum targetFanStateEnum = value != null ? TargetFanStateEnum.fromCode(value.intValue())\n                     : null;\n             if (targetFanStateEnum == null) {\n                 targetFanStateEnum = TargetFanStateEnum.AUTO;\n             }\n             return CompletableFuture.completedFuture(targetFanStateEnum);\n         }, (targetState) -> {\n-            if (item instanceof NumberItem) {\n-                ((NumberItem) item).send(new DecimalType(targetState.getCode()));\n+            if (item.getItem() instanceof NumberItem) {\n+                ((NumberItem) item.getItem()).send(new DecimalType(targetState.getCode()));\n             } else {\n-                logger.warn(\"Item type {} is not supported for {}. Only Number type is supported.\", item.getType(),\n-                        item.getName());\n+                logger.warn(\"Item type {} is not supported for {}. Only Number type is supported.\",\n+                        item.getItem().getType(), item.getName());\n             }\n-        }, (callback) -> updater.subscribe(item, TARGET_FAN_STATE.getTag(), callback),\n-                () -> updater.unsubscribe(item, TARGET_FAN_STATE.getTag()));\n+        }, getSubscriber(item, TARGET_FAN_STATE, updater), getUnsubscriber(item, TARGET_FAN_STATE, updater));\n     }\n \n-    private static RotationDirectionCharacteristic createRotationDirectionCharacteristic(final GenericItem item,\n+    private static RotationDirectionCharacteristic createRotationDirectionCharacteristic(final HomekitTaggedItem item,\n             HomekitAccessoryUpdater updater) {\n         return new RotationDirectionCharacteristic(\n                 () -> getEnumFromItem(item, RotationDirectionEnum.CLOCKWISE, RotationDirectionEnum.COUNTER_CLOCKWISE,\n                         RotationDirectionEnum.CLOCKWISE),\n                 (value) -> setValueFromEnum(item, value, RotationDirectionEnum.CLOCKWISE,\n                         RotationDirectionEnum.COUNTER_CLOCKWISE),\n-                (callback) -> updater.subscribe(item, ROTATION_DIRECTION.getTag(), callback),\n-                () -> updater.unsubscribe(item, ROTATION_DIRECTION.getTag()));\n+                getSubscriber(item, ROTATION_DIRECTION, updater), getUnsubscriber(item, ROTATION_DIRECTION, updater));\n     }\n \n-    private static SwingModeCharacteristic createSwingModeCharacteristic(final GenericItem item,\n+    private static SwingModeCharacteristic createSwingModeCharacteristic(final HomekitTaggedItem item,\n             HomekitAccessoryUpdater updater) {\n         return new SwingModeCharacteristic(\n                 () -> getEnumFromItem(item, SwingModeEnum.SWING_DISABLED, SwingModeEnum.SWING_ENABLED,\n                         SwingModeEnum.SWING_DISABLED),\n                 (value) -> setValueFromEnum(item, value, SwingModeEnum.SWING_DISABLED, SwingModeEnum.SWING_ENABLED),\n-                (callback) -> updater.subscribe(item, SWING_MODE.getTag(), callback),\n-                () -> updater.unsubscribe(item, SWING_MODE.getTag()));\n+                getSubscriber(item, SWING_MODE, updater), getUnsubscriber(item, SWING_MODE, updater));\n     }\n \n-    private static LockPhysicalControlsCharacteristic createLockPhysicalControlsCharacteristic(final GenericItem item,\n-            HomekitAccessoryUpdater updater) {\n+    private static LockPhysicalControlsCharacteristic createLockPhysicalControlsCharacteristic(\n+            final HomekitTaggedItem item, HomekitAccessoryUpdater updater) {\n         return new LockPhysicalControlsCharacteristic(\n                 () -> getEnumFromItem(item, LockPhysicalControlsEnum.CONTROL_LOCK_DISABLED,\n                         LockPhysicalControlsEnum.CONTROL_LOCK_ENABLED, LockPhysicalControlsEnum.CONTROL_LOCK_DISABLED),\n                 (value) -> setValueFromEnum(item, value, LockPhysicalControlsEnum.CONTROL_LOCK_DISABLED,\n                         LockPhysicalControlsEnum.CONTROL_LOCK_ENABLED),\n-                (callback) -> updater.subscribe(item, LOCK_CONTROL.getTag(), callback),\n-                () -> updater.unsubscribe(item, LOCK_CONTROL.getTag()));\n+                getSubscriber(item, LOCK_CONTROL, updater), getUnsubscriber(item, LOCK_CONTROL, updater));\n     }\n \n-    private static RotationSpeedCharacteristic createRotationSpeedCharacteristic(final GenericItem item,\n+    private static RotationSpeedCharacteristic createRotationSpeedCharacteristic(final HomekitTaggedItem item,\n             HomekitAccessoryUpdater updater) {\n         return new RotationSpeedCharacteristic(getIntSupplier(item), setIntConsumer(item),\n-                (callback) -> updater.subscribe(item, ROTATION_SPEED.getTag(), callback),\n-                () -> updater.unsubscribe(item, ROTATION_SPEED.getTag()));\n+                getSubscriber(item, ROTATION_SPEED, updater), getUnsubscriber(item, ROTATION_SPEED, updater));\n     }\n \n-    private static SetDurationCharacteristic createDurationCharacteristic(final GenericItem item,\n+    private static SetDurationCharacteristic createDurationCharacteristic(final HomekitTaggedItem item,\n             HomekitAccessoryUpdater updater) {\n-        return new SetDurationCharacteristic(getIntSupplier(item), setIntConsumer(item),\n-                (callback) -> updater.subscribe(item, DURATION.getTag(), callback),\n-                () -> updater.unsubscribe(item, DURATION.getTag()));\n+        return new SetDurationCharacteristic(() -> {\n+            int value = 0;\n+            final State state = item.getItem().getState();\n+            if (state instanceof PercentType) {\n+                value = state.as(PercentType.class).intValue();\n+            } else if (state instanceof DecimalType) {\n+                value = state.as(DecimalType.class).intValue();\n+            } else if (state instanceof UnDefType) {\n+                logger.debug(\"Item state {} is UNDEF {}.\", state, item.getName());\n+            } else {\n+                logger.warn(\n+                        \"Item state {} is not supported for {}. Only PercentType and DecimalType (0/100) are supported.\",\n+                        state, item.getName());\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aea5a1f87a9e89510ad8144d99c611e51df8818f"}, "originalPosition": 546}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzEwMDMxNw==", "bodyText": "yes, i had to add few lines to getIntSupplier. but indeed, it can be solved much better than copy-paste.\ni will split getIntSupplier in 2 parts - getInt and getSupplier so that i can use getInt here and add  required lines.", "url": "https://github.com/openhab/openhab-addons/pull/7673#discussion_r427100317", "createdAt": "2020-05-19T07:53:40Z", "author": {"login": "yfre"}, "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/accessories/HomekitCharacteristicFactory.java", "diffHunk": "@@ -195,315 +200,330 @@ private static void setValueFromEnum(GenericItem item, CharacteristicEnum value,\n                         \"Item state {} is not supported for {}. Only PercentType and DecimalType (0/100) are supported.\",\n                         state, item.getName());\n             }\n-            logger.trace(\" Get Int for {} value {}\", item.getLabel(), value);\n+            logger.trace(\" Get Int for {} value {}\", item.getName(), value);\n             return CompletableFuture.completedFuture(value);\n         };\n     }\n \n-    private static ExceptionalConsumer<Integer> setIntConsumer(final GenericItem item) {\n+    private static ExceptionalConsumer<Integer> setIntConsumer(final HomekitTaggedItem item) {\n         return (value) -> {\n-            if (item instanceof NumberItem) {\n-                ((NumberItem) item).send(new DecimalType(value));\n+            if (item.getItem() instanceof NumberItem) {\n+                ((NumberItem) item.getItem()).send(new DecimalType(value));\n             } else {\n-                logger.warn(\"Item type {} is not supported for {}. Only Number type is supported.\", item.getType(),\n-                        item.getName());\n+                logger.warn(\"Item type {} is not supported for {}. Only Number type is supported.\",\n+                        item.getItem().getType(), item.getName());\n             }\n         };\n     }\n \n-    private static Supplier<CompletableFuture<Double>> getDoubleSupplier(Item item) {\n+    private static Supplier<CompletableFuture<Double>> getDoubleSupplier(final HomekitTaggedItem item) {\n         return () -> {\n-            final DecimalType value = item.getStateAs(DecimalType.class);\n+            final DecimalType value = item.getItem().getStateAs(DecimalType.class);\n             return CompletableFuture.completedFuture(value != null ? value.doubleValue() : 0.0);\n         };\n     }\n \n+    private static Consumer<HomekitCharacteristicChangeCallback> getSubscriber(final HomekitTaggedItem item,\n+            final HomekitCharacteristicType key, final HomekitAccessoryUpdater updater) {\n+        return (callback) -> updater.subscribe((GenericItem) item.getItem(), key.getTag(), callback);\n+    }\n+\n+    private static Runnable getUnsubscriber(final HomekitTaggedItem item, final HomekitCharacteristicType key,\n+            final HomekitAccessoryUpdater updater) {\n+        return () -> updater.unsubscribe((GenericItem) item.getItem(), key.getTag());\n+    }\n+\n     // create method for characteristic\n-    private static StatusLowBatteryCharacteristic createStatusLowBatteryCharacteristic(final GenericItem item,\n-            HomekitAccessoryUpdater updater) {\n+    private static StatusLowBatteryCharacteristic createStatusLowBatteryCharacteristic(final HomekitTaggedItem item,\n+            final HomekitAccessoryUpdater updater) {\n         return new StatusLowBatteryCharacteristic(\n                 () -> getEnumFromItem(item, StatusLowBatteryEnum.NORMAL, StatusLowBatteryEnum.LOW,\n                         StatusLowBatteryEnum.NORMAL),\n-                (callback) -> updater.subscribe(item, BATTERY_LOW_STATUS.getTag(), callback),\n-                () -> updater.unsubscribe(item, BATTERY_LOW_STATUS.getTag()));\n+                getSubscriber(item, BATTERY_LOW_STATUS, updater), getUnsubscriber(item, BATTERY_LOW_STATUS, updater));\n     }\n \n-    private static StatusFaultCharacteristic createStatusFaultCharacteristic(final GenericItem item,\n-            HomekitAccessoryUpdater updater) {\n+    private static StatusFaultCharacteristic createStatusFaultCharacteristic(final HomekitTaggedItem item,\n+            final HomekitAccessoryUpdater updater) {\n         return new StatusFaultCharacteristic(\n                 () -> getEnumFromItem(item, StatusFaultEnum.NO_FAULT, StatusFaultEnum.GENERAL_FAULT,\n                         StatusFaultEnum.NO_FAULT),\n-                (callback) -> updater.subscribe(item, FAULT_STATUS.getTag(), callback),\n-                () -> updater.unsubscribe(item, FAULT_STATUS.getTag()));\n+                getSubscriber(item, FAULT_STATUS, updater), getUnsubscriber(item, FAULT_STATUS, updater));\n     }\n \n-    private static StatusTamperedCharacteristic createStatusTamperedCharacteristic(final GenericItem item,\n-            HomekitAccessoryUpdater updater) {\n+    private static StatusTamperedCharacteristic createStatusTamperedCharacteristic(final HomekitTaggedItem item,\n+            final HomekitAccessoryUpdater updater) {\n         return new StatusTamperedCharacteristic(\n                 () -> getEnumFromItem(item, StatusTamperedEnum.NOT_TAMPERED, StatusTamperedEnum.TAMPERED,\n                         StatusTamperedEnum.NOT_TAMPERED),\n-                (callback) -> updater.subscribe(item, TAMPERED_STATUS.getTag(), callback),\n-                () -> updater.unsubscribe(item, TAMPERED_STATUS.getTag()));\n+                getSubscriber(item, TAMPERED_STATUS, updater), getUnsubscriber(item, TAMPERED_STATUS, updater));\n     }\n \n-    private static ObstructionDetectedCharacteristic createObstructionDetectedCharacteristic(final GenericItem item,\n-            HomekitAccessoryUpdater updater) {\n+    private static ObstructionDetectedCharacteristic createObstructionDetectedCharacteristic(\n+            final HomekitTaggedItem item, HomekitAccessoryUpdater updater) {\n         return new ObstructionDetectedCharacteristic(\n-                () -> CompletableFuture\n-                        .completedFuture(item.getState() == OnOffType.ON || item.getState() == OpenClosedType.OPEN),\n-                (callback) -> updater.subscribe(item, OBSTRUCTION_STATUS.getTag(), callback),\n-                () -> updater.unsubscribe(item, OBSTRUCTION_STATUS.getTag()));\n+                () -> CompletableFuture.completedFuture(\n+                        item.getItem().getState() == OnOffType.ON || item.getItem().getState() == OpenClosedType.OPEN),\n+                getSubscriber(item, OBSTRUCTION_STATUS, updater), getUnsubscriber(item, OBSTRUCTION_STATUS, updater));\n     }\n \n-    private static StatusActiveCharacteristic createStatusActiveCharacteristic(final GenericItem item,\n+    private static StatusActiveCharacteristic createStatusActiveCharacteristic(final HomekitTaggedItem item,\n             HomekitAccessoryUpdater updater) {\n         return new StatusActiveCharacteristic(\n-                () -> CompletableFuture\n-                        .completedFuture(item.getState() == OnOffType.ON || item.getState() == OpenClosedType.OPEN),\n-                (callback) -> updater.subscribe(item, ACTIVE_STATUS.getTag(), callback),\n-                () -> updater.unsubscribe(item, ACTIVE_STATUS.getTag()));\n+                () -> CompletableFuture.completedFuture(\n+                        item.getItem().getState() == OnOffType.ON || item.getItem().getState() == OpenClosedType.OPEN),\n+                getSubscriber(item, ACTIVE_STATUS, updater), getUnsubscriber(item, ACTIVE_STATUS, updater));\n     }\n \n-    private static NameCharacteristic createNameCharacteristic(final GenericItem item,\n+    private static NameCharacteristic createNameCharacteristic(final HomekitTaggedItem item,\n             HomekitAccessoryUpdater updater) {\n         return new NameCharacteristic(() -> {\n-            final State state = item.getState();\n+            final State state = item.getItem().getState();\n             return CompletableFuture.completedFuture(state instanceof UnDefType ? \"\" : state.toString());\n         });\n     }\n \n-    private static HoldPositionCharacteristic createHoldPositionCharacteristic(final GenericItem item,\n+    private static HoldPositionCharacteristic createHoldPositionCharacteristic(final HomekitTaggedItem item,\n             HomekitAccessoryUpdater updater) {\n         return new HoldPositionCharacteristic(OnOffType::from);\n     }\n \n-    private static CarbonMonoxideLevelCharacteristic createCarbonMonoxideLevelCharacteristic(final GenericItem item,\n-            HomekitAccessoryUpdater updater) {\n+    private static CarbonMonoxideLevelCharacteristic createCarbonMonoxideLevelCharacteristic(\n+            final HomekitTaggedItem item, HomekitAccessoryUpdater updater) {\n         return new CarbonMonoxideLevelCharacteristic(getDoubleSupplier(item),\n-                (callback) -> updater.subscribe(item, CARBON_DIOXIDE_LEVEL.getTag(), callback),\n-                () -> updater.unsubscribe(item, CARBON_DIOXIDE_LEVEL.getTag()));\n+                getSubscriber(item, CARBON_DIOXIDE_LEVEL, updater),\n+                getUnsubscriber(item, CARBON_DIOXIDE_LEVEL, updater));\n     }\n \n     private static CarbonMonoxidePeakLevelCharacteristic createCarbonMonoxidePeakLevelCharacteristic(\n-            final GenericItem item, HomekitAccessoryUpdater updater) {\n+            final HomekitTaggedItem item, HomekitAccessoryUpdater updater) {\n         return new CarbonMonoxidePeakLevelCharacteristic(getDoubleSupplier(item),\n-                (callback) -> updater.subscribe(item, CARBON_DIOXIDE_PEAK_LEVEL.getTag(), callback),\n-                () -> updater.unsubscribe(item, CARBON_DIOXIDE_PEAK_LEVEL.getTag()));\n+                getSubscriber(item, CARBON_DIOXIDE_PEAK_LEVEL, updater),\n+                getUnsubscriber(item, CARBON_DIOXIDE_PEAK_LEVEL, updater));\n     }\n \n-    private static CarbonDioxideLevelCharacteristic createCarbonDioxideLevelCharacteristic(final GenericItem item,\n+    private static CarbonDioxideLevelCharacteristic createCarbonDioxideLevelCharacteristic(final HomekitTaggedItem item,\n             HomekitAccessoryUpdater updater) {\n         return new CarbonDioxideLevelCharacteristic(getDoubleSupplier(item),\n-                (callback) -> updater.subscribe(item, CARBON_MONOXIDE_LEVEL.getTag(), callback),\n-                () -> updater.unsubscribe(item, CARBON_MONOXIDE_LEVEL.getTag()));\n+                getSubscriber(item, CARBON_MONOXIDE_LEVEL, updater),\n+                getUnsubscriber(item, CARBON_MONOXIDE_LEVEL, updater));\n     }\n \n     private static CarbonDioxidePeakLevelCharacteristic createCarbonDioxidePeakLevelCharacteristic(\n-            final GenericItem item, HomekitAccessoryUpdater updater) {\n+            final HomekitTaggedItem item, HomekitAccessoryUpdater updater) {\n         return new CarbonDioxidePeakLevelCharacteristic(getDoubleSupplier(item),\n-                (callback) -> updater.subscribe(item, CARBON_MONOXIDE_PEAK_LEVEL.getTag(), callback),\n-                () -> updater.unsubscribe(item, CARBON_MONOXIDE_PEAK_LEVEL.getTag()));\n+                getSubscriber(item, CARBON_MONOXIDE_PEAK_LEVEL, updater),\n+                getUnsubscriber(item, CARBON_MONOXIDE_PEAK_LEVEL, updater));\n     }\n \n     private static CurrentHorizontalTiltAngleCharacteristic createCurrentHorizontalTiltAngleCharacteristic(\n-            final GenericItem item, HomekitAccessoryUpdater updater) {\n+            final HomekitTaggedItem item, HomekitAccessoryUpdater updater) {\n         return new CurrentHorizontalTiltAngleCharacteristic(getIntSupplier(item),\n-                (callback) -> updater.subscribe(item, CURRENT_HORIZONTAL_TILT_ANGLE.getTag(), callback),\n-                () -> updater.unsubscribe(item, CURRENT_HORIZONTAL_TILT_ANGLE.getTag()));\n+                getSubscriber(item, CURRENT_HORIZONTAL_TILT_ANGLE, updater),\n+                getUnsubscriber(item, CURRENT_HORIZONTAL_TILT_ANGLE, updater));\n     }\n \n     private static CurrentVerticalTiltAngleCharacteristic createCurrentVerticalTiltAngleCharacteristic(\n-            final GenericItem item, HomekitAccessoryUpdater updater) {\n+            final HomekitTaggedItem item, HomekitAccessoryUpdater updater) {\n         return new CurrentVerticalTiltAngleCharacteristic(getIntSupplier(item),\n-                (callback) -> updater.subscribe(item, CURRENT_VERTICAL_TILT_ANGLE.getTag(), callback),\n-                () -> updater.unsubscribe(item, CURRENT_VERTICAL_TILT_ANGLE.getTag()));\n+                getSubscriber(item, CURRENT_VERTICAL_TILT_ANGLE, updater),\n+                getUnsubscriber(item, CURRENT_VERTICAL_TILT_ANGLE, updater));\n     }\n \n     private static TargetHorizontalTiltAngleCharacteristic createTargetHorizontalTiltAngleCharacteristic(\n-            final GenericItem item, HomekitAccessoryUpdater updater) {\n+            final HomekitTaggedItem item, HomekitAccessoryUpdater updater) {\n         return new TargetHorizontalTiltAngleCharacteristic(getIntSupplier(item), setIntConsumer(item),\n-                (callback) -> updater.subscribe(item, TARGET_HORIZONTAL_TILT_ANGLE.getTag(), callback),\n-                () -> updater.unsubscribe(item, TARGET_HORIZONTAL_TILT_ANGLE.getTag()));\n+                getSubscriber(item, TARGET_HORIZONTAL_TILT_ANGLE, updater),\n+                getUnsubscriber(item, TARGET_HORIZONTAL_TILT_ANGLE, updater));\n     }\n \n     private static TargetVerticalTiltAngleCharacteristic createTargetVerticalTiltAngleCharacteristic(\n-            final GenericItem item, HomekitAccessoryUpdater updater) {\n+            final HomekitTaggedItem item, HomekitAccessoryUpdater updater) {\n         return new TargetVerticalTiltAngleCharacteristic(getIntSupplier(item), setIntConsumer(item),\n-                (callback) -> updater.subscribe(item, TARGET_VERTICAL_TILT_ANGLE.getTag(), callback),\n-                () -> updater.unsubscribe(item, TARGET_VERTICAL_TILT_ANGLE.getTag()));\n+                getSubscriber(item, TARGET_HORIZONTAL_TILT_ANGLE, updater),\n+                getUnsubscriber(item, TARGET_HORIZONTAL_TILT_ANGLE, updater));\n     }\n \n-    private static HueCharacteristic createHueCharacteristic(final GenericItem item, HomekitAccessoryUpdater updater) {\n+    private static HueCharacteristic createHueCharacteristic(final HomekitTaggedItem item,\n+            HomekitAccessoryUpdater updater) {\n         return new HueCharacteristic(() -> {\n             Double value = 0.0;\n-            State state = item.getState();\n+            State state = item.getItem().getState();\n             if (state instanceof HSBType) {\n                 value = ((HSBType) state).getHue().doubleValue();\n             }\n             return CompletableFuture.completedFuture(value);\n         }, (hue) -> {\n-            State state = item.getState();\n-            if (item instanceof ColorItem) {\n-                ((ColorItem) item).send(new HSBType(new DecimalType(hue), ((HSBType) state).getSaturation(),\n+            State state = item.getItem().getState();\n+            if (item.getItem() instanceof ColorItem) {\n+                ((ColorItem) item.getItem()).send(new HSBType(new DecimalType(hue), ((HSBType) state).getSaturation(),\n                         ((HSBType) state).getBrightness()));\n             } else {\n-                logger.warn(\"Item type {} is not supported for {}. Only Color type is supported.\", item.getType(),\n-                        item.getName());\n+                logger.warn(\"Item type {} is not supported for {}. Only Color type is supported.\",\n+                        item.getItem().getType(), item.getName());\n             }\n-        }, (callback) -> updater.subscribe(item, HUE.getTag(), callback),\n-                () -> updater.unsubscribe(item, HUE.getTag()));\n+        }, getSubscriber(item, HUE, updater), getUnsubscriber(item, HUE, updater));\n     }\n \n-    private static BrightnessCharacteristic createBrightnessCharacteristic(final GenericItem item,\n+    private static BrightnessCharacteristic createBrightnessCharacteristic(final HomekitTaggedItem item,\n             HomekitAccessoryUpdater updater) {\n         return new BrightnessCharacteristic(() -> {\n             int value = 0;\n-            final State state = item.getState();\n+            final State state = item.getItem().getState();\n             if (state instanceof HSBType) {\n                 value = ((HSBType) state).getBrightness().intValue();\n             } else if (state instanceof PercentType) {\n                 value = ((PercentType) state).intValue();\n             }\n             return CompletableFuture.completedFuture(value);\n         }, (brightness) -> {\n-            final State state = item.getState();\n-            if (item instanceof ColorItem) {\n-                ((ColorItem) item).send(new HSBType(((HSBType) state).getHue(), ((HSBType) state).getSaturation(),\n+            final Item oItem = item.getItem();\n+            final State state = oItem.getState();\n+            if (oItem instanceof ColorItem) {\n+                ((ColorItem) oItem).send(new HSBType(((HSBType) state).getHue(), ((HSBType) state).getSaturation(),\n                         new PercentType(brightness)));\n-            } else if (item instanceof DimmerItem) {\n-                ((DimmerItem) item).send(new PercentType(brightness));\n+            } else if (oItem instanceof DimmerItem) {\n+                ((DimmerItem) oItem).send(new PercentType(brightness));\n             } else {\n-                logger.warn(\"Item type {} is not supported for {}. Only ColorItem and DimmerIterm are supported.\",\n-                        item.getType(), item.getName());\n+                logger.warn(\"Item type {} is not supported for {}. Only Color type is supported.\", oItem.getType(),\n+                        item.getName());\n             }\n-        }, (callback) -> updater.subscribe(item, BRIGHTNESS.getTag(), callback),\n-                () -> updater.unsubscribe(item, BRIGHTNESS.getTag()));\n+        }, getSubscriber(item, BRIGHTNESS, updater), getUnsubscriber(item, BRIGHTNESS, updater));\n     }\n \n-    private static SaturationCharacteristic createSaturationCharacteristic(final GenericItem item,\n+    private static SaturationCharacteristic createSaturationCharacteristic(final HomekitTaggedItem item,\n             HomekitAccessoryUpdater updater) {\n         return new SaturationCharacteristic(() -> {\n             Double value = 0.0;\n-            State state = item.getState();\n+            State state = item.getItem().getState();\n             if (state instanceof HSBType) {\n                 value = ((HSBType) state).getSaturation().doubleValue();\n             } else if (state instanceof PercentType) {\n                 value = ((PercentType) state).doubleValue();\n             }\n             return CompletableFuture.completedFuture(value);\n         }, (saturation) -> {\n-            final State state = item.getState();\n-            if (item instanceof ColorItem) {\n-                ((ColorItem) item).send(new HSBType(((HSBType) state).getHue(), new PercentType(saturation.intValue()),\n-                        ((HSBType) state).getBrightness()));\n+            final State state = item.getItem().getState();\n+            if (item.getItem() instanceof ColorItem) {\n+                ((ColorItem) item.getItem()).send(new HSBType(((HSBType) state).getHue(),\n+                        new PercentType(saturation.intValue()), ((HSBType) state).getBrightness()));\n             } else {\n-                logger.warn(\"Item type {} is not supported for {}. Only Color type is supported.\", item.getType(),\n-                        item.getName());\n+                logger.warn(\"Item type {} is not supported for {}. Only Color type is supported.\",\n+                        item.getItem().getType(), item.getName());\n             }\n-        }, (callback) -> updater.subscribe(item, SATURATION.getTag(), callback),\n-                () -> updater.unsubscribe(item, SATURATION.getTag()));\n+        }, getSubscriber(item, SATURATION, updater), getUnsubscriber(item, SATURATION, updater));\n     }\n \n-    private static ColorTemperatureCharacteristic createColorTemperatureCharacteristic(final GenericItem item,\n+    private static ColorTemperatureCharacteristic createColorTemperatureCharacteristic(final HomekitTaggedItem item,\n             HomekitAccessoryUpdater updater) {\n         return new ColorTemperatureCharacteristic(getIntSupplier(item), setIntConsumer(item),\n-                (callback) -> updater.subscribe(item, COLOR_TEMPERATURE.getTag(), callback),\n-                () -> updater.unsubscribe(item, COLOR_TEMPERATURE.getTag()));\n+                getSubscriber(item, COLOR_TEMPERATURE, updater), getUnsubscriber(item, COLOR_TEMPERATURE, updater));\n     }\n \n-    private static CurrentFanStateCharacteristic createCurrentFanStateCharacteristic(final GenericItem item,\n+    private static CurrentFanStateCharacteristic createCurrentFanStateCharacteristic(final HomekitTaggedItem item,\n             HomekitAccessoryUpdater updater) {\n         return new CurrentFanStateCharacteristic(() -> {\n-            final DecimalType value = item.getStateAs(DecimalType.class);\n+            final DecimalType value = item.getItem().getStateAs(DecimalType.class);\n             CurrentFanStateEnum currentFanStateEnum = value != null ? CurrentFanStateEnum.fromCode(value.intValue())\n                     : null;\n             if (currentFanStateEnum == null) {\n                 currentFanStateEnum = CurrentFanStateEnum.INACTIVE;\n             }\n             return CompletableFuture.completedFuture(currentFanStateEnum);\n-        }, (callback) -> updater.subscribe(item, CURRENT_FAN_STATE.getTag(), callback),\n-                () -> updater.unsubscribe(item, CURRENT_FAN_STATE.getTag()));\n+        }, getSubscriber(item, CURRENT_FAN_STATE, updater), getUnsubscriber(item, CURRENT_FAN_STATE, updater));\n     }\n \n-    private static TargetFanStateCharacteristic createTargetFanStateCharacteristic(final GenericItem item,\n+    private static TargetFanStateCharacteristic createTargetFanStateCharacteristic(final HomekitTaggedItem item,\n             HomekitAccessoryUpdater updater) {\n         return new TargetFanStateCharacteristic(() -> {\n-            final DecimalType value = item.getStateAs(DecimalType.class);\n+            final DecimalType value = item.getItem().getStateAs(DecimalType.class);\n             TargetFanStateEnum targetFanStateEnum = value != null ? TargetFanStateEnum.fromCode(value.intValue())\n                     : null;\n             if (targetFanStateEnum == null) {\n                 targetFanStateEnum = TargetFanStateEnum.AUTO;\n             }\n             return CompletableFuture.completedFuture(targetFanStateEnum);\n         }, (targetState) -> {\n-            if (item instanceof NumberItem) {\n-                ((NumberItem) item).send(new DecimalType(targetState.getCode()));\n+            if (item.getItem() instanceof NumberItem) {\n+                ((NumberItem) item.getItem()).send(new DecimalType(targetState.getCode()));\n             } else {\n-                logger.warn(\"Item type {} is not supported for {}. Only Number type is supported.\", item.getType(),\n-                        item.getName());\n+                logger.warn(\"Item type {} is not supported for {}. Only Number type is supported.\",\n+                        item.getItem().getType(), item.getName());\n             }\n-        }, (callback) -> updater.subscribe(item, TARGET_FAN_STATE.getTag(), callback),\n-                () -> updater.unsubscribe(item, TARGET_FAN_STATE.getTag()));\n+        }, getSubscriber(item, TARGET_FAN_STATE, updater), getUnsubscriber(item, TARGET_FAN_STATE, updater));\n     }\n \n-    private static RotationDirectionCharacteristic createRotationDirectionCharacteristic(final GenericItem item,\n+    private static RotationDirectionCharacteristic createRotationDirectionCharacteristic(final HomekitTaggedItem item,\n             HomekitAccessoryUpdater updater) {\n         return new RotationDirectionCharacteristic(\n                 () -> getEnumFromItem(item, RotationDirectionEnum.CLOCKWISE, RotationDirectionEnum.COUNTER_CLOCKWISE,\n                         RotationDirectionEnum.CLOCKWISE),\n                 (value) -> setValueFromEnum(item, value, RotationDirectionEnum.CLOCKWISE,\n                         RotationDirectionEnum.COUNTER_CLOCKWISE),\n-                (callback) -> updater.subscribe(item, ROTATION_DIRECTION.getTag(), callback),\n-                () -> updater.unsubscribe(item, ROTATION_DIRECTION.getTag()));\n+                getSubscriber(item, ROTATION_DIRECTION, updater), getUnsubscriber(item, ROTATION_DIRECTION, updater));\n     }\n \n-    private static SwingModeCharacteristic createSwingModeCharacteristic(final GenericItem item,\n+    private static SwingModeCharacteristic createSwingModeCharacteristic(final HomekitTaggedItem item,\n             HomekitAccessoryUpdater updater) {\n         return new SwingModeCharacteristic(\n                 () -> getEnumFromItem(item, SwingModeEnum.SWING_DISABLED, SwingModeEnum.SWING_ENABLED,\n                         SwingModeEnum.SWING_DISABLED),\n                 (value) -> setValueFromEnum(item, value, SwingModeEnum.SWING_DISABLED, SwingModeEnum.SWING_ENABLED),\n-                (callback) -> updater.subscribe(item, SWING_MODE.getTag(), callback),\n-                () -> updater.unsubscribe(item, SWING_MODE.getTag()));\n+                getSubscriber(item, SWING_MODE, updater), getUnsubscriber(item, SWING_MODE, updater));\n     }\n \n-    private static LockPhysicalControlsCharacteristic createLockPhysicalControlsCharacteristic(final GenericItem item,\n-            HomekitAccessoryUpdater updater) {\n+    private static LockPhysicalControlsCharacteristic createLockPhysicalControlsCharacteristic(\n+            final HomekitTaggedItem item, HomekitAccessoryUpdater updater) {\n         return new LockPhysicalControlsCharacteristic(\n                 () -> getEnumFromItem(item, LockPhysicalControlsEnum.CONTROL_LOCK_DISABLED,\n                         LockPhysicalControlsEnum.CONTROL_LOCK_ENABLED, LockPhysicalControlsEnum.CONTROL_LOCK_DISABLED),\n                 (value) -> setValueFromEnum(item, value, LockPhysicalControlsEnum.CONTROL_LOCK_DISABLED,\n                         LockPhysicalControlsEnum.CONTROL_LOCK_ENABLED),\n-                (callback) -> updater.subscribe(item, LOCK_CONTROL.getTag(), callback),\n-                () -> updater.unsubscribe(item, LOCK_CONTROL.getTag()));\n+                getSubscriber(item, LOCK_CONTROL, updater), getUnsubscriber(item, LOCK_CONTROL, updater));\n     }\n \n-    private static RotationSpeedCharacteristic createRotationSpeedCharacteristic(final GenericItem item,\n+    private static RotationSpeedCharacteristic createRotationSpeedCharacteristic(final HomekitTaggedItem item,\n             HomekitAccessoryUpdater updater) {\n         return new RotationSpeedCharacteristic(getIntSupplier(item), setIntConsumer(item),\n-                (callback) -> updater.subscribe(item, ROTATION_SPEED.getTag(), callback),\n-                () -> updater.unsubscribe(item, ROTATION_SPEED.getTag()));\n+                getSubscriber(item, ROTATION_SPEED, updater), getUnsubscriber(item, ROTATION_SPEED, updater));\n     }\n \n-    private static SetDurationCharacteristic createDurationCharacteristic(final GenericItem item,\n+    private static SetDurationCharacteristic createDurationCharacteristic(final HomekitTaggedItem item,\n             HomekitAccessoryUpdater updater) {\n-        return new SetDurationCharacteristic(getIntSupplier(item), setIntConsumer(item),\n-                (callback) -> updater.subscribe(item, DURATION.getTag(), callback),\n-                () -> updater.unsubscribe(item, DURATION.getTag()));\n+        return new SetDurationCharacteristic(() -> {\n+            int value = 0;\n+            final State state = item.getItem().getState();\n+            if (state instanceof PercentType) {\n+                value = state.as(PercentType.class).intValue();\n+            } else if (state instanceof DecimalType) {\n+                value = state.as(DecimalType.class).intValue();\n+            } else if (state instanceof UnDefType) {\n+                logger.debug(\"Item state {} is UNDEF {}.\", state, item.getName());\n+            } else {\n+                logger.warn(\n+                        \"Item state {} is not supported for {}. Only PercentType and DecimalType (0/100) are supported.\",\n+                        state, item.getName());\n+            }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk0NDY3MA=="}, "originalCommit": {"oid": "aea5a1f87a9e89510ad8144d99c611e51df8818f"}, "originalPosition": 546}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2MTk0MTk1OnYy", "diffSide": "LEFT", "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/accessories/HomekitValveImpl.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNTo1NDowMFrOGXnLWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxOTo1OTozN1rOGXwdDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQxMjMxMw==", "bodyText": "Wouldn't you still need this since you removed it from stopTimer?", "url": "https://github.com/openhab/openhab-addons/pull/7673#discussion_r427412313", "createdAt": "2020-05-19T15:54:00Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/accessories/HomekitValveImpl.java", "diffHunk": "@@ -119,19 +119,13 @@ private void startTimer() {\n         int duration = getDuration();\n         logger.trace(\"start timer for duration {}\", duration);\n         if (duration > 0) {\n-            ScheduledFuture<?> future = valveTimer;\n-            if (future != null && !future.isDone()) {\n-                future.cancel(true);\n-            }\n+            stopTimer();\n             valveTimer = timerService.schedule(() -> {\n                 logger.trace(\"valve timer is over. switching off the valve\");\n                 switchOffValve();\n                 // let home app refresh the remaining duration, which is 0\n                 ((GenericItem) getRootAccessory().getItem()).send(RefreshType.REFRESH);\n             }, duration, TimeUnit.SECONDS);\n-\n-            // let home app refresh the remaining duration, which is 0\n-            ((GenericItem) getRootAccessory().getItem()).send(RefreshType.REFRESH);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fad26bc6d994af35d079d0da04361c02c7fb76d4"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU1MjkxMA==", "bodyText": "i have added to the caller method, setValveActive. it will call REFRESH in both cases - start and stop timer.\n if (homekitTimer) {\n                if ((state == ActiveEnum.ACTIVE)) {\n                    startTimer();\n                } else {\n                    stopTimer();\n                }\n                // let home app refresh the remaining duration\n                ((GenericItem) getRootAccessory().getItem()).send(RefreshType.REFRESH);", "url": "https://github.com/openhab/openhab-addons/pull/7673#discussion_r427552910", "createdAt": "2020-05-19T19:38:30Z", "author": {"login": "yfre"}, "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/accessories/HomekitValveImpl.java", "diffHunk": "@@ -119,19 +119,13 @@ private void startTimer() {\n         int duration = getDuration();\n         logger.trace(\"start timer for duration {}\", duration);\n         if (duration > 0) {\n-            ScheduledFuture<?> future = valveTimer;\n-            if (future != null && !future.isDone()) {\n-                future.cancel(true);\n-            }\n+            stopTimer();\n             valveTimer = timerService.schedule(() -> {\n                 logger.trace(\"valve timer is over. switching off the valve\");\n                 switchOffValve();\n                 // let home app refresh the remaining duration, which is 0\n                 ((GenericItem) getRootAccessory().getItem()).send(RefreshType.REFRESH);\n             }, duration, TimeUnit.SECONDS);\n-\n-            // let home app refresh the remaining duration, which is 0\n-            ((GenericItem) getRootAccessory().getItem()).send(RefreshType.REFRESH);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQxMjMxMw=="}, "originalCommit": {"oid": "fad26bc6d994af35d079d0da04361c02c7fb76d4"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU2NDMwMQ==", "bodyText": "Ah, didn't notice that. Looks good to me then.", "url": "https://github.com/openhab/openhab-addons/pull/7673#discussion_r427564301", "createdAt": "2020-05-19T19:59:37Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/accessories/HomekitValveImpl.java", "diffHunk": "@@ -119,19 +119,13 @@ private void startTimer() {\n         int duration = getDuration();\n         logger.trace(\"start timer for duration {}\", duration);\n         if (duration > 0) {\n-            ScheduledFuture<?> future = valveTimer;\n-            if (future != null && !future.isDone()) {\n-                future.cancel(true);\n-            }\n+            stopTimer();\n             valveTimer = timerService.schedule(() -> {\n                 logger.trace(\"valve timer is over. switching off the valve\");\n                 switchOffValve();\n                 // let home app refresh the remaining duration, which is 0\n                 ((GenericItem) getRootAccessory().getItem()).send(RefreshType.REFRESH);\n             }, duration, TimeUnit.SECONDS);\n-\n-            // let home app refresh the remaining duration, which is 0\n-            ((GenericItem) getRootAccessory().getItem()).send(RefreshType.REFRESH);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQxMjMxMw=="}, "originalCommit": {"oid": "fad26bc6d994af35d079d0da04361c02c7fb76d4"}, "originalPosition": 54}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2Mjg0NTM5OnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/accessories/HomekitCharacteristicFactory.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxOTo1MDoxNlrOGXwJZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxOTo1MDoxNlrOGXwJZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU1OTI2OA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            \"Unsupported optional characteristic. Characteristic type \\\"\" + item.getCharacteristicType());\n          \n          \n            \n                            \"Unsupported optional characteristic. Characteristic type \\\"\" + item.getCharacteristicType()+\"\\\"\");", "url": "https://github.com/openhab/openhab-addons/pull/7673#discussion_r427559268", "createdAt": "2020-05-19T19:50:16Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/accessories/HomekitCharacteristicFactory.java", "diffHunk": "@@ -123,28 +127,29 @@\n     /**\n      * create optional HomeKit characteristic\n      *\n-     * @param type type of characteristic\n      * @param item corresponding OH item\n      * @param updater update to keep OH item and HomeKit characteristic in sync\n      * @return HomeKit characteristic\n      */\n-    public static Characteristic createCharacteristic(HomekitCharacteristicType type, GenericItem item,\n-            HomekitAccessoryUpdater updater) throws HomekitException {\n-        logger.trace(\"createCharacteristic, type {} item {}\", type, item);\n-        if (optional.containsKey(type)) {\n-            return optional.get(type).apply(item, updater);\n+    public static Characteristic createCharacteristic(final HomekitTaggedItem item, HomekitAccessoryUpdater updater)\n+            throws HomekitException {\n+        logger.trace(\"createCharacteristic, type {} item {}\", item.getCharacteristicType(), item);\n+        if (optional.containsKey(item.getCharacteristicType())) {\n+            return optional.get(item.getCharacteristicType()).apply(item, updater);\n         }\n-        logger.warn(\"Unsupported optional characteristic. Item type {}, characteristic type {}\", item.getType(), type);\n-        throw new HomekitException(\"Unsupported optional characteristic. Characteristic type \\\"\" + item.getType());\n+        logger.warn(\"Unsupported optional characteristic. Item type {}, characteristic type {}\",\n+                item.getAccessoryType(), item.getCharacteristicType());\n+        throw new HomekitException(\n+                \"Unsupported optional characteristic. Characteristic type \\\"\" + item.getCharacteristicType());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ec450f3b9650637fabcfcfcd571273e5830e8ee"}, "originalPosition": 62}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2Mjg0Nzc5OnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/accessories/HomekitCharacteristicFactory.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxOTo1MDo1OVrOGXwK9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQwODowMDoyMVrOGX_t0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU1OTY2OA==", "bodyText": "Please cache item.getCharacteristicType() in a local variable for reuse.", "url": "https://github.com/openhab/openhab-addons/pull/7673#discussion_r427559668", "createdAt": "2020-05-19T19:50:59Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/accessories/HomekitCharacteristicFactory.java", "diffHunk": "@@ -123,28 +127,29 @@\n     /**\n      * create optional HomeKit characteristic\n      *\n-     * @param type type of characteristic\n      * @param item corresponding OH item\n      * @param updater update to keep OH item and HomeKit characteristic in sync\n      * @return HomeKit characteristic\n      */\n-    public static Characteristic createCharacteristic(HomekitCharacteristicType type, GenericItem item,\n-            HomekitAccessoryUpdater updater) throws HomekitException {\n-        logger.trace(\"createCharacteristic, type {} item {}\", type, item);\n-        if (optional.containsKey(type)) {\n-            return optional.get(type).apply(item, updater);\n+    public static Characteristic createCharacteristic(final HomekitTaggedItem item, HomekitAccessoryUpdater updater)\n+            throws HomekitException {\n+        logger.trace(\"createCharacteristic, type {} item {}\", item.getCharacteristicType(), item);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ec450f3b9650637fabcfcfcd571273e5830e8ee"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzgxNDM1Mg==", "bodyText": "good one. need to pay more attention to this.", "url": "https://github.com/openhab/openhab-addons/pull/7673#discussion_r427814352", "createdAt": "2020-05-20T08:00:21Z", "author": {"login": "yfre"}, "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/accessories/HomekitCharacteristicFactory.java", "diffHunk": "@@ -123,28 +127,29 @@\n     /**\n      * create optional HomeKit characteristic\n      *\n-     * @param type type of characteristic\n      * @param item corresponding OH item\n      * @param updater update to keep OH item and HomeKit characteristic in sync\n      * @return HomeKit characteristic\n      */\n-    public static Characteristic createCharacteristic(HomekitCharacteristicType type, GenericItem item,\n-            HomekitAccessoryUpdater updater) throws HomekitException {\n-        logger.trace(\"createCharacteristic, type {} item {}\", type, item);\n-        if (optional.containsKey(type)) {\n-            return optional.get(type).apply(item, updater);\n+    public static Characteristic createCharacteristic(final HomekitTaggedItem item, HomekitAccessoryUpdater updater)\n+            throws HomekitException {\n+        logger.trace(\"createCharacteristic, type {} item {}\", item.getCharacteristicType(), item);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU1OTY2OA=="}, "originalCommit": {"oid": "3ec450f3b9650637fabcfcfcd571273e5830e8ee"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NzI2NTAxOnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/accessories/HomekitCharacteristicFactory.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxOTo1NTozOVrOGYbm8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwOTo0MzowOVrOGYsuPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI3MTM0NA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    throw new HomekitException(\"Unsupported optional characteristic. Characteristic type \\\"\" + type);\n          \n          \n            \n                    throw new HomekitException(\"Unsupported optional characteristic. Characteristic type \\\"\" + type + \"\\\"\");", "url": "https://github.com/openhab/openhab-addons/pull/7673#discussion_r428271344", "createdAt": "2020-05-20T19:55:39Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/accessories/HomekitCharacteristicFactory.java", "diffHunk": "@@ -123,28 +128,29 @@\n     /**\n      * create optional HomeKit characteristic\n      *\n-     * @param type type of characteristic\n      * @param item corresponding OH item\n      * @param updater update to keep OH item and HomeKit characteristic in sync\n      * @return HomeKit characteristic\n      */\n-    public static Characteristic createCharacteristic(HomekitCharacteristicType type, GenericItem item,\n-            HomekitAccessoryUpdater updater) throws HomekitException {\n+    public static Characteristic createCharacteristic(final HomekitTaggedItem item, HomekitAccessoryUpdater updater)\n+            throws HomekitException {\n+        final @Nullable HomekitCharacteristicType type = item.getCharacteristicType();\n         logger.trace(\"createCharacteristic, type {} item {}\", type, item);\n         if (optional.containsKey(type)) {\n             return optional.get(type).apply(item, updater);\n         }\n-        logger.warn(\"Unsupported optional characteristic. Item type {}, characteristic type {}\", item.getType(), type);\n-        throw new HomekitException(\"Unsupported optional characteristic. Characteristic type \\\"\" + item.getType());\n+        logger.warn(\"Unsupported optional characteristic. Accessory type {}, characteristic type {}\",\n+                item.getAccessoryType(), type);\n+        throw new HomekitException(\"Unsupported optional characteristic. Characteristic type \\\"\" + type);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9db355b2b17e3f26f429f5740e9876a61779c4a0"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODU1MTc0Mg==", "bodyText": "sorry, missed that one", "url": "https://github.com/openhab/openhab-addons/pull/7673#discussion_r428551742", "createdAt": "2020-05-21T09:43:09Z", "author": {"login": "yfre"}, "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/accessories/HomekitCharacteristicFactory.java", "diffHunk": "@@ -123,28 +128,29 @@\n     /**\n      * create optional HomeKit characteristic\n      *\n-     * @param type type of characteristic\n      * @param item corresponding OH item\n      * @param updater update to keep OH item and HomeKit characteristic in sync\n      * @return HomeKit characteristic\n      */\n-    public static Characteristic createCharacteristic(HomekitCharacteristicType type, GenericItem item,\n-            HomekitAccessoryUpdater updater) throws HomekitException {\n+    public static Characteristic createCharacteristic(final HomekitTaggedItem item, HomekitAccessoryUpdater updater)\n+            throws HomekitException {\n+        final @Nullable HomekitCharacteristicType type = item.getCharacteristicType();\n         logger.trace(\"createCharacteristic, type {} item {}\", type, item);\n         if (optional.containsKey(type)) {\n             return optional.get(type).apply(item, updater);\n         }\n-        logger.warn(\"Unsupported optional characteristic. Item type {}, characteristic type {}\", item.getType(), type);\n-        throw new HomekitException(\"Unsupported optional characteristic. Characteristic type \\\"\" + item.getType());\n+        logger.warn(\"Unsupported optional characteristic. Accessory type {}, characteristic type {}\",\n+                item.getAccessoryType(), type);\n+        throw new HomekitException(\"Unsupported optional characteristic. Characteristic type \\\"\" + type);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI3MTM0NA=="}, "originalCommit": {"oid": "9db355b2b17e3f26f429f5740e9876a61779c4a0"}, "originalPosition": 63}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 45, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}