{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQzODc5MTE1", "number": 8057, "title": "[netatmo] Null annotations Part 3 of 3", "bodyText": "Fix #7913\nSigned-off-by: Laurent Garnier lg.hc@free.fr", "createdAt": "2020-07-03T06:33:27Z", "url": "https://github.com/openhab/openhab-addons/pull/8057", "merged": true, "mergeCommit": {"oid": "51dacbd1c60a59ffcc1101d500da75436761fd90"}, "closed": true, "closedAt": "2020-07-09T22:29:52Z", "author": {"login": "lolodomo"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcxNbATAH2gAyNDQzODc5MTE1OjljMDM5MjdjZDY4ODI3MmFhZjRiODhkZjJiYzcwMjA3OTE0MjdmMDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABczWyFNAFqTQ0NjAxMDg3NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9c03927cd688272aaf4b88df2bc7020791427f02", "author": {"user": {"login": "lolodomo", "name": "lolodomo"}}, "url": "https://github.com/openhab/openhab-addons/commit/9c03927cd688272aaf4b88df2bc7020791427f02", "committedDate": "2020-07-03T06:26:38Z", "message": "[netatmo] Null annotations Part 3 of 3\n\nFix #7913\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7df949736fe8f7677c14833a8ff3f548484445e0", "author": {"user": {"login": "lolodomo", "name": "lolodomo"}}, "url": "https://github.com/openhab/openhab-addons/commit/7df949736fe8f7677c14833a8ff3f548484445e0", "committedDate": "2020-07-04T11:44:23Z", "message": "Video status only set when there is a video in the event\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7b620e95278e0f9fe5444192403f4cfbb51629af", "author": {"user": {"login": "lolodomo", "name": "lolodomo"}}, "url": "https://github.com/openhab/openhab-addons/commit/7b620e95278e0f9fe5444192403f4cfbb51629af", "committedDate": "2020-07-04T11:04:20Z", "message": "Video status only set when there is a video in the event\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>"}, "afterCommit": {"oid": "7df949736fe8f7677c14833a8ff3f548484445e0", "author": {"user": {"login": "lolodomo", "name": "lolodomo"}}, "url": "https://github.com/openhab/openhab-addons/commit/7df949736fe8f7677c14833a8ff3f548484445e0", "committedDate": "2020-07-04T11:44:23Z", "message": "Video status only set when there is a video in the event\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNjY0OTM3", "url": "https://github.com/openhab/openhab-addons/pull/8057#pullrequestreview-442664937", "createdAt": "2020-07-05T10:24:29Z", "commit": {"oid": "7df949736fe8f7677c14833a8ff3f548484445e0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0113c48e6b24c9c9232fa9a5345658f84d5eb61", "author": {"user": {"login": "lolodomo", "name": "lolodomo"}}, "url": "https://github.com/openhab/openhab-addons/commit/e0113c48e6b24c9c9232fa9a5345658f84d5eb61", "committedDate": "2020-07-07T17:56:56Z", "message": "Add a setting to enable/disable the background discovery\n\nFix #8083\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "12918c857658fc65c43ca4589c0588108159a00e", "author": {"user": {"login": "lolodomo", "name": "lolodomo"}}, "url": "https://github.com/openhab/openhab-addons/commit/12918c857658fc65c43ca4589c0588108159a00e", "committedDate": "2020-07-07T17:42:05Z", "message": "Add a setting to enable/disable the background discovery\n\nFix #8083\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>"}, "afterCommit": {"oid": "e0113c48e6b24c9c9232fa9a5345658f84d5eb61", "author": {"user": {"login": "lolodomo", "name": "lolodomo"}}, "url": "https://github.com/openhab/openhab-addons/commit/e0113c48e6b24c9c9232fa9a5345658f84d5eb61", "committedDate": "2020-07-07T17:56:56Z", "message": "Add a setting to enable/disable the background discovery\n\nFix #8083\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0MTkxNzYz", "url": "https://github.com/openhab/openhab-addons/pull/8057#pullrequestreview-444191763", "createdAt": "2020-07-07T19:36:09Z", "commit": {"oid": "e0113c48e6b24c9c9232fa9a5345658f84d5eb61"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxOTozNjowOVrOGuMyag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxOTo0NzowNFrOGuNItA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA5NzE5NA==", "bodyText": "Please put each sentence on its own line.", "url": "https://github.com/openhab/openhab-addons/pull/8057#discussion_r451097194", "createdAt": "2020-07-07T19:36:09Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.netatmo/README.md", "diffHunk": "@@ -503,10 +509,9 @@ All these channels are read only.\n ### Welcome and Presence Camera\n \n Warnings:\n-- The URL of the live snapshot is a fixed URL so the value of the channel cameraLivePictureUrl / welcomeCameraLivePictureUrl will never be updated once first set by the binding.\n-So to get a refreshed picture, you need to use the refresh parameter in your sitemap image element.\n-- Some features like the video surveillance are accessed via the local network, so it may be helpful to set a static IP address\n-for the camera within your local network.\n+\n+- The URL of the live snapshot is a fixed URL so the value of the channel cameraLivePictureUrl / welcomeCameraLivePictureUrl will never be updated once first set by the binding. So to get a refreshed picture, you need to use the refresh parameter in your sitemap image element.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0113c48e6b24c9c9232fa9a5345658f84d5eb61"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA5ODE0NA==", "bodyText": "Caching the bridge handler result in a local variable is much safer from a concurrency standpoint.", "url": "https://github.com/openhab/openhab-addons/pull/8057#discussion_r451098144", "createdAt": "2020-07-07T19:38:02Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/handler/AbstractNetatmoThingHandler.java", "diffHunk": "@@ -233,21 +237,30 @@ protected void updateProperties(Integer firmware, String modelId) {\n         updateProperties(properties);\n     }\n \n+    protected Optional<RadioHelper> getRadioHelper() {\n+        RadioHelper helper = radioHelper;\n+        return helper != null ? Optional.of(helper) : Optional.empty();\n+    }\n+\n+    protected Optional<BatteryHelper> getBatteryHelper() {\n+        BatteryHelper helper = batteryHelper;\n+        return helper != null ? Optional.of(helper) : Optional.empty();\n+    }\n+\n     public void updateMeasurements() {\n     }\n \n-    public void getMeasurements(String device, @Nullable String module, String scale, List<String> types,\n+    public void getMeasurements(@Nullable String device, @Nullable String module, String scale, List<String> types,\n             List<String> channels, Map<String, Float> channelMeasurements) {\n-        NetatmoBridgeHandler handler = getBridgeHandler();\n-        if (handler == null) {\n+        if (!getBridgeHandler().isPresent() || device == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0113c48e6b24c9c9232fa9a5345658f84d5eb61"}, "originalPosition": 173}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTEwMTIzNA==", "bodyText": "getBridgeHandler() and getModule() should be cached to local variables", "url": "https://github.com/openhab/openhab-addons/pull/8057#discussion_r451101234", "createdAt": "2020-07-07T19:44:03Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomePersonHandler.java", "diffHunk": "@@ -105,21 +102,20 @@ protected State getNAThingProperty(@NonNull String channelId) {\n         return super.getNAThingProperty(channelId);\n     }\n \n-    private String getLastEventURL() {\n-        NetatmoBridgeHandler bridgeHandler = getBridgeHandler();\n-        if (bridgeHandler != null && lastEvent != null && lastEvent.getSnapshot() != null) {\n-            return bridgeHandler.getPictureUrl(lastEvent.getSnapshot().getId(), lastEvent.getSnapshot().getKey());\n+    private @Nullable String getLastEventURL() {\n+        if (getBridgeHandler().isPresent() && getLastEvent().isPresent()\n+                && getLastEvent().get().getSnapshot() != null) {\n+            return getBridgeHandler().get().getPictureUrl(getLastEvent().get().getSnapshot().getId(),\n+                    getLastEvent().get().getSnapshot().getKey());\n         }\n         return null;\n     }\n \n-    private String getAvatarURL() {\n-        NetatmoBridgeHandler bridgeHandler = getBridgeHandler();\n-        NAWelcomePerson module = this.module;\n-        if (bridgeHandler != null && avatarURL == null && module != null) {\n-            NAWelcomeFace face = module.getFace();\n+    private @Nullable String getAvatarURL() {\n+        if (getBridgeHandler().isPresent() && avatarURL == null && getModule().isPresent()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0113c48e6b24c9c9232fa9a5345658f84d5eb61"}, "originalPosition": 118}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTEwMjA3Mg==", "bodyText": "getBridgeHandler() and getLastEvent() should be cached to local variables", "url": "https://github.com/openhab/openhab-addons/pull/8057#discussion_r451102072", "createdAt": "2020-07-07T19:45:39Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomePersonHandler.java", "diffHunk": "@@ -105,21 +102,20 @@ protected State getNAThingProperty(@NonNull String channelId) {\n         return super.getNAThingProperty(channelId);\n     }\n \n-    private String getLastEventURL() {\n-        NetatmoBridgeHandler bridgeHandler = getBridgeHandler();\n-        if (bridgeHandler != null && lastEvent != null && lastEvent.getSnapshot() != null) {\n-            return bridgeHandler.getPictureUrl(lastEvent.getSnapshot().getId(), lastEvent.getSnapshot().getKey());\n+    private @Nullable String getLastEventURL() {\n+        if (getBridgeHandler().isPresent() && getLastEvent().isPresent()\n+                && getLastEvent().get().getSnapshot() != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0113c48e6b24c9c9232fa9a5345658f84d5eb61"}, "originalPosition": 105}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTEwMjkwMA==", "bodyText": "you get the idea, fix wherever else it might apply.", "url": "https://github.com/openhab/openhab-addons/pull/8057#discussion_r451102900", "createdAt": "2020-07-07T19:47:04Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomePersonHandler.java", "diffHunk": "@@ -70,32 +65,34 @@ public void updateChannels(Object module) {\n                         lastEvent = event;\n                     }\n                 });\n-            }\n+            });\n \n             setRefreshRequired(false);\n         }\n         super.updateChannels(module);\n     }\n \n     @Override\n-    protected State getNAThingProperty(@NonNull String channelId) {\n-        NAWelcomePerson module = this.module;\n+    protected State getNAThingProperty(String channelId) {\n         switch (channelId) {\n             case CHANNEL_WELCOME_PERSON_LASTSEEN:\n-                return module != null ? toDateTimeType(module.getLastSeen(), timeZoneProvider.getTimeZone())\n-                        : UnDefType.UNDEF;\n+                return getModule().map(m -> toDateTimeType(m.getLastSeen(), timeZoneProvider.getTimeZone()))\n+                        .orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_PERSON_ATHOME:\n-                return module != null ? module.getOutOfSight() ? OnOffType.OFF : OnOffType.ON : UnDefType.UNDEF;\n+                return getModule()\n+                        .map(m -> m.getOutOfSight() != null ? toOnOffType(!m.getOutOfSight()) : UnDefType.UNDEF)\n+                        .orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_PERSON_AVATAR_URL:\n                 return toStringType(getAvatarURL());\n             case CHANNEL_WELCOME_PERSON_AVATAR:\n                 return getAvatarURL() != null ? HttpUtil.downloadImage(getAvatarURL()) : UnDefType.UNDEF;\n             case CHANNEL_WELCOME_PERSON_LASTMESSAGE:\n-                return (lastEvent != null && lastEvent.getMessage() != null)\n-                        ? toStringType(lastEvent.getMessage().replace(\"<b>\", \"\").replace(\"</b>\", \"\"))\n+                return (getLastEvent().isPresent() && getLastEvent().get().getMessage() != null)\n+                        ? toStringType(getLastEvent().get().getMessage().replace(\"<b>\", \"\").replace(\"</b>\", \"\"))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0113c48e6b24c9c9232fa9a5345658f84d5eb61"}, "originalPosition": 86}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c34133a587a4076ce25391c0788cfe51deefcfce", "author": {"user": {"login": "lolodomo", "name": "lolodomo"}}, "url": "https://github.com/openhab/openhab-addons/commit/c34133a587a4076ce25391c0788cfe51deefcfce", "committedDate": "2020-07-08T13:54:03Z", "message": "Cache Optional result in local variable\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2MDEwODc1", "url": "https://github.com/openhab/openhab-addons/pull/8057#pullrequestreview-446010875", "createdAt": "2020-07-09T22:28:50Z", "commit": {"oid": "c34133a587a4076ce25391c0788cfe51deefcfce"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 89, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}