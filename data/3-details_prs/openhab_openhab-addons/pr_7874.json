{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMwNzA3NjMy", "number": 7874, "title": "[wemo] Do http (not port) ping to determine if wemo port is alive", "bodyText": "When the wemo changes its service port, it sometimes doesn't close the old one. The wemo binding relied on a simple connect() to figure out if the service was available.  Since the wemo tends to increase the port number upon changing, the first port that the binding would hit was inactive, and this would never correct itself even when the binding was restarted since the problem is on the wemo side (the lower numbered port would still not be valid)\nThis changes the logic to use a real http request that forces the wemo to respond with something. The bad port will not reply with anything other than just accepting.\nOld behavior would look something like the following:\n07-Jun-2020 21:27:04.210 [TRACE] [.openhab.binding.wemo.internal.handler.WemoHandler] - Ping WeMo device at '/192.168.1.200:49151'\n07-Jun-2020 21:27:04.217 [TRACE] [.openhab.binding.wemo.internal.handler.WemoHandler] - Ping WeMo device at '/192.168.1.200:49152'\n07-Jun-2020 21:27:04.222 [TRACE] [.openhab.binding.wemo.internal.handler.WemoHandler] - Ping WeMo device at '/192.168.1.200:49153'\n07-Jun-2020 21:27:04.227 [TRACE] [.openhab.binding.wemo.internal.handler.WemoHandler] - WeMo device Lightswitch-1_0-221413K13013CB responded at Port 49153\n07-Jun-2020 21:27:06.235 [DEBUG] [rg.openhab.binding.wemo.internal.http.WemoHttpCall] - Could not make HTTP call to WeMo\n\nHowever if an SSDP was issued it would show the correct port:\nHTTP/1.1 200 OK\nCACHE-CONTROL: max-age=86400\nDATE: Mon, 08 Jun 2020 01:31:34 GMT\nEXT:\nLOCATION: http://192.168.1.200:49154/setup.xml\nOPT: \"http://schemas.upnp.org/upnp/1/0/\"; ns=01\n01-NLS: c8a56a96-1dd1-11b2-befd-9672c2c999e0\nSERVER: Unspecified, UPnP/1.0, Unspecified\nX-User-Agent: redsonic\nST: upnp:rootdevice\nUSN: uuid:Lightswitch-1_0-221413K13013CB::upnp:rootdevice\n\nThe new behavior will correctly determine the port:\n23:57:20.668 [thingHandler-42] TRACE o.o.b.w.internal.handler.WemoHandler:497 - Ping WeMo device at '192.168.1.200:49151'\n23:57:20.919 [thingHandler-42] TRACE o.o.b.w.internal.handler.WemoHandler:497 - Ping WeMo device at '192.168.1.200:49152'\n23:57:21.171 [thingHandler-42] TRACE o.o.b.w.internal.handler.WemoHandler:497 - Ping WeMo device at '192.168.1.200:49153'\n23:57:21.422 [thingHandler-42] TRACE o.o.b.w.internal.handler.WemoHandler:497 - Ping WeMo device at '192.168.1.200:49154'\n23:57:21.430 [thingHandler-42] TRACE o.o.b.w.internal.handler.WemoHandler:470 - WeMo device Lightswitch-1_0-221413K13013CB responded at Port 49154\n23:57:21.430 [thingHandler-42] TRACE o.o.b.w.internal.handler.WemoHandler:478 - WeMo url http://192.168.1.200:49154/upnp/control/basicevent1", "createdAt": "2020-06-08T04:35:28Z", "url": "https://github.com/openhab/openhab-addons/pull/7874", "merged": true, "mergeCommit": {"oid": "184726b25914f1637ce10e189851c53cd713a7ca"}, "closed": true, "closedAt": "2020-06-09T15:54:50Z", "author": {"login": "billfor"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpJw8dgBqjM0MTgxNzcwMzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcpnKQwgFqTQyNzMwODU4NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "91777d8feb7497958b4d0df696753356cf65317a", "author": {"user": {"login": "billfor", "name": null}}, "url": "https://github.com/openhab/openhab-addons/commit/91777d8feb7497958b4d0df696753356cf65317a", "committedDate": "2020-06-08T04:03:20Z", "message": "do http not icmp ping"}, "afterCommit": {"oid": "acdf75150cdb4e9d647b90a19ed1bff63231bb44", "author": {"user": {"login": "billfor", "name": null}}, "url": "https://github.com/openhab/openhab-addons/commit/acdf75150cdb4e9d647b90a19ed1bff63231bb44", "committedDate": "2020-06-08T04:08:30Z", "message": "Poll using http not icmp\nSigned-off-by: Bill Forsyth <bf@cyrenica.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1OTMwNDcz", "url": "https://github.com/openhab/openhab-addons/pull/7874#pullrequestreview-425930473", "createdAt": "2020-06-08T05:52:24Z", "commit": {"oid": "acdf75150cdb4e9d647b90a19ed1bff63231bb44"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwNTo1MjoyNFrOGgP_jA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwNTo1Mzo1N1rOGgQBTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ2OTY0NA==", "bodyText": "Please remove the commented out code", "url": "https://github.com/openhab/openhab-addons/pull/7874#discussion_r436469644", "createdAt": "2020-06-08T05:52:24Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.wemo/src/main/java/org/openhab/binding/wemo/internal/handler/WemoHandler.java", "diffHunk": "@@ -480,20 +475,32 @@ public String getWemoURL(String actionService) {\n                 }\n             }\n             wemoURL = \"http://\" + host + \":\" + port + \"/upnp/control/\" + actionService + \"1\";\n+            logger.trace(\"WeMo url {}\", wemoURL);\n             return wemoURL;\n         }\n         return wemoURL;\n     }\n \n     public boolean servicePing(String host, int port) throws IOException {\n-        SocketAddress socketAddress = new InetSocketAddress(host, port);\n-        try (Socket socket = new Socket()) {\n-            logger.trace(\"Ping WeMo device at '{}'\", socketAddress);\n-            socket.connect(socketAddress, 250);\n-            return true;\n-        } catch (ConnectException | SocketTimeoutException | NoRouteToHostException ignored) {\n+        // SocketAddress socketAddress = new InetSocketAddress(host, port);\n+        // try (Socket socket = new Socket()) {\n+        // logger.trace(\"Ping WeMo device at '{}'\", socketAddress);\n+        // socket.connect(socketAddress, 250);\n+        // return true;\n+        // } catch (ConnectException | SocketTimeoutException | NoRouteToHostException ignored) {\n+        // return false;\n+        // }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "acdf75150cdb4e9d647b90a19ed1bff63231bb44"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ3MDA5Mw==", "bodyText": "So IOException this would never get thrown now right?", "url": "https://github.com/openhab/openhab-addons/pull/7874#discussion_r436470093", "createdAt": "2020-06-08T05:53:57Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.wemo/src/main/java/org/openhab/binding/wemo/internal/handler/WemoHandler.java", "diffHunk": "@@ -480,20 +475,32 @@ public String getWemoURL(String actionService) {\n                 }\n             }\n             wemoURL = \"http://\" + host + \":\" + port + \"/upnp/control/\" + actionService + \"1\";\n+            logger.trace(\"WeMo url {}\", wemoURL);\n             return wemoURL;\n         }\n         return wemoURL;\n     }\n \n     public boolean servicePing(String host, int port) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "acdf75150cdb4e9d647b90a19ed1bff63231bb44"}, "originalPosition": 31}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "acdf75150cdb4e9d647b90a19ed1bff63231bb44", "author": {"user": {"login": "billfor", "name": null}}, "url": "https://github.com/openhab/openhab-addons/commit/acdf75150cdb4e9d647b90a19ed1bff63231bb44", "committedDate": "2020-06-08T04:08:30Z", "message": "Poll using http not icmp\nSigned-off-by: Bill Forsyth <bf@cyrenica.com>"}, "afterCommit": {"oid": "e4d87efa22c92dd77f55535a08f1906ef539a09d", "author": {"user": {"login": "billfor", "name": null}}, "url": "https://github.com/openhab/openhab-addons/commit/e4d87efa22c92dd77f55535a08f1906ef539a09d", "committedDate": "2020-06-08T15:26:02Z", "message": "Poll using http not icmp\n\nSigned-off-by: bill <bf@cyrenica.com>\nSigned-off-by: bill <forbill.mail@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e4d87efa22c92dd77f55535a08f1906ef539a09d", "author": {"user": {"login": "billfor", "name": null}}, "url": "https://github.com/openhab/openhab-addons/commit/e4d87efa22c92dd77f55535a08f1906ef539a09d", "committedDate": "2020-06-08T15:26:02Z", "message": "Poll using http not icmp\n\nSigned-off-by: bill <bf@cyrenica.com>\nSigned-off-by: bill <forbill.mail@gmail.com>"}, "afterCommit": {"oid": "c2e72227629d5d02f29ee48a91661b919c417dae", "author": {"user": {"login": "billfor", "name": null}}, "url": "https://github.com/openhab/openhab-addons/commit/c2e72227629d5d02f29ee48a91661b919c417dae", "committedDate": "2020-06-08T15:28:38Z", "message": "Poll using http not icmp\n\nSigned-off-by: bill <bf@cyrenica.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c0f1c87d8486e80e41ddb81787a6e4f0fdfe4a4", "author": {"user": {"login": "billfor", "name": null}}, "url": "https://github.com/openhab/openhab-addons/commit/8c0f1c87d8486e80e41ddb81787a6e4f0fdfe4a4", "committedDate": "2020-06-08T15:35:47Z", "message": "Poll using http not icmp\n\nSigned-off-by: bill <forbill.mail@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c2e72227629d5d02f29ee48a91661b919c417dae", "author": {"user": {"login": "billfor", "name": null}}, "url": "https://github.com/openhab/openhab-addons/commit/c2e72227629d5d02f29ee48a91661b919c417dae", "committedDate": "2020-06-08T15:28:38Z", "message": "Poll using http not icmp\n\nSigned-off-by: bill <bf@cyrenica.com>"}, "afterCommit": {"oid": "8c0f1c87d8486e80e41ddb81787a6e4f0fdfe4a4", "author": {"user": {"login": "billfor", "name": null}}, "url": "https://github.com/openhab/openhab-addons/commit/8c0f1c87d8486e80e41ddb81787a6e4f0fdfe4a4", "committedDate": "2020-06-08T15:35:47Z", "message": "Poll using http not icmp\n\nSigned-off-by: bill <forbill.mail@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb75e119f89b01934cd63a09ef4d45c4fabf911c", "author": {"user": {"login": "billfor", "name": null}}, "url": "https://github.com/openhab/openhab-addons/commit/eb75e119f89b01934cd63a09ef4d45c4fabf911c", "committedDate": "2020-06-08T21:37:11Z", "message": "remove throw\n\nSigned-off-by: bill <forbill.mail@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3MzA4NTg1", "url": "https://github.com/openhab/openhab-addons/pull/7874#pullrequestreview-427308585", "createdAt": "2020-06-09T15:54:29Z", "commit": {"oid": "eb75e119f89b01934cd63a09ef4d45c4fabf911c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 542, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}