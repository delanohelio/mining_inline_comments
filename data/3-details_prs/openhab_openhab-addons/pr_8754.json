{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAzNTUxNjc5", "number": 8754, "title": "[touchwand] Touchwand Binding initial contribution  - migration to OH3 ", "bodyText": "TouchWand Wanderfull controller binding initial contribution\n[touchwand][WIP] initial contribution\nThis is OH3 PR migration from PR #6310 \nTouchwand Wanderfull\u2122 Hub basic is a plug & play Z-Wave based controller that uses Wi-Fi and Bluetooth to easily connect all smart home components.\nThe binding allow to connect to Touchwand Wanderfull hub and control shutters switches dimmers and wallcontrollers\nTouchWand website\nThis is initial contribution , currently the binding supports\n\nTouchwand Hub auto discovery\nUnits auto discovery\nSwitches\nShutters\nDimmers", "createdAt": "2020-10-14T18:09:47Z", "url": "https://github.com/openhab/openhab-addons/pull/8754", "merged": true, "mergeCommit": {"oid": "7cd5510a727d1c3c7333665775127a48b25cbf02"}, "closed": true, "closedAt": "2020-10-18T00:19:41Z", "author": {"login": "roieg"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSfSjwAH2gAyNTAzNTUxNjc5OmJjNWRjOWQ3OGFjZmE3OGU1MzZmMTI1ODRjMTE5YmQxYjllYWNjNzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdTgq7jgFqTUxMTAxMTgzNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bc5dc9d78acfa78e536f12584c119bd1b9eacc79", "author": {"user": {"login": "roieg", "name": "Roie Geron"}}, "url": "https://github.com/openhab/openhab-addons/commit/bc5dc9d78acfa78e536f12584c119bd1b9eacc79", "committedDate": "2020-10-14T15:55:12Z", "message": "initial migration to OH 3\n\nSigned-off-by: Roie Geron <roie.geron@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43e2ee5f57c9f741a09cb270d38da6b8b112c30e", "author": {"user": {"login": "roieg", "name": "Roie Geron"}}, "url": "https://github.com/openhab/openhab-addons/commit/43e2ee5f57c9f741a09cb270d38da6b8b112c30e", "committedDate": "2020-10-14T17:57:08Z", "message": "fix tab in pom.xml\nadd to codeowners\n\nSigned-off-by: Roie Geron <roie.geron@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5NjMzOTAx", "url": "https://github.com/openhab/openhab-addons/pull/8754#pullrequestreview-509633901", "createdAt": "2020-10-15T17:59:03Z", "commit": {"oid": "43e2ee5f57c9f741a09cb270d38da6b8b112c30e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5ODMzMDg0", "url": "https://github.com/openhab/openhab-addons/pull/8754#pullrequestreview-509833084", "createdAt": "2020-10-15T21:48:25Z", "commit": {"oid": "43e2ee5f57c9f741a09cb270d38da6b8b112c30e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQyMTo0ODoyNlrOHicpzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQyMjozNzoxOVrOHid3kA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg4MzA4NA==", "bodyText": "Add \"id\" as constant in your binding constants class then use the constant instead.", "url": "https://github.com/openhab/openhab-addons/pull/8754#discussion_r505883084", "createdAt": "2020-10-15T21:48:26Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.touchwand/src/main/java/org/openhab/binding/touchwand/internal/TouchWandBaseUnitHandler.java", "diffHunk": "@@ -0,0 +1,161 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.touchwand.internal;\n+\n+import static org.openhab.binding.touchwand.internal.TouchWandBindingConstants.*;\n+\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.openhab.binding.touchwand.internal.dto.TouchWandUnitData;\n+import org.openhab.core.thing.Bridge;\n+import org.openhab.core.thing.ChannelUID;\n+import org.openhab.core.thing.Thing;\n+import org.openhab.core.thing.ThingStatus;\n+import org.openhab.core.thing.ThingStatusDetail;\n+import org.openhab.core.thing.ThingTypeUID;\n+import org.openhab.core.thing.binding.BaseThingHandler;\n+import org.openhab.core.types.Command;\n+import org.openhab.core.types.RefreshType;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParseException;\n+import com.google.gson.JsonParser;\n+\n+/**\n+ * The {@link TouchWandBaseUnitHandler} is responsible for handling commands and status updates\n+ * for TouchWand units. This is an abstract class , units should implement the specific command\n+ * handling and status updates.\n+ *\n+ * @author Roie Geron - Initial contribution\n+ *\n+ */\n+@NonNullByDefault\n+public abstract class TouchWandBaseUnitHandler extends BaseThingHandler implements TouchWandUnitUpdateListener {\n+\n+    protected final Logger logger = LoggerFactory.getLogger(TouchWandBaseUnitHandler.class);\n+    public static final Set<ThingTypeUID> SUPPORTED_THING_TYPES = new HashSet<>(\n+            Arrays.asList(THING_TYPE_SHUTTER, THING_TYPE_SWITCH, THING_TYPE_WALLCONTROLLER, THING_TYPE_DIMMER));\n+\n+    protected String unitId = \"\";\n+\n+    @Nullable\n+    protected TouchWandBridgeHandler bridgeHandler;\n+\n+    public TouchWandBaseUnitHandler(Thing thing) {\n+        super(thing);\n+    }\n+\n+    @Override\n+    public void handleCommand(ChannelUID channelUID, Command command) {\n+        if (command instanceof RefreshType) {\n+            // updateTouchWandUnitState(getUnitState(unitId));\n+        } else {\n+            touchWandUnitHandleCommand(command);\n+        }\n+    }\n+\n+    @Override\n+    public void dispose() {\n+        TouchWandBridgeHandler myTmpBridgeHandler = bridgeHandler;\n+        if (myTmpBridgeHandler != null) {\n+            myTmpBridgeHandler.unregisterUpdateListener(this);\n+        }\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        Bridge bridge = getBridge();\n+        if (bridge == null || !(bridge.getHandler() instanceof TouchWandBridgeHandler)) {\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.BRIDGE_OFFLINE);\n+            logger.warn(\"Trying to initialize {} without a bridge\", getThing().getUID());\n+            return;\n+        }\n+\n+        bridgeHandler = (TouchWandBridgeHandler) bridge.getHandler();\n+\n+        unitId = getThing().getProperties().get(\"id\"); // TouchWand unit id", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43e2ee5f57c9f741a09cb270d38da6b8b112c30e"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg4MzU1Ng==", "bodyText": "same with \"name\"", "url": "https://github.com/openhab/openhab-addons/pull/8754#discussion_r505883556", "createdAt": "2020-10-15T21:48:58Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.touchwand/src/main/java/org/openhab/binding/touchwand/internal/discovery/TouchWandUnitDiscoveryService.java", "diffHunk": "@@ -0,0 +1,224 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+\n+package org.openhab.binding.touchwand.internal.discovery;\n+\n+import static org.openhab.binding.touchwand.internal.TouchWandBindingConstants.*;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Date;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.jdt.annotation.NonNull;\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.openhab.binding.touchwand.internal.TouchWandBridgeHandler;\n+import org.openhab.binding.touchwand.internal.TouchWandUnitStatusUpdateListener;\n+import org.openhab.binding.touchwand.internal.dto.TouchWandUnitData;\n+import org.openhab.binding.touchwand.internal.dto.TouchWandUnitFromJson;\n+import org.openhab.core.config.discovery.AbstractDiscoveryService;\n+import org.openhab.core.config.discovery.DiscoveryResultBuilder;\n+import org.openhab.core.config.discovery.DiscoveryService;\n+import org.openhab.core.thing.ThingStatus;\n+import org.openhab.core.thing.ThingTypeUID;\n+import org.openhab.core.thing.ThingUID;\n+import org.openhab.core.thing.binding.ThingHandler;\n+import org.openhab.core.thing.binding.ThingHandlerService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonParser;\n+import com.google.gson.JsonSyntaxException;\n+\n+/**\n+ * The {@link TouchWandUnitDiscoveryService} Discovery service for TouchWand units.\n+ *\n+ * @author Roie Geron - Initial contribution\n+ */\n+@NonNullByDefault\n+public class TouchWandUnitDiscoveryService extends AbstractDiscoveryService\n+        implements DiscoveryService, ThingHandlerService {\n+\n+    private static final int SEARCH_TIME_SEC = 10;\n+    private static final int SCAN_INTERVAL_SEC = 60;\n+    private static final int LINK_DISCOVERY_SERVICE_INITIAL_DELAY_SEC = 5;\n+    private static final String[] CONNECTIVITY_OPTIONS = { \"zwave\", \"knx\" };\n+    private @NonNullByDefault({}) TouchWandBridgeHandler touchWandBridgeHandler;\n+    private final Logger logger = LoggerFactory.getLogger(TouchWandUnitDiscoveryService.class);\n+\n+    private @Nullable ScheduledFuture<?> scanningJob;\n+    private List<TouchWandUnitStatusUpdateListener> listeners = new ArrayList<>();\n+\n+    public TouchWandUnitDiscoveryService() {\n+        super(SUPPORTED_THING_TYPES_UIDS, SEARCH_TIME_SEC, true);\n+    }\n+\n+    @Override\n+    protected void startScan() {\n+        if (touchWandBridgeHandler.getThing().getStatus() != ThingStatus.ONLINE) {\n+            logger.warn(\"Could not scan units while bridge offline\");\n+            return;\n+        }\n+\n+        logger.debug(\"Starting TouchWand discovery on bridge {}\", touchWandBridgeHandler.getThing().getUID());\n+        String response = touchWandBridgeHandler.touchWandClient.cmdListUnits();\n+        if (response.isEmpty()) {\n+            return;\n+        }\n+\n+        JsonParser jsonParser = new JsonParser();\n+        try {\n+            JsonArray jsonArray = jsonParser.parse(response).getAsJsonArray();\n+            if (jsonArray.isJsonArray()) {\n+                try {\n+                    for (JsonElement unit : jsonArray) {\n+                        TouchWandUnitData touchWandUnit;\n+                        touchWandUnit = TouchWandUnitFromJson.parseResponse(unit.getAsJsonObject());\n+                        if (touchWandUnit == null) {\n+                            continue;\n+                        }\n+                        if (!touchWandBridgeHandler.isAddSecondaryControllerUnits()) {\n+                            if (!Arrays.asList(CONNECTIVITY_OPTIONS).contains(touchWandUnit.getConnectivity())) {\n+                                continue;\n+                            }\n+                        }\n+                        String type = touchWandUnit.getType();\n+                        if (!Arrays.asList(SUPPORTED_TOUCHWAND_TYPES).contains(type)) {\n+                            logger.debug(\"Unit discovery skipping unsupported unit type : {} \", type);\n+                            continue;\n+                        }\n+                        switch (type) {\n+                            case TYPE_WALLCONTROLLER:\n+                                addDeviceDiscoveryResult(touchWandUnit, THING_TYPE_WALLCONTROLLER);\n+                                break;\n+                            case TYPE_SWITCH:\n+                                addDeviceDiscoveryResult(touchWandUnit, THING_TYPE_SWITCH);\n+                                notifyListeners(touchWandUnit);\n+                                break;\n+                            case TYPE_DIMMER:\n+                                addDeviceDiscoveryResult(touchWandUnit, THING_TYPE_DIMMER);\n+                                notifyListeners(touchWandUnit);\n+                                break;\n+                            case TYPE_SHUTTER:\n+                                addDeviceDiscoveryResult(touchWandUnit, THING_TYPE_SHUTTER);\n+                                break;\n+                            default:\n+                                continue;\n+                        }\n+                    }\n+                } catch (JsonSyntaxException e) {\n+                    logger.warn(\"Could not parse unit {}\", e.getMessage());\n+                }\n+            }\n+        } catch (JsonSyntaxException msg) {\n+            logger.warn(\"Could not parse list units response {}\", msg.getMessage());\n+        }\n+    }\n+\n+    private void notifyListeners(TouchWandUnitData touchWandUnit) {\n+        for (TouchWandUnitStatusUpdateListener listener : listeners) {\n+            listener.onDataReceived(touchWandUnit);\n+        }\n+    }\n+\n+    @Override\n+    protected synchronized void stopScan() {\n+        removeOlderResults(getTimestampOfLastScan());\n+        super.stopScan();\n+    }\n+\n+    @Override\n+    public void activate() {\n+        super.activate(null);\n+        removeOlderResults(new Date().getTime(), touchWandBridgeHandler.getThing().getUID());\n+    }\n+\n+    @Override\n+    public void deactivate() {\n+        removeOlderResults(System.currentTimeMillis(), touchWandBridgeHandler.getThing().getUID());\n+        super.deactivate();\n+    }\n+\n+    @Override\n+    protected void startBackgroundDiscovery() {\n+        ScheduledFuture<?> localScanningJob = scanningJob;\n+        if (localScanningJob == null || localScanningJob.isCancelled()) {\n+            scanningJob = scheduler.scheduleWithFixedDelay(this::startScan, LINK_DISCOVERY_SERVICE_INITIAL_DELAY_SEC,\n+                    SCAN_INTERVAL_SEC, TimeUnit.SECONDS);\n+        }\n+    }\n+\n+    @Override\n+    protected void stopBackgroundDiscovery() {\n+        ScheduledFuture<?> myScanningJob = scanningJob;\n+        if (myScanningJob != null) {\n+            myScanningJob.cancel(true);\n+            scanningJob = null;\n+        }\n+    }\n+\n+    public synchronized void registerListener(TouchWandUnitStatusUpdateListener listener) {\n+        if (!listeners.contains(listener)) {\n+            logger.debug(\"Adding TouchWandWebSocket listener {}\", listener);\n+            listeners.add(listener);\n+        }\n+    }\n+\n+    public synchronized void unregisterListener(TouchWandUnitStatusUpdateListener listener) {\n+        logger.debug(\"Removing TouchWandWebSocket listener {}\", listener);\n+        listeners.remove(listener);\n+    }\n+\n+    @Override\n+    public int getScanTimeout() {\n+        return SEARCH_TIME_SEC;\n+    }\n+\n+    private void addDeviceDiscoveryResult(TouchWandUnitData unit, ThingTypeUID typeUID) {\n+        ThingUID bridgeUID = touchWandBridgeHandler.getThing().getUID();\n+        ThingUID thingUID = new ThingUID(typeUID, bridgeUID, unit.getId().toString());\n+        Map<String, Object> properties = new HashMap<>();\n+        properties.put(\"id\", unit.getId().toString());\n+        properties.put(\"name\", unit.getName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43e2ee5f57c9f741a09cb270d38da6b8b112c30e"}, "originalPosition": 199}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg4NTA4NQ==", "bodyText": "Why are you using new Date().getTime() on one but System.currentTimeMillis() on the other?", "url": "https://github.com/openhab/openhab-addons/pull/8754#discussion_r505885085", "createdAt": "2020-10-15T21:51:04Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.touchwand/src/main/java/org/openhab/binding/touchwand/internal/discovery/TouchWandUnitDiscoveryService.java", "diffHunk": "@@ -0,0 +1,224 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+\n+package org.openhab.binding.touchwand.internal.discovery;\n+\n+import static org.openhab.binding.touchwand.internal.TouchWandBindingConstants.*;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Date;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.jdt.annotation.NonNull;\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.openhab.binding.touchwand.internal.TouchWandBridgeHandler;\n+import org.openhab.binding.touchwand.internal.TouchWandUnitStatusUpdateListener;\n+import org.openhab.binding.touchwand.internal.dto.TouchWandUnitData;\n+import org.openhab.binding.touchwand.internal.dto.TouchWandUnitFromJson;\n+import org.openhab.core.config.discovery.AbstractDiscoveryService;\n+import org.openhab.core.config.discovery.DiscoveryResultBuilder;\n+import org.openhab.core.config.discovery.DiscoveryService;\n+import org.openhab.core.thing.ThingStatus;\n+import org.openhab.core.thing.ThingTypeUID;\n+import org.openhab.core.thing.ThingUID;\n+import org.openhab.core.thing.binding.ThingHandler;\n+import org.openhab.core.thing.binding.ThingHandlerService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonParser;\n+import com.google.gson.JsonSyntaxException;\n+\n+/**\n+ * The {@link TouchWandUnitDiscoveryService} Discovery service for TouchWand units.\n+ *\n+ * @author Roie Geron - Initial contribution\n+ */\n+@NonNullByDefault\n+public class TouchWandUnitDiscoveryService extends AbstractDiscoveryService\n+        implements DiscoveryService, ThingHandlerService {\n+\n+    private static final int SEARCH_TIME_SEC = 10;\n+    private static final int SCAN_INTERVAL_SEC = 60;\n+    private static final int LINK_DISCOVERY_SERVICE_INITIAL_DELAY_SEC = 5;\n+    private static final String[] CONNECTIVITY_OPTIONS = { \"zwave\", \"knx\" };\n+    private @NonNullByDefault({}) TouchWandBridgeHandler touchWandBridgeHandler;\n+    private final Logger logger = LoggerFactory.getLogger(TouchWandUnitDiscoveryService.class);\n+\n+    private @Nullable ScheduledFuture<?> scanningJob;\n+    private List<TouchWandUnitStatusUpdateListener> listeners = new ArrayList<>();\n+\n+    public TouchWandUnitDiscoveryService() {\n+        super(SUPPORTED_THING_TYPES_UIDS, SEARCH_TIME_SEC, true);\n+    }\n+\n+    @Override\n+    protected void startScan() {\n+        if (touchWandBridgeHandler.getThing().getStatus() != ThingStatus.ONLINE) {\n+            logger.warn(\"Could not scan units while bridge offline\");\n+            return;\n+        }\n+\n+        logger.debug(\"Starting TouchWand discovery on bridge {}\", touchWandBridgeHandler.getThing().getUID());\n+        String response = touchWandBridgeHandler.touchWandClient.cmdListUnits();\n+        if (response.isEmpty()) {\n+            return;\n+        }\n+\n+        JsonParser jsonParser = new JsonParser();\n+        try {\n+            JsonArray jsonArray = jsonParser.parse(response).getAsJsonArray();\n+            if (jsonArray.isJsonArray()) {\n+                try {\n+                    for (JsonElement unit : jsonArray) {\n+                        TouchWandUnitData touchWandUnit;\n+                        touchWandUnit = TouchWandUnitFromJson.parseResponse(unit.getAsJsonObject());\n+                        if (touchWandUnit == null) {\n+                            continue;\n+                        }\n+                        if (!touchWandBridgeHandler.isAddSecondaryControllerUnits()) {\n+                            if (!Arrays.asList(CONNECTIVITY_OPTIONS).contains(touchWandUnit.getConnectivity())) {\n+                                continue;\n+                            }\n+                        }\n+                        String type = touchWandUnit.getType();\n+                        if (!Arrays.asList(SUPPORTED_TOUCHWAND_TYPES).contains(type)) {\n+                            logger.debug(\"Unit discovery skipping unsupported unit type : {} \", type);\n+                            continue;\n+                        }\n+                        switch (type) {\n+                            case TYPE_WALLCONTROLLER:\n+                                addDeviceDiscoveryResult(touchWandUnit, THING_TYPE_WALLCONTROLLER);\n+                                break;\n+                            case TYPE_SWITCH:\n+                                addDeviceDiscoveryResult(touchWandUnit, THING_TYPE_SWITCH);\n+                                notifyListeners(touchWandUnit);\n+                                break;\n+                            case TYPE_DIMMER:\n+                                addDeviceDiscoveryResult(touchWandUnit, THING_TYPE_DIMMER);\n+                                notifyListeners(touchWandUnit);\n+                                break;\n+                            case TYPE_SHUTTER:\n+                                addDeviceDiscoveryResult(touchWandUnit, THING_TYPE_SHUTTER);\n+                                break;\n+                            default:\n+                                continue;\n+                        }\n+                    }\n+                } catch (JsonSyntaxException e) {\n+                    logger.warn(\"Could not parse unit {}\", e.getMessage());\n+                }\n+            }\n+        } catch (JsonSyntaxException msg) {\n+            logger.warn(\"Could not parse list units response {}\", msg.getMessage());\n+        }\n+    }\n+\n+    private void notifyListeners(TouchWandUnitData touchWandUnit) {\n+        for (TouchWandUnitStatusUpdateListener listener : listeners) {\n+            listener.onDataReceived(touchWandUnit);\n+        }\n+    }\n+\n+    @Override\n+    protected synchronized void stopScan() {\n+        removeOlderResults(getTimestampOfLastScan());\n+        super.stopScan();\n+    }\n+\n+    @Override\n+    public void activate() {\n+        super.activate(null);\n+        removeOlderResults(new Date().getTime(), touchWandBridgeHandler.getThing().getUID());\n+    }\n+\n+    @Override\n+    public void deactivate() {\n+        removeOlderResults(System.currentTimeMillis(), touchWandBridgeHandler.getThing().getUID());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43e2ee5f57c9f741a09cb270d38da6b8b112c30e"}, "originalPosition": 155}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg4NjExNw==", "bodyText": "Please remove the synchronization on these methods and change your listeners implementation to a CopyOnWriteArraySet instead.", "url": "https://github.com/openhab/openhab-addons/pull/8754#discussion_r505886117", "createdAt": "2020-10-15T21:52:48Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.touchwand/src/main/java/org/openhab/binding/touchwand/internal/discovery/TouchWandUnitDiscoveryService.java", "diffHunk": "@@ -0,0 +1,224 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+\n+package org.openhab.binding.touchwand.internal.discovery;\n+\n+import static org.openhab.binding.touchwand.internal.TouchWandBindingConstants.*;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Date;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.jdt.annotation.NonNull;\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.openhab.binding.touchwand.internal.TouchWandBridgeHandler;\n+import org.openhab.binding.touchwand.internal.TouchWandUnitStatusUpdateListener;\n+import org.openhab.binding.touchwand.internal.dto.TouchWandUnitData;\n+import org.openhab.binding.touchwand.internal.dto.TouchWandUnitFromJson;\n+import org.openhab.core.config.discovery.AbstractDiscoveryService;\n+import org.openhab.core.config.discovery.DiscoveryResultBuilder;\n+import org.openhab.core.config.discovery.DiscoveryService;\n+import org.openhab.core.thing.ThingStatus;\n+import org.openhab.core.thing.ThingTypeUID;\n+import org.openhab.core.thing.ThingUID;\n+import org.openhab.core.thing.binding.ThingHandler;\n+import org.openhab.core.thing.binding.ThingHandlerService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonParser;\n+import com.google.gson.JsonSyntaxException;\n+\n+/**\n+ * The {@link TouchWandUnitDiscoveryService} Discovery service for TouchWand units.\n+ *\n+ * @author Roie Geron - Initial contribution\n+ */\n+@NonNullByDefault\n+public class TouchWandUnitDiscoveryService extends AbstractDiscoveryService\n+        implements DiscoveryService, ThingHandlerService {\n+\n+    private static final int SEARCH_TIME_SEC = 10;\n+    private static final int SCAN_INTERVAL_SEC = 60;\n+    private static final int LINK_DISCOVERY_SERVICE_INITIAL_DELAY_SEC = 5;\n+    private static final String[] CONNECTIVITY_OPTIONS = { \"zwave\", \"knx\" };\n+    private @NonNullByDefault({}) TouchWandBridgeHandler touchWandBridgeHandler;\n+    private final Logger logger = LoggerFactory.getLogger(TouchWandUnitDiscoveryService.class);\n+\n+    private @Nullable ScheduledFuture<?> scanningJob;\n+    private List<TouchWandUnitStatusUpdateListener> listeners = new ArrayList<>();\n+\n+    public TouchWandUnitDiscoveryService() {\n+        super(SUPPORTED_THING_TYPES_UIDS, SEARCH_TIME_SEC, true);\n+    }\n+\n+    @Override\n+    protected void startScan() {\n+        if (touchWandBridgeHandler.getThing().getStatus() != ThingStatus.ONLINE) {\n+            logger.warn(\"Could not scan units while bridge offline\");\n+            return;\n+        }\n+\n+        logger.debug(\"Starting TouchWand discovery on bridge {}\", touchWandBridgeHandler.getThing().getUID());\n+        String response = touchWandBridgeHandler.touchWandClient.cmdListUnits();\n+        if (response.isEmpty()) {\n+            return;\n+        }\n+\n+        JsonParser jsonParser = new JsonParser();\n+        try {\n+            JsonArray jsonArray = jsonParser.parse(response).getAsJsonArray();\n+            if (jsonArray.isJsonArray()) {\n+                try {\n+                    for (JsonElement unit : jsonArray) {\n+                        TouchWandUnitData touchWandUnit;\n+                        touchWandUnit = TouchWandUnitFromJson.parseResponse(unit.getAsJsonObject());\n+                        if (touchWandUnit == null) {\n+                            continue;\n+                        }\n+                        if (!touchWandBridgeHandler.isAddSecondaryControllerUnits()) {\n+                            if (!Arrays.asList(CONNECTIVITY_OPTIONS).contains(touchWandUnit.getConnectivity())) {\n+                                continue;\n+                            }\n+                        }\n+                        String type = touchWandUnit.getType();\n+                        if (!Arrays.asList(SUPPORTED_TOUCHWAND_TYPES).contains(type)) {\n+                            logger.debug(\"Unit discovery skipping unsupported unit type : {} \", type);\n+                            continue;\n+                        }\n+                        switch (type) {\n+                            case TYPE_WALLCONTROLLER:\n+                                addDeviceDiscoveryResult(touchWandUnit, THING_TYPE_WALLCONTROLLER);\n+                                break;\n+                            case TYPE_SWITCH:\n+                                addDeviceDiscoveryResult(touchWandUnit, THING_TYPE_SWITCH);\n+                                notifyListeners(touchWandUnit);\n+                                break;\n+                            case TYPE_DIMMER:\n+                                addDeviceDiscoveryResult(touchWandUnit, THING_TYPE_DIMMER);\n+                                notifyListeners(touchWandUnit);\n+                                break;\n+                            case TYPE_SHUTTER:\n+                                addDeviceDiscoveryResult(touchWandUnit, THING_TYPE_SHUTTER);\n+                                break;\n+                            default:\n+                                continue;\n+                        }\n+                    }\n+                } catch (JsonSyntaxException e) {\n+                    logger.warn(\"Could not parse unit {}\", e.getMessage());\n+                }\n+            }\n+        } catch (JsonSyntaxException msg) {\n+            logger.warn(\"Could not parse list units response {}\", msg.getMessage());\n+        }\n+    }\n+\n+    private void notifyListeners(TouchWandUnitData touchWandUnit) {\n+        for (TouchWandUnitStatusUpdateListener listener : listeners) {\n+            listener.onDataReceived(touchWandUnit);\n+        }\n+    }\n+\n+    @Override\n+    protected synchronized void stopScan() {\n+        removeOlderResults(getTimestampOfLastScan());\n+        super.stopScan();\n+    }\n+\n+    @Override\n+    public void activate() {\n+        super.activate(null);\n+        removeOlderResults(new Date().getTime(), touchWandBridgeHandler.getThing().getUID());\n+    }\n+\n+    @Override\n+    public void deactivate() {\n+        removeOlderResults(System.currentTimeMillis(), touchWandBridgeHandler.getThing().getUID());\n+        super.deactivate();\n+    }\n+\n+    @Override\n+    protected void startBackgroundDiscovery() {\n+        ScheduledFuture<?> localScanningJob = scanningJob;\n+        if (localScanningJob == null || localScanningJob.isCancelled()) {\n+            scanningJob = scheduler.scheduleWithFixedDelay(this::startScan, LINK_DISCOVERY_SERVICE_INITIAL_DELAY_SEC,\n+                    SCAN_INTERVAL_SEC, TimeUnit.SECONDS);\n+        }\n+    }\n+\n+    @Override\n+    protected void stopBackgroundDiscovery() {\n+        ScheduledFuture<?> myScanningJob = scanningJob;\n+        if (myScanningJob != null) {\n+            myScanningJob.cancel(true);\n+            scanningJob = null;\n+        }\n+    }\n+\n+    public synchronized void registerListener(TouchWandUnitStatusUpdateListener listener) {\n+        if (!listeners.contains(listener)) {\n+            logger.debug(\"Adding TouchWandWebSocket listener {}\", listener);\n+            listeners.add(listener);\n+        }\n+    }\n+\n+    public synchronized void unregisterListener(TouchWandUnitStatusUpdateListener listener) {\n+        logger.debug(\"Removing TouchWandWebSocket listener {}\", listener);\n+        listeners.remove(listener);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43e2ee5f57c9f741a09cb270d38da6b8b112c30e"}, "originalPosition": 187}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg4NjMyMg==", "bodyText": "use your constant here.", "url": "https://github.com/openhab/openhab-addons/pull/8754#discussion_r505886322", "createdAt": "2020-10-15T21:53:15Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.touchwand/src/main/java/org/openhab/binding/touchwand/internal/discovery/TouchWandUnitDiscoveryService.java", "diffHunk": "@@ -0,0 +1,224 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+\n+package org.openhab.binding.touchwand.internal.discovery;\n+\n+import static org.openhab.binding.touchwand.internal.TouchWandBindingConstants.*;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Date;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.jdt.annotation.NonNull;\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.openhab.binding.touchwand.internal.TouchWandBridgeHandler;\n+import org.openhab.binding.touchwand.internal.TouchWandUnitStatusUpdateListener;\n+import org.openhab.binding.touchwand.internal.dto.TouchWandUnitData;\n+import org.openhab.binding.touchwand.internal.dto.TouchWandUnitFromJson;\n+import org.openhab.core.config.discovery.AbstractDiscoveryService;\n+import org.openhab.core.config.discovery.DiscoveryResultBuilder;\n+import org.openhab.core.config.discovery.DiscoveryService;\n+import org.openhab.core.thing.ThingStatus;\n+import org.openhab.core.thing.ThingTypeUID;\n+import org.openhab.core.thing.ThingUID;\n+import org.openhab.core.thing.binding.ThingHandler;\n+import org.openhab.core.thing.binding.ThingHandlerService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonParser;\n+import com.google.gson.JsonSyntaxException;\n+\n+/**\n+ * The {@link TouchWandUnitDiscoveryService} Discovery service for TouchWand units.\n+ *\n+ * @author Roie Geron - Initial contribution\n+ */\n+@NonNullByDefault\n+public class TouchWandUnitDiscoveryService extends AbstractDiscoveryService\n+        implements DiscoveryService, ThingHandlerService {\n+\n+    private static final int SEARCH_TIME_SEC = 10;\n+    private static final int SCAN_INTERVAL_SEC = 60;\n+    private static final int LINK_DISCOVERY_SERVICE_INITIAL_DELAY_SEC = 5;\n+    private static final String[] CONNECTIVITY_OPTIONS = { \"zwave\", \"knx\" };\n+    private @NonNullByDefault({}) TouchWandBridgeHandler touchWandBridgeHandler;\n+    private final Logger logger = LoggerFactory.getLogger(TouchWandUnitDiscoveryService.class);\n+\n+    private @Nullable ScheduledFuture<?> scanningJob;\n+    private List<TouchWandUnitStatusUpdateListener> listeners = new ArrayList<>();\n+\n+    public TouchWandUnitDiscoveryService() {\n+        super(SUPPORTED_THING_TYPES_UIDS, SEARCH_TIME_SEC, true);\n+    }\n+\n+    @Override\n+    protected void startScan() {\n+        if (touchWandBridgeHandler.getThing().getStatus() != ThingStatus.ONLINE) {\n+            logger.warn(\"Could not scan units while bridge offline\");\n+            return;\n+        }\n+\n+        logger.debug(\"Starting TouchWand discovery on bridge {}\", touchWandBridgeHandler.getThing().getUID());\n+        String response = touchWandBridgeHandler.touchWandClient.cmdListUnits();\n+        if (response.isEmpty()) {\n+            return;\n+        }\n+\n+        JsonParser jsonParser = new JsonParser();\n+        try {\n+            JsonArray jsonArray = jsonParser.parse(response).getAsJsonArray();\n+            if (jsonArray.isJsonArray()) {\n+                try {\n+                    for (JsonElement unit : jsonArray) {\n+                        TouchWandUnitData touchWandUnit;\n+                        touchWandUnit = TouchWandUnitFromJson.parseResponse(unit.getAsJsonObject());\n+                        if (touchWandUnit == null) {\n+                            continue;\n+                        }\n+                        if (!touchWandBridgeHandler.isAddSecondaryControllerUnits()) {\n+                            if (!Arrays.asList(CONNECTIVITY_OPTIONS).contains(touchWandUnit.getConnectivity())) {\n+                                continue;\n+                            }\n+                        }\n+                        String type = touchWandUnit.getType();\n+                        if (!Arrays.asList(SUPPORTED_TOUCHWAND_TYPES).contains(type)) {\n+                            logger.debug(\"Unit discovery skipping unsupported unit type : {} \", type);\n+                            continue;\n+                        }\n+                        switch (type) {\n+                            case TYPE_WALLCONTROLLER:\n+                                addDeviceDiscoveryResult(touchWandUnit, THING_TYPE_WALLCONTROLLER);\n+                                break;\n+                            case TYPE_SWITCH:\n+                                addDeviceDiscoveryResult(touchWandUnit, THING_TYPE_SWITCH);\n+                                notifyListeners(touchWandUnit);\n+                                break;\n+                            case TYPE_DIMMER:\n+                                addDeviceDiscoveryResult(touchWandUnit, THING_TYPE_DIMMER);\n+                                notifyListeners(touchWandUnit);\n+                                break;\n+                            case TYPE_SHUTTER:\n+                                addDeviceDiscoveryResult(touchWandUnit, THING_TYPE_SHUTTER);\n+                                break;\n+                            default:\n+                                continue;\n+                        }\n+                    }\n+                } catch (JsonSyntaxException e) {\n+                    logger.warn(\"Could not parse unit {}\", e.getMessage());\n+                }\n+            }\n+        } catch (JsonSyntaxException msg) {\n+            logger.warn(\"Could not parse list units response {}\", msg.getMessage());\n+        }\n+    }\n+\n+    private void notifyListeners(TouchWandUnitData touchWandUnit) {\n+        for (TouchWandUnitStatusUpdateListener listener : listeners) {\n+            listener.onDataReceived(touchWandUnit);\n+        }\n+    }\n+\n+    @Override\n+    protected synchronized void stopScan() {\n+        removeOlderResults(getTimestampOfLastScan());\n+        super.stopScan();\n+    }\n+\n+    @Override\n+    public void activate() {\n+        super.activate(null);\n+        removeOlderResults(new Date().getTime(), touchWandBridgeHandler.getThing().getUID());\n+    }\n+\n+    @Override\n+    public void deactivate() {\n+        removeOlderResults(System.currentTimeMillis(), touchWandBridgeHandler.getThing().getUID());\n+        super.deactivate();\n+    }\n+\n+    @Override\n+    protected void startBackgroundDiscovery() {\n+        ScheduledFuture<?> localScanningJob = scanningJob;\n+        if (localScanningJob == null || localScanningJob.isCancelled()) {\n+            scanningJob = scheduler.scheduleWithFixedDelay(this::startScan, LINK_DISCOVERY_SERVICE_INITIAL_DELAY_SEC,\n+                    SCAN_INTERVAL_SEC, TimeUnit.SECONDS);\n+        }\n+    }\n+\n+    @Override\n+    protected void stopBackgroundDiscovery() {\n+        ScheduledFuture<?> myScanningJob = scanningJob;\n+        if (myScanningJob != null) {\n+            myScanningJob.cancel(true);\n+            scanningJob = null;\n+        }\n+    }\n+\n+    public synchronized void registerListener(TouchWandUnitStatusUpdateListener listener) {\n+        if (!listeners.contains(listener)) {\n+            logger.debug(\"Adding TouchWandWebSocket listener {}\", listener);\n+            listeners.add(listener);\n+        }\n+    }\n+\n+    public synchronized void unregisterListener(TouchWandUnitStatusUpdateListener listener) {\n+        logger.debug(\"Removing TouchWandWebSocket listener {}\", listener);\n+        listeners.remove(listener);\n+    }\n+\n+    @Override\n+    public int getScanTimeout() {\n+        return SEARCH_TIME_SEC;\n+    }\n+\n+    private void addDeviceDiscoveryResult(TouchWandUnitData unit, ThingTypeUID typeUID) {\n+        ThingUID bridgeUID = touchWandBridgeHandler.getThing().getUID();\n+        ThingUID thingUID = new ThingUID(typeUID, bridgeUID, unit.getId().toString());\n+        Map<String, Object> properties = new HashMap<>();\n+        properties.put(\"id\", unit.getId().toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43e2ee5f57c9f741a09cb270d38da6b8b112c30e"}, "originalPosition": 198}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg4NjM2MQ==", "bodyText": "and here", "url": "https://github.com/openhab/openhab-addons/pull/8754#discussion_r505886361", "createdAt": "2020-10-15T21:53:20Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.touchwand/src/main/java/org/openhab/binding/touchwand/internal/discovery/TouchWandUnitDiscoveryService.java", "diffHunk": "@@ -0,0 +1,224 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+\n+package org.openhab.binding.touchwand.internal.discovery;\n+\n+import static org.openhab.binding.touchwand.internal.TouchWandBindingConstants.*;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Date;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.jdt.annotation.NonNull;\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.openhab.binding.touchwand.internal.TouchWandBridgeHandler;\n+import org.openhab.binding.touchwand.internal.TouchWandUnitStatusUpdateListener;\n+import org.openhab.binding.touchwand.internal.dto.TouchWandUnitData;\n+import org.openhab.binding.touchwand.internal.dto.TouchWandUnitFromJson;\n+import org.openhab.core.config.discovery.AbstractDiscoveryService;\n+import org.openhab.core.config.discovery.DiscoveryResultBuilder;\n+import org.openhab.core.config.discovery.DiscoveryService;\n+import org.openhab.core.thing.ThingStatus;\n+import org.openhab.core.thing.ThingTypeUID;\n+import org.openhab.core.thing.ThingUID;\n+import org.openhab.core.thing.binding.ThingHandler;\n+import org.openhab.core.thing.binding.ThingHandlerService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonParser;\n+import com.google.gson.JsonSyntaxException;\n+\n+/**\n+ * The {@link TouchWandUnitDiscoveryService} Discovery service for TouchWand units.\n+ *\n+ * @author Roie Geron - Initial contribution\n+ */\n+@NonNullByDefault\n+public class TouchWandUnitDiscoveryService extends AbstractDiscoveryService\n+        implements DiscoveryService, ThingHandlerService {\n+\n+    private static final int SEARCH_TIME_SEC = 10;\n+    private static final int SCAN_INTERVAL_SEC = 60;\n+    private static final int LINK_DISCOVERY_SERVICE_INITIAL_DELAY_SEC = 5;\n+    private static final String[] CONNECTIVITY_OPTIONS = { \"zwave\", \"knx\" };\n+    private @NonNullByDefault({}) TouchWandBridgeHandler touchWandBridgeHandler;\n+    private final Logger logger = LoggerFactory.getLogger(TouchWandUnitDiscoveryService.class);\n+\n+    private @Nullable ScheduledFuture<?> scanningJob;\n+    private List<TouchWandUnitStatusUpdateListener> listeners = new ArrayList<>();\n+\n+    public TouchWandUnitDiscoveryService() {\n+        super(SUPPORTED_THING_TYPES_UIDS, SEARCH_TIME_SEC, true);\n+    }\n+\n+    @Override\n+    protected void startScan() {\n+        if (touchWandBridgeHandler.getThing().getStatus() != ThingStatus.ONLINE) {\n+            logger.warn(\"Could not scan units while bridge offline\");\n+            return;\n+        }\n+\n+        logger.debug(\"Starting TouchWand discovery on bridge {}\", touchWandBridgeHandler.getThing().getUID());\n+        String response = touchWandBridgeHandler.touchWandClient.cmdListUnits();\n+        if (response.isEmpty()) {\n+            return;\n+        }\n+\n+        JsonParser jsonParser = new JsonParser();\n+        try {\n+            JsonArray jsonArray = jsonParser.parse(response).getAsJsonArray();\n+            if (jsonArray.isJsonArray()) {\n+                try {\n+                    for (JsonElement unit : jsonArray) {\n+                        TouchWandUnitData touchWandUnit;\n+                        touchWandUnit = TouchWandUnitFromJson.parseResponse(unit.getAsJsonObject());\n+                        if (touchWandUnit == null) {\n+                            continue;\n+                        }\n+                        if (!touchWandBridgeHandler.isAddSecondaryControllerUnits()) {\n+                            if (!Arrays.asList(CONNECTIVITY_OPTIONS).contains(touchWandUnit.getConnectivity())) {\n+                                continue;\n+                            }\n+                        }\n+                        String type = touchWandUnit.getType();\n+                        if (!Arrays.asList(SUPPORTED_TOUCHWAND_TYPES).contains(type)) {\n+                            logger.debug(\"Unit discovery skipping unsupported unit type : {} \", type);\n+                            continue;\n+                        }\n+                        switch (type) {\n+                            case TYPE_WALLCONTROLLER:\n+                                addDeviceDiscoveryResult(touchWandUnit, THING_TYPE_WALLCONTROLLER);\n+                                break;\n+                            case TYPE_SWITCH:\n+                                addDeviceDiscoveryResult(touchWandUnit, THING_TYPE_SWITCH);\n+                                notifyListeners(touchWandUnit);\n+                                break;\n+                            case TYPE_DIMMER:\n+                                addDeviceDiscoveryResult(touchWandUnit, THING_TYPE_DIMMER);\n+                                notifyListeners(touchWandUnit);\n+                                break;\n+                            case TYPE_SHUTTER:\n+                                addDeviceDiscoveryResult(touchWandUnit, THING_TYPE_SHUTTER);\n+                                break;\n+                            default:\n+                                continue;\n+                        }\n+                    }\n+                } catch (JsonSyntaxException e) {\n+                    logger.warn(\"Could not parse unit {}\", e.getMessage());\n+                }\n+            }\n+        } catch (JsonSyntaxException msg) {\n+            logger.warn(\"Could not parse list units response {}\", msg.getMessage());\n+        }\n+    }\n+\n+    private void notifyListeners(TouchWandUnitData touchWandUnit) {\n+        for (TouchWandUnitStatusUpdateListener listener : listeners) {\n+            listener.onDataReceived(touchWandUnit);\n+        }\n+    }\n+\n+    @Override\n+    protected synchronized void stopScan() {\n+        removeOlderResults(getTimestampOfLastScan());\n+        super.stopScan();\n+    }\n+\n+    @Override\n+    public void activate() {\n+        super.activate(null);\n+        removeOlderResults(new Date().getTime(), touchWandBridgeHandler.getThing().getUID());\n+    }\n+\n+    @Override\n+    public void deactivate() {\n+        removeOlderResults(System.currentTimeMillis(), touchWandBridgeHandler.getThing().getUID());\n+        super.deactivate();\n+    }\n+\n+    @Override\n+    protected void startBackgroundDiscovery() {\n+        ScheduledFuture<?> localScanningJob = scanningJob;\n+        if (localScanningJob == null || localScanningJob.isCancelled()) {\n+            scanningJob = scheduler.scheduleWithFixedDelay(this::startScan, LINK_DISCOVERY_SERVICE_INITIAL_DELAY_SEC,\n+                    SCAN_INTERVAL_SEC, TimeUnit.SECONDS);\n+        }\n+    }\n+\n+    @Override\n+    protected void stopBackgroundDiscovery() {\n+        ScheduledFuture<?> myScanningJob = scanningJob;\n+        if (myScanningJob != null) {\n+            myScanningJob.cancel(true);\n+            scanningJob = null;\n+        }\n+    }\n+\n+    public synchronized void registerListener(TouchWandUnitStatusUpdateListener listener) {\n+        if (!listeners.contains(listener)) {\n+            logger.debug(\"Adding TouchWandWebSocket listener {}\", listener);\n+            listeners.add(listener);\n+        }\n+    }\n+\n+    public synchronized void unregisterListener(TouchWandUnitStatusUpdateListener listener) {\n+        logger.debug(\"Removing TouchWandWebSocket listener {}\", listener);\n+        listeners.remove(listener);\n+    }\n+\n+    @Override\n+    public int getScanTimeout() {\n+        return SEARCH_TIME_SEC;\n+    }\n+\n+    private void addDeviceDiscoveryResult(TouchWandUnitData unit, ThingTypeUID typeUID) {\n+        ThingUID bridgeUID = touchWandBridgeHandler.getThing().getUID();\n+        ThingUID thingUID = new ThingUID(typeUID, bridgeUID, unit.getId().toString());\n+        Map<String, Object> properties = new HashMap<>();\n+        properties.put(\"id\", unit.getId().toString());\n+        properties.put(\"name\", unit.getName());\n+        // @formatter:off\n+        thingDiscovered(DiscoveryResultBuilder.create(thingUID)\n+                .withThingType(typeUID)\n+                .withLabel(unit.getName())\n+                .withBridge(bridgeUID)\n+                .withProperties(properties)\n+                .withRepresentationProperty(\"id\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43e2ee5f57c9f741a09cb270d38da6b8b112c30e"}, "originalPosition": 206}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg4NjY5Ng==", "bodyText": "Make same change here, see above.", "url": "https://github.com/openhab/openhab-addons/pull/8754#discussion_r505886696", "createdAt": "2020-10-15T21:54:14Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.touchwand/src/main/java/org/openhab/binding/touchwand/internal/TouchWandWebSockets.java", "diffHunk": "@@ -0,0 +1,193 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.touchwand.internal;\n+\n+import static org.openhab.binding.touchwand.internal.TouchWandBindingConstants.SUPPORTED_TOUCHWAND_TYPES;\n+\n+import java.io.IOException;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.jetty.websocket.api.Session;\n+import org.eclipse.jetty.websocket.api.annotations.OnWebSocketClose;\n+import org.eclipse.jetty.websocket.api.annotations.OnWebSocketConnect;\n+import org.eclipse.jetty.websocket.api.annotations.OnWebSocketError;\n+import org.eclipse.jetty.websocket.api.annotations.OnWebSocketMessage;\n+import org.eclipse.jetty.websocket.api.annotations.WebSocket;\n+import org.eclipse.jetty.websocket.client.ClientUpgradeRequest;\n+import org.eclipse.jetty.websocket.client.WebSocketClient;\n+import org.openhab.binding.touchwand.internal.dto.TouchWandUnitData;\n+import org.openhab.binding.touchwand.internal.dto.TouchWandUnitFromJson;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParser;\n+import com.google.gson.JsonSyntaxException;\n+\n+/**\n+ * The {@link TouchWandWebSockets} class implements WebSockets API to TouchWand controller\n+ *\n+ * @author Roie Geron - Initial contribution\n+ */\n+@NonNullByDefault\n+public class TouchWandWebSockets {\n+\n+    private static final int CONNECT_TIMEOUT_SEC = 10;\n+    private static final int WEBSOCKET_RECONNECT_INTERVAL_SEC = CONNECT_TIMEOUT_SEC * 2;\n+    private static final int WEBSOCKET_IDLE_TIMEOUT_MS = CONNECT_TIMEOUT_SEC * 10 * 1000;\n+    private final Logger logger = LoggerFactory.getLogger(TouchWandWebSockets.class);\n+    private static final String WS_ENDPOINT_TOUCHWAND = \"/async\";\n+\n+    private WebSocketClient client;\n+    private String controllerAddress;\n+    private TouchWandSocket touchWandSocket;\n+    private boolean isShutDown = false;\n+    private List<TouchWandUnitStatusUpdateListener> listeners = new ArrayList<>();\n+    private @Nullable ScheduledFuture<?> socketReconnect;\n+    private @Nullable URI uri;\n+\n+    ScheduledExecutorService scheduler;\n+\n+    public TouchWandWebSockets(String ipAddress, ScheduledExecutorService scheduler) {\n+        client = new WebSocketClient();\n+        touchWandSocket = new TouchWandSocket();\n+        this.controllerAddress = ipAddress;\n+        this.scheduler = scheduler;\n+        socketReconnect = null;\n+    }\n+\n+    public void connect() {\n+        try {\n+            uri = new URI(\"ws://\" + controllerAddress + WS_ENDPOINT_TOUCHWAND);\n+        } catch (URISyntaxException e) {\n+            logger.warn(\"URI not valid {} message {}\", uri, e.getMessage());\n+            return;\n+        }\n+\n+        client.setConnectTimeout(CONNECT_TIMEOUT_SEC);\n+        ClientUpgradeRequest request = new ClientUpgradeRequest();\n+        request.setSubProtocols(\"relay_protocol\");\n+\n+        try {\n+            client.start();\n+            client.connect(touchWandSocket, uri, request);\n+        } catch (Exception e) {\n+            logger.warn(\"Could not connect webSocket URI {} message {}\", uri, e.getMessage());\n+            return;\n+        }\n+    }\n+\n+    public void dispose() {\n+        isShutDown = true;\n+        try {\n+            client.stop();\n+        } catch (Exception e) {\n+            logger.warn(\"Could not stop webSocketClient,  message {}\", e.getMessage());\n+        }\n+    }\n+\n+    public synchronized void registerListener(TouchWandUnitStatusUpdateListener listener) {\n+        if (!listeners.contains(listener)) {\n+            logger.debug(\"Adding TouchWandWebSocket listener {}\", listener);\n+            listeners.add(listener);\n+        }\n+    }\n+\n+    public synchronized void unregisterListener(TouchWandUnitStatusUpdateListener listener) {\n+        logger.debug(\"Removing TouchWandWebSocket listener {}\", listener);\n+        listeners.remove(listener);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43e2ee5f57c9f741a09cb270d38da6b8b112c30e"}, "originalPosition": 118}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg4NzU2Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        logger.warn(\"Error open connecton to {} : {} \", touchWandIpAddr, e.getMessage());\n          \n          \n            \n                        logger.warn(\"Error opening connecton to {} : {} \", touchWandIpAddr, e.getMessage());", "url": "https://github.com/openhab/openhab-addons/pull/8754#discussion_r505887563", "createdAt": "2020-10-15T21:56:20Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.touchwand/src/main/java/org/openhab/binding/touchwand/internal/TouchWandRestClient.java", "diffHunk": "@@ -0,0 +1,197 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+\n+package org.openhab.binding.touchwand.internal;\n+\n+import static org.openhab.binding.touchwand.internal.TouchWandBindingConstants.*;\n+\n+import java.net.CookieManager;\n+import java.net.MalformedURLException;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jetty.client.HttpClient;\n+import org.eclipse.jetty.client.api.ContentProvider;\n+import org.eclipse.jetty.client.api.ContentResponse;\n+import org.eclipse.jetty.client.api.Request;\n+import org.eclipse.jetty.client.util.StringContentProvider;\n+import org.eclipse.jetty.http.HttpMethod;\n+import org.eclipse.jetty.http.MimeTypes;\n+import org.openhab.core.library.types.OnOffType;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link TouchWandRestClient} is responsible for handling low level commands units TouchWand WonderFull hub\n+ * REST API interface\n+ *\n+ * @author Roie Geron - Initial contribution\n+ */\n+@NonNullByDefault\n+public class TouchWandRestClient {\n+\n+    private final Logger logger = LoggerFactory.getLogger(TouchWandRestClient.class);\n+\n+    static CookieManager cookieManager = new CookieManager();\n+\n+    private String touchWandIpAddr = \"\";\n+    private String touchWandPort = \"\";\n+    private boolean isConnected = false;\n+\n+    private static final HttpMethod METHOD_GET = HttpMethod.GET;\n+    private static final HttpMethod METHOD_POST = HttpMethod.POST;\n+\n+    private static final String CMD_LOGIN = \"login\";\n+    private static final String CMD_LIST_UNITS = \"listunits\";\n+    private static final String CMD_LIST_SCENARIOS = \"listsencarios\";\n+    private static final String CMD_UNIT_ACTION = \"action\";\n+    private static final String CMD_GET_UNIT_BY_ID = \"getunitbyid\";\n+\n+    private static final String ACTION_SWITCH_OFF = \"{\\\"id\\\":%s,\\\"value\\\":\" + SWITCH_STATUS_OFF + \"}\";\n+    private static final String ACTION_SWITCH_ON = \"{\\\"id\\\":%s,\\\"value\\\":\" + SWITCH_STATUS_ON + \"}\";\n+    private static final String ACTION_SHUTTER_DOWN = \"{\\\"id\\\":%s,\\\"value\\\":0,\\\"type\\\":\\\"height\\\"}\";\n+    private static final String ACTION_SHUTTER_UP = \"{\\\"id\\\":%s,\\\"value\\\":255,\\\"type\\\":\\\"height\\\"}\";\n+    private static final String ACTION_SHUTTER_STOP = \"{\\\"id\\\":%s,\\\"value\\\":0,\\\"type\\\":\\\"stop\\\"}\";\n+    private static final String ACTION_SHUTTER_POSITION = \"{\\\"id\\\":%s,\\\"value\\\":%s}\";\n+    private static final String ACTION_DIMMER_POSITION = \"{\\\"id\\\":%s,\\\"value\\\":%s}\";\n+\n+    private static final String CONTENT_TYPE_APPLICATION_JSON = MimeTypes.Type.APPLICATION_JSON.asString();\n+\n+    private static final int REQUEST_TIMEOUT_SEC = 10;\n+\n+    private static final Map<String, String> COMMAND_MAP = new HashMap<String, String>();\n+    static {\n+        COMMAND_MAP.put(CMD_LOGIN, \"/auth/login?\");\n+        COMMAND_MAP.put(CMD_LIST_UNITS, \"/units/listUnits\");\n+        COMMAND_MAP.put(CMD_LIST_SCENARIOS, \"/scenarios/listScenarios\");\n+        COMMAND_MAP.put(CMD_UNIT_ACTION, \"/units/action\");\n+        COMMAND_MAP.put(CMD_GET_UNIT_BY_ID, \"/units/getUnitByID?\");\n+    }\n+\n+    private HttpClient httpClient;\n+\n+    public TouchWandRestClient(HttpClient httpClient) {\n+        this.httpClient = httpClient;\n+    }\n+\n+    public final boolean connect(String user, String pass, String ipAddr, String port) {\n+        touchWandIpAddr = ipAddr;\n+        touchWandPort = port;\n+        isConnected = cmdLogin(user, pass, ipAddr);\n+\n+        return isConnected;\n+    }\n+\n+    private final boolean cmdLogin(String user, String pass, String ipAddr) {\n+        String command = buildUrl(CMD_LOGIN) + \"user=\" + user + \"&\" + \"psw=\" + pass;\n+        String response = sendCommand(command, METHOD_GET, \"\");\n+\n+        return !response.equals(\"Unauthorized\");\n+    }\n+\n+    public String cmdListUnits() {\n+        String command = buildUrl(CMD_LIST_UNITS);\n+        String response = sendCommand(command, METHOD_GET, \"\");\n+\n+        return response;\n+    }\n+\n+    public String cmdGetUnitById(String id) {\n+        String command = buildUrl(CMD_GET_UNIT_BY_ID) + \"id=\" + id;\n+        String response = sendCommand(command, METHOD_GET, \"\");\n+\n+        return response;\n+    }\n+\n+    public void cmdSwitchOnOff(String id, OnOffType onoff) {\n+        String action;\n+\n+        if (OnOffType.OFF.equals(onoff)) {\n+            action = String.format(ACTION_SWITCH_OFF, id);\n+        } else {\n+            action = String.format(ACTION_SWITCH_ON, id);\n+        }\n+        cmdUnitAction(action);\n+    }\n+\n+    public void cmdShutterUp(String id) {\n+        String action = String.format(ACTION_SHUTTER_UP, id);\n+        cmdUnitAction(action);\n+    }\n+\n+    public void cmdShutterDown(String id) {\n+        String action = String.format(ACTION_SHUTTER_DOWN, id);\n+        cmdUnitAction(action);\n+    }\n+\n+    public void cmdShutterPosition(String id, String position) {\n+        String action = String.format(ACTION_SHUTTER_POSITION, id, position);\n+        cmdUnitAction(action);\n+    }\n+\n+    public void cmdShutterStop(String id) {\n+        String action = String.format(ACTION_SHUTTER_STOP, id);\n+        cmdUnitAction(action);\n+    }\n+\n+    public void cmdDimmerPosition(String id, String position) {\n+        String action = String.format(ACTION_DIMMER_POSITION, id, position);\n+        cmdUnitAction(action);\n+    }\n+\n+    private String cmdUnitAction(String action) {\n+        String command = buildUrl(CMD_UNIT_ACTION);\n+        String response = sendCommand(command, METHOD_POST, action);\n+\n+        return response;\n+    }\n+\n+    private String buildUrl(String command) {\n+        String url = \"http://\" + touchWandIpAddr + \":\" + touchWandPort + COMMAND_MAP.get(command);\n+        return url;\n+    }\n+\n+    private synchronized String sendCommand(String command, HttpMethod method, String content) {\n+        ContentResponse response;\n+        Request request;\n+\n+        URL url = null;\n+        try {\n+            url = new URL(command);\n+        } catch (MalformedURLException e) {\n+            logger.warn(\"Error building URL {} : {}\", command, e.getMessage());\n+            return \"\";\n+        }\n+\n+        request = httpClient.newRequest(url.toString()).timeout(REQUEST_TIMEOUT_SEC, TimeUnit.SECONDS).method(method);\n+        if (method.equals(METHOD_POST) && (!content.isEmpty())) {\n+            ContentProvider contentProvider = new StringContentProvider(CONTENT_TYPE_APPLICATION_JSON, content,\n+                    StandardCharsets.UTF_8);\n+            request = request.content(contentProvider);\n+        }\n+\n+        try {\n+            response = request.send();\n+            return response.getContentAsString();\n+        } catch (InterruptedException | TimeoutException | ExecutionException e) {\n+            logger.warn(\"Error open connecton to {} : {} \", touchWandIpAddr, e.getMessage());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43e2ee5f57c9f741a09cb270d38da6b8b112c30e"}, "originalPosition": 193}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg4ODQ5Ng==", "bodyText": "Shouldn't you be url encoding the user and pass parameters? What if the password contains strange characters?", "url": "https://github.com/openhab/openhab-addons/pull/8754#discussion_r505888496", "createdAt": "2020-10-15T21:58:51Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.touchwand/src/main/java/org/openhab/binding/touchwand/internal/TouchWandRestClient.java", "diffHunk": "@@ -0,0 +1,197 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+\n+package org.openhab.binding.touchwand.internal;\n+\n+import static org.openhab.binding.touchwand.internal.TouchWandBindingConstants.*;\n+\n+import java.net.CookieManager;\n+import java.net.MalformedURLException;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jetty.client.HttpClient;\n+import org.eclipse.jetty.client.api.ContentProvider;\n+import org.eclipse.jetty.client.api.ContentResponse;\n+import org.eclipse.jetty.client.api.Request;\n+import org.eclipse.jetty.client.util.StringContentProvider;\n+import org.eclipse.jetty.http.HttpMethod;\n+import org.eclipse.jetty.http.MimeTypes;\n+import org.openhab.core.library.types.OnOffType;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link TouchWandRestClient} is responsible for handling low level commands units TouchWand WonderFull hub\n+ * REST API interface\n+ *\n+ * @author Roie Geron - Initial contribution\n+ */\n+@NonNullByDefault\n+public class TouchWandRestClient {\n+\n+    private final Logger logger = LoggerFactory.getLogger(TouchWandRestClient.class);\n+\n+    static CookieManager cookieManager = new CookieManager();\n+\n+    private String touchWandIpAddr = \"\";\n+    private String touchWandPort = \"\";\n+    private boolean isConnected = false;\n+\n+    private static final HttpMethod METHOD_GET = HttpMethod.GET;\n+    private static final HttpMethod METHOD_POST = HttpMethod.POST;\n+\n+    private static final String CMD_LOGIN = \"login\";\n+    private static final String CMD_LIST_UNITS = \"listunits\";\n+    private static final String CMD_LIST_SCENARIOS = \"listsencarios\";\n+    private static final String CMD_UNIT_ACTION = \"action\";\n+    private static final String CMD_GET_UNIT_BY_ID = \"getunitbyid\";\n+\n+    private static final String ACTION_SWITCH_OFF = \"{\\\"id\\\":%s,\\\"value\\\":\" + SWITCH_STATUS_OFF + \"}\";\n+    private static final String ACTION_SWITCH_ON = \"{\\\"id\\\":%s,\\\"value\\\":\" + SWITCH_STATUS_ON + \"}\";\n+    private static final String ACTION_SHUTTER_DOWN = \"{\\\"id\\\":%s,\\\"value\\\":0,\\\"type\\\":\\\"height\\\"}\";\n+    private static final String ACTION_SHUTTER_UP = \"{\\\"id\\\":%s,\\\"value\\\":255,\\\"type\\\":\\\"height\\\"}\";\n+    private static final String ACTION_SHUTTER_STOP = \"{\\\"id\\\":%s,\\\"value\\\":0,\\\"type\\\":\\\"stop\\\"}\";\n+    private static final String ACTION_SHUTTER_POSITION = \"{\\\"id\\\":%s,\\\"value\\\":%s}\";\n+    private static final String ACTION_DIMMER_POSITION = \"{\\\"id\\\":%s,\\\"value\\\":%s}\";\n+\n+    private static final String CONTENT_TYPE_APPLICATION_JSON = MimeTypes.Type.APPLICATION_JSON.asString();\n+\n+    private static final int REQUEST_TIMEOUT_SEC = 10;\n+\n+    private static final Map<String, String> COMMAND_MAP = new HashMap<String, String>();\n+    static {\n+        COMMAND_MAP.put(CMD_LOGIN, \"/auth/login?\");\n+        COMMAND_MAP.put(CMD_LIST_UNITS, \"/units/listUnits\");\n+        COMMAND_MAP.put(CMD_LIST_SCENARIOS, \"/scenarios/listScenarios\");\n+        COMMAND_MAP.put(CMD_UNIT_ACTION, \"/units/action\");\n+        COMMAND_MAP.put(CMD_GET_UNIT_BY_ID, \"/units/getUnitByID?\");\n+    }\n+\n+    private HttpClient httpClient;\n+\n+    public TouchWandRestClient(HttpClient httpClient) {\n+        this.httpClient = httpClient;\n+    }\n+\n+    public final boolean connect(String user, String pass, String ipAddr, String port) {\n+        touchWandIpAddr = ipAddr;\n+        touchWandPort = port;\n+        isConnected = cmdLogin(user, pass, ipAddr);\n+\n+        return isConnected;\n+    }\n+\n+    private final boolean cmdLogin(String user, String pass, String ipAddr) {\n+        String command = buildUrl(CMD_LOGIN) + \"user=\" + user + \"&\" + \"psw=\" + pass;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43e2ee5f57c9f741a09cb270d38da6b8b112c30e"}, "originalPosition": 102}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg4OTQzNA==", "bodyText": "why is this synchronized?", "url": "https://github.com/openhab/openhab-addons/pull/8754#discussion_r505889434", "createdAt": "2020-10-15T22:01:12Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.touchwand/src/main/java/org/openhab/binding/touchwand/internal/discovery/TouchWandControllerDiscoveryService.java", "diffHunk": "@@ -0,0 +1,142 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+\n+package org.openhab.binding.touchwand.internal.discovery;\n+\n+import static org.openhab.binding.touchwand.internal.TouchWandBindingConstants.THING_TYPE_BRIDGE;\n+\n+import java.io.IOException;\n+import java.net.DatagramPacket;\n+import java.net.DatagramSocket;\n+import java.net.InetAddress;\n+import java.net.SocketException;\n+import java.nio.charset.StandardCharsets;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.openhab.binding.touchwand.internal.TouchWandBindingConstants;\n+import org.openhab.binding.touchwand.internal.TouchWandBridgeHandler;\n+import org.openhab.core.config.discovery.AbstractDiscoveryService;\n+import org.openhab.core.config.discovery.DiscoveryResultBuilder;\n+import org.openhab.core.config.discovery.DiscoveryService;\n+import org.openhab.core.thing.ThingUID;\n+import org.osgi.service.component.annotations.Component;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link TouchWandControllerDiscoveryService} Discovery service for Touchwand Controllers.\n+ *\n+ * @author Roie Geron - Initial contribution\n+ */\n+@Component(service = DiscoveryService.class, configurationPid = \"discovery.touchwand\")\n+@NonNullByDefault\n+public class TouchWandControllerDiscoveryService extends AbstractDiscoveryService {\n+\n+    private static final int SEARCH_TIME_SEC = 2;\n+    private static final int TOUCHWAND_BCAST_PORT = 35000;\n+    private final Logger logger = LoggerFactory.getLogger(TouchWandControllerDiscoveryService.class);\n+\n+    private @Nullable Thread socketReceiveThread = null;\n+    private DatagramSocket listenSocket;\n+\n+    public TouchWandControllerDiscoveryService() throws SocketException {\n+        super(TouchWandBridgeHandler.SUPPORTED_THING_TYPES, SEARCH_TIME_SEC, true);\n+        removeOlderResults(getTimestampOfLastScan());\n+        listenSocket = new DatagramSocket(TOUCHWAND_BCAST_PORT);\n+    }\n+\n+    @Override\n+    protected void startScan() {\n+        DatagramSocket localListenSocket = listenSocket;\n+        runReceiveThread(localListenSocket);\n+    }\n+\n+    @Override\n+    protected synchronized void stopScan() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43e2ee5f57c9f741a09cb270d38da6b8b112c30e"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg4OTkyMg==", "bodyText": "This wan't do anything in the constructor, you need to move this to the activate method instead.", "url": "https://github.com/openhab/openhab-addons/pull/8754#discussion_r505889922", "createdAt": "2020-10-15T22:02:34Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.touchwand/src/main/java/org/openhab/binding/touchwand/internal/discovery/TouchWandControllerDiscoveryService.java", "diffHunk": "@@ -0,0 +1,142 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+\n+package org.openhab.binding.touchwand.internal.discovery;\n+\n+import static org.openhab.binding.touchwand.internal.TouchWandBindingConstants.THING_TYPE_BRIDGE;\n+\n+import java.io.IOException;\n+import java.net.DatagramPacket;\n+import java.net.DatagramSocket;\n+import java.net.InetAddress;\n+import java.net.SocketException;\n+import java.nio.charset.StandardCharsets;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.openhab.binding.touchwand.internal.TouchWandBindingConstants;\n+import org.openhab.binding.touchwand.internal.TouchWandBridgeHandler;\n+import org.openhab.core.config.discovery.AbstractDiscoveryService;\n+import org.openhab.core.config.discovery.DiscoveryResultBuilder;\n+import org.openhab.core.config.discovery.DiscoveryService;\n+import org.openhab.core.thing.ThingUID;\n+import org.osgi.service.component.annotations.Component;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link TouchWandControllerDiscoveryService} Discovery service for Touchwand Controllers.\n+ *\n+ * @author Roie Geron - Initial contribution\n+ */\n+@Component(service = DiscoveryService.class, configurationPid = \"discovery.touchwand\")\n+@NonNullByDefault\n+public class TouchWandControllerDiscoveryService extends AbstractDiscoveryService {\n+\n+    private static final int SEARCH_TIME_SEC = 2;\n+    private static final int TOUCHWAND_BCAST_PORT = 35000;\n+    private final Logger logger = LoggerFactory.getLogger(TouchWandControllerDiscoveryService.class);\n+\n+    private @Nullable Thread socketReceiveThread = null;\n+    private DatagramSocket listenSocket;\n+\n+    public TouchWandControllerDiscoveryService() throws SocketException {\n+        super(TouchWandBridgeHandler.SUPPORTED_THING_TYPES, SEARCH_TIME_SEC, true);\n+        removeOlderResults(getTimestampOfLastScan());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43e2ee5f57c9f741a09cb270d38da6b8b112c30e"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg5MDM0OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                protected synchronized void stopScan() {\n          \n          \n            \n                protected void stopScan() {", "url": "https://github.com/openhab/openhab-addons/pull/8754#discussion_r505890348", "createdAt": "2020-10-15T22:03:39Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.touchwand/src/main/java/org/openhab/binding/touchwand/internal/discovery/TouchWandUnitDiscoveryService.java", "diffHunk": "@@ -0,0 +1,224 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+\n+package org.openhab.binding.touchwand.internal.discovery;\n+\n+import static org.openhab.binding.touchwand.internal.TouchWandBindingConstants.*;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Date;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.jdt.annotation.NonNull;\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.openhab.binding.touchwand.internal.TouchWandBridgeHandler;\n+import org.openhab.binding.touchwand.internal.TouchWandUnitStatusUpdateListener;\n+import org.openhab.binding.touchwand.internal.dto.TouchWandUnitData;\n+import org.openhab.binding.touchwand.internal.dto.TouchWandUnitFromJson;\n+import org.openhab.core.config.discovery.AbstractDiscoveryService;\n+import org.openhab.core.config.discovery.DiscoveryResultBuilder;\n+import org.openhab.core.config.discovery.DiscoveryService;\n+import org.openhab.core.thing.ThingStatus;\n+import org.openhab.core.thing.ThingTypeUID;\n+import org.openhab.core.thing.ThingUID;\n+import org.openhab.core.thing.binding.ThingHandler;\n+import org.openhab.core.thing.binding.ThingHandlerService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonParser;\n+import com.google.gson.JsonSyntaxException;\n+\n+/**\n+ * The {@link TouchWandUnitDiscoveryService} Discovery service for TouchWand units.\n+ *\n+ * @author Roie Geron - Initial contribution\n+ */\n+@NonNullByDefault\n+public class TouchWandUnitDiscoveryService extends AbstractDiscoveryService\n+        implements DiscoveryService, ThingHandlerService {\n+\n+    private static final int SEARCH_TIME_SEC = 10;\n+    private static final int SCAN_INTERVAL_SEC = 60;\n+    private static final int LINK_DISCOVERY_SERVICE_INITIAL_DELAY_SEC = 5;\n+    private static final String[] CONNECTIVITY_OPTIONS = { \"zwave\", \"knx\" };\n+    private @NonNullByDefault({}) TouchWandBridgeHandler touchWandBridgeHandler;\n+    private final Logger logger = LoggerFactory.getLogger(TouchWandUnitDiscoveryService.class);\n+\n+    private @Nullable ScheduledFuture<?> scanningJob;\n+    private List<TouchWandUnitStatusUpdateListener> listeners = new ArrayList<>();\n+\n+    public TouchWandUnitDiscoveryService() {\n+        super(SUPPORTED_THING_TYPES_UIDS, SEARCH_TIME_SEC, true);\n+    }\n+\n+    @Override\n+    protected void startScan() {\n+        if (touchWandBridgeHandler.getThing().getStatus() != ThingStatus.ONLINE) {\n+            logger.warn(\"Could not scan units while bridge offline\");\n+            return;\n+        }\n+\n+        logger.debug(\"Starting TouchWand discovery on bridge {}\", touchWandBridgeHandler.getThing().getUID());\n+        String response = touchWandBridgeHandler.touchWandClient.cmdListUnits();\n+        if (response.isEmpty()) {\n+            return;\n+        }\n+\n+        JsonParser jsonParser = new JsonParser();\n+        try {\n+            JsonArray jsonArray = jsonParser.parse(response).getAsJsonArray();\n+            if (jsonArray.isJsonArray()) {\n+                try {\n+                    for (JsonElement unit : jsonArray) {\n+                        TouchWandUnitData touchWandUnit;\n+                        touchWandUnit = TouchWandUnitFromJson.parseResponse(unit.getAsJsonObject());\n+                        if (touchWandUnit == null) {\n+                            continue;\n+                        }\n+                        if (!touchWandBridgeHandler.isAddSecondaryControllerUnits()) {\n+                            if (!Arrays.asList(CONNECTIVITY_OPTIONS).contains(touchWandUnit.getConnectivity())) {\n+                                continue;\n+                            }\n+                        }\n+                        String type = touchWandUnit.getType();\n+                        if (!Arrays.asList(SUPPORTED_TOUCHWAND_TYPES).contains(type)) {\n+                            logger.debug(\"Unit discovery skipping unsupported unit type : {} \", type);\n+                            continue;\n+                        }\n+                        switch (type) {\n+                            case TYPE_WALLCONTROLLER:\n+                                addDeviceDiscoveryResult(touchWandUnit, THING_TYPE_WALLCONTROLLER);\n+                                break;\n+                            case TYPE_SWITCH:\n+                                addDeviceDiscoveryResult(touchWandUnit, THING_TYPE_SWITCH);\n+                                notifyListeners(touchWandUnit);\n+                                break;\n+                            case TYPE_DIMMER:\n+                                addDeviceDiscoveryResult(touchWandUnit, THING_TYPE_DIMMER);\n+                                notifyListeners(touchWandUnit);\n+                                break;\n+                            case TYPE_SHUTTER:\n+                                addDeviceDiscoveryResult(touchWandUnit, THING_TYPE_SHUTTER);\n+                                break;\n+                            default:\n+                                continue;\n+                        }\n+                    }\n+                } catch (JsonSyntaxException e) {\n+                    logger.warn(\"Could not parse unit {}\", e.getMessage());\n+                }\n+            }\n+        } catch (JsonSyntaxException msg) {\n+            logger.warn(\"Could not parse list units response {}\", msg.getMessage());\n+        }\n+    }\n+\n+    private void notifyListeners(TouchWandUnitData touchWandUnit) {\n+        for (TouchWandUnitStatusUpdateListener listener : listeners) {\n+            listener.onDataReceived(touchWandUnit);\n+        }\n+    }\n+\n+    @Override\n+    protected synchronized void stopScan() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43e2ee5f57c9f741a09cb270d38da6b8b112c30e"}, "originalPosition": 142}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg5MDY1Nw==", "bodyText": "Can you give this class a better name?", "url": "https://github.com/openhab/openhab-addons/pull/8754#discussion_r505890657", "createdAt": "2020-10-15T22:04:31Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.touchwand/src/main/java/org/openhab/binding/touchwand/internal/dto/Csc.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+\n+package org.openhab.binding.touchwand.internal.dto;\n+\n+/**\n+ * The {@link Csc} implements Csc data class.\n+ *\n+ * @author Roie Geron - Initial contribution\n+ */\n+public class Csc {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43e2ee5f57c9f741a09cb270d38da6b8b112c30e"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg5MTk5OQ==", "bodyText": "wallcontroller isn't a valid item-type", "url": "https://github.com/openhab/openhab-addons/pull/8754#discussion_r505891999", "createdAt": "2020-10-15T22:07:50Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.touchwand/src/main/resources/OH-INF/thing/wallcontroller.xml", "diffHunk": "@@ -0,0 +1,28 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<thing:thing-descriptions bindingId=\"touchwand\"\n+\txmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+\txmlns:thing=\"https://openhab.org/schemas/thing-description/v1.0.0\"\n+\txsi:schemaLocation=\"https://openhab.org/schemas/thing-description/v1.0.0 https://openhab.org/schemas/thing-description-1.0.0.xsd\">\n+\n+\t<thing-type id=\"wallcontroller\">\n+\t\t<supported-bridge-type-refs>\n+\t\t\t<bridge-type-ref id=\"bridge\"></bridge-type-ref>\n+\t\t</supported-bridge-type-refs>\n+\t\t<label>TouchWand WallController Unit</label>\n+\t\t<channels>\n+\t\t\t<channel id=\"wallaction\" typeId=\"wallaction\">\n+\t\t\t\t<description>WallController action</description>\n+\t\t\t</channel>\n+\t\t</channels>\n+\t</thing-type>\n+\t<channel-type id=\"wallaction\">\n+\t\t<item-type>wallcontroller</item-type>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43e2ee5f57c9f741a09cb270d38da6b8b112c30e"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTkwMTEyMA==", "bodyText": "If dispose is called immediately after initialize your binding should be able to shutdown without side effects.\nIn this case it is possible for dispose to be called before you have initialized the touchWandWebSockets field.\nTo prevent this from happening you need use a boolean isRunning field along with synchronization to make sure that access to the isRunning and touchWandWebSockets field is atomic.\nYou could synchronize on a new lock object, but for this fix it is less messy to just synchronize on the this object instead.\nprivate volatile boolean isRunning = false;\n\npublic synchronized void initialize() {\n\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    scheduler.execute(() -> {\n          \n          \n            \n                        boolean thingReachable = false;\n          \n          \n            \n                        String password = config.password;\n          \n          \n            \n                        String username = config.username;\n          \n          \n            \n                        thingReachable = touchWandClient.connect(username, password, host, port.toString());\n          \n          \n            \n                        if (thingReachable) {\n          \n          \n            \n                            updateStatus(ThingStatus.ONLINE);\n          \n          \n            \n                            TouchWandWebSockets localSockets = touchWandWebSockets = new TouchWandWebSockets(host, scheduler);\n          \n          \n            \n                            localSockets.registerListener(this);\n          \n          \n            \n                            localSockets.connect();\n          \n          \n            \n                        } else {\n          \n          \n            \n                            updateStatus(ThingStatus.OFFLINE);\n          \n          \n            \n                        }\n          \n          \n            \n                    });\n          \n          \n            \n                }\n          \n          \n            \n            \n          \n          \n            \n                @Override\n          \n          \n            \n                public void handleCommand(ChannelUID channelUID, Command command) {\n          \n          \n            \n                }\n          \n          \n            \n            \n          \n          \n            \n                public boolean isAddSecondaryControllerUnits() {\n          \n          \n            \n                    return addSecondaryUnits;\n          \n          \n            \n                }\n          \n          \n            \n            \n          \n          \n            \n                public int getStatusRefreshTime() {\n          \n          \n            \n                    return statusRefreshRateSec;\n          \n          \n            \n                }\n          \n          \n            \n            \n          \n          \n            \n                @Override\n          \n          \n            \n                public void dispose() {\n          \n          \n            \n                    TouchWandWebSockets myTouchWandWebSockets = touchWandWebSockets;\n          \n          \n            \n                    if (myTouchWandWebSockets != null) {\n          \n          \n            \n                        myTouchWandWebSockets.unregisterListener(this);\n          \n          \n            \n                        myTouchWandWebSockets.dispose();\n          \n          \n            \n                    }\n          \n          \n            \n                }\n          \n          \n            \n                    isRunning = true;\n          \n          \n            \n                    scheduler.execute(() -> {\n          \n          \n            \n                        boolean thingReachable = false;\n          \n          \n            \n                        String password = config.password;\n          \n          \n            \n                        String username = config.username;\n          \n          \n            \n                        thingReachable = touchWandClient.connect(username, password, host, port.toString());\n          \n          \n            \n                        if (thingReachable) {\n          \n          \n            \n                            updateStatus(ThingStatus.ONLINE);\n          \n          \n            \n                            synchronized(this){\n          \n          \n            \n                                if(isRunning){\n          \n          \n            \n                                    TouchWandWebSockets localSockets = touchWandWebSockets = new TouchWandWebSockets(host, scheduler);\n          \n          \n            \n                                    localSockets.registerListener(this);\n          \n          \n            \n                                    localSockets.connect();\n          \n          \n            \n                                }\n          \n          \n            \n                            }\n          \n          \n            \n                        } else {\n          \n          \n            \n                            updateStatus(ThingStatus.OFFLINE);\n          \n          \n            \n                        }\n          \n          \n            \n                    });\n          \n          \n            \n                }\n          \n          \n            \n            \n          \n          \n            \n                @Override\n          \n          \n            \n                public void handleCommand(ChannelUID channelUID, Command command) {\n          \n          \n            \n                }\n          \n          \n            \n            \n          \n          \n            \n                public boolean isAddSecondaryControllerUnits() {\n          \n          \n            \n                    return addSecondaryUnits;\n          \n          \n            \n                }\n          \n          \n            \n            \n          \n          \n            \n                public int getStatusRefreshTime() {\n          \n          \n            \n                    return statusRefreshRateSec;\n          \n          \n            \n                }\n          \n          \n            \n            \n          \n          \n            \n                @Override\n          \n          \n            \n                public synchronized void dispose() {\n          \n          \n            \n                    isRunning = false;\n          \n          \n            \n                    TouchWandWebSockets myTouchWandWebSockets = touchWandWebSockets;\n          \n          \n            \n                    if (myTouchWandWebSockets != null) {\n          \n          \n            \n                        myTouchWandWebSockets.unregisterListener(this);\n          \n          \n            \n                        myTouchWandWebSockets.dispose();\n          \n          \n            \n                    }\n          \n          \n            \n                }", "url": "https://github.com/openhab/openhab-addons/pull/8754#discussion_r505901120", "createdAt": "2020-10-15T22:32:15Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.touchwand/src/main/java/org/openhab/binding/touchwand/internal/TouchWandBridgeHandler.java", "diffHunk": "@@ -0,0 +1,139 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.touchwand.internal;\n+\n+import static org.openhab.binding.touchwand.internal.TouchWandBindingConstants.THING_TYPE_BRIDGE;\n+\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.ConcurrentHashMap;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.jetty.client.HttpClient;\n+import org.openhab.binding.touchwand.internal.config.TouchwandBridgeConfiguration;\n+import org.openhab.binding.touchwand.internal.discovery.TouchWandUnitDiscoveryService;\n+import org.openhab.binding.touchwand.internal.dto.TouchWandUnitData;\n+import org.openhab.core.thing.Bridge;\n+import org.openhab.core.thing.ChannelUID;\n+import org.openhab.core.thing.ThingStatus;\n+import org.openhab.core.thing.ThingTypeUID;\n+import org.openhab.core.thing.binding.BaseBridgeHandler;\n+import org.openhab.core.thing.binding.ThingHandlerService;\n+import org.openhab.core.types.Command;\n+import org.osgi.framework.BundleContext;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link TouchWandBridgeHandler} is responsible for handling commands, which are\n+ * sent to one of the channels TouchWand Wanderfull\u2122 Hub channels .\n+ *\n+ * @author Roie Geron - Initial contribution\n+ */\n+@NonNullByDefault\n+public class TouchWandBridgeHandler extends BaseBridgeHandler implements TouchWandUnitStatusUpdateListener {\n+    public static final Set<ThingTypeUID> SUPPORTED_THING_TYPES = Collections.singleton(THING_TYPE_BRIDGE);\n+    private final Logger logger = LoggerFactory.getLogger(TouchWandBridgeHandler.class);\n+    private int statusRefreshRateSec;\n+    private boolean addSecondaryUnits;\n+    private @Nullable TouchWandWebSockets touchWandWebSockets;\n+    private Map<String, TouchWandUnitUpdateListener> unitUpdateListeners = new ConcurrentHashMap<>();\n+\n+    public TouchWandRestClient touchWandClient;\n+\n+    public TouchWandBridgeHandler(Bridge bridge, HttpClient httpClient, BundleContext bundleContext) {\n+        super(bridge);\n+        touchWandClient = new TouchWandRestClient(httpClient);\n+        touchWandWebSockets = null;\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        String host;\n+        Integer port;\n+        TouchwandBridgeConfiguration config;\n+\n+        updateStatus(ThingStatus.UNKNOWN);\n+\n+        config = getConfigAs(TouchwandBridgeConfiguration.class);\n+\n+        host = config.ipAddress;\n+        port = config.port;\n+        statusRefreshRateSec = config.statusrefresh;\n+        addSecondaryUnits = config.addSecondaryUnits;\n+\n+        scheduler.execute(() -> {\n+            boolean thingReachable = false;\n+            String password = config.password;\n+            String username = config.username;\n+            thingReachable = touchWandClient.connect(username, password, host, port.toString());\n+            if (thingReachable) {\n+                updateStatus(ThingStatus.ONLINE);\n+                TouchWandWebSockets localSockets = touchWandWebSockets = new TouchWandWebSockets(host, scheduler);\n+                localSockets.registerListener(this);\n+                localSockets.connect();\n+            } else {\n+                updateStatus(ThingStatus.OFFLINE);\n+            }\n+        });\n+    }\n+\n+    @Override\n+    public void handleCommand(ChannelUID channelUID, Command command) {\n+    }\n+\n+    public boolean isAddSecondaryControllerUnits() {\n+        return addSecondaryUnits;\n+    }\n+\n+    public int getStatusRefreshTime() {\n+        return statusRefreshRateSec;\n+    }\n+\n+    @Override\n+    public void dispose() {\n+        TouchWandWebSockets myTouchWandWebSockets = touchWandWebSockets;\n+        if (myTouchWandWebSockets != null) {\n+            myTouchWandWebSockets.unregisterListener(this);\n+            myTouchWandWebSockets.dispose();\n+        }\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43e2ee5f57c9f741a09cb270d38da6b8b112c30e"}, "originalPosition": 113}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTkwMTU1Nw==", "bodyText": "We can take advantage of java11 here. yay!\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static final Set<ThingTypeUID> SUPPORTED_THING_TYPES = new HashSet<>(\n          \n          \n            \n                        Arrays.asList(THING_TYPE_SHUTTER, THING_TYPE_SWITCH, THING_TYPE_WALLCONTROLLER, THING_TYPE_DIMMER));\n          \n          \n            \n                public static final Set<ThingTypeUID> SUPPORTED_THING_TYPES = Set.of(THING_TYPE_SHUTTER, THING_TYPE_SWITCH, THING_TYPE_WALLCONTROLLER, THING_TYPE_DIMMER);", "url": "https://github.com/openhab/openhab-addons/pull/8754#discussion_r505901557", "createdAt": "2020-10-15T22:33:28Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.touchwand/src/main/java/org/openhab/binding/touchwand/internal/TouchWandBaseUnitHandler.java", "diffHunk": "@@ -0,0 +1,161 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.touchwand.internal;\n+\n+import static org.openhab.binding.touchwand.internal.TouchWandBindingConstants.*;\n+\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.openhab.binding.touchwand.internal.dto.TouchWandUnitData;\n+import org.openhab.core.thing.Bridge;\n+import org.openhab.core.thing.ChannelUID;\n+import org.openhab.core.thing.Thing;\n+import org.openhab.core.thing.ThingStatus;\n+import org.openhab.core.thing.ThingStatusDetail;\n+import org.openhab.core.thing.ThingTypeUID;\n+import org.openhab.core.thing.binding.BaseThingHandler;\n+import org.openhab.core.types.Command;\n+import org.openhab.core.types.RefreshType;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParseException;\n+import com.google.gson.JsonParser;\n+\n+/**\n+ * The {@link TouchWandBaseUnitHandler} is responsible for handling commands and status updates\n+ * for TouchWand units. This is an abstract class , units should implement the specific command\n+ * handling and status updates.\n+ *\n+ * @author Roie Geron - Initial contribution\n+ *\n+ */\n+@NonNullByDefault\n+public abstract class TouchWandBaseUnitHandler extends BaseThingHandler implements TouchWandUnitUpdateListener {\n+\n+    protected final Logger logger = LoggerFactory.getLogger(TouchWandBaseUnitHandler.class);\n+    public static final Set<ThingTypeUID> SUPPORTED_THING_TYPES = new HashSet<>(\n+            Arrays.asList(THING_TYPE_SHUTTER, THING_TYPE_SWITCH, THING_TYPE_WALLCONTROLLER, THING_TYPE_DIMMER));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43e2ee5f57c9f741a09cb270d38da6b8b112c30e"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTkwMjQ0OQ==", "bodyText": "please move these fields to below your static constants", "url": "https://github.com/openhab/openhab-addons/pull/8754#discussion_r505902449", "createdAt": "2020-10-15T22:35:43Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.touchwand/src/main/java/org/openhab/binding/touchwand/internal/TouchWandRestClient.java", "diffHunk": "@@ -0,0 +1,197 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+\n+package org.openhab.binding.touchwand.internal;\n+\n+import static org.openhab.binding.touchwand.internal.TouchWandBindingConstants.*;\n+\n+import java.net.CookieManager;\n+import java.net.MalformedURLException;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jetty.client.HttpClient;\n+import org.eclipse.jetty.client.api.ContentProvider;\n+import org.eclipse.jetty.client.api.ContentResponse;\n+import org.eclipse.jetty.client.api.Request;\n+import org.eclipse.jetty.client.util.StringContentProvider;\n+import org.eclipse.jetty.http.HttpMethod;\n+import org.eclipse.jetty.http.MimeTypes;\n+import org.openhab.core.library.types.OnOffType;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link TouchWandRestClient} is responsible for handling low level commands units TouchWand WonderFull hub\n+ * REST API interface\n+ *\n+ * @author Roie Geron - Initial contribution\n+ */\n+@NonNullByDefault\n+public class TouchWandRestClient {\n+\n+    private final Logger logger = LoggerFactory.getLogger(TouchWandRestClient.class);\n+\n+    static CookieManager cookieManager = new CookieManager();\n+\n+    private String touchWandIpAddr = \"\";\n+    private String touchWandPort = \"\";\n+    private boolean isConnected = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43e2ee5f57c9f741a09cb270d38da6b8b112c30e"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTkwMjYyNw==", "bodyText": "package private?", "url": "https://github.com/openhab/openhab-addons/pull/8754#discussion_r505902627", "createdAt": "2020-10-15T22:36:15Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.touchwand/src/main/java/org/openhab/binding/touchwand/internal/TouchWandWebSockets.java", "diffHunk": "@@ -0,0 +1,193 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.touchwand.internal;\n+\n+import static org.openhab.binding.touchwand.internal.TouchWandBindingConstants.SUPPORTED_TOUCHWAND_TYPES;\n+\n+import java.io.IOException;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.jetty.websocket.api.Session;\n+import org.eclipse.jetty.websocket.api.annotations.OnWebSocketClose;\n+import org.eclipse.jetty.websocket.api.annotations.OnWebSocketConnect;\n+import org.eclipse.jetty.websocket.api.annotations.OnWebSocketError;\n+import org.eclipse.jetty.websocket.api.annotations.OnWebSocketMessage;\n+import org.eclipse.jetty.websocket.api.annotations.WebSocket;\n+import org.eclipse.jetty.websocket.client.ClientUpgradeRequest;\n+import org.eclipse.jetty.websocket.client.WebSocketClient;\n+import org.openhab.binding.touchwand.internal.dto.TouchWandUnitData;\n+import org.openhab.binding.touchwand.internal.dto.TouchWandUnitFromJson;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParser;\n+import com.google.gson.JsonSyntaxException;\n+\n+/**\n+ * The {@link TouchWandWebSockets} class implements WebSockets API to TouchWand controller\n+ *\n+ * @author Roie Geron - Initial contribution\n+ */\n+@NonNullByDefault\n+public class TouchWandWebSockets {\n+\n+    private static final int CONNECT_TIMEOUT_SEC = 10;\n+    private static final int WEBSOCKET_RECONNECT_INTERVAL_SEC = CONNECT_TIMEOUT_SEC * 2;\n+    private static final int WEBSOCKET_IDLE_TIMEOUT_MS = CONNECT_TIMEOUT_SEC * 10 * 1000;\n+    private final Logger logger = LoggerFactory.getLogger(TouchWandWebSockets.class);\n+    private static final String WS_ENDPOINT_TOUCHWAND = \"/async\";\n+\n+    private WebSocketClient client;\n+    private String controllerAddress;\n+    private TouchWandSocket touchWandSocket;\n+    private boolean isShutDown = false;\n+    private List<TouchWandUnitStatusUpdateListener> listeners = new ArrayList<>();\n+    private @Nullable ScheduledFuture<?> socketReconnect;\n+    private @Nullable URI uri;\n+\n+    ScheduledExecutorService scheduler;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43e2ee5f57c9f741a09cb270d38da6b8b112c30e"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTkwMjk5Mg==", "bodyText": "Shouldn't the socketReconnect be canceled here?", "url": "https://github.com/openhab/openhab-addons/pull/8754#discussion_r505902992", "createdAt": "2020-10-15T22:37:19Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.touchwand/src/main/java/org/openhab/binding/touchwand/internal/TouchWandWebSockets.java", "diffHunk": "@@ -0,0 +1,193 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.touchwand.internal;\n+\n+import static org.openhab.binding.touchwand.internal.TouchWandBindingConstants.SUPPORTED_TOUCHWAND_TYPES;\n+\n+import java.io.IOException;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.jetty.websocket.api.Session;\n+import org.eclipse.jetty.websocket.api.annotations.OnWebSocketClose;\n+import org.eclipse.jetty.websocket.api.annotations.OnWebSocketConnect;\n+import org.eclipse.jetty.websocket.api.annotations.OnWebSocketError;\n+import org.eclipse.jetty.websocket.api.annotations.OnWebSocketMessage;\n+import org.eclipse.jetty.websocket.api.annotations.WebSocket;\n+import org.eclipse.jetty.websocket.client.ClientUpgradeRequest;\n+import org.eclipse.jetty.websocket.client.WebSocketClient;\n+import org.openhab.binding.touchwand.internal.dto.TouchWandUnitData;\n+import org.openhab.binding.touchwand.internal.dto.TouchWandUnitFromJson;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParser;\n+import com.google.gson.JsonSyntaxException;\n+\n+/**\n+ * The {@link TouchWandWebSockets} class implements WebSockets API to TouchWand controller\n+ *\n+ * @author Roie Geron - Initial contribution\n+ */\n+@NonNullByDefault\n+public class TouchWandWebSockets {\n+\n+    private static final int CONNECT_TIMEOUT_SEC = 10;\n+    private static final int WEBSOCKET_RECONNECT_INTERVAL_SEC = CONNECT_TIMEOUT_SEC * 2;\n+    private static final int WEBSOCKET_IDLE_TIMEOUT_MS = CONNECT_TIMEOUT_SEC * 10 * 1000;\n+    private final Logger logger = LoggerFactory.getLogger(TouchWandWebSockets.class);\n+    private static final String WS_ENDPOINT_TOUCHWAND = \"/async\";\n+\n+    private WebSocketClient client;\n+    private String controllerAddress;\n+    private TouchWandSocket touchWandSocket;\n+    private boolean isShutDown = false;\n+    private List<TouchWandUnitStatusUpdateListener> listeners = new ArrayList<>();\n+    private @Nullable ScheduledFuture<?> socketReconnect;\n+    private @Nullable URI uri;\n+\n+    ScheduledExecutorService scheduler;\n+\n+    public TouchWandWebSockets(String ipAddress, ScheduledExecutorService scheduler) {\n+        client = new WebSocketClient();\n+        touchWandSocket = new TouchWandSocket();\n+        this.controllerAddress = ipAddress;\n+        this.scheduler = scheduler;\n+        socketReconnect = null;\n+    }\n+\n+    public void connect() {\n+        try {\n+            uri = new URI(\"ws://\" + controllerAddress + WS_ENDPOINT_TOUCHWAND);\n+        } catch (URISyntaxException e) {\n+            logger.warn(\"URI not valid {} message {}\", uri, e.getMessage());\n+            return;\n+        }\n+\n+        client.setConnectTimeout(CONNECT_TIMEOUT_SEC);\n+        ClientUpgradeRequest request = new ClientUpgradeRequest();\n+        request.setSubProtocols(\"relay_protocol\");\n+\n+        try {\n+            client.start();\n+            client.connect(touchWandSocket, uri, request);\n+        } catch (Exception e) {\n+            logger.warn(\"Could not connect webSocket URI {} message {}\", uri, e.getMessage());\n+            return;\n+        }\n+    }\n+\n+    public void dispose() {\n+        isShutDown = true;\n+        try {\n+            client.stop();\n+        } catch (Exception e) {\n+            logger.warn(\"Could not stop webSocketClient,  message {}\", e.getMessage());\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43e2ee5f57c9f741a09cb270d38da6b8b112c30e"}, "originalPosition": 105}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e096521ff7efa28cc2525e21fae4fe7bc97ae67c", "author": {"user": {"login": "roieg", "name": "Roie Geron"}}, "url": "https://github.com/openhab/openhab-addons/commit/e096521ff7efa28cc2525e21fae4fe7bc97ae67c", "committedDate": "2020-10-16T15:05:45Z", "message": "Move some strings to binding constants\n\nSigned-off-by: Roie Geron <roie.geron@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa6b97d2f9f4c1cfacfe8ee5c2d73abae91b1f38", "author": {"user": {"login": "roieg", "name": "Roie Geron"}}, "url": "https://github.com/openhab/openhab-addons/commit/aa6b97d2f9f4c1cfacfe8ee5c2d73abae91b1f38", "committedDate": "2020-10-16T15:10:14Z", "message": "Change time to new Date().getTime()\n\nSigned-off-by: Roie Geron <roie.geron@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29d0d2ac2ce7afef5258ef9b2602c0360454c748", "author": {"user": {"login": "roieg", "name": "Roie Geron"}}, "url": "https://github.com/openhab/openhab-addons/commit/29d0d2ac2ce7afef5258ef9b2602c0360454c748", "committedDate": "2020-10-16T15:23:39Z", "message": "move to CopyOnWriteArraySet and remove synchonized\n\nSigned-off-by: Roie Geron <roie.geron@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f03cfebc7c4982f6a2abbcaca2034f404426d957", "author": {"user": {"login": "roieg", "name": "Roie Geron"}}, "url": "https://github.com/openhab/openhab-addons/commit/f03cfebc7c4982f6a2abbcaca2034f404426d957", "committedDate": "2020-10-16T15:28:29Z", "message": "yet another move to CopyOnWriteArraySet instead of synchronized\n\nyet another move to CopyOnWriteArraySet instead of synchronized\n\nSigned-off-by: Roie Geron <roie.geron@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f0b5932694170e2b4d41f9b197a63feb7d9e463", "author": {"user": {"login": "roieg", "name": "Roie Geron"}}, "url": "https://github.com/openhab/openhab-addons/commit/3f0b5932694170e2b4d41f9b197a63feb7d9e463", "committedDate": "2020-10-16T15:59:52Z", "message": "changed item-type to String\n\nSigned-off-by: Roie Geron <roie.geron@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49995d6f300897cab7c3ae3deb3777fb2071650e", "author": {"user": {"login": "roieg", "name": "Roie Geron"}}, "url": "https://github.com/openhab/openhab-addons/commit/49995d6f300897cab7c3ae3deb3777fb2071650e", "committedDate": "2020-10-16T16:07:15Z", "message": "some code beautify\n\nSigned-off-by: Roie Geron <roie.geron@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ceaca3bdc649e4484b8607603a92399f448a13a", "author": {"user": {"login": "roieg", "name": "Roie Geron"}}, "url": "https://github.com/openhab/openhab-addons/commit/3ceaca3bdc649e4484b8607603a92399f448a13a", "committedDate": "2020-10-16T16:10:37Z", "message": "change open to opening string\n\nSigned-off-by: Roie Geron <roie.geron@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e0dccd71fd1a6da2c80be834194460110ccf3c0", "author": {"user": {"login": "roieg", "name": "Roie Geron"}}, "url": "https://github.com/openhab/openhab-addons/commit/3e0dccd71fd1a6da2c80be834194460110ccf3c0", "committedDate": "2020-10-16T16:35:36Z", "message": "remove synchronized\n\nSigned-off-by: Roie Geron <roie.geron@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b43a7bbab007d48a36e59882b97ba0d1ff680411", "author": {"user": {"login": "roieg", "name": "Roie Geron"}}, "url": "https://github.com/openhab/openhab-addons/commit/b43a7bbab007d48a36e59882b97ba0d1ff680411", "committedDate": "2020-10-16T18:02:59Z", "message": "moved removeOlderResults(getTimestampOfLastScan())\n\nmoved  removeOlderResults(getTimestampOfLastScan()) to activate()\n\nSigned-off-by: Roie Geron <roie.geron@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bef9c85b5ff0482d19bad983cd38855c4e929e5b", "author": {"user": {"login": "roieg", "name": "Roie Geron"}}, "url": "https://github.com/openhab/openhab-addons/commit/bef9c85b5ff0482d19bad983cd38855c4e929e5b", "committedDate": "2020-10-16T18:15:11Z", "message": "moved private declarations after static\n\nSigned-off-by: Roie Geron <roie.geron@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3999e9f903611287546e07f62a85dbadd322a0e1", "author": {"user": {"login": "roieg", "name": "Roie Geron"}}, "url": "https://github.com/openhab/openhab-addons/commit/3999e9f903611287546e07f62a85dbadd322a0e1", "committedDate": "2020-10-16T18:23:09Z", "message": "add private to ScheduledExecutorService scheduler\n\nSigned-off-by: Roie Geron <roie.geron@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af9da70abcf35d9d27002e4d6e7ed7c2e264b426", "author": {"user": {"login": "roieg", "name": "Roie Geron"}}, "url": "https://github.com/openhab/openhab-addons/commit/af9da70abcf35d9d27002e4d6e7ed7c2e264b426", "committedDate": "2020-10-17T15:29:41Z", "message": "Review changes\n\nAdd encode URL to user and pass\nsync initialize and dispose\ncancel socketReconnect in case of dispose\n\nSigned-off-by: Roie Geron <roie.geron@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExMDA0MDM5", "url": "https://github.com/openhab/openhab-addons/pull/8754#pullrequestreview-511004039", "createdAt": "2020-10-17T17:56:19Z", "commit": {"oid": "af9da70abcf35d9d27002e4d6e7ed7c2e264b426"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xN1QxNzo1NjoxOVrOHje2Tg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xN1QxODoxNzoyNVrOHje9fw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk2NzYzMA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void dispose() {\n          \n          \n            \n                public synchronized void dispose() {", "url": "https://github.com/openhab/openhab-addons/pull/8754#discussion_r506967630", "createdAt": "2020-10-17T17:56:19Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.touchwand/src/main/java/org/openhab/binding/touchwand/internal/TouchWandBridgeHandler.java", "diffHunk": "@@ -105,6 +114,7 @@ public int getStatusRefreshTime() {\n \n     @Override\n     public void dispose() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "af9da70abcf35d9d27002e4d6e7ed7c2e264b426"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk2NzczMA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if (socketReconnect != null) {\n          \n          \n            \n                            socketReconnect.cancel(true);\n          \n          \n            \n                        }\n          \n          \n            \n                        ScheduledFuture<?> mySocketReconnect = socketReconnect;\n          \n          \n            \n                        if (mySocketReconnect != null) {\n          \n          \n            \n                            mySocketReconnect.cancel(true);\n          \n          \n            \n                        }", "url": "https://github.com/openhab/openhab-addons/pull/8754#discussion_r506967730", "createdAt": "2020-10-17T17:57:24Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.touchwand/src/main/java/org/openhab/binding/touchwand/internal/TouchWandWebSockets.java", "diffHunk": "@@ -99,6 +99,9 @@ public void dispose() {\n         isShutDown = true;\n         try {\n             client.stop();\n+            if (socketReconnect != null) {\n+                socketReconnect.cancel(true);\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "af9da70abcf35d9d27002e4d6e7ed7c2e264b426"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk2ODIzNg==", "bodyText": "You can remove this", "url": "https://github.com/openhab/openhab-addons/pull/8754#discussion_r506968236", "createdAt": "2020-10-17T18:03:16Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.touchwand/src/main/java/org/openhab/binding/touchwand/internal/TouchWandWebSockets.java", "diffHunk": "@@ -0,0 +1,196 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.touchwand.internal;\n+\n+import static org.openhab.binding.touchwand.internal.TouchWandBindingConstants.SUPPORTED_TOUCHWAND_TYPES;\n+\n+import java.io.IOException;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.util.Arrays;\n+import java.util.concurrent.CopyOnWriteArraySet;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.jetty.websocket.api.Session;\n+import org.eclipse.jetty.websocket.api.annotations.OnWebSocketClose;\n+import org.eclipse.jetty.websocket.api.annotations.OnWebSocketConnect;\n+import org.eclipse.jetty.websocket.api.annotations.OnWebSocketError;\n+import org.eclipse.jetty.websocket.api.annotations.OnWebSocketMessage;\n+import org.eclipse.jetty.websocket.api.annotations.WebSocket;\n+import org.eclipse.jetty.websocket.client.ClientUpgradeRequest;\n+import org.eclipse.jetty.websocket.client.WebSocketClient;\n+import org.openhab.binding.touchwand.internal.dto.TouchWandUnitData;\n+import org.openhab.binding.touchwand.internal.dto.TouchWandUnitFromJson;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParser;\n+import com.google.gson.JsonSyntaxException;\n+\n+/**\n+ * The {@link TouchWandWebSockets} class implements WebSockets API to TouchWand controller\n+ *\n+ * @author Roie Geron - Initial contribution\n+ */\n+@NonNullByDefault\n+public class TouchWandWebSockets {\n+\n+    private static final int CONNECT_TIMEOUT_SEC = 10;\n+    private static final int WEBSOCKET_RECONNECT_INTERVAL_SEC = CONNECT_TIMEOUT_SEC * 2;\n+    private static final int WEBSOCKET_IDLE_TIMEOUT_MS = CONNECT_TIMEOUT_SEC * 10 * 1000;\n+    private final Logger logger = LoggerFactory.getLogger(TouchWandWebSockets.class);\n+    private static final String WS_ENDPOINT_TOUCHWAND = \"/async\";\n+\n+    private WebSocketClient client;\n+    private String controllerAddress;\n+    private TouchWandSocket touchWandSocket;\n+    private boolean isShutDown = false;\n+    private CopyOnWriteArraySet<TouchWandUnitStatusUpdateListener> listeners = new CopyOnWriteArraySet<>();\n+    private @Nullable ScheduledFuture<?> socketReconnect;\n+    private @Nullable URI uri;\n+\n+    private ScheduledExecutorService scheduler;\n+\n+    public TouchWandWebSockets(String ipAddress, ScheduledExecutorService scheduler) {\n+        client = new WebSocketClient();\n+        touchWandSocket = new TouchWandSocket();\n+        this.controllerAddress = ipAddress;\n+        this.scheduler = scheduler;\n+        socketReconnect = null;\n+    }\n+\n+    public void connect() {\n+        try {\n+            uri = new URI(\"ws://\" + controllerAddress + WS_ENDPOINT_TOUCHWAND);\n+        } catch (URISyntaxException e) {\n+            logger.warn(\"URI not valid {} message {}\", uri, e.getMessage());\n+            return;\n+        }\n+\n+        client.setConnectTimeout(CONNECT_TIMEOUT_SEC);\n+        ClientUpgradeRequest request = new ClientUpgradeRequest();\n+        request.setSubProtocols(\"relay_protocol\");\n+\n+        try {\n+            client.start();\n+            client.connect(touchWandSocket, uri, request);\n+        } catch (Exception e) {\n+            logger.warn(\"Could not connect webSocket URI {} message {}\", uri, e.getMessage());\n+            return;\n+        }\n+    }\n+\n+    public void dispose() {\n+        isShutDown = true;\n+        try {\n+            client.stop();\n+            if (socketReconnect != null) {\n+                socketReconnect.cancel(true);\n+            }\n+        } catch (Exception e) {\n+            logger.warn(\"Could not stop webSocketClient,  message {}\", e.getMessage());\n+        }\n+    }\n+\n+    public void registerListener(TouchWandUnitStatusUpdateListener listener) {\n+        if (!listeners.contains(listener)) {\n+            logger.debug(\"Adding TouchWandWebSocket listener {}\", listener);\n+            listeners.add(listener);\n+        }\n+    }\n+\n+    public void unregisterListener(TouchWandUnitStatusUpdateListener listener) {\n+        logger.debug(\"Removing TouchWandWebSocket listener {}\", listener);\n+        listeners.remove(listener);\n+    }\n+\n+    @WebSocket(maxIdleTime = WEBSOCKET_IDLE_TIMEOUT_MS)\n+    public class TouchWandSocket {\n+\n+        public TouchWandSocket() {\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "af9da70abcf35d9d27002e4d6e7ed7c2e264b426"}, "originalPosition": 126}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk2ODMwNQ==", "bodyText": "Please try to catch specific exceptions here. At the very least catch RuntimeException instead.", "url": "https://github.com/openhab/openhab-addons/pull/8754#discussion_r506968305", "createdAt": "2020-10-17T18:04:10Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.touchwand/src/main/java/org/openhab/binding/touchwand/internal/TouchWandWebSockets.java", "diffHunk": "@@ -0,0 +1,196 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.touchwand.internal;\n+\n+import static org.openhab.binding.touchwand.internal.TouchWandBindingConstants.SUPPORTED_TOUCHWAND_TYPES;\n+\n+import java.io.IOException;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.util.Arrays;\n+import java.util.concurrent.CopyOnWriteArraySet;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.jetty.websocket.api.Session;\n+import org.eclipse.jetty.websocket.api.annotations.OnWebSocketClose;\n+import org.eclipse.jetty.websocket.api.annotations.OnWebSocketConnect;\n+import org.eclipse.jetty.websocket.api.annotations.OnWebSocketError;\n+import org.eclipse.jetty.websocket.api.annotations.OnWebSocketMessage;\n+import org.eclipse.jetty.websocket.api.annotations.WebSocket;\n+import org.eclipse.jetty.websocket.client.ClientUpgradeRequest;\n+import org.eclipse.jetty.websocket.client.WebSocketClient;\n+import org.openhab.binding.touchwand.internal.dto.TouchWandUnitData;\n+import org.openhab.binding.touchwand.internal.dto.TouchWandUnitFromJson;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParser;\n+import com.google.gson.JsonSyntaxException;\n+\n+/**\n+ * The {@link TouchWandWebSockets} class implements WebSockets API to TouchWand controller\n+ *\n+ * @author Roie Geron - Initial contribution\n+ */\n+@NonNullByDefault\n+public class TouchWandWebSockets {\n+\n+    private static final int CONNECT_TIMEOUT_SEC = 10;\n+    private static final int WEBSOCKET_RECONNECT_INTERVAL_SEC = CONNECT_TIMEOUT_SEC * 2;\n+    private static final int WEBSOCKET_IDLE_TIMEOUT_MS = CONNECT_TIMEOUT_SEC * 10 * 1000;\n+    private final Logger logger = LoggerFactory.getLogger(TouchWandWebSockets.class);\n+    private static final String WS_ENDPOINT_TOUCHWAND = \"/async\";\n+\n+    private WebSocketClient client;\n+    private String controllerAddress;\n+    private TouchWandSocket touchWandSocket;\n+    private boolean isShutDown = false;\n+    private CopyOnWriteArraySet<TouchWandUnitStatusUpdateListener> listeners = new CopyOnWriteArraySet<>();\n+    private @Nullable ScheduledFuture<?> socketReconnect;\n+    private @Nullable URI uri;\n+\n+    private ScheduledExecutorService scheduler;\n+\n+    public TouchWandWebSockets(String ipAddress, ScheduledExecutorService scheduler) {\n+        client = new WebSocketClient();\n+        touchWandSocket = new TouchWandSocket();\n+        this.controllerAddress = ipAddress;\n+        this.scheduler = scheduler;\n+        socketReconnect = null;\n+    }\n+\n+    public void connect() {\n+        try {\n+            uri = new URI(\"ws://\" + controllerAddress + WS_ENDPOINT_TOUCHWAND);\n+        } catch (URISyntaxException e) {\n+            logger.warn(\"URI not valid {} message {}\", uri, e.getMessage());\n+            return;\n+        }\n+\n+        client.setConnectTimeout(CONNECT_TIMEOUT_SEC);\n+        ClientUpgradeRequest request = new ClientUpgradeRequest();\n+        request.setSubProtocols(\"relay_protocol\");\n+\n+        try {\n+            client.start();\n+            client.connect(touchWandSocket, uri, request);\n+        } catch (Exception e) {\n+            logger.warn(\"Could not connect webSocket URI {} message {}\", uri, e.getMessage());\n+            return;\n+        }\n+    }\n+\n+    public void dispose() {\n+        isShutDown = true;\n+        try {\n+            client.stop();\n+            if (socketReconnect != null) {\n+                socketReconnect.cancel(true);\n+            }\n+        } catch (Exception e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "af9da70abcf35d9d27002e4d6e7ed7c2e264b426"}, "originalPosition": 105}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk2ODQ3OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    DatagramSocket mySocket;\n          \n          \n            \n                    private DatagramSocket mySocket;", "url": "https://github.com/openhab/openhab-addons/pull/8754#discussion_r506968478", "createdAt": "2020-10-17T18:05:52Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.touchwand/src/main/java/org/openhab/binding/touchwand/internal/discovery/TouchWandControllerDiscoveryService.java", "diffHunk": "@@ -0,0 +1,148 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+\n+package org.openhab.binding.touchwand.internal.discovery;\n+\n+import static org.openhab.binding.touchwand.internal.TouchWandBindingConstants.THING_TYPE_BRIDGE;\n+\n+import java.io.IOException;\n+import java.net.DatagramPacket;\n+import java.net.DatagramSocket;\n+import java.net.InetAddress;\n+import java.net.SocketException;\n+import java.nio.charset.StandardCharsets;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.openhab.binding.touchwand.internal.TouchWandBindingConstants;\n+import org.openhab.binding.touchwand.internal.TouchWandBridgeHandler;\n+import org.openhab.core.config.discovery.AbstractDiscoveryService;\n+import org.openhab.core.config.discovery.DiscoveryResultBuilder;\n+import org.openhab.core.config.discovery.DiscoveryService;\n+import org.openhab.core.thing.ThingUID;\n+import org.osgi.service.component.annotations.Component;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link TouchWandControllerDiscoveryService} Discovery service for Touchwand Controllers.\n+ *\n+ * @author Roie Geron - Initial contribution\n+ */\n+@Component(service = DiscoveryService.class, configurationPid = \"discovery.touchwand\")\n+@NonNullByDefault\n+public class TouchWandControllerDiscoveryService extends AbstractDiscoveryService {\n+\n+    private static final int SEARCH_TIME_SEC = 2;\n+    private static final int TOUCHWAND_BCAST_PORT = 35000;\n+    private final Logger logger = LoggerFactory.getLogger(TouchWandControllerDiscoveryService.class);\n+\n+    private @Nullable Thread socketReceiveThread = null;\n+    private DatagramSocket listenSocket;\n+\n+    public TouchWandControllerDiscoveryService() throws SocketException {\n+        super(TouchWandBridgeHandler.SUPPORTED_THING_TYPES, SEARCH_TIME_SEC, true);\n+\n+        listenSocket = new DatagramSocket(TOUCHWAND_BCAST_PORT);\n+    }\n+\n+    @Override\n+    protected void startScan() {\n+        DatagramSocket localListenSocket = listenSocket;\n+        runReceiveThread(localListenSocket);\n+    }\n+\n+    @Override\n+    protected void stopScan() {\n+        super.stopScan();\n+    }\n+\n+    @Override\n+    public void activate(@Nullable Map<String, @Nullable Object> configProperties) {\n+        removeOlderResults(getTimestampOfLastScan());\n+        super.activate(configProperties);\n+    }\n+\n+    @Override\n+    public void deactivate() {\n+        Thread mySocketReceiveThread = socketReceiveThread;\n+        if (mySocketReceiveThread != null) {\n+            mySocketReceiveThread.interrupt();\n+            socketReceiveThread = null;\n+        }\n+\n+        listenSocket.close();\n+        super.deactivate();\n+    }\n+\n+    private void addDeviceDiscoveryResult(String label, String ip) {\n+        String id = ip.replaceAll(\"\\\\.\", \"\");\n+        ThingUID thingUID = new ThingUID(THING_TYPE_BRIDGE, id);\n+        Map<String, Object> properties = new HashMap<>();\n+        properties.put(\"label\", label);\n+        properties.put(\"ipAddress\", ip);\n+        // @formatter:off\n+        logger.debug(\"Add new Bridge label:{} id {} \",label, id);\n+        thingDiscovered(DiscoveryResultBuilder.create(thingUID)\n+                .withThingType(THING_TYPE_BRIDGE)\n+                .withLabel(label)\n+                .withProperties(properties)\n+                .withRepresentationProperty(\"ipAddress\")\n+                .build()\n+        );\n+        // @formatter:on\n+    }\n+\n+    protected void runReceiveThread(DatagramSocket socket) {\n+        Thread localSocketReceivedThread = socketReceiveThread = new ReceiverThread(socket);\n+        localSocketReceivedThread.setName(TouchWandBindingConstants.DISCOVERY_THREAD_ID);\n+        localSocketReceivedThread.start();\n+    }\n+\n+    private class ReceiverThread extends Thread {\n+\n+        private static final int BUFFER_LENGTH = 256;\n+        private DatagramPacket dgram = new DatagramPacket(new byte[BUFFER_LENGTH], BUFFER_LENGTH);\n+        DatagramSocket mySocket;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "af9da70abcf35d9d27002e4d6e7ed7c2e264b426"}, "originalPosition": 118}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk2ODUxMg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    localSocketReceivedThread.setName(TouchWandBindingConstants.DISCOVERY_THREAD_ID);\n          \n          \n            \n                    localSocketReceivedThread.start();\n          \n          \n            \n                    localSocketReceivedThread.setName(TouchWandBindingConstants.DISCOVERY_THREAD_ID);\n          \n          \n            \n                    localSocketReceivedThread.setDaemon(true);\n          \n          \n            \n                    localSocketReceivedThread.start();", "url": "https://github.com/openhab/openhab-addons/pull/8754#discussion_r506968512", "createdAt": "2020-10-17T18:06:13Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.touchwand/src/main/java/org/openhab/binding/touchwand/internal/discovery/TouchWandControllerDiscoveryService.java", "diffHunk": "@@ -0,0 +1,148 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+\n+package org.openhab.binding.touchwand.internal.discovery;\n+\n+import static org.openhab.binding.touchwand.internal.TouchWandBindingConstants.THING_TYPE_BRIDGE;\n+\n+import java.io.IOException;\n+import java.net.DatagramPacket;\n+import java.net.DatagramSocket;\n+import java.net.InetAddress;\n+import java.net.SocketException;\n+import java.nio.charset.StandardCharsets;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.openhab.binding.touchwand.internal.TouchWandBindingConstants;\n+import org.openhab.binding.touchwand.internal.TouchWandBridgeHandler;\n+import org.openhab.core.config.discovery.AbstractDiscoveryService;\n+import org.openhab.core.config.discovery.DiscoveryResultBuilder;\n+import org.openhab.core.config.discovery.DiscoveryService;\n+import org.openhab.core.thing.ThingUID;\n+import org.osgi.service.component.annotations.Component;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link TouchWandControllerDiscoveryService} Discovery service for Touchwand Controllers.\n+ *\n+ * @author Roie Geron - Initial contribution\n+ */\n+@Component(service = DiscoveryService.class, configurationPid = \"discovery.touchwand\")\n+@NonNullByDefault\n+public class TouchWandControllerDiscoveryService extends AbstractDiscoveryService {\n+\n+    private static final int SEARCH_TIME_SEC = 2;\n+    private static final int TOUCHWAND_BCAST_PORT = 35000;\n+    private final Logger logger = LoggerFactory.getLogger(TouchWandControllerDiscoveryService.class);\n+\n+    private @Nullable Thread socketReceiveThread = null;\n+    private DatagramSocket listenSocket;\n+\n+    public TouchWandControllerDiscoveryService() throws SocketException {\n+        super(TouchWandBridgeHandler.SUPPORTED_THING_TYPES, SEARCH_TIME_SEC, true);\n+\n+        listenSocket = new DatagramSocket(TOUCHWAND_BCAST_PORT);\n+    }\n+\n+    @Override\n+    protected void startScan() {\n+        DatagramSocket localListenSocket = listenSocket;\n+        runReceiveThread(localListenSocket);\n+    }\n+\n+    @Override\n+    protected void stopScan() {\n+        super.stopScan();\n+    }\n+\n+    @Override\n+    public void activate(@Nullable Map<String, @Nullable Object> configProperties) {\n+        removeOlderResults(getTimestampOfLastScan());\n+        super.activate(configProperties);\n+    }\n+\n+    @Override\n+    public void deactivate() {\n+        Thread mySocketReceiveThread = socketReceiveThread;\n+        if (mySocketReceiveThread != null) {\n+            mySocketReceiveThread.interrupt();\n+            socketReceiveThread = null;\n+        }\n+\n+        listenSocket.close();\n+        super.deactivate();\n+    }\n+\n+    private void addDeviceDiscoveryResult(String label, String ip) {\n+        String id = ip.replaceAll(\"\\\\.\", \"\");\n+        ThingUID thingUID = new ThingUID(THING_TYPE_BRIDGE, id);\n+        Map<String, Object> properties = new HashMap<>();\n+        properties.put(\"label\", label);\n+        properties.put(\"ipAddress\", ip);\n+        // @formatter:off\n+        logger.debug(\"Add new Bridge label:{} id {} \",label, id);\n+        thingDiscovered(DiscoveryResultBuilder.create(thingUID)\n+                .withThingType(THING_TYPE_BRIDGE)\n+                .withLabel(label)\n+                .withProperties(properties)\n+                .withRepresentationProperty(\"ipAddress\")\n+                .build()\n+        );\n+        // @formatter:on\n+    }\n+\n+    protected void runReceiveThread(DatagramSocket socket) {\n+        Thread localSocketReceivedThread = socketReceiveThread = new ReceiverThread(socket);\n+        localSocketReceivedThread.setName(TouchWandBindingConstants.DISCOVERY_THREAD_ID);\n+        localSocketReceivedThread.start();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "af9da70abcf35d9d27002e4d6e7ed7c2e264b426"}, "originalPosition": 111}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk2OTQ3MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Nullable\n          \n          \n            \n                protected TouchWandBridgeHandler bridgeHandler;\n          \n          \n            \n                protected @Nullable TouchWandBridgeHandler bridgeHandler;", "url": "https://github.com/openhab/openhab-addons/pull/8754#discussion_r506969471", "createdAt": "2020-10-17T18:17:25Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.touchwand/src/main/java/org/openhab/binding/touchwand/internal/TouchWandBaseUnitHandler.java", "diffHunk": "@@ -0,0 +1,158 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.touchwand.internal;\n+\n+import static org.openhab.binding.touchwand.internal.TouchWandBindingConstants.*;\n+\n+import java.util.Set;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.openhab.binding.touchwand.internal.dto.TouchWandUnitData;\n+import org.openhab.core.thing.Bridge;\n+import org.openhab.core.thing.ChannelUID;\n+import org.openhab.core.thing.Thing;\n+import org.openhab.core.thing.ThingStatus;\n+import org.openhab.core.thing.ThingStatusDetail;\n+import org.openhab.core.thing.ThingTypeUID;\n+import org.openhab.core.thing.binding.BaseThingHandler;\n+import org.openhab.core.types.Command;\n+import org.openhab.core.types.RefreshType;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParseException;\n+import com.google.gson.JsonParser;\n+\n+/**\n+ * The {@link TouchWandBaseUnitHandler} is responsible for handling commands and status updates\n+ * for TouchWand units. This is an abstract class , units should implement the specific command\n+ * handling and status updates.\n+ *\n+ * @author Roie Geron - Initial contribution\n+ *\n+ */\n+@NonNullByDefault\n+public abstract class TouchWandBaseUnitHandler extends BaseThingHandler implements TouchWandUnitUpdateListener {\n+\n+    protected final Logger logger = LoggerFactory.getLogger(TouchWandBaseUnitHandler.class);\n+    public static final Set<ThingTypeUID> SUPPORTED_THING_TYPES = Set.of(THING_TYPE_SHUTTER, THING_TYPE_SWITCH,\n+            THING_TYPE_WALLCONTROLLER, THING_TYPE_DIMMER);\n+    protected String unitId = \"\";\n+\n+    @Nullable\n+    protected TouchWandBridgeHandler bridgeHandler;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "af9da70abcf35d9d27002e4d6e7ed7c2e264b426"}, "originalPosition": 55}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1279d4765265fd4968444b9c414c5cf87946f21", "author": {"user": {"login": "roieg", "name": "Roie Geron"}}, "url": "https://github.com/openhab/openhab-addons/commit/d1279d4765265fd4968444b9c414c5cf87946f21", "committedDate": "2020-10-17T19:48:03Z", "message": "Changes requeste in @cpmeister review\n\nSigned-off-by: Roie Geron <roie.geron@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExMDExODM1", "url": "https://github.com/openhab/openhab-addons/pull/8754#pullrequestreview-511011835", "createdAt": "2020-10-17T20:05:39Z", "commit": {"oid": "d1279d4765265fd4968444b9c414c5cf87946f21"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4574, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}