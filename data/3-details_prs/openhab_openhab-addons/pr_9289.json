{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM0Mzc5MTQy", "number": 9289, "title": "[miio] Elimate several SAT warnings", "bodyText": "eliminating sat warnings and minor improvements in the miloudconnector for failed attempts", "createdAt": "2020-12-08T11:17:02Z", "url": "https://github.com/openhab/openhab-addons/pull/9289", "merged": true, "mergeCommit": {"oid": "5bfc8940f4831049b5180d7f578620260a3a6ed9"}, "closed": true, "closedAt": "2020-12-12T23:27:55Z", "author": {"login": "marcelrv"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdkIDhoAH2gAyNTM0Mzc5MTQyOjkxNWEyMTYwNTJjOGYyYjNlMzFjNjI3ZGJkODE5ZjgwNWU0YzdhZTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdlhjfeAFqTU1MDg1NTIyNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "915a216052c8f2b3e31c627dbd819f805e4c7ae2", "author": {"user": {"login": "marcelrv", "name": "Marcel"}}, "url": "https://github.com/openhab/openhab-addons/commit/915a216052c8f2b3e31c627dbd819f805e4c7ae2", "committedDate": "2020-12-08T11:01:36Z", "message": "[miio] eliminate warnings from mapdraw\n\nSigned-off-by: Marcel Verpaalen <marcel@verpaalen.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "575e7d2569f9f701d0f4c5b3f091cb395c35c7bb", "author": {"user": {"login": "marcelrv", "name": "Marcel"}}, "url": "https://github.com/openhab/openhab-addons/commit/575e7d2569f9f701d0f4c5b3f091cb395c35c7bb", "committedDate": "2020-12-08T11:01:39Z", "message": "[miio] clean warnings from basic handler\n\nSigned-off-by: Marcel Verpaalen <marcel@verpaalen.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b2bfa96c5fd60dcc65d86d89df85cc82fbe593d", "author": {"user": {"login": "marcelrv", "name": "Marcel"}}, "url": "https://github.com/openhab/openhab-addons/commit/9b2bfa96c5fd60dcc65d86d89df85cc82fbe593d", "committedDate": "2020-12-08T11:09:35Z", "message": "[miio] avoid apache commons warning in utils\n\nSigned-off-by: Marcel Verpaalen <marcel@verpaalen.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0224054d366a3b684ecd42d462b38253a3dd5823", "author": {"user": {"login": "marcelrv", "name": "Marcel"}}, "url": "https://github.com/openhab/openhab-addons/commit/0224054d366a3b684ecd42d462b38253a3dd5823", "committedDate": "2020-12-08T11:12:37Z", "message": "[miio] eliminate warnings from micloudconnector\n\nSigned-off-by: Marcel Verpaalen <marcel@verpaalen.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3NDYwMDk2", "url": "https://github.com/openhab/openhab-addons/pull/9289#pullrequestreview-547460096", "createdAt": "2020-12-08T17:25:07Z", "commit": {"oid": "0224054d366a3b684ecd42d462b38253a3dd5823"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxNzoyNTowN1rOIBraag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxNzoyNjowMVrOIBreFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODYzMDc2Mg==", "bodyText": "Nullable annotations aren't required for local variables. This can be removed.", "url": "https://github.com/openhab/openhab-addons/pull/9289#discussion_r538630762", "createdAt": "2020-12-08T17:25:07Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/cloud/MiCloudConnector.java", "diffHunk": "@@ -492,9 +514,10 @@ private void dumpCookies(String url, boolean delete) {\n         if (logger.isTraceEnabled()) {\n             try {\n                 URI uri = URI.create(url);\n-                if (uri != null) {\n-                    logger.trace(\"Cookie dump for {}\", uri);\n-                    CookieStore cs = httpClient.getCookieStore();\n+                logger.trace(\"Cookie dump for {}\", uri);\n+                @Nullable", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0224054d366a3b684ecd42d462b38253a3dd5823"}, "originalPosition": 207}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODYzMTcwMA==", "bodyText": "same here", "url": "https://github.com/openhab/openhab-addons/pull/9289#discussion_r538631700", "createdAt": "2020-12-08T17:26:01Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/robot/RRMapDraw.java", "diffHunk": "@@ -379,6 +382,7 @@ private void drawOpenHabRocks(Graphics2D g2d, int width, int height, float scale\n         } catch (IOException e) {\n             logger.debug(\"Error loading image ohlogo.png:: {}\", e.getMessage());\n         }\n+        @Nullable", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0224054d366a3b684ecd42d462b38253a3dd5823"}, "originalPosition": 55}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99e78df1476fe4ce564f7496cd4fc4576549b86c", "author": {"user": {"login": "marcelrv", "name": "Marcel"}}, "url": "https://github.com/openhab/openhab-addons/commit/99e78df1476fe4ce564f7496cd4fc4576549b86c", "committedDate": "2020-12-08T18:02:46Z", "message": "[miio] update from feedback. remove @Nullable for local variables\n\nSigned-off-by: Marcel Verpaalen <marcel@verpaalen.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "785c1247031f23c60781c24832911b3b6359a655", "author": {"user": {"login": "marcelrv", "name": "Marcel"}}, "url": "https://github.com/openhab/openhab-addons/commit/785c1247031f23c60781c24832911b3b6359a655", "committedDate": "2020-12-08T18:05:04Z", "message": "[miio] one more\n\nSigned-off-by: Marcel Verpaalen <marcel@verpaalen.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3NjAxNDc2", "url": "https://github.com/openhab/openhab-addons/pull/9289#pullrequestreview-547601476", "createdAt": "2020-12-08T20:25:41Z", "commit": {"oid": "785c1247031f23c60781c24832911b3b6359a655"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQyMDoyNTo0MVrOIB0oZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQyMDoyNTo0MVrOIB0oZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc4MTc5Ng==", "bodyText": "You don't have to call toString it will be called automatically, but only when the logging-level actually applies.", "url": "https://github.com/openhab/openhab-addons/pull/9289#discussion_r538781796", "createdAt": "2020-12-08T20:25:41Z", "author": {"login": "martinvw"}, "path": "bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/cloud/MiCloudConnector.java", "diffHunk": "@@ -154,22 +155,26 @@ public String getMapUrl(String vacuumMap, String country) throws MiCloudExceptio\n         String mapResponse = request(url, map);\n         logger.trace(\"response: {}\", mapResponse);\n         String errorMsg = \"\";\n-        JsonElement response = PARSER.parse(mapResponse);\n-        if (response.isJsonObject()) {\n-            logger.debug(\"Received  JSON message {}\", response.toString());\n-            if (response.getAsJsonObject().has(\"result\") && response.getAsJsonObject().get(\"result\").isJsonObject()) {\n-                JsonObject jo = response.getAsJsonObject().get(\"result\").getAsJsonObject();\n-                if (jo.has(\"url\")) {\n-                    String mapUrl = jo.get(\"url\").getAsString();\n-                    return mapUrl != null ? mapUrl : \"\";\n+        try {\n+            JsonElement response = PARSER.parse(mapResponse);\n+            if (response.isJsonObject()) {\n+                logger.debug(\"Received  JSON message {}\", response.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "785c1247031f23c60781c24832911b3b6359a655"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4a7d03c361533052cbd25ae0787ec9fda805547", "author": {"user": {"login": "marcelrv", "name": "Marcel"}}, "url": "https://github.com/openhab/openhab-addons/commit/e4a7d03c361533052cbd25ae0787ec9fda805547", "committedDate": "2020-12-08T20:32:11Z", "message": "[miio] update from feedback-remove tostring\n\nSigned-off-by: Marcel Verpaalen <marcel@verpaalen.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwNDM2MTY5", "url": "https://github.com/openhab/openhab-addons/pull/9289#pullrequestreview-550436169", "createdAt": "2020-12-11T18:32:06Z", "commit": {"oid": "e4a7d03c361533052cbd25ae0787ec9fda805547"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxODozMjowNlrOIEE7_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxODo1NTowOVrOIEFuGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTE0NjExMA==", "bodyText": "Please cache cmdResponse.get(0) in a local variable.", "url": "https://github.com/openhab/openhab-addons/pull/9289#discussion_r541146110", "createdAt": "2020-12-11T18:32:06Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/handler/MiIoBasicHandler.java", "diffHunk": "@@ -641,19 +642,21 @@ public void onMessageReceived(MiIoSendCommand response) {\n                 default:\n                     if (refreshListCustomCommands.containsKey(response.getMethod())) {\n                         logger.debug(\"Processing custom refresh command response for !{}\", response.getMethod());\n-                        MiIoBasicChannel ch = refreshListCustomCommands.get(response.getMethod());\n-                        if (response.getResult().isJsonArray()) {\n-                            JsonArray cmdResponse = response.getResult().getAsJsonArray();\n-                            final String transformation = ch.getTransfortmation();\n-                            if (transformation == null || transformation.isBlank()) {\n-                                updateChannel(ch, ch.getChannel(),\n-                                        cmdResponse.get(0).isJsonPrimitive() ? cmdResponse.get(0)\n-                                                : new JsonPrimitive(cmdResponse.get(0).toString()));\n+                        final MiIoBasicChannel ch = refreshListCustomCommands.get(response.getMethod());\n+                        if (ch != null) {\n+                            if (response.getResult().isJsonArray()) {\n+                                JsonArray cmdResponse = response.getResult().getAsJsonArray();\n+                                final String transformation = ch.getTransfortmation();\n+                                if (transformation == null || transformation.isBlank()) {\n+                                    updateChannel(ch, ch.getChannel(),\n+                                            cmdResponse.get(0).isJsonPrimitive() ? cmdResponse.get(0)\n+                                                    : new JsonPrimitive(cmdResponse.get(0).toString()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4a7d03c361533052cbd25ae0787ec9fda805547"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTE0NjM0MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        final @Nullable MiIoBasicChannel miIoBasicChannel = actions.get(channelUID);\n          \n          \n            \n                        final MiIoBasicChannel miIoBasicChannel = actions.get(channelUID);", "url": "https://github.com/openhab/openhab-addons/pull/9289#discussion_r541146341", "createdAt": "2020-12-11T18:32:30Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/handler/MiIoBasicHandler.java", "diffHunk": "@@ -134,7 +135,7 @@ public void handleCommand(ChannelUID channelUID, Command receivedCommand) {\n         }\n         logger.debug(\"Locating action for {} channel '{}': '{}'\", getThing().getUID(), channelUID.getId(), command);\n         if (!actions.isEmpty()) {\n-            MiIoBasicChannel miIoBasicChannel = actions.get(channelUID);\n+            final @Nullable MiIoBasicChannel miIoBasicChannel = actions.get(channelUID);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4a7d03c361533052cbd25ae0787ec9fda805547"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTE0OTM0NA==", "bodyText": "What would throw either of these exceptions?", "url": "https://github.com/openhab/openhab-addons/pull/9289#discussion_r541149344", "createdAt": "2020-12-11T18:37:51Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/cloud/MiCloudConnector.java", "diffHunk": "@@ -154,22 +155,26 @@ public String getMapUrl(String vacuumMap, String country) throws MiCloudExceptio\n         String mapResponse = request(url, map);\n         logger.trace(\"response: {}\", mapResponse);\n         String errorMsg = \"\";\n-        JsonElement response = PARSER.parse(mapResponse);\n-        if (response.isJsonObject()) {\n-            logger.debug(\"Received  JSON message {}\", response.toString());\n-            if (response.getAsJsonObject().has(\"result\") && response.getAsJsonObject().get(\"result\").isJsonObject()) {\n-                JsonObject jo = response.getAsJsonObject().get(\"result\").getAsJsonObject();\n-                if (jo.has(\"url\")) {\n-                    String mapUrl = jo.get(\"url\").getAsString();\n-                    return mapUrl != null ? mapUrl : \"\";\n+        try {\n+            JsonElement response = PARSER.parse(mapResponse);\n+            if (response.isJsonObject()) {\n+                logger.debug(\"Received  JSON message {}\", response);\n+                if (response.getAsJsonObject().has(\"result\")\n+                        && response.getAsJsonObject().get(\"result\").isJsonObject()) {\n+                    JsonObject jo = response.getAsJsonObject().get(\"result\").getAsJsonObject();\n+                    if (jo.has(\"url\")) {\n+                        return jo.get(\"url\").getAsString();\n+                    } else {\n+                        errorMsg = \"Could not get url\";\n+                    }\n                 } else {\n-                    errorMsg = \"Could not get url\";\n+                    errorMsg = \"Could not get result\";\n                 }\n             } else {\n-                errorMsg = \"Could not get result\";\n+                errorMsg = \"Received message is invalid JSON\";\n             }\n-        } else {\n-            errorMsg = \"Received message is invalid JSON\";\n+        } catch (ClassCastException | IllegalStateException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4a7d03c361533052cbd25ae0787ec9fda805547"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTE1NzUyMw==", "bodyText": "While not a bad approach per se. In general you should avoid storing the entire file in memory if you would just pass it to another application for processing. Passing a reader for that file data would instead be preferable since it would allow the processing application to read and garbage collect data as it goes without requiring the entire file available at once.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    try (InputStream reader = fileName.openStream()) {\n          \n          \n            \n                        JsonElement jsonElement = parser.parse(new String(reader.readAllBytes(), StandardCharsets.UTF_8));\n          \n          \n            \n                    try (InputStream inputStream = fileName.openStream();\n          \n          \n            \n                           InputStreamReader reader = new InputStreamReader(inputStream, StandardCharsets.UTF_8)) {\n          \n          \n            \n                        JsonElement jsonElement = parser.parse(reader);", "url": "https://github.com/openhab/openhab-addons/pull/9289#discussion_r541157523", "createdAt": "2020-12-11T18:52:43Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/Utils.java", "diffHunk": "@@ -90,12 +94,15 @@ public static String obfuscateToken(String tokenString) {\n         }\n     }\n \n-    public static JsonObject convertFileToJSON(URL fileName) throws JsonIOException, JsonSyntaxException, IOException {\n+    public static JsonObject convertFileToJSON(URL fileName) throws JsonIOException, JsonSyntaxException,\n+            JsonParseException, IOException, URISyntaxException, NoSuchFileException {\n         JsonObject jsonObject = new JsonObject();\n         JsonParser parser = new JsonParser();\n-        JsonElement jsonElement = parser.parse(IOUtils.toString(fileName));\n-        jsonObject = jsonElement.getAsJsonObject();\n-        return jsonObject;\n+        try (InputStream reader = fileName.openStream()) {\n+            JsonElement jsonElement = parser.parse(new String(reader.readAllBytes(), StandardCharsets.UTF_8));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4a7d03c361533052cbd25ae0787ec9fda805547"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTE1ODkzOA==", "bodyText": "What would throw a ClassCastException or IllegalStateException here?", "url": "https://github.com/openhab/openhab-addons/pull/9289#discussion_r541158938", "createdAt": "2020-12-11T18:55:09Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/cloud/MiCloudConnector.java", "diffHunk": "@@ -396,22 +414,21 @@ private String loginStep1() throws InterruptedException, TimeoutException, Execu\n         logger.trace(\"Xiaomi Login step 1 response = {}\", responseStep1);\n         try {\n             JsonElement resp = new JsonParser().parse(parseJson(content));\n-            if (resp.getAsJsonObject().has(\"_sign\")) {\n+            if (resp.isJsonObject() && resp.getAsJsonObject().has(\"_sign\")) {\n                 String sign = resp.getAsJsonObject().get(\"_sign\").getAsString();\n                 logger.trace(\"Xiaomi Login step 1 sign = {}\", sign);\n                 return sign;\n             } else {\n-                logger.trace(\"Xiaomi Login _sign missing. Maybe still has login cookie.\");\n+                logger.debug(\"Xiaomi Login _sign missing. Maybe still has login cookie.\");\n                 return \"\";\n             }\n-\n-        } catch (JsonSyntaxException | NullPointerException e) {\n+        } catch (JsonParseException | IllegalStateException | ClassCastException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4a7d03c361533052cbd25ae0787ec9fda805547"}, "originalPosition": 165}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c3cbc874995e8c89c162c2968290c37eb5b9a38", "author": {"user": {"login": "marcelrv", "name": "Marcel"}}, "url": "https://github.com/openhab/openhab-addons/commit/3c3cbc874995e8c89c162c2968290c37eb5b9a38", "committedDate": "2020-12-12T09:31:49Z", "message": "Apply suggestions from code review\n\nCo-authored-by: Connor Petty <mistercpp2000@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb1a0fdbac4de2097ab51f5f1223b919dd2073b8", "author": {"user": {"login": "marcelrv", "name": "Marcel"}}, "url": "https://github.com/openhab/openhab-addons/commit/cb1a0fdbac4de2097ab51f5f1223b919dd2073b8", "committedDate": "2020-12-12T09:39:48Z", "message": "[miio] updates from review feedback\n\nSigned-off-by: Marcel Verpaalen <marcel@verpaalen.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwODU1MjI3", "url": "https://github.com/openhab/openhab-addons/pull/9289#pullrequestreview-550855227", "createdAt": "2020-12-12T19:18:04Z", "commit": {"oid": "cb1a0fdbac4de2097ab51f5f1223b919dd2073b8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3682, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}