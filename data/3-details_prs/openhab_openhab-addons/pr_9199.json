{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMwOTc0MTYz", "number": 9199, "title": "[ipcamera] Improve ONVIF discovery and bug fixes.", "bodyText": "Closed #9167\nClosed #9023\nClosed #9022\nThis PR changes the following:\n\nFix Offline detection. Would not detect the camera was offline when not polling a snapshot.\nImprove ONVIF discovery. Now scans on all NICs instead of only the first interface the binding would find.\nFix motion alarm FFmpeg options. Config was not working correctly if the user supplied options was '-vf xxxxxx' due to binding already providing this argument already.\nImprove log by removing password from logged FFmpeg commands.\nRefactor some code to make it slightly faster and consistent between similar classes.", "createdAt": "2020-12-02T12:13:01Z", "url": "https://github.com/openhab/openhab-addons/pull/9199", "merged": true, "mergeCommit": {"oid": "84995bac835fafc76ae1d4696a857ba107a153ec"}, "closed": true, "closedAt": "2020-12-07T05:56:26Z", "author": {"login": "Skinah"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdhJKj4gH2gAyNTMwOTc0MTYzOjk0NDIwMmNkMDg2OTAxYThmMTNiYTk2NzNhZWRiMWUyM2UzYjI0YTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdjvEHUgFqTU0NTg0ODE0NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "944202cd086901a8f13ba9673aedb1e23e3b24a1", "author": {"user": {"login": "Skinah", "name": "Matthew Skinner"}}, "url": "https://github.com/openhab/openhab-addons/commit/944202cd086901a8f13ba9673aedb1e23e3b24a1", "committedDate": "2020-11-29T04:37:25Z", "message": "Fix Offline detection and Improve discovery.\n\n\nSigned-off-by: Matthew Skinner <matt@pcmus.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66fe756e24beed885d0f785bb4aeced24b2778cb", "author": {"user": {"login": "Skinah", "name": "Matthew Skinner"}}, "url": "https://github.com/openhab/openhab-addons/commit/66fe756e24beed885d0f785bb4aeced24b2778cb", "committedDate": "2020-11-29T06:22:30Z", "message": "Motion options bug fix.\n\n\nSigned-off-by: Matthew Skinner <matt@pcmus.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82dd7f93cc1df82d8b423460b3fa911f5a1ea23f", "author": {"user": {"login": "Skinah", "name": "Matthew Skinner"}}, "url": "https://github.com/openhab/openhab-addons/commit/82dd7f93cc1df82d8b423460b3fa911f5a1ea23f", "committedDate": "2020-11-29T13:26:46Z", "message": "Message content bug fix.\n\n\nSigned-off-by: Matthew Skinner <matt@pcmus.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d9877d9fa7e8420ab833848f63b833a80164f60", "author": {"user": {"login": "Skinah", "name": "Matthew Skinner"}}, "url": "https://github.com/openhab/openhab-addons/commit/5d9877d9fa7e8420ab833848f63b833a80164f60", "committedDate": "2020-12-01T06:21:10Z", "message": "Fix all handlers to process all chunks as one.\n\n\nSigned-off-by: Matthew Skinner <matt@pcmus.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "babfe24669e5e57faa767b705b02f487a9b3c7fe", "author": {"user": {"login": "Skinah", "name": "Matthew Skinner"}}, "url": "https://github.com/openhab/openhab-addons/commit/babfe24669e5e57faa767b705b02f487a9b3c7fe", "committedDate": "2020-12-01T10:58:24Z", "message": "Remove password from FFmpeg command log.\n\n\nSigned-off-by: Matthew Skinner <matt@pcmus.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bfaefff0f8126d412b3eb2ee4cbffdfaaead166d", "author": {"user": {"login": "Skinah", "name": "Matthew Skinner"}}, "url": "https://github.com/openhab/openhab-addons/commit/bfaefff0f8126d412b3eb2ee4cbffdfaaead166d", "committedDate": "2020-12-02T10:48:19Z", "message": "Reverse some changes after testing.\n\n\nSigned-off-by: Matthew Skinner <matt@pcmus.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d27e48cb9744034fdb158d3dc0afb676818f053e", "author": {"user": {"login": "Skinah", "name": "Matthew Skinner"}}, "url": "https://github.com/openhab/openhab-addons/commit/d27e48cb9744034fdb158d3dc0afb676818f053e", "committedDate": "2020-12-02T11:03:17Z", "message": "Instar reverse.\n\n\nSigned-off-by: Matthew Skinner <matt@pcmus.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bca198146376aea515e7ec040e8ed8f751ab0d10", "author": {"user": {"login": "Skinah", "name": "Matthew Skinner"}}, "url": "https://github.com/openhab/openhab-addons/commit/bca198146376aea515e7ec040e8ed8f751ab0d10", "committedDate": "2020-12-02T11:47:47Z", "message": "clean up\n\n\nSigned-off-by: Matthew Skinner <matt@pcmus.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1MzA5OTA5", "url": "https://github.com/openhab/openhab-addons/pull/9199#pullrequestreview-545309909", "createdAt": "2020-12-04T21:32:02Z", "commit": {"oid": "bca198146376aea515e7ec040e8ed8f751ab0d10"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQyMTozMjowM1rOH_ivzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQyMTo0MDoxM1rOH_i93w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM5MTYyOQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                ffmpegCommand.replaceAll(password, \"passwordRemoved\"));\n          \n          \n            \n                                ffmpegCommand.replaceAll(password, \"********\"));", "url": "https://github.com/openhab/openhab-addons/pull/9199#discussion_r536391629", "createdAt": "2020-12-04T21:32:03Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.ipcamera/src/main/java/org/openhab/binding/ipcamera/internal/Ffmpeg.java", "diffHunk": "@@ -169,7 +171,8 @@ public void run() {\n     public void startConverting() {\n         if (!ipCameraFfmpegThread.isAlive()) {\n             ipCameraFfmpegThread = new IpCameraFfmpegThread();\n-            logger.debug(\"Starting ffmpeg with this command now:{}\", ffmpegCommand);\n+            logger.debug(\"Starting ffmpeg with this command now:{}\",\n+                    ffmpegCommand.replaceAll(password, \"passwordRemoved\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bca198146376aea515e7ec040e8ed8f751ab0d10"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM5NTIzMQ==", "bodyText": ".toString() might be an expensive operation, so calling it twice when you only need to call it once is a bad practice. The way it was before only called it once. What were you trying to address here with this change?", "url": "https://github.com/openhab/openhab-addons/pull/9199#discussion_r536395231", "createdAt": "2020-12-04T21:40:13Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.ipcamera/src/main/java/org/openhab/binding/ipcamera/internal/HikvisionHandler.java", "diffHunk": "@@ -64,18 +64,13 @@ public HikvisionHandler(ThingHandler handler, int nvrChannel) {\n     // This handles the incoming http replies back from the camera.\n     @Override\n     public void channelRead(@Nullable ChannelHandlerContext ctx, @Nullable Object msg) throws Exception {\n-        if (msg == null || ctx == null) {\n+        if (msg == null || ctx == null || msg.toString().isEmpty()) {\n             return;\n         }\n-        String content = \"\";\n-        int debounce = 3;\n         try {\n-            content = msg.toString();\n-            if (content.isEmpty()) {\n-                return;\n-            }\n+            int debounce = 3;\n+            String content = msg.toString();\n             logger.trace(\"HTTP Result back from camera is \\t:{}:\", content);\n-", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bca198146376aea515e7ec040e8ed8f751ab0d10"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1293922d512b1487927eba0b0e2134ee1bd92c2e", "author": {"user": {"login": "Skinah", "name": "Matthew Skinner"}}, "url": "https://github.com/openhab/openhab-addons/commit/1293922d512b1487927eba0b0e2134ee1bd92c2e", "committedDate": "2020-12-05T01:47:41Z", "message": "Update bundles/org.openhab.binding.ipcamera/src/main/java/org/openhab/binding/ipcamera/internal/Ffmpeg.java\r\n\r\nSigned-off-by: Matthew Skinner <matt@pcmus.com>\n\nCo-authored-by: Connor Petty <mistercpp2000@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7cae07ca51f222914b628badc12e366ce8c246e7", "author": {"user": {"login": "Skinah", "name": "Matthew Skinner"}}, "url": "https://github.com/openhab/openhab-addons/commit/7cae07ca51f222914b628badc12e366ce8c246e7", "committedDate": "2020-12-05T05:06:48Z", "message": "Remove un-needed tostring()\n\n\nSigned-off-by: Matthew Skinner <matt@pcmus.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1NDEzNTQ3", "url": "https://github.com/openhab/openhab-addons/pull/9199#pullrequestreview-545413547", "createdAt": "2020-12-05T05:39:22Z", "commit": {"oid": "7cae07ca51f222914b628badc12e366ce8c246e7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNVQwNTozOToyMlrOH_qkgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNVQwNTozOToyMlrOH_qkgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjUxOTgxMA==", "bodyText": "Does this still return a future that you should wait for? Or do you not need to do that anymore?", "url": "https://github.com/openhab/openhab-addons/pull/9199#discussion_r536519810", "createdAt": "2020-12-05T05:39:22Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.ipcamera/src/main/java/org/openhab/binding/ipcamera/internal/onvif/OnvifDiscovery.java", "diffHunk": "@@ -213,26 +215,21 @@ protected void channelRead0(@Nullable ChannelHandlerContext ctx, DatagramPacket\n                 }).option(ChannelOption.SO_BROADCAST, true).option(ChannelOption.SO_REUSEADDR, true)\n                 .option(ChannelOption.IP_MULTICAST_LOOP_DISABLED, false).option(ChannelOption.SO_RCVBUF, 2048)\n                 .option(ChannelOption.IP_MULTICAST_TTL, 255).option(ChannelOption.IP_MULTICAST_IF, networkInterface);\n-\n-        datagramChannel = (DatagramChannel) bootstrap.bind(localNetworkAddress).sync().channel();\n-        datagramChannel.joinGroup(multiCastAddress, networkInterface).sync();\n-        ChannelFuture chFuture;\n-        if (port == 1900) {\n-            String ssdp = \"M-SEARCH * HTTP/1.1\\n\" + \"HOST: 239.255.255.250:1900\\n\" + \"MAN: \\\"ssdp:discover\\\"\\n\"\n-                    + \"MX: 1\\n\" + \"ST: urn:dial-multiscreen-org:service:dial:1\\n\"\n-                    + \"USER-AGENT: Microsoft Edge/83.0.478.61 Windows\\n\" + \"\\n\" + \"\";\n-            ByteBuf ssdpProbeMessage = Unpooled.copiedBuffer(ssdp, 0, ssdp.length(), StandardCharsets.UTF_8);\n-            datagramPacket = new DatagramPacket(ssdpProbeMessage, multiCastAddress, localNetworkAddress);\n-            chFuture = datagramChannel.writeAndFlush(datagramPacket);\n-        } else {\n-            chFuture = datagramChannel.writeAndFlush(datagramPacket);\n+        ChannelGroup openChannels = new DefaultChannelGroup(GlobalEventExecutor.INSTANCE);\n+        for (NetworkInterface nic : nics) {\n+            DatagramChannel datagramChannel = (DatagramChannel) bootstrap.option(ChannelOption.IP_MULTICAST_IF, nic)\n+                    .bind(new InetSocketAddress(0)).sync().channel();\n+            datagramChannel\n+                    .joinGroup(new InetSocketAddress(InetAddress.getByName(\"239.255.255.250\"), 3702), networkInterface)\n+                    .sync();\n+            openChannels.add(datagramChannel);\n+        }\n+        if (!openChannels.isEmpty()) {\n+            openChannels.writeAndFlush(wsDiscovery());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7cae07ca51f222914b628badc12e366ce8c246e7"}, "originalPosition": 122}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1ODQ4MTQ0", "url": "https://github.com/openhab/openhab-addons/pull/9199#pullrequestreview-545848144", "createdAt": "2020-12-07T05:54:37Z", "commit": {"oid": "7cae07ca51f222914b628badc12e366ce8c246e7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3959, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}