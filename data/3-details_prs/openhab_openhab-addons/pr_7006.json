{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc1MDEyNjM4", "number": 7006, "title": "[tado] assorted upgrades and bug fixes to the binding", "bodyText": "This PR provides assorted bug fixes and enhancements to the tado binding as follows..\n\n\nReplaced the List of Zones by a HashMap of Zone Ids vs. Battery state, to avoid making a JSON HTTP request to the API every time that Battery state is refreshed; so now the battery state only gets polled after the polling refresh time has expired.\n\n\nFor Battery state and Open Window alarms, the binding only returns a JSON payload element in the case that there IS actually an alarm, (i.e. if there is no JSON element this means there is no alarm); so in such cases the Channels now return OnOffType.OFF (no alarm) instead of UndefType.UNDEF.\n\n\nThere were typo errors in the POM.XML dependencies entry: a) artifactId should be \"tado-api-client\" (not \"api-client\"), and b) version should be \"1.3\" (not \"1.3.0\") -- NOTE: I think this error was introduced in #6183\n\n\nAdded pom-aggregator.xml to the root directory in order to build the \"tado-api-client-1.3.jar\" dependency file from the root => hopefully the reviewers can suggest a way to integrate this build directly into the OH MVN build environment. (??)", "createdAt": "2020-02-13T18:04:37Z", "url": "https://github.com/openhab/openhab-addons/pull/7006", "merged": true, "mergeCommit": {"oid": "c3ba20c1c6d0c1b014689c4f5c1881f6852858d7"}, "closed": true, "closedAt": "2020-02-18T16:47:08Z", "author": {"login": "andrewfg"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcD-cuugH2gAyMzc1MDEyNjM4OmYyY2FkNmZlY2NhMDRiNTZhOWRmODMyYzVkYzFiZjgzOGUxMzY1MmM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcFkxf0gFqTM2MDQ5OTk3Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f2cad6fecca04b56a9df832c5dc1bf838e13652c", "author": {"user": {"login": "andrewfg", "name": "Andrew Fiddian-Green"}}, "url": "https://github.com/openhab/openhab-addons/commit/f2cad6fecca04b56a9df832c5dc1bf838e13652c", "committedDate": "2020-02-13T17:33:21Z", "message": "Return a defined channel state (off) when api does not return JSON payload\n\nSigned-off-by: Andrew Fiddian-Green <software@whitebear.ch>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b147145a0c68009f6ac617ec4e12c0d336d1b676", "author": {"user": {"login": "andrewfg", "name": "Andrew Fiddian-Green"}}, "url": "https://github.com/openhab/openhab-addons/commit/b147145a0c68009f6ac617ec4e12c0d336d1b676", "committedDate": "2020-02-13T17:34:05Z", "message": "Corrected typing errors in POM dependencies\n\nSigned-off-by: Andrew Fiddian-Green <software@whitebear.ch>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4bd3429a96f4b2b0768f8b1786ed0a8b8bc2db11", "author": {"user": {"login": "andrewfg", "name": "Andrew Fiddian-Green"}}, "url": "https://github.com/openhab/openhab-addons/commit/4bd3429a96f4b2b0768f8b1786ed0a8b8bc2db11", "committedDate": "2020-02-13T17:35:00Z", "message": "Added a pom-aggregator.xml to build the dependency file\n\nSigned-off-by: Andrew Fiddian-Green <software@whitebear.ch>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "004420acf555df2c0160afd33424c1c682318790", "author": {"user": {"login": "andrewfg", "name": "Andrew Fiddian-Green"}}, "url": "https://github.com/openhab/openhab-addons/commit/004420acf555df2c0160afd33424c1c682318790", "committedDate": "2020-02-13T17:35:27Z", "message": "Upload the dependency JAR file (just in case)\n\nSigned-off-by: Andrew Fiddian-Green <software@whitebear.ch>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5MzkyODgz", "url": "https://github.com/openhab/openhab-addons/pull/7006#pullrequestreview-359392883", "createdAt": "2020-02-16T10:06:55Z", "commit": {"oid": "004420acf555df2c0160afd33424c1c682318790"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNlQxMDowNjo1NlrOFqStfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNlQxMDowOTo1MVrOFqSuFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTg5MTA3MA==", "bodyText": "What's the idea here? If any batteryState is low, set the zoneList to OFF otherwise to ON?\nhomeHandler.getApi().listZones(homeId).forEach(zone -> {\n    try {\n        boolean batteryLow = !zone.getDevices().stream().map(ControlDevice::getBatteryState).anyMatch(s->!(\"NORMAL\".equals(s)));\n        zoneList.put(Long:valueOf(zone.getId()), OnOffType.from(batteryLow));\n    } catch (IOException | ApiException e) {\n        logger.debug(\"Fetch (battery state) zone list exception\", e); \n    }\n}\n\nThis also allows to process other zones if one zone failed (instead of before where processing stops when the first error occurs.", "url": "https://github.com/openhab/openhab-addons/pull/7006#discussion_r379891070", "createdAt": "2020-02-16T10:06:56Z", "author": {"login": "J-N-K"}, "path": "bundles/org.openhab.binding.tado/src/main/java/org/openhab/binding/tado/internal/handler/TadoBatteryChecker.java", "diffHunk": "@@ -57,10 +57,20 @@ private synchronized void refreshZoneList() {\n             Long homeId = homeHandler.getHomeId();\n             if (homeId != null) {\n                 logger.debug(\"Fetching (battery state) zone list for HomeId {}\", homeId);\n+                zoneList.clear();\n                 try {\n-                    zoneList = homeHandler.getApi().listZones(homeId);\n+                    for (Zone zone : homeHandler.getApi().listZones(homeId)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "004420acf555df2c0160afd33424c1c682318790"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTg5MTIyMA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    State state = zoneList.get(zoneId);\n          \n          \n            \n                    return zoneList.getorDefault(zoneId, OnOffType.OFF);", "url": "https://github.com/openhab/openhab-addons/pull/7006#discussion_r379891220", "createdAt": "2020-02-16T10:09:51Z", "author": {"login": "J-N-K"}, "path": "bundles/org.openhab.binding.tado/src/main/java/org/openhab/binding/tado/internal/handler/TadoBatteryChecker.java", "diffHunk": "@@ -69,25 +79,8 @@ private synchronized void refreshZoneList() {\n \n     public State getBatteryLowAlarm(long zoneId) {\n         refreshZoneList();\n-        boolean hasBatteryStateValue = false;\n-        if (zoneList != null) {\n-            // logger.debug(\"Fetching battery state for ZoneId {}\", zoneId);\n-            for (Zone zone : zoneList) {\n-                if (zoneId == zone.getId()) {\n-                    for (ControlDevice device : zone.getDevices()) {\n-                        String batteryState = device.getBatteryState();\n-                        if (batteryState != null) {\n-                            if (!batteryState.equals(\"NORMAL\")) {    \n-                                return OnOffType.ON;\n-                            }\n-                            hasBatteryStateValue = true;\n-                        }\n-                    }\n-                    break;\n-                }\n-            }\n-        }\n-        return hasBatteryStateValue ? OnOffType.OFF : UnDefType.UNDEF;\n+        State state = zoneList.get(zoneId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "004420acf555df2c0160afd33424c1c682318790"}, "originalPosition": 78}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d8c62b27e9d1809500f781a211f93fac4d2c876", "author": {"user": {"login": "andrewfg", "name": "Andrew Fiddian-Green"}}, "url": "https://github.com/openhab/openhab-addons/commit/8d8c62b27e9d1809500f781a211f93fac4d2c876", "committedDate": "2020-02-17T16:17:18Z", "message": "Changes suggested in review by @J-N-K\n\nSigned-off-by: Andrew Fiddian-Green <software@whitebear.ch>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3e6899a4ac0007126027c0698c35605f3140eae", "author": {"user": {"login": "andrewfg", "name": "Andrew Fiddian-Green"}}, "url": "https://github.com/openhab/openhab-addons/commit/a3e6899a4ac0007126027c0698c35605f3140eae", "committedDate": "2020-02-17T19:03:01Z", "message": "Cool code suggested by @J-N-K\n\nSigned-off-by: Andrew Fiddian-Green <software@whitebear.ch>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5OTMxNDk1", "url": "https://github.com/openhab/openhab-addons/pull/7006#pullrequestreview-359931495", "createdAt": "2020-02-17T19:24:18Z", "commit": {"oid": "a3e6899a4ac0007126027c0698c35605f3140eae"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxOToyNDoxOVrOFquB-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxOToyNjozOFrOFquEYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDMzODY4MA==", "bodyText": "Is this file still needed? IMO we should try to integrate it in the main pom (in another PR)", "url": "https://github.com/openhab/openhab-addons/pull/7006#discussion_r380338680", "createdAt": "2020-02-17T19:24:19Z", "author": {"login": "J-N-K"}, "path": "bundles/org.openhab.binding.tado/pom-aggregator.xml", "diffHunk": "@@ -0,0 +1,16 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?><project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3e6899a4ac0007126027c0698c35605f3140eae"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDMzOTI5OQ==", "bodyText": "Did you remove the stacktrace by intention?", "url": "https://github.com/openhab/openhab-addons/pull/7006#discussion_r380339299", "createdAt": "2020-02-17T19:26:38Z", "author": {"login": "J-N-K"}, "path": "bundles/org.openhab.binding.tado/src/main/java/org/openhab/binding/tado/internal/handler/TadoBatteryChecker.java", "diffHunk": "@@ -57,37 +58,23 @@ private synchronized void refreshZoneList() {\n             Long homeId = homeHandler.getHomeId();\n             if (homeId != null) {\n                 logger.debug(\"Fetching (battery state) zone list for HomeId {}\", homeId);\n+                zoneList.clear();\n                 try {\n-                    zoneList = homeHandler.getApi().listZones(homeId);\n+                    homeHandler.getApi().listZones(homeId).forEach(zone -> {\n+                        boolean batteryLow = !zone.getDevices().stream().map(ControlDevice::getBatteryState)\n+                                .filter(Objects::nonNull).allMatch(s -> s.equals(\"NORMAL\"));\n+                        zoneList.put(Long.valueOf(zone.getId()), OnOffType.from(batteryLow));\n+                    });\n                 } catch (IOException | ApiException e) {\n-                    zoneList = null;\n-                    logger.debug(\"Fetch (battery state) zone list exception\", e);\n+                    logger.debug(\"Fetch (battery state) zone list exception\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3e6899a4ac0007126027c0698c35605f3140eae"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a6f4dfa57a02b67f589b20e0a64af3577cf824e", "author": {"user": {"login": "andrewfg", "name": "Andrew Fiddian-Green"}}, "url": "https://github.com/openhab/openhab-addons/commit/0a6f4dfa57a02b67f589b20e0a64af3577cf824e", "committedDate": "2020-02-17T21:32:30Z", "message": "Deleted pom aggregator\n\nSigned-off-by: Andrew Fiddian-Green <software@whitebear.ch>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNDk5OTcy", "url": "https://github.com/openhab/openhab-addons/pull/7006#pullrequestreview-360499972", "createdAt": "2020-02-18T16:46:21Z", "commit": {"oid": "0a6f4dfa57a02b67f589b20e0a64af3577cf824e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1441, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}