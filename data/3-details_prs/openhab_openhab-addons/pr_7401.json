{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA1MjY4NjY3", "number": 7401, "title": "[lgwebos] Delay subscription of channel", "bodyText": "Addresses issue #7243.\nwithout the delay it can happen, that we request a subscription, but livetv is not yet ready to respond. Instead we get this error:\n2020-04-17 18:11:11.767 [DEBUG] [.lgwebos.internal.BaseChannelHandler] - Subscribed org.openhab.binding.lgwebos.internal.TVControlChannel on Thing: lgwebos:WebOSTV:6da62662-1369-a82d-95c7-353c235ed503\n2020-04-17 18:11:11.816 [DEBUG] [bos.internal.handler.LGWebOSTVSocket] - Error: {\"type\":\"error\",\"id\":9,\"error\":\"500 Application error\",\"payload\":{\"returnValue\":false,\"errorCode\":\"BROADCAST_ERROR_1003\",\"errorText\":\"No information\"}}\n2020-04-17 18:11:11.817 [DEBUG] [ng.lgwebos.internal.TVControlChannel] - Error in retrieving channel: 500 Application error.\n\nthe delay fixes the issue", "createdAt": "2020-04-17T18:03:29Z", "url": "https://github.com/openhab/openhab-addons/pull/7401", "merged": true, "mergeCommit": {"oid": "37f1096172e1453b3119dde79b0b00bbcf5bac84"}, "closed": true, "closedAt": "2020-04-17T20:35:31Z", "author": {"login": "sprehn"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcYlMazgH2gAyNDA1MjY4NjY3OjlkYTM1Mjc0NDFjYzNhNjM3YzMyMmFmMjFjZmYxOTE4YzQ3YmRlZmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcYnZ6eAFqTM5NTc1NTg2MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9da3527441cc3a637c322af21cff1918c47bdefa", "author": {"user": {"login": "sprehn", "name": "Sebastian Prehn"}}, "url": "https://github.com/openhab/openhab-addons/commit/9da3527441cc3a637c322af21cff1918c47bdefa", "committedDate": "2020-04-17T18:00:19Z", "message": "Delay subscription of channel. Addresses issue #7243.\nSigned-off-by: Sebastian Prehn <sebastian.prehn@gmx.de>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1NzA4Nzk5", "url": "https://github.com/openhab/openhab-addons/pull/7401#pullrequestreview-395708799", "createdAt": "2020-04-17T19:12:41Z", "commit": {"oid": "9da3527441cc3a637c322af21cff1918c47bdefa"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxOToxMjo0MVrOGHaCHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxOToxMjo0MVrOGHaCHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQxOTc0MQ==", "bodyText": "You should call this during dispose() as well.", "url": "https://github.com/openhab/openhab-addons/pull/7401#discussion_r410419741", "createdAt": "2020-04-17T19:12:41Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.lgwebos/src/main/java/org/openhab/binding/lgwebos/internal/handler/LGWebOSHandler.java", "diffHunk": "@@ -332,10 +333,34 @@ public void postUpdate(String channelId, State state) {\n             updateState(channelId, state);\n         }\n \n-        // channel subscription only works when on livetv app.\n-        if (CHANNEL_APP_LAUNCHER.equals(channelId) && APP_ID_LIVETV.equals(state.toString())) {\n-            channelHandlers.get(CHANNEL_CHANNEL).refreshSubscription(CHANNEL_CHANNEL, this);\n+        // channel subscription only works when livetv app is started,\n+        // therefore we need to slightly delay the subscription\n+        if (CHANNEL_APP_LAUNCHER.equals(channelId)) {\n+            if (APP_ID_LIVETV.equals(state.toString())) {\n+                scheduleChannelSubscriptionJob();\n+            } else {\n+                stopChannelSubscriptionJob();\n+            }\n+        }\n+    }\n+\n+    private void scheduleChannelSubscriptionJob() {\n+        ScheduledFuture<?> job = channelSubscriptionJob;\n+        if (job == null || job.isCancelled()) {\n+            logger.debug(\"Schedule channel subscription job\");\n+            channelSubscriptionJob = scheduler.schedule(\n+                    () -> channelHandlers.get(CHANNEL_CHANNEL).refreshSubscription(CHANNEL_CHANNEL, this),\n+                    CHANNEL_SUBSCRIPTION_DELAY_SECONDS, TimeUnit.SECONDS);\n+        }\n+    }\n+\n+    private void stopChannelSubscriptionJob() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9da3527441cc3a637c322af21cff1918c47bdefa"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ace67cbec5c206f9199dd13671767965693dceed", "author": {"user": {"login": "sprehn", "name": "Sebastian Prehn"}}, "url": "https://github.com/openhab/openhab-addons/commit/ace67cbec5c206f9199dd13671767965693dceed", "committedDate": "2020-04-17T19:32:01Z", "message": "Calling stopChannelSubscriptionJob() in dispose()\nSigned-off-by: Sebastian Prehn <sebastian.prehn@gmx.de>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1NzUxNDg3", "url": "https://github.com/openhab/openhab-addons/pull/7401#pullrequestreview-395751487", "createdAt": "2020-04-17T20:26:51Z", "commit": {"oid": "ace67cbec5c206f9199dd13671767965693dceed"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1NzU1ODYx", "url": "https://github.com/openhab/openhab-addons/pull/7401#pullrequestreview-395755861", "createdAt": "2020-04-17T20:34:52Z", "commit": {"oid": "ace67cbec5c206f9199dd13671767965693dceed"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 830, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}