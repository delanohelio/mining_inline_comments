{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk4NTM3MzUw", "number": 7282, "title": "[satel] Action for reading the event log added", "bodyText": "This PR add a rule action for reading records from the event log. It replaces current way of reading the log using items linked to channels of event-log thing. This is still available but marked as deprecated.\nIt also contains minor changes in README file.\nSigned-off-by: Krzysztof Goworek krzysztof.goworek@gmail.com", "createdAt": "2020-04-04T12:40:44Z", "url": "https://github.com/openhab/openhab-addons/pull/7282", "merged": true, "mergeCommit": {"oid": "3b49fb97aedfc6ca06291796a251208b36554cae"}, "closed": true, "closedAt": "2020-04-05T13:57:29Z", "author": {"login": "druciak"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcUVhjCgFqTM4NzY5ODMxOA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcUqhjpAFqTM4NzgyMTc3MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3Njk4MzE4", "url": "https://github.com/openhab/openhab-addons/pull/7282#pullrequestreview-387698318", "createdAt": "2020-04-04T13:13:01Z", "commit": {"oid": "132ae73ba4ee419990d06c5145798f84cbcc2413"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNFQxMzoxMzowMVrOGAxx3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNFQxMzoyOTowMlrOGAx3nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ2ODc2Nw==", "bodyText": "Maybe add a note seomwhere that this requires the mail binding.", "url": "https://github.com/openhab/openhab-addons/pull/7282#discussion_r403468767", "createdAt": "2020-04-04T13:13:01Z", "author": {"login": "J-N-K"}, "path": "bundles/org.openhab.binding.satel/README.md", "diffHunk": "@@ -381,34 +404,29 @@ then\n     ]\n end\n \n-rule \"Send event log start\"\n+rule \"Send event log\"\n when\n     Item Alarms changed to ON\n then\n-    eventLogCounter = 0\n-    eventLogMsgBody = \"\"\n-    EVENT_LOG_PREV.postUpdate(NULL)\n-    EVENT_LOG_IDX.sendCommand(-1)\n-end\n-\n-rule \"Send event log next\"\n-when\n-    Item EVENT_LOG_PREV changed\n-then\n-    if (EVENT_LOG_PREV.state == NULL) {\n-        \n-    } else if (eventLogCounter == 30) {\n-        sendMail(\"my@address.net\", \"Alarm system log\", eventLogMsgBody)\n-        // prevent initiating reading when index item is restored during OH startup\n-        EVENT_LOG_IDX.postUpdate(NULL)\n-    } else {\n-        eventLogMsgBody += \"\\n\" + (EVENT_LOG_TIME.state as DateTimeType).format(\"%1$tF %1$tR\") + \": \" + EVENT_LOG_DESCR.state\n-        if (EVENT_LOG_DET.state != NULL && EVENT_LOG_DET.state != \"\") {\n-            eventLogMsgBody += \" - \" + EVENT_LOG_DET.state\n-        }\n-        eventLogCounter += 1\n-        EVENT_LOG_IDX.sendCommand(EVENT_LOG_PREV.state)\n+    val actions = getActions(\"satel\", \"satel:event-log:home:EventLog\")\n+    if (null === actions) {\n+        logInfo(\"EventLog\", \"Actions not found, check thing ID\")\n+        return\n     }\n+    logInfo(\"EventLog\", \"Start\")\n+    var msgBody = \"\"\n+    var eventIdx = -1\n+    (1..10).forEach[\n+        val eventRec = actions.readEvent(eventIdx)\n+        val details = eventRec.get(\"details\")\n+        msgBody += \"\\n\" + String::format(\"%1$tF %1$tR\", eventRec.get(\"timestamp\")) + \": \" + eventRec.get(\"description\")\n+        if (details != NULL && details != \"\") {\n+             msgBody += \" - \" + details\n+        }\n+        eventIdx = eventRec.get(\"prev_index\")\n+    ]\n+    logInfo(\"EventLog\", \"End\")\n+    getActions(\"mail\",\"mail:smtp:local\").sendMail(\"you@email.net\", \"Event log\", msgBody)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "132ae73ba4ee419990d06c5145798f84cbcc2413"}, "originalPosition": 131}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ2ODkyMw==", "bodyText": "Please use a real name here", "url": "https://github.com/openhab/openhab-addons/pull/7282#discussion_r403468923", "createdAt": "2020-04-04T13:14:34Z", "author": {"login": "J-N-K"}, "path": "bundles/org.openhab.binding.satel/src/main/java/org/openhab/binding/satel/internal/handler/SatelEventLogHandler.java", "diffHunk": "@@ -63,6 +67,71 @@\n     private @Nullable ScheduledFuture<?> cacheExpirationJob;\n     private Charset encoding = Charset.defaultCharset();\n \n+    /**\n+     * Represents single record of the event log.\n+     *\n+     * @author kgoworek", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "132ae73ba4ee419990d06c5145798f84cbcc2413"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ3MDIzOQ==", "bodyText": "The Optional was here before, so ok for me, but I think you gain nothing by using it here. A simple null-check would be sufficient (in fact you are not doing anything other than that here) and produce less overhead.", "url": "https://github.com/openhab/openhab-addons/pull/7282#discussion_r403470239", "createdAt": "2020-04-04T13:29:02Z", "author": {"login": "J-N-K"}, "path": "bundles/org.openhab.binding.satel/src/main/java/org/openhab/binding/satel/internal/handler/SatelEventLogHandler.java", "diffHunk": "@@ -192,13 +279,13 @@ private void readEvent(int eventIndex) {\n                             + (readEventCmd.getObject() * 32 + readEventCmd.getUserControlNumber());\n                     Optional<EventDescription> eventDescNext = getEventDescription(readEventCmd.getNextIndex());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "132ae73ba4ee419990d06c5145798f84cbcc2413"}, "originalPosition": 131}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "132ae73ba4ee419990d06c5145798f84cbcc2413", "author": {"user": null}, "url": "https://github.com/openhab/openhab-addons/commit/132ae73ba4ee419990d06c5145798f84cbcc2413", "committedDate": "2020-04-04T12:34:13Z", "message": "[satel] Action for reading the event log added\n\nSigned-off-by: Krzysztof Goworek <krzysztof.goworek@gmail.com>"}, "afterCommit": {"oid": "3ecc281abfe21f0e0ce2c7f0ce2cbb0604d88104", "author": {"user": null}, "url": "https://github.com/openhab/openhab-addons/commit/3ecc281abfe21f0e0ce2c7f0ce2cbb0604d88104", "committedDate": "2020-04-04T13:40:59Z", "message": "[satel] Action for reading the event log added\n\nSigned-off-by: Krzysztof Goworek <krzysztof.goworek@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3NzAxNTA2", "url": "https://github.com/openhab/openhab-addons/pull/7282#pullrequestreview-387701506", "createdAt": "2020-04-04T13:55:49Z", "commit": {"oid": "3ecc281abfe21f0e0ce2c7f0ce2cbb0604d88104"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNFQxMzo1NTo1MFrOGAyBzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNFQxMzo1NzoyNlrOGAyCSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ3Mjg0Ng==", "bodyText": "Please use a new line for each sentence. They are  concatenated automatically.", "url": "https://github.com/openhab/openhab-addons/pull/7282#discussion_r403472846", "createdAt": "2020-04-04T13:55:50Z", "author": {"login": "J-N-K"}, "path": "bundles/org.openhab.binding.satel/README.md", "diffHunk": "@@ -55,6 +55,8 @@ Example:\n Bridge satel:ethm-1:home [ host=\"192.168.0.2\", refresh=1000, userCode=\"1234\", encryptionKey=\"abcdefgh\" ]\n ```\n \n+**NOTE:** There can be only one client connected to ETHM-1 module. It does not accept new connections if there is already a connection established. In case you have troubles connecting to the system using this module, please make sure there is no other client (for example installed 1.x version of the binding) already connected to it.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ecc281abfe21f0e0ce2c7f0ce2cbb0604d88104"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ3Mjg2MA==", "bodyText": "see above", "url": "https://github.com/openhab/openhab-addons/pull/7282#discussion_r403472860", "createdAt": "2020-04-04T13:56:01Z", "author": {"login": "J-N-K"}, "path": "bundles/org.openhab.binding.satel/README.md", "diffHunk": "@@ -261,6 +267,30 @@ Thing atd-100 KitchenTemp [ id=10, refresh=30 ]\n | device_lobatt | Switch             | Indicates low battery level in the wireless device        |\n | device_nocomm | Switch             | Indicates communication troubles with the wireless device |\n \n+## Rule Actions\n+\n+### readEvent\n+\n+This action allows you to read one record from the event log placed at index given by input parameter. The result of this action is compatible with channels of `event-log` thing and contains following values:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ecc281abfe21f0e0ce2c7f0ce2cbb0604d88104"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ3Mjk3MA==", "bodyText": "True. I was just thinking that someone installs satel, adds this example and runs into an error. Maybe a comment in the line above this one like sending notifications via mail requires the mail binding or something like that would be good.", "url": "https://github.com/openhab/openhab-addons/pull/7282#discussion_r403472970", "createdAt": "2020-04-04T13:57:26Z", "author": {"login": "J-N-K"}, "path": "bundles/org.openhab.binding.satel/README.md", "diffHunk": "@@ -381,34 +404,29 @@ then\n     ]\n end\n \n-rule \"Send event log start\"\n+rule \"Send event log\"\n when\n     Item Alarms changed to ON\n then\n-    eventLogCounter = 0\n-    eventLogMsgBody = \"\"\n-    EVENT_LOG_PREV.postUpdate(NULL)\n-    EVENT_LOG_IDX.sendCommand(-1)\n-end\n-\n-rule \"Send event log next\"\n-when\n-    Item EVENT_LOG_PREV changed\n-then\n-    if (EVENT_LOG_PREV.state == NULL) {\n-        \n-    } else if (eventLogCounter == 30) {\n-        sendMail(\"my@address.net\", \"Alarm system log\", eventLogMsgBody)\n-        // prevent initiating reading when index item is restored during OH startup\n-        EVENT_LOG_IDX.postUpdate(NULL)\n-    } else {\n-        eventLogMsgBody += \"\\n\" + (EVENT_LOG_TIME.state as DateTimeType).format(\"%1$tF %1$tR\") + \": \" + EVENT_LOG_DESCR.state\n-        if (EVENT_LOG_DET.state != NULL && EVENT_LOG_DET.state != \"\") {\n-            eventLogMsgBody += \" - \" + EVENT_LOG_DET.state\n-        }\n-        eventLogCounter += 1\n-        EVENT_LOG_IDX.sendCommand(EVENT_LOG_PREV.state)\n+    val actions = getActions(\"satel\", \"satel:event-log:home:EventLog\")\n+    if (null === actions) {\n+        logInfo(\"EventLog\", \"Actions not found, check thing ID\")\n+        return\n     }\n+    logInfo(\"EventLog\", \"Start\")\n+    var msgBody = \"\"\n+    var eventIdx = -1\n+    (1..10).forEach[\n+        val eventRec = actions.readEvent(eventIdx)\n+        val details = eventRec.get(\"details\")\n+        msgBody += \"\\n\" + String::format(\"%1$tF %1$tR\", eventRec.get(\"timestamp\")) + \": \" + eventRec.get(\"description\")\n+        if (details != NULL && details != \"\") {\n+             msgBody += \" - \" + details\n+        }\n+        eventIdx = eventRec.get(\"prev_index\")\n+    ]\n+    logInfo(\"EventLog\", \"End\")\n+    getActions(\"mail\",\"mail:smtp:local\").sendMail(\"you@email.net\", \"Event log\", msgBody)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ2ODc2Nw=="}, "originalCommit": {"oid": "132ae73ba4ee419990d06c5145798f84cbcc2413"}, "originalPosition": 131}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "025200c741599ade223c1ca3849406a97d814758", "author": {"user": null}, "url": "https://github.com/openhab/openhab-addons/commit/025200c741599ade223c1ca3849406a97d814758", "committedDate": "2020-04-04T17:24:13Z", "message": "[satel] Action for reading the event log added\n\nSigned-off-by: Krzysztof Goworek <krzysztof.goworek@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3ecc281abfe21f0e0ce2c7f0ce2cbb0604d88104", "author": {"user": null}, "url": "https://github.com/openhab/openhab-addons/commit/3ecc281abfe21f0e0ce2c7f0ce2cbb0604d88104", "committedDate": "2020-04-04T13:40:59Z", "message": "[satel] Action for reading the event log added\n\nSigned-off-by: Krzysztof Goworek <krzysztof.goworek@gmail.com>"}, "afterCommit": {"oid": "025200c741599ade223c1ca3849406a97d814758", "author": {"user": null}, "url": "https://github.com/openhab/openhab-addons/commit/025200c741599ade223c1ca3849406a97d814758", "committedDate": "2020-04-04T17:24:13Z", "message": "[satel] Action for reading the event log added\n\nSigned-off-by: Krzysztof Goworek <krzysztof.goworek@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3ODIxNzcw", "url": "https://github.com/openhab/openhab-addons/pull/7282#pullrequestreview-387821770", "createdAt": "2020-04-05T13:57:14Z", "commit": {"oid": "025200c741599ade223c1ca3849406a97d814758"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1007, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}