{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMyNzQwNTQw", "number": 9227, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQyMToxOTozMFrOFA-6Ag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQyMToxOTozMFrOFA-6Ag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM2NTc0OTc4OnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.binding.icalendar/src/main/java/org/openhab/binding/icalendar/internal/handler/ICalendarHandler.java", "isResolved": false, "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQyMToxOTozMFrOH_iYWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxNjowNzo0M1rOIBmFyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM4NTYyNQ==", "bodyText": "Maybe it would be better to just let the scheduled pull task handle the asynchronous part instead?\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            updateStatus(ThingStatus.UNKNOWN);\n          \n          \n            \n            \n          \n          \n            \n                            scheduler.submit(() -> {\n          \n          \n            \n                                // reload calendar file asynchronously\n          \n          \n            \n                                if (reloadCalendar()) {\n          \n          \n            \n                                    updateStatus(ThingStatus.ONLINE);\n          \n          \n            \n                                    updateStates();\n          \n          \n            \n                                    rescheduleCalendarStateUpdate();\n          \n          \n            \n                                } else {\n          \n          \n            \n                                    updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR,\n          \n          \n            \n                                            \"The calendar seems to be configured correctly, but the local copy of calendar could not be loaded.\");\n          \n          \n            \n                                }\n          \n          \n            \n                            });\n          \n          \n            \n                            pullJobFuture = scheduler.scheduleWithFixedDelay(regularPull, refreshTime, refreshTime,\n          \n          \n            \n                                    TimeUnit.MINUTES);\n          \n          \n            \n                            updateStatus(ThingStatus.UNKNOWN);\n          \n          \n            \n                            pullJobFuture = scheduler.scheduleWithFixedDelay(regularPull, 0, refreshTime,\n          \n          \n            \n                                    TimeUnit.MINUTES);", "url": "https://github.com/openhab/openhab-addons/pull/9227#discussion_r536385625", "createdAt": "2020-12-04T21:19:30Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.icalendar/src/main/java/org/openhab/binding/icalendar/internal/handler/ICalendarHandler.java", "diffHunk": "@@ -154,14 +152,19 @@ public void initialize() {\n             }\n             final long refreshTime = refreshTimeBD.longValue();\n             if (calendarFile.isFile()) {\n-                if (reloadCalendar()) {\n-                    updateStatus(ThingStatus.ONLINE);\n-                    updateStates();\n-                    rescheduleCalendarStateUpdate();\n-                } else {\n-                    updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR,\n-                            \"The calendar seems to be configured correctly, but the local copy of calendar could not be loaded.\");\n-                }\n+                updateStatus(ThingStatus.UNKNOWN);\n+\n+                scheduler.submit(() -> {\n+                    // reload calendar file asynchronously\n+                    if (reloadCalendar()) {\n+                        updateStatus(ThingStatus.ONLINE);\n+                        updateStates();\n+                        rescheduleCalendarStateUpdate();\n+                    } else {\n+                        updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR,\n+                                \"The calendar seems to be configured correctly, but the local copy of calendar could not be loaded.\");\n+                    }\n+                });\n                 pullJobFuture = scheduler.scheduleWithFixedDelay(regularPull, refreshTime, refreshTime,\n                         TimeUnit.MINUTES);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02bd093d133e941609e3d10d08857b6fa4de91ec"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzEwOTgxNQ==", "bodyText": "I am not sure if that will work. IIRC downloading the calendar is not part of the pull job. We might want to ask @daMihe for his opinion.", "url": "https://github.com/openhab/openhab-addons/pull/9227#discussion_r537109815", "createdAt": "2020-12-06T19:47:02Z", "author": {"login": "cweitkamp"}, "path": "bundles/org.openhab.binding.icalendar/src/main/java/org/openhab/binding/icalendar/internal/handler/ICalendarHandler.java", "diffHunk": "@@ -154,14 +152,19 @@ public void initialize() {\n             }\n             final long refreshTime = refreshTimeBD.longValue();\n             if (calendarFile.isFile()) {\n-                if (reloadCalendar()) {\n-                    updateStatus(ThingStatus.ONLINE);\n-                    updateStates();\n-                    rescheduleCalendarStateUpdate();\n-                } else {\n-                    updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR,\n-                            \"The calendar seems to be configured correctly, but the local copy of calendar could not be loaded.\");\n-                }\n+                updateStatus(ThingStatus.UNKNOWN);\n+\n+                scheduler.submit(() -> {\n+                    // reload calendar file asynchronously\n+                    if (reloadCalendar()) {\n+                        updateStatus(ThingStatus.ONLINE);\n+                        updateStates();\n+                        rescheduleCalendarStateUpdate();\n+                    } else {\n+                        updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR,\n+                                \"The calendar seems to be configured correctly, but the local copy of calendar could not be loaded.\");\n+                    }\n+                });\n                 pullJobFuture = scheduler.scheduleWithFixedDelay(regularPull, refreshTime, refreshTime,\n                         TimeUnit.MINUTES);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM4NTYyNQ=="}, "originalCommit": {"oid": "02bd093d133e941609e3d10d08857b6fa4de91ec"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzExMzA1MA==", "bodyText": "Asynchronously loading the calendar works, it's already triggered by PullJob via CalendarUpdateListener.onCalendarUpdated() this way (regularly via scheduleWithFixedDelay). However, just using the PullJob for reloading may cause the calendar to be in OFFLINE state if e.g. being offline even if a cached copy exists. So i think this is not a good idea.", "url": "https://github.com/openhab/openhab-addons/pull/9227#discussion_r537113050", "createdAt": "2020-12-06T20:05:33Z", "author": {"login": "daMihe"}, "path": "bundles/org.openhab.binding.icalendar/src/main/java/org/openhab/binding/icalendar/internal/handler/ICalendarHandler.java", "diffHunk": "@@ -154,14 +152,19 @@ public void initialize() {\n             }\n             final long refreshTime = refreshTimeBD.longValue();\n             if (calendarFile.isFile()) {\n-                if (reloadCalendar()) {\n-                    updateStatus(ThingStatus.ONLINE);\n-                    updateStates();\n-                    rescheduleCalendarStateUpdate();\n-                } else {\n-                    updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR,\n-                            \"The calendar seems to be configured correctly, but the local copy of calendar could not be loaded.\");\n-                }\n+                updateStatus(ThingStatus.UNKNOWN);\n+\n+                scheduler.submit(() -> {\n+                    // reload calendar file asynchronously\n+                    if (reloadCalendar()) {\n+                        updateStatus(ThingStatus.ONLINE);\n+                        updateStates();\n+                        rescheduleCalendarStateUpdate();\n+                    } else {\n+                        updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR,\n+                                \"The calendar seems to be configured correctly, but the local copy of calendar could not be loaded.\");\n+                    }\n+                });\n                 pullJobFuture = scheduler.scheduleWithFixedDelay(regularPull, refreshTime, refreshTime,\n                         TimeUnit.MINUTES);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM4NTYyNQ=="}, "originalCommit": {"oid": "02bd093d133e941609e3d10d08857b6fa4de91ec"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzI0NjA5Nw==", "bodyText": "Well this PR will put the calendar into an UNKNOWN state, which is a kind of offline state, while it loads the cached copy anyway. If we can assert that any stored copy of the calendar is a valid one then I can see allowing the binding to initially enter an ONLINE state if it finds a file is present already.", "url": "https://github.com/openhab/openhab-addons/pull/9227#discussion_r537246097", "createdAt": "2020-12-07T05:46:05Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.icalendar/src/main/java/org/openhab/binding/icalendar/internal/handler/ICalendarHandler.java", "diffHunk": "@@ -154,14 +152,19 @@ public void initialize() {\n             }\n             final long refreshTime = refreshTimeBD.longValue();\n             if (calendarFile.isFile()) {\n-                if (reloadCalendar()) {\n-                    updateStatus(ThingStatus.ONLINE);\n-                    updateStates();\n-                    rescheduleCalendarStateUpdate();\n-                } else {\n-                    updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR,\n-                            \"The calendar seems to be configured correctly, but the local copy of calendar could not be loaded.\");\n-                }\n+                updateStatus(ThingStatus.UNKNOWN);\n+\n+                scheduler.submit(() -> {\n+                    // reload calendar file asynchronously\n+                    if (reloadCalendar()) {\n+                        updateStatus(ThingStatus.ONLINE);\n+                        updateStates();\n+                        rescheduleCalendarStateUpdate();\n+                    } else {\n+                        updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR,\n+                                \"The calendar seems to be configured correctly, but the local copy of calendar could not be loaded.\");\n+                    }\n+                });\n                 pullJobFuture = scheduler.scheduleWithFixedDelay(regularPull, refreshTime, refreshTime,\n                         TimeUnit.MINUTES);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM4NTYyNQ=="}, "originalCommit": {"oid": "02bd093d133e941609e3d10d08857b6fa4de91ec"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgzNDYzMg==", "bodyText": "Yes, sounds reasonable. I just saw that reloadCalendar() calls rescheduleCalendarStateUpdate() too which makes the second call inside the if superfluous. I will remove that too.", "url": "https://github.com/openhab/openhab-addons/pull/9227#discussion_r537834632", "createdAt": "2020-12-07T21:09:41Z", "author": {"login": "cweitkamp"}, "path": "bundles/org.openhab.binding.icalendar/src/main/java/org/openhab/binding/icalendar/internal/handler/ICalendarHandler.java", "diffHunk": "@@ -154,14 +152,19 @@ public void initialize() {\n             }\n             final long refreshTime = refreshTimeBD.longValue();\n             if (calendarFile.isFile()) {\n-                if (reloadCalendar()) {\n-                    updateStatus(ThingStatus.ONLINE);\n-                    updateStates();\n-                    rescheduleCalendarStateUpdate();\n-                } else {\n-                    updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR,\n-                            \"The calendar seems to be configured correctly, but the local copy of calendar could not be loaded.\");\n-                }\n+                updateStatus(ThingStatus.UNKNOWN);\n+\n+                scheduler.submit(() -> {\n+                    // reload calendar file asynchronously\n+                    if (reloadCalendar()) {\n+                        updateStatus(ThingStatus.ONLINE);\n+                        updateStates();\n+                        rescheduleCalendarStateUpdate();\n+                    } else {\n+                        updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR,\n+                                \"The calendar seems to be configured correctly, but the local copy of calendar could not be loaded.\");\n+                    }\n+                });\n                 pullJobFuture = scheduler.scheduleWithFixedDelay(regularPull, refreshTime, refreshTime,\n                         TimeUnit.MINUTES);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM4NTYyNQ=="}, "originalCommit": {"oid": "02bd093d133e941609e3d10d08857b6fa4de91ec"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg3MDE4MA==", "bodyText": "Yes this seems to be redundant. You can also remove the updateStatus inside the if as its already done in updateStates. I assume this went into code about time and after several changes.", "url": "https://github.com/openhab/openhab-addons/pull/9227#discussion_r537870180", "createdAt": "2020-12-07T22:09:10Z", "author": {"login": "daMihe"}, "path": "bundles/org.openhab.binding.icalendar/src/main/java/org/openhab/binding/icalendar/internal/handler/ICalendarHandler.java", "diffHunk": "@@ -154,14 +152,19 @@ public void initialize() {\n             }\n             final long refreshTime = refreshTimeBD.longValue();\n             if (calendarFile.isFile()) {\n-                if (reloadCalendar()) {\n-                    updateStatus(ThingStatus.ONLINE);\n-                    updateStates();\n-                    rescheduleCalendarStateUpdate();\n-                } else {\n-                    updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR,\n-                            \"The calendar seems to be configured correctly, but the local copy of calendar could not be loaded.\");\n-                }\n+                updateStatus(ThingStatus.UNKNOWN);\n+\n+                scheduler.submit(() -> {\n+                    // reload calendar file asynchronously\n+                    if (reloadCalendar()) {\n+                        updateStatus(ThingStatus.ONLINE);\n+                        updateStates();\n+                        rescheduleCalendarStateUpdate();\n+                    } else {\n+                        updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR,\n+                                \"The calendar seems to be configured correctly, but the local copy of calendar could not be loaded.\");\n+                    }\n+                });\n                 pullJobFuture = scheduler.scheduleWithFixedDelay(regularPull, refreshTime, refreshTime,\n                         TimeUnit.MINUTES);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM4NTYyNQ=="}, "originalCommit": {"oid": "02bd093d133e941609e3d10d08857b6fa4de91ec"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODU0MzU2MQ==", "bodyText": "Dine in 906c1c2.", "url": "https://github.com/openhab/openhab-addons/pull/9227#discussion_r538543561", "createdAt": "2020-12-08T16:07:43Z", "author": {"login": "cweitkamp"}, "path": "bundles/org.openhab.binding.icalendar/src/main/java/org/openhab/binding/icalendar/internal/handler/ICalendarHandler.java", "diffHunk": "@@ -154,14 +152,19 @@ public void initialize() {\n             }\n             final long refreshTime = refreshTimeBD.longValue();\n             if (calendarFile.isFile()) {\n-                if (reloadCalendar()) {\n-                    updateStatus(ThingStatus.ONLINE);\n-                    updateStates();\n-                    rescheduleCalendarStateUpdate();\n-                } else {\n-                    updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR,\n-                            \"The calendar seems to be configured correctly, but the local copy of calendar could not be loaded.\");\n-                }\n+                updateStatus(ThingStatus.UNKNOWN);\n+\n+                scheduler.submit(() -> {\n+                    // reload calendar file asynchronously\n+                    if (reloadCalendar()) {\n+                        updateStatus(ThingStatus.ONLINE);\n+                        updateStates();\n+                        rescheduleCalendarStateUpdate();\n+                    } else {\n+                        updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR,\n+                                \"The calendar seems to be configured correctly, but the local copy of calendar could not be loaded.\");\n+                    }\n+                });\n                 pullJobFuture = scheduler.scheduleWithFixedDelay(regularPull, refreshTime, refreshTime,\n                         TimeUnit.MINUTES);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM4NTYyNQ=="}, "originalCommit": {"oid": "02bd093d133e941609e3d10d08857b6fa4de91ec"}, "originalPosition": 35}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3845, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}