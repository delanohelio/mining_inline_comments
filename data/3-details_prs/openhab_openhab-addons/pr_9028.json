{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIxMDM5Mzc2", "number": 9028, "title": "[neeo] improve code", "bodyText": "create forwardactionsservlet only if forwardchain is not empty\nremove dependency on apache commons\nfix #9027 (wrong thing XML)\n\nSigned-off-by: Jan N. Klug jan.n.klug@rub.de", "createdAt": "2020-11-14T17:58:09Z", "url": "https://github.com/openhab/openhab-addons/pull/9028", "merged": true, "mergeCommit": {"oid": "6e3c6400434f0f490a1d4aaeafb4f1cb15d0368c"}, "closed": true, "closedAt": "2020-11-18T00:25:47Z", "author": {"login": "J-N-K"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdcdw3QAH2gAyNTIxMDM5Mzc2OmVlNzFhZDk1NDE5YWY3MGY4M2Q3N2IxMTk4Mjg1MjkzODYyMzZlMDk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdddyADAFqTUzMjY2NDYzOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ee71ad95419af70f83d77b119828529386236e09", "author": {"user": {"login": "J-N-K", "name": null}}, "url": "https://github.com/openhab/openhab-addons/commit/ee71ad95419af70f83d77b119828529386236e09", "committedDate": "2020-11-14T15:47:44Z", "message": "create forwardactionsservlet only if forwardchain is not empty\n\nSigned-off-by: Jan N. Klug <jan.n.klug@rub.de>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff8d5b599755c97d693e9fa3338ed01b95f5f7c5", "author": {"user": {"login": "J-N-K", "name": null}}, "url": "https://github.com/openhab/openhab-addons/commit/ff8d5b599755c97d693e9fa3338ed01b95f5f7c5", "committedDate": "2020-11-14T17:57:32Z", "message": "remove dependency on apache commons\n\nSigned-off-by: Jan N. Klug <jan.n.klug@rub.de>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee3b94037d1cce36f5ccafd19256f232c55d85da", "author": {"user": {"login": "J-N-K", "name": null}}, "url": "https://github.com/openhab/openhab-addons/commit/ee3b94037d1cce36f5ccafd19256f232c55d85da", "committedDate": "2020-11-14T19:24:35Z", "message": "fixes\n\nSigned-off-by: Jan N. Klug <jan.n.klug@rub.de>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2fdcd377fcc0c4a7dfc737886f98e2637a4133da", "author": {"user": {"login": "J-N-K", "name": null}}, "url": "https://github.com/openhab/openhab-addons/commit/2fdcd377fcc0c4a7dfc737886f98e2637a4133da", "committedDate": "2020-11-14T19:41:31Z", "message": "fix forwardChain definition\n\nSigned-off-by: Jan N. Klug <jan.n.klug@rub.de>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwODMxMzg3", "url": "https://github.com/openhab/openhab-addons/pull/9028#pullrequestreview-530831387", "createdAt": "2020-11-15T20:18:36Z", "commit": {"oid": "2fdcd377fcc0c4a7dfc737886f98e2637a4133da"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNVQyMDoxODozNlrOHzitOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNVQyMDoyNTo1M1rOHziw4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzgwODA1Nw==", "bodyText": "Aren't the lists returned by Arrays.asList immutable? I don't think this would work unless you make a copy of the oldScenarios  List first.", "url": "https://github.com/openhab/openhab-addons/pull/9028#discussion_r523808057", "createdAt": "2020-11-15T20:18:36Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.neeo/src/main/java/org/openhab/binding/neeo/internal/NeeoRoomProtocol.java", "diffHunk": "@@ -263,19 +263,14 @@ private void refreshActiveScenarios() {\n             logger.debug(\"API is null [likely bridge is offline]\");\n         } else {\n             try {\n-                final String[] activeScenarios = api.getActiveScenarios();\n-                final String[] oldScenarios = this.activeScenarios.getAndSet(activeScenarios);\n-\n-                if (!ArrayUtils.isEquals(activeScenarios, oldScenarios)) {\n-                    for (String scenario : activeScenarios) {\n-                        refreshScenarioStatus(scenario);\n-                    }\n-\n-                    for (String oldScenario : oldScenarios) {\n-                        if (!ArrayUtils.contains(activeScenarios, oldScenario)) {\n-                            refreshScenarioStatus(oldScenario);\n-                        }\n-                    }\n+                final String[] apiScenarios = api.getActiveScenarios();\n+                final List<String> activeScenarios = Arrays.asList(apiScenarios);\n+                final List<String> oldScenarios = Arrays.asList(this.activeScenarios.getAndSet(apiScenarios));\n+\n+                if (!activeScenarios.equals(oldScenarios)) {\n+                    activeScenarios.forEach(this::refreshScenarioStatus);\n+                    oldScenarios.removeIf(activeScenarios::contains);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2fdcd377fcc0c4a7dfc737886f98e2637a4133da"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzgwODk5Mg==", "bodyText": "Same issue here.", "url": "https://github.com/openhab/openhab-addons/pull/9028#discussion_r523808992", "createdAt": "2020-11-15T20:25:53Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.neeo/src/main/java/org/openhab/binding/neeo/internal/NeeoRoomProtocol.java", "diffHunk": "@@ -123,18 +123,19 @@ public void processAction(NeeoAction action) {\n     private void processScenarioChange(String scenarioKey, boolean launch) {\n         NeeoUtil.requireNotEmpty(scenarioKey, \"scenarioKey cannot be empty\");\n \n-        final String[] activeScenarios = this.activeScenarios.get();\n-        final int idx = ArrayUtils.indexOf(activeScenarios, scenarioKey);\n+        final List<String> activeScenarios = Arrays.asList(this.activeScenarios.get());\n+        final int idx = activeScenarios.indexOf(scenarioKey);\n \n         // already set that way\n         if ((idx < 0 && !launch) || (idx >= 0 && launch)) {\n             return;\n+        } else if (idx >= 0) {\n+            activeScenarios.remove(scenarioKey);\n+        } else {\n+            activeScenarios.add(scenarioKey);\n         }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2fdcd377fcc0c4a7dfc737886f98e2637a4133da"}, "originalPosition": 50}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f35d04249109a75f119116dae48aab30d2bd03bc", "author": {"user": {"login": "J-N-K", "name": null}}, "url": "https://github.com/openhab/openhab-addons/commit/f35d04249109a75f119116dae48aab30d2bd03bc", "committedDate": "2020-11-15T20:59:26Z", "message": "address review comments\n\nSigned-off-by: Jan N. Klug <jan.n.klug@rub.de>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d96e66ff31b6e94aae13dec49d92e2aca27574a", "author": {"user": {"login": "J-N-K", "name": null}}, "url": "https://github.com/openhab/openhab-addons/commit/7d96e66ff31b6e94aae13dec49d92e2aca27574a", "committedDate": "2020-11-15T21:15:53Z", "message": "fix\n\nSigned-off-by: Jan N. Klug <jan.n.klug@rub.de>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwODM1ODQz", "url": "https://github.com/openhab/openhab-addons/pull/9028#pullrequestreview-530835843", "createdAt": "2020-11-15T21:14:05Z", "commit": {"oid": "f35d04249109a75f119116dae48aab30d2bd03bc"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNVQyMToxNDowNVrOHzjG-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNVQyMjoyOToxM1rOHzjphw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzgxNDY1MA==", "bodyText": "You risk concurrency exceptions if you don't make a copy of the list here.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    final List<String> activeScenarios = this.activeScenarios.get();\n          \n          \n            \n                    final List<String> activeScenarios = new ArrayList<>(this.activeScenarios.get());", "url": "https://github.com/openhab/openhab-addons/pull/9028#discussion_r523814650", "createdAt": "2020-11-15T21:14:05Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.neeo/src/main/java/org/openhab/binding/neeo/internal/NeeoRoomProtocol.java", "diffHunk": "@@ -123,19 +124,23 @@ public void processAction(NeeoAction action) {\n     private void processScenarioChange(String scenarioKey, boolean launch) {\n         NeeoUtil.requireNotEmpty(scenarioKey, \"scenarioKey cannot be empty\");\n \n-        final String[] activeScenarios = this.activeScenarios.get();\n-        final int idx = ArrayUtils.indexOf(activeScenarios, scenarioKey);\n+        final List<String> activeScenarios = this.activeScenarios.get();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f35d04249109a75f119116dae48aab30d2bd03bc"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzgyMzQ5NQ==", "bodyText": "For this to behave correctly in a concurrent environment you should use AtomicReference.compareAndSet to make sure that the reference has't been changed by something else before you were able to set it. Usually this is put in a while loop and only exists once the compareAndSet returns true.", "url": "https://github.com/openhab/openhab-addons/pull/9028#discussion_r523823495", "createdAt": "2020-11-15T22:29:13Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.neeo/src/main/java/org/openhab/binding/neeo/internal/NeeoRoomProtocol.java", "diffHunk": "@@ -123,19 +123,23 @@ public void processAction(NeeoAction action) {\n     private void processScenarioChange(String scenarioKey, boolean launch) {\n         NeeoUtil.requireNotEmpty(scenarioKey, \"scenarioKey cannot be empty\");\n \n-        final String[] activeScenarios = this.activeScenarios.get();\n-        final int idx = ArrayUtils.indexOf(activeScenarios, scenarioKey);\n+        final List<String> activeScenarios = this.activeScenarios.get();\n \n-        // already set that way\n-        if ((idx < 0 && !launch) || (idx >= 0 && launch)) {\n-            return;\n+        if (activeScenarios.contains(scenarioKey)) {\n+            if (launch) {\n+                return;\n+            } else {\n+                activeScenarios.remove(scenarioKey);\n+            }\n+        } else {\n+            if (launch) {\n+                activeScenarios.add(scenarioKey);\n+            } else {\n+                return;\n+            }\n         }\n \n-        final String[] newScenarios = idx >= 0 ? (String[]) ArrayUtils.remove(activeScenarios, idx)\n-                : (String[]) ArrayUtils.add(activeScenarios, scenarioKey);\n-\n-        this.activeScenarios.set(newScenarios);\n-\n+        this.activeScenarios.set(activeScenarios);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d96e66ff31b6e94aae13dec49d92e2aca27574a"}, "originalPosition": 73}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dfb5b82fd49e63cb761c22df59f836fbb19099d1", "author": {"user": {"login": "J-N-K", "name": null}}, "url": "https://github.com/openhab/openhab-addons/commit/dfb5b82fd49e63cb761c22df59f836fbb19099d1", "committedDate": "2020-11-16T07:35:37Z", "message": "address review comments\n\nSigned-off-by: Jan N. Klug <jan.n.klug@rub.de>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxNjk1NzI2", "url": "https://github.com/openhab/openhab-addons/pull/9028#pullrequestreview-531695726", "createdAt": "2020-11-16T20:17:31Z", "commit": {"oid": "dfb5b82fd49e63cb761c22df59f836fbb19099d1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQyMDoxNzozMlrOH0PwPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQyMDoxNzozMlrOH0PwPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDU0NjExMQ==", "bodyText": "The compareAndSet here will never return true since you always make a copy of activeScenarios.get(). The compareAndSet does reference comparison.", "url": "https://github.com/openhab/openhab-addons/pull/9028#discussion_r524546111", "createdAt": "2020-11-16T20:17:32Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.neeo/src/main/java/org/openhab/binding/neeo/internal/NeeoRoomProtocol.java", "diffHunk": "@@ -123,23 +123,28 @@ public void processAction(NeeoAction action) {\n     private void processScenarioChange(String scenarioKey, boolean launch) {\n         NeeoUtil.requireNotEmpty(scenarioKey, \"scenarioKey cannot be empty\");\n \n-        final List<String> activeScenarios = this.activeScenarios.get();\n+        List<String> activeScenarios;\n+        List<String> newActiveScenarios;\n \n-        if (activeScenarios.contains(scenarioKey)) {\n-            if (launch) {\n-                return;\n-            } else {\n-                activeScenarios.remove(scenarioKey);\n-            }\n-        } else {\n-            if (launch) {\n-                activeScenarios.add(scenarioKey);\n+        do {\n+            activeScenarios = new ArrayList<>(this.activeScenarios.get());\n+            newActiveScenarios = new ArrayList<>(activeScenarios);\n+\n+            if (activeScenarios.contains(scenarioKey)) {\n+                if (launch) {\n+                    return;\n+                } else {\n+                    newActiveScenarios.remove(scenarioKey);\n+                }\n             } else {\n-                return;\n+                if (launch) {\n+                    newActiveScenarios.add(scenarioKey);\n+                } else {\n+                    return;\n+                }\n             }\n-        }\n+        } while (!this.activeScenarios.compareAndSet(activeScenarios, newActiveScenarios));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dfb5b82fd49e63cb761c22df59f836fbb19099d1"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1656c529e9690bc85c5b49a9dc46a5b040716cb", "author": {"user": {"login": "J-N-K", "name": null}}, "url": "https://github.com/openhab/openhab-addons/commit/b1656c529e9690bc85c5b49a9dc46a5b040716cb", "committedDate": "2020-11-17T06:45:35Z", "message": "next try\n\nSigned-off-by: Jan N. Klug <jan.n.klug@rub.de>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyNjY0NjM4", "url": "https://github.com/openhab/openhab-addons/pull/9028#pullrequestreview-532664638", "createdAt": "2020-11-17T18:22:54Z", "commit": {"oid": "b1656c529e9690bc85c5b49a9dc46a5b040716cb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4082, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}