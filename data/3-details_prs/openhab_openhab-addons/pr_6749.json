{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU4Nzg4NTEx", "number": 6749, "title": "[yeelight] Add support for yeelight 650 with ambient light (Closes #6\u2026", "bodyText": "Fixes #6227 - Support for Yeelight 650 (ceiling4)\n\nadded needed enums, constants etc.\nadded channel to control ambient light color / brightness\nadded channel to switch to nightlight mode\nstarted implementing unit tests", "createdAt": "2020-01-02T20:45:08Z", "url": "https://github.com/openhab/openhab-addons/pull/6749", "merged": true, "mergeCommit": {"oid": "98e37463867b9a6d4c1a7bc85409fd5d5b9d6590"}, "closed": true, "closedAt": "2020-02-29T15:11:22Z", "author": {"login": "vkoop"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb2f3LdAH2gAyMzU4Nzg4NTExOjYzM2QzMmUwYTFlZDNjOTFhMmViOTE1MTNhZWE0YzZkMzUxOGNmNDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcAUi8UgFqTM1MTkyODI0OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "633d32e0a1ed3c91a2eb91513aea4c6d3518cf46", "author": {"user": {"login": "vkoop", "name": "Viktor Koop"}}, "url": "https://github.com/openhab/openhab-addons/commit/633d32e0a1ed3c91a2eb91513aea4c6d3518cf46", "committedDate": "2020-01-02T20:34:10Z", "message": "[yeelight] Add support for yeelight 650 with ambient light (Closes #6227)\n\nSigned-off-by: Viktor Koop <viktor.koop@googlemail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e258d4828c4b7f6a2ebd654729f16bd0773c2e5", "author": {"user": null}, "url": "https://github.com/openhab/openhab-addons/commit/8e258d4828c4b7f6a2ebd654729f16bd0773c2e5", "committedDate": "2020-01-04T00:18:55Z", "message": "[yeelight] Combine switch cases with similar logic\n\nSigned-off-by: Viktor Koop <viktor.koop@googlemail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "27d03d3f22082ff36aac99719c8e11228d0d8d29", "author": {"user": null}, "url": "https://github.com/openhab/openhab-addons/commit/27d03d3f22082ff36aac99719c8e11228d0d8d29", "committedDate": "2020-01-04T00:18:55Z", "message": "[yeelight] don't initialize variable with useless value\n\nSigned-off-by: Viktor Koop <viktor.koop@googlemail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8758365c4effa12325386f06fda9fdf52befc36", "author": {"user": null}, "url": "https://github.com/openhab/openhab-addons/commit/d8758365c4effa12325386f06fda9fdf52befc36", "committedDate": "2020-01-04T00:20:33Z", "message": "[yeelight] Instead of creating an executor service on every search we create a cached thread pool once.\n\nSigned-off-by: Viktor Koop <viktor.koop@googlemail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4Njc5NTcz", "url": "https://github.com/openhab/openhab-addons/pull/6749#pullrequestreview-338679573", "createdAt": "2020-01-06T14:41:49Z", "commit": {"oid": "561ea85dd224abe3176d8238f3b9f763b0ef6830"}, "state": "DISMISSED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQxNDo0MTo0OVrOFafWNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQxNDo0MTo0OVrOFafWNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzMyMDg4NA==", "bodyText": "backgroundBrightness should probably not be a separate channel. The convention is that a user can create a Dimmer item on the color channel and that should be handled as setting the brightness.", "url": "https://github.com/openhab/openhab-addons/pull/6749#discussion_r363320884", "createdAt": "2020-01-06T14:41:49Z", "author": {"login": "Hilbrand"}, "path": "bundles/org.openhab.binding.yeelight/README.md", "diffHunk": "@@ -39,6 +39,10 @@ All devices support some of the following channels:\n |`color` | `Color` | This channel supports color control, it is available on `wonder` and `stripe`.|\n |`colorTemperature` | `Dimmer` | This channel supports adjusting the color temperature, it is available on `wonder` and `stripe` and `ceiling`.|\n |`command` | `String` | This channel sends a command directly to the device, it is available on all Yeelight Things.|\n+|`backgroundColor` | `Color` | This channel supports color control for the ambient light, it is available on `ceiling4`.|\n+|`backgroundBrightness` | `Dimmer` | This channel supports adjusting the ambient light brightness value, it is available on `ceiling4`.|", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "561ea85dd224abe3176d8238f3b9f763b0ef6830"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "561ea85dd224abe3176d8238f3b9f763b0ef6830", "author": {"user": null}, "url": "https://github.com/openhab/openhab-addons/commit/561ea85dd224abe3176d8238f3b9f763b0ef6830", "committedDate": "2020-01-03T10:00:17Z", "message": "[yeelight] Add support for yeelight 650 with ambient light (Closes #6227)\n\n- combine similar switch cases\n\nSigned-off-by: Viktor Koop <viktor.koop@googlemail.com>"}, "afterCommit": {"oid": "c7c1fcb1ee65e2ce7f1e1b13c80cd73a6aefabd9", "author": {"user": null}, "url": "https://github.com/openhab/openhab-addons/commit/c7c1fcb1ee65e2ce7f1e1b13c80cd73a6aefabd9", "committedDate": "2020-01-08T18:11:24Z", "message": "[yeelight] Fixes code review remarks\n\nSigned-off-by: Viktor Koop <viktor.koop@googlemail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0e0c2f780b37946e88121b3a207ea3033df8137", "author": {"user": null}, "url": "https://github.com/openhab/openhab-addons/commit/f0e0c2f780b37946e88121b3a207ea3033df8137", "committedDate": "2020-01-11T17:20:36Z", "message": "[yeelight] Fixes code review remarks\n\nSigned-off-by: Viktor Koop <viktor.koop@googlemail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c7c1fcb1ee65e2ce7f1e1b13c80cd73a6aefabd9", "author": {"user": null}, "url": "https://github.com/openhab/openhab-addons/commit/c7c1fcb1ee65e2ce7f1e1b13c80cd73a6aefabd9", "committedDate": "2020-01-08T18:11:24Z", "message": "[yeelight] Fixes code review remarks\n\nSigned-off-by: Viktor Koop <viktor.koop@googlemail.com>"}, "afterCommit": {"oid": "f0e0c2f780b37946e88121b3a207ea3033df8137", "author": {"user": null}, "url": "https://github.com/openhab/openhab-addons/commit/f0e0c2f780b37946e88121b3a207ea3033df8137", "committedDate": "2020-01-11T17:20:36Z", "message": "[yeelight] Fixes code review remarks\n\nSigned-off-by: Viktor Koop <viktor.koop@googlemail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxNjk1MjAx", "url": "https://github.com/openhab/openhab-addons/pull/6749#pullrequestreview-351695201", "createdAt": "2020-01-31T18:33:45Z", "commit": {"oid": "f0e0c2f780b37946e88121b3a207ea3033df8137"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQxODozMzo0NVrOFkUI2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQxODozNzoxMVrOFkUOuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzYyMzAwMw==", "bodyText": "Is it really necessary to catch Exception here? Whatr type of exceptions do you expect? The problem with catching Exception is that it also catches NPE and therefore might hide programming errors.", "url": "https://github.com/openhab/openhab-addons/pull/6749#discussion_r373623003", "createdAt": "2020-01-31T18:33:45Z", "author": {"login": "J-N-K"}, "path": "bundles/org.openhab.binding.yeelight/src/main/java/org/openhab/binding/yeelight/internal/lib/device/CeilingDeviceWithAmbientDevice.java", "diffHunk": "@@ -0,0 +1,109 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.yeelight.internal.lib.device;\n+\n+import org.openhab.binding.yeelight.internal.lib.enums.ActiveMode;\n+import org.openhab.binding.yeelight.internal.lib.enums.DeviceType;\n+import org.openhab.binding.yeelight.internal.lib.enums.MethodAction;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParser;\n+\n+/**\n+ * The {@link CeilingDeviceWithAmbientDevice} contains methods for handling the ceiling device with ambient light.\n+ *\n+ * @author Viktor Koop - Initial contribution\n+ */\n+public class CeilingDeviceWithAmbientDevice extends CeilingDevice\n+        implements DeviceWithAmbientLight, DeviceWithNightlight {\n+    private final Logger logger = LoggerFactory.getLogger(CeilingDeviceWithAmbientDevice.class);\n+\n+    public CeilingDeviceWithAmbientDevice(String id) {\n+        super(id);\n+\n+        mDeviceType = DeviceType.ceiling4;\n+    }\n+\n+    @Override\n+    public void onNotify(String msg) {\n+        logger.debug(\"Got state: {}\", msg);\n+\n+        JsonObject result = new JsonParser().parse(msg).getAsJsonObject();\n+\n+        try {\n+            if (result.has(\"id\")) {\n+                String id = result.get(\"id\").getAsString();\n+                // for cmd transaction.\n+\n+                if (mQueryList.contains(id)) {\n+                    JsonArray status = result.get(\"result\").getAsJsonArray();\n+\n+                    final String backgroundPowerState = status.get(4).toString();\n+                    if (\"\\\"off\\\"\".equals(backgroundPowerState)) {\n+                        mDeviceStatus.setBackgroundIsPowerOff(true);\n+                    } else if (\"\\\"on\\\"\".equals(backgroundPowerState)) {\n+                        mDeviceStatus.setBackgroundIsPowerOff(false);\n+                    }\n+\n+                    final int backgroundBrightness = status.get(5).getAsInt();\n+                    mDeviceStatus.setBackgroundBrightness(backgroundBrightness);\n+\n+                    final int backgroundHue = status.get(6).getAsInt();\n+                    mDeviceStatus.setBackgroundHue(backgroundHue);\n+\n+                    final int backgroundSaturation = status.get(7).getAsInt();\n+                    mDeviceStatus.setBackgroundSat(backgroundSaturation);\n+\n+                    final int activeMode = status.get(8).getAsInt();\n+                    mDeviceStatus.setActiveMode(ActiveMode.values()[activeMode]);\n+                }\n+            }\n+        } catch (Exception e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0e0c2f780b37946e88121b3a207ea3033df8137"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzYyNDUwNQ==", "bodyText": "Wouldn't it be possible to use switch (property)  here? Since Java 7 we can switch on strings.", "url": "https://github.com/openhab/openhab-addons/pull/6749#discussion_r373624505", "createdAt": "2020-01-31T18:37:11Z", "author": {"login": "J-N-K"}, "path": "bundles/org.openhab.binding.yeelight/src/main/java/org/openhab/binding/yeelight/internal/lib/device/DeviceBase.java", "diffHunk": "@@ -79,48 +78,39 @@ public void onNotify(String response) {\n         boolean needNotify = true;\n         JsonObject message = new JsonParser().parse(response).getAsJsonObject();\n         try {\n-            String updateProp = \"\";\n             if (message.has(\"method\")) {\n                 String method = message.get(\"method\").toString().replace(\"\\\"\", \"\");\n                 if (method.equals(\"props\")) {// Property notify\n                     String params = message.get(\"params\").toString();\n                     JsonObject propsObject = new JsonParser().parse(params).getAsJsonObject();\n-                    Set<Entry<String, JsonElement>> props = propsObject.entrySet();\n-                    Iterator<Entry<String, JsonElement>> iterator = props.iterator();\n-                    while (iterator.hasNext()) {\n-                        Entry<String, JsonElement> prop = iterator.next();\n-                        if (prop.getKey().equals(\"power\")) {\n-                            updateProp += \" power\";\n+                    for (Entry<String, JsonElement> prop : propsObject.entrySet()) {\n+                        final YeelightDeviceProperty property = YeelightDeviceProperty.fromString(prop.getKey());\n+                        if (YeelightDeviceProperty.POWER.equals(property)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0e0c2f780b37946e88121b3a207ea3033df8137"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dbcbb991001a049858ddccafe8dd0b5f2e575713", "author": {"user": null}, "url": "https://github.com/openhab/openhab-addons/commit/dbcbb991001a049858ddccafe8dd0b5f2e575713", "committedDate": "2020-01-31T20:25:36Z", "message": "[yeelight] Fixed code review remarks.\n\nSigned-off-by: Viktor Koop <viktor.koop@googlemail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "766ef14e1aef03d77dca81ff41a106e8f57f026b", "author": {"user": null}, "url": "https://github.com/openhab/openhab-addons/commit/766ef14e1aef03d77dca81ff41a106e8f57f026b", "committedDate": "2020-01-31T20:01:37Z", "message": "[yeelight] Fixed code review remarks.\n\nSigned-off-by: Viktor Koop <viktor.koop@googlemail.com>"}, "afterCommit": {"oid": "dbcbb991001a049858ddccafe8dd0b5f2e575713", "author": {"user": null}, "url": "https://github.com/openhab/openhab-addons/commit/dbcbb991001a049858ddccafe8dd0b5f2e575713", "committedDate": "2020-01-31T20:25:36Z", "message": "[yeelight] Fixed code review remarks.\n\nSigned-off-by: Viktor Koop <viktor.koop@googlemail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxOTI4MjQ4", "url": "https://github.com/openhab/openhab-addons/pull/6749#pullrequestreview-351928248", "createdAt": "2020-02-02T09:02:21Z", "commit": {"oid": "dbcbb991001a049858ddccafe8dd0b5f2e575713"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1786, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}