{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE3MTg1ODQy", "number": 8981, "title": "[miio]  Cloud Communication for devices", "bodyText": "Allows to define if communication to devices is direct or send via the\nXiaomi cloud. (#7276)\nIntroduce additional channel to execute commands via cloud.\nOther small improvements\n\nUse common method from abstract handler to send commands\nCommon way to handle custom commands\nIntroduce small delay before refreshing robot properties after sending\ncommands (similar to the basic handler) so devices have time to update\ntheir properties\n\nSigned-off-by: Marcel Verpaalen marcel@verpaalen.com", "createdAt": "2020-11-07T20:02:58Z", "url": "https://github.com/openhab/openhab-addons/pull/8981", "merged": true, "mergeCommit": {"oid": "ad202edefa2c934609c36e4a9ddaa4bcbd52832c"}, "closed": true, "closedAt": "2020-11-29T04:03:13Z", "author": {"login": "marcelrv"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdaq_CcAFqTUyNTg1MTg3MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdhIpW4gFqTU0MDQ0NTMyMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1ODUxODcx", "url": "https://github.com/openhab/openhab-addons/pull/8981#pullrequestreview-525851871", "createdAt": "2020-11-08T22:28:55Z", "commit": {"oid": "8e88c6fe49258340a8a50644a5b8ad2dde1b48e6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOFQyMjoyODo1NVrOHva6oQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOFQyMjozMTowMVrOHva7pw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTQ4NjExMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        throw new MiCloudException();\n          \n          \n            \n                        throw new MiCloudException(e);", "url": "https://github.com/openhab/openhab-addons/pull/8981#discussion_r519486113", "createdAt": "2020-11-08T22:28:55Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/cloud/MiCloudConnector.java", "diffHunk": "@@ -176,10 +176,26 @@ public String getMapUrl(String vacuumMap, String country) throws MiCloudExceptio\n     }\n \n     public String getDeviceStatus(String device, String country) throws MiCloudException {\n-        String url = getApiUrl(country) + \"/home/device_list\";\n-        Map<String, String> map = new HashMap<String, String>();\n-        map.put(\"data\", \"{\\\"dids\\\":[\\\"\" + device + \"\\\"]}\");\n-        final String response = request(url, map);\n+        final String response = request(\"/home/device_list\", country, \"{\\\"dids\\\":[\\\"\" + device + \"\\\"]}\");\n+        logger.debug(\"response: {}\", response);\n+        return response;\n+    }\n+\n+    public String sendRPCCommand(String device, String country, String command) throws MiCloudException {\n+        if (device.length() != 8) {\n+            logger.debug(\"Device ID ('{}') incorrect or missing. Command not send: {}\", device, command);\n+        }\n+        if (country.length() > 3 || country.length() < 2) {\n+            logger.debug(\"Country ('{}') incorrect or missing. Command not send: {}\", device, command);\n+        }\n+        String id = \"\";\n+        try {\n+            id = String.valueOf(Long.parseUnsignedLong(device, 16));\n+        } catch (NumberFormatException e) {\n+            logger.debug(\"Could not parse device ID ('{}')\", device);\n+            throw new MiCloudException();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e88c6fe49258340a8a50644a5b8ad2dde1b48e6"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTQ4NjM3NQ==", "bodyText": "Please make sure store the future to a field and cancel it when the handler is disposed.", "url": "https://github.com/openhab/openhab-addons/pull/8981#discussion_r519486375", "createdAt": "2020-11-08T22:31:01Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/handler/MiIoVacuumHandler.java", "diffHunk": "@@ -240,14 +241,13 @@ public void handleCommand(ChannelUID channelUID, Command command) {\n             sendCommand(MiIoCommand.CONSUMABLES_RESET, \"[\" + command.toString() + \"]\");\n             updateState(CHANNEL_CONSUMABLE_RESET, new StringType(\"none\"));\n         }\n-        if (channelUID.getId().equals(CHANNEL_COMMAND)) {\n-            cmds.put(sendCommand(command.toString()), command.toString());\n-        }\n     }\n \n     private void forceStatusUpdate() {\n         status.invalidateValue();\n-        status.getValue();\n+        scheduler.schedule(() -> {\n+            status.getValue();\n+        }, 3000, TimeUnit.MILLISECONDS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e88c6fe49258340a8a50644a5b8ad2dde1b48e6"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2cbaffa4131a4bf0c327bdd8059c0b22fde47ef8", "author": {"user": {"login": "marcelrv", "name": "Marcel"}}, "url": "https://github.com/openhab/openhab-addons/commit/2cbaffa4131a4bf0c327bdd8059c0b22fde47ef8", "committedDate": "2020-11-09T19:09:04Z", "message": "[miio]  Cloud Communication for devices\n\nAllows to define if communication to devices is direct or send via the\nXiaomi cloud.\nIntroduce additional channel to execute commands via cloud.\n\nOther small improvements\n* Use common method from abstract handler to send commands\n* Common way to handle custom commands\n* Introduce small delay before refreshing robot properties after sending\ncommands (similar to the basic handler) so devices have time to update\ntheir properties\n\nSigned-off-by: Marcel Verpaalen <marcel@verpaalen.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55355ba4763854027389bc0f9fde17b357004a2f", "author": {"user": {"login": "marcelrv", "name": "Marcel"}}, "url": "https://github.com/openhab/openhab-addons/commit/55355ba4763854027389bc0f9fde17b357004a2f", "committedDate": "2020-11-09T19:09:05Z", "message": "[miio] simplify cloudconnector\n\nsimplify cloudconnector\nspotless run\n\n\nSigned-off-by: Marcel Verpaalen <marcel@verpaalen.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a9353d1bec88e8e65a2e94f5181e3f1b0d6d377", "author": {"user": {"login": "marcelrv", "name": "Marcel"}}, "url": "https://github.com/openhab/openhab-addons/commit/3a9353d1bec88e8e65a2e94f5181e3f1b0d6d377", "committedDate": "2020-11-09T20:58:15Z", "message": "[miio] Cleanup all jobs when unloading\n\nSigned-off-by: Marcel Verpaalen <marcel@verpaalen.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8e88c6fe49258340a8a50644a5b8ad2dde1b48e6", "author": {"user": {"login": "marcelrv", "name": "Marcel"}}, "url": "https://github.com/openhab/openhab-addons/commit/8e88c6fe49258340a8a50644a5b8ad2dde1b48e6", "committedDate": "2020-11-08T21:36:00Z", "message": "[miio] simplify cloudconnector\n\nsimplify cloudconnector\nspotless run\n\n\nSigned-off-by: Marcel Verpaalen <marcel@verpaalen.com>"}, "afterCommit": {"oid": "3a9353d1bec88e8e65a2e94f5181e3f1b0d6d377", "author": {"user": {"login": "marcelrv", "name": "Marcel"}}, "url": "https://github.com/openhab/openhab-addons/commit/3a9353d1bec88e8e65a2e94f5181e3f1b0d6d377", "committedDate": "2020-11-09T20:58:15Z", "message": "[miio] Cleanup all jobs when unloading\n\nSigned-off-by: Marcel Verpaalen <marcel@verpaalen.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26376330f4f3089859b07165bb2627b2a1525870", "author": {"user": {"login": "marcelrv", "name": "Marcel"}}, "url": "https://github.com/openhab/openhab-addons/commit/26376330f4f3089859b07165bb2627b2a1525870", "committedDate": "2020-11-09T21:15:56Z", "message": "[miio] fix spotless complaint\n\nSigned-off-by: Marcel Verpaalen <marcel@verpaalen.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2Njc5MzY4", "url": "https://github.com/openhab/openhab-addons/pull/8981#pullrequestreview-526679368", "createdAt": "2020-11-09T21:44:58Z", "commit": {"oid": "26376330f4f3089859b07165bb2627b2a1525870"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMTo0NDo1OFrOHwC0pQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMTo0NDo1OFrOHwC0pQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDEzOTk0MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    for (ScheduledFuture<?> s : scheduledJobs) {\n          \n          \n            \n                        if (s.isDone()) {\n          \n          \n            \n                            scheduledJobs.remove(s);\n          \n          \n            \n                        }\n          \n          \n            \n                    }\n          \n          \n            \n                    scheduledJobs.removeIf(Future::isDone);", "url": "https://github.com/openhab/openhab-addons/pull/8981#discussion_r520139941", "createdAt": "2020-11-09T21:44:58Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/handler/MiIoAbstractHandler.java", "diffHunk": "@@ -163,6 +183,14 @@ private boolean tokenCheckPass(@Nullable String tokenSting) {\n         }\n     }\n \n+    protected void removedCompletedJobs() {\n+        for (ScheduledFuture<?> s : scheduledJobs) {\n+            if (s.isDone()) {\n+                scheduledJobs.remove(s);\n+            }\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "26376330f4f3089859b07165bb2627b2a1525870"}, "originalPosition": 92}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "153260b7aa232370c920eafe8cc6113453e4b3ff", "author": {"user": {"login": "marcelrv", "name": "Marcel"}}, "url": "https://github.com/openhab/openhab-addons/commit/153260b7aa232370c920eafe8cc6113453e4b3ff", "committedDate": "2020-11-12T19:41:53Z", "message": "[miio] update to use dedicated ScheduledExecutorService\n\nUse dedicated ScheduledExecutorService to avoid unloading problems\n\nSigned-off-by: Marcel Verpaalen <marcel@verpaalen.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c41c1964371e8fb943801623bd950dc0f53b004", "author": {"user": {"login": "marcelrv", "name": "Marcel"}}, "url": "https://github.com/openhab/openhab-addons/commit/5c41c1964371e8fb943801623bd950dc0f53b004", "committedDate": "2020-11-13T09:24:30Z", "message": "Update bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/handler/MiIoAbstractHandler.java\n\nCo-authored-by: Connor Petty <mistercpp2000@gmail.com>\nSigned-off-by: Marcel Verpaalen <marcel@verpaalen.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4a7ae4ea8ccbcdb209127f6bfd7b47590b79dd0e", "author": {"user": {"login": "marcelrv", "name": "Marcel"}}, "url": "https://github.com/openhab/openhab-addons/commit/4a7ae4ea8ccbcdb209127f6bfd7b47590b79dd0e", "committedDate": "2020-11-12T19:53:42Z", "message": "Update bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/handler/MiIoAbstractHandler.java\n\nCo-authored-by: Connor Petty <mistercpp2000@gmail.com>"}, "afterCommit": {"oid": "5c41c1964371e8fb943801623bd950dc0f53b004", "author": {"user": {"login": "marcelrv", "name": "Marcel"}}, "url": "https://github.com/openhab/openhab-addons/commit/5c41c1964371e8fb943801623bd950dc0f53b004", "committedDate": "2020-11-13T09:24:30Z", "message": "Update bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/handler/MiIoAbstractHandler.java\n\nCo-authored-by: Connor Petty <mistercpp2000@gmail.com>\nSigned-off-by: Marcel Verpaalen <marcel@verpaalen.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "67d3d0f8fcac5e4199d5e23c6ffa895d27494dbf", "author": {"user": {"login": "marcelrv", "name": "Marcel"}}, "url": "https://github.com/openhab/openhab-addons/commit/67d3d0f8fcac5e4199d5e23c6ffa895d27494dbf", "committedDate": "2020-11-13T09:29:14Z", "message": "[miio] fix for removeif\n\nSigned-off-by: Marcel Verpaalen <marcel@verpaalen.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNDc3OTQ2", "url": "https://github.com/openhab/openhab-addons/pull/8981#pullrequestreview-530477946", "createdAt": "2020-11-13T23:29:03Z", "commit": {"oid": "67d3d0f8fcac5e4199d5e23c6ffa895d27494dbf"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMzoyOTowM1rOHzCtRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMzoyOTowM1rOHzCtRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI4Mzc4Mw==", "bodyText": "You shouldn't perform shutdown of the threadpools returned by ThreadPoolManager.\nInstead you should create your own ScheduledThreadPoolExecutor instance as follows:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    miIoScheduler = ThreadPoolManager.getScheduledPool(getThing().getUID().getAsString());\n          \n          \n            \n                    miIoScheduler = new ScheduledThreadPoolExecutor(1,\n          \n          \n            \n                            new NamedThreadFactory(getThing().getUID().getAsString(), true));\n          \n          \n            \n                    miIoScheduler.setExecuteExistingDelayedTasksAfterShutdownPolicy(false);\n          \n          \n            \n                    miIoScheduler.setRemoveOnCancelPolicy(true);\n          \n      \n    \n    \n  \n\nThe example above creates a scheduler with only a single thread, but you can increase this number as you see fit.", "url": "https://github.com/openhab/openhab-addons/pull/8981#discussion_r523283783", "createdAt": "2020-11-13T23:29:03Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/handler/MiIoAbstractHandler.java", "diffHunk": "@@ -93,18 +102,35 @@\n     private final Logger logger = LoggerFactory.getLogger(MiIoAbstractHandler.class);\n     protected MiIoDatabaseWatchService miIoDatabaseWatchService;\n \n-    public MiIoAbstractHandler(Thing thing, MiIoDatabaseWatchService miIoDatabaseWatchService) {\n+    public MiIoAbstractHandler(Thing thing, MiIoDatabaseWatchService miIoDatabaseWatchService,\n+            CloudConnector cloudConnector) {\n         super(thing);\n         this.miIoDatabaseWatchService = miIoDatabaseWatchService;\n+        this.cloudConnector = cloudConnector;\n     }\n \n     @Override\n     public abstract void handleCommand(ChannelUID channelUID, Command command);\n \n+    protected boolean handleCommandsChannels(ChannelUID channelUID, Command command) {\n+        if (channelUID.getId().equals(CHANNEL_COMMAND)) {\n+            cmds.put(sendCommand(command.toString(), \"\"), command.toString());\n+            return true;\n+        }\n+        if (channelUID.getId().equals(CHANNEL_RPC)) {\n+            cmds.put(sendCommand(command.toString(), cloudServer), command.toString());\n+            return true;\n+        }\n+        return false;\n+    }\n+\n     @Override\n     public void initialize() {\n         logger.debug(\"Initializing Mi IO device handler '{}' with thingType {}\", getThing().getUID(),\n                 getThing().getThingTypeUID());\n+\n+        miIoScheduler = ThreadPoolManager.getScheduledPool(getThing().getUID().getAsString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "67d3d0f8fcac5e4199d5e23c6ffa895d27494dbf"}, "originalPosition": 72}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNDc4NjA3", "url": "https://github.com/openhab/openhab-addons/pull/8981#pullrequestreview-530478607", "createdAt": "2020-11-13T23:31:22Z", "commit": {"oid": "67d3d0f8fcac5e4199d5e23c6ffa895d27494dbf"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMzozMToyMlrOHzCvtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMzozMToyMlrOHzCvtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI4NDQwNQ==", "bodyText": "If since you need it to be non-null, but are going to override it anyway during initialization, then I see no problem with initially setting it to the BaseThingHandler scheduler.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                protected ScheduledExecutorService miIoScheduler = ThreadPoolManager.getScheduledPool(BINDING_ID);\n          \n          \n            \n                protected ScheduledExecutorService miIoScheduler = scheduler;", "url": "https://github.com/openhab/openhab-addons/pull/8981#discussion_r523284405", "createdAt": "2020-11-13T23:31:22Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/handler/MiIoAbstractHandler.java", "diffHunk": "@@ -67,7 +71,10 @@\n     protected static final int MAX_QUEUE = 5;\n     protected static final Gson GSON = new GsonBuilder().create();\n \n+    protected ScheduledExecutorService miIoScheduler = ThreadPoolManager.getScheduledPool(BINDING_ID);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "67d3d0f8fcac5e4199d5e23c6ffa895d27494dbf"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5557b15bb6ee5419e7669e0553bc218e07876620", "author": {"user": {"login": "marcelrv", "name": "Marcel"}}, "url": "https://github.com/openhab/openhab-addons/commit/5557b15bb6ee5419e7669e0553bc218e07876620", "committedDate": "2020-11-23T20:16:26Z", "message": "miio- Improve scheduler\n\nCo-authored-by: Connor Petty <mistercpp2000@gmail.com>\nSigned-off-by: Marcel Verpaalen <marcel@verpaalen.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78f0e74b76b03920d71688058d8ca818a81fbe56", "author": {"user": {"login": "marcelrv", "name": "Marcel"}}, "url": "https://github.com/openhab/openhab-addons/commit/78f0e74b76b03920d71688058d8ca818a81fbe56", "committedDate": "2020-11-23T20:26:21Z", "message": "[miio] fix communication error if device is not on the network\n\nSigned-off-by: Marcel Verpaalen <marcel@verpaalen.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4NzQ4MDc0", "url": "https://github.com/openhab/openhab-addons/pull/8981#pullrequestreview-538748074", "createdAt": "2020-11-25T18:13:08Z", "commit": {"oid": "5557b15bb6ee5419e7669e0553bc218e07876620"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxODoxMzowOFrOH5_BOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxODo0Mzo1NFrOH5_7_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDU2MzM4NQ==", "bodyText": "Don't set it to scheduler here, it would just allow further tasks to be scheduled after disposal.", "url": "https://github.com/openhab/openhab-addons/pull/8981#discussion_r530563385", "createdAt": "2020-11-25T18:13:08Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/handler/MiIoAbstractHandler.java", "diffHunk": "@@ -216,7 +220,8 @@ public void dispose() {\n             }\n         }\n         scheduledJobs.clear();\n-        miIoScheduler = ThreadPoolManager.getScheduledPool(BINDING_ID);\n+        miIoScheduler.shutdownNow();\n+        miIoScheduler = scheduler;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5557b15bb6ee5419e7669e0553bc218e07876620"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDU2Nzk1OQ==", "bodyText": "Always pass the cause exception.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        throw new MiCloudException(err);\n          \n          \n            \n                        throw new MiCloudException(err, e);", "url": "https://github.com/openhab/openhab-addons/pull/8981#discussion_r530567959", "createdAt": "2020-11-25T18:22:09Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/cloud/MiCloudConnector.java", "diffHunk": "@@ -176,10 +176,27 @@ public String getMapUrl(String vacuumMap, String country) throws MiCloudExceptio\n     }\n \n     public String getDeviceStatus(String device, String country) throws MiCloudException {\n-        String url = getApiUrl(country) + \"/home/device_list\";\n-        Map<String, String> map = new HashMap<String, String>();\n-        map.put(\"data\", \"{\\\"dids\\\":[\\\"\" + device + \"\\\"]}\");\n-        final String response = request(url, map);\n+        final String response = request(\"/home/device_list\", country, \"{\\\"dids\\\":[\\\"\" + device + \"\\\"]}\");\n+        logger.debug(\"response: {}\", response);\n+        return response;\n+    }\n+\n+    public String sendRPCCommand(String device, String country, String command) throws MiCloudException {\n+        if (device.length() != 8) {\n+            logger.debug(\"Device ID ('{}') incorrect or missing. Command not send: {}\", device, command);\n+        }\n+        if (country.length() > 3 || country.length() < 2) {\n+            logger.debug(\"Country ('{}') incorrect or missing. Command not send: {}\", device, command);\n+        }\n+        String id = \"\";\n+        try {\n+            id = String.valueOf(Long.parseUnsignedLong(device, 16));\n+        } catch (NumberFormatException e) {\n+            String err = \"Could not parse device ID ('\" + device.toString() + \"')\";\n+            logger.debug(\"{}\", err);\n+            throw new MiCloudException(err);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78f0e74b76b03920d71688058d8ca818a81fbe56"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDU3ODQzMA==", "bodyText": "miIoScheduler.shutdownNow() will automatically cancel any running tasks. So I don't think you need to track the scheduledJobs manually since the miIoScheduler handles it for you.", "url": "https://github.com/openhab/openhab-addons/pull/8981#discussion_r530578430", "createdAt": "2020-11-25T18:43:54Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/handler/MiIoAbstractHandler.java", "diffHunk": "@@ -67,7 +72,9 @@\n     protected static final int MAX_QUEUE = 5;\n     protected static final Gson GSON = new GsonBuilder().create();\n \n+    protected ScheduledExecutorService miIoScheduler = scheduler;\n     protected @Nullable ScheduledFuture<?> pollingJob;\n+    protected CopyOnWriteArraySet<ScheduledFuture<?>> scheduledJobs = new CopyOnWriteArraySet<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78f0e74b76b03920d71688058d8ca818a81fbe56"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b04b8067d7e33a16edbec11a5810f2cda1e745a9", "author": {"user": {"login": "marcelrv", "name": "Marcel"}}, "url": "https://github.com/openhab/openhab-addons/commit/b04b8067d7e33a16edbec11a5810f2cda1e745a9", "committedDate": "2020-11-26T08:10:36Z", "message": "[miio] update with comments from feedback\n\n* remove scheduler tracking\n* improve status setting for cloud communication\n\nSigned-off-by: Marcel Verpaalen <marcel@verpaalen.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ee2e175ad8cbb4e2ad1dc9861ca24b1eb9e45b0", "author": {"user": {"login": "marcelrv", "name": "Marcel"}}, "url": "https://github.com/openhab/openhab-addons/commit/6ee2e175ad8cbb4e2ad1dc9861ca24b1eb9e45b0", "committedDate": "2020-11-26T08:14:01Z", "message": "[miio] update with feedback review\n\nSigned-off-by: Marcel Verpaalen <marcel@verpaalen.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b862800f4cccae64f09e01a731dd67526563c820", "author": {"user": {"login": "marcelrv", "name": "Marcel"}}, "url": "https://github.com/openhab/openhab-addons/commit/b862800f4cccae64f09e01a731dd67526563c820", "committedDate": "2020-11-26T22:58:25Z", "message": "Merge updates\n\nSigned-off-by: Marcel Verpaalen <marcel@verpaalen.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "085b6b5f7e463e45c40b762d5c52943945576285", "author": {"user": {"login": "marcelrv", "name": "Marcel"}}, "url": "https://github.com/openhab/openhab-addons/commit/085b6b5f7e463e45c40b762d5c52943945576285", "committedDate": "2020-11-27T08:11:09Z", "message": "readme update once more\n\nSigned-off-by: Marcel Verpaalen <marcel@verpaalen.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwNDQ1MzIx", "url": "https://github.com/openhab/openhab-addons/pull/8981#pullrequestreview-540445321", "createdAt": "2020-11-29T04:01:09Z", "commit": {"oid": "085b6b5f7e463e45c40b762d5c52943945576285"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4056, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}