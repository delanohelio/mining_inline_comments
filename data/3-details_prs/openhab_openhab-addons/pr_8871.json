{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEwMTEzMTU3", "number": 8871, "title": "[Linky] Some enhancements and corrections on the linky binding", "bodyText": "Modified documentation to reflect evolutions of Enedis website.\nCreating a httpClient per handler.\nAvoiding warning (+5000ms) at initialization of the handler", "createdAt": "2020-10-26T15:29:30Z", "url": "https://github.com/openhab/openhab-addons/pull/8871", "merged": true, "mergeCommit": {"oid": "5a1428dddc36c75921d432b65f5f13b00c29f6df"}, "closed": true, "closedAt": "2020-11-10T17:08:03Z", "author": {"login": "clinique"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdWnAQmgFqTUxNzU4NjEzOQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbMfmZAFqTUyNzQxOTc0MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3NTg2MTM5", "url": "https://github.com/openhab/openhab-addons/pull/8871#pullrequestreview-517586139", "createdAt": "2020-10-27T11:10:09Z", "commit": {"oid": "648368732e9c234a32a81da4bd34af0100f7ef16"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3NTk0NDkw", "url": "https://github.com/openhab/openhab-addons/pull/8871#pullrequestreview-517594490", "createdAt": "2020-10-27T11:21:36Z", "commit": {"oid": "648368732e9c234a32a81da4bd34af0100f7ef16"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxMToyMTozNlrOHo3L9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxMToyMTozNlrOHo3L9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjYwOTI3MA==", "bodyText": "Why do you need a new client for each thing?", "url": "https://github.com/openhab/openhab-addons/pull/8871#discussion_r512609270", "createdAt": "2020-10-27T11:21:36Z", "author": {"login": "J-N-K"}, "path": "bundles/org.openhab.binding.linky/src/main/java/org/openhab/binding/linky/internal/LinkyHandlerFactory.java", "diffHunk": "@@ -69,10 +68,9 @@ public boolean supportsThingType(ThingTypeUID thingTypeUID) {\n     protected @Nullable ThingHandler createHandler(Thing thing) {\n         ThingTypeUID thingTypeUID = thing.getThingTypeUID();\n \n-        if (supportsThingType(thingTypeUID)) {\n-            return new LinkyHandler(thing, localeProvider, gson, httpClient);\n-        }\n-\n-        return null;\n+        return supportsThingType(thingTypeUID)\n+                ? new LinkyHandler(thing, localeProvider, gson,\n+                        httpClientFactory.createHttpClient(thingTypeUID.getAsString().replace(\":\", \"_\")))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "648368732e9c234a32a81da4bd34af0100f7ef16"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxMTYxNTcy", "url": "https://github.com/openhab/openhab-addons/pull/8871#pullrequestreview-521161572", "createdAt": "2020-10-31T18:57:59Z", "commit": {"oid": "648368732e9c234a32a81da4bd34af0100f7ef16"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMVQxODo1Nzo1OVrOHrpU0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMVQxOTowMDoyMlrOHrpVvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTUyNzg5MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            8. Repeat steps 1, 2. You should arrive directly on step 5, then open the developper tool window (F12) and select \"Stockage\" tab. In the \"Cookies\" entry, select \"https://mon-compte-enedis.fr\". You'll find an entry named \"internalAuthId\", copy this value in your Openhab configuration.\n          \n          \n            \n            8. Repeat steps 1, 2. You should arrive directly on step 5, then open the developer tool window (F12) and select \"Stockage\" tab. In the \"Cookies\" entry, select \"https://mon-compte-enedis.fr\". You'll find an entry named \"internalAuthId\", copy this value in your Openhab configuration.", "url": "https://github.com/openhab/openhab-addons/pull/8871#discussion_r515527890", "createdAt": "2020-10-31T18:57:59Z", "author": {"login": "J-N-K"}, "path": "bundles/org.openhab.binding.linky/README.md", "diffHunk": "@@ -40,7 +40,8 @@ Instructions given for Firefox :\n 4. Clic on \"Suivant\".\n 5. In the login page, prefilled with your mail address, enter your Enedis account password and click on \"Connexion \u00e0 Espace Client Enedis\".\n 6. You will be directed to your Enedis account environment. Get back to previous page in you browser.\n-7. Open the developper tool window (F12) and select \"Stockage\" tab. In the \"Cookies\" entry, select \"https://mon-compte-enedis.fr\". You should see an entry named \"internalAuthId\", copy this value in your Openhab configuration.\n+7. Disconnect from your Enedis account\n+8. Repeat steps 1, 2. You should arrive directly on step 5, then open the developper tool window (F12) and select \"Stockage\" tab. In the \"Cookies\" entry, select \"https://mon-compte-enedis.fr\". You'll find an entry named \"internalAuthId\", copy this value in your Openhab configuration.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "648368732e9c234a32a81da4bd34af0100f7ef16"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTUyODEyNQ==", "bodyText": "Of course hthe shared client should never be stopped, so this if of course a good reason. But why is it necessary to start/stop the client?", "url": "https://github.com/openhab/openhab-addons/pull/8871#discussion_r515528125", "createdAt": "2020-10-31T19:00:22Z", "author": {"login": "J-N-K"}, "path": "bundles/org.openhab.binding.linky/src/main/java/org/openhab/binding/linky/internal/LinkyHandlerFactory.java", "diffHunk": "@@ -69,10 +68,9 @@ public boolean supportsThingType(ThingTypeUID thingTypeUID) {\n     protected @Nullable ThingHandler createHandler(Thing thing) {\n         ThingTypeUID thingTypeUID = thing.getThingTypeUID();\n \n-        if (supportsThingType(thingTypeUID)) {\n-            return new LinkyHandler(thing, localeProvider, gson, httpClient);\n-        }\n-\n-        return null;\n+        return supportsThingType(thingTypeUID)\n+                ? new LinkyHandler(thing, localeProvider, gson,\n+                        httpClientFactory.createHttpClient(thingTypeUID.getAsString().replace(\":\", \"_\")))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjYwOTI3MA=="}, "originalCommit": {"oid": "648368732e9c234a32a81da4bd34af0100f7ef16"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7d73d2a22b53f514af0711ab46d167f4d033534", "author": {"user": {"login": "clinique", "name": "Ga\u00ebl L'hopital"}}, "url": "https://github.com/openhab/openhab-addons/commit/d7d73d2a22b53f514af0711ab46d167f4d033534", "committedDate": "2020-11-03T16:39:06Z", "message": "Some enhancements and corrections on the linky binding\nspotless apply\nAdressing code review comments\n\nSigned-off-by: clinique <gael@lhopital.org>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5fc920c8afdce4ce6b4a75b97aa79bc6b78f79f2", "author": {"user": {"login": "clinique", "name": "Ga\u00ebl L'hopital"}}, "url": "https://github.com/openhab/openhab-addons/commit/5fc920c8afdce4ce6b4a75b97aa79bc6b78f79f2", "committedDate": "2020-11-03T16:37:31Z", "message": "Adressing code review comments"}, "afterCommit": {"oid": "d7d73d2a22b53f514af0711ab46d167f4d033534", "author": {"user": {"login": "clinique", "name": "Ga\u00ebl L'hopital"}}, "url": "https://github.com/openhab/openhab-addons/commit/d7d73d2a22b53f514af0711ab46d167f4d033534", "committedDate": "2020-11-03T16:39:06Z", "message": "Some enhancements and corrections on the linky binding\nspotless apply\nAdressing code review comments\n\nSigned-off-by: clinique <gael@lhopital.org>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyNzI2NzU1", "url": "https://github.com/openhab/openhab-addons/pull/8871#pullrequestreview-522726755", "createdAt": "2020-11-03T17:30:40Z", "commit": {"oid": "d7d73d2a22b53f514af0711ab46d167f4d033534"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxNzozMDo0MFrOHs5Wug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxNzozMDo0MFrOHs5Wug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjgzOTA5OA==", "bodyText": "Please check that you have enough data to avoid s potential NPE.", "url": "https://github.com/openhab/openhab-addons/pull/8871#discussion_r516839098", "createdAt": "2020-11-03T17:30:40Z", "author": {"login": "lolodomo"}, "path": "bundles/org.openhab.binding.linky/src/main/java/org/openhab/binding/linky/internal/handler/LinkyHandler.java", "diffHunk": "@@ -167,50 +168,57 @@ public void initialize() {\n     private void updateData() {\n         updatePowerData();\n         updateDailyData();\n+        updateWeeklyData();\n         updateMonthlyData();\n         updateYearlyData();\n     }\n \n     private synchronized void updatePowerData() {\n         if (isLinked(PEAK_POWER) || isLinked(PEAK_TIMESTAMP)) {\n-            Consumption result = cachedPowerData.getValue();\n-            if (result != null) {\n-                updateVAChannel(PEAK_POWER, result.aggregats.days.datas.get(0));\n-                updateState(PEAK_TIMESTAMP, new DateTimeType(result.aggregats.days.periodes.get(0).dateDebut));\n-            }\n+            cachedPowerData.getValue().ifPresent(values -> {\n+                updateVAChannel(PEAK_POWER, values.aggregats.days.datas.get(0));\n+                updateState(PEAK_TIMESTAMP, new DateTimeType(values.aggregats.days.periodes.get(0).dateDebut));\n+            });\n         }\n     }\n \n     /**\n      * Request new dayly/weekly data and updates channels\n      */\n     private synchronized void updateDailyData() {\n-        if (isLinked(YESTERDAY) || isLinked(LAST_WEEK) || isLinked(THIS_WEEK)) {\n-            Consumption result = cachedDaylyData.getValue();\n-            if (result != null) {\n-                Aggregate days = result.aggregats.days;\n-\n+        if (isLinked(YESTERDAY) || isLinked(THIS_WEEK)) {\n+            cachedDailyData.getValue().ifPresent(values -> {\n+                Aggregate days = values.aggregats.days;\n                 int maxValue = days.periodes.size() - 1;\n                 int thisWeekNumber = days.periodes.get(maxValue).dateDebut.get(weekFields.weekOfWeekBasedYear());\n                 double yesterday = days.datas.get(maxValue);\n-                double lastWeek = 0.0;\n-                double thisWeek = 0.0;\n+                double thisWeek = 0.00;\n \n                 for (int i = maxValue; i >= 0; i--) {\n                     int weekNumber = days.periodes.get(i).dateDebut.get(weekFields.weekOfWeekBasedYear());\n                     if (weekNumber == thisWeekNumber) {\n-                        thisWeek += days.datas.get(i);\n-                    } else if (weekNumber == thisWeekNumber - 1) {\n-                        lastWeek += days.datas.get(i);\n+                        Double value = days.datas.get(i);\n+                        thisWeek += !value.isNaN() ? value : 0;\n                     } else {\n                         break;\n                     }\n                 }\n \n                 updateKwhChannel(YESTERDAY, yesterday);\n                 updateKwhChannel(THIS_WEEK, thisWeek);\n-                updateKwhChannel(LAST_WEEK, lastWeek);\n-            }\n+            });\n+        }\n+    }\n+\n+    /**\n+     * Request new weekly data and updates channels\n+     */\n+    private synchronized void updateWeeklyData() {\n+        if (isLinked(LAST_WEEK)) {\n+            cachedDailyData.getValue().ifPresent(values -> {\n+                Aggregate weeks = values.aggregats.weeks;\n+                updateKwhChannel(LAST_WEEK, weeks.datas.get(1));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7d73d2a22b53f514af0711ab46d167f4d033534"}, "originalPosition": 153}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01b0c19f7d2bd5cacf7e6c34d8d50ab2bbf322fd", "author": {"user": {"login": "clinique", "name": "Ga\u00ebl L'hopital"}}, "url": "https://github.com/openhab/openhab-addons/commit/01b0c19f7d2bd5cacf7e6c34d8d50ab2bbf322fd", "committedDate": "2020-11-04T10:21:54Z", "message": "Adressing potential NPR.\n\nSigned-off-by: clinique <gael@lhopital.org>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzOTYxNjE2", "url": "https://github.com/openhab/openhab-addons/pull/8871#pullrequestreview-523961616", "createdAt": "2020-11-05T06:41:21Z", "commit": {"oid": "e0aaa22aa6c771aaca0c27020eddfd93f806b79e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NTM2NDg1", "url": "https://github.com/openhab/openhab-addons/pull/8871#pullrequestreview-526536485", "createdAt": "2020-11-09T18:29:57Z", "commit": {"oid": "e0aaa22aa6c771aaca0c27020eddfd93f806b79e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxODoyOTo1N1rOHv79zg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxODoyOTo1N1rOHv79zg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAyNzU5OA==", "bodyText": "I assume this is supposed to be:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                updateKwhChannel(LAST_YEAR, Double.NaN);\n          \n          \n            \n                                updateKwhChannel(THIS_YEAR, Double.NaN);", "url": "https://github.com/openhab/openhab-addons/pull/8871#discussion_r520027598", "createdAt": "2020-11-09T18:29:57Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.linky/src/main/java/org/openhab/binding/linky/internal/handler/LinkyHandler.java", "diffHunk": "@@ -237,26 +246,28 @@ private synchronized void updateMonthlyData() {\n      */\n     private synchronized void updateYearlyData() {\n         if (isLinked(LAST_YEAR) || isLinked(THIS_YEAR)) {\n-            Consumption result = cachedYearlyData.getValue();\n-            if (result != null) {\n-                Aggregate years = result.aggregats.years;\n+            cachedYearlyData.getValue().ifPresent(values -> {\n+                Aggregate years = values.aggregats.years;\n                 updateKwhChannel(LAST_YEAR, years.datas.get(0));\n-                updateKwhChannel(THIS_YEAR, years.datas.get(1));\n-            }\n+                if (years.datas.size() > 1) {\n+                    updateKwhChannel(THIS_YEAR, years.datas.get(1));\n+                } else {\n+                    updateKwhChannel(LAST_YEAR, Double.NaN);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0aaa22aa6c771aaca0c27020eddfd93f806b79e"}, "originalPosition": 200}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bae7f5000bdc3cb31aff1abb28d3b1a484d58b01", "author": {"user": {"login": "clinique", "name": "Ga\u00ebl L'hopital"}}, "url": "https://github.com/openhab/openhab-addons/commit/bae7f5000bdc3cb31aff1abb28d3b1a484d58b01", "committedDate": "2020-11-09T18:42:16Z", "message": "Code review findings correction\n\nSigned-off-by: clinique <gael@lhopital.org>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e0aaa22aa6c771aaca0c27020eddfd93f806b79e", "author": {"user": {"login": "clinique", "name": "Ga\u00ebl L'hopital"}}, "url": "https://github.com/openhab/openhab-addons/commit/e0aaa22aa6c771aaca0c27020eddfd93f806b79e", "committedDate": "2020-11-04T11:59:40Z", "message": "Merge branch 'main' into Linky_enhabcements"}, "afterCommit": {"oid": "bae7f5000bdc3cb31aff1abb28d3b1a484d58b01", "author": {"user": {"login": "clinique", "name": "Ga\u00ebl L'hopital"}}, "url": "https://github.com/openhab/openhab-addons/commit/bae7f5000bdc3cb31aff1abb28d3b1a484d58b01", "committedDate": "2020-11-09T18:42:16Z", "message": "Code review findings correction\n\nSigned-off-by: clinique <gael@lhopital.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b13496318c9fddaca74e68ca17f42cdc937eb37", "author": {"user": {"login": "clinique", "name": "Ga\u00ebl L'hopital"}}, "url": "https://github.com/openhab/openhab-addons/commit/9b13496318c9fddaca74e68ca17f42cdc937eb37", "committedDate": "2020-11-10T09:12:43Z", "message": "Pleasing SAT checks\n\nSigned-off-by: clinique <gael@lhopital.org>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "02b3e1eb617980d5b9af40c90bda977b4ab3d8f1", "author": {"user": {"login": "clinique", "name": "Ga\u00ebl L'hopital"}}, "url": "https://github.com/openhab/openhab-addons/commit/02b3e1eb617980d5b9af40c90bda977b4ab3d8f1", "committedDate": "2020-11-09T18:49:09Z", "message": "Merge branch 'main' into Linky_enhabcements"}, "afterCommit": {"oid": "9b13496318c9fddaca74e68ca17f42cdc937eb37", "author": {"user": {"login": "clinique", "name": "Ga\u00ebl L'hopital"}}, "url": "https://github.com/openhab/openhab-addons/commit/9b13496318c9fddaca74e68ca17f42cdc937eb37", "committedDate": "2020-11-10T09:12:43Z", "message": "Pleasing SAT checks\n\nSigned-off-by: clinique <gael@lhopital.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "342a222a8c98b2280925dfa57347028d9264b30a", "author": {"user": {"login": "clinique", "name": "Ga\u00ebl L'hopital"}}, "url": "https://github.com/openhab/openhab-addons/commit/342a222a8c98b2280925dfa57347028d9264b30a", "committedDate": "2020-11-10T09:14:39Z", "message": "Merge branch 'main' into Linky_enhabcements"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3NDE5NzQw", "url": "https://github.com/openhab/openhab-addons/pull/8871#pullrequestreview-527419740", "createdAt": "2020-11-10T17:06:34Z", "commit": {"oid": "342a222a8c98b2280925dfa57347028d9264b30a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4411, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}