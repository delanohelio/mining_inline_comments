{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM5OTE0MTcx", "number": 9385, "title": "[atlona] Add support for the AT-PRO3HD66M", "bodyText": "Added support for the older (non-UHD) model AT-PRO3HD66M matrix. This device required a slightly different login protocol and selective bypassing of some of the status inquires. This was necessary because sending large amounts of commands to the device that it did not understand would cause it to lock up.\n@tmrobert8", "createdAt": "2020-12-15T01:37:25Z", "url": "https://github.com/openhab/openhab-addons/pull/9385", "merged": true, "mergeCommit": {"oid": "ce69f22ef37fa3f7778bae4cc6619dc5ee8cb85d"}, "closed": true, "closedAt": "2020-12-25T13:36:58Z", "author": {"login": "mlobstein"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmP7KIgH2gAyNTM5OTE0MTcxOmQxYmQwYzQ3YWIyZThmYzJiYWY2MjAxMTNmYzIwMjQzNjBmY2IxN2Y=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdpocbXgFqTU1ODgxNjI3OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d1bd0c47ab2e8fc2baf620113fc2024360fcb17f", "author": {"user": {"login": "mlobstein", "name": null}}, "url": "https://github.com/openhab/openhab-addons/commit/d1bd0c47ab2e8fc2baf620113fc2024360fcb17f", "committedDate": "2020-12-15T01:19:33Z", "message": "Add support for the AT-PRO3HD66M\n\nSigned-off-by: Michael Lobstein <michael.lobstein@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4NTAwNjQ1", "url": "https://github.com/openhab/openhab-addons/pull/9385#pullrequestreview-558500645", "createdAt": "2020-12-24T13:10:57Z", "commit": {"oid": "d1bd0c47ab2e8fc2baf620113fc2024360fcb17f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNFQxMzoxMDo1N1rOILHZeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNFQxMzoyMDoxN1rOILHiXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODUyNjQ1Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private static final Set<ThingTypeUID> SUPPORTED_THING_TYPES_UIDS = Collections\n          \n          \n            \n                        .unmodifiableSet(Stream.of(THING_TYPE_PRO3_44M, THING_TYPE_PRO3_66M, THING_TYPE_PRO3_88M,\n          \n          \n            \n                                THING_TYPE_PRO3_1616M, THING_TYPE_PRO3HD_66M).collect(Collectors.toSet()));\n          \n          \n            \n                private static final Set<ThingTypeUID> SUPPORTED_THING_TYPES_UIDS = Set.of(THING_TYPE_PRO3_44M, THING_TYPE_PRO3_66M, THING_TYPE_PRO3_88M,THING_TYPE_PRO3_1616M, THING_TYPE_PRO3HD_66M);", "url": "https://github.com/openhab/openhab-addons/pull/9385#discussion_r548526456", "createdAt": "2020-12-24T13:10:57Z", "author": {"login": "J-N-K"}, "path": "bundles/org.openhab.binding.atlona/src/main/java/org/openhab/binding/atlona/internal/AtlonaHandlerFactory.java", "diffHunk": "@@ -44,9 +45,9 @@\n     /**\n      * The set of supported Atlona products\n      */\n-    private static final Set<ThingTypeUID> SUPPORTED_THING_TYPES_UIDS = Collections.unmodifiableSet(\n-            Stream.of(THING_TYPE_PRO3_44M, THING_TYPE_PRO3_66M, THING_TYPE_PRO3_88M, THING_TYPE_PRO3_1616M)\n-                    .collect(Collectors.toSet()));\n+    private static final Set<ThingTypeUID> SUPPORTED_THING_TYPES_UIDS = Collections\n+            .unmodifiableSet(Stream.of(THING_TYPE_PRO3_44M, THING_TYPE_PRO3_66M, THING_TYPE_PRO3_88M,\n+                    THING_TYPE_PRO3_1616M, THING_TYPE_PRO3HD_66M).collect(Collectors.toSet()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1bd0c47ab2e8fc2baf620113fc2024360fcb17f"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODUyNjYzNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                Collections.unmodifiableSet(Stream.of(6, 8).collect(Collectors.toSet())), true));\n          \n          \n            \n                              Set.of(6, 8), true));\n          \n      \n    \n    \n  \n\nalso below", "url": "https://github.com/openhab/openhab-addons/pull/9385#discussion_r548526636", "createdAt": "2020-12-24T13:11:52Z", "author": {"login": "J-N-K"}, "path": "bundles/org.openhab.binding.atlona/src/main/java/org/openhab/binding/atlona/internal/AtlonaHandlerFactory.java", "diffHunk": "@@ -65,30 +66,30 @@ public boolean supportsThingType(ThingTypeUID thingTypeUID) {\n      */\n     @Override\n     protected ThingHandler createHandler(Thing thing) {\n-        if (thing == null) {\n-            logger.error(\"createHandler was given a null thing!\");\n-            return null;\n-        }\n-\n         ThingTypeUID thingTypeUID = thing.getThingTypeUID();\n \n         if (thingTypeUID.equals(THING_TYPE_PRO3_44M)) {\n-            return new AtlonaPro3Handler(thing, new AtlonaPro3Capabilities(5, 3, Collections.singleton(5)));\n+            return new AtlonaPro3Handler(thing, new AtlonaPro3Capabilities(5, 3, Collections.singleton(5), true));\n         }\n \n         if (thingTypeUID.equals(THING_TYPE_PRO3_66M)) {\n             return new AtlonaPro3Handler(thing, new AtlonaPro3Capabilities(8, 4,\n-                    Collections.unmodifiableSet(Stream.of(6, 8).collect(Collectors.toSet()))));\n+                    Collections.unmodifiableSet(Stream.of(6, 8).collect(Collectors.toSet())), true));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1bd0c47ab2e8fc2baf620113fc2024360fcb17f"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODUyNzczNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                String loginUHD() throws Exception {\n          \n          \n            \n                String loginUHD() throws IOException {", "url": "https://github.com/openhab/openhab-addons/pull/9385#discussion_r548527736", "createdAt": "2020-12-24T13:16:10Z", "author": {"login": "J-N-K"}, "path": "bundles/org.openhab.binding.atlona/src/main/java/org/openhab/binding/atlona/internal/pro3/AtlonaPro3PortocolHandler.java", "diffHunk": "@@ -178,7 +187,7 @@\n      * @return a null if logged in successfully (or if switch didn't require login). Non-null if an exception occurred.\n      * @throws IOException an IO exception occurred during login\n      */\n-    String login() throws Exception {\n+    String loginUHD() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1bd0c47ab2e8fc2baf620113fc2024360fcb17f"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODUyNzgwNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                String loginHD() throws Exception {\n          \n          \n            \n                String loginHD() throws IOException {", "url": "https://github.com/openhab/openhab-addons/pull/9385#discussion_r548527806", "createdAt": "2020-12-24T13:16:25Z", "author": {"login": "J-N-K"}, "path": "bundles/org.openhab.binding.atlona/src/main/java/org/openhab/binding/atlona/internal/pro3/AtlonaPro3PortocolHandler.java", "diffHunk": "@@ -280,6 +289,94 @@ String login() throws Exception {\n         return \"Password was invalid - please check your atlona setup\";\n     }\n \n+    /**\n+     * Attempts to log into the older HD model switches using a slightly different protocol\n+     *\n+     * @return a null if logged in successfully (or if switch didn't require login). Non-null if an exception occurred.\n+     * @throws IOException an IO exception occurred during login\n+     */\n+    String loginHD() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1bd0c47ab2e8fc2baf620113fc2024360fcb17f"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODUyODA5MQ==", "bodyText": "Please do not catch Exception. I assume IOException is enough. Catching Exception also catches NPE and hides programming errors.", "url": "https://github.com/openhab/openhab-addons/pull/9385#discussion_r548528091", "createdAt": "2020-12-24T13:17:35Z", "author": {"login": "J-N-K"}, "path": "bundles/org.openhab.binding.atlona/src/main/java/org/openhab/binding/atlona/internal/pro3/AtlonaPro3PortocolHandler.java", "diffHunk": "@@ -192,7 +201,7 @@ String login() throws Exception {\n         try {\n             response = callback.getResponse();\n             if (!response.equals(\"\")) {\n-                logger.info(\"Altona protocol violation - didn't start with an inital empty response: '{}'\", response);\n+                logger.debug(\"Altona protocol violation - didn't start with an inital empty response: '{}'\", response);\n             }\n         } catch (Exception e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1bd0c47ab2e8fc2baf620113fc2024360fcb17f"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODUyODExNA==", "bodyText": "see above", "url": "https://github.com/openhab/openhab-addons/pull/9385#discussion_r548528114", "createdAt": "2020-12-24T13:17:44Z", "author": {"login": "J-N-K"}, "path": "bundles/org.openhab.binding.atlona/src/main/java/org/openhab/binding/atlona/internal/pro3/AtlonaPro3PortocolHandler.java", "diffHunk": "@@ -280,6 +289,94 @@ String login() throws Exception {\n         return \"Password was invalid - please check your atlona setup\";\n     }\n \n+    /**\n+     * Attempts to log into the older HD model switches using a slightly different protocol\n+     *\n+     * @return a null if logged in successfully (or if switch didn't require login). Non-null if an exception occurred.\n+     * @throws IOException an IO exception occurred during login\n+     */\n+    String loginHD() throws Exception {\n+        logger.debug(\"Logging into atlona switch\");\n+        // Void to make sure we retrieve them\n+        modelType = null;\n+        version = null;\n+\n+        NoDispatchingCallback callback = new NoDispatchingCallback();\n+        session.addListener(callback);\n+\n+        // Burn the initial (empty) return\n+        String response;\n+        try {\n+            response = callback.getResponse();\n+            if (!response.equals(\"\")) {\n+                logger.debug(\"Altona protocol violation - didn't start with an inital empty response: '{}'\", response);\n+            }\n+        } catch (Exception e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1bd0c47ab2e8fc2baf620113fc2024360fcb17f"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODUyODczNQ==", "bodyText": "This whole method looks very much the same as loginHD. Do you think it is possible to have a common login(boolean isUHD) whis is called from loginHD and loginUHD and takes care of the differences?", "url": "https://github.com/openhab/openhab-addons/pull/9385#discussion_r548528735", "createdAt": "2020-12-24T13:20:17Z", "author": {"login": "J-N-K"}, "path": "bundles/org.openhab.binding.atlona/src/main/java/org/openhab/binding/atlona/internal/pro3/AtlonaPro3PortocolHandler.java", "diffHunk": "@@ -280,6 +289,94 @@ String login() throws Exception {\n         return \"Password was invalid - please check your atlona setup\";\n     }\n \n+    /**\n+     * Attempts to log into the older HD model switches using a slightly different protocol\n+     *\n+     * @return a null if logged in successfully (or if switch didn't require login). Non-null if an exception occurred.\n+     * @throws IOException an IO exception occurred during login\n+     */\n+    String loginHD() throws Exception {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODUyNzgwNg=="}, "originalCommit": {"oid": "d1bd0c47ab2e8fc2baf620113fc2024360fcb17f"}, "originalPosition": 73}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce62c33e2a171977fc187156b675157b6d58ca90", "author": {"user": {"login": "mlobstein", "name": null}}, "url": "https://github.com/openhab/openhab-addons/commit/ce62c33e2a171977fc187156b675157b6d58ca90", "committedDate": "2020-12-24T15:30:29Z", "message": "review changes\n\nSigned-off-by: Michael Lobstein <michael.lobstein@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4ODE2Mjc5", "url": "https://github.com/openhab/openhab-addons/pull/9385#pullrequestreview-558816279", "createdAt": "2020-12-25T13:27:07Z", "commit": {"oid": "ce62c33e2a171977fc187156b675157b6d58ca90"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNVQxMzozNDo1NFrOILckug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNVQxMzozNTowNVrOILckzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODg3MzQwMg==", "bodyText": "I just looked at the rest of the code. This should never have been merged. Removing the Exception here will require some bigger refactoring, which is clearly out of scope here. Leave it as is.", "url": "https://github.com/openhab/openhab-addons/pull/9385#discussion_r548873402", "createdAt": "2020-12-25T13:34:54Z", "author": {"login": "J-N-K"}, "path": "bundles/org.openhab.binding.atlona/src/main/java/org/openhab/binding/atlona/internal/pro3/AtlonaPro3PortocolHandler.java", "diffHunk": "@@ -192,7 +201,7 @@ String login() throws Exception {\n         try {\n             response = callback.getResponse();\n             if (!response.equals(\"\")) {\n-                logger.info(\"Altona protocol violation - didn't start with an inital empty response: '{}'\", response);\n+                logger.debug(\"Altona protocol violation - didn't start with an inital empty response: '{}'\", response);\n             }\n         } catch (Exception e) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODUyODA5MQ=="}, "originalCommit": {"oid": "d1bd0c47ab2e8fc2baf620113fc2024360fcb17f"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODg3MzQyMw==", "bodyText": "ok", "url": "https://github.com/openhab/openhab-addons/pull/9385#discussion_r548873423", "createdAt": "2020-12-25T13:35:05Z", "author": {"login": "J-N-K"}, "path": "bundles/org.openhab.binding.atlona/src/main/java/org/openhab/binding/atlona/internal/pro3/AtlonaPro3PortocolHandler.java", "diffHunk": "@@ -280,6 +289,94 @@ String login() throws Exception {\n         return \"Password was invalid - please check your atlona setup\";\n     }\n \n+    /**\n+     * Attempts to log into the older HD model switches using a slightly different protocol\n+     *\n+     * @return a null if logged in successfully (or if switch didn't require login). Non-null if an exception occurred.\n+     * @throws IOException an IO exception occurred during login\n+     */\n+    String loginHD() throws Exception {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODUyNzgwNg=="}, "originalCommit": {"oid": "d1bd0c47ab2e8fc2baf620113fc2024360fcb17f"}, "originalPosition": 73}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3791, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}