{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI5MTY4MzYx", "number": 9176, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQwMDo0ODowOFrOE-5xWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQyMTo1NjozMVrOFA_w2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0MzkzNjg5OnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/discovery/MiIoDiscovery.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQwMDo0ODowOFrOH8TtSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQwMDo0ODowOFrOH8TtSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk5OTQ5OQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                Boolean isOnline = device.getIsOnline();\n          \n          \n            \n                                boolean isOnline = device.getIsOnline();", "url": "https://github.com/openhab/openhab-addons/pull/9176#discussion_r532999499", "createdAt": "2020-12-01T00:48:08Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/discovery/MiIoDiscovery.java", "diffHunk": "@@ -133,6 +169,33 @@ private void discover() {\n         }\n     }\n \n+    private void cloudDiscovery() {\n+        String cloudDiscoveryMode = getCloudDiscoveryMode();\n+        if (cloudConnector.isConnected()) {\n+            List<CloudDeviceDTO> dv = cloudConnector.getDevicesList();\n+            for (CloudDeviceDTO device : dv) {\n+                String id = String.format(\"%08X\", Long.parseUnsignedLong(device.getDid()));\n+                if (cloudDiscoveryMode.contentEquals(SUPPORTED)) {\n+                    if (MiIoDevices.getType(device.getModel()).getThingType().equals(THING_TYPE_UNSUPPORTED)) {\n+                        logger.warn(\"Discovered from cloud, but ignored because not supported: {} {}\", id, device);\n+                    }\n+                }\n+                if (device.getIsOnline()) {\n+                    logger.debug(\"Discovered from cloud: {} {}\", id, device);\n+                    cloudDevices.put(id, device.getLocalip());\n+                    String token = device.getToken();\n+                    String label = device.getName() + \" \" + id + \" (\" + device.getDid() + \")\";\n+                    String country = device.getServer();\n+                    Boolean isOnline = device.getIsOnline();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11261a27cf8a3b676009a122d5e0a05f5d2d4252"}, "originalPosition": 117}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0MzkzODI0OnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/discovery/MiIoDiscovery.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQwMDo0ODo0M1rOH8TuEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQwMDo0ODo0M1rOH8TuEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk5OTY5Nw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Nullable\n          \n          \n            \n                private Configuration miioConfig;\n          \n          \n            \n                private @Nullable Configuration miioConfig;", "url": "https://github.com/openhab/openhab-addons/pull/9176#discussion_r532999697", "createdAt": "2020-12-01T00:48:43Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/discovery/MiIoDiscovery.java", "diffHunk": "@@ -66,11 +76,33 @@\n \n     private final Logger logger = LoggerFactory.getLogger(MiIoDiscovery.class);\n     private final CloudConnector cloudConnector;\n+    private Map<String, String> cloudDevices = new HashMap<>();\n+    @Nullable\n+    private Configuration miioConfig;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11261a27cf8a3b676009a122d5e0a05f5d2d4252"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0Mzk0ODkzOnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/discovery/MiIoDiscovery.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQwMDo1MzowN1rOH8Tz8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQyMjo1NDozMFrOH9DJyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAwMTIwMw==", "bodyText": "Is there a reason you did contains instead of equals? If not then you can simplify the code.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (cloudDevices.containsKey(id)) {\n          \n          \n            \n                        if (cloudDevices.get(id).contains(ip)) {\n          \n          \n            \n                            logger.debug(\"Skipped adding local found {}. Already discovered by cloud.\", label);\n          \n          \n            \n                            return;\n          \n          \n            \n                        }\n          \n          \n            \n                    }\n          \n          \n            \n                    if(ip.equals(cloudDevices.get(id)){\n          \n          \n            \n                        logger.debug(\"Skipped adding local found {}. Already discovered by cloud.\", label);\n          \n          \n            \n                        return;\n          \n          \n            \n                    }", "url": "https://github.com/openhab/openhab-addons/pull/9176#discussion_r533001203", "createdAt": "2020-12-01T00:53:07Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/discovery/MiIoDiscovery.java", "diffHunk": "@@ -141,6 +204,12 @@ private void discovered(String ip, byte[] response) {\n         String label = \"Xiaomi Mi Device \" + id + \" (\" + Long.parseUnsignedLong(id, 16) + \")\";\n         String country = \"\";\n         boolean isOnline = false;\n+        if (cloudDevices.containsKey(id)) {\n+            if (cloudDevices.get(id).contains(ip)) {\n+                logger.debug(\"Skipped adding local found {}. Already discovered by cloud.\", label);\n+                return;\n+            }\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11261a27cf8a3b676009a122d5e0a05f5d2d4252"}, "originalPosition": 139}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzc3Njg0MA==", "bodyText": "Yours is better indeed. The contains was only to avoid the NPE", "url": "https://github.com/openhab/openhab-addons/pull/9176#discussion_r533776840", "createdAt": "2020-12-01T22:54:30Z", "author": {"login": "marcelrv"}, "path": "bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/discovery/MiIoDiscovery.java", "diffHunk": "@@ -141,6 +204,12 @@ private void discovered(String ip, byte[] response) {\n         String label = \"Xiaomi Mi Device \" + id + \" (\" + Long.parseUnsignedLong(id, 16) + \")\";\n         String country = \"\";\n         boolean isOnline = false;\n+        if (cloudDevices.containsKey(id)) {\n+            if (cloudDevices.get(id).contains(ip)) {\n+                logger.debug(\"Skipped adding local found {}. Already discovered by cloud.\", label);\n+                return;\n+            }\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAwMTIwMw=="}, "originalCommit": {"oid": "11261a27cf8a3b676009a122d5e0a05f5d2d4252"}, "originalPosition": 139}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0Mzk1MTMwOnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/discovery/MiIoDiscovery.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQwMDo1NDoxM1rOH8T1Xg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQwMDo1NDoxM1rOH8T1Xg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAwMTU2Ng==", "bodyText": "If there is change this would be modified by multiple threads the you should use ConcurrentHashMap instead.", "url": "https://github.com/openhab/openhab-addons/pull/9176#discussion_r533001566", "createdAt": "2020-12-01T00:54:13Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/discovery/MiIoDiscovery.java", "diffHunk": "@@ -66,11 +76,33 @@\n \n     private final Logger logger = LoggerFactory.getLogger(MiIoDiscovery.class);\n     private final CloudConnector cloudConnector;\n+    private Map<String, String> cloudDevices = new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11261a27cf8a3b676009a122d5e0a05f5d2d4252"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1OTk4NTQ2OnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/discovery/MiIoDiscovery.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxOTo0MjoxN1rOH-uY4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwODoyOTozMVrOH_GAYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTUzMzc5Mw==", "bodyText": "Please do proper null checks instead of just catching the NullPointerException.", "url": "https://github.com/openhab/openhab-addons/pull/9176#discussion_r535533793", "createdAt": "2020-12-03T19:42:17Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/discovery/MiIoDiscovery.java", "diffHunk": "@@ -66,11 +76,32 @@\n \n     private final Logger logger = LoggerFactory.getLogger(MiIoDiscovery.class);\n     private final CloudConnector cloudConnector;\n+    private Map<String, String> cloudDevices = new ConcurrentHashMap<>();\n+    private @Nullable Configuration miioConfig;\n \n     @Activate\n-    public MiIoDiscovery(@Reference CloudConnector cloudConnector) throws IllegalArgumentException {\n+    public MiIoDiscovery(@Reference CloudConnector cloudConnector, @Reference ConfigurationAdmin configAdmin)\n+            throws IllegalArgumentException {\n         super(DISCOVERY_TIME);\n         this.cloudConnector = cloudConnector;\n+        try {\n+            miioConfig = configAdmin.getConfiguration(\"binding.miio\");\n+        } catch (IOException | SecurityException e) {\n+            logger.debug(\"Error getting configuration: {}\", e.getMessage());\n+        }\n+    }\n+\n+    private String getCloudDiscoveryMode() {\n+        if (miioConfig != null) {\n+            try {\n+                Dictionary<String, Object> properties = miioConfig.getProperties();\n+                String cloudDiscoveryModeConfig = ((String) properties.get(\"cloudDiscoveryMode\")).toLowerCase();\n+                return Set.of(SUPPORTED, ALL).contains(cloudDiscoveryModeConfig) ? cloudDiscoveryModeConfig : DISABLED;\n+            } catch (NullPointerException | ClassCastException | SecurityException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59bca6dd7c8bba4d62f8ba3f0354172a38aaea47"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTkyMDczOQ==", "bodyText": "yes, did that... I did it in the former way to avoid one more dead code warning.\nSomehow it assumes that the result of a Map.get is a notnull and complains about the null check.\nI don't know how to tell it that it can be a Null", "url": "https://github.com/openhab/openhab-addons/pull/9176#discussion_r535920739", "createdAt": "2020-12-04T08:29:31Z", "author": {"login": "marcelrv"}, "path": "bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/discovery/MiIoDiscovery.java", "diffHunk": "@@ -66,11 +76,32 @@\n \n     private final Logger logger = LoggerFactory.getLogger(MiIoDiscovery.class);\n     private final CloudConnector cloudConnector;\n+    private Map<String, String> cloudDevices = new ConcurrentHashMap<>();\n+    private @Nullable Configuration miioConfig;\n \n     @Activate\n-    public MiIoDiscovery(@Reference CloudConnector cloudConnector) throws IllegalArgumentException {\n+    public MiIoDiscovery(@Reference CloudConnector cloudConnector, @Reference ConfigurationAdmin configAdmin)\n+            throws IllegalArgumentException {\n         super(DISCOVERY_TIME);\n         this.cloudConnector = cloudConnector;\n+        try {\n+            miioConfig = configAdmin.getConfiguration(\"binding.miio\");\n+        } catch (IOException | SecurityException e) {\n+            logger.debug(\"Error getting configuration: {}\", e.getMessage());\n+        }\n+    }\n+\n+    private String getCloudDiscoveryMode() {\n+        if (miioConfig != null) {\n+            try {\n+                Dictionary<String, Object> properties = miioConfig.getProperties();\n+                String cloudDiscoveryModeConfig = ((String) properties.get(\"cloudDiscoveryMode\")).toLowerCase();\n+                return Set.of(SUPPORTED, ALL).contains(cloudDiscoveryModeConfig) ? cloudDiscoveryModeConfig : DISABLED;\n+            } catch (NullPointerException | ClassCastException | SecurityException e) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTUzMzc5Mw=="}, "originalCommit": {"oid": "59bca6dd7c8bba4d62f8ba3f0354172a38aaea47"}, "originalPosition": 65}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM2NTg5MDE2OnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/discovery/MiIoDiscovery.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQyMTo1NjozMVrOH_jr3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQyMzoxMToxOVrOH_lkLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQwNzAwNw==", "bodyText": "Is it guaranteed that id is an integer at this point? You make no attempt to catch the NumberFormatException that this would throw. If you know that it is an integer why not have the id passed as a long parameter instead?", "url": "https://github.com/openhab/openhab-addons/pull/9176#discussion_r536407007", "createdAt": "2020-12-04T21:56:31Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/discovery/MiIoDiscovery.java", "diffHunk": "@@ -152,17 +224,22 @@ private void discovered(String ip, byte[] response) {\n                 isOnline = cloudInfo.getIsOnline();\n             }\n         }\n+        submitDiscovery(ip, token, id, label, country, isOnline);\n+    }\n+\n+    private void submitDiscovery(String ip, String token, String id, String label, String country, boolean isOnline) {\n         ThingUID uid = new ThingUID(THING_TYPE_MIIO, id);\n-        logger.debug(\"Discovered Mi Device {} ({}) at {} as {}\", id, Long.parseUnsignedLong(id, 16), ip, uid);\n         DiscoveryResultBuilder dr = DiscoveryResultBuilder.create(uid).withProperty(PROPERTY_HOST_IP, ip)\n                 .withProperty(PROPERTY_DID, id);\n         if (IGNORED_TOKENS.contains(token)) {\n+            logger.debug(\"Discovered Mi Device {} ({}) at {} as {}\", id, Long.parseUnsignedLong(id, 16), ip, uid);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19e741473c527ebc828ce5b90ee91c06dbdac73c"}, "originalPosition": 159}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQzNzI5Mg==", "bodyText": "it is a HEX string in this setting..\nBut I can indeed surround it with a try/catch NumberFormatException", "url": "https://github.com/openhab/openhab-addons/pull/9176#discussion_r536437292", "createdAt": "2020-12-04T23:09:46Z", "author": {"login": "marcelrv"}, "path": "bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/discovery/MiIoDiscovery.java", "diffHunk": "@@ -152,17 +224,22 @@ private void discovered(String ip, byte[] response) {\n                 isOnline = cloudInfo.getIsOnline();\n             }\n         }\n+        submitDiscovery(ip, token, id, label, country, isOnline);\n+    }\n+\n+    private void submitDiscovery(String ip, String token, String id, String label, String country, boolean isOnline) {\n         ThingUID uid = new ThingUID(THING_TYPE_MIIO, id);\n-        logger.debug(\"Discovered Mi Device {} ({}) at {} as {}\", id, Long.parseUnsignedLong(id, 16), ip, uid);\n         DiscoveryResultBuilder dr = DiscoveryResultBuilder.create(uid).withProperty(PROPERTY_HOST_IP, ip)\n                 .withProperty(PROPERTY_DID, id);\n         if (IGNORED_TOKENS.contains(token)) {\n+            logger.debug(\"Discovered Mi Device {} ({}) at {} as {}\", id, Long.parseUnsignedLong(id, 16), ip, uid);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQwNzAwNw=="}, "originalCommit": {"oid": "19e741473c527ebc828ce5b90ee91c06dbdac73c"}, "originalPosition": 159}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQzNzgwNQ==", "bodyText": "This is how it looks like", "url": "https://github.com/openhab/openhab-addons/pull/9176#discussion_r536437805", "createdAt": "2020-12-04T23:11:19Z", "author": {"login": "marcelrv"}, "path": "bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/discovery/MiIoDiscovery.java", "diffHunk": "@@ -152,17 +224,22 @@ private void discovered(String ip, byte[] response) {\n                 isOnline = cloudInfo.getIsOnline();\n             }\n         }\n+        submitDiscovery(ip, token, id, label, country, isOnline);\n+    }\n+\n+    private void submitDiscovery(String ip, String token, String id, String label, String country, boolean isOnline) {\n         ThingUID uid = new ThingUID(THING_TYPE_MIIO, id);\n-        logger.debug(\"Discovered Mi Device {} ({}) at {} as {}\", id, Long.parseUnsignedLong(id, 16), ip, uid);\n         DiscoveryResultBuilder dr = DiscoveryResultBuilder.create(uid).withProperty(PROPERTY_HOST_IP, ip)\n                 .withProperty(PROPERTY_DID, id);\n         if (IGNORED_TOKENS.contains(token)) {\n+            logger.debug(\"Discovered Mi Device {} ({}) at {} as {}\", id, Long.parseUnsignedLong(id, 16), ip, uid);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQwNzAwNw=="}, "originalCommit": {"oid": "19e741473c527ebc828ce5b90ee91c06dbdac73c"}, "originalPosition": 159}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3753, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}