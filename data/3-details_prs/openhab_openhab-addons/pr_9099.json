{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI1MjUzNjMw", "number": 9099, "title": "[somfytahoma] code cleanup", "bodyText": "This PR brings code simplification and clean up for the Somfy Tahoma binding", "createdAt": "2020-11-22T09:07:28Z", "url": "https://github.com/openhab/openhab-addons/pull/9099", "merged": true, "mergeCommit": {"oid": "d13e41ddb12dc14934778f25c05579e5a463b645"}, "closed": true, "closedAt": "2020-11-23T21:05:12Z", "author": {"login": "octa22"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABde8vykAH2gAyNTI1MjUzNjMwOjU1ZjBlNGQ2YjU0ZTJhNzQ4NDdjMDI0ZTA4OWQ5NTlhNjcyZDk1NzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdfZo1bgFqTUzNjc0OTE0NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "55f0e4d6b54e2a74847c024e089d959a672d9570", "author": {"user": {"login": "octa22", "name": "Ondrej Pecta"}}, "url": "https://github.com/openhab/openhab-addons/commit/55f0e4d6b54e2a74847c024e089d959a672d9570", "committedDate": "2020-11-22T09:01:28Z", "message": "[somfytahoma] code cleanup\n\nSigned-off-by: Ondrej Pecta <opecta@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2MzEyNzc5", "url": "https://github.com/openhab/openhab-addons/pull/9099#pullrequestreview-536312779", "createdAt": "2020-11-23T09:52:48Z", "commit": {"oid": "55f0e4d6b54e2a74847c024e089d959a672d9570"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QwOTo1Mjo0OVrOH4GAmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxMDowMDoxMFrOH4GTZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODU4MDc2Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return response != null ? new ArrayList<>(Arrays.asList(response)) : new ArrayList<>();\n          \n          \n            \n                    return response != null ? Arrays.asList(response)  : List.of();\n          \n      \n    \n    \n  \n\nor is it necessary to alter the array afterwards?\n(Also applies below).", "url": "https://github.com/openhab/openhab-addons/pull/9099#discussion_r528580762", "createdAt": "2020-11-23T09:52:49Z", "author": {"login": "J-N-K"}, "path": "bundles/org.openhab.binding.somfytahoma/src/main/java/org/openhab/binding/somfytahoma/internal/handler/SomfyTahomaBridgeHandler.java", "diffHunk": "@@ -234,71 +231,27 @@ private void setTooManyRequests() {\n     }\n \n     private @Nullable String registerEvents() {\n-        String url;\n+        SomfyTahomaRegisterEventsResponse response = invokeCallToURL(TAHOMA_EVENTS_URL + \"register\", \"\",\n+                HttpMethod.POST, SomfyTahomaRegisterEventsResponse.class);\n+        return response != null ? response.getId() : null;\n+    }\n \n+    private String urlEncode(String text) {\n         try {\n-            url = TAHOMA_EVENTS_URL + \"register\";\n-\n-            String line = sendPostToTahomaWithCookie(url, \"\");\n-            SomfyTahomaRegisterEventsResponse response = gson.fromJson(line, SomfyTahomaRegisterEventsResponse.class);\n-            return response.getId();\n-        } catch (JsonSyntaxException e) {\n-            logger.debug(\"Received invalid data\", e);\n-            return null;\n-        } catch (ExecutionException e) {\n-            if (isAuthenticationChallenge(e)) {\n-                reLogin();\n-                return UNAUTHORIZED;\n-            } else {\n-                logger.info(\"Cannot register events!\", e);\n-                updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR);\n-            }\n-        } catch (InterruptedException | TimeoutException e) {\n-            logger.info(\"Cannot register events!\", e);\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR);\n-            if (e instanceof InterruptedException) {\n-                Thread.currentThread().interrupt();\n-            }\n+            return URLEncoder.encode(text, StandardCharsets.UTF_8.toString());\n+        } catch (UnsupportedEncodingException e) {\n+            return text;\n         }\n-        return null;\n-    }\n-\n-    private String urlEncode(String text) throws UnsupportedEncodingException {\n-        return URLEncoder.encode(text, StandardCharsets.UTF_8.toString());\n     }\n \n     private void enableLogin() {\n         tooManyRequests = false;\n     }\n \n     private List<SomfyTahomaEvent> getEvents() {\n-        String url;\n-        String line = \"\";\n-\n-        try {\n-            url = TAHOMA_API_URL + \"events/\" + eventsId + \"/fetch\";\n-\n-            line = sendPostToTahomaWithCookie(url, \"\");\n-            SomfyTahomaEvent[] array = gson.fromJson(line, SomfyTahomaEvent[].class);\n-            return new ArrayList<>(Arrays.asList(array));\n-        } catch (JsonSyntaxException e) {\n-            logger.debug(\"Received data: {} is not JSON\", line, e);\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR, \"Received invalid data\");\n-        } catch (ExecutionException e) {\n-            if (isAuthenticationChallenge(e)) {\n-                reLogin();\n-            } else {\n-                logger.debug(\"Cannot get Tahoma events!\", e);\n-                updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR);\n-            }\n-        } catch (InterruptedException | TimeoutException e) {\n-            logger.debug(\"Cannot get Tahoma events!\", e);\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR);\n-            if (e instanceof InterruptedException) {\n-                Thread.currentThread().interrupt();\n-            }\n-        }\n-        return new ArrayList<>();\n+        SomfyTahomaEvent[] response = invokeCallToURL(TAHOMA_API_URL + \"events/\" + eventsId + \"/fetch\", \"\",\n+                HttpMethod.POST, SomfyTahomaEvent[].class);\n+        return response != null ? new ArrayList<>(Arrays.asList(response)) : new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55f0e4d6b54e2a74847c024e089d959a672d9570"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODU4MTE0NQ==", "bodyText": "This is a change from the behaviour before. Is that intended? Before the thing changed to OFFLINE in case of an encoding error.", "url": "https://github.com/openhab/openhab-addons/pull/9099#discussion_r528581145", "createdAt": "2020-11-23T09:53:28Z", "author": {"login": "J-N-K"}, "path": "bundles/org.openhab.binding.somfytahoma/src/main/java/org/openhab/binding/somfytahoma/internal/handler/SomfyTahomaBridgeHandler.java", "diffHunk": "@@ -234,71 +231,27 @@ private void setTooManyRequests() {\n     }\n \n     private @Nullable String registerEvents() {\n-        String url;\n+        SomfyTahomaRegisterEventsResponse response = invokeCallToURL(TAHOMA_EVENTS_URL + \"register\", \"\",\n+                HttpMethod.POST, SomfyTahomaRegisterEventsResponse.class);\n+        return response != null ? response.getId() : null;\n+    }\n \n+    private String urlEncode(String text) {\n         try {\n-            url = TAHOMA_EVENTS_URL + \"register\";\n-\n-            String line = sendPostToTahomaWithCookie(url, \"\");\n-            SomfyTahomaRegisterEventsResponse response = gson.fromJson(line, SomfyTahomaRegisterEventsResponse.class);\n-            return response.getId();\n-        } catch (JsonSyntaxException e) {\n-            logger.debug(\"Received invalid data\", e);\n-            return null;\n-        } catch (ExecutionException e) {\n-            if (isAuthenticationChallenge(e)) {\n-                reLogin();\n-                return UNAUTHORIZED;\n-            } else {\n-                logger.info(\"Cannot register events!\", e);\n-                updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR);\n-            }\n-        } catch (InterruptedException | TimeoutException e) {\n-            logger.info(\"Cannot register events!\", e);\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR);\n-            if (e instanceof InterruptedException) {\n-                Thread.currentThread().interrupt();\n-            }\n+            return URLEncoder.encode(text, StandardCharsets.UTF_8.toString());\n+        } catch (UnsupportedEncodingException e) {\n+            return text;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55f0e4d6b54e2a74847c024e089d959a672d9570"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODU4NTI2NQ==", "bodyText": "StringUtils should not be used in new code. In this case you can just use state.getName().isEmpty() since getName() is non-null.", "url": "https://github.com/openhab/openhab-addons/pull/9099#discussion_r528585265", "createdAt": "2020-11-23T09:59:45Z", "author": {"login": "J-N-K"}, "path": "bundles/org.openhab.binding.somfytahoma/src/main/java/org/openhab/binding/somfytahoma/internal/handler/SomfyTahomaBridgeHandler.java", "diffHunk": "@@ -913,28 +676,48 @@ public void handleConfigurationUpdate(Map<String, Object> configurationParameter\n     }\n \n     public synchronized void refresh(String url, String stateName) {\n+        SomfyTahomaState state = invokeCallToURL(DEVICES_URL + urlEncode(url) + \"/states/\" + stateName, \"\",\n+                HttpMethod.GET, SomfyTahomaState.class);\n+        if (state != null && StringUtils.isNotEmpty(state.getName())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55f0e4d6b54e2a74847c024e089d959a672d9570"}, "originalPosition": 422}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODU4NTU3NQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        updateDevice(url, Arrays.asList(state));\n          \n          \n            \n                        updateDevice(url, List.of(state));", "url": "https://github.com/openhab/openhab-addons/pull/9099#discussion_r528585575", "createdAt": "2020-11-23T10:00:10Z", "author": {"login": "J-N-K"}, "path": "bundles/org.openhab.binding.somfytahoma/src/main/java/org/openhab/binding/somfytahoma/internal/handler/SomfyTahomaBridgeHandler.java", "diffHunk": "@@ -913,28 +676,48 @@ public void handleConfigurationUpdate(Map<String, Object> configurationParameter\n     }\n \n     public synchronized void refresh(String url, String stateName) {\n+        SomfyTahomaState state = invokeCallToURL(DEVICES_URL + urlEncode(url) + \"/states/\" + stateName, \"\",\n+                HttpMethod.GET, SomfyTahomaState.class);\n+        if (state != null && StringUtils.isNotEmpty(state.getName())) {\n+            updateDevice(url, Arrays.asList(state));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55f0e4d6b54e2a74847c024e089d959a672d9570"}, "originalPosition": 423}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03d34f3ffdfe2d53846047abd751a7e46fd2c86f", "author": {"user": {"login": "octa22", "name": "Ondrej Pecta"}}, "url": "https://github.com/openhab/openhab-addons/commit/03d34f3ffdfe2d53846047abd751a7e46fd2c86f", "committedDate": "2020-11-23T11:14:25Z", "message": "[somfytahoma] implemented code review suggestions\n\nSigned-off-by: Ondrej Pecta <opecta@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2NDgwODI4", "url": "https://github.com/openhab/openhab-addons/pull/9099#pullrequestreview-536480828", "createdAt": "2020-11-23T13:40:59Z", "commit": {"oid": "03d34f3ffdfe2d53846047abd751a7e46fd2c86f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxMzo0MDo1OVrOH4N54A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxMzo0Mzo0NVrOH4OAyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODcxMDExMg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return response != null ? Arrays.asList(response) : Collections.emptyList();\n          \n          \n            \n                    return response != null ? List.of(response) : List.of();", "url": "https://github.com/openhab/openhab-addons/pull/9099#discussion_r528710112", "createdAt": "2020-11-23T13:40:59Z", "author": {"login": "J-N-K"}, "path": "bundles/org.openhab.binding.somfytahoma/src/main/java/org/openhab/binding/somfytahoma/internal/handler/SomfyTahomaBridgeHandler.java", "diffHunk": "@@ -356,103 +309,19 @@ private void stopPolling() {\n     }\n \n     public List<SomfyTahomaActionGroup> listActionGroups() {\n-        String groups = getGroups();\n-        if (StringUtils.equals(groups, UNAUTHORIZED)) {\n-            groups = getGroups();\n-        }\n-\n-        if (groups == null || groups.equals(UNAUTHORIZED)) {\n-            return Collections.emptyList();\n-        }\n-\n-        try {\n-            SomfyTahomaActionGroup[] list = gson.fromJson(groups, SomfyTahomaActionGroup[].class);\n-            return Arrays.asList(list);\n-        } catch (JsonSyntaxException e) {\n-            logger.debug(\"Received data: {} is not JSON\", groups, e);\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR, \"Received invalid data\");\n-        }\n-        return new ArrayList<>();\n-    }\n-\n-    private @Nullable String getGroups() {\n-        String url;\n-\n-        try {\n-            url = TAHOMA_API_URL + \"actionGroups\";\n-            return sendGetToTahomaWithCookie(url);\n-        } catch (ExecutionException e) {\n-            if (isAuthenticationChallenge(e)) {\n-                reLogin();\n-                return UNAUTHORIZED;\n-            } else {\n-                logger.debug(\"Cannot send getActionGroups command!\", e);\n-                updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR);\n-            }\n-        } catch (InterruptedException | TimeoutException e) {\n-            logger.debug(\"Cannot send getActionGroups command!\", e);\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR);\n-            if (e instanceof InterruptedException) {\n-                Thread.currentThread().interrupt();\n-            }\n-        }\n-        return null;\n+        SomfyTahomaActionGroup[] list = invokeCallToURL(TAHOMA_API_URL + \"actionGroups\", \"\", HttpMethod.GET,\n+                SomfyTahomaActionGroup[].class);\n+        return list != null ? Arrays.asList(list) : new ArrayList<>();\n     }\n \n     public @Nullable SomfyTahomaSetup getSetup() {\n-        String url;\n-        String line = \"\";\n-\n-        try {\n-            url = TAHOMA_API_URL + \"setup\";\n-            line = sendGetToTahomaWithCookie(url);\n-            return gson.fromJson(line, SomfyTahomaSetup.class);\n-        } catch (JsonSyntaxException e) {\n-            logger.debug(\"Received data: {} is not JSON\", line, e);\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR, \"Received invalid data\");\n-        } catch (ExecutionException e) {\n-            if (isAuthenticationChallenge(e)) {\n-                reLogin();\n-            } else {\n-                logger.debug(\"Cannot send getSetup command!\", e);\n-                updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR);\n-            }\n-        } catch (InterruptedException | TimeoutException e) {\n-            logger.debug(\"Cannot send getSetup command!\", e);\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR);\n-            if (e instanceof InterruptedException) {\n-                Thread.currentThread().interrupt();\n-            }\n-        }\n-        return null;\n+        return invokeCallToURL(TAHOMA_API_URL + \"setup\", \"\", HttpMethod.GET, SomfyTahomaSetup.class);\n     }\n \n     public List<SomfyTahomaDevice> getDevices() {\n-        String url;\n-        String line = \"\";\n-\n-        try {\n-            url = SETUP_URL + \"devices\";\n-            line = sendGetToTahomaWithCookie(url);\n-            return Arrays.asList(gson.fromJson(line, SomfyTahomaDevice[].class));\n-        } catch (JsonSyntaxException e) {\n-            logger.debug(\"Received data: {} is not JSON\", line, e);\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR, \"Received invalid data\");\n-        } catch (ExecutionException e) {\n-            if (isAuthenticationChallenge(e)) {\n-                reLogin();\n-            } else {\n-                logger.debug(\"Cannot send get devices command!\", e);\n-                updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR);\n-            }\n-        } catch (InterruptedException | TimeoutException e) {\n-            logger.debug(\"Cannot send get devices command!\", e);\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR);\n-            if (e instanceof InterruptedException) {\n-                Thread.currentThread().interrupt();\n-            }\n-        }\n-        return Collections.emptyList();\n+        SomfyTahomaDevice[] response = invokeCallToURL(SETUP_URL + \"devices\", \"\", HttpMethod.GET,\n+                SomfyTahomaDevice[].class);\n+        return response != null ? Arrays.asList(response) : Collections.emptyList();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03d34f3ffdfe2d53846047abd751a7e46fd2c86f"}, "originalPosition": 200}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODcxMDYwNA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return response != null ? new ArrayList<>(List.of(response)) : List.of();\n          \n          \n            \n                    return response != null ? List.of(response) : List.of();", "url": "https://github.com/openhab/openhab-addons/pull/9099#discussion_r528710604", "createdAt": "2020-11-23T13:41:44Z", "author": {"login": "J-N-K"}, "path": "bundles/org.openhab.binding.somfytahoma/src/main/java/org/openhab/binding/somfytahoma/internal/handler/SomfyTahomaBridgeHandler.java", "diffHunk": "@@ -234,71 +231,27 @@ private void setTooManyRequests() {\n     }\n \n     private @Nullable String registerEvents() {\n-        String url;\n+        SomfyTahomaRegisterEventsResponse response = invokeCallToURL(TAHOMA_EVENTS_URL + \"register\", \"\",\n+                HttpMethod.POST, SomfyTahomaRegisterEventsResponse.class);\n+        return response != null ? response.getId() : null;\n+    }\n \n+    private String urlEncode(String text) {\n         try {\n-            url = TAHOMA_EVENTS_URL + \"register\";\n-\n-            String line = sendPostToTahomaWithCookie(url, \"\");\n-            SomfyTahomaRegisterEventsResponse response = gson.fromJson(line, SomfyTahomaRegisterEventsResponse.class);\n-            return response.getId();\n-        } catch (JsonSyntaxException e) {\n-            logger.debug(\"Received invalid data\", e);\n-            return null;\n-        } catch (ExecutionException e) {\n-            if (isAuthenticationChallenge(e)) {\n-                reLogin();\n-                return UNAUTHORIZED;\n-            } else {\n-                logger.info(\"Cannot register events!\", e);\n-                updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR);\n-            }\n-        } catch (InterruptedException | TimeoutException e) {\n-            logger.info(\"Cannot register events!\", e);\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR);\n-            if (e instanceof InterruptedException) {\n-                Thread.currentThread().interrupt();\n-            }\n+            return URLEncoder.encode(text, StandardCharsets.UTF_8.toString());\n+        } catch (UnsupportedEncodingException e) {\n+            return text;\n         }\n-        return null;\n-    }\n-\n-    private String urlEncode(String text) throws UnsupportedEncodingException {\n-        return URLEncoder.encode(text, StandardCharsets.UTF_8.toString());\n     }\n \n     private void enableLogin() {\n         tooManyRequests = false;\n     }\n \n     private List<SomfyTahomaEvent> getEvents() {\n-        String url;\n-        String line = \"\";\n-\n-        try {\n-            url = TAHOMA_API_URL + \"events/\" + eventsId + \"/fetch\";\n-\n-            line = sendPostToTahomaWithCookie(url, \"\");\n-            SomfyTahomaEvent[] array = gson.fromJson(line, SomfyTahomaEvent[].class);\n-            return new ArrayList<>(Arrays.asList(array));\n-        } catch (JsonSyntaxException e) {\n-            logger.debug(\"Received data: {} is not JSON\", line, e);\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR, \"Received invalid data\");\n-        } catch (ExecutionException e) {\n-            if (isAuthenticationChallenge(e)) {\n-                reLogin();\n-            } else {\n-                logger.debug(\"Cannot get Tahoma events!\", e);\n-                updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR);\n-            }\n-        } catch (InterruptedException | TimeoutException e) {\n-            logger.debug(\"Cannot get Tahoma events!\", e);\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR);\n-            if (e instanceof InterruptedException) {\n-                Thread.currentThread().interrupt();\n-            }\n-        }\n-        return new ArrayList<>();\n+        SomfyTahomaEvent[] response = invokeCallToURL(TAHOMA_API_URL + \"events/\" + eventsId + \"/fetch\", \"\",\n+                HttpMethod.POST, SomfyTahomaEvent[].class);\n+        return response != null ? new ArrayList<>(List.of(response)) : List.of();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03d34f3ffdfe2d53846047abd751a7e46fd2c86f"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODcxMDg4Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return list != null ? Arrays.asList(list) : new ArrayList<>();\n          \n          \n            \n                    return list != null ? List.of(list) : List.of();", "url": "https://github.com/openhab/openhab-addons/pull/9099#discussion_r528710886", "createdAt": "2020-11-23T13:42:10Z", "author": {"login": "J-N-K"}, "path": "bundles/org.openhab.binding.somfytahoma/src/main/java/org/openhab/binding/somfytahoma/internal/handler/SomfyTahomaBridgeHandler.java", "diffHunk": "@@ -356,103 +309,19 @@ private void stopPolling() {\n     }\n \n     public List<SomfyTahomaActionGroup> listActionGroups() {\n-        String groups = getGroups();\n-        if (StringUtils.equals(groups, UNAUTHORIZED)) {\n-            groups = getGroups();\n-        }\n-\n-        if (groups == null || groups.equals(UNAUTHORIZED)) {\n-            return Collections.emptyList();\n-        }\n-\n-        try {\n-            SomfyTahomaActionGroup[] list = gson.fromJson(groups, SomfyTahomaActionGroup[].class);\n-            return Arrays.asList(list);\n-        } catch (JsonSyntaxException e) {\n-            logger.debug(\"Received data: {} is not JSON\", groups, e);\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR, \"Received invalid data\");\n-        }\n-        return new ArrayList<>();\n-    }\n-\n-    private @Nullable String getGroups() {\n-        String url;\n-\n-        try {\n-            url = TAHOMA_API_URL + \"actionGroups\";\n-            return sendGetToTahomaWithCookie(url);\n-        } catch (ExecutionException e) {\n-            if (isAuthenticationChallenge(e)) {\n-                reLogin();\n-                return UNAUTHORIZED;\n-            } else {\n-                logger.debug(\"Cannot send getActionGroups command!\", e);\n-                updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR);\n-            }\n-        } catch (InterruptedException | TimeoutException e) {\n-            logger.debug(\"Cannot send getActionGroups command!\", e);\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR);\n-            if (e instanceof InterruptedException) {\n-                Thread.currentThread().interrupt();\n-            }\n-        }\n-        return null;\n+        SomfyTahomaActionGroup[] list = invokeCallToURL(TAHOMA_API_URL + \"actionGroups\", \"\", HttpMethod.GET,\n+                SomfyTahomaActionGroup[].class);\n+        return list != null ? Arrays.asList(list) : new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03d34f3ffdfe2d53846047abd751a7e46fd2c86f"}, "originalPosition": 140}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODcxMTg4Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if (!StringUtils.isEmpty(response.getExecId())) {\n          \n          \n            \n                        if (!response.getExecId().isEmpty()) {", "url": "https://github.com/openhab/openhab-addons/pull/9099#discussion_r528711882", "createdAt": "2020-11-23T13:43:45Z", "author": {"login": "J-N-K"}, "path": "bundles/org.openhab.binding.somfytahoma/src/main/java/org/openhab/binding/somfytahoma/internal/handler/SomfyTahomaBridgeHandler.java", "diffHunk": "@@ -693,54 +562,29 @@ public void sendCommand(String io, String command, String params) {\n         }\n \n         Boolean result = sendCommandInternal(io, command, params);\n-        if (result != null && !result) {\n+        if (!result) {\n             sendCommandInternal(io, command, params);\n         }\n     }\n \n-    private @Nullable Boolean sendCommandInternal(String io, String command, String params) {\n-        String url;\n-        String line = \"\";\n-\n-        try {\n-            url = EXEC_URL + \"apply\";\n-\n-            String value = params.equals(\"[]\") ? command : params.replace(\"\\\"\", \"\");\n-            String urlParameters = \"{\\\"label\\\":\\\"\" + getThingLabelByURL(io) + \" - \" + value\n-                    + \" - OH2\\\",\\\"actions\\\":[{\\\"deviceURL\\\":\\\"\" + io + \"\\\",\\\"commands\\\":[{\\\"name\\\":\\\"\" + command\n-                    + \"\\\",\\\"parameters\\\":\" + params + \"}]}]}\";\n-\n-            line = sendPostToTahomaWithCookie(url, urlParameters);\n-\n-            SomfyTahomaApplyResponse data = gson.fromJson(line, SomfyTahomaApplyResponse.class);\n-\n-            if (!StringUtils.isEmpty(data.getExecId())) {\n-                logger.debug(\"Exec id: {}\", data.getExecId());\n-                registerExecution(io, data.getExecId());\n+    private Boolean sendCommandInternal(String io, String command, String params) {\n+        String value = params.equals(\"[]\") ? command : params.replace(\"\\\"\", \"\");\n+        String urlParameters = \"{\\\"label\\\":\\\"\" + getThingLabelByURL(io) + \" - \" + value\n+                + \" - OH2\\\",\\\"actions\\\":[{\\\"deviceURL\\\":\\\"\" + io + \"\\\",\\\"commands\\\":[{\\\"name\\\":\\\"\" + command\n+                + \"\\\",\\\"parameters\\\":\" + params + \"}]}]}\";\n+        SomfyTahomaApplyResponse response = invokeCallToURL(EXEC_URL + \"apply\", urlParameters, HttpMethod.POST,\n+                SomfyTahomaApplyResponse.class);\n+        if (response != null) {\n+            if (!StringUtils.isEmpty(response.getExecId())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03d34f3ffdfe2d53846047abd751a7e46fd2c86f"}, "originalPosition": 241}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a19feb5df21b09559a3f875cec54410792b1641", "author": {"user": {"login": "octa22", "name": "Ondrej Pecta"}}, "url": "https://github.com/openhab/openhab-addons/commit/0a19feb5df21b09559a3f875cec54410792b1641", "committedDate": "2020-11-23T14:25:16Z", "message": "Update bundles/org.openhab.binding.somfytahoma/src/main/java/org/openhab/binding/somfytahoma/internal/handler/SomfyTahomaBridgeHandler.java\n\nCo-authored-by: J-N-K <J-N-K@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e98568b1cf3ae9add7da0a2df7856a4ac159403", "author": {"user": {"login": "octa22", "name": "Ondrej Pecta"}}, "url": "https://github.com/openhab/openhab-addons/commit/3e98568b1cf3ae9add7da0a2df7856a4ac159403", "committedDate": "2020-11-23T14:25:39Z", "message": "Update bundles/org.openhab.binding.somfytahoma/src/main/java/org/openhab/binding/somfytahoma/internal/handler/SomfyTahomaBridgeHandler.java\n\nCo-authored-by: J-N-K <J-N-K@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf4e53769f9ae699cbc097623533f321ba13dfd0", "author": {"user": {"login": "octa22", "name": "Ondrej Pecta"}}, "url": "https://github.com/openhab/openhab-addons/commit/bf4e53769f9ae699cbc097623533f321ba13dfd0", "committedDate": "2020-11-23T14:25:47Z", "message": "Update bundles/org.openhab.binding.somfytahoma/src/main/java/org/openhab/binding/somfytahoma/internal/handler/SomfyTahomaBridgeHandler.java\n\nCo-authored-by: J-N-K <J-N-K@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e1be98783abe23a93dbdb48fe6390f9fa81a0399", "author": {"user": {"login": "octa22", "name": "Ondrej Pecta"}}, "url": "https://github.com/openhab/openhab-addons/commit/e1be98783abe23a93dbdb48fe6390f9fa81a0399", "committedDate": "2020-11-23T14:26:08Z", "message": "Update bundles/org.openhab.binding.somfytahoma/src/main/java/org/openhab/binding/somfytahoma/internal/handler/SomfyTahomaBridgeHandler.java\n\nCo-authored-by: J-N-K <J-N-K@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2NzQ5MTQ1", "url": "https://github.com/openhab/openhab-addons/pull/9099#pullrequestreview-536749145", "createdAt": "2020-11-23T18:41:07Z", "commit": {"oid": "e1be98783abe23a93dbdb48fe6390f9fa81a0399"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4166, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}