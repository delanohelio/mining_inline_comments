{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY3MjUwNzY3", "number": 6909, "title": "[hueemulation] Fixes to prevent Alexa errors when using voice commands and the app (#6690)", "bodyText": "Fixes #6690 #5897\nWhen Alexa changes the state of a bulb it seems to immediately request the state of the bulb and after three requests will report an error with the device if the state does not match what it expects.\nThe issue is due to the conversion from hue state to OH state and back again, e.g. Alexa sends a brightness of 128 which is converted to an OH brightness of 50. However, 50 converts back to 127 and Alexa is expecting to see the brightness change to 128.\nThis change caches the last hue state change so that the same values can be reflected back for the status of the bulb.\nAlso the minimum hue brightness as stated in the API should be 1 not 0. Changing this has fixed the issue with all off bulbs being reported in the Alexa app with \"Device does not support requested value\"\nTested with Alexa voice commands and also Alex app. Also tested with Logitech Harmony remote. Checked bulbs which are off but now reporting brightness of 1 are considered off in both Alexa and Harmony app/remote.\nSigned-off-by: Mike Major mike_j_major@hotmail.com", "createdAt": "2020-01-26T19:11:54Z", "url": "https://github.com/openhab/openhab-addons/pull/6909", "merged": true, "mergeCommit": {"oid": "008d8083a17baaf5ee3c729f8b6ecef62aade66b"}, "closed": true, "closedAt": "2020-02-10T21:12:01Z", "author": {"login": "MikeJMajor"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb-L9B5gH2gAyMzY3MjUwNzY3OjkwZTVhODliODg4MWYyZjRjYTUzZTBlYTc5OTkxODM0Njk2ZjE5ZDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcArvZNAFqTM1MjIwNTI5Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "90e5a89b8881f2f4ca53e0ea79991834696f19d1", "author": {"user": {"login": "MikeJMajor", "name": "Mike Major"}}, "url": "https://github.com/openhab/openhab-addons/commit/90e5a89b8881f2f4ca53e0ea79991834696f19d1", "committedDate": "2020-01-26T17:53:51Z", "message": "Correct state to prevent Alexa reporting device errors.\n\nSigned-off-by: Mike Major <mike_j_major@hotmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fdc567ad9e765cb7c65aa7adf2477ca4a70e58ed", "author": {"user": {"login": "MikeJMajor", "name": "Mike Major"}}, "url": "https://github.com/openhab/openhab-addons/commit/fdc567ad9e765cb7c65aa7adf2477ca4a70e58ed", "committedDate": "2020-01-27T22:13:02Z", "message": "Minimum hue brightness should be 1 not 0.\n\nSigned-off-by: Mike Major <mike_j_major@hotmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5MTg0NDk4", "url": "https://github.com/openhab/openhab-addons/pull/6909#pullrequestreview-349184498", "createdAt": "2020-01-28T08:05:52Z", "commit": {"oid": "fdc567ad9e765cb7c65aa7adf2477ca4a70e58ed"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxMzUyMDM2", "url": "https://github.com/openhab/openhab-addons/pull/6909#pullrequestreview-351352036", "createdAt": "2020-01-31T08:29:37Z", "commit": {"oid": "fdc567ad9e765cb7c65aa7adf2477ca4a70e58ed"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxNDIwNDU5", "url": "https://github.com/openhab/openhab-addons/pull/6909#pullrequestreview-351420459", "createdAt": "2020-01-31T10:38:49Z", "commit": {"oid": "fdc567ad9e765cb7c65aa7adf2477ca4a70e58ed"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQxMDozODo0OVrOFkHfnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQxMDozODo0OVrOFkHfnQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQxNTgzNw==", "bodyText": "Usage of as is tricky here. Because the as as used with the openHAB State class returns a new instance. So the contract to be assumed should be the method returns a new instance. Here it's assumed it returns the same object. But if that would change this code will break here. Because the code below will than make changes on the local variable only and not on the object returned. It would be better to do an instanceof check and a cast :\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                HueStateColorBulb c = hueState.as(HueStateColorBulb.class);\n          \n          \n            \n                                HueStateColorBulb c = (HueStateColorBulb) hueState;\n          \n      \n    \n    \n  \n\nSame below with HueStateBulb", "url": "https://github.com/openhab/openhab-addons/pull/6909#discussion_r373415837", "createdAt": "2020-01-31T10:38:49Z", "author": {"login": "Hilbrand"}, "path": "bundles/org.openhab.io.hueemulation/src/main/java/org/openhab/io/hueemulation/internal/StateUtils.java", "diffHunk": "@@ -413,4 +413,48 @@ public static Command commandByItemState(State state) throws IllegalStateExcepti\n         }\n         return t;\n     }\n+\n+    /**\n+     * Compute the hue state from a given item state and a device type.\n+     * If the item state matches the last command. the hue state is adjusted\n+     * to use the values from the last hue state change. This is done to prevent\n+     * Alexa reporting device errors.\n+     * \n+     * @param itemState The item state\n+     * @param deviceType The device type\n+     * @param lastCommand The last command\n+     * @param lastHueChange The last hue state change\n+     * @return A hue light state\n+     */\n+    public static AbstractHueState adjustedColorStateFromItemState(State itemState, @Nullable DeviceType deviceType,\n+            @Nullable Command lastCommand, @Nullable HueStateChange lastHueChange) {\n+\n+        AbstractHueState hueState = colorStateFromItemState(itemState, deviceType);\n+\n+        if (lastCommand != null && lastHueChange != null) {\n+            if (lastCommand instanceof HSBType) {\n+                if (itemState.as(HSBType.class).equals(lastCommand)) {\n+                    HueStateColorBulb c = hueState.as(HueStateColorBulb.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fdc567ad9e765cb7c65aa7adf2477ca4a70e58ed"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2a8aa93d28b1f8d185043f69b9d93ac07013abf", "author": {"user": {"login": "MikeJMajor", "name": "Mike Major"}}, "url": "https://github.com/openhab/openhab-addons/commit/e2a8aa93d28b1f8d185043f69b9d93ac07013abf", "committedDate": "2020-01-31T15:49:45Z", "message": "Updated with review comments and return CT value in status\n\nSigned-off-by: Mike Major <mike_j_major@hotmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyMjA1Mjkz", "url": "https://github.com/openhab/openhab-addons/pull/6909#pullrequestreview-352205293", "createdAt": "2020-02-03T12:03:46Z", "commit": {"oid": "e2a8aa93d28b1f8d185043f69b9d93ac07013abf"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1284, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}