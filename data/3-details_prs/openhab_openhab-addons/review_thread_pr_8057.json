{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQzODc5MTE1", "number": 8057, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxOTozNjowOVrOEMNw_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxOTo0NzowNFrOEMN-vg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxMjQzOTAwOnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.binding.netatmo/README.md", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxOTozNjowOVrOGuMyag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQyMjoyNjo1M1rOGvj34g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA5NzE5NA==", "bodyText": "Please put each sentence on its own line.", "url": "https://github.com/openhab/openhab-addons/pull/8057#discussion_r451097194", "createdAt": "2020-07-07T19:36:09Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.netatmo/README.md", "diffHunk": "@@ -503,10 +509,9 @@ All these channels are read only.\n ### Welcome and Presence Camera\n \n Warnings:\n-- The URL of the live snapshot is a fixed URL so the value of the channel cameraLivePictureUrl / welcomeCameraLivePictureUrl will never be updated once first set by the binding.\n-So to get a refreshed picture, you need to use the refresh parameter in your sitemap image element.\n-- Some features like the video surveillance are accessed via the local network, so it may be helpful to set a static IP address\n-for the camera within your local network.\n+\n+- The URL of the live snapshot is a fixed URL so the value of the channel cameraLivePictureUrl / welcomeCameraLivePictureUrl will never be updated once first set by the binding. So to get a refreshed picture, you need to use the refresh parameter in your sitemap image element.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0113c48e6b24c9c9232fa9a5345658f84d5eb61"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTMyNzE2NQ==", "bodyText": "This was done to avoid a warning in the checks (blank line required after a list item, something like that).\nEither 2 lines to help maintenance but a warning, or one line and no warning.\nLet me know what you prefer.", "url": "https://github.com/openhab/openhab-addons/pull/8057#discussion_r451327165", "createdAt": "2020-07-08T07:06:58Z", "author": {"login": "lolodomo"}, "path": "bundles/org.openhab.binding.netatmo/README.md", "diffHunk": "@@ -503,10 +509,9 @@ All these channels are read only.\n ### Welcome and Presence Camera\n \n Warnings:\n-- The URL of the live snapshot is a fixed URL so the value of the channel cameraLivePictureUrl / welcomeCameraLivePictureUrl will never be updated once first set by the binding.\n-So to get a refreshed picture, you need to use the refresh parameter in your sitemap image element.\n-- Some features like the video surveillance are accessed via the local network, so it may be helpful to set a static IP address\n-for the camera within your local network.\n+\n+- The URL of the live snapshot is a fixed URL so the value of the channel cameraLivePictureUrl / welcomeCameraLivePictureUrl will never be updated once first set by the binding. So to get a refreshed picture, you need to use the refresh parameter in your sitemap image element.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA5NzE5NA=="}, "originalCommit": {"oid": "e0113c48e6b24c9c9232fa9a5345658f84d5eb61"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjUyNDAwMg==", "bodyText": "Just leave as is then. I've prefer to avoid the warning even if it might be misguided.", "url": "https://github.com/openhab/openhab-addons/pull/8057#discussion_r452524002", "createdAt": "2020-07-09T22:26:53Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.netatmo/README.md", "diffHunk": "@@ -503,10 +509,9 @@ All these channels are read only.\n ### Welcome and Presence Camera\n \n Warnings:\n-- The URL of the live snapshot is a fixed URL so the value of the channel cameraLivePictureUrl / welcomeCameraLivePictureUrl will never be updated once first set by the binding.\n-So to get a refreshed picture, you need to use the refresh parameter in your sitemap image element.\n-- Some features like the video surveillance are accessed via the local network, so it may be helpful to set a static IP address\n-for the camera within your local network.\n+\n+- The URL of the live snapshot is a fixed URL so the value of the channel cameraLivePictureUrl / welcomeCameraLivePictureUrl will never be updated once first set by the binding. So to get a refreshed picture, you need to use the refresh parameter in your sitemap image element.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA5NzE5NA=="}, "originalCommit": {"oid": "e0113c48e6b24c9c9232fa9a5345658f84d5eb61"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxMjQ0NDkyOnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/handler/AbstractNetatmoThingHandler.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxOTozODowMlrOGuM2IA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxOTozODowMlrOGuM2IA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA5ODE0NA==", "bodyText": "Caching the bridge handler result in a local variable is much safer from a concurrency standpoint.", "url": "https://github.com/openhab/openhab-addons/pull/8057#discussion_r451098144", "createdAt": "2020-07-07T19:38:02Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/handler/AbstractNetatmoThingHandler.java", "diffHunk": "@@ -233,21 +237,30 @@ protected void updateProperties(Integer firmware, String modelId) {\n         updateProperties(properties);\n     }\n \n+    protected Optional<RadioHelper> getRadioHelper() {\n+        RadioHelper helper = radioHelper;\n+        return helper != null ? Optional.of(helper) : Optional.empty();\n+    }\n+\n+    protected Optional<BatteryHelper> getBatteryHelper() {\n+        BatteryHelper helper = batteryHelper;\n+        return helper != null ? Optional.of(helper) : Optional.empty();\n+    }\n+\n     public void updateMeasurements() {\n     }\n \n-    public void getMeasurements(String device, @Nullable String module, String scale, List<String> types,\n+    public void getMeasurements(@Nullable String device, @Nullable String module, String scale, List<String> types,\n             List<String> channels, Map<String, Float> channelMeasurements) {\n-        NetatmoBridgeHandler handler = getBridgeHandler();\n-        if (handler == null) {\n+        if (!getBridgeHandler().isPresent() || device == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0113c48e6b24c9c9232fa9a5345658f84d5eb61"}, "originalPosition": 173}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxMjQ2MzYyOnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomePersonHandler.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxOTo0NDowM1rOGuNCMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxOTo0NDowM1rOGuNCMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTEwMTIzNA==", "bodyText": "getBridgeHandler() and getModule() should be cached to local variables", "url": "https://github.com/openhab/openhab-addons/pull/8057#discussion_r451101234", "createdAt": "2020-07-07T19:44:03Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomePersonHandler.java", "diffHunk": "@@ -105,21 +102,20 @@ protected State getNAThingProperty(@NonNull String channelId) {\n         return super.getNAThingProperty(channelId);\n     }\n \n-    private String getLastEventURL() {\n-        NetatmoBridgeHandler bridgeHandler = getBridgeHandler();\n-        if (bridgeHandler != null && lastEvent != null && lastEvent.getSnapshot() != null) {\n-            return bridgeHandler.getPictureUrl(lastEvent.getSnapshot().getId(), lastEvent.getSnapshot().getKey());\n+    private @Nullable String getLastEventURL() {\n+        if (getBridgeHandler().isPresent() && getLastEvent().isPresent()\n+                && getLastEvent().get().getSnapshot() != null) {\n+            return getBridgeHandler().get().getPictureUrl(getLastEvent().get().getSnapshot().getId(),\n+                    getLastEvent().get().getSnapshot().getKey());\n         }\n         return null;\n     }\n \n-    private String getAvatarURL() {\n-        NetatmoBridgeHandler bridgeHandler = getBridgeHandler();\n-        NAWelcomePerson module = this.module;\n-        if (bridgeHandler != null && avatarURL == null && module != null) {\n-            NAWelcomeFace face = module.getFace();\n+    private @Nullable String getAvatarURL() {\n+        if (getBridgeHandler().isPresent() && avatarURL == null && getModule().isPresent()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0113c48e6b24c9c9232fa9a5345658f84d5eb61"}, "originalPosition": 118}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxMjQ2ODg1OnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomePersonHandler.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxOTo0NTozOVrOGuNFeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxOTo0NTozOVrOGuNFeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTEwMjA3Mg==", "bodyText": "getBridgeHandler() and getLastEvent() should be cached to local variables", "url": "https://github.com/openhab/openhab-addons/pull/8057#discussion_r451102072", "createdAt": "2020-07-07T19:45:39Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomePersonHandler.java", "diffHunk": "@@ -105,21 +102,20 @@ protected State getNAThingProperty(@NonNull String channelId) {\n         return super.getNAThingProperty(channelId);\n     }\n \n-    private String getLastEventURL() {\n-        NetatmoBridgeHandler bridgeHandler = getBridgeHandler();\n-        if (bridgeHandler != null && lastEvent != null && lastEvent.getSnapshot() != null) {\n-            return bridgeHandler.getPictureUrl(lastEvent.getSnapshot().getId(), lastEvent.getSnapshot().getKey());\n+    private @Nullable String getLastEventURL() {\n+        if (getBridgeHandler().isPresent() && getLastEvent().isPresent()\n+                && getLastEvent().get().getSnapshot() != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0113c48e6b24c9c9232fa9a5345658f84d5eb61"}, "originalPosition": 105}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxMjQ3NDIyOnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomePersonHandler.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxOTo0NzowNFrOGuNItA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwNzozMjowMVrOGubm9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTEwMjkwMA==", "bodyText": "you get the idea, fix wherever else it might apply.", "url": "https://github.com/openhab/openhab-addons/pull/8057#discussion_r451102900", "createdAt": "2020-07-07T19:47:04Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomePersonHandler.java", "diffHunk": "@@ -70,32 +65,34 @@ public void updateChannels(Object module) {\n                         lastEvent = event;\n                     }\n                 });\n-            }\n+            });\n \n             setRefreshRequired(false);\n         }\n         super.updateChannels(module);\n     }\n \n     @Override\n-    protected State getNAThingProperty(@NonNull String channelId) {\n-        NAWelcomePerson module = this.module;\n+    protected State getNAThingProperty(String channelId) {\n         switch (channelId) {\n             case CHANNEL_WELCOME_PERSON_LASTSEEN:\n-                return module != null ? toDateTimeType(module.getLastSeen(), timeZoneProvider.getTimeZone())\n-                        : UnDefType.UNDEF;\n+                return getModule().map(m -> toDateTimeType(m.getLastSeen(), timeZoneProvider.getTimeZone()))\n+                        .orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_PERSON_ATHOME:\n-                return module != null ? module.getOutOfSight() ? OnOffType.OFF : OnOffType.ON : UnDefType.UNDEF;\n+                return getModule()\n+                        .map(m -> m.getOutOfSight() != null ? toOnOffType(!m.getOutOfSight()) : UnDefType.UNDEF)\n+                        .orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_PERSON_AVATAR_URL:\n                 return toStringType(getAvatarURL());\n             case CHANNEL_WELCOME_PERSON_AVATAR:\n                 return getAvatarURL() != null ? HttpUtil.downloadImage(getAvatarURL()) : UnDefType.UNDEF;\n             case CHANNEL_WELCOME_PERSON_LASTMESSAGE:\n-                return (lastEvent != null && lastEvent.getMessage() != null)\n-                        ? toStringType(lastEvent.getMessage().replace(\"<b>\", \"\").replace(\"</b>\", \"\"))\n+                return (getLastEvent().isPresent() && getLastEvent().get().getMessage() != null)\n+                        ? toStringType(getLastEvent().get().getMessage().replace(\"<b>\", \"\").replace(\"</b>\", \"\"))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0113c48e6b24c9c9232fa9a5345658f84d5eb61"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM0MDAyMg==", "bodyText": "Understood", "url": "https://github.com/openhab/openhab-addons/pull/8057#discussion_r451340022", "createdAt": "2020-07-08T07:32:01Z", "author": {"login": "lolodomo"}, "path": "bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomePersonHandler.java", "diffHunk": "@@ -70,32 +65,34 @@ public void updateChannels(Object module) {\n                         lastEvent = event;\n                     }\n                 });\n-            }\n+            });\n \n             setRefreshRequired(false);\n         }\n         super.updateChannels(module);\n     }\n \n     @Override\n-    protected State getNAThingProperty(@NonNull String channelId) {\n-        NAWelcomePerson module = this.module;\n+    protected State getNAThingProperty(String channelId) {\n         switch (channelId) {\n             case CHANNEL_WELCOME_PERSON_LASTSEEN:\n-                return module != null ? toDateTimeType(module.getLastSeen(), timeZoneProvider.getTimeZone())\n-                        : UnDefType.UNDEF;\n+                return getModule().map(m -> toDateTimeType(m.getLastSeen(), timeZoneProvider.getTimeZone()))\n+                        .orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_PERSON_ATHOME:\n-                return module != null ? module.getOutOfSight() ? OnOffType.OFF : OnOffType.ON : UnDefType.UNDEF;\n+                return getModule()\n+                        .map(m -> m.getOutOfSight() != null ? toOnOffType(!m.getOutOfSight()) : UnDefType.UNDEF)\n+                        .orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_PERSON_AVATAR_URL:\n                 return toStringType(getAvatarURL());\n             case CHANNEL_WELCOME_PERSON_AVATAR:\n                 return getAvatarURL() != null ? HttpUtil.downloadImage(getAvatarURL()) : UnDefType.UNDEF;\n             case CHANNEL_WELCOME_PERSON_LASTMESSAGE:\n-                return (lastEvent != null && lastEvent.getMessage() != null)\n-                        ? toStringType(lastEvent.getMessage().replace(\"<b>\", \"\").replace(\"</b>\", \"\"))\n+                return (getLastEvent().isPresent() && getLastEvent().get().getMessage() != null)\n+                        ? toStringType(getLastEvent().get().getMessage().replace(\"<b>\", \"\").replace(\"</b>\", \"\"))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTEwMjkwMA=="}, "originalCommit": {"oid": "e0113c48e6b24c9c9232fa9a5345658f84d5eb61"}, "originalPosition": 86}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4690, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}