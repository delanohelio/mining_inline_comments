{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ1NjQxNzg2", "number": 9525, "title": "[samsungtv] UPnP devices discovery refactored", "bodyText": "Ported #7499 to openHAB 3.\nFixes #2916\nFixes #8419\nFixes #9495", "createdAt": "2020-12-26T00:08:59Z", "url": "https://github.com/openhab/openhab-addons/pull/9525", "merged": true, "mergeCommit": {"oid": "0b50f2756fb12fbb6499d1b0291d3e112ca8b278"}, "closed": true, "closedAt": "2021-01-02T20:01:09Z", "author": {"login": "kaikreuzer"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdqGZwWgBqjQxNDk5MzUwMzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdsAZJNABqjQxNjEzMDExOTI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b9b1948de8f08308c7260249f2ec09814d78b55c", "author": {"user": {"login": "kaikreuzer", "name": "Kai Kreuzer"}}, "url": "https://github.com/openhab/openhab-addons/commit/b9b1948de8f08308c7260249f2ec09814d78b55c", "committedDate": "2020-12-26T00:06:19Z", "message": "[samsungtv] UPnP devices discovery refactored\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>"}, "afterCommit": {"oid": "8b55829b6232c14490b6d9a78c165623c4de8f4a", "author": {"user": {"login": "kaikreuzer", "name": "Kai Kreuzer"}}, "url": "https://github.com/openhab/openhab-addons/commit/8b55829b6232c14490b6d9a78c165623c4de8f4a", "committedDate": "2020-12-27T00:22:56Z", "message": "[samsungtv] UPnP devices discovery refactored\n\nAlso-by: Laurent Garnier <lg.hc@free.fr>\nSigned-off-by: Kai Kreuzer <kai@openhab.org>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4OTk3OTE1", "url": "https://github.com/openhab/openhab-addons/pull/9525#pullrequestreview-558997915", "createdAt": "2020-12-28T05:06:57Z", "commit": {"oid": "4a6aabcab40ac22b1f5729f12a30f9c6c461c99b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5NDEyMjAy", "url": "https://github.com/openhab/openhab-addons/pull/9525#pullrequestreview-559412202", "createdAt": "2020-12-29T07:41:36Z", "commit": {"oid": "4a6aabcab40ac22b1f5729f12a30f9c6c461c99b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQwNzo0MTozN1rOIMJCUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQwNzo0MTozN1rOIMJCUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTYwMTg3Mw==", "bodyText": "There might be a small chance to miss device(s) if new is registered between getRemoteDevices loop and addListener.", "url": "https://github.com/openhab/openhab-addons/pull/9525#discussion_r549601873", "createdAt": "2020-12-29T07:41:37Z", "author": {"login": "paulianttila"}, "path": "bundles/org.openhab.binding.samsungtv/src/main/java/org/openhab/binding/samsungtv/internal/handler/SamsungTvHandler.java", "diffHunk": "@@ -155,9 +145,13 @@ public void initialize() {\n \n         configuration = getConfigAs(SamsungTvConfiguration.class);\n \n-        discoveryServiceRegistry.addDiscoveryListener(this);\n+        // One Samsung TV contains several UPnP devices. Create handler for each UPnP device.\n+        for (RemoteDevice device : upnpService.getRegistry().getRemoteDevices()) {\n+            remoteDeviceAdded(null, device);\n+        }\n+        upnpService.getRegistry().addListener(this);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a6aabcab40ac22b1f5729f12a30f9c6c461c99b"}, "originalPosition": 91}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5NDI2NjU1", "url": "https://github.com/openhab/openhab-addons/pull/9525#pullrequestreview-559426655", "createdAt": "2020-12-29T08:29:16Z", "commit": {"oid": "4a6aabcab40ac22b1f5729f12a30f9c6c461c99b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQwODoyOToxNlrOIMJ23g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQwODoyOToxNlrOIMJ23g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTYxNTMyNg==", "bodyText": "Some of the Samsung TV models have a faulty UPnP implementation as they don't publish SSDP alive message as they have promised and jUPnP library might make a decision to remove the device. If device is a MediaRenderer device, shutdown now remove all samsung tv related UPnP services and they might not come back as remoteDeviceAdded is not called by the UPnP library for those removed services. Earlier checkAndCreateServices was called which created all related services.", "url": "https://github.com/openhab/openhab-addons/pull/9525#discussion_r549615326", "createdAt": "2020-12-29T08:29:16Z", "author": {"login": "paulianttila"}, "path": "bundles/org.openhab.binding.samsungtv/src/main/java/org/openhab/binding/samsungtv/internal/handler/SamsungTvHandler.java", "diffHunk": "@@ -330,52 +305,84 @@ private synchronized void stopService(SamsungTvService service) {\n     }\n \n     @Override\n-    public void thingDiscovered(DiscoveryService source, DiscoveryResult result) {\n-        if (configuration.hostName != null\n-                && configuration.hostName.equals(result.getProperties().get(SamsungTvConfiguration.HOST_NAME))) {\n-            logger.debug(\"thingDiscovered: {}, {}\", result.getProperties().get(SamsungTvConfiguration.HOST_NAME),\n-                    result);\n+    public void remoteDeviceDiscoveryStarted(@Nullable Registry registry, @Nullable RemoteDevice device) {\n+    }\n+\n+    @Override\n+    public void remoteDeviceDiscoveryFailed(@Nullable Registry registry, @Nullable RemoteDevice device,\n+            @Nullable Exception ex) {\n+    }\n+\n+    @Override\n+    public void remoteDeviceAdded(@Nullable Registry registry, @Nullable RemoteDevice device) {\n+        if (configuration.hostName == null || device == null || device.getIdentity() == null\n+                || device.getIdentity().getDescriptorURL() == null\n+                || !configuration.hostName.equals(device.getIdentity().getDescriptorURL().getHost())\n+                || device.getType() == null) {\n+            return;\n+        }\n+\n+        logger.debug(\"remoteDeviceAdded: {}, {}\", device.getType().getType(), device.getIdentity().getDescriptorURL());\n+\n+        createService(device);\n+        putOnline();\n \n+        if (\"MediaRenderer\".equals(device.getType().getType())) {\n             /* Check if configuration should be updated */\n             if (configuration.macAddress == null || configuration.macAddress.trim().isEmpty()) {\n                 String macAddress = WakeOnLanUtility.getMACAddress(configuration.hostName);\n                 if (macAddress != null) {\n                     putConfig(SamsungTvConfiguration.MAC_ADDRESS, macAddress);\n-                    logger.debug(\"thingDiscovered, macAddress: {}\", macAddress);\n+                    logger.debug(\"remoteDeviceAdded, macAddress: {}\", macAddress);\n                 }\n             }\n             if (SamsungTvConfiguration.PROTOCOL_NONE.equals(configuration.protocol)) {\n                 Map<String, Object> properties = RemoteControllerService.discover(configuration.hostName);\n                 for (Map.Entry<String, Object> property : properties.entrySet()) {\n                     putConfig(property.getKey(), property.getValue());\n-                    logger.debug(\"thingDiscovered, {}: {}\", property.getKey(), property.getValue());\n+                    logger.debug(\"remoteDeviceAdded, {}: {}\", property.getKey(), property.getValue());\n                 }\n             }\n-\n-            /*\n-             * SamsungTV discovery services creates thing UID from UPnP UDN.\n-             * When thing is generated manually, thing UID may not match UPnP UDN, so store it for later use (e.g.\n-             * thingRemoved).\n-             */\n-            upnpThingUID = result.getThingUID();\n-            logger.debug(\"thingDiscovered, thingUID={}, discoveredUID={}\", this.getThing().getUID(), upnpThingUID);\n-            checkAndCreateServices();\n+            checkCreateManualConnection();\n         }\n     }\n \n     @Override\n-    public void thingRemoved(DiscoveryService source, ThingUID thingUID) {\n-        if (thingUID.equals(upnpThingUID)) {\n-            logger.debug(\"Thing Removed: {}\", thingUID);\n+    public void remoteDeviceUpdated(@Nullable Registry registry, @Nullable RemoteDevice device) {\n+    }\n+\n+    @Override\n+    public void remoteDeviceRemoved(@Nullable Registry registry, @Nullable RemoteDevice device) {\n+        if (configuration.hostName == null || device == null || device.getIdentity() == null\n+                || device.getIdentity().getDescriptorURL() == null\n+                || !configuration.hostName.equals(device.getIdentity().getDescriptorURL().getHost())\n+                || device.getType() == null) {\n+            return;\n+        }\n+\n+        logger.debug(\"remoteDeviceRemoved: {}, {}\", device.getType().getType(),\n+                device.getIdentity().getDescriptorURL());\n+\n+        if (\"MediaRenderer\".equals(device.getType().getType())) {\n             shutdown();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a6aabcab40ac22b1f5729f12a30f9c6c461c99b"}, "originalPosition": 260}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79283b1b4525c28acc9f719e62d51215cf91e71a", "author": {"user": {"login": "kaikreuzer", "name": "Kai Kreuzer"}}, "url": "https://github.com/openhab/openhab-addons/commit/79283b1b4525c28acc9f719e62d51215cf91e71a", "committedDate": "2021-01-01T22:36:52Z", "message": "[samsungtv] UPnP devices discovery refactored\n\nAlso-by: Laurent Garnier <lg.hc@free.fr>\nSigned-off-by: Kai Kreuzer <kai@openhab.org>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "273bd4780000db9d4beccf8893283914dabec1cf", "author": {"user": {"login": "kaikreuzer", "name": "Kai Kreuzer"}}, "url": "https://github.com/openhab/openhab-addons/commit/273bd4780000db9d4beccf8893283914dabec1cf", "committedDate": "2021-01-01T22:09:38Z", "message": "addressed review comments\n\nSigned-off-by: Kai Kreuzer <kai@openhab.org>"}, "afterCommit": {"oid": "79283b1b4525c28acc9f719e62d51215cf91e71a", "author": {"user": {"login": "kaikreuzer", "name": "Kai Kreuzer"}}, "url": "https://github.com/openhab/openhab-addons/commit/79283b1b4525c28acc9f719e62d51215cf91e71a", "committedDate": "2021-01-01T22:36:52Z", "message": "[samsungtv] UPnP devices discovery refactored\n\nAlso-by: Laurent Garnier <lg.hc@free.fr>\nSigned-off-by: Kai Kreuzer <kai@openhab.org>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3622, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}