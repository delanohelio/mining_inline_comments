{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA0NjAzMzc0", "number": 7393, "title": "[km200] bugfixing and optimization", "bodyText": "Bugfixing and optimizations for the km200 binding.\n\nReplaced depreced Date/Time code\nFixed problem with fraction of numbers\nAdded @NonNullByDefault annotation to classes\nFixed problems on dispose\nRemoved almost all warnings\nSmall bugfixes", "createdAt": "2020-04-16T18:42:04Z", "url": "https://github.com/openhab/openhab-addons/pull/7393", "merged": true, "mergeCommit": {"oid": "a1918e87685b4bba802b1b75edcdea94d83b9059"}, "closed": true, "closedAt": "2020-04-18T17:09:03Z", "author": {"login": "Markinus"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcXo-jWAH2gAyNDA0NjAzMzc0OmQwYzNiZmY3NTliNDdhNTJjODAwZTAwNGQ5NmU5NzRiZDI4NjE2Mzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcY5CyhAFqTM5NTkzMjEyNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d0c3bff759b47a52c800e004d96e974bd2861637", "author": {"user": {"login": "Markinus", "name": "Markus Eckhardt"}}, "url": "https://github.com/openhab/openhab-addons/commit/d0c3bff759b47a52c800e004d96e974bd2861637", "committedDate": "2020-04-14T19:50:52Z", "message": "Some bug fixes:\n- Fixed problems on dispose, restart and configuration changing\n- Fixed a lot of warnings\n- Fixed the number of decimal places to one\n\nSigned-off-by: Markus Eckhardt <github@familie-eckhardt.eu>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4e611449253b2a026dcf997668f0864434a5943", "author": {"user": {"login": "Markinus", "name": "Markus Eckhardt"}}, "url": "https://github.com/openhab/openhab-addons/commit/a4e611449253b2a026dcf997668f0864434a5943", "committedDate": "2020-04-16T07:20:47Z", "message": "Added @NonNullByDefault to all interfaces and removed warnings\n\nSigned-off-by: Markus Eckhardt <github@familie-eckhardt.eu>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "68b620de8533d80cf724fb0c08fd0e611e7d0c9e", "author": {"user": {"login": "Markinus", "name": "Markus Eckhardt"}}, "url": "https://github.com/openhab/openhab-addons/commit/68b620de8533d80cf724fb0c08fd0e611e7d0c9e", "committedDate": "2020-04-16T10:36:23Z", "message": "Fixed problems with program switches\n\nSigned-off-by: Markus Eckhardt <github@familie-eckhardt.eu>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09ea29ede22f201b4decc340074cd45450b10a1b", "author": {"user": {"login": "Markinus", "name": "Markus Eckhardt"}}, "url": "https://github.com/openhab/openhab-addons/commit/09ea29ede22f201b4decc340074cd45450b10a1b", "committedDate": "2020-04-16T12:23:52Z", "message": "Fixed fraction problems on numbers\n\nSigned-off-by: Markus Eckhardt <github@familie-eckhardt.eu>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c14ba38663ea7cbdafaaa82fce721990e5db62ef", "author": {"user": {"login": "Markinus", "name": "Markus Eckhardt"}}, "url": "https://github.com/openhab/openhab-addons/commit/c14ba38663ea7cbdafaaa82fce721990e5db62ef", "committedDate": "2020-04-16T12:25:58Z", "message": "Disabled log entry\n\nSigned-off-by: Markus Eckhardt <github@familie-eckhardt.eu>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ff46638cc3db2f10d49f73cbbe3f370e37f4ffc", "author": {"user": {"login": "Markinus", "name": "Markus Eckhardt"}}, "url": "https://github.com/openhab/openhab-addons/commit/6ff46638cc3db2f10d49f73cbbe3f370e37f4ffc", "committedDate": "2020-04-16T17:49:52Z", "message": "Fixed sending of data\n\nSigned-off-by: Markus Eckhardt <github@familie-eckhardt.eu>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0OTA2NDA5", "url": "https://github.com/openhab/openhab-addons/pull/7393#pullrequestreview-394906409", "createdAt": "2020-04-16T18:45:14Z", "commit": {"oid": "6ff46638cc3db2f10d49f73cbbe3f370e37f4ffc"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxODo0NToxNFrOGGymYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxOToyMDo0OVrOGGzzHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc3MzY2NA==", "bodyText": "Please use empty string literals instead of creating a new string instance.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                protected String ip4Address = new String();\n          \n          \n            \n                protected String ip4Address = \"\";", "url": "https://github.com/openhab/openhab-addons/pull/7393#discussion_r409773664", "createdAt": "2020-04-16T18:45:14Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.km200/src/main/java/org/openhab/binding/km200/internal/KM200Device.java", "diffHunk": "@@ -32,60 +34,54 @@\n  *\n  * @author Markus Eckhardt - Initial contribution\n  */\n+@NonNullByDefault\n public class KM200Device {\n \n     private final Logger logger = LoggerFactory.getLogger(KM200Device.class);\n     private final JsonParser jsonParser = new JsonParser();\n     private final KM200Cryption comCryption;\n     private final KM200Comm<KM200Device> deviceCommunicator;\n \n-    /**\n-     * shared instance of HTTP client for asynchronous calls\n-     */\n-    private HttpClient httpClient;\n-\n     /* valid IPv4 address of the KMxxx. */\n-    protected String ip4Address;\n+    protected String ip4Address = new String();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ff46638cc3db2f10d49f73cbbe3f370e37f4ffc"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc4MTg4Mg==", "bodyText": "Since you are already using the apache library you can just use:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                protected byte[] cryptKeyInit = {};\n          \n          \n            \n                protected byte[] cryptKeyInit = ArrayUtils.EMPTY_BYTE_ARRAY;", "url": "https://github.com/openhab/openhab-addons/pull/7393#discussion_r409781882", "createdAt": "2020-04-16T18:59:54Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.km200/src/main/java/org/openhab/binding/km200/internal/KM200Device.java", "diffHunk": "@@ -32,60 +34,54 @@\n  *\n  * @author Markus Eckhardt - Initial contribution\n  */\n+@NonNullByDefault\n public class KM200Device {\n \n     private final Logger logger = LoggerFactory.getLogger(KM200Device.class);\n     private final JsonParser jsonParser = new JsonParser();\n     private final KM200Cryption comCryption;\n     private final KM200Comm<KM200Device> deviceCommunicator;\n \n-    /**\n-     * shared instance of HTTP client for asynchronous calls\n-     */\n-    private HttpClient httpClient;\n-\n     /* valid IPv4 address of the KMxxx. */\n-    protected String ip4Address;\n+    protected String ip4Address = new String();\n \n     /* The gateway password which is provided on the type sign of the KMxxx. */\n-    protected String gatewayPassword;\n+    protected String gatewayPassword = new String();\n \n     /* The private password which has been defined by the user via EasyControl. */\n-    protected String privatePassword;\n+    protected String privatePassword = new String();\n \n     /* The returned device charset for communication */\n-    protected String charSet;\n+    protected String charSet = new String();;\n \n     /* Needed keys for the communication */\n-    protected byte[] cryptKeyInit;\n-    protected byte[] cryptKeyPriv;\n+    protected byte[] cryptKeyInit = {};", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ff46638cc3db2f10d49f73cbbe3f370e37f4ffc"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc4MjUyMg==", "bodyText": "I suggest making valPara a StringBuilder instance instead since you do a lot of concatenation with it.", "url": "https://github.com/openhab/openhab-addons/pull/7393#discussion_r409782522", "createdAt": "2020-04-16T19:01:03Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.km200/src/main/java/org/openhab/binding/km200/internal/KM200Device.java", "diffHunk": "@@ -192,22 +194,20 @@ public void listAllServices() {\n      * @param actTreeMap\n      */\n     public void printAllServices(Map<String, KM200ServiceObject> actTreeMap) {\n-        if (actTreeMap != null) {\n-            for (KM200ServiceObject object : actTreeMap.values()) {\n-                if (object != null) {\n-                    String val = \"\", type, valPara = \"\";\n-                    logger.debug(\"List type: {} service: {}\", object.getServiceType(), object.getFullServiceName());\n-                    type = object.getServiceType();\n-                    if (type == null) {\n-                        type = new String();\n-                    }\n-                    if (\"stringValue\".equals(type) || \"floatValue\".equals(type)) {\n-                        val = object.getValue().toString();\n-                        if (object.getValueParameter() != null) {\n-                            if (\"stringValue\".equals(type)) {\n-                                // Type is definitely correct here\n-                                @SuppressWarnings(\"unchecked\")\n-                                List<String> valParas = (List<String>) object.getValueParameter();\n+        for (KM200ServiceObject object : actTreeMap.values()) {\n+            String val = \"\", type, valPara = \"\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ff46638cc3db2f10d49f73cbbe3f370e37f4ffc"}, "originalPosition": 145}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc4NDM0MA==", "bodyText": "Would it be possible to make type an enum instead of a string?", "url": "https://github.com/openhab/openhab-addons/pull/7393#discussion_r409784340", "createdAt": "2020-04-16T19:04:31Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.km200/src/main/java/org/openhab/binding/km200/internal/KM200Device.java", "diffHunk": "@@ -192,22 +194,20 @@ public void listAllServices() {\n      * @param actTreeMap\n      */\n     public void printAllServices(Map<String, KM200ServiceObject> actTreeMap) {\n-        if (actTreeMap != null) {\n-            for (KM200ServiceObject object : actTreeMap.values()) {\n-                if (object != null) {\n-                    String val = \"\", type, valPara = \"\";\n-                    logger.debug(\"List type: {} service: {}\", object.getServiceType(), object.getFullServiceName());\n-                    type = object.getServiceType();\n-                    if (type == null) {\n-                        type = new String();\n-                    }\n-                    if (\"stringValue\".equals(type) || \"floatValue\".equals(type)) {\n-                        val = object.getValue().toString();\n-                        if (object.getValueParameter() != null) {\n-                            if (\"stringValue\".equals(type)) {\n-                                // Type is definitely correct here\n-                                @SuppressWarnings(\"unchecked\")\n-                                List<String> valParas = (List<String>) object.getValueParameter();\n+        for (KM200ServiceObject object : actTreeMap.values()) {\n+            String val = \"\", type, valPara = \"\";\n+            logger.debug(\"List type: {} service: {}\", object.getServiceType(), object.getFullServiceName());\n+            type = object.getServiceType();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ff46638cc3db2f10d49f73cbbe3f370e37f4ffc"}, "originalPosition": 147}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc4NTI0Mg==", "bodyText": "This method should exit early if necessary logging levels are not enabled.", "url": "https://github.com/openhab/openhab-addons/pull/7393#discussion_r409785242", "createdAt": "2020-04-16T19:06:10Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.km200/src/main/java/org/openhab/binding/km200/internal/KM200Device.java", "diffHunk": "@@ -192,22 +194,20 @@ public void listAllServices() {\n      * @param actTreeMap\n      */\n     public void printAllServices(Map<String, KM200ServiceObject> actTreeMap) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ff46638cc3db2f10d49f73cbbe3f370e37f4ffc"}, "originalPosition": 127}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc4NTM2Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Nullable\n          \n          \n            \n                public KM200ServiceObject getServiceObject(String service) {\n          \n          \n            \n                public @Nullable KM200ServiceObject getServiceObject(String service) {", "url": "https://github.com/openhab/openhab-addons/pull/7393#discussion_r409785367", "createdAt": "2020-04-16T19:06:24Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.km200/src/main/java/org/openhab/binding/km200/internal/KM200Device.java", "diffHunk": "@@ -297,6 +294,7 @@ public Boolean containsService(String service) {\n      *\n      * @param service\n      */\n+    @Nullable\n     public KM200ServiceObject getServiceObject(String service) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ff46638cc3db2f10d49f73cbbe3f370e37f4ffc"}, "originalPosition": 227}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc4NTQ0OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Nullable\n          \n          \n            \n                public JsonObject getServiceNode(String service) {\n          \n          \n            \n                public @Nullable JsonObject getServiceNode(String service) {", "url": "https://github.com/openhab/openhab-addons/pull/7393#discussion_r409785448", "createdAt": "2020-04-16T19:06:35Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.km200/src/main/java/org/openhab/binding/km200/internal/KM200Device.java", "diffHunk": "@@ -328,6 +326,7 @@ public KM200ServiceObject getServiceObject(String service) {\n      * possible and a JSON node in opposide case.\n      *\n      */\n+    @Nullable\n     public JsonObject getServiceNode(String service) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ff46638cc3db2f10d49f73cbbe3f370e37f4ffc"}, "originalPosition": 235}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc4Njg3OQ==", "bodyText": "Instead of getting the httpClient reference through the set/unset methods you should instead have the HttpClientFactory passed in through the KM200HandlerFactory constructor; that way you can make the httpClient field non-null and final.", "url": "https://github.com/openhab/openhab-addons/pull/7393#discussion_r409786879", "createdAt": "2020-04-16T19:09:08Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.km200/src/main/java/org/openhab/binding/km200/internal/KM200HandlerFactory.java", "diffHunk": "@@ -57,12 +60,12 @@\n \n     private final Logger logger = LoggerFactory.getLogger(KM200HandlerFactory.class);\n \n-    private KM200ChannelTypeProvider channelTypeProvider;\n+    private @Nullable KM200ChannelTypeProvider channelTypeProvider;\n \n     /**\n      * shared instance of HTTP client for asynchronous calls\n      */\n-    private HttpClient httpClient;\n+    private @Nullable HttpClient httpClient;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ff46638cc3db2f10d49f73cbbe3f370e37f4ffc"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc4NzA5NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Nullable\n          \n          \n            \n                public Object getValue() {\n          \n          \n            \n                public @Nullable Object getValue() {", "url": "https://github.com/openhab/openhab-addons/pull/7393#discussion_r409787094", "createdAt": "2020-04-16T19:09:35Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.km200/src/main/java/org/openhab/binding/km200/internal/KM200ServiceObject.java", "diffHunk": "@@ -91,14 +93,17 @@ public String getFullServiceName() {\n         return fullServiceName;\n     }\n \n+    @Nullable\n     public Object getValue() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ff46638cc3db2f10d49f73cbbe3f370e37f4ffc"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc4NzQ3NQ==", "bodyText": "same here", "url": "https://github.com/openhab/openhab-addons/pull/7393#discussion_r409787475", "createdAt": "2020-04-16T19:10:18Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.km200/src/main/java/org/openhab/binding/km200/internal/KM200ServiceObject.java", "diffHunk": "@@ -91,14 +93,17 @@ public String getFullServiceName() {\n         return fullServiceName;\n     }\n \n+    @Nullable\n     public Object getValue() {\n         return value;\n     }\n \n+    @Nullable\n     public Object getValueParameter() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ff46638cc3db2f10d49f73cbbe3f370e37f4ffc"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc4NzY1Mw==", "bodyText": "and here, you get the idea. Please update all other methods similarly.", "url": "https://github.com/openhab/openhab-addons/pull/7393#discussion_r409787653", "createdAt": "2020-04-16T19:10:39Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.km200/src/main/java/org/openhab/binding/km200/internal/KM200ServiceObject.java", "diffHunk": "@@ -91,14 +93,17 @@ public String getFullServiceName() {\n         return fullServiceName;\n     }\n \n+    @Nullable\n     public Object getValue() {\n         return value;\n     }\n \n+    @Nullable\n     public Object getValueParameter() {\n         return valueParameter;\n     }\n \n+    @Nullable\n     public String getParent() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ff46638cc3db2f10d49f73cbbe3f370e37f4ffc"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc4ODk0OA==", "bodyText": "The error logging level should be reserved for issues catastrophic enough to threaten the operation of openHab itself. In error in a binding shouldn't qualify for this. Please read the openHab coding guidelines for expected use of logging in bindings.", "url": "https://github.com/openhab/openhab-addons/pull/7393#discussion_r409788948", "createdAt": "2020-04-16T19:13:06Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.km200/src/main/java/org/openhab/binding/km200/internal/discovery/KM200GatewayDiscoveryService.java", "diffHunk": "@@ -97,6 +99,10 @@ private void discoverDevices() {\n             if (gateway.getDevice().containsService(root)) {\n                 boolean enumOnly = true;\n                 KM200ServiceObject object = gateway.getDevice().getServiceObject(root);\n+                if (null == object) {\n+                    logger.error(\"No root service object found\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ff46638cc3db2f10d49f73cbbe3f370e37f4ffc"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc4OTczNQ==", "bodyText": "same here", "url": "https://github.com/openhab/openhab-addons/pull/7393#discussion_r409789735", "createdAt": "2020-04-16T19:14:25Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.km200/src/main/java/org/openhab/binding/km200/internal/discovery/KM200GatewayDiscoveryService.java", "diffHunk": "@@ -144,26 +154,31 @@ private void discoverDevices() {\n                                     currParaRepl = switchObject.serviceTreeMap.entrySet().iterator().next().getKey();\n                                 }\n                             }\n-\n-                            String posName = ((KM200SwitchProgramServiceHandler) switchObject.serviceTreeMap.entrySet()\n-                                    .iterator().next().getValue().getValueParameter()).getPositiveSwitch();\n-                            String negName = ((KM200SwitchProgramServiceHandler) switchObject.serviceTreeMap.entrySet()\n-                                    .iterator().next().getValue().getValueParameter()).getNegativeSwitch();\n-                            ThingUID subThingUID = new ThingUID(tType.getThingTypeUID(), bridgeUID,\n-                                    key + \"-switchprogram\");\n-                            Map<String, Object> subProperties = new HashMap<>(4);\n-                            subProperties.put(\"root\", KM200Utils.translatesPathToName(\n-                                    root + \"/\" + key + \"/\" + SWITCH_PROGRAM_PATH_NAME + \"/\" + currParaRepl));\n-                            subProperties.put(SWITCH_PROGRAM_CURRENT_PATH_NAME,\n-                                    KM200Utils.translatesPathToName(currentPathName));\n-                            subProperties.put(SWITCH_PROGRAM_POSITIVE, posName);\n-                            subProperties.put(SWITCH_PROGRAM_NEGATIVE, negName);\n-                            logger.debug(\"enum thingUID {} bridgeUID {} withLabel {} root {}\", thingUID, bridgeUID, key,\n-                                    root);\n-                            DiscoveryResult subDiscoveryResult = DiscoveryResultBuilder.create(subThingUID)\n-                                    .withBridge(bridgeUID).withLabel(key + \" switch program\")\n-                                    .withProperties(subProperties).build();\n-                            thingDiscovered(subDiscoveryResult);\n+                            KM200SwitchProgramServiceHandler valPara = (KM200SwitchProgramServiceHandler) switchObject.serviceTreeMap\n+                                    .entrySet().iterator().next().getValue().getValueParameter();\n+                            if (null != valPara) {\n+                                String posName = valPara.getPositiveSwitch();\n+                                String negName = valPara.getNegativeSwitch();\n+                                if (null == posName || null == negName) {\n+                                    logger.error(\"Service switches not found!\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ff46638cc3db2f10d49f73cbbe3f370e37f4ffc"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc5MDIzNQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                logger.warn(\"Serviceobject is not existing\");\n          \n          \n            \n                                logger.warn(\"Serviceobject does not exist\");", "url": "https://github.com/openhab/openhab-addons/pull/7393#discussion_r409790235", "createdAt": "2020-04-16T19:15:22Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.km200/src/main/java/org/openhab/binding/km200/internal/handler/KM200DataHandler.java", "diffHunk": "@@ -65,60 +70,82 @@ public State getProvidersState(String service, String itemType, Map<String, Stri\n             }\n             if (remoteDevice.containsService(service)) {\n                 object = remoteDevice.getServiceObject(service);\n+                if (null == object) {\n+                    logger.warn(\"Serviceobject is not existing\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ff46638cc3db2f10d49f73cbbe3f370e37f4ffc"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc5MDU5OA==", "bodyText": "don't log error", "url": "https://github.com/openhab/openhab-addons/pull/7393#discussion_r409790598", "createdAt": "2020-04-16T19:16:02Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.km200/src/main/java/org/openhab/binding/km200/internal/handler/KM200DataHandler.java", "diffHunk": "@@ -65,60 +70,82 @@ public State getProvidersState(String service, String itemType, Map<String, Stri\n             }\n             if (remoteDevice.containsService(service)) {\n                 object = remoteDevice.getServiceObject(service);\n+                if (null == object) {\n+                    logger.warn(\"Serviceobject is not existing\");\n+                    return null;\n+                }\n                 if (object.getReadable() == 0) {\n                     logger.warn(\"Service is listed as protected (reading is not possible): {}\", service);\n                     return null;\n                 }\n                 type = object.getServiceType();\n+                logger.debug(\"Type: {}\", type);\n             } else {\n                 logger.warn(\"Service is not in the determined device service list: {}\", service);\n                 return null;\n             }\n-            /* For using of virtual services only one receive on the parent service is needed */\n-            if (!object.getUpdated()\n-                    || (object.getVirtual() == 1 && !remoteDevice.getServiceObject(object.getParent()).getUpdated())) {\n-                if (object.getVirtual() == 1) {\n-                    logger.debug(\"Receive data for an virtual object\");\n-                    /* If it's a virtual service then receive the data from parent service */\n-                    jsonNode = remoteDevice.getServiceNode(object.getParent());\n-                } else {\n+            /* Needs to be updated? */\n+            if (object.getVirtual() == 0) {\n+                if (!object.getUpdated()) {\n                     logger.debug(\"Receive data\");\n                     jsonNode = remoteDevice.getServiceNode(service);\n-                }\n-\n-                if (jsonNode == null || jsonNode.isJsonNull()) {\n-                    logger.error(\"Communication is not possible!\");\n-                    return null;\n-                }\n-                if (object.getVirtual() == 1) {\n-                    remoteDevice.getServiceObject(object.getParent()).setJSONData(jsonNode);\n-                    remoteDevice.getServiceObject(object.getParent()).setUpdated(true);\n-                } else {\n+                    if (jsonNode == null || jsonNode.isJsonNull()) {\n+                        logger.error(\"Communication is not possible!\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ff46638cc3db2f10d49f73cbbe3f370e37f4ffc"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc5MTYxMQ==", "bodyText": "This is safer.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                        state = new DecimalType(((BigDecimal) bdVal).doubleValue());\n          \n          \n            \n                                        state = new DecimalType(((Number) bdVal).doubleValue());", "url": "https://github.com/openhab/openhab-addons/pull/7393#discussion_r409791611", "createdAt": "2020-04-16T19:17:53Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.km200/src/main/java/org/openhab/binding/km200/internal/handler/KM200DataHandler.java", "diffHunk": "@@ -190,9 +217,9 @@ public State parseJSONData(JsonObject nodeRoot, String type, String service, Str\n                     /* NumberItem Binding */\n                     if (\"Number\".equals(itemType)) {\n                         if (bdVal instanceof Double) { // Checking whether\n-                            state = new DecimalType(((Double) bdVal).floatValue());\n+                            state = new DecimalType((Double) bdVal);\n                         } else {\n-                            state = new DecimalType(((BigDecimal) bdVal).floatValue());\n+                            state = new DecimalType(((BigDecimal) bdVal).doubleValue());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ff46638cc3db2f10d49f73cbbe3f370e37f4ffc"}, "originalPosition": 172}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc5MzMwOA==", "bodyText": "Should probably make all these string literals constants", "url": "https://github.com/openhab/openhab-addons/pull/7393#discussion_r409793308", "createdAt": "2020-04-16T19:20:49Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.km200/src/main/java/org/openhab/binding/km200/internal/handler/KM200DataHandler.java", "diffHunk": "@@ -290,142 +335,137 @@ public State parseJSONData(JsonObject nodeRoot, String type, String service, Str\n     /**\n      * This function checks the virtual state of a service\n      */\n-    private State getVirtualState(KM200ServiceObject object, String itemType, String service) {\n+    private @Nullable State getVirtualState(KM200ServiceObject object, String itemType, String service) {\n         State state = null;\n         String type = object.getServiceType();\n-        logger.debug(\"Check virtual state of: {} type: {} item: {}\", service, type, itemType);\n-        switch (type) {\n-            case \"switchProgram\":\n-                KM200SwitchProgramServiceHandler sPService = ((KM200SwitchProgramServiceHandler) remoteDevice\n-                        .getServiceObject(object.getParent()).getValueParameter());\n-                String[] servicePath = service.split(\"/\");\n-                String virtService = servicePath[servicePath.length - 1];\n-                if (\"weekday\".equals(virtService)) {\n-                    if (\"String\".equals(itemType)) {\n-                        String val = sPService.getActiveDay();\n-                        if (val == null) {\n-                            return null;\n-                        }\n-                        state = new StringType(val);\n-                    } else {\n-                        logger.warn(\"Bindingtype not supported for day service: {}\", itemType.getClass());\n-                        return null;\n-                    }\n-                } else if (\"nbrCycles\".equals(virtService)) {\n-                    if (\"Number\".equals(itemType)) {\n-                        Integer val = sPService.getNbrCycles();\n-                        if (val == null) {\n-                            return null;\n-                        }\n-                        state = new DecimalType(val);\n-                    } else {\n-                        logger.warn(\"Bindingtype not supported for nbrCycles service: {}\", itemType.getClass());\n-                        return null;\n-                    }\n-                } else if (\"cycle\".equals(virtService)) {\n-                    if (\"Number\".equals(itemType)) {\n-                        Integer val = sPService.getActiveCycle();\n-                        if (val == null) {\n-                            return null;\n-                        }\n-                        state = new DecimalType(val);\n-                    } else {\n-                        logger.warn(\"Bindingtype not supported for cycle service: {}\", itemType.getClass());\n-                        return null;\n-                    }\n-                } else if (virtService.equals(sPService.getPositiveSwitch())) {\n-                    if (\"Number\".equals(itemType)) {\n-                        Integer val = sPService.getActivePositiveSwitch();\n-                        if (val == null) {\n-                            return null;\n-                        }\n-                        state = new DecimalType(val);\n-                    } else if (\"DateTime\".equals(itemType)) {\n-                        Integer val = sPService.getActivePositiveSwitch();\n-                        if (val == null) {\n-                            return null;\n-                        }\n-                        Calendar rightNow = Calendar.getInstance();\n-                        Integer hour = val % 60;\n-                        Integer minute = val - (hour * 60);\n-                        rightNow.set(Calendar.HOUR_OF_DAY, hour);\n-                        rightNow.set(Calendar.MINUTE, minute);\n-                        state = new DateTimeType(rightNow);\n-                    } else {\n-                        logger.warn(\"Bindingtype not supported for cycle service: {}\", itemType);\n-                        return null;\n-                    }\n-                } else if (virtService.equals(sPService.getNegativeSwitch())) {\n-                    if (\"Number\".equals(itemType)) {\n-                        Integer val = sPService.getActiveNegativeSwitch();\n-                        if (val == null) {\n-                            return null;\n-                        }\n-                        state = new DecimalType(val);\n-                    } else if (\"DateTime\".equals(itemType)) {\n-                        Integer val = sPService.getActiveNegativeSwitch();\n-                        if (val == null) {\n-                            return null;\n-                        }\n-                        Calendar rightNow = Calendar.getInstance();\n-                        Integer hour = val % 60;\n-                        Integer minute = val - (hour * 60);\n-                        rightNow.set(Calendar.HOUR_OF_DAY, hour);\n-                        rightNow.set(Calendar.MINUTE, minute);\n-                        state = new DateTimeType(rightNow);\n-                    } else {\n-                        logger.warn(\"Bindingtype not supported for cycle service: {}\", itemType.getClass());\n-                        return null;\n-                    }\n-                }\n-                break;\n-            case \"errorList\":\n-                KM200ErrorServiceHandler eService = ((KM200ErrorServiceHandler) remoteDevice\n-                        .getServiceObject(object.getParent()).getValueParameter());\n-                String[] nServicePath = service.split(\"/\");\n-                String nVirtService = nServicePath[nServicePath.length - 1];\n-                /* Go through the parameters and read the values */\n-                switch (nVirtService) {\n-                    case \"nbrErrors\":\n-                        if (\"Number\".equals(itemType)) {\n-                            Integer val = eService.getNbrErrors();\n-                            state = new DecimalType(val);\n-                        } else {\n-                            logger.warn(\"Bindingtype not supported for error number service: {}\", itemType.getClass());\n-                            return null;\n-                        }\n-                        break;\n-                    case \"error\":\n-                        if (\"Number\".equals(itemType)) {\n-                            Integer val = eService.getActiveError();\n-                            state = new DecimalType(val);\n+        String parent = object.getParent();\n+        if (null != parent) {\n+            KM200ServiceObject objParent = remoteDevice.getServiceObject(parent);\n+            if (null != objParent) {\n+                logger.debug(\"Check virtual state of: {} type: {} item: {}\", service, type, itemType);\n+                switch (type) {\n+                    case \"switchProgram\":\n+                        KM200SwitchProgramServiceHandler sPService = ((KM200SwitchProgramServiceHandler) objParent\n+                                .getValueParameter());\n+                        if (null != sPService) {\n+                            String[] servicePath = service.split(\"/\");\n+                            String virtService = servicePath[servicePath.length - 1];\n+                            if (\"weekday\".equals(virtService)) {\n+                                if (\"String\".equals(itemType)) {\n+                                    String actDay = sPService.getActiveDay();\n+                                    state = new StringType(actDay);\n+                                } else {\n+                                    logger.warn(\"Bindingtype not supported for day service: {}\", itemType.getClass());\n+                                    return null;\n+                                }\n+                            } else if (\"nbrCycles\".equals(virtService)) {\n+                                if (\"Number\".equals(itemType)) {\n+                                    Integer nbrCycles = sPService.getNbrCycles();\n+                                    state = new DecimalType(nbrCycles);\n+                                } else {\n+                                    logger.warn(\"Bindingtype not supported for nbrCycles service: {}\",\n+                                            itemType.getClass());\n+                                    return null;\n+                                }\n+                            } else if (\"cycle\".equals(virtService)) {\n+                                if (\"Number\".equals(itemType)) {\n+                                    Integer cycle = sPService.getActiveCycle();\n+                                    state = new DecimalType(cycle);\n+                                } else {\n+                                    logger.warn(\"Bindingtype not supported for cycle service: {}\", itemType.getClass());\n+                                    return null;\n+                                }\n+                            } else if (virtService.equals(sPService.getPositiveSwitch())) {\n+                                if (\"Number\".equals(itemType)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ff46638cc3db2f10d49f73cbbe3f370e37f4ffc"}, "originalPosition": 455}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85027749e66a2abdfc145b00e2930d2a32881495", "author": {"user": {"login": "Markinus", "name": "Markus Eckhardt"}}, "url": "https://github.com/openhab/openhab-addons/commit/85027749e66a2abdfc145b00e2930d2a32881495", "committedDate": "2020-04-17T16:42:43Z", "message": "Added constants for data types\nUsing constants for item types\nSmall changes and bugfixes\n\nSigned-off-by: Markus Eckhardt <github@familie-eckhardt.eu>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d81a15123675c432cdc03c53613d66e2b0ce902b", "author": {"user": {"login": "Markinus", "name": "Markus Eckhardt"}}, "url": "https://github.com/openhab/openhab-addons/commit/d81a15123675c432cdc03c53613d66e2b0ce902b", "committedDate": "2020-04-17T05:40:47Z", "message": "Update bundles/org.openhab.binding.km200/src/main/java/org/openhab/binding/km200/internal/KM200Device.java\n\nCo-Authored-By: cpmeister <mistercpp2000@gmail.com>"}, "afterCommit": {"oid": "85027749e66a2abdfc145b00e2930d2a32881495", "author": {"user": {"login": "Markinus", "name": "Markus Eckhardt"}}, "url": "https://github.com/openhab/openhab-addons/commit/85027749e66a2abdfc145b00e2930d2a32881495", "committedDate": "2020-04-17T16:42:43Z", "message": "Added constants for data types\nUsing constants for item types\nSmall changes and bugfixes\n\nSigned-off-by: Markus Eckhardt <github@familie-eckhardt.eu>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a67b5e511dd5cbcc7f0bd30ad98a2c72890789a2", "author": {"user": {"login": "Markinus", "name": "Markus Eckhardt"}}, "url": "https://github.com/openhab/openhab-addons/commit/a67b5e511dd5cbcc7f0bd30ad98a2c72890789a2", "committedDate": "2020-04-17T17:58:38Z", "message": "Changed the httpClientFactory interface from set/uset to constructor.\n\nSigned-off-by: Markus Eckhardt <github@familie-eckhardt.eu>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1Njg5NTgz", "url": "https://github.com/openhab/openhab-addons/pull/7393#pullrequestreview-395689583", "createdAt": "2020-04-17T18:41:24Z", "commit": {"oid": "a67b5e511dd5cbcc7f0bd30ad98a2c72890789a2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxODo0MToyNFrOGHZHJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxOTowNTozN1rOGHZ1KQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQwNDY0NQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private HttpClient httpClient;\n          \n          \n            \n                private final HttpClient httpClient;", "url": "https://github.com/openhab/openhab-addons/pull/7393#discussion_r410404645", "createdAt": "2020-04-17T18:41:24Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.km200/src/main/java/org/openhab/binding/km200/internal/KM200HandlerFactory.java", "diffHunk": "@@ -57,13 +61,18 @@\n \n     private final Logger logger = LoggerFactory.getLogger(KM200HandlerFactory.class);\n \n-    private KM200ChannelTypeProvider channelTypeProvider;\n+    private @Nullable KM200ChannelTypeProvider channelTypeProvider;\n \n     /**\n      * shared instance of HTTP client for asynchronous calls\n      */\n     private HttpClient httpClient;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a67b5e511dd5cbcc7f0bd30ad98a2c72890789a2"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQwNDg1Mg==", "bodyText": "You can get this one in the constructor too", "url": "https://github.com/openhab/openhab-addons/pull/7393#discussion_r410404852", "createdAt": "2020-04-17T18:41:55Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.km200/src/main/java/org/openhab/binding/km200/internal/KM200HandlerFactory.java", "diffHunk": "@@ -57,13 +61,18 @@\n \n     private final Logger logger = LoggerFactory.getLogger(KM200HandlerFactory.class);\n \n-    private KM200ChannelTypeProvider channelTypeProvider;\n+    private @Nullable KM200ChannelTypeProvider channelTypeProvider;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a67b5e511dd5cbcc7f0bd30ad98a2c72890789a2"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQxMDkyNw==", "bodyText": "Any time you create your own threadpool in a binding you should make sure that theadpool gives the threads names that identify this binding as the creator. Also make sure that the created threads are daemon.\nUsing a NamedThreadFactory can accomplish this just make sure to replace ... with the prefix for your thread names.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    executor = Executors.newScheduledThreadPool(2);\n          \n          \n            \n                    executor = Executors.newScheduledThreadPool(2, new NamedThreadFactory(...,true));\n          \n      \n    \n    \n  \n\nThat said, I do have to ask why aren't you using the scheduler instead?", "url": "https://github.com/openhab/openhab-addons/pull/7393#discussion_r410410927", "createdAt": "2020-04-17T18:53:55Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.km200/src/main/java/org/openhab/binding/km200/internal/handler/KM200GatewayHandler.java", "diffHunk": "@@ -76,37 +79,37 @@\n     /**\n      * shared instance of HTTP client for (a)synchronous calls\n      */\n-    private HttpClient httpClient;\n-\n-    private ScheduledExecutorService executor = Executors.newScheduledThreadPool(2);\n+    private ScheduledExecutorService executor;\n     private final KM200Device remoteDevice;\n     private final KM200DataHandler dataHandler;\n     private int readDelay;\n     private int refreshInterval;\n \n     public KM200GatewayHandler(Bridge bridge, HttpClient httpClient) {\n         super(bridge);\n-        this.httpClient = httpClient;\n         refreshInterval = 120;\n         readDelay = 100;\n         updateStatus(ThingStatus.UNINITIALIZED, ThingStatusDetail.CONFIGURATION_PENDING);\n         remoteDevice = new KM200Device(httpClient);\n         dataHandler = new KM200DataHandler(remoteDevice);\n+        executor = Executors.newScheduledThreadPool(2);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a67b5e511dd5cbcc7f0bd30ad98a2c72890789a2"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQxMTAwNw==", "bodyText": "see above", "url": "https://github.com/openhab/openhab-addons/pull/7393#discussion_r410411007", "createdAt": "2020-04-17T18:54:06Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.km200/src/main/java/org/openhab/binding/km200/internal/handler/KM200GatewayHandler.java", "diffHunk": "@@ -122,10 +125,11 @@ public void initialize() {\n                 return;\n             }\n \n-            if (getDevice() != null) {\n-                logger.debug(\"Starting send and receive executor\");\n-                SendKM200Runnable sendRunnable = new SendKM200Runnable(sendMap, getDevice());\n-                GetKM200Runnable receivingRunnable = new GetKM200Runnable(sendMap, this, getDevice());\n+            logger.debug(\"Starting send and receive executor\");\n+            SendKM200Runnable sendRunnable = new SendKM200Runnable(sendMap, getDevice());\n+            GetKM200Runnable receivingRunnable = new GetKM200Runnable(sendMap, this, getDevice());\n+            if (!executor.isTerminated()) {\n+                executor = Executors.newScheduledThreadPool(2);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a67b5e511dd5cbcc7f0bd30ad98a2c72890789a2"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQxMTcwMA==", "bodyText": "please remove all the blank lines after your break statements.", "url": "https://github.com/openhab/openhab-addons/pull/7393#discussion_r410411700", "createdAt": "2020-04-17T18:55:37Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.km200/src/main/java/org/openhab/binding/km200/internal/handler/KM200ServiceHandler.java", "diffHunk": "@@ -91,142 +96,143 @@ public void createServiceObject() {\n             recordable = val;\n         }\n         logger.debug(\"Typ: {}\", type);\n-        serviceObject = new KM200ServiceObject(id, type, readable, writeable, recordable, 0, null, parent);\n+        serviceObject = new KM200ServiceObject(id, type, readable, writeable, recordable, 0, null);\n         serviceObject.setJSONData(nodeRoot);\n+        return serviceObject;\n     }\n \n     /**\n      * This function determines the service's capabilities\n      */\n-    public void determineServiceObject() {\n+    public void determineServiceObject(KM200ServiceObject serviceObject, JsonObject nodeRoot) {\n         /* Check the service features and set the flags */\n         String id = null;\n         Object valObject = null;\n         JsonObject dataObject = serviceObject.getJSONData();\n-        switch (serviceObject.getServiceType()) {\n-            case \"stringValue\": /*\n-                                 * Check whether the type is a single value containing a\n-                                 * string value\n-                                 */\n-                logger.debug(\"initDevice: type string value: {}\", dataObject);\n-                valObject = new String(nodeRoot.get(\"value\").getAsString());\n-                serviceObject.setValue(valObject);\n-                if (nodeRoot.has(\"allowedValues\")) {\n-                    List<String> valParas = new ArrayList<>();\n-                    JsonArray paras = nodeRoot.get(\"allowedValues\").getAsJsonArray();\n-                    for (int i = 0; i < paras.size(); i++) {\n-                        String subJSON = paras.get(i).getAsString();\n-                        valParas.add(subJSON);\n-                    }\n-                    serviceObject.setValueParameter(valParas);\n-                }\n-                break;\n-\n-            case \"floatValue\": /* Check whether the type is a single value containing a float value */\n-                logger.debug(\"initDevice: type float value: {}\", dataObject);\n-                valObject = nodeRoot.get(\"value\");\n-                try {\n-                    valObject = nodeRoot.get(\"value\").getAsBigDecimal();\n+        if (null != dataObject) {\n+            switch (serviceObject.getServiceType()) {\n+                case DATA_TYPE_STRING_VALUE: /*\n+                                              * Check whether the type is a single value containing a\n+                                              * string value\n+                                              */\n+                    logger.debug(\"initDevice: type string value: {}\", dataObject);\n+                    valObject = new String(nodeRoot.get(\"value\").getAsString());\n                     serviceObject.setValue(valObject);\n-                } catch (NumberFormatException e) {\n-                    logger.debug(\"float value is a string: {}\", valObject);\n-                    Double tmpObj = Double.NaN;\n-                    serviceObject.setValue(tmpObj);\n-                }\n-                if (nodeRoot.has(\"minValue\") && nodeRoot.has(\"maxValue\")) {\n-                    List<Object> valParas = new ArrayList<>();\n-                    valParas.add(nodeRoot.get(\"minValue\").getAsBigDecimal());\n-                    valParas.add(nodeRoot.get(\"maxValue\").getAsBigDecimal());\n-                    if (nodeRoot.has(\"unitOfMeasure\")) {\n-                        valParas.add(nodeRoot.get(\"unitOfMeasure\").getAsString());\n+                    if (nodeRoot.has(\"allowedValues\")) {\n+                        List<String> valParas = new ArrayList<>();\n+                        JsonArray paras = nodeRoot.get(\"allowedValues\").getAsJsonArray();\n+                        for (int i = 0; i < paras.size(); i++) {\n+                            String subJSON = paras.get(i).getAsString();\n+                            valParas.add(subJSON);\n+                        }\n+                        serviceObject.setValueParameter(valParas);\n+                    }\n+                    break;\n+\n+                case DATA_TYPE_FLOAT_VALUE: /* Check whether the type is a single value containing a float value */\n+                    logger.debug(\"initDevice: type float value: {}\", dataObject);\n+                    valObject = nodeRoot.get(\"value\");\n+                    try {\n+                        valObject = nodeRoot.get(\"value\").getAsBigDecimal();\n+                        serviceObject.setValue(valObject);\n+                    } catch (NumberFormatException e) {\n+                        logger.debug(\"float value is a string: {}\", valObject);\n+                        Double tmpObj = Double.NaN;\n+                        serviceObject.setValue(tmpObj);\n+                    }\n+                    if (nodeRoot.has(\"minValue\") && nodeRoot.has(\"maxValue\")) {\n+                        List<Object> valParas = new ArrayList<>();\n+                        valParas.add(nodeRoot.get(\"minValue\").getAsBigDecimal());\n+                        valParas.add(nodeRoot.get(\"maxValue\").getAsBigDecimal());\n+                        if (nodeRoot.has(\"unitOfMeasure\")) {\n+                            valParas.add(nodeRoot.get(\"unitOfMeasure\").getAsString());\n+                        }\n+                        serviceObject.setValueParameter(valParas);\n                     }\n-                    serviceObject.setValueParameter(valParas);\n-                }\n-                break;\n-\n-            case \"switchProgram\": /* Check whether the type is a switchProgram */\n-                logger.debug(\"initDevice: type switchProgram {}\", dataObject);\n-                KM200SwitchProgramServiceHandler sPService = new KM200SwitchProgramServiceHandler();\n-                sPService.setMaxNbOfSwitchPoints(nodeRoot.get(\"maxNbOfSwitchPoints\").getAsInt());\n-                sPService.setMaxNbOfSwitchPointsPerDay(nodeRoot.get(\"maxNbOfSwitchPointsPerDay\").getAsInt());\n-                sPService.setSwitchPointTimeRaster(nodeRoot.get(\"switchPointTimeRaster\").getAsInt());\n-                JsonObject propObject = nodeRoot.get(\"setpointProperty\").getAsJsonObject();\n-                sPService.setSetpointProperty(propObject.get(\"id\").getAsString());\n-                serviceObject.setValueParameter(sPService);\n-                serviceObject.setJSONData(dataObject);\n-                remoteDevice.virtualList.add(serviceObject);\n-                break;\n-\n-            case \"errorList\": /* Check whether the type is a errorList */\n-                logger.debug(\"initDevice: type errorList: {}\", dataObject);\n-                KM200ErrorServiceHandler eService = new KM200ErrorServiceHandler();\n-                eService.updateErrors(nodeRoot);\n-                serviceObject.setValueParameter(eService);\n-                serviceObject.setJSONData(dataObject);\n-                remoteDevice.virtualList.add(serviceObject);\n-                break;\n-\n-            case \"refEnum\": /* Check whether the type is a refEnum */\n-                logger.debug(\"initDevice: type refEnum: {}\", dataObject);\n-                JsonArray refers = nodeRoot.get(\"references\").getAsJsonArray();\n-                for (int i = 0; i < refers.size(); i++) {\n-                    JsonObject subJSON = refers.get(i).getAsJsonObject();\n-                    id = subJSON.get(\"id\").getAsString();\n-                    KM200ServiceHandler serviceHandler = new KM200ServiceHandler(id, serviceObject, remoteDevice);\n-                    serviceHandler.initObject();\n-\n-                }\n-                break;\n-\n-            case \"moduleList\": /* Check whether the type is a moduleList */\n-                logger.debug(\"initDevice: type moduleList: {}\", dataObject);\n-                JsonArray vals = nodeRoot.get(\"values\").getAsJsonArray();\n-                for (int i = 0; i < vals.size(); i++) {\n-                    JsonObject subJSON = vals.get(i).getAsJsonObject();\n-                    id = subJSON.get(\"id\").getAsString();\n-                    KM200ServiceHandler serviceHandler = new KM200ServiceHandler(id, serviceObject, remoteDevice);\n-                    serviceHandler.initObject();\n-                }\n-                break;\n-\n-            case \"yRecording\": /* Check whether the type is a yRecording */\n-                logger.debug(\"initDevice: type yRecording: {}\", dataObject);\n-                /* have to be completed */\n-                break;\n-\n-            case \"systeminfo\": /* Check whether the type is a systeminfo */\n-                logger.debug(\"initDevice: type systeminfo: {}\", dataObject);\n-                JsonArray sInfo = nodeRoot.get(\"values\").getAsJsonArray();\n-                serviceObject.setValue(sInfo);\n-                /* have to be completed */\n-                break;\n-            case \"arrayData\":\n-                logger.debug(\"initDevice: type arrayData: {}\", dataObject);\n-                serviceObject.setJSONData(dataObject);\n-                /* have to be completed */\n-                break;\n-\n-            case \"eMonitoringList\":\n-                logger.debug(\"initDevice: type eMonitoringList: {}\", dataObject);\n-                serviceObject.setJSONData(dataObject);\n-                /* have to be completed */\n-                break;\n-\n-            case \"$$PROTECTED$$\":\n-                logger.debug(\"initDevice: readonly\");\n-                serviceObject.setJSONData(dataObject);\n-                break;\n-\n-            default: /* Unknown type */\n-                logger.info(\"initDevice: type: {} unknown for service: {} Data: {}\", serviceObject.getServiceType(),\n-                        service, dataObject);\n+                    break;\n+\n+                case DATA_TYPE_SWITCH_PROGRAM: /* Check whether the type is a switchProgram */\n+                    logger.debug(\"initDevice: type switchProgram {}\", dataObject);\n+                    KM200SwitchProgramServiceHandler sPService = new KM200SwitchProgramServiceHandler();\n+                    sPService.setMaxNbOfSwitchPoints(nodeRoot.get(\"maxNbOfSwitchPoints\").getAsInt());\n+                    sPService.setMaxNbOfSwitchPointsPerDay(nodeRoot.get(\"maxNbOfSwitchPointsPerDay\").getAsInt());\n+                    sPService.setSwitchPointTimeRaster(nodeRoot.get(\"switchPointTimeRaster\").getAsInt());\n+                    JsonObject propObject = nodeRoot.get(\"setpointProperty\").getAsJsonObject();\n+                    sPService.setSetpointProperty(propObject.get(\"id\").getAsString());\n+                    serviceObject.setValueParameter(sPService);\n+                    serviceObject.setJSONData(dataObject);\n+                    remoteDevice.virtualList.add(serviceObject);\n+                    break;\n+\n+                case DATA_TYPE_ERROR_LIST: /* Check whether the type is a errorList */\n+                    logger.debug(\"initDevice: type errorList: {}\", dataObject);\n+                    KM200ErrorServiceHandler eService = new KM200ErrorServiceHandler();\n+                    eService.updateErrors(nodeRoot);\n+                    serviceObject.setValueParameter(eService);\n+                    serviceObject.setJSONData(dataObject);\n+                    remoteDevice.virtualList.add(serviceObject);\n+                    break;\n+\n+                case DATA_TYPE_REF_ENUM: /* Check whether the type is a refEnum */\n+                    logger.debug(\"initDevice: type refEnum: {}\", dataObject);\n+                    JsonArray refers = nodeRoot.get(\"references\").getAsJsonArray();\n+                    for (int i = 0; i < refers.size(); i++) {\n+                        JsonObject subJSON = refers.get(i).getAsJsonObject();\n+                        id = subJSON.get(\"id\").getAsString();\n+                        KM200ServiceHandler serviceHandler = new KM200ServiceHandler(id, serviceObject, remoteDevice);\n+                        serviceHandler.initObject();\n+                    }\n+                    break;\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a67b5e511dd5cbcc7f0bd30ad98a2c72890789a2"}, "originalPosition": 285}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQxMjgwNA==", "bodyText": "Why is a static field getting populated by a constructor? Please do this in a static{...} block instead.", "url": "https://github.com/openhab/openhab-addons/pull/7393#discussion_r410412804", "createdAt": "2020-04-17T18:57:54Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.km200/src/main/java/org/openhab/binding/km200/internal/handler/KM200SwitchProgramServiceHandler.java", "diffHunk": "@@ -57,32 +60,29 @@\n     private Integer activeCycle = 1;\n \n     /* Night- and daylist for all weekdays */\n-    public Map<String, Map<String, List<Integer>>> switchMap;\n+    public Map<String, Map<String, List<Integer>>> switchMap = new HashMap<>();\n \n     /* List with all days */\n-    private List<String> days;\n-    public static List<StateOption> daysList;\n+    private List<String> days = new ArrayList<>();\n+    public static List<StateOption> daysList = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a67b5e511dd5cbcc7f0bd30ad98a2c72890789a2"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQxMzk1Mw==", "bodyText": "Once you make the KM200ChannelTypeProvider non-null and final in the ThingHandlerFactory then you should be able to make the non-null again.", "url": "https://github.com/openhab/openhab-addons/pull/7393#discussion_r410413953", "createdAt": "2020-04-17T19:00:15Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.km200/src/main/java/org/openhab/binding/km200/internal/handler/KM200ThingHandler.java", "diffHunk": "@@ -65,28 +67,22 @@\n  *\n  * @author Markus Eckhardt - Initial contribution\n  */\n+@NonNullByDefault\n public class KM200ThingHandler extends BaseThingHandler {\n \n     private final Logger logger = LoggerFactory.getLogger(KM200ThingHandler.class);\n-    private static URI configDescriptionUriChannel;\n \n     public static final Set<ThingTypeUID> SUPPORTED_THING_TYPES_UIDS = Collections.unmodifiableSet(Stream\n             .of(THING_TYPE_DHW_CIRCUIT, THING_TYPE_HEATING_CIRCUIT, THING_TYPE_SOLAR_CIRCUIT, THING_TYPE_HEAT_SOURCE,\n                     THING_TYPE_SYSTEM_APPLIANCE, THING_TYPE_SYSTEM_HOLIDAYMODES, THING_TYPE_SYSTEM_SENSOR,\n                     THING_TYPE_GATEWAY, THING_TYPE_NOTIFICATION, THING_TYPE_SYSTEM, THING_TYPE_SYSTEMSTATES)\n             .collect(Collectors.toSet()));\n \n-    private KM200ChannelTypeProvider channelTypeProvider;\n+    private @Nullable KM200ChannelTypeProvider channelTypeProvider;\n \n-    public KM200ThingHandler(Thing thing, KM200ChannelTypeProvider channelTypeProvider) {\n+    public KM200ThingHandler(Thing thing, @Nullable KM200ChannelTypeProvider channelTypeProvider) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a67b5e511dd5cbcc7f0bd30ad98a2c72890789a2"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQxNDgxNw==", "bodyText": "Please don't log as error", "url": "https://github.com/openhab/openhab-addons/pull/7393#discussion_r410414817", "createdAt": "2020-04-17T19:02:12Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.km200/src/main/java/org/openhab/binding/km200/internal/handler/KM200ThingHandler.java", "diffHunk": "@@ -233,22 +256,34 @@ public void initialize() {\n                         new ChannelUID(thing.getUID(), \"weekday\"), service + \"/\" + \"weekday\", CoreItemFactory.STRING,\n                         currentPathName, \"Current selected weekday for cycle selection\", \"Weekday\", true, true, state,\n                         \"\");\n-                subChannels.add(newChannel);\n+                if (null == newChannel) {\n+                    logger.error(\"Creation of the channel {} was niot possible\", thing.getUID());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a67b5e511dd5cbcc7f0bd30ad98a2c72890789a2"}, "originalPosition": 176}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQxNDkyNg==", "bodyText": "don't log as error", "url": "https://github.com/openhab/openhab-addons/pull/7393#discussion_r410414926", "createdAt": "2020-04-17T19:02:27Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.km200/src/main/java/org/openhab/binding/km200/internal/handler/KM200ThingHandler.java", "diffHunk": "@@ -233,22 +256,34 @@ public void initialize() {\n                         new ChannelUID(thing.getUID(), \"weekday\"), service + \"/\" + \"weekday\", CoreItemFactory.STRING,\n                         currentPathName, \"Current selected weekday for cycle selection\", \"Weekday\", true, true, state,\n                         \"\");\n-                subChannels.add(newChannel);\n+                if (null == newChannel) {\n+                    logger.error(\"Creation of the channel {} was niot possible\", thing.getUID());\n+                } else {\n+                    subChannels.add(newChannel);\n+                }\n \n                 state = StateDescriptionFragmentBuilder.create().withMinimum(BigDecimal.ZERO).withStep(BigDecimal.ONE)\n                         .withPattern(\"%d\").withReadOnly(true).build();\n                 newChannel = createChannel(new ChannelTypeUID(thing.getUID().getAsString() + \":\" + \"nbrCycles\"),\n                         new ChannelUID(thing.getUID(), \"nbrCycles\"), service + \"/\" + \"nbrCycles\",\n                         CoreItemFactory.NUMBER, currentPathName, \"Number of switching cycles\", \"Number\", true, true,\n                         state, \"\");\n-                subChannels.add(newChannel);\n+                if (null == newChannel) {\n+                    logger.error(\"Creation of the channel {} was niot possible\", thing.getUID());\n+                } else {\n+                    subChannels.add(newChannel);\n+                }\n \n                 state = StateDescriptionFragmentBuilder.create().withMinimum(BigDecimal.ZERO).withStep(BigDecimal.ONE)\n                         .withPattern(\"%d\").build();\n                 newChannel = createChannel(new ChannelTypeUID(thing.getUID().getAsString() + \":\" + \"cycle\"),\n                         new ChannelUID(thing.getUID(), \"cycle\"), service + \"/\" + \"cycle\", CoreItemFactory.NUMBER,\n                         currentPathName, \"Current selected cycle\", \"Cycle\", true, true, state, \"\");\n-                subChannels.add(newChannel);\n+                if (null == newChannel) {\n+                    logger.error(\"Creation of the channel {} was niot possible\", thing.getUID());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a67b5e511dd5cbcc7f0bd30ad98a2c72890789a2"}, "originalPosition": 201}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQxNDk3OA==", "bodyText": "here too", "url": "https://github.com/openhab/openhab-addons/pull/7393#discussion_r410414978", "createdAt": "2020-04-17T19:02:33Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.km200/src/main/java/org/openhab/binding/km200/internal/handler/KM200ThingHandler.java", "diffHunk": "@@ -257,14 +292,22 @@ public void initialize() {\n                         new ChannelUID(thing.getUID(), posName), service + \"/\" + posName, CoreItemFactory.NUMBER,\n                         currentPathName, \"Positive switch of the cycle, like 'Day' 'On'\", posName, true, true, state,\n                         \"minutes\");\n-                subChannels.add(newChannel);\n+                if (null == newChannel) {\n+                    logger.error(\"Creation of the channel {} was niot possible\", thing.getUID());\n+                } else {\n+                    subChannels.add(newChannel);\n+                }\n \n                 String negName = thing.getProperties().get(SWITCH_PROGRAM_NEGATIVE);\n                 newChannel = createChannel(new ChannelTypeUID(thing.getUID().getAsString() + \":\" + negName),\n                         new ChannelUID(thing.getUID(), negName), service + \"/\" + negName, CoreItemFactory.NUMBER,\n                         currentPathName, \"Negative switch of the cycle, like 'Night' 'Off'\", negName, true, true, state,\n                         \"minutes\");\n-                subChannels.add(newChannel);\n+                if (null == newChannel) {\n+                    logger.error(\"Creation of the channel {} was niot possible\", thing.getUID());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a67b5e511dd5cbcc7f0bd30ad98a2c72890789a2"}, "originalPosition": 226}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQxNTE4Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                            if (\"C\".compareTo(unitOfMeasure) == 0) {\n          \n          \n            \n                                            if (\"C\".equals(unitOfMeasure)) {", "url": "https://github.com/openhab/openhab-addons/pull/7393#discussion_r410415182", "createdAt": "2020-04-17T19:02:58Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.km200/src/main/java/org/openhab/binding/km200/internal/handler/KM200ThingHandler.java", "diffHunk": "@@ -384,15 +433,17 @@ private void addChannels(KM200ServiceObject serObj, Thing thing, List<Channel> s\n                         // The type is definitely correct here\n                         @SuppressWarnings(\"unchecked\")\n                         List<Object> subValParas = (List<Object>) serObj.serviceTreeMap.get(subKey).getValueParameter();\n-                        minVal = (BigDecimal) subValParas.get(0);\n-                        maxVal = (BigDecimal) subValParas.get(1);\n-                        if (subValParas.size() > 2) {\n-                            unitOfMeasure = (String) subValParas.get(2);\n-                            if (\"C\".compareTo(unitOfMeasure) == 0) {\n-                                unitOfMeasure = \"\u00b0C\";\n+                        if (null != subValParas) {\n+                            minVal = (BigDecimal) subValParas.get(0);\n+                            maxVal = (BigDecimal) subValParas.get(1);\n+                            if (subValParas.size() > 2) {\n+                                unitOfMeasure = (String) subValParas.get(2);\n+                                if (\"C\".compareTo(unitOfMeasure) == 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a67b5e511dd5cbcc7f0bd30ad98a2c72890789a2"}, "originalPosition": 294}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQxNjIyMg==", "bodyText": "Why are you sleeping in a synchronized block? Or better question, why do you need to sleep the thread?", "url": "https://github.com/openhab/openhab-addons/pull/7393#discussion_r410416222", "createdAt": "2020-04-17T19:05:11Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.km200/src/main/java/org/openhab/binding/km200/internal/handler/KM200GatewayHandler.java", "diffHunk": "@@ -405,35 +440,36 @@ private void updateChildren(Map<Channel, JsonObject> sendMap, KM200GatewayHandle\n                         continue;\n                     }\n                     String tmpService = KM200Utils.checkParameterReplacement(actChannel, remoteDevice);\n-                    if (parent == null || parent.equals(remoteDevice.getServiceObject(tmpService).getParent())) {\n-                        synchronized (sendMap) {\n-                            if (sendMap.containsKey(actChannel)) {\n-                                state = dataHandler.parseJSONData(sendMap.get(actChannel),\n-                                        remoteDevice.getServiceObject(tmpService).getServiceType(), tmpService,\n-                                        actChannel.getAcceptedItemType(),\n-                                        KM200Utils.getChannelConfigurationStrings(actChannel));\n-                            } else {\n-                                state = dataHandler.getProvidersState(tmpService, actChannel.getAcceptedItemType(),\n-                                        KM200Utils.getChannelConfigurationStrings(actChannel));\n+                    KM200ServiceObject tmpSerObjekt = remoteDevice.getServiceObject(tmpService);\n+                    if (null != tmpSerObjekt) {\n+                        if (parent == null || parent.equals(tmpSerObjekt.getParent())) {\n+                            synchronized (sendMap) {\n+                                if (sendMap.containsKey(actChannel)) {\n+                                    state = dataHandler.parseJSONData(sendMap.get(actChannel),\n+                                            tmpSerObjekt.getServiceType(), tmpService, actChTypes,\n+                                            KM200Utils.getChannelConfigurationStrings(actChannel));\n+                                } else {\n+                                    state = dataHandler.getProvidersState(tmpService, actChTypes,\n+                                            KM200Utils.getChannelConfigurationStrings(actChannel));\n+                                }\n                             }\n-                        }\n-                        if (state != null) {\n-                            try {\n-                                gatewayHandler.updateState(actChannel.getUID(), state);\n-                            } catch (IllegalStateException e) {\n-                                logger.error(\"Could not get updated item state\", e);\n+                            if (state != null) {\n+                                try {\n+                                    gatewayHandler.updateState(actChannel.getUID(), state);\n+                                } catch (IllegalStateException e) {\n+                                    logger.error(\"Could not get updated item state\", e);\n+                                }\n                             }\n                         }\n-                    }\n-                    try {\n-                        Thread.sleep(readDelay);\n-                    } catch (InterruptedException e) {\n-                        continue;\n+                        try {\n+                            Thread.sleep(readDelay);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a67b5e511dd5cbcc7f0bd30ad98a2c72890789a2"}, "originalPosition": 314}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQxNjI4MQ==", "bodyText": "don't log as error", "url": "https://github.com/openhab/openhab-addons/pull/7393#discussion_r410416281", "createdAt": "2020-04-17T19:05:18Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.km200/src/main/java/org/openhab/binding/km200/internal/handler/KM200GatewayHandler.java", "diffHunk": "@@ -405,35 +440,36 @@ private void updateChildren(Map<Channel, JsonObject> sendMap, KM200GatewayHandle\n                         continue;\n                     }\n                     String tmpService = KM200Utils.checkParameterReplacement(actChannel, remoteDevice);\n-                    if (parent == null || parent.equals(remoteDevice.getServiceObject(tmpService).getParent())) {\n-                        synchronized (sendMap) {\n-                            if (sendMap.containsKey(actChannel)) {\n-                                state = dataHandler.parseJSONData(sendMap.get(actChannel),\n-                                        remoteDevice.getServiceObject(tmpService).getServiceType(), tmpService,\n-                                        actChannel.getAcceptedItemType(),\n-                                        KM200Utils.getChannelConfigurationStrings(actChannel));\n-                            } else {\n-                                state = dataHandler.getProvidersState(tmpService, actChannel.getAcceptedItemType(),\n-                                        KM200Utils.getChannelConfigurationStrings(actChannel));\n+                    KM200ServiceObject tmpSerObjekt = remoteDevice.getServiceObject(tmpService);\n+                    if (null != tmpSerObjekt) {\n+                        if (parent == null || parent.equals(tmpSerObjekt.getParent())) {\n+                            synchronized (sendMap) {\n+                                if (sendMap.containsKey(actChannel)) {\n+                                    state = dataHandler.parseJSONData(sendMap.get(actChannel),\n+                                            tmpSerObjekt.getServiceType(), tmpService, actChTypes,\n+                                            KM200Utils.getChannelConfigurationStrings(actChannel));\n+                                } else {\n+                                    state = dataHandler.getProvidersState(tmpService, actChTypes,\n+                                            KM200Utils.getChannelConfigurationStrings(actChannel));\n+                                }\n                             }\n-                        }\n-                        if (state != null) {\n-                            try {\n-                                gatewayHandler.updateState(actChannel.getUID(), state);\n-                            } catch (IllegalStateException e) {\n-                                logger.error(\"Could not get updated item state\", e);\n+                            if (state != null) {\n+                                try {\n+                                    gatewayHandler.updateState(actChannel.getUID(), state);\n+                                } catch (IllegalStateException e) {\n+                                    logger.error(\"Could not get updated item state\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a67b5e511dd5cbcc7f0bd30ad98a2c72890789a2"}, "originalPosition": 304}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQxNjQyNQ==", "bodyText": "here too", "url": "https://github.com/openhab/openhab-addons/pull/7393#discussion_r410416425", "createdAt": "2020-04-17T19:05:37Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.km200/src/main/java/org/openhab/binding/km200/internal/handler/KM200GatewayHandler.java", "diffHunk": "@@ -340,60 +354,81 @@ private void updateBridgeProperties() {\n      * Prepares a message for sending\n      */\n     public void prepareMessage(Thing thing, Channel channel, Command command) {\n-        if (getDevice() != null && getDevice().getInited() && channel != null) {\n+        if (getDevice().getInited()) {\n             JsonObject newObject = null;\n             State state = null;\n             String service = KM200Utils.checkParameterReplacement(channel, getDevice());\n-\n+            String chTypes = channel.getAcceptedItemType();\n+            if (null == chTypes) {\n+                logger.error(\"Channel {} has not accepted item types\", channel.getLabel());\n+                return;\n+            }\n             logger.debug(\"handleCommand channel: {} service: {}\", channel.getLabel(), service);\n-            newObject = dataHandler.sendProvidersState(service, command, channel.getAcceptedItemType(),\n+            newObject = dataHandler.sendProvidersState(service, command, chTypes,\n                     KM200Utils.getChannelConfigurationStrings(channel));\n             synchronized (getDevice()) {\n-                if (newObject != null) {\n-                    sendMap.put(channel, newObject);\n-                } else if (getDevice().containsService(service)\n-                        && getDevice().getServiceObject(service).getVirtual() == 1) {\n-                    String parent = getDevice().getServiceObject(service).getParent();\n-                    for (Thing actThing : getThing().getThings()) {\n-                        logger.debug(\"Checking: {}\", actThing.getUID().getAsString());\n-                        for (Channel tmpChannel : actThing.getChannels()) {\n-                            String actService = KM200Utils.checkParameterReplacement(tmpChannel, getDevice());\n-                            logger.debug(\"tmpService: {}\", actService);\n-                            String actParent = getDevice().getServiceObject(actService).getParent();\n-                            if (actParent != null && actParent.equals(parent)) {\n-                                state = dataHandler.getProvidersState(actService, tmpChannel.getAcceptedItemType(),\n-                                        KM200Utils.getChannelConfigurationStrings(tmpChannel));\n-                                if (state != null) {\n-                                    try {\n-                                        updateState(tmpChannel.getUID(), state);\n-                                    } catch (IllegalStateException e) {\n-                                        logger.error(\"Could not get updated item state\", e);\n+                KM200ServiceObject serObjekt = getDevice().getServiceObject(service);\n+                if (null != serObjekt) {\n+                    if (newObject != null) {\n+                        sendMap.put(channel, newObject);\n+                    } else if (getDevice().containsService(service) && serObjekt.getVirtual() == 1) {\n+                        String parent = serObjekt.getParent();\n+                        for (Thing actThing : getThing().getThings()) {\n+                            logger.debug(\"Checking: {}\", actThing.getUID().getAsString());\n+                            for (Channel tmpChannel : actThing.getChannels()) {\n+                                String tmpChTypes = tmpChannel.getAcceptedItemType();\n+                                if (null == tmpChTypes) {\n+                                    logger.error(\"Channel {} has not accepted item types\", tmpChannel.getLabel());\n+                                    return;\n+                                }\n+                                String actService = KM200Utils.checkParameterReplacement(tmpChannel, getDevice());\n+                                logger.debug(\"tmpService: {}\", actService);\n+                                KM200ServiceObject actSerObjekt = getDevice().getServiceObject(actService);\n+                                if (null != actSerObjekt) {\n+                                    String actParent = actSerObjekt.getParent();\n+                                    if (actParent != null && actParent.equals(parent)) {\n+                                        state = dataHandler.getProvidersState(actService, tmpChTypes,\n+                                                KM200Utils.getChannelConfigurationStrings(tmpChannel));\n+                                        if (state != null) {\n+                                            try {\n+                                                updateState(tmpChannel.getUID(), state);\n+                                            } catch (IllegalStateException e) {\n+                                                logger.error(\"Could not get updated item state\", e);\n+                                            }\n+                                        }\n                                     }\n                                 }\n                             }\n                         }\n+                    } else {\n+                        logger.warn(\"Service is not availible: {}\", service);\n                     }\n-                } else {\n-                    logger.warn(\"Service is not availible: {}\", service);\n                 }\n             }\n         }\n-\n     }\n \n     /**\n      * Update the children\n      */\n     // Every thing has here a handler\n     private void updateChildren(Map<Channel, JsonObject> sendMap, KM200GatewayHandler gatewayHandler,\n-            KM200Device remoteDevice, String parent) {\n+            KM200Device remoteDevice, @Nullable String parent) {\n         State state;\n         synchronized (remoteDevice) {\n             if (parent != null) {\n-                remoteDevice.getServiceObject(parent).setUpdated(false);\n+                KM200ServiceObject serParObjekt = remoteDevice.getServiceObject(parent);\n+                if (null != serParObjekt) {\n+                    serParObjekt.setUpdated(false);\n+                }\n             }\n             for (Thing actThing : gatewayHandler.getThing().getThings()) {\n                 for (Channel actChannel : actThing.getChannels()) {\n+                    String actChTypes = actChannel.getAcceptedItemType();\n+                    if (null == actChTypes) {\n+                        logger.error(\"Channel {} has not accepted item types\", actChannel.getLabel());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a67b5e511dd5cbcc7f0bd30ad98a2c72890789a2"}, "originalPosition": 261}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11bb9dd73c26036dc7756a2514ff495d63e11efb", "author": {"user": {"login": "Markinus", "name": "Markus Eckhardt"}}, "url": "https://github.com/openhab/openhab-addons/commit/11bb9dd73c26036dc7756a2514ff495d63e11efb", "committedDate": "2020-04-18T05:47:04Z", "message": "Rechecked all logging levels\n\nSigned-off-by: Markus Eckhardt <github@familie-eckhardt.eu>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe4ae7d2cce3487a056c311cb8a2ab6253bb7cb3", "author": {"user": {"login": "Markinus", "name": "Markus Eckhardt"}}, "url": "https://github.com/openhab/openhab-addons/commit/fe4ae7d2cce3487a056c311cb8a2ab6253bb7cb3", "committedDate": "2020-04-18T06:45:36Z", "message": "More bugfixes and optimizations\n\nSigned-off-by: Markus Eckhardt <github@familie-eckhardt.eu>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1OTMyMTI2", "url": "https://github.com/openhab/openhab-addons/pull/7393#pullrequestreview-395932126", "createdAt": "2020-04-18T17:07:55Z", "commit": {"oid": "fe4ae7d2cce3487a056c311cb8a2ab6253bb7cb3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 822, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}