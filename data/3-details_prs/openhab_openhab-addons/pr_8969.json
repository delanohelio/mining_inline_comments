{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE3MDg4MzQw", "number": 8969, "title": "[telegram] Add support for sendVideo (MP4) and sendAnimation (GIF)", "bodyText": "Closed #7971\n\nImprovement: Add support for sendVideo and sendAnimation so you can now send GIF and MP4 recordings.\nImprovement: Increase the 2MB limit to now allow 10MB jpg files as per the API's limit.\nRefactor: Remove the use of org.apache.commons.io.IOUtils and instead use a Java 9 method.\nImprovement: Add support for absolute paths and not just file:// URLs\n\nPrecompiled jar for testing under openHAB 3 is here:\nhttp://www.pcmus.com/openhab/telegramBinding/org.openhab.binding.telegram-3.0.0-SNAPSHOT.zip\nInside a rule I test using this:\ngetActions(\"telegram\", \"telegram:telegramBot:MyBot\").sendTelegramVideo(1111111111, \"http://192.168.1.2:54321/ipcamera.mp4\", \"Video from Doorbell camera\")", "createdAt": "2020-11-07T05:10:53Z", "url": "https://github.com/openhab/openhab-addons/pull/8969", "merged": true, "mergeCommit": {"oid": "7e5be7ef476ef1024d25e00df7a6543af4b6c888"}, "closed": true, "closedAt": "2020-11-11T03:50:59Z", "author": {"login": "Skinah"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdaB0EvgH2gAyNTE3MDg4MzQwOjFkYzBjMjY3N2FjNjg5MmYwNmNlODE4ZTA1ZDk3OWU0NzA0YTUyZDU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbUJQSAH2gAyNTE3MDg4MzQwOjEzZDA1NWRkZGFjYWEwYzZiZTczYWYzN2Y3NmQ5YjljYzI3MDZmMzc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1dc0c2677ac6892f06ce818e05d979e4704a52d5", "author": {"user": {"login": "Skinah", "name": "Matthew Skinner"}}, "url": "https://github.com/openhab/openhab-addons/commit/1dc0c2677ac6892f06ce818e05d979e4704a52d5", "committedDate": "2020-11-07T02:06:03Z", "message": "Add sendVideo and sendAnimation features.\n\n\nSigned-off-by: Matthew Skinner <matt@pcmus.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6f036a68a8b289c4795a8f1053cbfe7b7a774fb", "author": {"user": {"login": "Skinah", "name": "Matthew Skinner"}}, "url": "https://github.com/openhab/openhab-addons/commit/c6f036a68a8b289c4795a8f1053cbfe7b7a774fb", "committedDate": "2020-11-07T04:55:46Z", "message": "Re-order functions to keep inline with other functions.\n\n\nSigned-off-by: Matthew Skinner <matt@pcmus.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1Njk0ODg2", "url": "https://github.com/openhab/openhab-addons/pull/8969#pullrequestreview-525694886", "createdAt": "2020-11-08T00:22:43Z", "commit": {"oid": "c6f036a68a8b289c4795a8f1053cbfe7b7a774fb"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOFQwMDoyMjo0M1rOHvLyGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOFQwMDoyMjo0M1rOHvLyGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTIzODE3MQ==", "bodyText": "Do you need to download the url? I thought the telegram api supported sending urls as is.", "url": "https://github.com/openhab/openhab-addons/pull/8969#discussion_r519238171", "createdAt": "2020-11-08T00:22:43Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.telegram/src/main/java/org/openhab/binding/telegram/internal/action/TelegramActions.java", "diffHunk": "@@ -394,6 +396,153 @@ public boolean sendTelegramPhoto(@ActionInput(name = \"photoURL\") @Nullable Strin\n         return sendTelegramPhoto(photoURL, caption, null, null);\n     }\n \n+    @RuleAction(label = \"send animation\", description = \"Send an Animation using the Telegram API.\")\n+    public boolean sendTelegramAnimation(@ActionInput(name = \"animationURL\") @Nullable String animationURL,\n+            @ActionInput(name = \"caption\") @Nullable String caption) {\n+        TelegramHandler localHandler = handler;\n+        if (localHandler != null) {\n+            for (Long chatId : localHandler.getReceiverChatIds()) {\n+                if (!sendTelegramAnimation(chatId, animationURL, caption)) {\n+                    return false;\n+                }\n+            }\n+        }\n+        return true;\n+    }\n+\n+    @RuleAction(label = \"send animation\", description = \"Send an Animation using the Telegram API.\")\n+    public boolean sendTelegramAnimation(@ActionInput(name = \"chatId\") @Nullable Long chatId,\n+            @ActionInput(name = \"animationURL\") @Nullable String animationURL,\n+            @ActionInput(name = \"caption\") @Nullable String caption) {\n+        if (animationURL == null) {\n+            logger.warn(\"Animation URL not defined; unable to retrieve video for sending.\");\n+            return false;\n+        }\n+        if (chatId == null) {\n+            logger.warn(\"chatId not defined; action skipped.\");\n+            return false;\n+        }\n+        TelegramHandler localHandler = handler;\n+        if (localHandler != null) {\n+            final SendAnimation sendAnimation;\n+            if (animationURL.toLowerCase().startsWith(\"http\")) {\n+                // load image from url", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c6f036a68a8b289c4795a8f1053cbfe7b7a774fb"}, "originalPosition": 70}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "237ab1587ae2f229d9e531a0a584723c8cde09b1", "author": {"user": {"login": "Skinah", "name": "Matthew Skinner"}}, "url": "https://github.com/openhab/openhab-addons/commit/237ab1587ae2f229d9e531a0a584723c8cde09b1", "committedDate": "2020-11-08T05:31:19Z", "message": "Readme change to trigger new build.\n\nSigned-off-by: Matthew Skinner <matt@pcmus.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1ODUwMzkx", "url": "https://github.com/openhab/openhab-addons/pull/8969#pullrequestreview-525850391", "createdAt": "2020-11-08T22:12:50Z", "commit": {"oid": "237ab1587ae2f229d9e531a0a584723c8cde09b1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e125381b7a80a32a45ff88c15d7c508e683b948a", "author": {"user": {"login": "Skinah", "name": "Matthew Skinner"}}, "url": "https://github.com/openhab/openhab-addons/commit/e125381b7a80a32a45ff88c15d7c508e683b948a", "committedDate": "2020-11-09T10:35:27Z", "message": "Add ability to use raw file paths to send video and animations.\n\n\nSigned-off-by: Matthew Skinner <matt@pcmus.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "caf64494dae3b0ff14feba5ae22875b4424c2445", "author": {"user": {"login": "Skinah", "name": "Matthew Skinner"}}, "url": "https://github.com/openhab/openhab-addons/commit/caf64494dae3b0ff14feba5ae22875b4424c2445", "committedDate": "2020-11-09T10:38:48Z", "message": "Change Paths.get to Path.of as JavaDocs recommend.\n\n\nSigned-off-by: Matthew Skinner <matt@pcmus.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "224a7d1fb20f58edb565603df8f94020236dab1c", "author": {"user": {"login": "Skinah", "name": "Matthew Skinner"}}, "url": "https://github.com/openhab/openhab-addons/commit/224a7d1fb20f58edb565603df8f94020236dab1c", "committedDate": "2020-11-10T02:28:10Z", "message": "Allow absolute paths in SendPhoto methods and update readme.md\n\nSigned-off-by: Matthew Skinner <matt@pcmus.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2ODMzNDc4", "url": "https://github.com/openhab/openhab-addons/pull/8969#pullrequestreview-526833478", "createdAt": "2020-11-10T03:52:41Z", "commit": {"oid": "224a7d1fb20f58edb565603df8f94020236dab1c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQwMzo1Mjo0MlrOHwKvWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQwMzo1Mjo0MlrOHwKvWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI2OTY1OA==", "bodyText": "It should be noted that .jpeg, .jpe, .jif, .jfif, and .jfi are all valid extensions for a file with the image/jpeg mimetype. So either add support for all of those or just simply check if the url contains a period (.) so that you can handle any extension they throw at you.", "url": "https://github.com/openhab/openhab-addons/pull/8969#discussion_r520269658", "createdAt": "2020-11-10T03:52:42Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.telegram/src/main/java/org/openhab/binding/telegram/internal/action/TelegramActions.java", "diffHunk": "@@ -318,19 +317,22 @@ public boolean sendTelegramPhoto(@ActionInput(name = \"chatId\") @Nullable Long ch\n                             \"Basic \" + B64Code.encode(username + \":\" + password, StandardCharsets.ISO_8859_1)));\n                 }\n                 try {\n-                    ContentResponse contentResponse = request.send();\n+                    // API has 10mb limit to jpg file size, without this it can only accept 2mb\n+                    FutureResponseListener listener = new FutureResponseListener(request, 10 * 1024 * 1024);\n+                    request.send(listener);\n+                    ContentResponse contentResponse = listener.get();\n                     if (contentResponse.getStatus() == 200) {\n                         byte[] fileContent = contentResponse.getContent();\n                         sendPhoto = new SendPhoto(chatId, fileContent);\n                     } else {\n                         logger.warn(\"Download from {} failed with status: {}\", photoURL, contentResponse.getStatus());\n                         return false;\n                     }\n-                } catch (InterruptedException | TimeoutException | ExecutionException e) {\n+                } catch (InterruptedException | ExecutionException e) {\n                     logger.warn(\"Download from {} failed with exception: {}\", photoURL, e.getMessage());\n                     return false;\n                 }\n-            } else if (photoURL.toLowerCase().startsWith(\"file\")) {\n+            } else if (photoURL.toLowerCase().startsWith(\"file:\") || photoURL.toLowerCase().endsWith(\".jpg\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "224a7d1fb20f58edb565603df8f94020236dab1c"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f677ead71c4efc5a63036b9ebc10ae921d6569d8", "author": {"user": {"login": "Skinah", "name": "Matthew Skinner"}}, "url": "https://github.com/openhab/openhab-addons/commit/f677ead71c4efc5a63036b9ebc10ae921d6569d8", "committedDate": "2020-11-10T04:23:04Z", "message": "Support for no caption with photo.\n\n\nSigned-off-by: Matthew Skinner <matt@pcmus.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "852453e9ec18ff8993aab2865aad400368beaada", "author": {"user": {"login": "Skinah", "name": "Matthew Skinner"}}, "url": "https://github.com/openhab/openhab-addons/commit/852453e9ec18ff8993aab2865aad400368beaada", "committedDate": "2020-11-10T05:34:54Z", "message": "Add absolute path support for png and webp.\n\n\nSigned-off-by: Matthew Skinner <matt@pcmus.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b03a489c398040478fa47254af755fc991ebcfd1", "author": {"user": {"login": "Skinah", "name": "Matthew Skinner"}}, "url": "https://github.com/openhab/openhab-addons/commit/b03a489c398040478fa47254af755fc991ebcfd1", "committedDate": "2020-11-10T05:59:15Z", "message": "Add all file types requested.\n\n\nSigned-off-by: Matthew Skinner <matt@pcmus.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13d055dddacaa0c6be73af37f76d9b9cc2706f37", "author": {"user": {"login": "Skinah", "name": "Matthew Skinner"}}, "url": "https://github.com/openhab/openhab-addons/commit/13d055dddacaa0c6be73af37f76d9b9cc2706f37", "committedDate": "2020-11-11T02:01:24Z", "message": "Remove multiple OR and only do lowercase once.\n\n\nSigned-off-by: Matthew Skinner <matt@pcmus.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4266, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}