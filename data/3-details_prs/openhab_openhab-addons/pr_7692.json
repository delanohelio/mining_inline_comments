{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE5NzYwNzc1", "number": 7692, "title": "[openweathermap] bridge / thing handling", "bodyText": "Signed-off-by: Laurent Garnier lg.hc@free.fr", "createdAt": "2020-05-18T21:52:54Z", "url": "https://github.com/openhab/openhab-addons/pull/7692", "merged": true, "mergeCommit": {"oid": "29735bd3082f501dfb646fec9c6626ab0ae2efd5"}, "closed": true, "closedAt": "2020-05-19T23:12:14Z", "author": {"login": "lolodomo"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcinD01gH2gAyNDE5NzYwNzc1OjUyYzFmNzA3YzZlOGE2MmU3NWQxZDZjNmUwZjVhYWE3YWFiZWEwZmM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABci81HvAFqTQxNDg4NTU2OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "52c1f707c6e8a62e75d1d6c6e0f5aaa7aabea0fc", "author": {"user": {"login": "lolodomo", "name": "lolodomo"}}, "url": "https://github.com/openhab/openhab-addons/commit/52c1f707c6e8a62e75d1d6c6e0f5aaa7aabea0fc", "committedDate": "2020-05-18T21:49:59Z", "message": "[openweathermap] bridge / thing handling\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0MDM1OTQ0", "url": "https://github.com/openhab/openhab-addons/pull/7692#pullrequestreview-414035944", "createdAt": "2020-05-19T01:13:28Z", "commit": {"oid": "52c1f707c6e8a62e75d1d6c6e0f5aaa7aabea0fc"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwMToxMzoyOFrOGXMeBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwMToxMzoyOFrOGXMeBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk3NDcyNg==", "bodyText": "You should eliminate the requirement for subclasses to have to call super and then exit early. Instead you should just move all the  AbstractOpenWeatherMapHandler.initializeThing logic into AbstractOpenWeatherMapHandler.initialize, make AbstractOpenWeatherMapHandler.initializeThing abstract and only call initializeThing when bridgeHandler != null && bridgeStatus == ThingStatus.ONLINE.", "url": "https://github.com/openhab/openhab-addons/pull/7692#discussion_r426974726", "createdAt": "2020-05-19T01:13:28Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.openweathermap/src/main/java/org/openhab/binding/openweathermap/internal/handler/OpenWeatherMapWeatherAndForecastHandler.java", "diffHunk": "@@ -82,8 +83,11 @@ public OpenWeatherMapWeatherAndForecastHandler(Thing thing) {\n     }\n \n     @Override\n-    public void initialize() {\n-        super.initialize();\n+    protected void initializeThing(@Nullable ThingHandler bridgeHandler, @Nullable ThingStatus bridgeStatus) {\n+        super.initializeThing(bridgeHandler, bridgeStatus);\n+        if (bridgeHandler == null || bridgeStatus != ThingStatus.ONLINE) {\n+            return;\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "52c1f707c6e8a62e75d1d6c6e0f5aaa7aabea0fc"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a1a3b5dedcc78730e44987a6f46f4d685a8957f", "author": {"user": {"login": "lolodomo", "name": "lolodomo"}}, "url": "https://github.com/openhab/openhab-addons/commit/2a1a3b5dedcc78730e44987a6f46f4d685a8957f", "committedDate": "2020-05-19T06:38:03Z", "message": "Create an abstract method\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0NjgzNDc4", "url": "https://github.com/openhab/openhab-addons/pull/7692#pullrequestreview-414683478", "createdAt": "2020-05-19T17:47:18Z", "commit": {"oid": "2a1a3b5dedcc78730e44987a6f46f4d685a8957f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNzo0NzoxOFrOGXrvgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNzo0NzoxOFrOGXrvgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ4NzEwNg==", "bodyText": "Since bridge.getStatus() should reflect the most recently changed status. It should be possible to refactor the logic from bridgeStatusChanged and initialize into initializeThing. Of course we would have to change the name here to avoid naming conflicts with our abstract method.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private void initializeThing(@Nullable ThingHandler bridgeHandler, @Nullable ThingStatus bridgeStatus) {\n          \n          \n            \n                    if (bridgeHandler != null && bridgeStatus != null) {\n          \n          \n            \n                private void initializeThingInternal() {\n          \n          \n            \n                    Bridge bridge = getBridge();\n          \n          \n            \n                    ThingHandler bridgeHandler = bridge != null ? bridge.getHandler() : null;\n          \n          \n            \n                    ThingStatus bridgeStatus = bridge != null ? bridge.getStatus() : null;\n          \n          \n            \n                    if (bridgeHandler != null && bridgeStatus != null) {", "url": "https://github.com/openhab/openhab-addons/pull/7692#discussion_r427487106", "createdAt": "2020-05-19T17:47:18Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.openweathermap/src/main/java/org/openhab/binding/openweathermap/internal/handler/AbstractOpenWeatherMapHandler.java", "diffHunk": "@@ -82,29 +84,50 @@ public AbstractOpenWeatherMapHandler(Thing thing) {\n \n     @Override\n     public void initialize() {\n-        OpenWeatherMapLocationConfiguration config = getConfigAs(OpenWeatherMapLocationConfiguration.class);\n-\n-        boolean configValid = true;\n-        if (StringUtils.trimToNull(config.getLocation()) == null) {\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.CONFIGURATION_ERROR,\n-                    \"@text/offline.conf-error-missing-location\");\n-            configValid = false;\n+        logger.debug(\"initializing handler for thing {}\", getThing().getUID());\n+        Bridge bridge = getBridge();\n+        if (bridge == null) {\n+            initializeThing(null, null);\n+        } else {\n+            initializeThing(bridge.getHandler(), bridge.getStatus());\n         }\n+    }\n \n-        try {\n-            location = new PointType(config.getLocation());\n-        } catch (IllegalArgumentException e) {\n-            location = null;\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.CONFIGURATION_ERROR,\n-                    \"@text/offline.conf-error-parsing-location\");\n-            configValid = false;\n-        }\n+    private void initializeThing(@Nullable ThingHandler bridgeHandler, @Nullable ThingStatus bridgeStatus) {\n+        if (bridgeHandler != null && bridgeStatus != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a1a3b5dedcc78730e44987a6f46f4d685a8957f"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f87846b1d94ce803d20e5cf91e521731c4eeef34", "author": {"user": {"login": "lolodomo", "name": "lolodomo"}}, "url": "https://github.com/openhab/openhab-addons/commit/f87846b1d94ce803d20e5cf91e521731c4eeef34", "committedDate": "2020-05-19T20:58:46Z", "message": "Only bridgeStatus as parameter for method initializeThing\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0ODg1NTY5", "url": "https://github.com/openhab/openhab-addons/pull/7692#pullrequestreview-414885569", "createdAt": "2020-05-19T23:11:50Z", "commit": {"oid": "f87846b1d94ce803d20e5cf91e521731c4eeef34"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 589, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}