{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzczNDA2MzEx", "number": 6995, "title": "[bluetooth.bluegiga] Fix BlueGiga discovery and manufacturerData handling", "bodyText": "Replaces #6595. Ready for review / merge.", "createdAt": "2020-02-10T23:31:25Z", "url": "https://github.com/openhab/openhab-addons/pull/6995", "merged": true, "mergeCommit": {"oid": "3bfc4896e767bcbaf6d0e7a1d74934fad8ccabbe"}, "closed": true, "closedAt": "2020-02-23T08:37:52Z", "author": {"login": "pfink"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABbwq-Q9gH2gAyMzczNDA2MzExOjg2ZmQ4Y2E4NWYyMWZkMThlMWVkYzBmMjkwODZjYTQ1NzYxZWFjYTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcHExtUAFqTM2MzA3ODkyOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "86fd8ca85f21fd18e1edc0f29086ca45761eaca6", "author": {"user": {"login": "pfink", "name": "Patrick Fink"}}, "url": "https://github.com/openhab/openhab-addons/commit/86fd8ca85f21fd18e1edc0f29086ca45761eaca6", "committedDate": "2019-12-15T18:07:19Z", "message": "[bluetooth.bluegiga] Fix BlueGiga discovery and manufacturerData parsing\n\nSigned-off-by: Patrick Fink <mail@pfink.de>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ef03802271b106ebbf29538f8df8345fc8e0d9c", "author": {"user": {"login": "pfink", "name": "Patrick Fink"}}, "url": "https://github.com/openhab/openhab-addons/commit/2ef03802271b106ebbf29538f8df8345fc8e0d9c", "committedDate": "2020-02-10T23:26:40Z", "message": "[bluetooth.bluegiga] Handle ClassCastException on manufacturerData parsing\n\nSigned-off-by: Patrick Fink <mail@pfink.de>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ae2e118a61fd6de37d9a860fa62ae77037ccd37", "author": {"user": {"login": "pfink", "name": "Patrick Fink"}}, "url": "https://github.com/openhab/openhab-addons/commit/0ae2e118a61fd6de37d9a860fa62ae77037ccd37", "committedDate": "2020-02-10T23:27:10Z", "message": "[bluetooth.bluegiga] Prepend Company ID to manufacturerData\n\nSigned-off-by: Patrick Fink <mail@pfink.de>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2MzQ1NzMy", "url": "https://github.com/openhab/openhab-addons/pull/6995#pullrequestreview-356345732", "createdAt": "2020-02-10T23:45:13Z", "commit": {"oid": "0ae2e118a61fd6de37d9a860fa62ae77037ccd37"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQyMzo0NToxNFrOFn5rCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQyMzo0NjoxN1rOFn5sTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM4MzY4OQ==", "bodyText": "If you are going to be catching a ClassCastException you might as well forego the instanceof check.", "url": "https://github.com/openhab/openhab-addons/pull/6995#discussion_r377383689", "createdAt": "2020-02-10T23:45:14Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.bluetooth.bluegiga/src/main/java/org/openhab/binding/bluetooth/bluegiga/BlueGigaBluetoothDevice.java", "diffHunk": "@@ -193,10 +194,28 @@ public void bluegigaEventReceived(BlueGigaResponse event) {\n                         case EIR_FLAGS:\n                             break;\n                         case EIR_MANUFACTURER_SPECIFIC:\n-                            manufacturerData = (byte[]) eir.getRecord(EirDataType.EIR_MANUFACTURER_SPECIFIC);\n-                            if (manufacturerData.length > 2) {\n-                                int id = manufacturerData[0] + (manufacturerData[1] << 8);\n-                                manufacturer = id;\n+                            Object obj = eir.getRecord(EirDataType.EIR_MANUFACTURER_SPECIFIC);\n+                            if (obj != null && obj instanceof Map<?, ?>) {\n+                                try {\n+                                    @SuppressWarnings(\"unchecked\")\n+                                    Map<Short, int[]> eirRecord = (Map<Short, int[]>) obj;\n+                                    Map.Entry<Short, int[]> eirEntry = eirRecord.entrySet().iterator().next();\n+\n+                                    manufacturer = (int) eirEntry.getKey();\n+\n+                                    int[] manufacturerInt = eirEntry.getValue();\n+                                    manufacturerData = new byte[manufacturerInt.length + 2];\n+                                    // Convert short Company ID to bytes and add it to manufacturerData\n+                                    manufacturerData[0] = (byte) (manufacturer & 0xff);\n+                                    manufacturerData[1] = (byte) ((manufacturer >> 8) & 0xff);\n+                                    // Add Convert int custom data nd add it to manufacturerData\n+                                    for (int i = 0; i < manufacturerInt.length; i++) {\n+                                        manufacturerData[i + 2] = (byte) manufacturerInt[i];\n+                                    }\n+                                } catch (ClassCastException e) {\n+                                    logger.debug(\"Unsupported manufacturer specific record received from device {}\",\n+                                            address);\n+                                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ae2e118a61fd6de37d9a860fa62ae77037ccd37"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM4NDAxNQ==", "bodyText": "why are you getting rid of these? Aren't these checks important?", "url": "https://github.com/openhab/openhab-addons/pull/6995#discussion_r377384015", "createdAt": "2020-02-10T23:46:17Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.bluetooth.bluegiga/src/main/java/org/openhab/binding/bluetooth/bluegiga/BlueGigaBluetoothDevice.java", "diffHunk": "@@ -229,27 +248,18 @@ public void bluegigaEventReceived(BlueGigaResponse event) {\n             }\n \n             if (connectionState == ConnectionState.DISCOVERING) {\n-                // We want to wait for an advertisement and a scan response before we call this discovered.\n-                // The intention is to gather a reasonable amount of data about the device given devices send\n-                // different data in different packets...\n-                // Note that this is possible a bit arbitrary and may be refined later.\n                 scanResponses.add(scanEvent.getPacketType());\n \n-                if ((scanResponses.contains(ScanResponseType.CONNECTABLE_ADVERTISEMENT)\n-                        || scanResponses.contains(ScanResponseType.DISCOVERABLE_ADVERTISEMENT)\n-                        || scanResponses.contains(ScanResponseType.NON_CONNECTABLE_ADVERTISEMENT))\n-                        && scanResponses.contains(ScanResponseType.SCAN_RESPONSE)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ae2e118a61fd6de37d9a860fa62ae77037ccd37"}, "originalPosition": 54}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2Mzc2MzQ3", "url": "https://github.com/openhab/openhab-addons/pull/6995#pullrequestreview-356376347", "createdAt": "2020-02-11T01:22:58Z", "commit": {"oid": "0ae2e118a61fd6de37d9a860fa62ae77037ccd37"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQwMToyMjo1OFrOFn7SRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQwMToyMjo1OFrOFn7SRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQxMDExOQ==", "bodyText": "I wouldn't remove this just yet. Discovery needs to be reworked here and I think some of that work is happening in PR #6921 . There is no harm in leaving this in for now.", "url": "https://github.com/openhab/openhab-addons/pull/6995#discussion_r377410119", "createdAt": "2020-02-11T01:22:58Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.bluetooth.bluegiga/src/main/java/org/openhab/binding/bluetooth/bluegiga/handler/BlueGigaBridgeHandler.java", "diffHunk": "@@ -341,7 +341,6 @@ public void bluegigaEventReceived(@Nullable BlueGigaResponse event) {\n                 device = new BlueGigaBluetoothDevice(this, new BluetoothAddress(scanEvent.getSender()),\n                         scanEvent.getAddressType());\n                 devices.put(sender, device);\n-                deviceDiscovered(device);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ae2e118a61fd6de37d9a860fa62ae77037ccd37"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a7f4062164ec00031975001bc372975c6f3dca2c", "author": {"user": {"login": "pfink", "name": "Patrick Fink"}}, "url": "https://github.com/openhab/openhab-addons/commit/a7f4062164ec00031975001bc372975c6f3dca2c", "committedDate": "2020-02-11T19:52:22Z", "message": "[bluetooth.bluegiga] Remove instanceof check\n\nSigned-off-by: Patrick Fink <mail@pfink.de>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b45796acba6026470a448c2d77d9ec985d817c9d", "author": {"user": {"login": "pfink", "name": "Patrick Fink"}}, "url": "https://github.com/openhab/openhab-addons/commit/b45796acba6026470a448c2d77d9ec985d817c9d", "committedDate": "2020-02-11T19:55:01Z", "message": "[bluetooth.bluegiga] Remove obsolete scanResponses attribute\n\nSigned-off-by: Patrick Fink <mail@pfink.de>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c62190a1075321c1924e7c3f77a1bc836099586", "author": {"user": {"login": "pfink", "name": "Patrick Fink"}}, "url": "https://github.com/openhab/openhab-addons/commit/4c62190a1075321c1924e7c3f77a1bc836099586", "committedDate": "2020-02-11T20:07:40Z", "message": "[bluetooth.bluegiga] Add comment regarding scan response discovery\n\nSigned-off-by: Patrick Fink <mail@pfink.de>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2252be2ceb35643e5b98c0e5e31fb41fdc342f36", "author": {"user": {"login": "pfink", "name": "Patrick Fink"}}, "url": "https://github.com/openhab/openhab-addons/commit/2252be2ceb35643e5b98c0e5e31fb41fdc342f36", "committedDate": "2020-02-11T20:13:45Z", "message": "[bluetooth.bluegiga] Keep deviceDiscovered for now to avoid conflict with #6921\n\nSigned-off-by: Patrick Fink <mail@pfink.de>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe25b4fa7f29b5056b97e2883f67d2500b4f458e", "author": {"user": {"login": "pfink", "name": "Patrick Fink"}}, "url": "https://github.com/openhab/openhab-addons/commit/fe25b4fa7f29b5056b97e2883f67d2500b4f458e", "committedDate": "2020-02-11T20:18:03Z", "message": "[bluetooth.bluegiga] Fix comment position\n\nSigned-off-by: Patrick Fink <mail@pfink.de>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5MzQzOTgx", "url": "https://github.com/openhab/openhab-addons/pull/6995#pullrequestreview-359343981", "createdAt": "2020-02-15T12:49:16Z", "commit": {"oid": "fe25b4fa7f29b5056b97e2883f67d2500b4f458e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNVQxMjo0OToxNlrOFqO9sQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNVQxMjo0OToxNlrOFqO9sQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTgyOTY4MQ==", "bodyText": "Are we sure that all needed data is always received by one scan event or could it possible that bluetooth device send them as a separated scan events?", "url": "https://github.com/openhab/openhab-addons/pull/6995#discussion_r379829681", "createdAt": "2020-02-15T12:49:16Z", "author": {"login": "paulianttila"}, "path": "bundles/org.openhab.binding.bluetooth.bluegiga/src/main/java/org/openhab/binding/bluetooth/bluegiga/BlueGigaBluetoothDevice.java", "diffHunk": "@@ -229,27 +245,20 @@ public void bluegigaEventReceived(BlueGigaResponse event) {\n             }\n \n             if (connectionState == ConnectionState.DISCOVERING) {\n-                // We want to wait for an advertisement and a scan response before we call this discovered.\n-                // The intention is to gather a reasonable amount of data about the device given devices send\n-                // different data in different packets...\n-                // Note that this is possible a bit arbitrary and may be refined later.\n-                scanResponses.add(scanEvent.getPacketType());\n-\n-                if ((scanResponses.contains(ScanResponseType.CONNECTABLE_ADVERTISEMENT)\n-                        || scanResponses.contains(ScanResponseType.DISCOVERABLE_ADVERTISEMENT)\n-                        || scanResponses.contains(ScanResponseType.NON_CONNECTABLE_ADVERTISEMENT))\n-                        && scanResponses.contains(ScanResponseType.SCAN_RESPONSE)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe25b4fa7f29b5056b97e2883f67d2500b4f458e"}, "originalPosition": 64}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMDYyNTg2", "url": "https://github.com/openhab/openhab-addons/pull/6995#pullrequestreview-363062586", "createdAt": "2020-02-23T02:58:05Z", "commit": {"oid": "fe25b4fa7f29b5056b97e2883f67d2500b4f458e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMDc4OTI5", "url": "https://github.com/openhab/openhab-addons/pull/6995#pullrequestreview-363078929", "createdAt": "2020-02-23T08:37:28Z", "commit": {"oid": "fe25b4fa7f29b5056b97e2883f67d2500b4f458e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1439, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}