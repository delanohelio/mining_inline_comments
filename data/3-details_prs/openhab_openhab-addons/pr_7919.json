{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM0MTYyNDQ0", "number": 7919, "title": "[amazonechocontrol] fix memory/thread leak and failing connection", "bodyText": "Fixes #7910\nThis fixes the memory/thread leak resulting from incorrect shutdown handling. Because of the high re-connect rate of 60s this resulted in an OOM after some time.\nThe requests failed because some headers were added twice which caused the server to discard the message.\nSigned-off-by: Jan N. Klug jan.n.klug@rub.de", "createdAt": "2020-06-14T15:40:14Z", "url": "https://github.com/openhab/openhab-addons/pull/7919", "merged": true, "mergeCommit": {"oid": "e428407d2d6d65bb963ee77a3230b4dc2dc7fda8"}, "closed": true, "closedAt": "2020-06-16T18:57:54Z", "author": {"login": "J-N-K"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcrN-ZqgH2gAyNDM0MTYyNDQ0Ojg3NGQ1ZDE4N2MzYTE5NTkwZjAxMDFiOTA4NzcyOTdkYzI4M2U4ZWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcr5-C1gFqTQzMTgwNDU4Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "874d5d187c3a19590f0101b90877297dc283e8ef", "author": {"user": {"login": "J-N-K", "name": null}}, "url": "https://github.com/openhab/openhab-addons/commit/874d5d187c3a19590f0101b90877297dc283e8ef", "committedDate": "2020-06-14T15:41:45Z", "message": "fix memory leak on failing websocket\n\nSigned-off-by: Jan N. Klug <jan.n.klug@rub.de>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4f1dc3b908624216a07bd156b8b9b14e210a7905", "author": {"user": {"login": "J-N-K", "name": null}}, "url": "https://github.com/openhab/openhab-addons/commit/4f1dc3b908624216a07bd156b8b9b14e210a7905", "committedDate": "2020-06-14T13:40:00Z", "message": "fix memory leak on websocket timeout\n\nSigned-off-by: Jan N. Klug <jan.n.klug@rub.de>"}, "afterCommit": {"oid": "874d5d187c3a19590f0101b90877297dc283e8ef", "author": {"user": {"login": "J-N-K", "name": null}}, "url": "https://github.com/openhab/openhab-addons/commit/874d5d187c3a19590f0101b90877297dc283e8ef", "committedDate": "2020-06-14T15:41:45Z", "message": "fix memory leak on failing websocket\n\nSigned-off-by: Jan N. Klug <jan.n.klug@rub.de>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwMjM0MjEz", "url": "https://github.com/openhab/openhab-addons/pull/7919#pullrequestreview-430234213", "createdAt": "2020-06-14T16:41:18Z", "commit": {"oid": "874d5d187c3a19590f0101b90877297dc283e8ef"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQxNjo0MToxOFrOGjeJeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQxNjo0MToxOFrOGjeJeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg0NzI4OA==", "bodyText": "Where is this counter and the one below it being used? I see them being incremented, but i don't see where anything is done with that count", "url": "https://github.com/openhab/openhab-addons/pull/7919#discussion_r439847288", "createdAt": "2020-06-14T16:41:18Z", "author": {"login": "digitaldan"}, "path": "bundles/org.openhab.binding.amazonechocontrol/src/main/java/org/openhab/binding/amazonechocontrol/internal/WebSocketConnection.java", "diffHunk": "@@ -64,6 +68,9 @@\n     Listener listener;\n     boolean closed;\n     IWebSocketCommandHandler webSocketCommandHandler;\n+    private long messageCounter = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "874d5d187c3a19590f0101b90877297dc283e8ef"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f68feb0cade0267fe4408f39c7d8a31b69cd194", "author": {"user": {"login": "J-N-K", "name": null}}, "url": "https://github.com/openhab/openhab-addons/commit/3f68feb0cade0267fe4408f39c7d8a31b69cd194", "committedDate": "2020-06-14T17:14:57Z", "message": "address review comment and fix some smaller issues\n\nSigned-off-by: Jan N. Klug <jan.n.klug@rub.de>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwMjUwNTAx", "url": "https://github.com/openhab/openhab-addons/pull/7919#pullrequestreview-430250501", "createdAt": "2020-06-14T20:58:15Z", "commit": {"oid": "3f68feb0cade0267fe4408f39c7d8a31b69cd194"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQyMDo1ODoxNVrOGjfWEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQyMDo1ODoxNVrOGjfWEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg2Njg5OA==", "bodyText": "I know this is not part of you change, but I wonder if we should reduce this to debug?  Info seem very chatty here.", "url": "https://github.com/openhab/openhab-addons/pull/7919#discussion_r439866898", "createdAt": "2020-06-14T20:58:15Z", "author": {"login": "digitaldan"}, "path": "bundles/org.openhab.binding.amazonechocontrol/src/main/java/org/openhab/binding/amazonechocontrol/internal/WebSocketConnection.java", "diffHunk": "@@ -424,7 +440,22 @@ public void onWebSocketClose(int code, @Nullable String reason) {\n         @Override\n         public void onWebSocketError(@Nullable Throwable error) {\n             logger.info(\"Web Socket error\", error);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f68feb0cade0267fe4408f39c7d8a31b69cd194"}, "originalPosition": 111}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwMjUwNzA3", "url": "https://github.com/openhab/openhab-addons/pull/7919#pullrequestreview-430250707", "createdAt": "2020-06-14T21:01:07Z", "commit": {"oid": "3f68feb0cade0267fe4408f39c7d8a31b69cd194"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwODY5MDcz", "url": "https://github.com/openhab/openhab-addons/pull/7919#pullrequestreview-430869073", "createdAt": "2020-06-15T17:55:54Z", "commit": {"oid": "3f68feb0cade0267fe4408f39c7d8a31b69cd194"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNzo1NTo1NFrOGj8u2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxODoyNzoyNFrOGj9wuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM0ODM3OQ==", "bodyText": "I'm not sure how useful logging the future would be since I don't think it implements a toString().", "url": "https://github.com/openhab/openhab-addons/pull/7919#discussion_r440348379", "createdAt": "2020-06-15T17:55:54Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.amazonechocontrol/src/main/java/org/openhab/binding/amazonechocontrol/internal/WebSocketConnection.java", "diffHunk": "@@ -155,8 +159,15 @@ public void close() {\n                 logger.debug(\"Closing sessing failed\", e);\n             }\n         }\n+        logger.trace(\"Connect future = {}\", sessionFuture);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f68feb0cade0267fe4408f39c7d8a31b69cd194"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM2MDk3Mw==", "bodyText": "It always bothered me that we are not overriding the default executor used by the WebSocketClient. The default one has a min thread count of 8 and all the threads are non-daemon. I'd prefer if we provided our own thread pool so we can use an existing thread pool for all these connections instead of creating new ones each time.\nIt would also give us an opportunity to give the threads names that would tie them to this binding.", "url": "https://github.com/openhab/openhab-addons/pull/7919#discussion_r440360973", "createdAt": "2020-06-15T18:19:30Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.amazonechocontrol/src/main/java/org/openhab/binding/amazonechocontrol/internal/WebSocketConnection.java", "diffHunk": "@@ -54,16 +58,16 @@\n public class WebSocketConnection {\n     private final Logger logger = LoggerFactory.getLogger(WebSocketConnection.class);\n     private final Gson gson = new Gson();\n-    WebSocketClient webSocketClient;\n-    @Nullable\n-    Session session;\n-    @Nullable\n-    Timer pingTimer;\n-    @Nullable\n-    Timer pongTimeoutTimer;\n-    Listener listener;\n-    boolean closed;\n-    IWebSocketCommandHandler webSocketCommandHandler;\n+    private final WebSocketClient webSocketClient;\n+    private final IWebSocketCommandHandler webSocketCommandHandler;\n+    private final Listener listener;\n+\n+    private @Nullable Session session;\n+    private @Nullable Timer pingTimer;\n+    private @Nullable Timer pongTimeoutTimer;\n+    private @Nullable Future<?> sessionFuture;\n+\n+    private boolean closed;\n \n     public WebSocketConnection(String amazonSite, List<HttpCookie> sessionCookies,\n             IWebSocketCommandHandler webSocketCommandHandler) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f68feb0cade0267fe4408f39c7d8a31b69cd194"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM2NTI0MQ==", "bodyText": "Why are two separate Timer instances required? Can't you use just a single Timer for all scheduling tasks?", "url": "https://github.com/openhab/openhab-addons/pull/7919#discussion_r440365241", "createdAt": "2020-06-15T18:27:24Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.amazonechocontrol/src/main/java/org/openhab/binding/amazonechocontrol/internal/WebSocketConnection.java", "diffHunk": "@@ -54,16 +58,16 @@\n public class WebSocketConnection {\n     private final Logger logger = LoggerFactory.getLogger(WebSocketConnection.class);\n     private final Gson gson = new Gson();\n-    WebSocketClient webSocketClient;\n-    @Nullable\n-    Session session;\n-    @Nullable\n-    Timer pingTimer;\n-    @Nullable\n-    Timer pongTimeoutTimer;\n-    Listener listener;\n-    boolean closed;\n-    IWebSocketCommandHandler webSocketCommandHandler;\n+    private final WebSocketClient webSocketClient;\n+    private final IWebSocketCommandHandler webSocketCommandHandler;\n+    private final Listener listener;\n+\n+    private @Nullable Session session;\n+    private @Nullable Timer pingTimer;\n+    private @Nullable Timer pongTimeoutTimer;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f68feb0cade0267fe4408f39c7d8a31b69cd194"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73340c0b201e9c3130d4061727b084f27125b9a1", "author": {"user": {"login": "J-N-K", "name": null}}, "url": "https://github.com/openhab/openhab-addons/commit/73340c0b201e9c3130d4061727b084f27125b9a1", "committedDate": "2020-06-15T21:32:48Z", "message": "more fixes\n\nSigned-off-by: Jan N. Klug <jan.n.klug@rub.de>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54f5ee534c5d8e3bc2ffee13952b683521024d9b", "author": {"user": {"login": "J-N-K", "name": null}}, "url": "https://github.com/openhab/openhab-addons/commit/54f5ee534c5d8e3bc2ffee13952b683521024d9b", "committedDate": "2020-06-15T21:41:00Z", "message": "remove leftovers\n\nSigned-off-by: Jan N. Klug <jan.n.klug@rub.de>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxMTcyNzQ2", "url": "https://github.com/openhab/openhab-addons/pull/7919#pullrequestreview-431172746", "createdAt": "2020-06-16T05:37:04Z", "commit": {"oid": "54f5ee534c5d8e3bc2ffee13952b683521024d9b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxODA0NTg2", "url": "https://github.com/openhab/openhab-addons/pull/7919#pullrequestreview-431804586", "createdAt": "2020-06-16T18:57:11Z", "commit": {"oid": "54f5ee534c5d8e3bc2ffee13952b683521024d9b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 273, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}