{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIxODk5Njc0", "number": 7741, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQyMTo1Mjo1MlrOD_FEVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yM1QwNDoxNjozMFrOD_G8Gg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3NDY5OTEwOnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.binding.insteon/src/main/java/org/openhab/binding/insteon/internal/handler/InsteonNetworkHandler.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQyMTo1Mjo1MlrOGZkkmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQyMjo1ODozMlrOGZlmew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ2Njc3Ng==", "bodyText": "I doubt it is your intention for this thread to interrupt itself.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            reconnectJob.cancel(true);\n          \n          \n            \n                            reconnectJob.cancel(false);", "url": "https://github.com/openhab/openhab-addons/pull/7741#discussion_r429466776", "createdAt": "2020-05-22T21:52:52Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.insteon/src/main/java/org/openhab/binding/insteon/internal/handler/InsteonNetworkHandler.java", "diffHunk": "@@ -142,6 +149,18 @@ public void updateState(ChannelUID channelUID, State state) {\n         super.updateState(channelUID, state);\n     }\n \n+    public void bindingDisconnected() {\n+        reconnectJob = scheduler.scheduleWithFixedDelay(() -> {\n+            if (insteonBinding.reconnect()) {\n+                updateStatus(ThingStatus.ONLINE);\n+                reconnectJob.cancel(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed437e5912b51a559d01886ee7b24c5cae55ddf4"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ4MzY0Mw==", "bodyText": "fixed", "url": "https://github.com/openhab/openhab-addons/pull/7741#discussion_r429483643", "createdAt": "2020-05-22T22:58:32Z", "author": {"login": "robnielsen"}, "path": "bundles/org.openhab.binding.insteon/src/main/java/org/openhab/binding/insteon/internal/handler/InsteonNetworkHandler.java", "diffHunk": "@@ -142,6 +149,18 @@ public void updateState(ChannelUID channelUID, State state) {\n         super.updateState(channelUID, state);\n     }\n \n+    public void bindingDisconnected() {\n+        reconnectJob = scheduler.scheduleWithFixedDelay(() -> {\n+            if (insteonBinding.reconnect()) {\n+                updateStatus(ThingStatus.ONLINE);\n+                reconnectJob.cancel(true);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ2Njc3Ng=="}, "originalCommit": {"oid": "ed437e5912b51a559d01886ee7b24c5cae55ddf4"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3NDc0MDcyOnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.binding.insteon/src/main/java/org/openhab/binding/insteon/internal/driver/Port.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQyMjowMzo0NFrOGZk_rA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQyMzozNTo0MFrOGZl9CA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ3MzcwOA==", "bodyText": "You shouldn't synchronize on a non-final field, and you shouldn't synchronize on a boolean. Java synchronization operates against object instances, not against field names, so you would either need to use a dedicated lock object for synchronization:\nprivate final Object disconnectLock = new Object();\n\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        synchronized (disconnected) {\n          \n          \n            \n                            if (!disconnected) {\n          \n          \n            \n                                logger.warn(\"port {} disconnected\", logName);\n          \n          \n            \n                                driver.disconnected();\n          \n          \n            \n                                disconnected = true;\n          \n          \n            \n                            }\n          \n          \n            \n                        }\n          \n          \n            \n                        synchronized (disconnectLock) {\n          \n          \n            \n                            if (!disconnected) {\n          \n          \n            \n                                logger.warn(\"port {} disconnected\", logName);\n          \n          \n            \n                                driver.disconnected();\n          \n          \n            \n                                disconnected = true;\n          \n          \n            \n                            }\n          \n          \n            \n                        }\n          \n      \n    \n    \n  \n\nOr you can change your disconnected field into one of the atomic utility classes (like AtomicBoolean) and then do the following:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        synchronized (disconnected) {\n          \n          \n            \n                            if (!disconnected) {\n          \n          \n            \n                                logger.warn(\"port {} disconnected\", logName);\n          \n          \n            \n                                driver.disconnected();\n          \n          \n            \n                                disconnected = true;\n          \n          \n            \n                            }\n          \n          \n            \n                        }\n          \n          \n            \n                        if(!disconnected.getAndSet(true)){\n          \n          \n            \n                            logger.warn(\"port {} disconnected\", logName);\n          \n          \n            \n                            driver.disconnected();\n          \n          \n            \n                        }", "url": "https://github.com/openhab/openhab-addons/pull/7741#discussion_r429473708", "createdAt": "2020-05-22T22:03:44Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.insteon/src/main/java/org/openhab/binding/insteon/internal/driver/Port.java", "diffHunk": "@@ -255,6 +265,18 @@ public void modemDBComplete() {\n         driver.modemDBComplete(this);\n     }\n \n+    public void disconnected() {\n+        if (isRunning()) {\n+            synchronized (disconnected) {\n+                if (!disconnected) {\n+                    logger.warn(\"port {} disconnected\", logName);\n+                    driver.disconnected();\n+                    disconnected = true;\n+                }\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed437e5912b51a559d01886ee7b24c5cae55ddf4"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ4OTQxNg==", "bodyText": "Changed to AtomicBoolean", "url": "https://github.com/openhab/openhab-addons/pull/7741#discussion_r429489416", "createdAt": "2020-05-22T23:35:40Z", "author": {"login": "robnielsen"}, "path": "bundles/org.openhab.binding.insteon/src/main/java/org/openhab/binding/insteon/internal/driver/Port.java", "diffHunk": "@@ -255,6 +265,18 @@ public void modemDBComplete() {\n         driver.modemDBComplete(this);\n     }\n \n+    public void disconnected() {\n+        if (isRunning()) {\n+            synchronized (disconnected) {\n+                if (!disconnected) {\n+                    logger.warn(\"port {} disconnected\", logName);\n+                    driver.disconnected();\n+                    disconnected = true;\n+                }\n+            }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ3MzcwOA=="}, "originalCommit": {"oid": "ed437e5912b51a559d01886ee7b24c5cae55ddf4"}, "originalPosition": 67}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3NDc0NTIyOnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.binding.insteon/src/main/java/org/openhab/binding/insteon/internal/driver/Port.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQyMjowNjo1MlrOGZlCaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQyMzozNTo1MFrOGZl9MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ3NDQwOA==", "bodyText": "If you aren't going to change this to an AtomicBoolean then please make this primitive.", "url": "https://github.com/openhab/openhab-addons/pull/7741#discussion_r429474408", "createdAt": "2020-05-22T22:06:52Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.insteon/src/main/java/org/openhab/binding/insteon/internal/driver/Port.java", "diffHunk": "@@ -83,6 +83,7 @@\n     private ModemDBBuilder mdbb;\n     private ArrayList<MsgListener> listeners = new ArrayList<>();\n     private LinkedBlockingQueue<Msg> writeQueue = new LinkedBlockingQueue<>();\n+    private Boolean disconnected = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed437e5912b51a559d01886ee7b24c5cae55ddf4"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ4OTQ1Ng==", "bodyText": "Changed to AtomicBoolean", "url": "https://github.com/openhab/openhab-addons/pull/7741#discussion_r429489456", "createdAt": "2020-05-22T23:35:50Z", "author": {"login": "robnielsen"}, "path": "bundles/org.openhab.binding.insteon/src/main/java/org/openhab/binding/insteon/internal/driver/Port.java", "diffHunk": "@@ -83,6 +83,7 @@\n     private ModemDBBuilder mdbb;\n     private ArrayList<MsgListener> listeners = new ArrayList<>();\n     private LinkedBlockingQueue<Msg> writeQueue = new LinkedBlockingQueue<>();\n+    private Boolean disconnected = false;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ3NDQwOA=="}, "originalCommit": {"oid": "ed437e5912b51a559d01886ee7b24c5cae55ddf4"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3NDc0NzQ4OnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.binding.insteon/src/main/java/org/openhab/binding/insteon/internal/driver/IOStream.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQyMjowODozN1rOGZlDxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQyMzoyODoyMVrOGZl4vA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ3NDc1Ng==", "bodyText": "Because this is repeatedly checked in a while loop, it would be in your best interest to make this volatile.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private boolean stopped = false;\n          \n          \n            \n                private volatile boolean stopped = false;", "url": "https://github.com/openhab/openhab-addons/pull/7741#discussion_r429474756", "createdAt": "2020-05-22T22:08:37Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.insteon/src/main/java/org/openhab/binding/insteon/internal/driver/IOStream.java", "diffHunk": "@@ -39,6 +39,10 @@\n     protected @Nullable OutputStream out = null;\n     private boolean stopped = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed437e5912b51a559d01886ee7b24c5cae55ddf4"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ4ODMxNg==", "bodyText": "done", "url": "https://github.com/openhab/openhab-addons/pull/7741#discussion_r429488316", "createdAt": "2020-05-22T23:28:21Z", "author": {"login": "robnielsen"}, "path": "bundles/org.openhab.binding.insteon/src/main/java/org/openhab/binding/insteon/internal/driver/IOStream.java", "diffHunk": "@@ -39,6 +39,10 @@\n     protected @Nullable OutputStream out = null;\n     private boolean stopped = false;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ3NDc1Ng=="}, "originalCommit": {"oid": "ed437e5912b51a559d01886ee7b24c5cae55ddf4"}, "originalPosition": 2}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3NDc1NTQ5OnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.binding.insteon/src/main/java/org/openhab/binding/insteon/internal/driver/IOStream.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQyMjoxNTowM1rOGZlIpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQyMzoyNjoxMVrOGZl3OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ3NjAwNw==", "bodyText": "One thing to note, if in.read returns a -1 here, which would indicate the end of the stream, then this code turns into a busy loop.\nThere are two ways you can fix this:\nIf the calling code is expected to handle an eof then you could just break out of the loop and return -1 to the caller.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        len = in.read(b, offset, readSize);\n          \n          \n            \n                        len = in.read(b, offset, readSize);\n          \n          \n            \n                        if(len == -1){\n          \n          \n            \n                            break; \n          \n          \n            \n                        }\n          \n      \n    \n    \n  \n\nIf there is no expectation for the caller to handle a return value of -1, then I suggest throwing an exception instead.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        len = in.read(b, offset, readSize);\n          \n          \n            \n                        len = in.read(b, offset, readSize);\n          \n          \n            \n                        if(len == -1){\n          \n          \n            \n                            throw new EOFException();\n          \n          \n            \n                        }", "url": "https://github.com/openhab/openhab-addons/pull/7741#discussion_r429476007", "createdAt": "2020-05-22T22:15:03Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.insteon/src/main/java/org/openhab/binding/insteon/internal/driver/IOStream.java", "diffHunk": "@@ -51,20 +55,12 @@ public void stop() {\n      * @param readSize size to read\n      * @return number of bytes read\n      */\n-    public int read(byte[] b, int offset, int readSize) throws InterruptedException {\n+    public int read(byte[] b, int offset, int readSize) throws InterruptedException, IOException {\n         int len = 0;\n         while (!stopped && len < 1) {\n-            try {\n-                len = in.read(b, offset, readSize);\n-                if (Thread.interrupted()) {\n-                    throw new InterruptedException();\n-                }\n-            } catch (IOException e) {\n-                logger.trace(\"got exception while reading: {}\", e.getMessage());\n-                while (!stopped && !reconnect()) {\n-                    logger.trace(\"sleeping before reconnecting\");\n-                    Thread.sleep(10000);\n-                }\n+            len = in.read(b, offset, readSize);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed437e5912b51a559d01886ee7b24c5cae55ddf4"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ4NzkyOQ==", "bodyText": "Nice catch, I'm going to have it throw an EOFException. It's been this way for years.", "url": "https://github.com/openhab/openhab-addons/pull/7741#discussion_r429487929", "createdAt": "2020-05-22T23:26:11Z", "author": {"login": "robnielsen"}, "path": "bundles/org.openhab.binding.insteon/src/main/java/org/openhab/binding/insteon/internal/driver/IOStream.java", "diffHunk": "@@ -51,20 +55,12 @@ public void stop() {\n      * @param readSize size to read\n      * @return number of bytes read\n      */\n-    public int read(byte[] b, int offset, int readSize) throws InterruptedException {\n+    public int read(byte[] b, int offset, int readSize) throws InterruptedException, IOException {\n         int len = 0;\n         while (!stopped && len < 1) {\n-            try {\n-                len = in.read(b, offset, readSize);\n-                if (Thread.interrupted()) {\n-                    throw new InterruptedException();\n-                }\n-            } catch (IOException e) {\n-                logger.trace(\"got exception while reading: {}\", e.getMessage());\n-                while (!stopped && !reconnect()) {\n-                    logger.trace(\"sleeping before reconnecting\");\n-                    Thread.sleep(10000);\n-                }\n+            len = in.read(b, offset, readSize);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ3NjAwNw=="}, "originalCommit": {"oid": "ed437e5912b51a559d01886ee7b24c5cae55ddf4"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3NTAwNTcwOnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.binding.insteon/src/main/java/org/openhab/binding/insteon/internal/driver/Port.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yM1QwNDoxNjozMFrOGZnWvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yM1QxMTo0ODozOVrOGZo-4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTUxMjM4MA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    disconnected.getAndSet(false);\n          \n          \n            \n                    disconnected.set(false);", "url": "https://github.com/openhab/openhab-addons/pull/7741#discussion_r429512380", "createdAt": "2020-05-23T04:16:30Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.insteon/src/main/java/org/openhab/binding/insteon/internal/driver/Port.java", "diffHunk": "@@ -188,7 +189,7 @@ public void start() {\n         }\n \n         running = true;\n-        disconnected = false;\n+        disconnected.getAndSet(false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2e3dc465ef2be0fdbee168d9eca58ca7f42a0c7"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTUzOTA0Mg==", "bodyText": "done", "url": "https://github.com/openhab/openhab-addons/pull/7741#discussion_r429539042", "createdAt": "2020-05-23T11:48:39Z", "author": {"login": "robnielsen"}, "path": "bundles/org.openhab.binding.insteon/src/main/java/org/openhab/binding/insteon/internal/driver/Port.java", "diffHunk": "@@ -188,7 +189,7 @@ public void start() {\n         }\n \n         running = true;\n-        disconnected = false;\n+        disconnected.getAndSet(false);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTUxMjM4MA=="}, "originalCommit": {"oid": "c2e3dc465ef2be0fdbee168d9eca58ca7f42a0c7"}, "originalPosition": 22}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 100, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}