{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE0ODIwNzIx", "number": 8952, "reviewThreads": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QyMzowNjo0M1rOE1A3Ug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNzowMToyM1rOE2Kk5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MDI0MTQ2OnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/VigiCruesHandlerFactory.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QyMzowNjo0M1rOHtDpig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QyMzowNjo0M1rOHtDpig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAwNzc1NA==", "bodyText": "You don't even check if the handler being removed is even related to the service you are unregistering?\nTypically you keep track of a map of handler instances to registered services.", "url": "https://github.com/openhab/openhab-addons/pull/8952#discussion_r517007754", "createdAt": "2020-11-03T23:06:43Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/VigiCruesHandlerFactory.java", "diffHunk": "@@ -64,10 +72,13 @@ public boolean supportsThingType(ThingTypeUID thingTypeUID) {\n     protected @Nullable ThingHandler createHandler(Thing thing) {\n         ThingTypeUID thingTypeUID = thing.getThingTypeUID();\n \n-        if (thingTypeUID.equals(THING_TYPE_VIGI_CRUES)) {\n-            return new VigiCruesHandler(thing, timeZoneProvider, gson);\n-        }\n+        return supportsThingType(thingTypeUID) ? new VigiCruesHandler(thing, locationProvider, apiHandler) : null;\n+    }\n \n-        return null;\n+    @Override\n+    protected void removeHandler(ThingHandler thingHandler) {\n+        if (serviceReg != null) {\n+            serviceReg.unregister();\n+        }\n     }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfa65cbc4d78b31a831625487b8437ff3b25fae3"}, "originalPosition": 85}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MDI0MzgzOnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/VigiCruesHandlerFactory.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QyMzowNzo0MVrOHtDq6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxMToxMDo0NVrOHt-bcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAwODEwNQ==", "bodyText": "Why isn't the VigiCruesDiscoveryService a @Component?", "url": "https://github.com/openhab/openhab-addons/pull/8952#discussion_r517008105", "createdAt": "2020-11-03T23:07:41Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/VigiCruesHandlerFactory.java", "diffHunk": "@@ -42,17 +44,23 @@\n @Component(service = ThingHandlerFactory.class, configurationPid = \"binding.vigicrues\")\n @NonNullByDefault\n public class VigiCruesHandlerFactory extends BaseThingHandlerFactory {\n-    private final Gson gson;\n-    // Needed for converting UTC time to local time\n-    private final TimeZoneProvider timeZoneProvider;\n+    private final LocationProvider locationProvider;\n+    private final ApiHandler apiHandler;\n+    private @Nullable ServiceRegistration<?> serviceReg;\n \n     @Activate\n-    public VigiCruesHandlerFactory(@Reference TimeZoneProvider timeZoneProvider) {\n-        this.timeZoneProvider = timeZoneProvider;\n-        this.gson = new GsonBuilder()\n-                .registerTypeAdapter(ZonedDateTime.class, (JsonDeserializer<ZonedDateTime>) (json, type,\n-                        jsonDeserializationContext) -> ZonedDateTime.parse(json.getAsJsonPrimitive().getAsString()))\n-                .create();\n+    public VigiCruesHandlerFactory(@Reference TimeZoneProvider timeZoneProvider,\n+            @Reference LocationProvider locationProvider) {\n+        this.locationProvider = locationProvider;\n+        this.apiHandler = new ApiHandler(timeZoneProvider);\n+    }\n+\n+    @Override\n+    protected void activate(ComponentContext componentContext) {\n+        super.activate(componentContext);\n+        VigiCruesDiscoveryService discoveryService = new VigiCruesDiscoveryService(apiHandler, locationProvider);\n+        serviceReg = bundleContext.registerService(DiscoveryService.class.getName(), discoveryService,\n+                new Hashtable<>());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfa65cbc4d78b31a831625487b8437ff3b25fae3"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI1Mzc5NQ==", "bodyText": "Because it needs the ApiHandler", "url": "https://github.com/openhab/openhab-addons/pull/8952#discussion_r517253795", "createdAt": "2020-11-04T10:45:32Z", "author": {"login": "clinique"}, "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/VigiCruesHandlerFactory.java", "diffHunk": "@@ -42,17 +44,23 @@\n @Component(service = ThingHandlerFactory.class, configurationPid = \"binding.vigicrues\")\n @NonNullByDefault\n public class VigiCruesHandlerFactory extends BaseThingHandlerFactory {\n-    private final Gson gson;\n-    // Needed for converting UTC time to local time\n-    private final TimeZoneProvider timeZoneProvider;\n+    private final LocationProvider locationProvider;\n+    private final ApiHandler apiHandler;\n+    private @Nullable ServiceRegistration<?> serviceReg;\n \n     @Activate\n-    public VigiCruesHandlerFactory(@Reference TimeZoneProvider timeZoneProvider) {\n-        this.timeZoneProvider = timeZoneProvider;\n-        this.gson = new GsonBuilder()\n-                .registerTypeAdapter(ZonedDateTime.class, (JsonDeserializer<ZonedDateTime>) (json, type,\n-                        jsonDeserializationContext) -> ZonedDateTime.parse(json.getAsJsonPrimitive().getAsString()))\n-                .create();\n+    public VigiCruesHandlerFactory(@Reference TimeZoneProvider timeZoneProvider,\n+            @Reference LocationProvider locationProvider) {\n+        this.locationProvider = locationProvider;\n+        this.apiHandler = new ApiHandler(timeZoneProvider);\n+    }\n+\n+    @Override\n+    protected void activate(ComponentContext componentContext) {\n+        super.activate(componentContext);\n+        VigiCruesDiscoveryService discoveryService = new VigiCruesDiscoveryService(apiHandler, locationProvider);\n+        serviceReg = bundleContext.registerService(DiscoveryService.class.getName(), discoveryService,\n+                new Hashtable<>());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAwODEwNQ=="}, "originalCommit": {"oid": "cfa65cbc4d78b31a831625487b8437ff3b25fae3"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU4MzMyMw==", "bodyText": "Why not make the ApiHandler a @Component as well then?", "url": "https://github.com/openhab/openhab-addons/pull/8952#discussion_r517583323", "createdAt": "2020-11-04T19:33:08Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/VigiCruesHandlerFactory.java", "diffHunk": "@@ -42,17 +44,23 @@\n @Component(service = ThingHandlerFactory.class, configurationPid = \"binding.vigicrues\")\n @NonNullByDefault\n public class VigiCruesHandlerFactory extends BaseThingHandlerFactory {\n-    private final Gson gson;\n-    // Needed for converting UTC time to local time\n-    private final TimeZoneProvider timeZoneProvider;\n+    private final LocationProvider locationProvider;\n+    private final ApiHandler apiHandler;\n+    private @Nullable ServiceRegistration<?> serviceReg;\n \n     @Activate\n-    public VigiCruesHandlerFactory(@Reference TimeZoneProvider timeZoneProvider) {\n-        this.timeZoneProvider = timeZoneProvider;\n-        this.gson = new GsonBuilder()\n-                .registerTypeAdapter(ZonedDateTime.class, (JsonDeserializer<ZonedDateTime>) (json, type,\n-                        jsonDeserializationContext) -> ZonedDateTime.parse(json.getAsJsonPrimitive().getAsString()))\n-                .create();\n+    public VigiCruesHandlerFactory(@Reference TimeZoneProvider timeZoneProvider,\n+            @Reference LocationProvider locationProvider) {\n+        this.locationProvider = locationProvider;\n+        this.apiHandler = new ApiHandler(timeZoneProvider);\n+    }\n+\n+    @Override\n+    protected void activate(ComponentContext componentContext) {\n+        super.activate(componentContext);\n+        VigiCruesDiscoveryService discoveryService = new VigiCruesDiscoveryService(apiHandler, locationProvider);\n+        serviceReg = bundleContext.registerService(DiscoveryService.class.getName(), discoveryService,\n+                new Hashtable<>());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAwODEwNQ=="}, "originalCommit": {"oid": "cfa65cbc4d78b31a831625487b8437ff3b25fae3"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk3MDgwMg==", "bodyText": "Did it.", "url": "https://github.com/openhab/openhab-addons/pull/8952#discussion_r517970802", "createdAt": "2020-11-05T11:10:45Z", "author": {"login": "clinique"}, "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/VigiCruesHandlerFactory.java", "diffHunk": "@@ -42,17 +44,23 @@\n @Component(service = ThingHandlerFactory.class, configurationPid = \"binding.vigicrues\")\n @NonNullByDefault\n public class VigiCruesHandlerFactory extends BaseThingHandlerFactory {\n-    private final Gson gson;\n-    // Needed for converting UTC time to local time\n-    private final TimeZoneProvider timeZoneProvider;\n+    private final LocationProvider locationProvider;\n+    private final ApiHandler apiHandler;\n+    private @Nullable ServiceRegistration<?> serviceReg;\n \n     @Activate\n-    public VigiCruesHandlerFactory(@Reference TimeZoneProvider timeZoneProvider) {\n-        this.timeZoneProvider = timeZoneProvider;\n-        this.gson = new GsonBuilder()\n-                .registerTypeAdapter(ZonedDateTime.class, (JsonDeserializer<ZonedDateTime>) (json, type,\n-                        jsonDeserializationContext) -> ZonedDateTime.parse(json.getAsJsonPrimitive().getAsString()))\n-                .create();\n+    public VigiCruesHandlerFactory(@Reference TimeZoneProvider timeZoneProvider,\n+            @Reference LocationProvider locationProvider) {\n+        this.locationProvider = locationProvider;\n+        this.apiHandler = new ApiHandler(timeZoneProvider);\n+    }\n+\n+    @Override\n+    protected void activate(ComponentContext componentContext) {\n+        super.activate(componentContext);\n+        VigiCruesDiscoveryService discoveryService = new VigiCruesDiscoveryService(apiHandler, locationProvider);\n+        serviceReg = bundleContext.registerService(DiscoveryService.class.getName(), discoveryService,\n+                new Hashtable<>());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAwODEwNQ=="}, "originalCommit": {"oid": "cfa65cbc4d78b31a831625487b8437ff3b25fae3"}, "originalPosition": 65}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MDI3OTYwOnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/api/ApiRequest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QyMzoyMzozN1rOHtD_fg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMTowNTo0OVrOHtTYAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAxMzM3NA==", "bodyText": "I don't see much of a purpose of this class. It would be much simpler to replace this class with a series of methods in API handler instead, one for each type of api request.", "url": "https://github.com/openhab/openhab-addons/pull/8952#discussion_r517013374", "createdAt": "2020-11-03T23:23:37Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/api/ApiRequest.java", "diffHunk": "@@ -0,0 +1,108 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.vigicrues.internal.api;\n+\n+import java.util.Locale;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.openhab.binding.vigicrues.internal.dto.hubeau.HubEauResponse;\n+import org.openhab.binding.vigicrues.internal.dto.opendatasoft.OpenDatasoftResponse;\n+import org.openhab.binding.vigicrues.internal.dto.vigicrues.CdStationHydro;\n+import org.openhab.binding.vigicrues.internal.dto.vigicrues.InfoVigiCru;\n+import org.openhab.binding.vigicrues.internal.dto.vigicrues.TerEntVigiCru;\n+import org.openhab.binding.vigicrues.internal.dto.vigicrues.TronEntVigiCru;\n+import org.openhab.core.library.types.PointType;\n+\n+/**\n+ * The {@link APIRequests} defines all the action classes that can be used\n+ * when interaction with Vigicrues API\n+ *\n+ * @author Ga\u00ebl L'hopital - Initial contribution\n+ */\n+@NonNullByDefault\n+public class ApiRequest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfa65cbc4d78b31a831625487b8437ff3b25fae3"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI2NTQxMA==", "bodyText": "Removed", "url": "https://github.com/openhab/openhab-addons/pull/8952#discussion_r517265410", "createdAt": "2020-11-04T11:05:49Z", "author": {"login": "clinique"}, "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/api/ApiRequest.java", "diffHunk": "@@ -0,0 +1,108 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.vigicrues.internal.api;\n+\n+import java.util.Locale;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.openhab.binding.vigicrues.internal.dto.hubeau.HubEauResponse;\n+import org.openhab.binding.vigicrues.internal.dto.opendatasoft.OpenDatasoftResponse;\n+import org.openhab.binding.vigicrues.internal.dto.vigicrues.CdStationHydro;\n+import org.openhab.binding.vigicrues.internal.dto.vigicrues.InfoVigiCru;\n+import org.openhab.binding.vigicrues.internal.dto.vigicrues.TerEntVigiCru;\n+import org.openhab.binding.vigicrues.internal.dto.vigicrues.TronEntVigiCru;\n+import org.openhab.core.library.types.PointType;\n+\n+/**\n+ * The {@link APIRequests} defines all the action classes that can be used\n+ * when interaction with Vigicrues API\n+ *\n+ * @author Ga\u00ebl L'hopital - Initial contribution\n+ */\n+@NonNullByDefault\n+public class ApiRequest {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAxMzM3NA=="}, "originalCommit": {"oid": "cfa65cbc4d78b31a831625487b8437ff3b25fae3"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0Mzk1MDY5OnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/api/ApiHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxOTozMDowMVrOHtmrcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxOTozMDowMVrOHtmrcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU4MTY4Mw==", "bodyText": "You can simplify your api calls a bit by handling the json parsing in this method as well.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private String execute(String url) throws VigiCruesException {\n          \n          \n            \n                    String jsonResponse = \"\";\n          \n          \n            \n                    try {\n          \n          \n            \n                        jsonResponse = HttpUtil.executeUrl(\"GET\", url, TIMEOUT_MS);\n          \n          \n            \n                        return jsonResponse;\n          \n          \n            \n                    } catch (IOException e) {\n          \n          \n            \n                        throw new VigiCruesException(e);\n          \n          \n            \n                    }\n          \n          \n            \n                }\n          \n          \n            \n                private <T> T execute(String url, Class<T> responseType) throws VigiCruesException {\n          \n          \n            \n                   try {\n          \n          \n            \n                        String jsonResponse = HttpUtil.executeUrl(\"GET\", url, TIMEOUT_MS);\n          \n          \n            \n                        return gson.fromJson(response, responseType);\n          \n          \n            \n                    } catch (IOException e) {\n          \n          \n            \n                        throw new VigiCruesException(e);\n          \n          \n            \n                    } catch (JsonSyntaxException e) {\n          \n          \n            \n                        throw new VigiCruesException(e);\n          \n          \n            \n                    }\n          \n          \n            \n                }", "url": "https://github.com/openhab/openhab-addons/pull/8952#discussion_r517581683", "createdAt": "2020-11-04T19:30:01Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/api/ApiHandler.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.vigicrues.internal.api;\n+\n+import java.io.IOException;\n+import java.time.ZonedDateTime;\n+import java.util.Locale;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.openhab.binding.vigicrues.internal.dto.hubeau.HubEauResponse;\n+import org.openhab.binding.vigicrues.internal.dto.opendatasoft.OpenDatasoftResponse;\n+import org.openhab.binding.vigicrues.internal.dto.vigicrues.CdStationHydro;\n+import org.openhab.binding.vigicrues.internal.dto.vigicrues.InfoVigiCru;\n+import org.openhab.binding.vigicrues.internal.dto.vigicrues.TerEntVigiCru;\n+import org.openhab.binding.vigicrues.internal.dto.vigicrues.TronEntVigiCru;\n+import org.openhab.core.i18n.TimeZoneProvider;\n+import org.openhab.core.io.net.http.HttpUtil;\n+import org.openhab.core.library.types.PointType;\n+\n+import com.google.gson.Gson;\n+import com.google.gson.GsonBuilder;\n+import com.google.gson.JsonDeserializer;\n+import com.google.gson.JsonSyntaxException;\n+\n+/**\n+ * The {@link ApiHandler} is the responsible to call a given\n+ * url and transform the answer in the appropriate dto class\n+ *\n+ * @author Ga\u00ebl L'hopital - Initial contribution\n+ */\n+@NonNullByDefault\n+public class ApiHandler {\n+    private static final int TIMEOUT_MS = 30000;\n+    private final Gson gson;\n+\n+    public ApiHandler(TimeZoneProvider timeZoneProvider) {\n+        this.gson = new GsonBuilder().registerTypeAdapter(ZonedDateTime.class,\n+                (JsonDeserializer<ZonedDateTime>) (json, type, jsonDeserializationContext) -> ZonedDateTime\n+                        .parse(json.getAsJsonPrimitive().getAsString())\n+                        .withZoneSameInstant(timeZoneProvider.getTimeZone()))\n+                .create();\n+    }\n+\n+    private String execute(String url) throws VigiCruesException {\n+        String jsonResponse = \"\";\n+        try {\n+            jsonResponse = HttpUtil.executeUrl(\"GET\", url, TIMEOUT_MS);\n+            return jsonResponse;\n+        } catch (IOException e) {\n+            throw new VigiCruesException(e);\n+        }\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "685bf8f3e20a730fbaec799b0a7efd673368b306"}, "originalPosition": 62}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0Mzk1MjY0OnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/api/ApiHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxOTozMDozNlrOHtmspw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxOTozMDozNlrOHtmspw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU4MTk5MQ==", "bodyText": "Please make sure all of your method names are camelcase.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public InfoVigiCru GetTronconStatus(String tronconId) throws VigiCruesException {\n          \n          \n            \n                public InfoVigiCru getTronconStatus(String tronconId) throws VigiCruesException {", "url": "https://github.com/openhab/openhab-addons/pull/8952#discussion_r517581991", "createdAt": "2020-11-04T19:30:36Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/api/ApiHandler.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.vigicrues.internal.api;\n+\n+import java.io.IOException;\n+import java.time.ZonedDateTime;\n+import java.util.Locale;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.openhab.binding.vigicrues.internal.dto.hubeau.HubEauResponse;\n+import org.openhab.binding.vigicrues.internal.dto.opendatasoft.OpenDatasoftResponse;\n+import org.openhab.binding.vigicrues.internal.dto.vigicrues.CdStationHydro;\n+import org.openhab.binding.vigicrues.internal.dto.vigicrues.InfoVigiCru;\n+import org.openhab.binding.vigicrues.internal.dto.vigicrues.TerEntVigiCru;\n+import org.openhab.binding.vigicrues.internal.dto.vigicrues.TronEntVigiCru;\n+import org.openhab.core.i18n.TimeZoneProvider;\n+import org.openhab.core.io.net.http.HttpUtil;\n+import org.openhab.core.library.types.PointType;\n+\n+import com.google.gson.Gson;\n+import com.google.gson.GsonBuilder;\n+import com.google.gson.JsonDeserializer;\n+import com.google.gson.JsonSyntaxException;\n+\n+/**\n+ * The {@link ApiHandler} is the responsible to call a given\n+ * url and transform the answer in the appropriate dto class\n+ *\n+ * @author Ga\u00ebl L'hopital - Initial contribution\n+ */\n+@NonNullByDefault\n+public class ApiHandler {\n+    private static final int TIMEOUT_MS = 30000;\n+    private final Gson gson;\n+\n+    public ApiHandler(TimeZoneProvider timeZoneProvider) {\n+        this.gson = new GsonBuilder().registerTypeAdapter(ZonedDateTime.class,\n+                (JsonDeserializer<ZonedDateTime>) (json, type, jsonDeserializationContext) -> ZonedDateTime\n+                        .parse(json.getAsJsonPrimitive().getAsString())\n+                        .withZoneSameInstant(timeZoneProvider.getTimeZone()))\n+                .create();\n+    }\n+\n+    private String execute(String url) throws VigiCruesException {\n+        String jsonResponse = \"\";\n+        try {\n+            jsonResponse = HttpUtil.executeUrl(\"GET\", url, TIMEOUT_MS);\n+            return jsonResponse;\n+        } catch (IOException e) {\n+            throw new VigiCruesException(e);\n+        }\n+    }\n+\n+    public InfoVigiCru GetTronconStatus(String tronconId) throws VigiCruesException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "685bf8f3e20a730fbaec799b0a7efd673368b306"}, "originalPosition": 64}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0ODg2NjQ1OnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/api/ApiHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQyMDo0MDo0OFrOHuVpPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQyMDo0MDo0OFrOHuVpPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM1MTE2Nw==", "bodyText": "You don't need to supply a configurationPid if your component isn't configurable.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            @Component(service = ApiHandler.class, configurationPid = \"binding.vigicrues.apiHandler\")\n          \n          \n            \n            @Component(service = ApiHandler.class)", "url": "https://github.com/openhab/openhab-addons/pull/8952#discussion_r518351167", "createdAt": "2020-11-05T20:40:48Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/api/ApiHandler.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.vigicrues.internal.api;\n+\n+import java.io.IOException;\n+import java.time.ZonedDateTime;\n+import java.util.Locale;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.openhab.binding.vigicrues.internal.dto.hubeau.HubEauResponse;\n+import org.openhab.binding.vigicrues.internal.dto.opendatasoft.OpenDatasoftResponse;\n+import org.openhab.binding.vigicrues.internal.dto.vigicrues.CdStationHydro;\n+import org.openhab.binding.vigicrues.internal.dto.vigicrues.InfoVigiCru;\n+import org.openhab.binding.vigicrues.internal.dto.vigicrues.TerEntVigiCru;\n+import org.openhab.binding.vigicrues.internal.dto.vigicrues.TronEntVigiCru;\n+import org.openhab.core.i18n.TimeZoneProvider;\n+import org.openhab.core.io.net.http.HttpUtil;\n+import org.openhab.core.library.types.PointType;\n+import org.osgi.service.component.annotations.Activate;\n+import org.osgi.service.component.annotations.Component;\n+import org.osgi.service.component.annotations.Reference;\n+\n+import com.google.gson.Gson;\n+import com.google.gson.GsonBuilder;\n+import com.google.gson.JsonDeserializer;\n+import com.google.gson.JsonSyntaxException;\n+\n+/**\n+ * The {@link ApiHandler} is the responsible to call a given\n+ * url and transform the answer in the appropriate dto class\n+ *\n+ * @author Ga\u00ebl L'hopital - Initial contribution\n+ */\n+\n+@Component(service = ApiHandler.class, configurationPid = \"binding.vigicrues.apiHandler\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62f3e8140ee58b135d1d1d9ed6900475f794982e"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0ODg4MDIxOnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/discovery/VigiCruesDiscoveryService.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQyMDo0NDo1MFrOHuVxhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQwODo0NjoxNFrOHuk-DA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM1MzI4NA==", "bodyText": "This value only ever increases, is it ever reset anywhere? Should it reset as part of stopScan()?", "url": "https://github.com/openhab/openhab-addons/pull/8952#discussion_r518353284", "createdAt": "2020-11-05T20:44:50Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/discovery/VigiCruesDiscoveryService.java", "diffHunk": "@@ -0,0 +1,81 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.vigicrues.internal.discovery;\n+\n+import static org.openhab.binding.vigicrues.internal.VigiCruesBindingConstants.*;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.openhab.binding.vigicrues.internal.StationConfiguration;\n+import org.openhab.binding.vigicrues.internal.api.ApiHandler;\n+import org.openhab.binding.vigicrues.internal.api.VigiCruesException;\n+import org.openhab.binding.vigicrues.internal.dto.hubeau.HubEauResponse;\n+import org.openhab.core.config.discovery.AbstractDiscoveryService;\n+import org.openhab.core.config.discovery.DiscoveryResultBuilder;\n+import org.openhab.core.config.discovery.DiscoveryService;\n+import org.openhab.core.i18n.LocationProvider;\n+import org.openhab.core.library.types.PointType;\n+import org.openhab.core.thing.ThingUID;\n+import org.osgi.service.component.annotations.Activate;\n+import org.osgi.service.component.annotations.Component;\n+import org.osgi.service.component.annotations.Reference;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link VigiCruesDiscoveryService} searches for available\n+ * hydro stations discoverable through API\n+ *\n+ * @author Ga\u00ebl L'hopital - Initial contribution\n+ */\n+@Component(service = DiscoveryService.class, configurationPid = \"discovery.vigicrues\")\n+@NonNullByDefault\n+public class VigiCruesDiscoveryService extends AbstractDiscoveryService {\n+    private static final int SEARCH_TIME = 5;\n+\n+    private final Logger logger = LoggerFactory.getLogger(VigiCruesDiscoveryService.class);\n+    private final LocationProvider locationProvider;\n+    private final ApiHandler apiHandler;\n+\n+    private int searchRange = 10;\n+\n+    @Activate\n+    public VigiCruesDiscoveryService(@Reference ApiHandler apiHandler, @Reference LocationProvider locationProvider) {\n+        super(SUPPORTED_THING_TYPES_UIDS, SEARCH_TIME, false);\n+        this.apiHandler = apiHandler;\n+        this.locationProvider = locationProvider;\n+    }\n+\n+    @Override\n+    public void startScan() {\n+        PointType location = locationProvider.getLocation();\n+        if (location != null) {\n+            try {\n+                HubEauResponse response = apiHandler.discoverStations(location, searchRange);\n+                if (response.count > 0) {\n+                    response.stations.stream().filter(station -> station.enService).forEach(station -> {\n+                        thingDiscovered(DiscoveryResultBuilder\n+                                .create(new ThingUID(THING_TYPE_STATION, station.codeStation))\n+                                .withLabel(station.libelleStation).withRepresentationProperty(StationConfiguration.ID)\n+                                .withProperty(StationConfiguration.ID, station.codeStation).build());\n+                    });\n+                } else {\n+                    logger.info(\"No station exists in a neighbourhood of {} km\", searchRange);\n+                }\n+            } catch (VigiCruesException e) {\n+                logger.warn(\"Error discovering nearby hydro stations : {}\", e.getMessage());\n+            }\n+            searchRange += 10;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62f3e8140ee58b135d1d1d9ed6900475f794982e"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODYwMjI1Mg==", "bodyText": "Yes, the value increases each time a scan is manually launched so the radius of the search is extended per 10km each time. Isn't it a nice idea ?", "url": "https://github.com/openhab/openhab-addons/pull/8952#discussion_r518602252", "createdAt": "2020-11-06T08:46:14Z", "author": {"login": "clinique"}, "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/discovery/VigiCruesDiscoveryService.java", "diffHunk": "@@ -0,0 +1,81 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.vigicrues.internal.discovery;\n+\n+import static org.openhab.binding.vigicrues.internal.VigiCruesBindingConstants.*;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.openhab.binding.vigicrues.internal.StationConfiguration;\n+import org.openhab.binding.vigicrues.internal.api.ApiHandler;\n+import org.openhab.binding.vigicrues.internal.api.VigiCruesException;\n+import org.openhab.binding.vigicrues.internal.dto.hubeau.HubEauResponse;\n+import org.openhab.core.config.discovery.AbstractDiscoveryService;\n+import org.openhab.core.config.discovery.DiscoveryResultBuilder;\n+import org.openhab.core.config.discovery.DiscoveryService;\n+import org.openhab.core.i18n.LocationProvider;\n+import org.openhab.core.library.types.PointType;\n+import org.openhab.core.thing.ThingUID;\n+import org.osgi.service.component.annotations.Activate;\n+import org.osgi.service.component.annotations.Component;\n+import org.osgi.service.component.annotations.Reference;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link VigiCruesDiscoveryService} searches for available\n+ * hydro stations discoverable through API\n+ *\n+ * @author Ga\u00ebl L'hopital - Initial contribution\n+ */\n+@Component(service = DiscoveryService.class, configurationPid = \"discovery.vigicrues\")\n+@NonNullByDefault\n+public class VigiCruesDiscoveryService extends AbstractDiscoveryService {\n+    private static final int SEARCH_TIME = 5;\n+\n+    private final Logger logger = LoggerFactory.getLogger(VigiCruesDiscoveryService.class);\n+    private final LocationProvider locationProvider;\n+    private final ApiHandler apiHandler;\n+\n+    private int searchRange = 10;\n+\n+    @Activate\n+    public VigiCruesDiscoveryService(@Reference ApiHandler apiHandler, @Reference LocationProvider locationProvider) {\n+        super(SUPPORTED_THING_TYPES_UIDS, SEARCH_TIME, false);\n+        this.apiHandler = apiHandler;\n+        this.locationProvider = locationProvider;\n+    }\n+\n+    @Override\n+    public void startScan() {\n+        PointType location = locationProvider.getLocation();\n+        if (location != null) {\n+            try {\n+                HubEauResponse response = apiHandler.discoverStations(location, searchRange);\n+                if (response.count > 0) {\n+                    response.stations.stream().filter(station -> station.enService).forEach(station -> {\n+                        thingDiscovered(DiscoveryResultBuilder\n+                                .create(new ThingUID(THING_TYPE_STATION, station.codeStation))\n+                                .withLabel(station.libelleStation).withRepresentationProperty(StationConfiguration.ID)\n+                                .withProperty(StationConfiguration.ID, station.codeStation).build());\n+                    });\n+                } else {\n+                    logger.info(\"No station exists in a neighbourhood of {} km\", searchRange);\n+                }\n+            } catch (VigiCruesException e) {\n+                logger.warn(\"Error discovering nearby hydro stations : {}\", e.getMessage());\n+            }\n+            searchRange += 10;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM1MzI4NA=="}, "originalCommit": {"oid": "62f3e8140ee58b135d1d1d9ed6900475f794982e"}, "originalPosition": 77}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0ODg4NTY5OnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/handler/VigiCruesHandler.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQyMDo0NjozMVrOHuV0yQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOFQxMToxMjozMFrOHvS49A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM1NDEyMQ==", "bodyText": "Is there any reason you are using QuantityType here? It doesn't seem that you care about the units when you are later using the values as references. Wouldn't just storing as a Double suffice?", "url": "https://github.com/openhab/openhab-addons/pull/8952#discussion_r518354121", "createdAt": "2020-11-05T20:46:31Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/handler/VigiCruesHandler.java", "diffHunk": "@@ -54,35 +74,124 @@\n  */\n @NonNullByDefault\n public class VigiCruesHandler extends BaseThingHandler {\n-    private static final String URL = OPENDATASOFT_URL + \"?dataset=vigicrues&sort=timestamp&q=\";\n-    private static final int TIMEOUT_MS = 30000;\n     private final Logger logger = LoggerFactory.getLogger(VigiCruesHandler.class);\n+    private final LocationProvider locationProvider;\n \n-    // Time zone provider representing time zone configured in openHAB configuration\n-    private final TimeZoneProvider timeZoneProvider;\n-    private final Gson gson;\n     private @Nullable ScheduledFuture<?> refreshJob;\n-    private @Nullable String queryUrl;\n+    private final ApiHandler apiHandler;\n+\n+    private List<QuantityType<?>> referenceHeights = new ArrayList<>();\n+    private List<QuantityType<?>> referenceFlows = new ArrayList<>();\n+    private @Nullable String portion;\n \n-    public VigiCruesHandler(Thing thing, TimeZoneProvider timeZoneProvider, Gson gson) {\n+    public VigiCruesHandler(Thing thing, LocationProvider locationProvider, ApiHandler apiHandler) {\n         super(thing);\n-        this.timeZoneProvider = timeZoneProvider;\n-        this.gson = gson;\n+        this.apiHandler = apiHandler;\n+        this.locationProvider = locationProvider;\n     }\n \n     @Override\n     public void initialize() {\n         logger.debug(\"Initializing VigiCrues handler.\");\n \n-        VigiCruesConfiguration config = getConfigAs(VigiCruesConfiguration.class);\n-        logger.debug(\"config station = {}\", config.id);\n+        StationConfiguration config = getConfigAs(StationConfiguration.class);\n         logger.debug(\"config refresh = {} min\", config.refresh);\n \n         updateStatus(ThingStatus.UNKNOWN);\n-        queryUrl = URL + config.id;\n+\n+        if (thing.getProperties().isEmpty()) {\n+            Map<String, String> properties = discoverAttributes(config);\n+            updateProperties(properties);\n+        }\n+        getReferences();\n         refreshJob = scheduler.scheduleWithFixedDelay(this::updateAndPublish, 0, config.refresh, TimeUnit.MINUTES);\n     }\n \n+    private void getReferences() {\n+        List<QuantityType<?>> heights = new ArrayList<>();\n+        List<QuantityType<?>> flows = new ArrayList<>();\n+        thing.getProperties().keySet().stream().filter(key -> key.startsWith(FLOOD)).forEach(key -> {\n+            String value = thing.getProperties().get(key);\n+            if (key.contains(FLOW)) {\n+                flows.add(new QuantityType<>(value));\n+            } else {\n+                heights.add(new QuantityType<>(value));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62f3e8140ee58b135d1d1d9ed6900475f794982e"}, "originalPosition": 128}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODYwMzMwMA==", "bodyText": "It is a lazy approach to avoid having to cope with units :)", "url": "https://github.com/openhab/openhab-addons/pull/8952#discussion_r518603300", "createdAt": "2020-11-06T08:48:18Z", "author": {"login": "clinique"}, "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/handler/VigiCruesHandler.java", "diffHunk": "@@ -54,35 +74,124 @@\n  */\n @NonNullByDefault\n public class VigiCruesHandler extends BaseThingHandler {\n-    private static final String URL = OPENDATASOFT_URL + \"?dataset=vigicrues&sort=timestamp&q=\";\n-    private static final int TIMEOUT_MS = 30000;\n     private final Logger logger = LoggerFactory.getLogger(VigiCruesHandler.class);\n+    private final LocationProvider locationProvider;\n \n-    // Time zone provider representing time zone configured in openHAB configuration\n-    private final TimeZoneProvider timeZoneProvider;\n-    private final Gson gson;\n     private @Nullable ScheduledFuture<?> refreshJob;\n-    private @Nullable String queryUrl;\n+    private final ApiHandler apiHandler;\n+\n+    private List<QuantityType<?>> referenceHeights = new ArrayList<>();\n+    private List<QuantityType<?>> referenceFlows = new ArrayList<>();\n+    private @Nullable String portion;\n \n-    public VigiCruesHandler(Thing thing, TimeZoneProvider timeZoneProvider, Gson gson) {\n+    public VigiCruesHandler(Thing thing, LocationProvider locationProvider, ApiHandler apiHandler) {\n         super(thing);\n-        this.timeZoneProvider = timeZoneProvider;\n-        this.gson = gson;\n+        this.apiHandler = apiHandler;\n+        this.locationProvider = locationProvider;\n     }\n \n     @Override\n     public void initialize() {\n         logger.debug(\"Initializing VigiCrues handler.\");\n \n-        VigiCruesConfiguration config = getConfigAs(VigiCruesConfiguration.class);\n-        logger.debug(\"config station = {}\", config.id);\n+        StationConfiguration config = getConfigAs(StationConfiguration.class);\n         logger.debug(\"config refresh = {} min\", config.refresh);\n \n         updateStatus(ThingStatus.UNKNOWN);\n-        queryUrl = URL + config.id;\n+\n+        if (thing.getProperties().isEmpty()) {\n+            Map<String, String> properties = discoverAttributes(config);\n+            updateProperties(properties);\n+        }\n+        getReferences();\n         refreshJob = scheduler.scheduleWithFixedDelay(this::updateAndPublish, 0, config.refresh, TimeUnit.MINUTES);\n     }\n \n+    private void getReferences() {\n+        List<QuantityType<?>> heights = new ArrayList<>();\n+        List<QuantityType<?>> flows = new ArrayList<>();\n+        thing.getProperties().keySet().stream().filter(key -> key.startsWith(FLOOD)).forEach(key -> {\n+            String value = thing.getProperties().get(key);\n+            if (key.contains(FLOW)) {\n+                flows.add(new QuantityType<>(value));\n+            } else {\n+                heights.add(new QuantityType<>(value));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM1NDEyMQ=="}, "originalCommit": {"oid": "62f3e8140ee58b135d1d1d9ed6900475f794982e"}, "originalPosition": 128}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTIzNjE0MQ==", "bodyText": "Well a unitless QuantityType is a bit misleading. Can you just use a Double instead?", "url": "https://github.com/openhab/openhab-addons/pull/8952#discussion_r519236141", "createdAt": "2020-11-07T23:57:36Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/handler/VigiCruesHandler.java", "diffHunk": "@@ -54,35 +74,124 @@\n  */\n @NonNullByDefault\n public class VigiCruesHandler extends BaseThingHandler {\n-    private static final String URL = OPENDATASOFT_URL + \"?dataset=vigicrues&sort=timestamp&q=\";\n-    private static final int TIMEOUT_MS = 30000;\n     private final Logger logger = LoggerFactory.getLogger(VigiCruesHandler.class);\n+    private final LocationProvider locationProvider;\n \n-    // Time zone provider representing time zone configured in openHAB configuration\n-    private final TimeZoneProvider timeZoneProvider;\n-    private final Gson gson;\n     private @Nullable ScheduledFuture<?> refreshJob;\n-    private @Nullable String queryUrl;\n+    private final ApiHandler apiHandler;\n+\n+    private List<QuantityType<?>> referenceHeights = new ArrayList<>();\n+    private List<QuantityType<?>> referenceFlows = new ArrayList<>();\n+    private @Nullable String portion;\n \n-    public VigiCruesHandler(Thing thing, TimeZoneProvider timeZoneProvider, Gson gson) {\n+    public VigiCruesHandler(Thing thing, LocationProvider locationProvider, ApiHandler apiHandler) {\n         super(thing);\n-        this.timeZoneProvider = timeZoneProvider;\n-        this.gson = gson;\n+        this.apiHandler = apiHandler;\n+        this.locationProvider = locationProvider;\n     }\n \n     @Override\n     public void initialize() {\n         logger.debug(\"Initializing VigiCrues handler.\");\n \n-        VigiCruesConfiguration config = getConfigAs(VigiCruesConfiguration.class);\n-        logger.debug(\"config station = {}\", config.id);\n+        StationConfiguration config = getConfigAs(StationConfiguration.class);\n         logger.debug(\"config refresh = {} min\", config.refresh);\n \n         updateStatus(ThingStatus.UNKNOWN);\n-        queryUrl = URL + config.id;\n+\n+        if (thing.getProperties().isEmpty()) {\n+            Map<String, String> properties = discoverAttributes(config);\n+            updateProperties(properties);\n+        }\n+        getReferences();\n         refreshJob = scheduler.scheduleWithFixedDelay(this::updateAndPublish, 0, config.refresh, TimeUnit.MINUTES);\n     }\n \n+    private void getReferences() {\n+        List<QuantityType<?>> heights = new ArrayList<>();\n+        List<QuantityType<?>> flows = new ArrayList<>();\n+        thing.getProperties().keySet().stream().filter(key -> key.startsWith(FLOOD)).forEach(key -> {\n+            String value = thing.getProperties().get(key);\n+            if (key.contains(FLOW)) {\n+                flows.add(new QuantityType<>(value));\n+            } else {\n+                heights.add(new QuantityType<>(value));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM1NDEyMQ=="}, "originalCommit": {"oid": "62f3e8140ee58b135d1d1d9ed6900475f794982e"}, "originalPosition": 128}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTM1NDYxMg==", "bodyText": "There is a unit in the incoming data", "url": "https://github.com/openhab/openhab-addons/pull/8952#discussion_r519354612", "createdAt": "2020-11-08T11:12:30Z", "author": {"login": "clinique"}, "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/handler/VigiCruesHandler.java", "diffHunk": "@@ -54,35 +74,124 @@\n  */\n @NonNullByDefault\n public class VigiCruesHandler extends BaseThingHandler {\n-    private static final String URL = OPENDATASOFT_URL + \"?dataset=vigicrues&sort=timestamp&q=\";\n-    private static final int TIMEOUT_MS = 30000;\n     private final Logger logger = LoggerFactory.getLogger(VigiCruesHandler.class);\n+    private final LocationProvider locationProvider;\n \n-    // Time zone provider representing time zone configured in openHAB configuration\n-    private final TimeZoneProvider timeZoneProvider;\n-    private final Gson gson;\n     private @Nullable ScheduledFuture<?> refreshJob;\n-    private @Nullable String queryUrl;\n+    private final ApiHandler apiHandler;\n+\n+    private List<QuantityType<?>> referenceHeights = new ArrayList<>();\n+    private List<QuantityType<?>> referenceFlows = new ArrayList<>();\n+    private @Nullable String portion;\n \n-    public VigiCruesHandler(Thing thing, TimeZoneProvider timeZoneProvider, Gson gson) {\n+    public VigiCruesHandler(Thing thing, LocationProvider locationProvider, ApiHandler apiHandler) {\n         super(thing);\n-        this.timeZoneProvider = timeZoneProvider;\n-        this.gson = gson;\n+        this.apiHandler = apiHandler;\n+        this.locationProvider = locationProvider;\n     }\n \n     @Override\n     public void initialize() {\n         logger.debug(\"Initializing VigiCrues handler.\");\n \n-        VigiCruesConfiguration config = getConfigAs(VigiCruesConfiguration.class);\n-        logger.debug(\"config station = {}\", config.id);\n+        StationConfiguration config = getConfigAs(StationConfiguration.class);\n         logger.debug(\"config refresh = {} min\", config.refresh);\n \n         updateStatus(ThingStatus.UNKNOWN);\n-        queryUrl = URL + config.id;\n+\n+        if (thing.getProperties().isEmpty()) {\n+            Map<String, String> properties = discoverAttributes(config);\n+            updateProperties(properties);\n+        }\n+        getReferences();\n         refreshJob = scheduler.scheduleWithFixedDelay(this::updateAndPublish, 0, config.refresh, TimeUnit.MINUTES);\n     }\n \n+    private void getReferences() {\n+        List<QuantityType<?>> heights = new ArrayList<>();\n+        List<QuantityType<?>> flows = new ArrayList<>();\n+        thing.getProperties().keySet().stream().filter(key -> key.startsWith(FLOOD)).forEach(key -> {\n+            String value = thing.getProperties().get(key);\n+            if (key.contains(FLOW)) {\n+                flows.add(new QuantityType<>(value));\n+            } else {\n+                heights.add(new QuantityType<>(value));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM1NDEyMQ=="}, "originalCommit": {"oid": "62f3e8140ee58b135d1d1d9ed6900475f794982e"}, "originalPosition": 128}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0ODkyMDcwOnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/handler/VigiCruesHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQyMDo1Njo0M1rOHuWJ8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQyMDo1Njo0M1rOHuWJ8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM1OTUzOQ==", "bodyText": "I don't think that bindings should be interacting with the osgi framework directly like this. Since your resources would be located in the same jar as the compiled code It should be more than sufficient to load the resource using the classloader found from VigiCruesHandler.class.getClassLoader()\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    Bundle bundle = FrameworkUtil.getBundle(getClass());\n          \n          \n            \n                    try (InputStream stream = bundle.getResource(iconPath).openStream()) {\n          \n          \n            \n                    try (InputStream stream = VigiCruesHandler.class.getClassLoader().getResourceAsStream()) {", "url": "https://github.com/openhab/openhab-addons/pull/8952#discussion_r518359539", "createdAt": "2020-11-05T20:56:43Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/handler/VigiCruesHandler.java", "diffHunk": "@@ -133,8 +258,29 @@ private void updateQuantity(String channelId, Double value, Unit<?> unit) {\n \n     public void updateDate(String channelId, ZonedDateTime zonedDateTime) {\n         if (isLinked(channelId)) {\n-            ZonedDateTime localDateTime = zonedDateTime.withZoneSameInstant(timeZoneProvider.getTimeZone());\n-            updateState(channelId, new DateTimeType(localDateTime));\n+            updateState(channelId, new DateTimeType(zonedDateTime));\n+        }\n+    }\n+\n+    public void updateAlert(String channelId, int value) {\n+        String channelIcon = channelId + \"-icon\";\n+        if (isLinked(channelId)) {\n+            updateState(channelId, new DecimalType(value));\n+        }\n+        if (isLinked(channelIcon)) {\n+            String resource = getResource(String.format(\"picto/crue-%d.svg\", value));\n+            updateState(channelIcon,\n+                    resource != null ? new RawType(resource.getBytes(), \"image/svg+xml\") : UnDefType.UNDEF);\n+        }\n+    }\n+\n+    public @Nullable String getResource(String iconPath) {\n+        Bundle bundle = FrameworkUtil.getBundle(getClass());\n+        try (InputStream stream = bundle.getResource(iconPath).openStream()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62f3e8140ee58b135d1d1d9ed6900475f794982e"}, "originalPosition": 292}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0ODkyNjgxOnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/handler/VigiCruesHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQyMDo1ODo0N1rOHuWNvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQyMDo1ODo0N1rOHuWNvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM2MDUxMA==", "bodyText": "Since you are only using this to load binary data perhaps you should just return a byte array instead.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public @Nullable String getResource(String iconPath) {\n          \n          \n            \n                public byte @Nullable [] getResource(String iconPath) {", "url": "https://github.com/openhab/openhab-addons/pull/8952#discussion_r518360510", "createdAt": "2020-11-05T20:58:47Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/handler/VigiCruesHandler.java", "diffHunk": "@@ -133,8 +258,29 @@ private void updateQuantity(String channelId, Double value, Unit<?> unit) {\n \n     public void updateDate(String channelId, ZonedDateTime zonedDateTime) {\n         if (isLinked(channelId)) {\n-            ZonedDateTime localDateTime = zonedDateTime.withZoneSameInstant(timeZoneProvider.getTimeZone());\n-            updateState(channelId, new DateTimeType(localDateTime));\n+            updateState(channelId, new DateTimeType(zonedDateTime));\n+        }\n+    }\n+\n+    public void updateAlert(String channelId, int value) {\n+        String channelIcon = channelId + \"-icon\";\n+        if (isLinked(channelId)) {\n+            updateState(channelId, new DecimalType(value));\n+        }\n+        if (isLinked(channelIcon)) {\n+            String resource = getResource(String.format(\"picto/crue-%d.svg\", value));\n+            updateState(channelIcon,\n+                    resource != null ? new RawType(resource.getBytes(), \"image/svg+xml\") : UnDefType.UNDEF);\n+        }\n+    }\n+\n+    public @Nullable String getResource(String iconPath) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62f3e8140ee58b135d1d1d9ed6900475f794982e"}, "originalPosition": 290}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0ODkzMjA5OnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/handler/VigiCruesHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQyMTowMDoxOFrOHuWQ5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQyMTowMDoxOFrOHuWQ5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM2MTMxOQ==", "bodyText": "If you want to just return a binary array this can be vastly simplified due to java 11.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        return new BufferedReader(new InputStreamReader(stream)).lines().collect(Collectors.joining(\"\\n\"));\n          \n          \n            \n                        return stream.readAllBytes();", "url": "https://github.com/openhab/openhab-addons/pull/8952#discussion_r518361319", "createdAt": "2020-11-05T21:00:18Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/handler/VigiCruesHandler.java", "diffHunk": "@@ -133,8 +258,29 @@ private void updateQuantity(String channelId, Double value, Unit<?> unit) {\n \n     public void updateDate(String channelId, ZonedDateTime zonedDateTime) {\n         if (isLinked(channelId)) {\n-            ZonedDateTime localDateTime = zonedDateTime.withZoneSameInstant(timeZoneProvider.getTimeZone());\n-            updateState(channelId, new DateTimeType(localDateTime));\n+            updateState(channelId, new DateTimeType(zonedDateTime));\n+        }\n+    }\n+\n+    public void updateAlert(String channelId, int value) {\n+        String channelIcon = channelId + \"-icon\";\n+        if (isLinked(channelId)) {\n+            updateState(channelId, new DecimalType(value));\n+        }\n+        if (isLinked(channelIcon)) {\n+            String resource = getResource(String.format(\"picto/crue-%d.svg\", value));\n+            updateState(channelIcon,\n+                    resource != null ? new RawType(resource.getBytes(), \"image/svg+xml\") : UnDefType.UNDEF);\n+        }\n+    }\n+\n+    public @Nullable String getResource(String iconPath) {\n+        Bundle bundle = FrameworkUtil.getBundle(getClass());\n+        try (InputStream stream = bundle.getResource(iconPath).openStream()) {\n+            return new BufferedReader(new InputStreamReader(stream)).lines().collect(Collectors.joining(\"\\n\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62f3e8140ee58b135d1d1d9ed6900475f794982e"}, "originalPosition": 293}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0ODkzOTc5OnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/handler/VigiCruesHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQyMTowMjozOVrOHuWVkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQyMTowMjozOVrOHuWVkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM2MjUxNA==", "bodyText": "IIRC QuantityType accepts a plain Number argument and DecimalType extends Number.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                properties.put(DISTANCE, new QuantityType<>(distance.intValue(), SIUnits.METRE).toString());\n          \n          \n            \n                                properties.put(DISTANCE, new QuantityType<>(distance, SIUnits.METRE).toString());", "url": "https://github.com/openhab/openhab-addons/pull/8952#discussion_r518362514", "createdAt": "2020-11-05T21:02:39Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/handler/VigiCruesHandler.java", "diffHunk": "@@ -54,35 +74,124 @@\n  */\n @NonNullByDefault\n public class VigiCruesHandler extends BaseThingHandler {\n-    private static final String URL = OPENDATASOFT_URL + \"?dataset=vigicrues&sort=timestamp&q=\";\n-    private static final int TIMEOUT_MS = 30000;\n     private final Logger logger = LoggerFactory.getLogger(VigiCruesHandler.class);\n+    private final LocationProvider locationProvider;\n \n-    // Time zone provider representing time zone configured in openHAB configuration\n-    private final TimeZoneProvider timeZoneProvider;\n-    private final Gson gson;\n     private @Nullable ScheduledFuture<?> refreshJob;\n-    private @Nullable String queryUrl;\n+    private final ApiHandler apiHandler;\n+\n+    private List<QuantityType<?>> referenceHeights = new ArrayList<>();\n+    private List<QuantityType<?>> referenceFlows = new ArrayList<>();\n+    private @Nullable String portion;\n \n-    public VigiCruesHandler(Thing thing, TimeZoneProvider timeZoneProvider, Gson gson) {\n+    public VigiCruesHandler(Thing thing, LocationProvider locationProvider, ApiHandler apiHandler) {\n         super(thing);\n-        this.timeZoneProvider = timeZoneProvider;\n-        this.gson = gson;\n+        this.apiHandler = apiHandler;\n+        this.locationProvider = locationProvider;\n     }\n \n     @Override\n     public void initialize() {\n         logger.debug(\"Initializing VigiCrues handler.\");\n \n-        VigiCruesConfiguration config = getConfigAs(VigiCruesConfiguration.class);\n-        logger.debug(\"config station = {}\", config.id);\n+        StationConfiguration config = getConfigAs(StationConfiguration.class);\n         logger.debug(\"config refresh = {} min\", config.refresh);\n \n         updateStatus(ThingStatus.UNKNOWN);\n-        queryUrl = URL + config.id;\n+\n+        if (thing.getProperties().isEmpty()) {\n+            Map<String, String> properties = discoverAttributes(config);\n+            updateProperties(properties);\n+        }\n+        getReferences();\n         refreshJob = scheduler.scheduleWithFixedDelay(this::updateAndPublish, 0, config.refresh, TimeUnit.MINUTES);\n     }\n \n+    private void getReferences() {\n+        List<QuantityType<?>> heights = new ArrayList<>();\n+        List<QuantityType<?>> flows = new ArrayList<>();\n+        thing.getProperties().keySet().stream().filter(key -> key.startsWith(FLOOD)).forEach(key -> {\n+            String value = thing.getProperties().get(key);\n+            if (key.contains(FLOW)) {\n+                flows.add(new QuantityType<>(value));\n+            } else {\n+                heights.add(new QuantityType<>(value));\n+            }\n+        });\n+        referenceHeights = heights.stream().distinct().sorted().collect(Collectors.toList());\n+        referenceFlows = flows.stream().distinct().sorted().collect(Collectors.toList());\n+        portion = thing.getProperties().get(TRONCON);\n+    }\n+\n+    private Map<String, String> discoverAttributes(StationConfiguration config) {\n+        Map<String, String> properties = new HashMap<>();\n+\n+        ThingBuilder thingBuilder = editThing();\n+        List<Channel> channels = new ArrayList<>(getThing().getChannels());\n+\n+        try {\n+            HubEauResponse stationDetails = apiHandler.discoverStations(config.id);\n+            stationDetails.stations.stream().findFirst().ifPresent(station -> {\n+                PointType stationLocation = new PointType(\n+                        String.format(Locale.US, \"%f,%f\", station.latitudeStation, station.longitudeStation));\n+                properties.put(LOCATION, stationLocation.toString());\n+                PointType serverLocation = locationProvider.getLocation();\n+                if (serverLocation != null) {\n+                    DecimalType distance = serverLocation.distanceFrom(stationLocation);\n+                    properties.put(DISTANCE, new QuantityType<>(distance.intValue(), SIUnits.METRE).toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62f3e8140ee58b135d1d1d9ed6900475f794982e"}, "originalPosition": 151}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0ODk1NzUyOnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/handler/VigiCruesHandler.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQyMTowODoxNVrOHuWgbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQwODo1ODo0MlrOHulYMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM2NTI5Mg==", "bodyText": "What is the point of keeping track of multiple reference values if you only care about the first one?", "url": "https://github.com/openhab/openhab-addons/pull/8952#discussion_r518365292", "createdAt": "2020-11-05T21:08:15Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/handler/VigiCruesHandler.java", "diffHunk": "@@ -102,26 +211,42 @@ public void handleCommand(ChannelUID channelUID, Command command) {\n     }\n \n     private void updateAndPublish() {\n+        StationConfiguration config = getConfigAs(StationConfiguration.class);\n         try {\n-            if (queryUrl != null) {\n-                String response = HttpUtil.executeUrl(\"GET\", queryUrl, TIMEOUT_MS);\n-                updateStatus(ThingStatus.ONLINE);\n-                OpenDatasoftResponse apiResponse = gson.fromJson(response, OpenDatasoftResponse.class);\n-                Arrays.stream(apiResponse.getRecords()).findFirst().flatMap(Record::getFields).ifPresent(field -> {\n-                    field.getHeight().ifPresent(height -> updateQuantity(HEIGHT, height, METRE));\n-                    field.getFlow().ifPresent(flow -> updateQuantity(FLOW, flow, CUBICMETRE_PER_SECOND));\n-                    field.getTimestamp().ifPresent(date -> updateDate(OBSERVATION_TIME, date));\n+            OpenDatasoftResponse measures = apiHandler.getMeasures(config.id);\n+            measures.getFirstRecord().ifPresent(field -> {\n+                field.getHeight().ifPresent(height -> {\n+                    updateQuantity(HEIGHT, height, SIUnits.METRE);\n+                    updateRelativeMeasure(RELATIVE_HEIGHT, referenceHeights, height);\n                 });\n-            } else {\n-                updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.DISABLED,\n-                        \"queryUrl should never be null, but it is !\");\n+                field.getFlow().ifPresent(flow -> {\n+                    updateQuantity(FLOW, flow, SmartHomeUnits.CUBICMETRE_PER_SECOND);\n+                    updateRelativeMeasure(RELATIVE_FLOW, referenceFlows, flow);\n+                });\n+                field.getTimestamp().ifPresent(date -> updateDate(OBSERVATION_TIME, date));\n+            });\n+            if (portion != null) {\n+                InfoVigiCru status = apiHandler.getTronconStatus(portion);\n+                updateAlert(ALERT, status.vicInfoVigiCru.vicNivInfoVigiCru - 1);\n+                updateString(SHORT_COMMENT, status.vicInfoVigiCru.vicSituActuInfoVigiCru);\n+                updateString(COMMENT, status.vicInfoVigiCru.vicQualifInfoVigiCru);\n             }\n-        } catch (MalformedURLException e) {\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.CONFIGURATION_ERROR,\n-                    String.format(\"Querying '%s' raised : %s\", queryUrl, e.getMessage()));\n-        } catch (IOException e) {\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR,\n-                    String.format(\"Error opening connection to VigiCrues webservice : {}\", e.getMessage()));\n+            updateStatus(ThingStatus.ONLINE);\n+        } catch (VigiCruesException e) {\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.DISABLED, e.getMessage());\n+        }\n+    }\n+\n+    private void updateString(String channelId, String value) {\n+        if (isLinked(channelId)) {\n+            updateState(channelId, new StringType(value));\n+        }\n+    }\n+\n+    private void updateRelativeMeasure(String channelId, List<QuantityType<?>> reference, double value) {\n+        if (reference.size() > 0) {\n+            double percent = value / reference.get(0).doubleValue() * 100;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62f3e8140ee58b135d1d1d9ed6900475f794982e"}, "originalPosition": 263}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODYwODk0Nw==", "bodyText": "I currently use the lowest value as reference, but maybe we could introduce a setting to let the user decide if he wants it compared to lowest or highest. Reason why I did it this way.", "url": "https://github.com/openhab/openhab-addons/pull/8952#discussion_r518608947", "createdAt": "2020-11-06T08:58:42Z", "author": {"login": "clinique"}, "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/handler/VigiCruesHandler.java", "diffHunk": "@@ -102,26 +211,42 @@ public void handleCommand(ChannelUID channelUID, Command command) {\n     }\n \n     private void updateAndPublish() {\n+        StationConfiguration config = getConfigAs(StationConfiguration.class);\n         try {\n-            if (queryUrl != null) {\n-                String response = HttpUtil.executeUrl(\"GET\", queryUrl, TIMEOUT_MS);\n-                updateStatus(ThingStatus.ONLINE);\n-                OpenDatasoftResponse apiResponse = gson.fromJson(response, OpenDatasoftResponse.class);\n-                Arrays.stream(apiResponse.getRecords()).findFirst().flatMap(Record::getFields).ifPresent(field -> {\n-                    field.getHeight().ifPresent(height -> updateQuantity(HEIGHT, height, METRE));\n-                    field.getFlow().ifPresent(flow -> updateQuantity(FLOW, flow, CUBICMETRE_PER_SECOND));\n-                    field.getTimestamp().ifPresent(date -> updateDate(OBSERVATION_TIME, date));\n+            OpenDatasoftResponse measures = apiHandler.getMeasures(config.id);\n+            measures.getFirstRecord().ifPresent(field -> {\n+                field.getHeight().ifPresent(height -> {\n+                    updateQuantity(HEIGHT, height, SIUnits.METRE);\n+                    updateRelativeMeasure(RELATIVE_HEIGHT, referenceHeights, height);\n                 });\n-            } else {\n-                updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.DISABLED,\n-                        \"queryUrl should never be null, but it is !\");\n+                field.getFlow().ifPresent(flow -> {\n+                    updateQuantity(FLOW, flow, SmartHomeUnits.CUBICMETRE_PER_SECOND);\n+                    updateRelativeMeasure(RELATIVE_FLOW, referenceFlows, flow);\n+                });\n+                field.getTimestamp().ifPresent(date -> updateDate(OBSERVATION_TIME, date));\n+            });\n+            if (portion != null) {\n+                InfoVigiCru status = apiHandler.getTronconStatus(portion);\n+                updateAlert(ALERT, status.vicInfoVigiCru.vicNivInfoVigiCru - 1);\n+                updateString(SHORT_COMMENT, status.vicInfoVigiCru.vicSituActuInfoVigiCru);\n+                updateString(COMMENT, status.vicInfoVigiCru.vicQualifInfoVigiCru);\n             }\n-        } catch (MalformedURLException e) {\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.CONFIGURATION_ERROR,\n-                    String.format(\"Querying '%s' raised : %s\", queryUrl, e.getMessage()));\n-        } catch (IOException e) {\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR,\n-                    String.format(\"Error opening connection to VigiCrues webservice : {}\", e.getMessage()));\n+            updateStatus(ThingStatus.ONLINE);\n+        } catch (VigiCruesException e) {\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.DISABLED, e.getMessage());\n+        }\n+    }\n+\n+    private void updateString(String channelId, String value) {\n+        if (isLinked(channelId)) {\n+            updateState(channelId, new StringType(value));\n+        }\n+    }\n+\n+    private void updateRelativeMeasure(String channelId, List<QuantityType<?>> reference, double value) {\n+        if (reference.size() > 0) {\n+            double percent = value / reference.get(0).doubleValue() * 100;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM2NTI5Mg=="}, "originalCommit": {"oid": "62f3e8140ee58b135d1d1d9ed6900475f794982e"}, "originalPosition": 263}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0ODk3NDA2OnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/handler/VigiCruesHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQyMToxMzoyNVrOHuWqHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQyMToxMzoyNVrOHuWqHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM2Nzc3NQ==", "bodyText": "Bindings should never use ThingStatusDetail.DISABLED, that is reserved for the core. Please use ThingStatusDetail.COMMUNICATION_ERROR instead.", "url": "https://github.com/openhab/openhab-addons/pull/8952#discussion_r518367775", "createdAt": "2020-11-05T21:13:25Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/handler/VigiCruesHandler.java", "diffHunk": "@@ -102,26 +211,42 @@ public void handleCommand(ChannelUID channelUID, Command command) {\n     }\n \n     private void updateAndPublish() {\n+        StationConfiguration config = getConfigAs(StationConfiguration.class);\n         try {\n-            if (queryUrl != null) {\n-                String response = HttpUtil.executeUrl(\"GET\", queryUrl, TIMEOUT_MS);\n-                updateStatus(ThingStatus.ONLINE);\n-                OpenDatasoftResponse apiResponse = gson.fromJson(response, OpenDatasoftResponse.class);\n-                Arrays.stream(apiResponse.getRecords()).findFirst().flatMap(Record::getFields).ifPresent(field -> {\n-                    field.getHeight().ifPresent(height -> updateQuantity(HEIGHT, height, METRE));\n-                    field.getFlow().ifPresent(flow -> updateQuantity(FLOW, flow, CUBICMETRE_PER_SECOND));\n-                    field.getTimestamp().ifPresent(date -> updateDate(OBSERVATION_TIME, date));\n+            OpenDatasoftResponse measures = apiHandler.getMeasures(config.id);\n+            measures.getFirstRecord().ifPresent(field -> {\n+                field.getHeight().ifPresent(height -> {\n+                    updateQuantity(HEIGHT, height, SIUnits.METRE);\n+                    updateRelativeMeasure(RELATIVE_HEIGHT, referenceHeights, height);\n                 });\n-            } else {\n-                updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.DISABLED,\n-                        \"queryUrl should never be null, but it is !\");\n+                field.getFlow().ifPresent(flow -> {\n+                    updateQuantity(FLOW, flow, SmartHomeUnits.CUBICMETRE_PER_SECOND);\n+                    updateRelativeMeasure(RELATIVE_FLOW, referenceFlows, flow);\n+                });\n+                field.getTimestamp().ifPresent(date -> updateDate(OBSERVATION_TIME, date));\n+            });\n+            if (portion != null) {\n+                InfoVigiCru status = apiHandler.getTronconStatus(portion);\n+                updateAlert(ALERT, status.vicInfoVigiCru.vicNivInfoVigiCru - 1);\n+                updateString(SHORT_COMMENT, status.vicInfoVigiCru.vicSituActuInfoVigiCru);\n+                updateString(COMMENT, status.vicInfoVigiCru.vicQualifInfoVigiCru);\n             }\n-        } catch (MalformedURLException e) {\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.CONFIGURATION_ERROR,\n-                    String.format(\"Querying '%s' raised : %s\", queryUrl, e.getMessage()));\n-        } catch (IOException e) {\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR,\n-                    String.format(\"Error opening connection to VigiCrues webservice : {}\", e.getMessage()));\n+            updateStatus(ThingStatus.ONLINE);\n+        } catch (VigiCruesException e) {\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.DISABLED, e.getMessage());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62f3e8140ee58b135d1d1d9ed6900475f794982e"}, "originalPosition": 251}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1MjMxODQ3OnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/discovery/VigiCruesDiscoveryService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNzowMToyM1rOHu2GRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNzowMToyM1rOHu2GRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg4Mjg4Ng==", "bodyText": "You shouldn't have changed this one. You were supposed to remove the one from ApiHandler instead.", "url": "https://github.com/openhab/openhab-addons/pull/8952#discussion_r518882886", "createdAt": "2020-11-06T17:01:23Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/discovery/VigiCruesDiscoveryService.java", "diffHunk": "@@ -37,7 +37,7 @@\n  *\n  * @author Ga\u00ebl L'hopital - Initial contribution\n  */\n-@Component(service = DiscoveryService.class, configurationPid = \"discovery.vigicrues\")\n+@Component(service = DiscoveryService.class)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3885b5e6d8bd9b08de9914df6ede5d89f53f9557"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4035, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}