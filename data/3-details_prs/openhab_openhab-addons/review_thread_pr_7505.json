{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDExMTA5OTg2", "number": 7505, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxODoyNzozOVrOD4KHaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQwMjoxMTo1NFrOD4RH9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwMjEyNTg1OnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.binding.coolmasternet/src/main/java/org/openhab/binding/coolmasternet/internal/ControllerHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxODoyNzozOVrOGO1T8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxODoyNzozOVrOGO1T8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIwNjcwNg==", "bodyText": "If the stream isn't meant to be closed, there is no reason to use a try-with-resources.", "url": "https://github.com/openhab/openhab-addons/pull/7505#discussion_r418206706", "createdAt": "2020-04-30T18:27:39Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.coolmasternet/src/main/java/org/openhab/binding/coolmasternet/internal/ControllerHandler.java", "diffHunk": "@@ -146,9 +151,10 @@ public boolean isConnected() {\n                 logger.trace(\"Sending command '{}'\", command);\n                 OutputStream out = localSocket.getOutputStream();\n                 out.write(command.getBytes());\n-                out.write(\"\\r\\n\".getBytes());\n+                out.write(\"\\n\".getBytes());\n \n-                try (Reader isr = new InputStreamReader(localSocket.getInputStream());\n+                try (InputStream uis = new UncloseableInputStream(localSocket.getInputStream());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4356e59af432fdc7d774d4897d52a4ad800c6baf"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwMjIxMDY1OnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.binding.coolmasternet/src/main/java/org/openhab/binding/coolmasternet/internal/ControllerHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxODo1MzozN1rOGO2KgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxODo1MzozN1rOGO2KgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIyMDY3Mg==", "bodyText": "The charset should be specified here.", "url": "https://github.com/openhab/openhab-addons/pull/7505#discussion_r418220672", "createdAt": "2020-04-30T18:53:37Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.coolmasternet/src/main/java/org/openhab/binding/coolmasternet/internal/ControllerHandler.java", "diffHunk": "@@ -146,9 +151,10 @@ public boolean isConnected() {\n                 logger.trace(\"Sending command '{}'\", command);\n                 OutputStream out = localSocket.getOutputStream();\n                 out.write(command.getBytes());\n-                out.write(\"\\r\\n\".getBytes());\n+                out.write(\"\\n\".getBytes());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4356e59af432fdc7d774d4897d52a4ad800c6baf"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwMjIxNzQ4OnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.binding.coolmasternet/src/main/java/org/openhab/binding/coolmasternet/internal/ControllerHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxODo1NTozOVrOGO2Oxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxODo1NTozOVrOGO2Oxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIyMTc2Nw==", "bodyText": "This will busy-loop if there is no input available.", "url": "https://github.com/openhab/openhab-addons/pull/7505#discussion_r418221767", "createdAt": "2020-04-30T18:55:39Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.coolmasternet/src/main/java/org/openhab/binding/coolmasternet/internal/ControllerHandler.java", "diffHunk": "@@ -205,21 +211,35 @@ private void checkConnection() throws CoolMasterClientError {\n                 }\n \n                 InputStream in = localSocket.getInputStream();\n-                /* Flush anything pending in the input stream */\n-                while (in.available() > 0) {\n-                    in.read();\n+\n+                // Sink (clear) buffer until earlier of the SINK_TIMEOUT or > prompt\n+                long deadline = System.currentTimeMillis() + SINK_TIMEOUT;\n+                while (System.currentTimeMillis() < deadline) {\n+                    if (in.available() > 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4356e59af432fdc7d774d4897d52a4ad800c6baf"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwMzEyMjMxOnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.binding.coolmasternet/src/main/java/org/openhab/binding/coolmasternet/internal/ControllerHandler.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQwMDozMzo1MlrOGO-4JQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQwMToxMDo0NVrOGO_bPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM2MzQyOQ==", "bodyText": "in.readLine() will return null if the end of stream is reached. If that happens your code here will go into an infinite loop.", "url": "https://github.com/openhab/openhab-addons/pull/7505#discussion_r418363429", "createdAt": "2020-05-01T00:33:52Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.coolmasternet/src/main/java/org/openhab/binding/coolmasternet/internal/ControllerHandler.java", "diffHunk": "@@ -146,25 +151,19 @@ public boolean isConnected() {\n                 logger.trace(\"Sending command '{}'\", command);\n                 OutputStream out = localSocket.getOutputStream();\n                 out.write(command.getBytes());\n-                out.write(\"\\r\\n\".getBytes());\n+                out.write(LF);\n \n-                try (Reader isr = new InputStreamReader(localSocket.getInputStream());\n-                        BufferedReader in = new BufferedReader(isr)) {\n-                    while (true) {\n-                        String line = in.readLine();\n-                        logger.trace(\"Read result '{}'\", line);\n-                        if (\"OK\".equals(line)) {\n-                            return response.toString();\n-                        }\n-                        response.append(line);\n-                        if (response.length() > 100) {\n-                            /*\n-                             * Usually this loop times out on errors, but in the case that we just keep getting\n-                             * data we should also fail with an error.\n-                             */\n-                            throw new CoolMasterClientError(\n-                                    String.format(\"Got gibberish response to command %s\", command));\n-                        }\n+                final Reader isr = new InputStreamReader(localSocket.getInputStream());\n+                final BufferedReader in = new BufferedReader(isr);\n+                while (true) {\n+                    String line = in.readLine();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fccd724b66bcabedc5b51cd2198bac210942ae12"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM3MjQxMw==", "bodyText": "The original code didn't handle null, so I didn't either. But I've fixed it and will push a commit.", "url": "https://github.com/openhab/openhab-addons/pull/7505#discussion_r418372413", "createdAt": "2020-05-01T01:10:45Z", "author": {"login": "benalexau"}, "path": "bundles/org.openhab.binding.coolmasternet/src/main/java/org/openhab/binding/coolmasternet/internal/ControllerHandler.java", "diffHunk": "@@ -146,25 +151,19 @@ public boolean isConnected() {\n                 logger.trace(\"Sending command '{}'\", command);\n                 OutputStream out = localSocket.getOutputStream();\n                 out.write(command.getBytes());\n-                out.write(\"\\r\\n\".getBytes());\n+                out.write(LF);\n \n-                try (Reader isr = new InputStreamReader(localSocket.getInputStream());\n-                        BufferedReader in = new BufferedReader(isr)) {\n-                    while (true) {\n-                        String line = in.readLine();\n-                        logger.trace(\"Read result '{}'\", line);\n-                        if (\"OK\".equals(line)) {\n-                            return response.toString();\n-                        }\n-                        response.append(line);\n-                        if (response.length() > 100) {\n-                            /*\n-                             * Usually this loop times out on errors, but in the case that we just keep getting\n-                             * data we should also fail with an error.\n-                             */\n-                            throw new CoolMasterClientError(\n-                                    String.format(\"Got gibberish response to command %s\", command));\n-                        }\n+                final Reader isr = new InputStreamReader(localSocket.getInputStream());\n+                final BufferedReader in = new BufferedReader(isr);\n+                while (true) {\n+                    String line = in.readLine();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM2MzQyOQ=="}, "originalCommit": {"oid": "fccd724b66bcabedc5b51cd2198bac210942ae12"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwMzE2NzQ5OnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.binding.coolmasternet/src/main/java/org/openhab/binding/coolmasternet/internal/ControllerHandler.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQwMTowMDo0NFrOGO_SUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQwMToxMToxNlrOGO_brw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM3MDEzMA==", "bodyText": "Shouldn't the character encoding be specified here as well?", "url": "https://github.com/openhab/openhab-addons/pull/7505#discussion_r418370130", "createdAt": "2020-05-01T01:00:44Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.coolmasternet/src/main/java/org/openhab/binding/coolmasternet/internal/ControllerHandler.java", "diffHunk": "@@ -146,25 +151,19 @@ public boolean isConnected() {\n                 logger.trace(\"Sending command '{}'\", command);\n                 OutputStream out = localSocket.getOutputStream();\n                 out.write(command.getBytes());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fccd724b66bcabedc5b51cd2198bac210942ae12"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM3MjUyNw==", "bodyText": "Original code didn't, so I didn't do this either. But I have fixed this and will push a commit.", "url": "https://github.com/openhab/openhab-addons/pull/7505#discussion_r418372527", "createdAt": "2020-05-01T01:11:16Z", "author": {"login": "benalexau"}, "path": "bundles/org.openhab.binding.coolmasternet/src/main/java/org/openhab/binding/coolmasternet/internal/ControllerHandler.java", "diffHunk": "@@ -146,25 +151,19 @@ public boolean isConnected() {\n                 logger.trace(\"Sending command '{}'\", command);\n                 OutputStream out = localSocket.getOutputStream();\n                 out.write(command.getBytes());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM3MDEzMA=="}, "originalCommit": {"oid": "fccd724b66bcabedc5b51cd2198bac210942ae12"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwMzI3MDI1OnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.binding.coolmasternet/src/main/java/org/openhab/binding/coolmasternet/internal/ControllerHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQwMjowOTowMlrOGPAOlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQwMjowOTowMlrOGPAOlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM4NTU1Ng==", "bodyText": "please format this, this has the wrong indentation.", "url": "https://github.com/openhab/openhab-addons/pull/7505#discussion_r418385556", "createdAt": "2020-05-01T02:09:02Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.coolmasternet/src/main/java/org/openhab/binding/coolmasternet/internal/ControllerHandler.java", "diffHunk": "@@ -205,21 +204,41 @@ private void checkConnection() throws CoolMasterClientError {\n                 }\n \n                 InputStream in = localSocket.getInputStream();\n-                /* Flush anything pending in the input stream */\n-                while (in.available() > 0) {\n-                    in.read();\n+\n+                // Sink (clear) buffer until earlier of the SINK_TIMEOUT or > prompt\n+                try {\n+                    localSocket.setSoTimeout(SINK_TIMEOUT);\n+                    while (true) {\n+                        int b = in.read();\n+                        if (b == -1) {\n+                          break;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3df0027499b797ccb6d3bdc97d631f4ab39a182"}, "originalPosition": 73}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwMzI3MjU3OnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.binding.coolmasternet/src/main/java/org/openhab/binding/coolmasternet/internal/ControllerHandler.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQwMjoxMDo0MVrOGPAP4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQwNzowMjo0M1rOGPDnIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM4NTg5MA==", "bodyText": "Shouldn't a charset be specified for this reader?", "url": "https://github.com/openhab/openhab-addons/pull/7505#discussion_r418385890", "createdAt": "2020-05-01T02:10:41Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.coolmasternet/src/main/java/org/openhab/binding/coolmasternet/internal/ControllerHandler.java", "diffHunk": "@@ -145,26 +150,20 @@ public boolean isConnected() {\n \n                 logger.trace(\"Sending command '{}'\", command);\n                 OutputStream out = localSocket.getOutputStream();\n-                out.write(command.getBytes());\n-                out.write(\"\\r\\n\".getBytes());\n+                out.write(command.getBytes(StandardCharsets.US_ASCII));\n+                out.write(LF);\n \n-                try (Reader isr = new InputStreamReader(localSocket.getInputStream());\n-                        BufferedReader in = new BufferedReader(isr)) {\n-                    while (true) {\n-                        String line = in.readLine();\n-                        logger.trace(\"Read result '{}'\", line);\n-                        if (\"OK\".equals(line)) {\n-                            return response.toString();\n-                        }\n-                        response.append(line);\n-                        if (response.length() > 100) {\n-                            /*\n-                             * Usually this loop times out on errors, but in the case that we just keep getting\n-                             * data we should also fail with an error.\n-                             */\n-                            throw new CoolMasterClientError(\n-                                    String.format(\"Got gibberish response to command %s\", command));\n-                        }\n+                final Reader isr = new InputStreamReader(localSocket.getInputStream());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3df0027499b797ccb6d3bdc97d631f4ab39a182"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQzNzk2OA==", "bodyText": "It has been this way since 2 January 2017. I did not write it.", "url": "https://github.com/openhab/openhab-addons/pull/7505#discussion_r418437968", "createdAt": "2020-05-01T06:48:12Z", "author": {"login": "benalexau"}, "path": "bundles/org.openhab.binding.coolmasternet/src/main/java/org/openhab/binding/coolmasternet/internal/ControllerHandler.java", "diffHunk": "@@ -145,26 +150,20 @@ public boolean isConnected() {\n \n                 logger.trace(\"Sending command '{}'\", command);\n                 OutputStream out = localSocket.getOutputStream();\n-                out.write(command.getBytes());\n-                out.write(\"\\r\\n\".getBytes());\n+                out.write(command.getBytes(StandardCharsets.US_ASCII));\n+                out.write(LF);\n \n-                try (Reader isr = new InputStreamReader(localSocket.getInputStream());\n-                        BufferedReader in = new BufferedReader(isr)) {\n-                    while (true) {\n-                        String line = in.readLine();\n-                        logger.trace(\"Read result '{}'\", line);\n-                        if (\"OK\".equals(line)) {\n-                            return response.toString();\n-                        }\n-                        response.append(line);\n-                        if (response.length() > 100) {\n-                            /*\n-                             * Usually this loop times out on errors, but in the case that we just keep getting\n-                             * data we should also fail with an error.\n-                             */\n-                            throw new CoolMasterClientError(\n-                                    String.format(\"Got gibberish response to command %s\", command));\n-                        }\n+                final Reader isr = new InputStreamReader(localSocket.getInputStream());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM4NTg5MA=="}, "originalCommit": {"oid": "f3df0027499b797ccb6d3bdc97d631f4ab39a182"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQ0MDk5NA==", "bodyText": "Anyhow I modified it to be explicit.", "url": "https://github.com/openhab/openhab-addons/pull/7505#discussion_r418440994", "createdAt": "2020-05-01T07:02:43Z", "author": {"login": "benalexau"}, "path": "bundles/org.openhab.binding.coolmasternet/src/main/java/org/openhab/binding/coolmasternet/internal/ControllerHandler.java", "diffHunk": "@@ -145,26 +150,20 @@ public boolean isConnected() {\n \n                 logger.trace(\"Sending command '{}'\", command);\n                 OutputStream out = localSocket.getOutputStream();\n-                out.write(command.getBytes());\n-                out.write(\"\\r\\n\".getBytes());\n+                out.write(command.getBytes(StandardCharsets.US_ASCII));\n+                out.write(LF);\n \n-                try (Reader isr = new InputStreamReader(localSocket.getInputStream());\n-                        BufferedReader in = new BufferedReader(isr)) {\n-                    while (true) {\n-                        String line = in.readLine();\n-                        logger.trace(\"Read result '{}'\", line);\n-                        if (\"OK\".equals(line)) {\n-                            return response.toString();\n-                        }\n-                        response.append(line);\n-                        if (response.length() > 100) {\n-                            /*\n-                             * Usually this loop times out on errors, but in the case that we just keep getting\n-                             * data we should also fail with an error.\n-                             */\n-                            throw new CoolMasterClientError(\n-                                    String.format(\"Got gibberish response to command %s\", command));\n-                        }\n+                final Reader isr = new InputStreamReader(localSocket.getInputStream());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM4NTg5MA=="}, "originalCommit": {"oid": "f3df0027499b797ccb6d3bdc97d631f4ab39a182"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwMzI3NDE1OnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.binding.coolmasternet/src/main/java/org/openhab/binding/coolmasternet/internal/ControllerHandler.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQwMjoxMTo1NFrOGPAQ4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQwNzowMDowOVrOGPDlMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM4NjE0Ng==", "bodyText": "please log this anyway, you can log it as DEBUG", "url": "https://github.com/openhab/openhab-addons/pull/7505#discussion_r418386146", "createdAt": "2020-05-01T02:11:54Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.coolmasternet/src/main/java/org/openhab/binding/coolmasternet/internal/ControllerHandler.java", "diffHunk": "@@ -205,21 +204,41 @@ private void checkConnection() throws CoolMasterClientError {\n                 }\n \n                 InputStream in = localSocket.getInputStream();\n-                /* Flush anything pending in the input stream */\n-                while (in.available() > 0) {\n-                    in.read();\n+\n+                // Sink (clear) buffer until earlier of the SINK_TIMEOUT or > prompt\n+                try {\n+                    localSocket.setSoTimeout(SINK_TIMEOUT);\n+                    while (true) {\n+                        int b = in.read();\n+                        if (b == -1) {\n+                          break;\n+                        }\n+                        if (b == PROMPT) {\n+                            if (in.available() > 0) {\n+                                throw new IOException(\"Unexpected data following prompt\");\n+                            }\n+                            logger.trace(\"Buffer empty following unsolicited > prompt\");\n+                            return;\n+                        }\n+                    }\n+                } catch (final IOException ignoredAsLikelySocketTimeout) {\n+                } finally {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3df0027499b797ccb6d3bdc97d631f4ab39a182"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQ0MDQ5OQ==", "bodyText": "I narrowed the exception instead to SocketTimeoutException. That way it reflects the expected blue sky case (which is in.read() timing out as the buffer is now empty). Other IOException cases are already caught and logged in the enclosing try statement.", "url": "https://github.com/openhab/openhab-addons/pull/7505#discussion_r418440499", "createdAt": "2020-05-01T07:00:09Z", "author": {"login": "benalexau"}, "path": "bundles/org.openhab.binding.coolmasternet/src/main/java/org/openhab/binding/coolmasternet/internal/ControllerHandler.java", "diffHunk": "@@ -205,21 +204,41 @@ private void checkConnection() throws CoolMasterClientError {\n                 }\n \n                 InputStream in = localSocket.getInputStream();\n-                /* Flush anything pending in the input stream */\n-                while (in.available() > 0) {\n-                    in.read();\n+\n+                // Sink (clear) buffer until earlier of the SINK_TIMEOUT or > prompt\n+                try {\n+                    localSocket.setSoTimeout(SINK_TIMEOUT);\n+                    while (true) {\n+                        int b = in.read();\n+                        if (b == -1) {\n+                          break;\n+                        }\n+                        if (b == PROMPT) {\n+                            if (in.available() > 0) {\n+                                throw new IOException(\"Unexpected data following prompt\");\n+                            }\n+                            logger.trace(\"Buffer empty following unsolicited > prompt\");\n+                            return;\n+                        }\n+                    }\n+                } catch (final IOException ignoredAsLikelySocketTimeout) {\n+                } finally {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM4NjE0Ng=="}, "originalCommit": {"oid": "f3df0027499b797ccb6d3bdc97d631f4ab39a182"}, "originalPosition": 84}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 442, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}