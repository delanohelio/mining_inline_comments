{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgwNTg1NDM0", "number": 7073, "title": "[bluetooth.bluez] Fix for bluez discovery scheduler death (#7072)", "bodyText": "Fixes issue #7072 by catching any Bluetooth exception within the discovery loop.\nMakes attempt at preventing possible cause of errors and updates the adapter bridge status accordingly.", "createdAt": "2020-02-27T01:10:49Z", "url": "https://github.com/openhab/openhab-addons/pull/7073", "merged": true, "mergeCommit": {"oid": "65d4e591bb9c7fa81e74f3ca6971b5eedd5bced9"}, "closed": true, "closedAt": "2020-02-27T08:29:30Z", "author": {"login": "cpmeister"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcIQjrwAH2gAyMzgwNTg1NDM0OjI0YWFkZmFjYTVmYmJlNTk0MDA0MWZiYWFlMTAzMzE5OTkyNmM1YWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcIXDgDgFqTM2NTQ4OTA2Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "24aadfaca5fbbe5940041fbaae1033199926c5aa", "author": {"user": {"login": "cpmeister", "name": "Connor Petty"}}, "url": "https://github.com/openhab/openhab-addons/commit/24aadfaca5fbbe5940041fbaae1033199926c5aa", "committedDate": "2020-02-27T00:54:56Z", "message": "Fix for issue #7072\n\nSigned-off-by: Connor Petty <cpmeister@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "667d9151f0ce157b7a84c89096adc2f55c872aeb", "author": {"user": {"login": "cpmeister", "name": "Connor Petty"}}, "url": "https://github.com/openhab/openhab-addons/commit/667d9151f0ce157b7a84c89096adc2f55c872aeb", "committedDate": "2020-02-27T01:10:00Z", "message": "cleanup status error message\n\nSigned-off-by: Connor Petty <cpmeister@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1NDMyODk2", "url": "https://github.com/openhab/openhab-addons/pull/7073#pullrequestreview-365432896", "createdAt": "2020-02-27T06:07:11Z", "commit": {"oid": "667d9151f0ce157b7a84c89096adc2f55c872aeb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QwNjowNzoxMVrOFvGNNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QwNjowNzoxMVrOFvGNNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkyOTA3OQ==", "bodyText": "Why is this message parsing necessary? And I guess you need to check if the message is null before calling lastIndex()", "url": "https://github.com/openhab/openhab-addons/pull/7073#discussion_r384929079", "createdAt": "2020-02-27T06:07:11Z", "author": {"login": "J-N-K"}, "path": "bundles/org.openhab.binding.bluetooth.bluez/src/main/java/org/openhab/binding/bluetooth/bluez/handler/BlueZBridgeHandler.java", "diffHunk": "@@ -155,33 +155,48 @@ public void removeDiscoveryListener(@Nullable BluetoothDiscoveryListener listene\n     }\n \n     private void startDiscovery() {\n+        // we need to make sure the adapter is powered first\n+        if (!adapter.getPowered()) {\n+            adapter.setPowered(true);\n+        }\n         if (!adapter.getDiscovering()) {\n             adapter.setRssiDiscoveryFilter(-96);\n             adapter.startDiscovery();\n         }\n     }\n \n     private void refreshDevices() {\n-        logger.debug(\"Refreshing Bluetooth device list...\");\n-        List<tinyb.BluetoothDevice> tinybDevices = adapter.getDevices();\n-        logger.debug(\"Found {} Bluetooth devices.\", tinybDevices.size());\n-        for (tinyb.BluetoothDevice tinybDevice : tinybDevices) {\n-            BlueZBluetoothDevice device = getDevice(new BluetoothAddress(tinybDevice.getAddress()));\n-            device.updateTinybDevice(tinybDevice);\n-            notifyDiscoveryListeners(device);\n-        }\n-        // clean up orphaned entries\n-        synchronized (devices) {\n-            for (BlueZBluetoothDevice device : devices.values()) {\n-                if (shouldRemove(device)) {\n-                    logger.debug(\"Removing device '{}' due to inactivity\", device.getAddress());\n-                    device.dispose();\n-                    devices.remove(device.getAddress());\n+        try {\n+            logger.debug(\"Refreshing Bluetooth device list...\");\n+            List<tinyb.BluetoothDevice> tinybDevices = adapter.getDevices();\n+            logger.debug(\"Found {} Bluetooth devices.\", tinybDevices.size());\n+            for (tinyb.BluetoothDevice tinybDevice : tinybDevices) {\n+                BlueZBluetoothDevice device = getDevice(new BluetoothAddress(tinybDevice.getAddress()));\n+                device.updateTinybDevice(tinybDevice);\n+                notifyDiscoveryListeners(device);\n+            }\n+            // clean up orphaned entries\n+            synchronized (devices) {\n+                for (BlueZBluetoothDevice device : devices.values()) {\n+                    if (shouldRemove(device)) {\n+                        logger.debug(\"Removing device '{}' due to inactivity\", device.getAddress());\n+                        device.dispose();\n+                        devices.remove(device.getAddress());\n+                    }\n                 }\n             }\n+            // For whatever reason, bluez will sometimes turn off scanning. So we just make sure it keeps running.\n+            startDiscovery();\n+            // everything went fine, so lets switch to online\n+            updateStatus(ThingStatus.ONLINE);\n+        } catch (BluetoothException ex) {\n+            String message = ex.getMessage();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "667d9151f0ce157b7a84c89096adc2f55c872aeb"}, "originalPosition": 70}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5522d7546c9454d24354474f9eaaeeebc103f866", "author": {"user": {"login": "cpmeister", "name": "Connor Petty"}}, "url": "https://github.com/openhab/openhab-addons/commit/5522d7546c9454d24354474f9eaaeeebc103f866", "committedDate": "2020-02-27T06:13:50Z", "message": "Added null check\n\nSigned-off-by: Connor Petty <cpmeister@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1NDg5MDYy", "url": "https://github.com/openhab/openhab-addons/pull/7073#pullrequestreview-365489062", "createdAt": "2020-02-27T08:29:07Z", "commit": {"oid": "5522d7546c9454d24354474f9eaaeeebc103f866"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1074, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}