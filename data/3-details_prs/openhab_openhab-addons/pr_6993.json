{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzczMzM5MDIz", "number": 6993, "title": "[somfytahoma] added dynamic RSSI channel", "bodyText": "This PR contains:\n\nautomatic adding of a RSSI channel to all things where applicable\nadded sensor_defect channel for getting the health state of sensors\nadded extra channels radio_battery, sensor_battery for the smoke sensor thing (getting battery health)", "createdAt": "2020-02-10T20:32:37Z", "url": "https://github.com/openhab/openhab-addons/pull/6993", "merged": true, "mergeCommit": {"oid": "497495483faded026b118726a40995cf253edc8f"}, "closed": true, "closedAt": "2020-03-03T22:29:21Z", "author": {"login": "octa22"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcJYqoMgH2gAyMzczMzM5MDIzOjg4OWYzZmJhYjZiYjk2MDIwMWU0MGUwNTlkZWNlNTIxNWE3YjE1MWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKH3OjgFqTM2ODI3ODY5MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "889f3fbab6bb960201e40e059dece5215a7b151f", "author": {"user": {"login": "octa22", "name": "Ondrej Pecta"}}, "url": "https://github.com/openhab/openhab-addons/commit/889f3fbab6bb960201e40e059dece5215a7b151f", "committedDate": "2020-03-01T12:55:41Z", "message": "[somfytahoma] added dynamic rssi channel\n\nSigned-off-by: Ondrej Pecta <opecta@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89f9ea65f011b094b90bf7e3f292515137afea42", "author": {"user": {"login": "octa22", "name": "Ondrej Pecta"}}, "url": "https://github.com/openhab/openhab-addons/commit/89f9ea65f011b094b90bf7e3f292515137afea42", "committedDate": "2020-03-01T12:55:41Z", "message": "[somfytahoma] added extra channels for sensor things\n\nSigned-off-by: Ondrej Pecta <opecta@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f4e5c048545d92912ef80588ee74fa6121ee118", "author": {"user": {"login": "octa22", "name": "Ondrej Pecta"}}, "url": "https://github.com/openhab/openhab-addons/commit/1f4e5c048545d92912ef80588ee74fa6121ee118", "committedDate": "2020-03-01T12:55:41Z", "message": "[somfytahoma] code cleanup\n\nSigned-off-by: Ondrej Pecta <opecta@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c29df786a9949d4a7b14fe0f2ac3cdfe926910c8", "author": {"user": {"login": "octa22", "name": "Ondrej Pecta"}}, "url": "https://github.com/openhab/openhab-addons/commit/c29df786a9949d4a7b14fe0f2ac3cdfe926910c8", "committedDate": "2020-03-01T12:57:41Z", "message": "[somfytahoma] improved logging\n\nSigned-off-by: Ondrej Pecta <opecta@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "080cc1cdf7253bb770389aa23032d383580d9db4", "author": {"user": {"login": "octa22", "name": "Ondrej Pecta"}}, "url": "https://github.com/openhab/openhab-addons/commit/080cc1cdf7253bb770389aa23032d383580d9db4", "committedDate": "2020-02-10T20:19:04Z", "message": "[somfytahoma] improved logging\n\nSigned-off-by: Ondrej Pecta <opecta@gmail.com>"}, "afterCommit": {"oid": "c29df786a9949d4a7b14fe0f2ac3cdfe926910c8", "author": {"user": {"login": "octa22", "name": "Ondrej Pecta"}}, "url": "https://github.com/openhab/openhab-addons/commit/c29df786a9949d4a7b14fe0f2ac3cdfe926910c8", "committedDate": "2020-03-01T12:57:41Z", "message": "[somfytahoma] improved logging\n\nSigned-off-by: Ondrej Pecta <opecta@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4MTc1NjUw", "url": "https://github.com/openhab/openhab-addons/pull/6993#pullrequestreview-368175650", "createdAt": "2020-03-03T17:24:02Z", "commit": {"oid": "c29df786a9949d4a7b14fe0f2ac3cdfe926910c8"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxNzoyNDowM1rOFxPVUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxNzo0MToyMFrOFxP5Qg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE3NTc2MQ==", "bodyText": "getURL is quite expensive and called even if the log level is lower than DEBUG. Is there any reason why the URL is not set during initialization and stored in a String field? In case of configuration change the thing handler is disposed and re-initialized, so this should not be a problem. (also applies below)", "url": "https://github.com/openhab/openhab-addons/pull/6993#discussion_r387175761", "createdAt": "2020-03-03T17:24:03Z", "author": {"login": "J-N-K"}, "path": "bundles/org.openhab.binding.somfytahoma/src/main/java/org/openhab/binding/somfytahoma/internal/handler/SomfyTahomaBaseThingHandler.java", "diffHunk": "@@ -62,12 +64,29 @@ public SomfyTahomaBaseThingHandler(Thing thing) {\n \n     @Override\n     public void initialize() {\n+        if (getThing().getProperties().containsKey(RSSI_LEVEL_STATE)) {\n+            createRSSIChannel();\n+        }\n         updateStatus(ThingStatus.ONLINE);\n     }\n \n+    private void createRSSIChannel() {\n+        if (thing.getChannel(RSSI) == null) {\n+            logger.debug(\"{} Creating a rssi channel\", getURL());\n+            createChannel(RSSI, \"Number\",\"RSSI Level\");\n+        }\n+    }\n+\n+    private void createChannel(String name, String type, String label) {\n+        ThingBuilder thingBuilder = editThing();\n+        Channel channel = ChannelBuilder.create(new ChannelUID(thing.getUID(), name), type).withLabel(label).build();\n+        thingBuilder.withChannel(channel);\n+        updateThing(thingBuilder.build());\n+    }\n+\n     @Override\n     public void handleCommand(ChannelUID channelUID, Command command) {\n-        logger.debug(\"Received command {} for channel {}\", command, channelUID);\n+        logger.debug(\"{} Received command {} for channel {}\", getURL(), command, channelUID);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c29df786a9949d4a7b14fe0f2ac3cdfe926910c8"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE3ODY5NQ==", "bodyText": "isChannelLinked is quite expensive, while parseTahomaState seems to be cheap. Is there a special reason to check the channel link state (I know that has been done before, but ...)", "url": "https://github.com/openhab/openhab-addons/pull/6993#discussion_r387178695", "createdAt": "2020-03-03T17:29:15Z", "author": {"login": "J-N-K"}, "path": "bundles/org.openhab.binding.somfytahoma/src/main/java/org/openhab/binding/somfytahoma/internal/handler/SomfyTahomaBaseThingHandler.java", "diffHunk": "@@ -275,21 +294,40 @@ private void updateThingStatus(@Nullable SomfyTahomaState state) {\n     public void updateThingChannels(List<SomfyTahomaState> states) {\n         Map<String, String> properties = new HashMap<>();\n         for (SomfyTahomaState state : states) {\n-            logger.trace(\"processing state: {} with value: {}\", state.getName(), state.getValue());\n+            logger.trace(\"{} processing state: {} with value: {}\", getURL(), state.getName(), state.getValue());\n             properties.put(state.getName(), state.getValue().toString());\n-            updateThingChannels(state);\n+            if (RSSI_LEVEL_STATE.equals(state.getName())) {\n+                // RSSI channel is a dynamic one\n+                updateRSSIChannel(state);\n+            } else {\n+                updateThingChannels(state);\n+            }\n         }\n         updateProperties(properties);\n     }\n \n+    private void updateRSSIChannel(SomfyTahomaState state) {\n+        createRSSIChannel();\n+        Channel ch = thing.getChannel(RSSI);\n+        if (ch != null && isChannelLinked(ch)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c29df786a9949d4a7b14fe0f2ac3cdfe926910c8"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE4NDk2Mg==", "bodyText": "This looks strange. Maybe run the spotless formatter before we merge", "url": "https://github.com/openhab/openhab-addons/pull/6993#discussion_r387184962", "createdAt": "2020-03-03T17:41:20Z", "author": {"login": "J-N-K"}, "path": "bundles/org.openhab.binding.somfytahoma/src/main/java/org/openhab/binding/somfytahoma/internal/handler/SomfyTahomaWaterSensorHandler.java", "diffHunk": "@@ -12,8 +12,8 @@\n  */\n package org.openhab.binding.somfytahoma.internal.handler;\n \n-import static org.openhab.binding.somfytahoma.internal.SomfyTahomaBindingConstants.CONTACT;\n-import static org.openhab.binding.somfytahoma.internal.SomfyTahomaBindingConstants.WATER_DETECTION_STATE;\n+import static org.openhab.binding.somfytahoma.internal.SomfyTahomaBindingConstants.*;\n+import static org.openhab.binding.somfytahoma.internal.SomfyTahomaBindingConstants.SENSOR_DEFECT_STATE;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c29df786a9949d4a7b14fe0f2ac3cdfe926910c8"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4MjM4ODYz", "url": "https://github.com/openhab/openhab-addons/pull/6993#pullrequestreview-368238863", "createdAt": "2020-03-03T18:56:09Z", "commit": {"oid": "07f364e07152ada7b5106a44a4fbd88d57700a4e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxODo1NjoxMFrOFxSZfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxODo1NjoxMFrOFxSZfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzIyNTk4MQ==", "bodyText": "Unfortunately this will not work, the config might not be available when the handler is constructed.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private final String url = getURL();\n          \n          \n            \n                private final String url = \"\";\n          \n      \n    \n    \n  \n\nAnd call url=getURL(); in initialize();", "url": "https://github.com/openhab/openhab-addons/pull/6993#discussion_r387225981", "createdAt": "2020-03-03T18:56:10Z", "author": {"login": "J-N-K"}, "path": "bundles/org.openhab.binding.somfytahoma/src/main/java/org/openhab/binding/somfytahoma/internal/handler/SomfyTahomaBaseThingHandler.java", "diffHunk": "@@ -62,6 +62,8 @@ public SomfyTahomaBaseThingHandler(Thing thing) {\n         return stateNames;\n     }\n \n+    private final String url = getURL();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07f364e07152ada7b5106a44a4fbd88d57700a4e"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f5d3b8db9ecf8e28d55c45bd482c1590ddd2098", "author": {"user": {"login": "octa22", "name": "Ondrej Pecta"}}, "url": "https://github.com/openhab/openhab-addons/commit/2f5d3b8db9ecf8e28d55c45bd482c1590ddd2098", "committedDate": "2020-03-03T18:58:59Z", "message": "[somfytahoma] fixes based on a code review\n\nSigned-off-by: Ondrej Pecta <opecta@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "07f364e07152ada7b5106a44a4fbd88d57700a4e", "author": {"user": {"login": "octa22", "name": "Ondrej Pecta"}}, "url": "https://github.com/openhab/openhab-addons/commit/07f364e07152ada7b5106a44a4fbd88d57700a4e", "committedDate": "2020-03-03T18:50:22Z", "message": "[somfytahoma] fixes based on a code review\n\nSigned-off-by: Ondrej Pecta <opecta@gmail.com>"}, "afterCommit": {"oid": "2f5d3b8db9ecf8e28d55c45bd482c1590ddd2098", "author": {"user": {"login": "octa22", "name": "Ondrej Pecta"}}, "url": "https://github.com/openhab/openhab-addons/commit/2f5d3b8db9ecf8e28d55c45bd482c1590ddd2098", "committedDate": "2020-03-03T18:58:59Z", "message": "[somfytahoma] fixes based on a code review\n\nSigned-off-by: Ondrej Pecta <opecta@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4Mjc4Njkx", "url": "https://github.com/openhab/openhab-addons/pull/6993#pullrequestreview-368278691", "createdAt": "2020-03-03T19:54:59Z", "commit": {"oid": "2f5d3b8db9ecf8e28d55c45bd482c1590ddd2098"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1430, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}