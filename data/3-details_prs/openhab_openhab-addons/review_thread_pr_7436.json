{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA2NjI5MDI3", "number": 7436, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNDoyNjoxM1rOD0RjBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQwODoxOTozMFrOD3FFdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2MTQwMDM5OnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.binding.samsungtv/src/main/java/org/openhab/binding/samsungtv/internal/handler/SamsungTvHandler.java", "isResolved": false, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNDoyNjoxM1rOGJIrvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNjo1NTo1NVrOGJObvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjIzMjYzOQ==", "bodyText": "thingDiscovered method will be called when ever new UPnP device is discovered, so delay shouldn't be needed", "url": "https://github.com/openhab/openhab-addons/pull/7436#discussion_r412232639", "createdAt": "2020-04-21T14:26:13Z", "author": {"login": "paulianttila"}, "path": "bundles/org.openhab.binding.samsungtv/src/main/java/org/openhab/binding/samsungtv/internal/handler/SamsungTvHandler.java", "diffHunk": "@@ -330,6 +331,12 @@ public void thingDiscovered(DiscoveryService source, DiscoveryResult result) {\n              */\n             upnpThingUID = result.getThingUID();\n             logger.debug(\"thingDiscovered, thingUID={}, discoveredUID={}\", this.getThing().getUID(), upnpThingUID);\n+            // We wait a little to increase the chance to have all UPnP devices being discovered before\n+            // calling checkAndCreateServices\n+            try {\n+                Thread.sleep(2000);\n+            } catch (InterruptedException e) {\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a8577e8e9410fb53e51be1864bb323247e006b8"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjI0NzI0MA==", "bodyText": "I think thingDiscovered is called only if a new OH thing is discovered.\nFor a new UPnP device that is ignored by the OH discovery, I don't think thingDiscovered will be called.\nBut I will check the code from the framework core again to be sure.", "url": "https://github.com/openhab/openhab-addons/pull/7436#discussion_r412247240", "createdAt": "2020-04-21T14:43:00Z", "author": {"login": "lolodomo"}, "path": "bundles/org.openhab.binding.samsungtv/src/main/java/org/openhab/binding/samsungtv/internal/handler/SamsungTvHandler.java", "diffHunk": "@@ -330,6 +331,12 @@ public void thingDiscovered(DiscoveryService source, DiscoveryResult result) {\n              */\n             upnpThingUID = result.getThingUID();\n             logger.debug(\"thingDiscovered, thingUID={}, discoveredUID={}\", this.getThing().getUID(), upnpThingUID);\n+            // We wait a little to increase the chance to have all UPnP devices being discovered before\n+            // calling checkAndCreateServices\n+            try {\n+                Thread.sleep(2000);\n+            } catch (InterruptedException e) {\n+            }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjIzMjYzOQ=="}, "originalCommit": {"oid": "8a8577e8e9410fb53e51be1864bb323247e006b8"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjI4NTM2MA==", "bodyText": "If that's the case, then that most probably is also the reason why many users have issue with binding (not all features are always supported). Samsung TV's will announce UPnP devices very randomly. Initially, the binding registered itself directly to the UPnP library to get notification when UPnP device have been found or removed, but that was changed some point of time to use DiscoveryListener.", "url": "https://github.com/openhab/openhab-addons/pull/7436#discussion_r412285360", "createdAt": "2020-04-21T15:26:59Z", "author": {"login": "paulianttila"}, "path": "bundles/org.openhab.binding.samsungtv/src/main/java/org/openhab/binding/samsungtv/internal/handler/SamsungTvHandler.java", "diffHunk": "@@ -330,6 +331,12 @@ public void thingDiscovered(DiscoveryService source, DiscoveryResult result) {\n              */\n             upnpThingUID = result.getThingUID();\n             logger.debug(\"thingDiscovered, thingUID={}, discoveredUID={}\", this.getThing().getUID(), upnpThingUID);\n+            // We wait a little to increase the chance to have all UPnP devices being discovered before\n+            // calling checkAndCreateServices\n+            try {\n+                Thread.sleep(2000);\n+            } catch (InterruptedException e) {\n+            }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjIzMjYzOQ=="}, "originalCommit": {"oid": "8a8577e8e9410fb53e51be1864bb323247e006b8"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjMwMDEyNw==", "bodyText": "For me, the framework code is clear, thingDiscovered is called only if there is one UPnP participant for which createResult returns a non null value. And that makes sense to me.\nSo if the MainTVServer2 UPnP device is discovered too much time after the MediaRenderer UPnP device, it is possible that the service relative to MainTVServer2 is not created by the binding. This is the reason of the delay I introduced here.\nThat being said, I agree with you, it would have been probably better to register directly to the UPnP library to be informed of any new and removed UPnP device, rather than using DiscoveryListener which in fact is triggered only by the MediaRenderer UPnP device.", "url": "https://github.com/openhab/openhab-addons/pull/7436#discussion_r412300127", "createdAt": "2020-04-21T16:12:29Z", "author": {"login": "lolodomo"}, "path": "bundles/org.openhab.binding.samsungtv/src/main/java/org/openhab/binding/samsungtv/internal/handler/SamsungTvHandler.java", "diffHunk": "@@ -330,6 +331,12 @@ public void thingDiscovered(DiscoveryService source, DiscoveryResult result) {\n              */\n             upnpThingUID = result.getThingUID();\n             logger.debug(\"thingDiscovered, thingUID={}, discoveredUID={}\", this.getThing().getUID(), upnpThingUID);\n+            // We wait a little to increase the chance to have all UPnP devices being discovered before\n+            // calling checkAndCreateServices\n+            try {\n+                Thread.sleep(2000);\n+            } catch (InterruptedException e) {\n+            }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjIzMjYzOQ=="}, "originalCommit": {"oid": "8a8577e8e9410fb53e51be1864bb323247e006b8"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjMxMjEwNw==", "bodyText": "I think 2 seconds delay is not enough as Samsung TV's can announce services very randomly, it can take minutes before all services are discovered.\nI can't remember anymore when change was done from UPnP library to DiscoveryListener and unfortunately git history is gone because of bnd build change.", "url": "https://github.com/openhab/openhab-addons/pull/7436#discussion_r412312107", "createdAt": "2020-04-21T16:36:10Z", "author": {"login": "paulianttila"}, "path": "bundles/org.openhab.binding.samsungtv/src/main/java/org/openhab/binding/samsungtv/internal/handler/SamsungTvHandler.java", "diffHunk": "@@ -330,6 +331,12 @@ public void thingDiscovered(DiscoveryService source, DiscoveryResult result) {\n              */\n             upnpThingUID = result.getThingUID();\n             logger.debug(\"thingDiscovered, thingUID={}, discoveredUID={}\", this.getThing().getUID(), upnpThingUID);\n+            // We wait a little to increase the chance to have all UPnP devices being discovered before\n+            // calling checkAndCreateServices\n+            try {\n+                Thread.sleep(2000);\n+            } catch (InterruptedException e) {\n+            }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjIzMjYzOQ=="}, "originalCommit": {"oid": "8a8577e8e9410fb53e51be1864bb323247e006b8"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjMyNjg0Nw==", "bodyText": "If it can take so much time, I understand my proposal makes no sense.\nI propose to suppress this part from my PR.", "url": "https://github.com/openhab/openhab-addons/pull/7436#discussion_r412326847", "createdAt": "2020-04-21T16:55:55Z", "author": {"login": "lolodomo"}, "path": "bundles/org.openhab.binding.samsungtv/src/main/java/org/openhab/binding/samsungtv/internal/handler/SamsungTvHandler.java", "diffHunk": "@@ -330,6 +331,12 @@ public void thingDiscovered(DiscoveryService source, DiscoveryResult result) {\n              */\n             upnpThingUID = result.getThingUID();\n             logger.debug(\"thingDiscovered, thingUID={}, discoveredUID={}\", this.getThing().getUID(), upnpThingUID);\n+            // We wait a little to increase the chance to have all UPnP devices being discovered before\n+            // calling checkAndCreateServices\n+            try {\n+                Thread.sleep(2000);\n+            } catch (InterruptedException e) {\n+            }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjIzMjYzOQ=="}, "originalCommit": {"oid": "8a8577e8e9410fb53e51be1864bb323247e006b8"}, "originalPosition": 85}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU5MDgxNTkxOnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.binding.samsungtv/src/main/java/org/openhab/binding/samsungtv/internal/handler/SamsungTvHandler.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQwODoxOTozMFrOGNIZwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQwNzo1Njo0OFrOGNztPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQyMjMzNw==", "bodyText": "isLinked is very expensive. But since this is still an improvement over the old behaviour, I'm ok with it. The better way IMO would be to keep track of the linked channels locally.", "url": "https://github.com/openhab/openhab-addons/pull/7436#discussion_r416422337", "createdAt": "2020-04-28T08:19:30Z", "author": {"login": "J-N-K"}, "path": "bundles/org.openhab.binding.samsungtv/src/main/java/org/openhab/binding/samsungtv/internal/handler/SamsungTvHandler.java", "diffHunk": "@@ -187,6 +206,21 @@ private synchronized void putOffline() {\n         updateState(SOURCE_APP, new StringType(\"\"));\n     }\n \n+    private void poll() {\n+        for (SamsungTvService service : services) {\n+            for (String channel : service.getSupportedChannelNames()) {\n+                if (isLinked(channel)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d682b7aa7a4425951f9aa65b7cfbfc2e89318f93"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjkzMTgwNw==", "bodyText": "Why is it slow? Isn't that something that should be fixed in the core then? Why provide the method if the user shouldn't use it?", "url": "https://github.com/openhab/openhab-addons/pull/7436#discussion_r416931807", "createdAt": "2020-04-28T21:23:44Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.samsungtv/src/main/java/org/openhab/binding/samsungtv/internal/handler/SamsungTvHandler.java", "diffHunk": "@@ -187,6 +206,21 @@ private synchronized void putOffline() {\n         updateState(SOURCE_APP, new StringType(\"\"));\n     }\n \n+    private void poll() {\n+        for (SamsungTvService service : services) {\n+            for (String channel : service.getSupportedChannelNames()) {\n+                if (isLinked(channel)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQyMjMzNw=="}, "originalCommit": {"oid": "d682b7aa7a4425951f9aa65b7cfbfc2e89318f93"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjk0MzQ0Nw==", "bodyText": "It\u2018s not exactly slow but IIRC the link registry is a single map. Calling it a low frequency is not a problem. But a lot of requests with high rate could create problems, especially if a lot of bindings are doing it in larger systems.", "url": "https://github.com/openhab/openhab-addons/pull/7436#discussion_r416943447", "createdAt": "2020-04-28T21:46:07Z", "author": {"login": "J-N-K"}, "path": "bundles/org.openhab.binding.samsungtv/src/main/java/org/openhab/binding/samsungtv/internal/handler/SamsungTvHandler.java", "diffHunk": "@@ -187,6 +206,21 @@ private synchronized void putOffline() {\n         updateState(SOURCE_APP, new StringType(\"\"));\n     }\n \n+    private void poll() {\n+        for (SamsungTvService service : services) {\n+            for (String channel : service.getSupportedChannelNames()) {\n+                if (isLinked(channel)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQyMjMzNw=="}, "originalCommit": {"oid": "d682b7aa7a4425951f9aa65b7cfbfc2e89318f93"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjk1OTQ3NA==", "bodyText": "I just looked at the core code and it looks like it is using read locks on a single map. So it should work just fine at a high volume of reads.", "url": "https://github.com/openhab/openhab-addons/pull/7436#discussion_r416959474", "createdAt": "2020-04-28T22:21:57Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.samsungtv/src/main/java/org/openhab/binding/samsungtv/internal/handler/SamsungTvHandler.java", "diffHunk": "@@ -187,6 +206,21 @@ private synchronized void putOffline() {\n         updateState(SOURCE_APP, new StringType(\"\"));\n     }\n \n+    private void poll() {\n+        for (SamsungTvService service : services) {\n+            for (String channel : service.getSupportedChannelNames()) {\n+                if (isLinked(channel)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQyMjMzNw=="}, "originalCommit": {"oid": "d682b7aa7a4425951f9aa65b7cfbfc2e89318f93"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzEzMTgzOA==", "bodyText": "Then I'll never mention that again. :D Maybe that was refactored, I had similar code in one of my ESH bindings and was asked to remove that.", "url": "https://github.com/openhab/openhab-addons/pull/7436#discussion_r417131838", "createdAt": "2020-04-29T07:56:48Z", "author": {"login": "J-N-K"}, "path": "bundles/org.openhab.binding.samsungtv/src/main/java/org/openhab/binding/samsungtv/internal/handler/SamsungTvHandler.java", "diffHunk": "@@ -187,6 +206,21 @@ private synchronized void putOffline() {\n         updateState(SOURCE_APP, new StringType(\"\"));\n     }\n \n+    private void poll() {\n+        for (SamsungTvService service : services) {\n+            for (String channel : service.getSupportedChannelNames()) {\n+                if (isLinked(channel)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQyMjMzNw=="}, "originalCommit": {"oid": "d682b7aa7a4425951f9aa65b7cfbfc2e89318f93"}, "originalPosition": 90}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 317, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}