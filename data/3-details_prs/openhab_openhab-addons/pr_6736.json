{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU4NTA2MDI2", "number": 6736, "title": "[Telegram] Support data URI scheme for base64 encoded images", "bodyText": "Base64 encoded images are already supported when the simple data is passed. This PR adds support for  base64 encoded images with data URI scheme (base64 data starting with \"data:\").\nThis was already supported by the old OH1 Telegram action.\nFixes #6687", "createdAt": "2020-01-01T17:50:50Z", "url": "https://github.com/openhab/openhab-addons/pull/6736", "merged": true, "mergeCommit": {"oid": "2fe44af0e2610cb90bb12920e444c395bfc0b6c8"}, "closed": true, "closedAt": "2020-01-07T09:21:20Z", "author": {"login": "ZzetT"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb2TtXLgFqTMzNzUzOTAzNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb39NJcAFqTMzOTExMzk0OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM3NTM5MDM0", "url": "https://github.com/openhab/openhab-addons/pull/6736#pullrequestreview-337539034", "createdAt": "2020-01-02T06:07:02Z", "commit": {"oid": "df9d9cbb1356eb1bb5278ab714d59b2384f92473"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wMlQwNjowNzowM1rOFZlwCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wMlQwNjoxNToyMVrOFZlzMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjM3NzIyNQ==", "bodyText": "The input parameter photoURL must not be assigned to.", "url": "https://github.com/openhab/openhab-addons/pull/6736#discussion_r362377225", "createdAt": "2020-01-02T06:07:03Z", "author": {"login": "9037568"}, "path": "bundles/org.openhab.binding.telegram/src/main/java/org/openhab/binding/telegram/bot/TelegramActions.java", "diffHunk": "@@ -341,6 +341,15 @@ public boolean sendTelegramPhoto(@ActionInput(name = \"chatId\") @Nullable Long ch\n                 // Load image from provided base64 image\n                 logger.debug(\"Photo base64 provided; converting to binary.\");\n                 try {\n+                    if (photoURL.startsWith(\"data:\")) // support data URI scheme\n+                    {\n+                        String[] photoURLParts = photoURL.split(\",\");\n+                        if (photoURLParts.length > 1) {\n+                            photoURL = photoURLParts[1];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df9d9cbb1356eb1bb5278ab714d59b2384f92473"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjM3NzQ2OQ==", "bodyText": "I think we need an extended sample of this \"URI scheme\" format in the body somewhere to show what it is expected to contain.", "url": "https://github.com/openhab/openhab-addons/pull/6736#discussion_r362377469", "createdAt": "2020-01-02T06:09:35Z", "author": {"login": "9037568"}, "path": "bundles/org.openhab.binding.telegram/README.md", "diffHunk": "@@ -95,7 +95,7 @@ These actions will send a message to all chat ids configured for this bot.\n | sendTelegram(String format, Object... args)          | Sends a formatted message (See https://docs.oracle.com/javase/8/docs/api/java/util/Formatter.html for more information).\n | sendTelegramQuery(String message, String replyId, String... buttons) | Sends a question to the user that can be answered via the defined buttons. The replyId can be freely choosen and is sent back with the answer. Then, the id is required to identify what question has been answered (e.g. in case of multiple open questions). The final result looks like this: ![Telegram Inline Keyboard](doc/queryExample.png). |\n | sendTelegramAnswer(String replyId, String message) | Sends a message after the user has answered a question. You should *always* call this method after you received an answer. It will remove buttons from the specific question and will also stop the progress bar displayed at the client side. If no message is necessary, just pass `null` here. |\n-| sendTelegramPhoto(String photoURL, String caption) | Sends a picture. The URL can be specified using the http, https, and file protocols or a base64 encoded image. |\n+| sendTelegramPhoto(String photoURL, String caption) | Sends a picture. The URL can be specified using the http, https, and file protocols or a base64 encoded image (simple base64 data or data URI scheme). |", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df9d9cbb1356eb1bb5278ab714d59b2384f92473"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjM3ODAzMg==", "bodyText": "\"The provided base64 string is not a valid data URI scheme\"", "url": "https://github.com/openhab/openhab-addons/pull/6736#discussion_r362378032", "createdAt": "2020-01-02T06:15:21Z", "author": {"login": "9037568"}, "path": "bundles/org.openhab.binding.telegram/src/main/java/org/openhab/binding/telegram/bot/TelegramActions.java", "diffHunk": "@@ -341,6 +341,15 @@ public boolean sendTelegramPhoto(@ActionInput(name = \"chatId\") @Nullable Long ch\n                 // Load image from provided base64 image\n                 logger.debug(\"Photo base64 provided; converting to binary.\");\n                 try {\n+                    if (photoURL.startsWith(\"data:\")) // support data URI scheme\n+                    {\n+                        String[] photoURLParts = photoURL.split(\",\");\n+                        if (photoURLParts.length > 1) {\n+                            photoURL = photoURLParts[1];\n+                        } else {\n+                            logger.warn(\"The provided base64 string doesn't seem to a be valid data URI schema\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df9d9cbb1356eb1bb5278ab714d59b2384f92473"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM3ODU0OTY5", "url": "https://github.com/openhab/openhab-addons/pull/6736#pullrequestreview-337854969", "createdAt": "2020-01-02T20:57:42Z", "commit": {"oid": "6260e0ba57d522f038bcd5f989f309cf70fdb141"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4NDE3OTc1", "url": "https://github.com/openhab/openhab-addons/pull/6736#pullrequestreview-338417975", "createdAt": "2020-01-05T19:48:47Z", "commit": {"oid": "6260e0ba57d522f038bcd5f989f309cf70fdb141"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4ODkwNjY2", "url": "https://github.com/openhab/openhab-addons/pull/6736#pullrequestreview-338890666", "createdAt": "2020-01-06T20:57:37Z", "commit": {"oid": "f1b620fa4844faab5768a69b599f3fd7e89de4d7"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQyMDo1NzozOFrOFapCBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQyMDo1ODo0M1rOFapDsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzQ3OTU1OA==", "bodyText": "Please apply correct formatting. brackets should be on the same line.", "url": "https://github.com/openhab/openhab-addons/pull/6736#discussion_r363479558", "createdAt": "2020-01-06T20:57:38Z", "author": {"login": "Hilbrand"}, "path": "bundles/org.openhab.binding.telegram/src/main/java/org/openhab/binding/telegram/bot/TelegramActions.java", "diffHunk": "@@ -341,7 +341,22 @@ public boolean sendTelegramPhoto(@ActionInput(name = \"chatId\") @Nullable Long ch\n                 // Load image from provided base64 image\n                 logger.debug(\"Photo base64 provided; converting to binary.\");\n                 try {\n-                    InputStream is = Base64.getDecoder().wrap(new ByteArrayInputStream(photoURL.getBytes(\"UTF-8\")));\n+                    final String photoB64Data;\n+                    if (photoURL.startsWith(\"data:\")) // support data URI scheme\n+                    {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f1b620fa4844faab5768a69b599f3fd7e89de4d7"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzQ3OTk4Nw==", "bodyText": "Use StandardCharsets.UTF_8 instead of string", "url": "https://github.com/openhab/openhab-addons/pull/6736#discussion_r363479987", "createdAt": "2020-01-06T20:58:43Z", "author": {"login": "Hilbrand"}, "path": "bundles/org.openhab.binding.telegram/src/main/java/org/openhab/binding/telegram/bot/TelegramActions.java", "diffHunk": "@@ -341,7 +341,22 @@ public boolean sendTelegramPhoto(@ActionInput(name = \"chatId\") @Nullable Long ch\n                 // Load image from provided base64 image\n                 logger.debug(\"Photo base64 provided; converting to binary.\");\n                 try {\n-                    InputStream is = Base64.getDecoder().wrap(new ByteArrayInputStream(photoURL.getBytes(\"UTF-8\")));\n+                    final String photoB64Data;\n+                    if (photoURL.startsWith(\"data:\")) // support data URI scheme\n+                    {\n+                        String[] photoURLParts = photoURL.split(\",\");\n+                        if (photoURLParts.length > 1) {\n+                            photoB64Data = photoURLParts[1];\n+                        } else {\n+                            logger.warn(\"The provided base64 string is not a valid data URI scheme\");\n+                            return false;\n+                        }\n+                    }\n+                    else\n+                    {\n+                        photoB64Data = photoURL;\n+                    }\n+                    InputStream is = Base64.getDecoder().wrap(new ByteArrayInputStream(photoB64Data.getBytes(\"UTF-8\")));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f1b620fa4844faab5768a69b599f3fd7e89de4d7"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce9464a9e0cff430babc42b56175b854571d511f", "author": {"user": {"login": "ZzetT", "name": null}}, "url": "https://github.com/openhab/openhab-addons/commit/ce9464a9e0cff430babc42b56175b854571d511f", "committedDate": "2020-01-06T21:55:37Z", "message": "support data URI scheme for base64 encoded images\n\nSigned-off-by: Alexander Krasnogolowy <alexkrasno@hotmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dec92fbef761ef2ff9646fab3fef33540013e805", "author": {"user": {"login": "ZzetT", "name": null}}, "url": "https://github.com/openhab/openhab-addons/commit/dec92fbef761ef2ff9646fab3fef33540013e805", "committedDate": "2020-01-06T21:55:37Z", "message": "improved documentation, avoid usage of method input parameter for re-assignment\n\nSigned-off-by: Alexander Krasnogolowy <alexkrasno@hotmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ebfd2e1135cc104a0fbf4dd3e77d83fff9cf21d", "author": {"user": {"login": "ZzetT", "name": null}}, "url": "https://github.com/openhab/openhab-addons/commit/5ebfd2e1135cc104a0fbf4dd3e77d83fff9cf21d", "committedDate": "2020-01-06T21:55:48Z", "message": "fixed formatting and replaced \"UTF-8\" string by StandardCharsets.UTF_8 enum\n\nSigned-off-by: Alexander Krasnogolowy <alexkrasno@hotmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "91d7854a66604e5b2626bee8c0f0b23bd6300b7d", "author": {"user": {"login": "ZzetT", "name": null}}, "url": "https://github.com/openhab/openhab-addons/commit/91d7854a66604e5b2626bee8c0f0b23bd6300b7d", "committedDate": "2020-01-06T21:55:48Z", "message": "removed unnecessary try-catch\n\nSigned-off-by: Alexander Krasnogolowy <alexkrasno@hotmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4fc4a8f5a90a56f8fcb0ad1e670017a517570eee", "author": {"user": {"login": "ZzetT", "name": null}}, "url": "https://github.com/openhab/openhab-addons/commit/4fc4a8f5a90a56f8fcb0ad1e670017a517570eee", "committedDate": "2020-01-06T21:46:25Z", "message": "removed unnecessary try-catch\n\nSigned-off-by: Alexander Krasnogolowy <alexkrasno@hotmail.com>"}, "afterCommit": {"oid": "91d7854a66604e5b2626bee8c0f0b23bd6300b7d", "author": {"user": {"login": "ZzetT", "name": null}}, "url": "https://github.com/openhab/openhab-addons/commit/91d7854a66604e5b2626bee8c0f0b23bd6300b7d", "committedDate": "2020-01-06T21:55:48Z", "message": "removed unnecessary try-catch\n\nSigned-off-by: Alexander Krasnogolowy <alexkrasno@hotmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4OTI1ODk5", "url": "https://github.com/openhab/openhab-addons/pull/6736#pullrequestreview-338925899", "createdAt": "2020-01-06T22:08:37Z", "commit": {"oid": "91d7854a66604e5b2626bee8c0f0b23bd6300b7d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5MTEzOTQ4", "url": "https://github.com/openhab/openhab-addons/pull/6736#pullrequestreview-339113948", "createdAt": "2020-01-07T09:19:20Z", "commit": {"oid": "91d7854a66604e5b2626bee8c0f0b23bd6300b7d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1749, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}