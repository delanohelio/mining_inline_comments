{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMyNzQwNTQw", "number": 9227, "title": "[icalendar] Reload calendar file asynchronously", "bodyText": "Reload calendar file asynchronously to avoid slow initialization\n\n2020-12-04 08:34:08.896 [WARN ] [core.thing.internal.ThingManagerImpl] - Initializing handler for thing 'icalendar:calendar:calendar' takes more than 5000ms.\n\nSigned-off-by: Christoph Weitkamp github@christophweitkamp.de", "createdAt": "2020-12-04T19:29:59Z", "url": "https://github.com/openhab/openhab-addons/pull/9227", "merged": true, "mergeCommit": {"oid": "1a6f5b51589553266a8f06a4c1846e73c40f7ab6"}, "closed": true, "closedAt": "2020-12-08T19:07:25Z", "author": {"login": "cweitkamp"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdi-f9cgFqTU0NTMwMzE3MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdkO9LQAFqTU0NzU0MjQ3MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1MzAzMTcw", "url": "https://github.com/openhab/openhab-addons/pull/9227#pullrequestreview-545303170", "createdAt": "2020-12-04T21:19:30Z", "commit": {"oid": "02bd093d133e941609e3d10d08857b6fa4de91ec"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQyMToxOTozMFrOH_iYWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQyMToxOTozMFrOH_iYWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM4NTYyNQ==", "bodyText": "Maybe it would be better to just let the scheduled pull task handle the asynchronous part instead?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            updateStatus(ThingStatus.UNKNOWN);\n          \n          \n            \n            \n          \n          \n            \n                            scheduler.submit(() -> {\n          \n          \n            \n                                // reload calendar file asynchronously\n          \n          \n            \n                                if (reloadCalendar()) {\n          \n          \n            \n                                    updateStatus(ThingStatus.ONLINE);\n          \n          \n            \n                                    updateStates();\n          \n          \n            \n                                    rescheduleCalendarStateUpdate();\n          \n          \n            \n                                } else {\n          \n          \n            \n                                    updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR,\n          \n          \n            \n                                            \"The calendar seems to be configured correctly, but the local copy of calendar could not be loaded.\");\n          \n          \n            \n                                }\n          \n          \n            \n                            });\n          \n          \n            \n                            pullJobFuture = scheduler.scheduleWithFixedDelay(regularPull, refreshTime, refreshTime,\n          \n          \n            \n                                    TimeUnit.MINUTES);\n          \n          \n            \n                            updateStatus(ThingStatus.UNKNOWN);\n          \n          \n            \n                            pullJobFuture = scheduler.scheduleWithFixedDelay(regularPull, 0, refreshTime,\n          \n          \n            \n                                    TimeUnit.MINUTES);", "url": "https://github.com/openhab/openhab-addons/pull/9227#discussion_r536385625", "createdAt": "2020-12-04T21:19:30Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.icalendar/src/main/java/org/openhab/binding/icalendar/internal/handler/ICalendarHandler.java", "diffHunk": "@@ -154,14 +152,19 @@ public void initialize() {\n             }\n             final long refreshTime = refreshTimeBD.longValue();\n             if (calendarFile.isFile()) {\n-                if (reloadCalendar()) {\n-                    updateStatus(ThingStatus.ONLINE);\n-                    updateStates();\n-                    rescheduleCalendarStateUpdate();\n-                } else {\n-                    updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR,\n-                            \"The calendar seems to be configured correctly, but the local copy of calendar could not be loaded.\");\n-                }\n+                updateStatus(ThingStatus.UNKNOWN);\n+\n+                scheduler.submit(() -> {\n+                    // reload calendar file asynchronously\n+                    if (reloadCalendar()) {\n+                        updateStatus(ThingStatus.ONLINE);\n+                        updateStates();\n+                        rescheduleCalendarStateUpdate();\n+                    } else {\n+                        updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR,\n+                                \"The calendar seems to be configured correctly, but the local copy of calendar could not be loaded.\");\n+                    }\n+                });\n                 pullJobFuture = scheduler.scheduleWithFixedDelay(regularPull, refreshTime, refreshTime,\n                         TimeUnit.MINUTES);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02bd093d133e941609e3d10d08857b6fa4de91ec"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1NzQyNzcx", "url": "https://github.com/openhab/openhab-addons/pull/9227#pullrequestreview-545742771", "createdAt": "2020-12-06T20:05:33Z", "commit": {"oid": "02bd093d133e941609e3d10d08857b6fa4de91ec"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNlQyMDowNTozM1rOIAOx2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNlQyMDowNTozM1rOIAOx2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzExMzA1MA==", "bodyText": "Asynchronously loading the calendar works, it's already triggered by PullJob via CalendarUpdateListener.onCalendarUpdated() this way (regularly via scheduleWithFixedDelay). However, just using the PullJob for reloading may cause the calendar to be in OFFLINE state if e.g. being offline even if a cached copy exists. So i think this is not a good idea.", "url": "https://github.com/openhab/openhab-addons/pull/9227#discussion_r537113050", "createdAt": "2020-12-06T20:05:33Z", "author": {"login": "daMihe"}, "path": "bundles/org.openhab.binding.icalendar/src/main/java/org/openhab/binding/icalendar/internal/handler/ICalendarHandler.java", "diffHunk": "@@ -154,14 +152,19 @@ public void initialize() {\n             }\n             final long refreshTime = refreshTimeBD.longValue();\n             if (calendarFile.isFile()) {\n-                if (reloadCalendar()) {\n-                    updateStatus(ThingStatus.ONLINE);\n-                    updateStates();\n-                    rescheduleCalendarStateUpdate();\n-                } else {\n-                    updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR,\n-                            \"The calendar seems to be configured correctly, but the local copy of calendar could not be loaded.\");\n-                }\n+                updateStatus(ThingStatus.UNKNOWN);\n+\n+                scheduler.submit(() -> {\n+                    // reload calendar file asynchronously\n+                    if (reloadCalendar()) {\n+                        updateStatus(ThingStatus.ONLINE);\n+                        updateStates();\n+                        rescheduleCalendarStateUpdate();\n+                    } else {\n+                        updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR,\n+                                \"The calendar seems to be configured correctly, but the local copy of calendar could not be loaded.\");\n+                    }\n+                });\n                 pullJobFuture = scheduler.scheduleWithFixedDelay(regularPull, refreshTime, refreshTime,\n                         TimeUnit.MINUTES);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM4NTYyNQ=="}, "originalCommit": {"oid": "02bd093d133e941609e3d10d08857b6fa4de91ec"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06003c1188f6d8a3b0ae55f68224be214ef2173f", "author": {"user": {"login": "cweitkamp", "name": "Christoph Weitkamp"}}, "url": "https://github.com/openhab/openhab-addons/commit/06003c1188f6d8a3b0ae55f68224be214ef2173f", "committedDate": "2020-12-08T07:36:13Z", "message": "Reload calendar file asynchronously\n\nSigned-off-by: Christoph Weitkamp <github@christophweitkamp.de>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "906c1c273faecf1a243199598b2b832554b4627d", "author": {"user": {"login": "cweitkamp", "name": "Christoph Weitkamp"}}, "url": "https://github.com/openhab/openhab-addons/commit/906c1c273faecf1a243199598b2b832554b4627d", "committedDate": "2020-12-08T07:42:15Z", "message": "Incorporated comments from review\n\nSigned-off-by: Christoph Weitkamp <github@christophweitkamp.de>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "02bd093d133e941609e3d10d08857b6fa4de91ec", "author": {"user": {"login": "cweitkamp", "name": "Christoph Weitkamp"}}, "url": "https://github.com/openhab/openhab-addons/commit/02bd093d133e941609e3d10d08857b6fa4de91ec", "committedDate": "2020-12-04T08:15:48Z", "message": "Reload calendar file asynchronously\n\nSigned-off-by: Christoph Weitkamp <github@christophweitkamp.de>"}, "afterCommit": {"oid": "906c1c273faecf1a243199598b2b832554b4627d", "author": {"user": {"login": "cweitkamp", "name": "Christoph Weitkamp"}}, "url": "https://github.com/openhab/openhab-addons/commit/906c1c273faecf1a243199598b2b832554b4627d", "committedDate": "2020-12-08T07:42:15Z", "message": "Incorporated comments from review\n\nSigned-off-by: Christoph Weitkamp <github@christophweitkamp.de>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3NTQyNDcx", "url": "https://github.com/openhab/openhab-addons/pull/9227#pullrequestreview-547542471", "createdAt": "2020-12-08T19:04:00Z", "commit": {"oid": "906c1c273faecf1a243199598b2b832554b4627d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3998, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}