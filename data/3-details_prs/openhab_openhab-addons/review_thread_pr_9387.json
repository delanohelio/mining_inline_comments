{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQwMTkwNjA5", "number": 9387, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQyMTo1MjoxMVrOFF0tTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQyMTo1NTo1NlrOFF0zBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQxNjUwNzY3OnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.binding.smhi/src/main/java/org/openhab/binding/smhi/internal/SmhiHandler.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQyMTo1MjoxMVrOIGhl-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQwOToyMjoyM1rOIG7kfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzcxMjc2MA==", "bodyText": "Why did you change this to a custom unit calculation? Same for below.", "url": "https://github.com/openhab/openhab-addons/pull/9387#discussion_r543712760", "createdAt": "2020-12-15T21:52:11Z", "author": {"login": "fwolter"}, "path": "bundles/org.openhab.binding.smhi/src/main/java/org/openhab/binding/smhi/internal/SmhiHandler.java", "diffHunk": "@@ -159,74 +156,87 @@ private void updateChannels(TimeSeries timeSeries) {\n                 continue;\n             }\n \n-            int offset = 24 * i + 12;\n-            Forecast forecast = timeSeries.getForecast(currentDay, offset);\n+            int dayOffset = i;\n+            int hourOffset = 24 * dayOffset + 12;\n+            Optional<Forecast> forecast = timeSeries.getForecast(currentDay, hourOffset);\n \n-            if (forecast == null) {\n+            if (forecast.isEmpty()) {\n                 if (logger.isDebugEnabled()) {\n-                    logger.debug(\"No forecast yet for {}\", currentDay.plusHours(offset));\n+                    logger.debug(\"No forecast yet for {}\", currentDay.plusHours(hourOffset));\n                 }\n                 channels.forEach(c -> {\n-                    updateState(c.getUID(), UnDefType.NULL);\n+                    updateState(c.getUID(), UnDefType.UNDEF);\n                 });\n             } else {\n                 channels.forEach(c -> {\n                     String id = c.getUID().getIdWithoutGroup();\n-                    BigDecimal value = forecast.getParameter(id);\n+                    Optional<BigDecimal> value;\n+                    if (isAggregatedChannel(id)) {\n+                        value = getAggregatedValue(id, timeSeries, dayOffset);\n+                    } else {\n+                        value = forecast.get().getParameter(id);\n+                    }\n                     updateChannel(c, value);\n                 });\n             }\n         }\n     }\n \n-    private void updateChannel(Channel channel, @Nullable BigDecimal value) {\n+    private void updateChannel(Channel channel, Optional<BigDecimal> value) {\n         String id = channel.getUID().getIdWithoutGroup();\n-        State newState = UnDefType.NULL;\n+        State newState = UnDefType.UNDEF;\n \n-        if (value != null) {\n+        if (value.isPresent()) {\n             switch (id) {\n                 case PRESSURE:\n-                    newState = new QuantityType<>(value, MetricPrefix.HECTO(SIUnits.PASCAL));\n+                    newState = new QuantityType<>(value.get(), MetricPrefix.HECTO(SIUnits.PASCAL));\n                     break;\n                 case TEMPERATURE:\n-                    newState = new QuantityType<>(value, SIUnits.CELSIUS);\n+                case TEMPERATURE_MAX:\n+                case TEMPERATURE_MIN:\n+                    newState = new QuantityType<>(value.get(), SIUnits.CELSIUS);\n                     break;\n                 case VISIBILITY:\n-                    newState = new QuantityType<>(value, MetricPrefix.KILO(SIUnits.METRE));\n+                    newState = new QuantityType<>(value.get(), MetricPrefix.KILO(SIUnits.METRE));\n                     break;\n                 case WIND_DIRECTION:\n-                    newState = new QuantityType<>(value, Units.DEGREE_ANGLE);\n+                    newState = new QuantityType<>(value.get(), Units.DEGREE_ANGLE);\n                     break;\n                 case WIND_SPEED:\n+                case WIND_MAX:\n+                case WIND_MIN:\n                 case GUST:\n-                    newState = new QuantityType<>(value, Units.METRE_PER_SECOND);\n+                    newState = new QuantityType<>(value.get(), SIUnits.METRE.divide(Units.SECOND));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7259ec407d7483e0593481e485ef952a2a8aea32"}, "originalPosition": 95}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDA3MTI1MQ==", "bodyText": "When testing out the binding, I noticed that the values returned from the Item didn't keep the unit that the QuantityType was created with (some with m/s and some with mm/h), but instead used the default, which is km/h for Number:Speed-Items. Since all other types seemed to work correctly (even the Number:Length-Items where some have km an some mm for unit oddly enough) I thought it had something to to with the predefined composite units, so tried to set it explicitly. Forgot to revert afterwards.", "url": "https://github.com/openhab/openhab-addons/pull/9387#discussion_r544071251", "createdAt": "2020-12-16T07:28:46Z", "author": {"login": "pacive"}, "path": "bundles/org.openhab.binding.smhi/src/main/java/org/openhab/binding/smhi/internal/SmhiHandler.java", "diffHunk": "@@ -159,74 +156,87 @@ private void updateChannels(TimeSeries timeSeries) {\n                 continue;\n             }\n \n-            int offset = 24 * i + 12;\n-            Forecast forecast = timeSeries.getForecast(currentDay, offset);\n+            int dayOffset = i;\n+            int hourOffset = 24 * dayOffset + 12;\n+            Optional<Forecast> forecast = timeSeries.getForecast(currentDay, hourOffset);\n \n-            if (forecast == null) {\n+            if (forecast.isEmpty()) {\n                 if (logger.isDebugEnabled()) {\n-                    logger.debug(\"No forecast yet for {}\", currentDay.plusHours(offset));\n+                    logger.debug(\"No forecast yet for {}\", currentDay.plusHours(hourOffset));\n                 }\n                 channels.forEach(c -> {\n-                    updateState(c.getUID(), UnDefType.NULL);\n+                    updateState(c.getUID(), UnDefType.UNDEF);\n                 });\n             } else {\n                 channels.forEach(c -> {\n                     String id = c.getUID().getIdWithoutGroup();\n-                    BigDecimal value = forecast.getParameter(id);\n+                    Optional<BigDecimal> value;\n+                    if (isAggregatedChannel(id)) {\n+                        value = getAggregatedValue(id, timeSeries, dayOffset);\n+                    } else {\n+                        value = forecast.get().getParameter(id);\n+                    }\n                     updateChannel(c, value);\n                 });\n             }\n         }\n     }\n \n-    private void updateChannel(Channel channel, @Nullable BigDecimal value) {\n+    private void updateChannel(Channel channel, Optional<BigDecimal> value) {\n         String id = channel.getUID().getIdWithoutGroup();\n-        State newState = UnDefType.NULL;\n+        State newState = UnDefType.UNDEF;\n \n-        if (value != null) {\n+        if (value.isPresent()) {\n             switch (id) {\n                 case PRESSURE:\n-                    newState = new QuantityType<>(value, MetricPrefix.HECTO(SIUnits.PASCAL));\n+                    newState = new QuantityType<>(value.get(), MetricPrefix.HECTO(SIUnits.PASCAL));\n                     break;\n                 case TEMPERATURE:\n-                    newState = new QuantityType<>(value, SIUnits.CELSIUS);\n+                case TEMPERATURE_MAX:\n+                case TEMPERATURE_MIN:\n+                    newState = new QuantityType<>(value.get(), SIUnits.CELSIUS);\n                     break;\n                 case VISIBILITY:\n-                    newState = new QuantityType<>(value, MetricPrefix.KILO(SIUnits.METRE));\n+                    newState = new QuantityType<>(value.get(), MetricPrefix.KILO(SIUnits.METRE));\n                     break;\n                 case WIND_DIRECTION:\n-                    newState = new QuantityType<>(value, Units.DEGREE_ANGLE);\n+                    newState = new QuantityType<>(value.get(), Units.DEGREE_ANGLE);\n                     break;\n                 case WIND_SPEED:\n+                case WIND_MAX:\n+                case WIND_MIN:\n                 case GUST:\n-                    newState = new QuantityType<>(value, Units.METRE_PER_SECOND);\n+                    newState = new QuantityType<>(value.get(), SIUnits.METRE.divide(Units.SECOND));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzcxMjc2MA=="}, "originalCommit": {"oid": "7259ec407d7483e0593481e485ef952a2a8aea32"}, "originalPosition": 95}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDEzODM2NQ==", "bodyText": "Reverted now", "url": "https://github.com/openhab/openhab-addons/pull/9387#discussion_r544138365", "createdAt": "2020-12-16T09:22:23Z", "author": {"login": "pacive"}, "path": "bundles/org.openhab.binding.smhi/src/main/java/org/openhab/binding/smhi/internal/SmhiHandler.java", "diffHunk": "@@ -159,74 +156,87 @@ private void updateChannels(TimeSeries timeSeries) {\n                 continue;\n             }\n \n-            int offset = 24 * i + 12;\n-            Forecast forecast = timeSeries.getForecast(currentDay, offset);\n+            int dayOffset = i;\n+            int hourOffset = 24 * dayOffset + 12;\n+            Optional<Forecast> forecast = timeSeries.getForecast(currentDay, hourOffset);\n \n-            if (forecast == null) {\n+            if (forecast.isEmpty()) {\n                 if (logger.isDebugEnabled()) {\n-                    logger.debug(\"No forecast yet for {}\", currentDay.plusHours(offset));\n+                    logger.debug(\"No forecast yet for {}\", currentDay.plusHours(hourOffset));\n                 }\n                 channels.forEach(c -> {\n-                    updateState(c.getUID(), UnDefType.NULL);\n+                    updateState(c.getUID(), UnDefType.UNDEF);\n                 });\n             } else {\n                 channels.forEach(c -> {\n                     String id = c.getUID().getIdWithoutGroup();\n-                    BigDecimal value = forecast.getParameter(id);\n+                    Optional<BigDecimal> value;\n+                    if (isAggregatedChannel(id)) {\n+                        value = getAggregatedValue(id, timeSeries, dayOffset);\n+                    } else {\n+                        value = forecast.get().getParameter(id);\n+                    }\n                     updateChannel(c, value);\n                 });\n             }\n         }\n     }\n \n-    private void updateChannel(Channel channel, @Nullable BigDecimal value) {\n+    private void updateChannel(Channel channel, Optional<BigDecimal> value) {\n         String id = channel.getUID().getIdWithoutGroup();\n-        State newState = UnDefType.NULL;\n+        State newState = UnDefType.UNDEF;\n \n-        if (value != null) {\n+        if (value.isPresent()) {\n             switch (id) {\n                 case PRESSURE:\n-                    newState = new QuantityType<>(value, MetricPrefix.HECTO(SIUnits.PASCAL));\n+                    newState = new QuantityType<>(value.get(), MetricPrefix.HECTO(SIUnits.PASCAL));\n                     break;\n                 case TEMPERATURE:\n-                    newState = new QuantityType<>(value, SIUnits.CELSIUS);\n+                case TEMPERATURE_MAX:\n+                case TEMPERATURE_MIN:\n+                    newState = new QuantityType<>(value.get(), SIUnits.CELSIUS);\n                     break;\n                 case VISIBILITY:\n-                    newState = new QuantityType<>(value, MetricPrefix.KILO(SIUnits.METRE));\n+                    newState = new QuantityType<>(value.get(), MetricPrefix.KILO(SIUnits.METRE));\n                     break;\n                 case WIND_DIRECTION:\n-                    newState = new QuantityType<>(value, Units.DEGREE_ANGLE);\n+                    newState = new QuantityType<>(value.get(), Units.DEGREE_ANGLE);\n                     break;\n                 case WIND_SPEED:\n+                case WIND_MAX:\n+                case WIND_MIN:\n                 case GUST:\n-                    newState = new QuantityType<>(value, Units.METRE_PER_SECOND);\n+                    newState = new QuantityType<>(value.get(), SIUnits.METRE.divide(Units.SECOND));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzcxMjc2MA=="}, "originalCommit": {"oid": "7259ec407d7483e0593481e485ef952a2a8aea32"}, "originalPosition": 95}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQxNjUyMjI5OnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.binding.smhi/src/main/resources/OH-INF/thing/channel-types.xml", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQyMTo1NTo1NlrOIGhuaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQwOToxMzo1MVrOIG7OMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzcxNDkyMw==", "bodyText": "What's the reason for replacing the units by constants?", "url": "https://github.com/openhab/openhab-addons/pull/9387#discussion_r543714923", "createdAt": "2020-12-15T21:55:56Z", "author": {"login": "fwolter"}, "path": "bundles/org.openhab.binding.smhi/src/main/resources/OH-INF/thing/channel-types.xml", "diffHunk": "@@ -8,97 +8,127 @@\n \t\t<item-type>Number:Pressure</item-type>\n \t\t<label>Air Pressure</label>\n \t\t<description>Air pressure in hPa</description>\n-\t\t<state readOnly=\"true\" pattern=\"%.1f %unit%\"/>\n+\t\t<state readOnly=\"true\" pattern=\"%.1f hPa\"/>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7259ec407d7483e0593481e485ef952a2a8aea32"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDA3MTI5MA==", "bodyText": "This however did solve the above problem, so I figured I'd set it explicitly for all channels, so there's a sensible default. It can still be overridden by setting the state description on the Item to a different unit. If I use %unit% for the channels, the state description would have to be set for each Item to make it display the correct unit, which can be a lot of work for the end user.\nExample:\nWithout explicit unit:\nopenhab> openhab:status SMHIWeatherForecast_MinWindSpeed\n5.759990784011058554102274358886417 km/h\n\nWith explicit unit:\nopenhab> openhab:status SMHIWeatherForecast_MinWindSpeed\n1.6 m/s\n\nShould this be considered a bug, and an issue raised in openhab-core?", "url": "https://github.com/openhab/openhab-addons/pull/9387#discussion_r544071290", "createdAt": "2020-12-16T07:28:50Z", "author": {"login": "pacive"}, "path": "bundles/org.openhab.binding.smhi/src/main/resources/OH-INF/thing/channel-types.xml", "diffHunk": "@@ -8,97 +8,127 @@\n \t\t<item-type>Number:Pressure</item-type>\n \t\t<label>Air Pressure</label>\n \t\t<description>Air pressure in hPa</description>\n-\t\t<state readOnly=\"true\" pattern=\"%.1f %unit%\"/>\n+\t\t<state readOnly=\"true\" pattern=\"%.1f hPa\"/>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzcxNDkyMw=="}, "originalCommit": {"oid": "7259ec407d7483e0593481e485ef952a2a8aea32"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDEzMjY1Ng==", "bodyText": "The units might be converted by the framework due to locale settings. As it's unlikely that this binding will be used by users with imperial units, I think it's good to go with constant units.", "url": "https://github.com/openhab/openhab-addons/pull/9387#discussion_r544132656", "createdAt": "2020-12-16T09:13:51Z", "author": {"login": "fwolter"}, "path": "bundles/org.openhab.binding.smhi/src/main/resources/OH-INF/thing/channel-types.xml", "diffHunk": "@@ -8,97 +8,127 @@\n \t\t<item-type>Number:Pressure</item-type>\n \t\t<label>Air Pressure</label>\n \t\t<description>Air pressure in hPa</description>\n-\t\t<state readOnly=\"true\" pattern=\"%.1f %unit%\"/>\n+\t\t<state readOnly=\"true\" pattern=\"%.1f hPa\"/>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzcxNDkyMw=="}, "originalCommit": {"oid": "7259ec407d7483e0593481e485ef952a2a8aea32"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3683, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}