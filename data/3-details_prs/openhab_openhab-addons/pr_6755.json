{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU5MTQ5Nzg0", "number": 6755, "title": "[mqtt] Allow outgoing format", "bodyText": "This PR handles outgoing formats.\nFor this the value is kept as a Value.\nTransformations will retrieve the String value by calling the default format (Value.getMQTTpublishValue(null))\nAfter the transformation, the string result is converted to a TextValue.\nAfter all transformations, the value is converted to a String by calling Value.getMQTTpublishValue(format) allowing for special handling of the different values.\nDefault formats are adjusted to the old behaviour and documented in the README.md\nThis should adress #6566 (Use \"%.0f\" as format and not \"%d\")", "createdAt": "2020-01-03T23:03:24Z", "url": "https://github.com/openhab/openhab-addons/pull/6755", "merged": true, "mergeCommit": {"oid": "06815315cf8ddd3b941d137f297d4c45695957d6"}, "closed": true, "closedAt": "2020-01-06T14:33:20Z", "author": {"login": "jochen314"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb2x72zAH2gAyMzU5MTQ5Nzg0OmJmY2ZkNjMwMWMxN2Y0Zjc0NDdjN2QyNDA2MmYxMjJmZTEyODJiZjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb3tFRZgFqTMzODY3NDI1OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bfcfd6301c17f4f7447c7d24062f122fe1282bf9", "author": {"user": {"login": "jochen314", "name": "Jochen Klein"}}, "url": "https://github.com/openhab/openhab-addons/commit/bfcfd6301c17f4f7447c7d24062f122fe1282bf9", "committedDate": "2020-01-03T17:37:34Z", "message": "initial commit\n\nSigned-off-by: Jochen Klein <git@jochen.susca.de>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9c95bb59f16dede913c4dcc36796745ac9a5563", "author": {"user": {"login": "jochen314", "name": "Jochen Klein"}}, "url": "https://github.com/openhab/openhab-addons/commit/b9c95bb59f16dede913c4dcc36796745ac9a5563", "committedDate": "2020-01-03T22:52:27Z", "message": "readme\n\ncommon format pattern.\nallow format after transformation\n\nSigned-off-by: Jochen Klein <git@jochen.susca.de>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4MzQ2MzQ4", "url": "https://github.com/openhab/openhab-addons/pull/6755#pullrequestreview-338346348", "createdAt": "2020-01-04T09:59:26Z", "commit": {"oid": "b9c95bb59f16dede913c4dcc36796745ac9a5563"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNFQwOTo1OToyNlrOFaNY6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNFQwOTo1OToyNlrOFaNY6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzAyNjY2NA==", "bodyText": "Not sure if this sentence is important. It might be confusing actually. mqtt3 can only handle strings and binary.", "url": "https://github.com/openhab/openhab-addons/pull/6755#discussion_r363026664", "createdAt": "2020-01-04T09:59:26Z", "author": {"login": "davidgraeff"}, "path": "bundles/org.openhab.binding.mqtt.generic/README.md", "diffHunk": "@@ -245,6 +245,23 @@ Here are a few examples:\n   - For an output of *May 23, 1995* use \"%1$**tb** %1$**te**,%1$**tY**\".\n   - For an output of *23.05.1995* use \"%1$**td**.%1$**tm**.%1$**tY**\".\n   - For an output of *23:15* use \"%1$**tH**:%1$**tM**\".\n+  \n+Default pattern applied for each type:\n+| Type             | Parameter                         | Pattern             | Comment |\n+| ---------------- | --------------------------------- | ------------------- | ------- |\n+| __string__       | String                            | \"%s\"                | \n+| __number__       | BigDecimal                        | \"%f\"                | The default will remove trailing zeros after the decimal point. \n+| __dimmer__       | BigDecimal                        | \"%f\"                | The default will remove trailing zeros after the decimal point. \n+| __contact__      | String                            | --                  | No pattern supported. Always **on** and **off** strings. \n+| __switch__       | String                            | --                  | No pattern supported. Always **on** and **off** strings. \n+| __colorRGB__     | BigDecimal, BigDecimal, BigDecimal| \"%1$d,%2$d,%3$d\"    | Parameters are **red**, **green** and **blue** components.\n+| __colorHSB__     | BigDecimal, BigDecimal, BigDecimal| \"%1$d,%2$d,%3$d\"    | Parameters are **hue**, **saturation** and **brightness** components.\n+| __location__     | BigDecimal, BigDecimal            | \"%2$f,%3$f,%1$f\"    | Parameters are **altitude**, **latitude** and **longitude**, altitude is only in default pattern, if value is not '0'.\n+| __image__        | --                                | --                  | No publishing supported. \n+| __datetime__     | ZonedDateTime                     | \"%1$tY-%1$tm-%1$tdT%1$tH:%1$tM:%1$tS.%1$tN\" | Trailing zeros of the nanoseconds are removed.\n+| __rollershutter__| String                            | \"%s\"                | No pattern supported. Always **up**, **down**, **stop** string or integer percent value.\n+\n+Any outgoing value transformation will **always** result in a __string__ value.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b9c95bb59f16dede913c4dcc36796745ac9a5563"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4MzcxMzg4", "url": "https://github.com/openhab/openhab-addons/pull/6755#pullrequestreview-338371388", "createdAt": "2020-01-04T21:45:08Z", "commit": {"oid": "b9c95bb59f16dede913c4dcc36796745ac9a5563"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNFQyMTo0NTowOVrOFaPOyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNFQyMTo0NTowOVrOFaPOyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzA1Njg0MA==", "bodyText": "What happens if cachedValue is a NumberValue and we have a transformation that e.g. returns a character or a string based on the number value? In update we do newValue = new BigDecimal(command.toString()); which will fail.", "url": "https://github.com/openhab/openhab-addons/pull/6755#discussion_r363056840", "createdAt": "2020-01-04T21:45:09Z", "author": {"login": "J-N-K"}, "path": "bundles/org.openhab.binding.mqtt.generic/src/main/java/org/openhab/binding/mqtt/generic/ChannelState.java", "diffHunk": "@@ -352,29 +352,36 @@ public boolean hasSubscribed() {\n \n         // Outgoing transformations\n         for (ChannelStateTransformation t : transformationsOut) {\n-            String transformedValue = t.processValue(mqttCommandValue);\n+            String commandString = mqttCommandValue.getMQTTpublishValue(null);\n+            String transformedValue = t.processValue(commandString);\n             if (transformedValue != null) {\n-                mqttCommandValue = transformedValue;\n+                Value textValue = new TextValue();\n+                textValue.update(new StringType(transformedValue));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b9c95bb59f16dede913c4dcc36796745ac9a5563"}, "originalPosition": 51}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4NDA1Njk0", "url": "https://github.com/openhab/openhab-addons/pull/6755#pullrequestreview-338405694", "createdAt": "2020-01-05T15:05:26Z", "commit": {"oid": "b9c95bb59f16dede913c4dcc36796745ac9a5563"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4Njc0MjU4", "url": "https://github.com/openhab/openhab-addons/pull/6755#pullrequestreview-338674258", "createdAt": "2020-01-06T14:32:15Z", "commit": {"oid": "b9c95bb59f16dede913c4dcc36796745ac9a5563"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1790, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}