{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIyNDI3OTc3", "number": 7776, "title": "[keba] Don't use selector if it has been closed", "bodyText": "On bundle shutdown, I have seen errors like:\nException in thread \"openHAB-Keba-Transceiver\" java.nio.channels.ClosedSelectorException\n        at java.base/sun.nio.ch.SelectorImpl.ensureOpen(SelectorImpl.java:75)\n        at java.base/sun.nio.ch.SelectorImpl.lockAndDoSelect(SelectorImpl.java:118)\n        at java.base/sun.nio.ch.SelectorImpl.selectNow(SelectorImpl.java:146)\n        at org.openhab.binding.keba.internal.handler.KeContactTransceiver.lambda$0(KeContactTransceiver.java:223)\n        at java.base/java.lang.Thread.run(Thread.java:834)\n\nWe hence must make sure to only use the selector if it hasn't yet been closed.\nSigned-off-by: Kai Kreuzer kai@openhab.org", "createdAt": "2020-05-24T15:18:41Z", "url": "https://github.com/openhab/openhab-addons/pull/7776", "merged": true, "mergeCommit": {"oid": "03b8d51e923559a660f54415f6ed5bb42c0f03e7"}, "closed": true, "closedAt": "2020-05-25T22:59:33Z", "author": {"login": "kaikreuzer"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABckdCVQgH2gAyNDIyNDI3OTc3OjBmZjJhMTdmNGE4Y2QzYzlkNGJmMTkwODc1NzE4ZTgyMWZiODBjNmU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABck4PvdAFqTQxNzg5NTM3NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0ff2a17f4a8cd3c9d4bf190875718e821fb80c6e", "author": {"user": {"login": "kaikreuzer", "name": "Kai Kreuzer"}}, "url": "https://github.com/openhab/openhab-addons/commit/0ff2a17f4a8cd3c9d4bf190875718e821fb80c6e", "committedDate": "2020-05-24T15:17:09Z", "message": "don't use selector if it has been closed\n\nSigned-off-by: Kai Kreuzer <kai@openhab.org>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3NDA4OTQx", "url": "https://github.com/openhab/openhab-addons/pull/7776#pullrequestreview-417408941", "createdAt": "2020-05-25T00:41:08Z", "commit": {"oid": "0ff2a17f4a8cd3c9d4bf190875718e821fb80c6e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQwMDo0MTowOFrOGZyXZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQwMDo0MTowOFrOGZyXZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY5Mjc3NQ==", "bodyText": "As far as I can tell ClosedSelectorException could be thrown from any of the selector operations and since the selector is closed from another thread it could be closed on this thread at any time. I don't think that simply checking if it is open at this point is sufficient to prevent ClosedSelectorException from getting thrown.\nI think the easiest way to deal with this error is to just catch the ClosedSelectorException.\nBut a more proper way to prevent this error from getting thrown is to make the transceiverThread responsible for opening and closing the selector and to add logic to allow outside threads to instruct the transceiverThread to close the selector on its own accord.\nI'm ok with either solution but I think the first one is better because there are fewer things that can go wrong with it.", "url": "https://github.com/openhab/openhab-addons/pull/7776#discussion_r429692775", "createdAt": "2020-05-25T00:41:08Z", "author": {"login": "cpmeister"}, "path": "bundles/org.openhab.binding.keba/src/main/java/org/openhab/binding/keba/internal/handler/KeContactTransceiver.java", "diffHunk": "@@ -219,6 +219,9 @@ protected ByteBuffer send(String message, KeContactHandler handler) {\n         while (true) {\n             try {\n                 synchronized (selector) {\n+                    if (!selector.isOpen()) {\n+                        return;\n+                    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ff2a17f4a8cd3c9d4bf190875718e821fb80c6e"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a790b58c9ab7a5ac9732dab85b0dda438d27d65", "author": {"user": {"login": "kaikreuzer", "name": "Kai Kreuzer"}}, "url": "https://github.com/openhab/openhab-addons/commit/6a790b58c9ab7a5ac9732dab85b0dda438d27d65", "committedDate": "2020-05-25T18:17:33Z", "message": "addressed review comment\n\nSigned-off-by: Kai Kreuzer <kai@openhab.org>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3ODk1Mzc1", "url": "https://github.com/openhab/openhab-addons/pull/7776#pullrequestreview-417895375", "createdAt": "2020-05-25T22:59:14Z", "commit": {"oid": "6a790b58c9ab7a5ac9732dab85b0dda438d27d65"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 417, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}