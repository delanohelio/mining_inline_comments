{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgxNzg5NTUx", "number": 7080, "title": "[mqtt.homeassistant] Improve compatibility with Tasmota based color lights", "bodyText": "The HomeAssistant MQTT discovery documentation is slightly confusing with regard to when to use value_template, and when to use state_value_template in config payloads.  Some HomeAssistant items expect value_template, some expect state_value_template.  LED strip controllers based on the popular Tasmota firmware use value_template.  While this doesn't directly match the documentation for lights on the HomeAssistant MQTT web page, it is acceptable to the HomeAssistant software.\nOne may argue that the Tasmota firmware is incorrect, but this change allows OpenHAB to work with existing Tasmota firmware.  There is likely significant overlap between Tasmota firmware users, and OpenHAB users so this enhancement should be useful to many.\nTagging @jochen314 and @davidgraeff as the primary authors for the MQTT binding.", "createdAt": "2020-02-29T06:57:25Z", "url": "https://github.com/openhab/openhab-addons/pull/7080", "merged": true, "mergeCommit": {"oid": "652c70ea7e904b7c5778864c38a812e556712569"}, "closed": true, "closedAt": "2020-03-14T03:23:56Z", "author": {"login": "mehoekstra"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcFRHfIAH2gAyMzgxNzg5NTUxOjQxMWNkMDM2NTEzMzU1NDA5ZTI3NmY5YzhkOTIwNjkyMjZiZGYwMzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcNcQZcgFqTM3NDY5Mzg1MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "411cd036513355409e276f9c8d92069226bdf039", "author": {"user": {"login": "mehoekstra", "name": "Matt Hoekstra"}}, "url": "https://github.com/openhab/openhab-addons/commit/411cd036513355409e276f9c8d92069226bdf039", "committedDate": "2020-02-17T17:52:16Z", "message": "ixed bugs in ComponentLight and HomeAssistantThingHandler\n\nSigned-off-by: Matt Hoekstra <matthew.e.hoekstra@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0983a397341679b6f8d4db7948d63e98dd086da8", "author": {"user": {"login": "mehoekstra", "name": "Matt Hoekstra"}}, "url": "https://github.com/openhab/openhab-addons/commit/0983a397341679b6f8d4db7948d63e98dd086da8", "committedDate": "2020-02-17T22:22:53Z", "message": "ixed bugs in ComponentLight and HomeAssistantThingHandler\n\nSigned-off-by: Matt Hoekstra <matthew.e.hoekstra@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ed9f5da6c2c1f38fcb451b52c3447b1075593b8", "author": {"user": {"login": "mehoekstra", "name": "Matt Hoekstra"}}, "url": "https://github.com/openhab/openhab-addons/commit/6ed9f5da6c2c1f38fcb451b52c3447b1075593b8", "committedDate": "2020-02-17T22:24:19Z", "message": "Merge branch '2.5.x' of https://github.com/mehoekstra/openhab-addons into 2.5.x"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e1c5847dd038f67a515f08fcd7e78e77cede7342", "author": {"user": {"login": "mehoekstra", "name": "Matt Hoekstra"}}, "url": "https://github.com/openhab/openhab-addons/commit/e1c5847dd038f67a515f08fcd7e78e77cede7342", "committedDate": "2020-02-19T04:45:57Z", "message": "Merge branch '2.5.x' of https://github.com/openhab/openhab-addons into 2.5.x\n\nSigned-off-by: Matt Hoekstra <matthew.e.hoekstra@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "46f8d1d4a37d67381a03cb2778bd502b15e782b1", "author": {"user": {"login": "mehoekstra", "name": "Matt Hoekstra"}}, "url": "https://github.com/openhab/openhab-addons/commit/46f8d1d4a37d67381a03cb2778bd502b15e782b1", "committedDate": "2020-02-19T05:00:06Z", "message": "Rolling back so that only one file change is in this pull request.\n\nSigned-off-by: Matt Hoekstra <matthew.e.hoekstra@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e971f76425b8490860fa8d8795ed425f372f1c6", "author": {"user": {"login": "mehoekstra", "name": "Matt Hoekstra"}}, "url": "https://github.com/openhab/openhab-addons/commit/9e971f76425b8490860fa8d8795ed425f372f1c6", "committedDate": "2020-02-29T04:59:30Z", "message": "Merge branch '2.5.x' of https://github.com/openhab/openhab-addons into tasmota"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "387a0d69f57c5eaaf3a9f9a86bd26f78167c03b8", "author": {"user": {"login": "mehoekstra", "name": "Matt Hoekstra"}}, "url": "https://github.com/openhab/openhab-addons/commit/387a0d69f57c5eaaf3a9f9a86bd26f78167c03b8", "committedDate": "2020-02-29T06:37:55Z", "message": "Set state_value_template = value_template if state_value_template == null\n\nSigned-off-by: Matt Hoekstra <matthew.e.hoekstra@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "faef3a253a43bd72e0cd3ad937051c39d138a5f6", "author": {"user": {"login": "mehoekstra", "name": "Matt Hoekstra"}}, "url": "https://github.com/openhab/openhab-addons/commit/faef3a253a43bd72e0cd3ad937051c39d138a5f6", "committedDate": "2020-02-29T06:50:27Z", "message": "rolling back change, so only one change in this pull request\n\nSigned-off-by: Matt Hoekstra <matthew.e.hoekstra@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dbf39c5367d82aa6593f69f21173e41df6d8aff6", "author": {"user": {"login": "mehoekstra", "name": "Matt Hoekstra"}}, "url": "https://github.com/openhab/openhab-addons/commit/dbf39c5367d82aa6593f69f21173e41df6d8aff6", "committedDate": "2020-03-05T05:16:54Z", "message": "Added dependencies for the test program to properly run\n\nSigned-off-by: Matt Hoekstra <matthew.e.hoekstra@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba6ab904df91951eeb4257b693d6ff6aa4a5ae20", "author": {"user": {"login": "mehoekstra", "name": "Matt Hoekstra"}}, "url": "https://github.com/openhab/openhab-addons/commit/ba6ab904df91951eeb4257b693d6ff6aa4a5ae20", "committedDate": "2020-03-05T07:49:57Z", "message": "Tests are functional now!  Need to cleanup a bit before submitting pull request\n\nSigned-off-by: Matt Hoekstra <matthew.e.hoekstra@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fbfcd9e684214e0ac82e8e875fa1869e7bac0fdb", "author": {"user": {"login": "mehoekstra", "name": "Matt Hoekstra"}}, "url": "https://github.com/openhab/openhab-addons/commit/fbfcd9e684214e0ac82e8e875fa1869e7bac0fdb", "committedDate": "2020-03-05T07:51:02Z", "message": "Tests functional now, need to clean up before pull\n\nSigned-off-by: Matt Hoekstra <matthew.e.hoekstra@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwODU1NDIy", "url": "https://github.com/openhab/openhab-addons/pull/7080#pullrequestreview-370855422", "createdAt": "2020-03-08T20:24:19Z", "commit": {"oid": "faef3a253a43bd72e0cd3ad937051c39d138a5f6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOFQyMDoyNDoxOVrOFzXN-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOFQyMDoyNDoxOVrOFzXN-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQwMjEwNw==", "bodyText": "Did you notic, that the stateTopic()method allows for any number of templates?\nThe frist non-Blank one will be used.\nSo we could just do:\n.stateTopic(channelConfiguration.state_topic, channelConfiguration.state_value_template, channelConfiguration.value_template)", "url": "https://github.com/openhab/openhab-addons/pull/7080#discussion_r389402107", "createdAt": "2020-03-08T20:24:19Z", "author": {"login": "jochen314"}, "path": "bundles/org.openhab.binding.mqtt.homeassistant/src/main/java/org/openhab/binding/mqtt/homeassistant/internal/ComponentLight.java", "diffHunk": "@@ -102,6 +102,16 @@ public ComponentLight(CFactory.ComponentConfiguration builder) {\n         this.channelStateUpdateListener = builder.getUpdateListener();\n         ColorValue value = new ColorValue(true, channelConfiguration.payload_on, channelConfiguration.payload_off, 100);\n \n+        // HomeAssistant MQTT Discovery documentation is a bit unclear as to when to use value_template and\n+        // when to use state_value_template. As a result, not all light implementations use state_value_template.\n+        // Lights using the Tasmota firmware for example use value_template.\n+        if (channelConfiguration.state_value_template == null) {\n+            channelConfiguration.state_value_template = channelConfiguration.value_template;\n+        }\n+        if (channelConfiguration.value_template == null) {\n+            channelConfiguration.value_template = channelConfiguration.state_value_template;\n+        }\n+\n         // Create three MQTT subscriptions and use this class object as update listener\n         switchChannel = buildChannel(switchChannelID, value, channelConfiguration.name, this)//\n                 .stateTopic(channelConfiguration.state_topic, channelConfiguration.state_value_template)//", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "faef3a253a43bd72e0cd3ad937051c39d138a5f6"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e493e01d6e1c04a06780c93b9915a9d0b59e715b", "author": {"user": {"login": "mehoekstra", "name": "Matt Hoekstra"}}, "url": "https://github.com/openhab/openhab-addons/commit/e493e01d6e1c04a06780c93b9915a9d0b59e715b", "committedDate": "2020-03-13T05:00:25Z", "message": "Merged with latest 2.5x branch\n\nSigned-off-by: Matt Hoekstra <matthew.e.hoekstra@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b03029352791687f879f3391b68e71c28c7721ad", "author": {"user": {"login": "mehoekstra", "name": "Matt Hoekstra"}}, "url": "https://github.com/openhab/openhab-addons/commit/b03029352791687f879f3391b68e71c28c7721ad", "committedDate": "2020-03-13T05:07:38Z", "message": "Rolling back to main 2.5x version of test\n\nSigned-off-by: Matt Hoekstra <matthew.e.hoekstra@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ebc18e36b1bf4aad402b2fad365b2c3a9ab96c5", "author": {"user": {"login": "mehoekstra", "name": "Matt Hoekstra"}}, "url": "https://github.com/openhab/openhab-addons/commit/1ebc18e36b1bf4aad402b2fad365b2c3a9ab96c5", "committedDate": "2020-03-13T07:37:48Z", "message": "Now uses varargs function to choose value_template or state_value_template\n\nSigned-off-by: Matt Hoekstra <matthew.e.hoekstra@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0NjkzODUw", "url": "https://github.com/openhab/openhab-addons/pull/7080#pullrequestreview-374693850", "createdAt": "2020-03-14T03:22:22Z", "commit": {"oid": "1ebc18e36b1bf4aad402b2fad365b2c3a9ab96c5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1077, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}