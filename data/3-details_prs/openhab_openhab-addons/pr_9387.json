{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQwMTkwNjA5", "number": 9387, "title": "[smhi] Add aggregated channels for daily forecast.", "bodyText": "Also updates to use Optionals instead of @Nullables, and add unit tests\nSigned-off-by: Anders Alfredsson andersb86@gmail.com", "createdAt": "2020-12-15T11:46:53Z", "url": "https://github.com/openhab/openhab-addons/pull/9387", "merged": true, "mergeCommit": {"oid": "393ae49dc49c60a167363ca3f26dfe65bcbc1ab6"}, "closed": true, "closedAt": "2020-12-22T21:50:28Z", "author": {"login": "pacive"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmY2tPAH2gAyNTQwMTkwNjA5OjcyNTllYzQwN2Q3NDgzZTA1OTM0ODFlNDg1ZWY5NTJhMmE4YWVhMzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmrhDtgFqTU1MzUwMDA2Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7259ec407d7483e0593481e485ef952a2a8aea32", "author": {"user": {"login": "pacive", "name": "Anders Alfredsson"}}, "url": "https://github.com/openhab/openhab-addons/commit/7259ec407d7483e0593481e485ef952a2a8aea32", "committedDate": "2020-12-15T11:43:50Z", "message": "Add aggregated channels for daily forecast.\n\nAlso updates to use Optionals instead of @Nullables, and add unit tests\n\nSigned-off-by: Anders Alfredsson <andersb86@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyOTQyOTIw", "url": "https://github.com/openhab/openhab-addons/pull/9387#pullrequestreview-552942920", "createdAt": "2020-12-15T21:52:10Z", "commit": {"oid": "7259ec407d7483e0593481e485ef952a2a8aea32"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQyMTo1MjoxMVrOIGhl-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQyMTo1NTo1NlrOIGhuaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzcxMjc2MA==", "bodyText": "Why did you change this to a custom unit calculation? Same for below.", "url": "https://github.com/openhab/openhab-addons/pull/9387#discussion_r543712760", "createdAt": "2020-12-15T21:52:11Z", "author": {"login": "fwolter"}, "path": "bundles/org.openhab.binding.smhi/src/main/java/org/openhab/binding/smhi/internal/SmhiHandler.java", "diffHunk": "@@ -159,74 +156,87 @@ private void updateChannels(TimeSeries timeSeries) {\n                 continue;\n             }\n \n-            int offset = 24 * i + 12;\n-            Forecast forecast = timeSeries.getForecast(currentDay, offset);\n+            int dayOffset = i;\n+            int hourOffset = 24 * dayOffset + 12;\n+            Optional<Forecast> forecast = timeSeries.getForecast(currentDay, hourOffset);\n \n-            if (forecast == null) {\n+            if (forecast.isEmpty()) {\n                 if (logger.isDebugEnabled()) {\n-                    logger.debug(\"No forecast yet for {}\", currentDay.plusHours(offset));\n+                    logger.debug(\"No forecast yet for {}\", currentDay.plusHours(hourOffset));\n                 }\n                 channels.forEach(c -> {\n-                    updateState(c.getUID(), UnDefType.NULL);\n+                    updateState(c.getUID(), UnDefType.UNDEF);\n                 });\n             } else {\n                 channels.forEach(c -> {\n                     String id = c.getUID().getIdWithoutGroup();\n-                    BigDecimal value = forecast.getParameter(id);\n+                    Optional<BigDecimal> value;\n+                    if (isAggregatedChannel(id)) {\n+                        value = getAggregatedValue(id, timeSeries, dayOffset);\n+                    } else {\n+                        value = forecast.get().getParameter(id);\n+                    }\n                     updateChannel(c, value);\n                 });\n             }\n         }\n     }\n \n-    private void updateChannel(Channel channel, @Nullable BigDecimal value) {\n+    private void updateChannel(Channel channel, Optional<BigDecimal> value) {\n         String id = channel.getUID().getIdWithoutGroup();\n-        State newState = UnDefType.NULL;\n+        State newState = UnDefType.UNDEF;\n \n-        if (value != null) {\n+        if (value.isPresent()) {\n             switch (id) {\n                 case PRESSURE:\n-                    newState = new QuantityType<>(value, MetricPrefix.HECTO(SIUnits.PASCAL));\n+                    newState = new QuantityType<>(value.get(), MetricPrefix.HECTO(SIUnits.PASCAL));\n                     break;\n                 case TEMPERATURE:\n-                    newState = new QuantityType<>(value, SIUnits.CELSIUS);\n+                case TEMPERATURE_MAX:\n+                case TEMPERATURE_MIN:\n+                    newState = new QuantityType<>(value.get(), SIUnits.CELSIUS);\n                     break;\n                 case VISIBILITY:\n-                    newState = new QuantityType<>(value, MetricPrefix.KILO(SIUnits.METRE));\n+                    newState = new QuantityType<>(value.get(), MetricPrefix.KILO(SIUnits.METRE));\n                     break;\n                 case WIND_DIRECTION:\n-                    newState = new QuantityType<>(value, Units.DEGREE_ANGLE);\n+                    newState = new QuantityType<>(value.get(), Units.DEGREE_ANGLE);\n                     break;\n                 case WIND_SPEED:\n+                case WIND_MAX:\n+                case WIND_MIN:\n                 case GUST:\n-                    newState = new QuantityType<>(value, Units.METRE_PER_SECOND);\n+                    newState = new QuantityType<>(value.get(), SIUnits.METRE.divide(Units.SECOND));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7259ec407d7483e0593481e485ef952a2a8aea32"}, "originalPosition": 95}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzcxNDkyMw==", "bodyText": "What's the reason for replacing the units by constants?", "url": "https://github.com/openhab/openhab-addons/pull/9387#discussion_r543714923", "createdAt": "2020-12-15T21:55:56Z", "author": {"login": "fwolter"}, "path": "bundles/org.openhab.binding.smhi/src/main/resources/OH-INF/thing/channel-types.xml", "diffHunk": "@@ -8,97 +8,127 @@\n \t\t<item-type>Number:Pressure</item-type>\n \t\t<label>Air Pressure</label>\n \t\t<description>Air pressure in hPa</description>\n-\t\t<state readOnly=\"true\" pattern=\"%.1f %unit%\"/>\n+\t\t<state readOnly=\"true\" pattern=\"%.1f hPa\"/>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7259ec407d7483e0593481e485ef952a2a8aea32"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2fa57ee3e9a345b32feb3575718ec85f244037d", "author": {"user": {"login": "pacive", "name": "Anders Alfredsson"}}, "url": "https://github.com/openhab/openhab-addons/commit/a2fa57ee3e9a345b32feb3575718ec85f244037d", "committedDate": "2020-12-16T07:30:59Z", "message": "Revert unsing explicit unit definition\n\nSigned-off-by: Anders Alfredsson <andersb86@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzNTAwMDYy", "url": "https://github.com/openhab/openhab-addons/pull/9387#pullrequestreview-553500062", "createdAt": "2020-12-16T09:28:23Z", "commit": {"oid": "a2fa57ee3e9a345b32feb3575718ec85f244037d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3795, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}