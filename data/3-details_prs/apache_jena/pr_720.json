{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk2MTczNjQ5", "number": 720, "title": "JENA-1875: Context for Turtle related stream writers.", "bodyText": "Add a \"context\" argument to Turtle/Trig syntax stream writers, including tests.\nAlso, more on JENA-1761\nAdding the style switch for @base/BASE.", "createdAt": "2020-03-31T08:46:39Z", "url": "https://github.com/apache/jena/pull/720", "merged": true, "mergeCommit": {"oid": "b6ba09ef1bfaccaa346d11d8df76e6b136826d5f"}, "closed": true, "closedAt": "2020-04-02T18:55:36Z", "author": {"login": "afs"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcS-JO1gH2gAyMzk2MTczNjQ5OjQzODU4MDFlYmM3ZTY5MjRlZGU0N2IzOWNhNTIwNTI4ZTRjZWM4OTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTalviABqjMxODg3OTc5NjY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4385801ebc7e6924ede47b39ca520528e4cec897", "author": {"user": {"login": "afs", "name": "Andy Seaborne"}}, "url": "https://github.com/apache/jena/commit/4385801ebc7e6924ede47b39ca520528e4cec897", "committedDate": "2020-03-31T07:40:55Z", "message": "JENA-1875: Context argument for stream writers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c30990f878f8e2dfbb9f12e31248a6d2c27752de", "author": {"user": {"login": "afs", "name": "Andy Seaborne"}}, "url": "https://github.com/apache/jena/commit/c30990f878f8e2dfbb9f12e31248a6d2c27752de", "committedDate": "2020-03-31T08:27:51Z", "message": "JENA-1761: Switchable writing of @base/BASE"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "780b3169117e21364d79098d66130f25f6c05ea5", "author": {"user": {"login": "afs", "name": "Andy Seaborne"}}, "url": "https://github.com/apache/jena/commit/780b3169117e21364d79098d66130f25f6c05ea5", "committedDate": "2020-03-31T10:06:12Z", "message": "JENA-1875: Context argument for stream writers (Elephas)"}, "afterCommit": {"oid": "75da71c33637844ae459450ddf9c55aaf931d8a8", "author": {"user": {"login": "afs", "name": "Andy Seaborne"}}, "url": "https://github.com/apache/jena/commit/75da71c33637844ae459450ddf9c55aaf931d8a8", "committedDate": "2020-03-31T12:45:54Z", "message": "JENA-1875: Context argument for stream writers (Elephas)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1MTI4MzYx", "url": "https://github.com/apache/jena/pull/720#pullrequestreview-385128361", "createdAt": "2020-03-31T21:46:48Z", "commit": {"oid": "75da71c33637844ae459450ddf9c55aaf931d8a8"}, "state": "APPROVED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQyMTo0Njo0OVrOF-pbbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQyMTo1Mzo0M1rOF-poJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTIzNDc5OA==", "bodyText": "Should we use try-with-resources here to close it later? Test only so I think it may not matter much.", "url": "https://github.com/apache/jena/pull/720#discussion_r401234798", "createdAt": "2020-03-31T21:46:49Z", "author": {"login": "kinow"}, "path": "jena-arq/src/test/java/org/apache/jena/riot/writer/TestTurtleWriter.java", "diffHunk": "@@ -55,70 +60,110 @@ static void blankNodeLang(String testdata, RDFFormat lang) {\n         Model m = ModelFactory.createDefaultModel() ;\n         RDFDataMgr.read(m, r, null, RDFLanguages.NTRIPLES) ;\n         Assert.assertTrue(m.size() > 0);\n-        \n+\n         ByteArrayOutputStream output = new ByteArrayOutputStream();\n         RDFDataMgr.write(output, m, lang);\n-        \n+\n         ByteArrayInputStream input = new ByteArrayInputStream(output.toByteArray());\n         Model m2 = ModelFactory.createDefaultModel();\n         RDFDataMgr.read(m2, input, lang.getLang());\n-        \n+\n         Assert.assertTrue(m2.size() > 0);\n         Assert.assertTrue(m.isIsomorphicWith(m2));\n     }\n-    \n-    // Tests from JENA-908 \n+\n+    // Tests from JENA-908\n     @Test\n     public void bnode_cycles_01() { blankNodeLang(cycle1, RDFFormat.TURTLE) ; }\n-    \n+\n     @Test\n     public void bnode_cycles_02() { blankNodeLang(cycle1, RDFFormat.TURTLE_BLOCKS) ; }\n-    \n+\n     @Test\n     public void bnode_cycles_03() { blankNodeLang(cycle1, RDFFormat.TURTLE_FLAT) ; }\n-    \n+\n     @Test\n     public void bnode_cycles_04() { blankNodeLang(cycle1, RDFFormat.TURTLE_PRETTY) ; }\n \n     @Test\n     public void bnode_cycles_05() { blankNodeLang(cycle2, RDFFormat.TURTLE) ; }\n-    \n+\n     @Test\n     public void bnode_cycles_06() { blankNodeLang(cycle2, RDFFormat.TURTLE_BLOCKS) ; }\n-    \n+\n     @Test\n     public void bnode_cycles_07() { blankNodeLang(cycle2, RDFFormat.TURTLE_FLAT) ; }\n-    \n+\n     @Test\n     public void bnode_cycles_08() { blankNodeLang(cycle2, RDFFormat.TURTLE_PRETTY) ; }\n \n     @Test\n     public void bnode_cycles() {\n         Model m = RDFDataMgr.loadModel(\"testing/DAWG-Final/construct/data-ident.ttl\");\n         Assert.assertTrue(m.size() > 0);\n-        \n+\n         ByteArrayOutputStream output = new ByteArrayOutputStream();\n         RDFDataMgr.write(output, m, Lang.TURTLE);\n-        \n+\n         ByteArrayInputStream input = new ByteArrayInputStream(output.toByteArray());\n         Model m2 = ModelFactory.createDefaultModel();\n         RDFDataMgr.read(m2, input, Lang.TURTLE);\n         Assert.assertTrue(m2.size() > 0);\n-        \n+\n         Assert.assertTrue(m.isIsomorphicWith(m2));\n     }\n-    \n+\n+    // @base\n     @Test\n-    public void test_base() {\n-        InputStream r = new ByteArrayInputStream(TestTurtleWriter.basetester.getBytes()) ;\n-        String b = \"http://example.org/\" ;\n-        Model m = ModelFactory.createDefaultModel() ;\n-        m.read(r, b, \"TTL\") ;\n+    public void test_base_1() {\n+        // Default base style\n+        String result = modelToString(baseTestData, RDFFormat.TURTLE_FLAT, null);\n+        int count1 = StringUtils.countMatches(result, \"@base\");\n+        Assert.assertEquals(1, count1);\n+        int count2 = StringUtils.countMatches(result, \"BASE\");\n+        Assert.assertEquals(0, count2);\n+    }\n+\n+    @Test\n+    public void test_base_2() {\n+        Context cxt = RIOT.getContext().copy();\n+        cxt.set(RIOT.symTurtleDirectiveStyle, DirectiveStyle.AT);\n+        String result = modelToString(baseTestData, RDFFormat.TURTLE_BLOCKS, null);\n+        int count1 = StringUtils.countMatches(result, \"@base\");\n+        Assert.assertEquals(1, count1);\n+        int count2 = StringUtils.countMatches(result, \"BASE\");\n+        Assert.assertEquals(0, count2);\n+    }\n+\n+\n+    // BASE\n+    @Test\n+    public void test_base_3() {\n+        Context cxt = RIOT.getContext().copy();\n+        cxt.set(RIOT.symTurtleDirectiveStyle, DirectiveStyle.SPARQL);\n+        String result = modelToString(baseTestData, RDFFormat.TURTLE_FLAT, cxt);\n+        int count1 = StringUtils.countMatches(result, \"BASE\");\n+        Assert.assertEquals(1, count1);\n+        int count2 = StringUtils.countMatches(result, \"@base\");\n+        Assert.assertEquals(0, count2);\n+    }\n+\n+    @Test\n+    public void test_base_4() {\n+        Context cxt = RIOT.getContext().copy();\n+        cxt.set(RIOT.symTurtleDirectiveStyle, DirectiveStyle.SPARQL);\n+        String result = modelToString(baseTestData, RDFFormat.TURTLE_BLOCKS, cxt);\n+        int count1 = StringUtils.countMatches(result, \"BASE\");\n+        Assert.assertEquals(1, count1);\n+        int count2 = StringUtils.countMatches(result, \"@base\");\n+        Assert.assertEquals(0, count2);\n+    }\n \n-        OutputStream o = new ByteArrayOutputStream() ;\n-        RDFWriter.create().source(m).format(RDFFormat.TURTLE_BLOCKS).base(b).output(o) ;\n-        String k = o.toString() ;\n-        Assert.assertTrue(k.contains(\"@base\")) ;\n+    private String modelToString(Model model, RDFFormat format, Context context) {\n+        ByteArrayOutputStream o = new ByteArrayOutputStream();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "75da71c33637844ae459450ddf9c55aaf931d8a8"}, "originalPosition": 178}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTIzNjMwOQ==", "bodyText": "If it's not changed elsewhere, maybe it could be final too? Otherwise it could lead to inconsistent results if multiple thread access directiveStyle I think? (as it returns its value there)", "url": "https://github.com/apache/jena/pull/720#discussion_r401236309", "createdAt": "2020-03-31T21:49:52Z", "author": {"login": "kinow"}, "path": "jena-arq/src/main/java/org/apache/jena/riot/writer/WriterLib.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.jena.riot.writer;\n+\n+import org.apache.jena.riot.RIOT;\n+import org.apache.jena.sparql.util.Context;\n+\n+/** Package-scoped utilities */\n+/*package*/ class WriterLib {\n+\n+    static DirectiveStyle dftDirectiveStyle = DirectiveStyle.AT;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "75da71c33637844ae459450ddf9c55aaf931d8a8"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTIzNjUwMQ==", "bodyText": "Nice \ud83d\udc4d", "url": "https://github.com/apache/jena/pull/720#discussion_r401236501", "createdAt": "2020-03-31T21:50:17Z", "author": {"login": "kinow"}, "path": "jena-arq/src/main/java/org/apache/jena/riot/writer/TurtleShell.java", "diffHunk": "@@ -82,21 +67,7 @@ protected TurtleShell(IndentedWriter out, PrefixMap pmap, String baseURI, NodeFo\n         this.baseURI = baseURI ;\n         this.nodeFmt = nodeFmt ;\n         this.context = context;\n-        this.prefixStyle = prefixStyle(context) ;\n-    }\n-\n-    // Determine the prefix style (applies to BASE as well).\n-    private static PrefixStyle prefixStyle(Context context) {\n-        Object x = context.get(RIOT.symTurtlePrefixStyle) ;\n-        if ( x instanceof String ) {\n-            String s = (String)x ;\n-            PrefixStyle style = PrefixStyle.create(s);\n-            return style == null ? dftPrefixStyle : style;\n-        }\n-        if ( x instanceof PrefixStyle )\n-            return (PrefixStyle)x ;\n-        // Default choice; includes null in context.\n-        return dftPrefixStyle;\n+        this.prefixStyle = WriterLib.directiveStyle(context) ;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "75da71c33637844ae459450ddf9c55aaf931d8a8"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTIzNjY3OA==", "bodyText": "Missing newline at the end of the file? Important for git I think...", "url": "https://github.com/apache/jena/pull/720#discussion_r401236678", "createdAt": "2020-03-31T21:50:38Z", "author": {"login": "kinow"}, "path": "jena-arq/src/main/java/org/apache/jena/riot/writer/DirectiveStyle.java", "diffHunk": "@@ -0,0 +1,33 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.jena.riot.writer;\n+\n+enum DirectiveStyle {\n+    AT, SPARQL ;\n+    public static DirectiveStyle create(String label) {\n+        String s = label.toLowerCase() ;\n+        switch(s) {\n+            case \"rdf_10\": case \"rdf10\": case \"n3\": case \"at\":\n+                return DirectiveStyle.AT ;\n+            case \"rdf_11\": case \"rdf11\": case \"sparql\":\n+                return DirectiveStyle.SPARQL ;\n+        }\n+        return null;\n+    }\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "75da71c33637844ae459450ddf9c55aaf931d8a8"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTIzNzgzNg==", "bodyText": "Just checking, the other one looks like Turtle with a . at the end. This new style doesn't need that right?", "url": "https://github.com/apache/jena/pull/720#discussion_r401237836", "createdAt": "2020-03-31T21:53:17Z", "author": {"login": "kinow"}, "path": "jena-arq/src/main/java/org/apache/jena/riot/system/RiotLib.java", "diffHunk": "@@ -342,45 +342,51 @@ private static void writeBaseOldStyle(IndentedWriter out, String base) {\n         }\n     }\n \n-    /** Write prefixes, using {@code PREFIX} */ \n+    /** Write prefixes */ \n     public static void writePrefixes(IndentedWriter out, PrefixMap prefixMap, boolean newStyle) {\n-        if ( newStyle )\n-            writePrefixesNewStyle(out, prefixMap);\n-        else\n-            writePrefixesOldStyle(out, prefixMap);\n-    }\n-    \n-    /** Write prefixes, using {@code PREFIX} */ \n-    private static void writePrefixesNewStyle(IndentedWriter out, PrefixMap prefixMap) {\n         if ( prefixMap != null && !prefixMap.isEmpty() ) {\n             for ( Map.Entry<String, String> e : prefixMap.getMapping().entrySet() ) {\n-                out.print(\"PREFIX \");\n-                out.print(e.getKey());\n-                out.print(\": \");\n-                out.pad(PREFIX_IRI);\n-                out.print(\"<\");\n-                out.print(e.getValue());\n-                out.print(\">\");\n-                out.println();\n+                if ( newStyle )\n+                    writePrefixNewStyle(out, e.getKey(), e.getValue());\n+                else\n+                    writePrefixOldStyle(out, e.getKey(), e.getValue());\n             }\n         }\n     }\n+    \n+    /** Write a prefix.\n+     * Write using {@code @prefix} or {@code PREFIX}.\n+     */ \n+    public static void writePrefix(IndentedWriter out, String prefix, String uri, boolean newStyle) {\n+        if ( newStyle )\n+            writePrefixNewStyle(out, prefix, uri);\n+        else\n+            writePrefixOldStyle(out, prefix, uri);\n+    }\n+\n+    /** Write prefix, using {@code PREFIX} */ \n+    private static void writePrefixNewStyle(IndentedWriter out, String prefix, String uri) {\n+        out.print(\"PREFIX \");\n+        out.print(prefix);\n+        out.print(\": \");\n+        out.pad(PREFIX_IRI);\n+        out.print(\"<\");\n+        out.print(uri);\n+        out.print(\">\");\n+        out.println();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "75da71c33637844ae459450ddf9c55aaf931d8a8"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTIzODA1Mw==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/apache/jena/pull/720#discussion_r401238053", "createdAt": "2020-03-31T21:53:43Z", "author": {"login": "kinow"}, "path": "jena-arq/src/main/java/org/apache/jena/riot/system/StreamRDFOps.java", "diffHunk": "@@ -103,8 +107,18 @@ public static void sendGraphToStream(Graph graph, StreamRDF stream) {\n         sendGraphToStream(graph, stream, prefixMap) ;\n     }\n     \n-    /** Send the triples of graph and an explicitly given prefix mapping, to a StreamRDF */\n+    /**\n+     * @deprecated prefer {@link #sendGraphToStream(Graph, StreamRDF, String, PrefixMap)} with a null base URI.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "75da71c33637844ae459450ddf9c55aaf931d8a8"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "096411efec61dc4bc76c149d1d3ec0a1527a349c", "author": {"user": {"login": "afs", "name": "Andy Seaborne"}}, "url": "https://github.com/apache/jena/commit/096411efec61dc4bc76c149d1d3ec0a1527a349c", "committedDate": "2020-04-01T16:49:08Z", "message": "JENA-1875: Context argument for stream writers (Elephas)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "75da71c33637844ae459450ddf9c55aaf931d8a8", "author": {"user": {"login": "afs", "name": "Andy Seaborne"}}, "url": "https://github.com/apache/jena/commit/75da71c33637844ae459450ddf9c55aaf931d8a8", "committedDate": "2020-03-31T12:45:54Z", "message": "JENA-1875: Context argument for stream writers (Elephas)"}, "afterCommit": {"oid": "096411efec61dc4bc76c149d1d3ec0a1527a349c", "author": {"user": {"login": "afs", "name": "Andy Seaborne"}}, "url": "https://github.com/apache/jena/commit/096411efec61dc4bc76c149d1d3ec0a1527a349c", "committedDate": "2020-04-01T16:49:08Z", "message": "JENA-1875: Context argument for stream writers (Elephas)"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3011, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}