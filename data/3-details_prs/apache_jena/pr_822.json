{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE0MTE2Nzg1", "number": 822, "title": "Add Fuseki /$/compact/* endpoint (JENA-1987)", "bodyText": "Some of the implementation for adding a /$/compact/* endpoint to a Fuseki server that allows live database compaction via the REST API\nTo Do:\n\n Add some integration test cases\n Companion PR for doc updates", "createdAt": "2020-11-02T14:58:57Z", "url": "https://github.com/apache/jena/pull/822", "merged": true, "mergeCommit": {"oid": "b5dff72279a630e380e011f7288d7c1897bd9819"}, "closed": true, "closedAt": "2020-11-18T09:02:35Z", "author": {"login": "rvesse"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdYlxsXgH2gAyNTE0MTE2Nzg1OjE1YmU2MzQ4MmM3NjQ0ZDE1NGI3NWZhNTA1ZjlmNjQ4YzU2NWMxYWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABddXluuAH2gAyNTE0MTE2Nzg1OjJkZWNiNWQ5N2Q4ZGQ4ODgyN2JhNTU5ODcxOTlmOTdmZmM1Y2MzNDg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "15be63482c7644d154b75fa505f9f648c565c1ac", "author": {"user": {"login": "rvesse", "name": "Rob Vesse"}}, "url": "https://github.com/apache/jena/commit/15be63482c7644d154b75fa505f9f648c565c1ac", "committedDate": "2020-11-02T14:52:11Z", "message": "Add Fuseki /$/compact/* endpoint (JENA-1987)\n\nSome of the implementation for adding a /$/compact/* endpoint to a\nFuseki server that allows live database compaction via the REST API"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7ab131ab01881dc26435f7c047ec1299415e869", "author": {"user": {"login": "rvesse", "name": "Rob Vesse"}}, "url": "https://github.com/apache/jena/commit/c7ab131ab01881dc26435f7c047ec1299415e869", "committedDate": "2020-11-02T14:57:07Z", "message": "Simplify code (JENA-1987)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxNzA2Mzc0", "url": "https://github.com/apache/jena/pull/822#pullrequestreview-521706374", "createdAt": "2020-11-02T14:59:40Z", "commit": {"oid": "c7ab131ab01881dc26435f7c047ec1299415e869"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxNDo1OTo0MFrOHsH_sw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxNDo1OTo0MFrOHsH_sw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjAzMDM4Nw==", "bodyText": "This addition was necessary to be able to call DatabaseMgr.compact()", "url": "https://github.com/apache/jena/pull/822#discussion_r516030387", "createdAt": "2020-11-02T14:59:40Z", "author": {"login": "rvesse"}, "path": "jena-fuseki2/jena-fuseki-webapp/pom.xml", "diffHunk": "@@ -56,6 +56,12 @@\n       <artifactId>jena-text</artifactId>\n       <version>3.17.0-SNAPSHOT</version>\n     </dependency>\n+    \n+    <dependency>\n+        <groupId>org.apache.jena</groupId>\n+        <artifactId>jena-tdb2</artifactId>\n+        <version>3.17.0-SNAPSHOT</version>\n+    </dependency>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c7ab131ab01881dc26435f7c047ec1299415e869"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxODExNDEw", "url": "https://github.com/apache/jena/pull/822#pullrequestreview-521811410", "createdAt": "2020-11-02T16:49:26Z", "commit": {"oid": "c7ab131ab01881dc26435f7c047ec1299415e869"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxNjo0OToyNlrOHsM2YA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxNjo0OToyNlrOHsM2YA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjEwOTkyMA==", "bodyText": "Not sure this is possible because jena-fuseki-main does not depend on jena-fuseki-webapp from which the backup and compact functionality originate.", "url": "https://github.com/apache/jena/pull/822#discussion_r516109920", "createdAt": "2020-11-02T16:49:26Z", "author": {"login": "rvesse"}, "path": "jena-fuseki2/jena-fuseki-main/src/main/java/org/apache/jena/fuseki/main/FusekiServer.java", "diffHunk": "@@ -1021,6 +1021,7 @@ private void servletsAndFilters(ServletContextHandler context) {\n                 addServlet(context, \"/$/stats/*\", new ActionStats());\n             if ( withMetrics )\n                 addServlet(context, \"/$/metrics\", new ActionMetrics());\n+            // TODO Should we support registering other functionality e.g. /$/backup/* and /$/compact/*", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c7ab131ab01881dc26435f7c047ec1299415e869"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyNjg3ODQx", "url": "https://github.com/apache/jena/pull/822#pullrequestreview-522687841", "createdAt": "2020-11-03T16:45:35Z", "commit": {"oid": "c7ab131ab01881dc26435f7c047ec1299415e869"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxNjo0NTozNVrOHs3g_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxNjo1NjoxM1rOHs3_nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjgwODk1OA==", "bodyText": "Maybe test it is the right species of DatrasetGraph and return an error if it is not.\nSee TDBOps in fuseki-core.", "url": "https://github.com/apache/jena/pull/822#discussion_r516808958", "createdAt": "2020-11-03T16:45:35Z", "author": {"login": "afs"}, "path": "jena-fuseki2/jena-fuseki-webapp/src/main/java/org/apache/jena/fuseki/mgt/ActionCompact.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.jena.fuseki.mgt;\n+\n+import static java.lang.String.format;\n+\n+import org.apache.jena.fuseki.ctl.ActionAsyncTask;\n+import org.apache.jena.fuseki.ctl.TaskBase;\n+import org.apache.jena.fuseki.servlets.HttpAction;\n+import org.apache.jena.fuseki.servlets.ServletOps;\n+import org.apache.jena.tdb2.DatabaseMgr;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class ActionCompact extends ActionAsyncTask\n+{\n+    public ActionCompact() { super(\"Compact\"); }\n+\n+    @Override\n+    public void validate(HttpAction action) {}\n+\n+    @Override\n+    protected Runnable createRunnable(HttpAction action) {\n+        String name = getItemName(action);\n+        if ( name == null ) {\n+            action.log.error(\"Null for dataset name in item request\");\n+            ServletOps.errorOccurred(\"Null for dataset name in item request\");\n+            return null;\n+        }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c7ab131ab01881dc26435f7c047ec1299415e869"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjgxMzk5NQ==", "bodyText": "core has a dependency on jena-tdb2 via apache-jena-libs.\nI also check by adding a call to DatabaseMgr.compact in a class jena-fuseki-webapp.\n(cd jena-fuseki-webapp ; mvn dependency:tree) on the default branch of the codebase gives me:\n[INFO] org.apache.jena:jena-fuseki-webapp:jar:3.17.0-SNAPSHOT\n[INFO] +- org.apache.jena:jena-fuseki-core:jar:3.17.0-SNAPSHOT:compile\n[INFO] |  +- org.apache.jena:apache-jena-libs:pom:3.17.0-SNAPSHOT:compile\n[INFO] |  |  +- org.apache.jena:jena-shacl:jar:3.17.0-SNAPSHOT:compile\n[INFO] |  |  |  \\- org.apache.jena:jena-arq:jar:3.17.0-SNAPSHOT:compile\n[INFO] |  |  +- org.apache.jena:jena-tdb:jar:3.17.0-SNAPSHOT:compile\n[INFO] |  |  +- org.apache.jena:jena-tdb2:jar:3.17.0-SNAPSHOT:compile", "url": "https://github.com/apache/jena/pull/822#discussion_r516813995", "createdAt": "2020-11-03T16:52:32Z", "author": {"login": "afs"}, "path": "jena-fuseki2/jena-fuseki-webapp/pom.xml", "diffHunk": "@@ -56,6 +56,12 @@\n       <artifactId>jena-text</artifactId>\n       <version>3.17.0-SNAPSHOT</version>\n     </dependency>\n+    \n+    <dependency>\n+        <groupId>org.apache.jena</groupId>\n+        <artifactId>jena-tdb2</artifactId>\n+        <version>3.17.0-SNAPSHOT</version>\n+    </dependency>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjAzMDM4Nw=="}, "originalCommit": {"oid": "c7ab131ab01881dc26435f7c047ec1299415e869"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjgxNjc5OQ==", "bodyText": "There are a couple of big issues here.\n\nSecurity. So far fuseki-main additional operations under /$/are \"mostly harmless\" but this is a step more impactful.\nThe general area of admin for Fuseki/main where my concern is that we are building in a URL pattern and maybe a better design is add it as a service on the /myTDB2dataset/compact.\n\nSuggestion: add this admin function now for fuseki-webapp and fuseki-main later.\nLet's discuss on the JIRA ticket as it is not about the jena-webapps code which looks fine.", "url": "https://github.com/apache/jena/pull/822#discussion_r516816799", "createdAt": "2020-11-03T16:56:13Z", "author": {"login": "afs"}, "path": "jena-fuseki2/jena-fuseki-main/src/main/java/org/apache/jena/fuseki/main/FusekiServer.java", "diffHunk": "@@ -1021,6 +1021,7 @@ private void servletsAndFilters(ServletContextHandler context) {\n                 addServlet(context, \"/$/stats/*\", new ActionStats());\n             if ( withMetrics )\n                 addServlet(context, \"/$/metrics\", new ActionMetrics());\n+            // TODO Should we support registering other functionality e.g. /$/backup/* and /$/compact/*", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjEwOTkyMA=="}, "originalCommit": {"oid": "c7ab131ab01881dc26435f7c047ec1299415e869"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e5e7129a8fc17f9b66b290eae863080d97b5b77", "author": {"user": {"login": "rvesse", "name": "Rob Vesse"}}, "url": "https://github.com/apache/jena/commit/3e5e7129a8fc17f9b66b290eae863080d97b5b77", "committedDate": "2020-11-04T15:42:46Z", "message": "Remove unnecessary extra dependency (JENA-1987)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyMjE5NTQ1", "url": "https://github.com/apache/jena/pull/822#pullrequestreview-532219545", "createdAt": "2020-11-17T10:25:06Z", "commit": {"oid": "3e5e7129a8fc17f9b66b290eae863080d97b5b77"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09019c08249e4dda0eb6ec26f234b86b0dacbdbf", "author": {"user": {"login": "rvesse", "name": "Rob Vesse"}}, "url": "https://github.com/apache/jena/commit/09019c08249e4dda0eb6ec26f234b86b0dacbdbf", "committedDate": "2020-11-17T10:28:48Z", "message": "Unit tests for /$/compact/<dataset> (JENA-1987)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "207dcce55a2d0d2fa2736e91133c719d52083f93", "author": {"user": {"login": "rvesse", "name": "Rob Vesse"}}, "url": "https://github.com/apache/jena/commit/207dcce55a2d0d2fa2736e91133c719d52083f93", "committedDate": "2020-11-17T10:36:32Z", "message": "Rollback irrelevant changes (JENA-1987)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "697772891e17b3d080d69eec5e82ae6857476cd6", "author": {"user": {"login": "rvesse", "name": "Rob Vesse"}}, "url": "https://github.com/apache/jena/commit/697772891e17b3d080d69eec5e82ae6857476cd6", "committedDate": "2020-11-17T10:40:11Z", "message": "Rollback more irrelevant changes (JENA-1987)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1fe930c39dbb08ab8d17aea4f0c70500c5f5520f", "author": {"user": {"login": "rvesse", "name": "Rob Vesse"}}, "url": "https://github.com/apache/jena/commit/1fe930c39dbb08ab8d17aea4f0c70500c5f5520f", "committedDate": "2020-11-17T10:45:13Z", "message": "Rename method for clarity (JENA-1987)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyMjMzNjg4", "url": "https://github.com/apache/jena/pull/822#pullrequestreview-532233688", "createdAt": "2020-11-17T10:42:09Z", "commit": {"oid": "697772891e17b3d080d69eec5e82ae6857476cd6"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxMDo0MjowOVrOH0u0WQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxMDo0NDozNVrOH0u6UA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTA1NTA2NQ==", "bodyText": "Stumbled on this while writing some new unit tests around both /$/backup/<dataset> and /$/compact/<dataset>\nThis function didn't verify that dsg was not null so when it tried to interact with the ConcurrentHashMap that stores active backups it would NPE because concurrent maps do not permit null keys", "url": "https://github.com/apache/jena/pull/822#discussion_r525055065", "createdAt": "2020-11-17T10:42:09Z", "author": {"login": "rvesse"}, "path": "jena-fuseki2/jena-fuseki-webapp/src/main/java/org/apache/jena/fuseki/mgt/Backup.java", "diffHunk": "@@ -84,6 +84,10 @@ public static void backup(Transactional transactional, DatasetGraph dsg, String\n      * @see #backup(Transactional, DatasetGraph, String)\n      */\n     private static void backup(DatasetGraph dsg, String backupfile) {\n+        if (dsg == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "697772891e17b3d080d69eec5e82ae6857476cd6"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTA1NTUwOQ==", "bodyText": "As noted elsewhere was trying to get a success flag in the Task output working but couldn't get this working, left here for future reference", "url": "https://github.com/apache/jena/pull/822#discussion_r525055509", "createdAt": "2020-11-17T10:42:50Z", "author": {"login": "rvesse"}, "path": "jena-fuseki2/jena-fuseki-core/src/main/java/org/apache/jena/fuseki/ctl/JsonConstCtl.java", "diffHunk": "@@ -25,5 +25,6 @@\n     public static final String task             = \"task\";\n     public static final String finished         = \"finished\";\n     public static final String started          = \"started\";\n+    public static final String success          = \"success\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "697772891e17b3d080d69eec5e82ae6857476cd6"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTA1NjU5Mg==", "bodyText": "Added a TDB2 based dataset so I could test /$/compact/<dataset>, since adding and deleting this dataset might be unstable on Windows I made this and other tests that use that dataset require a non-Windows OS", "url": "https://github.com/apache/jena/pull/822#discussion_r525056592", "createdAt": "2020-11-17T10:44:35Z", "author": {"login": "rvesse"}, "path": "jena-fuseki2/jena-fuseki-webapp/src/test/java/org/apache/jena/fuseki/TestAdmin.java", "diffHunk": "@@ -187,6 +189,21 @@\n         addTestDataset(fileBase+\"config-ds-plain-2.ttl\");\n         checkExists(\"test-ds2\");\n     }\n+    \n+    @Test public void add_delete_dataset_6() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "697772891e17b3d080d69eec5e82ae6857476cd6"}, "originalPosition": 57}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ecccbd3d8699e509d1ca3afb2ad1d31e7f1e20f", "author": {"user": {"login": "rvesse", "name": "Rob Vesse"}}, "url": "https://github.com/apache/jena/commit/2ecccbd3d8699e509d1ca3afb2ad1d31e7f1e20f", "committedDate": "2020-11-17T11:05:22Z", "message": "Indicate task success/failure correctly (JENA-1987)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2decb5d97d8dd88827ba55987199f97ffc5cc348", "author": {"user": {"login": "rvesse", "name": "Rob Vesse"}}, "url": "https://github.com/apache/jena/commit/2decb5d97d8dd88827ba55987199f97ffc5cc348", "committedDate": "2020-11-17T11:10:04Z", "message": "Ensure ActionSleep throws errors upwards (JENA-1987)"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2965, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}