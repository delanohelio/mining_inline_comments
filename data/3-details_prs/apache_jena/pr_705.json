{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1NjM0ODE0", "number": 705, "title": "JENA-1854: Fuseki to consume the whole request body when errors occur.", "bodyText": "This PR catches various places where incomplete processing of the request body may happen and calls a function to consume any remaining bytes in the body input stream before starting sending the HTTP error response.", "createdAt": "2020-03-09T14:53:10Z", "url": "https://github.com/apache/jena/pull/705", "merged": true, "mergeCommit": {"oid": "2718a793c485e5d1f83d9174176ea094d96fe6b8"}, "closed": true, "closedAt": "2020-03-11T13:06:28Z", "author": {"login": "afs"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcLCz7rgH2gAyMzg1NjM0ODE0OmJiYTUwYzhmOTEyN2E4OTcxMmE1NjY1NjY2ODA1YmEzZGFlZTA4Yjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMSs9FAFqTM3MTk1NjY3Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bba50c8f9127a89712a5665666805ba3daee08b7", "author": {"user": {"login": "afs", "name": "Andy Seaborne"}}, "url": "https://github.com/apache/jena/commit/bba50c8f9127a89712a5665666805ba3daee08b7", "committedDate": "2020-03-06T16:35:47Z", "message": "Minor fixes and comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9a4909e0fde4c90dc5307063f3632ed05cfda60", "author": {"user": {"login": "afs", "name": "Andy Seaborne"}}, "url": "https://github.com/apache/jena/commit/f9a4909e0fde4c90dc5307063f3632ed05cfda60", "committedDate": "2020-03-09T13:38:34Z", "message": "JENA-1854: Ensure body is read completely when Content-Length is set"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxNDkzMzYx", "url": "https://github.com/apache/jena/pull/705#pullrequestreview-371493361", "createdAt": "2020-03-09T20:10:09Z", "commit": {"oid": "f9a4909e0fde4c90dc5307063f3632ed05cfda60"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQyMDoxMDowOVrOFz3o2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQyMDoxMDowOVrOFz3o2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkzMzI3NQ==", "bodyText": "The buffer here appears to start null/uninitialized. Then on the first call to this method it is created, then populated with whatever we have in the stream. But it's never used again I think.\nCouldn't we define it as a local variable in the skipToEnd method, and just leave it to be collected when the method is done, or = null it?", "url": "https://github.com/apache/jena/pull/705#discussion_r389933275", "createdAt": "2020-03-09T20:10:09Z", "author": {"login": "kinow"}, "path": "jena-base/src/main/java/org/apache/jena/atlas/io/IO.java", "diffHunk": "@@ -437,4 +437,22 @@ public FileVisitResult postVisitDirectory(Path dir, IOException e) throws IOExce\n         }\n         catch (IOException ex) { IO.exception(ex); return; }\n     }\n+\n+    // Do nothing buffer.  Never read from this, it may be corrupt because it is shared.\n+    private static int SKIP_BUFFER_LEN = 64*1024;\n+    private static byte[] SKIP_BUFFER = null;\n+    /** Skip to the end of the InputStream, discarding input. */\n+    public static void skipToEnd(InputStream input) {\n+        if ( SKIP_BUFFER == null )\n+            // No harm in concurrent assignment.\n+            SKIP_BUFFER = new byte[SKIP_BUFFER_LEN];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9a4909e0fde4c90dc5307063f3632ed05cfda60"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxOTU2Njc2", "url": "https://github.com/apache/jena/pull/705#pullrequestreview-371956676", "createdAt": "2020-03-10T13:37:58Z", "commit": {"oid": "f9a4909e0fde4c90dc5307063f3632ed05cfda60"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxMzozNzo1OFrOF0PFYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxMzozNzo1OFrOF0PFYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDMxNzQxMQ==", "bodyText": "I think @afs's goal here is to minimise extra memory usage by having a shared buffer that we can just dump the unread data out into potentially by many threads at once.  We're never going to read the data back out so it doesn't matter if many threads are dumping unusable data into it at once.\nIf you had a local variable then you'd have a buffer by thread and a potential DoS vector because a malicious client could send a load of malformed request bodies in order to get Fuseki to run up its memory usage and OOM.", "url": "https://github.com/apache/jena/pull/705#discussion_r390317411", "createdAt": "2020-03-10T13:37:58Z", "author": {"login": "rvesse"}, "path": "jena-base/src/main/java/org/apache/jena/atlas/io/IO.java", "diffHunk": "@@ -437,4 +437,22 @@ public FileVisitResult postVisitDirectory(Path dir, IOException e) throws IOExce\n         }\n         catch (IOException ex) { IO.exception(ex); return; }\n     }\n+\n+    // Do nothing buffer.  Never read from this, it may be corrupt because it is shared.\n+    private static int SKIP_BUFFER_LEN = 64*1024;\n+    private static byte[] SKIP_BUFFER = null;\n+    /** Skip to the end of the InputStream, discarding input. */\n+    public static void skipToEnd(InputStream input) {\n+        if ( SKIP_BUFFER == null )\n+            // No harm in concurrent assignment.\n+            SKIP_BUFFER = new byte[SKIP_BUFFER_LEN];", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkzMzI3NQ=="}, "originalCommit": {"oid": "f9a4909e0fde4c90dc5307063f3632ed05cfda60"}, "originalPosition": 12}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3000, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}