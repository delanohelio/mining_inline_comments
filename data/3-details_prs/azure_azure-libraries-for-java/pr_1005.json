{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcxMjUwOTYz", "number": 1005, "title": "Migrate Auxiliary Authentication Policy to V2", "bodyText": "Migration from V1 interceptor.\nV1: https://github.com/azure/azure-libraries-for-java/blob/bc5a8263bb43d6f03ef6cc74d99efe8f1c925b29/azure-mgmt-resources/src/main/java/com/microsoft/azure/management/resources/fluentcore/utils/AuxiliaryCredentialsInterceptor.java#L24\nUsed for cross tenant authentication, no test yet. I may test it later and will not merge it until my test succeed.", "createdAt": "2020-02-05T08:50:40Z", "url": "https://github.com/Azure/azure-libraries-for-java/pull/1005", "merged": true, "mergeCommit": {"oid": "ae43384d9b796d0d1e03faa38255990063b7786a"}, "closed": true, "closedAt": "2020-02-17T03:19:09Z", "author": {"login": "ChenTanyi"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBRWZDgH2gAyMzcxMjUwOTYzOmQ0OGNjZTFhMTliNmQ3MTAwZmQ5YmFhOTYzNzIwNzQxN2ZiMTAwMTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcFDzwYgH2gAyMzcxMjUwOTYzOjc0OGFmYzExNWRlZTYyNzZlYzQzYzA3Y2RmY2E4ZDJlNGM5ODc2Mzg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d48cce1a19b6d7100fd9baa9637207417fb10011", "author": {"user": {"login": "ChenTanyi", "name": "Tanyi Chen"}}, "url": "https://github.com/Azure/azure-libraries-for-java/commit/d48cce1a19b6d7100fd9baa9637207417fb10011", "committedDate": "2020-02-05T07:52:51Z", "message": "feat: change TokenCredential to AzureTokenCredential in resetclient"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54248a5288b7c4f8bc38a718a7e6d2fb7f181eee", "author": {"user": {"login": "ChenTanyi", "name": "Tanyi Chen"}}, "url": "https://github.com/Azure/azure-libraries-for-java/commit/54248a5288b7c4f8bc38a718a7e6d2fb7f181eee", "committedDate": "2020-02-05T08:45:06Z", "message": "feat: set token cache into credentials"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77d9b928c671c78cef5c3d73fad5351aa2535a44", "author": {"user": {"login": "ChenTanyi", "name": "Tanyi Chen"}}, "url": "https://github.com/Azure/azure-libraries-for-java/commit/77d9b928c671c78cef5c3d73fad5351aa2535a44", "committedDate": "2020-02-05T08:45:31Z", "message": "feat: add AuxiliaryAuthenticationPolicy"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0MTYxNzc4", "url": "https://github.com/Azure/azure-libraries-for-java/pull/1005#pullrequestreview-354161778", "createdAt": "2020-02-06T02:03:50Z", "commit": {"oid": "77d9b928c671c78cef5c3d73fad5351aa2535a44"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQwMjowMzo1MFrOFmNQHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQwMjowMzo1MFrOFmNQHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTYwNzMyNw==", "bodyText": "Could you do a proper refresh? These code seems not belong here.", "url": "https://github.com/Azure/azure-libraries-for-java/pull/1005#discussion_r375607327", "createdAt": "2020-02-06T02:03:50Z", "author": {"login": "weidongxu-microsoft"}, "path": "azure-mgmt-resources/src/main/java/com/azure/management/AzureTokenCredential.java", "diffHunk": "@@ -43,42 +44,33 @@ public AzureTokenCredential(AzureEnvironment environment, String domain) {\n      * @param request the details of the token request\r\n      * @return a Publisher that emits a single access token\r\n      */\r\n-//    @Override\r\n-//    public final Mono<AccessToken> getToken(TokenRequestContext request) {\r\n-//        String host = request.toString().toLowerCase();\r\n-//        String resource = getEnvironment().getManagementEndpoint();\r\n-//        for (Map.Entry<String, String> endpoint : getEnvironment().endpoints().entrySet()) {\r\n-//            if (host.contains(endpoint.getValue())) {\r\n-//                if (endpoint.getKey().equals(AzureEnvironment.Endpoint.KEYVAULT.identifier())) {\r\n-//                    resource = String.format(\"https://%s/\", endpoint.getValue().replaceAll(\"^\\\\.*\", \"\"));\r\n-//                    break;\r\n-//                } else if (endpoint.getKey().equals(AzureEnvironment.Endpoint.GRAPH.identifier())) {\r\n-//                    resource = getEnvironment().getGraphEndpoint();\r\n-//                    break;\r\n-//                } else if (endpoint.getKey().equals(AzureEnvironment.Endpoint.LOG_ANALYTICS.identifier())) {\r\n-//                    resource = getEnvironment().getLogAnalyticsEndpoint();\r\n-//                    break;\r\n-//                } else if (endpoint.getKey().equals(AzureEnvironment.Endpoint.APPLICATION_INSIGHTS.identifier())) {\r\n-//                    resource = getEnvironment().getApplicationInsightsEndpoint();\r\n-//                    break;\r\n-//                } else if (endpoint.getKey().equals(AzureEnvironment.Endpoint.DATA_LAKE_STORE.identifier())\r\n-//                        || endpoint.getKey().equals(AzureEnvironment.Endpoint.DATA_LAKE_ANALYTICS.identifier())) {\r\n-//                    resource = getEnvironment().getDataLakeEndpointResourceId();\r\n-//                    break;\r\n-//                }\r\n-//            }\r\n-//        }\r\n-//        return getToken(resource);\r\n-//    }\r\n-\r\n-    /**\r\n-     * Override this method to provide the mechanism to get a token.\r\n-     *\r\n-     * @param resource the resource the access token is for\r\n-     * @return the token to access the resource\r\n-     * @throws IOException exceptions from IO\r\n-     */\r\n-//    public abstract Mono<AccessToken> getToken(String resource);\r\n+    public final Mono<AccessToken> getToken(HttpRequest request) {\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "77d9b928c671c78cef5c3d73fad5351aa2535a44"}, "originalPosition": 48}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77e1e4162d8503e6626b62ea5ef8c86a81702299", "author": {"user": {"login": "ChenTanyi", "name": "Tanyi Chen"}}, "url": "https://github.com/Azure/azure-libraries-for-java/commit/77e1e4162d8503e6626b62ea5ef8c86a81702299", "committedDate": "2020-02-07T11:09:29Z", "message": "fix authentication implementation accoding to test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1OTE0OTQz", "url": "https://github.com/Azure/azure-libraries-for-java/pull/1005#pullrequestreview-355914943", "createdAt": "2020-02-10T12:58:26Z", "commit": {"oid": "77e1e4162d8503e6626b62ea5ef8c86a81702299"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMjo1ODoyNlrOFnlGBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMjo1ODoyNlrOFnlGBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA0NjUzNQ==", "bodyText": "After multiple PR updates, It is now a bit messed up on the scope vs. request (host).\nThere is 3 thing happening here:\n(1) If scope is not provided, deduct the scope from host+environment\n(2) Get the token based on scope\n(3) Cache the token\nIf we stick with scope, my suggestion:\n(2) is always done in ApplicationTokenCredential. No problem.\n(1) is moved a lot in various PRs. My suggestion is to put it to a Util class. Input host+environment, output scope. Deterministic, and easy to do unit test. No need to couple this to either TokenCredential or Policy.\nAfter it is decoupled, Policy could then call TokenCredential.getToken with TokenRequestContext (use the Util above to get the scope if not provided).\n(3) seems better to be in subclass of TokenCredential, since AuxiliaryAuthenticationPolicy would also use that cache.\n@yaohaizh Let us know your opinion.", "url": "https://github.com/Azure/azure-libraries-for-java/pull/1005#discussion_r377046535", "createdAt": "2020-02-10T12:58:26Z", "author": {"login": "weidongxu-microsoft"}, "path": "azure-mgmt-resources/src/main/java/com/azure/management/BearerTokenAuthenticationPolicy.java", "diffHunk": "@@ -76,21 +35,11 @@ private String getDefaultScopeFromRequest(HttpRequest request) {\n             return Mono.error(new RuntimeException(\"token credentials require a URL using the HTTPS protocol scheme\"));\n         }\n \n-        String[] scopes;\n-        if (this.scopes == null || this.scopes.length == 0) {\n-            scopes = new String[] {getDefaultScopeFromRequest(context.getHttpRequest())};\n-        } else {\n-            scopes = this.scopes;\n-        }\n-        assert scopes.length > 0;\n-\n         Mono<AccessToken> tokenResult;\n-        AccessToken token = tokenCache.get(scopes[0]);\n-        if (token == null || token.isExpired()) {\n-            tokenResult = this.credential.getToken(new TokenRequestContext().addScopes(scopes))\n-                            .doOnNext(accessToken -> this.tokenCache.put(scopes[0], accessToken));\n+        if (this.scopes == null || this.scopes.length == 0) {\n+            tokenResult = this.credential.getToken(context.getHttpRequest());\n         } else {\n-            tokenResult = Mono.just(token);\n+            tokenResult = this.credential.getToken(new TokenRequestContext().addScopes(scopes));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "77e1e4162d8503e6626b62ea5ef8c86a81702299"}, "originalPosition": 92}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3MzE3NTY3", "url": "https://github.com/Azure/azure-libraries-for-java/pull/1005#pullrequestreview-357317567", "createdAt": "2020-02-12T09:54:51Z", "commit": {"oid": "77e1e4162d8503e6626b62ea5ef8c86a81702299"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8ba2dbc39390a6a30ec2b7ba1049803cb165ee9", "author": {"user": {"login": "ChenTanyi", "name": "Tanyi Chen"}}, "url": "https://github.com/Azure/azure-libraries-for-java/commit/c8ba2dbc39390a6a30ec2b7ba1049803cb165ee9", "committedDate": "2020-02-12T14:06:13Z", "message": "fix: move get default scope function to a utils"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3OTIzMjA4", "url": "https://github.com/Azure/azure-libraries-for-java/pull/1005#pullrequestreview-357923208", "createdAt": "2020-02-13T02:44:07Z", "commit": {"oid": "c8ba2dbc39390a6a30ec2b7ba1049803cb165ee9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a66a4d1379c2603570fd6fbc4c2589825fbe5bb8", "author": {"user": {"login": "ChenTanyi", "name": "Tanyi Chen"}}, "url": "https://github.com/Azure/azure-libraries-for-java/commit/a66a4d1379c2603570fd6fbc4c2589825fbe5bb8", "committedDate": "2020-02-13T03:51:07Z", "message": "feat: split token cache to external"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49d882d5dde6d38fd5e6c965f9ae737ed54de791", "author": {"user": {"login": "ChenTanyi", "name": "Tanyi Chen"}}, "url": "https://github.com/Azure/azure-libraries-for-java/commit/49d882d5dde6d38fd5e6c965f9ae737ed54de791", "committedDate": "2020-02-13T03:51:14Z", "message": "Revert \"feat: change TokenCredential to AzureTokenCredential in resetclient\"\n\nThis reverts commit d48cce1a19b6d7100fd9baa9637207417fb10011."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3OTY4Mjkx", "url": "https://github.com/Azure/azure-libraries-for-java/pull/1005#pullrequestreview-357968291", "createdAt": "2020-02-13T05:51:06Z", "commit": {"oid": "49d882d5dde6d38fd5e6c965f9ae737ed54de791"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwNTo1MTowNlrOFpHvnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwNTo1MTowNlrOFpHvnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODY2MjgxNQ==", "bodyText": "What's this token cache different with the one in the azure identity?", "url": "https://github.com/Azure/azure-libraries-for-java/pull/1005#discussion_r378662815", "createdAt": "2020-02-13T05:51:06Z", "author": {"login": "yaohaizh"}, "path": "azure-mgmt-resources/src/main/java/com/azure/management/resources/fluentcore/utils/AuxiliaryAuthenticationPolicy.java", "diffHunk": "@@ -0,0 +1,90 @@\n+/**", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49d882d5dde6d38fd5e6c965f9ae737ed54de791"}, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93a7ba6484158e35eb4712e954dc6a5e3dd72e55", "author": {"user": {"login": "ChenTanyi", "name": "Tanyi Chen"}}, "url": "https://github.com/Azure/azure-libraries-for-java/commit/93a7ba6484158e35eb4712e954dc6a5e3dd72e55", "committedDate": "2020-02-17T01:54:20Z", "message": "fix: remove token cache and use simple token cache in azure core"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f30767dc67d6ec86fe27b74bbef18c1fc021ee34", "author": {"user": {"login": "ChenTanyi", "name": "Tanyi Chen"}}, "url": "https://github.com/Azure/azure-libraries-for-java/commit/f30767dc67d6ec86fe27b74bbef18c1fc021ee34", "committedDate": "2020-02-17T02:13:38Z", "message": "feat: add utils test and fix error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "748afc115dee6276ec43c07cdfca8d2e4c987638", "author": {"user": {"login": "ChenTanyi", "name": "Tanyi Chen"}}, "url": "https://github.com/Azure/azure-libraries-for-java/commit/748afc115dee6276ec43c07cdfca8d2e4c987638", "committedDate": "2020-02-17T02:21:57Z", "message": "Merge branch 'vnext' into vnext-auxiAuth"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1478, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}