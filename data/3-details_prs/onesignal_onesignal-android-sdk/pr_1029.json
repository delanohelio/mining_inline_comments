{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIxNjIxNDk5", "number": 1029, "title": "Add Huawei Location support", "bodyText": "This change is\u2002", "createdAt": "2020-05-21T22:34:04Z", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1029", "merged": true, "mergeCommit": {"oid": "32cd7a3ecba827977b5841f8692a5caf4d41c916"}, "closed": true, "closedAt": "2020-06-10T04:24:46Z", "author": {"login": "Jeasmine"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABclGkTnABqjMzNzQxNjQ4MzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcpwXW6AH2gAyNDIxNjIxNDk5OjM4MmVjODFhMzFkNTdlYzVkY2Q2MTZhY2VhODQ2OWY5NTAwOTViOTY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0c0dd1262fe4e8832908dda8d7805807daf1291f", "author": {"user": {"login": "Jeasmine", "name": "JNahui"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/0c0dd1262fe4e8832908dda8d7805807daf1291f", "committedDate": "2020-05-23T01:13:43Z", "message": "Add Huawei Location UnitTest"}, "afterCommit": {"oid": "a4504b29fb204f19111406161df3117aabf46f3d", "author": {"user": {"login": "Jeasmine", "name": "JNahui"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/a4504b29fb204f19111406161df3117aabf46f3d", "committedDate": "2020-05-26T15:40:00Z", "message": "Add Huawei Location UnitTest"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5NjcxODYx", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1029#pullrequestreview-419671861", "createdAt": "2020-05-27T23:11:41Z", "commit": {"oid": "a4504b29fb204f19111406161df3117aabf46f3d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QyMzoxMTo0MVrOGbgSgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QyMzoyMzowM1rOGbgg7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ5Mzc2Mw==", "bodyText": "agconnect only needs to be applied at the app level, not our SDK.", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1029#discussion_r431493763", "createdAt": "2020-05-27T23:11:41Z", "author": {"login": "jkasten2"}, "path": "OneSignalSDK/onesignal/build.gradle", "diffHunk": "@@ -1,4 +1,5 @@\n apply plugin: 'com.android.library'\n+apply plugin: 'com.huawei.agconnect'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4504b29fb204f19111406161df3117aabf46f3d"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ5NDIwNw==", "bodyText": "These should be compileOnly so they are not included in our POM file as required dependencies.", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1029#discussion_r431494207", "createdAt": "2020-05-27T23:12:52Z", "author": {"login": "jkasten2"}, "path": "OneSignalSDK/onesignal/build.gradle", "diffHunk": "@@ -56,6 +57,10 @@ dependencies {\n     // firebase-messaging:17.6.0 is the max version since we still have code looking for FirebaseInstanceIdService\n     api 'com.google.firebase:firebase-messaging:[10.2.1, 17.3.99]'\n \n+    implementation 'com.huawei.agconnect:agconnect-core:1.3.1.300'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4504b29fb204f19111406161df3117aabf46f3d"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ5NTg3Ng==", "bodyText": "We will want to change this to the same logic we are using the getDeviceType once PR #1026 is merged in.", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1029#discussion_r431495876", "createdAt": "2020-05-27T23:18:07Z", "author": {"login": "jkasten2"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/LocationController.java", "diffHunk": "@@ -248,40 +273,100 @@ else if (permissionList.contains(\"android.permission.ACCESS_COARSE_LOCATION\")) {\n \n    // Started from this class or PermissionActivity\n    static void startGetLocation() {\n-      // Prevents overlapping requests\n-      if (fallbackFailThread != null)\n-         return;\n+      OneSignal.Log(OneSignal.LOG_LEVEL.DEBUG, \"LocationController startGetLocation with lastLocation: \" + lastLocation);\n+\n+      if (locationHandlerThread == null)\n+         locationHandlerThread = new LocationHandlerThread();\n \n       try {\n-         synchronized (syncLock) {\n-            startFallBackThread();\n-\n-            if (locationHandlerThread == null)\n-               locationHandlerThread = new LocationHandlerThread();\n-\n-            if (mGoogleApiClient == null || mLastLocation == null) {\n-               GoogleApiClientListener googleApiClientListener = new GoogleApiClientListener();\n-               GoogleApiClient googleApiClient = new GoogleApiClient.Builder(classContext)\n-                       .addApi(LocationServices.API)\n-                       .addConnectionCallbacks(googleApiClientListener)\n-                       .addOnConnectionFailedListener(googleApiClientListener)\n-                       .setHandler(locationHandlerThread.mHandler)\n-                       .build();\n-               mGoogleApiClient = new GoogleApiClientCompatProxy(googleApiClient);\n-\n-               mGoogleApiClient.connect();\n-            }\n-            else if (mLastLocation != null)\n-               fireCompleteForLocation(mLastLocation);\n+         if (isGooglePlayServicesAvailable(classContext)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4504b29fb204f19111406161df3117aabf46f3d"}, "originalPosition": 156}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ5NzQ1NA==", "bodyText": "Let's put HMS in the class name so it is clear it is only for it", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1029#discussion_r431497454", "createdAt": "2020-05-27T23:23:03Z", "author": {"login": "jkasten2"}, "path": "OneSignalSDK/unittest/src/test/java/com/onesignal/ShadowFusedLocationProviderClient.java", "diffHunk": "@@ -0,0 +1,112 @@\n+/**\n+ * Modified MIT License\n+ * <p>\n+ * Copyright 2020 OneSignal\n+ * <p>\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ * <p>\n+ * 1. The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ * <p>\n+ * 2. All copies of substantial portions of the Software may only be used in connection\n+ * with services provided by OneSignal.\n+ * <p>\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+\n+package com.onesignal;\n+\n+import android.content.Context;\n+import android.location.Location;\n+import android.os.Handler;\n+import android.os.Looper;\n+\n+import com.huawei.hmf.tasks.Task;\n+import com.huawei.hmf.tasks.a.i;\n+import com.huawei.hms.location.FusedLocationProviderClient;\n+import com.huawei.hms.location.LocationCallback;\n+import com.huawei.hms.location.LocationRequest;\n+\n+import org.robolectric.annotation.Implementation;\n+import org.robolectric.annotation.Implements;\n+\n+import java.util.Timer;\n+import java.util.TimerTask;\n+\n+@Implements(FusedLocationProviderClient.class)\n+public class ShadowFusedLocationProviderClient {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4504b29fb204f19111406161df3117aabf46f3d"}, "originalPosition": 48}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2d2ecafea44552bbed1476655184d47cdbbf97bc", "author": {"user": {"login": "jkasten2", "name": "Josh Kasten"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/2d2ecafea44552bbed1476655184d47cdbbf97bc", "committedDate": "2020-06-04T22:58:10Z", "message": "Upgraded to HMS location version 4 from 3\n\n* Also updated unit test for Location class name change"}, "afterCommit": {"oid": "fd8df18208886be760eaafcb04275aaf6a299dd0", "author": {"user": {"login": "jkasten2", "name": "Josh Kasten"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/fd8df18208886be760eaafcb04275aaf6a299dd0", "committedDate": "2020-06-05T05:18:59Z", "message": "Upgraded to HMS location version 4 from 3\n\n* Also updated unit test for Location class name change"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fd8df18208886be760eaafcb04275aaf6a299dd0", "author": {"user": {"login": "jkasten2", "name": "Josh Kasten"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/fd8df18208886be760eaafcb04275aaf6a299dd0", "committedDate": "2020-06-05T05:18:59Z", "message": "Upgraded to HMS location version 4 from 3\n\n* Also updated unit test for Location class name change"}, "afterCommit": {"oid": "eda5af68cb4099505160f9a267eaffb8c14c3057", "author": {"user": {"login": "jkasten2", "name": "Josh Kasten"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/eda5af68cb4099505160f9a267eaffb8c14c3057", "committedDate": "2020-06-05T06:33:52Z", "message": "Upgraded to HMS location version 4 from 3\n\n* Also updated unit test for Location class name change"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eda5af68cb4099505160f9a267eaffb8c14c3057", "author": {"user": {"login": "jkasten2", "name": "Josh Kasten"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/eda5af68cb4099505160f9a267eaffb8c14c3057", "committedDate": "2020-06-05T06:33:52Z", "message": "Upgraded to HMS location version 4 from 3\n\n* Also updated unit test for Location class name change"}, "afterCommit": {"oid": "40e3275222eb6b8f44e5553beba255175dfa3a79", "author": {"user": {"login": "jkasten2", "name": "Josh Kasten"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/40e3275222eb6b8f44e5553beba255175dfa3a79", "committedDate": "2020-06-05T07:06:04Z", "message": "Upgraded to HMS location version 4 from 3\n\n* Also updated unit test for Location class name change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af7dd2cb62ee1517cf96acbd567f5824ee411b83", "author": {"user": {"login": "jkasten2", "name": "Josh Kasten"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/af7dd2cb62ee1517cf96acbd567f5824ee411b83", "committedDate": "2020-06-10T02:15:20Z", "message": "Test for HMS notification open REST API call"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd6bd548e85459573db427070d92bc410a3d8550", "author": {"user": {"login": "jkasten2", "name": "Josh Kasten"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/dd6bd548e85459573db427070d92bc410a3d8550", "committedDate": "2020-06-10T02:15:20Z", "message": "Correct NotificationOpenedActivityHMS intent flags\n\n* Removed used of deperated flag\n* Added more comments on why the specific flags are needed."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f07b128dd0442dbfd5cd65c7758f997c7cd14a7", "author": {"user": {"login": "Jeasmine", "name": "JNahui"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/7f07b128dd0442dbfd5cd65c7758f997c7cd14a7", "committedDate": "2020-06-10T02:15:20Z", "message": "Add Huawei Location support"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7effb1e44d90b9de00d5cd5e68fe33dac3badca0", "author": {"user": {"login": "Jeasmine", "name": "JNahui"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/7effb1e44d90b9de00d5cd5e68fe33dac3badca0", "committedDate": "2020-06-10T02:15:20Z", "message": "Add Huawei Location UnitTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4085ee17bb9b0b66c954f47858ee6cc03063e9d", "author": {"user": {"login": "jkasten2", "name": "Josh Kasten"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/b4085ee17bb9b0b66c954f47858ee6cc03063e9d", "committedDate": "2020-06-10T02:15:20Z", "message": "HMS location fix ups\n\n* Changed gradle to compileOnly so it isn't a direct dependecy\n* Renamed ShadowFusedLocationProviderClient -> ShadowHMSFusedLocationProviderClient\n   - Naming more clear this is only for HMS\n* Removed hms gradle plugin from onesignal SDK target\n   - It only applies to app targets"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1310599ebbecc623818bed40240e1a2062816436", "author": {"user": {"login": "jkasten2", "name": "Josh Kasten"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/1310599ebbecc623818bed40240e1a2062816436", "committedDate": "2020-06-10T02:15:20Z", "message": "Upgraded to HMS location version 4 from 3\n\n* Also updated unit test for Location class name change"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b15e5bea10214d17b3a4411af4b299688e98c9ae", "author": {"user": {"login": "jkasten2", "name": "Josh Kasten"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/b15e5bea10214d17b3a4411af4b299688e98c9ae", "committedDate": "2020-06-10T02:06:07Z", "message": "Added missing huaweiFusedLocationClient null check\n\n* Also cleaned up ShadowLocationController mocking\n   - This is driven by OSUtil now\n* Fixed shouldRegisterWhenPromptingAfterInit_Huawei\n   - It was using FCM instead of HMS for the push part of the test."}, "afterCommit": {"oid": "1310599ebbecc623818bed40240e1a2062816436", "author": {"user": {"login": "jkasten2", "name": "Josh Kasten"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/1310599ebbecc623818bed40240e1a2062816436", "committedDate": "2020-06-10T02:15:20Z", "message": "Upgraded to HMS location version 4 from 3\n\n* Also updated unit test for Location class name change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37dcd0e6c5e5ffb857f2414fd5f090fa39daa504", "author": {"user": {"login": "jkasten2", "name": "Josh Kasten"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/37dcd0e6c5e5ffb857f2414fd5f090fa39daa504", "committedDate": "2020-06-10T02:37:56Z", "message": "Changed location platform detection to device_type\n\n* This prevents code duplicating and a consistently on provider\n    - If we use Google for push we should use google for location\n    - If we use HMS for push we should use HMS for location."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6feac1f81ef340ba40a53c42a84f53f8c40dce32", "author": {"user": {"login": "jkasten2", "name": "Josh Kasten"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/6feac1f81ef340ba40a53c42a84f53f8c40dce32", "committedDate": "2020-06-10T02:37:56Z", "message": "Removed hms:base and agconnect-core\n\n* These are already part of hms:lcation and hms:push\n   - The specifc version is mis-matched with agconnect-core causing internal NPE errors\n   - This fixes the test failing as well."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "382ec81a31d57ec5dcd616acea8469f950095b96", "author": {"user": {"login": "jkasten2", "name": "Josh Kasten"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/382ec81a31d57ec5dcd616acea8469f950095b96", "committedDate": "2020-06-10T02:37:56Z", "message": "Added missing huaweiFusedLocationClient null check\n\n* Also cleaned up ShadowLocationController mocking\n   - This is driven by OSUtil now\n* Fixed shouldRegisterWhenPromptingAfterInit_Huawei\n   - It was using FCM instead of HMS for the push part of the test."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3575, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}