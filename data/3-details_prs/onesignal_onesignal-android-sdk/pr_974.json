{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxNzY5MDEz", "number": 974, "title": "Add new features to IAM preview ", "bodyText": "Add prompt to IAM preview\nAdd logs for tags and outcomes\nRedisplay, tags, outcomes, impression should not be included on IAM preview\n\n\n\nThis change is\u2002", "createdAt": "2020-03-20T22:42:23Z", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/974", "merged": true, "mergeCommit": {"oid": "c26a2643a9b96449aef12edeada31ceeddac4769"}, "closed": true, "closedAt": "2020-03-23T20:20:44Z", "author": {"login": "Jeasmine"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcPoeIyABqjMxNTExMjA5MzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcQkKKOgFqTM3OTc4ODk3NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f1d2d25a32f1f4bbb1e33df0306dbc147dd7ac20", "author": {"user": {"login": "Jeasmine", "name": "JNahui"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/f1d2d25a32f1f4bbb1e33df0306dbc147dd7ac20", "committedDate": "2020-03-20T22:41:24Z", "message": "Exclude features from IAM preview\n\n   * Redisplay, tags, outcomes, impression should not be included on IAM preview"}, "afterCommit": {"oid": "91b556e07c6555391402b110033a70f7b7b69459", "author": {"user": {"login": "Jeasmine", "name": "JNahui"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/91b556e07c6555391402b110033a70f7b7b69459", "committedDate": "2020-03-20T22:43:01Z", "message": "Add new features to IAM preview\n\n   * Add prompt to IAM preview\n   * Add logs for tags and outcomes\n   * Redisplay, tags, outcomes, impression should not be included on IAM preview"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5MDM0MTM4", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/974#pullrequestreview-379034138", "createdAt": "2020-03-22T18:31:00Z", "commit": {"oid": "91b556e07c6555391402b110033a70f7b7b69459"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMlQxODozMTowMVrOF5xnMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMlQxODo0NDo0MlrOF5xsAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjEyNjAwMQ==", "bodyText": "Don't make it specific to tags and outcomes we might have more things added here eventually\nChange name from fireTagsAndOutcomeLogs to\nlogInAppMessagePreviewActions or\nlogIamPreviewActions?", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/974#discussion_r396126001", "createdAt": "2020-03-22T18:31:01Z", "author": {"login": "mikechoch"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -284,19 +285,57 @@ void onMessageActionOccurredOnPreview(@NonNull final OSInAppMessage message, @No\n         action.firstClick = message.takeActionAsUnique();\n \n         firePublicClickHandler(action);\n+        showPrompts(message, action.prompts);\n         fireClickAction(action);\n+        fireTagsAndOutcomeLogs(action);\n     }\n \n-    private void firePrompt(OSInAppMessage message, final List<OSInAppMessagePrompt> prompts) {\n-        for (OSInAppMessagePrompt prompt : prompts) {\n+    private void fireTagsAndOutcomeLogs(final OSInAppMessageAction action) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91b556e07c6555391402b110033a70f7b7b69459"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjEyNjY4MA==", "bodyText": "way too much extra code here, tags and outcomes are JSONObjects so just call tags.toString() and print that\nwith a single log about the tags\nSame exact thing for outcomes, outcomes.toString() with a log\nex.\nprivate void fireTagsAndOutcomeLogs(final OSInAppMessageAction action) {\n@mikechoch\nmikechoch Member Pending\nDon't make it specific to tags and outcomes we might have more things added here eventually\nChange name from fireTagsAndOutcomeLogs to\nlogInAppMessagePreviewActions or\nlogIamPreviewActions?\nprivate void logInAppMessagePreviewActions(final OSInAppMessageAction action) {\n    JSONObject tags = action.tags;\n    if (tags != null)\n        OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, \"Tags detected inside of the action click payload, ignoring because action came from IAM preview: \" + tags.toString());\n   \n    JSONObject outcomes = action.outcomes;\n    if (outcomes != null)\n        OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, \"Outcomes detected inside of the action click payload, ignoring because action came from IAM preview: \" + outcomes.toString());\n\n    // TODO: Add more action payload preview logs here in future\n}", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/974#discussion_r396126680", "createdAt": "2020-03-22T18:38:26Z", "author": {"login": "mikechoch"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -284,19 +285,57 @@ void onMessageActionOccurredOnPreview(@NonNull final OSInAppMessage message, @No\n         action.firstClick = message.takeActionAsUnique();\n \n         firePublicClickHandler(action);\n+        showPrompts(message, action.prompts);\n         fireClickAction(action);\n+        fireTagsAndOutcomeLogs(action);\n     }\n \n-    private void firePrompt(OSInAppMessage message, final List<OSInAppMessagePrompt> prompts) {\n-        for (OSInAppMessagePrompt prompt : prompts) {\n+    private void fireTagsAndOutcomeLogs(final OSInAppMessageAction action) {\n+        if (action.tags != null) {\n+            OSInAppMessageTag tags = action.tags;\n+            if (tags.getTagsToAdd() != null)\n+                OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, \"Tags to add detected inside of the action click payload, ignoring because action came from IAM preview:: \" + tags.getTagsToAdd());\n+            if (tags.getTagsToRemove() != null)\n+                OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, \"Tags to remove detected inside of the action click payload, ignoring because action came from IAM preview: \" + tags.getTagsToRemove());\n+        }\n+\n+        for (OSInAppMessageOutcome outcome : action.outcomes) {\n+            OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, \"Outcome detected inside of the action click payload, ignoring because action came from IAM preview: \" + outcome.toString());\n+        }\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91b556e07c6555391402b110033a70f7b7b69459"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjEyNzIzMw==", "bodyText": "rename to beginProcessingPrompts that way the next calls make more sense.", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/974#discussion_r396127233", "createdAt": "2020-03-22T18:44:41Z", "author": {"login": "mikechoch"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -284,19 +285,57 @@ void onMessageActionOccurredOnPreview(@NonNull final OSInAppMessage message, @No\n         action.firstClick = message.takeActionAsUnique();\n \n         firePublicClickHandler(action);\n+        showPrompts(message, action.prompts);\n         fireClickAction(action);\n+        fireTagsAndOutcomeLogs(action);\n     }\n \n-    private void firePrompt(OSInAppMessage message, final List<OSInAppMessagePrompt> prompts) {\n-        for (OSInAppMessagePrompt prompt : prompts) {\n+    private void fireTagsAndOutcomeLogs(final OSInAppMessageAction action) {\n+        if (action.tags != null) {\n+            OSInAppMessageTag tags = action.tags;\n+            if (tags.getTagsToAdd() != null)\n+                OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, \"Tags to add detected inside of the action click payload, ignoring because action came from IAM preview:: \" + tags.getTagsToAdd());\n+            if (tags.getTagsToRemove() != null)\n+                OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, \"Tags to remove detected inside of the action click payload, ignoring because action came from IAM preview: \" + tags.getTagsToRemove());\n+        }\n+\n+        for (OSInAppMessageOutcome outcome : action.outcomes) {\n+            OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, \"Outcome detected inside of the action click payload, ignoring because action came from IAM preview: \" + outcome.toString());\n+        }\n+    }\n+\n+    private void showPrompts(OSInAppMessage message, final List<OSInAppMessagePrompt> prompts) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91b556e07c6555391402b110033a70f7b7b69459"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjEyNzIzNQ==", "bodyText": "Rename to showMultiplePrompts", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/974#discussion_r396127235", "createdAt": "2020-03-22T18:44:42Z", "author": {"login": "mikechoch"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -284,19 +285,57 @@ void onMessageActionOccurredOnPreview(@NonNull final OSInAppMessage message, @No\n         action.firstClick = message.takeActionAsUnique();\n \n         firePublicClickHandler(action);\n+        showPrompts(message, action.prompts);\n         fireClickAction(action);\n+        fireTagsAndOutcomeLogs(action);\n     }\n \n-    private void firePrompt(OSInAppMessage message, final List<OSInAppMessagePrompt> prompts) {\n-        for (OSInAppMessagePrompt prompt : prompts) {\n+    private void fireTagsAndOutcomeLogs(final OSInAppMessageAction action) {\n+        if (action.tags != null) {\n+            OSInAppMessageTag tags = action.tags;\n+            if (tags.getTagsToAdd() != null)\n+                OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, \"Tags to add detected inside of the action click payload, ignoring because action came from IAM preview:: \" + tags.getTagsToAdd());\n+            if (tags.getTagsToRemove() != null)\n+                OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, \"Tags to remove detected inside of the action click payload, ignoring because action came from IAM preview: \" + tags.getTagsToRemove());\n+        }\n+\n+        for (OSInAppMessageOutcome outcome : action.outcomes) {\n+            OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, \"Outcome detected inside of the action click payload, ignoring because action came from IAM preview: \" + outcome.toString());\n+        }\n+    }\n+\n+    private void showPrompts(OSInAppMessage message, final List<OSInAppMessagePrompt> prompts) {\n+        if (prompts.size() > 0) {\n+            OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, \"IAM showing prompts from IAM: \" + message.toString());\n             // TODO until we don't fix the activity going forward or back dismissing the IAM, we need to auto dismiss\n-            messageWasDismissed(message);\n-            prompt.handlePrompt(new OneSignal.OperationCompletedCallback() {\n+            WebViewManager.dismissCurrentIAM();\n+            handleMultiplePrompts(message, prompts);\n+        }\n+    }\n+\n+    private void handleMultiplePrompts(final OSInAppMessage message, final List<OSInAppMessagePrompt> prompts) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91b556e07c6555391402b110033a70f7b7b69459"}, "originalPosition": 53}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d451efd6cb66bf95e33d1bca754987dae13b062", "author": {"user": {"login": "Jeasmine", "name": "JNahui"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/0d451efd6cb66bf95e33d1bca754987dae13b062", "committedDate": "2020-03-23T19:35:40Z", "message": "Add new features to IAM preview\n\n   * Add prompt to IAM preview\n   * Add logs for tags and outcomes\n   * Redisplay, tags, outcomes, impression should not be included on IAM preview"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "91b556e07c6555391402b110033a70f7b7b69459", "author": {"user": {"login": "Jeasmine", "name": "JNahui"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/91b556e07c6555391402b110033a70f7b7b69459", "committedDate": "2020-03-20T22:43:01Z", "message": "Add new features to IAM preview\n\n   * Add prompt to IAM preview\n   * Add logs for tags and outcomes\n   * Redisplay, tags, outcomes, impression should not be included on IAM preview"}, "afterCommit": {"oid": "0d451efd6cb66bf95e33d1bca754987dae13b062", "author": {"user": {"login": "Jeasmine", "name": "JNahui"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/0d451efd6cb66bf95e33d1bca754987dae13b062", "committedDate": "2020-03-23T19:35:40Z", "message": "Add new features to IAM preview\n\n   * Add prompt to IAM preview\n   * Add logs for tags and outcomes\n   * Redisplay, tags, outcomes, impression should not be included on IAM preview"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5Nzg2ODQ4", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/974#pullrequestreview-379786848", "createdAt": "2020-03-23T20:13:18Z", "commit": {"oid": "0d451efd6cb66bf95e33d1bca754987dae13b062"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5Nzg4OTc1", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/974#pullrequestreview-379788975", "createdAt": "2020-03-23T20:16:33Z", "commit": {"oid": "0d451efd6cb66bf95e33d1bca754987dae13b062"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3534, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}