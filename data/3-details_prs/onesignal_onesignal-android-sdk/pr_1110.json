{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY1NTM2ODgy", "number": 1110, "title": "Added runtime check before showing a notification", "bodyText": "Notification should never be processed for display from the Main Thread\n\nThis can cause an ANR if work is taking too long before showing the notification\n\n\nCreated a OSThrowable class with a OSMainThreadException\nFixed UnitTests thinking they were on the Main Thread\n\nAdded a shadow in ShadowOSUtils for isRunningOnMainThread method\n\n\n\n\n\nThis change is\u2002", "createdAt": "2020-08-10T14:28:56Z", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1110", "merged": true, "mergeCommit": {"oid": "96579ed0ea77b8a212bf2435237156cb371ab930"}, "closed": true, "closedAt": "2020-08-20T20:47:20Z", "author": {"login": "mikechoch"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc9jFhJAH2gAyNDY1NTM2ODgyOjVjZjcyNWYyNDA2MWUwYzM2ZDY4MjRmYzA2NDM5YjUwZDEyMWU0OGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdA2ZAEgFqTQ3MTk2ODk3Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5cf725f24061e0c36d6824fc06439b50d121e48d", "author": {"user": {"login": "mikechoch", "name": "Michael DiCioccio"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/5cf725f24061e0c36d6824fc06439b50d121e48d", "committedDate": "2020-08-10T14:28:10Z", "message": "Added runtime check before showing a notification\n* Notification should never be processed for display from the Main Thread\n  * This can cause an `ANR` if work is taking too long before showing the notification\n* Created a `OSThrowable` class with a `OSMainThreadException`\n* Fixed `UnitTests` thinking they were on the Main Thread\n  * Added a shadow in `ShadowOSUtils` for `isRunningOnMainThread` method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0MzY2OTY4", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1110#pullrequestreview-464366968", "createdAt": "2020-08-10T16:01:14Z", "commit": {"oid": "5cf725f24061e0c36d6824fc06439b50d121e48d"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNjowMToxNFrOG-VPwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNjowNTozN1rOG-VaCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODAxMjk5NA==", "bodyText": "any reason for having this \"container\" class?", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1110#discussion_r468012994", "createdAt": "2020-08-10T16:01:14Z", "author": {"login": "Jeasmine"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSThrowable.java", "diffHunk": "@@ -0,0 +1,37 @@\n+/**\n+ * Modified MIT License\n+ *\n+ * Copyright 2020 OneSignal\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * 1. The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * 2. All copies of substantial portions of the Software may only be used in connection\n+ * with services provided by OneSignal.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+\n+package com.onesignal;\n+\n+class OSThrowable {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cf725f24061e0c36d6824fc06439b50d121e48d"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODAxNTYyNA==", "bodyText": "do we need this to be shadowed? shoudn't the test fail if it is running on the main thread? in that way we can fix it", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1110#discussion_r468015624", "createdAt": "2020-08-10T16:05:37Z", "author": {"login": "Jeasmine"}, "path": "OneSignalSDK/unittest/src/test/java/com/onesignal/ShadowOSUtils.java", "diffHunk": "@@ -7,9 +7,15 @@\n @Implements(OSUtils.class)\n public class ShadowOSUtils {\n \n+   public static boolean isRunningOnMainThread;\n+\n    public static String carrierName;\n    public static int subscribableStatus;\n \n+   public static boolean isRunningOnMainThread() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cf725f24061e0c36d6824fc06439b50d121e48d"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0NDk0MjM1", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1110#pullrequestreview-464494235", "createdAt": "2020-08-10T19:01:02Z", "commit": {"oid": "5cf725f24061e0c36d6824fc06439b50d121e48d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxOTowMTowMlrOG-bbRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxOToxNjozNFrOG-b6vg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODExNDI0NQ==", "bodyText": "We would like to have new isRunningOnMainThread check fail in tests when it should, so we know if something broke when travisCI runs.\nAlso this line is dangerous as it will hide other future checks we add to other things.", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1110#discussion_r468114245", "createdAt": "2020-08-10T19:01:02Z", "author": {"login": "jkasten2"}, "path": "OneSignalSDK/unittest/src/test/java/com/onesignal/ShadowOSUtils.java", "diffHunk": "@@ -72,14 +78,14 @@ public static void resetStatics() {\n       carrierName = \"test1\";\n       subscribableStatus = 1;\n \n+      isRunningOnMainThread = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cf725f24061e0c36d6824fc06439b50d121e48d"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODEyMjMwMg==", "bodyText": "Which tests fail if we don't have this line?", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1110#discussion_r468122302", "createdAt": "2020-08-10T19:16:34Z", "author": {"login": "jkasten2"}, "path": "OneSignalSDK/unittest/src/test/java/com/onesignal/ShadowOSUtils.java", "diffHunk": "@@ -72,14 +78,14 @@ public static void resetStatics() {\n       carrierName = \"test1\";\n       subscribableStatus = 1;\n \n+      isRunningOnMainThread = false;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODExNDI0NQ=="}, "originalCommit": {"oid": "5cf725f24061e0c36d6824fc06439b50d121e48d"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f46823553233e9bc70354bcc17910f30d95e827a", "author": {"user": {"login": "mikechoch", "name": "Michael DiCioccio"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/f46823553233e9bc70354bcc17910f30d95e827a", "committedDate": "2020-08-11T17:06:18Z", "message": "Adding the main thread check surfaced a bug\n* Broken logic when processing a duplicate notification\n* This is fixed now and also fixes UnitTests failing from this modified logic\n  * This was change in this PR #1010\n  * Added back the correct logic now and UnitTests pass"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4296b03516f6229da6821d4108d7f7fb9d0d44d3", "author": {"user": {"login": "mikechoch", "name": "Michael DiCioccio"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/4296b03516f6229da6821d4108d7f7fb9d0d44d3", "committedDate": "2020-08-11T19:54:00Z", "message": "Replaced `processJobForDisplay` call with Worker kickoff now\n* Found another spot where we may not be trying to kick off the Worker and hence would lead to showing the notification from the MainThread\n* Also removed the `isRunningOnMainThread` method inside of the `ShadowOSUtils` class"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxMDEyMDcz", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1110#pullrequestreview-471012073", "createdAt": "2020-08-19T22:38:54Z", "commit": {"oid": "cc60a5b419a583ac24fa1b60e5cdedd4878d6eb3"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cc60a5b419a583ac24fa1b60e5cdedd4878d6eb3", "author": {"user": {"login": "mikechoch", "name": "Michael DiCioccio"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/cc60a5b419a583ac24fa1b60e5cdedd4878d6eb3", "committedDate": "2020-08-13T14:27:41Z", "message": "Wrapped receive notification based helpers with new Thread\n* This solves issues with our MainThread runtime check before showing a notification\n  * For some reason the background thread running from our Worker job says MainThread during UnitTests\n  * Added `Looper.prepare`, `Looper.loop`, and `Looper.quit` calls for handling the postDelayed runnables\n* WIP -  Trying to fix some broken UnitTests related to NotificationProcessingHandler and NotificationWillShowInForegroundHandler\n  * The handlers have complete methods built in and the postDelayed runnables are not firing in the UnitTests for some reason"}, "afterCommit": {"oid": "36d9dfac1682701bc1c0943231ff06b27a2fb570", "author": {"user": {"login": "Jeasmine", "name": "JNahui"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/36d9dfac1682701bc1c0943231ff06b27a2fb570", "committedDate": "2020-08-20T16:51:49Z", "message": "Fix Test due to Roboelectric custom Main Thread Looper shadowing\n\n  * Added `Looper.prepare`, `Looper.loop`, and `Looper.quit` calls for handling the postDelayed runnables\n  * Add GenerateNotification.java MainThread check shadow\n  * Add to String methods for better log\n  * Make OSTimeoutHandler.java a composition reference instead of inheritance"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "36d9dfac1682701bc1c0943231ff06b27a2fb570", "author": {"user": {"login": "Jeasmine", "name": "JNahui"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/36d9dfac1682701bc1c0943231ff06b27a2fb570", "committedDate": "2020-08-20T16:51:49Z", "message": "Fix Test due to Roboelectric custom Main Thread Looper shadowing\n\n  * Added `Looper.prepare`, `Looper.loop`, and `Looper.quit` calls for handling the postDelayed runnables\n  * Add GenerateNotification.java MainThread check shadow\n  * Add to String methods for better log\n  * Make OSTimeoutHandler.java a composition reference instead of inheritance"}, "afterCommit": {"oid": "d97cdd2b632bd6b50ba95c3d238712635e3f7b59", "author": {"user": {"login": "Jeasmine", "name": "JNahui"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/d97cdd2b632bd6b50ba95c3d238712635e3f7b59", "committedDate": "2020-08-20T17:08:31Z", "message": "Fix Test due to Roboelectric custom Main Thread Looper shadowing\n\n  * Added `Looper.prepare`, `Looper.loop`, and `Looper.quit` calls for handling the postDelayed runnables\n  * Add GenerateNotification.java MainThread check shadow\n  * Add to String methods for better log\n  * Make OSTimeoutHandler.java a composition reference instead of inheritance"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9db70b8079952fae307a944e037e04a9cb33d6f0", "author": {"user": {"login": "Jeasmine", "name": "JNahui"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/9db70b8079952fae307a944e037e04a9cb33d6f0", "committedDate": "2020-08-20T17:10:06Z", "message": "Fix Test due to Roboelectric custom Main Thread Looper shadowing\n\n  * Added `Looper.prepare`, `Looper.loop`, and `Looper.quit` calls for handling the postDelayed runnables\n  * Add GenerateNotification.java MainThread check shadow\n  * Add to String methods for better log\n  * Make OSTimeoutHandler.java a composition reference instead of inheritance"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d97cdd2b632bd6b50ba95c3d238712635e3f7b59", "author": {"user": {"login": "Jeasmine", "name": "JNahui"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/d97cdd2b632bd6b50ba95c3d238712635e3f7b59", "committedDate": "2020-08-20T17:08:31Z", "message": "Fix Test due to Roboelectric custom Main Thread Looper shadowing\n\n  * Added `Looper.prepare`, `Looper.loop`, and `Looper.quit` calls for handling the postDelayed runnables\n  * Add GenerateNotification.java MainThread check shadow\n  * Add to String methods for better log\n  * Make OSTimeoutHandler.java a composition reference instead of inheritance"}, "afterCommit": {"oid": "9db70b8079952fae307a944e037e04a9cb33d6f0", "author": {"user": {"login": "Jeasmine", "name": "JNahui"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/9db70b8079952fae307a944e037e04a9cb33d6f0", "committedDate": "2020-08-20T17:10:06Z", "message": "Fix Test due to Roboelectric custom Main Thread Looper shadowing\n\n  * Added `Looper.prepare`, `Looper.loop`, and `Looper.quit` calls for handling the postDelayed runnables\n  * Add GenerateNotification.java MainThread check shadow\n  * Add to String methods for better log\n  * Make OSTimeoutHandler.java a composition reference instead of inheritance"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxOTY4OTcz", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1110#pullrequestreview-471968973", "createdAt": "2020-08-20T20:39:25Z", "commit": {"oid": "9db70b8079952fae307a944e037e04a9cb33d6f0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3401, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}