{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY1NDYyMTc3", "number": 927, "reviewThreads": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQyMzo1NjozMlrODZrPuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQyMDoxOTowMlrODj8OHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4MjQ5NTI4OnYy", "diffSide": "RIGHT", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQyMzo1NjozMlrOFgMupQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQyMzo1NjozMlrOFgMupQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMwNzMwMQ==", "bodyText": "displaysQuantity should be displayQuantity", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r369307301", "createdAt": "2020-01-21T23:56:32Z", "author": {"login": "mikechoch"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java", "diffHunk": "@@ -34,24 +43,42 @@\n     @NonNull\n     public ArrayList<ArrayList<OSTrigger>> triggers;\n \n+    //Last IAM display time in seconds\n+    private long lastDisplayTime = -1;\n+    //Current quantity of displays\n+    private int displaysQuantity = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4e1d4c461a38d4cc875e30bf7e7b9b358c74efe"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4MjQ5NjA0OnYy", "diffSide": "RIGHT", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQyMzo1Njo1M1rOFgMvAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQwMzozODozOFrOFraJ0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMwNzM5NQ==", "bodyText": "displaysLimit should be displayLimit", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r369307395", "createdAt": "2020-01-21T23:56:53Z", "author": {"login": "mikechoch"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java", "diffHunk": "@@ -34,24 +43,42 @@\n     @NonNull\n     public ArrayList<ArrayList<OSTrigger>> triggers;\n \n+    //Last IAM display time in seconds\n+    private long lastDisplayTime = -1;\n+    //Current quantity of displays\n+    private int displaysQuantity = 0;\n+    //Quantity of displays limit\n+    private int displaysLimit = Integer.MAX_VALUE;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4e1d4c461a38d4cc875e30bf7e7b9b358c74efe"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQyNTYxNA==", "bodyText": "Let's make display limit default to 1 since normal IAMs only show once?", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r371425614", "createdAt": "2020-01-27T19:06:28Z", "author": {"login": "mikechoch"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java", "diffHunk": "@@ -34,24 +43,42 @@\n     @NonNull\n     public ArrayList<ArrayList<OSTrigger>> triggers;\n \n+    //Last IAM display time in seconds\n+    private long lastDisplayTime = -1;\n+    //Current quantity of displays\n+    private int displaysQuantity = 0;\n+    //Quantity of displays limit\n+    private int displaysLimit = Integer.MAX_VALUE;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMwNzM5NQ=="}, "originalCommit": {"oid": "e4e1d4c461a38d4cc875e30bf7e7b9b358c74efe"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI1NTE1Mg==", "bodyText": "taking https://github.com/OneSignal/engineering/pull/92/files as reference, it says that if limit is missing make it MAX_INT", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r374255152", "createdAt": "2020-02-03T18:07:37Z", "author": {"login": "Jeasmine"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java", "diffHunk": "@@ -34,24 +43,42 @@\n     @NonNull\n     public ArrayList<ArrayList<OSTrigger>> triggers;\n \n+    //Last IAM display time in seconds\n+    private long lastDisplayTime = -1;\n+    //Current quantity of displays\n+    private int displaysQuantity = 0;\n+    //Quantity of displays limit\n+    private int displaysLimit = Integer.MAX_VALUE;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMwNzM5NQ=="}, "originalCommit": {"oid": "e4e1d4c461a38d4cc875e30bf7e7b9b358c74efe"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDMxNTI5Mw==", "bodyText": "@jkasten2 Did we decide to keep this MAX_INT as default?", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r374315293", "createdAt": "2020-02-03T20:10:19Z", "author": {"login": "mikechoch"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java", "diffHunk": "@@ -34,24 +43,42 @@\n     @NonNull\n     public ArrayList<ArrayList<OSTrigger>> triggers;\n \n+    //Last IAM display time in seconds\n+    private long lastDisplayTime = -1;\n+    //Current quantity of displays\n+    private int displaysQuantity = 0;\n+    //Quantity of displays limit\n+    private int displaysLimit = Integer.MAX_VALUE;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMwNzM5NQ=="}, "originalCommit": {"oid": "e4e1d4c461a38d4cc875e30bf7e7b9b358c74efe"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA2MTU4NA==", "bodyText": "Yes, we can use MAX_INT incase the backend passes back a redisplay section but without any params. @mikechoch This property was moved to OSInAppMessageDisplayStats so I think this is more clear now. Marking this as resolved.", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r381061584", "createdAt": "2020-02-19T03:38:38Z", "author": {"login": "jkasten2"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java", "diffHunk": "@@ -34,24 +43,42 @@\n     @NonNull\n     public ArrayList<ArrayList<OSTrigger>> triggers;\n \n+    //Last IAM display time in seconds\n+    private long lastDisplayTime = -1;\n+    //Current quantity of displays\n+    private int displaysQuantity = 0;\n+    //Quantity of displays limit\n+    private int displaysLimit = Integer.MAX_VALUE;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMwNzM5NQ=="}, "originalCommit": {"oid": "e4e1d4c461a38d4cc875e30bf7e7b9b358c74efe"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4MjUwMjQxOnYy", "diffSide": "RIGHT", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQyMzo1OTo1NlrOFgMyhw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQyMzo1OTo1NlrOFgMyhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMwODI5NQ==", "bodyText": "Lets rename delay to displayDelay, so it is a little more specific", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r369308295", "createdAt": "2020-01-21T23:59:56Z", "author": {"login": "mikechoch"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java", "diffHunk": "@@ -34,24 +43,42 @@\n     @NonNull\n     public ArrayList<ArrayList<OSTrigger>> triggers;\n \n+    //Last IAM display time in seconds\n+    private long lastDisplayTime = -1;\n+    //Current quantity of displays\n+    private int displaysQuantity = 0;\n+    //Quantity of displays limit\n+    private int displaysLimit = Integer.MAX_VALUE;\n+    //Delay between displays in seconds\n+    private long delay = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4e1d4c461a38d4cc875e30bf7e7b9b358c74efe"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4MjUwNDE1OnYy", "diffSide": "RIGHT", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQwMDowMDo1N1rOFgMzkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQwMDowMDo1N1rOFgMzkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMwODU2MQ==", "bodyText": "reDisplayEnabled should be redisplayEnabled\nRedisplay is one word, so no capitol D", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r369308561", "createdAt": "2020-01-22T00:00:57Z", "author": {"login": "mikechoch"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java", "diffHunk": "@@ -34,24 +43,42 @@\n     @NonNull\n     public ArrayList<ArrayList<OSTrigger>> triggers;\n \n+    //Last IAM display time in seconds\n+    private long lastDisplayTime = -1;\n+    //Current quantity of displays\n+    private int displaysQuantity = 0;\n+    //Quantity of displays limit\n+    private int displaysLimit = Integer.MAX_VALUE;\n+    //Delay between displays in seconds\n+    private long delay = 0;\n     private double displayDuration;\n \n+    private boolean reDisplayEnabled = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4e1d4c461a38d4cc875e30bf7e7b9b358c74efe"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4MjUwOTU0OnYy", "diffSide": "RIGHT", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQwMDowNDowNVrOFgM22w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQwMDowNDowNVrOFgM22w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMwOTQwMw==", "bodyText": "increaseDisplayQuantity should be incrementDisplayQuantity\nincrease could be any quantity, increment means to add 1 to a current value", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r369309403", "createdAt": "2020-01-22T00:04:05Z", "author": {"login": "mikechoch"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java", "diffHunk": "@@ -137,22 +189,86 @@ boolean takeActionAsUnique() {\n         return actionTaken = true;\n     }\n \n-    public double getDisplayDuration() {\n+    double getDisplayDuration() {\n         return displayDuration;\n     }\n \n-    public void setDisplayDuration(double displayDuration) {\n+    void setDisplayDuration(double displayDuration) {\n         this.displayDuration = displayDuration;\n     }\n \n+    int getDisplaysQuantity() {\n+        return displaysQuantity;\n+    }\n+\n+    void setDisplaysQuantity(int displaysQuantity) {\n+        this.displaysQuantity = displaysQuantity;\n+    }\n+\n+    void increaseDisplayQuantity() {\n+        this.displaysQuantity++;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4e1d4c461a38d4cc875e30bf7e7b9b358c74efe"}, "originalPosition": 185}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4MjUxMTI2OnYy", "diffSide": "RIGHT", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQwMDowNTowMlrOFgM34g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQwMDowNTowMlrOFgM34g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMwOTY2Ng==", "bodyText": "isRemainingDisplays should be shouldDisplayAgain", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r369309666", "createdAt": "2020-01-22T00:05:02Z", "author": {"login": "mikechoch"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java", "diffHunk": "@@ -137,22 +189,86 @@ boolean takeActionAsUnique() {\n         return actionTaken = true;\n     }\n \n-    public double getDisplayDuration() {\n+    double getDisplayDuration() {\n         return displayDuration;\n     }\n \n-    public void setDisplayDuration(double displayDuration) {\n+    void setDisplayDuration(double displayDuration) {\n         this.displayDuration = displayDuration;\n     }\n \n+    int getDisplaysQuantity() {\n+        return displaysQuantity;\n+    }\n+\n+    void setDisplaysQuantity(int displaysQuantity) {\n+        this.displaysQuantity = displaysQuantity;\n+    }\n+\n+    void increaseDisplayQuantity() {\n+        this.displaysQuantity++;\n+    }\n+\n+    int getDisplaysLimit() {\n+        return displaysLimit;\n+    }\n+\n+    long getDelay() {\n+        return delay;\n+    }\n+\n+    long getLastDisplayTime() {\n+        return lastDisplayTime;\n+    }\n+\n+    void setLastDisplayTime(long lastDisplayTime) {\n+        this.lastDisplayTime = lastDisplayTime;\n+    }\n+\n+    boolean isReDisplayEnabled() {\n+        return reDisplayEnabled;\n+    }\n+\n+    boolean isRemainingDisplays() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4e1d4c461a38d4cc875e30bf7e7b9b358c74efe"}, "originalPosition": 208}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4MjUxNjkwOnYy", "diffSide": "RIGHT", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "isResolved": true, "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQwMDowODoxMVrOFgM7RA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxOToyMzo0MlrOFixgzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxMDUzMg==", "bodyText": "Why aren't we using the previous messages instead?", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r369310532", "createdAt": "2020-01-22T00:08:11Z", "author": {"login": "mikechoch"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -27,16 +29,20 @@\n     }};\n \n     public static final String IN_APP_MESSAGES_JSON_KEY = \"in_app_messages\";\n+    private static final String OS_SAVE_IN_APP_MESSAGE = \"OS_SAVE_IN_APP_MESSAGE\";\n \n     OSTriggerController triggerController;\n     private OSSystemConditionController systemConditionController;\n+    private OSInAppMessageRepository inAppMessageRepository;\n \n     // IAMs loaded remotely from on_session\n     //   If on_session won't be called this will be loaded from cache\n     @NonNull private ArrayList<OSInAppMessage> messages;\n     // IAMs that have had their trigger(s) evaluated to true;\n     //   This mean they have been added to the queue to display, or have already displayed\n-    @NonNull final private Set<String> triggeredMessages;\n+    @NonNull final private Set<String> dismissedAndToDismissMessages;\n+    // IAMs displayed with last displayed time and quantity of displays data\n+    @NonNull final private List<OSInAppMessage> displayedMessagesData;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4e1d4c461a38d4cc875e30bf7e7b9b358c74efe"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTcwMTAwNQ==", "bodyText": "do you mean ArrayList messages?\ni think is more clear to have separate responsibilities. But i can mix the logic to whenever the message is set add the data for redisplay,  although it will trigger another for loop. We can discuss this if you want", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r369701005", "createdAt": "2020-01-22T17:32:15Z", "author": {"login": "Jeasmine"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -27,16 +29,20 @@\n     }};\n \n     public static final String IN_APP_MESSAGES_JSON_KEY = \"in_app_messages\";\n+    private static final String OS_SAVE_IN_APP_MESSAGE = \"OS_SAVE_IN_APP_MESSAGE\";\n \n     OSTriggerController triggerController;\n     private OSSystemConditionController systemConditionController;\n+    private OSInAppMessageRepository inAppMessageRepository;\n \n     // IAMs loaded remotely from on_session\n     //   If on_session won't be called this will be loaded from cache\n     @NonNull private ArrayList<OSInAppMessage> messages;\n     // IAMs that have had their trigger(s) evaluated to true;\n     //   This mean they have been added to the queue to display, or have already displayed\n-    @NonNull final private Set<String> triggeredMessages;\n+    @NonNull final private Set<String> dismissedAndToDismissMessages;\n+    // IAMs displayed with last displayed time and quantity of displays data\n+    @NonNull final private List<OSInAppMessage> displayedMessagesData;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxMDUzMg=="}, "originalCommit": {"oid": "e4e1d4c461a38d4cc875e30bf7e7b9b358c74efe"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg3MzYzMw==", "bodyText": "I am wondering why we have\n@NonNull private ArrayList<OSInAppMessage> messages;\nand\n@NonNull final private List<OSInAppMessage> displayedMessagesData;\nShouldn't we just have one list of messages that we obtain from the on_session or cached IAMs?", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r370873633", "createdAt": "2020-01-24T22:40:07Z", "author": {"login": "mikechoch"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -27,16 +29,20 @@\n     }};\n \n     public static final String IN_APP_MESSAGES_JSON_KEY = \"in_app_messages\";\n+    private static final String OS_SAVE_IN_APP_MESSAGE = \"OS_SAVE_IN_APP_MESSAGE\";\n \n     OSTriggerController triggerController;\n     private OSSystemConditionController systemConditionController;\n+    private OSInAppMessageRepository inAppMessageRepository;\n \n     // IAMs loaded remotely from on_session\n     //   If on_session won't be called this will be loaded from cache\n     @NonNull private ArrayList<OSInAppMessage> messages;\n     // IAMs that have had their trigger(s) evaluated to true;\n     //   This mean they have been added to the queue to display, or have already displayed\n-    @NonNull final private Set<String> triggeredMessages;\n+    @NonNull final private Set<String> dismissedAndToDismissMessages;\n+    // IAMs displayed with last displayed time and quantity of displays data\n+    @NonNull final private List<OSInAppMessage> displayedMessagesData;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxMDUzMg=="}, "originalCommit": {"oid": "e4e1d4c461a38d4cc875e30bf7e7b9b358c74efe"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQwNzA1OQ==", "bodyText": "yeah i can mix the logics", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r371407059", "createdAt": "2020-01-27T18:28:07Z", "author": {"login": "Jeasmine"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -27,16 +29,20 @@\n     }};\n \n     public static final String IN_APP_MESSAGES_JSON_KEY = \"in_app_messages\";\n+    private static final String OS_SAVE_IN_APP_MESSAGE = \"OS_SAVE_IN_APP_MESSAGE\";\n \n     OSTriggerController triggerController;\n     private OSSystemConditionController systemConditionController;\n+    private OSInAppMessageRepository inAppMessageRepository;\n \n     // IAMs loaded remotely from on_session\n     //   If on_session won't be called this will be loaded from cache\n     @NonNull private ArrayList<OSInAppMessage> messages;\n     // IAMs that have had their trigger(s) evaluated to true;\n     //   This mean they have been added to the queue to display, or have already displayed\n-    @NonNull final private Set<String> triggeredMessages;\n+    @NonNull final private Set<String> dismissedAndToDismissMessages;\n+    // IAMs displayed with last displayed time and quantity of displays data\n+    @NonNull final private List<OSInAppMessage> displayedMessagesData;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxMDUzMg=="}, "originalCommit": {"oid": "e4e1d4c461a38d4cc875e30bf7e7b9b358c74efe"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQyMDQ0MQ==", "bodyText": "I think we should have a single @NonNull private ArrayList<OSInAppMessage> messages; that contains on IAMs pulled down for the current session\nI cant tell if you are agreeing or not haha?", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r371420441", "createdAt": "2020-01-27T18:56:13Z", "author": {"login": "mikechoch"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -27,16 +29,20 @@\n     }};\n \n     public static final String IN_APP_MESSAGES_JSON_KEY = \"in_app_messages\";\n+    private static final String OS_SAVE_IN_APP_MESSAGE = \"OS_SAVE_IN_APP_MESSAGE\";\n \n     OSTriggerController triggerController;\n     private OSSystemConditionController systemConditionController;\n+    private OSInAppMessageRepository inAppMessageRepository;\n \n     // IAMs loaded remotely from on_session\n     //   If on_session won't be called this will be loaded from cache\n     @NonNull private ArrayList<OSInAppMessage> messages;\n     // IAMs that have had their trigger(s) evaluated to true;\n     //   This mean they have been added to the queue to display, or have already displayed\n-    @NonNull final private Set<String> triggeredMessages;\n+    @NonNull final private Set<String> dismissedAndToDismissMessages;\n+    // IAMs displayed with last displayed time and quantity of displays data\n+    @NonNull final private List<OSInAppMessage> displayedMessagesData;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxMDUzMg=="}, "originalCommit": {"oid": "e4e1d4c461a38d4cc875e30bf7e7b9b358c74efe"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ2MDkzMA==", "bodyText": "@mikechoch and I talked about this. Our ArrayList<OSInAppMessage> messages is a list of all IAMs from our server so we should keep this list untouched.\nTo read and write our two new properties I think we should create a new class to store them under. We can call this something like OSInAppMessageDisplayStats which will hold our displayQuantity and lastTimeDisplayed. This can still be referenced by OSInAppMessage as a property.", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r371460930", "createdAt": "2020-01-27T20:18:23Z", "author": {"login": "jkasten2"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -27,16 +29,20 @@\n     }};\n \n     public static final String IN_APP_MESSAGES_JSON_KEY = \"in_app_messages\";\n+    private static final String OS_SAVE_IN_APP_MESSAGE = \"OS_SAVE_IN_APP_MESSAGE\";\n \n     OSTriggerController triggerController;\n     private OSSystemConditionController systemConditionController;\n+    private OSInAppMessageRepository inAppMessageRepository;\n \n     // IAMs loaded remotely from on_session\n     //   If on_session won't be called this will be loaded from cache\n     @NonNull private ArrayList<OSInAppMessage> messages;\n     // IAMs that have had their trigger(s) evaluated to true;\n     //   This mean they have been added to the queue to display, or have already displayed\n-    @NonNull final private Set<String> triggeredMessages;\n+    @NonNull final private Set<String> dismissedAndToDismissMessages;\n+    // IAMs displayed with last displayed time and quantity of displays data\n+    @NonNull final private List<OSInAppMessage> displayedMessagesData;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxMDUzMg=="}, "originalCommit": {"oid": "e4e1d4c461a38d4cc875e30bf7e7b9b358c74efe"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjAwNzExOQ==", "bodyText": "ok that make sense. I agree with that the message list should kept untouched.", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r372007119", "createdAt": "2020-01-28T19:23:42Z", "author": {"login": "Jeasmine"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -27,16 +29,20 @@\n     }};\n \n     public static final String IN_APP_MESSAGES_JSON_KEY = \"in_app_messages\";\n+    private static final String OS_SAVE_IN_APP_MESSAGE = \"OS_SAVE_IN_APP_MESSAGE\";\n \n     OSTriggerController triggerController;\n     private OSSystemConditionController systemConditionController;\n+    private OSInAppMessageRepository inAppMessageRepository;\n \n     // IAMs loaded remotely from on_session\n     //   If on_session won't be called this will be loaded from cache\n     @NonNull private ArrayList<OSInAppMessage> messages;\n     // IAMs that have had their trigger(s) evaluated to true;\n     //   This mean they have been added to the queue to display, or have already displayed\n-    @NonNull final private Set<String> triggeredMessages;\n+    @NonNull final private Set<String> dismissedAndToDismissMessages;\n+    // IAMs displayed with last displayed time and quantity of displays data\n+    @NonNull final private List<OSInAppMessage> displayedMessagesData;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxMDUzMg=="}, "originalCommit": {"oid": "e4e1d4c461a38d4cc875e30bf7e7b9b358c74efe"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4MjUxODE1OnYy", "diffSide": "RIGHT", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQwMDowODo1MFrOFgM7-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQwMDowODo1MFrOFgM7-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxMDcxNA==", "bodyText": "dismissedAndToDismissMessages should be dismissedMessages, no need to over complicate the name", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r369310714", "createdAt": "2020-01-22T00:08:50Z", "author": {"login": "mikechoch"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -27,16 +29,20 @@\n     }};\n \n     public static final String IN_APP_MESSAGES_JSON_KEY = \"in_app_messages\";\n+    private static final String OS_SAVE_IN_APP_MESSAGE = \"OS_SAVE_IN_APP_MESSAGE\";\n \n     OSTriggerController triggerController;\n     private OSSystemConditionController systemConditionController;\n+    private OSInAppMessageRepository inAppMessageRepository;\n \n     // IAMs loaded remotely from on_session\n     //   If on_session won't be called this will be loaded from cache\n     @NonNull private ArrayList<OSInAppMessage> messages;\n     // IAMs that have had their trigger(s) evaluated to true;\n     //   This mean they have been added to the queue to display, or have already displayed\n-    @NonNull final private Set<String> triggeredMessages;\n+    @NonNull final private Set<String> dismissedAndToDismissMessages;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4e1d4c461a38d4cc875e30bf7e7b9b358c74efe"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4MjUyMDgwOnYy", "diffSide": "RIGHT", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQwMDoxMDoyMlrOFgM9ig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxNTowMjo1NFrOFgfV-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxMTExNA==", "bodyText": "Why is this <p> here?", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r369311114", "createdAt": "2020-01-22T00:10:22Z", "author": {"login": "mikechoch"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java", "diffHunk": "@@ -21,7 +30,7 @@\n     /**\n      * Allows in-app messages to use multiple language variants, or to have variations between\n      * different device types (ie. a different image for phones vs. tablets, etc.).\n-     *\n+     * <p>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4e1d4c461a38d4cc875e30bf7e7b9b358c74efe"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTYxMjI4MA==", "bodyText": "reformat code stuff, i will remove it", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r369612280", "createdAt": "2020-01-22T15:02:54Z", "author": {"login": "Jeasmine"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java", "diffHunk": "@@ -21,7 +30,7 @@\n     /**\n      * Allows in-app messages to use multiple language variants, or to have variations between\n      * different device types (ie. a different image for phones vs. tablets, etc.).\n-     *\n+     * <p>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxMTExNA=="}, "originalCommit": {"oid": "e4e1d4c461a38d4cc875e30bf7e7b9b358c74efe"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4MjUyMzY2OnYy", "diffSide": "RIGHT", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQwMDoxMTo1NlrOFgM_OA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQwMDoxMTo1NlrOFgM_OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxMTU0NA==", "bodyText": "Pass null into here instead, if possible", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r369311544", "createdAt": "2020-01-22T00:11:56Z", "author": {"login": "mikechoch"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -51,41 +57,44 @@\n \n     @Nullable private static OSInAppMessageController sharedInstance;\n     public static OSInAppMessageController getController() {\n+        OneSignalDbHelper dbHelper = OneSignal.getDBHelperInstance();\n+\n         // Make sure only Android 4.4 devices and higher can use IAMs\n         if (Build.VERSION.SDK_INT <= Build.VERSION_CODES.JELLY_BEAN_MR2) {\n-            sharedInstance = new OSInAppMessageDummyController();\n+            sharedInstance = new OSInAppMessageDummyController(dbHelper);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4e1d4c461a38d4cc875e30bf7e7b9b358c74efe"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5NjIzMDcxOnYy", "diffSide": "RIGHT", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxODo1NDowNlrOFiNpHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QyMDoxMDozMFrOFk-ZdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQxOTQyMw==", "bodyText": "Prefer adding curly braces if more than one line is under an if statement.", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r371419423", "createdAt": "2020-01-27T18:54:06Z", "author": {"login": "jkasten2"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java", "diffHunk": "@@ -105,8 +159,16 @@ JSONObject toJSONObject() {\n                 variants.put(key, converted);\n             }\n \n-            json.put(\"variants\", variants);\n-            json.put(\"display_duration\", this.displayDuration);\n+            json.put(IAM_VARIANTS, variants);\n+            json.put(DISPLAY_DURATION, this.displayDuration);\n+            json.put(DISPLAY_LIMIT, this.displayLimit);\n+            json.put(DISPLAY_DELAY, this.displayDelay);\n+\n+            if (redisplayEnabled)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2eab6f5daa346f25aefcb082de36bea951d61f3a"}, "originalPosition": 139}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDMxNTM4MA==", "bodyText": "Agree with this", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r374315380", "createdAt": "2020-02-03T20:10:30Z", "author": {"login": "mikechoch"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessage.java", "diffHunk": "@@ -105,8 +159,16 @@ JSONObject toJSONObject() {\n                 variants.put(key, converted);\n             }\n \n-            json.put(\"variants\", variants);\n-            json.put(\"display_duration\", this.displayDuration);\n+            json.put(IAM_VARIANTS, variants);\n+            json.put(DISPLAY_DURATION, this.displayDuration);\n+            json.put(DISPLAY_LIMIT, this.displayLimit);\n+            json.put(DISPLAY_DELAY, this.displayDelay);\n+\n+            if (redisplayEnabled)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQxOTQyMw=="}, "originalCommit": {"oid": "2eab6f5daa346f25aefcb082de36bea951d61f3a"}, "originalPosition": 139}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5NjI5MTEzOnYy", "diffSide": "RIGHT", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxOToxMzo1MFrOFiOPPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxOToyNDoyOFrOFixiVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQyOTE4Mw==", "bodyText": "This if would never be true as we new up a OSInAppMessageDummyController instead for per 4.4 devices.", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r371429183", "createdAt": "2020-01-27T19:13:50Z", "author": {"login": "jkasten2"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -94,6 +102,14 @@ protected OSInAppMessageController() {\n         );\n         if (tempClickedMessageIdsSet != null)\n             clickedClickIds.addAll(tempClickedMessageIdsSet);\n+\n+        if (Build.VERSION.SDK_INT <= Build.VERSION_CODES.JELLY_BEAN_MR2) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2eab6f5daa346f25aefcb082de36bea951d61f3a"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjAwNzUxMA==", "bodyText": "true! i added this for some test case, but i will check", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r372007510", "createdAt": "2020-01-28T19:24:28Z", "author": {"login": "Jeasmine"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -94,6 +102,14 @@ protected OSInAppMessageController() {\n         );\n         if (tempClickedMessageIdsSet != null)\n             clickedClickIds.addAll(tempClickedMessageIdsSet);\n+\n+        if (Build.VERSION.SDK_INT <= Build.VERSION_CODES.JELLY_BEAN_MR2) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQyOTE4Mw=="}, "originalCommit": {"oid": "2eab6f5daa346f25aefcb082de36bea951d61f3a"}, "originalPosition": 97}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5NjI5Nzc1OnYy", "diffSide": "RIGHT", "path": "OneSignalSDK/unittest/src/test/java/com/test/onesignal/InAppMessagingUnitTests.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxOToxNTo1MlrOFiOTNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxOToxNTo1MlrOFiOTNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQzMDE5OA==", "bodyText": "nit, remove space after (", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r371430198", "createdAt": "2020-01-27T19:15:52Z", "author": {"login": "jkasten2"}, "path": "OneSignalSDK/unittest/src/test/java/com/test/onesignal/InAppMessagingUnitTests.java", "diffHunk": "@@ -153,6 +157,97 @@ public void testBuiltMessageVariants() {\n         assertEquals(message.variants.get(\"android\").get(\"en\"), InAppMessagingHelpers.TEST_ENGLISH_ANDROID_VARIANT_ID);\n     }\n \n+    @Test\n+    public void testBuiltMessageReDisplay() throws JSONException {\n+        OSTestInAppMessage message = InAppMessagingHelpers.buildTestMessageWitRedisplay(\n+                LIMIT,\n+                DELAY\n+        );\n+        assertTrue(message.isRedisplayEnabled());\n+        assertEquals(LIMIT, message.getDisplayLimit());\n+        assertEquals(DELAY, message.getDisplayDelay());\n+        assertEquals(-1.0, message.getLastDisplayTime());\n+        assertEquals(0, message.getDisplayQuantity());\n+\n+        OSTestInAppMessage messageWithoutDisplay = InAppMessagingHelpers.buildTestMessageWithSingleTrigger(\n+                OSTriggerKind.SESSION_TIME,\n+                null,\n+                OSTriggerOperator.GREATER_THAN_OR_EQUAL_TO.toString(),\n+                3\n+        );\n+        assertFalse(messageWithoutDisplay.isRedisplayEnabled());\n+        assertEquals(Integer.MAX_VALUE, messageWithoutDisplay.getDisplayLimit());\n+        assertEquals(0.0, messageWithoutDisplay.getDisplayDelay());\n+        assertEquals(-1.0, messageWithoutDisplay.getLastDisplayTime());\n+        assertEquals(0, messageWithoutDisplay.getDisplayQuantity());\n+    }\n+\n+    @Test\n+    public void testBuiltMessageRedisplayLimit() throws JSONException {\n+        OSTestInAppMessage message = InAppMessagingHelpers.buildTestMessageWitRedisplay(\n+                LIMIT,\n+                DELAY\n+        );\n+\n+        for (int i = 0; i < LIMIT; i++) {\n+            assertTrue( message.shouldDisplayAgain());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2eab6f5daa346f25aefcb082de36bea951d61f3a"}, "originalPosition": 59}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5NjMzNjExOnYy", "diffSide": "RIGHT", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxOToyNzo0MVrOFiOqrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxOToyNzo0MVrOFiOqrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQzNjIwNg==", "bodyText": "Here we need to add a check to only re-display if a trigger was updated that is in this IAM's trigger set.\nThis prevents the IAM from reshowing over and over until it hits it's display limit since evaluateInAppMessages is called each time an IAM is dismissed.", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r371436206", "createdAt": "2020-01-27T19:27:41Z", "author": {"login": "jkasten2"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -303,17 +323,48 @@ void onFailure(int statusCode, String response, Throwable throwable) {\n         }\n     }\n \n+    /**\n+     * In order to an IAM to be re display, two condition need to be satisfied\n+     *  - Gap between displays\n+     *  - Quantity of displays\n+     *\n+     * For re display, the message need to be removed from the arrays that track the display\n+     * */\n+    private void setDataForReDisplay(OSInAppMessage message) {\n+        if (!message.isRedisplayEnabled())\n+            return;\n+\n+        int index = displayedMessagesData.indexOf(message);\n+        if (index != -1) {\n+            OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, \"setDataForReDisplay: \" + message.messageId);\n+\n+            OSInAppMessage savedIAM = displayedMessagesData.get(index);\n+            message.setLastDisplayTime(savedIAM.getLastDisplayTime());\n+            message.setDisplayQuantity(savedIAM.getDisplayQuantity());\n+\n+            if (message.isDelayTimeSatisfied() && message.shouldDisplayAgain()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2eab6f5daa346f25aefcb082de36bea951d61f3a"}, "originalPosition": 171}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwNDM0ODUxOnYy", "diffSide": "RIGHT", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQyMzo1OTozNlrOFjbmNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxNzoyMjo0M1rOFlcr5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY5NjYyOA==", "bodyText": "We need to also call checkTriggerChanges() in removeTriggersForKeys as well, as they could have a condition to display on trigger does not exists.", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r372696628", "createdAt": "2020-01-29T23:59:36Z", "author": {"login": "jkasten2"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -553,6 +587,7 @@ public void messageTriggerConditionChanged() {\n      */\n     void addTriggers(Map<String, Object> newTriggers) {\n         triggerController.addTriggers(newTriggers);\n+        checkTriggerChanges(newTriggers);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76d40edb26f587169ae829ad8167c30584a36679"}, "originalPosition": 143}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDgxMTYyMw==", "bodyText": "ok, i had doubts about this", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r374811623", "createdAt": "2020-02-04T17:22:43Z", "author": {"login": "Jeasmine"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -553,6 +587,7 @@ public void messageTriggerConditionChanged() {\n      */\n     void addTriggers(Map<String, Object> newTriggers) {\n         triggerController.addTriggers(newTriggers);\n+        checkTriggerChanges(newTriggers);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY5NjYyOA=="}, "originalCommit": {"oid": "76d40edb26f587169ae829ad8167c30584a36679"}, "originalPosition": 143}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwNzczOTc0OnYy", "diffSide": "RIGHT", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQyMjozNjoyNlrOFj8O9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQyMjozNjoyNlrOFj8O9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzIzMTM1MQ==", "bodyText": "ReDisplay should be Redisplay", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r373231351", "createdAt": "2020-01-30T22:36:26Z", "author": {"login": "mikechoch"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -303,17 +325,47 @@ void onFailure(int statusCode, String response, Throwable throwable) {\n         }\n     }\n \n+    /**\n+     * In order to an IAM to be re display, two condition need to be satisfied\n+     *  - Gap between displays\n+     *  - Quantity of displays\n+     *\n+     * For re display, the message need to be removed from the arrays that track the display\n+     * */\n+    private void setDataForReDisplay(OSInAppMessage message) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76d40edb26f587169ae829ad8167c30584a36679"}, "originalPosition": 169}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1ODU1MTM4OnYy", "diffSide": "RIGHT", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQwMzozMTowN1rOFraDrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQyMjo0MToyOFrOFr6Wew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA2MDAxNA==", "bodyText": "We can clean up this DateGenerator by using  System.currentTimeMillis()  instead.  This way we can use advanceSystemTimeBy in our tests for mocking time.", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r381060014", "createdAt": "2020-02-19T03:31:07Z", "author": {"login": "jkasten2"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -94,6 +106,22 @@ protected OSInAppMessageController() {\n         );\n         if (tempClickedMessageIdsSet != null)\n             clickedClickIds.addAll(tempClickedMessageIdsSet);\n+\n+        initRedisplayData(dbInstance);\n+    }\n+\n+    /*\n+    * For testing purposes\n+    * */\n+    public DateGenerator getDateGenerator() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ebe8352de384a3a02970dc2b519a9f692d97cd4"}, "originalPosition": 119}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTU4OTExNQ==", "bodyText": "oh men, why i didn't see this", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r381589115", "createdAt": "2020-02-19T22:41:28Z", "author": {"login": "Jeasmine"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -94,6 +106,22 @@ protected OSInAppMessageController() {\n         );\n         if (tempClickedMessageIdsSet != null)\n             clickedClickIds.addAll(tempClickedMessageIdsSet);\n+\n+        initRedisplayData(dbInstance);\n+    }\n+\n+    /*\n+    * For testing purposes\n+    * */\n+    public DateGenerator getDateGenerator() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA2MDAxNA=="}, "originalCommit": {"oid": "3ebe8352de384a3a02970dc2b519a9f692d97cd4"}, "originalPosition": 119}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM5MDEyNDA3OnYy", "diffSide": "RIGHT", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQyMDoxNToyM1rOFwBmkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQyMDoxNToyM1rOFwBmkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkwMjIyNg==", "bodyText": "Change dbInstance to dbHelper, most of our codebase is dbHelper", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r385902226", "createdAt": "2020-02-28T20:15:23Z", "author": {"login": "mikechoch"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -110,7 +110,7 @@ protected OSInAppMessageController(OneSignalDbHelper dbInstance) {\n         initRedisplayData(dbInstance);\n     }\n \n-    void initRedisplayData(OneSignalDbHelper dbInstance) {\n+    protected void initRedisplayData(OneSignalDbHelper dbInstance) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3413fd7edc3e50fe8f5dfbca0f5f18841f116105"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM5MDEzMjgwOnYy", "diffSide": "LEFT", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQyMDoxODozNFrOFwBrzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQyMDoyNjo1NVrOFwB4aQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkwMzU2Ng==", "bodyText": "Using contains with an oObject is dangerous. This could be true or false and not represent the String messageId, this should be changed back", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r385903566", "createdAt": "2020-02-28T20:18:34Z", "author": {"login": "mikechoch"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -402,7 +402,7 @@ private void setDataForRedisplay(OSInAppMessage message) {\n     private void queueMessageForDisplay(@NonNull OSInAppMessage message) {\n         synchronized (messageDisplayQueue) {\n             // Make sure no message is ever added to the queue more than once\n-            if (!isInAppMessageQueued(message)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3413fd7edc3e50fe8f5dfbca0f5f18841f116105"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkwNjc5Mw==", "bodyText": "Yeah agree, thas why i have the equals and hash overriden", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r385906793", "createdAt": "2020-02-28T20:26:55Z", "author": {"login": "Jeasmine"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -402,7 +402,7 @@ private void setDataForRedisplay(OSInAppMessage message) {\n     private void queueMessageForDisplay(@NonNull OSInAppMessage message) {\n         synchronized (messageDisplayQueue) {\n             // Make sure no message is ever added to the queue more than once\n-            if (!isInAppMessageQueued(message)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkwMzU2Ng=="}, "originalCommit": {"oid": "3413fd7edc3e50fe8f5dfbca0f5f18841f116105"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM5MDEzNDA1OnYy", "diffSide": "RIGHT", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQyMDoxOTowMlrOFwBslQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQyMDoxOTowMlrOFwBslQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkwMzc2NQ==", "bodyText": "Nice clean up!", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/927#discussion_r385903765", "createdAt": "2020-02-28T20:19:02Z", "author": {"login": "mikechoch"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -467,8 +456,7 @@ void messageWasDismissed(@NonNull OSInAppMessage message) {\n     private void dismissCurrentMessage() {\n         synchronized (messageDisplayQueue) {\n             if (messageDisplayQueue.size() > 0) {\n-                String removedMessageId = messageDisplayQueue.get(0).messageId;\n-                messageDisplayQueue.remove(0);\n+                String removedMessageId = messageDisplayQueue.remove(0).messageId;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3413fd7edc3e50fe8f5dfbca0f5f18841f116105"}, "originalPosition": 72}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2328, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}