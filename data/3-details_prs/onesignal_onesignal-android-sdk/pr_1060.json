{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMyODk0ODM4", "number": 1060, "title": "Moved logic out of NotificationOpenedActivityHMS", "bodyText": "Moved most logic into NotificationPayloadProcessorHMS so the Activity\nhas a single responsibility, to be an entry point only.\nAdded HMS action button id formatting logic\nAdded new HMS open integration test.\n\nIt covers testing firing the open callback + actionId is set.\n\n\n\n\n\nThis change is\u2002", "createdAt": "2020-06-11T07:34:56Z", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1060", "merged": true, "mergeCommit": {"oid": "a23af4481d40efd89289d27d315f19670cb395e1"}, "closed": true, "closedAt": "2020-06-12T11:20:20Z", "author": {"login": "jkasten2"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcqJMRVgH2gAyNDMyODk0ODM4OjA2ZmNiMTYyOTEyYmEwYjIzMGVhNGVlZWVlYzc1Yjc4ZDIyNDJkN2Y=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcqhB4AgFqTQyOTY2Mjg5OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "06fcb162912ba0b230ea4eeeeec75b78d2242d7f", "author": {"user": {"login": "jkasten2", "name": "Josh Kasten"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/06fcb162912ba0b230ea4eeeeec75b78d2242d7f", "committedDate": "2020-06-11T07:33:27Z", "message": "Moved logic out of NotificationOpenedActivityHMS\n\n* Moved most logic into NotificationPayloadProcessorHMS so the Activity\nhas a single responbility, to be an entry point only.\n* Added HMS action button id formatting logic\n* Added new HMS open intergration test.\n  - It covers testing firing the open callback + actionId is set."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4OTM4OTEw", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1060#pullrequestreview-428938910", "createdAt": "2020-06-11T13:56:06Z", "commit": {"oid": "06fcb162912ba0b230ea4eeeeec75b78d2242d7f"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxNDoxMDo0OFrOGifNRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxNDoxNjoxMFrOGifb8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgxNjA2OQ==", "bodyText": "So that its consistent should we capitalize HMS in covertHmsOpenIntentToJson?", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1060#discussion_r438816069", "createdAt": "2020-06-11T14:10:48Z", "author": {"login": "mikechoch"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/NotificationPayloadProcessorHMS.java", "diffHunk": "@@ -0,0 +1,74 @@\n+package com.onesignal;\r\n+\r\n+import android.app.Activity;\r\n+import android.content.Intent;\r\n+import android.os.Bundle;\r\n+import android.support.annotation.NonNull;\r\n+import android.support.annotation.Nullable;\r\n+\r\n+import org.json.JSONArray;\r\n+import org.json.JSONException;\r\n+import org.json.JSONObject;\r\n+\r\n+import static com.onesignal.GenerateNotification.BUNDLE_KEY_ACTION_ID;\r\n+\r\n+class NotificationPayloadProcessorHMS {\r\n+\r\n+    static void handleHmsNotificationOpenIntent(@NonNull Activity activity, @Nullable Intent intent) {\r\n+        OneSignal.setAppContext(activity);\r\n+        if (intent == null)\r\n+            return;\r\n+\r\n+        JSONObject jsonData = covertHmsOpenIntentToJson(intent);\r\n+        if (jsonData == null)\r\n+            return;\r\n+\r\n+        handleProcessJsonOpenData(activity, jsonData);\r\n+    }\r\n+\r\n+    // Takes in a Notification Open Intent fired from HMS Core and coverts it to an OS formatted JSONObject\r\n+    // Returns null if it is NOT a notification sent from OneSignal's backend\r\n+    private static @Nullable JSONObject covertHmsOpenIntentToJson(@Nullable Intent intent) {\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06fcb162912ba0b230ea4eeeeec75b78d2242d7f"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgxNjMwNw==", "bodyText": "So that its consistent should we capitalize HMS in handleHmsNotificationOpenIntent?", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1060#discussion_r438816307", "createdAt": "2020-06-11T14:11:05Z", "author": {"login": "mikechoch"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/NotificationPayloadProcessorHMS.java", "diffHunk": "@@ -0,0 +1,74 @@\n+package com.onesignal;\r\n+\r\n+import android.app.Activity;\r\n+import android.content.Intent;\r\n+import android.os.Bundle;\r\n+import android.support.annotation.NonNull;\r\n+import android.support.annotation.Nullable;\r\n+\r\n+import org.json.JSONArray;\r\n+import org.json.JSONException;\r\n+import org.json.JSONObject;\r\n+\r\n+import static com.onesignal.GenerateNotification.BUNDLE_KEY_ACTION_ID;\r\n+\r\n+class NotificationPayloadProcessorHMS {\r\n+\r\n+    static void handleHmsNotificationOpenIntent(@NonNull Activity activity, @Nullable Intent intent) {\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06fcb162912ba0b230ea4eeeeec75b78d2242d7f"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgxOTM5Ng==", "bodyText": "Use the OSNotificationFormatHelper.PAYLOAD_OS_NOTIFICATION_ID for \"i\"?\nUse the OSNotificationFormatHelper.PAYLOAD_OS_ROOT_CUSTOM for \"custom\"?", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1060#discussion_r438819396", "createdAt": "2020-06-11T14:15:30Z", "author": {"login": "mikechoch"}, "path": "OneSignalSDK/unittest/src/test/java/com/test/onesignal/NotificationOpenedActivityHMSIntegrationTestsRunner.java", "diffHunk": "@@ -68,27 +70,50 @@ public void beforeEachTest() throws Exception {\n         ShadowOSUtils.supportsHMS(true);\r\n     }\r\n \r\n-    private static Intent helper_baseHMSOpenIntent() {\r\n+    private static @NonNull Intent helper_baseHMSOpenIntent() {\r\n         return new Intent()\r\n                 .setFlags(Intent.FLAG_ACTIVITY_NO_HISTORY | Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_MULTIPLE_TASK)\r\n                 .setAction(\"android.intent.action.VIEW\");\r\n     }\r\n \r\n-    private static void helper_startHMSOpenActivity(@NonNull Intent intent) {\r\n-        Robolectric.buildActivity(NotificationOpenedActivityHMS.class, intent).create();\r\n+    private static @NonNull Intent helper_basicOSHMSOpenIntent() throws JSONException {\r\n+        return helper_baseHMSOpenIntent()\r\n+                .putExtra(\r\n+                    \"custom\",\r\n+                    new JSONObject() {{\r\n+                        put(\"i\", UUID.randomUUID().toString());\r\n+                }}.toString()\r\n+        );\r\n     }\r\n \r\n-    private static void helper_initSDKAndFireHMSNotificationOpenIntent() throws Exception {\r\n-        OneSignal.init(RuntimeEnvironment.application, \"123456789\", ONESIGNAL_APP_ID);\r\n-        fastColdRestartApp();\r\n-\r\n-        Intent intent = helper_baseHMSOpenIntent()\r\n+    private static @NonNull Intent helper_basicOSHMSOpenIntentWithActionId(final @NonNull String actionId) throws JSONException {\r\n+        return helper_baseHMSOpenIntent()\r\n                 .putExtra(\r\n                         \"custom\",\r\n                         new JSONObject() {{\r\n                             put(\"i\", UUID.randomUUID().toString());\r\n+                            put(BUNDLE_KEY_ACTION_ID, actionId);\r\n                         }}.toString()\r\n                 );\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06fcb162912ba0b230ea4eeeeec75b78d2242d7f"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgxOTgyNA==", "bodyText": "Use the OSNotificationFormatHelper.PAYLOAD_OS_NOTIFICATION_ID for \"i\"?\nUse the OSNotificationFormatHelper.PAYLOAD_OS_ROOT_CUSTOM for \"custom\"?", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1060#discussion_r438819824", "createdAt": "2020-06-11T14:16:10Z", "author": {"login": "mikechoch"}, "path": "OneSignalSDK/unittest/src/test/java/com/test/onesignal/NotificationOpenedActivityHMSIntegrationTestsRunner.java", "diffHunk": "@@ -68,27 +70,50 @@ public void beforeEachTest() throws Exception {\n         ShadowOSUtils.supportsHMS(true);\r\n     }\r\n \r\n-    private static Intent helper_baseHMSOpenIntent() {\r\n+    private static @NonNull Intent helper_baseHMSOpenIntent() {\r\n         return new Intent()\r\n                 .setFlags(Intent.FLAG_ACTIVITY_NO_HISTORY | Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_MULTIPLE_TASK)\r\n                 .setAction(\"android.intent.action.VIEW\");\r\n     }\r\n \r\n-    private static void helper_startHMSOpenActivity(@NonNull Intent intent) {\r\n-        Robolectric.buildActivity(NotificationOpenedActivityHMS.class, intent).create();\r\n+    private static @NonNull Intent helper_basicOSHMSOpenIntent() throws JSONException {\r\n+        return helper_baseHMSOpenIntent()\r\n+                .putExtra(\r\n+                    \"custom\",\r\n+                    new JSONObject() {{\r\n+                        put(\"i\", UUID.randomUUID().toString());\r\n+                }}.toString()\r\n+        );\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06fcb162912ba0b230ea4eeeeec75b78d2242d7f"}, "originalPosition": 52}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5MDMzMDk3", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1060#pullrequestreview-429033097", "createdAt": "2020-06-11T15:32:17Z", "commit": {"oid": "06fcb162912ba0b230ea4eeeeec75b78d2242d7f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxNTozMjoxN1rOGiiypQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxNTozMjoxN1rOGiiypQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg3NDc4OQ==", "bodyText": "can this go in the top with the other constants? \ud83d\ude01", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1060#discussion_r438874789", "createdAt": "2020-06-11T15:32:17Z", "author": {"login": "Jeasmine"}, "path": "OneSignalSDK/unittest/src/test/java/com/test/onesignal/NotificationOpenedActivityHMSIntegrationTestsRunner.java", "diffHunk": "@@ -102,18 +127,34 @@ public void emptyIntent_doesNotThrow() {\n \r\n     @Test\r\n     public void barebonesOSPayload_startsMainActivity() throws Exception {\r\n-        helper_initSDKAndFireHMSNotificationOpenIntent();\r\n+        helper_initSDKAndFireHMSNotificationBarebonesOSOpenIntent();\r\n \r\n         Intent startedActivity = shadowOf(RuntimeEnvironment.application).getNextStartedActivity();\r\n         assertEquals(startedActivity.getComponent().getClassName(), BlankActivity.class.getName());\r\n     }\r\n \r\n     @Test\r\n     public void barebonesOSPayload_makesNotificationOpenRequest() throws Exception {\r\n-        helper_initSDKAndFireHMSNotificationOpenIntent();\r\n+        helper_initSDKAndFireHMSNotificationBarebonesOSOpenIntent();\r\n         assertNotificationOpenAtIndex(1, UserState.DEVICE_TYPE_HUAWEI);\r\n     }\r\n \r\n+    private static final String TEST_ACTION_ID = \"myTestActionId\";\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06fcb162912ba0b230ea4eeeeec75b78d2242d7f"}, "originalPosition": 109}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93cf2f6a6dab56b05d0edf49ec58578ac8e350f9", "author": {"user": {"login": "jkasten2", "name": "Josh Kasten"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/93cf2f6a6dab56b05d0edf49ec58578ac8e350f9", "committedDate": "2020-06-11T18:03:45Z", "message": "Switching to constants keys from strings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f24308c61bb82192b60e051fa3c29bdf5b667c04", "author": {"user": {"login": "jkasten2", "name": "Josh Kasten"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/f24308c61bb82192b60e051fa3c29bdf5b667c04", "committedDate": "2020-06-11T18:04:07Z", "message": "HMS casing fixes on method names"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5MzQyNjE2", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1060#pullrequestreview-429342616", "createdAt": "2020-06-11T22:44:25Z", "commit": {"oid": "f24308c61bb82192b60e051fa3c29bdf5b667c04"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5NjYyODk5", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1060#pullrequestreview-429662899", "createdAt": "2020-06-12T11:19:49Z", "commit": {"oid": "f24308c61bb82192b60e051fa3c29bdf5b667c04"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3605, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}