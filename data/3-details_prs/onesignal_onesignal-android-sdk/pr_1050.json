{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMxOTgxMDA4", "number": 1050, "title": "Adding 2 layers of control to prevent locks in SQL DB and minor clean up", "bodyText": "Removed the commented enableWriteAheadLogging\n\nNo need for this as this allows concurrent read and writes to occur and we would rather pause a read while a write occurs\nPausing will ensure that we are querying the most updated data\n\n\n\n2 layers of security for SQL DB regarding OSInAppMessageRepository.java\n\nFirst one will be transactions using beginTransaction, setTransactionSuccessful, and endTransaction methods wherever we insert, delete, or update\nSecond one is keeping TABLE manipulation or reading within the same file and setting these methods as synchronized so that any other TABLE touching that occurs won't happen till any current methods are complete\nThe combination of the two steps should help prevent any conflicts between SQL DB and solve the locking issues\n\n\n\nWIP - Making sure any DB reading and writing is from the same file so synchronized along with transactions provide this 2 layer security around our single SQL DB instance\n\n\n\n\nThis change is\u2002", "createdAt": "2020-06-09T18:14:46Z", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1050", "merged": true, "mergeCommit": {"oid": "282a3dfd5c24da7fbff624dc6def0a5ebe8715a7"}, "closed": true, "closedAt": "2020-06-11T02:40:08Z", "author": {"login": "mikechoch"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcppKHYAH2gAyNDMxOTgxMDA4Ojc2ZjFmYzY2ZWNiYmUzMjlhNGMyODQ3MGIzNzVjZDUyMTBjMjA2Njk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcqE-2LAFqTQyODU1MzkyOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "76f1fc66ecbbe329a4c28470b375cd5210c20669", "author": {"user": {"login": "mikechoch", "name": "Michael DiCioccio"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/76f1fc66ecbbe329a4c28470b375cd5210c20669", "committedDate": "2020-06-09T18:14:08Z", "message": "Adding 2 layers of SQL DB security and minor clean up\n* Removed the commented `enableWriteAheadLogging`\n  * No need for this as this allows concurrent read and writes to occur and we would rather pause a read while a write occurs\n  * Pausing will ensure that we are querying the most updated data\n* 2 layers of security for SQL DB regarding `OSInAppMessageRepository.java`\n  * First one will be transactions using `beginTransaction`, `setTransactionSuccessful`, and `endTransaction` methods wherever we `insert`, `delete`, or `update`\n  * Second one is keeping TABLE manipulation or reading within the same file and setting these methods as synchronized so that any other TABLE touching that occurs won't happen till any current methods are complete\n  * The combination of the two steps should help prevent any conflicts between SQL DB and solve the locking issues\n\n* WIP - Making sure any DB reading and writing is from the same file so `synchronized` along with transactions provide this 2 layer security around our single SQL DB instance"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c9d3dc694f91bbdaa7bb2c1d8c87fd21a7342c8", "author": {"user": {"login": "mikechoch", "name": "Michael DiCioccio"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/8c9d3dc694f91bbdaa7bb2c1d8c87fd21a7342c8", "committedDate": "2020-06-09T18:22:26Z", "message": "Forgot to change `Throwable` to `SQLException` instead\n* Fixed within `OSInAppMessageRepository.java`"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3NDM4MDgw", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1050#pullrequestreview-427438080", "createdAt": "2020-06-09T18:37:16Z", "commit": {"oid": "8c9d3dc694f91bbdaa7bb2c1d8c87fd21a7342c8"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxODozNzoxNlrOGhXXJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxODozODoxM1rOGhXZJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzYzODk0OQ==", "bodyText": "maybe move it to the IAM Repository file?", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1050#discussion_r437638949", "createdAt": "2020-06-09T18:37:16Z", "author": {"login": "Jeasmine"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignalCacheCleaner.java", "diffHunk": "@@ -1,24 +1,19 @@\n package com.onesignal;\n \n-import com.onesignal.OneSignalDbContract.NotificationTable;\n-import com.onesignal.influence.model.OSInfluenceChannel;\n-import com.onesignal.outcomes.OSOutcomeTableProvider;\n-\n import android.content.Context;\n-import android.database.Cursor;\n+import android.database.SQLException;\n import android.database.sqlite.SQLiteDatabase;\n import android.os.Process;\n import android.support.annotation.WorkerThread;\n \n-import org.json.JSONArray;\n-import org.json.JSONException;\n-\n-import java.util.Set;\n+import com.onesignal.OneSignalDbContract.NotificationTable;\n+import com.onesignal.influence.model.OSInfluenceChannel;\n+import com.onesignal.outcomes.OSOutcomeTableProvider;\n \n class OneSignalCacheCleaner {\n \n     private final static long NOTIFICATION_CACHE_DATA_LIFETIME = 604_800L; // 7 days in seconds\n-    private final static long IAM_CACHE_DATA_LIFETIME = 15_552_000L; // 6 months in seconds\n+    final static long IAM_CACHE_DATA_LIFETIME = 15_552_000L; // 6 months in seconds", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c9d3dc694f91bbdaa7bb2c1d8c87fd21a7342c8"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzYzOTQ2Mg==", "bodyText": "maybe access it throw OneSignal.java? or add it to the method params? because there should be already a repository instance alive if we have more that one instance then te synchronized won't work", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1050#discussion_r437639462", "createdAt": "2020-06-09T18:38:13Z", "author": {"login": "Jeasmine"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignalCacheCleaner.java", "diffHunk": "@@ -61,73 +66,13 @@ public void run() {\n      * 3. Use queried data to clean SharedPreferences\n      */\n     @WorkerThread\n-    synchronized static void cleanCachedInAppMessages(final SQLiteDatabase writableDb) {\n+    synchronized static void cleanCachedInAppMessages(final OneSignalDbHelper dbHelper) {\n         new Thread(new Runnable() {\n             @Override\n             public void run() {\n                 Thread.currentThread().setPriority(Process.THREAD_PRIORITY_BACKGROUND);\n-\n-                // 1. Query for all old message ids and old clicked click ids\n-                String[] retColumns = new String[]{\n-                        OneSignalDbContract.InAppMessageTable.COLUMN_NAME_MESSAGE_ID,\n-                        OneSignalDbContract.InAppMessageTable.COLUMN_CLICK_IDS\n-                };\n-\n-                String whereStr = OneSignalDbContract.InAppMessageTable.COLUMN_NAME_LAST_DISPLAY + \" < ?\";\n-\n-                String sixMonthsAgoInSeconds = String.valueOf((System.currentTimeMillis() / 1_000L) - IAM_CACHE_DATA_LIFETIME);\n-                String[] whereArgs = new String[]{sixMonthsAgoInSeconds};\n-\n-                Set<String> oldMessageIds = OSUtils.newConcurrentSet();\n-                Set<String> oldClickedClickIds = OSUtils.newConcurrentSet();\n-\n-                Cursor cursor = null;\n-                try {\n-                    cursor = writableDb.query(OneSignalDbContract.InAppMessageTable.TABLE_NAME,\n-                            retColumns,\n-                            whereStr,\n-                            whereArgs,\n-                            null,\n-                            null,\n-                            null);\n-\n-                    if (cursor == null || cursor.getCount() == 0) {\n-                        OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, \"Attempted to clean 6 month old IAM data, but none exists!\");\n-                        return;\n-                    }\n-\n-                    // From cursor get all of the old message ids and old clicked click ids\n-                    if (cursor.moveToFirst()) {\n-                        do {\n-                            String oldMessageId = cursor.getString(\n-                                    cursor.getColumnIndex(\n-                                            OneSignalDbContract.InAppMessageTable.COLUMN_NAME_MESSAGE_ID));\n-                            String oldClickIds = cursor.getString(\n-                                    cursor.getColumnIndex(\n-                                            OneSignalDbContract.InAppMessageTable.COLUMN_CLICK_IDS));\n-\n-                            oldMessageIds.add(oldMessageId);\n-                            oldClickedClickIds.addAll(OSUtils.newStringSetFromJSONArray(new JSONArray(oldClickIds)));\n-                        } while (cursor.moveToNext());\n-                    }\n-                } catch (JSONException e) {\n-                    e.printStackTrace();\n-                } finally {\n-                    if (cursor != null && !cursor.isClosed())\n-                        cursor.close();\n-                }\n-\n-                // 2. Delete old IAMs from SQL\n-                writableDb.delete(\n-                        OneSignalDbContract.InAppMessageTable.TABLE_NAME,\n-                        whereStr,\n-                        whereArgs);\n-\n-                // 3. Use queried data to clean SharedPreferences\n-                cleanInAppMessageIds(oldMessageIds);\n-                cleanInAppMessageClickedClickIds(oldClickedClickIds);\n+                new OSInAppMessageRepository(dbHelper).cleanCachedInAppMessages();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c9d3dc694f91bbdaa7bb2c1d8c87fd21a7342c8"}, "originalPosition": 130}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bbabeabb9e8b63fb2ed94cc0e85e7bd19215e218", "author": {"user": {"login": "mikechoch", "name": "Michael DiCioccio"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/bbabeabb9e8b63fb2ed94cc0e85e7bd19215e218", "committedDate": "2020-06-10T20:53:44Z", "message": "Using singleton `OSInAppMessageController.java` instead of new\n* Created singleton based `getInAppMessageRepository` method inside of `OSInAppMessageController.java` class\n* This allows the synchronized to apply to multiple methods being called from the class instance\n* Deleted unused thread name since new Thread was moved toi cache cleaning file with different thread name now"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df4ce782a8fb511c6d68134bb27b6af29181bd4b", "author": {"user": {"login": "mikechoch", "name": "Michael DiCioccio"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/df4ce782a8fb511c6d68134bb27b6af29181bd4b", "committedDate": "2020-06-10T20:56:45Z", "message": "Needed to change defaults again for `getStringSet`\n* `OneSignalCacheCleaner.java` was rearranged a bit and it caused conflicts\n* `OSInAppMessageRepository.java` now has those correct changes an the default was flipped `OSUtils.<String>newConcurrentSet()` to `null`"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "53c86e58f11fb14a244e4239f072f1fc65c40a97", "author": {"user": {"login": "mikechoch", "name": "Michael DiCioccio"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/53c86e58f11fb14a244e4239f072f1fc65c40a97", "committedDate": "2020-06-10T20:57:27Z", "message": "Merge branch 'master' into fix/sql_db_lock_added_more_transactions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "27d22f1e956e0a36c2c38581c02fbc796a404cd2", "author": {"user": {"login": "mikechoch", "name": "Michael DiCioccio"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/27d22f1e956e0a36c2c38581c02fbc796a404cd2", "committedDate": "2020-06-10T21:34:54Z", "message": "Reverted to new instance within `initRedisplayData`\n* Changed the `new OSInAppMessageRepository(dbHelper);` to `getInAppMessageRepository(dbHelper);` and it broke a UnitTest in Travis"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4NDQ4OTc0", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1050#pullrequestreview-428448974", "createdAt": "2020-06-10T21:41:54Z", "commit": {"oid": "bbabeabb9e8b63fb2ed94cc0e85e7bd19215e218"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQyMTo0MTo1NFrOGiHTsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQyMTo0MTo1NFrOGiHTsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQyNDQ5Ng==", "bodyText": "Tests are failing after this commit.\nIf you add OSInAppMessageRepository to StaticResetHelper.java I think it might fix the tests.", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1050#discussion_r438424496", "createdAt": "2020-06-10T21:41:54Z", "author": {"login": "jkasten2"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -122,8 +121,15 @@ protected OSInAppMessageController(OneSignalDbHelper dbHelper) {\n         initRedisplayData(dbHelper);\n     }\n \n+    OSInAppMessageRepository getInAppMessageRepository(OneSignalDbHelper dbHelper) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bbabeabb9e8b63fb2ed94cc0e85e7bd19215e218"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "42b98e6c4ff2f5eda15ecd68897bb0dd5858c42a", "author": {"user": {"login": "mikechoch", "name": "Michael DiCioccio"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/42b98e6c4ff2f5eda15ecd68897bb0dd5858c42a", "committedDate": "2020-06-10T22:06:26Z", "message": "Merge branch 'fix/sql_db_lock_added_more_transactions' of github.com:OneSignal/OneSignal-Android-SDK into fix/sql_db_lock_added_more_transactions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b7e6897f740a599f0edd1acdce9a07d568c130e", "author": {"user": {"login": "mikechoch", "name": "Michael DiCioccio"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/8b7e6897f740a599f0edd1acdce9a07d568c130e", "committedDate": "2020-06-10T22:20:51Z", "message": "Fixing travis tests\n* After comment added `OSInAppMessageController.java` into `StaticResetHelper.java`"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3a3caa6505244658f3f0be9d9196bb6475268b3", "author": {"user": {"login": "mikechoch", "name": "Michael DiCioccio"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/a3a3caa6505244658f3f0be9d9196bb6475268b3", "committedDate": "2020-06-11T02:33:16Z", "message": "Removed `StaticResetHelper.java` for `OSInAppMessageRepository.java`"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2feac9dbb75de8777357e462c1ef60629ce57130", "author": {"user": {"login": "mikechoch", "name": "Michael DiCioccio"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/2feac9dbb75de8777357e462c1ef60629ce57130", "committedDate": "2020-06-11T02:35:15Z", "message": "`IAM_CACHE_DATA_LIFETIME` moved to `OSInAppMessageRepository.java`"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4NTUzNzI1", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1050#pullrequestreview-428553725", "createdAt": "2020-06-11T02:38:28Z", "commit": {"oid": "2feac9dbb75de8777357e462c1ef60629ce57130"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4NTUzOTI5", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1050#pullrequestreview-428553929", "createdAt": "2020-06-11T02:39:10Z", "commit": {"oid": "2feac9dbb75de8777357e462c1ef60629ce57130"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3594, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}