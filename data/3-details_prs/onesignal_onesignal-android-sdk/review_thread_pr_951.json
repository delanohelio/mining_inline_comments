{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzczMDE4ODkw", "number": 951, "reviewThreads": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQyMDoxNzozM1rODfUbKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQyMToxNTo1NVrODi2sXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM0MTY3MDgzOnYy", "diffSide": "RIGHT", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQyMDoxNzozM1rOFo9LgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxNzo1OToyNVrOFpd4aw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ4OTcyOA==", "bodyText": "The source of newMessages is driven directly by the results from the  on_session network call . However the results from on_session is drive by the backend and if the player fits into the Segments defined there. So this means the same IAM could fall in and out of Segment multiple times which would result in the on_session not always have it either.\nSo we don't reset the display stats noted above we should only delete these local records after a long period of time to be safe or not at all. Can we set this to 6 months to be safe?", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/951#discussion_r378489728", "createdAt": "2020-02-12T20:17:33Z", "author": {"login": "jkasten2"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -154,16 +155,26 @@ void receivedInAppMessageJson(@NonNull JSONArray json) throws JSONException {\n         // Cache copy for quick cold starts\n         OneSignalPrefs.saveString(OneSignalPrefs.PREFS_ONESIGNAL,\n            OneSignalPrefs.PREFS_OS_CACHED_IAMS, json.toString());\n-        processInAppMessageJson(json);\n+        ArrayList<OSInAppMessage> newMessages = processInAppMessageJson(json);\n+\n+        List<OSInAppMessage> updatedRedisplayMessages = inAppMessageRepository.updateInAppMessage(newMessages, redisplayInAppMessages);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4aa2fe125ccc2924111ca0caa4514aa2af7fe80e"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTAyNTUxNQ==", "bodyText": "oh ok, i will address this on here and iOS. 6 Months seems like a logic time period", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/951#discussion_r379025515", "createdAt": "2020-02-13T17:59:25Z", "author": {"login": "Jeasmine"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -154,16 +155,26 @@ void receivedInAppMessageJson(@NonNull JSONArray json) throws JSONException {\n         // Cache copy for quick cold starts\n         OneSignalPrefs.saveString(OneSignalPrefs.PREFS_ONESIGNAL,\n            OneSignalPrefs.PREFS_OS_CACHED_IAMS, json.toString());\n-        processInAppMessageJson(json);\n+        ArrayList<OSInAppMessage> newMessages = processInAppMessageJson(json);\n+\n+        List<OSInAppMessage> updatedRedisplayMessages = inAppMessageRepository.updateInAppMessage(newMessages, redisplayInAppMessages);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ4OTcyOA=="}, "originalCommit": {"oid": "4aa2fe125ccc2924111ca0caa4514aa2af7fe80e"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM0NjEyMjE3OnYy", "diffSide": "RIGHT", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQwMDoyNzozNFrOFpoJ-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQwMDoyNzozNFrOFpoJ-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE5Mzg1MA==", "bodyText": "Remove space before ArrayList", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/951#discussion_r379193850", "createdAt": "2020-02-14T00:27:34Z", "author": {"login": "mikechoch"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -154,16 +155,26 @@ void receivedInAppMessageJson(@NonNull JSONArray json) throws JSONException {\n         // Cache copy for quick cold starts\n         OneSignalPrefs.saveString(OneSignalPrefs.PREFS_ONESIGNAL,\n            OneSignalPrefs.PREFS_OS_CACHED_IAMS, json.toString());\n-        processInAppMessageJson(json);\n+        ArrayList<OSInAppMessage> newMessages = processInAppMessageJson(json);\n+\n+        List<OSInAppMessage> updatedRedisplayMessages = inAppMessageRepository.updateInAppMessage(newMessages, redisplayInAppMessages);\n+        if (redisplayInAppMessages.size() != updatedRedisplayMessages.size()) {\n+            redisplayInAppMessages = updatedRedisplayMessages;\n+        }\n+        setMessages(newMessages);\n     }\n \n-    private void processInAppMessageJson(@NonNull JSONArray json) throws JSONException {\n+    private ArrayList<OSInAppMessage>  processInAppMessageJson(@NonNull JSONArray json) throws JSONException {\n         ArrayList<OSInAppMessage> newMessages = new ArrayList<>();\n         for (int i = 0; i < json.length(); i++) {\n             JSONObject messageJson = json.getJSONObject(i);\n             OSInAppMessage message = new OSInAppMessage(messageJson);\n             newMessages.add(message);\n         }\n+        return newMessages;\n+    }\n+\n+    private void setMessages( ArrayList<OSInAppMessage> newMessages) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4aa2fe125ccc2924111ca0caa4514aa2af7fe80e"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM0NjEyMjQ2OnYy", "diffSide": "RIGHT", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQwMDoyNzo0NlrOFpoKMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQwMDoyNzo0NlrOFpoKMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE5MzkwNQ==", "bodyText": "Add a space after //", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/951#discussion_r379193905", "createdAt": "2020-02-14T00:27:46Z", "author": {"login": "mikechoch"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -472,14 +483,14 @@ public void run() {\n \n         //Update the data to enable future re displays", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4aa2fe125ccc2924111ca0caa4514aa2af7fe80e"}, "originalPosition": 77}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM0NjEyMjY1OnYy", "diffSide": "RIGHT", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQwMDoyNzo1MlrOFpoKTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQwMDoyNzo1MlrOFpoKTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE5MzkzNQ==", "bodyText": "Add a space after //", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/951#discussion_r379193935", "createdAt": "2020-02-14T00:27:52Z", "author": {"login": "mikechoch"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -472,14 +483,14 @@ public void run() {\n \n         //Update the data to enable future re displays\n         //Avoid calling the repository data again", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4aa2fe125ccc2924111ca0caa4514aa2af7fe80e"}, "originalPosition": 78}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM0NjEyMzU5OnYy", "diffSide": "RIGHT", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQwMDoyODoyM1rOFpoK2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQwMDoyODoyM1rOFpoK2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE5NDA3NQ==", "bodyText": "* */ should just be */", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/951#discussion_r379194075", "createdAt": "2020-02-14T00:28:23Z", "author": {"login": "mikechoch"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -572,7 +583,7 @@ public void messageTriggerConditionChanged() {\n      * */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4aa2fe125ccc2924111ca0caa4514aa2af7fe80e"}, "originalPosition": 95}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1ODM2MzYwOnYy", "diffSide": "RIGHT", "path": "OneSignalSDK/unittest/src/test/java/com/test/onesignal/TestHelpers.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQwMToyODoxN1rOFrYRHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQwMzowMjoxN1rOFsA_fQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTAzMDY4Ng==", "bodyText": "This is duplicated, it exists in com.onesignal.OSInAppMessageRepository as well. Also I don't see this being called in the tests so I think we can remove this deleteOldInAppMessages method here.", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/951#discussion_r381030686", "createdAt": "2020-02-19T01:28:17Z", "author": {"login": "jkasten2"}, "path": "OneSignalSDK/unittest/src/test/java/com/test/onesignal/TestHelpers.java", "diffHunk": "@@ -373,6 +398,49 @@ else if (type == Cursor.FIELD_TYPE_FLOAT)\n       return iams;\n    }\n \n+   @WorkerThread\n+   static void deleteOldInAppMessages() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98824eae01729546ae6d237220789b6e60128a25"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTY5NzkxNw==", "bodyText": "good catch, this was used before but I changed it. TY!", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/951#discussion_r381697917", "createdAt": "2020-02-20T03:02:17Z", "author": {"login": "Jeasmine"}, "path": "OneSignalSDK/unittest/src/test/java/com/test/onesignal/TestHelpers.java", "diffHunk": "@@ -373,6 +398,49 @@ else if (type == Cursor.FIELD_TYPE_FLOAT)\n       return iams;\n    }\n \n+   @WorkerThread\n+   static void deleteOldInAppMessages() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTAzMDY4Ng=="}, "originalCommit": {"oid": "98824eae01729546ae6d237220789b6e60128a25"}, "originalPosition": 92}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1ODM2NDMxOnYy", "diffSide": "RIGHT", "path": "OneSignalSDK/unittest/src/test/java/com/test/onesignal/TestHelpers.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQwMToyODoyOFrOFrYRdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQwMToyODoyOFrOFrYRdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTAzMDc3Mw==", "bodyText": "This is duplicated, it exists in com.onesignal.OSInAppMessageRepository as well. Also I don't see this being called in the tests so I think we can remove this deleteInAppMessage method here.", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/951#discussion_r381030773", "createdAt": "2020-02-19T01:28:28Z", "author": {"login": "jkasten2"}, "path": "OneSignalSDK/unittest/src/test/java/com/test/onesignal/TestHelpers.java", "diffHunk": "@@ -373,6 +398,49 @@ else if (type == Cursor.FIELD_TYPE_FLOAT)\n       return iams;\n    }\n \n+   @WorkerThread\n+   static void deleteOldInAppMessages() {\n+      SQLiteDatabase readableDb = OneSignalDbHelper.getInstance(RuntimeEnvironment.application).getReadableDatabase();\n+      Cursor cursor = readableDb.query(\n+              OneSignalPackagePrivateHelper.InAppMessageTable.TABLE_NAME,\n+              null,\n+              OneSignalPackagePrivateHelper.InAppMessageTable.COLUMN_NAME_LAST_DISPLAY + \">?\",\n+              new String[]{String.valueOf(SIX_MONTHS_TIME_SECONDS)},\n+              null,\n+              null,\n+              null\n+      );\n+\n+      if (cursor.moveToFirst()) {\n+         do {\n+            String idToRemove = cursor.getString(cursor.getColumnIndex(OneSignalPackagePrivateHelper.InAppMessageTable.COLUMN_NAME_MESSAGE_ID));\n+            deleteInAppMessage(idToRemove);\n+         } while (cursor.moveToNext());\n+      }\n+\n+      if (!cursor.isClosed())\n+         cursor.close();\n+   }\n+\n+   static void deleteInAppMessage(String messageId) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98824eae01729546ae6d237220789b6e60128a25"}, "originalPosition": 115}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1ODM2NzU3OnYy", "diffSide": "RIGHT", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageRepository.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQwMTozMDoxOVrOFrYTZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQwMzoxMDozOVrOFsBQMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTAzMTI2OA==", "bodyText": "We could use a writable db here and performance a single write. Instead getting a list of ids then doing a delete on each record one at a time.", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/951#discussion_r381031268", "createdAt": "2020-02-19T01:30:19Z", "author": {"login": "jkasten2"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageRepository.java", "diffHunk": "@@ -15,12 +16,40 @@\n \n class OSInAppMessageRepository {\n \n+    private static final long SIX_MONTHS_TIME_SECONDS = 6 * 30 * 24 * 60 * 60;\n     private final OneSignalDbHelper dbHelper;\n \n     OSInAppMessageRepository(OneSignalDbHelper dbHelper) {\n         this.dbHelper = dbHelper;\n     }\n \n+    /**\n+     * Remove IAMs that the last display time was six month ago\n+     */\n+    @WorkerThread\n+    void deleteOldInAppMessages(long dateInSeconds) {\n+        SQLiteDatabase readableDb = dbHelper.getReadableDbWithRetries();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98824eae01729546ae6d237220789b6e60128a25"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTcwMjE5Mg==", "bodyText": "Absolutely right", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/951#discussion_r381702192", "createdAt": "2020-02-20T03:10:39Z", "author": {"login": "Jeasmine"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageRepository.java", "diffHunk": "@@ -15,12 +16,40 @@\n \n class OSInAppMessageRepository {\n \n+    private static final long SIX_MONTHS_TIME_SECONDS = 6 * 30 * 24 * 60 * 60;\n     private final OneSignalDbHelper dbHelper;\n \n     OSInAppMessageRepository(OneSignalDbHelper dbHelper) {\n         this.dbHelper = dbHelper;\n     }\n \n+    /**\n+     * Remove IAMs that the last display time was six month ago\n+     */\n+    @WorkerThread\n+    void deleteOldInAppMessages(long dateInSeconds) {\n+        SQLiteDatabase readableDb = dbHelper.getReadableDbWithRetries();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTAzMTI2OA=="}, "originalCommit": {"oid": "98824eae01729546ae6d237220789b6e60128a25"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3ODczNDYwOnYy", "diffSide": "RIGHT", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQyMToxMzozNVrOFuVZFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQyMToxMzozNVrOFuVZFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDEyOTMwMQ==", "bodyText": "Change the tag associated with the thread, this is not a save action is it?", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/951#discussion_r384129301", "createdAt": "2020-02-25T21:13:35Z", "author": {"login": "mikechoch"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -144,6 +145,15 @@ void receivedInAppMessageJson(@NonNull JSONArray json) throws JSONException {\n         OneSignalPrefs.saveString(OneSignalPrefs.PREFS_ONESIGNAL,\n            OneSignalPrefs.PREFS_OS_CACHED_IAMS, json.toString());\n         processInAppMessageJson(json);\n+\n+        // Remove cache redisplayed messages\n+        new Thread(new Runnable() {\n+            @Override\n+            public void run() {\n+                Thread.currentThread().setPriority(Process.THREAD_PRIORITY_BACKGROUND);\n+                inAppMessageRepository.deleteOldRedisplayedInAppMessages();\n+            }\n+        }, OS_SAVE_IN_APP_MESSAGE).start();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fa4b08bf82ca12f0f98685a7e57c156af9aff9ed"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3ODczOTU1OnYy", "diffSide": "RIGHT", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageDisplayStats.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQyMToxNTowN1rOFuVcGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQyMToxNTowN1rOFuVcGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDEzMDA3NQ==", "bodyText": "Space after //", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/951#discussion_r384130075", "createdAt": "2020-02-25T21:15:07Z", "author": {"login": "mikechoch"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageDisplayStats.java", "diffHunk": "@@ -87,13 +87,10 @@ boolean shouldDisplayAgain() {\n     }\n \n     boolean isDelayTimeSatisfied() {\n-        long currentTimeInSeconds = System.currentTimeMillis() / 1000;\n-\n         if (lastDisplayTime < 0) {\n-            lastDisplayTime = currentTimeInSeconds;\n             return true;\n         }\n-\n+        long currentTimeInSeconds = System.currentTimeMillis() / 1000;\n         //Calculate gap between display times", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fa4b08bf82ca12f0f98685a7e57c156af9aff9ed"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3ODc0MjcxOnYy", "diffSide": "RIGHT", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageRepository.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQyMToxNTo1NVrOFuVd6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQyMToxNTo1NVrOFuVd6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDEzMDUzOQ==", "bodyText": "Space between <? -> < ?", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/951#discussion_r384130539", "createdAt": "2020-02-25T21:15:55Z", "author": {"login": "mikechoch"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageRepository.java", "diffHunk": "@@ -15,32 +15,24 @@\n \n class OSInAppMessageRepository {\n \n+    private static final long SIX_MONTHS_TIME_SECONDS = 6 * 30 * 24 * 60 * 60;\n     private final OneSignalDbHelper dbHelper;\n \n     OSInAppMessageRepository(OneSignalDbHelper dbHelper) {\n         this.dbHelper = dbHelper;\n     }\n \n+    /**\n+     * Remove IAMs that the last display time was six month ago\n+     */\n     @WorkerThread\n-    synchronized void deleteInAppMessage(String messageId) {\n+    synchronized void deleteOldRedisplayedInAppMessages() {\n+        long sixMonthsAgo = System.currentTimeMillis() / 1000 - SIX_MONTHS_TIME_SECONDS;\n         SQLiteDatabase writableDb = dbHelper.getWritableDbWithRetries();\n-\n-        try {\n-            writableDb.beginTransaction();\n-            writableDb.delete(OneSignalDbContract.InAppMessageTable.TABLE_NAME,\n-                    OneSignalDbContract.InAppMessageTable.COLUMN_NAME_MESSAGE_ID + \" = ?\", new String[]{messageId});\n-            writableDb.setTransactionSuccessful();\n-        } catch (Throwable t) {\n-            OneSignal.Log(OneSignal.LOG_LEVEL.ERROR, \"Error deleting in app message! \", t);\n-        } finally {\n-            if (writableDb != null) {\n-                try {\n-                    writableDb.endTransaction(); // May throw if transaction was never opened or DB is full.\n-                } catch (Throwable t) {\n-                    OneSignal.Log(OneSignal.LOG_LEVEL.ERROR, \"Error closing transaction! \", t);\n-                }\n-            }\n-        }\n+        writableDb.delete(OneSignalDbContract.InAppMessageTable.TABLE_NAME,\n+                OneSignalDbContract.InAppMessageTable.COLUMN_NAME_LAST_DISPLAY + \"<?\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fa4b08bf82ca12f0f98685a7e57c156af9aff9ed"}, "originalPosition": 37}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2187, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}