{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg4OTQxMTAy", "number": 1153, "title": "Fix setRequiresUserPrivacyConsent race condition", "bodyText": "Fixes issue where setRequiresUserPrivacyConsent(true) may not apply in time to prevent a player create from happening when called before the SDK initializes.\nRecommend reviewing commit-by-commit\n\nThis change is\u2002", "createdAt": "2020-09-17T21:26:51Z", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1153", "merged": true, "mergeCommit": {"oid": "b302e69241af9fbd0dbf1400666f883fbe28b9bf"}, "closed": true, "closedAt": "2020-09-22T22:45:22Z", "author": {"login": "jkasten2"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdJ6DBggBqjM3ODAzNDk0NDU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLfvibgFqTQ5Mzg5MDE2MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "30419bb6014db255acd5629d4d0d8db2adfb2ff8", "author": {"user": {"login": "jkasten2", "name": "Josh Kasten"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/30419bb6014db255acd5629d4d0d8db2adfb2ff8", "committedDate": "2020-09-17T21:25:40Z", "message": "Added test to reproduce PrivacyConsent issue"}, "afterCommit": {"oid": "00fc19fc6dbf0dd6a58ec9e5955dfba10bee9c2d", "author": {"user": {"login": "jkasten2", "name": "Josh Kasten"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/00fc19fc6dbf0dd6a58ec9e5955dfba10bee9c2d", "committedDate": "2020-09-18T00:00:05Z", "message": "Added test to reproduce PrivacyConsent issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69084b774158c679fb329b1669b69e497f50a31e", "author": {"user": {"login": "jkasten2", "name": "Josh Kasten"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/69084b774158c679fb329b1669b69e497f50a31e", "committedDate": "2020-09-21T20:11:56Z", "message": "Added test to reproduce PrivacyConsent issue"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "00fc19fc6dbf0dd6a58ec9e5955dfba10bee9c2d", "author": {"user": {"login": "jkasten2", "name": "Josh Kasten"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/00fc19fc6dbf0dd6a58ec9e5955dfba10bee9c2d", "committedDate": "2020-09-18T00:00:05Z", "message": "Added test to reproduce PrivacyConsent issue"}, "afterCommit": {"oid": "69084b774158c679fb329b1669b69e497f50a31e", "author": {"user": {"login": "jkasten2", "name": "Josh Kasten"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/69084b774158c679fb329b1669b69e497f50a31e", "committedDate": "2020-09-21T20:11:56Z", "message": "Added test to reproduce PrivacyConsent issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c48bf3afd002a41ef784ac32b9a31c020676dfd", "author": {"user": {"login": "jkasten2", "name": "Josh Kasten"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/4c48bf3afd002a41ef784ac32b9a31c020676dfd", "committedDate": "2020-09-21T20:43:45Z", "message": "Removed default requires_user_privacy_consent\n\n* Removed this default remote param as it isn't included in the REST API\nresponse today from the backend.\n  - Updated 2 tests that were expecting default false being there.\n* setRequiresUserPrivacyConsent_withTrue_CalledFirst_DoesNOTCreatePlayer\nadded in the last commit now fails as a repo case than we can now fix\nin a future commit"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "70974f327c99d4e68611b8cfe52166ce2c44cd6c", "author": {"user": {"login": "jkasten2", "name": "Josh Kasten"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/70974f327c99d4e68611b8cfe52166ce2c44cd6c", "committedDate": "2020-09-21T20:26:32Z", "message": "Removed default requires_user_privacy_consent\n\n* Removed this default remote param as it isn't included in the REST API\nresponse today from the backend.\n* setRequiresUserPrivacyConsent_withTrue_CalledFirst_DoesNOTCreatePlayer\nadded in the last commit now fails as a repo case than we can now fix\nin a future commit"}, "afterCommit": {"oid": "4c48bf3afd002a41ef784ac32b9a31c020676dfd", "author": {"user": {"login": "jkasten2", "name": "Josh Kasten"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/4c48bf3afd002a41ef784ac32b9a31c020676dfd", "committedDate": "2020-09-21T20:43:45Z", "message": "Removed default requires_user_privacy_consent\n\n* Removed this default remote param as it isn't included in the REST API\nresponse today from the backend.\n  - Updated 2 tests that were expecting default false being there.\n* setRequiresUserPrivacyConsent_withTrue_CalledFirst_DoesNOTCreatePlayer\nadded in the last commit now fails as a repo case than we can now fix\nin a future commit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc50858dcc631bb3223123af04a0985081ab195c", "author": {"user": {"login": "jkasten2", "name": "Josh Kasten"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/bc50858dcc631bb3223123af04a0985081ab195c", "committedDate": "2020-09-21T21:35:16Z", "message": "Removed setRequiresUserPrivacyConsent pre-init\n\n* This extra check sometimes delays setting requiresUserPrivacyConsent\nto long where the player create call has already kicked off.\n* If the remote params call finishes later and contains the\nrequires_user_privacy_consent key it can still override."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNTM5NTcy", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1153#pullrequestreview-493539572", "createdAt": "2020-09-22T14:44:25Z", "commit": {"oid": "4c48bf3afd002a41ef784ac32b9a31c020676dfd"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNDo0NDoyNVrOHV9uhg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNDo0NzoxOFrOHV93yQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc5MzQ3OA==", "bodyText": "there is a method for doing this under ShadowOneSignalRestClient\nsetRemoteParamsRequirePrivacyConsent", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1153#discussion_r492793478", "createdAt": "2020-09-22T14:44:25Z", "author": {"login": "Jeasmine"}, "path": "OneSignalSDK/unittest/src/test/java/com/test/onesignal/RemoteParamsTests.java", "diffHunk": "@@ -150,7 +150,9 @@ public void testUserPrivacyConsentRequired_UserConfigurationOverrideByRemotePara\n \n     @Test\n     public void testUserPrivacyConsentNotRequired_UserConfigurationOverrideByRemoteParams() throws Exception {\n-        ShadowOneSignalRestClient.setRemoteParamsGetHtmlResponse();\n+        JSONObject remoteParams = new JSONObject();\n+        remoteParams.put(\"requires_user_privacy_consent\", false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c48bf3afd002a41ef784ac32b9a31c020676dfd"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc5NTg0OQ==", "bodyText": "what will happen if the user put setRequiresUserPrivacyConsent as false, and then remote params comes with requiresUserPrivacyConsent as true?", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1153#discussion_r492795849", "createdAt": "2020-09-22T14:47:18Z", "author": {"login": "Jeasmine"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OneSignal.java", "diffHunk": "@@ -1012,19 +1012,6 @@ public static boolean requiresUserPrivacyConsent() {\n     * This method will be replaced by remote params set\n     */\n    public static void setRequiresUserPrivacyConsent(final boolean required) {\n-      if (taskController.shouldQueueTaskForInit(OSTaskController.SET_REQUIRES_USER_PRIVACY_CONSENT)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc50858dcc631bb3223123af04a0985081ab195c"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7834920d5fc5e3584b260b39a910a2c49f73a0d", "author": {"user": {"login": "jkasten2", "name": "Josh Kasten"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/e7834920d5fc5e3584b260b39a910a2c49f73a0d", "committedDate": "2020-09-22T18:45:36Z", "message": "fixup! Removed default requires_user_privacy_consent"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eaf2db6b1bbac5ad34ac59e146989a7e12f0308d", "author": {"user": {"login": "jkasten2", "name": "Josh Kasten"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/eaf2db6b1bbac5ad34ac59e146989a7e12f0308d", "committedDate": "2020-09-22T18:51:35Z", "message": "fixup! Removed setRequiresUserPrivacyConsent pre-init"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzODYxNDQ1", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1153#pullrequestreview-493861445", "createdAt": "2020-09-22T21:30:47Z", "commit": {"oid": "eaf2db6b1bbac5ad34ac59e146989a7e12f0308d"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMTozMDo0N1rOHWNGOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMTo1Njo0N1rOHWNy5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA0NTMwNw==", "bodyText": "change to  ShadowOneSignalRestClient.setRemoteParamsRequirePrivacyConsent(false);", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1153#discussion_r493045307", "createdAt": "2020-09-22T21:30:47Z", "author": {"login": "Jeasmine"}, "path": "OneSignalSDK/unittest/src/test/java/com/test/onesignal/RemoteParamsTests.java", "diffHunk": "@@ -174,7 +172,9 @@ public void testUserPrivacyConsentRequired_UserConfigurationNotOverrideRemotePar\n \n     @Test\n     public void testUserPrivacyConsentNotRequired_UserConfigurationNotOverrideRemoteParams() throws Exception {\n-        ShadowOneSignalRestClient.setRemoteParamsGetHtmlResponse();\n+        JSONObject remoteParams = new JSONObject();\n+        remoteParams.put(\"requires_user_privacy_consent\", false);\n+        ShadowOneSignalRestClient.setRemoteParamsGetHtmlResponse(remoteParams);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eaf2db6b1bbac5ad34ac59e146989a7e12f0308d"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA1Njc0Mw==", "bodyText": "will this still work if only depending on remote params? I suppose that yes because of the test setting false and being true from remote params, but just checking", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1153#discussion_r493056743", "createdAt": "2020-09-22T21:56:47Z", "author": {"login": "Jeasmine"}, "path": "OneSignalSDK/unittest/src/test/java/com/test/onesignal/OneSignalInitializationIntegrationTestsRunner.java", "diffHunk": "@@ -0,0 +1,85 @@\n+package com.test.onesignal;\r\n+\r\n+import androidx.test.core.app.ApplicationProvider;\r\n+\r\n+import com.onesignal.OneSignal;\r\n+import com.onesignal.ShadowCustomTabsClient;\r\n+import com.onesignal.ShadowCustomTabsSession;\r\n+import com.onesignal.ShadowOSUtils;\r\n+import com.onesignal.ShadowOneSignalRestClient;\r\n+import com.onesignal.ShadowPushRegistratorFCM;\r\n+import com.onesignal.StaticResetHelper;\r\n+import com.onesignal.example.BlankActivity;\r\n+\r\n+import org.junit.Before;\r\n+import org.junit.BeforeClass;\r\n+import org.junit.Test;\r\n+import org.junit.runner.RunWith;\r\n+import org.robolectric.Robolectric;\r\n+import org.robolectric.RobolectricTestRunner;\r\n+import org.robolectric.android.controller.ActivityController;\r\n+import org.robolectric.annotation.Config;\r\n+import org.robolectric.shadows.ShadowLog;\r\n+\r\n+import static com.onesignal.ShadowOneSignalRestClient.setRemoteParamsGetHtmlResponse;\r\n+import static com.test.onesignal.TestHelpers.threadAndTaskWait;\r\n+\r\n+@Config(\r\n+        packageName = \"com.onesignal.example\",\r\n+        shadows = {\r\n+            ShadowOSUtils.class,\r\n+            ShadowOneSignalRestClient.class,\r\n+            ShadowPushRegistratorFCM.class,\r\n+            ShadowCustomTabsClient.class,\r\n+            ShadowCustomTabsSession.class,\r\n+        },\r\n+        sdk = 26\r\n+)\r\n+\r\n+@RunWith(RobolectricTestRunner.class)\r\n+public class OneSignalInitializationIntegrationTestsRunner {\r\n+    private ActivityController<BlankActivity> blankActivityController;\r\n+\r\n+    @BeforeClass // Runs only once, before any tests\r\n+    public static void setUpClass() throws Exception {\r\n+        ShadowLog.stream = System.out;\r\n+        TestHelpers.beforeTestSuite();\r\n+        StaticResetHelper.saveStaticValues();\r\n+    }\r\n+\r\n+    @Before\r\n+    public void beforeEachTest() throws Exception {\r\n+        TestHelpers.beforeTestInitAndCleanup();\r\n+        setRemoteParamsGetHtmlResponse();\r\n+        blankActivityController = Robolectric.buildActivity(BlankActivity.class).create();\r\n+    }\r\n+\r\n+    private static final String APP_ID = \"11111111-2222-3333-4444-55555555555\";\r\n+    private static void helper_OneSignal_initWithAppContext() {\r\n+        OneSignal.initWithContext(ApplicationProvider.getApplicationContext());\r\n+    }\r\n+\r\n+    @Test\r\n+    public void setRequiresUserPrivacyConsent_withTrue_CalledFirst_DoesNOTCreatePlayer() throws Exception {\r\n+        OneSignal.setRequiresUserPrivacyConsent(true);\r\n+\r\n+        OneSignal.setAppId(APP_ID);\r\n+        helper_OneSignal_initWithAppContext();\r\n+        threadAndTaskWait();\r\n+\r\n+        RestClientAsserts.assertRemoteParamsWasTheOnlyNetworkCall();\r\n+    }\r\n+\r\n+    @Test\r\n+    public void setRequiresUserPrivacyConsent_withFalseAndRemoteTrue_DoesNOTCreatePlayer() throws Exception {\r\n+        ShadowOneSignalRestClient.setRemoteParamsRequirePrivacyConsent(true);\r\n+        OneSignal.setRequiresUserPrivacyConsent(false);\r\n+\r\n+        OneSignal.setAppId(APP_ID);\r\n+        helper_OneSignal_initWithAppContext();\r\n+        threadAndTaskWait();\r\n+\r\n+        RestClientAsserts.assertRemoteParamsWasTheOnlyNetworkCall();\r\n+    }\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eaf2db6b1bbac5ad34ac59e146989a7e12f0308d"}, "originalPosition": 83}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a6b8828738abe803f38d6014d6969ca8a6c4753", "author": {"user": {"login": "jkasten2", "name": "Josh Kasten"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/8a6b8828738abe803f38d6014d6969ca8a6c4753", "committedDate": "2020-09-22T22:25:53Z", "message": "Test clean up of requires_user_privacy_consent"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzODkwMTYx", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1153#pullrequestreview-493890161", "createdAt": "2020-09-22T22:29:23Z", "commit": {"oid": "8a6b8828738abe803f38d6014d6969ca8a6c4753"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3437, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}