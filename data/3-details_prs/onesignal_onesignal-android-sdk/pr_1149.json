{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg3NDkwODgw", "number": 1149, "title": "Fix IAM not being redisplay by session duration", "bodyText": "Dynamic triggers weren't being scheduled on the second pass due to !dismissedMessages.contains(message.messageId) check being call before evaluateMessageTriggers, and this is not reset until setDataForRedisplay evaluates to true. If evaluateMessageTriggers is not called then dynamic triggers aren't scheduled\nDynamic triggers weren't calling makeRedisplayMessagesAvailableWithTriggers, so no redisplay logic was being handled\nAdd better debug logging\n\nImprovements:\npopulateRedisplayMessagesTriggers, to avoid iterating over messages, iterate only over redisplay messages. Redisplay messages on the worst case will be O(n)\nUse Cases:\nDisplay IAM after the user is 30 seconds on the app every day.\nDisplay IAM 5 seconds after last IAM, every day.\nWarnings:\nIf the user has an IAM with session duration or last IAM with a short-timer period and short redisplay delay, this might end on IAM displaying multiple times in the same session.\nReset dynamic session launch time\n\nIf the user puts the app on the background and opens the app after 30 seconds, on a new session, the session launch time was not being reset and due to that IAM with redisplay was being shown immediately.\nWhen a new session is started, reset session launch time. This will make IAM with session time trigger and redisplay work properly\nRefactor IAM Controller getController to avoid static reference\n\n\nThis change is\u2002", "createdAt": "2020-09-15T18:53:23Z", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1149", "merged": true, "mergeCommit": {"oid": "cfb5574b7806ecbc19a3464dad45208225f0fd0f"}, "closed": true, "closedAt": "2020-09-29T18:53:23Z", "author": {"login": "Jeasmine"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdJMkMigBqjM3Njk4Njc3OTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdNbG0SAFqTQ5NzkzNTk5Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b2a0293aa74f03a3e5787fcc4c74efe20d173fc8", "author": {"user": {"login": "Jeasmine", "name": "JNahui"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/b2a0293aa74f03a3e5787fcc4c74efe20d173fc8", "committedDate": "2020-09-15T18:51:13Z", "message": "Fix IAM not being redisplay by SESSION DURATION\n\n* Dynamic triggers weren't being scheduled on second pass due to !dismissedMessages.contains(message.messageId) check before evaluateMessageTriggers\n* Dynamic trigger weren't calling makeRedisplayMessagesAvailableWithTriggers, so no redisplay logic was being handle"}, "afterCommit": {"oid": "94b4e5909a985f4d891011200ea6f712e8e59576", "author": {"user": {"login": "Jeasmine", "name": "JNahui"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/94b4e5909a985f4d891011200ea6f712e8e59576", "committedDate": "2020-09-15T19:00:43Z", "message": "Fix IAM not being redisplay by SESSION DURATION\n\n* Dynamic triggers weren't being scheduled on second pass due to !dismissedMessages.contains(message.messageId) check before evaluateMessageTriggers\n* Dynamic trigger weren't calling makeRedisplayMessagesAvailableWithTriggers, so no redisplay logic was being handle"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "94b4e5909a985f4d891011200ea6f712e8e59576", "author": {"user": {"login": "Jeasmine", "name": "JNahui"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/94b4e5909a985f4d891011200ea6f712e8e59576", "committedDate": "2020-09-15T19:00:43Z", "message": "Fix IAM not being redisplay by SESSION DURATION\n\n* Dynamic triggers weren't being scheduled on second pass due to !dismissedMessages.contains(message.messageId) check before evaluateMessageTriggers\n* Dynamic trigger weren't calling makeRedisplayMessagesAvailableWithTriggers, so no redisplay logic was being handle"}, "afterCommit": {"oid": "7802af94c4c8de458a68d48df544d8b29fc020ce", "author": {"user": {"login": "Jeasmine", "name": "JNahui"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/7802af94c4c8de458a68d48df544d8b29fc020ce", "committedDate": "2020-09-15T19:05:41Z", "message": "Fix IAM not being redisplay by SESSION DURATION\n\n* Dynamic triggers weren't being scheduled on the second pass due to !dismissedMessages.contains(message.messageId) check being call before evaluateMessageTriggers, and this is not reset until setDataForRedisplay evaluates to true. If evaluateMessageTriggers is not called then dynamic triggers aren't scheduled\n* Dynamic triggers weren't calling makeRedisplayMessagesAvailableWithTriggers, so no redisplay logic was being handled\n* Add better debug logging"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7802af94c4c8de458a68d48df544d8b29fc020ce", "author": {"user": {"login": "Jeasmine", "name": "JNahui"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/7802af94c4c8de458a68d48df544d8b29fc020ce", "committedDate": "2020-09-15T19:05:41Z", "message": "Fix IAM not being redisplay by SESSION DURATION\n\n* Dynamic triggers weren't being scheduled on the second pass due to !dismissedMessages.contains(message.messageId) check being call before evaluateMessageTriggers, and this is not reset until setDataForRedisplay evaluates to true. If evaluateMessageTriggers is not called then dynamic triggers aren't scheduled\n* Dynamic triggers weren't calling makeRedisplayMessagesAvailableWithTriggers, so no redisplay logic was being handled\n* Add better debug logging"}, "afterCommit": {"oid": "fb1cc40bbc8c9f44033859fd0377f6f532f3c395", "author": {"user": {"login": "Jeasmine", "name": "JNahui"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/fb1cc40bbc8c9f44033859fd0377f6f532f3c395", "committedDate": "2020-09-16T00:18:31Z", "message": "Fix IAM not being redisplay by SESSION DURATION\n\n* Dynamic triggers weren't being scheduled on the second pass due to !dismissedMessages.contains(message.messageId) check being call before evaluateMessageTriggers, and this is not reset until setDataForRedisplay evaluates to true. If evaluateMessageTriggers is not called then dynamic triggers aren't scheduled\n* Dynamic triggers weren't calling makeRedisplayMessagesAvailableWithTriggers, so no redisplay logic was being handled\n* Add better debug logging"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fb1cc40bbc8c9f44033859fd0377f6f532f3c395", "author": {"user": {"login": "Jeasmine", "name": "JNahui"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/fb1cc40bbc8c9f44033859fd0377f6f532f3c395", "committedDate": "2020-09-16T00:18:31Z", "message": "Fix IAM not being redisplay by SESSION DURATION\n\n* Dynamic triggers weren't being scheduled on the second pass due to !dismissedMessages.contains(message.messageId) check being call before evaluateMessageTriggers, and this is not reset until setDataForRedisplay evaluates to true. If evaluateMessageTriggers is not called then dynamic triggers aren't scheduled\n* Dynamic triggers weren't calling makeRedisplayMessagesAvailableWithTriggers, so no redisplay logic was being handled\n* Add better debug logging"}, "afterCommit": {"oid": "1574233fd84f4470beb3c4e83c4428b33581067e", "author": {"user": {"login": "Jeasmine", "name": "JNahui"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/1574233fd84f4470beb3c4e83c4428b33581067e", "committedDate": "2020-09-16T00:22:58Z", "message": "Fix IAM not being redisplay by SESSION DURATION\n\n* Dynamic triggers weren't being scheduled on the second pass due to !dismissedMessages.contains(message.messageId) check being call before evaluateMessageTriggers, and this is not reset until setDataForRedisplay evaluates to true. If evaluateMessageTriggers is not called then dynamic triggers aren't scheduled\n* Dynamic triggers weren't calling makeRedisplayMessagesAvailableWithTriggers, so no redisplay logic was being handled\n* Add better debug logging"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1574233fd84f4470beb3c4e83c4428b33581067e", "author": {"user": {"login": "Jeasmine", "name": "JNahui"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/1574233fd84f4470beb3c4e83c4428b33581067e", "committedDate": "2020-09-16T00:22:58Z", "message": "Fix IAM not being redisplay by SESSION DURATION\n\n* Dynamic triggers weren't being scheduled on the second pass due to !dismissedMessages.contains(message.messageId) check being call before evaluateMessageTriggers, and this is not reset until setDataForRedisplay evaluates to true. If evaluateMessageTriggers is not called then dynamic triggers aren't scheduled\n* Dynamic triggers weren't calling makeRedisplayMessagesAvailableWithTriggers, so no redisplay logic was being handled\n* Add better debug logging"}, "afterCommit": {"oid": "40379d01cce004b2d414867cd4613da976a185a4", "author": {"user": {"login": "Jeasmine", "name": "JNahui"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/40379d01cce004b2d414867cd4613da976a185a4", "committedDate": "2020-09-16T00:25:34Z", "message": "Fix IAM not being redisplay by SESSION DURATION\n\n* Dynamic triggers weren't being scheduled on the second pass due to !dismissedMessages.contains(message.messageId) check being call before evaluateMessageTriggers, and this is not reset until setDataForRedisplay evaluates to true. If evaluateMessageTriggers is not called then dynamic triggers aren't scheduled\n* Dynamic triggers weren't calling makeRedisplayMessagesAvailableWithTriggers, so no redisplay logic was being handled\n* Add better debug logging"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5NTUxNDI0", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1149#pullrequestreview-489551424", "createdAt": "2020-09-16T12:01:02Z", "commit": {"oid": "40379d01cce004b2d414867cd4613da976a185a4"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxMjowMTowMlrOHStfdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxMjowMTowMlrOHStfdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM4MTc1MA==", "bodyText": "This logic seems odd to me by using a foreach style logic but then looking up an idex. Couldn't this work with a contains check instead?", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1149#discussion_r489381750", "createdAt": "2020-09-16T12:01:02Z", "author": {"login": "jkasten2"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -189,19 +190,36 @@ private void processInAppMessageJson(@NonNull JSONArray json) throws JSONExcepti\n         }\n         messages = newMessages;\n \n+        populateRedisplayMessagesTriggers();\n         evaluateInAppMessages();\n     }\n \n+    private void populateRedisplayMessagesTriggers() {\n+        for (OSInAppMessage redisplayMessage : redisplayedInAppMessages) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40379d01cce004b2d414867cd4613da976a185a4"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87b356645e165d6e5f0366f6e433937c31d74c5e", "author": {"user": {"login": "Jeasmine", "name": "JNahui"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/87b356645e165d6e5f0366f6e433937c31d74c5e", "committedDate": "2020-09-17T16:38:19Z", "message": "Fix IAM not being redisplay by SESSION DURATION\n\n* Dynamic triggers weren't being scheduled on the second pass due to !dismissedMessages.contains(message.messageId) check being call before evaluateMessageTriggers, and this is not reset until setDataForRedisplay evaluates to true. If evaluateMessageTriggers is not called then dynamic triggers aren't scheduled\n* Dynamic triggers weren't calling makeRedisplayMessagesAvailableWithTriggers, so no redisplay logic was being handled\n* Add better debug logging"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "40379d01cce004b2d414867cd4613da976a185a4", "author": {"user": {"login": "Jeasmine", "name": "JNahui"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/40379d01cce004b2d414867cd4613da976a185a4", "committedDate": "2020-09-16T00:25:34Z", "message": "Fix IAM not being redisplay by SESSION DURATION\n\n* Dynamic triggers weren't being scheduled on the second pass due to !dismissedMessages.contains(message.messageId) check being call before evaluateMessageTriggers, and this is not reset until setDataForRedisplay evaluates to true. If evaluateMessageTriggers is not called then dynamic triggers aren't scheduled\n* Dynamic triggers weren't calling makeRedisplayMessagesAvailableWithTriggers, so no redisplay logic was being handled\n* Add better debug logging"}, "afterCommit": {"oid": "87b356645e165d6e5f0366f6e433937c31d74c5e", "author": {"user": {"login": "Jeasmine", "name": "JNahui"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/87b356645e165d6e5f0366f6e433937c31d74c5e", "committedDate": "2020-09-17T16:38:19Z", "message": "Fix IAM not being redisplay by SESSION DURATION\n\n* Dynamic triggers weren't being scheduled on the second pass due to !dismissedMessages.contains(message.messageId) check being call before evaluateMessageTriggers, and this is not reset until setDataForRedisplay evaluates to true. If evaluateMessageTriggers is not called then dynamic triggers aren't scheduled\n* Dynamic triggers weren't calling makeRedisplayMessagesAvailableWithTriggers, so no redisplay logic was being handled\n* Add better debug logging"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwOTg5Njk2", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1149#pullrequestreview-490989696", "createdAt": "2020-09-17T21:07:26Z", "commit": {"oid": "87b356645e165d6e5f0366f6e433937c31d74c5e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0360dc5ae6f7bc982df25c8be96c577ffd361a64", "author": {"user": {"login": "Jeasmine", "name": "JNahui"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/0360dc5ae6f7bc982df25c8be96c577ffd361a64", "committedDate": "2020-09-28T17:53:25Z", "message": "Reset dynamic session launch time\n\n* If user puts app on background and opens the app after 30 seconds, on new session, session launch time was not being reset and due to that IAM with redisplay was being show inmediatly.\n* When a new session is started, reset session launch time. This will make IAM with session time trigger and redisplay work properly"}, "afterCommit": {"oid": "f88a3609f7d904772e3b17ab2206d395c39ba424", "author": {"user": {"login": "Jeasmine", "name": "JNahui"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/f88a3609f7d904772e3b17ab2206d395c39ba424", "committedDate": "2020-09-28T17:58:34Z", "message": "Reset dynamic session launch time\n\n* If the user puts the app on the background and opens the app after 30 seconds, on a new session, the session launch time was not being reset and due to that IAM with redisplay was being shown immediately.\n* When a new session is started, reset session launch time. This will make IAM with session time trigger and redisplay work properly"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f88a3609f7d904772e3b17ab2206d395c39ba424", "author": {"user": {"login": "Jeasmine", "name": "JNahui"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/f88a3609f7d904772e3b17ab2206d395c39ba424", "committedDate": "2020-09-28T17:58:34Z", "message": "Reset dynamic session launch time\n\n* If the user puts the app on the background and opens the app after 30 seconds, on a new session, the session launch time was not being reset and due to that IAM with redisplay was being shown immediately.\n* When a new session is started, reset session launch time. This will make IAM with session time trigger and redisplay work properly"}, "afterCommit": {"oid": "37754b7e22921f3bf6fee6fc3a5975504650d7e4", "author": {"user": {"login": "Jeasmine", "name": "JNahui"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/37754b7e22921f3bf6fee6fc3a5975504650d7e4", "committedDate": "2020-09-28T17:59:36Z", "message": "Reset dynamic session launch time\n\n* If the user puts the app on the background and opens the app after 30 seconds, on a new session, the session launch time was not being reset and due to that IAM with redisplay was being shown immediately.\n* When a new session is started, reset session launch time. This will make IAM with session time trigger and redisplay work properly"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e74e3c05c98b91b242d9a31246a303f26ed2354", "author": {"user": {"login": "Jeasmine", "name": "JNahui"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/1e74e3c05c98b91b242d9a31246a303f26ed2354", "committedDate": "2020-09-28T17:59:58Z", "message": "Reset dynamic session launch time\n\n* If the user puts the app on the background and opens the app after 30 seconds, on a new session, the session launch time was not being reset and due to that IAM with redisplay was being shown immediately.\n* When a new session is started, reset session launch time. This will make IAM with session time trigger and redisplay work properly\n* Refactor IAM Controller getController to avoid static reference"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "37754b7e22921f3bf6fee6fc3a5975504650d7e4", "author": {"user": {"login": "Jeasmine", "name": "JNahui"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/37754b7e22921f3bf6fee6fc3a5975504650d7e4", "committedDate": "2020-09-28T17:59:36Z", "message": "Reset dynamic session launch time\n\n* If the user puts the app on the background and opens the app after 30 seconds, on a new session, the session launch time was not being reset and due to that IAM with redisplay was being shown immediately.\n* When a new session is started, reset session launch time. This will make IAM with session time trigger and redisplay work properly"}, "afterCommit": {"oid": "1e74e3c05c98b91b242d9a31246a303f26ed2354", "author": {"user": {"login": "Jeasmine", "name": "JNahui"}}, "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/1e74e3c05c98b91b242d9a31246a303f26ed2354", "committedDate": "2020-09-28T17:59:58Z", "message": "Reset dynamic session launch time\n\n* If the user puts the app on the background and opens the app after 30 seconds, on a new session, the session launch time was not being reset and due to that IAM with redisplay was being shown immediately.\n* When a new session is started, reset session launch time. This will make IAM with session time trigger and redisplay work properly\n* Refactor IAM Controller getController to avoid static reference"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3OTM1OTkz", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1149#pullrequestreview-497935993", "createdAt": "2020-09-28T22:13:08Z", "commit": {"oid": "1e74e3c05c98b91b242d9a31246a303f26ed2354"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3432, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}