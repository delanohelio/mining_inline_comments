{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM2MTQzNzQw", "number": 1239, "reviewThreads": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQwMDo0OToxOFrOFDwbuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQyMTowODoyNVrOFFzpFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM5NDgzNTc2OnYy", "diffSide": "RIGHT", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQwMDo0OToxOFrOIDkHCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQyMjowMTozN1rOIEQ1tg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDYwODI2Nw==", "bodyText": "Looks like this is a TODO yet?", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r540608267", "createdAt": "2020-12-11T00:49:18Z", "author": {"login": "jkasten2"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -409,6 +420,53 @@ else if (action.getUrlTarget() == OSInAppMessageAction.OSInAppMessageActionUrlTy\n         }\n     }\n \n+    private void fireRESTCallForPageChange(@NonNull final OSInAppMessage message, @NonNull final OSInAppMessagePage page) {\n+        final String variantId = variantIdForMessage(message);\n+        if (variantId == null)\n+            return;\n+\n+        final String pageId = page.getPageId();\n+\n+\n+        // Never send multiple page impressions for the same message UUID unless that page change is from an IAM with redisplay\n+        if (message.getViewedPageIds().contains(pageId))\n+            return;\n+\n+        message.addPageId(page.getPageId());\n+\n+        try {\n+            JSONObject json = new JSONObject() {{\n+                put(\"app_id\", OneSignal.appId);\n+                put(\"player_id\", OneSignal.getUserId());\n+                put(\"variant_id\", variantId);\n+                put(\"device_type\", new OSUtils().getDeviceType());\n+                put(\"page_id\", pageId);\n+            }};\n+\n+            OneSignalRestClient.post(\"in_app_messages/\" + message.messageId + \"/pageImpression\", json, new ResponseHandler() {\n+                @Override\n+                void onSuccess(String response) {\n+                    printHttpSuccessForInAppMessageRequest(\"page impression\", response);\n+                    /*OneSignalPrefs.saveStringSet(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "04790085256c86606e69a3f5c622f4a562a2c039"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzNDY1Mw==", "bodyText": "Yes this was my question at the end of the PR do we need to save the ids to the prefs?", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r541134653", "createdAt": "2020-12-11T18:12:13Z", "author": {"login": "emawby"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -409,6 +420,53 @@ else if (action.getUrlTarget() == OSInAppMessageAction.OSInAppMessageActionUrlTy\n         }\n     }\n \n+    private void fireRESTCallForPageChange(@NonNull final OSInAppMessage message, @NonNull final OSInAppMessagePage page) {\n+        final String variantId = variantIdForMessage(message);\n+        if (variantId == null)\n+            return;\n+\n+        final String pageId = page.getPageId();\n+\n+\n+        // Never send multiple page impressions for the same message UUID unless that page change is from an IAM with redisplay\n+        if (message.getViewedPageIds().contains(pageId))\n+            return;\n+\n+        message.addPageId(page.getPageId());\n+\n+        try {\n+            JSONObject json = new JSONObject() {{\n+                put(\"app_id\", OneSignal.appId);\n+                put(\"player_id\", OneSignal.getUserId());\n+                put(\"variant_id\", variantId);\n+                put(\"device_type\", new OSUtils().getDeviceType());\n+                put(\"page_id\", pageId);\n+            }};\n+\n+            OneSignalRestClient.post(\"in_app_messages/\" + message.messageId + \"/pageImpression\", json, new ResponseHandler() {\n+                @Override\n+                void onSuccess(String response) {\n+                    printHttpSuccessForInAppMessageRequest(\"page impression\", response);\n+                    /*OneSignalPrefs.saveStringSet(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDYwODI2Nw=="}, "originalCommit": {"oid": "04790085256c86606e69a3f5c622f4a562a2c039"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTIzNjAwMQ==", "bodyText": "The only scenario that I think needs this.\n1 - Opening app\n2 - Display IAM\n3 - Impression sent\n4 - Close application (swipe away) without dismiss IAM\n5 - Open app\n6 - IAM should display again\n7 - Impression shouldn't be sent again", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r541236001", "createdAt": "2020-12-11T20:11:05Z", "author": {"login": "Jeasmine"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -409,6 +420,53 @@ else if (action.getUrlTarget() == OSInAppMessageAction.OSInAppMessageActionUrlTy\n         }\n     }\n \n+    private void fireRESTCallForPageChange(@NonNull final OSInAppMessage message, @NonNull final OSInAppMessagePage page) {\n+        final String variantId = variantIdForMessage(message);\n+        if (variantId == null)\n+            return;\n+\n+        final String pageId = page.getPageId();\n+\n+\n+        // Never send multiple page impressions for the same message UUID unless that page change is from an IAM with redisplay\n+        if (message.getViewedPageIds().contains(pageId))\n+            return;\n+\n+        message.addPageId(page.getPageId());\n+\n+        try {\n+            JSONObject json = new JSONObject() {{\n+                put(\"app_id\", OneSignal.appId);\n+                put(\"player_id\", OneSignal.getUserId());\n+                put(\"variant_id\", variantId);\n+                put(\"device_type\", new OSUtils().getDeviceType());\n+                put(\"page_id\", pageId);\n+            }};\n+\n+            OneSignalRestClient.post(\"in_app_messages/\" + message.messageId + \"/pageImpression\", json, new ResponseHandler() {\n+                @Override\n+                void onSuccess(String response) {\n+                    printHttpSuccessForInAppMessageRequest(\"page impression\", response);\n+                    /*OneSignalPrefs.saveStringSet(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDYwODI2Nw=="}, "originalCommit": {"oid": "04790085256c86606e69a3f5c622f4a562a2c039"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTM0MTExMA==", "bodyText": "Cool confirmed that this is an issue so I will store them in the prefs", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r541341110", "createdAt": "2020-12-11T22:01:37Z", "author": {"login": "emawby"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -409,6 +420,53 @@ else if (action.getUrlTarget() == OSInAppMessageAction.OSInAppMessageActionUrlTy\n         }\n     }\n \n+    private void fireRESTCallForPageChange(@NonNull final OSInAppMessage message, @NonNull final OSInAppMessagePage page) {\n+        final String variantId = variantIdForMessage(message);\n+        if (variantId == null)\n+            return;\n+\n+        final String pageId = page.getPageId();\n+\n+\n+        // Never send multiple page impressions for the same message UUID unless that page change is from an IAM with redisplay\n+        if (message.getViewedPageIds().contains(pageId))\n+            return;\n+\n+        message.addPageId(page.getPageId());\n+\n+        try {\n+            JSONObject json = new JSONObject() {{\n+                put(\"app_id\", OneSignal.appId);\n+                put(\"player_id\", OneSignal.getUserId());\n+                put(\"variant_id\", variantId);\n+                put(\"device_type\", new OSUtils().getDeviceType());\n+                put(\"page_id\", pageId);\n+            }};\n+\n+            OneSignalRestClient.post(\"in_app_messages/\" + message.messageId + \"/pageImpression\", json, new ResponseHandler() {\n+                @Override\n+                void onSuccess(String response) {\n+                    printHttpSuccessForInAppMessageRequest(\"page impression\", response);\n+                    /*OneSignalPrefs.saveStringSet(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDYwODI2Nw=="}, "originalCommit": {"oid": "04790085256c86606e69a3f5c622f4a562a2c039"}, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM5ODQ3Njk1OnYy", "diffSide": "LEFT", "path": "Examples/OneSignalDemo/local.properties", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxODowODo1NlrOIEEHeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxOTozNDoxOVrOIFjGOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzMjY2Ng==", "bodyText": "this should be a ignored file", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r541132666", "createdAt": "2020-12-11T18:08:56Z", "author": {"login": "Jeasmine"}, "path": "Examples/OneSignalDemo/local.properties", "diffHunk": "@@ -4,6 +4,6 @@\n # Location of the SDK. This is only used by Gradle.\n # For customization when using a Version Control System, please read the\n # header note.\n-#Tue Jul 23 19:22:28 PDT 2019", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "04790085256c86606e69a3f5c622f4a562a2c039"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY4ODgyNw==", "bodyText": "can we remove this file from the PR?", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r542688827", "createdAt": "2020-12-14T19:34:19Z", "author": {"login": "Jeasmine"}, "path": "Examples/OneSignalDemo/local.properties", "diffHunk": "@@ -4,6 +4,6 @@\n # Location of the SDK. This is only used by Gradle.\n # For customization when using a Version Control System, please read the\n # header note.\n-#Tue Jul 23 19:22:28 PDT 2019", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzMjY2Ng=="}, "originalCommit": {"oid": "04790085256c86606e69a3f5c622f4a562a2c039"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM5ODQ4MjU3OnYy", "diffSide": "RIGHT", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageAction.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxODoxMDoyM1rOIEEKyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxOTowNzo0OFrOIFhSHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzMzUxNA==", "bodyText": "this is marked as notNull but\npageId = json.optString(PAGE_ID, null); it could end being null, maybe set a default value? tr change to Nullable", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r541133514", "createdAt": "2020-12-11T18:10:23Z", "author": {"login": "Jeasmine"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageAction.java", "diffHunk": "@@ -125,6 +133,11 @@ public String getClickName() {\n         return clickName;\n     }\n \n+    @NonNull", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "04790085256c86606e69a3f5c622f4a562a2c039"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY1OTEwMA==", "bodyText": "fixed!", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r542659100", "createdAt": "2020-12-14T19:07:48Z", "author": {"login": "emawby"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageAction.java", "diffHunk": "@@ -125,6 +133,11 @@ public String getClickName() {\n         return clickName;\n     }\n \n+    @NonNull", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzMzUxNA=="}, "originalCommit": {"oid": "04790085256c86606e69a3f5c622f4a562a2c039"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM5ODQ4ODk1OnYy", "diffSide": "RIGHT", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxODoxMTo1M1rOIEEOgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxOTowNzo0MFrOIFhRcQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzNDQ2Ng==", "bodyText": "remove extra enter", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r541134466", "createdAt": "2020-12-11T18:11:53Z", "author": {"login": "Jeasmine"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -409,6 +420,53 @@ else if (action.getUrlTarget() == OSInAppMessageAction.OSInAppMessageActionUrlTy\n         }\n     }\n \n+    private void fireRESTCallForPageChange(@NonNull final OSInAppMessage message, @NonNull final OSInAppMessagePage page) {\n+        final String variantId = variantIdForMessage(message);\n+        if (variantId == null)\n+            return;\n+\n+        final String pageId = page.getPageId();\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "04790085256c86606e69a3f5c622f4a562a2c039"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY1ODkyOQ==", "bodyText": "fixed!", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r542658929", "createdAt": "2020-12-14T19:07:40Z", "author": {"login": "emawby"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -409,6 +420,53 @@ else if (action.getUrlTarget() == OSInAppMessageAction.OSInAppMessageActionUrlTy\n         }\n     }\n \n+    private void fireRESTCallForPageChange(@NonNull final OSInAppMessage message, @NonNull final OSInAppMessagePage page) {\n+        final String variantId = variantIdForMessage(message);\n+        if (variantId == null)\n+            return;\n+\n+        final String pageId = page.getPageId();\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzNDQ2Ng=="}, "originalCommit": {"oid": "04790085256c86606e69a3f5c622f4a562a2c039"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM5ODQ5MTQyOnYy", "diffSide": "RIGHT", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxODoxMjoyN1rOIEEP6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxOTowMTowNlrOIFg1eA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzNDgyNg==", "bodyText": "this is checked under onPageChanged too, is that ok?", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r541134826", "createdAt": "2020-12-11T18:12:27Z", "author": {"login": "Jeasmine"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -409,6 +420,53 @@ else if (action.getUrlTarget() == OSInAppMessageAction.OSInAppMessageActionUrlTy\n         }\n     }\n \n+    private void fireRESTCallForPageChange(@NonNull final OSInAppMessage message, @NonNull final OSInAppMessagePage page) {\n+        final String variantId = variantIdForMessage(message);\n+        if (variantId == null)\n+            return;\n+\n+        final String pageId = page.getPageId();\n+\n+\n+        // Never send multiple page impressions for the same message UUID unless that page change is from an IAM with redisplay\n+        if (message.getViewedPageIds().contains(pageId))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "04790085256c86606e69a3f5c622f4a562a2c039"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY1MTc2OA==", "bodyText": "Now only checking in the rest method call for consistency with iOS and better separation of concerns", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r542651768", "createdAt": "2020-12-14T19:01:06Z", "author": {"login": "emawby"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -409,6 +420,53 @@ else if (action.getUrlTarget() == OSInAppMessageAction.OSInAppMessageActionUrlTy\n         }\n     }\n \n+    private void fireRESTCallForPageChange(@NonNull final OSInAppMessage message, @NonNull final OSInAppMessagePage page) {\n+        final String variantId = variantIdForMessage(message);\n+        if (variantId == null)\n+            return;\n+\n+        final String pageId = page.getPageId();\n+\n+\n+        // Never send multiple page impressions for the same message UUID unless that page change is from an IAM with redisplay\n+        if (message.getViewedPageIds().contains(pageId))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzNDgyNg=="}, "originalCommit": {"oid": "04790085256c86606e69a3f5c622f4a562a2c039"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM5ODUxNTMwOnYy", "diffSide": "RIGHT", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessagePage.kt", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxODoxODo1M1rOIEEd8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxOTowMTo0NFrOIFg4Ww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzODQxOQ==", "bodyText": "is the optional needed?", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r541138419", "createdAt": "2020-12-11T18:18:53Z", "author": {"login": "Jeasmine"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessagePage.kt", "diffHunk": "@@ -0,0 +1,29 @@\n+package com.onesignal\n+\n+\n+import org.json.JSONException\n+import org.json.JSONObject\n+\n+const val PAGE_ID = \"pageId\"\n+const val PAGE_INDEX = \"pageIndex\"\n+\n+class OSInAppMessagePage constructor(jsonObject: JSONObject) {\n+    var pageId: String? = null\n+    var pageIndex: String? = null\n+\n+    init {\n+        pageId = jsonObject.optString(PAGE_ID, null)\n+        pageIndex = jsonObject.optString(PAGE_INDEX, null)\n+    }\n+\n+    fun toJSONObject(): JSONObject? {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "04790085256c86606e69a3f5c622f4a562a2c039"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY1MjUwNw==", "bodyText": "nope fixed", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r542652507", "createdAt": "2020-12-14T19:01:44Z", "author": {"login": "emawby"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessagePage.kt", "diffHunk": "@@ -0,0 +1,29 @@\n+package com.onesignal\n+\n+\n+import org.json.JSONException\n+import org.json.JSONObject\n+\n+const val PAGE_ID = \"pageId\"\n+const val PAGE_INDEX = \"pageIndex\"\n+\n+class OSInAppMessagePage constructor(jsonObject: JSONObject) {\n+    var pageId: String? = null\n+    var pageIndex: String? = null\n+\n+    init {\n+        pageId = jsonObject.optString(PAGE_ID, null)\n+        pageIndex = jsonObject.optString(PAGE_INDEX, null)\n+    }\n+\n+    fun toJSONObject(): JSONObject? {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzODQxOQ=="}, "originalCommit": {"oid": "04790085256c86606e69a3f5c622f4a562a2c039"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM5ODUyMTM1OnYy", "diffSide": "RIGHT", "path": "OneSignalSDK/unittest/src/test/java/com/test/onesignal/InAppMessagingUnitTests.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxODoyMDozMlrOIEEhiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQyMTo0NTozN1rOIFroJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzOTMzNw==", "bodyText": "is this needed?", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r541139337", "createdAt": "2020-12-11T18:20:32Z", "author": {"login": "Jeasmine"}, "path": "OneSignalSDK/unittest/src/test/java/com/test/onesignal/InAppMessagingUnitTests.java", "diffHunk": "@@ -616,4 +616,19 @@ public void testOnMessageWasShown() throws Exception {\n         assertEquals(1, iamImpressionRequest.payload.get(\"device_type\"));\n         assertEquals(true, iamImpressionRequest.payload.get(\"first_impression\"));\n     }\n+\n+    @Test\n+    public void testOnPageChanged() throws Exception {\n+        threadAndTaskWait();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "04790085256c86606e69a3f5c622f4a562a2c039"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY1ODc1NA==", "bodyText": "yes it crashes without it", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r542658754", "createdAt": "2020-12-14T19:07:30Z", "author": {"login": "emawby"}, "path": "OneSignalSDK/unittest/src/test/java/com/test/onesignal/InAppMessagingUnitTests.java", "diffHunk": "@@ -616,4 +616,19 @@ public void testOnMessageWasShown() throws Exception {\n         assertEquals(1, iamImpressionRequest.payload.get(\"device_type\"));\n         assertEquals(true, iamImpressionRequest.payload.get(\"first_impression\"));\n     }\n+\n+    @Test\n+    public void testOnPageChanged() throws Exception {\n+        threadAndTaskWait();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzOTMzNw=="}, "originalCommit": {"oid": "04790085256c86606e69a3f5c622f4a562a2c039"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY4NzMwNQ==", "bodyText": "oh, weird \ud83e\udd14  test setup should not break tests, can you point out which error it is?", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r542687305", "createdAt": "2020-12-14T19:32:53Z", "author": {"login": "Jeasmine"}, "path": "OneSignalSDK/unittest/src/test/java/com/test/onesignal/InAppMessagingUnitTests.java", "diffHunk": "@@ -616,4 +616,19 @@ public void testOnMessageWasShown() throws Exception {\n         assertEquals(1, iamImpressionRequest.payload.get(\"device_type\"));\n         assertEquals(true, iamImpressionRequest.payload.get(\"first_impression\"));\n     }\n+\n+    @Test\n+    public void testOnPageChanged() throws Exception {\n+        threadAndTaskWait();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzOTMzNw=="}, "originalCommit": {"oid": "04790085256c86606e69a3f5c622f4a562a2c039"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjgyODU4MQ==", "bodyText": "Ah sorry the crash can be fixed, but you need to initialize to have the player id etc for the request", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r542828581", "createdAt": "2020-12-14T21:45:37Z", "author": {"login": "emawby"}, "path": "OneSignalSDK/unittest/src/test/java/com/test/onesignal/InAppMessagingUnitTests.java", "diffHunk": "@@ -616,4 +616,19 @@ public void testOnMessageWasShown() throws Exception {\n         assertEquals(1, iamImpressionRequest.payload.get(\"device_type\"));\n         assertEquals(true, iamImpressionRequest.payload.get(\"first_impression\"));\n     }\n+\n+    @Test\n+    public void testOnPageChanged() throws Exception {\n+        threadAndTaskWait();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzOTMzNw=="}, "originalCommit": {"oid": "04790085256c86606e69a3f5c622f4a562a2c039"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM5ODUyNDY3OnYy", "diffSide": "RIGHT", "path": "OneSignalSDK/unittest/src/test/java/com/test/onesignal/InAppMessagingUnitTests.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxODoyMToyNVrOIEEjfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxOTowNDozMVrOIFhESw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzOTgzNw==", "bodyText": "is ok to test without mocking the IAM display?", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r541139837", "createdAt": "2020-12-11T18:21:25Z", "author": {"login": "Jeasmine"}, "path": "OneSignalSDK/unittest/src/test/java/com/test/onesignal/InAppMessagingUnitTests.java", "diffHunk": "@@ -616,4 +616,19 @@ public void testOnMessageWasShown() throws Exception {\n         assertEquals(1, iamImpressionRequest.payload.get(\"device_type\"));\n         assertEquals(true, iamImpressionRequest.payload.get(\"first_impression\"));\n     }\n+\n+    @Test\n+    public void testOnPageChanged() throws Exception {\n+        threadAndTaskWait();\n+\n+        OneSignalPackagePrivateHelper.onPageChanged(message, InAppMessagingHelpers.buildTestPageJson());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "04790085256c86606e69a3f5c622f4a562a2c039"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY1NTU2Mw==", "bodyText": "Yes we test without mocking the iam display for clicks as well and they should be entirely independent", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r542655563", "createdAt": "2020-12-14T19:04:31Z", "author": {"login": "emawby"}, "path": "OneSignalSDK/unittest/src/test/java/com/test/onesignal/InAppMessagingUnitTests.java", "diffHunk": "@@ -616,4 +616,19 @@ public void testOnMessageWasShown() throws Exception {\n         assertEquals(1, iamImpressionRequest.payload.get(\"device_type\"));\n         assertEquals(true, iamImpressionRequest.payload.get(\"first_impression\"));\n     }\n+\n+    @Test\n+    public void testOnPageChanged() throws Exception {\n+        threadAndTaskWait();\n+\n+        OneSignalPackagePrivateHelper.onPageChanged(message, InAppMessagingHelpers.buildTestPageJson());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzOTgzNw=="}, "originalCommit": {"oid": "04790085256c86606e69a3f5c622f4a562a2c039"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQwOTY5MDY2OnYy", "diffSide": "RIGHT", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxOTozNToyMlrOIFjLCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQyMTo0NToxM1rOIFrmqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY5MDA1OQ==", "bodyText": "same question as on iOS, see OneSignal/OneSignal-iOS-SDK#735 (comment)", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r542690059", "createdAt": "2020-12-14T19:35:22Z", "author": {"login": "Jeasmine"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -409,6 +429,62 @@ else if (action.getUrlTarget() == OSInAppMessageAction.OSInAppMessageActionUrlTy\n         }\n     }\n \n+    private void saveViewedPageIdsToPrefs() {\n+        OneSignalPrefs.saveStringSet(\n+                OneSignalPrefs.PREFS_ONESIGNAL,\n+                OneSignalPrefs.PREFS_OS_PAGE_IMPRESSIONED_IAMS,\n+                // Post success, store impressioned pages to disk\n+                viewedPageIds);\n+    }\n+\n+    private void fireRESTCallForPageChange(@NonNull final OSInAppMessage message, @NonNull final OSInAppMessagePage page) {\n+        final String variantId = variantIdForMessage(message);\n+        if (variantId == null)\n+            return;\n+\n+        final String pageId = page.getPageId();\n+\n+        final String messagePrefixedPageId = message.messageId + pageId;\n+\n+        // Never send multiple page impressions for the same message UUID unless that page change is from an IAM with redisplay\n+        if (message.getViewedPageIds().contains(pageId) || viewedPageIds.contains(messagePrefixedPageId)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a428549751e320600989f56c94f53c976fc4e98"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjgyODIwMw==", "bodyText": "same fix as ios. only tracking globally now, but it is still per inapp since we don't want them to affect each other (in local testing I was getting duplicate page ids for different inapps which is why I prefixed the page id with the message id)", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r542828203", "createdAt": "2020-12-14T21:45:13Z", "author": {"login": "emawby"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -409,6 +429,62 @@ else if (action.getUrlTarget() == OSInAppMessageAction.OSInAppMessageActionUrlTy\n         }\n     }\n \n+    private void saveViewedPageIdsToPrefs() {\n+        OneSignalPrefs.saveStringSet(\n+                OneSignalPrefs.PREFS_ONESIGNAL,\n+                OneSignalPrefs.PREFS_OS_PAGE_IMPRESSIONED_IAMS,\n+                // Post success, store impressioned pages to disk\n+                viewedPageIds);\n+    }\n+\n+    private void fireRESTCallForPageChange(@NonNull final OSInAppMessage message, @NonNull final OSInAppMessagePage page) {\n+        final String variantId = variantIdForMessage(message);\n+        if (variantId == null)\n+            return;\n+\n+        final String pageId = page.getPageId();\n+\n+        final String messagePrefixedPageId = message.messageId + pageId;\n+\n+        // Never send multiple page impressions for the same message UUID unless that page change is from an IAM with redisplay\n+        if (message.getViewedPageIds().contains(pageId) || viewedPageIds.contains(messagePrefixedPageId)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY5MDA1OQ=="}, "originalCommit": {"oid": "9a428549751e320600989f56c94f53c976fc4e98"}, "originalPosition": 70}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQxNjMzMzAwOnYy", "diffSide": "RIGHT", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQyMTowODoyNVrOIGgCSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQyMDoyNDozNVrOIHXrzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY4NzI0Mg==", "bodyText": "can we put some comment over this desition of cleaning impressions, so we know in the future?", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r543687242", "createdAt": "2020-12-15T21:08:25Z", "author": {"login": "Jeasmine"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -494,6 +568,8 @@ private void setDataForRedisplay(OSInAppMessage message) {\n \n                 dismissedMessages.remove(message.messageId);\n                 impressionedMessages.remove(message.messageId);\n+                viewedPageIds.clear();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ba6373650125d7b6aa152380d99e949d35f96db5"}, "originalPosition": 113}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDU5ODk5MQ==", "bodyText": "done!", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r544598991", "createdAt": "2020-12-16T20:24:35Z", "author": {"login": "emawby"}, "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -494,6 +568,8 @@ private void setDataForRedisplay(OSInAppMessage message) {\n \n                 dismissedMessages.remove(message.messageId);\n                 impressionedMessages.remove(message.messageId);\n+                viewedPageIds.clear();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY4NzI0Mg=="}, "originalCommit": {"oid": "ba6373650125d7b6aa152380d99e949d35f96db5"}, "originalPosition": 113}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2180, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}