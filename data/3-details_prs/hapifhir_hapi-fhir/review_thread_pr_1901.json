{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI4NjExODM1", "number": 1901, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNzo0Mjo1N1rOEDCrbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNzo0NzozNVrOEDCxQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNjI1MDY4OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/predicate/JpaSystemProperties.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNzo0Mjo1N1rOGf3i8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNzo1MDoyOFrOGf3x7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjA2OTEwNg==", "bodyText": "I believe this if needs to be reversed.  if (!ourO...", "url": "https://github.com/hapifhir/hapi-fhir/pull/1901#discussion_r436069106", "createdAt": "2020-06-05T17:42:57Z", "author": {"login": "fil512"}, "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/predicate/JpaSystemProperties.java", "diffHunk": "@@ -0,0 +1,32 @@\n+package ca.uhn.fhir.jpa.dao.predicate;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class JpaSystemProperties {\n+\n+\tprivate static final Logger ourLog = LoggerFactory.getLogger(JpaSystemProperties.class);\n+\tpublic static final String HFJ_FORCE_IN_CLAUSES_HF_50 = \"hfj_force_in_clauses_hf50\";\n+\tprivate static boolean ourOptmizeSingleElementInExpression;\n+\n+\tstatic {\n+\t\tupdateSettingsBasedOnCurrentSystemProperties();\n+\t}\n+\n+\t/**\n+\t * Non instantiable\n+\t */\n+\tprivate JpaSystemProperties() {\n+\t}\n+\n+\tpublic static void updateSettingsBasedOnCurrentSystemProperties() {\n+\t\tourOptmizeSingleElementInExpression = !(\"true\".equals(System.getProperty(HFJ_FORCE_IN_CLAUSES_HF_50)));\n+\t\tif (ourOptmizeSingleElementInExpression) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe3ba5789eb7ca27d4df24c5518e78e44eadd368"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjA3Mjk0Mw==", "bodyText": "you are absolutely right", "url": "https://github.com/hapifhir/hapi-fhir/pull/1901#discussion_r436072943", "createdAt": "2020-06-05T17:50:28Z", "author": {"login": "jamesagnew"}, "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/predicate/JpaSystemProperties.java", "diffHunk": "@@ -0,0 +1,32 @@\n+package ca.uhn.fhir.jpa.dao.predicate;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class JpaSystemProperties {\n+\n+\tprivate static final Logger ourLog = LoggerFactory.getLogger(JpaSystemProperties.class);\n+\tpublic static final String HFJ_FORCE_IN_CLAUSES_HF_50 = \"hfj_force_in_clauses_hf50\";\n+\tprivate static boolean ourOptmizeSingleElementInExpression;\n+\n+\tstatic {\n+\t\tupdateSettingsBasedOnCurrentSystemProperties();\n+\t}\n+\n+\t/**\n+\t * Non instantiable\n+\t */\n+\tprivate JpaSystemProperties() {\n+\t}\n+\n+\tpublic static void updateSettingsBasedOnCurrentSystemProperties() {\n+\t\tourOptmizeSingleElementInExpression = !(\"true\".equals(System.getProperty(HFJ_FORCE_IN_CLAUSES_HF_50)));\n+\t\tif (ourOptmizeSingleElementInExpression) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjA2OTEwNg=="}, "originalCommit": {"oid": "fe3ba5789eb7ca27d4df24c5518e78e44eadd368"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNjI2MTE4OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/dao/r4/FhirResourceDaoR4SearchNoFtTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNzo0NjoxM1rOGf3pfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNzo0NjoxM1rOGf3pfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjA3MDc4Mg==", "bodyText": "I love these tests.", "url": "https://github.com/hapifhir/hapi-fhir/pull/1901#discussion_r436070782", "createdAt": "2020-06-05T17:46:13Z", "author": {"login": "fil512"}, "path": "hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/dao/r4/FhirResourceDaoR4SearchNoFtTest.java", "diffHunk": "@@ -4730,6 +4732,48 @@ public void testCircularReferencesDontBreakRevIncludes() {\n \n \t}\n \n+\t@Test\n+\tpublic void testSearchReference_DontOptmizeSingleValueInPredicate() {\n+\t\tPatient p = new Patient();\n+\t\tp.setActive(true);\n+\t\tString patientId = myPatientDao.create(p).getId().toUnqualifiedVersionless().getValue();\n+\n+\t\tAuditEvent audit = new AuditEvent();\n+\t\taudit.addEntity().getWhat().setReference(patientId);\n+\t\tString auditId = myAuditEventDao.create(audit).getId().toUnqualifiedVersionless().getValue();\n+\n+\n+\t\t// Default\n+\t\t{\n+\t\t\tmyCaptureQueriesListener.clear();\n+\t\t\tSearchParameterMap map = new SearchParameterMap();\n+\t\t\tmap.setLoadSynchronous(true);\n+\t\t\tmap.add(AuditEvent.SP_ENTITY, new ReferenceParam(patientId));\n+\t\t\tIBundleProvider outcome = myAuditEventDao.search(map);\n+\t\t\tassertThat(toUnqualifiedVersionlessIdValues(outcome), contains(auditId));\n+\t\t\tmyCaptureQueriesListener.logSelectQueriesForCurrentThread();\n+\t\t\tassertThat(myCaptureQueriesListener.getSelectQueriesForCurrentThread().get(0).getSql(true, true), containsString(\"myresource1_.TARGET_RESOURCE_ID=\"));\n+\t\t}\n+\n+\t\t// Disable optmization\n+\t\ttry {\n+\t\t\tSystem.setProperty(HFJ_FORCE_IN_CLAUSES_HF_50, \"true\");\n+\t\t\tJpaSystemProperties.updateSettingsBasedOnCurrentSystemProperties();\n+\n+\t\t\tmyCaptureQueriesListener.clear();\n+\t\t\tSearchParameterMap map = new SearchParameterMap();\n+\t\t\tmap.setLoadSynchronous(true);\n+\t\t\tmap.add(AuditEvent.SP_ENTITY, new ReferenceParam(patientId));\n+\t\t\tIBundleProvider outcome = myAuditEventDao.search(map);\n+\t\t\tassertThat(toUnqualifiedVersionlessIdValues(outcome), contains(auditId));\n+\t\t\tmyCaptureQueriesListener.logSelectQueriesForCurrentThread();\n+\t\t\tassertThat(myCaptureQueriesListener.getSelectQueriesForCurrentThread().get(0).getSql(true, true), containsString(\"myresource1_.TARGET_RESOURCE_ID in \"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe3ba5789eb7ca27d4df24c5518e78e44eadd368"}, "originalPosition": 64}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNjI2NTYyOnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/predicate/JpaSystemProperties.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNzo0NzozNVrOGf3sPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNzo1NDo1OFrOGf368A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjA3MTQ4NQ==", "bodyText": "How can we ensure we back this out a year from now.  Is there some build-breaking reminder we could set for ourselves?", "url": "https://github.com/hapifhir/hapi-fhir/pull/1901#discussion_r436071485", "createdAt": "2020-06-05T17:47:35Z", "author": {"login": "fil512"}, "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/predicate/JpaSystemProperties.java", "diffHunk": "@@ -0,0 +1,32 @@\n+package ca.uhn.fhir.jpa.dao.predicate;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class JpaSystemProperties {\n+\n+\tprivate static final Logger ourLog = LoggerFactory.getLogger(JpaSystemProperties.class);\n+\tpublic static final String HFJ_FORCE_IN_CLAUSES_HF_50 = \"hfj_force_in_clauses_hf50\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe3ba5789eb7ca27d4df24c5518e78e44eadd368"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjA3MjU2OQ==", "bodyText": "This is only merging to the 5_0 release branch so by default it expires in august.... do you thihnk that makes sense?", "url": "https://github.com/hapifhir/hapi-fhir/pull/1901#discussion_r436072569", "createdAt": "2020-06-05T17:49:48Z", "author": {"login": "jamesagnew"}, "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/predicate/JpaSystemProperties.java", "diffHunk": "@@ -0,0 +1,32 @@\n+package ca.uhn.fhir.jpa.dao.predicate;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class JpaSystemProperties {\n+\n+\tprivate static final Logger ourLog = LoggerFactory.getLogger(JpaSystemProperties.class);\n+\tpublic static final String HFJ_FORCE_IN_CLAUSES_HF_50 = \"hfj_force_in_clauses_hf50\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjA3MTQ4NQ=="}, "originalCommit": {"oid": "fe3ba5789eb7ca27d4df24c5518e78e44eadd368"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjA3NTI0OA==", "bodyText": "oh right of course duh!", "url": "https://github.com/hapifhir/hapi-fhir/pull/1901#discussion_r436075248", "createdAt": "2020-06-05T17:54:58Z", "author": {"login": "fil512"}, "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/predicate/JpaSystemProperties.java", "diffHunk": "@@ -0,0 +1,32 @@\n+package ca.uhn.fhir.jpa.dao.predicate;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class JpaSystemProperties {\n+\n+\tprivate static final Logger ourLog = LoggerFactory.getLogger(JpaSystemProperties.class);\n+\tpublic static final String HFJ_FORCE_IN_CLAUSES_HF_50 = \"hfj_force_in_clauses_hf50\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjA3MTQ4NQ=="}, "originalCommit": {"oid": "fe3ba5789eb7ca27d4df24c5518e78e44eadd368"}, "originalPosition": 9}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1857, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}