{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM3NzQzNDIw", "number": 2240, "title": "Add support for composite sorting", "bodyText": "Support for the composite sort e.g. http://hapi.fhir.org/baseR4/Observation?_sort=component-code-value-quantity", "createdAt": "2020-12-12T04:11:51Z", "url": "https://github.com/hapifhir/hapi-fhir/pull/2240", "merged": true, "mergeCommit": {"oid": "effbd199248ed40fd907af3ae91c1c7327d62590"}, "closed": true, "closedAt": "2020-12-16T21:54:57Z", "author": {"login": "frankjtao"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdlTbYMAH2gAyNTM3NzQzNDIwOmRjYmRjODNkOGViOGEyMmM3ZDIzYjFhNzNjZjU0YzkyNzAzOWJjYTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdm2G_aAFqTU1NDExMjAxMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "dcbdc83d8eb8a22c7d23b1a73cf54c927039bca5", "author": {"user": {"login": "frankjtao", "name": "Frank Tao"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/dcbdc83d8eb8a22c7d23b1a73cf54c927039bca5", "committedDate": "2020-12-12T02:50:32Z", "message": "Supported composite sort"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0411967e26add7dd1c6a2feae4f03b6742e9abfc", "author": {"user": {"login": "frankjtao", "name": "Frank Tao"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/0411967e26add7dd1c6a2feae4f03b6742e9abfc", "committedDate": "2020-12-12T03:25:12Z", "message": "Added composite sort test case for R5"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzOTkzMDc3", "url": "https://github.com/hapifhir/hapi-fhir/pull/2240#pullrequestreview-553993077", "createdAt": "2020-12-16T18:59:39Z", "commit": {"oid": "0411967e26add7dd1c6a2feae4f03b6742e9abfc"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQxODo1OTozOVrOIHUg5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQxOToyNjoyMlrOIHVgZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDU0NzA0Ng==", "bodyText": "Should avoid prefixing the name of the composite list variable with the. We usually reserve this prefix for parameters that were passed to the method (not for local variables). Maybe just change the name of this variable to compositeList?", "url": "https://github.com/hapifhir/hapi-fhir/pull/2240#discussion_r544547046", "createdAt": "2020-12-16T18:59:39Z", "author": {"login": "IanMMarshall"}, "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/search/builder/SearchBuilder.java", "diffHunk": "@@ -528,9 +528,25 @@ private void createSort(QueryStack theQueryStack, SortSpec theSort) {\n \t\t\t\t\tbreak;\n \t\t\t\tcase QUANTITY:\n \t\t\t\t\ttheQueryStack.addSortOnQuantity(myResourceName, theSort.getParamName(), ascending);\n+\t\t\t\t\tbreak;\t\n+\t\t\t\tcase COMPOSITE:\n+\t\t\t\t\tList<RuntimeSearchParam> theCompositList = param.getCompositeOf();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0411967e26add7dd1c6a2feae4f03b6742e9abfc"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDU1ODI1MQ==", "bodyText": "I am wondering if it's appropriate to support sorting on composites with reference,  number and uri param types given that the search functionality does not appear to support searching on composites that include these param types.\nIf we are going to support these types, then I think we should include tests for these types.", "url": "https://github.com/hapifhir/hapi-fhir/pull/2240#discussion_r544558251", "createdAt": "2020-12-16T19:18:08Z", "author": {"login": "IanMMarshall"}, "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/search/builder/SearchBuilder.java", "diffHunk": "@@ -542,6 +558,37 @@ private void createSort(QueryStack theQueryStack, SortSpec theSort) {\n \t\tcreateSort(theQueryStack, theSort.getChain());\n \n \t}\n+\t\n+\tprivate void createCompositeSort(QueryStack theQueryStack, String theResourceName, RestSearchParameterTypeEnum theParamType, String theParamName, boolean theAscending) {\n+\n+\t\tswitch (theParamType) {\n+\t\tcase STRING:\n+\t\t\ttheQueryStack.addSortOnString(myResourceName, theParamName, theAscending);\n+\t\t\tbreak;\n+\t\tcase DATE:\n+\t\t\ttheQueryStack.addSortOnDate(myResourceName, theParamName, theAscending);\n+\t\t\tbreak;\n+\t\tcase REFERENCE:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0411967e26add7dd1c6a2feae4f03b6742e9abfc"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDU2MzMwMg==", "bodyText": "One way you could test these edge cases (assuming you keep these) is to create resources with number, reference and/or uri values and then create a custom SearchParameter. The FhirResourceDaoR4SearchCustomSearchParamTest test class in ca.uhn.fhir.jpa.dao.r4 includes several examples of tests that use custom SearchParameter definitions that you might be able to adapt (although I admit that I am having troubles finding examples that include uri parameters other than maybe cases that involve resources with extensions).", "url": "https://github.com/hapifhir/hapi-fhir/pull/2240#discussion_r544563302", "createdAt": "2020-12-16T19:26:22Z", "author": {"login": "IanMMarshall"}, "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/search/builder/SearchBuilder.java", "diffHunk": "@@ -542,6 +558,37 @@ private void createSort(QueryStack theQueryStack, SortSpec theSort) {\n \t\tcreateSort(theQueryStack, theSort.getChain());\n \n \t}\n+\t\n+\tprivate void createCompositeSort(QueryStack theQueryStack, String theResourceName, RestSearchParameterTypeEnum theParamType, String theParamName, boolean theAscending) {\n+\n+\t\tswitch (theParamType) {\n+\t\tcase STRING:\n+\t\t\ttheQueryStack.addSortOnString(myResourceName, theParamName, theAscending);\n+\t\t\tbreak;\n+\t\tcase DATE:\n+\t\t\ttheQueryStack.addSortOnDate(myResourceName, theParamName, theAscending);\n+\t\t\tbreak;\n+\t\tcase REFERENCE:\n+\t\t\ttheQueryStack.addSortOnResourceLink(myResourceName, theParamName, theAscending);\n+\t\t\tbreak;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0411967e26add7dd1c6a2feae4f03b6742e9abfc"}, "originalPosition": 52}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de845300c2910d3bc577744b084fd6d97b171c9f", "author": {"user": {"login": "frankjtao", "name": "Frank Tao"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/de845300c2910d3bc577744b084fd6d97b171c9f", "committedDate": "2020-12-16T20:48:10Z", "message": "Updated based on the review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0MTEyMDEw", "url": "https://github.com/hapifhir/hapi-fhir/pull/2240#pullrequestreview-554112010", "createdAt": "2020-12-16T21:48:52Z", "commit": {"oid": "de845300c2910d3bc577744b084fd6d97b171c9f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3818, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}