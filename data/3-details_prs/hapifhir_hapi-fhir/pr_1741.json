{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgyNjQ1MzYw", "number": 1741, "title": "Create custom span for Search Threads for Elastic APM", "bodyText": "Currently in elastic APM, since searches occur on background threads, the Transactions that are reported caused by http requests are lacking the span information of the searches.\nTo fix this, and ensure that any search time also counts towards the transaction's time, create a custom span in the task, while specifying the HTTP request transaction as the parent. This causes the search span to be associated to the original request when viewing APM data.", "createdAt": "2020-03-02T22:38:54Z", "url": "https://github.com/hapifhir/hapi-fhir/pull/1741", "merged": true, "mergeCommit": {"oid": "4d7f39cfdce2399302198c4e407b6b958294c764"}, "closed": true, "closedAt": "2020-03-03T05:46:46Z", "author": {"login": "tadgh"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcI2hzGAH2gAyMzgyNjQ1MzYwOmVkN2I5ZmM2YjZhZjkzZTY3M2RlN2YwZTg4N2VlNmQ5OWYxYWU3Y2I=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcJ1tBsgFqTM2NzU4NDY1Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ed7b9fc6b6af93e673de7f0e887ee6d99f1ae7cb", "author": {"user": null}, "url": "https://github.com/hapifhir/hapi-fhir/commit/ed7b9fc6b6af93e673de7f0e887ee6d99f1ae7cb", "committedDate": "2020-02-28T21:09:16Z", "message": "Initial attempt at integrating elastic APM for search performance"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d9119faef6e3cef7ad5828ad34f66ad15121f88", "author": {"user": {"login": "tadgh", "name": "Tadgh"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/8d9119faef6e3cef7ad5828ad34f66ad15121f88", "committedDate": "2020-03-02T22:37:09Z", "message": "Rework span name"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3NTg0NjU3", "url": "https://github.com/hapifhir/hapi-fhir/pull/1741#pullrequestreview-367584657", "createdAt": "2020-03-02T22:43:45Z", "commit": {"oid": "ed7b9fc6b6af93e673de7f0e887ee6d99f1ae7cb"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQyMjo0Mzo0NVrOFwyEvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQyMjo0NDo1OVrOFwyG1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjY5NjM4MA==", "bodyText": "I can't believe this is all that took....... hot damn", "url": "https://github.com/hapifhir/hapi-fhir/pull/1741#discussion_r386696380", "createdAt": "2020-03-02T22:43:45Z", "author": {"login": "jamesagnew"}, "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/search/SearchCoordinatorSvcImpl.java", "diffHunk": "@@ -614,6 +617,7 @@ protected SearchTask(Search theSearch, IDao theCallingDao, SearchParameterMap th\n \t\t\tmySearchRuntimeDetails = new SearchRuntimeDetails(theRequest, mySearch.getUuid());\n \t\t\tmySearchRuntimeDetails.setQueryString(theParams.toNormalizedQueryString(theCallingDao.getContext()));\n \t\t\tmyRequest = theRequest;\n+\t\t\tmyParentTransaction = ElasticApm.currentTransaction();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed7b9fc6b6af93e673de7f0e887ee6d99f1ae7cb"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjY5NjkxOA==", "bodyText": "What are these strings? Presumably h2 refers to the DB, which would be misleading in any environment that isn't using H2....", "url": "https://github.com/hapifhir/hapi-fhir/pull/1741#discussion_r386696918", "createdAt": "2020-03-02T22:44:59Z", "author": {"login": "jamesagnew"}, "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/search/SearchCoordinatorSvcImpl.java", "diffHunk": "@@ -841,7 +845,8 @@ void requestImmediateAbort() {\n \t\t@Override\n \t\tpublic Void call() {\n \t\t\tStopWatch sw = new StopWatch();\n-\n+\t\t\tSpan span = myParentTransaction.startSpan(\"db\", \"H2\", \"search\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed7b9fc6b6af93e673de7f0e887ee6d99f1ae7cb"}, "originalPosition": 32}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4014, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}