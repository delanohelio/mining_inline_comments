{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc2MjUyNzcz", "number": 2059, "title": "Improve synchronous searching by providing offset & limit support", "bodyText": "Describe the issue\nThis is related to #1940, #536\nAs described HAPI FHIR does not support stateless pagination(searching). Supporting stateless searching would allow using all database nodes for searches. The current stateful search forces to use master node because it needs to write and update the database. Stateless search from the database could also be more performant because it would eliminate the need to write search to the database and update the entry there (and also clean those from the db). Also the asynchronous search fetches more entries than is probably requested (batching).\nCurrent synchronous searching does not support paging and limiting very well. This is an initial poc implementation for better paging support for the synchronous search.\nWhat's been done\n\nAdd support for offset querying which leverages paging at the query level\nAdd configuration for search default page size and search maximum page size\nIf using offset, always use synchronous searching to avoid extra database insert/update etc.\nWhen using offset, only calculate count if it's wanted\nValidate params closer to provider and handle size if search returned \"all\" (or last page)\nSimple use cases are tested to be working. If both database backed paging and this is supported, then if there is _offset parameter then offset paging links are given (synchronous paging) and if not then database backed paging links are given (with page id).\n\nWhat's missing\nThis is still heavily work-in-progress and therefore I'm marking this as draft. There are  issues with lots of tests that are using for example IBundleProvider.size() for verifications, but if we don't want to force searching to query count from the database, that field is null (if we do not fetch all or the last page of resources). I'm not really sure how this should be fixed though.. size is marked nullable, and if one resource is fetched with count 1 it's not known if there is more or not. (We could add total accurate parameter to tests). Also the bundleprovider size -> bundle total is not always correctly added if accurate count is not requested.\nI haven't looked into the $everything operations. There might be some other issues as well.\nI'm willing to put effort into this if this is something that could be merged into the HAPI FHIR library.", "createdAt": "2020-08-31T12:01:21Z", "url": "https://github.com/hapifhir/hapi-fhir/pull/2059", "merged": true, "mergeCommit": {"oid": "1435540320979a55d94e00854edc9dcf75a9137a"}, "closed": true, "closedAt": "2020-10-12T21:42:04Z", "author": {"login": "tuomoa"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdEQ0IIgH2gAyNDc2MjUyNzczOjE2NmU4MmNlYjlhM2M5YTE3NDlkZDI4MDc4YTFjZDBlMmRkOWI1YTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdR7DSKAFqTUwNjkzNTQzMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "166e82ceb9a3c9a1749dd28078a1cd0e2dd9b5a5", "author": {"user": {"login": "tuomoa", "name": "Tuomo Ala-Vannesluoma"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/166e82ceb9a3c9a1749dd28078a1cd0e2dd9b5a5", "committedDate": "2020-08-31T11:08:21Z", "message": "Improve synchronous searching by providing offset & limit support\n\nAdd support for offset querying which leverages paging at the query level\nAdd configuration for search default page size and search maximum page size\nIf using offset, always use synchronous searching to avoid extra database insert/update etc.\nWhen using offset, only calculate count if it's wanted\nValidate params closer to provider and handle size if search returned \"all\" (or last)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4NjE3NjI2", "url": "https://github.com/hapifhir/hapi-fhir/pull/2059#pullrequestreview-478617626", "createdAt": "2020-08-31T13:30:45Z", "commit": {"oid": "166e82ceb9a3c9a1749dd28078a1cd0e2dd9b5a5"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxMzozMDo0NVrOHJ48ig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxMzo1MzoyMlrOHJ5y4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDEzMjIzNA==", "bodyText": "It should defnitely be noted in the javadoc that _offset is a nonstandard FHIR parameter and may not be supported on all servers.", "url": "https://github.com/hapifhir/hapi-fhir/pull/2059#discussion_r480132234", "createdAt": "2020-08-31T13:30:45Z", "author": {"login": "jamesagnew"}, "path": "hapi-fhir-base/src/main/java/ca/uhn/fhir/rest/gclient/IQuery.java", "diffHunk": "@@ -49,6 +49,14 @@\n \t */\n \tIQuery<Y> count(int theCount);\n \n+\t/**\n+\t * Specifies the <code>_offset</code> parameter, which indicates to the server the offset of the query. Use\n+\t * with {@link #count(int)}.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "166e82ceb9a3c9a1749dd28078a1cd0e2dd9b5a5"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE0MzU1Ng==", "bodyText": "I'm not sure I love the idea of this being the default if no paging provider exists- This feels like a significant change in behaviour from the current default.\nWhat if we modified IPagingProvider to have a new method along the lines of\ndefault boolean supportsOffsetQueries() { return false; }\n...and the provider could basically declare itself stateless?", "url": "https://github.com/hapifhir/hapi-fhir/pull/2059#discussion_r480143556", "createdAt": "2020-08-31T13:49:14Z", "author": {"login": "jamesagnew"}, "path": "hapi-fhir-server/src/main/java/ca/uhn/fhir/rest/server/method/BaseResourceReturningMethodBinding.java", "diffHunk": "@@ -200,7 +210,18 @@ IBaseResource createBundleFromBundleProvider(IRestfulServer<?> theServer, Reques\n \t\tString linkPrev = null;\n \t\tString linkNext = null;\n \n-\t\tif (isNotBlank(theResult.getCurrentPageId())) {\n+\t\tif (theServer.getPagingProvider() == null || requestOffset != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "166e82ceb9a3c9a1749dd28078a1cd0e2dd9b5a5"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE0NjE0Ng==", "bodyText": "This new annotation should probably get a mention in the search page and perhaps a section on stateless paging would be good on the paging page", "url": "https://github.com/hapifhir/hapi-fhir/pull/2059#discussion_r480146146", "createdAt": "2020-08-31T13:53:22Z", "author": {"login": "jamesagnew"}, "path": "hapi-fhir-client/src/main/java/ca/uhn/fhir/rest/client/method/MethodUtil.java", "diffHunk": "@@ -340,6 +340,8 @@ public static StringBuilder createUrl(String theResourceType, Map<String, List<S\n \t\t\t\t\t\t\t\touterCollectionType);\n \t\t\t\t\t} else if (nextAnnotation instanceof Count) {\n \t\t\t\t\t\tparam = new CountParameter();\n+\t\t\t\t\t} else if (nextAnnotation instanceof Offset) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "166e82ceb9a3c9a1749dd28078a1cd0e2dd9b5a5"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1fe2c2e68f5b9fd3007980acb30755b6a23bb54", "author": {"user": {"login": "tuomoa", "name": "Tuomo Ala-Vannesluoma"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/b1fe2c2e68f5b9fd3007980acb30755b6a23bb54", "committedDate": "2020-09-01T12:51:00Z", "message": "Review and test fixes\n\nComment _offset as nonstandard parameter\nMake synchronous search always count the total value (for now)\nFix issue with FulltextSearchSvcImpl mutating param map\nDirty fix for BaseJpaTest (not sure how to fix the including resources issue)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5NzE2NjU3", "url": "https://github.com/hapifhir/hapi-fhir/pull/2059#pullrequestreview-479716657", "createdAt": "2020-09-01T13:01:09Z", "commit": {"oid": "b1fe2c2e68f5b9fd3007980acb30755b6a23bb54"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxMzowMTowOVrOHK1MAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxMzowMTowOVrOHK1MAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTExOTIzMg==", "bodyText": "I'm not sure I get the issue being fixed here - Synchronous calls are performed when we're trying to minimize database load because we're expecting the call to be made a lot, so forcing a count goes against the whole objective.", "url": "https://github.com/hapifhir/hapi-fhir/pull/2059#discussion_r481119232", "createdAt": "2020-09-01T13:01:09Z", "author": {"login": "jamesagnew"}, "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/search/SearchCoordinatorSvcImpl.java", "diffHunk": "@@ -473,9 +474,22 @@ private IBundleProvider executeQuery(String theResourceType, SearchParameterMap\n \t\t\tRequestPartitionId requestPartitionId = myRequestPartitionHelperService.determineReadPartitionForRequest(theRequestDetails, theResourceType);\n \n \t\t\tLong count = 0L;\n-\t\t\tif (wantCount) {\n+\t\t\t// TODO not sure if this is good idea or not? synchronous is mostly used on internal operations, maybe count is not needed\n+\t\t\t//  but code has to be fixed. Most operations are looking for one resource. Those that are fetching larger could be  fixed to\n+\t\t\t//  handle size nullability and pages correctly.\n+\t\t\tif (wantCount || theParams.isLoadSynchronous()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1fe2c2e68f5b9fd3007980acb30755b6a23bb54"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5NzE3ODY1", "url": "https://github.com/hapifhir/hapi-fhir/pull/2059#pullrequestreview-479717865", "createdAt": "2020-09-01T13:02:36Z", "commit": {"oid": "b1fe2c2e68f5b9fd3007980acb30755b6a23bb54"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxMzowMjozN1rOHK1PbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxMzowMjozN1rOHK1PbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTEyMDEwOA==", "bodyText": "Wrong how? It's incomplete sure, but that's only because you're seeing only the first 5 results as configured.", "url": "https://github.com/hapifhir/hapi-fhir/pull/2059#discussion_r481120108", "createdAt": "2020-09-01T13:02:37Z", "author": {"login": "jamesagnew"}, "path": "hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/dao/r4/FhirResourceDaoR4SearchNoHashesTest.java", "diffHunk": "@@ -2655,6 +2655,7 @@ public void testSearchWithDate() {\n \t}\n \n \t@Test\n+\t// TODO What does this mean? The size in the result is actually wrong if we are hitting the fetchSizeDefaultMaximum?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1fe2c2e68f5b9fd3007980acb30755b6a23bb54"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e342263fae25b661feb0aa134af9db0273d1624e", "author": {"user": {"login": "tuomoa", "name": "Tuomo Ala-Vannesluoma"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/e342263fae25b661feb0aa134af9db0273d1624e", "committedDate": "2020-09-02T07:16:09Z", "message": "Remove temporary count querying fix for synchronous loads"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "540036b5acb5763c6351066e6ae5485c15c5c7dd", "author": {"user": {"login": "tuomoa", "name": "Tuomo Ala-Vannesluoma"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/540036b5acb5763c6351066e6ae5485c15c5c7dd", "committedDate": "2020-09-02T07:40:20Z", "message": "Fix offsetting of everything operations, do not drop zero offset"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4937bd64ae7f7f6bfd4382b13fe5d2f12d340956", "author": {"user": {"login": "tuomoa", "name": "Tuomo Ala-Vannesluoma"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/4937bd64ae7f7f6bfd4382b13fe5d2f12d340956", "committedDate": "2020-09-02T10:19:04Z", "message": "Fix jpa test default and maximum page size, add some fixmes to tests before resolved"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57f1fed14d0f988b970355977c257309e8bd7060", "author": {"user": {"login": "tuomoa", "name": "Tuomo Ala-Vannesluoma"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/57f1fed14d0f988b970355977c257309e8bd7060", "committedDate": "2020-09-02T12:38:48Z", "message": "Ignore one failing test, fix others"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwNzg5NjA3", "url": "https://github.com/hapifhir/hapi-fhir/pull/2059#pullrequestreview-480789607", "createdAt": "2020-09-02T12:55:57Z", "commit": {"oid": "57f1fed14d0f988b970355977c257309e8bd7060"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxMjo1NTo1N1rOHLtxVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxMjo1NTo1N1rOHLtxVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjA0NjI5NQ==", "bodyText": "I'm not really sure why this is not working. I'm not sure but maybe it seems that the actual query returns duplicate pids and when that's combined to LIMIT 10 we are only getting 6 pids. The same test with DSTU3 works.. Maybe there is some kind of new include param in R4 which causes query to find duplicates or something..", "url": "https://github.com/hapifhir/hapi-fhir/pull/2059#discussion_r482046295", "createdAt": "2020-09-02T12:55:57Z", "author": {"login": "tuomoa"}, "path": "hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/r4/ResourceProviderR4Test.java", "diffHunk": "@@ -2919,6 +2919,8 @@ public void testPagingOverEverythingSet() throws InterruptedException {\n \t}\n \n \t@Test\n+\t@Disabled\n+\t// FIXME no idea why this is returning only 6 results. stu2/3 tests are working..", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57f1fed14d0f988b970355977c257309e8bd7060"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1bf6c0aaa2cd4a36af7ead824a970389f5c27759", "author": {"user": {"login": "tuomoa", "name": "Tuomo Ala-Vannesluoma"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/1bf6c0aaa2cd4a36af7ead824a970389f5c27759", "committedDate": "2020-09-03T08:35:15Z", "message": "Fix Dereferenced variable may be null"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e5a3f7948d2e6ed5d447fb114714d3d79dcd582", "author": {"user": {"login": "tuomoa", "name": "Tuomo Ala-Vannesluoma"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/0e5a3f7948d2e6ed5d447fb114714d3d79dcd582", "committedDate": "2020-09-14T08:52:23Z", "message": "Fix everything paging in R4 by adding DISTINCT if synchronous load is used\n\nAlso fix assertion of size when hitting fetchSizeDefaultMaximum"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "145714186011144e1125668d5374f074be72c1cc", "author": {"user": {"login": "tuomoa", "name": "Tuomo Ala-Vannesluoma"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/145714186011144e1125668d5374f074be72c1cc", "committedDate": "2020-09-14T10:41:19Z", "message": "Add documentation about offset annotation and paging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39c14f40b6c5b9d38c93c3527bdf90098de21573", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/39c14f40b6c5b9d38c93c3527bdf90098de21573", "committedDate": "2020-10-12T21:40:33Z", "message": "Merge branch 'master' into better_synchronous_paging"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2OTM1NDMw", "url": "https://github.com/hapifhir/hapi-fhir/pull/2059#pullrequestreview-506935430", "createdAt": "2020-10-12T21:41:56Z", "commit": {"oid": "39c14f40b6c5b9d38c93c3527bdf90098de21573"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3840, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}