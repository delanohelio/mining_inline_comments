{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIyMDY0Mzk1", "number": 1863, "title": "Im 20200520 cascade delete", "bodyText": "Replaced a hard-coded limit that restricted the number of delete conflicts that could be handled by a cascade delete request with a configurable value that can be increased where needed.", "createdAt": "2020-05-22T17:43:04Z", "url": "https://github.com/hapifhir/hapi-fhir/pull/1863", "merged": true, "mergeCommit": {"oid": "12f80b3da53c5c75b42f94d2501facf43374eec9"}, "closed": true, "closedAt": "2020-05-22T20:17:09Z", "author": {"login": "IanMMarshall"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcjy8xkAH2gAyNDIyMDY0Mzk1OmE2MGU1ODA5YjJmYTQ1ZTcxZTVjMjcyMzY2MmY0MzY1NjRjNWE0NDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABckxLk-gFqTQxNzc1NTc5NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a60e5809b2fa45e71e5c2723662f436564c5a442", "author": {"user": null}, "url": "https://github.com/hapifhir/hapi-fhir/commit/a60e5809b2fa45e71e5c2723662f436564c5a442", "committedDate": "2020-05-22T14:15:04Z", "message": "Changes to enable adjusting limits on delete conflict handling through configuration."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b501a601b73f1f54e9cfc07054638d6bd605b1d1", "author": {"user": null}, "url": "https://github.com/hapifhir/hapi-fhir/commit/b501a601b73f1f54e9cfc07054638d6bd605b1d1", "committedDate": "2020-05-22T17:36:08Z", "message": "Some final cleanup minor updates."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a5c23c36b486ed0ad155e7ad28ae365549e8948", "author": {"user": null}, "url": "https://github.com/hapifhir/hapi-fhir/commit/6a5c23c36b486ed0ad155e7ad28ae365549e8948", "committedDate": "2020-05-22T17:45:17Z", "message": "Adding a proposed change log."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3MDg0OTQy", "url": "https://github.com/hapifhir/hapi-fhir/pull/1863#pullrequestreview-417084942", "createdAt": "2020-05-22T17:45:37Z", "commit": {"oid": "b501a601b73f1f54e9cfc07054638d6bd605b1d1"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNzo0NTozOFrOGZfHPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNzo0NjowN1rOGZfIIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM3NzM0MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t * Invoked when a resource delete operation is about to fail due to referential integrity checks. Intended for use with ca.uhn.fhir.jpa.interceptor.CascadingDeleteInterceptor.\n          \n          \n            \n            \t * Invoked when a resource delete operation is about to fail due to referential integrity checks. Intended for use with {@literal ca.uhn.fhir.jpa.interceptor.CascadingDeleteInterceptor}.", "url": "https://github.com/hapifhir/hapi-fhir/pull/1863#discussion_r429377341", "createdAt": "2020-05-22T17:45:38Z", "author": {"login": "jamesagnew"}, "path": "hapi-fhir-base/src/main/java/ca/uhn/fhir/interceptor/api/Pointcut.java", "diffHunk": "@@ -1282,7 +1282,7 @@\n \n \t/**\n \t * <b>Storage Hook:</b>\n-\t * Invoked when a resource delete operation is about to fail due to referential integrity hcts.\n+\t * Invoked when a resource delete operation is about to fail due to referential integrity checks. Intended for use with ca.uhn.fhir.jpa.interceptor.CascadingDeleteInterceptor.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b501a601b73f1f54e9cfc07054638d6bd605b1d1"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM3NzUxNw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t * @since 4.1.0\n          \n          \n            \n            \t * @since 5.1.0", "url": "https://github.com/hapifhir/hapi-fhir/pull/1863#discussion_r429377517", "createdAt": "2020-05-22T17:45:59Z", "author": {"login": "jamesagnew"}, "path": "hapi-fhir-jpaserver-api/src/main/java/ca/uhn/fhir/jpa/api/config/DaoConfig.java", "diffHunk": "@@ -2021,4 +2026,33 @@ public boolean isStoreRequestId() {\n \t\t */\n \t\tANY\n \t}\n+\n+\t/**\n+\t * <p>\n+\t * This determines the maximum number of conflicts that should be fetched and handled while retrying a delete of a resource.\n+\t * </p>\n+\t * <p>\n+\t * The default value for this setting is {@code 60}.\n+\t * </p>\n+\t *\n+\t * @since 4.1.0", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b501a601b73f1f54e9cfc07054638d6bd605b1d1"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM3NzU2OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t * @since 4.1.0\n          \n          \n            \n            \t * @since 5.1.0", "url": "https://github.com/hapifhir/hapi-fhir/pull/1863#discussion_r429377568", "createdAt": "2020-05-22T17:46:07Z", "author": {"login": "jamesagnew"}, "path": "hapi-fhir-jpaserver-api/src/main/java/ca/uhn/fhir/jpa/api/config/DaoConfig.java", "diffHunk": "@@ -2021,4 +2026,33 @@ public boolean isStoreRequestId() {\n \t\t */\n \t\tANY\n \t}\n+\n+\t/**\n+\t * <p>\n+\t * This determines the maximum number of conflicts that should be fetched and handled while retrying a delete of a resource.\n+\t * </p>\n+\t * <p>\n+\t * The default value for this setting is {@code 60}.\n+\t * </p>\n+\t *\n+\t * @since 4.1.0\n+\t */\n+\tpublic Integer getMaximumDeleteConflictQueryCount() {\n+\t\treturn myMaximumDeleteConflictQueryCount;\n+\t}\n+\n+\t/**\n+\t * <p>\n+\t * This determines the maximum number of conflicts that should be fetched and handled while retrying a delete of a resource.\n+\t * </p>\n+\t * <p>\n+\t * The default value for this setting is {@code 60}.\n+\t * </p>\n+\t *\n+\t * @since 4.1.0", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b501a601b73f1f54e9cfc07054638d6bd605b1d1"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44869856da2fc01da253281bffd46a27753ad544", "author": {"user": {"login": "IanMMarshall", "name": null}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/44869856da2fc01da253281bffd46a27753ad544", "committedDate": "2020-05-22T17:50:24Z", "message": "Update hapi-fhir-base/src/main/java/ca/uhn/fhir/interceptor/api/Pointcut.java\n\nCo-authored-by: James Agnew <jamesagnew@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51604dab2ce5ffa67bcf26cd44743cc822f5af07", "author": {"user": {"login": "IanMMarshall", "name": null}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/51604dab2ce5ffa67bcf26cd44743cc822f5af07", "committedDate": "2020-05-22T17:50:35Z", "message": "Update hapi-fhir-jpaserver-api/src/main/java/ca/uhn/fhir/jpa/api/config/DaoConfig.java\n\nCo-authored-by: James Agnew <jamesagnew@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "612fb215d6b5396f89844c5ac549079be8f9e3d5", "author": {"user": {"login": "IanMMarshall", "name": null}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/612fb215d6b5396f89844c5ac549079be8f9e3d5", "committedDate": "2020-05-22T17:50:42Z", "message": "Update hapi-fhir-jpaserver-api/src/main/java/ca/uhn/fhir/jpa/api/config/DaoConfig.java\n\nCo-authored-by: James Agnew <jamesagnew@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1a3d9de38591dcb999cd9154bd181e5098236c4", "author": {"user": {"login": "IanMMarshall", "name": null}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/a1a3d9de38591dcb999cd9154bd181e5098236c4", "committedDate": "2020-05-22T20:11:38Z", "message": "Merge branch 'master' into im_20200520_cascade_delete"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3NzU1Nzk0", "url": "https://github.com/hapifhir/hapi-fhir/pull/1863#pullrequestreview-417755794", "createdAt": "2020-05-25T14:44:19Z", "commit": {"oid": "a1a3d9de38591dcb999cd9154bd181e5098236c4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQxNDo0NDoxOVrOGaDYBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQxNDo0NDoxOVrOGaDYBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTk3MTQ2MA==", "bodyText": "shouldn't this use the new config param?", "url": "https://github.com/hapifhir/hapi-fhir/pull/1863#discussion_r429971460", "createdAt": "2020-05-25T14:44:19Z", "author": {"login": "fil512"}, "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/delete/DeleteConflictService.java", "diffHunk": "@@ -81,11 +81,16 @@ public int validateOkToDelete(DeleteConflictList theDeleteConflicts, ResourceTab\n \t\twhile (outcome != null) {\n \t\t\tint shouldRetryCount = Math.min(outcome.getShouldRetryCount(), MAX_RETRY_ATTEMPTS);\n \t\t\tif (!(retryCount < shouldRetryCount)) break;\n-\t\t\tnewConflicts = new DeleteConflictList();\n-\t\t\toutcome = findAndHandleConflicts(theRequest, newConflicts, theEntity, theForValidate, RETRY_QUERY_RESULT_COUNT, theTransactionDetails);\n+\t\t\tnewConflicts = new DeleteConflictList(newConflicts);\n+\t\t\toutcome = findAndHandleConflicts(theRequest, newConflicts, theEntity, theForValidate, myDaoConfig.getMaximumDeleteConflictQueryCount(), theTransactionDetails);\n \t\t\t++retryCount;\n \t\t}\n \t\ttheDeleteConflicts.addAll(newConflicts);\n+\t\tif(retryCount >= MAX_RETRY_ATTEMPTS && !theDeleteConflicts.isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a1a3d9de38591dcb999cd9154bd181e5098236c4"}, "originalPosition": 36}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3910, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}