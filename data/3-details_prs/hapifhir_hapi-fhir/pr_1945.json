{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQwNjYwNjI3", "number": 1945, "title": "Use read partition for finding update candidate on upsert", "bodyText": "", "createdAt": "2020-06-26T15:52:18Z", "url": "https://github.com/hapifhir/hapi-fhir/pull/1945", "merged": true, "mergeCommit": {"oid": "072f3a422ab350850d3edd9394f670adcaa25761"}, "closed": true, "closedAt": "2020-06-29T22:22:27Z", "author": {"login": "jamesagnew"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcvFTs3AH2gAyNDQwNjYwNjI3OmYzYTcxNzAzNzVmYzc2YTlhNzg1ZjMwM2FkNjdiMTUxNDI3YTVmZGU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwHrIzAH2gAyNDQwNjYwNjI3OmNmNzJiZTc2YTEwYjA1YjQ0ZGQ1OTZlOGQ5OWFkZjdjZjE1MzU4OTg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f3a7170375fc76a9a785f303ad67b151427a5fde", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/f3a7170375fc76a9a785f303ad67b151427a5fde", "committedDate": "2020-06-26T15:51:34Z", "message": "Use read partition for finding update candidate on upsert"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49b85541e200313300590947805c52afe47f5805", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/49b85541e200313300590947805c52afe47f5805", "committedDate": "2020-06-26T15:54:25Z", "message": "Add changelog"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4ODA1Mzkw", "url": "https://github.com/hapifhir/hapi-fhir/pull/1945#pullrequestreview-438805390", "createdAt": "2020-06-28T19:06:27Z", "commit": {"oid": "49b85541e200313300590947805c52afe47f5805"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOFQxOTowNjoyN1rOGp_kjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOFQxOTowOTozNFrOGp_mBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY4NjM1MA==", "bodyText": "This is the opposite scenario of what FMC requires.  They are trying to do a PUT with a non-null partition in the request when the pre-existing resource had a null partition.\nI tried adding the following test, but it failed with an error:\n\t@Test\n\tpublic void testUpdate_ResourcePreExistsInNullPartition() {\n\t\tIIdType patientId = createPatient(withPutPartition(1), withId(\"ONE\"), withBirthdate(\"2020-01-01\"));\n\t\taddReadDefaultPartition();\n\t\taddCreateDefaultPartition();\n\n\t\tPatient p = new Patient();\n\t\tp.setId(patientId.toUnqualifiedVersionless());\n\t\tp.setGender(Enumerations.AdministrativeGender.MALE);\n\t\tmyPatientDao.update(p);\n\t}", "url": "https://github.com/hapifhir/hapi-fhir/pull/1945#discussion_r446686350", "createdAt": "2020-06-28T19:06:27Z", "author": {"login": "fil512"}, "path": "hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/dao/r4/PartitioningR4Test.java", "diffHunk": "@@ -2073,12 +2082,24 @@ public void testSearch_RefParam_TargetForcedId_SearchDefaultPartition() {\n \n \t}\n \n+\t@Test\n+\tpublic void testUpdate_ResourcePreExistsInWrongPartition() {\n+\t\tIIdType patientId = createPatient(withPutPartition(null), withId(\"ONE\"), withBirthdate(\"2020-01-01\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49b85541e200313300590947805c52afe47f5805"}, "originalPosition": 161}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY4NjcyNQ==", "bodyText": "This reads different from the FMC scenario, but maybe it amounts to the same thing?\nFMC is not using an interceptor; all partition id requests are coming in through http headers.  They can't add partitions to pre-existing resources because there's too much data, so they're leaving all pre-existing resources in the null partition.  New resources coming in (that may pre-exist) have a non-null requested partition id in the header of the request.  This currently throws an error when the resource already exists in the null partition.", "url": "https://github.com/hapifhir/hapi-fhir/pull/1945#discussion_r446686725", "createdAt": "2020-06-28T19:09:34Z", "author": {"login": "fil512"}, "path": "hapi-fhir-docs/src/main/resources/ca/uhn/hapi/fhir/changelog/5_1_0/1945-use-read-partition-for-upsert-read.yaml", "diffHunk": "@@ -0,0 +1,7 @@\n+---\n+type: change\n+issue: 1945\n+title: \"When performing a JPA 'upsert' (a PUT to an ID that may or may not already exist) on a partitioned system,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49b85541e200313300590947805c52afe47f5805"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf72be76a10b05b44dd596e8d99adf7cf1535898", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/cf72be76a10b05b44dd596e8d99adf7cf1535898", "committedDate": "2020-06-29T21:10:54Z", "message": "Merge branch 'master' into ja_20200626_use_read_partition_on_partitioned_client_assigned_id"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3971, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}