{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg4MTEyOTk4", "number": 1760, "title": "Bugfix/1752 support chained parameters inside reverse chained parameter", "bodyText": "This adds rudimentary support for using chained parameters within a _has query, for example\n/Patient?_has:Observation:subject:device.identifier=SYS|VAL.\n\nFix some typos\nMinor refactoring to decrease function size\nrename builder to criteriaBuilder for readability\nAdd PERFTRACE_WARNING call where a chained parameter searches a resource reference that may have more than one type of resource as its target, the parameter chain may end up referring to search parameters with the same name on more than one kind of resource at once. For example,\n/Patient?_has:Observation:subject:device.identifier=SYS|VAL.  in this query, device could either be a Device or a DeviceMetric. Failing to qualify the query adds an extra predicate to the SQL query.", "createdAt": "2020-03-14T02:14:51Z", "url": "https://github.com/hapifhir/hapi-fhir/pull/1760", "merged": true, "mergeCommit": {"oid": "4583cb9939431fa4ede2015b2bfc7cc32ef8fae6"}, "closed": true, "closedAt": "2020-03-17T20:27:20Z", "author": {"login": "tadgh"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcK1HslAH2gAyMzg4MTEyOTk4OjBhY2ZjNTEwODJiNGQxYzllMWY4MTQ3ODVhOWU1ZTdlZmU2YTcyZWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcOmOAngH2gAyMzg4MTEyOTk4OjNlYjA5YjE1ZjA5NGE3NzUwNjYxYzg3ZTFhOTM4N2VlMjBlZTY2YzY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0acfc51082b4d1c9e1f814785a9e5e7efe6a72ec", "author": {"user": {"login": "tadgh", "name": "Tadgh"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/0acfc51082b4d1c9e1f814785a9e5e7efe6a72ec", "committedDate": "2020-03-06T00:38:42Z", "message": "Split test into two tests, one of which passes, one of which fails, showing the missing functionality"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b299d0b63f759e5231227d946d6f383c6e502122", "author": {"user": {"login": "tadgh", "name": "Tadgh"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/b299d0b63f759e5231227d946d6f383c6e502122", "committedDate": "2020-03-06T19:39:39Z", "message": "Fix Typos, reduce code duplication\n\n* Change Two streams into one.\n* Fix typos.\n* Begin Writing docstrings\n* Rename variables for clarity"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aca4bcfaad5e827ecc127de512599accf777e5c5", "author": {"user": {"login": "tadgh", "name": "Tadgh"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/aca4bcfaad5e827ecc127de512599accf777e5c5", "committedDate": "2020-03-06T22:22:31Z", "message": "Minor refactoring for readability"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59d16035973376dbe60bb88b2e21ab6871f89541", "author": {"user": {"login": "tadgh", "name": "Tadgh"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/59d16035973376dbe60bb88b2e21ab6871f89541", "committedDate": "2020-03-09T20:51:47Z", "message": "Some variable renaming. Adds some questions."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12412a7be9f0e70045debb93f056296cd09290c3", "author": {"user": {"login": "tadgh", "name": "Tadgh"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/12412a7be9f0e70045debb93f056296cd09290c3", "committedDate": "2020-03-09T20:58:59Z", "message": "Add query capturing to query"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e38ec3e3ddb30c33c979b6bcdb26e50ea35e7fbc", "author": {"user": {"login": "tadgh", "name": "Tadgh"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/e38ec3e3ddb30c33c979b6bcdb26e50ea35e7fbc", "committedDate": "2020-03-09T21:57:53Z", "message": "Fix typo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3ceffbd7298770e7d92519eec935aebd055f773", "author": {"user": {"login": "tadgh", "name": "Tadgh"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/c3ceffbd7298770e7d92519eec935aebd055f773", "committedDate": "2020-03-09T23:05:41Z", "message": "wip"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74fd2c1519fa2f461b006845259f3d464d9d6696", "author": {"user": {"login": "tadgh", "name": "Tadgh"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/74fd2c1519fa2f461b006845259f3d464d9d6696", "committedDate": "2020-03-13T18:28:44Z", "message": "wip"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03567c5831a1984b92dd11ea05de8d8e4b533108", "author": {"user": {"login": "tadgh", "name": "Tadgh"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/03567c5831a1984b92dd11ea05de8d8e4b533108", "committedDate": "2020-03-13T22:29:48Z", "message": "Add perftrace. Remove regex"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d91cb7524c866bdb4b49ae0ecef677c62232e2a6", "author": {"user": {"login": "tadgh", "name": "Tadgh"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/d91cb7524c866bdb4b49ae0ecef677c62232e2a6", "committedDate": "2020-03-13T22:30:49Z", "message": "Fix up whitespace"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b80e71773d47c77997b1b883affc1877ba0c4aa7", "author": {"user": {"login": "tadgh", "name": "Tadgh"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/b80e71773d47c77997b1b883affc1877ba0c4aa7", "committedDate": "2020-03-14T01:36:43Z", "message": "Tidy, fix up tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4777d75e6b293c0dd985a49b744281418a83c7b8", "author": {"user": {"login": "tadgh", "name": "Tadgh"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/4777d75e6b293c0dd985a49b744281418a83c7b8", "committedDate": "2020-03-14T01:40:11Z", "message": "Merge branch 'master' into bugfix/1752-support-chained-parameters-inside-reverse-chained-parameter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a39ac886af361c1573ea8dffbcee4337784fd160", "author": {"user": {"login": "tadgh", "name": "Tadgh"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/a39ac886af361c1573ea8dffbcee4337784fd160", "committedDate": "2020-03-14T01:43:43Z", "message": "Fix error while resolving rebase"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f872ffb5153311045f6042727ed1199a5ced0de", "author": {"user": {"login": "tadgh", "name": "Tadgh"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/6f872ffb5153311045f6042727ed1199a5ced0de", "committedDate": "2020-03-14T02:15:46Z", "message": "Minor refactor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2MTQ5NjI2", "url": "https://github.com/hapifhir/hapi-fhir/pull/1760#pullrequestreview-376149626", "createdAt": "2020-03-17T15:33:58Z", "commit": {"oid": "6f872ffb5153311045f6042727ed1199a5ced0de"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNTozMzo1OVrOF3huTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNTozMzo1OVrOF3huTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzc2ODUyNQ==", "bodyText": "Nice, great message.", "url": "https://github.com/hapifhir/hapi-fhir/pull/1760#discussion_r393768525", "createdAt": "2020-03-17T15:33:59Z", "author": {"login": "jamesagnew"}, "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/predicate/PredicateBuilderReference.java", "diffHunk": "@@ -317,24 +332,46 @@ private Predicate addPredicateReferenceWithChain(String theResourceName, String\n \t\t\t\torValues.add(chainValue);\n \t\t\t}\n \n+\n \t\t\tSubquery<Long> subQ = createLinkSubquery(foundChainMatch, chain, subResourceName, orValues, theRequest);\n \n \t\t\tPredicate pathPredicate = createResourceLinkPathPredicate(theResourceName, theParamName, theJoin);\n \t\t\tPredicate pidPredicate = theJoin.get(\"myTargetResourcePid\").in(subQ);\n-\t\t\tPredicate andPredicate = myBuilder.and(pathPredicate, pidPredicate);\n+\t\t\tPredicate andPredicate = myCriteriaBuilder.and(pathPredicate, pidPredicate);\n \t\t\ttheCodePredicates.add(andPredicate);\n-\n+\t\t\tcandidateTargetTypes.add(nextType);\n \t\t}\n \n \t\tif (!foundChainMatch) {\n-\t\t\tthrow new InvalidRequestException(myContext.getLocalizer().getMessage(BaseHapiFhirResourceDao.class, \"invalidParameterChain\", theParamName + '.' + theRef.getChain()));\n+\t\t\tthrow new InvalidRequestException(myContext.getLocalizer().getMessage(BaseHapiFhirResourceDao.class, \"invalidParameterChain\", theParamName + '.' + theReferenceParam.getChain()));\n+\t\t}\n+\n+\t\tif (candidateTargetTypes.size() > 1) {\n+\t\t\twarnAboutPerformanceOnUnqualifiedResources(theParamName, theRequest, candidateTargetTypes);\n \t\t}\n \n-\t\tPredicate predicate = myBuilder.or(toArray(theCodePredicates));\n+\t\tPredicate predicate = myCriteriaBuilder.or(toArray(theCodePredicates));\n \t\tmyQueryRoot.addPredicate(predicate);\n \t\treturn predicate;\n \t}\n \n+\tprivate void warnAboutPerformanceOnUnqualifiedResources(String theParamName, RequestDetails theRequest, List<Class<? extends IBaseResource>> theCandidateTargetTypes) {\n+\t\tString message = new StringBuilder()\n+\t\t\t.append(\"This search uses an unqualified resource(a parameter in a chain without a resource type). \")\n+\t\t\t.append(\"This is less efficient than using a qualified type. \")\n+\t\t\t.append(\"[\" + theParamName + \"] resolves to [\"+ theCandidateTargetTypes.stream().map(Class::getSimpleName).collect(Collectors.joining(\",\")) +\"].\")\n+\t\t\t.append(\"If you know what you're looking for, try qualifying it like this: \")\n+\t\t\t.append(theCandidateTargetTypes.stream().map(cls -> \"[\" +cls.getSimpleName() +\":\"+theParamName+\"]\").collect(Collectors.joining(\" or \")))\n+\t\t\t.toString();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f872ffb5153311045f6042727ed1199a5ced0de"}, "originalPosition": 156}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2MTUwNjk0", "url": "https://github.com/hapifhir/hapi-fhir/pull/1760#pullrequestreview-376150694", "createdAt": "2020-03-17T15:35:02Z", "commit": {"oid": "6f872ffb5153311045f6042727ed1199a5ced0de"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNTozNTowMlrOF3hxYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNTozNTowMlrOF3hxYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzc2OTMxNA==", "bodyText": "One meta comment I'll drop here: This needs a changelog", "url": "https://github.com/hapifhir/hapi-fhir/pull/1760#discussion_r393769314", "createdAt": "2020-03-17T15:35:02Z", "author": {"login": "jamesagnew"}, "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/MatchResourceUrlService.java", "diffHunk": "@@ -81,7 +81,6 @@\n \t\t\t\t.add(StorageProcessingMessage.class, message);\n \t\t\tJpaInterceptorBroadcaster.doCallHooks(myInterceptorBroadcaster, theRequest, Pointcut.JPA_PERFTRACE_INFO, params);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f872ffb5153311045f6042727ed1199a5ced0de"}, "originalPosition": 2}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77733b59fa6e9b6efcc5271104b899d7be45c5b4", "author": {"user": {"login": "tadgh", "name": "Tadgh"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/77733b59fa6e9b6efcc5271104b899d7be45c5b4", "committedDate": "2020-03-17T16:33:58Z", "message": "Add changelog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3eb09b15f094a7750661c87e1a9387ee20ee66c6", "author": {"user": {"login": "tadgh", "name": "Tadgh"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/3eb09b15f094a7750661c87e1a9387ee20ee66c6", "committedDate": "2020-03-17T17:32:43Z", "message": "Merge branch 'master' into bugfix/1752-support-chained-parameters-inside-reverse-chained-parameter"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4028, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}