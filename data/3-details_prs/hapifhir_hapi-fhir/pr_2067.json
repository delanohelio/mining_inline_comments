{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgxNjY5NDM2", "number": 2067, "title": "ConceptMap multi version support", "bodyText": "Multi-version support for ConceptMap (Same Url, different version)\nAdded url, conceptMapVersion into ConceptMap $translate request for R3, R4 and R5\nFixed a NullPointerException of the reverse $translate when match.equivalence is missing.", "createdAt": "2020-09-07T22:43:01Z", "url": "https://github.com/hapifhir/hapi-fhir/pull/2067", "merged": true, "mergeCommit": {"oid": "b29d5388c6354cb0bef2dc97db086d4f712dbb43"}, "closed": true, "closedAt": "2020-09-11T16:05:15Z", "author": {"login": "frankjtao"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdGQNargH2gAyNDgxNjY5NDM2OmVkMjgwMWRiYWY0OGE1NTAyODY4MjgzNzc0YWM4YTM1ZTM1MzY0YjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdH1Sn-gH2gAyNDgxNjY5NDM2Ojc1MGNiZjRiYTNmZmQyMmFmYmQ3MTUxOGU1YjQxZDIyOWJkNjY3NTA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ed2801dbaf48a5502868283774ac8a35e35364b0", "author": {"user": {"login": "frankjtao", "name": "Frank Tao"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/ed2801dbaf48a5502868283774ac8a35e35364b0", "committedDate": "2020-09-06T15:33:55Z", "message": "ConceptMap multi-version supported"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45b88de3b67e6536aad82fc6f119334ec83a6e28", "author": {"user": {"login": "frankjtao", "name": "Frank Tao"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/45b88de3b67e6536aad82fc6f119334ec83a6e28", "committedDate": "2020-09-06T15:47:07Z", "message": "Fixed typo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ecec0abc923bedf44872324a2c3a5e4f878391c", "author": {"user": {"login": "frankjtao", "name": "Frank Tao"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/1ecec0abc923bedf44872324a2c3a5e4f878391c", "committedDate": "2020-09-06T19:23:26Z", "message": "Fixed duplicate ConceptMap URL only"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81cd73f820b6da861207c5eb3bcc630fd86f2c77", "author": {"user": {"login": "frankjtao", "name": "Frank Tao"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/81cd73f820b6da861207c5eb3bcc630fd86f2c77", "committedDate": "2020-09-06T19:27:29Z", "message": "Added test cases to for duplicate url and version of ConceptMap"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d019dee786b9c741a4d10cc348d9b320591f56b4", "author": {"user": {"login": "frankjtao", "name": "Frank Tao"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/d019dee786b9c741a4d10cc348d9b320591f56b4", "committedDate": "2020-09-06T20:11:09Z", "message": "Added url/conceptMapVersion for ConceptMap to support translate"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54100426434b5feb9d99f41965ad8c5fbe6b91e7", "author": {"user": {"login": "frankjtao", "name": "Frank Tao"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/54100426434b5feb9d99f41965ad8c5fbe6b91e7", "committedDate": "2020-09-07T14:43:58Z", "message": "Multi-version supported for ConceptMap $translate operation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e17625a1bd8cc3032abefdc41cd36aa10ab25fb", "author": {"user": {"login": "frankjtao", "name": "Frank Tao"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/5e17625a1bd8cc3032abefdc41cd36aa10ab25fb", "committedDate": "2020-09-07T22:09:01Z", "message": "Fixed NullPointerException for reverse $translate operation."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2fd692f5bb134ec92042fea7eeb9fcffc7457993", "author": {"user": {"login": "frankjtao", "name": "Frank Tao"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/2fd692f5bb134ec92042fea7eeb9fcffc7457993", "committedDate": "2020-09-08T00:54:35Z", "message": "Updated R5 reverse $translate test case for more coverage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4a87adc640081b396658527a072178998021d2b", "author": {"user": null}, "url": "https://github.com/hapifhir/hapi-fhir/commit/b4a87adc640081b396658527a072178998021d2b", "committedDate": "2020-09-09T20:53:14Z", "message": "Suggested test that includes case where ConceptVersion is not specified in $translate operation."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c873b6d6dd382717ba5ff9c6683abfe9a4c6837e", "author": {"user": {"login": "frankjtao", "name": "Frank Tao"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/c873b6d6dd382717ba5ff9c6683abfe9a4c6837e", "committedDate": "2020-09-10T02:24:02Z", "message": "Fixed ConceptMap $translation without conceptMapVersion issue."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1OTc5MzQw", "url": "https://github.com/hapifhir/hapi-fhir/pull/2067#pullrequestreview-485979340", "createdAt": "2020-09-10T14:12:49Z", "commit": {"oid": "c873b6d6dd382717ba5ff9c6683abfe9a4c6837e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNDoxMjo0OVrOHP2F6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNDoxMjo0OVrOHP2F6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM3NjkzOA==", "bodyText": "The method name might be a bit confusing now that we are supporting multiple ConceptMap versions.  Maybe could change this to something like findUnversionedTermConceptMapByUrl or findTermConceptMapByUrlAndNullVersion.", "url": "https://github.com/hapifhir/hapi-fhir/pull/2067#discussion_r486376938", "createdAt": "2020-09-10T14:12:49Z", "author": {"login": "IanMMarshall"}, "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/data/ITermConceptMapDao.java", "diffHunk": "@@ -36,6 +39,12 @@\n \t@Query(\"SELECT cm FROM TermConceptMap cm WHERE cm.myResourcePid = :resource_pid\")\n \tOptional<TermConceptMap> findTermConceptMapByResourcePid(@Param(\"resource_pid\") Long theResourcePid);\n \n-\t@Query(\"SELECT cm FROM TermConceptMap cm WHERE cm.myUrl = :url\")\n+\t@Query(\"SELECT cm FROM TermConceptMap cm WHERE cm.myUrl = :url and cm.myVersion is null\")\n \tOptional<TermConceptMap> findTermConceptMapByUrl(@Param(\"url\") String theUrl);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c873b6d6dd382717ba5ff9c6683abfe9a4c6837e"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1OTgxNDc2", "url": "https://github.com/hapifhir/hapi-fhir/pull/2067#pullrequestreview-485981476", "createdAt": "2020-09-10T14:14:52Z", "commit": {"oid": "c873b6d6dd382717ba5ff9c6683abfe9a4c6837e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNDoxNDo1MlrOHP2L_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNDoxNDo1MlrOHP2L_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM3ODQ5Mw==", "bodyText": "Suggestion for a more descriptive method name: getTermConceptMapEntitiesByUrlOrderByVersion.", "url": "https://github.com/hapifhir/hapi-fhir/pull/2067#discussion_r486378493", "createdAt": "2020-09-10T14:14:52Z", "author": {"login": "IanMMarshall"}, "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/data/ITermConceptMapDao.java", "diffHunk": "@@ -36,6 +39,12 @@\n \t@Query(\"SELECT cm FROM TermConceptMap cm WHERE cm.myResourcePid = :resource_pid\")\n \tOptional<TermConceptMap> findTermConceptMapByResourcePid(@Param(\"resource_pid\") Long theResourcePid);\n \n-\t@Query(\"SELECT cm FROM TermConceptMap cm WHERE cm.myUrl = :url\")\n+\t@Query(\"SELECT cm FROM TermConceptMap cm WHERE cm.myUrl = :url and cm.myVersion is null\")\n \tOptional<TermConceptMap> findTermConceptMapByUrl(@Param(\"url\") String theUrl);\n+\t\n+\t@Query(value=\"SELECT cm FROM TermConceptMap cm INNER JOIN ResourceTable r ON r.myId = cm.myResourcePid WHERE cm.myUrl = :url ORDER BY r.myUpdated DESC\") \n+\tList<TermConceptMap> findTermConceptMapByUrl(Pageable thePage, @Param(\"url\") String theUrl);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c873b6d6dd382717ba5ff9c6683abfe9a4c6837e"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2MDMxODUy", "url": "https://github.com/hapifhir/hapi-fhir/pull/2067#pullrequestreview-486031852", "createdAt": "2020-09-10T15:03:30Z", "commit": {"oid": "c873b6d6dd382717ba5ff9c6683abfe9a4c6837e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNTowMzozMFrOHP4fvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNTowMzozMFrOHP4fvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQxNjMxOA==", "bodyText": "It looks like the else clause above has created a gap in the test coverage for the case where a concept map version is specified but no URL is specified. To be honest, I am not sure if this would even be a valid use case. I would suggest either removing the else clause (e.g. ignore the version if no URL is specified) or adding a JUnit test for this use case.", "url": "https://github.com/hapifhir/hapi-fhir/pull/2067#discussion_r486416318", "createdAt": "2020-09-10T15:03:30Z", "author": {"login": "IanMMarshall"}, "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/term/BaseTermReadSvcImpl.java", "diffHunk": "@@ -1946,6 +1969,25 @@ ConceptSubsumptionOutcome testForSubsumption(FullTextEntityManager theEntityMana\n \t\t\t\t\tpredicates.add(criteriaBuilder.equal(groupJoin.get(\"myTarget\"), translationQuery.getTargetSystem().getValueAsString()));\n \t\t\t\t}\n \n+\t\t\t\tif (translationQuery.hasUrl()) { \n+\t\t\t\t\tpredicates.add(criteriaBuilder.equal(conceptMapJoin.get(\"myUrl\"), translationQuery.getUrl().getValueAsString()));\n+\t\t\t\t\tif (translationQuery.hasConceptMapVersion()) {\n+\t\t\t\t\t\t// both url and conceptMapVersion\n+\t\t\t\t\t\tpredicates.add(criteriaBuilder.equal(conceptMapJoin.get(\"myVersion\"), translationQuery.getConceptMapVersion().getValueAsString()));\n+\t\t\t\t\t} else {\n+\t\t\t\t\t\tif (StringUtils.isNotBlank(latestConceptMapVersion)) {\n+\t\t\t\t\t\t\t// only url and use latestConceptMapVersion\n+\t\t\t\t\t\t\tpredicates.add(criteriaBuilder.equal(conceptMapJoin.get(\"myVersion\"), latestConceptMapVersion));\n+\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\tpredicates.add(criteriaBuilder.isNull(conceptMapJoin.get(\"myVersion\")));\n+\t\t\t\t\t\t}\n+\t\t\t\t\t}\n+\t\t\t\t} else {\n+\t\t\t\t\tif (translationQuery.hasConceptMapVersion()) {\n+\t\t\t\t\t\tpredicates.add(criteriaBuilder.equal(conceptMapJoin.get(\"myVersion\"), translationQuery.getConceptMapVersion().getValueAsString()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c873b6d6dd382717ba5ff9c6683abfe9a4c6837e"}, "originalPosition": 93}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2MDMyMzUy", "url": "https://github.com/hapifhir/hapi-fhir/pull/2067#pullrequestreview-486032352", "createdAt": "2020-09-10T15:04:00Z", "commit": {"oid": "c873b6d6dd382717ba5ff9c6683abfe9a4c6837e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNTowNDowMFrOHP4hJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNTowNDowMFrOHP4hJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQxNjY3Nw==", "bodyText": "It looks like the else clause above has created a gap in the test coverage for the case where a concept map version is specified but no URL is specified. To be honest, I am not sure if this would even be a valid use case. I would suggest either removing the else clause (e.g. ignore the version if no URL is specified) or adding a JUnit test for this use case.", "url": "https://github.com/hapifhir/hapi-fhir/pull/2067#discussion_r486416677", "createdAt": "2020-09-10T15:04:00Z", "author": {"login": "IanMMarshall"}, "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/term/BaseTermReadSvcImpl.java", "diffHunk": "@@ -2029,6 +2077,25 @@ ConceptSubsumptionOutcome testForSubsumption(FullTextEntityManager theEntityMana\n \t\t\t\t\tpredicates.add(criteriaBuilder.equal(groupJoin.get(\"myTargetVersion\"), coding.getVersion()));\n \t\t\t\t}\n \n+\t\t\t\tif (translationQuery.hasUrl()) { \n+\t\t\t\t\tpredicates.add(criteriaBuilder.equal(conceptMapJoin.get(\"myUrl\"), translationQuery.getUrl().getValueAsString()));\n+\t\t\t\t\tif (translationQuery.hasConceptMapVersion()) {\n+\t\t\t\t\t\t// both url and conceptMapVersion\n+\t\t\t\t\t\tpredicates.add(criteriaBuilder.equal(conceptMapJoin.get(\"myVersion\"), translationQuery.getConceptMapVersion().getValueAsString()));\n+\t\t\t\t\t} else {\n+\t\t\t\t\t\tif (StringUtils.isNotBlank(latestConceptMapVersion)) {\n+\t\t\t\t\t\t\t// only url and use latestConceptMapVersion\n+\t\t\t\t\t\t\tpredicates.add(criteriaBuilder.equal(conceptMapJoin.get(\"myVersion\"), latestConceptMapVersion));\n+\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\tpredicates.add(criteriaBuilder.isNull(conceptMapJoin.get(\"myVersion\")));\n+\t\t\t\t\t\t}\n+\t\t\t\t\t}\n+\t\t\t\t} else {\n+\t\t\t\t\tif (translationQuery.hasConceptMapVersion()) {\n+\t\t\t\t\t\tpredicates.add(criteriaBuilder.equal(conceptMapJoin.get(\"myVersion\"), translationQuery.getConceptMapVersion().getValueAsString()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c873b6d6dd382717ba5ff9c6683abfe9a4c6837e"}, "originalPosition": 132}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2MDM2OTIy", "url": "https://github.com/hapifhir/hapi-fhir/pull/2067#pullrequestreview-486036922", "createdAt": "2020-09-10T15:08:29Z", "commit": {"oid": "c873b6d6dd382717ba5ff9c6683abfe9a4c6837e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNTowODoyOVrOHP4ucg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNTowODoyOVrOHP4ucg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQyMDA4Mg==", "bodyText": "Might need a JUnit test for the case where translate is requested with a URL and no version, but the requested ConceptMap is not versioned in the repository.", "url": "https://github.com/hapifhir/hapi-fhir/pull/2067#discussion_r486420082", "createdAt": "2020-09-10T15:08:29Z", "author": {"login": "IanMMarshall"}, "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/term/BaseTermReadSvcImpl.java", "diffHunk": "@@ -2094,6 +2161,20 @@ void throwInvalidValueSet(String theValueSet) {\n \t\tthrow new ResourceNotFoundException(\"Unknown ValueSet: \" + UrlUtil.escapeUrlParam(theValueSet));\n \t}\n \n+\t// Special case for the translate operation with url and without\n+\t// conceptMapVersion, find the latest conecptMapVersion\n+\tprivate String getLatestConceptMapVersion(TranslationRequest theTranslationRequest) {\n+\n+\t\tPageable page = PageRequest.of(0, 1);\n+\t\tList<TermConceptMap> theConceptMapList = myConceptMapDao.findTermConceptMapByUrl(page,\n+\t\t\t\ttheTranslationRequest.getUrl().asStringValue());\n+\t\tif (!theConceptMapList.isEmpty()) {\n+\t\t\treturn theConceptMapList.get(0).getVersion();\n+\t\t}\n+\n+\t\treturn null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c873b6d6dd382717ba5ff9c6683abfe9a4c6837e"}, "originalPosition": 154}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2MTA1ODM4", "url": "https://github.com/hapifhir/hapi-fhir/pull/2067#pullrequestreview-486105838", "createdAt": "2020-09-10T16:22:09Z", "commit": {"oid": "c873b6d6dd382717ba5ff9c6683abfe9a4c6837e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNjoyMjowOVrOHP79XA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNjoyMjowOVrOHP79XA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ3MzA1Mg==", "bodyText": "nitpick - comment should say should return the latest one which in this case is not versioned.", "url": "https://github.com/hapifhir/hapi-fhir/pull/2067#discussion_r486473052", "createdAt": "2020-09-10T16:22:09Z", "author": {"login": "IanMMarshall"}, "path": "hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/dao/dstu3/FhirResourceDaoDstu3ConceptMapTest.java", "diffHunk": "@@ -98,4 +107,74 @@ protected void doInTransactionWithoutResult(TransactionStatus theStatus) {\n \t\t});\n \t}\n \n+\t@Test\n+\tpublic void testConcaptMapFindTermConceptMapByUrl() {\n+\t\t\t\n+\t\tPageable page = PageRequest.of(0, 1);\n+\t\tList<TermConceptMap> theExpConceptMapList = myTermConceptMapDao.findTermConceptMapByUrl(page, CM_URL);\n+\t\tassertEquals(1, theExpConceptMapList.size());\n+\t\tassertEquals(CM_URL, theExpConceptMapList.get(0).getUrl());\n+\t\t\n+\t}\n+\n+\t@Test\n+\tpublic void testConcaptMapTwoConceptMapWithSameUrlDifferentVersion() {\n+\t\t\t\t\n+\t\tString theUrl = \"http://loinc.org/property/analyte-suffix\";\n+\t\tConceptMap theConceptMap1 = new ConceptMap();\n+\t\tConceptMap theConceptMap2 = new ConceptMap();\n+\t\t\n+\t\ttheConceptMap1.setUrl(theUrl).setStatus(PublicationStatus.ACTIVE).setName(\"name1\").setVersion(\"v1\");\n+\t\ttheConceptMap2.setUrl(theUrl).setStatus(PublicationStatus.ACTIVE).setName(\"name2\").setVersion(\"v2\");\n+\t\t\n+\t\tmyConceptMapDao.create(theConceptMap1);\n+\t\tmyConceptMapDao.create(theConceptMap2);\n+\t\t\n+\t\tOptional<TermConceptMap> theExpConceptMapV1 = myTermConceptMapDao.findTermConceptMapByUrlAndVersion(theUrl, \"v1\");\n+\t\tOptional<TermConceptMap> theExpConceptMapV2 = myTermConceptMapDao.findTermConceptMapByUrlAndVersion(theUrl, \"v2\");\n+\t\t\n+\t\tassertTrue(theExpConceptMapV1.isPresent());\n+\t\tassertEquals(theUrl, theExpConceptMapV1.get().getUrl());\n+\t\tassertEquals(\"v1\", theExpConceptMapV1.get().getVersion());\n+\t\t\n+\t\tassertTrue(theExpConceptMapV2.isPresent());\n+\t\tassertEquals(theUrl, theExpConceptMapV2.get().getUrl());\n+\t\tassertEquals(\"v2\", theExpConceptMapV2.get().getVersion());\n+\n+\t\t// should return the latest one which is v2\n+\t\tPageable page = PageRequest.of(0, 1);\n+\t\tList<TermConceptMap> theExpSecondOne = myTermConceptMapDao.findTermConceptMapByUrl(page, theUrl);\n+\t\t\n+\t\tassertEquals(1, theExpSecondOne.size());\n+\t\tassertEquals(theUrl, theExpSecondOne.get(0).getUrl());\n+\t\tassertEquals(\"v2\", theExpSecondOne.get(0).getVersion());\n+\t}\n+\n+\t@Test\n+\tpublic void testConcaptMapTwoConceptMapWithSameUrlOneWithoutVersion() {\n+\t\t\t\t\n+\t\tString theUrl = \"http://loinc.org/property/analyte-suffix\";\n+\t\tConceptMap theConceptMap1 = new ConceptMap();\n+\t\tConceptMap theConceptMap2 = new ConceptMap();\n+\t\t\n+\t\ttheConceptMap1.setUrl(theUrl).setStatus(PublicationStatus.ACTIVE).setName(\"name1\").setVersion(\"v1\");\n+\t\ttheConceptMap2.setUrl(theUrl).setStatus(PublicationStatus.ACTIVE).setName(\"name2\");\n+\t\t\n+\t\tmyConceptMapDao.create(theConceptMap1);\n+\t\tmyConceptMapDao.create(theConceptMap2);\n+\t\t\n+\t\tOptional<TermConceptMap> theExpConceptMapV1 = myTermConceptMapDao.findTermConceptMapByUrlAndVersion(theUrl, \"v1\");\n+\t\t\n+\t\tassertTrue(theExpConceptMapV1.isPresent());\n+\t\tassertEquals(theUrl, theExpConceptMapV1.get().getUrl());\n+\t\tassertEquals(\"v1\", theExpConceptMapV1.get().getVersion());\n+\t\t\n+\t\t// should return the latest one which is v2", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c873b6d6dd382717ba5ff9c6683abfe9a4c6837e"}, "originalPosition": 105}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2MTEyMDI2", "url": "https://github.com/hapifhir/hapi-fhir/pull/2067#pullrequestreview-486112026", "createdAt": "2020-09-10T16:29:47Z", "commit": {"oid": "c873b6d6dd382717ba5ff9c6683abfe9a4c6837e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNjoyOTo0N1rOHP8Qnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNjoyOTo0N1rOHP8Qnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ3Nzk4Mw==", "bodyText": "nitpick: method ConceptMap spelled as ConcaptMap in the method name.", "url": "https://github.com/hapifhir/hapi-fhir/pull/2067#discussion_r486477983", "createdAt": "2020-09-10T16:29:47Z", "author": {"login": "IanMMarshall"}, "path": "hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/dstu3/ResourceProviderDstu3ConceptMapTest.java", "diffHunk": "@@ -114,4 +127,287 @@ public void testTranslateByCodeSystemsAndSourceCodeOneToMany() {\n \t\tpart = getPartByName(param, \"source\");\n \t\tassertEquals(CM_URL, ((UriType) part.getValue()).getValueAsString());\n \t}\n+\t\n+\t@Test\n+\tpublic void testTranslateWithConcaptMapUrlAndVersion() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c873b6d6dd382717ba5ff9c6683abfe9a4c6837e"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2MTE0ODg4", "url": "https://github.com/hapifhir/hapi-fhir/pull/2067#pullrequestreview-486114888", "createdAt": "2020-09-10T16:33:24Z", "commit": {"oid": "c873b6d6dd382717ba5ff9c6683abfe9a4c6837e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNjozMzoyNFrOHP8ZiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNjozMzoyNFrOHP8ZiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ4MDI2NQ==", "bodyText": "You can remove this class now (I added it for illustration purposes, but the ResourceProviderDstu3ConceptMapTest class provides adequate coverage now).", "url": "https://github.com/hapifhir/hapi-fhir/pull/2067#discussion_r486480265", "createdAt": "2020-09-10T16:33:24Z", "author": {"login": "IanMMarshall"}, "path": "hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/dstu3/ResourceProviderDstu3ConceptMap_Ian_Test.java", "diffHunk": "@@ -0,0 +1,296 @@\n+package ca.uhn.fhir.jpa.provider.dstu3;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c873b6d6dd382717ba5ff9c6683abfe9a4c6837e"}, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "972bdbd87d86c23f8c6800e5f6a2e438733547c2", "author": {"user": {"login": "frankjtao", "name": "Frank Tao"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/972bdbd87d86c23f8c6800e5f6a2e438733547c2", "committedDate": "2020-09-11T01:17:41Z", "message": "Updated based on code review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "750cbf4ba3ffd22afbd71518e5b41d229bd66750", "author": {"user": {"login": "frankjtao", "name": "Frank Tao"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/750cbf4ba3ffd22afbd71518e5b41d229bd66750", "committedDate": "2020-09-11T13:20:01Z", "message": "@Deprecated the old findTermConceptMapByUrl method"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3845, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}