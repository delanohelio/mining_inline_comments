{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE0MTAzNjMx", "number": 1832, "title": "Transaction write performance fix", "bodyText": "", "createdAt": "2020-05-06T13:40:16Z", "url": "https://github.com/hapifhir/hapi-fhir/pull/1832", "merged": true, "mergeCommit": {"oid": "b67509d7ff80916f51ff8f3de0731fe0a09375b7"}, "closed": true, "closedAt": "2020-05-07T14:56:42Z", "author": {"login": "jamesagnew"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABceocM6gH2gAyNDE0MTAzNjMxOjliNzIxYWM1YjY4MGUyOGI5YzIwMWY2NGY5ODg2ZjIwOTJmMzY3Mjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcexWAsAH2gAyNDE0MTAzNjMxOmRkNzg1NjcwN2M4MDBmNjlmMGE3ZGY1MTUwYTU5NDBlM2E4ZTU0YzE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9b721ac5b680e28b9c201f64f9886f2092f36728", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/9b721ac5b680e28b9c201f64f9886f2092f36728", "committedDate": "2020-05-06T13:10:49Z", "message": "Performance fix for transactions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9fecd41917f8a9f8d7e62733b5589da3cc9f30af", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/9fecd41917f8a9f8d7e62733b5589da3cc9f30af", "committedDate": "2020-05-06T13:39:38Z", "message": "Test fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0b750efaf3b6aeff411eba761a9d65b65bf48db", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/d0b750efaf3b6aeff411eba761a9d65b65bf48db", "committedDate": "2020-05-06T17:40:32Z", "message": "Fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93225a79dbc81ed31683b9abf646fbe2f9f63a96", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/93225a79dbc81ed31683b9abf646fbe2f9f63a96", "committedDate": "2020-05-06T18:21:29Z", "message": "Add docs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2OTAwNDYx", "url": "https://github.com/hapifhir/hapi-fhir/pull/1832#pullrequestreview-406900461", "createdAt": "2020-05-06T18:57:57Z", "commit": {"oid": "93225a79dbc81ed31683b9abf646fbe2f9f63a96"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxODo1Nzo1N1rOGRhFLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxOTowMzowN1rOGRhQ2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAyMDk3NA==", "bodyText": "Was the optimization mostly just adding caching here?", "url": "https://github.com/hapifhir/hapi-fhir/pull/1832#discussion_r421020974", "createdAt": "2020-05-06T18:57:57Z", "author": {"login": "tadgh"}, "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/index/IdHelperService.java", "diffHunk": "@@ -364,20 +364,42 @@ private Long resolveResourceIdentity(@Nonnull RequestPartitionId theRequestParti\n \t}\n \n \tprivate void resolvePids(@Nonnull RequestPartitionId theRequestPartitionId, List<Long> thePidsToResolve, List<IResourceLookup> theTarget) {\n-\t\tCollection<Object[]> lookup;\n-\t\tif (theRequestPartitionId.isAllPartitions()) {\n-\t\t\tlookup = myResourceTableDao.findLookupFieldsByResourcePid(thePidsToResolve);\n-\t\t} else {\n-\t\t\tif (theRequestPartitionId.getPartitionId() != null) {\n-\t\t\t\tlookup = myResourceTableDao.findLookupFieldsByResourcePidInPartition(thePidsToResolve, theRequestPartitionId.getPartitionId());\n+\n+\t\tif (!myDaoConfig.isDeleteEnabled()) {\n+\t\t\tfor (Iterator<Long> forcedIdIterator = thePidsToResolve.iterator(); forcedIdIterator.hasNext(); ) {\n+\t\t\t\tLong nextPid = forcedIdIterator.next();\n+\t\t\t\tString nextKey = Long.toString(nextPid);\n+\t\t\t\tIResourceLookup cachedLookup = myResourceLookupCache.getIfPresent(nextKey);\n+\t\t\t\tif (cachedLookup != null) {\n+\t\t\t\t\tforcedIdIterator.remove();\n+\t\t\t\t\ttheTarget.add(cachedLookup);\n+\t\t\t\t}\n+\t\t\t}\n+\t\t}\n+\n+\t\tif (thePidsToResolve.size() > 0) {\n+\t\t\tCollection<Object[]> lookup;\n+\t\t\tif (theRequestPartitionId.isAllPartitions()) {\n+\t\t\t\tlookup = myResourceTableDao.findLookupFieldsByResourcePid(thePidsToResolve);\n \t\t\t} else {\n-\t\t\t\tlookup = myResourceTableDao.findLookupFieldsByResourcePidInPartitionNull(thePidsToResolve);\n+\t\t\t\tif (theRequestPartitionId.getPartitionId() != null) {\n+\t\t\t\t\tlookup = myResourceTableDao.findLookupFieldsByResourcePidInPartition(thePidsToResolve, theRequestPartitionId.getPartitionId());\n+\t\t\t\t} else {\n+\t\t\t\t\tlookup = myResourceTableDao.findLookupFieldsByResourcePidInPartitionNull(thePidsToResolve);\n+\t\t\t\t}\n \t\t\t}\n+\t\t\tlookup\n+\t\t\t\t.stream()\n+\t\t\t\t.map(t -> new ResourceLookup((String) t[0], (Long) t[1], (Date) t[2]))\n+\t\t\t\t.forEach(t->{\n+\t\t\t\t\ttheTarget.add(t);\n+\t\t\t\t\tif (!myDaoConfig.isDeleteEnabled()) {\n+\t\t\t\t\t\tString nextKey = Long.toString(t.getResourceId());\n+\t\t\t\t\t\tmyResourceLookupCache.put(nextKey, t);\n+\t\t\t\t\t}\n+\t\t\t\t});\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93225a79dbc81ed31683b9abf646fbe2f9f63a96"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAyMzk2MA==", "bodyText": "withing -> within", "url": "https://github.com/hapifhir/hapi-fhir/pull/1832#discussion_r421023960", "createdAt": "2020-05-06T19:03:07Z", "author": {"login": "tadgh"}, "path": "hapi-fhir-jpaserver-model/src/main/java/ca/uhn/fhir/jpa/model/util/TransactionDetails.java", "diffHunk": "@@ -0,0 +1,90 @@\n+package ca.uhn.fhir.jpa.model.util;\n+\n+/*-\n+ * #%L\n+ * HAPI FHIR Model\n+ * %%\n+ * Copyright (C) 2014 - 2020 University Health Network\n+ * %%\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * #L%\n+ */\n+\n+import ca.uhn.fhir.jpa.model.cross.ResourcePersistentId;\n+import org.hl7.fhir.instance.model.api.IIdType;\n+\n+import java.util.Collections;\n+import java.util.Date;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+/**\n+ * This object contains runtime information that is gathered and relevant to a single <i>database transaction</i>.\n+ * This doesn't mean a FHIR transaction necessarily, but rather any operation that happens withing a single DB transaction", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93225a79dbc81ed31683b9abf646fbe2f9f63a96"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd7856707c800f69f0a7df5150a5940e3a8e54c1", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/dd7856707c800f69f0a7df5150a5940e3a8e54c1", "committedDate": "2020-05-06T23:33:12Z", "message": "Test fixes"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4071, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}