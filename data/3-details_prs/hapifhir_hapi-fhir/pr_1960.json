{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ0MTQyMjE5", "number": 1960, "title": "Accidentally merged pull request before pushing changes from code review", "bodyText": "", "createdAt": "2020-07-03T17:11:15Z", "url": "https://github.com/hapifhir/hapi-fhir/pull/1960", "merged": true, "mergeCommit": {"oid": "e23e222f803c08e71a53bd63188c67b0dcabcb33"}, "closed": true, "closedAt": "2020-07-03T20:29:34Z", "author": {"login": "IanMMarshall"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcxWmXHgH2gAyNDQ0MTQyMjE5OjRlNWNhMmVlMTVkMzg0Y2ZmZmFiNjJhYmJhNzczYWFjODk4ZTZhYmM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcxXtDiAH2gAyNDQ0MTQyMjE5OmIxZmY2Y2JlMzc4ZjlkZTA4NGIwMjAzNWVhODBiNDMzYTE0NDM1N2Q=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4e5ca2ee15d384cfffab62abba773aac898e6abc", "author": {"user": null}, "url": "https://github.com/hapifhir/hapi-fhir/commit/4e5ca2ee15d384cfffab62abba773aac898e6abc", "committedDate": "2020-07-03T17:08:11Z", "message": "Changes from code review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNTE0MzQz", "url": "https://github.com/hapifhir/hapi-fhir/pull/1960#pullrequestreview-442514343", "createdAt": "2020-07-03T17:16:20Z", "commit": {"oid": "4e5ca2ee15d384cfffab62abba773aac898e6abc"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxNzoxNjoyMVrOGs1UBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxNzoxNjo1MlrOGs1UdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTY2NDAwNg==", "bodyText": "change to ourLog.error\nAlso, the exception is getting lost.\nI suggest log the exception in a separate ourLog.error(\"exception: \", theE)", "url": "https://github.com/hapifhir/hapi-fhir/pull/1960#discussion_r449664006", "createdAt": "2020-07-03T17:16:21Z", "author": {"login": "fil512"}, "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/term/TermDeferredStorageSvcImpl.java", "diffHunk": "@@ -145,10 +146,10 @@ private void processDeferredConcepts() {\n \t\tourLog.info(\"Saving {} deferred concepts...\", count);\n \t\twhile (codeCount < count && myDeferredConcepts.size() > 0) {\n \t\t\tTermConcept next = myDeferredConcepts.remove(0);\n-\t\t\tif(myCodeSystemVersionDao.findById(next.getCodeSystemVersion().getPid()).isPresent()) {\n+\t\t\ttry {\n          \tcodeCount += myCodeSystemStorageSvc.saveConcept(next);\n-\t\t\t} else {\n-\t\t\t\tourLog.warn(\"Unable to save deferred TermConcept {} because Code System {} version PID {} is no longer valid. Code system may have since been replaced.\",\n+\t\t\t} catch (Exception theE) {\n+\t\t\t\tourLog.warn(\"Unable to save deferred TermConcept {}, possibly because Code System {} version PID {} may have since been replaced.\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e5ca2ee15d384cfffab62abba773aac898e6abc"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTY2NDExNw==", "bodyText": "Nice!!  Super helpful!", "url": "https://github.com/hapifhir/hapi-fhir/pull/1960#discussion_r449664117", "createdAt": "2020-07-03T17:16:52Z", "author": {"login": "fil512"}, "path": "hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/term/TermCodeSystemStorageSvcTest.java", "diffHunk": "@@ -12,33 +12,40 @@\n \n \tpublic static final String URL_MY_CODE_SYSTEM = \"http://example.com/my_code_system\";\n \n-\tprivate CodeSystem createCodeSystemWithMoreThan100Concepts() {\n-\t\tCodeSystem codeSystem = new CodeSystem();\n-\t\tcodeSystem.setUrl(URL_MY_CODE_SYSTEM);\n-\t\tcodeSystem.setContent(CodeSystem.CodeSystemContentMode.NOTPRESENT);\n-\n-\t\tfor (int i = 0; i < 125; i++) {\n-\t\t\tcodeSystem.addConcept(new CodeSystem.ConceptDefinitionComponent(new CodeType(\"codeA \" + i)));\n-\t\t}\n-\n-\t\treturn codeSystem;\n-\n-\t}\n-\n \t@Test\n \tpublic void testStoreNewCodeSystemVersionForExistingCodeSystem() {\n \t\tCodeSystem upload = createCodeSystemWithMoreThan100Concepts();\n \n+\t\t// Create CodeSystem resource\n \t\tResourceTable codeSystemResourceEntity = (ResourceTable)myCodeSystemDao.create(upload, mySrd).getEntity();\n \n+\t\t// Update the CodeSystem resource\n \t\trunInTransaction(() -> myTermCodeSystemStorageSvc.storeNewCodeSystemVersionIfNeeded(upload, codeSystemResourceEntity));\n \n+\t\t/*\n+\t\t\tBecause there are more than 100 concepts in the code system, the first 100 will be persisted immediately and\n+\t\t\tthe remaining 25 concepts will be queued up for \"deferred save\".\n+\n+\t\t\tAs the CodeSystem was persisted twice, the extra 25 term concepts will be queued twice, each with a different", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e5ca2ee15d384cfffab62abba773aac898e6abc"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1ff6cbe378f9de084b02035ea80b433a144357d", "author": {"user": null}, "url": "https://github.com/hapifhir/hapi-fhir/commit/b1ff6cbe378f9de084b02035ea80b433a144357d", "committedDate": "2020-07-03T18:25:24Z", "message": "Changes from code review"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3978, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}