{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIyMDkyNTYx", "number": 2177, "reviewThreads": {"totalCount": 79, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNzo0MTowOVrOE6I4FA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxODozMToxM1rOFB7F_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5Mzk4MjkyOnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/entity/EmpiLink.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNzo0MTowOVrOH1BQug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNzo0MTowOVrOH1BQug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM1NzI0Mg==", "bodyText": "Consider changing to GOLDEN_RESOURCE_PID and renaming variable to myGoldenResourcePid", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525357242", "createdAt": "2020-11-17T17:41:09Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/entity/EmpiLink.java", "diffHunk": "@@ -60,6 +60,13 @@\n \t@Column(name = \"PID\")\n \tprivate Long myId;\n \n+\t@ManyToOne(optional = false, fetch = FetchType.LAZY, cascade = {})", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5Mzk4Njk3OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/entity/EmpiLink.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNzo0MjowN1rOH1BTTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNzo0MjowN1rOH1BTTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM1NzkwMQ==", "bodyText": "Change to myGoldenResourcePid, and add rule count", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525357901", "createdAt": "2020-11-17T17:42:07Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/entity/EmpiLink.java", "diffHunk": "@@ -289,18 +303,27 @@ public EmpiLink setEmpiTargetType(String theEmpiTargetType) {\n \tpublic String toString() {\n \t\treturn new ToStringBuilder(this)\n \t\t\t.append(\"myId\", myId)\n-\t\t\t.append(\"myPersonPid\", myPersonPid)\n+\t\t\t.append(\"myPersonPid\", mySourceResourcePid)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 100}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5Mzk4ODAwOnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-empi/smile.basedir_IS_UNDEFINED/Link Service.puml", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNzo0MjoyMVrOH1BT4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNzo0MjoyMVrOH1BT4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM1ODA1MQ==", "bodyText": "Should be removed", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525358051", "createdAt": "2020-11-17T17:42:21Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-jpaserver-empi/smile.basedir_IS_UNDEFINED/Link Service.puml", "diffHunk": "@@ -0,0 +1,26 @@\n+@startuml", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5Mzk5MDMxOnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/broker/EmpiMessageHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNzo0Mjo1MlrOH1BVPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNzo0Mjo1MlrOH1BVPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM1ODM5OA==", "bodyText": "Rename to myMdmSettings", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525358398", "createdAt": "2020-11-17T17:42:52Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/broker/EmpiMessageHandler.java", "diffHunk": "@@ -106,51 +108,51 @@ public void matchEmpiAndUpdateLinks(ResourceModifiedMessage theMsg) {\n \t\t}\n \t}\n \n-\tprivate EmpiTransactionContext createEmpiContext(ResourceModifiedMessage theMsg) {\n+\tprivate MdmTransactionContext createEmpiContext(ResourceModifiedMessage theMsg, String theResourceType) {\n \t\tTransactionLogMessages transactionLogMessages = TransactionLogMessages.createFromTransactionGuid(theMsg.getTransactionId());\n-\t\tEmpiTransactionContext.OperationType empiOperation;\n+\t\tMdmTransactionContext.OperationType empiOperation;\n \t\tswitch (theMsg.getOperationType()) {\n \t\t\tcase CREATE:\n-\t\t\t\tempiOperation = EmpiTransactionContext.OperationType.CREATE_RESOURCE;\n+\t\t\t\tempiOperation = MdmTransactionContext.OperationType.CREATE_RESOURCE;\n \t\t\t\tbreak;\n \t\t\tcase UPDATE:\n-\t\t\t\tempiOperation = EmpiTransactionContext.OperationType.UPDATE_RESOURCE;\n+\t\t\t\tempiOperation = MdmTransactionContext.OperationType.UPDATE_RESOURCE;\n \t\t\t\tbreak;\n \t\t\tcase MANUALLY_TRIGGERED:\n-\t\t\t\tempiOperation = EmpiTransactionContext.OperationType.SUBMIT_RESOURCE_TO_EMPI;\n+\t\t\t\tempiOperation = MdmTransactionContext.OperationType.SUBMIT_RESOURCE_TO_EMPI;\n \t\t\t\tbreak;\n \t\t\tcase DELETE:\n \t\t\tdefault:\n \t\t\t\tourLog.trace(\"Not creating an EmpiTransactionContext for {}\", theMsg.getOperationType());\n \t\t\t\tthrow new InvalidRequestException(\"We can't handle non-update/create operations in EMPI\");\n \t\t}\n-\t\treturn new EmpiTransactionContext(transactionLogMessages, empiOperation);\n+\t\treturn new MdmTransactionContext(transactionLogMessages, empiOperation, theResourceType);\n \t}\n \n \tprivate void validateResourceType(String theResourceType) {\n-\t\tif (!EmpiUtil.supportedTargetType(theResourceType)) {\n+\t\tif (!myEmpiSettings.isSupportedMdmType(theResourceType)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 63}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5Mzk5MzI2OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/config/EmpiConsumerConfig.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNzo0MzozNlrOH1BXCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNzo0MzozNlrOH1BXCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM1ODg1OQ==", "bodyText": "Chance Empi prefix to Mdm and rename variables appropriately.", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525358859", "createdAt": "2020-11-17T17:43:36Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/config/EmpiConsumerConfig.java", "diffHunk": "@@ -168,8 +174,8 @@ IEmpiLinkQuerySvc empiLinkQuerySvc() {\n \t}\n \n \t@Bean\n-\tIEmpiExpungeSvc empiResetSvc(EmpiLinkDaoSvc theEmpiLinkDaoSvc, EmpiPersonDeletingSvc theEmpiPersonDeletingSvcImpl ) {\n-\t\treturn new EmpiClearSvcImpl(theEmpiLinkDaoSvc, theEmpiPersonDeletingSvcImpl);\n+\tIEmpiExpungeSvc empiResetSvc(EmpiLinkDaoSvc theEmpiLinkDaoSvc, EmpiPersonDeletingSvc theEmpiPersonDeletingSvcImpl, IEmpiSettings theIEmpiSettings) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 72}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5Mzk5NTQ5OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/config/EmpiConsumerConfig.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNzo0NDowNVrOH1BYTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNzo0NDowNVrOH1BYTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM1OTE4Mg==", "bodyText": "Change Empi prefix to Mdm and rename variables appropriately.", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525359182", "createdAt": "2020-11-17T17:44:05Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/config/EmpiConsumerConfig.java", "diffHunk": "@@ -223,8 +229,12 @@ EmpiResourceFilteringSvc empiResourceFilteringSvc() {\n \t}\n \n \t@Bean\n-\tEmpiControllerHelper empiProviderHelper(FhirContext theFhirContext, IResourceLoader theResourceLoader) { return new EmpiControllerHelper(theFhirContext, theResourceLoader); }\n+\tEmpiControllerHelper empiProviderHelper(FhirContext theFhirContext, IResourceLoader theResourceLoader, IEmpiSettings theEmpiSettings, MessageHelper messageHelper) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 91}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDAxMTQ5OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/config/EmpiSearchParameterLoader.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNzo0Nzo1MFrOH1BiNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNzo0Nzo1MFrOH1BiNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM2MTcxOQ==", "bodyText": "This functionality is pending further requirements elicitation?", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525361719", "createdAt": "2020-11-17T17:47:50Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/config/EmpiSearchParameterLoader.java", "diffHunk": "@@ -78,7 +78,7 @@ private SearchParameter buildAssuranceEmpiSearchParameterR4() {\n \t\tSearchParameter retval = new SearchParameter();\n \t\tretval.setId(EMPI_PERSON_ASSURANCE_SEARCH_PARAMETER_ID);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDAxNDgzOnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/dao/EmpiLinkDaoSvc.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNzo0ODoyMFrOH1BkeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNzo0ODoyMFrOH1BkeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM2MjI5Nw==", "bodyText": "Rename source to golden", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525362297", "createdAt": "2020-11-17T17:48:20Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/dao/EmpiLinkDaoSvc.java", "diffHunk": "@@ -59,61 +60,60 @@\n \tprivate FhirContext myFhirContext;\n \n \t@Transactional\n-\tpublic EmpiLink createOrUpdateLinkEntity(IBaseResource thePerson, IBaseResource theTarget, EmpiMatchOutcome theMatchOutcome, EmpiLinkSourceEnum theLinkSource, @Nullable EmpiTransactionContext theEmpiTransactionContext) {\n-\t\tLong personPid = myIdHelperService.getPidOrNull(thePerson);\n-\t\tLong resourcePid = myIdHelperService.getPidOrNull(theTarget);\n+\tpublic EmpiLink createOrUpdateLinkEntity(IBaseResource theSourceResource, IBaseResource theTargetResource, EmpiMatchOutcome theMatchOutcome, EmpiLinkSourceEnum theLinkSource, @Nullable MdmTransactionContext theMdmTransactionContext) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDAxNzAwOnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/dao/EmpiLinkDaoSvc.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNzo0ODozN1rOH1Bl5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNzo0ODozN1rOH1Bl5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM2MjY2Mw==", "bodyText": "Rename source to golden", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525362663", "createdAt": "2020-11-17T17:48:37Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/dao/EmpiLinkDaoSvc.java", "diffHunk": "@@ -59,61 +60,60 @@\n \tprivate FhirContext myFhirContext;\n \n \t@Transactional\n-\tpublic EmpiLink createOrUpdateLinkEntity(IBaseResource thePerson, IBaseResource theTarget, EmpiMatchOutcome theMatchOutcome, EmpiLinkSourceEnum theLinkSource, @Nullable EmpiTransactionContext theEmpiTransactionContext) {\n-\t\tLong personPid = myIdHelperService.getPidOrNull(thePerson);\n-\t\tLong resourcePid = myIdHelperService.getPidOrNull(theTarget);\n+\tpublic EmpiLink createOrUpdateLinkEntity(IBaseResource theSourceResource, IBaseResource theTargetResource, EmpiMatchOutcome theMatchOutcome, EmpiLinkSourceEnum theLinkSource, @Nullable MdmTransactionContext theMdmTransactionContext) {\n+\t\tLong sourceResourcePid = myIdHelperService.getPidOrNull(theSourceResource);\n+\t\tLong targetResourcePid = myIdHelperService.getPidOrNull(theTargetResource);\n \n-\t\tEmpiLink empiLink = getOrCreateEmpiLinkByPersonPidAndTargetPid(personPid, resourcePid);\n+\t\tEmpiLink empiLink = getOrCreateEmpiLinkBySourceResourcePidAndTargetResourcePid(sourceResourcePid, targetResourcePid);\n \t\tempiLink.setLinkSource(theLinkSource);\n \t\tempiLink.setMatchResult(theMatchOutcome.getMatchResultEnum());\n \t\t// Preserve these flags for link updates\n \t\tempiLink.setEidMatch(theMatchOutcome.isEidMatch() | empiLink.isEidMatch());\n-\t\tempiLink.setNewPerson(theMatchOutcome.isNewPerson() | empiLink.isNewPerson());\n-\t\tempiLink.setEmpiTargetType(myFhirContext.getResourceType(theTarget));\n+\t\tempiLink.setHadToCreateNewResource(theMatchOutcome.isNewPerson() | empiLink.getHadToCreateNewResource());\n+\t\tempiLink.setEmpiTargetType(myFhirContext.getResourceType(theTargetResource));\n \t\tif (empiLink.getScore() != null) {\n \t\t\tempiLink.setScore(Math.max(theMatchOutcome.score, empiLink.getScore()));\n \t\t} else {\n \t\t\tempiLink.setScore(theMatchOutcome.score);\n \t\t}\n \n-\t\tString message = String.format(\"Creating EmpiLink from %s to %s -> %s\", thePerson.getIdElement().toUnqualifiedVersionless(), theTarget.getIdElement().toUnqualifiedVersionless(), theMatchOutcome);\n-\t\ttheEmpiTransactionContext.addTransactionLogMessage(message);\n+\t\tString message = String.format(\"Creating EmpiLink from %s to %s -> %s\", theSourceResource.getIdElement().toUnqualifiedVersionless(), theTargetResource.getIdElement().toUnqualifiedVersionless(), theMatchOutcome);\n+\t\ttheMdmTransactionContext.addTransactionLogMessage(message);\n \t\tourLog.debug(message);\n \t\tsave(empiLink);\n \t\treturn empiLink;\n \t}\n \n \t@Nonnull\n-\tpublic EmpiLink getOrCreateEmpiLinkByPersonPidAndTargetPid(Long thePersonPid, Long theResourcePid) {\n-\t\tOptional<EmpiLink> oExisting = getLinkByPersonPidAndTargetPid(thePersonPid, theResourcePid);\n+\tpublic EmpiLink getOrCreateEmpiLinkBySourceResourcePidAndTargetResourcePid(Long theSourceResourcePid, Long theTargetResourcePid) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDAzMDY1OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/dao/EmpiLinkDaoSvc.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNzo1MDoxOVrOH1BufQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNzo1MDoxOVrOH1BufQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM2NDg2MQ==", "bodyText": "Rename source to golden and update comments", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525364861", "createdAt": "2020-11-17T17:50:19Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/dao/EmpiLinkDaoSvc.java", "diffHunk": "@@ -162,15 +162,14 @@ public EmpiLink getOrCreateEmpiLinkByPersonPidAndTargetPid(Long thePersonPid, Lo\n \t/**\n \t * Given a person a target and a match result, return the matching EmpiLink, if it exists.\n \t *\n-\t * @param thePersonPid The Pid of the Person in the relationship\n-\t * @param theTargetPid The Pid of the target in the relationship\n+\t * @param thePersonPid   The Pid of the Person in the relationship\n+\t * @param theTargetPid   The Pid of the target in the relationship\n \t * @param theMatchResult The MatchResult you are looking for.\n-\t *\n \t * @return an Optional {@link EmpiLink} containing the matched link if it exists.\n \t */\n \tpublic Optional<EmpiLink> getEmpiLinksByPersonPidTargetPidAndMatchResult(Long thePersonPid, Long theTargetPid, EmpiMatchResultEnum theMatchResult) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 109}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDA0MTg1OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/dao/EmpiLinkDaoSvc.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNzo1MTo1M1rOH1B1jg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNzo1MTo1M1rOH1B1jg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM2NjY3MA==", "bodyText": "rename to goldenResources", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525366670", "createdAt": "2020-11-17T17:51:53Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/dao/EmpiLinkDaoSvc.java", "diffHunk": "@@ -233,14 +231,20 @@ public void deleteLink(EmpiLink theEmpiLink) {\n \t * @return A list of Long representing the related Person Pids.\n \t */\n \t@Transactional\n-\tpublic List<Long> deleteAllEmpiLinksAndReturnPersonPids() {\n+\tpublic List<Long> deleteAllEmpiLinksAndReturnGoldenResourcePids() {\n \t\tList<EmpiLink> all = myEmpiLinkDao.findAll();\n-\t\treturn deleteEmpiLinksAndReturnPersonPids(all);\n+\t\treturn deleteEmpiLinksAndReturnGoldenResourcePids(all);\n \t}\n \n-\tprivate List<Long> deleteEmpiLinksAndReturnPersonPids(List<EmpiLink> theLinks) {\n-\t\tSet<Long> persons = theLinks.stream().map(EmpiLink::getPersonPid).collect(Collectors.toSet());\n-\t\tpersons.addAll(theLinks.stream().filter(link -> \"Person\".equals(link.getEmpiTargetType())).map(EmpiLink::getTargetPid).collect(Collectors.toSet()));\n+\tprivate List<Long> deleteEmpiLinksAndReturnGoldenResourcePids(List<EmpiLink> theLinks) {\n+\t\tSet<Long> persons = theLinks.stream().map(EmpiLink::getSourceResourcePid).collect(Collectors.toSet());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 156}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDA0NDQyOnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/dao/EmpiLinkDaoSvc.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNzo1MjoyOFrOH1B3GQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNzo1MjoyOFrOH1B3GQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM2NzA2NQ==", "bodyText": "rename source to golden, update javadocs", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525367065", "createdAt": "2020-11-17T17:52:28Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/dao/EmpiLinkDaoSvc.java", "diffHunk": "@@ -308,12 +308,55 @@ public EmpiLink save(EmpiLink theEmpiLink) {\n \t\treturn myEmpiLinkDao.findAll(example);\n \t}\n \n+\t/**\n+\t * Finds all links pointing from the target resource to the source resource.\n+\t *\n+\t * @param theTargetResource Resource referencing the source resource\n+\t * @param theSourceResource Resource being referenced by the source resource\n+\t *\n+\t * @return\n+\t * \t\tReturns all EMPI links pointing to the source from target resource\n+\t */\n+\tpublic List<EmpiLink> findEmpiLinksByTargetAndSource(IBaseResource theTargetResource, IBaseResource theSourceResource) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 226}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDA1NjA0OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/dao/EmpiLinkDaoSvc.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNzo1NToxMFrOH1B-Xw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNzo1NToxMFrOH1B-Xw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM2ODkyNw==", "bodyText": "May be a good idea to pull todo out of javadocs", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525368927", "createdAt": "2020-11-17T17:55:10Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/dao/EmpiLinkDaoSvc.java", "diffHunk": "@@ -308,12 +308,55 @@ public EmpiLink save(EmpiLink theEmpiLink) {\n \t\treturn myEmpiLinkDao.findAll(example);\n \t}\n \n+\t/**\n+\t * Finds all links pointing from the target resource to the source resource.\n+\t *\n+\t * @param theTargetResource Resource referencing the source resource\n+\t * @param theSourceResource Resource being referenced by the source resource\n+\t *\n+\t * @return\n+\t * \t\tReturns all EMPI links pointing to the source from target resource\n+\t */\n+\tpublic List<EmpiLink> findEmpiLinksByTargetAndSource(IBaseResource theTargetResource, IBaseResource theSourceResource) {\n+\t\tLong targetPid = myIdHelperService.getPidOrNull(theTargetResource);\n+\t\tif (targetPid == null) {\n+\t\t\treturn Collections.emptyList();\n+\t\t}\n+\t\tLong sourcePid = myIdHelperService.getPidOrNull(theSourceResource);\n+\t\tif (sourcePid == null) {\n+\t\t\treturn Collections.emptyList();\n+\t\t}\n+\t\tEmpiLink exampleLink = myEmpiLinkFactory.newEmpiLink().setTargetPid(targetPid).setGoldenResourcePid(sourcePid);\n+\t\tExample<EmpiLink> example = Example.of(exampleLink);\n+\t\treturn myEmpiLinkDao.findAll(example);\n+\t}\n+\n+\t/**\n+\t * Finds all {@link EmpiLink} entities in which theSourceResource's PID is the source\n+\t * of the relationship.\n+\t *\n+\t * @param theSourceResource the source resource to find links for.\n+\t * @return all links for the source.\n+\t */\n+\tpublic List<EmpiLink> findEmpiMatchLinksBySource(IBaseResource theSourceResource) {\n+\t\tLong pid = myIdHelperService.getPidOrNull(theSourceResource);\n+\t\tif (pid == null) {\n+\t\t\treturn Collections.emptyList();\n+\t\t}\n+\t\tEmpiLink exampleLink = myEmpiLinkFactory.newEmpiLink().setGoldenResourcePid(pid);\n+\t\texampleLink.setMatchResult(EmpiMatchResultEnum.MATCH);\n+\t\tExample<EmpiLink> example = Example.of(exampleLink);\n+\t\treturn myEmpiLinkDao.findAll(example);\n+\t}\n+\n \t/**\n \t * Factory delegation method, whenever you need a new EmpiLink, use this factory method.\n \t * //TODO Should we make the constructor private for EmpiLink? or work out some way to ensure they can only be instantiated via factory.\n+\t *", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 261}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDA1OTY0OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/svc/EmpiClearSvcImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNzo1NTo1NlrOH1CAhg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNzo1NTo1NlrOH1CAhg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM2OTQ3OA==", "bodyText": "Fix empi/person in the naming", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525369478", "createdAt": "2020-11-17T17:55:56Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/svc/EmpiClearSvcImpl.java", "diffHunk": "@@ -42,15 +42,17 @@\n \n \tfinal EmpiLinkDaoSvc myEmpiLinkDaoSvc;\n \tfinal EmpiPersonDeletingSvc myEmpiPersonDeletingSvcImpl;\n+\tfinal IEmpiSettings myEmpiSettings;\n \n \t@Autowired\n-\tpublic EmpiClearSvcImpl(EmpiLinkDaoSvc theEmpiLinkDaoSvc, EmpiPersonDeletingSvc theEmpiPersonDeletingSvcImpl) {\n+\tpublic EmpiClearSvcImpl(EmpiLinkDaoSvc theEmpiLinkDaoSvc, EmpiPersonDeletingSvc theEmpiPersonDeletingSvcImpl, IEmpiSettings theIEmpiSettings) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDA2MDc5OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/svc/EmpiClearSvcImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNzo1NjoxNVrOH1CBQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNzo1NjoxNVrOH1CBQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM2OTY2Ng==", "bodyText": "Address empi", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525369666", "createdAt": "2020-11-17T17:56:15Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/svc/EmpiClearSvcImpl.java", "diffHunk": "@@ -60,15 +62,15 @@ public long expungeAllEmpiLinksOfTargetType(String theResourceType, ServletReque\n \t}\n \n \tprivate void throwExceptionIfInvalidTargetType(String theResourceType) {\n-\t\tif (!EmpiUtil.supportedTargetType(theResourceType)) {\n-\t\t\tthrow new InvalidRequestException(ProviderConstants.EMPI_CLEAR + \" does not support resource type: \" + theResourceType);\n+\t\tif (!myEmpiSettings.isSupportedMdmType(theResourceType)) {\n+\t\t\tthrow new InvalidRequestException(ProviderConstants.MDM_CLEAR + \" does not support resource type: \" + theResourceType);\n \t\t}\n \t}\n \n \t@Override\n \tpublic long expungeAllEmpiLinks(ServletRequestDetails theRequestDetails) {\n \t\tourLog.info(\"Clearing all EMPI Links...\");\n-\t\tList<Long> personPids = myEmpiLinkDaoSvc.deleteAllEmpiLinksAndReturnPersonPids();\n+\t\tList<Long> personPids = myEmpiLinkDaoSvc.deleteAllEmpiLinksAndReturnGoldenResourcePids();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDA2MTc1OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/svc/EmpiControllerSvcImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNzo1NjoyOVrOH1CB4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNzo1NjoyOVrOH1CB4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM2OTgyNg==", "bodyText": "rename params", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525369826", "createdAt": "2020-11-17T17:56:29Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/svc/EmpiControllerSvcImpl.java", "diffHunk": "@@ -47,53 +47,53 @@\n \t@Autowired\n \tEmpiControllerHelper myEmpiControllerHelper;\n \t@Autowired\n-\tIEmpiPersonMergerSvc myEmpiPersonMergerSvc;\n+\tIGoldenResourceMergerSvc myEmpiPersonMergerSvc;\n \t@Autowired\n \tIEmpiLinkQuerySvc myEmpiLinkQuerySvc;\n \t@Autowired\n \tIEmpiLinkUpdaterSvc myIEmpiLinkUpdaterSvc;\n \n \t@Override\n-\tpublic IAnyResource mergePersons(String theFromPersonId, String theToPersonId, EmpiTransactionContext theEmpiTransactionContext) {\n-\t\tIAnyResource fromPerson = myEmpiControllerHelper.getLatestPersonFromIdOrThrowException(ProviderConstants.EMPI_MERGE_PERSONS_FROM_PERSON_ID, theFromPersonId);\n-\t\tIAnyResource toPerson = myEmpiControllerHelper.getLatestPersonFromIdOrThrowException(ProviderConstants.EMPI_MERGE_PERSONS_TO_PERSON_ID, theToPersonId);\n+\tpublic IAnyResource mergeGoldenResources(String theFromPersonId, String theToPersonId, MdmTransactionContext theMdmTransactionContext) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDA2ODc0OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/svc/EmpiEidUpdateService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNzo1ODowNVrOH1CGHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNzo1ODowNVrOH1CGHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM3MDkwOA==", "bodyText": "Remove EMPI / SourceResource", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525370908", "createdAt": "2020-11-17T17:58:05Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/svc/EmpiEidUpdateService.java", "diffHunk": "@@ -51,7 +51,7 @@\n \t@Autowired\n \tprivate IEmpiLinkSvc myEmpiLinkSvc;\n \t@Autowired\n-\tprivate EmpiPersonFindingSvc myEmpiPersonFindingSvc;\n+\tprivate EmpiSourceResourceFindingSvc myEmpiSourceResourceFindingSvc;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDA4Nzg3OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/svc/EmpiEidUpdateService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODowMjo0MlrOH1CSCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODowMjo0MlrOH1CSCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM3Mzk2Mw==", "bodyText": "Introduce a boolean flag to remove comments, along the lines of \"isOverwritableEidResource\", may be?", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525373963", "createdAt": "2020-11-17T18:02:42Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/svc/EmpiEidUpdateService.java", "diffHunk": "@@ -61,68 +61,70 @@\n \t@Autowired\n \tprivate IEmpiSettings myEmpiSettings;\n \n-\tvoid handleEmpiUpdate(IAnyResource theResource, MatchedPersonCandidate theMatchedPersonCandidate, EmpiTransactionContext theEmpiTransactionContext) {\n-\n-\t\tEmpiUpdateContext updateContext = new EmpiUpdateContext(theMatchedPersonCandidate, theResource);\n-\n+\tvoid handleEmpiUpdate(IAnyResource theResource, MatchedSourceResourceCandidate theMatchedSourceResourceCandidate, MdmTransactionContext theMdmTransactionContext) {\n+\t\tEmpiUpdateContext updateContext = new EmpiUpdateContext(theMatchedSourceResourceCandidate, theResource);\n \t\tif (updateContext.isRemainsMatchedToSamePerson()) {\n-\t\t\tmyPersonHelper.updatePersonFromUpdatedEmpiTarget(updateContext.getMatchedPerson(), theResource, theEmpiTransactionContext);\n+\t\t\t// Copy over any new external EIDs which don't already exist.\n+\t\t\t// TODO NG - Eventually this call will use terser to clone data in, once the surviorship rules for copying data will be confirmed\n+\t\t\t// myPersonHelper.updatePersonFromUpdatedEmpiTarget(updateContext.getMatchedPerson(), theResource, theEmpiTransactionContext);\n \t\t\tif (!updateContext.isIncomingResourceHasAnEid() || updateContext.isHasEidsInCommon()) {\n \t\t\t\t//update to patient that uses internal EIDs only.\n-\t\t\t\tmyEmpiLinkSvc.updateLink(updateContext.getMatchedPerson(), theResource, theMatchedPersonCandidate.getMatchResult(), EmpiLinkSourceEnum.AUTO, theEmpiTransactionContext);\n+\t\t\t\tmyEmpiLinkSvc.updateLink(updateContext.getMatchedSourceResource(), theResource, theMatchedSourceResourceCandidate.getMatchResult(), EmpiLinkSourceEnum.AUTO, theMdmTransactionContext);\n \t\t\t} else if (!updateContext.isHasEidsInCommon()) {\n-\t\t\t\thandleNoEidsInCommon(theResource, theMatchedPersonCandidate, theEmpiTransactionContext, updateContext);\n+\t\t\t\thandleNoEidsInCommon(theResource, theMatchedSourceResourceCandidate, theMdmTransactionContext, updateContext);\n \t\t\t}\n \t\t} else {\n \t\t\t//This is a new linking scenario. we have to break the existing link and link to the new person. For now, we create duplicate.\n \t\t\t//updated patient has an EID that matches to a new candidate. Link them, and set the persons possible duplicates\n-\t\t\tlinkToNewPersonAndFlagAsDuplicate(theResource, updateContext.getExistingPerson(), updateContext.getMatchedPerson(), theEmpiTransactionContext);\n+\t\t\tlinkToNewPersonAndFlagAsDuplicate(theResource, updateContext.getExistingPerson(), updateContext.getMatchedSourceResource(), theMdmTransactionContext);\n \t\t}\n \t}\n \n-\tprivate void handleNoEidsInCommon(IAnyResource theResource, MatchedPersonCandidate theMatchedPersonCandidate, EmpiTransactionContext theEmpiTransactionContext, EmpiUpdateContext theUpdateContext) {\n+\tprivate void handleNoEidsInCommon(IAnyResource theResource, MatchedSourceResourceCandidate theMatchedSourceResourceCandidate, MdmTransactionContext theMdmTransactionContext, EmpiUpdateContext theUpdateContext) {\n \t\t// the user is simply updating their EID. We propagate this change to the Person.\n \t\t//overwrite. No EIDS in common, but still same person.\n \t\tif (myEmpiSettings.isPreventMultipleEids()) {\n-\t\t\tif (myPersonHelper.getLinkCount(theUpdateContext.getMatchedPerson()) <= 1) { // If there is only 0/1 link on the person, we can safely overwrite the EID.\n-\t\t\t\thandleExternalEidOverwrite(theUpdateContext.getMatchedPerson(), theResource, theEmpiTransactionContext);\n+\t\t\tif (myEmpiLinkDaoSvc.findEmpiMatchLinksBySource(theUpdateContext.getMatchedSourceResource()).size() <= 1) { // If there is only 0/1 link on the person, we can safely overwrite the EID.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 63}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDA4ODY0OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/svc/EmpiEidUpdateService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODowMjo1N1rOH1CSnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODowMjo1N1rOH1CSnQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM3NDEwOQ==", "bodyText": "Fix SourceResource", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525374109", "createdAt": "2020-11-17T18:02:57Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/svc/EmpiEidUpdateService.java", "diffHunk": "@@ -61,68 +61,70 @@\n \t@Autowired\n \tprivate IEmpiSettings myEmpiSettings;\n \n-\tvoid handleEmpiUpdate(IAnyResource theResource, MatchedPersonCandidate theMatchedPersonCandidate, EmpiTransactionContext theEmpiTransactionContext) {\n-\n-\t\tEmpiUpdateContext updateContext = new EmpiUpdateContext(theMatchedPersonCandidate, theResource);\n-\n+\tvoid handleEmpiUpdate(IAnyResource theResource, MatchedSourceResourceCandidate theMatchedSourceResourceCandidate, MdmTransactionContext theMdmTransactionContext) {\n+\t\tEmpiUpdateContext updateContext = new EmpiUpdateContext(theMatchedSourceResourceCandidate, theResource);\n \t\tif (updateContext.isRemainsMatchedToSamePerson()) {\n-\t\t\tmyPersonHelper.updatePersonFromUpdatedEmpiTarget(updateContext.getMatchedPerson(), theResource, theEmpiTransactionContext);\n+\t\t\t// Copy over any new external EIDs which don't already exist.\n+\t\t\t// TODO NG - Eventually this call will use terser to clone data in, once the surviorship rules for copying data will be confirmed\n+\t\t\t// myPersonHelper.updatePersonFromUpdatedEmpiTarget(updateContext.getMatchedPerson(), theResource, theEmpiTransactionContext);\n \t\t\tif (!updateContext.isIncomingResourceHasAnEid() || updateContext.isHasEidsInCommon()) {\n \t\t\t\t//update to patient that uses internal EIDs only.\n-\t\t\t\tmyEmpiLinkSvc.updateLink(updateContext.getMatchedPerson(), theResource, theMatchedPersonCandidate.getMatchResult(), EmpiLinkSourceEnum.AUTO, theEmpiTransactionContext);\n+\t\t\t\tmyEmpiLinkSvc.updateLink(updateContext.getMatchedSourceResource(), theResource, theMatchedSourceResourceCandidate.getMatchResult(), EmpiLinkSourceEnum.AUTO, theMdmTransactionContext);\n \t\t\t} else if (!updateContext.isHasEidsInCommon()) {\n-\t\t\t\thandleNoEidsInCommon(theResource, theMatchedPersonCandidate, theEmpiTransactionContext, updateContext);\n+\t\t\t\thandleNoEidsInCommon(theResource, theMatchedSourceResourceCandidate, theMdmTransactionContext, updateContext);\n \t\t\t}\n \t\t} else {\n \t\t\t//This is a new linking scenario. we have to break the existing link and link to the new person. For now, we create duplicate.\n \t\t\t//updated patient has an EID that matches to a new candidate. Link them, and set the persons possible duplicates\n-\t\t\tlinkToNewPersonAndFlagAsDuplicate(theResource, updateContext.getExistingPerson(), updateContext.getMatchedPerson(), theEmpiTransactionContext);\n+\t\t\tlinkToNewPersonAndFlagAsDuplicate(theResource, updateContext.getExistingPerson(), updateContext.getMatchedSourceResource(), theMdmTransactionContext);\n \t\t}\n \t}\n \n-\tprivate void handleNoEidsInCommon(IAnyResource theResource, MatchedPersonCandidate theMatchedPersonCandidate, EmpiTransactionContext theEmpiTransactionContext, EmpiUpdateContext theUpdateContext) {\n+\tprivate void handleNoEidsInCommon(IAnyResource theResource, MatchedSourceResourceCandidate theMatchedSourceResourceCandidate, MdmTransactionContext theMdmTransactionContext, EmpiUpdateContext theUpdateContext) {\n \t\t// the user is simply updating their EID. We propagate this change to the Person.\n \t\t//overwrite. No EIDS in common, but still same person.\n \t\tif (myEmpiSettings.isPreventMultipleEids()) {\n-\t\t\tif (myPersonHelper.getLinkCount(theUpdateContext.getMatchedPerson()) <= 1) { // If there is only 0/1 link on the person, we can safely overwrite the EID.\n-\t\t\t\thandleExternalEidOverwrite(theUpdateContext.getMatchedPerson(), theResource, theEmpiTransactionContext);\n+\t\t\tif (myEmpiLinkDaoSvc.findEmpiMatchLinksBySource(theUpdateContext.getMatchedSourceResource()).size() <= 1) { // If there is only 0/1 link on the person, we can safely overwrite the EID.\n+\t\t\t// if (myPersonHelper.getLinkCount(theUpdateContext.getMatchedSourceResource()) <= 1) { // If there is only 0/1 link on the person, we can safely overwrite the EID.\n+\t\t\t\thandleExternalEidOverwrite(theUpdateContext.getMatchedSourceResource(), theResource, theMdmTransactionContext);\n \t\t\t} else { // If the person has multiple patients tied to it, we can't just overwrite the EID, so we split the person.\n-\t\t\t\tcreateNewPersonAndFlagAsDuplicate(theResource, theEmpiTransactionContext, theUpdateContext.getExistingPerson());\n+\t\t\t\tcreateNewPersonAndFlagAsDuplicate(theResource, theMdmTransactionContext, theUpdateContext.getExistingPerson());\n \t\t\t}\n \t\t} else {\n-\t\t\tmyPersonHelper.handleExternalEidAddition(theUpdateContext.getMatchedPerson(), theResource, theEmpiTransactionContext);\n+\t\t\tmyPersonHelper.handleExternalEidAddition(theUpdateContext.getMatchedSourceResource(), theResource, theMdmTransactionContext);\n \t\t}\n-\t\tmyEmpiLinkSvc.updateLink(theUpdateContext.getMatchedPerson(), theResource, theMatchedPersonCandidate.getMatchResult(), EmpiLinkSourceEnum.AUTO, theEmpiTransactionContext);\n+\t\tmyEmpiLinkSvc.updateLink(theUpdateContext.getMatchedSourceResource(), theResource, theMatchedSourceResourceCandidate.getMatchResult(), EmpiLinkSourceEnum.AUTO, theMdmTransactionContext);\n \t}\n \n-\tprivate void handleExternalEidOverwrite(IAnyResource thePerson, IAnyResource theResource, EmpiTransactionContext theEmpiTransactionContext) {\n+\tprivate void handleExternalEidOverwrite(IAnyResource thePerson, IAnyResource theResource, MdmTransactionContext theMdmTransactionContext) {\n \t\tList<CanonicalEID> eidFromResource = myEIDHelper.getExternalEid(theResource);\n \t\tif (!eidFromResource.isEmpty()) {\n \t\t\tmyPersonHelper.overwriteExternalEids(thePerson, eidFromResource);\n \t\t}\n \t}\n \n-\tprivate boolean candidateIsSameAsEmpiLinkPerson(EmpiLink theExistingMatchLink, MatchedPersonCandidate thePersonCandidate) {\n-\t\treturn theExistingMatchLink.getPersonPid().equals(thePersonCandidate.getCandidatePersonPid().getIdAsLong());\n+\tprivate boolean candidateIsSameAsEmpiLinkPerson(EmpiLink theExistingMatchLink, MatchedSourceResourceCandidate thePersonCandidate) {\n+\t\treturn theExistingMatchLink.getSourceResourcePid().equals(thePersonCandidate.getCandidatePersonPid().getIdAsLong());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 89}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDA5MzgyOnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/svc/EmpiEidUpdateService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODowNDoyNlrOH1CV_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODowNDoyNlrOH1CV_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM3NDk3Mg==", "bodyText": "Do we need to update EmpiMatchOutcome into MdmMatchOutcome and fix enum literals?", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525374972", "createdAt": "2020-11-17T18:04:26Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/svc/EmpiEidUpdateService.java", "diffHunk": "@@ -61,68 +61,70 @@\n \t@Autowired\n \tprivate IEmpiSettings myEmpiSettings;\n \n-\tvoid handleEmpiUpdate(IAnyResource theResource, MatchedPersonCandidate theMatchedPersonCandidate, EmpiTransactionContext theEmpiTransactionContext) {\n-\n-\t\tEmpiUpdateContext updateContext = new EmpiUpdateContext(theMatchedPersonCandidate, theResource);\n-\n+\tvoid handleEmpiUpdate(IAnyResource theResource, MatchedSourceResourceCandidate theMatchedSourceResourceCandidate, MdmTransactionContext theMdmTransactionContext) {\n+\t\tEmpiUpdateContext updateContext = new EmpiUpdateContext(theMatchedSourceResourceCandidate, theResource);\n \t\tif (updateContext.isRemainsMatchedToSamePerson()) {\n-\t\t\tmyPersonHelper.updatePersonFromUpdatedEmpiTarget(updateContext.getMatchedPerson(), theResource, theEmpiTransactionContext);\n+\t\t\t// Copy over any new external EIDs which don't already exist.\n+\t\t\t// TODO NG - Eventually this call will use terser to clone data in, once the surviorship rules for copying data will be confirmed\n+\t\t\t// myPersonHelper.updatePersonFromUpdatedEmpiTarget(updateContext.getMatchedPerson(), theResource, theEmpiTransactionContext);\n \t\t\tif (!updateContext.isIncomingResourceHasAnEid() || updateContext.isHasEidsInCommon()) {\n \t\t\t\t//update to patient that uses internal EIDs only.\n-\t\t\t\tmyEmpiLinkSvc.updateLink(updateContext.getMatchedPerson(), theResource, theMatchedPersonCandidate.getMatchResult(), EmpiLinkSourceEnum.AUTO, theEmpiTransactionContext);\n+\t\t\t\tmyEmpiLinkSvc.updateLink(updateContext.getMatchedSourceResource(), theResource, theMatchedSourceResourceCandidate.getMatchResult(), EmpiLinkSourceEnum.AUTO, theMdmTransactionContext);\n \t\t\t} else if (!updateContext.isHasEidsInCommon()) {\n-\t\t\t\thandleNoEidsInCommon(theResource, theMatchedPersonCandidate, theEmpiTransactionContext, updateContext);\n+\t\t\t\thandleNoEidsInCommon(theResource, theMatchedSourceResourceCandidate, theMdmTransactionContext, updateContext);\n \t\t\t}\n \t\t} else {\n \t\t\t//This is a new linking scenario. we have to break the existing link and link to the new person. For now, we create duplicate.\n \t\t\t//updated patient has an EID that matches to a new candidate. Link them, and set the persons possible duplicates\n-\t\t\tlinkToNewPersonAndFlagAsDuplicate(theResource, updateContext.getExistingPerson(), updateContext.getMatchedPerson(), theEmpiTransactionContext);\n+\t\t\tlinkToNewPersonAndFlagAsDuplicate(theResource, updateContext.getExistingPerson(), updateContext.getMatchedSourceResource(), theMdmTransactionContext);\n \t\t}\n \t}\n \n-\tprivate void handleNoEidsInCommon(IAnyResource theResource, MatchedPersonCandidate theMatchedPersonCandidate, EmpiTransactionContext theEmpiTransactionContext, EmpiUpdateContext theUpdateContext) {\n+\tprivate void handleNoEidsInCommon(IAnyResource theResource, MatchedSourceResourceCandidate theMatchedSourceResourceCandidate, MdmTransactionContext theMdmTransactionContext, EmpiUpdateContext theUpdateContext) {\n \t\t// the user is simply updating their EID. We propagate this change to the Person.\n \t\t//overwrite. No EIDS in common, but still same person.\n \t\tif (myEmpiSettings.isPreventMultipleEids()) {\n-\t\t\tif (myPersonHelper.getLinkCount(theUpdateContext.getMatchedPerson()) <= 1) { // If there is only 0/1 link on the person, we can safely overwrite the EID.\n-\t\t\t\thandleExternalEidOverwrite(theUpdateContext.getMatchedPerson(), theResource, theEmpiTransactionContext);\n+\t\t\tif (myEmpiLinkDaoSvc.findEmpiMatchLinksBySource(theUpdateContext.getMatchedSourceResource()).size() <= 1) { // If there is only 0/1 link on the person, we can safely overwrite the EID.\n+\t\t\t// if (myPersonHelper.getLinkCount(theUpdateContext.getMatchedSourceResource()) <= 1) { // If there is only 0/1 link on the person, we can safely overwrite the EID.\n+\t\t\t\thandleExternalEidOverwrite(theUpdateContext.getMatchedSourceResource(), theResource, theMdmTransactionContext);\n \t\t\t} else { // If the person has multiple patients tied to it, we can't just overwrite the EID, so we split the person.\n-\t\t\t\tcreateNewPersonAndFlagAsDuplicate(theResource, theEmpiTransactionContext, theUpdateContext.getExistingPerson());\n+\t\t\t\tcreateNewPersonAndFlagAsDuplicate(theResource, theMdmTransactionContext, theUpdateContext.getExistingPerson());\n \t\t\t}\n \t\t} else {\n-\t\t\tmyPersonHelper.handleExternalEidAddition(theUpdateContext.getMatchedPerson(), theResource, theEmpiTransactionContext);\n+\t\t\tmyPersonHelper.handleExternalEidAddition(theUpdateContext.getMatchedSourceResource(), theResource, theMdmTransactionContext);\n \t\t}\n-\t\tmyEmpiLinkSvc.updateLink(theUpdateContext.getMatchedPerson(), theResource, theMatchedPersonCandidate.getMatchResult(), EmpiLinkSourceEnum.AUTO, theEmpiTransactionContext);\n+\t\tmyEmpiLinkSvc.updateLink(theUpdateContext.getMatchedSourceResource(), theResource, theMatchedSourceResourceCandidate.getMatchResult(), EmpiLinkSourceEnum.AUTO, theMdmTransactionContext);\n \t}\n \n-\tprivate void handleExternalEidOverwrite(IAnyResource thePerson, IAnyResource theResource, EmpiTransactionContext theEmpiTransactionContext) {\n+\tprivate void handleExternalEidOverwrite(IAnyResource thePerson, IAnyResource theResource, MdmTransactionContext theMdmTransactionContext) {\n \t\tList<CanonicalEID> eidFromResource = myEIDHelper.getExternalEid(theResource);\n \t\tif (!eidFromResource.isEmpty()) {\n \t\t\tmyPersonHelper.overwriteExternalEids(thePerson, eidFromResource);\n \t\t}\n \t}\n \n-\tprivate boolean candidateIsSameAsEmpiLinkPerson(EmpiLink theExistingMatchLink, MatchedPersonCandidate thePersonCandidate) {\n-\t\treturn theExistingMatchLink.getPersonPid().equals(thePersonCandidate.getCandidatePersonPid().getIdAsLong());\n+\tprivate boolean candidateIsSameAsEmpiLinkPerson(EmpiLink theExistingMatchLink, MatchedSourceResourceCandidate thePersonCandidate) {\n+\t\treturn theExistingMatchLink.getSourceResourcePid().equals(thePersonCandidate.getCandidatePersonPid().getIdAsLong());\n \t}\n \n-\tprivate void createNewPersonAndFlagAsDuplicate(IAnyResource theResource, EmpiTransactionContext theEmpiTransactionContext, IAnyResource theOldPerson) {\n-\t\tlog(theEmpiTransactionContext, \"Duplicate detected based on the fact that both resources have different external EIDs.\");\n-\t\tIAnyResource newPerson = myPersonHelper.createPersonFromEmpiTarget(theResource);\n-\t\tmyEmpiLinkSvc.updateLink(newPerson, theResource, EmpiMatchOutcome.NEW_PERSON_MATCH, EmpiLinkSourceEnum.AUTO, theEmpiTransactionContext);\n-\t\tmyEmpiLinkSvc.updateLink(newPerson, theOldPerson, EmpiMatchOutcome.POSSIBLE_DUPLICATE, EmpiLinkSourceEnum.AUTO, theEmpiTransactionContext);\n+\tprivate void createNewPersonAndFlagAsDuplicate(IAnyResource theResource, MdmTransactionContext theMdmTransactionContext, IAnyResource theOldPerson) {\n+\t\tlog(theMdmTransactionContext, \"Duplicate detected based on the fact that both resources have different external EIDs.\");\n+\t\tIAnyResource newPerson = myPersonHelper.createGoldenResourceFromMdmTarget(theResource);\n+\n+\t\tmyEmpiLinkSvc.updateLink(newPerson, theResource, EmpiMatchOutcome.NEW_PERSON_MATCH, EmpiLinkSourceEnum.AUTO, theMdmTransactionContext);\n+\t\tmyEmpiLinkSvc.updateLink(newPerson, theOldPerson, EmpiMatchOutcome.POSSIBLE_DUPLICATE, EmpiLinkSourceEnum.AUTO, theMdmTransactionContext);\n \t}\n \n-\tprivate void linkToNewPersonAndFlagAsDuplicate(IAnyResource theResource, IAnyResource theOldPerson, IAnyResource theNewPerson, EmpiTransactionContext theEmpiTransactionContext) {\n-\t\tlog(theEmpiTransactionContext, \"Changing a match link!\");\n-\t\tmyEmpiLinkSvc.deleteLink(theOldPerson, theResource, theEmpiTransactionContext);\n-\t\tmyEmpiLinkSvc.updateLink(theNewPerson, theResource, EmpiMatchOutcome.NEW_PERSON_MATCH, EmpiLinkSourceEnum.AUTO, theEmpiTransactionContext);\n-\t\tlog(theEmpiTransactionContext, \"Duplicate detected based on the fact that both resources have different external EIDs.\");\n-\t\tmyEmpiLinkSvc.updateLink(theNewPerson, theOldPerson, EmpiMatchOutcome.POSSIBLE_DUPLICATE, EmpiLinkSourceEnum.AUTO, theEmpiTransactionContext);\n+\tprivate void linkToNewPersonAndFlagAsDuplicate(IAnyResource theResource, IAnyResource theOldPerson, IAnyResource theNewPerson, MdmTransactionContext theMdmTransactionContext) {\n+\t\tlog(theMdmTransactionContext, \"Changing a match link!\");\n+\t\tmyEmpiLinkSvc.deleteLink(theOldPerson, theResource, theMdmTransactionContext);\n+\t\tmyEmpiLinkSvc.updateLink(theNewPerson, theResource, EmpiMatchOutcome.NEW_PERSON_MATCH, EmpiLinkSourceEnum.AUTO, theMdmTransactionContext);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 114}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDEwMTc1OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/svc/EmpiLinkSvcImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODowNjowNFrOH1CaqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODowNjowNFrOH1CaqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM3NjE2OQ==", "bodyText": "Remove obsolete code", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525376169", "createdAt": "2020-11-17T18:06:04Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/svc/EmpiLinkSvcImpl.java", "diffHunk": "@@ -102,33 +101,36 @@ private boolean personsLinkedAsNoMatch(IAnyResource thePerson, IAnyResource theT\n \t\t\tmyEmpiLinkDaoSvc.getEmpiLinksByPersonPidTargetPidAndMatchResult(targetId, personId, EmpiMatchResultEnum.NO_MATCH).isPresent();\n \t}\n \n-\t@Override\n-\t@Transactional\n-\tpublic void syncEmpiLinksToPersonLinks(IAnyResource thePersonResource, EmpiTransactionContext theEmpiTransactionContext) {\n-\t\tint origLinkCount = myPersonHelper.getLinkCount(thePersonResource);\n-\n-\t\tList<EmpiLink> empiLinks = myEmpiLinkDaoSvc.findEmpiLinksByPerson(thePersonResource);\n-\n-\t\tList<IBaseBackboneElement> newLinks = empiLinks.stream()\n-\t\t\t.filter(link -> link.isMatch() || link.isPossibleMatch() || link.isRedirect())\n-\t\t\t.map(this::personLinkFromEmpiLink)\n-\t\t\t.collect(Collectors.toList());\n-\t\tmyPersonHelper.setLinks(thePersonResource, newLinks);\n-\t\tif (newLinks.size() > origLinkCount) {\n-\t\t\tlog(theEmpiTransactionContext, thePersonResource.getIdElement().toVersionless() + \" links increased from \" + origLinkCount + \" to \" + newLinks.size());\n-\t\t} else if (newLinks.size() < origLinkCount) {\n-\t\t\tlog(theEmpiTransactionContext, thePersonResource.getIdElement().toVersionless() + \" links decreased from \" + origLinkCount + \" to \" + newLinks.size());\n-\t\t}\n-\n-\t}\n+//\t@Override\n+//\t@Transactional\n+//\tpublic void syncEmpiLinksToPersonLinks(IAnyResource thePersonResource, EmpiTransactionContext theEmpiTransactionContext) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 98}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDEwMjYyOnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/svc/EmpiLinkSvcImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODowNjoxOVrOH1CbOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODowNjoxOVrOH1CbOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM3NjMxNA==", "bodyText": "handle S/R", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525376314", "createdAt": "2020-11-17T18:06:19Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/svc/EmpiLinkSvcImpl.java", "diffHunk": "@@ -102,33 +101,36 @@ private boolean personsLinkedAsNoMatch(IAnyResource thePerson, IAnyResource theT\n \t\t\tmyEmpiLinkDaoSvc.getEmpiLinksByPersonPidTargetPidAndMatchResult(targetId, personId, EmpiMatchResultEnum.NO_MATCH).isPresent();\n \t}\n \n-\t@Override\n-\t@Transactional\n-\tpublic void syncEmpiLinksToPersonLinks(IAnyResource thePersonResource, EmpiTransactionContext theEmpiTransactionContext) {\n-\t\tint origLinkCount = myPersonHelper.getLinkCount(thePersonResource);\n-\n-\t\tList<EmpiLink> empiLinks = myEmpiLinkDaoSvc.findEmpiLinksByPerson(thePersonResource);\n-\n-\t\tList<IBaseBackboneElement> newLinks = empiLinks.stream()\n-\t\t\t.filter(link -> link.isMatch() || link.isPossibleMatch() || link.isRedirect())\n-\t\t\t.map(this::personLinkFromEmpiLink)\n-\t\t\t.collect(Collectors.toList());\n-\t\tmyPersonHelper.setLinks(thePersonResource, newLinks);\n-\t\tif (newLinks.size() > origLinkCount) {\n-\t\t\tlog(theEmpiTransactionContext, thePersonResource.getIdElement().toVersionless() + \" links increased from \" + origLinkCount + \" to \" + newLinks.size());\n-\t\t} else if (newLinks.size() < origLinkCount) {\n-\t\t\tlog(theEmpiTransactionContext, thePersonResource.getIdElement().toVersionless() + \" links decreased from \" + origLinkCount + \" to \" + newLinks.size());\n-\t\t}\n-\n-\t}\n+//\t@Override\n+//\t@Transactional\n+//\tpublic void syncEmpiLinksToPersonLinks(IAnyResource thePersonResource, EmpiTransactionContext theEmpiTransactionContext) {\n+//\t\t// int origLinkCount = myPersonHelper.getLinkCount(thePersonResource);\n+//\t\tint origLinkCount = myEmpiLinkDaoSvc.findEmpiMatchLinksBySource(thePersonResource).size();\n+//\n+//\t\tList<EmpiLink> empiLinks = myEmpiLinkDaoSvc.findEmpiLinksBySourceResource(thePersonResource);\n+//\n+//\t\tList<IBaseBackboneElement> newLinks = empiLinks.stream()\n+//\t\t\t.filter(link -> link.isMatch() || link.isPossibleMatch() || link.isRedirect())\n+//\t\t\t.map(this::personLinkFromEmpiLink)\n+//\t\t\t.collect(Collectors.toList());\n+//\t\tmyPersonHelper.setLinks(thePersonResource, newLinks);\n+//\t\tif (newLinks.size() > origLinkCount) {\n+//\t\t\tlog(theEmpiTransactionContext, thePersonResource.getIdElement().toVersionless() + \" links increased from \" + origLinkCount + \" to \" + newLinks.size());\n+//\t\t} else if (newLinks.size() < origLinkCount) {\n+//\t\t\tlog(theEmpiTransactionContext, thePersonResource.getIdElement().toVersionless() + \" links decreased from \" + origLinkCount + \" to \" + newLinks.size());\n+//\t\t}\n+//\n+//\t}\n \n \t@Override\n-\tpublic void deleteLink(IAnyResource theExistingPerson, IAnyResource theResource, EmpiTransactionContext theEmpiTransactionContext) {\n-\t\tmyPersonHelper.removeLink(theExistingPerson, theResource.getIdElement(), theEmpiTransactionContext);\n-\t\tOptional<EmpiLink> oEmpiLink = getEmpiLinkForPersonTargetPair(theExistingPerson, theResource);\n+\tpublic void deleteLink(IAnyResource theSourceResource, IAnyResource theTargetResource, MdmTransactionContext theMdmTransactionContext) {\n+\t\t// myPersonHelper.removeLink(theExistingPerson, theResource.getIdElement(), theEmpiTransactionContext);\n+//\t\t myEmpiLinkDaoSvc.deleteEmpiLinks(theSourceResource, theTargetResource);\n+\n+\t\tOptional<EmpiLink> oEmpiLink = getEmpiLinkForPersonTargetPair(theSourceResource, theTargetResource);\n \t\tif (oEmpiLink.isPresent()) {\n \t\t\tEmpiLink empiLink = oEmpiLink.get();\n-\t\t\tlog(theEmpiTransactionContext, \"Deleting EmpiLink [\" + theExistingPerson.getIdElement().toVersionless() + \" -> \" + theResource.getIdElement().toVersionless() + \"] with result: \" + empiLink.getMatchResult());\n+\t\t\tlog(theMdmTransactionContext, \"Deleting EmpiLink [\" + theSourceResource.getIdElement().toVersionless() + \" -> \" + theTargetResource.getIdElement().toVersionless() + \"] with result: \" + empiLink.getMatchResult());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 129}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDEwOTg4OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/svc/EmpiMatchLinkSvc.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODowODowMVrOH1CfhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODowODowMVrOH1CfhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM3NzQxMg==", "bodyText": "rename EMPI previx", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525377412", "createdAt": "2020-11-17T18:08:01Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/svc/EmpiMatchLinkSvc.java", "diffHunk": "@@ -63,48 +63,49 @@\n \t * Does nothing if resource is determined to be not managed by EMPI.\n \t *\n \t * @param theResource the incoming EMPI target, which is either a Patient or Practitioner.\n-\t * @param theEmpiTransactionContext\n+\t * @param theMdmTransactionContext\n \t * @return an {@link TransactionLogMessages} which contains all informational messages related to EMPI processing of this resource.\n \t */\n-\tpublic EmpiTransactionContext updateEmpiLinksForEmpiTarget(IAnyResource theResource, EmpiTransactionContext theEmpiTransactionContext) {\n+\tpublic MdmTransactionContext updateEmpiLinksForEmpiTarget(IAnyResource theResource, MdmTransactionContext theMdmTransactionContext) {\n \t\tif (EmpiUtil.isEmpiAccessible(theResource)) {\n-\t\t\treturn doEmpiUpdate(theResource, theEmpiTransactionContext);\n+\t\t\treturn doEmpiUpdate(theResource, theMdmTransactionContext);\n \t\t} else {\n \t\t\treturn null;\n \t\t}\n \t}\n \n-\tprivate EmpiTransactionContext doEmpiUpdate(IAnyResource theResource, EmpiTransactionContext theEmpiTransactionContext) {\n-\t\tCandidateList candidateList = myEmpiPersonFindingSvc.findPersonCandidates(theResource);\n+\tprivate MdmTransactionContext doEmpiUpdate(IAnyResource theResource, MdmTransactionContext theMdmTransactionContext) {\n+\t\tCandidateList candidateList = myEmpiSourceResourceFindingSvc.findSourceResourceCandidates(theResource);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDExMjE2OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/svc/EmpiResourceDaoSvc.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODowODo0MlrOH1ChHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODowODo0MlrOH1ChHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM3NzgyMA==", "bodyText": "Remove import", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525377820", "createdAt": "2020-11-17T18:08:42Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/svc/EmpiResourceDaoSvc.java", "diffHunk": "@@ -22,96 +22,89 @@\n \n import ca.uhn.fhir.empi.api.EmpiConstants;\n import ca.uhn.fhir.empi.api.IEmpiSettings;\n-import ca.uhn.fhir.empi.util.EmpiUtil;\n import ca.uhn.fhir.jpa.api.dao.DaoRegistry;\n import ca.uhn.fhir.jpa.api.dao.IFhirResourceDao;\n import ca.uhn.fhir.jpa.api.model.DaoMethodOutcome;\n+import ca.uhn.fhir.jpa.model.entity.TagTypeEnum;\n import ca.uhn.fhir.jpa.searchparam.SearchParameterMap;\n import ca.uhn.fhir.rest.api.server.IBundleProvider;\n import ca.uhn.fhir.rest.api.server.storage.ResourcePersistentId;\n import ca.uhn.fhir.rest.param.TokenParam;\n import ca.uhn.fhir.rest.server.exceptions.InternalErrorException;\n import org.hl7.fhir.instance.model.api.IAnyResource;\n import org.hl7.fhir.instance.model.api.IBaseResource;\n-import org.hl7.fhir.instance.model.api.IIdType;\n+import org.jetbrains.annotations.NotNull;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDExMzAyOnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/svc/EmpiResourceDaoSvc.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODowODo1OFrOH1ChoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODowODo1OFrOH1ChoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM3Nzk1Mg==", "bodyText": "Fix S/R", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525377952", "createdAt": "2020-11-17T18:08:58Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/svc/EmpiResourceDaoSvc.java", "diffHunk": "@@ -22,96 +22,89 @@\n \n import ca.uhn.fhir.empi.api.EmpiConstants;\n import ca.uhn.fhir.empi.api.IEmpiSettings;\n-import ca.uhn.fhir.empi.util.EmpiUtil;\n import ca.uhn.fhir.jpa.api.dao.DaoRegistry;\n import ca.uhn.fhir.jpa.api.dao.IFhirResourceDao;\n import ca.uhn.fhir.jpa.api.model.DaoMethodOutcome;\n+import ca.uhn.fhir.jpa.model.entity.TagTypeEnum;\n import ca.uhn.fhir.jpa.searchparam.SearchParameterMap;\n import ca.uhn.fhir.rest.api.server.IBundleProvider;\n import ca.uhn.fhir.rest.api.server.storage.ResourcePersistentId;\n import ca.uhn.fhir.rest.param.TokenParam;\n import ca.uhn.fhir.rest.server.exceptions.InternalErrorException;\n import org.hl7.fhir.instance.model.api.IAnyResource;\n import org.hl7.fhir.instance.model.api.IBaseResource;\n-import org.hl7.fhir.instance.model.api.IIdType;\n+import org.jetbrains.annotations.NotNull;\n import org.springframework.beans.factory.annotation.Autowired;\n import org.springframework.stereotype.Service;\n \n-import javax.annotation.PostConstruct;\n import java.util.List;\n import java.util.Optional;\n-import java.util.stream.Collectors;\n \n @Service\n public class EmpiResourceDaoSvc {\n+\n \tprivate static final int MAX_MATCHING_PERSONS = 1000;\n+\n \t@Autowired\n \tDaoRegistry myDaoRegistry;\n \t@Autowired\n \tIEmpiSettings myEmpiConfig;\n \n-\tprivate IFhirResourceDao<IBaseResource> myPatientDao;\n-\tprivate IFhirResourceDao<IBaseResource> myPersonDao;\n-\tprivate IFhirResourceDao<IBaseResource> myPractitionerDao;\n-\n-\t@PostConstruct\n-\tpublic void postConstruct() {\n-\t\tmyPatientDao = myDaoRegistry.getResourceDao(\"Patient\");\n-\t\tmyPersonDao = myDaoRegistry.getResourceDao(\"Person\");\n-\t\tmyPractitionerDao = myDaoRegistry.getResourceDao(\"Practitioner\");\n-\t}\n-\n-\tpublic IAnyResource readPatient(IIdType theId) {\n-\t\treturn (IAnyResource) myPatientDao.read(theId);\n-\t}\n-\n-\tpublic IAnyResource readPerson(IIdType theId) {\n-\t\treturn (IAnyResource) myPersonDao.read(theId);\n-\t}\n-\n-\tpublic IAnyResource readPractitioner(IIdType theId) {\n-\t\treturn (IAnyResource) myPractitionerDao.read(theId);\n-\t}\n-\n-\tpublic DaoMethodOutcome updatePerson(IAnyResource thePerson) {\n-\t\tif (thePerson.getIdElement().hasIdPart()) {\n-\t\t\treturn myPersonDao.update(thePerson);\n+\tpublic DaoMethodOutcome upsertSourceResource(IAnyResource theSourceResource, String theResourceType) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 62}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDEyOTEyOnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/svc/GoldenResourceMergerSvcImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODoxMjo1MlrOH1Crsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODoxMjo1MlrOH1Crsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM4MDUzMQ==", "bodyText": "removeTargetLinks can be removed altogether?", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525380531", "createdAt": "2020-11-17T18:12:52Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/svc/GoldenResourceMergerSvcImpl.java", "diffHunk": "@@ -0,0 +1,181 @@\n+package ca.uhn.fhir.jpa.empi.svc;\n+\n+/*-\n+ * #%L\n+ * HAPI FHIR JPA Server - Enterprise Master Patient Index\n+ * %%\n+ * Copyright (C) 2014 - 2020 University Health Network\n+ * %%\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * #L%\n+ */\n+\n+import ca.uhn.fhir.empi.api.EmpiLinkSourceEnum;\n+import ca.uhn.fhir.empi.api.EmpiMatchResultEnum;\n+import ca.uhn.fhir.empi.api.IEmpiLinkSvc;\n+import ca.uhn.fhir.empi.api.IGoldenResourceMergerSvc;\n+import ca.uhn.fhir.empi.log.Logs;\n+import ca.uhn.fhir.empi.model.MdmTransactionContext;\n+import ca.uhn.fhir.empi.util.PersonHelper;\n+import ca.uhn.fhir.jpa.dao.index.IdHelperService;\n+import ca.uhn.fhir.jpa.empi.dao.EmpiLinkDaoSvc;\n+import ca.uhn.fhir.jpa.entity.EmpiLink;\n+import ca.uhn.fhir.rest.server.exceptions.InvalidRequestException;\n+import org.hl7.fhir.instance.model.api.IAnyResource;\n+import org.slf4j.Logger;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Optional;\n+\n+@Service\n+public class GoldenResourceMergerSvcImpl implements IGoldenResourceMergerSvc {\n+\tprivate static final Logger ourLog = Logs.getEmpiTroubleshootingLog();\n+\n+\t@Autowired\n+\tPersonHelper myPersonHelper;\n+\t@Autowired\n+\tEmpiLinkDaoSvc myEmpiLinkDaoSvc;\n+\t@Autowired\n+\tIEmpiLinkSvc myEmpiLinkSvc;\n+\t@Autowired\n+\tIdHelperService myIdHelperService;\n+\t@Autowired\n+\tEmpiResourceDaoSvc myEmpiResourceDaoSvc;\n+\n+\t@Override\n+\t@Transactional\n+\tpublic IAnyResource mergeGoldenResources(IAnyResource theFromGoldenResource, IAnyResource theToGoldenResource, MdmTransactionContext theMdmTransactionContext) {\n+\t\tLong fromGoldenResourcePid = myIdHelperService.getPidOrThrowException(theFromGoldenResource);\n+\t\tLong toGoldenResourcePid = myIdHelperService.getPidOrThrowException(theToGoldenResource);\n+\t\tString resourceType = theMdmTransactionContext.getResourceType();\n+\n+\t\t//Merge attributes, to be determined when survivorship is solved.\n+\t\tmyPersonHelper.mergeFields(theFromGoldenResource, theToGoldenResource);\n+\n+\t\t//Merge the links from the FROM to the TO resource. Clean up dangling links.\n+\t\tmergeGoldenResourceLinks(theFromGoldenResource, theToGoldenResource, toGoldenResourcePid, theMdmTransactionContext);\n+\n+\t\t//Create the new REDIRECT link\n+\t\taddMergeLink(toGoldenResourcePid, fromGoldenResourcePid, resourceType);\n+\n+\t\t//Strip the golden resource tag from the now-deprecated resource.\n+\t\tmyEmpiResourceDaoSvc.removeGoldenResourceTag(theFromGoldenResource, resourceType);\n+\n+\t\t//Add the REDIRECT tag to that same deprecated resource.\n+\t\tmyPersonHelper.deactivateResource(theFromGoldenResource);\n+\n+\t\t//Save the deprecated resource.\n+\t\tmyEmpiResourceDaoSvc.upsertSourceResource(theFromGoldenResource, resourceType);\n+\n+\t\tlog(theMdmTransactionContext, \"Merged \" + theFromGoldenResource.getIdElement().toVersionless() + \" into \" + theToGoldenResource.getIdElement().toVersionless());\n+\t\treturn theToGoldenResource;\n+\t}\n+\n+\t/**\n+\t * Removes non-manual links from source to target\n+\t *\n+\t * @param theFrom                   Target of the link\n+\t * @param theTo                     Source resource of the link\n+\t * @param theMdmTransactionContext Context to keep track of the deletions\n+\t */\n+\tprivate void removeTargetLinks(IAnyResource theFrom, IAnyResource theTo, MdmTransactionContext theMdmTransactionContext) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 95}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDEzMTQ4OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/svc/candidate/BaseCandidateFinder.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODoxMzozNVrOH1CtQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODoxMzozNVrOH1CtQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM4MDkzMQ==", "bodyText": "address S/R", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525380931", "createdAt": "2020-11-17T18:13:35Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/svc/candidate/BaseCandidateFinder.java", "diffHunk": "@@ -35,11 +35,11 @@\n \n \tCandidateList findCandidates(IAnyResource theTarget) {\n \t\tCandidateList candidateList = new CandidateList(getStrategy());\n-\t\tcandidateList.addAll(findMatchPersonCandidates(theTarget));\n+\t\tcandidateList.addAll(findMatchSourceResourceCandidates(theTarget));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDEzMjU3OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/svc/candidate/EmpiSourceResourceFindingSvc.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODoxMzo1M1rOH1Ct7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODoxMzo1M1rOH1Ct7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM4MTEwMg==", "bodyText": "Rename to MdmGoldenResourceFindingSvc", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525381102", "createdAt": "2020-11-17T18:13:53Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/svc/candidate/EmpiSourceResourceFindingSvc.java", "diffHunk": "@@ -30,7 +30,7 @@\n import org.springframework.stereotype.Service;\n \n @Service\n-public class EmpiPersonFindingSvc {\n+public class EmpiSourceResourceFindingSvc {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDEzNzE4OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/svc/candidate/MatchedSourceResourceCandidate.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODoxNTowMVrOH1Cw2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODoxNTowMVrOH1Cw2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM4MTg0OA==", "bodyText": "Rename to MatchedGoldenResourceCandidate", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525381848", "createdAt": "2020-11-17T18:15:01Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/svc/candidate/MatchedSourceResourceCandidate.java", "diffHunk": "@@ -24,22 +24,23 @@\n import ca.uhn.fhir.jpa.entity.EmpiLink;\n import ca.uhn.fhir.rest.api.server.storage.ResourcePersistentId;\n \n-public class MatchedPersonCandidate {\n-\tprivate final ResourcePersistentId myCandidatePersonPid;\n+public class MatchedSourceResourceCandidate {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDEzOTE0OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/svc/candidate/MatchedSourceResourceCandidate.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODoxNToyNlrOH1CyBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODoxNToyNlrOH1CyBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM4MjE0OA==", "bodyText": "Fix person / empi", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525382148", "createdAt": "2020-11-17T18:15:26Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/svc/candidate/MatchedSourceResourceCandidate.java", "diffHunk": "@@ -24,22 +24,23 @@\n import ca.uhn.fhir.jpa.entity.EmpiLink;\n import ca.uhn.fhir.rest.api.server.storage.ResourcePersistentId;\n \n-public class MatchedPersonCandidate {\n-\tprivate final ResourcePersistentId myCandidatePersonPid;\n+public class MatchedSourceResourceCandidate {\n+\n+\tprivate final ResourcePersistentId myCandidateSourceResourcePid;\n \tprivate final EmpiMatchOutcome myEmpiMatchOutcome;\n \n-\tpublic MatchedPersonCandidate(ResourcePersistentId theCandidate, EmpiMatchOutcome theEmpiMatchOutcome) {\n-\t\tmyCandidatePersonPid = theCandidate;\n+\tpublic MatchedSourceResourceCandidate(ResourcePersistentId theCandidate, EmpiMatchOutcome theEmpiMatchOutcome) {\n+\t\tmyCandidateSourceResourcePid = theCandidate;\n \t\tmyEmpiMatchOutcome = theEmpiMatchOutcome;\n \t}\n \n-\tpublic MatchedPersonCandidate(ResourcePersistentId thePersonPid, EmpiLink theEmpiLink) {\n-\t\tmyCandidatePersonPid = thePersonPid;\n+\tpublic MatchedSourceResourceCandidate(ResourcePersistentId thePersonPid, EmpiLink theEmpiLink) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDE0Mjk0OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-empi/src/test/java/ca/uhn/fhir/jpa/empi/BaseEmpiR4Test.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODoxNjoxM1rOH1C0Mw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODoxNjoxM1rOH1C0Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM4MjcwNw==", "bodyText": "fix S/R", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525382707", "createdAt": "2020-11-17T18:16:13Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-jpaserver-empi/src/test/java/ca/uhn/fhir/jpa/empi/BaseEmpiR4Test.java", "diffHunk": "@@ -269,71 +316,91 @@ protected void assertLinkCount(long theExpectedCount) {\n \t\tassertEquals(theExpectedCount, myEmpiLinkDao.count());\n \t}\n \n-\tprotected Person getPersonFromTarget(IAnyResource theBaseResource) {\n+\tprotected IAnyResource getGoldenResourceFromTargetResource(IAnyResource theBaseResource) {\n+\t\tString resourceType = theBaseResource.getIdElement().getResourceType();\n+\t\tIFhirResourceDao relevantDao = myDaoRegistry.getResourceDao(resourceType);\n+\n \t\tOptional<EmpiLink> matchedLinkForTargetPid = myEmpiLinkDaoSvc.getMatchedLinkForTargetPid(myIdHelperService.getPidOrNull(theBaseResource));\n \t\tif (matchedLinkForTargetPid.isPresent()) {\n-\t\t\tLong personPid = matchedLinkForTargetPid.get().getPersonPid();\n-\t\t\treturn (Person) myPersonDao.readByPid(new ResourcePersistentId(personPid));\n+\t\t\tLong sourceResourcePid = matchedLinkForTargetPid.get().getSourceResourcePid();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 234}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDE2NTY0OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-empi/src/test/java/ca/uhn/fhir/jpa/empi/matcher/BaseSourceResourceMatcher.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODoyMToyOFrOH1DB-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODoyMToyOFrOH1DB-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM4NjIzMg==", "bodyText": "Rename S/R -> Golden?", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525386232", "createdAt": "2020-11-17T18:21:28Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-jpaserver-empi/src/test/java/ca/uhn/fhir/jpa/empi/matcher/BaseSourceResourceMatcher.java", "diffHunk": "@@ -16,40 +18,41 @@\n import java.util.List;\n import java.util.stream.Collectors;\n \n-public abstract class BasePersonMatcher extends TypeSafeMatcher<IAnyResource> {\n-\tprivate static final Logger ourLog = LoggerFactory.getLogger(BasePersonMatcher.class);\n+public abstract class BaseSourceResourceMatcher extends TypeSafeMatcher<IAnyResource> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDE2NzI3OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-empi/src/test/java/ca/uhn/fhir/jpa/empi/matcher/IsLinkedTo.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODoyMTo1MlrOH1DC-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODoyMTo1MlrOH1DC-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM4NjQ5MQ==", "bodyText": "S/R to Golden?", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525386491", "createdAt": "2020-11-17T18:21:52Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-jpaserver-empi/src/test/java/ca/uhn/fhir/jpa/empi/matcher/IsLinkedTo.java", "diffHunk": "@@ -14,7 +14,7 @@\n  * is linked to a set of patients/practitioners via a person.\n  *\n  */\n-public class IsLinkedTo extends BasePersonMatcher {\n+public class IsLinkedTo extends BaseSourceResourceMatcher {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDE2ODc4OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-empi/src/test/java/ca/uhn/fhir/jpa/empi/matcher/IsSameSourceResourceAs.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODoyMjoxNFrOH1DD9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODoyMjoxNFrOH1DD9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM4Njc0Mw==", "bodyText": "S/R to Golden?", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525386743", "createdAt": "2020-11-17T18:22:14Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-jpaserver-empi/src/test/java/ca/uhn/fhir/jpa/empi/matcher/IsSameSourceResourceAs.java", "diffHunk": "@@ -0,0 +1,46 @@\n+package ca.uhn.fhir.jpa.empi.matcher;\n+\n+import ca.uhn.fhir.jpa.dao.index.IdHelperService;\n+import ca.uhn.fhir.jpa.empi.dao.EmpiLinkDaoSvc;\n+import org.hamcrest.Description;\n+import org.hamcrest.Matcher;\n+import org.hl7.fhir.instance.model.api.IAnyResource;\n+\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+public class IsSameSourceResourceAs extends BaseSourceResourceMatcher {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDE3MTM4OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-empi/src/test/java/ca/uhn/fhir/jpa/empi/provider/EmpiProviderClearLinkR4Test.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODoyMjo1M1rOH1DFlw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODoyMjo1M1rOH1DFlw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM4NzE1OQ==", "bodyText": "S/R to Golden?", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525387159", "createdAt": "2020-11-17T18:22:53Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-jpaserver-empi/src/test/java/ca/uhn/fhir/jpa/empi/provider/EmpiProviderClearLinkR4Test.java", "diffHunk": "@@ -29,16 +32,16 @@\n public class EmpiProviderClearLinkR4Test extends BaseLinkR4Test {\n \tprotected Practitioner myPractitioner;\n \tprotected StringType myPractitionerId;\n-\tprotected Person myPractitionerPerson;\n-\tprotected StringType myPractitionerPersonId;\n+\tprotected IAnyResource myPractitionerSourceResource;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDE3MzMwOnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-empi/src/test/java/ca/uhn/fhir/jpa/empi/provider/EmpiProviderClearLinkR4Test.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODoyMzoyN1rOH1DG6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODoyMzoyN1rOH1DG6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM4NzQ5Nw==", "bodyText": "can be removed", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525387497", "createdAt": "2020-11-17T18:23:27Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-jpaserver-empi/src/test/java/ca/uhn/fhir/jpa/empi/provider/EmpiProviderClearLinkR4Test.java", "diffHunk": "@@ -124,29 +135,31 @@ public void testPersonsWithCircularReferenceCanBeCleared() {\n \n \t\t//SUT\n \t\tParameters parameters = myEmpiProviderR4.clearEmpiLinks(null, myRequestDetails);\n+\n+\t\tprintLinks();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 126}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDE3NTI4OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-empi/src/test/java/ca/uhn/fhir/jpa/empi/provider/EmpiProviderMergePersonsR4Test.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODoyMzo1OVrOH1DIJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODoyMzo1OVrOH1DIJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM4NzgxMw==", "bodyText": "clean up comments", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525387813", "createdAt": "2020-11-17T18:23:59Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-jpaserver-empi/src/test/java/ca/uhn/fhir/jpa/empi/provider/EmpiProviderMergePersonsR4Test.java", "diffHunk": "@@ -3,132 +3,164 @@\n import ca.uhn.fhir.empi.api.EmpiLinkSourceEnum;\n import ca.uhn.fhir.empi.api.EmpiMatchResultEnum;\n import ca.uhn.fhir.empi.util.AssuranceLevelUtil;\n+import ca.uhn.fhir.empi.util.EmpiUtil;\n+import ca.uhn.fhir.jpa.entity.EmpiLink;\n import ca.uhn.fhir.rest.server.exceptions.InvalidRequestException;\n import ca.uhn.fhir.rest.server.exceptions.ResourceNotFoundException;\n-import org.hl7.fhir.r4.model.Person;\n+import org.hl7.fhir.instance.model.api.IAnyResource;\n+import org.hl7.fhir.instance.model.api.IBaseResource;\n+import org.hl7.fhir.r4.model.Identifier;\n+import org.hl7.fhir.r4.model.Patient;\n import org.hl7.fhir.r4.model.StringType;\n import org.junit.jupiter.api.BeforeEach;\n import org.junit.jupiter.api.Test;\n \n import java.util.List;\n+import java.util.Optional;\n \n import static org.hamcrest.MatcherAssert.assertThat;\n-import static org.hamcrest.Matchers.endsWith;\n-import static org.hamcrest.Matchers.hasSize;\n-import static org.hamcrest.Matchers.is;\n+import static org.hamcrest.Matchers.*;\n+import static org.junit.Assert.assertTrue;\n import static org.junit.jupiter.api.Assertions.assertEquals;\n import static org.junit.jupiter.api.Assertions.fail;\n \n public class EmpiProviderMergePersonsR4Test extends BaseProviderR4Test {\n \n-\tprivate Person myFromPerson;\n-\tprivate StringType myFromPersonId;\n-\tprivate Person myToPerson;\n-\tprivate StringType myToPersonId;\n+\tprivate Patient myFromSourcePatient;\n+\tprivate StringType myFromSourcePatientId;\n+\tprivate Patient myToSourcePatient;\n+\tprivate StringType myToSourcePatientId;\n \n \t@Override\n \t@BeforeEach\n \tpublic void before() {\n \t\tsuper.before();\n \t\tsuper.loadEmpiSearchParameters();\n \n-\t\tmyFromPerson = createPerson();\n-\t\tmyFromPersonId = new StringType(myFromPerson.getIdElement().getValue());\n-\t\tmyToPerson = createPerson();\n-\t\tmyToPersonId = new StringType(myToPerson.getIdElement().getValue());\n+\t\tmyFromSourcePatient = createGoldenPatient();\n+\t\tmyFromSourcePatientId = new StringType(myFromSourcePatient.getIdElement().getValue());\n+\t\tmyToSourcePatient = createGoldenPatient();\n+\t\tmyToSourcePatientId = new StringType(myToSourcePatient.getIdElement().getValue());\n \t}\n \n \t@Test\n \tpublic void testMerge() {\n-\t\tPerson mergedPerson = myEmpiProviderR4.mergePersons(myFromPersonId, myToPersonId, myRequestDetails);\n-\t\tassertEquals(myToPerson.getIdElement(), mergedPerson.getIdElement());\n-\t\tassertThat(mergedPerson, is(samePersonAs(myToPerson)));\n-\t\tassertEquals(2, getAllPersons().size());\n-\t\tassertEquals(1, getAllActivePersons().size());\n-\n-\t\tPerson fromPerson = myPersonDao.read(myFromPerson.getIdElement().toUnqualifiedVersionless());\n-\t\tassertThat(fromPerson.getActive(), is(false));\n-\t\tList<Person.PersonLinkComponent> links = fromPerson.getLink();\n+\t\tPatient mergedSourcePatient = (Patient) myEmpiProviderR4.mergeGoldenResources(myFromSourcePatientId,\n+\t\t\tmyToSourcePatientId, myRequestDetails);\n+\n+\t\tassertTrue(EmpiUtil.isGoldenRecord(myFromSourcePatient));\n+\t\tassertEquals(myToSourcePatient.getIdElement(), mergedSourcePatient.getIdElement());\n+\t\tassertThat(mergedSourcePatient, is(sameSourceResourceAs(myToSourcePatient)));\n+\t\tassertEquals(1, getAllRedirectedGoldenPatients().size());\n+\t\tassertEquals(1, getAllGoldenPatients().size());\n+\n+\t\tPatient fromSourcePatient = myPatientDao.read(myFromSourcePatient.getIdElement().toUnqualifiedVersionless());\n+\t\tassertThat(fromSourcePatient.getActive(), is(false));\n+\t\tassertTrue(EmpiUtil.isGoldenRecordRedirected(fromSourcePatient));\n+\n+\t\t//TODO GGG eventually this will need to check a redirect... this is a hack which doesnt work\n+\t\t// Optional<Identifier> redirect = fromSourcePatient.getIdentifier().stream().filter(theIdentifier -> theIdentifier.getSystem().equals(\"REDIRECT\")).findFirst();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 81}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDE4MDE3OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-empi/src/test/java/ca/uhn/fhir/jpa/empi/provider/EmpiProviderUpdateLinkR4Test.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODoyNTowN1rOH1DLFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODoyNTowN1rOH1DLFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM4ODU2NQ==", "bodyText": "rename S/R to Golden", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525388565", "createdAt": "2020-11-17T18:25:07Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-jpaserver-empi/src/test/java/ca/uhn/fhir/jpa/empi/provider/EmpiProviderUpdateLinkR4Test.java", "diffHunk": "@@ -49,91 +50,114 @@ public void testUpdateLinkMatch() {\n \n \t@Test\n \tpublic void testUpdateLinkTwiceFailsDueToWrongVersion() {\n-\t\tmyEmpiProviderR4.updateLink(myPersonId, myPatientId, MATCH_RESULT, myRequestDetails);\n+\t\tmyEmpiProviderR4.updateLink(mySourcePatientId, myPatientId, MATCH_RESULT, myRequestDetails);\n+\n+\t\tmateriallyChangeGoldenPatient();\n+\n \t\ttry {\n-\t\t\tmyEmpiProviderR4.updateLink(myPersonId, myPatientId, NO_MATCH_RESULT, myRequestDetails);\n+\t\t\tmyEmpiProviderR4.updateLink(mySourcePatientId, myPatientId, NO_MATCH_RESULT, myRequestDetails);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 66}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDE5MzYwOnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-empi/src/test/java/ca/uhn/fhir/jpa/empi/svc/EmpiLinkSvcTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODoyNzo1M1rOH1DSuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODoyNzo1M1rOH1DSuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM5MDUyMw==", "bodyText": "clean up comments", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525390523", "createdAt": "2020-11-17T18:27:53Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-jpaserver-empi/src/test/java/ca/uhn/fhir/jpa/empi/svc/EmpiLinkSvcTest.java", "diffHunk": "@@ -47,76 +53,78 @@ public void compareEmptyPatients() {\n \t@Test\n \tpublic void testCreateRemoveLink() {\n \t\tassertLinkCount(0);\n-\t\tPerson person = createPerson();\n-\t\tIdType personId = person.getIdElement().toUnqualifiedVersionless();\n-\t\tassertEquals(0, person.getLink().size());\n+\t\tPatient goldenPatient = createGoldenPatient();\n+\t\tIdType sourcePatientId = goldenPatient.getIdElement().toUnqualifiedVersionless();\n+\t\t// TODO NG should be ok to remove - assertEquals(0, goldenPatient.getLink().size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDIwNDAxOnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-empi/src/test/java/ca/uhn/fhir/jpa/empi/svc/EmpiMatchLinkSvcTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODozMDozMlrOH1DZIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODozMDozMlrOH1DZIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM5MjE2Mg==", "bodyText": "S/R to Golden", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525392162", "createdAt": "2020-11-17T18:30:32Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-jpaserver-empi/src/test/java/ca/uhn/fhir/jpa/empi/svc/EmpiMatchLinkSvcTest.java", "diffHunk": "@@ -87,54 +110,54 @@ public void testAddPatientLinksToExistingPersonIfMatch() {\n \t\tPatient patient2 = createPatientAndUpdateLinks(buildJanePatient());\n \t\tassertLinkCount(2);\n \n-\t\tassertThat(patient1, is(samePersonAs(patient2)));\n+\t\tassertThat(patient1, is(sameSourceResourceAs(patient2)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 95}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDM5NjU4OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-server-empi/src/main/java/ca/uhn/fhir/empi/api/EmpiConstants.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxOToxNjoyM1rOH1FQQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxOToxNjoyM1rOH1FQQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQyMjY1Ng==", "bodyText": "Do we need to adjust those to use MDM terminology?", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525422656", "createdAt": "2020-11-17T19:16:23Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-server-empi/src/main/java/ca/uhn/fhir/empi/api/EmpiConstants.java", "diffHunk": "@@ -25,13 +25,20 @@\n \t * TAG system for Person resources which are managed by HAPI EMPI.\n \t */\n \n-\tpublic static final String SYSTEM_EMPI_MANAGED = \"https://hapifhir.org/NamingSystem/managing-empi-system\";\n-\tpublic static final String CODE_HAPI_EMPI_MANAGED = \"HAPI-EMPI\";\n+\tpublic static final String SYSTEM_MDM_MANAGED = \"https://hapifhir.org/NamingSystem/managing-mdm-system\";\n+\tpublic static final String CODE_HAPI_MDM_MANAGED = \"HAPI-MDM\";\n \tpublic static final String DISPLAY_HAPI_EMPI_MANAGED = \"This Person can only be modified by Smile CDR's EMPI system.\";\n \tpublic static final String CODE_NO_EMPI_MANAGED = \"NO-EMPI\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDQwMTA1OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-server-empi/src/main/java/ca/uhn/fhir/empi/api/IEmpiSettings.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxOToxNzozNFrOH1FTCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxOToxNzozNFrOH1FTCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQyMzM3MA==", "bodyText": "Reaming to MDM?", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525423370", "createdAt": "2020-11-17T19:17:34Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-server-empi/src/main/java/ca/uhn/fhir/empi/api/IEmpiSettings.java", "diffHunk": "@@ -22,6 +22,8 @@\n \n import ca.uhn.fhir.empi.rules.json.EmpiRulesJson;\n \n+import java.util.stream.Collectors;\n+\n public interface IEmpiSettings {\n \tString EMPI_CHANNEL_NAME = \"empi\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDQwNjE4OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-server-empi/src/main/java/ca/uhn/fhir/empi/provider/BaseEmpiProvider.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxOToxOToxMFrOH1FWSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxOToxOToxMFrOH1FWSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQyNDIwMg==", "bodyText": "Move to MessageHelper and change to use proper terminology", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525424202", "createdAt": "2020-11-17T19:19:10Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-server-empi/src/main/java/ca/uhn/fhir/empi/provider/BaseEmpiProvider.java", "diffHunk": "@@ -43,43 +43,48 @@ public BaseEmpiProvider(FhirContext theFhirContext) {\n \t\tmyFhirContext = theFhirContext;\n \t}\n \n-\tprotected void validateMergeParameters(IPrimitiveType<String> theFromPersonId, IPrimitiveType<String> theToPersonId) {\n-\t\tvalidateNotNull(ProviderConstants.EMPI_MERGE_PERSONS_FROM_PERSON_ID, theFromPersonId);\n-\t\tvalidateNotNull(ProviderConstants.EMPI_MERGE_PERSONS_TO_PERSON_ID, theToPersonId);\n-\t\tif (theFromPersonId.getValue().equals(theToPersonId.getValue())) {\n+\tprotected void validateMergeParameters(IPrimitiveType<String> theFromGoldenResourceId, IPrimitiveType<String> theToGoldenResourceId) {\n+\t\t// TODO NG - Add validation to check that types are the same?\n+\t\tvalidateNotNull(ProviderConstants.MDM_MERGE_GR_FROM_GOLDEN_RESOURCE_ID, theFromGoldenResourceId);\n+\t\tvalidateNotNull(ProviderConstants.MDM_MERGE_GR_TO_GOLDEN_RESOURCE_ID, theToGoldenResourceId);\n+\t\tif (theFromGoldenResourceId.getValue().equals(theToGoldenResourceId.getValue())) {\n \t\t\tthrow new InvalidRequestException(\"fromPersonId must be different from toPersonId\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDQxMjg2OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-server-empi/src/main/java/ca/uhn/fhir/empi/provider/EmpiControllerHelper.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxOToyMDo0MVrOH1FaOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxOToyMDo0MVrOH1FaOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQyNTIwOQ==", "bodyText": "rename to validateIsMdmManaged", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525425209", "createdAt": "2020-11-17T19:20:41Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-server-empi/src/main/java/ca/uhn/fhir/empi/provider/EmpiControllerHelper.java", "diffHunk": "@@ -73,20 +84,24 @@ protected IAnyResource loadResource(IIdType theResourceId) {\n \t}\n \n \tpublic void validateMergeResources(IAnyResource theFromPerson, IAnyResource theToPerson) {\n-\t\tvalidateIsEmpiManaged(ProviderConstants.EMPI_MERGE_PERSONS_FROM_PERSON_ID, theFromPerson);\n-\t\tvalidateIsEmpiManaged(ProviderConstants.EMPI_MERGE_PERSONS_TO_PERSON_ID, theToPerson);\n+\t\tvalidateIsEmpiManaged(ProviderConstants.MDM_MERGE_GR_FROM_GOLDEN_RESOURCE_ID, theFromPerson);\n+\t\tvalidateIsEmpiManaged(ProviderConstants.MDM_MERGE_GR_TO_GOLDEN_RESOURCE_ID, theToPerson);\n \t}\n \n \tpublic String toJson(IAnyResource theAnyResource) {\n \t\treturn myFhirContext.newJsonParser().encodeResourceToString(theAnyResource);\n \t}\n \n-\tprivate void validateIsEmpiManaged(String theName, IAnyResource thePerson) {\n-\t\tif (!\"Person\".equals(myFhirContext.getResourceType(thePerson))) {\n-\t\t\tthrow new InvalidRequestException(\"Only Person resources can be merged.  The \" + theName + \" points to a \" + myFhirContext.getResourceType(thePerson));\n+\tpublic void validateIsEmpiManaged(String theName, IAnyResource theResource) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 66}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDQxODUwOnYy", "diffSide": "RIGHT", "path": "hapi-fhir-server-empi/src/main/java/ca/uhn/fhir/empi/provider/EmpiProviderDstu3.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxOToyMjoxM1rOH1FdtA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxOToyMjoxM1rOH1FdtA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQyNjEwMA==", "bodyText": "rename Empi to MDM", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525426100", "createdAt": "2020-11-17T19:22:13Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-server-empi/src/main/java/ca/uhn/fhir/empi/provider/EmpiProviderDstu3.java", "diffHunk": "@@ -79,107 +79,100 @@ public EmpiProviderDstu3(FhirContext theFhirContext, IEmpiControllerSvc theEmpiC\n \t}\n \n \t@Operation(name = ProviderConstants.EMPI_MATCH, type = Patient.class)\n-\tpublic Bundle match(@OperationParam(name = ProviderConstants.EMPI_MATCH_RESOURCE, min = 1, max = 1) Patient thePatient) {\n+\tpublic Bundle match(@OperationParam(name = ProviderConstants.MDM_MATCH_RESOURCE, min = 1, max = 1) Patient thePatient) {\n \t\tif (thePatient == null) {\n \t\t\tthrow new InvalidRequestException(\"resource may not be null\");\n \t\t}\n \n-\t\tList<MatchedTarget> matches = myEmpiMatchFinderSvc.getMatchedTargets(\"Patient\", thePatient);\n-\t\tmatches.sort(Comparator.comparing((MatchedTarget m) -> m.getMatchResult().getNormalizedScore()).reversed());\n-\n-\t\tBundle retVal = new Bundle();\n-\t\tretVal.setType(Bundle.BundleType.SEARCHSET);\n-\t\tretVal.setId(UUID.randomUUID().toString());\n-\t\tretVal.getMeta().setLastUpdatedElement(InstantType.now());\n-\n-\t\tfor (MatchedTarget next : matches) {\n-\t\t\tboolean shouldKeepThisEntry = next.isMatch() || next.isPossibleMatch();\n-\t\t\tif (!shouldKeepThisEntry) {\n-\t\t\t\tcontinue;\n-\t\t\t}\n-\n-\t\t\tBundle.BundleEntryComponent entry = new Bundle.BundleEntryComponent();\n-\t\t\tentry.setResource((Resource) next.getTarget());\n-\t\t\tentry.setSearch(toBundleEntrySearchComponent(next));\n+\t\treturn getMatchesAndPossibleMatchesForResource(thePatient, \"Patient\");\n+\t}\n \n-\t\t\tretVal.addEntry(entry);\n+\t@Operation(name = ProviderConstants.MDM_MATCH)\n+\tpublic Bundle serverMatch(@OperationParam(name = ProviderConstants.MDM_MATCH_RESOURCE, min = 1, max = 1) IAnyResource theResource,\n+\t\t\t\t\t\t\t\t\t  @OperationParam(name = ProviderConstants.MDM_RESOURCE_TYPE, min = 1, max = 1) StringType theResourceType\n+\t) {\n+\t\tif (theResource == null) {\n+\t\t\tthrow new InvalidRequestException(\"resource may not be null\");\n \t\t}\n+\t\treturn getMatchesAndPossibleMatchesForResource(theResource, theResourceType.getValueNotNull());\n \n-\t\treturn retVal;\n \t}\n \n \tprivate Bundle.BundleEntrySearchComponent toBundleEntrySearchComponent(MatchedTarget theMatchedTarget) {\n \t\tBundle.BundleEntrySearchComponent searchComponent = new Bundle.BundleEntrySearchComponent();\n \t\tsearchComponent.setMode(Bundle.SearchEntryMode.MATCH);\n \t\tsearchComponent.setScore(theMatchedTarget.getMatchResult().getNormalizedScore());\n \n-\t\tMatchGrade matchGrade = MatchGrade.PROBABLE;\n-\t\tif (theMatchedTarget.isMatch()) {\n-\t\t\tmatchGrade = MatchGrade.CERTAIN;\n-\t\t} else if (theMatchedTarget.isPossibleMatch()) {\n-\t\t\tmatchGrade = MatchGrade.POSSIBLE;\n-\t\t}\n+\t\tMatchGrade matchGrade = getMatchGrade(theMatchedTarget);\n \n \t\tsearchComponent.addExtension(EmpiConstants.FIHR_STRUCTURE_DEF_MATCH_GRADE_URL_NAMESPACE, new CodeType(matchGrade.toCode()));\n \t\treturn searchComponent;\n \t}\n \n-\t@Operation(name = ProviderConstants.EMPI_MERGE_PERSONS, type = Person.class)\n-\tpublic Person mergePerson(@OperationParam(name=ProviderConstants.EMPI_MERGE_PERSONS_FROM_PERSON_ID, min = 1, max = 1) StringType theFromPersonId,\n-\t\t\t\t\t\t\t\t\t  @OperationParam(name=ProviderConstants.EMPI_MERGE_PERSONS_TO_PERSON_ID, min = 1, max = 1) StringType theToPersonId,\n-\t\t\t\t\t\t\t\t\t  RequestDetails theRequestDetails) {\n-\t\tvalidateMergeParameters(theFromPersonId, theToPersonId);\n+\t@Operation(name = ProviderConstants.MDM_MERGE_GOLDEN_RESOURCES)\n+\tpublic IBaseResource mergeGoldenResource(@OperationParam(name=ProviderConstants.MDM_MERGE_GR_FROM_GOLDEN_RESOURCE_ID, min = 1, max = 1) StringType theFromGoldenResourceId,\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t  @OperationParam(name=ProviderConstants.MDM_MERGE_GR_TO_GOLDEN_RESOURCE_ID, min = 1, max = 1) StringType theToGoldenResourceId,\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t  RequestDetails theRequestDetails) {\n+\t\tvalidateMergeParameters(theFromGoldenResourceId, theToGoldenResourceId);\n \n-\t\treturn (Person) myEmpiControllerSvc.mergePersons(theFromPersonId.getValue(), theToPersonId.getValue(), createEmpiContext(theRequestDetails, EmpiTransactionContext.OperationType.MERGE_PERSONS));\n+\t\tString resourceType = getResourceType(ProviderConstants.MDM_MERGE_GR_FROM_GOLDEN_RESOURCE_ID, theFromGoldenResourceId);\n+\n+\t\treturn myEmpiControllerSvc.mergeGoldenResources(theFromGoldenResourceId.getValue(), theToGoldenResourceId.getValue(),\n+\t\t\tcreateMdmContext(theRequestDetails, MdmTransactionContext.OperationType.MERGE_PERSONS, resourceType));\n \t}\n \n-\t@Operation(name = ProviderConstants.EMPI_UPDATE_LINK, type = Person.class)\n-\tpublic Person updateLink(@OperationParam(name=ProviderConstants.EMPI_UPDATE_LINK_PERSON_ID, min = 1, max = 1) StringType thePersonId,\n-\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t  @OperationParam(name=ProviderConstants.EMPI_UPDATE_LINK_TARGET_ID, min = 1, max = 1) StringType theTargetId,\n-\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t  @OperationParam(name=ProviderConstants.EMPI_UPDATE_LINK_MATCH_RESULT, min = 1, max = 1) StringType theMatchResult,\n+\t@Operation(name = ProviderConstants.MDM_UPDATE_LINK)\n+\tpublic IBaseResource updateLink(@OperationParam(name=ProviderConstants.MDM_UPDATE_LINK_GOLDEN_RESOURCE_ID, min = 1, max = 1) StringType theGoldenResourceId,\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t  @OperationParam(name=ProviderConstants.MDM_UPDATE_LINK_RESOURCE_ID, min = 1, max = 1) StringType theTargetId,\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t  @OperationParam(name=ProviderConstants.MDM_UPDATE_LINK_MATCH_RESULT, min = 1, max = 1) StringType theMatchResult,\n \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t  ServletRequestDetails theRequestDetails) {\n \n-\t\tvalidateUpdateLinkParameters(thePersonId, theTargetId, theMatchResult);\n+\t\tvalidateUpdateLinkParameters(theGoldenResourceId, theTargetId, theMatchResult);\n \n-\t\treturn (Person) myEmpiControllerSvc.updateLink(thePersonId.getValue(), theTargetId.getValue(), theMatchResult.getValue(), createEmpiContext(theRequestDetails, EmpiTransactionContext.OperationType.UPDATE_LINK));\n+\t\treturn myEmpiControllerSvc.updateLink(theGoldenResourceId.getValue(), theTargetId.getValue(), theMatchResult.getValue(),\n+\t\t\tcreateMdmContext(theRequestDetails, MdmTransactionContext.OperationType.UPDATE_LINK,\n+\t\t\t\tgetResourceType(ProviderConstants.MDM_UPDATE_LINK_GOLDEN_RESOURCE_ID, theGoldenResourceId)));\n \t}\n \n-\t@Operation(name = ProviderConstants.EMPI_QUERY_LINKS)\n-\tpublic Parameters queryLinks(@OperationParam(name=ProviderConstants.EMPI_QUERY_LINKS_PERSON_ID, min = 0, max = 1) StringType thePersonId,\n-\t\t\t\t\t\t\t\t\t\t  @OperationParam(name=ProviderConstants.EMPI_QUERY_LINKS_TARGET_ID, min = 0, max = 1) StringType theTargetId,\n+\t@Operation(name = ProviderConstants.MDM_QUERY_LINKS)\n+\tpublic Parameters queryLinks(@OperationParam(name=ProviderConstants.MDM_QUERY_LINKS_GOLDEN_RESOURCE_ID, min = 0, max = 1) StringType theGoldenResourceId,\n+\t\t\t\t\t\t\t\t\t\t  @OperationParam(name=ProviderConstants.MDM_QUERY_LINKS_RESOURCE_ID, min = 0, max = 1) StringType theTargetResourceId,\n \t\t\t\t\t\t\t\t\t\t  @OperationParam(name=ProviderConstants.EMPI_QUERY_LINKS_MATCH_RESULT, min = 0, max = 1) StringType theMatchResult,\n \t\t\t\t\t\t\t\t\t\t  @OperationParam(name=ProviderConstants.EMPI_QUERY_LINKS_MATCH_RESULT, min = 0, max = 1) StringType theLinkSource,\n \t\t\t\t\t\t\t\t\t\t  ServletRequestDetails theRequestDetails) {\n \n-\t\tStream<EmpiLinkJson> empiLinkJson = myEmpiControllerSvc.queryLinks(extractStringOrNull(thePersonId), extractStringOrNull(theTargetId), extractStringOrNull(theMatchResult), extractStringOrNull(theLinkSource), createEmpiContext(theRequestDetails, EmpiTransactionContext.OperationType.QUERY_LINKS));\n+\t\tStream<EmpiLinkJson> empiLinkJson = myEmpiControllerSvc.queryLinks(extractStringOrNull(theGoldenResourceId), extractStringOrNull(theTargetResourceId),\n+\t\t\textractStringOrNull(theMatchResult), extractStringOrNull(theLinkSource), createMdmContext(theRequestDetails,\n+\t\t\t\tMdmTransactionContext.OperationType.QUERY_LINKS, getResourceType(ProviderConstants.MDM_QUERY_LINKS_GOLDEN_RESOURCE_ID, theGoldenResourceId)));\n \t\treturn (Parameters) parametersFromEmpiLinks(empiLinkJson, true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 138}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDQyNDA0OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-server-empi/src/main/java/ca/uhn/fhir/empi/provider/EmpiProviderR4.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxOToyMzo0NVrOH1FhNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxOToyMzo0NVrOH1FhNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQyNjk5OQ==", "bodyText": "MdmProviderR4?", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525426999", "createdAt": "2020-11-17T19:23:45Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-server-empi/src/main/java/ca/uhn/fhir/empi/provider/EmpiProviderR4.java", "diffHunk": "@@ -63,30 +62,54 @@\n public class EmpiProviderR4 extends BaseEmpiProvider {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDQzNjQ2OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-server-empi/src/main/java/ca/uhn/fhir/empi/util/EmpiUtil.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxOToyNjo1NFrOH1Fo-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxOToyNjo1NFrOH1Fo-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQyODk4NQ==", "bodyText": "Empi -> MDM", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525428985", "createdAt": "2020-11-17T19:26:54Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-server-empi/src/main/java/ca/uhn/fhir/empi/util/EmpiUtil.java", "diffHunk": "@@ -55,7 +56,70 @@ public static boolean isEmpiAccessible(IBaseResource theBaseResource) {\n \t * @return a boolean indicating whether or not EMPI manages this Person.\n \t */\n \tpublic static boolean isEmpiManaged(IBaseResource theBaseResource) {\n-\t\treturn theBaseResource.getMeta().getTag(EmpiConstants.SYSTEM_EMPI_MANAGED, EmpiConstants.CODE_HAPI_EMPI_MANAGED) != null;\n+\t\treturn resourceHasTag(theBaseResource, EmpiConstants.SYSTEM_MDM_MANAGED, EmpiConstants.CODE_HAPI_MDM_MANAGED);\n+\t}\n+\n+\tpublic static boolean isGoldenRecord(IBaseResource theBaseResource) {\n+\t\treturn resourceHasTag(theBaseResource, EmpiConstants.SYSTEM_GOLDEN_RECORD_STATUS, EmpiConstants.CODE_GOLDEN_RECORD);\n+\t}\n+\n+\tpublic static boolean isGoldenRecordRedirected(IBaseResource theBaseResource) {\n+\t\treturn resourceHasTag(theBaseResource, EmpiConstants.SYSTEM_GOLDEN_RECORD_STATUS, EmpiConstants.CODE_GOLDEN_RECORD_REDIRECTED);\n+\t}\n+\n+\tprivate static boolean resourceHasTag(IBaseResource theTheBaseResource, String theSystem, String theCode) {\n+\t\treturn theTheBaseResource.getMeta().getTag(theSystem, theCode) != null;\n+\t}\n+\n+\tprivate static Optional<? extends IBaseCoding> getTagWithSystem(IBaseResource theResource, String theSystem) {\n+\t\treturn theResource.getMeta().getTag().stream().filter(tag -> tag.getSystem().equalsIgnoreCase(theSystem)).findFirst();\n+\t}\n+\n+\tpublic static void removeTagWithSystem(IBaseResource theResource, String theSystem) {\n+\t\ttheResource.getMeta().getTag().removeIf(tag -> tag.getSystem().equalsIgnoreCase(theSystem));\n+\t}\n+\n+\n+\t/**\n+\t * Sets the EMPI-managed tag, indicating the EMPI system has ownership of this\n+\t * Resource. No changes are made if resource is already maanged by EMPI.\n+\t *\n+\t * @param theBaseResource resource to set the tag for\n+\t * @return\n+\t * \t\tReturns resource with the tag set.\n+\t */\n+\tpublic static IBaseResource setEmpiManaged(IBaseResource theBaseResource) {\n+\t\treturn setTagOnResource(theBaseResource, EmpiConstants.SYSTEM_MDM_MANAGED, EmpiConstants.CODE_HAPI_MDM_MANAGED, EmpiConstants.DISPLAY_HAPI_EMPI_MANAGED);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 66}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDQ0MTgxOnYy", "diffSide": "RIGHT", "path": "hapi-fhir-server-empi/src/main/java/ca/uhn/fhir/empi/util/PersonHelper.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxOToyODoxOVrOH1FsbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxOToyODoxOVrOH1FsbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQyOTg2OQ==", "bodyText": "rename S/R to Golden", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525429869", "createdAt": "2020-11-17T19:28:19Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-server-empi/src/main/java/ca/uhn/fhir/empi/util/PersonHelper.java", "diffHunk": "@@ -73,374 +82,261 @@ public PersonHelper(FhirContext theFhirContext) {\n \t}\n \n \t/**\n-\t * Given a Person, extract all {@link IIdType}s for the linked targets.\n-\t *\n-\t * @param thePerson the Person to extract link IDs from.\n-\t * @return a Stream of {@link IIdType}.\n-\t */\n-\tpublic Stream<IIdType> getLinkIds(IBaseResource thePerson) {\n-\t\tswitch (myFhirContext.getVersion().getVersion()) {\n-\t\t\tcase R4:\n-\t\t\t\tPerson personR4 = (Person) thePerson;\n-\t\t\t\treturn personR4.getLink().stream()\n-\t\t\t\t\t.map(Person.PersonLinkComponent::getTarget)\n-\t\t\t\t\t.map(IBaseReference::getReferenceElement)\n-\t\t\t\t\t.map(IIdType::toUnqualifiedVersionless);\n-\t\t\tcase DSTU3:\n-\t\t\t\torg.hl7.fhir.dstu3.model.Person personStu3 = (org.hl7.fhir.dstu3.model.Person) thePerson;\n-\t\t\t\treturn personStu3.getLink().stream()\n-\t\t\t\t\t.map(org.hl7.fhir.dstu3.model.Person.PersonLinkComponent::getTarget)\n-\t\t\t\t\t.map(IBaseReference::getReferenceElement)\n-\t\t\t\t\t.map(IIdType::toUnqualifiedVersionless);\n-\t\t\tdefault:\n-\t\t\t\tthrow new UnsupportedOperationException(\"Version not supported: \" + myFhirContext.getVersion().getVersion());\n-\t\t}\n-\t}\n-\n-\t/**\n-\t * Determine whether or not the given {@link IBaseResource} person contains a link to a particular {@link IIdType}\n+\t * Creates a copy of the specified resource. This method will carry over resource EID if it exists. If it does not exist,\n+\t * a randomly generated UUID EID will be created.\n \t *\n-\t * @param thePerson     The person to check\n-\t * @param theResourceId The ID to check.\n-\t * @return A boolean indicating whether or not there was a contained link.\n+\t * @param <T>                 Supported MDM resource type (e.g. Patient, Practitioner)\n+\t * @param theIncomingResource The resource that will be used as the starting point for the MDM linking.\n \t */\n-\tpublic boolean containsLinkTo(IBaseResource thePerson, IIdType theResourceId) {\n-\t\tStream<IIdType> links = getLinkIds(thePerson);\n-\t\treturn links.anyMatch(link -> link.getValue().equals(theResourceId.getValue()));\n-\t}\n+\tpublic <T extends IAnyResource> T createGoldenResourceFromMdmTarget(T theIncomingResource) {\n+\t\tvalidateContextSupported();\n \n-\t/**\n-\t * Create or update a link from source {@link IBaseResource} to the target {@link IIdType}, with the given {@link CanonicalIdentityAssuranceLevel}.\n-\t * @param thePerson The person who's link needs to be updated.\n-\t * @param theResourceId The target of the link\n-\t * @param canonicalAssuranceLevel The level of certainty of this link.\n-\t * @param theEmpiTransactionContext\n-\t */\n-\tpublic void addOrUpdateLink(IBaseResource thePerson, IIdType theResourceId, @Nonnull CanonicalIdentityAssuranceLevel canonicalAssuranceLevel, EmpiTransactionContext theEmpiTransactionContext) {\n-\t\tswitch (myFhirContext.getVersion().getVersion()) {\n-\t\t\tcase R4:\n-\t\t\t\thandleLinkUpdateR4(thePerson, theResourceId, canonicalAssuranceLevel, theEmpiTransactionContext);\n-\t\t\t\tbreak;\n-\t\t\tcase DSTU3:\n-\t\t\t\thandleLinkUpdateDSTU3(thePerson, theResourceId, canonicalAssuranceLevel, theEmpiTransactionContext);\n-\t\t\t\tbreak;\n-\t\t\tdefault:\n-\t\t\t\tthrow new UnsupportedOperationException(\"Version not supported: \" + myFhirContext.getVersion().getVersion());\n-\t\t}\n-\t}\n+\t\t// get a ref to the actual ID Field\n+\t\tRuntimeResourceDefinition resourceDefinition = myFhirContext.getResourceDefinition(theIncomingResource);\n+\t\tIBaseResource newSourceResource = resourceDefinition.newInstance();\n \n-\tprivate void handleLinkUpdateDSTU3(IBaseResource thePerson, IIdType theResourceId, CanonicalIdentityAssuranceLevel theCanonicalAssuranceLevel, EmpiTransactionContext theTransactionLogMessages) {\n-\t\tif (theCanonicalAssuranceLevel == null) {\n-\t\t\tourLog.warn(\"Refusing to update or add a link without an Assurance Level.\");\n-\t\t\treturn;\n-\t\t}\n+\t\t// hapi has 2 metamodels: for children and types\n+\t\tBaseRuntimeChildDefinition sourceResourceIdentifier = resourceDefinition.getChildByName(FIELD_NAME_IDENTIFIER);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 146}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDQ0MzYwOnYy", "diffSide": "RIGHT", "path": "hapi-fhir-server-empi/src/main/java/ca/uhn/fhir/empi/util/PersonHelper.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxOToyODo0NlrOH1FthA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxOToyODo0NlrOH1FthA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQzMDE0OA==", "bodyText": "S/R to Golden", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525430148", "createdAt": "2020-11-17T19:28:46Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-server-empi/src/main/java/ca/uhn/fhir/empi/util/PersonHelper.java", "diffHunk": "@@ -73,374 +82,261 @@ public PersonHelper(FhirContext theFhirContext) {\n \t}\n \n \t/**\n-\t * Given a Person, extract all {@link IIdType}s for the linked targets.\n-\t *\n-\t * @param thePerson the Person to extract link IDs from.\n-\t * @return a Stream of {@link IIdType}.\n-\t */\n-\tpublic Stream<IIdType> getLinkIds(IBaseResource thePerson) {\n-\t\tswitch (myFhirContext.getVersion().getVersion()) {\n-\t\t\tcase R4:\n-\t\t\t\tPerson personR4 = (Person) thePerson;\n-\t\t\t\treturn personR4.getLink().stream()\n-\t\t\t\t\t.map(Person.PersonLinkComponent::getTarget)\n-\t\t\t\t\t.map(IBaseReference::getReferenceElement)\n-\t\t\t\t\t.map(IIdType::toUnqualifiedVersionless);\n-\t\t\tcase DSTU3:\n-\t\t\t\torg.hl7.fhir.dstu3.model.Person personStu3 = (org.hl7.fhir.dstu3.model.Person) thePerson;\n-\t\t\t\treturn personStu3.getLink().stream()\n-\t\t\t\t\t.map(org.hl7.fhir.dstu3.model.Person.PersonLinkComponent::getTarget)\n-\t\t\t\t\t.map(IBaseReference::getReferenceElement)\n-\t\t\t\t\t.map(IIdType::toUnqualifiedVersionless);\n-\t\t\tdefault:\n-\t\t\t\tthrow new UnsupportedOperationException(\"Version not supported: \" + myFhirContext.getVersion().getVersion());\n-\t\t}\n-\t}\n-\n-\t/**\n-\t * Determine whether or not the given {@link IBaseResource} person contains a link to a particular {@link IIdType}\n+\t * Creates a copy of the specified resource. This method will carry over resource EID if it exists. If it does not exist,\n+\t * a randomly generated UUID EID will be created.\n \t *\n-\t * @param thePerson     The person to check\n-\t * @param theResourceId The ID to check.\n-\t * @return A boolean indicating whether or not there was a contained link.\n+\t * @param <T>                 Supported MDM resource type (e.g. Patient, Practitioner)\n+\t * @param theIncomingResource The resource that will be used as the starting point for the MDM linking.\n \t */\n-\tpublic boolean containsLinkTo(IBaseResource thePerson, IIdType theResourceId) {\n-\t\tStream<IIdType> links = getLinkIds(thePerson);\n-\t\treturn links.anyMatch(link -> link.getValue().equals(theResourceId.getValue()));\n-\t}\n+\tpublic <T extends IAnyResource> T createGoldenResourceFromMdmTarget(T theIncomingResource) {\n+\t\tvalidateContextSupported();\n \n-\t/**\n-\t * Create or update a link from source {@link IBaseResource} to the target {@link IIdType}, with the given {@link CanonicalIdentityAssuranceLevel}.\n-\t * @param thePerson The person who's link needs to be updated.\n-\t * @param theResourceId The target of the link\n-\t * @param canonicalAssuranceLevel The level of certainty of this link.\n-\t * @param theEmpiTransactionContext\n-\t */\n-\tpublic void addOrUpdateLink(IBaseResource thePerson, IIdType theResourceId, @Nonnull CanonicalIdentityAssuranceLevel canonicalAssuranceLevel, EmpiTransactionContext theEmpiTransactionContext) {\n-\t\tswitch (myFhirContext.getVersion().getVersion()) {\n-\t\t\tcase R4:\n-\t\t\t\thandleLinkUpdateR4(thePerson, theResourceId, canonicalAssuranceLevel, theEmpiTransactionContext);\n-\t\t\t\tbreak;\n-\t\t\tcase DSTU3:\n-\t\t\t\thandleLinkUpdateDSTU3(thePerson, theResourceId, canonicalAssuranceLevel, theEmpiTransactionContext);\n-\t\t\t\tbreak;\n-\t\t\tdefault:\n-\t\t\t\tthrow new UnsupportedOperationException(\"Version not supported: \" + myFhirContext.getVersion().getVersion());\n-\t\t}\n-\t}\n+\t\t// get a ref to the actual ID Field\n+\t\tRuntimeResourceDefinition resourceDefinition = myFhirContext.getResourceDefinition(theIncomingResource);\n+\t\tIBaseResource newSourceResource = resourceDefinition.newInstance();\n \n-\tprivate void handleLinkUpdateDSTU3(IBaseResource thePerson, IIdType theResourceId, CanonicalIdentityAssuranceLevel theCanonicalAssuranceLevel, EmpiTransactionContext theTransactionLogMessages) {\n-\t\tif (theCanonicalAssuranceLevel == null) {\n-\t\t\tourLog.warn(\"Refusing to update or add a link without an Assurance Level.\");\n-\t\t\treturn;\n-\t\t}\n+\t\t// hapi has 2 metamodels: for children and types\n+\t\tBaseRuntimeChildDefinition sourceResourceIdentifier = resourceDefinition.getChildByName(FIELD_NAME_IDENTIFIER);\n \n-\t\torg.hl7.fhir.dstu3.model.Person person = (org.hl7.fhir.dstu3.model.Person) thePerson;\n-\t\tif (!containsLinkTo(thePerson, theResourceId)) {\n-\t\t\tperson.addLink().setTarget(new org.hl7.fhir.dstu3.model.Reference(theResourceId)).setAssurance(theCanonicalAssuranceLevel.toDstu3());\n-\t\t\tlogLinkAddMessage(thePerson, theResourceId, theCanonicalAssuranceLevel, theTransactionLogMessages);\n-\t\t} else {\n-\t\t\tperson.getLink().stream()\n-\t\t\t\t.filter(link -> link.getTarget().getReference().equalsIgnoreCase(theResourceId.getValue()))\n-\t\t\t\t.findFirst()\n-\t\t\t\t.ifPresent(link -> {\n-\t\t\t\t\tlogLinkUpdateMessage(thePerson, theResourceId, theCanonicalAssuranceLevel, theTransactionLogMessages, link.getAssurance().toCode());\n-\t\t\t\t\tlink.setAssurance(theCanonicalAssuranceLevel.toDstu3());\n-\t\t\t\t});\n-\t\t}\n-\t}\n+\t\tcloneAllExternalEidsIntoNewSourceResource(sourceResourceIdentifier, theIncomingResource, newSourceResource);\n \n-\tprivate void logLinkAddMessage(IBaseResource thePerson, IIdType theResourceId, CanonicalIdentityAssuranceLevel theCanonicalAssuranceLevel, EmpiTransactionContext theEmpiTransactionContext) {\n-\t\ttheEmpiTransactionContext.addTransactionLogMessage(\"Creating new link from \" + (StringUtils.isBlank(thePerson.getIdElement().toUnqualifiedVersionless().getValue()) ? \"new Person\" : thePerson.getIdElement().toUnqualifiedVersionless()) + \" -> \" + theResourceId.toUnqualifiedVersionless() + \" with IdentityAssuranceLevel: \" + theCanonicalAssuranceLevel.name());\n-\t}\n+\t\taddHapiEidIfNoExternalEidIsPresent(newSourceResource, sourceResourceIdentifier, theIncomingResource);\n \n-\tprivate void logLinkUpdateMessage(IBaseResource thePerson, IIdType theResourceId, CanonicalIdentityAssuranceLevel canonicalAssuranceLevel, EmpiTransactionContext theEmpiTransactionContext, String theOriginalAssuranceLevel) {\n-\t\ttheEmpiTransactionContext.addTransactionLogMessage(\"Updating link from \" + thePerson.getIdElement().toUnqualifiedVersionless() + \" -> \" + theResourceId.toUnqualifiedVersionless() + \". Changing IdentityAssuranceLevel: \" + theOriginalAssuranceLevel + \" -> \" + canonicalAssuranceLevel.name());\n-\t}\n+\t\t//setGoldenResource(newSourceResource, resourceDefinition, true);\n \n-\tprivate void handleLinkUpdateR4(IBaseResource thePerson, IIdType theResourceId, CanonicalIdentityAssuranceLevel canonicalAssuranceLevel, EmpiTransactionContext theEmpiTransactionContext) {\n-\t\tif (canonicalAssuranceLevel == null) {\n-\t\t\tourLog.warn(\"Refusing to update or add a link without an Assurance Level.\");\n-\t\t\treturn;\n-\t\t}\n+\t\tEmpiUtil.setEmpiManaged(newSourceResource);\n+\t\tEmpiUtil.setGoldenResource(newSourceResource);\n \n-\t\tPerson person = (Person) thePerson;\n-\t\tif (!containsLinkTo(thePerson, theResourceId)) {\n-\t\t\tperson.addLink().setTarget(new Reference(theResourceId)).setAssurance(canonicalAssuranceLevel.toR4());\n-\t\t\tlogLinkAddMessage(thePerson, theResourceId, canonicalAssuranceLevel, theEmpiTransactionContext);\n-\t\t} else {\n-\t\t\tperson.getLink().stream()\n-\t\t\t\t.filter(link -> link.getTarget().getReference().equalsIgnoreCase(theResourceId.getValue()))\n-\t\t\t\t.findFirst()\n-\t\t\t\t.ifPresent(link -> {\n-\t\t\t\t\tlogLinkUpdateMessage(thePerson, theResourceId, canonicalAssuranceLevel, theEmpiTransactionContext, link.getAssurance().toCode());\n-\t\t\t\t\tlink.setAssurance(canonicalAssuranceLevel.toR4());\n-\t\t\t\t});\n-\t\t}\n+\t\treturn (T) newSourceResource;\n \t}\n \n-\n \t/**\n-\t * Removes a link from the given {@link IBaseResource} to the target {@link IIdType}.\n-\t * @param thePerson The person to remove the link from.\n-\t * @param theResourceId The target ID to remove.\n-\t * @param theEmpiTransactionContext\n+\t * If there are no external EIDs on the incoming resource, create a new HAPI EID on the new SourceResource.\n \t */\n-\tpublic void removeLink(IBaseResource thePerson, IIdType theResourceId, EmpiTransactionContext theEmpiTransactionContext) {\n-\t\tif (!containsLinkTo(thePerson, theResourceId)) {\n+\t//TODO GGG ask james if there is any way we can convert this canonical EID into a generic STU-agnostic IBase.\n+\tprivate <T extends IAnyResource> void addHapiEidIfNoExternalEidIsPresent(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 209}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDQ0NTcwOnYy", "diffSide": "RIGHT", "path": "hapi-fhir-server-empi/src/main/java/ca/uhn/fhir/empi/util/PersonHelper.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxOToyOToxN1rOH1FuxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxOToyOToxN1rOH1FuxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQzMDQ2OQ==", "bodyText": "s/r to golden", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525430469", "createdAt": "2020-11-17T19:29:17Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-server-empi/src/main/java/ca/uhn/fhir/empi/util/PersonHelper.java", "diffHunk": "@@ -73,374 +82,261 @@ public PersonHelper(FhirContext theFhirContext) {\n \t}\n \n \t/**\n-\t * Given a Person, extract all {@link IIdType}s for the linked targets.\n-\t *\n-\t * @param thePerson the Person to extract link IDs from.\n-\t * @return a Stream of {@link IIdType}.\n-\t */\n-\tpublic Stream<IIdType> getLinkIds(IBaseResource thePerson) {\n-\t\tswitch (myFhirContext.getVersion().getVersion()) {\n-\t\t\tcase R4:\n-\t\t\t\tPerson personR4 = (Person) thePerson;\n-\t\t\t\treturn personR4.getLink().stream()\n-\t\t\t\t\t.map(Person.PersonLinkComponent::getTarget)\n-\t\t\t\t\t.map(IBaseReference::getReferenceElement)\n-\t\t\t\t\t.map(IIdType::toUnqualifiedVersionless);\n-\t\t\tcase DSTU3:\n-\t\t\t\torg.hl7.fhir.dstu3.model.Person personStu3 = (org.hl7.fhir.dstu3.model.Person) thePerson;\n-\t\t\t\treturn personStu3.getLink().stream()\n-\t\t\t\t\t.map(org.hl7.fhir.dstu3.model.Person.PersonLinkComponent::getTarget)\n-\t\t\t\t\t.map(IBaseReference::getReferenceElement)\n-\t\t\t\t\t.map(IIdType::toUnqualifiedVersionless);\n-\t\t\tdefault:\n-\t\t\t\tthrow new UnsupportedOperationException(\"Version not supported: \" + myFhirContext.getVersion().getVersion());\n-\t\t}\n-\t}\n-\n-\t/**\n-\t * Determine whether or not the given {@link IBaseResource} person contains a link to a particular {@link IIdType}\n+\t * Creates a copy of the specified resource. This method will carry over resource EID if it exists. If it does not exist,\n+\t * a randomly generated UUID EID will be created.\n \t *\n-\t * @param thePerson     The person to check\n-\t * @param theResourceId The ID to check.\n-\t * @return A boolean indicating whether or not there was a contained link.\n+\t * @param <T>                 Supported MDM resource type (e.g. Patient, Practitioner)\n+\t * @param theIncomingResource The resource that will be used as the starting point for the MDM linking.\n \t */\n-\tpublic boolean containsLinkTo(IBaseResource thePerson, IIdType theResourceId) {\n-\t\tStream<IIdType> links = getLinkIds(thePerson);\n-\t\treturn links.anyMatch(link -> link.getValue().equals(theResourceId.getValue()));\n-\t}\n+\tpublic <T extends IAnyResource> T createGoldenResourceFromMdmTarget(T theIncomingResource) {\n+\t\tvalidateContextSupported();\n \n-\t/**\n-\t * Create or update a link from source {@link IBaseResource} to the target {@link IIdType}, with the given {@link CanonicalIdentityAssuranceLevel}.\n-\t * @param thePerson The person who's link needs to be updated.\n-\t * @param theResourceId The target of the link\n-\t * @param canonicalAssuranceLevel The level of certainty of this link.\n-\t * @param theEmpiTransactionContext\n-\t */\n-\tpublic void addOrUpdateLink(IBaseResource thePerson, IIdType theResourceId, @Nonnull CanonicalIdentityAssuranceLevel canonicalAssuranceLevel, EmpiTransactionContext theEmpiTransactionContext) {\n-\t\tswitch (myFhirContext.getVersion().getVersion()) {\n-\t\t\tcase R4:\n-\t\t\t\thandleLinkUpdateR4(thePerson, theResourceId, canonicalAssuranceLevel, theEmpiTransactionContext);\n-\t\t\t\tbreak;\n-\t\t\tcase DSTU3:\n-\t\t\t\thandleLinkUpdateDSTU3(thePerson, theResourceId, canonicalAssuranceLevel, theEmpiTransactionContext);\n-\t\t\t\tbreak;\n-\t\t\tdefault:\n-\t\t\t\tthrow new UnsupportedOperationException(\"Version not supported: \" + myFhirContext.getVersion().getVersion());\n-\t\t}\n-\t}\n+\t\t// get a ref to the actual ID Field\n+\t\tRuntimeResourceDefinition resourceDefinition = myFhirContext.getResourceDefinition(theIncomingResource);\n+\t\tIBaseResource newSourceResource = resourceDefinition.newInstance();\n \n-\tprivate void handleLinkUpdateDSTU3(IBaseResource thePerson, IIdType theResourceId, CanonicalIdentityAssuranceLevel theCanonicalAssuranceLevel, EmpiTransactionContext theTransactionLogMessages) {\n-\t\tif (theCanonicalAssuranceLevel == null) {\n-\t\t\tourLog.warn(\"Refusing to update or add a link without an Assurance Level.\");\n-\t\t\treturn;\n-\t\t}\n+\t\t// hapi has 2 metamodels: for children and types\n+\t\tBaseRuntimeChildDefinition sourceResourceIdentifier = resourceDefinition.getChildByName(FIELD_NAME_IDENTIFIER);\n \n-\t\torg.hl7.fhir.dstu3.model.Person person = (org.hl7.fhir.dstu3.model.Person) thePerson;\n-\t\tif (!containsLinkTo(thePerson, theResourceId)) {\n-\t\t\tperson.addLink().setTarget(new org.hl7.fhir.dstu3.model.Reference(theResourceId)).setAssurance(theCanonicalAssuranceLevel.toDstu3());\n-\t\t\tlogLinkAddMessage(thePerson, theResourceId, theCanonicalAssuranceLevel, theTransactionLogMessages);\n-\t\t} else {\n-\t\t\tperson.getLink().stream()\n-\t\t\t\t.filter(link -> link.getTarget().getReference().equalsIgnoreCase(theResourceId.getValue()))\n-\t\t\t\t.findFirst()\n-\t\t\t\t.ifPresent(link -> {\n-\t\t\t\t\tlogLinkUpdateMessage(thePerson, theResourceId, theCanonicalAssuranceLevel, theTransactionLogMessages, link.getAssurance().toCode());\n-\t\t\t\t\tlink.setAssurance(theCanonicalAssuranceLevel.toDstu3());\n-\t\t\t\t});\n-\t\t}\n-\t}\n+\t\tcloneAllExternalEidsIntoNewSourceResource(sourceResourceIdentifier, theIncomingResource, newSourceResource);\n \n-\tprivate void logLinkAddMessage(IBaseResource thePerson, IIdType theResourceId, CanonicalIdentityAssuranceLevel theCanonicalAssuranceLevel, EmpiTransactionContext theEmpiTransactionContext) {\n-\t\ttheEmpiTransactionContext.addTransactionLogMessage(\"Creating new link from \" + (StringUtils.isBlank(thePerson.getIdElement().toUnqualifiedVersionless().getValue()) ? \"new Person\" : thePerson.getIdElement().toUnqualifiedVersionless()) + \" -> \" + theResourceId.toUnqualifiedVersionless() + \" with IdentityAssuranceLevel: \" + theCanonicalAssuranceLevel.name());\n-\t}\n+\t\taddHapiEidIfNoExternalEidIsPresent(newSourceResource, sourceResourceIdentifier, theIncomingResource);\n \n-\tprivate void logLinkUpdateMessage(IBaseResource thePerson, IIdType theResourceId, CanonicalIdentityAssuranceLevel canonicalAssuranceLevel, EmpiTransactionContext theEmpiTransactionContext, String theOriginalAssuranceLevel) {\n-\t\ttheEmpiTransactionContext.addTransactionLogMessage(\"Updating link from \" + thePerson.getIdElement().toUnqualifiedVersionless() + \" -> \" + theResourceId.toUnqualifiedVersionless() + \". Changing IdentityAssuranceLevel: \" + theOriginalAssuranceLevel + \" -> \" + canonicalAssuranceLevel.name());\n-\t}\n+\t\t//setGoldenResource(newSourceResource, resourceDefinition, true);\n \n-\tprivate void handleLinkUpdateR4(IBaseResource thePerson, IIdType theResourceId, CanonicalIdentityAssuranceLevel canonicalAssuranceLevel, EmpiTransactionContext theEmpiTransactionContext) {\n-\t\tif (canonicalAssuranceLevel == null) {\n-\t\t\tourLog.warn(\"Refusing to update or add a link without an Assurance Level.\");\n-\t\t\treturn;\n-\t\t}\n+\t\tEmpiUtil.setEmpiManaged(newSourceResource);\n+\t\tEmpiUtil.setGoldenResource(newSourceResource);\n \n-\t\tPerson person = (Person) thePerson;\n-\t\tif (!containsLinkTo(thePerson, theResourceId)) {\n-\t\t\tperson.addLink().setTarget(new Reference(theResourceId)).setAssurance(canonicalAssuranceLevel.toR4());\n-\t\t\tlogLinkAddMessage(thePerson, theResourceId, canonicalAssuranceLevel, theEmpiTransactionContext);\n-\t\t} else {\n-\t\t\tperson.getLink().stream()\n-\t\t\t\t.filter(link -> link.getTarget().getReference().equalsIgnoreCase(theResourceId.getValue()))\n-\t\t\t\t.findFirst()\n-\t\t\t\t.ifPresent(link -> {\n-\t\t\t\t\tlogLinkUpdateMessage(thePerson, theResourceId, canonicalAssuranceLevel, theEmpiTransactionContext, link.getAssurance().toCode());\n-\t\t\t\t\tlink.setAssurance(canonicalAssuranceLevel.toR4());\n-\t\t\t\t});\n-\t\t}\n+\t\treturn (T) newSourceResource;\n \t}\n \n-\n \t/**\n-\t * Removes a link from the given {@link IBaseResource} to the target {@link IIdType}.\n-\t * @param thePerson The person to remove the link from.\n-\t * @param theResourceId The target ID to remove.\n-\t * @param theEmpiTransactionContext\n+\t * If there are no external EIDs on the incoming resource, create a new HAPI EID on the new SourceResource.\n \t */\n-\tpublic void removeLink(IBaseResource thePerson, IIdType theResourceId, EmpiTransactionContext theEmpiTransactionContext) {\n-\t\tif (!containsLinkTo(thePerson, theResourceId)) {\n+\t//TODO GGG ask james if there is any way we can convert this canonical EID into a generic STU-agnostic IBase.\n+\tprivate <T extends IAnyResource> void addHapiEidIfNoExternalEidIsPresent(\n+\t\tIBaseResource theNewSourceResource, BaseRuntimeChildDefinition theSourceResourceIdentifier, IAnyResource theTargetResource) {\n+\n+\t\tList<CanonicalEID> eidsToApply = myEIDHelper.getExternalEid(theNewSourceResource);\n+\t\tif (!eidsToApply.isEmpty()) {\n \t\t\treturn;\n \t\t}\n-\t\ttheEmpiTransactionContext.addTransactionLogMessage(\"Removing PersonLinkComponent from \" + thePerson.getIdElement().toUnqualifiedVersionless() + \" -> \" + theResourceId.toUnqualifiedVersionless());\n-\t\tswitch (myFhirContext.getVersion().getVersion()) {\n-\t\t\tcase R4:\n-\t\t\t\tPerson person = (Person) thePerson;\n-\t\t\t\tList<Person.PersonLinkComponent> links = person.getLink();\n-\t\t\t\tlinks.removeIf(component -> component.hasTarget() && component.getTarget().getReference().equals(theResourceId.getValue()));\n-\t\t\t\tbreak;\n-\t\t\tcase DSTU3:\n-\t\t\t\torg.hl7.fhir.dstu3.model.Person personDstu3 = (org.hl7.fhir.dstu3.model.Person) thePerson;\n-\t\t\t\tpersonDstu3.getLink().removeIf(component -> component.hasTarget() && component.getTarget().getReference().equalsIgnoreCase(theResourceId.getValue()));\n-\t\t\t\tbreak;\n-\t\t\tdefault:\n-\t\t\t\tthrow new UnsupportedOperationException(\"Version not supported: \" + myFhirContext.getVersion().getVersion());\n-\t\t}\n+\n+\t\tCanonicalEID hapiEid = myEIDHelper.createHapiEid();\n+\t\ttheSourceResourceIdentifier.getMutator().addValue(theNewSourceResource, toId(hapiEid));\n+\n+\t\t// set identifier on the target resource\n+\t\tcloneEidIntoResource(theTargetResource, hapiEid);\n+\t}\n+\n+\tprivate void cloneEidIntoResource(IBaseResource theResourceToCloneInto, CanonicalEID theEid) {\n+\t\t// get a ref to the actual ID Field\n+\t\tRuntimeResourceDefinition resourceDefinition = myFhirContext.getResourceDefinition(theResourceToCloneInto);\n+\t\t// hapi has 2 metamodels: for children and types\n+\t\tBaseRuntimeChildDefinition resourceIdentifier = resourceDefinition.getChildByName(FIELD_NAME_IDENTIFIER);\n+\t\tcloneEidIntoResource(resourceIdentifier, toId(theEid), theResourceToCloneInto);\n \t}\n \n \t/**\n-\t * Create a Person from a given patient. This will carry over the Patient's EID if it exists. If it does not exist,\n-\t * a randomly generated UUID EID will be created.\n-\t *\n-\t * @param theSourceResource The Patient that will be used as the starting point for the person.\n-\t * @return the Person that is created.\n+\t * Given an Child Definition of `identifier`, a R4/DSTU3 EID Identifier, and a new resource, clone the EID into that resources' identifier list.\n \t */\n-\tpublic IAnyResource createPersonFromEmpiTarget(IAnyResource theSourceResource) {\n-\t\tList<CanonicalEID> eidsToApply = myEIDHelper.getExternalEid(theSourceResource);\n-\t\tif (eidsToApply.isEmpty()) {\n-\t\t\teidsToApply.add(myEIDHelper.createHapiEid());\n-\t\t}\n-\t\tswitch (myFhirContext.getVersion().getVersion()) {\n-\t\t\tcase R4:\n-\t\t\t\tPerson personR4 = new Person();\n+\tprivate void cloneEidIntoResource(BaseRuntimeChildDefinition theIdentifierDefinition, IBase theEid, IBase theResourceToCloneEidInto) {\n+\t\t// FHIR choice types - fields within fhir where we have a choice of ids\n+\t\tBaseRuntimeElementCompositeDefinition<?> childIdentifier = (BaseRuntimeElementCompositeDefinition<?>) theIdentifierDefinition.getChildByName(FIELD_NAME_IDENTIFIER);\n+\t\tIBase resourceNewIdentifier = childIdentifier.newInstance();\n \n-\t\t\t\tpersonR4.setActive(true);\n-\t\t\t\teidsToApply.forEach(eid -> personR4.addIdentifier(eid.toR4()));\n-\t\t\t\tpersonR4.getMeta().addTag((Coding) buildEmpiManagedTag());\n-\t\t\t\tcopyEmpiTargetDataIntoPerson(theSourceResource, personR4, true);\n-\t\t\t\treturn personR4;\n-\t\t\tcase DSTU3:\n-\t\t\t\torg.hl7.fhir.dstu3.model.Person personDstu3 = new org.hl7.fhir.dstu3.model.Person();\n-\t\t\t\tpersonDstu3.setActive(true);\n-\t\t\t\teidsToApply.forEach(eid -> personDstu3.addIdentifier(eid.toDSTU3()));\n-\t\t\t\tpersonDstu3.getMeta().addTag((org.hl7.fhir.dstu3.model.Coding) buildEmpiManagedTag());\n-\t\t\t\tcopyEmpiTargetDataIntoPerson(theSourceResource, personDstu3, true);\n-\t\t\t\treturn personDstu3;\n-\t\t\tdefault:\n-\t\t\t\tthrow new UnsupportedOperationException(\"Version not supported: \" + myFhirContext.getVersion().getVersion());\n-\t\t}\n+\t\tFhirTerser terser = myFhirContext.newTerser();\n+\t\tterser.cloneInto(theEid, resourceNewIdentifier, true);\n+\t\ttheIdentifierDefinition.getMutator().addValue(theResourceToCloneEidInto, resourceNewIdentifier);\n \t}\n \n \t/**\n-\t * This will copy over all attributes that are copiable from Patient/Practitioner to Person.\n-\t *\n-\t * @param theBaseResource The incoming {@link Patient} or {@link Practitioner} who's data we want to copy into Person.\n-\t * @param thePerson       The incoming {@link Person} who needs to have their data updated.\n-\t * @param theAllowOverwriting If enabled, will overwrite existing values on the person. Otherwise, will set them only if they are currently empty/null.\n+\t * Clones specified composite field (collection). Composite field values must confirm to the collections\n+\t * contract.\n \t *\n+\t * @param theFrom Resource to clone the specified filed from\n+\t * @param theTo Resource to clone the specified filed to\n+\t * @param field Field name to be copied\n \t */\n-\tprivate void copyEmpiTargetDataIntoPerson(IBaseResource theBaseResource, IBaseResource thePerson, Boolean theAllowOverwriting) {\n-\t\tswitch (myFhirContext.getVersion().getVersion()) {\n-\t\t\tcase R4:\n-\t\t\t\tcopyR4TargetInformation(theBaseResource, thePerson, theAllowOverwriting);\n-\t\t\t\tbreak;\n-\t\t\tcase DSTU3:\n-\t\t\t\tcopyDSTU3TargetInformation(theBaseResource, thePerson, theAllowOverwriting);\n-\t\t\t\tbreak;\n-\t\t\tdefault:\n-\t\t\t\tthrow new UnsupportedOperationException(\"Version not supported: \" + myFhirContext.getVersion().getVersion());\n+\tprivate void cloneCompositeField(IBaseResource theFrom, IBaseResource theTo, String field) {\n+\t\tFhirTerser terser = myFhirContext.newTerser();\n+\n+\t\tRuntimeResourceDefinition definition = myFhirContext.getResourceDefinition(theFrom);\n+\t\tBaseRuntimeChildDefinition childDefinition = definition.getChildByName(field);\n+\n+\t\tIFhirPath fhirPath = myFhirContext.newFhirPath();\n+\t\tList<IBase> theFromFieldValues = childDefinition.getAccessor().getValues(theFrom);\n+\t\tList<IBase> theToFieldValues = childDefinition.getAccessor().getValues(theTo);\n+\n+\t\tfor (IBase theFromFieldValue: theFromFieldValues) {\n+\t\t\tif (contains(theFromFieldValue, theToFieldValues)) {\n+\t\t\t\tcontinue;\n+\t\t\t}\n+\n+\t\t\tBaseRuntimeElementCompositeDefinition<?> compositeDefinition = (BaseRuntimeElementCompositeDefinition<?>) childDefinition.getChildByName(field);\n+\t\t\tIBase newFieldValue = compositeDefinition.newInstance();\n+\t\t\tterser.cloneInto(theFromFieldValue, newFieldValue, true);\n+\n+\t\t\ttheToFieldValues.add(newFieldValue);\n \t\t}\n \t}\n \n-\tprivate void copyR4TargetInformation(IBaseResource theBaseResource, IBaseResource thePerson, boolean theAllowOverwriting) {\n-\t\tPerson person = (Person) thePerson;\n-\t\tswitch (myFhirContext.getResourceType(theBaseResource)) {\n-\t\t\tcase \"Patient\":\n-\t\t\t\tPatient patient = (Patient) theBaseResource;\n-\t\t\t\tif (theAllowOverwriting || person.getName().isEmpty()) {\n-\t\t\t\t\tperson.setName(patient.getName());\n-\t\t\t\t}\n-\t\t\t\tif (theAllowOverwriting || person.getAddress().isEmpty()) {\n-\t\t\t\t\tperson.setAddress(patient.getAddress());\n-\t\t\t\t}\n-\t\t\t\tif (theAllowOverwriting || person.getTelecom().isEmpty()) {\n-\t\t\t\t\tperson.setTelecom(patient.getTelecom());\n-\t\t\t\t}\n-\t\t\t\tif (theAllowOverwriting || person.getBirthDate() == null) {\n-\t\t\t\t\tperson.setBirthDate(patient.getBirthDate());\n-\t\t\t\t}\n-\t\t\t\tif (theAllowOverwriting || person.getGender() == null) {\n-\t\t\t\t\tperson.setGender(patient.getGender());\n-\t\t\t\t}\n-\t\t\t\tif (theAllowOverwriting || person.getPhoto().isEmpty()) {\n-\t\t\t\t\tperson.setPhoto(patient.getPhotoFirstRep());\n-\t\t\t\t}\n-\t\t\t\tbreak;\n-\t\t\tcase \"Practitioner\":\n-\t\t\t\tPractitioner practitioner = (Practitioner) theBaseResource;\n-\t\t\t\tif (theAllowOverwriting || person.getName().isEmpty()) {\n-\t\t\t\t\tperson.setName(practitioner.getName());\n-\t\t\t\t}\n-\t\t\t\tif (theAllowOverwriting || person.getAddress().isEmpty()) {\n-\t\t\t\t\tperson.setAddress(practitioner.getAddress());\n-\t\t\t\t}\n-\t\t\t\tif (theAllowOverwriting || person.getTelecom().isEmpty()) {\n-\t\t\t\t\tperson.setTelecom(practitioner.getTelecom());\n-\t\t\t\t}\n-\t\t\t\tif (theAllowOverwriting || person.getBirthDate() == null) {\n-\t\t\t\t\tperson.setBirthDate(practitioner.getBirthDate());\n-\t\t\t\t}\n-\t\t\t\tif (theAllowOverwriting || person.getGender() == null) {\n-\t\t\t\t\tperson.setGender(practitioner.getGender());\n-\t\t\t\t}\n-\t\t\t\tif (theAllowOverwriting || person.getPhoto().isEmpty()) {\n-\t\t\t\t\tperson.setPhoto(practitioner.getPhotoFirstRep());\n-\t\t\t\t}\n-\t\t\t\tbreak;\n-\t\t\tdefault:\n-\t\t\t\tthrow new UnsupportedOperationException(\"EMPI targets are limited to Practitioner/Patient. This is a : \" + myFhirContext.getResourceType(theBaseResource));\n-\t\t}\n+\tprivate boolean contains(IBase theItem, List<IBase> theItems) {\n+\t\tPrimitiveTypeComparingPredicate predicate = new PrimitiveTypeComparingPredicate();\n+\t\treturn theItems.stream().filter(i -> {\n+\t\t\treturn predicate.test(i, theItem);\n+\t\t}).findFirst().isPresent();\n \t}\n \n-\tprivate void copyDSTU3TargetInformation(IBaseResource theBaseResource, IBaseResource thePerson, boolean theAllowOverwriting) {\n-\t\torg.hl7.fhir.dstu3.model.Person person = (org.hl7.fhir.dstu3.model.Person) thePerson;\n-\t\tswitch (myFhirContext.getResourceType(theBaseResource)) {\n-\t\t\tcase \"Patient\":\n-\t\t\t\torg.hl7.fhir.dstu3.model.Patient patient = (org.hl7.fhir.dstu3.model.Patient) theBaseResource;\n+\tprivate void cloneAllExternalEidsIntoNewSourceResource(BaseRuntimeChildDefinition theSourceResourceIdentifier, IBase theSourceResource, IBase theNewSourceResource) {\n+\t\t// FHIR choice types - fields within fhir where we have a choice of ids\n+\t\tIFhirPath fhirPath = myFhirContext.newFhirPath();\n+\t\tList<IBase> sourceResourceIdentifiers = theSourceResourceIdentifier.getAccessor().getValues(theSourceResource);\n \n-\t\t\t\tif (theAllowOverwriting || person.getName().isEmpty()) {\n-\t\t\t\t\tperson.setName(patient.getName());\n-\t\t\t\t}\n-\t\t\t\tif (theAllowOverwriting || person.getAddress().isEmpty()) {\n-\t\t\t\t\tperson.setAddress(patient.getAddress());\n-\t\t\t\t}\n-\t\t\t\tif (theAllowOverwriting || person.getTelecom().isEmpty()) {\n-\t\t\t\t\tperson.setTelecom(patient.getTelecom());\n-\t\t\t\t}\n-\t\t\t\tif (theAllowOverwriting || person.getBirthDate() == null ) {\n-\t\t\t\t\tperson.setBirthDate(patient.getBirthDate());\n-\t\t\t\t}\n-\t\t\t\tif (theAllowOverwriting || person.getGender() == null ) {\n-\t\t\t\t\tperson.setGender(patient.getGender());\n+\t\tfor (IBase base : sourceResourceIdentifiers) {\n+\t\t\tOptional<IPrimitiveType> system = fhirPath.evaluateFirst(base, \"system\", IPrimitiveType.class);\n+\t\t\tif (system.isPresent()) {\n+\t\t\t\tString empiSystem = myEmpiConfig.getEmpiRules().getEnterpriseEIDSystem();\n+\t\t\t\tString baseSystem = system.get().getValueAsString();\n+\t\t\t\tif (Objects.equals(baseSystem, empiSystem)) {\n+\t\t\t\t\tcloneEidIntoResource(theSourceResourceIdentifier, base, theNewSourceResource);\n+\t\t\t\t} else if (ourLog.isDebugEnabled()) {\n+\t\t\t\t\tourLog.debug(String.format(\"System %s differs from system in the EMPI rules %s\", baseSystem, empiSystem));\n \t\t\t\t}\n-\t\t\t\tif (theAllowOverwriting || person.getPhoto().isEmpty()) {\n-\t\t\t\t\tperson.setPhoto(patient.getPhotoFirstRep());\n-\t\t\t\t}\n-\t\t\t\tbreak;\n-\t\t\tcase \"Practitioner\":\n-\t\t\t\torg.hl7.fhir.dstu3.model.Practitioner practitioner = (org.hl7.fhir.dstu3.model.Practitioner) theBaseResource;\n-\t\t\t\tif (theAllowOverwriting || person.getName().isEmpty()) {\n-\t\t\t\t\tperson.setName(practitioner.getName());\n-\t\t\t\t}\n-\t\t\t\tif (theAllowOverwriting || person.getAddress().isEmpty()) {\n-\t\t\t\t\tperson.setAddress(practitioner.getAddress());\n-\t\t\t\t}\n-\t\t\t\tif (theAllowOverwriting || person.getTelecom().isEmpty()) {\n-\t\t\t\t\tperson.setTelecom(practitioner.getTelecom());\n-\t\t\t\t}\n-\t\t\t\tif (theAllowOverwriting || person.getBirthDate() == null) {\n-\t\t\t\t\tperson.setBirthDate(practitioner.getBirthDate());\n-\t\t\t\t}\n-\t\t\t\tif (theAllowOverwriting || person.getGender() == null) {\n-\t\t\t\t\tperson.setGender(practitioner.getGender());\n-\t\t\t\t}\n-\t\t\t\tif (theAllowOverwriting || person.getPhoto().isEmpty()) {\n-\t\t\t\t\tperson.setPhoto(practitioner.getPhotoFirstRep());\n-\t\t\t\t}\n-\t\t\t\tbreak;\n-\t\t\tdefault:\n-\t\t\t\tthrow new UnsupportedOperationException(\"EMPI targets are limited to Practitioner/Patient. This is a : \" + myFhirContext.getResourceType(theBaseResource));\n+\t\t\t} else {\n+\t\t\t\tourLog.debug(\"System is missing, skipping\");\n+\t\t\t}\n \t\t}\n \t}\n \n-\tprivate IBaseCoding buildEmpiManagedTag() {\n-\t\tswitch (myFhirContext.getVersion().getVersion()) {\n-\t\t\tcase R4:\n-\t\t\t\tCoding empiManagedCoding = new Coding();\n-\t\t\t\tempiManagedCoding.setSystem(EmpiConstants.SYSTEM_EMPI_MANAGED);\n-\t\t\t\tempiManagedCoding.setCode(EmpiConstants.CODE_HAPI_EMPI_MANAGED);\n-\t\t\t\tempiManagedCoding.setDisplay(EmpiConstants.DISPLAY_HAPI_EMPI_MANAGED);\n-\t\t\t\treturn empiManagedCoding;\n-\t\t\tcase DSTU3:\n-\t\t\t\torg.hl7.fhir.dstu3.model.Coding empiManagedCodingDstu3 = new org.hl7.fhir.dstu3.model.Coding();\n-\t\t\t\tempiManagedCodingDstu3.setSystem(EmpiConstants.SYSTEM_EMPI_MANAGED);\n-\t\t\t\tempiManagedCodingDstu3.setCode(EmpiConstants.CODE_HAPI_EMPI_MANAGED);\n-\t\t\t\tempiManagedCodingDstu3.setDisplay(EmpiConstants.DISPLAY_HAPI_EMPI_MANAGED);\n-\t\t\t\treturn empiManagedCodingDstu3;\n-\t\t\tdefault:\n-\t\t\t\tthrow new UnsupportedOperationException(\"Version not supported: \" + myFhirContext.getVersion().getVersion());\n-\n+\tprivate void validateContextSupported() {\n+\t\tFhirVersionEnum fhirVersion = myFhirContext.getVersion().getVersion();\n+\t\tif (fhirVersion == R4 || fhirVersion == DSTU3) {\n+\t\t\treturn;\n \t\t}\n+\t\tthrow new UnsupportedOperationException(\"Version not supported: \" + myFhirContext.getVersion().getVersion());\n \t}\n \n \t/**\n \t * Update a Person's EID based on the incoming target resource. If the incoming resource has an external EID, it is applied\n \t * to the Person, unless that person already has an external EID which does not match, in which case throw {@link IllegalArgumentException}\n-\t *\n+\t * <p>\n \t * If running in multiple EID mode, then incoming EIDs are simply added to the Person without checking for matches.\n \t *\n-\t * @param thePerson     The person to update the external EID on.\n-\t * @param theEmpiTarget The target we will retrieve the external EID from.\n+\t * @param theSourceResource The person to update the external EID on.\n+\t * @param theTargetResource The target we will retrieve the external EID from.\n \t * @return the modified {@link IBaseResource} representing the person.\n \t */\n-\tpublic IAnyResource updatePersonExternalEidFromEmpiTarget(IAnyResource thePerson, IAnyResource theEmpiTarget, EmpiTransactionContext theEmpiTransactionContext) {\n+\tpublic IAnyResource updateSourceResourceExternalEidFromTargetResource(IAnyResource theSourceResource, IAnyResource", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 494}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDQ1MjY1OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-server-empi/src/main/java/ca/uhn/fhir/empi/util/PersonHelper.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxOTozMTowNVrOH1FzDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxOTozMTowNVrOH1FzDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQzMTU2Nw==", "bodyText": "Rename to ResourceHelper or GoldenResourceHelper?", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525431567", "createdAt": "2020-11-17T19:31:05Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-server-empi/src/main/java/ca/uhn/fhir/empi/util/PersonHelper.java", "diffHunk": "@@ -20,51 +20,60 @@\n  * #L%\n  */\n \n+import ca.uhn.fhir.context.BaseRuntimeChildDefinition;\n+import ca.uhn.fhir.context.BaseRuntimeElementCompositeDefinition;\n import ca.uhn.fhir.context.FhirContext;\n-import ca.uhn.fhir.empi.api.EmpiConstants;\n+import ca.uhn.fhir.context.FhirVersionEnum;\n+import ca.uhn.fhir.context.RuntimeResourceDefinition;\n+import ca.uhn.fhir.empi.api.IEmpiLinkQuerySvc;\n import ca.uhn.fhir.empi.api.IEmpiSettings;\n import ca.uhn.fhir.empi.log.Logs;\n import ca.uhn.fhir.empi.model.CanonicalEID;\n import ca.uhn.fhir.empi.model.CanonicalIdentityAssuranceLevel;\n-import ca.uhn.fhir.empi.model.EmpiTransactionContext;\n-import org.apache.commons.lang3.StringUtils;\n+import ca.uhn.fhir.empi.model.MdmTransactionContext;\n+import ca.uhn.fhir.fhirpath.IFhirPath;\n+import ca.uhn.fhir.util.FhirTerser;\n import org.hl7.fhir.instance.model.api.IAnyResource;\n+import org.hl7.fhir.instance.model.api.IBase;\n import org.hl7.fhir.instance.model.api.IBaseBackboneElement;\n-import org.hl7.fhir.instance.model.api.IBaseCoding;\n-import org.hl7.fhir.instance.model.api.IBaseReference;\n import org.hl7.fhir.instance.model.api.IBaseResource;\n import org.hl7.fhir.instance.model.api.IIdType;\n+import org.hl7.fhir.instance.model.api.IPrimitiveType;\n import org.hl7.fhir.r4.model.Address;\n-import org.hl7.fhir.r4.model.Coding;\n+import org.hl7.fhir.r4.model.BooleanType;\n import org.hl7.fhir.r4.model.ContactPoint;\n import org.hl7.fhir.r4.model.HumanName;\n import org.hl7.fhir.r4.model.Identifier;\n-import org.hl7.fhir.r4.model.Patient;\n import org.hl7.fhir.r4.model.Person;\n-import org.hl7.fhir.r4.model.Practitioner;\n import org.hl7.fhir.r4.model.Reference;\n import org.slf4j.Logger;\n import org.springframework.beans.factory.annotation.Autowired;\n import org.springframework.stereotype.Service;\n \n-import javax.annotation.Nonnull;\n import java.util.ArrayList;\n import java.util.List;\n+import java.util.Objects;\n import java.util.Optional;\n import java.util.function.BiPredicate;\n import java.util.function.Function;\n import java.util.stream.Collectors;\n-import java.util.stream.Stream;\n+\n+import static ca.uhn.fhir.context.FhirVersionEnum.DSTU3;\n+import static ca.uhn.fhir.context.FhirVersionEnum.R4;\n \n @Service\n public class PersonHelper {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDUyMDMxOnYy", "diffSide": "RIGHT", "path": "hapi-fhir-server-empi/src/main/java/ca/uhn/fhir/empi/util/PersonHelper.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxOTo0MjoxMVrOH1Ggqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxOTo0MjoxMVrOH1Ggqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQ0MzI0Mw==", "bodyText": "rename person to golden resource", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525443243", "createdAt": "2020-11-17T19:42:11Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-server-empi/src/main/java/ca/uhn/fhir/empi/util/PersonHelper.java", "diffHunk": "@@ -458,26 +355,20 @@ private void addIdentifierIfAbsent(org.hl7.fhir.dstu3.model.Person thePerson, or\n \t\t}\n \t}\n \n-\tprivate void addIdentifierIfAbsent(Person thePerson, Identifier theIdentifier) {\n-\t\tOptional<Identifier> first = thePerson.getIdentifier().stream().filter(identifier -> identifier.getSystem().equals(theIdentifier.getSystem())).filter(identifier -> identifier.getValue().equals(theIdentifier.getValue())).findFirst();\n-\t\tif (first.isPresent()) {\n-\t\t\treturn;\n-\t\t} else {\n-\t\t\tthePerson.addIdentifier(theIdentifier);\n-\t\t}\n-\t}\n+\tpublic void mergeFields(IBaseResource theFromPerson, IBaseResource theToPerson) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 655}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDUyMzIwOnYy", "diffSide": "RIGHT", "path": "hapi-fhir-server-empi/src/main/java/ca/uhn/fhir/empi/util/PersonHelper.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxOTo0MjozNlrOH1Giwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxOTo0MjozNlrOH1Giwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQ0Mzc3OA==", "bodyText": "This can be removed?", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525443778", "createdAt": "2020-11-17T19:42:36Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-server-empi/src/main/java/ca/uhn/fhir/empi/util/PersonHelper.java", "diffHunk": "@@ -585,75 +479,35 @@ public void setLinks(IAnyResource thePersonResource, List<IBaseBackboneElement>\n \t}\n \n \tprivate void setLinksDstu3(IAnyResource thePersonResource, List<IBaseBackboneElement> theLinks) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 715}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDU1ODAwOnYy", "diffSide": "RIGHT", "path": "hapi-fhir-server-empi/src/test/java/ca/uhn/fhir/empi/svc/PersonHelperDSTU3Test.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxOTo0NzoyNVrOH1G6mw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxOTo0NzoyNVrOH1G6mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQ0OTg4Mw==", "bodyText": "This test can be removed - linking is done via EmpiLink class", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525449883", "createdAt": "2020-11-17T19:47:25Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-server-empi/src/test/java/ca/uhn/fhir/empi/svc/PersonHelperDSTU3Test.java", "diffHunk": "@@ -33,52 +35,55 @@ public void testGetLinks() {\n \t\tperson.addLink().setTarget(new Reference(PATIENT_1));\n \t\tperson.addLink().setTarget(new Reference(PATIENT_2));\n \n-\t\t{\n-\t\t\tList<IIdType> links = MY_PERSON_HELPER.getLinkIds(person).collect(Collectors.toList());\n-\t\t\tassertEquals(2, links.size());\n-\t\t\tassertEquals(PATIENT_1, links.get(0).getValue());\n-\t\t\tassertEquals(PATIENT_2, links.get(1).getValue());\n-\t\t\tassertTrue(MY_PERSON_HELPER.containsLinkTo(person, new IdDt(PATIENT_1)));\n-\t\t\tassertTrue(MY_PERSON_HELPER.containsLinkTo(person, new IdDt(PATIENT_2)));\n-\t\t\tassertFalse(MY_PERSON_HELPER.containsLinkTo(person, new IdDt(PATIENT_BAD)));\n-\t\t}\n-\n-\t\t{\n-\t\t\tMY_PERSON_HELPER.removeLink(person, new IdDt(PATIENT_1), createDummyContext());\n-\t\t\tList<IIdType> links = MY_PERSON_HELPER.getLinkIds(person).collect(Collectors.toList());\n-\t\t\tassertEquals(1, links.size());\n-\t\t\tassertEquals(PATIENT_2, links.get(0).getValue());\n+\t\t// TODO NG - check if we need similar functionality in JPA DAO", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDU1OTk5OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-server-empi/src/test/java/ca/uhn/fhir/empi/svc/PersonHelperR4Test.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxOTo0Nzo0NFrOH1G8BQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxOTo0Nzo0NFrOH1G8BQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQ1MDI0NQ==", "bodyText": "Obsolete test", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525450245", "createdAt": "2020-11-17T19:47:44Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-server-empi/src/test/java/ca/uhn/fhir/empi/svc/PersonHelperR4Test.java", "diffHunk": "@@ -30,52 +30,61 @@\n \n \t@Test\n \tpublic void testGetLinks() {\n+\t\t// TODO NG - Revisit this code checking if we need to keep it - if yes - push to the JPA level, delete otherwise", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NDU2NTU0OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-server/src/main/java/ca/uhn/fhir/rest/server/provider/ProviderConstants.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxOTo0ODozOFrOH1G_2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxOTo0ODozOFrOH1G_2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQ1MTIyNg==", "bodyText": "Rename to MDM", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r525451226", "createdAt": "2020-11-17T19:48:38Z", "author": {"login": "nvg-smile"}, "path": "hapi-fhir-server/src/main/java/ca/uhn/fhir/rest/server/provider/ProviderConstants.java", "diffHunk": "@@ -62,30 +62,35 @@\n \t * EMPI Operations\n \t */\n \tpublic static final String EMPI_MATCH = \"$match\";\n-\tpublic static final String EMPI_MATCH_RESOURCE = \"resource\";\n+\t//TODO GGG MDM: implement a server-level MDM match to complement the FHIR-spec $match for /Patient\n+\tpublic static final String MDM_MATCH = \"$mdm-match\";\n+\tpublic static final String MDM_MATCH_RESOURCE = \"resource\";\n+\tpublic static final String MDM_RESOURCE_TYPE = \"resourceType\";\n \n-\tpublic static final String EMPI_MERGE_PERSONS = \"$empi-merge-persons\";\n-\tpublic static final String EMPI_MERGE_PERSONS_FROM_PERSON_ID = \"fromPersonId\";\n-\tpublic static final String EMPI_MERGE_PERSONS_TO_PERSON_ID = \"toPersonId\";\n+\t//TODO GGG MDM: rename all these vars\n+\tpublic static final String MDM_MERGE_GOLDEN_RESOURCES = \"$mdm-merge-golden-resources\";\n+\tpublic static final String MDM_MERGE_GR_FROM_GOLDEN_RESOURCE_ID = \"fromGoldenResourceId\";\n+\tpublic static final String MDM_MERGE_GR_TO_GOLDEN_RESOURCE_ID = \"toGoldenResourceId\";\n \n-\tpublic static final String EMPI_UPDATE_LINK = \"$empi-update-link\";\n-\tpublic static final String EMPI_UPDATE_LINK_PERSON_ID = \"personId\";\n-\tpublic static final String EMPI_UPDATE_LINK_TARGET_ID = \"targetId\";\n-\tpublic static final String EMPI_UPDATE_LINK_MATCH_RESULT = \"matchResult\";\n+\tpublic static final String MDM_UPDATE_LINK = \"$mdm-update-link\";\n+\tpublic static final String MDM_UPDATE_LINK_GOLDEN_RESOURCE_ID = \"goldenResourceId\";\n+\tpublic static final String MDM_UPDATE_LINK_RESOURCE_ID = \"resourceId\";\n+\tpublic static final String MDM_UPDATE_LINK_MATCH_RESULT = \"matchResult\";\n \n-\tpublic static final String EMPI_QUERY_LINKS = \"$empi-query-links\";\n-\tpublic static final String EMPI_QUERY_LINKS_PERSON_ID = \"personId\";\n-\tpublic static final String EMPI_QUERY_LINKS_TARGET_ID = \"targetId\";\n+\tpublic static final String MDM_QUERY_LINKS = \"$mdm-query-links\";\n+\tpublic static final String MDM_QUERY_LINKS_GOLDEN_RESOURCE_ID = \"goldenResourceId\";\n+\tpublic static final String MDM_QUERY_LINKS_RESOURCE_ID = \"resourceId\";\n \tpublic static final String EMPI_QUERY_LINKS_MATCH_RESULT = \"matchResult\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "805d5b1d6c1c800295cbe99af777b53f6290dd71"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3NDgwODE1OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-docs/src/main/resources/ca/uhn/hapi/fhir/changelog/5_3_0/2177-remove-Person-references-to-support-MDM.yaml", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNTo0ODowMlrOIAtOJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNTo0ODowMlrOIAtOJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYxMTgxNQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            title: \"Refactoring of the Enterprise Master Patient Index solution to a Master Data Management solution. The new MDM solution supports other FHIR resources where EMPI only allowed Person resource to be used. For example, if MDM is occurring on a patient, we will create a new Patient, and tag that patient as a Golden Record. This means that several things have changed:\n          \n          \n            \n            title: \"Redesigning the Enterprise Master Patient Index solution to a Master Data Management solution. The new MDM solution supports other FHIR resources where EMPI only allowed Person resource to be used. For example, if MDM is occurring on a patient, we will create a new Patient, and tag that patient as a Golden Record. This means that several things have changed:", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r537611815", "createdAt": "2020-12-07T15:48:02Z", "author": {"login": "fil512"}, "path": "hapi-fhir-docs/src/main/resources/ca/uhn/hapi/fhir/changelog/5_3_0/2177-remove-Person-references-to-support-MDM.yaml", "diffHunk": "@@ -0,0 +1,19 @@\n+---\n+type: add\n+issue: 2177\n+title: \"Refactoring of the Enterprise Master Patient Index solution to a Master Data Management solution. The new MDM solution supports other FHIR resources where EMPI only allowed Person resource to be used. For example, if MDM is occurring on a patient, we will create a new Patient, and tag that patient as a Golden Record. This means that several things have changed:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51b3fb05250cbd209c0aa60555285fa8e83b4ba3"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3NTQwNTQ3OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-docs/src/main/resources/ca/uhn/hapi/fhir/docs/server_jpa_mdm/mdm.md", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNzo0NTo0N1rOIAyvHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNzo0NTo0N1rOIAyvHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzcwMjE3Mw==", "bodyText": "s/Golden resource/Golden Resource/", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r537702173", "createdAt": "2020-12-07T17:45:47Z", "author": {"login": "fil512"}, "path": "hapi-fhir-docs/src/main/resources/ca/uhn/hapi/fhir/docs/server_jpa_mdm/mdm.md", "diffHunk": "@@ -0,0 +1,35 @@\n+# MDM Getting Started \n+ \n+## Introduction \n+ \n+A Master Data Management (MDM) module allows for links to be created and maintained among FHIR resources. These links indicate the fact that different FHIR resources are known or believed to refer to the same actual (real world) resource. The links are created and updated using different combinations of automatic and manual linking. \n+ \n+The real-world resource is referred to as the Golden Resource in this context. The resource believed to be a duplicate is said to be a target resource.\n+\n+## Working Example\n+\n+A complete working example of HAPI MDM can be found in the [JPA Server Starter](/hapi-fhir/docs/server_jpa/get_started.html) project. You may wish to browse its source to see how it is set up.\n+\n+## Overview\n+\n+To get up and running with HAPI MDM, either enable it using the `hapi.properties` file in the JPA Server Starter, or follow the instructions below to (enable it in HAPI FHIR directly)[#mdm-settings].  \n+\n+Once MDM is enabled, the next thing you will want to do is configure your [MDM Rules](/hapi-fhir/docs/server_jpa_mdm/mdm_rules.html)\n+\n+HAPI MDM watches for incoming target resources and automatically links them to the appropriate Golden resources based on these rules.  For example, if the rules indicate that any two patients with the same SSN, birthdate and first and last name are the same patients, then two different Patient resources with matching values for these attributes will automatically be linked to the same Golden Patient resource. If no existing resources match the incoming Patient, then a new Golden Patient resource will be created and linked to the incoming Patient.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5f7f2df14f732c131b360087deaa0b4827b05b5"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3NTQwOTE3OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-docs/src/main/resources/ca/uhn/hapi/fhir/docs/server_jpa_mdm/mdm.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNzo0NjozNlrOIAyxWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNzo0NjozNlrOIAyxWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzcwMjc0NQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            HAPI MDM watches for incoming target resources and automatically links them to the appropriate Golden resources based on these rules.  For example, if the rules indicate that any two patients with the same SSN, birthdate and first and last name are the same patients, then two different Patient resources with matching values for these attributes will automatically be linked to the same Golden Patient resource. If no existing resources match the incoming Patient, then a new Golden Patient resource will be created and linked to the incoming Patient.\n          \n          \n            \n            HAPI MDM watches for incoming target resources and automatically links them to the appropriate Golden Resources based on these rules.  For example, if the rules indicate that any two patients with the same SSN, birthdate and first and last name are the same patient, then two different Patient resources with matching values for these attributes will automatically be linked to the same Golden Patient resource. If no existing resources match the incoming Patient, then a new Golden Patient resource will be created and linked to the incoming Patient.", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r537702745", "createdAt": "2020-12-07T17:46:36Z", "author": {"login": "fil512"}, "path": "hapi-fhir-docs/src/main/resources/ca/uhn/hapi/fhir/docs/server_jpa_mdm/mdm.md", "diffHunk": "@@ -0,0 +1,35 @@\n+# MDM Getting Started \n+ \n+## Introduction \n+ \n+A Master Data Management (MDM) module allows for links to be created and maintained among FHIR resources. These links indicate the fact that different FHIR resources are known or believed to refer to the same actual (real world) resource. The links are created and updated using different combinations of automatic and manual linking. \n+ \n+The real-world resource is referred to as the Golden Resource in this context. The resource believed to be a duplicate is said to be a target resource.\n+\n+## Working Example\n+\n+A complete working example of HAPI MDM can be found in the [JPA Server Starter](/hapi-fhir/docs/server_jpa/get_started.html) project. You may wish to browse its source to see how it is set up.\n+\n+## Overview\n+\n+To get up and running with HAPI MDM, either enable it using the `hapi.properties` file in the JPA Server Starter, or follow the instructions below to (enable it in HAPI FHIR directly)[#mdm-settings].  \n+\n+Once MDM is enabled, the next thing you will want to do is configure your [MDM Rules](/hapi-fhir/docs/server_jpa_mdm/mdm_rules.html)\n+\n+HAPI MDM watches for incoming target resources and automatically links them to the appropriate Golden resources based on these rules.  For example, if the rules indicate that any two patients with the same SSN, birthdate and first and last name are the same patients, then two different Patient resources with matching values for these attributes will automatically be linked to the same Golden Patient resource. If no existing resources match the incoming Patient, then a new Golden Patient resource will be created and linked to the incoming Patient.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5f7f2df14f732c131b360087deaa0b4827b05b5"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3NTQxMjMwOnYy", "diffSide": "RIGHT", "path": "hapi-fhir-docs/src/main/resources/ca/uhn/hapi/fhir/docs/server_jpa_mdm/mdm.md", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNzo0NzoxNVrOIAyzPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNzo0NzoxNVrOIAyzPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzcwMzIzMQ==", "bodyText": "Search the documentation for \"Person\".", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r537703231", "createdAt": "2020-12-07T17:47:15Z", "author": {"login": "fil512"}, "path": "hapi-fhir-docs/src/main/resources/ca/uhn/hapi/fhir/docs/server_jpa_mdm/mdm.md", "diffHunk": "@@ -0,0 +1,35 @@\n+# MDM Getting Started \n+ \n+## Introduction \n+ \n+A Master Data Management (MDM) module allows for links to be created and maintained among FHIR resources. These links indicate the fact that different FHIR resources are known or believed to refer to the same actual (real world) resource. The links are created and updated using different combinations of automatic and manual linking. \n+ \n+The real-world resource is referred to as the Golden Resource in this context. The resource believed to be a duplicate is said to be a target resource.\n+\n+## Working Example\n+\n+A complete working example of HAPI MDM can be found in the [JPA Server Starter](/hapi-fhir/docs/server_jpa/get_started.html) project. You may wish to browse its source to see how it is set up.\n+\n+## Overview\n+\n+To get up and running with HAPI MDM, either enable it using the `hapi.properties` file in the JPA Server Starter, or follow the instructions below to (enable it in HAPI FHIR directly)[#mdm-settings].  \n+\n+Once MDM is enabled, the next thing you will want to do is configure your [MDM Rules](/hapi-fhir/docs/server_jpa_mdm/mdm_rules.html)\n+\n+HAPI MDM watches for incoming target resources and automatically links them to the appropriate Golden resources based on these rules.  For example, if the rules indicate that any two patients with the same SSN, birthdate and first and last name are the same patients, then two different Patient resources with matching values for these attributes will automatically be linked to the same Golden Patient resource. If no existing resources match the incoming Patient, then a new Golden Patient resource will be created and linked to the incoming Patient.\n+\n+Based on how well two patients match, the MDM Rules may link the Patient to the Golden Patient as a MATCH or a \n+POSSIBLE_MATCH. In the case of a POSSIBLE_MATCH, a user will need to later use [MDM Operations](/hapi-fhir/docs/server_jpa_mdm/mdm_operations.html) to either confirm the link as a MATCH, or mark the link as a NO_MATCH in which case HAPI MDM will create a new Person for them.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5f7f2df14f732c131b360087deaa0b4827b05b5"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3NTQyOTM2OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-docs/src/main/resources/ca/uhn/hapi/fhir/docs/server_jpa_mdm/mdm_details.md", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNzo1MDo1OFrOIAy9Vw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNzo1MDo1OFrOIAy9Vw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzcwNTgxNQ==", "bodyText": "\"Source resource\" is now a better term than \"Target resource\".  We used \"Target\" before because of Person.link.target.  But I don't think it's relevant any more.", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r537705815", "createdAt": "2020-12-07T17:50:58Z", "author": {"login": "fil512"}, "path": "hapi-fhir-docs/src/main/resources/ca/uhn/hapi/fhir/docs/server_jpa_mdm/mdm_details.md", "diffHunk": "@@ -0,0 +1,92 @@\n+# MDM Implementation Details\n+\n+This section describes details of how MDM functionality is implemented in HAPI FHIR.\n+\n+## Resource linking in FHIR\n+\n+Because HAPI MDM is implemented on the HAPI JPA Server, it uses the FHIR model to represent links. The following illustration shows an example of how these links work.\n+\n+<a href=\"/hapi-fhir/docs/images/empi-links.svg\"><img src=\"/hapi-fhir/docs/images/empi-links.svg\" alt=\"MDM links\" style=\"margin-left: 15px; margin-bottom: 15px; width: 500px;\" /></a>\n+\n+There are several resources that are used:\n+\n+* Target resource - Represents the record in being matched. For example, it can be a Patient resource who receives healthcare services and that should be mapped to a master record.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5f7f2df14f732c131b360087deaa0b4827b05b5"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3NTQzOTcwOnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/entity/MdmLink.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNzo1MzowNFrOIAzDOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNzo1MzowNFrOIAzDOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzcwNzMyMw==", "bodyText": "I recommend renaming to: myNewGoldenResource", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r537707323", "createdAt": "2020-12-07T17:53:04Z", "author": {"login": "fil512"}, "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/entity/MdmLink.java", "diffHunk": "@@ -99,56 +107,67 @@\n \n \t/** This link created a new person **/\n \t@Column(name = \"NEW_PERSON\")\n-\tprivate Boolean myNewPerson;\n+\tprivate Boolean myHadToCreateNewResource;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5f7f2df14f732c131b360087deaa0b4827b05b5"}, "originalPosition": 64}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3NTQ0OTA1OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-mdm/src/main/java/ca/uhn/fhir/jpa/mdm/config/MdmLoader.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNzo1NTowOVrOIAzIzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNzo1NTowOVrOIAzIzA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzcwODc0OA==", "bodyText": "these can be removed", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r537708748", "createdAt": "2020-12-07T17:55:09Z", "author": {"login": "fil512"}, "path": "hapi-fhir-jpaserver-mdm/src/main/java/ca/uhn/fhir/jpa/mdm/config/MdmLoader.java", "diffHunk": "@@ -31,34 +31,35 @@\n import org.springframework.stereotype.Service;\n \n @Service\n-public class EmpiLoader {\n-\tprivate static final Logger ourLog = LoggerFactory.getLogger(EmpiLoader.class);\n+public class MdmLoader {\n+\tprivate static final Logger ourLog = LoggerFactory.getLogger(MdmLoader.class);\n \n \t@Autowired\n-\tIEmpiSettings myEmpiProperties;\n+\tIMdmSettings myMdmSettings;\n \t@Autowired\n-\tEmpiProviderLoader myEmpiProviderLoader;\n+\tMdmProviderLoader myMdmProviderLoader;\n \t@Autowired\n-\tEmpiSubscriptionLoader myEmpiSubscriptionLoader;\n+\tMdmSubscriptionLoader myMdmSubscriptionLoader;\n \t@Autowired\n-\tEmpiSearchParameterLoader myEmpiSearchParameterLoader;\n+\tMdmSearchParameterLoader myMdmSearchParameterLoader;\n \n \t@EventListener(classes = {ContextRefreshedEvent.class})\n \t// This @Order is here to ensure that MatchingQueueSubscriberLoader has initialized before we initialize this.\n-\t// Otherwise the EMPI subscriptions won't get loaded into the SubscriptionRegistry\n+\t// Otherwise the MDM subscriptions won't get loaded into the SubscriptionRegistry\n \t@Order\n \tpublic void updateSubscriptions() {\n-\t\tif (!myEmpiProperties.isEnabled()) {\n+\t\tif (!myMdmSettings.isEnabled()) {\n \t\t\treturn;\n \t\t}\n \n-\t\tmyEmpiProviderLoader.loadProvider();\n-\t\tourLog.info(\"EMPI provider registered\");\n+\t\tmyMdmProviderLoader.loadProvider();\n+\t\tourLog.info(\"MDM provider registered\");\n \n-\t\tmyEmpiSubscriptionLoader.daoUpdateEmpiSubscriptions();\n-\t\tourLog.info(\"EMPI subscriptions updated\");\n+\t\tmyMdmSubscriptionLoader.daoUpdateMdmSubscriptions();\n+\t\tourLog.info(\"MDM subscriptions updated\");\n \n-\t\tmyEmpiSearchParameterLoader.daoUpdateEmpiSearchParameters();\n-\t\tourLog.info(\"EMPI search parameters updated\");\n+\t\t//TODO GGG MDM: Do we need these search parameters, or equivalent, anymore? Don't think so... ask @fil512\n+\t\tmyMdmSearchParameterLoader.daoUpdateMdmSearchParameters();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5f7f2df14f732c131b360087deaa0b4827b05b5"}, "originalPosition": 68}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3NTQ1MjEyOnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-mdm/src/main/java/ca/uhn/fhir/jpa/mdm/config/MdmSearchParameterLoader.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNzo1NTozOFrOIAzKZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNzo1NTozOFrOIAzKZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzcwOTE1Ng==", "bodyText": "remove this class", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r537709156", "createdAt": "2020-12-07T17:55:38Z", "author": {"login": "fil512"}, "path": "hapi-fhir-jpaserver-mdm/src/main/java/ca/uhn/fhir/jpa/mdm/config/MdmSearchParameterLoader.java", "diffHunk": "@@ -32,40 +32,42 @@\n import org.springframework.stereotype.Service;\n \n @Service\n-public class EmpiSearchParameterLoader {\n-\tpublic static final String EMPI_PERSON_ASSURANCE_SEARCH_PARAMETER_ID = \"person-assurance\";\n-\tpublic static final String EMPI_PERSON_ACTIVE_SEARCH_PARAMETER_ID = \"person-active\";\n+public class MdmSearchParameterLoader {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5f7f2df14f732c131b360087deaa0b4827b05b5"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3NTQ2MDkyOnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-mdm/src/main/java/ca/uhn/fhir/jpa/mdm/dao/MdmLinkDaoSvc.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNzo1NzoyMlrOIAzPbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNzo1NzoyMlrOIAzPbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzcxMDQ0Ng==", "bodyText": "Git is seeing these as delete / add which makes it harder to review.  If possible, it's better to rename and move classes in a git aware fashion so it can track the deltas.  It's possible that git just isn't able to do this...", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r537710446", "createdAt": "2020-12-07T17:57:22Z", "author": {"login": "fil512"}, "path": "hapi-fhir-jpaserver-mdm/src/main/java/ca/uhn/fhir/jpa/mdm/dao/MdmLinkDaoSvc.java", "diffHunk": "@@ -0,0 +1,338 @@\n+package ca.uhn.fhir.jpa.mdm.dao;\n+\n+/*-\n+ * #%L\n+ * HAPI FHIR JPA Server - Master Data Management\n+ * %%\n+ * Copyright (C) 2014 - 2020 University Health Network\n+ * %%\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * #L%\n+ */\n+\n+import ca.uhn.fhir.context.FhirContext;\n+import ca.uhn.fhir.jpa.dao.data.IMdmLinkDao;\n+import ca.uhn.fhir.jpa.dao.index.IdHelperService;\n+import ca.uhn.fhir.jpa.entity.MdmLink;\n+import ca.uhn.fhir.mdm.api.MdmLinkSourceEnum;\n+import ca.uhn.fhir.mdm.api.MdmMatchOutcome;\n+import ca.uhn.fhir.mdm.api.MdmMatchResultEnum;\n+import ca.uhn.fhir.mdm.log.Logs;\n+import ca.uhn.fhir.mdm.model.MdmTransactionContext;\n+import org.hl7.fhir.instance.model.api.IBaseResource;\n+import org.slf4j.Logger;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.data.domain.Example;\n+import org.springframework.transaction.annotation.Propagation;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.Date;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+public class MdmLinkDaoSvc {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5f7f2df14f732c131b360087deaa0b4827b05b5"}, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3NTQ2NzUzOnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-mdm/src/main/java/ca/uhn/fhir/jpa/mdm/interceptor/MdmStorageInterceptor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNzo1ODo0OVrOIAzTaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNzo1ODo0OVrOIAzTaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzcxMTQ2NQ==", "bodyText": "What's the plan with these TODOs?  Will they be addressed in a future PR?", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r537711465", "createdAt": "2020-12-07T17:58:49Z", "author": {"login": "fil512"}, "path": "hapi-fhir-jpaserver-mdm/src/main/java/ca/uhn/fhir/jpa/mdm/interceptor/MdmStorageInterceptor.java", "diffHunk": "@@ -45,72 +45,71 @@\n import java.util.concurrent.atomic.AtomicInteger;\n \n @Service\n-public class EmpiStorageInterceptor implements IEmpiStorageInterceptor {\n-\tprivate static final Logger ourLog = LoggerFactory.getLogger(EmpiStorageInterceptor.class);\n+public class MdmStorageInterceptor implements IMdmStorageInterceptor {\n+\tprivate static final Logger ourLog = LoggerFactory.getLogger(MdmStorageInterceptor.class);\n \t@Autowired\n \tprivate ExpungeEverythingService myExpungeEverythingService;\n \t@Autowired\n-\tprivate EmpiLinkDeleteSvc myEmpiLinkDeleteSvc;\n+\tprivate MdmLinkDeleteSvc myMdmLinkDeleteSvc;\n \t@Autowired\n \tprivate FhirContext myFhirContext;\n \t@Autowired\n \tprivate EIDHelper myEIDHelper;\n \t@Autowired\n-\tprivate IEmpiSettings myEmpiSettings;\n+\tprivate IMdmSettings myMdmSettings;\n \t@Autowired\n-\tprivate PersonHelper myPersonHelper;\n+\tprivate GoldenResourceHelper myGoldenResourceHelper;\n \n \n \t@Hook(Pointcut.STORAGE_PRESTORAGE_RESOURCE_CREATED)\n-\tpublic void blockManualPersonManipulationOnCreate(IBaseResource theBaseResource, RequestDetails theRequestDetails, ServletRequestDetails theServletRequestDetails) {\n+\tpublic void blockManualResourceManipulationOnCreate(IBaseResource theBaseResource, RequestDetails theRequestDetails, ServletRequestDetails theServletRequestDetails) {\n \n \t\t//If running in single EID mode, forbid multiple eids.\n-\t\tif (myEmpiSettings.isPreventMultipleEids()) {\n+\t\tif (myMdmSettings.isPreventMultipleEids()) {\n \t\t\tforbidIfHasMultipleEids(theBaseResource);\n \t\t}\n \n-\t\t// TODO EMPI find a better way to identify EMPI calls\n+\t\t// TODO GGG MDM find a better way to identify i nternal calls?\n \t\tif (isInternalRequest(theRequestDetails)) {\n \t\t\treturn;\n \t\t}\n \n-\t\tforbidIfEmpiManagedTagIsPresent(theBaseResource);\n+\t\tforbidIfMdmManagedTagIsPresent(theBaseResource);\n \t}\n \n \t@Hook(Pointcut.STORAGE_PRESTORAGE_RESOURCE_UPDATED)\n-\tpublic void blockManualPersonManipulationOnUpdate(IBaseResource theOldResource, IBaseResource theNewResource, RequestDetails theRequestDetails, ServletRequestDetails theServletRequestDetails) {\n-\n+\tpublic void blockManualGoldenResourceManipulationOnUpdate(IBaseResource theOldResource, IBaseResource theUpdatedResource, RequestDetails theRequestDetails, ServletRequestDetails theServletRequestDetails) {\n \t\t//If running in single EID mode, forbid multiple eids.\n-\t\tif (myEmpiSettings.isPreventMultipleEids()) {\n-\t\t\tforbidIfHasMultipleEids(theNewResource);\n+\t\tif (myMdmSettings.isPreventMultipleEids()) {\n+\t\t\tforbidIfHasMultipleEids(theUpdatedResource);\n \t\t}\n \n-\t\tif (EmpiUtil.isEmpiManagedPerson(myFhirContext, theNewResource) &&\n-\t\t\tmyPersonHelper.isDeactivated(theNewResource)) {\n-\t\t\tourLog.debug(\"Deleting empi links to deactivated Person {}\", theNewResource.getIdElement().toUnqualifiedVersionless());\n-\t\t\tint deleted = myEmpiLinkDeleteSvc.deleteNonRedirectWithWithAnyReferenceTo(theNewResource);\n+\t\t//TODO GGG MDM: Check if this is actually handled already in mdm update code or not.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5f7f2df14f732c131b360087deaa0b4827b05b5"}, "originalPosition": 97}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3NTQ4Mzk3OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-mdm/src/main/java/ca/uhn/fhir/jpa/mdm/interceptor/MdmStorageInterceptor.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxODowMjoxMFrOIAzc9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxODowMjoxMFrOIAzc9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzcxMzkxMA==", "bodyText": "I was initially thrown by the term \"deactivated\" but I think it's a good term here.  It does make me wonder if there's a better one.  What do other mdm systems call this...?", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r537713910", "createdAt": "2020-12-07T18:02:10Z", "author": {"login": "fil512"}, "path": "hapi-fhir-jpaserver-mdm/src/main/java/ca/uhn/fhir/jpa/mdm/interceptor/MdmStorageInterceptor.java", "diffHunk": "@@ -45,72 +45,71 @@\n import java.util.concurrent.atomic.AtomicInteger;\n \n @Service\n-public class EmpiStorageInterceptor implements IEmpiStorageInterceptor {\n-\tprivate static final Logger ourLog = LoggerFactory.getLogger(EmpiStorageInterceptor.class);\n+public class MdmStorageInterceptor implements IMdmStorageInterceptor {\n+\tprivate static final Logger ourLog = LoggerFactory.getLogger(MdmStorageInterceptor.class);\n \t@Autowired\n \tprivate ExpungeEverythingService myExpungeEverythingService;\n \t@Autowired\n-\tprivate EmpiLinkDeleteSvc myEmpiLinkDeleteSvc;\n+\tprivate MdmLinkDeleteSvc myMdmLinkDeleteSvc;\n \t@Autowired\n \tprivate FhirContext myFhirContext;\n \t@Autowired\n \tprivate EIDHelper myEIDHelper;\n \t@Autowired\n-\tprivate IEmpiSettings myEmpiSettings;\n+\tprivate IMdmSettings myMdmSettings;\n \t@Autowired\n-\tprivate PersonHelper myPersonHelper;\n+\tprivate GoldenResourceHelper myGoldenResourceHelper;\n \n \n \t@Hook(Pointcut.STORAGE_PRESTORAGE_RESOURCE_CREATED)\n-\tpublic void blockManualPersonManipulationOnCreate(IBaseResource theBaseResource, RequestDetails theRequestDetails, ServletRequestDetails theServletRequestDetails) {\n+\tpublic void blockManualResourceManipulationOnCreate(IBaseResource theBaseResource, RequestDetails theRequestDetails, ServletRequestDetails theServletRequestDetails) {\n \n \t\t//If running in single EID mode, forbid multiple eids.\n-\t\tif (myEmpiSettings.isPreventMultipleEids()) {\n+\t\tif (myMdmSettings.isPreventMultipleEids()) {\n \t\t\tforbidIfHasMultipleEids(theBaseResource);\n \t\t}\n \n-\t\t// TODO EMPI find a better way to identify EMPI calls\n+\t\t// TODO GGG MDM find a better way to identify i nternal calls?\n \t\tif (isInternalRequest(theRequestDetails)) {\n \t\t\treturn;\n \t\t}\n \n-\t\tforbidIfEmpiManagedTagIsPresent(theBaseResource);\n+\t\tforbidIfMdmManagedTagIsPresent(theBaseResource);\n \t}\n \n \t@Hook(Pointcut.STORAGE_PRESTORAGE_RESOURCE_UPDATED)\n-\tpublic void blockManualPersonManipulationOnUpdate(IBaseResource theOldResource, IBaseResource theNewResource, RequestDetails theRequestDetails, ServletRequestDetails theServletRequestDetails) {\n-\n+\tpublic void blockManualGoldenResourceManipulationOnUpdate(IBaseResource theOldResource, IBaseResource theUpdatedResource, RequestDetails theRequestDetails, ServletRequestDetails theServletRequestDetails) {\n \t\t//If running in single EID mode, forbid multiple eids.\n-\t\tif (myEmpiSettings.isPreventMultipleEids()) {\n-\t\t\tforbidIfHasMultipleEids(theNewResource);\n+\t\tif (myMdmSettings.isPreventMultipleEids()) {\n+\t\t\tforbidIfHasMultipleEids(theUpdatedResource);\n \t\t}\n \n-\t\tif (EmpiUtil.isEmpiManagedPerson(myFhirContext, theNewResource) &&\n-\t\t\tmyPersonHelper.isDeactivated(theNewResource)) {\n-\t\t\tourLog.debug(\"Deleting empi links to deactivated Person {}\", theNewResource.getIdElement().toUnqualifiedVersionless());\n-\t\t\tint deleted = myEmpiLinkDeleteSvc.deleteNonRedirectWithWithAnyReferenceTo(theNewResource);\n+\t\t//TODO GGG MDM: Check if this is actually handled already in mdm update code or not.\n+\t\tif (myGoldenResourceHelper.isDeactivated(theUpdatedResource)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5f7f2df14f732c131b360087deaa0b4827b05b5"}, "originalPosition": 98}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3NTUwNDUzOnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-mdm/src/main/java/ca/uhn/fhir/jpa/mdm/svc/MdmResourceFilteringSvc.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxODowNjo0M1rOIAzonQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxODowNjo0M1rOIAzonQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzcxNjg5Mw==", "bodyText": "hmm.  I don't understand the question", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r537716893", "createdAt": "2020-12-07T18:06:43Z", "author": {"login": "fil512"}, "path": "hapi-fhir-jpaserver-mdm/src/main/java/ca/uhn/fhir/jpa/mdm/svc/MdmResourceFilteringSvc.java", "diffHunk": "@@ -32,43 +33,48 @@\n import java.util.List;\n \n @Service\n-public class EmpiResourceFilteringSvc {\n-\tprivate static final Logger ourLog = Logs.getEmpiTroubleshootingLog();\n+public class MdmResourceFilteringSvc {\n+\tprivate static final Logger ourLog = Logs.getMdmTroubleshootingLog();\n \n \t@Autowired\n-\tprivate IEmpiSettings myEmpiSettings;\n+\tprivate IMdmSettings myMdmSettings;\n \t@Autowired\n-\tEmpiSearchParamSvc myEmpiSearchParamSvc;\n+\tMdmSearchParamSvc myMdmSearchParamSvc;\n \t@Autowired\n \tFhirContext myFhirContext;\n \n \t/**\n-\t * Given a resource from the EMPI Channel, determine whether or not EMPI processing should occur on it.\n+\t * Given a resource from the MDM Channel, determine whether or not MDM processing should occur on it.\n \t *\n-\t * EMPI processing should occur if for any {@link EmpiResourceSearchParamJson) Search Param, the resource contains a value.\n+\t * MDM processing should occur if for any {@link MdmResourceSearchParamJson ) Search Param, the resource contains a value.\n \t *\n \t * If the resource has no attributes that appear in the candidate search params, processing should be skipped, as there is not\n-\t * sufficient information to perform meaningful EMPI processing. (For example, how can EMPI processing occur on a patient that has _no_ attributes?)\n+\t * sufficient information to perform meaningful MDM processing. (For example, how can MDM processing occur on a patient that has _no_ attributes?)\n \t *\n-\t * @param theResource the resource that you wish to check against EMPI rules.\n+\t * @param theResource the resource that you wish to check against MDM rules.\n \t *\n-\t * @return whether or not EMPI processing should proceed\n+\t * @return whether or not MDM processing should proceed\n \t */\n \tpublic boolean shouldBeProcessed(IAnyResource theResource) {\n+\t\t//TODO GGG ask KHS: Skip the infinite loop, whoops. Better way to do this? tighter subscription criteria?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5f7f2df14f732c131b360087deaa0b4827b05b5"}, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3NTUwOTI1OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-mdm/src/main/java/ca/uhn/fhir/jpa/mdm/svc/candidate/FindCandidateByScoreSvc.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxODowNzo0OVrOIAzrZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxODowNzo0OVrOIAzrZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzcxNzYwNA==", "bodyText": "Consider renaming to FindCandidateByExampleSvc", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r537717604", "createdAt": "2020-12-07T18:07:49Z", "author": {"login": "fil512"}, "path": "hapi-fhir-jpaserver-mdm/src/main/java/ca/uhn/fhir/jpa/mdm/svc/candidate/FindCandidateByScoreSvc.java", "diffHunk": "@@ -0,0 +1,111 @@\n+package ca.uhn.fhir.jpa.mdm.svc.candidate;\n+\n+/*-\n+ * #%L\n+ * HAPI FHIR JPA Server - Master Data Management\n+ * %%\n+ * Copyright (C) 2014 - 2020 University Health Network\n+ * %%\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * #L%\n+ */\n+\n+import ca.uhn.fhir.context.FhirContext;\n+import ca.uhn.fhir.mdm.api.MdmMatchResultEnum;\n+import ca.uhn.fhir.mdm.api.IMdmMatchFinderSvc;\n+import ca.uhn.fhir.mdm.api.MatchedTarget;\n+import ca.uhn.fhir.mdm.log.Logs;\n+import ca.uhn.fhir.jpa.dao.index.IdHelperService;\n+import ca.uhn.fhir.jpa.mdm.dao.MdmLinkDaoSvc;\n+import ca.uhn.fhir.jpa.entity.MdmLink;\n+import ca.uhn.fhir.rest.api.server.storage.ResourcePersistentId;\n+import org.hl7.fhir.instance.model.api.IAnyResource;\n+import org.hl7.fhir.instance.model.api.IBaseResource;\n+import org.slf4j.Logger;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+@Service\n+public class FindCandidateByScoreSvc extends BaseCandidateFinder {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5f7f2df14f732c131b360087deaa0b4827b05b5"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3NTUyNTA4OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-server-mdm/src/main/java/ca/uhn/fhir/mdm/model/CanonicalIdentityAssuranceLevel.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxODoxMTozOFrOIAz03g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxODoxMTozOFrOIAz03g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzcyMDAzMA==", "bodyText": "delete this class", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r537720030", "createdAt": "2020-12-07T18:11:38Z", "author": {"login": "fil512"}, "path": "hapi-fhir-server-mdm/src/main/java/ca/uhn/fhir/mdm/model/CanonicalIdentityAssuranceLevel.java", "diffHunk": "@@ -1,8 +1,8 @@\n-package ca.uhn.fhir.empi.model;\n+package ca.uhn.fhir.mdm.model;\n \n /*-\n  * #%L\n- * HAPI FHIR - Enterprise Master Patient Index\n+ * HAPI FHIR - Master Data Management", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5f7f2df14f732c131b360087deaa0b4827b05b5"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3NTUzMzc2OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-server-mdm/src/main/java/ca/uhn/fhir/mdm/util/AssuranceLevelUtil.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxODoxMzozMlrOIAz5zQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxODoxMzozMlrOIAz5zQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzcyMTI5Mw==", "bodyText": "Delete all mdm classes concerning assurance level", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r537721293", "createdAt": "2020-12-07T18:13:32Z", "author": {"login": "fil512"}, "path": "hapi-fhir-server-mdm/src/main/java/ca/uhn/fhir/mdm/util/AssuranceLevelUtil.java", "diffHunk": "@@ -20,21 +20,21 @@\n  * #L%\n  */\n \n-import ca.uhn.fhir.empi.api.EmpiLinkSourceEnum;\n-import ca.uhn.fhir.empi.api.EmpiMatchResultEnum;\n-import ca.uhn.fhir.empi.model.CanonicalIdentityAssuranceLevel;\n+import ca.uhn.fhir.mdm.api.MdmLinkSourceEnum;\n+import ca.uhn.fhir.mdm.api.MdmMatchResultEnum;\n+import ca.uhn.fhir.mdm.model.CanonicalIdentityAssuranceLevel;\n import ca.uhn.fhir.rest.server.exceptions.InvalidRequestException;\n \n /**\n  * Helper class to determine assurance level based on Link Source and Match Result.\n- * This is strictly for use in populating Person links.\n+ * This is strictly for use in populating Golden Resource links.\n  */\n public final class AssuranceLevelUtil {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5f7f2df14f732c131b360087deaa0b4827b05b5"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3NTU1NzM0OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-server-mdm/src/main/java/ca/uhn/fhir/mdm/util/GoldenResourceHelper.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxODoxOToxMlrOIA0IFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxODoxOToxMlrOIA0IFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzcyNDk0OA==", "bodyText": "Is this actually a PrimitiveTypeEqualsPredicate ?", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r537724948", "createdAt": "2020-12-07T18:19:12Z", "author": {"login": "fil512"}, "path": "hapi-fhir-server-mdm/src/main/java/ca/uhn/fhir/mdm/util/GoldenResourceHelper.java", "diffHunk": "@@ -0,0 +1,377 @@\n+package ca.uhn.fhir.mdm.util;\n+\n+/*-\n+ * #%L\n+ * HAPI FHIR - Master Data Management\n+ * %%\n+ * Copyright (C) 2014 - 2020 University Health Network\n+ * %%\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * #L%\n+ */\n+\n+import ca.uhn.fhir.context.BaseRuntimeChildDefinition;\n+import ca.uhn.fhir.context.BaseRuntimeElementCompositeDefinition;\n+import ca.uhn.fhir.context.FhirContext;\n+import ca.uhn.fhir.context.FhirVersionEnum;\n+import ca.uhn.fhir.context.RuntimeResourceDefinition;\n+import ca.uhn.fhir.fhirpath.IFhirPath;\n+import ca.uhn.fhir.mdm.api.IMdmSettings;\n+import ca.uhn.fhir.mdm.log.Logs;\n+import ca.uhn.fhir.mdm.model.CanonicalEID;\n+import ca.uhn.fhir.mdm.model.MdmTransactionContext;\n+import ca.uhn.fhir.util.FhirTerser;\n+import org.hl7.fhir.instance.model.api.IAnyResource;\n+import org.hl7.fhir.instance.model.api.IBase;\n+import org.hl7.fhir.instance.model.api.IBaseResource;\n+import org.hl7.fhir.instance.model.api.IPrimitiveType;\n+import org.hl7.fhir.r4.model.BooleanType;\n+import org.slf4j.Logger;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+import static ca.uhn.fhir.context.FhirVersionEnum.DSTU3;\n+import static ca.uhn.fhir.context.FhirVersionEnum.R4;\n+\n+@Service\n+public class GoldenResourceHelper {\n+\n+\tprivate static final Logger ourLog = Logs.getMdmTroubleshootingLog();\n+\n+\tprivate static final String FIELD_NAME_IDENTIFIER = \"identifier\";\n+\n+\t@Autowired\n+\tprivate IMdmSettings myMdmSettings;\n+\t@Autowired\n+\tprivate EIDHelper myEIDHelper;\n+\n+\n+\tprivate final FhirContext myFhirContext;\n+\n+\t@Autowired\n+\tpublic GoldenResourceHelper(FhirContext theFhirContext) {\n+\t\tmyFhirContext = theFhirContext;\n+\t}\n+\n+\t/**\n+\t * Creates a copy of the specified resource. This method will carry over resource EID if it exists. If it does not exist,\n+\t * a randomly generated UUID EID will be created.\n+\t *\n+\t * @param <T>                 Supported MDM resource type (e.g. Patient, Practitioner)\n+\t * @param theIncomingResource The resource that will be used as the starting point for the MDM linking.\n+\t */\n+\tpublic <T extends IAnyResource> T createGoldenResourceFromMdmTarget(T theIncomingResource) {\n+\t\tvalidateContextSupported();\n+\n+\t\t// get a ref to the actual ID Field\n+\t\tRuntimeResourceDefinition resourceDefinition = myFhirContext.getResourceDefinition(theIncomingResource);\n+\t\tIBaseResource newGoldenResource = resourceDefinition.newInstance();\n+\n+\t\t// hapi has 2 metamodels: for children and types\n+\t\tBaseRuntimeChildDefinition goldenResourceIdentifier = resourceDefinition.getChildByName(FIELD_NAME_IDENTIFIER);\n+\n+\t\tcloneAllExternalEidsIntoNewGoldenResource(goldenResourceIdentifier, theIncomingResource, newGoldenResource);\n+\n+\t\taddHapiEidIfNoExternalEidIsPresent(newGoldenResource, goldenResourceIdentifier, theIncomingResource);\n+\n+\t\tMdmUtil.setMdmManaged(newGoldenResource);\n+\t\tMdmUtil.setGoldenResource(newGoldenResource);\n+\n+\t\treturn (T) newGoldenResource;\n+\t}\n+\n+\t/**\n+\t * If there are no external EIDs on the incoming resource, create a new HAPI EID on the new Golden Resource.\n+\t */\n+\t//TODO GGG ask james if there is any way we can convert this canonical EID into a generic STU-agnostic IBase.\n+\tprivate <T extends IAnyResource> void addHapiEidIfNoExternalEidIsPresent(\n+\t\tIBaseResource theNewGoldenResource, BaseRuntimeChildDefinition theGoldenResourceIdentifier, IAnyResource theTargetResource) {\n+\n+\t\tList<CanonicalEID> eidsToApply = myEIDHelper.getExternalEid(theNewGoldenResource);\n+\t\tif (!eidsToApply.isEmpty()) {\n+\t\t\treturn;\n+\t\t}\n+\n+\t\tCanonicalEID hapiEid = myEIDHelper.createHapiEid();\n+\t\ttheGoldenResourceIdentifier.getMutator().addValue(theNewGoldenResource, toId(hapiEid));\n+\n+\t\t// set identifier on the target resource\n+\t\tcloneEidIntoResource(theTargetResource, hapiEid);\n+\t}\n+\n+\tprivate void cloneEidIntoResource(IBaseResource theResourceToCloneInto, CanonicalEID theEid) {\n+\t\t// get a ref to the actual ID Field\n+\t\tRuntimeResourceDefinition resourceDefinition = myFhirContext.getResourceDefinition(theResourceToCloneInto);\n+\t\t// hapi has 2 metamodels: for children and types\n+\t\tBaseRuntimeChildDefinition resourceIdentifier = resourceDefinition.getChildByName(FIELD_NAME_IDENTIFIER);\n+\t\tcloneEidIntoResource(resourceIdentifier, toId(theEid), theResourceToCloneInto);\n+\t}\n+\n+\t/**\n+\t * Given an Child Definition of `identifier`, a R4/DSTU3 EID Identifier, and a new resource, clone the EID into that resources' identifier list.\n+\t */\n+\tprivate void cloneEidIntoResource(BaseRuntimeChildDefinition theIdentifierDefinition, IBase theEid, IBase theResourceToCloneEidInto) {\n+\t\t// FHIR choice types - fields within fhir where we have a choice of ids\n+\t\tBaseRuntimeElementCompositeDefinition<?> childIdentifier = (BaseRuntimeElementCompositeDefinition<?>) theIdentifierDefinition.getChildByName(FIELD_NAME_IDENTIFIER);\n+\t\tIBase resourceNewIdentifier = childIdentifier.newInstance();\n+\n+\t\tFhirTerser terser = myFhirContext.newTerser();\n+\t\tterser.cloneInto(theEid, resourceNewIdentifier, true);\n+\t\ttheIdentifierDefinition.getMutator().addValue(theResourceToCloneEidInto, resourceNewIdentifier);\n+\t}\n+\n+\t/**\n+\t * Clones specified composite field (collection). Composite field values must confirm to the collections\n+\t * contract.\n+\t *\n+\t * @param theFrom Resource to clone the specified filed from\n+\t * @param theTo   Resource to clone the specified filed to\n+\t * @param field   Field name to be copied\n+\t */\n+\tprivate void cloneCompositeField(IBaseResource theFrom, IBaseResource theTo, String field) {\n+\t\tFhirTerser terser = myFhirContext.newTerser();\n+\n+\t\tRuntimeResourceDefinition definition = myFhirContext.getResourceDefinition(theFrom);\n+\t\tBaseRuntimeChildDefinition childDefinition = definition.getChildByName(field);\n+\n+\t\tIFhirPath fhirPath = myFhirContext.newFhirPath();\n+\t\tList<IBase> theFromFieldValues = childDefinition.getAccessor().getValues(theFrom);\n+\t\tList<IBase> theToFieldValues = childDefinition.getAccessor().getValues(theTo);\n+\n+\t\tfor (IBase theFromFieldValue : theFromFieldValues) {\n+\t\t\tif (contains(theFromFieldValue, theToFieldValues)) {\n+\t\t\t\tcontinue;\n+\t\t\t}\n+\n+\t\t\tBaseRuntimeElementCompositeDefinition<?> compositeDefinition = (BaseRuntimeElementCompositeDefinition<?>) childDefinition.getChildByName(field);\n+\t\t\tIBase newFieldValue = compositeDefinition.newInstance();\n+\t\t\tterser.cloneInto(theFromFieldValue, newFieldValue, true);\n+\n+\t\t\ttheToFieldValues.add(newFieldValue);\n+\t\t}\n+\t}\n+\n+\tprivate boolean contains(IBase theItem, List<IBase> theItems) {\n+\t\tPrimitiveTypeComparingPredicate predicate = new PrimitiveTypeComparingPredicate();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5f7f2df14f732c131b360087deaa0b4827b05b5"}, "originalPosition": 171}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3NTU2MjQ0OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-server-mdm/src/main/java/ca/uhn/fhir/mdm/util/GoldenResourceHelper.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxODoyMDoxOFrOIA0K3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxODoyMDoxOFrOIA0K3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzcyNTY2MA==", "bodyText": "This should probably be a static util function so we can use it elsewhere..", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r537725660", "createdAt": "2020-12-07T18:20:18Z", "author": {"login": "fil512"}, "path": "hapi-fhir-server-mdm/src/main/java/ca/uhn/fhir/mdm/util/GoldenResourceHelper.java", "diffHunk": "@@ -0,0 +1,377 @@\n+package ca.uhn.fhir.mdm.util;\n+\n+/*-\n+ * #%L\n+ * HAPI FHIR - Master Data Management\n+ * %%\n+ * Copyright (C) 2014 - 2020 University Health Network\n+ * %%\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * #L%\n+ */\n+\n+import ca.uhn.fhir.context.BaseRuntimeChildDefinition;\n+import ca.uhn.fhir.context.BaseRuntimeElementCompositeDefinition;\n+import ca.uhn.fhir.context.FhirContext;\n+import ca.uhn.fhir.context.FhirVersionEnum;\n+import ca.uhn.fhir.context.RuntimeResourceDefinition;\n+import ca.uhn.fhir.fhirpath.IFhirPath;\n+import ca.uhn.fhir.mdm.api.IMdmSettings;\n+import ca.uhn.fhir.mdm.log.Logs;\n+import ca.uhn.fhir.mdm.model.CanonicalEID;\n+import ca.uhn.fhir.mdm.model.MdmTransactionContext;\n+import ca.uhn.fhir.util.FhirTerser;\n+import org.hl7.fhir.instance.model.api.IAnyResource;\n+import org.hl7.fhir.instance.model.api.IBase;\n+import org.hl7.fhir.instance.model.api.IBaseResource;\n+import org.hl7.fhir.instance.model.api.IPrimitiveType;\n+import org.hl7.fhir.r4.model.BooleanType;\n+import org.slf4j.Logger;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+import static ca.uhn.fhir.context.FhirVersionEnum.DSTU3;\n+import static ca.uhn.fhir.context.FhirVersionEnum.R4;\n+\n+@Service\n+public class GoldenResourceHelper {\n+\n+\tprivate static final Logger ourLog = Logs.getMdmTroubleshootingLog();\n+\n+\tprivate static final String FIELD_NAME_IDENTIFIER = \"identifier\";\n+\n+\t@Autowired\n+\tprivate IMdmSettings myMdmSettings;\n+\t@Autowired\n+\tprivate EIDHelper myEIDHelper;\n+\n+\n+\tprivate final FhirContext myFhirContext;\n+\n+\t@Autowired\n+\tpublic GoldenResourceHelper(FhirContext theFhirContext) {\n+\t\tmyFhirContext = theFhirContext;\n+\t}\n+\n+\t/**\n+\t * Creates a copy of the specified resource. This method will carry over resource EID if it exists. If it does not exist,\n+\t * a randomly generated UUID EID will be created.\n+\t *\n+\t * @param <T>                 Supported MDM resource type (e.g. Patient, Practitioner)\n+\t * @param theIncomingResource The resource that will be used as the starting point for the MDM linking.\n+\t */\n+\tpublic <T extends IAnyResource> T createGoldenResourceFromMdmTarget(T theIncomingResource) {\n+\t\tvalidateContextSupported();\n+\n+\t\t// get a ref to the actual ID Field\n+\t\tRuntimeResourceDefinition resourceDefinition = myFhirContext.getResourceDefinition(theIncomingResource);\n+\t\tIBaseResource newGoldenResource = resourceDefinition.newInstance();\n+\n+\t\t// hapi has 2 metamodels: for children and types\n+\t\tBaseRuntimeChildDefinition goldenResourceIdentifier = resourceDefinition.getChildByName(FIELD_NAME_IDENTIFIER);\n+\n+\t\tcloneAllExternalEidsIntoNewGoldenResource(goldenResourceIdentifier, theIncomingResource, newGoldenResource);\n+\n+\t\taddHapiEidIfNoExternalEidIsPresent(newGoldenResource, goldenResourceIdentifier, theIncomingResource);\n+\n+\t\tMdmUtil.setMdmManaged(newGoldenResource);\n+\t\tMdmUtil.setGoldenResource(newGoldenResource);\n+\n+\t\treturn (T) newGoldenResource;\n+\t}\n+\n+\t/**\n+\t * If there are no external EIDs on the incoming resource, create a new HAPI EID on the new Golden Resource.\n+\t */\n+\t//TODO GGG ask james if there is any way we can convert this canonical EID into a generic STU-agnostic IBase.\n+\tprivate <T extends IAnyResource> void addHapiEidIfNoExternalEidIsPresent(\n+\t\tIBaseResource theNewGoldenResource, BaseRuntimeChildDefinition theGoldenResourceIdentifier, IAnyResource theTargetResource) {\n+\n+\t\tList<CanonicalEID> eidsToApply = myEIDHelper.getExternalEid(theNewGoldenResource);\n+\t\tif (!eidsToApply.isEmpty()) {\n+\t\t\treturn;\n+\t\t}\n+\n+\t\tCanonicalEID hapiEid = myEIDHelper.createHapiEid();\n+\t\ttheGoldenResourceIdentifier.getMutator().addValue(theNewGoldenResource, toId(hapiEid));\n+\n+\t\t// set identifier on the target resource\n+\t\tcloneEidIntoResource(theTargetResource, hapiEid);\n+\t}\n+\n+\tprivate void cloneEidIntoResource(IBaseResource theResourceToCloneInto, CanonicalEID theEid) {\n+\t\t// get a ref to the actual ID Field\n+\t\tRuntimeResourceDefinition resourceDefinition = myFhirContext.getResourceDefinition(theResourceToCloneInto);\n+\t\t// hapi has 2 metamodels: for children and types\n+\t\tBaseRuntimeChildDefinition resourceIdentifier = resourceDefinition.getChildByName(FIELD_NAME_IDENTIFIER);\n+\t\tcloneEidIntoResource(resourceIdentifier, toId(theEid), theResourceToCloneInto);\n+\t}\n+\n+\t/**\n+\t * Given an Child Definition of `identifier`, a R4/DSTU3 EID Identifier, and a new resource, clone the EID into that resources' identifier list.\n+\t */\n+\tprivate void cloneEidIntoResource(BaseRuntimeChildDefinition theIdentifierDefinition, IBase theEid, IBase theResourceToCloneEidInto) {\n+\t\t// FHIR choice types - fields within fhir where we have a choice of ids\n+\t\tBaseRuntimeElementCompositeDefinition<?> childIdentifier = (BaseRuntimeElementCompositeDefinition<?>) theIdentifierDefinition.getChildByName(FIELD_NAME_IDENTIFIER);\n+\t\tIBase resourceNewIdentifier = childIdentifier.newInstance();\n+\n+\t\tFhirTerser terser = myFhirContext.newTerser();\n+\t\tterser.cloneInto(theEid, resourceNewIdentifier, true);\n+\t\ttheIdentifierDefinition.getMutator().addValue(theResourceToCloneEidInto, resourceNewIdentifier);\n+\t}\n+\n+\t/**\n+\t * Clones specified composite field (collection). Composite field values must confirm to the collections\n+\t * contract.\n+\t *\n+\t * @param theFrom Resource to clone the specified filed from\n+\t * @param theTo   Resource to clone the specified filed to\n+\t * @param field   Field name to be copied\n+\t */\n+\tprivate void cloneCompositeField(IBaseResource theFrom, IBaseResource theTo, String field) {\n+\t\tFhirTerser terser = myFhirContext.newTerser();\n+\n+\t\tRuntimeResourceDefinition definition = myFhirContext.getResourceDefinition(theFrom);\n+\t\tBaseRuntimeChildDefinition childDefinition = definition.getChildByName(field);\n+\n+\t\tIFhirPath fhirPath = myFhirContext.newFhirPath();\n+\t\tList<IBase> theFromFieldValues = childDefinition.getAccessor().getValues(theFrom);\n+\t\tList<IBase> theToFieldValues = childDefinition.getAccessor().getValues(theTo);\n+\n+\t\tfor (IBase theFromFieldValue : theFromFieldValues) {\n+\t\t\tif (contains(theFromFieldValue, theToFieldValues)) {\n+\t\t\t\tcontinue;\n+\t\t\t}\n+\n+\t\t\tBaseRuntimeElementCompositeDefinition<?> compositeDefinition = (BaseRuntimeElementCompositeDefinition<?>) childDefinition.getChildByName(field);\n+\t\t\tIBase newFieldValue = compositeDefinition.newInstance();\n+\t\t\tterser.cloneInto(theFromFieldValue, newFieldValue, true);\n+\n+\t\t\ttheToFieldValues.add(newFieldValue);\n+\t\t}\n+\t}\n+\n+\tprivate boolean contains(IBase theItem, List<IBase> theItems) {\n+\t\tPrimitiveTypeComparingPredicate predicate = new PrimitiveTypeComparingPredicate();\n+\t\treturn theItems.stream().filter(i -> {\n+\t\t\treturn predicate.test(i, theItem);\n+\t\t}).findFirst().isPresent();\n+\t}\n+\n+\tprivate void cloneAllExternalEidsIntoNewGoldenResource(BaseRuntimeChildDefinition theGoldenResourceIdentifier,\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t IBase theGoldenResource, IBase theNewGoldenResource) {\n+\t\t// FHIR choice types - fields within fhir where we have a choice of ids\n+\t\tIFhirPath fhirPath = myFhirContext.newFhirPath();\n+\t\tList<IBase> goldenResourceIdentifiers = theGoldenResourceIdentifier.getAccessor().getValues(theGoldenResource);\n+\n+\t\tfor (IBase base : goldenResourceIdentifiers) {\n+\t\t\tOptional<IPrimitiveType> system = fhirPath.evaluateFirst(base, \"system\", IPrimitiveType.class);\n+\t\t\tif (system.isPresent()) {\n+\t\t\t\tString mdmSystem = myMdmSettings.getMdmRules().getEnterpriseEIDSystem();\n+\t\t\t\tString baseSystem = system.get().getValueAsString();\n+\t\t\t\tif (Objects.equals(baseSystem, mdmSystem)) {\n+\t\t\t\t\tcloneEidIntoResource(theGoldenResourceIdentifier, base, theNewGoldenResource);\n+\t\t\t\t\tourLog.debug(\"System {} differs from system in the MDM rules {}\", baseSystem, mdmSystem);\n+\t\t\t\t}\n+\t\t\t} else {\n+\t\t\t\tourLog.debug(\"System is missing, skipping\");\n+\t\t\t}\n+\t\t}\n+\t}\n+\n+\tprivate void validateContextSupported() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5f7f2df14f732c131b360087deaa0b4827b05b5"}, "originalPosition": 198}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3NTU3MTY3OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-server-mdm/src/main/java/ca/uhn/fhir/mdm/util/GoldenResourceHelper.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxODoyMjowOVrOIA0QTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxODoyMjowOVrOIA0QTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzcyNzA1NQ==", "bodyText": "nitpick this class is getting kind of long.  is there a distinct responsibility in here that could be carved out into a separate class?", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r537727055", "createdAt": "2020-12-07T18:22:09Z", "author": {"login": "fil512"}, "path": "hapi-fhir-server-mdm/src/main/java/ca/uhn/fhir/mdm/util/GoldenResourceHelper.java", "diffHunk": "@@ -0,0 +1,377 @@\n+package ca.uhn.fhir.mdm.util;\n+\n+/*-\n+ * #%L\n+ * HAPI FHIR - Master Data Management\n+ * %%\n+ * Copyright (C) 2014 - 2020 University Health Network\n+ * %%\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * #L%\n+ */\n+\n+import ca.uhn.fhir.context.BaseRuntimeChildDefinition;\n+import ca.uhn.fhir.context.BaseRuntimeElementCompositeDefinition;\n+import ca.uhn.fhir.context.FhirContext;\n+import ca.uhn.fhir.context.FhirVersionEnum;\n+import ca.uhn.fhir.context.RuntimeResourceDefinition;\n+import ca.uhn.fhir.fhirpath.IFhirPath;\n+import ca.uhn.fhir.mdm.api.IMdmSettings;\n+import ca.uhn.fhir.mdm.log.Logs;\n+import ca.uhn.fhir.mdm.model.CanonicalEID;\n+import ca.uhn.fhir.mdm.model.MdmTransactionContext;\n+import ca.uhn.fhir.util.FhirTerser;\n+import org.hl7.fhir.instance.model.api.IAnyResource;\n+import org.hl7.fhir.instance.model.api.IBase;\n+import org.hl7.fhir.instance.model.api.IBaseResource;\n+import org.hl7.fhir.instance.model.api.IPrimitiveType;\n+import org.hl7.fhir.r4.model.BooleanType;\n+import org.slf4j.Logger;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+import static ca.uhn.fhir.context.FhirVersionEnum.DSTU3;\n+import static ca.uhn.fhir.context.FhirVersionEnum.R4;\n+\n+@Service\n+public class GoldenResourceHelper {\n+\n+\tprivate static final Logger ourLog = Logs.getMdmTroubleshootingLog();\n+\n+\tprivate static final String FIELD_NAME_IDENTIFIER = \"identifier\";\n+\n+\t@Autowired\n+\tprivate IMdmSettings myMdmSettings;\n+\t@Autowired\n+\tprivate EIDHelper myEIDHelper;\n+\n+\n+\tprivate final FhirContext myFhirContext;\n+\n+\t@Autowired\n+\tpublic GoldenResourceHelper(FhirContext theFhirContext) {\n+\t\tmyFhirContext = theFhirContext;\n+\t}\n+\n+\t/**\n+\t * Creates a copy of the specified resource. This method will carry over resource EID if it exists. If it does not exist,\n+\t * a randomly generated UUID EID will be created.\n+\t *\n+\t * @param <T>                 Supported MDM resource type (e.g. Patient, Practitioner)\n+\t * @param theIncomingResource The resource that will be used as the starting point for the MDM linking.\n+\t */\n+\tpublic <T extends IAnyResource> T createGoldenResourceFromMdmTarget(T theIncomingResource) {\n+\t\tvalidateContextSupported();\n+\n+\t\t// get a ref to the actual ID Field\n+\t\tRuntimeResourceDefinition resourceDefinition = myFhirContext.getResourceDefinition(theIncomingResource);\n+\t\tIBaseResource newGoldenResource = resourceDefinition.newInstance();\n+\n+\t\t// hapi has 2 metamodels: for children and types\n+\t\tBaseRuntimeChildDefinition goldenResourceIdentifier = resourceDefinition.getChildByName(FIELD_NAME_IDENTIFIER);\n+\n+\t\tcloneAllExternalEidsIntoNewGoldenResource(goldenResourceIdentifier, theIncomingResource, newGoldenResource);\n+\n+\t\taddHapiEidIfNoExternalEidIsPresent(newGoldenResource, goldenResourceIdentifier, theIncomingResource);\n+\n+\t\tMdmUtil.setMdmManaged(newGoldenResource);\n+\t\tMdmUtil.setGoldenResource(newGoldenResource);\n+\n+\t\treturn (T) newGoldenResource;\n+\t}\n+\n+\t/**\n+\t * If there are no external EIDs on the incoming resource, create a new HAPI EID on the new Golden Resource.\n+\t */\n+\t//TODO GGG ask james if there is any way we can convert this canonical EID into a generic STU-agnostic IBase.\n+\tprivate <T extends IAnyResource> void addHapiEidIfNoExternalEidIsPresent(\n+\t\tIBaseResource theNewGoldenResource, BaseRuntimeChildDefinition theGoldenResourceIdentifier, IAnyResource theTargetResource) {\n+\n+\t\tList<CanonicalEID> eidsToApply = myEIDHelper.getExternalEid(theNewGoldenResource);\n+\t\tif (!eidsToApply.isEmpty()) {\n+\t\t\treturn;\n+\t\t}\n+\n+\t\tCanonicalEID hapiEid = myEIDHelper.createHapiEid();\n+\t\ttheGoldenResourceIdentifier.getMutator().addValue(theNewGoldenResource, toId(hapiEid));\n+\n+\t\t// set identifier on the target resource\n+\t\tcloneEidIntoResource(theTargetResource, hapiEid);\n+\t}\n+\n+\tprivate void cloneEidIntoResource(IBaseResource theResourceToCloneInto, CanonicalEID theEid) {\n+\t\t// get a ref to the actual ID Field\n+\t\tRuntimeResourceDefinition resourceDefinition = myFhirContext.getResourceDefinition(theResourceToCloneInto);\n+\t\t// hapi has 2 metamodels: for children and types\n+\t\tBaseRuntimeChildDefinition resourceIdentifier = resourceDefinition.getChildByName(FIELD_NAME_IDENTIFIER);\n+\t\tcloneEidIntoResource(resourceIdentifier, toId(theEid), theResourceToCloneInto);\n+\t}\n+\n+\t/**\n+\t * Given an Child Definition of `identifier`, a R4/DSTU3 EID Identifier, and a new resource, clone the EID into that resources' identifier list.\n+\t */\n+\tprivate void cloneEidIntoResource(BaseRuntimeChildDefinition theIdentifierDefinition, IBase theEid, IBase theResourceToCloneEidInto) {\n+\t\t// FHIR choice types - fields within fhir where we have a choice of ids\n+\t\tBaseRuntimeElementCompositeDefinition<?> childIdentifier = (BaseRuntimeElementCompositeDefinition<?>) theIdentifierDefinition.getChildByName(FIELD_NAME_IDENTIFIER);\n+\t\tIBase resourceNewIdentifier = childIdentifier.newInstance();\n+\n+\t\tFhirTerser terser = myFhirContext.newTerser();\n+\t\tterser.cloneInto(theEid, resourceNewIdentifier, true);\n+\t\ttheIdentifierDefinition.getMutator().addValue(theResourceToCloneEidInto, resourceNewIdentifier);\n+\t}\n+\n+\t/**\n+\t * Clones specified composite field (collection). Composite field values must confirm to the collections\n+\t * contract.\n+\t *\n+\t * @param theFrom Resource to clone the specified filed from\n+\t * @param theTo   Resource to clone the specified filed to\n+\t * @param field   Field name to be copied\n+\t */\n+\tprivate void cloneCompositeField(IBaseResource theFrom, IBaseResource theTo, String field) {\n+\t\tFhirTerser terser = myFhirContext.newTerser();\n+\n+\t\tRuntimeResourceDefinition definition = myFhirContext.getResourceDefinition(theFrom);\n+\t\tBaseRuntimeChildDefinition childDefinition = definition.getChildByName(field);\n+\n+\t\tIFhirPath fhirPath = myFhirContext.newFhirPath();\n+\t\tList<IBase> theFromFieldValues = childDefinition.getAccessor().getValues(theFrom);\n+\t\tList<IBase> theToFieldValues = childDefinition.getAccessor().getValues(theTo);\n+\n+\t\tfor (IBase theFromFieldValue : theFromFieldValues) {\n+\t\t\tif (contains(theFromFieldValue, theToFieldValues)) {\n+\t\t\t\tcontinue;\n+\t\t\t}\n+\n+\t\t\tBaseRuntimeElementCompositeDefinition<?> compositeDefinition = (BaseRuntimeElementCompositeDefinition<?>) childDefinition.getChildByName(field);\n+\t\t\tIBase newFieldValue = compositeDefinition.newInstance();\n+\t\t\tterser.cloneInto(theFromFieldValue, newFieldValue, true);\n+\n+\t\t\ttheToFieldValues.add(newFieldValue);\n+\t\t}\n+\t}\n+\n+\tprivate boolean contains(IBase theItem, List<IBase> theItems) {\n+\t\tPrimitiveTypeComparingPredicate predicate = new PrimitiveTypeComparingPredicate();\n+\t\treturn theItems.stream().filter(i -> {\n+\t\t\treturn predicate.test(i, theItem);\n+\t\t}).findFirst().isPresent();\n+\t}\n+\n+\tprivate void cloneAllExternalEidsIntoNewGoldenResource(BaseRuntimeChildDefinition theGoldenResourceIdentifier,\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t IBase theGoldenResource, IBase theNewGoldenResource) {\n+\t\t// FHIR choice types - fields within fhir where we have a choice of ids\n+\t\tIFhirPath fhirPath = myFhirContext.newFhirPath();\n+\t\tList<IBase> goldenResourceIdentifiers = theGoldenResourceIdentifier.getAccessor().getValues(theGoldenResource);\n+\n+\t\tfor (IBase base : goldenResourceIdentifiers) {\n+\t\t\tOptional<IPrimitiveType> system = fhirPath.evaluateFirst(base, \"system\", IPrimitiveType.class);\n+\t\t\tif (system.isPresent()) {\n+\t\t\t\tString mdmSystem = myMdmSettings.getMdmRules().getEnterpriseEIDSystem();\n+\t\t\t\tString baseSystem = system.get().getValueAsString();\n+\t\t\t\tif (Objects.equals(baseSystem, mdmSystem)) {\n+\t\t\t\t\tcloneEidIntoResource(theGoldenResourceIdentifier, base, theNewGoldenResource);\n+\t\t\t\t\tourLog.debug(\"System {} differs from system in the MDM rules {}\", baseSystem, mdmSystem);\n+\t\t\t\t}\n+\t\t\t} else {\n+\t\t\t\tourLog.debug(\"System is missing, skipping\");\n+\t\t\t}\n+\t\t}\n+\t}\n+\n+\tprivate void validateContextSupported() {\n+\t\tFhirVersionEnum fhirVersion = myFhirContext.getVersion().getVersion();\n+\t\tif (fhirVersion == R4 || fhirVersion == DSTU3) {\n+\t\t\treturn;\n+\t\t}\n+\t\tthrow new UnsupportedOperationException(\"Version not supported: \" + myFhirContext.getVersion().getVersion());\n+\t}\n+\n+\t/**\n+\t * Updates EID on Golden Resource, based on the incoming target resource. If the incoming resource has an external EID, it is applied\n+\t * to the Golden Resource, unless that golden resource already has an external EID which does not match, in which case throw {@link IllegalArgumentException}\n+\t * <p>\n+\t * If running in multiple EID mode, then incoming EIDs are simply added to the Golden Resource without checking for matches.\n+\t *\n+\t * @param theGoldenResource The golden resource to update the external EID on.\n+\t * @param theTargetResource The target we will retrieve the external EID from.\n+\t * @return the modified {@link IBaseResource} representing the Golden Resource.\n+\t */\n+\tpublic IAnyResource updateGoldenResourceExternalEidFromTargetResource(IAnyResource theGoldenResource, IAnyResource\n+\t\ttheTargetResource, MdmTransactionContext theMdmTransactionContext) {\n+\t\t//This handles overwriting an automatically assigned EID if a patient that links is coming in with an official EID.\n+\t\tList<CanonicalEID> incomingTargetEid = myEIDHelper.getExternalEid(theTargetResource);\n+\t\tList<CanonicalEID> goldenResourceOfficialEid = myEIDHelper.getExternalEid(theGoldenResource);\n+\n+\t\tif (incomingTargetEid.isEmpty()) {\n+\t\t\treturn theGoldenResource;\n+\t\t}\n+\n+\t\tif (goldenResourceOfficialEid.isEmpty() || !myMdmSettings.isPreventMultipleEids()) {\n+\t\t\tlog(theMdmTransactionContext, \"Incoming resource:\" + theTargetResource.getIdElement().toUnqualifiedVersionless() + \" + with EID \" + incomingTargetEid.stream().map(CanonicalEID::toString).collect(Collectors.joining(\",\"))\n+\t\t\t\t+ \" is applying this EIDs to its related Target Resource, as this Target Resource does not yet have an external EID\");\n+\t\t\taddCanonicalEidsToGoldenResourceIfAbsent(theGoldenResource, incomingTargetEid);\n+\t\t} else if (!goldenResourceOfficialEid.isEmpty() && myEIDHelper.eidMatchExists(goldenResourceOfficialEid, incomingTargetEid)) {\n+\t\t\tlog(theMdmTransactionContext, \"incoming resource:\" + theTargetResource.getIdElement().toVersionless() + \" with EIDs \" + incomingTargetEid.stream().map(CanonicalEID::toString).collect(Collectors.joining(\",\")) + \" does not need to overwrite Golden Resource, as this EID is already present\");\n+\t\t} else {\n+\t\t\tthrow new IllegalArgumentException(\n+\t\t\t\tString.format(\"Target EIDs %s would create a duplicate golden resource, as EIDs %s already exist!\",\n+\t\t\t\t\tincomingTargetEid.toString(), goldenResourceOfficialEid.toString()));\n+\t\t}\n+\t\treturn theGoldenResource;\n+\t}\n+\n+\tpublic IBaseResource overwriteExternalEids(IBaseResource theGoldenResource, List<CanonicalEID> theNewEid) {\n+\t\tclearExternalEids(theGoldenResource);\n+\t\taddCanonicalEidsToGoldenResourceIfAbsent(theGoldenResource, theNewEid);\n+\t\treturn theGoldenResource;\n+\t}\n+\n+\tprivate void clearExternalEidsFromTheGoldenResource(BaseRuntimeChildDefinition theGoldenResourceIdentifier, IBase theGoldenResource) {\n+\t\tIFhirPath fhirPath = myFhirContext.newFhirPath();\n+\t\tList<IBase> goldenResourceIdentifiers = theGoldenResourceIdentifier.getAccessor().getValues(theGoldenResource);\n+\t\tList<IBase> clonedIdentifiers = new ArrayList<>();\n+\t\tFhirTerser terser = myFhirContext.newTerser();\n+\n+\t\tfor (IBase base : goldenResourceIdentifiers) {\n+\t\t\tOptional<IPrimitiveType> system = fhirPath.evaluateFirst(base, \"system\", IPrimitiveType.class);\n+\t\t\tif (system.isPresent()) {\n+\t\t\t\tString mdmSystem = myMdmSettings.getMdmRules().getEnterpriseEIDSystem();\n+\t\t\t\tString baseSystem = system.get().getValueAsString();\n+\t\t\t\tif (Objects.equals(baseSystem, mdmSystem)) {\n+\t\t\t\t\tourLog.debug(\"Found EID confirming to MDM rules {}. It should not be copied, skipping\", baseSystem);\n+\t\t\t\t\tcontinue;\n+\t\t\t\t}\n+\t\t\t}\n+\n+\t\t\tBaseRuntimeElementCompositeDefinition<?> childIdentifier = (BaseRuntimeElementCompositeDefinition<?>)\n+\t\t\t\ttheGoldenResourceIdentifier.getChildByName(FIELD_NAME_IDENTIFIER);\n+\t\t\tIBase goldenResourceNewIdentifier = childIdentifier.newInstance();\n+\t\t\tterser.cloneInto(base, goldenResourceNewIdentifier, true);\n+\n+\t\t\tclonedIdentifiers.add(goldenResourceNewIdentifier);\n+\t\t}\n+\n+\t\tgoldenResourceIdentifiers.clear();\n+\t\tgoldenResourceIdentifiers.addAll(clonedIdentifiers);\n+\t}\n+\n+\tprivate void clearExternalEids(IBaseResource theGoldenResource) {\n+\t\t// validate the system - if it's set to EID system - then clear it - type and STU version\n+\t\tvalidateContextSupported();\n+\n+\t\t// get a ref to the actual ID Field\n+\t\tRuntimeResourceDefinition resourceDefinition = myFhirContext.getResourceDefinition(theGoldenResource);\n+\t\tBaseRuntimeChildDefinition goldenResourceIdentifier = resourceDefinition.getChildByName(FIELD_NAME_IDENTIFIER);\n+\t\tclearExternalEidsFromTheGoldenResource(goldenResourceIdentifier, theGoldenResource);\n+\t}\n+\n+\t/**\n+\t * Given a list of incoming External EIDs, and a Golden Resource, apply all the EIDs to this resource, which did not already exist on it.\n+\t */\n+\tprivate void addCanonicalEidsToGoldenResourceIfAbsent(IBaseResource theGoldenResource, List<CanonicalEID> theIncomingTargetExternalEids) {\n+\t\tList<CanonicalEID> goldenResourceExternalEids = myEIDHelper.getExternalEid(theGoldenResource);\n+\n+\t\tfor (CanonicalEID incomingExternalEid : theIncomingTargetExternalEids) {\n+\t\t\tif (goldenResourceExternalEids.contains(incomingExternalEid)) {\n+\t\t\t\tcontinue;\n+\t\t\t} else {\n+\t\t\t\tcloneEidIntoResource(theGoldenResource, incomingExternalEid);\n+\t\t\t}\n+\t\t}\n+\t}\n+\n+\tprivate <T extends IBase> T toId(CanonicalEID eid) {\n+\t\tswitch (myFhirContext.getVersion().getVersion()) {\n+\t\t\tcase R4:\n+\t\t\t\treturn (T) eid.toR4();\n+\t\t\tcase DSTU3:\n+\t\t\t\treturn (T) eid.toDSTU3();\n+\t\t}\n+\t\tthrow new IllegalStateException(\"Unsupported FHIR version \" + myFhirContext.getVersion().getVersion());\n+\t}\n+\n+\n+\tprivate <T extends IBase> T toBooleanType(boolean theFlag) {\n+\t\tswitch (myFhirContext.getVersion().getVersion()) {\n+\t\t\tcase R4:\n+\t\t\t\treturn (T) new BooleanType(theFlag);\n+\t\t\tcase DSTU3:\n+\t\t\t\treturn (T) new org.hl7.fhir.dstu3.model.BooleanType(theFlag);\n+\t\t}\n+\t\tthrow new IllegalStateException(\"Unsupported FHIR version \" + myFhirContext.getVersion().getVersion());\n+\t}\n+\n+\tprivate <T extends IBase> boolean fromBooleanType(T theFlag) {\n+\t\tswitch (myFhirContext.getVersion().getVersion()) {\n+\t\t\tcase R4:\n+\t\t\t\treturn ((BooleanType) theFlag).booleanValue();\n+\t\t\tcase DSTU3:\n+\t\t\t\treturn ((org.hl7.fhir.dstu3.model.BooleanType) theFlag).booleanValue();\n+\t\t}\n+\t\tthrow new IllegalStateException(\"Unsupported FHIR version \" + myFhirContext.getVersion().getVersion());\n+\t}\n+\n+\tpublic void mergeFields(IBaseResource theFromGoldenResource, IBaseResource theToGoldenResource) {\n+\t\t//\tTODO NG - Revisit when merge rules are defined\n+\t\tcloneCompositeField(theFromGoldenResource, theToGoldenResource, FIELD_NAME_IDENTIFIER);\n+\n+//\t\tswitch (myFhirContext.getVersion().getVersion()) {\n+//\t\t\tcase R4:\n+//\t\t\t\tmergeR4PersonFields(theFromGoldenResource, theToGoldenResource);\n+//\t\t\t\tbreak;\n+//\t\t\tcase DSTU3:\n+//\t\t\t\tmergeDstu3PersonFields(theFromGoldenResource, theToGoldenResource);\n+//\t\t\t\tbreak;\n+//\t\t\tdefault:\n+//\t\t\t\tthrow new UnsupportedOperationException(\"Version not supported: \" + myFhirContext.getVersion().getVersion());\n+//\t\t}\n+\t}\n+\n+\t/**\n+\t * An incoming resource is a potential duplicate if it matches a target that has a golden resource with an official\n+\t * EID, but the incoming resource also has an EID that does not match.\n+\t */\n+\tpublic boolean isPotentialDuplicate(IAnyResource theExistingGoldenResource, IAnyResource theComparingGoldenResource) {\n+\t\tList<CanonicalEID> externalEidsGoldenResource = myEIDHelper.getExternalEid(theExistingGoldenResource);\n+\t\tList<CanonicalEID> externalEidsResource = myEIDHelper.getExternalEid(theComparingGoldenResource);\n+\t\treturn !externalEidsGoldenResource.isEmpty() && !externalEidsResource.isEmpty() && !myEIDHelper.eidMatchExists(externalEidsResource, externalEidsGoldenResource);\n+\t}\n+\n+\tprivate void log(MdmTransactionContext theMdmTransactionContext, String theMessage) {\n+\t\ttheMdmTransactionContext.addTransactionLogMessage(theMessage);\n+\t\tourLog.debug(theMessage);\n+\t}\n+\n+\tpublic void handleExternalEidAddition(IAnyResource theGoldenResource, IAnyResource theTargetResource, MdmTransactionContext\n+\t\ttheMdmTransactionContext) {\n+\t\tList<CanonicalEID> eidFromResource = myEIDHelper.getExternalEid(theTargetResource);\n+\t\tif (!eidFromResource.isEmpty()) {\n+\t\t\tupdateGoldenResourceExternalEidFromTargetResource(theGoldenResource, theTargetResource, theMdmTransactionContext);\n+\t\t}\n+\t}\n+\n+\tpublic void deactivateResource(IAnyResource theResource) {\n+\t\tMdmUtil.setGoldenResourceRedirected(theResource);\n+\t}\n+\n+\tpublic boolean isDeactivated(IBaseResource theGoldenResource) {\n+\t\treturn MdmUtil.isGoldenRecordRedirected(theGoldenResource);\n+\t}\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5f7f2df14f732c131b360087deaa0b4827b05b5"}, "originalPosition": 377}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3NTU3Mzk1OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-server-mdm/src/main/java/ca/uhn/fhir/mdm/util/MdmUtil.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxODoyMjozOVrOIA0RhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxODoyMjozOVrOIA0RhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzcyNzM2NQ==", "bodyText": "MdmResourceUtil?", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r537727365", "createdAt": "2020-12-07T18:22:39Z", "author": {"login": "fil512"}, "path": "hapi-fhir-server-mdm/src/main/java/ca/uhn/fhir/mdm/util/MdmUtil.java", "diffHunk": "@@ -0,0 +1,129 @@\n+package ca.uhn.fhir.mdm.util;\n+\n+/*-\n+ * #%L\n+ * HAPI FHIR - Master Data Management\n+ * %%\n+ * Copyright (C) 2014 - 2020 University Health Network\n+ * %%\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * #L%\n+ */\n+\n+import ca.uhn.fhir.mdm.api.MdmConstants;\n+import org.hl7.fhir.instance.model.api.IBaseCoding;\n+import org.hl7.fhir.instance.model.api.IBaseResource;\n+\n+import javax.annotation.Nonnull;\n+import java.util.Optional;\n+\n+public final class MdmUtil {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5f7f2df14f732c131b360087deaa0b4827b05b5"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3NTU3NzQ5OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-server-mdm/src/main/java/ca/uhn/fhir/mdm/util/PrimitiveTypeComparingPredicate.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxODoyMzozM1rOIA0Tqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxODoyMzozM1rOIA0Tqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzcyNzkxNQ==", "bodyText": "nitpick: rename to PrimitiveTypeEqualsPredicate", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r537727915", "createdAt": "2020-12-07T18:23:33Z", "author": {"login": "fil512"}, "path": "hapi-fhir-server-mdm/src/main/java/ca/uhn/fhir/mdm/util/PrimitiveTypeComparingPredicate.java", "diffHunk": "@@ -0,0 +1,87 @@\n+package ca.uhn.fhir.mdm.util;\n+\n+/*-\n+ * #%L\n+ * HAPI FHIR - Master Data Management\n+ * %%\n+ * Copyright (C) 2014 - 2020 University Health Network\n+ * %%\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * #L%\n+ */\n+\n+import org.hl7.fhir.instance.model.api.IPrimitiveType;\n+\n+import java.lang.reflect.Field;\n+import java.util.function.BiPredicate;\n+\n+public class PrimitiveTypeComparingPredicate implements BiPredicate {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5f7f2df14f732c131b360087deaa0b4827b05b5"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3NTU4ODU5OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-server-mdm/src/test/java/ca/uhn/fhir/mdm/util/PrimitiveTypeComparingPredicateTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxODoyNjowNVrOIA0aFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxODoyNjowNVrOIA0aFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzcyOTU1OA==", "bodyText": "why is there a Patient patient?", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r537729558", "createdAt": "2020-12-07T18:26:05Z", "author": {"login": "fil512"}, "path": "hapi-fhir-server-mdm/src/test/java/ca/uhn/fhir/mdm/util/PrimitiveTypeComparingPredicateTest.java", "diffHunk": "@@ -0,0 +1,104 @@\n+package ca.uhn.fhir.mdm.util;\n+\n+import ca.uhn.fhir.context.FhirContext;\n+import ca.uhn.fhir.util.FhirTerser;\n+import org.hl7.fhir.instance.model.api.IBase;\n+import org.hl7.fhir.r4.model.Address;\n+import org.hl7.fhir.r4.model.BooleanType;\n+import org.hl7.fhir.r4.model.DateType;\n+import org.hl7.fhir.r4.model.Enumerations;\n+import org.hl7.fhir.r4.model.Identifier;\n+import org.hl7.fhir.r4.model.Patient;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+\n+import java.util.Collections;\n+\n+import static org.junit.jupiter.api.Assertions.assertFalse;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+class PrimitiveTypeComparingPredicateTest {\n+\n+\tprivate static FhirContext myFhirContext;\n+\n+\tprivate FhirTerser myTerser;\n+\n+\tprivate IBase myPositiveTest1;\n+\n+\tprivate IBase myPositiveTest2;\n+\n+\tprivate IBase myPositiveTest3;\n+\n+\tprivate IBase myNegativeTest;\n+\n+\tprivate PrimitiveTypeComparingPredicate cut = new PrimitiveTypeComparingPredicate();\n+\n+\t@BeforeAll\n+\tpublic static void initContext() {\n+\t\tmyFhirContext = FhirContext.forR4();\n+\t}\n+\n+\t@BeforeEach\n+\tpublic void init() {\n+\t\tmyTerser = myFhirContext.newTerser();\n+\n+\t\tmyPositiveTest1 = newPatient();\n+\t\tmyPositiveTest2 = newPatient();\n+\t\tmyPositiveTest3 = newPatient();\n+\n+\t\tPatient patient = newPatient();\n+\t\tpatient.setActive(false);\n+\t\tpatient.setMultipleBirth(new BooleanType(false));\n+\t\tmyNegativeTest = patient;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5f7f2df14f732c131b360087deaa0b4827b05b5"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3NTYwMzk2OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-server-mdm/src/test/java/ca/uhn/fhir/mdm/util/PrimitiveTypeComparingPredicateTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxODoyOTozM1rOIA0jRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxODoyOTozM1rOIA0jRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzczMTkwOQ==", "bodyText": "Nitpick: This test is misleading.  It's not testing transitivity.  It's just testing that three identical resources are all equal to each other.  It doesn't do anything beyond testing that assertTrue(cut.test(myPositiveTest1, myPositiveTest2));", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r537731909", "createdAt": "2020-12-07T18:29:33Z", "author": {"login": "fil512"}, "path": "hapi-fhir-server-mdm/src/test/java/ca/uhn/fhir/mdm/util/PrimitiveTypeComparingPredicateTest.java", "diffHunk": "@@ -0,0 +1,104 @@\n+package ca.uhn.fhir.mdm.util;\n+\n+import ca.uhn.fhir.context.FhirContext;\n+import ca.uhn.fhir.util.FhirTerser;\n+import org.hl7.fhir.instance.model.api.IBase;\n+import org.hl7.fhir.r4.model.Address;\n+import org.hl7.fhir.r4.model.BooleanType;\n+import org.hl7.fhir.r4.model.DateType;\n+import org.hl7.fhir.r4.model.Enumerations;\n+import org.hl7.fhir.r4.model.Identifier;\n+import org.hl7.fhir.r4.model.Patient;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+\n+import java.util.Collections;\n+\n+import static org.junit.jupiter.api.Assertions.assertFalse;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+class PrimitiveTypeComparingPredicateTest {\n+\n+\tprivate static FhirContext myFhirContext;\n+\n+\tprivate FhirTerser myTerser;\n+\n+\tprivate IBase myPositiveTest1;\n+\n+\tprivate IBase myPositiveTest2;\n+\n+\tprivate IBase myPositiveTest3;\n+\n+\tprivate IBase myNegativeTest;\n+\n+\tprivate PrimitiveTypeComparingPredicate cut = new PrimitiveTypeComparingPredicate();\n+\n+\t@BeforeAll\n+\tpublic static void initContext() {\n+\t\tmyFhirContext = FhirContext.forR4();\n+\t}\n+\n+\t@BeforeEach\n+\tpublic void init() {\n+\t\tmyTerser = myFhirContext.newTerser();\n+\n+\t\tmyPositiveTest1 = newPatient();\n+\t\tmyPositiveTest2 = newPatient();\n+\t\tmyPositiveTest3 = newPatient();\n+\n+\t\tPatient patient = newPatient();\n+\t\tpatient.setActive(false);\n+\t\tpatient.setMultipleBirth(new BooleanType(false));\n+\t\tmyNegativeTest = patient;\n+\t}\n+\n+\tprivate Patient newPatient() {\n+\t\tPatient patient;\n+\t\tpatient = new Patient();\n+\t\tpatient.setActive(true);\n+\t\tpatient.setGender(Enumerations.AdministrativeGender.FEMALE);\n+\t\tpatient.setBirthDateElement(new DateType(\"1901-01-01\"));\n+\n+\t\tAddress address = new Address();\n+\t\taddress.addLine(\"Somwhere\");\n+\t\taddress.setCity(\"Toronto\");\n+\t\taddress.setCountry(\"Canada\");\n+\t\tpatient.setAddress(Collections.singletonList(address));\n+\t\treturn patient;\n+\t}\n+\n+\t@Test\n+\tpublic void testNegativeMatchOnTheSameType() {\n+\t\tassertFalse(cut.test(myPositiveTest1, myNegativeTest));\n+\t\tassertFalse(cut.test(myNegativeTest, myPositiveTest1));\n+\t}\n+\n+\t@Test\n+\tpublic void testNegativeMatchOnDifferentTypes() {\n+\t\tPatient patient = newPatient();\n+\t\tIdentifier identifier = patient.addIdentifier();\n+\t\tidentifier.setValue(\"TEST_VALUE\");\n+\t\tassertFalse(cut.test(myNegativeTest, identifier));\n+\t}\n+\n+\t@Test\n+\tpublic void testSymmetry() {\n+\t\tassertTrue(cut.test(myPositiveTest1, myPositiveTest2));\n+\t\tassertTrue(cut.test(myPositiveTest2, myPositiveTest1));\n+\t}\n+\n+\t@Test\n+\tpublic void testReflexivity() {\n+\t\tassertTrue(cut.test(myPositiveTest1, myPositiveTest1));\n+\t}\n+\n+\t@Test\n+\tpublic void testTransitivity() {\n+\t\tassertTrue(cut.test(myPositiveTest1, myPositiveTest2));\n+\t\tassertTrue(cut.test(myPositiveTest2, myPositiveTest3));\n+\t\tassertTrue(cut.test(myPositiveTest1, myPositiveTest3));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5f7f2df14f732c131b360087deaa0b4827b05b5"}, "originalPosition": 100}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3NTYxMDg3OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-server-mdm/src/main/java/ca/uhn/fhir/mdm/util/GoldenResourceHelper.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxODozMToxM1rOIA0nZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxODozMToxM1rOIA0nZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzczMjk2NA==", "bodyText": "This is really nice!  Will be interesting to see how it evolves as we add survivability rules!", "url": "https://github.com/hapifhir/hapi-fhir/pull/2177#discussion_r537732964", "createdAt": "2020-12-07T18:31:13Z", "author": {"login": "fil512"}, "path": "hapi-fhir-server-mdm/src/main/java/ca/uhn/fhir/mdm/util/GoldenResourceHelper.java", "diffHunk": "@@ -0,0 +1,377 @@\n+package ca.uhn.fhir.mdm.util;\n+\n+/*-\n+ * #%L\n+ * HAPI FHIR - Master Data Management\n+ * %%\n+ * Copyright (C) 2014 - 2020 University Health Network\n+ * %%\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * #L%\n+ */\n+\n+import ca.uhn.fhir.context.BaseRuntimeChildDefinition;\n+import ca.uhn.fhir.context.BaseRuntimeElementCompositeDefinition;\n+import ca.uhn.fhir.context.FhirContext;\n+import ca.uhn.fhir.context.FhirVersionEnum;\n+import ca.uhn.fhir.context.RuntimeResourceDefinition;\n+import ca.uhn.fhir.fhirpath.IFhirPath;\n+import ca.uhn.fhir.mdm.api.IMdmSettings;\n+import ca.uhn.fhir.mdm.log.Logs;\n+import ca.uhn.fhir.mdm.model.CanonicalEID;\n+import ca.uhn.fhir.mdm.model.MdmTransactionContext;\n+import ca.uhn.fhir.util.FhirTerser;\n+import org.hl7.fhir.instance.model.api.IAnyResource;\n+import org.hl7.fhir.instance.model.api.IBase;\n+import org.hl7.fhir.instance.model.api.IBaseResource;\n+import org.hl7.fhir.instance.model.api.IPrimitiveType;\n+import org.hl7.fhir.r4.model.BooleanType;\n+import org.slf4j.Logger;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+import static ca.uhn.fhir.context.FhirVersionEnum.DSTU3;\n+import static ca.uhn.fhir.context.FhirVersionEnum.R4;\n+\n+@Service\n+public class GoldenResourceHelper {\n+\n+\tprivate static final Logger ourLog = Logs.getMdmTroubleshootingLog();\n+\n+\tprivate static final String FIELD_NAME_IDENTIFIER = \"identifier\";\n+\n+\t@Autowired\n+\tprivate IMdmSettings myMdmSettings;\n+\t@Autowired\n+\tprivate EIDHelper myEIDHelper;\n+\n+\n+\tprivate final FhirContext myFhirContext;\n+\n+\t@Autowired\n+\tpublic GoldenResourceHelper(FhirContext theFhirContext) {\n+\t\tmyFhirContext = theFhirContext;\n+\t}\n+\n+\t/**\n+\t * Creates a copy of the specified resource. This method will carry over resource EID if it exists. If it does not exist,\n+\t * a randomly generated UUID EID will be created.\n+\t *\n+\t * @param <T>                 Supported MDM resource type (e.g. Patient, Practitioner)\n+\t * @param theIncomingResource The resource that will be used as the starting point for the MDM linking.\n+\t */\n+\tpublic <T extends IAnyResource> T createGoldenResourceFromMdmTarget(T theIncomingResource) {\n+\t\tvalidateContextSupported();\n+\n+\t\t// get a ref to the actual ID Field\n+\t\tRuntimeResourceDefinition resourceDefinition = myFhirContext.getResourceDefinition(theIncomingResource);\n+\t\tIBaseResource newGoldenResource = resourceDefinition.newInstance();\n+\n+\t\t// hapi has 2 metamodels: for children and types\n+\t\tBaseRuntimeChildDefinition goldenResourceIdentifier = resourceDefinition.getChildByName(FIELD_NAME_IDENTIFIER);\n+\n+\t\tcloneAllExternalEidsIntoNewGoldenResource(goldenResourceIdentifier, theIncomingResource, newGoldenResource);\n+\n+\t\taddHapiEidIfNoExternalEidIsPresent(newGoldenResource, goldenResourceIdentifier, theIncomingResource);\n+\n+\t\tMdmUtil.setMdmManaged(newGoldenResource);\n+\t\tMdmUtil.setGoldenResource(newGoldenResource);\n+\n+\t\treturn (T) newGoldenResource;\n+\t}\n+\n+\t/**\n+\t * If there are no external EIDs on the incoming resource, create a new HAPI EID on the new Golden Resource.\n+\t */\n+\t//TODO GGG ask james if there is any way we can convert this canonical EID into a generic STU-agnostic IBase.\n+\tprivate <T extends IAnyResource> void addHapiEidIfNoExternalEidIsPresent(\n+\t\tIBaseResource theNewGoldenResource, BaseRuntimeChildDefinition theGoldenResourceIdentifier, IAnyResource theTargetResource) {\n+\n+\t\tList<CanonicalEID> eidsToApply = myEIDHelper.getExternalEid(theNewGoldenResource);\n+\t\tif (!eidsToApply.isEmpty()) {\n+\t\t\treturn;\n+\t\t}\n+\n+\t\tCanonicalEID hapiEid = myEIDHelper.createHapiEid();\n+\t\ttheGoldenResourceIdentifier.getMutator().addValue(theNewGoldenResource, toId(hapiEid));\n+\n+\t\t// set identifier on the target resource\n+\t\tcloneEidIntoResource(theTargetResource, hapiEid);\n+\t}\n+\n+\tprivate void cloneEidIntoResource(IBaseResource theResourceToCloneInto, CanonicalEID theEid) {\n+\t\t// get a ref to the actual ID Field\n+\t\tRuntimeResourceDefinition resourceDefinition = myFhirContext.getResourceDefinition(theResourceToCloneInto);\n+\t\t// hapi has 2 metamodels: for children and types\n+\t\tBaseRuntimeChildDefinition resourceIdentifier = resourceDefinition.getChildByName(FIELD_NAME_IDENTIFIER);\n+\t\tcloneEidIntoResource(resourceIdentifier, toId(theEid), theResourceToCloneInto);\n+\t}\n+\n+\t/**\n+\t * Given an Child Definition of `identifier`, a R4/DSTU3 EID Identifier, and a new resource, clone the EID into that resources' identifier list.\n+\t */\n+\tprivate void cloneEidIntoResource(BaseRuntimeChildDefinition theIdentifierDefinition, IBase theEid, IBase theResourceToCloneEidInto) {\n+\t\t// FHIR choice types - fields within fhir where we have a choice of ids\n+\t\tBaseRuntimeElementCompositeDefinition<?> childIdentifier = (BaseRuntimeElementCompositeDefinition<?>) theIdentifierDefinition.getChildByName(FIELD_NAME_IDENTIFIER);\n+\t\tIBase resourceNewIdentifier = childIdentifier.newInstance();\n+\n+\t\tFhirTerser terser = myFhirContext.newTerser();\n+\t\tterser.cloneInto(theEid, resourceNewIdentifier, true);\n+\t\ttheIdentifierDefinition.getMutator().addValue(theResourceToCloneEidInto, resourceNewIdentifier);\n+\t}\n+\n+\t/**\n+\t * Clones specified composite field (collection). Composite field values must confirm to the collections\n+\t * contract.\n+\t *\n+\t * @param theFrom Resource to clone the specified filed from\n+\t * @param theTo   Resource to clone the specified filed to\n+\t * @param field   Field name to be copied\n+\t */\n+\tprivate void cloneCompositeField(IBaseResource theFrom, IBaseResource theTo, String field) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5f7f2df14f732c131b360087deaa0b4827b05b5"}, "originalPosition": 147}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1733, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}