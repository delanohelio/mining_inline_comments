{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIyMDY0Mzk1", "number": 1863, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNzo0NTozOFrOD_Bs3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQxNDo0NDoxOVrOD_aADg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3NDE0NzUwOnYy", "diffSide": "RIGHT", "path": "hapi-fhir-base/src/main/java/ca/uhn/fhir/interceptor/api/Pointcut.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNzo0NTozOFrOGZfHPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNzo0NTozOFrOGZfHPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM3NzM0MQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t * Invoked when a resource delete operation is about to fail due to referential integrity checks. Intended for use with ca.uhn.fhir.jpa.interceptor.CascadingDeleteInterceptor.\n          \n          \n            \n            \t * Invoked when a resource delete operation is about to fail due to referential integrity checks. Intended for use with {@literal ca.uhn.fhir.jpa.interceptor.CascadingDeleteInterceptor}.", "url": "https://github.com/hapifhir/hapi-fhir/pull/1863#discussion_r429377341", "createdAt": "2020-05-22T17:45:38Z", "author": {"login": "jamesagnew"}, "path": "hapi-fhir-base/src/main/java/ca/uhn/fhir/interceptor/api/Pointcut.java", "diffHunk": "@@ -1282,7 +1282,7 @@\n \n \t/**\n \t * <b>Storage Hook:</b>\n-\t * Invoked when a resource delete operation is about to fail due to referential integrity hcts.\n+\t * Invoked when a resource delete operation is about to fail due to referential integrity checks. Intended for use with ca.uhn.fhir.jpa.interceptor.CascadingDeleteInterceptor.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b501a601b73f1f54e9cfc07054638d6bd605b1d1"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3NDE0ODU4OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-api/src/main/java/ca/uhn/fhir/jpa/api/config/DaoConfig.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNzo0NTo1OVrOGZfH7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNzo0NTo1OVrOGZfH7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM3NzUxNw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t * @since 4.1.0\n          \n          \n            \n            \t * @since 5.1.0", "url": "https://github.com/hapifhir/hapi-fhir/pull/1863#discussion_r429377517", "createdAt": "2020-05-22T17:45:59Z", "author": {"login": "jamesagnew"}, "path": "hapi-fhir-jpaserver-api/src/main/java/ca/uhn/fhir/jpa/api/config/DaoConfig.java", "diffHunk": "@@ -2021,4 +2026,33 @@ public boolean isStoreRequestId() {\n \t\t */\n \t\tANY\n \t}\n+\n+\t/**\n+\t * <p>\n+\t * This determines the maximum number of conflicts that should be fetched and handled while retrying a delete of a resource.\n+\t * </p>\n+\t * <p>\n+\t * The default value for this setting is {@code 60}.\n+\t * </p>\n+\t *\n+\t * @since 4.1.0", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b501a601b73f1f54e9cfc07054638d6bd605b1d1"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3NDE0ODg5OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-api/src/main/java/ca/uhn/fhir/jpa/api/config/DaoConfig.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNzo0NjowN1rOGZfIIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNzo0NjowN1rOGZfIIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM3NzU2OA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t * @since 4.1.0\n          \n          \n            \n            \t * @since 5.1.0", "url": "https://github.com/hapifhir/hapi-fhir/pull/1863#discussion_r429377568", "createdAt": "2020-05-22T17:46:07Z", "author": {"login": "jamesagnew"}, "path": "hapi-fhir-jpaserver-api/src/main/java/ca/uhn/fhir/jpa/api/config/DaoConfig.java", "diffHunk": "@@ -2021,4 +2026,33 @@ public boolean isStoreRequestId() {\n \t\t */\n \t\tANY\n \t}\n+\n+\t/**\n+\t * <p>\n+\t * This determines the maximum number of conflicts that should be fetched and handled while retrying a delete of a resource.\n+\t * </p>\n+\t * <p>\n+\t * The default value for this setting is {@code 60}.\n+\t * </p>\n+\t *\n+\t * @since 4.1.0\n+\t */\n+\tpublic Integer getMaximumDeleteConflictQueryCount() {\n+\t\treturn myMaximumDeleteConflictQueryCount;\n+\t}\n+\n+\t/**\n+\t * <p>\n+\t * This determines the maximum number of conflicts that should be fetched and handled while retrying a delete of a resource.\n+\t * </p>\n+\t * <p>\n+\t * The default value for this setting is {@code 60}.\n+\t * </p>\n+\t *\n+\t * @since 4.1.0", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b501a601b73f1f54e9cfc07054638d6bd605b1d1"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3ODEyODc4OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/delete/DeleteConflictService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQxNDo0NDoxOVrOGaDYBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQxNDo1Nzo0NFrOGaDwdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTk3MTQ2MA==", "bodyText": "shouldn't this use the new config param?", "url": "https://github.com/hapifhir/hapi-fhir/pull/1863#discussion_r429971460", "createdAt": "2020-05-25T14:44:19Z", "author": {"login": "fil512"}, "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/delete/DeleteConflictService.java", "diffHunk": "@@ -81,11 +81,16 @@ public int validateOkToDelete(DeleteConflictList theDeleteConflicts, ResourceTab\n \t\twhile (outcome != null) {\n \t\t\tint shouldRetryCount = Math.min(outcome.getShouldRetryCount(), MAX_RETRY_ATTEMPTS);\n \t\t\tif (!(retryCount < shouldRetryCount)) break;\n-\t\t\tnewConflicts = new DeleteConflictList();\n-\t\t\toutcome = findAndHandleConflicts(theRequest, newConflicts, theEntity, theForValidate, RETRY_QUERY_RESULT_COUNT, theTransactionDetails);\n+\t\t\tnewConflicts = new DeleteConflictList(newConflicts);\n+\t\t\toutcome = findAndHandleConflicts(theRequest, newConflicts, theEntity, theForValidate, myDaoConfig.getMaximumDeleteConflictQueryCount(), theTransactionDetails);\n \t\t\t++retryCount;\n \t\t}\n \t\ttheDeleteConflicts.addAll(newConflicts);\n+\t\tif(retryCount >= MAX_RETRY_ATTEMPTS && !theDeleteConflicts.isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a1a3d9de38591dcb999cd9154bd181e5098236c4"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTk3NzcxOA==", "bodyText": "No. Only the RETRY_QUERY_RESULT_COUNT was made configurable and the RETRY_QUERY_RESULT_COUNT parameter was only being used to determine the number of delete conflicts to process during each retry. This condition is determining essentially whether the previous loop exhausted all of the available retries, the number of which is determined by the static MAX_RETRY_ATTEMPTS parameter.", "url": "https://github.com/hapifhir/hapi-fhir/pull/1863#discussion_r429977718", "createdAt": "2020-05-25T14:57:44Z", "author": {"login": "IanMMarshall"}, "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/delete/DeleteConflictService.java", "diffHunk": "@@ -81,11 +81,16 @@ public int validateOkToDelete(DeleteConflictList theDeleteConflicts, ResourceTab\n \t\twhile (outcome != null) {\n \t\t\tint shouldRetryCount = Math.min(outcome.getShouldRetryCount(), MAX_RETRY_ATTEMPTS);\n \t\t\tif (!(retryCount < shouldRetryCount)) break;\n-\t\t\tnewConflicts = new DeleteConflictList();\n-\t\t\toutcome = findAndHandleConflicts(theRequest, newConflicts, theEntity, theForValidate, RETRY_QUERY_RESULT_COUNT, theTransactionDetails);\n+\t\t\tnewConflicts = new DeleteConflictList(newConflicts);\n+\t\t\toutcome = findAndHandleConflicts(theRequest, newConflicts, theEntity, theForValidate, myDaoConfig.getMaximumDeleteConflictQueryCount(), theTransactionDetails);\n \t\t\t++retryCount;\n \t\t}\n \t\ttheDeleteConflicts.addAll(newConflicts);\n+\t\tif(retryCount >= MAX_RETRY_ATTEMPTS && !theDeleteConflicts.isEmpty()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTk3MTQ2MA=="}, "originalCommit": {"oid": "a1a3d9de38591dcb999cd9154bd181e5098236c4"}, "originalPosition": 36}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1835, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}