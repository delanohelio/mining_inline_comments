{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEwNzI3MDg2", "number": 1821, "title": "Multitenancy Ticket 2 -  #1813", "bodyText": "", "createdAt": "2020-04-29T13:51:13Z", "url": "https://github.com/hapifhir/hapi-fhir/pull/1821", "merged": true, "mergeCommit": {"oid": "a77aa6a28e32b9d1ef4bb26249bfb42f4d42d329"}, "closed": true, "closedAt": "2020-05-05T19:12:16Z", "author": {"login": "jamesagnew"}, "timelineItems": {"totalCount": 45, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcacsfXgH2gAyNDEwNzI3MDg2OmI3NGNkMDVlMDNhNzllOWJmMjE1NzE5ZTVmYTFhYWJhM2JhMzRjYzg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABceXsCwAH2gAyNDEwNzI3MDg2OmM5MzU5NmY4YTQ2MGNkZGVmZGRmYzM1NDExNGE0OGM2Njc2ZmZmYzU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b74cd05e03a79e9bf215719e5fa1aaba3ba34cc8", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/b74cd05e03a79e9bf215719e5fa1aaba3ba34cc8", "committedDate": "2020-04-23T13:14:03Z", "message": "Merge branch 'master' into ja_20200423_multitenancy_2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92efd1ea92a18944bc0efa9c774258da8a3c465c", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/92efd1ea92a18944bc0efa9c774258da8a3c465c", "committedDate": "2020-04-23T13:52:27Z", "message": "Work on multitenancy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c34b0d2a81aa33541c8ebdfcfc602e559ad0e3c7", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/c34b0d2a81aa33541c8ebdfcfc602e559ad0e3c7", "committedDate": "2020-04-23T22:02:40Z", "message": "Second ticket started"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e92184bf74c7184c15fc48fe5dc4f8888d30fbb1", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/e92184bf74c7184c15fc48fe5dc4f8888d30fbb1", "committedDate": "2020-04-24T15:47:45Z", "message": "Merge branch 'master' into ja_20200423_multitenancy_2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d980a813fb1f309aee59e35ea2d82dad20eb3b7", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/8d980a813fb1f309aee59e35ea2d82dad20eb3b7", "committedDate": "2020-04-25T23:51:18Z", "message": "More multitenancy work"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59ec0eaf784a5eb8095dc0aafeb4ce872e8ef0af", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/59ec0eaf784a5eb8095dc0aafeb4ce872e8ef0af", "committedDate": "2020-04-26T17:55:08Z", "message": "Work on tenancy security"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f80a9af1c407cf18d3cdea2334eedeaf933c2b4", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/1f80a9af1c407cf18d3cdea2334eedeaf933c2b4", "committedDate": "2020-04-29T13:02:29Z", "message": "Work on multitenancy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d83a04cfb0ad4e1b3da39820abc6fc7d445bc71", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/7d83a04cfb0ad4e1b3da39820abc6fc7d445bc71", "committedDate": "2020-04-29T13:25:56Z", "message": "Merge branch 'master' into ja_20200423_multitenancy_2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee5fa2805b8880fd77be6b770be4fb091714f82b", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/ee5fa2805b8880fd77be6b770be4fb091714f82b", "committedDate": "2020-04-29T13:48:26Z", "message": "Test fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26b4d9af5a27be4b4d226f01348445eff2c15f90", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/26b4d9af5a27be4b4d226f01348445eff2c15f90", "committedDate": "2020-04-29T13:50:14Z", "message": "Add docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd03802837983335bb55c0476307ce76c949d02f", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/bd03802837983335bb55c0476307ce76c949d02f", "committedDate": "2020-04-29T13:53:04Z", "message": "cs tweak"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ea93c0d2db5f06d51503ad2a7b057365df3a9fb", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/1ea93c0d2db5f06d51503ad2a7b057365df3a9fb", "committedDate": "2020-04-29T14:19:37Z", "message": "Multitenancy fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d54be2669c35b18e18739ef80ebd8275abd42cb4", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/d54be2669c35b18e18739ef80ebd8275abd42cb4", "committedDate": "2020-04-29T14:42:08Z", "message": "Add debug log"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "72d6e75a40976e1584ceeef1d1fe07afa49d0928", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/72d6e75a40976e1584ceeef1d1fe07afa49d0928", "committedDate": "2020-04-29T16:50:18Z", "message": "Fix build"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a329440fa804c010dfef6c21e7f05deccc48fa6", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/0a329440fa804c010dfef6c21e7f05deccc48fa6", "committedDate": "2020-04-29T16:50:29Z", "message": "Merge branch 'ja_20200423_multitenancy_2' of github.com:jamesagnew/hapi-fhir into ja_20200423_multitenancy_2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85ed2b3fc10a02f543a87c36137ce143f1109b19", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/85ed2b3fc10a02f543a87c36137ce143f1109b19", "committedDate": "2020-04-29T16:50:47Z", "message": "Add headers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69bb7d1ab9c1b8da31a2c44ae884ddf725746758", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/69bb7d1ab9c1b8da31a2c44ae884ddf725746758", "committedDate": "2020-04-29T16:50:52Z", "message": "Merge branch 'ja_20200423_multitenancy_2' of github.com:jamesagnew/hapi-fhir into ja_20200423_multitenancy_2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a82518eb48c09e505d15473393c69e581f665879", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/a82518eb48c09e505d15473393c69e581f665879", "committedDate": "2020-04-29T22:27:42Z", "message": "Add partition selection interceptor hook"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzNTk0MzM5", "url": "https://github.com/hapifhir/hapi-fhir/pull/1821#pullrequestreview-403594339", "createdAt": "2020-04-30T14:47:51Z", "commit": {"oid": "a82518eb48c09e505d15473393c69e581f665879"}, "state": "APPROVED", "comments": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxNDo0Nzo1MVrOGOsy-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxNjoyOTo1NFrOGOxGYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA2NzE5NQ==", "bodyText": "I think this is a kind of request, not a kind of partition id, so I'd go with \"PartitionIdRequest\".", "url": "https://github.com/hapifhir/hapi-fhir/pull/1821#discussion_r418067195", "createdAt": "2020-04-30T14:47:51Z", "author": {"login": "fil512"}, "path": "hapi-fhir-base/src/main/java/ca/uhn/fhir/interceptor/model/RequestPartitionId.java", "diffHunk": "@@ -26,35 +26,57 @@\n \n import static org.apache.commons.lang3.ObjectUtils.defaultIfNull;\n \n+/**\n+ * @since 5.0.0\n+ */\n public class RequestPartitionId {\n \n-\tprivate final Integer myPartitionId;\n+\tprivate static final RequestPartitionId ALL_PARTITIONS = new RequestPartitionId();\n \tprivate final LocalDate myPartitionDate;\n+\tprivate final boolean myAllPartitions;\n+\tprivate final Integer myPartitionId;\n \tprivate final String myPartitionName;\n \n \t/**\n-\t * Constructor\n+\t * Constructor for a single partition\n \t */\n \tprivate RequestPartitionId(@Nullable String thePartitionName, @Nullable Integer thePartitionId, @Nullable LocalDate thePartitionDate) {\n-\t\tmyPartitionName = thePartitionName;\n \t\tmyPartitionId = thePartitionId;\n+\t\tmyPartitionName = thePartitionName;\n \t\tmyPartitionDate = thePartitionDate;\n+\t\tmyAllPartitions = false;\n \t}\n \n-\tpublic String getPartitionName() {\n-\t\treturn myPartitionName;\n+\t/**\n+\t * Constructor for all partitions\n+\t */\n+\tprivate RequestPartitionId() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a82518eb48c09e505d15473393c69e581f665879"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA3NDQyOQ==", "bodyText": "nitpick: I used to write it this way, but I think it's not obvious what it's doing.  Even though it's more code, I think it's clearer to write:\nif (myPartitionId == null) {\n  return \"null\"\n}\nreturn myPartitionId.toString();", "url": "https://github.com/hapifhir/hapi-fhir/pull/1821#discussion_r418074429", "createdAt": "2020-04-30T14:57:38Z", "author": {"login": "fil512"}, "path": "hapi-fhir-base/src/main/java/ca/uhn/fhir/interceptor/model/RequestPartitionId.java", "diffHunk": "@@ -64,7 +86,17 @@ public String toString() {\n \t * Returns the partition ID (numeric) as a string, or the string \"null\"\n \t */\n \tpublic String getPartitionIdStringOrNullString() {\n-\t\treturn defaultIfNull(myPartitionId, \"null\").toString();\n+\t\treturn defaultIfNull(getPartitionId(), \"null\").toString();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a82518eb48c09e505d15473393c69e581f665879"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA3NjQ3Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t * key will be of type {@link ca.uhn.fhir.interceptor.model.PersistedPartitionId}.\n          \n          \n            \n            \t * key will be of type {@link ca.uhn.fhir.interceptor.model.RequestPartitionId}.", "url": "https://github.com/hapifhir/hapi-fhir/pull/1821#discussion_r418076476", "createdAt": "2020-04-30T15:00:14Z", "author": {"login": "fil512"}, "path": "hapi-fhir-base/src/main/java/ca/uhn/fhir/rest/api/Constants.java", "diffHunk": "@@ -264,6 +264,13 @@\n \tpublic static final String PARAM_FHIRPATH = \"_fhirpath\";\n \tpublic static final String PARAM_TYPE = \"_type\";\n \n+\t/**\n+\t * {@link org.hl7.fhir.instance.model.api.IBaseResource#getUserData(String) User metadata key} used\n+\t * to store the partition ID (if any) associated with the given resource. Value for this\n+\t * key will be of type {@link ca.uhn.fhir.interceptor.model.PersistedPartitionId}.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a82518eb48c09e505d15473393c69e581f665879"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA3ODM5OA==", "bodyText": "rather than static, why not make it an instance method?  (default method since it's an interface)", "url": "https://github.com/hapifhir/hapi-fhir/pull/1821#discussion_r418078398", "createdAt": "2020-04-30T15:03:01Z", "author": {"login": "fil512"}, "path": "hapi-fhir-base/src/main/java/org/hl7/fhir/instance/model/api/IPrimitiveType.java", "diffHunk": "@@ -33,5 +33,9 @@\n \tboolean hasValue();\n \t\n \tIPrimitiveType<T> setValue(T theValue) throws IllegalArgumentException;\n-\t\n+\n+\tstatic <T> T toValueOrNull(IPrimitiveType<T> thePrimitiveType) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a82518eb48c09e505d15473393c69e581f665879"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA4Mjc4OQ==", "bodyText": "This looks risky.  What if I have a tenantId that is the same name as a legit path?  Is there some other way in the request we can track whether the tenandId has been appended?  (e.g. in a custom header)", "url": "https://github.com/hapifhir/hapi-fhir/pull/1821#discussion_r418082789", "createdAt": "2020-04-30T15:09:09Z", "author": {"login": "fil512"}, "path": "hapi-fhir-client/src/main/java/ca/uhn/fhir/rest/client/interceptor/UrlTenantSelectionInterceptor.java", "diffHunk": "@@ -81,6 +81,10 @@ public void request(IRestfulClient theClient, IHttpRequest theRequest) {\n \n \t\tValidate.isTrue(requestUri.startsWith(serverBase), \"Request URI %s does not start with server base %s\", requestUri, serverBase);\n \n+\t\tif (requestUri.startsWith(serverBase + \"/\" + tenantId)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a82518eb48c09e505d15473393c69e581f665879"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA4NTc5OA==", "bodyText": "This SNIPPET stuff is so incredibly awesome!", "url": "https://github.com/hapifhir/hapi-fhir/pull/1821#discussion_r418085798", "createdAt": "2020-04-30T15:13:18Z", "author": {"login": "fil512"}, "path": "hapi-fhir-docs/src/main/java/ca/uhn/hapi/fhir/docs/ClientExamples.java", "diffHunk": "@@ -60,6 +61,29 @@ public void createProxy() {\n       // END SNIPPET: proxy\n    }\n \n+\n+   public void tenantId() {\n+   \t// START SNIPPET: tenantId", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a82518eb48c09e505d15473393c69e581f665879"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA4ODIzNA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\tPatient patientB = genericClient.read().resource(Patient.class).withId(\"123\").execute();\n          \n          \n            \n            \t\tPatient patientB = genericClient.read().resource(Patient.class).withId(\"456\").execute();\n          \n      \n    \n    \n  \n\nI'm worried people might get the impression you can have the same id in different partitions.", "url": "https://github.com/hapifhir/hapi-fhir/pull/1821#discussion_r418088234", "createdAt": "2020-04-30T15:16:52Z", "author": {"login": "fil512"}, "path": "hapi-fhir-docs/src/main/java/ca/uhn/hapi/fhir/docs/ClientExamples.java", "diffHunk": "@@ -60,6 +61,29 @@ public void createProxy() {\n       // END SNIPPET: proxy\n    }\n \n+\n+   public void tenantId() {\n+   \t// START SNIPPET: tenantId\n+\t\tFhirContext ctx = FhirContext.forR4();\n+\n+\t\t// Create the client\n+\t\tIGenericClient genericClient = ctx.newRestfulGenericClient(\"http://localhost:9999/fhir\");\n+\n+\t\t// Register the interceptor\n+\t\tUrlTenantSelectionInterceptor tenantSelection = new UrlTenantSelectionInterceptor();\n+\t\tgenericClient.registerInterceptor(tenantSelection);\n+\n+\t\t// Read from tenant A\n+\t\ttenantSelection.setTenantId(\"TENANT-A\");\n+\t\tPatient patientA = genericClient.read().resource(Patient.class).withId(\"123\").execute();\n+\n+\t\t// Read from tenant B\n+\t\ttenantSelection.setTenantId(\"TENANT-B\");\n+\t\tPatient patientB = genericClient.read().resource(Patient.class).withId(\"123\").execute();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a82518eb48c09e505d15473393c69e581f665879"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA5MTQ5MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            In this kind of scenario, we want to look up the Patient record and reference it from the newly created observation. In the event that no Patient record already exists with the given identifier, a new one will be created and the Observation will reference it. This is known in FHIR as a [Conditional Create](http://hl7.org/fhir/http.html#ccreate).\n          \n          \n            \n            In this scenario, we want to look up the Patient record and reference it from the newly created Observation. In the event that no Patient record already exists with the given identifier, a new one will be created and the Observation will reference it. This is known in FHIR as a [Conditional Create](http://hl7.org/fhir/http.html#ccreate).", "url": "https://github.com/hapifhir/hapi-fhir/pull/1821#discussion_r418091490", "createdAt": "2020-04-30T15:21:36Z", "author": {"login": "fil512"}, "path": "hapi-fhir-docs/src/main/resources/ca/uhn/hapi/fhir/docs/client/examples.md", "diffHunk": "@@ -2,79 +2,63 @@\n \n This page contains examples of how to use the client to perform complete tasks. If you have an example you could contribute, we'd love to hear from you!\n \n-# Transaction With Placeholder IDs\n+# Transaction With Conditional Create\n \n-The following example shows how to post a transaction with two resources, where one resource contains a reference to the other. A temporary ID (a UUID) is used as an ID to refer to, and this ID will be replaced by the server by\ta permanent ID.\n+The following example demonstrates a common scenario: How to create a new piece of data for a Patient (in this case, an Observation) where the identifier of the Patient is known, but the ID is not.\n \n-```java\n-{{snippet:classpath:/ca/uhn/hapi/fhir/docs/ClientTransactionExamples.java|conditional}}\n-```\n+In this kind of scenario, we want to look up the Patient record and reference it from the newly created observation. In the event that no Patient record already exists with the given identifier, a new one will be created and the Observation will reference it. This is known in FHIR as a [Conditional Create](http://hl7.org/fhir/http.html#ccreate).", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a82518eb48c09e505d15473393c69e581f665879"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA5Mjg5Nw==", "bodyText": "General question not related to this line: Do you handle the case where an update operation changes the partition id of the resource?", "url": "https://github.com/hapifhir/hapi-fhir/pull/1821#discussion_r418092897", "createdAt": "2020-04-30T15:23:33Z", "author": {"login": "fil512"}, "path": "hapi-fhir-docs/src/main/resources/ca/uhn/hapi/fhir/docs/server_jpa/partitioning.md", "diffHunk": "@@ -328,5 +328,7 @@ None of the limitations listed here are considered permanent. Over time the HAPI\n    * ConceptMap\n \n * **Search Parameters are not partitioned**: There is only one set of SearchParameter resources for the entire system, and any search parameters will apply to resources in all partitions. All SearchParameter resources must be stored in the default partition.\n+\n+* **Cross-partition History Operations are not supported**: It is not possible to perform a `_history` operation that spans all partitions (`_history` does work when applied to a single partition however). ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a82518eb48c09e505d15473393c69e581f665879"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA5NDQ0Mg==", "bodyText": "gurgle", "url": "https://github.com/hapifhir/hapi-fhir/pull/1821#discussion_r418094442", "createdAt": "2020-04-30T15:25:40Z", "author": {"login": "fil512"}, "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/data/IResourceHistoryTableDao.java", "diffHunk": "@@ -35,36 +35,37 @@\n \n public interface IResourceHistoryTableDao extends JpaRepository<ResourceHistoryTable, Long> {\n \n-\t@Query(\"SELECT COUNT(*) FROM ResourceHistoryTable t WHERE t.myUpdated >= :cutoff\")\n-\tint countForAllResourceTypes(\n-\t\t@Temporal(value = TemporalType.TIMESTAMP) @Param(\"cutoff\") Date theCutoff\n-\t);\n-\n-\t@Query(\"SELECT COUNT(*) FROM ResourceHistoryTable t\")\n-\tint countForAllResourceTypes(\n-\t);\n-\n-\t@Query(\"SELECT COUNT(*) FROM ResourceHistoryTable t WHERE t.myResourceId = :id AND t.myUpdated >= :cutoff\")\n-\tint countForResourceInstance(\n-\t\t@Param(\"id\") Long theId,\n-\t\t@Temporal(value = TemporalType.TIMESTAMP) @Param(\"cutoff\") Date theCutoff\n-\t);\n-\n-\t@Query(\"SELECT COUNT(*) FROM ResourceHistoryTable t WHERE t.myResourceId = :id\")\n-\tint countForResourceInstance(\n-\t\t@Param(\"id\") Long theId\n-\t);\n-\n-\t@Query(\"SELECT COUNT(*) FROM ResourceHistoryTable t WHERE t.myResourceType = :type AND t.myUpdated >= :cutoff\")\n-\tint countForResourceType(\n-\t\t@Param(\"type\") String theType,\n-\t\t@Temporal(value = TemporalType.TIMESTAMP) @Param(\"cutoff\") Date theCutoff\n-\t);\n-\n-\t@Query(\"SELECT COUNT(*) FROM ResourceHistoryTable t WHERE t.myResourceType = :type\")\n-\tint countForResourceType(\n-\t\t@Param(\"type\") String theType\n-\t);\n+\t// FIXME: remove commented", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a82518eb48c09e505d15473393c69e581f665879"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA5OTQyNg==", "bodyText": "Nice.  This is a really elegant way to manage this cache.", "url": "https://github.com/hapifhir/hapi-fhir/pull/1821#discussion_r418099426", "createdAt": "2020-04-30T15:32:41Z", "author": {"login": "fil512"}, "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/index/IdHelperService.java", "diffHunk": "@@ -389,6 +385,36 @@ public void clearCache() {\n \t\t\t.build();\n \t}\n \n+\tpublic Map<Long, Optional<String>> translatePidsToForcedIds(Set<Long> thePids) {\n+\t\tMap<Long, Optional<String>> retVal = new HashMap<>(myForcedIdCache.getAllPresent(thePids));\n+\n+\t\tList<Long> remainingPids = thePids\n+\t\t\t.stream()\n+\t\t\t.filter(t -> !retVal.containsKey(t))\n+\t\t\t.collect(Collectors.toList());\n+\n+\t\tnew QueryChunker<Long>().chunk(remainingPids, t->{\n+\t\t\tList<ForcedId> forcedIds = myForcedIdDao.findAllById(t);\n+\t\t\tfor (ForcedId forcedId : forcedIds) {\n+\t\t\t\tLong nextResourcePid = forcedId.getResourceId();\n+\t\t\t\tOptional<String> nextForcedId = Optional.of(forcedId.getForcedId());\n+\t\t\t\tretVal.put(nextResourcePid, nextForcedId);\n+\t\t\t\tmyForcedIdCache.put(nextResourcePid, nextForcedId);\n+\t\t\t}\n+\t\t});\n+\n+\t\tremainingPids = thePids\n+\t\t\t.stream()\n+\t\t\t.filter(t -> !retVal.containsKey(t))\n+\t\t\t.collect(Collectors.toList());\n+\t\tfor (Long nextResourcePid : remainingPids) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a82518eb48c09e505d15473393c69e581f665879"}, "originalPosition": 203}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODEwMDMyMA==", "bodyText": "Nice you got rid of a meaningful null.", "url": "https://github.com/hapifhir/hapi-fhir/pull/1821#discussion_r418100320", "createdAt": "2020-04-30T15:34:01Z", "author": {"login": "fil512"}, "path": "hapi-fhir-base/src/main/java/ca/uhn/fhir/interceptor/model/RequestPartitionId.java", "diffHunk": "@@ -26,35 +26,57 @@\n \n import static org.apache.commons.lang3.ObjectUtils.defaultIfNull;\n \n+/**\n+ * @since 5.0.0\n+ */\n public class RequestPartitionId {\n \n-\tprivate final Integer myPartitionId;\n+\tprivate static final RequestPartitionId ALL_PARTITIONS = new RequestPartitionId();\n \tprivate final LocalDate myPartitionDate;\n+\tprivate final boolean myAllPartitions;\n+\tprivate final Integer myPartitionId;\n \tprivate final String myPartitionName;\n \n \t/**\n-\t * Constructor\n+\t * Constructor for a single partition\n \t */\n \tprivate RequestPartitionId(@Nullable String thePartitionName, @Nullable Integer thePartitionId, @Nullable LocalDate thePartitionDate) {\n-\t\tmyPartitionName = thePartitionName;\n \t\tmyPartitionId = thePartitionId;\n+\t\tmyPartitionName = thePartitionName;\n \t\tmyPartitionDate = thePartitionDate;\n+\t\tmyAllPartitions = false;\n \t}\n \n-\tpublic String getPartitionName() {\n-\t\treturn myPartitionName;\n+\t/**\n+\t * Constructor for all partitions\n+\t */\n+\tprivate RequestPartitionId() {\n+\t\tsuper();\n+\t\tmyPartitionDate = null;\n+\t\tmyPartitionName = null;\n+\t\tmyPartitionId = null;\n+\t\tmyAllPartitions = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a82518eb48c09e505d15473393c69e581f665879"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODEwMTY3NQ==", "bodyText": "nitpick: Replace numbered comments with methods", "url": "https://github.com/hapifhir/hapi-fhir/pull/1821#discussion_r418101675", "createdAt": "2020-04-30T15:36:04Z", "author": {"login": "fil512"}, "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/BaseHapiFhirDao.java", "diffHunk": "@@ -924,6 +918,17 @@ public IBaseResource toResource(BaseHasResource theEntity, boolean theForHistory\n \n \t\t}\n \n+\t\t// 7. Add partition information", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a82518eb48c09e505d15473393c69e581f665879"}, "originalPosition": 150}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODEwNTg5MA==", "bodyText": "How do you decide if a class is a Service or a Svc?", "url": "https://github.com/hapifhir/hapi-fhir/pull/1821#discussion_r418105890", "createdAt": "2020-04-30T15:42:07Z", "author": {"login": "fil512"}, "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/BaseHapiFhirResourceDao.java", "diffHunk": "@@ -216,7 +216,7 @@ public DaoMethodOutcome create(T theResource, String theIfNoneExist, boolean the\n \t\t\ttheResource.setUserData(JpaConstants.RESOURCE_ID_SERVER_ASSIGNED, Boolean.TRUE);\n \t\t}\n \n-\t\tRequestPartitionId requestPartitionId = myRequestPartitionHelperService.determineCreatePartitionForRequest(theRequestDetails, theResource);\n+\t\tRequestPartitionId requestPartitionId = myRequestPartitionHelperService.determineCreatePartitionForRequest(theRequestDetails, theResource, getResourceName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a82518eb48c09e505d15473393c69e581f665879"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODEwNjIxMA==", "bodyText": "Or just a Helper?\nI've been using Helper for instance helpers and Util for static helpers.", "url": "https://github.com/hapifhir/hapi-fhir/pull/1821#discussion_r418106210", "createdAt": "2020-04-30T15:42:36Z", "author": {"login": "fil512"}, "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/BaseHapiFhirResourceDao.java", "diffHunk": "@@ -216,7 +216,7 @@ public DaoMethodOutcome create(T theResource, String theIfNoneExist, boolean the\n \t\t\ttheResource.setUserData(JpaConstants.RESOURCE_ID_SERVER_ASSIGNED, Boolean.TRUE);\n \t\t}\n \n-\t\tRequestPartitionId requestPartitionId = myRequestPartitionHelperService.determineCreatePartitionForRequest(theRequestDetails, theResource);\n+\t\tRequestPartitionId requestPartitionId = myRequestPartitionHelperService.determineCreatePartitionForRequest(theRequestDetails, theResource, getResourceName());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODEwNTg5MA=="}, "originalCommit": {"oid": "a82518eb48c09e505d15473393c69e581f665879"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODExMDE0Ng==", "bodyText": "I know it's probably too late for this comment, but seeing this code here makes me wonder: are there pieces of the partition filter that could be implemented as a consent interceptor?  (clearly when it's a predicate added to a query this doesn't make sense--but there are parts of the code like this where it's not a part of the query and might be more clearly expressed as a consent interceptor...?)", "url": "https://github.com/hapifhir/hapi-fhir/pull/1821#discussion_r418110146", "createdAt": "2020-04-30T15:48:19Z", "author": {"login": "fil512"}, "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/BaseHapiFhirResourceDao.java", "diffHunk": "@@ -1005,19 +1000,19 @@ public BaseHasResource readEntity(IIdType theId, RequestDetails theRequest) {\n \tpublic BaseHasResource readEntity(IIdType theId, boolean theCheckForForcedId, RequestDetails theRequest) {\n \t\tvalidateResourceTypeAndThrowInvalidRequestException(theId);\n \n-\t\t@Nullable RequestPartitionId requestPartitionId = myRequestPartitionHelperService.determineReadPartitionForRequest(theRequest, getResourceName());\n+\t\tRequestPartitionId requestPartitionId = myRequestPartitionHelperService.determineReadPartitionForRequest(theRequest, getResourceName());\n \t\tResourcePersistentId pid = myIdHelperService.resolveResourcePersistentIds(requestPartitionId, getResourceName(), theId.getIdPart());\n \t\tBaseHasResource entity = myEntityManager.find(ResourceTable.class, pid.getIdAsLong());\n \n \t\t// Verify that the resource is for the correct partition\n-\t\tif (requestPartitionId != null) {\n+\t\tif (!requestPartitionId.isAllPartitions()) {\n \t\t\tif (requestPartitionId.getPartitionId() == null) {\n \t\t\t\tif (entity.getPartitionId() != null) {\n \t\t\t\t\tourLog.debug(\"Performing a read for PartitionId={} but entity has partition: {}\", requestPartitionId, entity.getPartitionId());\n \t\t\t\t\tentity = null;\n \t\t\t\t}\n \t\t\t} else if (entity.getPartitionId() != null) {\n-\t\t\t\tif (!entity.getPartitionId().getPartitionId().equals(requestPartitionId.getPartitionId())) {\n+\t\t\t\tif (!requestPartitionId.getPartitionId().equals(entity.getPartitionId().getPartitionId())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a82518eb48c09e505d15473393c69e581f665879"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODExMzM0Ng==", "bodyText": "Never used.  If this is called to build the cache, maybe don't store the results?", "url": "https://github.com/hapifhir/hapi-fhir/pull/1821#discussion_r418113346", "createdAt": "2020-04-30T15:52:46Z", "author": {"login": "fil512"}, "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/HistoryBuilder.java", "diffHunk": "@@ -0,0 +1,185 @@\n+package ca.uhn.fhir.jpa.dao;\n+\n+/*\n+ * #%L\n+ * HAPI FHIR JPA Server\n+ * %%\n+ * Copyright (C) 2014 - 2020 University Health Network\n+ * %%\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * #L%\n+ */\n+\n+import ca.uhn.fhir.context.FhirContext;\n+import ca.uhn.fhir.interceptor.api.IInterceptorBroadcaster;\n+import ca.uhn.fhir.interceptor.model.RequestPartitionId;\n+import ca.uhn.fhir.jpa.dao.index.IdHelperService;\n+import ca.uhn.fhir.jpa.model.config.PartitionSettings;\n+import ca.uhn.fhir.jpa.model.cross.ResourcePersistentId;\n+import ca.uhn.fhir.jpa.model.entity.ResourceHistoryTable;\n+import ca.uhn.fhir.rest.server.exceptions.InvalidRequestException;\n+import com.google.common.collect.ImmutableListMultimap;\n+import com.google.common.collect.Multimaps;\n+import org.hl7.fhir.instance.model.api.IIdType;\n+import org.springframework.beans.factory.annotation.Autowired;\n+\n+import javax.annotation.Nullable;\n+import javax.persistence.EntityManager;\n+import javax.persistence.PersistenceContext;\n+import javax.persistence.PersistenceContextType;\n+import javax.persistence.TypedQuery;\n+import javax.persistence.criteria.CriteriaBuilder;\n+import javax.persistence.criteria.CriteriaQuery;\n+import javax.persistence.criteria.JoinType;\n+import javax.persistence.criteria.Predicate;\n+import javax.persistence.criteria.Root;\n+import java.util.ArrayList;\n+import java.util.Date;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+import static ca.uhn.fhir.jpa.dao.SearchBuilder.toPredicateArray;\n+\n+/**\n+ * The HistoryBuilder is responsible for building history queries\n+ */\n+public class HistoryBuilder {\n+\n+\tprivate final String myResourceType;\n+\tprivate final Long myResourceId;\n+\tprivate final Date myRangeStartInclusive;\n+\tprivate final Date myRangeEndInclusive;\n+\t@Autowired\n+\tprotected IInterceptorBroadcaster myInterceptorBroadcaster;\n+\t@PersistenceContext(type = PersistenceContextType.TRANSACTION)\n+\tprotected EntityManager myEntityManager;\n+\t@Autowired\n+\tprivate PartitionSettings myPartitionSettings;\n+\t@Autowired\n+\tprivate FhirContext myCtx;\n+\n+\n+\t/**\n+\t * Constructor\n+\t */\n+\tpublic HistoryBuilder(@Nullable String theResourceType, @Nullable Long theResourceId, @Nullable Date theRangeStartInclusive, @Nullable Date theRangeEndInclusive) {\n+\t\tmyResourceType = theResourceType;\n+\t\tmyResourceId = theResourceId;\n+\t\tmyRangeStartInclusive = theRangeStartInclusive;\n+\t\tmyRangeEndInclusive = theRangeEndInclusive;\n+\t}\n+\n+\tpublic Long fetchCount(RequestPartitionId thePartitionId) {\n+\t\tCriteriaBuilder cb = myEntityManager.getCriteriaBuilder();\n+\t\tCriteriaQuery<Long> criteriaQuery = cb.createQuery(Long.class);\n+\t\tRoot<ResourceHistoryTable> from = criteriaQuery.from(ResourceHistoryTable.class);\n+\t\tcriteriaQuery.select(cb.count(from));\n+\n+\t\taddPredicatesToQuery(cb, thePartitionId, criteriaQuery, from);\n+\n+\t\tTypedQuery<Long> query = myEntityManager.createQuery(criteriaQuery);\n+\t\treturn query.getSingleResult();\n+\t}\n+\n+\t@SuppressWarnings(\"OptionalIsPresent\")\n+\tpublic List<ResourceHistoryTable> fetchEntities(RequestPartitionId thePartitionId, int theFromIndex, int theToIndex) {\n+\t\tCriteriaBuilder cb = myEntityManager.getCriteriaBuilder();\n+\t\tCriteriaQuery<ResourceHistoryTable> criteriaQuery = cb.createQuery(ResourceHistoryTable.class);\n+\t\tRoot<ResourceHistoryTable> from = criteriaQuery.from(ResourceHistoryTable.class);\n+\n+\t\taddPredicatesToQuery(cb, thePartitionId, criteriaQuery, from);\n+\n+\t\tfrom.fetch(\"myProvenance\", JoinType.LEFT);\n+\n+\t\tcriteriaQuery.orderBy(cb.desc(from.get(\"myUpdated\")));\n+\n+\t\tTypedQuery<ResourceHistoryTable> query = myEntityManager.createQuery(criteriaQuery);\n+\n+\t\tquery.setFirstResult(theFromIndex);\n+\t\tquery.setMaxResults(theToIndex - theFromIndex);\n+\n+\t\tList<ResourceHistoryTable> tables = query.getResultList();\n+\t\tif (tables.size() > 0) {\n+\t\t\tImmutableListMultimap<Long, ResourceHistoryTable> resourceIdToHistoryEntries = Multimaps.index(tables, ResourceHistoryTable::getResourceId);\n+\n+\t\t\tMap<Long, Optional<String>> pidToForcedId = myIdHelperService.translatePidsToForcedIds(resourceIdToHistoryEntries.keySet());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a82518eb48c09e505d15473393c69e581f665879"}, "originalPosition": 117}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODExNjYzNQ==", "bodyText": "Good call.  I fell victim to \"Gosh this is so cool\" syndrome here.", "url": "https://github.com/hapifhir/hapi-fhir/pull/1821#discussion_r418116635", "createdAt": "2020-04-30T15:57:25Z", "author": {"login": "fil512"}, "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/SearchBuilderFactory.java", "diffHunk": "@@ -21,12 +21,20 @@\n  */\n \n import ca.uhn.fhir.jpa.api.dao.IDao;\n+import ca.uhn.fhir.jpa.config.BaseConfig;\n import org.hl7.fhir.instance.model.api.IBaseResource;\n+import org.springframework.beans.factory.annotation.Autowired;\n import org.springframework.beans.factory.annotation.Lookup;\n+import org.springframework.context.ApplicationContext;\n import org.springframework.stereotype.Service;\n \n-@Service\n-public abstract class SearchBuilderFactory {\n-\t@Lookup", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a82518eb48c09e505d15473393c69e581f665879"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODExNzU0NA==", "bodyText": "Need to optimize imports across this whole MR.  (lmk if you haven't seen this before.)", "url": "https://github.com/hapifhir/hapi-fhir/pull/1821#discussion_r418117544", "createdAt": "2020-04-30T15:58:52Z", "author": {"login": "fil512"}, "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/SearchBuilderFactory.java", "diffHunk": "@@ -21,12 +21,20 @@\n  */\n \n import ca.uhn.fhir.jpa.api.dao.IDao;\n+import ca.uhn.fhir.jpa.config.BaseConfig;\n import org.hl7.fhir.instance.model.api.IBaseResource;\n+import org.springframework.beans.factory.annotation.Autowired;\n import org.springframework.beans.factory.annotation.Lookup;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a82518eb48c09e505d15473393c69e581f665879"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODEyMjg1NA==", "bodyText": "Love it!!", "url": "https://github.com/hapifhir/hapi-fhir/pull/1821#discussion_r418122854", "createdAt": "2020-04-30T16:06:51Z", "author": {"login": "fil512"}, "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/util/QueryChunker.java", "diffHunk": "@@ -0,0 +1,45 @@\n+package ca.uhn.fhir.jpa.util;\n+\n+/*-\n+ * #%L\n+ * HAPI FHIR JPA Server\n+ * %%\n+ * Copyright (C) 2014 - 2020 University Health Network\n+ * %%\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * #L%\n+ */\n+\n+import ca.uhn.fhir.jpa.dao.SearchBuilder;\n+\n+import java.util.List;\n+import java.util.function.Consumer;\n+\n+/**\n+ * As always, Oracle can't handle things that other databases don't mind.. In this\n+ * case it doesn't like more than ~1000 IDs in a single load, so we break this up\n+ * if it's lots of IDs. I suppose maybe we should be doing this as a join anyhow\n+ * but this should work too. Sigh.\n+ */\n+public class QueryChunker<T> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a82518eb48c09e505d15473393c69e581f665879"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODEyNDE5NA==", "bodyText": "this assert doesn't cover the case where there are 4..", "url": "https://github.com/hapifhir/hapi-fhir/pull/1821#discussion_r418124194", "createdAt": "2020-04-30T16:08:51Z", "author": {"login": "fil512"}, "path": "hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/dao/r4/FhirResourceDaoR4QueryCountTest.java", "diffHunk": "@@ -246,6 +247,117 @@ public void testReferenceToForcedId_DeletesDisabled() {\n \n \t}\n \n+\t@Test\n+\tpublic void testHistory_Server() {\n+\t\trunInTransaction(() -> {\n+\t\t\tPatient p = new Patient();\n+\t\t\tp.setId(\"A\");\n+\t\t\tp.addIdentifier().setSystem(\"urn:system\").setValue(\"1\");\n+\t\t\tmyPatientDao.update(p).getId().toUnqualified();\n+\n+\t\t\tp = new Patient();\n+\t\t\tp.setId(\"B\");\n+\t\t\tp.addIdentifier().setSystem(\"urn:system\").setValue(\"2\");\n+\t\t\tmyPatientDao.update(p).getId().toUnqualified();\n+\n+\t\t\tp = new Patient();\n+\t\t\tp.addIdentifier().setSystem(\"urn:system\").setValue(\"2\");\n+\t\t\tmyPatientDao.create(p).getId().toUnqualified();\n+\t\t});\n+\n+\t\tmyCaptureQueriesListener.clear();\n+\t\trunInTransaction(() -> {\n+\t\t\tIBundleProvider history = mySystemDao.history(null, null, null);\n+\t\t\tassertEquals(3, history.getResources(0, 3).size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a82518eb48c09e505d15473393c69e581f665879"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODEzMjAwMg==", "bodyText": "This method name is confusing but I'm struggling to think of a better name.  sizeOrThrowException()?", "url": "https://github.com/hapifhir/hapi-fhir/pull/1821#discussion_r418132002", "createdAt": "2020-04-30T16:21:01Z", "author": {"login": "fil512"}, "path": "hapi-fhir-server/src/main/java/ca/uhn/fhir/rest/api/server/IBundleProvider.java", "diffHunk": "@@ -163,4 +164,12 @@ default boolean isEmpty() {\n \t\treturn getResources(0, 1).isEmpty();\n \t}\n \n+\t/**\n+\t * Returns the value of {@link #size()} and throws a {@link NullPointerException} of it is null\n+\t */\n+\tdefault int sizeNotNull() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a82518eb48c09e505d15473393c69e581f665879"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODEzNzY5OA==", "bodyText": "This is super cool.  I've added it to our next meeting agenda.", "url": "https://github.com/hapifhir/hapi-fhir/pull/1821#discussion_r418137698", "createdAt": "2020-04-30T16:29:54Z", "author": {"login": "fil512"}, "path": "hapi-fhir-test-utilities/src/main/java/ca/uhn/fhir/test/utilities/ITestDataBuilder.java", "diffHunk": "@@ -0,0 +1,183 @@\n+package ca.uhn.fhir.test.utilities;\n+\n+/*-\n+ * #%L\n+ * HAPI FHIR Test Utilities\n+ * %%\n+ * Copyright (C) 2014 - 2020 University Health Network\n+ * %%\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * #L%\n+ */\n+\n+import ca.uhn.fhir.context.BaseRuntimeChildDefinition;\n+import ca.uhn.fhir.context.BaseRuntimeElementCompositeDefinition;\n+import ca.uhn.fhir.context.FhirContext;\n+import ca.uhn.fhir.context.RuntimeResourceDefinition;\n+import org.hl7.fhir.instance.model.api.IBaseReference;\n+import org.hl7.fhir.instance.model.api.IBaseResource;\n+import org.hl7.fhir.instance.model.api.ICompositeType;\n+import org.hl7.fhir.instance.model.api.IIdType;\n+import org.hl7.fhir.instance.model.api.IPrimitiveType;\n+\n+import javax.annotation.Nullable;\n+import java.util.function.Consumer;\n+\n+import static org.apache.commons.lang3.StringUtils.isNotBlank;\n+import static org.hamcrest.Matchers.matchesPattern;\n+import static org.junit.Assert.assertThat;\n+\n+/**\n+ * This is an experiment to see if we can make test data creation for storage unit tests a bit more readable.\n+ */\n+@SuppressWarnings({\"unchecked\", \"ConstantConditions\"})\n+public interface ITestDataBuilder {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a82518eb48c09e505d15473393c69e581f665879"}, "originalPosition": 44}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8a34c0589dbfee30521163ba0025d91a57bd6e3", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/d8a34c0589dbfee30521163ba0025d91a57bd6e3", "committedDate": "2020-05-01T14:52:57Z", "message": "Update hapi-fhir-base/src/main/java/ca/uhn/fhir/rest/api/Constants.java\n\nCo-authored-by: Ken Stevens <khstevens@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8f5a9889a059e5f13c51bdd930c6444d37fa636", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/d8f5a9889a059e5f13c51bdd930c6444d37fa636", "committedDate": "2020-05-01T16:27:11Z", "message": "Account for review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ffcbb96ef4202d70f3aea6e82742cea4ed7c708", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/9ffcbb96ef4202d70f3aea6e82742cea4ed7c708", "committedDate": "2020-05-01T16:30:42Z", "message": "Merge branch 'ja_20200423_multitenancy_2' of github.com:jamesagnew/hapi-fhir into ja_20200423_multitenancy_2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0471cc2c335f0a297758b1850821eef939df075", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/b0471cc2c335f0a297758b1850821eef939df075", "committedDate": "2020-05-01T16:32:48Z", "message": "Merge branch 'master' into ja_20200423_multitenancy_2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4634e7eea732558ef0d423ad514e3708a091e2f", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/d4634e7eea732558ef0d423ad514e3708a091e2f", "committedDate": "2020-05-01T17:06:42Z", "message": "Resolve FIXMES"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a962f6454939c3fd9256b5cf2a377fb8bdd846ef", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/a962f6454939c3fd9256b5cf2a377fb8bdd846ef", "committedDate": "2020-05-01T19:06:39Z", "message": "Merge branch 'master' into ja_20200423_multitenancy_2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f7f9be98bb002aeed46ad609189eb803531e528", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/1f7f9be98bb002aeed46ad609189eb803531e528", "committedDate": "2020-05-01T19:16:32Z", "message": "Work on tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d89a07504f2e9abf2a8da8d0f0bb6467da272bb", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/4d89a07504f2e9abf2a8da8d0f0bb6467da272bb", "committedDate": "2020-05-02T17:44:39Z", "message": "Test fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8767d0e9a421ebf9c3505d5cd3c3b883bf589fef", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/8767d0e9a421ebf9c3505d5cd3c3b883bf589fef", "committedDate": "2020-05-02T17:46:38Z", "message": "A bit more cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c37951320f6f937466958be26510b5703d3ca00b", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/c37951320f6f937466958be26510b5703d3ca00b", "committedDate": "2020-05-04T09:40:20Z", "message": "Work on multitenancy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0bea3fc2bb82d4b6f1196971bd26f55ddde2c190", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/0bea3fc2bb82d4b6f1196971bd26f55ddde2c190", "committedDate": "2020-05-04T18:45:52Z", "message": "Update hapi-fhir-docs/src/main/java/ca/uhn/hapi/fhir/docs/ClientExamples.java\n\nCo-authored-by: Ken Stevens <khstevens@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08eac70f356f5bf68f8602f82b56fda73df515d2", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/08eac70f356f5bf68f8602f82b56fda73df515d2", "committedDate": "2020-05-04T18:46:05Z", "message": "Update hapi-fhir-docs/src/main/resources/ca/uhn/hapi/fhir/docs/client/examples.md\n\nCo-authored-by: Ken Stevens <khstevens@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02f8675df69bf662f91dc9aff70ede55c3e4391a", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/02f8675df69bf662f91dc9aff70ede55c3e4391a", "committedDate": "2020-05-04T18:54:18Z", "message": "Address review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d4762c33f25c6dbcc8d4c05d1fe32bdfe1ffd84", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/6d4762c33f25c6dbcc8d4c05d1fe32bdfe1ffd84", "committedDate": "2020-05-04T18:54:27Z", "message": "Merge branch 'ja_20200423_multitenancy_2' of github.com:jamesagnew/hapi-fhir into ja_20200423_multitenancy_2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37beb301242339e490787e7cafd76e1dfe2b6675", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/37beb301242339e490787e7cafd76e1dfe2b6675", "committedDate": "2020-05-04T21:05:49Z", "message": "Merge branch 'ja_20200423_multitenancy_2' of github.com:jamesagnew/hapi-fhir into ja_20200423_multitenancy_2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10522363f16ef8404daa42bdff9ff77e89d8b2f0", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/10522363f16ef8404daa42bdff9ff77e89d8b2f0", "committedDate": "2020-05-05T13:41:17Z", "message": "Allow disabling text modifier indexing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "190cac2b1c3971c7c9f0259f7a99b808a8d7fee4", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/190cac2b1c3971c7c9f0259f7a99b808a8d7fee4", "committedDate": "2020-05-05T13:43:14Z", "message": "Add changelog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "050ff6feb37ce57d5b8c147e2b0fc4295e91bc68", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/050ff6feb37ce57d5b8c147e2b0fc4295e91bc68", "committedDate": "2020-05-05T15:12:33Z", "message": "Docs fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "717cc92603bccb7b71d8139a133a9d4e25a4c3fc", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/717cc92603bccb7b71d8139a133a9d4e25a4c3fc", "committedDate": "2020-05-05T15:15:20Z", "message": "Address review comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a265691afb7d2b6dc8de30f6df645a11e440978f", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/a265691afb7d2b6dc8de30f6df645a11e440978f", "committedDate": "2020-05-05T15:18:04Z", "message": "Merge branch 'master' into ja_20200505_disable_text_modifier"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e004834c63094baa5844ce36b513471253d9db3", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/4e004834c63094baa5844ce36b513471253d9db3", "committedDate": "2020-05-05T15:29:24Z", "message": "Resolve merge conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5c3c940fc2e68d3b37a690154f19ab28597b127", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/a5c3c940fc2e68d3b37a690154f19ab28597b127", "committedDate": "2020-05-05T15:34:48Z", "message": "Merge branch 'ja_20200505_disable_text_modifier' into ja_20200423_multitenancy_2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44354ef7fdf60ec5a6256e9973f1fa0745b4d902", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/44354ef7fdf60ec5a6256e9973f1fa0745b4d902", "committedDate": "2020-05-05T16:20:01Z", "message": "Merge master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6548b5c8c556daa91a7f3105f87e95166ded3c9", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/d6548b5c8c556daa91a7f3105f87e95166ded3c9", "committedDate": "2020-05-05T16:20:22Z", "message": "Merge branch 'master' into ja_20200423_multitenancy_2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ad03c0413503f58ec5c6d03952eb45eff8d60f5", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/4ad03c0413503f58ec5c6d03952eb45eff8d60f5", "committedDate": "2020-05-05T16:48:56Z", "message": "Compile fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c93596f8a460cddefddfc354114a48c6676fffc5", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/c93596f8a460cddefddfc354114a48c6676fffc5", "committedDate": "2020-05-05T17:39:44Z", "message": "Test fix"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4060, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}