{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgxNjY5NDM2", "number": 2067, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNDoxMjo0OVrOEiI5ew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNjozMzoyNFrOEiM0FA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0MjMyODI3OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/data/ITermConceptMapDao.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNDoxMjo0OVrOHP2F6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxMzoxMjowOFrOHQeQiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM3NjkzOA==", "bodyText": "The method name might be a bit confusing now that we are supporting multiple ConceptMap versions.  Maybe could change this to something like findUnversionedTermConceptMapByUrl or findTermConceptMapByUrlAndNullVersion.", "url": "https://github.com/hapifhir/hapi-fhir/pull/2067#discussion_r486376938", "createdAt": "2020-09-10T14:12:49Z", "author": {"login": "IanMMarshall"}, "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/data/ITermConceptMapDao.java", "diffHunk": "@@ -36,6 +39,12 @@\n \t@Query(\"SELECT cm FROM TermConceptMap cm WHERE cm.myResourcePid = :resource_pid\")\n \tOptional<TermConceptMap> findTermConceptMapByResourcePid(@Param(\"resource_pid\") Long theResourcePid);\n \n-\t@Query(\"SELECT cm FROM TermConceptMap cm WHERE cm.myUrl = :url\")\n+\t@Query(\"SELECT cm FROM TermConceptMap cm WHERE cm.myUrl = :url and cm.myVersion is null\")\n \tOptional<TermConceptMap> findTermConceptMapByUrl(@Param(\"url\") String theUrl);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c873b6d6dd382717ba5ff9c6683abfe9a4c6837e"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcwNjIxMQ==", "bodyText": "Will change to findTermConceptMapByUrlAndNullVersion, not sure this is used by outside out HAPI.", "url": "https://github.com/hapifhir/hapi-fhir/pull/2067#discussion_r486706211", "createdAt": "2020-09-11T00:33:29Z", "author": {"login": "frankjtao"}, "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/data/ITermConceptMapDao.java", "diffHunk": "@@ -36,6 +39,12 @@\n \t@Query(\"SELECT cm FROM TermConceptMap cm WHERE cm.myResourcePid = :resource_pid\")\n \tOptional<TermConceptMap> findTermConceptMapByResourcePid(@Param(\"resource_pid\") Long theResourcePid);\n \n-\t@Query(\"SELECT cm FROM TermConceptMap cm WHERE cm.myUrl = :url\")\n+\t@Query(\"SELECT cm FROM TermConceptMap cm WHERE cm.myUrl = :url and cm.myVersion is null\")\n \tOptional<TermConceptMap> findTermConceptMapByUrl(@Param(\"url\") String theUrl);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM3NjkzOA=="}, "originalCommit": {"oid": "c873b6d6dd382717ba5ff9c6683abfe9a4c6837e"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzAzNTAxNg==", "bodyText": "Good point about breaking backwards compatibility. I suppose we could have kept the old name as well and marked it as deprecated along with a comment recommending the use of the new name.", "url": "https://github.com/hapifhir/hapi-fhir/pull/2067#discussion_r487035016", "createdAt": "2020-09-11T13:12:08Z", "author": {"login": "IanMMarshall"}, "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/data/ITermConceptMapDao.java", "diffHunk": "@@ -36,6 +39,12 @@\n \t@Query(\"SELECT cm FROM TermConceptMap cm WHERE cm.myResourcePid = :resource_pid\")\n \tOptional<TermConceptMap> findTermConceptMapByResourcePid(@Param(\"resource_pid\") Long theResourcePid);\n \n-\t@Query(\"SELECT cm FROM TermConceptMap cm WHERE cm.myUrl = :url\")\n+\t@Query(\"SELECT cm FROM TermConceptMap cm WHERE cm.myUrl = :url and cm.myVersion is null\")\n \tOptional<TermConceptMap> findTermConceptMapByUrl(@Param(\"url\") String theUrl);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM3NjkzOA=="}, "originalCommit": {"oid": "c873b6d6dd382717ba5ff9c6683abfe9a4c6837e"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0MjMzNzM2OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/data/ITermConceptMapDao.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNDoxNDo1MlrOHP2L_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwMDozNjozM1rOHQKPZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM3ODQ5Mw==", "bodyText": "Suggestion for a more descriptive method name: getTermConceptMapEntitiesByUrlOrderByVersion.", "url": "https://github.com/hapifhir/hapi-fhir/pull/2067#discussion_r486378493", "createdAt": "2020-09-10T14:14:52Z", "author": {"login": "IanMMarshall"}, "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/data/ITermConceptMapDao.java", "diffHunk": "@@ -36,6 +39,12 @@\n \t@Query(\"SELECT cm FROM TermConceptMap cm WHERE cm.myResourcePid = :resource_pid\")\n \tOptional<TermConceptMap> findTermConceptMapByResourcePid(@Param(\"resource_pid\") Long theResourcePid);\n \n-\t@Query(\"SELECT cm FROM TermConceptMap cm WHERE cm.myUrl = :url\")\n+\t@Query(\"SELECT cm FROM TermConceptMap cm WHERE cm.myUrl = :url and cm.myVersion is null\")\n \tOptional<TermConceptMap> findTermConceptMapByUrl(@Param(\"url\") String theUrl);\n+\t\n+\t@Query(value=\"SELECT cm FROM TermConceptMap cm INNER JOIN ResourceTable r ON r.myId = cm.myResourcePid WHERE cm.myUrl = :url ORDER BY r.myUpdated DESC\") \n+\tList<TermConceptMap> findTermConceptMapByUrl(Pageable thePage, @Param(\"url\") String theUrl);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c873b6d6dd382717ba5ff9c6683abfe9a4c6837e"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcwNzA0NA==", "bodyText": "Changed", "url": "https://github.com/hapifhir/hapi-fhir/pull/2067#discussion_r486707044", "createdAt": "2020-09-11T00:36:33Z", "author": {"login": "frankjtao"}, "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/data/ITermConceptMapDao.java", "diffHunk": "@@ -36,6 +39,12 @@\n \t@Query(\"SELECT cm FROM TermConceptMap cm WHERE cm.myResourcePid = :resource_pid\")\n \tOptional<TermConceptMap> findTermConceptMapByResourcePid(@Param(\"resource_pid\") Long theResourcePid);\n \n-\t@Query(\"SELECT cm FROM TermConceptMap cm WHERE cm.myUrl = :url\")\n+\t@Query(\"SELECT cm FROM TermConceptMap cm WHERE cm.myUrl = :url and cm.myVersion is null\")\n \tOptional<TermConceptMap> findTermConceptMapByUrl(@Param(\"url\") String theUrl);\n+\t\n+\t@Query(value=\"SELECT cm FROM TermConceptMap cm INNER JOIN ResourceTable r ON r.myId = cm.myResourcePid WHERE cm.myUrl = :url ORDER BY r.myUpdated DESC\") \n+\tList<TermConceptMap> findTermConceptMapByUrl(Pageable thePage, @Param(\"url\") String theUrl);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM3ODQ5Mw=="}, "originalCommit": {"oid": "c873b6d6dd382717ba5ff9c6683abfe9a4c6837e"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0MjU3MTgxOnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/term/BaseTermReadSvcImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNTowMzozMFrOHP4fvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwMDozNzo0NVrOHQKQ2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQxNjMxOA==", "bodyText": "It looks like the else clause above has created a gap in the test coverage for the case where a concept map version is specified but no URL is specified. To be honest, I am not sure if this would even be a valid use case. I would suggest either removing the else clause (e.g. ignore the version if no URL is specified) or adding a JUnit test for this use case.", "url": "https://github.com/hapifhir/hapi-fhir/pull/2067#discussion_r486416318", "createdAt": "2020-09-10T15:03:30Z", "author": {"login": "IanMMarshall"}, "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/term/BaseTermReadSvcImpl.java", "diffHunk": "@@ -1946,6 +1969,25 @@ ConceptSubsumptionOutcome testForSubsumption(FullTextEntityManager theEntityMana\n \t\t\t\t\tpredicates.add(criteriaBuilder.equal(groupJoin.get(\"myTarget\"), translationQuery.getTargetSystem().getValueAsString()));\n \t\t\t\t}\n \n+\t\t\t\tif (translationQuery.hasUrl()) { \n+\t\t\t\t\tpredicates.add(criteriaBuilder.equal(conceptMapJoin.get(\"myUrl\"), translationQuery.getUrl().getValueAsString()));\n+\t\t\t\t\tif (translationQuery.hasConceptMapVersion()) {\n+\t\t\t\t\t\t// both url and conceptMapVersion\n+\t\t\t\t\t\tpredicates.add(criteriaBuilder.equal(conceptMapJoin.get(\"myVersion\"), translationQuery.getConceptMapVersion().getValueAsString()));\n+\t\t\t\t\t} else {\n+\t\t\t\t\t\tif (StringUtils.isNotBlank(latestConceptMapVersion)) {\n+\t\t\t\t\t\t\t// only url and use latestConceptMapVersion\n+\t\t\t\t\t\t\tpredicates.add(criteriaBuilder.equal(conceptMapJoin.get(\"myVersion\"), latestConceptMapVersion));\n+\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\tpredicates.add(criteriaBuilder.isNull(conceptMapJoin.get(\"myVersion\")));\n+\t\t\t\t\t\t}\n+\t\t\t\t\t}\n+\t\t\t\t} else {\n+\t\t\t\t\tif (translationQuery.hasConceptMapVersion()) {\n+\t\t\t\t\t\tpredicates.add(criteriaBuilder.equal(conceptMapJoin.get(\"myVersion\"), translationQuery.getConceptMapVersion().getValueAsString()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c873b6d6dd382717ba5ff9c6683abfe9a4c6837e"}, "originalPosition": 93}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcwNzQxNw==", "bodyText": "the else clause is removed", "url": "https://github.com/hapifhir/hapi-fhir/pull/2067#discussion_r486707417", "createdAt": "2020-09-11T00:37:45Z", "author": {"login": "frankjtao"}, "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/term/BaseTermReadSvcImpl.java", "diffHunk": "@@ -1946,6 +1969,25 @@ ConceptSubsumptionOutcome testForSubsumption(FullTextEntityManager theEntityMana\n \t\t\t\t\tpredicates.add(criteriaBuilder.equal(groupJoin.get(\"myTarget\"), translationQuery.getTargetSystem().getValueAsString()));\n \t\t\t\t}\n \n+\t\t\t\tif (translationQuery.hasUrl()) { \n+\t\t\t\t\tpredicates.add(criteriaBuilder.equal(conceptMapJoin.get(\"myUrl\"), translationQuery.getUrl().getValueAsString()));\n+\t\t\t\t\tif (translationQuery.hasConceptMapVersion()) {\n+\t\t\t\t\t\t// both url and conceptMapVersion\n+\t\t\t\t\t\tpredicates.add(criteriaBuilder.equal(conceptMapJoin.get(\"myVersion\"), translationQuery.getConceptMapVersion().getValueAsString()));\n+\t\t\t\t\t} else {\n+\t\t\t\t\t\tif (StringUtils.isNotBlank(latestConceptMapVersion)) {\n+\t\t\t\t\t\t\t// only url and use latestConceptMapVersion\n+\t\t\t\t\t\t\tpredicates.add(criteriaBuilder.equal(conceptMapJoin.get(\"myVersion\"), latestConceptMapVersion));\n+\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\tpredicates.add(criteriaBuilder.isNull(conceptMapJoin.get(\"myVersion\")));\n+\t\t\t\t\t\t}\n+\t\t\t\t\t}\n+\t\t\t\t} else {\n+\t\t\t\t\tif (translationQuery.hasConceptMapVersion()) {\n+\t\t\t\t\t\tpredicates.add(criteriaBuilder.equal(conceptMapJoin.get(\"myVersion\"), translationQuery.getConceptMapVersion().getValueAsString()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQxNjMxOA=="}, "originalCommit": {"oid": "c873b6d6dd382717ba5ff9c6683abfe9a4c6837e"}, "originalPosition": 93}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0MjU3NDA0OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/term/BaseTermReadSvcImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNTowNDowMFrOHP4hJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwMDozOTo1N1rOHQKS4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQxNjY3Nw==", "bodyText": "It looks like the else clause above has created a gap in the test coverage for the case where a concept map version is specified but no URL is specified. To be honest, I am not sure if this would even be a valid use case. I would suggest either removing the else clause (e.g. ignore the version if no URL is specified) or adding a JUnit test for this use case.", "url": "https://github.com/hapifhir/hapi-fhir/pull/2067#discussion_r486416677", "createdAt": "2020-09-10T15:04:00Z", "author": {"login": "IanMMarshall"}, "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/term/BaseTermReadSvcImpl.java", "diffHunk": "@@ -2029,6 +2077,25 @@ ConceptSubsumptionOutcome testForSubsumption(FullTextEntityManager theEntityMana\n \t\t\t\t\tpredicates.add(criteriaBuilder.equal(groupJoin.get(\"myTargetVersion\"), coding.getVersion()));\n \t\t\t\t}\n \n+\t\t\t\tif (translationQuery.hasUrl()) { \n+\t\t\t\t\tpredicates.add(criteriaBuilder.equal(conceptMapJoin.get(\"myUrl\"), translationQuery.getUrl().getValueAsString()));\n+\t\t\t\t\tif (translationQuery.hasConceptMapVersion()) {\n+\t\t\t\t\t\t// both url and conceptMapVersion\n+\t\t\t\t\t\tpredicates.add(criteriaBuilder.equal(conceptMapJoin.get(\"myVersion\"), translationQuery.getConceptMapVersion().getValueAsString()));\n+\t\t\t\t\t} else {\n+\t\t\t\t\t\tif (StringUtils.isNotBlank(latestConceptMapVersion)) {\n+\t\t\t\t\t\t\t// only url and use latestConceptMapVersion\n+\t\t\t\t\t\t\tpredicates.add(criteriaBuilder.equal(conceptMapJoin.get(\"myVersion\"), latestConceptMapVersion));\n+\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\tpredicates.add(criteriaBuilder.isNull(conceptMapJoin.get(\"myVersion\")));\n+\t\t\t\t\t\t}\n+\t\t\t\t\t}\n+\t\t\t\t} else {\n+\t\t\t\t\tif (translationQuery.hasConceptMapVersion()) {\n+\t\t\t\t\t\tpredicates.add(criteriaBuilder.equal(conceptMapJoin.get(\"myVersion\"), translationQuery.getConceptMapVersion().getValueAsString()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c873b6d6dd382717ba5ff9c6683abfe9a4c6837e"}, "originalPosition": 132}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcwNzkzNg==", "bodyText": "same as above", "url": "https://github.com/hapifhir/hapi-fhir/pull/2067#discussion_r486707936", "createdAt": "2020-09-11T00:39:57Z", "author": {"login": "frankjtao"}, "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/term/BaseTermReadSvcImpl.java", "diffHunk": "@@ -2029,6 +2077,25 @@ ConceptSubsumptionOutcome testForSubsumption(FullTextEntityManager theEntityMana\n \t\t\t\t\tpredicates.add(criteriaBuilder.equal(groupJoin.get(\"myTargetVersion\"), coding.getVersion()));\n \t\t\t\t}\n \n+\t\t\t\tif (translationQuery.hasUrl()) { \n+\t\t\t\t\tpredicates.add(criteriaBuilder.equal(conceptMapJoin.get(\"myUrl\"), translationQuery.getUrl().getValueAsString()));\n+\t\t\t\t\tif (translationQuery.hasConceptMapVersion()) {\n+\t\t\t\t\t\t// both url and conceptMapVersion\n+\t\t\t\t\t\tpredicates.add(criteriaBuilder.equal(conceptMapJoin.get(\"myVersion\"), translationQuery.getConceptMapVersion().getValueAsString()));\n+\t\t\t\t\t} else {\n+\t\t\t\t\t\tif (StringUtils.isNotBlank(latestConceptMapVersion)) {\n+\t\t\t\t\t\t\t// only url and use latestConceptMapVersion\n+\t\t\t\t\t\t\tpredicates.add(criteriaBuilder.equal(conceptMapJoin.get(\"myVersion\"), latestConceptMapVersion));\n+\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\tpredicates.add(criteriaBuilder.isNull(conceptMapJoin.get(\"myVersion\")));\n+\t\t\t\t\t\t}\n+\t\t\t\t\t}\n+\t\t\t\t} else {\n+\t\t\t\t\tif (translationQuery.hasConceptMapVersion()) {\n+\t\t\t\t\t\tpredicates.add(criteriaBuilder.equal(conceptMapJoin.get(\"myVersion\"), translationQuery.getConceptMapVersion().getValueAsString()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQxNjY3Nw=="}, "originalCommit": {"oid": "c873b6d6dd382717ba5ff9c6683abfe9a4c6837e"}, "originalPosition": 132}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0MjU5NTA2OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/term/BaseTermReadSvcImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNTowODoyOVrOHP4ucg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwMDo1Mjo0NVrOHQKf9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQyMDA4Mg==", "bodyText": "Might need a JUnit test for the case where translate is requested with a URL and no version, but the requested ConceptMap is not versioned in the repository.", "url": "https://github.com/hapifhir/hapi-fhir/pull/2067#discussion_r486420082", "createdAt": "2020-09-10T15:08:29Z", "author": {"login": "IanMMarshall"}, "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/term/BaseTermReadSvcImpl.java", "diffHunk": "@@ -2094,6 +2161,20 @@ void throwInvalidValueSet(String theValueSet) {\n \t\tthrow new ResourceNotFoundException(\"Unknown ValueSet: \" + UrlUtil.escapeUrlParam(theValueSet));\n \t}\n \n+\t// Special case for the translate operation with url and without\n+\t// conceptMapVersion, find the latest conecptMapVersion\n+\tprivate String getLatestConceptMapVersion(TranslationRequest theTranslationRequest) {\n+\n+\t\tPageable page = PageRequest.of(0, 1);\n+\t\tList<TermConceptMap> theConceptMapList = myConceptMapDao.findTermConceptMapByUrl(page,\n+\t\t\t\ttheTranslationRequest.getUrl().asStringValue());\n+\t\tif (!theConceptMapList.isEmpty()) {\n+\t\t\treturn theConceptMapList.get(0).getVersion();\n+\t\t}\n+\n+\t\treturn null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c873b6d6dd382717ba5ff9c6683abfe9a4c6837e"}, "originalPosition": 154}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcxMTI4Nw==", "bodyText": "new test case added", "url": "https://github.com/hapifhir/hapi-fhir/pull/2067#discussion_r486711287", "createdAt": "2020-09-11T00:52:45Z", "author": {"login": "frankjtao"}, "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/term/BaseTermReadSvcImpl.java", "diffHunk": "@@ -2094,6 +2161,20 @@ void throwInvalidValueSet(String theValueSet) {\n \t\tthrow new ResourceNotFoundException(\"Unknown ValueSet: \" + UrlUtil.escapeUrlParam(theValueSet));\n \t}\n \n+\t// Special case for the translate operation with url and without\n+\t// conceptMapVersion, find the latest conecptMapVersion\n+\tprivate String getLatestConceptMapVersion(TranslationRequest theTranslationRequest) {\n+\n+\t\tPageable page = PageRequest.of(0, 1);\n+\t\tList<TermConceptMap> theConceptMapList = myConceptMapDao.findTermConceptMapByUrl(page,\n+\t\t\t\ttheTranslationRequest.getUrl().asStringValue());\n+\t\tif (!theConceptMapList.isEmpty()) {\n+\t\t\treturn theConceptMapList.get(0).getVersion();\n+\t\t}\n+\n+\t\treturn null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQyMDA4Mg=="}, "originalCommit": {"oid": "c873b6d6dd382717ba5ff9c6683abfe9a4c6837e"}, "originalPosition": 154}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0MjkyNDQ5OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/dao/dstu3/FhirResourceDaoDstu3ConceptMapTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNjoyMjowOVrOHP79XA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwMDo1NTo0N1rOHQKjKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ3MzA1Mg==", "bodyText": "nitpick - comment should say should return the latest one which in this case is not versioned.", "url": "https://github.com/hapifhir/hapi-fhir/pull/2067#discussion_r486473052", "createdAt": "2020-09-10T16:22:09Z", "author": {"login": "IanMMarshall"}, "path": "hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/dao/dstu3/FhirResourceDaoDstu3ConceptMapTest.java", "diffHunk": "@@ -98,4 +107,74 @@ protected void doInTransactionWithoutResult(TransactionStatus theStatus) {\n \t\t});\n \t}\n \n+\t@Test\n+\tpublic void testConcaptMapFindTermConceptMapByUrl() {\n+\t\t\t\n+\t\tPageable page = PageRequest.of(0, 1);\n+\t\tList<TermConceptMap> theExpConceptMapList = myTermConceptMapDao.findTermConceptMapByUrl(page, CM_URL);\n+\t\tassertEquals(1, theExpConceptMapList.size());\n+\t\tassertEquals(CM_URL, theExpConceptMapList.get(0).getUrl());\n+\t\t\n+\t}\n+\n+\t@Test\n+\tpublic void testConcaptMapTwoConceptMapWithSameUrlDifferentVersion() {\n+\t\t\t\t\n+\t\tString theUrl = \"http://loinc.org/property/analyte-suffix\";\n+\t\tConceptMap theConceptMap1 = new ConceptMap();\n+\t\tConceptMap theConceptMap2 = new ConceptMap();\n+\t\t\n+\t\ttheConceptMap1.setUrl(theUrl).setStatus(PublicationStatus.ACTIVE).setName(\"name1\").setVersion(\"v1\");\n+\t\ttheConceptMap2.setUrl(theUrl).setStatus(PublicationStatus.ACTIVE).setName(\"name2\").setVersion(\"v2\");\n+\t\t\n+\t\tmyConceptMapDao.create(theConceptMap1);\n+\t\tmyConceptMapDao.create(theConceptMap2);\n+\t\t\n+\t\tOptional<TermConceptMap> theExpConceptMapV1 = myTermConceptMapDao.findTermConceptMapByUrlAndVersion(theUrl, \"v1\");\n+\t\tOptional<TermConceptMap> theExpConceptMapV2 = myTermConceptMapDao.findTermConceptMapByUrlAndVersion(theUrl, \"v2\");\n+\t\t\n+\t\tassertTrue(theExpConceptMapV1.isPresent());\n+\t\tassertEquals(theUrl, theExpConceptMapV1.get().getUrl());\n+\t\tassertEquals(\"v1\", theExpConceptMapV1.get().getVersion());\n+\t\t\n+\t\tassertTrue(theExpConceptMapV2.isPresent());\n+\t\tassertEquals(theUrl, theExpConceptMapV2.get().getUrl());\n+\t\tassertEquals(\"v2\", theExpConceptMapV2.get().getVersion());\n+\n+\t\t// should return the latest one which is v2\n+\t\tPageable page = PageRequest.of(0, 1);\n+\t\tList<TermConceptMap> theExpSecondOne = myTermConceptMapDao.findTermConceptMapByUrl(page, theUrl);\n+\t\t\n+\t\tassertEquals(1, theExpSecondOne.size());\n+\t\tassertEquals(theUrl, theExpSecondOne.get(0).getUrl());\n+\t\tassertEquals(\"v2\", theExpSecondOne.get(0).getVersion());\n+\t}\n+\n+\t@Test\n+\tpublic void testConcaptMapTwoConceptMapWithSameUrlOneWithoutVersion() {\n+\t\t\t\t\n+\t\tString theUrl = \"http://loinc.org/property/analyte-suffix\";\n+\t\tConceptMap theConceptMap1 = new ConceptMap();\n+\t\tConceptMap theConceptMap2 = new ConceptMap();\n+\t\t\n+\t\ttheConceptMap1.setUrl(theUrl).setStatus(PublicationStatus.ACTIVE).setName(\"name1\").setVersion(\"v1\");\n+\t\ttheConceptMap2.setUrl(theUrl).setStatus(PublicationStatus.ACTIVE).setName(\"name2\");\n+\t\t\n+\t\tmyConceptMapDao.create(theConceptMap1);\n+\t\tmyConceptMapDao.create(theConceptMap2);\n+\t\t\n+\t\tOptional<TermConceptMap> theExpConceptMapV1 = myTermConceptMapDao.findTermConceptMapByUrlAndVersion(theUrl, \"v1\");\n+\t\t\n+\t\tassertTrue(theExpConceptMapV1.isPresent());\n+\t\tassertEquals(theUrl, theExpConceptMapV1.get().getUrl());\n+\t\tassertEquals(\"v1\", theExpConceptMapV1.get().getVersion());\n+\t\t\n+\t\t// should return the latest one which is v2", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c873b6d6dd382717ba5ff9c6683abfe9a4c6837e"}, "originalPosition": 105}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcxMjEwNw==", "bodyText": "Comments updated", "url": "https://github.com/hapifhir/hapi-fhir/pull/2067#discussion_r486712107", "createdAt": "2020-09-11T00:55:47Z", "author": {"login": "frankjtao"}, "path": "hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/dao/dstu3/FhirResourceDaoDstu3ConceptMapTest.java", "diffHunk": "@@ -98,4 +107,74 @@ protected void doInTransactionWithoutResult(TransactionStatus theStatus) {\n \t\t});\n \t}\n \n+\t@Test\n+\tpublic void testConcaptMapFindTermConceptMapByUrl() {\n+\t\t\t\n+\t\tPageable page = PageRequest.of(0, 1);\n+\t\tList<TermConceptMap> theExpConceptMapList = myTermConceptMapDao.findTermConceptMapByUrl(page, CM_URL);\n+\t\tassertEquals(1, theExpConceptMapList.size());\n+\t\tassertEquals(CM_URL, theExpConceptMapList.get(0).getUrl());\n+\t\t\n+\t}\n+\n+\t@Test\n+\tpublic void testConcaptMapTwoConceptMapWithSameUrlDifferentVersion() {\n+\t\t\t\t\n+\t\tString theUrl = \"http://loinc.org/property/analyte-suffix\";\n+\t\tConceptMap theConceptMap1 = new ConceptMap();\n+\t\tConceptMap theConceptMap2 = new ConceptMap();\n+\t\t\n+\t\ttheConceptMap1.setUrl(theUrl).setStatus(PublicationStatus.ACTIVE).setName(\"name1\").setVersion(\"v1\");\n+\t\ttheConceptMap2.setUrl(theUrl).setStatus(PublicationStatus.ACTIVE).setName(\"name2\").setVersion(\"v2\");\n+\t\t\n+\t\tmyConceptMapDao.create(theConceptMap1);\n+\t\tmyConceptMapDao.create(theConceptMap2);\n+\t\t\n+\t\tOptional<TermConceptMap> theExpConceptMapV1 = myTermConceptMapDao.findTermConceptMapByUrlAndVersion(theUrl, \"v1\");\n+\t\tOptional<TermConceptMap> theExpConceptMapV2 = myTermConceptMapDao.findTermConceptMapByUrlAndVersion(theUrl, \"v2\");\n+\t\t\n+\t\tassertTrue(theExpConceptMapV1.isPresent());\n+\t\tassertEquals(theUrl, theExpConceptMapV1.get().getUrl());\n+\t\tassertEquals(\"v1\", theExpConceptMapV1.get().getVersion());\n+\t\t\n+\t\tassertTrue(theExpConceptMapV2.isPresent());\n+\t\tassertEquals(theUrl, theExpConceptMapV2.get().getUrl());\n+\t\tassertEquals(\"v2\", theExpConceptMapV2.get().getVersion());\n+\n+\t\t// should return the latest one which is v2\n+\t\tPageable page = PageRequest.of(0, 1);\n+\t\tList<TermConceptMap> theExpSecondOne = myTermConceptMapDao.findTermConceptMapByUrl(page, theUrl);\n+\t\t\n+\t\tassertEquals(1, theExpSecondOne.size());\n+\t\tassertEquals(theUrl, theExpSecondOne.get(0).getUrl());\n+\t\tassertEquals(\"v2\", theExpSecondOne.get(0).getVersion());\n+\t}\n+\n+\t@Test\n+\tpublic void testConcaptMapTwoConceptMapWithSameUrlOneWithoutVersion() {\n+\t\t\t\t\n+\t\tString theUrl = \"http://loinc.org/property/analyte-suffix\";\n+\t\tConceptMap theConceptMap1 = new ConceptMap();\n+\t\tConceptMap theConceptMap2 = new ConceptMap();\n+\t\t\n+\t\ttheConceptMap1.setUrl(theUrl).setStatus(PublicationStatus.ACTIVE).setName(\"name1\").setVersion(\"v1\");\n+\t\ttheConceptMap2.setUrl(theUrl).setStatus(PublicationStatus.ACTIVE).setName(\"name2\");\n+\t\t\n+\t\tmyConceptMapDao.create(theConceptMap1);\n+\t\tmyConceptMapDao.create(theConceptMap2);\n+\t\t\n+\t\tOptional<TermConceptMap> theExpConceptMapV1 = myTermConceptMapDao.findTermConceptMapByUrlAndVersion(theUrl, \"v1\");\n+\t\t\n+\t\tassertTrue(theExpConceptMapV1.isPresent());\n+\t\tassertEquals(theUrl, theExpConceptMapV1.get().getUrl());\n+\t\tassertEquals(\"v1\", theExpConceptMapV1.get().getVersion());\n+\t\t\n+\t\t// should return the latest one which is v2", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ3MzA1Mg=="}, "originalCommit": {"oid": "c873b6d6dd382717ba5ff9c6683abfe9a4c6837e"}, "originalPosition": 105}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0Mjk1NTg5OnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/dstu3/ResourceProviderDstu3ConceptMapTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNjoyOTo0N1rOHP8Qnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwMDo1ODoyM1rOHQKl1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ3Nzk4Mw==", "bodyText": "nitpick: method ConceptMap spelled as ConcaptMap in the method name.", "url": "https://github.com/hapifhir/hapi-fhir/pull/2067#discussion_r486477983", "createdAt": "2020-09-10T16:29:47Z", "author": {"login": "IanMMarshall"}, "path": "hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/dstu3/ResourceProviderDstu3ConceptMapTest.java", "diffHunk": "@@ -114,4 +127,287 @@ public void testTranslateByCodeSystemsAndSourceCodeOneToMany() {\n \t\tpart = getPartByName(param, \"source\");\n \t\tassertEquals(CM_URL, ((UriType) part.getValue()).getValueAsString());\n \t}\n+\t\n+\t@Test\n+\tpublic void testTranslateWithConcaptMapUrlAndVersion() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c873b6d6dd382717ba5ff9c6683abfe9a4c6837e"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcxMjc4OQ==", "bodyText": "Fixed", "url": "https://github.com/hapifhir/hapi-fhir/pull/2067#discussion_r486712789", "createdAt": "2020-09-11T00:58:23Z", "author": {"login": "frankjtao"}, "path": "hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/dstu3/ResourceProviderDstu3ConceptMapTest.java", "diffHunk": "@@ -114,4 +127,287 @@ public void testTranslateByCodeSystemsAndSourceCodeOneToMany() {\n \t\tpart = getPartByName(param, \"source\");\n \t\tassertEquals(CM_URL, ((UriType) part.getValue()).getValueAsString());\n \t}\n+\t\n+\t@Test\n+\tpublic void testTranslateWithConcaptMapUrlAndVersion() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ3Nzk4Mw=="}, "originalCommit": {"oid": "c873b6d6dd382717ba5ff9c6683abfe9a4c6837e"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0Mjk2OTgwOnYy", "diffSide": "RIGHT", "path": "hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/dstu3/ResourceProviderDstu3ConceptMap_Ian_Test.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNjozMzoyNFrOHP8ZiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwMToxNjoxN1rOHQK37A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ4MDI2NQ==", "bodyText": "You can remove this class now (I added it for illustration purposes, but the ResourceProviderDstu3ConceptMapTest class provides adequate coverage now).", "url": "https://github.com/hapifhir/hapi-fhir/pull/2067#discussion_r486480265", "createdAt": "2020-09-10T16:33:24Z", "author": {"login": "IanMMarshall"}, "path": "hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/dstu3/ResourceProviderDstu3ConceptMap_Ian_Test.java", "diffHunk": "@@ -0,0 +1,296 @@\n+package ca.uhn.fhir.jpa.provider.dstu3;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c873b6d6dd382717ba5ff9c6683abfe9a4c6837e"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcxNzQyMA==", "bodyText": "This is class is removed and the test cases are merged to ResourceProviderDstu3ConceptMapTest class", "url": "https://github.com/hapifhir/hapi-fhir/pull/2067#discussion_r486717420", "createdAt": "2020-09-11T01:16:17Z", "author": {"login": "frankjtao"}, "path": "hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/dstu3/ResourceProviderDstu3ConceptMap_Ian_Test.java", "diffHunk": "@@ -0,0 +1,296 @@\n+package ca.uhn.fhir.jpa.provider.dstu3;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ4MDI2NQ=="}, "originalCommit": {"oid": "c873b6d6dd382717ba5ff9c6683abfe9a4c6837e"}, "originalPosition": 1}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1774, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}