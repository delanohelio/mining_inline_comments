{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQxNjg3ODQx", "number": 1951, "title": "Allow search criteria as subscription delivery mechanism", "bodyText": "", "createdAt": "2020-06-29T22:47:34Z", "url": "https://github.com/hapifhir/hapi-fhir/pull/1951", "merged": true, "mergeCommit": {"oid": "fa4bbe368517b2255c96544e6574619bb59deabb"}, "closed": true, "closedAt": "2020-06-30T18:29:10Z", "author": {"login": "jamesagnew"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcsRlr9AH2gAyNDQxNjg3ODQxOmY3NGViYTUzOTdkNDBmOTQ4OTcwYzBmYzc3ZWY3MjFiMDIxZGU0NmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwW3v3gFqTQ0MDAzNjE3OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f74eba5397d40f948970c0fc77ef721b021de46a", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/f74eba5397d40f948970c0fc77ef721b021de46a", "committedDate": "2020-06-17T22:28:18Z", "message": "Terser should create correct Enumeration on create"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64a9eaa4de38b5b16c0b5d8f3727634c897f06de", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/64a9eaa4de38b5b16c0b5d8f3727634c897f06de", "committedDate": "2020-06-17T22:32:17Z", "message": "Start work"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52addcff5916ee3f32b245f464dfa13f4e1c6ac8", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/52addcff5916ee3f32b245f464dfa13f4e1c6ac8", "committedDate": "2020-06-27T22:09:23Z", "message": "Merge branch 'master' into ja_20200617_subscription_send_bundles"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed2e62752efc828c16e0ca772c76ca1428610777", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/ed2e62752efc828c16e0ca772c76ca1428610777", "committedDate": "2020-06-29T13:39:10Z", "message": "Work on subscriptions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7cde945281890ce34023a1e954a24503f2741809", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/7cde945281890ce34023a1e954a24503f2741809", "committedDate": "2020-06-29T21:10:33Z", "message": "Work on seed bundles"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88bd4abf0cf105765e622a2fedd18b265ec8fbbe", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/88bd4abf0cf105765e622a2fedd18b265ec8fbbe", "committedDate": "2020-06-29T21:31:23Z", "message": "Merge branch 'master' into ja_20200617_subscription_send_bundles"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a1d7383b0c7d119acf0f97866be902c61cff0f5", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/4a1d7383b0c7d119acf0f97866be902c61cff0f5", "committedDate": "2020-06-29T22:46:52Z", "message": "Bundle transmission"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ebcceeb5ca314313c197ff8543a87343e82a7a1", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/6ebcceeb5ca314313c197ff8543a87343e82a7a1", "committedDate": "2020-06-29T22:49:01Z", "message": "Add changelog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b650fdb9ea7d09bdc1f9f811727e6d23bbf153ce", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/b650fdb9ea7d09bdc1f9f811727e6d23bbf153ce", "committedDate": "2020-06-30T13:20:52Z", "message": "Test fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11c4f9defba581132a340a2e5f189a934e829b67", "author": {"user": {"login": "jamesagnew", "name": "James Agnew"}}, "url": "https://github.com/hapifhir/hapi-fhir/commit/11c4f9defba581132a340a2e5f189a934e829b67", "committedDate": "2020-06-30T13:38:16Z", "message": "Fix LGTM warning"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwMDM2MTc4", "url": "https://github.com/hapifhir/hapi-fhir/pull/1951#pullrequestreview-440036178", "createdAt": "2020-06-30T13:51:48Z", "commit": {"oid": "11c4f9defba581132a340a2e5f189a934e829b67"}, "state": "APPROVED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxMzo1MTo0OFrOGq9Yzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNDo1MzowNFrOGrAT4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzY5OTE1MQ==", "bodyText": "Version independent builder.  Nice!", "url": "https://github.com/hapifhir/hapi-fhir/pull/1951#discussion_r447699151", "createdAt": "2020-06-30T13:51:48Z", "author": {"login": "fil512"}, "path": "hapi-fhir-base/src/main/java/ca/uhn/fhir/util/TransactionBuilder.java", "diffHunk": "@@ -0,0 +1,110 @@\n+package ca.uhn.fhir.util;\n+\n+import ca.uhn.fhir.context.BaseRuntimeChildDefinition;\n+import ca.uhn.fhir.context.BaseRuntimeElementDefinition;\n+import ca.uhn.fhir.context.FhirContext;\n+import ca.uhn.fhir.context.RuntimeResourceDefinition;\n+import org.hl7.fhir.instance.model.api.IBase;\n+import org.hl7.fhir.instance.model.api.IBaseBundle;\n+import org.hl7.fhir.instance.model.api.IBaseResource;\n+import org.hl7.fhir.instance.model.api.IPrimitiveType;\n+import org.thymeleaf.util.Validate;\n+\n+/**\n+ * This class can be used to build a Bundle resource to be used as a FHIR transaction.\n+ *\n+ * This is not yet complete, and doesn't support all FHIR features. <b>USE WITH CAUTION</b> as the API\n+ * may change.\n+ *\n+ * @since 5.1.0\n+ */\n+public class TransactionBuilder {\n+\n+\tprivate final FhirContext myContext;\n+\tprivate final IBaseBundle myBundle;\n+\tprivate final RuntimeResourceDefinition myBundleDef;\n+\tprivate final BaseRuntimeChildDefinition myEntryChild;\n+\tprivate final BaseRuntimeElementDefinition<?> myEntryDef;\n+\tprivate final BaseRuntimeChildDefinition myEntryResourceChild;\n+\tprivate final BaseRuntimeChildDefinition myEntryFullUrlChild;\n+\tprivate final BaseRuntimeChildDefinition myEntryRequestChild;\n+\tprivate final BaseRuntimeElementDefinition<?> myEntryRequestDef;\n+\tprivate final BaseRuntimeChildDefinition myEntryRequestUrlChild;\n+\tprivate final BaseRuntimeChildDefinition myEntryRequestMethodChild;\n+\tprivate final BaseRuntimeElementDefinition<?> myEntryRequestMethodDef;\n+\n+\t/**\n+\t * Constructor\n+\t */\n+\tpublic TransactionBuilder(FhirContext theContext) {\n+\t\tmyContext = theContext;\n+\n+\t\tmyBundleDef = myContext.getResourceDefinition(\"Bundle\");\n+\t\tmyBundle = (IBaseBundle) myBundleDef.newInstance();\n+\n+\t\tBaseRuntimeChildDefinition typeChild = myBundleDef.getChildByName(\"type\");\n+\t\tIPrimitiveType<?> type = (IPrimitiveType<?>) typeChild.getChildByName(\"type\").newInstance(typeChild.getInstanceConstructorArguments());\n+\t\ttype.setValueAsString(\"transaction\");\n+\t\ttypeChild.getMutator().setValue(myBundle, type);\n+\n+\t\tmyEntryChild = myBundleDef.getChildByName(\"entry\");\n+\t\tmyEntryDef = myEntryChild.getChildByName(\"entry\");\n+\n+\t\tmyEntryResourceChild = myEntryDef.getChildByName(\"resource\");\n+\t\tmyEntryFullUrlChild = myEntryDef.getChildByName(\"fullUrl\");\n+\n+\t\tmyEntryRequestChild = myEntryDef.getChildByName(\"request\");\n+\t\tmyEntryRequestDef = myEntryRequestChild.getChildByName(\"request\");\n+\n+\t\tmyEntryRequestUrlChild = myEntryRequestDef.getChildByName(\"url\");\n+\t\t\n+\t\tmyEntryRequestMethodChild = myEntryRequestDef.getChildByName(\"method\");\n+\t\tmyEntryRequestMethodDef = myEntryRequestMethodChild.getChildByName(\"method\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11c4f9defba581132a340a2e5f189a934e829b67"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzcwMjYwMw==", "bodyText": "Can we move all the hapi resource extensions into their own constants class?  This class could live in a non jpa module so it's available to non-jpa implementations.", "url": "https://github.com/hapifhir/hapi-fhir/pull/1951#discussion_r447702603", "createdAt": "2020-06-30T13:56:15Z", "author": {"login": "fil512"}, "path": "hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/subscription/resthook/RestHookTestR4Test.java", "diffHunk": "@@ -1013,4 +1013,39 @@ public void testCustomSearchParam() throws Exception {\n \t}\n \n \n+\t@Test\n+\tpublic void testDeliverSearchResult() throws Exception {\n+\t\t{\n+\t\t\tSubscription subscription = newSubscription(\"Observation?\", \"application/json\");\n+\t\t\tsubscription.addExtension(JpaConstants.EXT_SUBSCRIPTION_PAYLOAD_SEARCH_RESULT, new StringType(\"Observation?_id=${matched_resource_id}&_include=*\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11c4f9defba581132a340a2e5f189a934e829b67"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzcwNDQzMg==", "bodyText": "nitipck: theFlags.length > 0 is redundant", "url": "https://github.com/hapifhir/hapi-fhir/pull/1951#discussion_r447704432", "createdAt": "2020-06-30T13:58:38Z", "author": {"login": "fil512"}, "path": "hapi-fhir-jpaserver-searchparam/src/main/java/ca/uhn/fhir/jpa/searchparam/MatchUrlService.java", "diffHunk": "@@ -79,6 +80,13 @@ public SearchParameterMap translateMatchUrl(String theMatchUrl, RuntimeResourceD\n \n \t\tfor (String nextParamName : nameToParamLists.keySet()) {\n \t\t\tList<QualifiedParamList> paramList = nameToParamLists.get(nextParamName);\n+\n+\t\t\tif (theFlags != null && theFlags.length > 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11c4f9defba581132a340a2e5f189a934e829b67"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc0MTc2MQ==", "bodyText": "Nitpick: this adds more than one responsibility to this class.  single-responsibility classes are easier to test.", "url": "https://github.com/hapifhir/hapi-fhir/pull/1951#discussion_r447741761", "createdAt": "2020-06-30T14:46:29Z", "author": {"login": "fil512"}, "path": "hapi-fhir-jpaserver-subscription/src/main/java/ca/uhn/fhir/jpa/subscription/match/deliver/resthook/SubscriptionDeliveringRestHookSubscriber.java", "diffHunk": "@@ -81,55 +90,82 @@ protected void deliverPayload(ResourceDeliveryMessage theMsg, CanonicalSubscript\n \n \tprotected void doDelivery(ResourceDeliveryMessage theMsg, CanonicalSubscription theSubscription, EncodingEnum thePayloadType, IGenericClient theClient, IBaseResource thePayloadResource) {\n \t\tIClientExecutable<?, ?> operation;\n+\n+\t\tif (isNotBlank(theSubscription.getPayloadSearchResult())) {\n+\t\t\toperation = createDeliveryRequestTransaction(theSubscription, theClient, thePayloadResource);\n+\t\t} else if (thePayloadType != null) {\n+\t\t\toperation = createDeliveryRequestNormal(theMsg, theClient, thePayloadResource);\n+\t\t} else {\n+\t\t\tsendNotification(theMsg);\n+\t\t\toperation = null;\n+\t\t}\n+\n+\t\tif (operation != null) {\n+\n+\t\t\tif (thePayloadType != null) {\n+\t\t\t\toperation.encoded(thePayloadType);\n+\t\t\t}\n+\n+\t\t\tString payloadId = thePayloadResource.getIdElement().toUnqualified().getValue();\n+\t\t\tourLog.info(\"Delivering {} rest-hook payload {} for {}\", theMsg.getOperationType(), payloadId, theSubscription.getIdElement(myFhirContext).toUnqualifiedVersionless().getValue());\n+\n+\t\t\ttry {\n+\t\t\t\toperation.execute();\n+\t\t\t} catch (ResourceNotFoundException e) {\n+\t\t\t\tourLog.error(\"Cannot reach {} \", theMsg.getSubscription().getEndpointUrl());\n+\t\t\t\tourLog.error(\"Exception: \", e);\n+\t\t\t\tthrow e;\n+\t\t\t}\n+\n+\t\t}\n+\t}\n+\n+\t@Nullable\n+\tprivate IClientExecutable<?, ?> createDeliveryRequestNormal(ResourceDeliveryMessage theMsg, IGenericClient theClient, IBaseResource thePayloadResource) {\n+\t\tIClientExecutable<?, ?> operation;\n \t\tswitch (theMsg.getOperationType()) {\n \t\t\tcase CREATE:\n \t\t\tcase UPDATE:\n-\t\t\t\tif (thePayloadResource == null || thePayloadResource.isEmpty()) {\n-\t\t\t\t\tif (thePayloadType != null) {\n-\t\t\t\t\t\toperation = theClient.create().resource(thePayloadResource);\n-\t\t\t\t\t} else {\n-\t\t\t\t\t\tsendNotification(theMsg);\n-\t\t\t\t\t\treturn;\n-\t\t\t\t\t}\n-\t\t\t\t} else {\n-\t\t\t\t\tif (thePayloadType != null) {\n-\t\t\t\t\t\toperation = theClient.update().resource(thePayloadResource);\n-\t\t\t\t\t} else {\n-\t\t\t\t\t\tsendNotification(theMsg);\n-\t\t\t\t\t\treturn;\n-\t\t\t\t\t}\n-\t\t\t\t}\n+\t\t\t\toperation = theClient.update().resource(thePayloadResource);\n \t\t\t\tbreak;\n \t\t\tcase DELETE:\n \t\t\t\toperation = theClient.delete().resourceById(theMsg.getPayloadId(myFhirContext));\n \t\t\t\tbreak;\n \t\t\tdefault:\n \t\t\t\tourLog.warn(\"Ignoring delivery message of type: {}\", theMsg.getOperationType());\n-\t\t\t\treturn;\n+\t\t\t\toperation = null;\n+\t\t\t\tbreak;\n \t\t}\n+\t\treturn operation;\n+\t}\n \n-\t\tif (thePayloadType != null) {\n-\t\t\toperation.encoded(thePayloadType);\n-\t\t}\n+\tprivate IClientExecutable<?, ?> createDeliveryRequestTransaction(CanonicalSubscription theSubscription, IGenericClient theClient, IBaseResource thePayloadResource) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11c4f9defba581132a340a2e5f189a934e829b67"}, "originalPosition": 115}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc0NDY3MQ==", "bodyText": "Is this a payloadSearchCriteria as opposed to a payloadSearchResult?", "url": "https://github.com/hapifhir/hapi-fhir/pull/1951#discussion_r447744671", "createdAt": "2020-06-30T14:50:10Z", "author": {"login": "fil512"}, "path": "hapi-fhir-jpaserver-subscription/src/main/java/ca/uhn/fhir/jpa/subscription/model/CanonicalSubscription.java", "diffHunk": "@@ -64,6 +68,8 @@\n \tprivate RestHookDetails myRestHookDetails;\n \t@JsonProperty(\"extensions\")\n \tprivate Map<String, List<String>> myChannelExtensions;\n+\t@JsonProperty(\"payloadSearchResult\")\n+\tprivate String myPayloadSearchResult;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11c4f9defba581132a340a2e5f189a934e829b67"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc0NTIwOQ==", "bodyText": "nice!", "url": "https://github.com/hapifhir/hapi-fhir/pull/1951#discussion_r447745209", "createdAt": "2020-06-30T14:50:51Z", "author": {"login": "fil512"}, "path": "hapi-fhir-jpaserver-subscription/src/main/java/ca/uhn/fhir/jpa/subscription/submit/interceptor/SubscriptionValidatingInterceptor.java", "diffHunk": "@@ -96,39 +97,48 @@ public void validateSubmittedSubscription(IBaseResource theSubscription) {\n \n \t\tif (!finished) {\n \n-\t\t\tString query = subscription.getCriteriaString();\n-\t\t\tif (isBlank(query)) {\n-\t\t\t\tthrow new UnprocessableEntityException(\"Subscription.criteria must be populated\");\n-\t\t\t}\n-\n-\t\t\tint sep = query.indexOf('?');\n-\t\t\tif (sep <= 1) {\n-\t\t\t\tthrow new UnprocessableEntityException(\"Subscription.criteria must be in the form \\\"{Resource Type}?[params]\\\"\");\n-\t\t\t}\n+\t\t\tvalidateQuery(subscription.getCriteriaString(), \"Subscription.criteria\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11c4f9defba581132a340a2e5f189a934e829b67"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc0NzA0Mg==", "bodyText": "Unrelated question, what do you think about having a statically cached TestFhirContext.R4 ?  I wonder if it would speed up our tests...", "url": "https://github.com/hapifhir/hapi-fhir/pull/1951#discussion_r447747042", "createdAt": "2020-06-30T14:53:04Z", "author": {"login": "fil512"}, "path": "hapi-fhir-structures-r4/src/test/java/ca/uhn/fhir/util/TransactionBuilderTest.java", "diffHunk": "@@ -0,0 +1,40 @@\n+package ca.uhn.fhir.util;\n+\n+import ca.uhn.fhir.context.FhirContext;\n+import org.hl7.fhir.r4.model.Bundle;\n+import org.hl7.fhir.r4.model.Patient;\n+import org.hl7.fhir.r4.model.codesystems.HttpVerb;\n+import org.junit.Test;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertSame;\n+\n+public class TransactionBuilderTest {\n+\tprivate static final Logger ourLog = LoggerFactory.getLogger(TransactionBuilderTest.class);\n+\tprivate FhirContext myFhirContext = FhirContext.forR4();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11c4f9defba581132a340a2e5f189a934e829b67"}, "originalPosition": 16}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3973, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}