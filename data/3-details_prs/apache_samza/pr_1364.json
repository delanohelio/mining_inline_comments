{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE5Nzc4Nzk3", "number": 1364, "title": "SAMZA-2534: AzureBlobSystemProducer: Enable adding of number of records in blob as metadata of the blob", "bodyText": "Feature: Enable addition of number of records in a blob to the blob's metadata.\nChanges: BlobMetadataContext passed as input to BlobMetadataGenerator interface now have an additional field giving the number of records in the blob. This can be used as needed by the generator.\nAPI changes: BlobMetadataContext passed as input to BlobMetadataGenerator interface now have an additional field giving the number of records in the blob. This can be used as needed by the generator.\nUpgrade Instructions: None\nUsage Instructions: None\nTests: unit test updated.", "createdAt": "2020-05-18T22:44:31Z", "url": "https://github.com/apache/samza/pull/1364", "merged": true, "mergeCommit": {"oid": "583da7764e2db6541b974ce61db7e1f555d02c4e"}, "closed": true, "closedAt": "2020-05-27T23:55:29Z", "author": {"login": "lakshmi-manasa-g"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcimRZTAH2gAyNDE5Nzc4Nzk3OjZhYzU1ZmU2NmU1N2FhNmUxMWE2N2RhY2VmMTRiYzYyZjFkMzY5NmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABclgeNFAFqTQxOTYzNTAyMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6ac55fe66e57aa6e11a67dacef14bc62f1d3696a", "author": {"user": {"login": "lakshmi-manasa-g", "name": null}}, "url": "https://github.com/apache/samza/commit/6ac55fe66e57aa6e11a67dacef14bc62f1d3696a", "committedDate": "2020-05-18T20:54:54Z", "message": "AzureBlobSystemProducer: Enable adding of number of records in blob as metadata of the blob"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1MDIxMDU1", "url": "https://github.com/apache/samza/pull/1364#pullrequestreview-415021055", "createdAt": "2020-05-20T06:17:35Z", "commit": {"oid": "6ac55fe66e57aa6e11a67dacef14bc62f1d3696a"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQwNjoxNzozNlrOGX8tLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQwNjozMDoxNFrOGX9AaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzc2NTAzOQ==", "bodyText": "Would it be better to use AtomicLong here to ensure that all access to the member are atomic?", "url": "https://github.com/apache/samza/pull/1364#discussion_r427765039", "createdAt": "2020-05-20T06:17:36Z", "author": {"login": "bkonold"}, "path": "samza-azure/src/main/java/org/apache/samza/system/azureblob/avro/AzureBlobOutputStream.java", "diffHunk": "@@ -85,6 +85,7 @@\n \n   private volatile boolean isClosed = false;\n   private long totalUploadedBlockSize = 0;\n+  private long totalNumberOfRecordsInBlob = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ac55fe66e57aa6e11a67dacef14bc62f1d3696a"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzc2OTgyNg==", "bodyText": "Was there any consideration given to using AtomicLong here instead? If threading is involved, it could more clearly express that any modifications will be atomic without the need to worry about method synchronization.", "url": "https://github.com/apache/samza/pull/1364#discussion_r427769826", "createdAt": "2020-05-20T06:29:55Z", "author": {"login": "bkonold"}, "path": "samza-azure/src/main/java/org/apache/samza/system/azureblob/avro/AzureBlobOutputStream.java", "diffHunk": "@@ -85,6 +85,7 @@\n \n   private volatile boolean isClosed = false;\n   private long totalUploadedBlockSize = 0;\n+  private long totalNumberOfRecordsInBlob = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ac55fe66e57aa6e11a67dacef14bc62f1d3696a"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzc2OTk2MA==", "bodyText": "What will this be used for or what do we anticipate it will be used for?", "url": "https://github.com/apache/samza/pull/1364#discussion_r427769960", "createdAt": "2020-05-20T06:30:14Z", "author": {"login": "bkonold"}, "path": "samza-azure/src/main/java/org/apache/samza/system/azureblob/utils/BlobMetadataContext.java", "diffHunk": "@@ -25,10 +25,12 @@\n public class BlobMetadataContext {\n   private final String streamName;\n   private final long blobSize;\n+  private final long numberOfMessagesInBlob;\n \n-  public BlobMetadataContext(String streamName, long blobSize) {\n+  public BlobMetadataContext(String streamName, long blobSize, long numberOfMessagesInBlob) {\n     this.streamName = streamName;\n     this.blobSize = blobSize;\n+    this.numberOfMessagesInBlob = numberOfMessagesInBlob;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ac55fe66e57aa6e11a67dacef14bc62f1d3696a"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1MDY1MDE1", "url": "https://github.com/apache/samza/pull/1364#pullrequestreview-415065015", "createdAt": "2020-05-20T07:34:25Z", "commit": {"oid": "6ac55fe66e57aa6e11a67dacef14bc62f1d3696a"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQwNzozNDoyNVrOGX-0rA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQwNzo0NzowNlrOGX_P6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzc5OTcyNA==", "bodyText": "Cool. That's fine then.", "url": "https://github.com/apache/samza/pull/1364#discussion_r427799724", "createdAt": "2020-05-20T07:34:25Z", "author": {"login": "bkonold"}, "path": "samza-azure/src/main/java/org/apache/samza/system/azureblob/avro/AzureBlobOutputStream.java", "diffHunk": "@@ -85,6 +85,7 @@\n \n   private volatile boolean isClosed = false;\n   private long totalUploadedBlockSize = 0;\n+  private long totalNumberOfRecordsInBlob = 0;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzc2OTgyNg=="}, "originalCommit": {"oid": "6ac55fe66e57aa6e11a67dacef14bc62f1d3696a"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzgwNjY5OQ==", "bodyText": "I see. Thanks for explaining.\nI notice that the interface of the generator takes a BlobMetadataContext and returns a Map<String,String>; out of curiosity, is it intended that a generator may have additional metadata (beyond what is carried within the BlobMetadataContext) to attach to the blob?", "url": "https://github.com/apache/samza/pull/1364#discussion_r427806699", "createdAt": "2020-05-20T07:47:06Z", "author": {"login": "bkonold"}, "path": "samza-azure/src/main/java/org/apache/samza/system/azureblob/utils/BlobMetadataContext.java", "diffHunk": "@@ -25,10 +25,12 @@\n public class BlobMetadataContext {\n   private final String streamName;\n   private final long blobSize;\n+  private final long numberOfMessagesInBlob;\n \n-  public BlobMetadataContext(String streamName, long blobSize) {\n+  public BlobMetadataContext(String streamName, long blobSize, long numberOfMessagesInBlob) {\n     this.streamName = streamName;\n     this.blobSize = blobSize;\n+    this.numberOfMessagesInBlob = numberOfMessagesInBlob;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzc2OTk2MA=="}, "originalCommit": {"oid": "6ac55fe66e57aa6e11a67dacef14bc62f1d3696a"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3MTQ3Nzkx", "url": "https://github.com/apache/samza/pull/1364#pullrequestreview-417147791", "createdAt": "2020-05-22T19:38:07Z", "commit": {"oid": "6ac55fe66e57aa6e11a67dacef14bc62f1d3696a"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxOTozODowN1rOGZh-Aw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxOTozODowN1rOGZh-Aw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQyNDEzMQ==", "bodyText": "I suggest adding some javadocs here to clarify how this needs to be used (i.e. only for passing metadata for the blob when closing the blob).\nSince DataFileWriter may still be buffering some data, this totalNumberOfRecordsInBlob may not reflect the exact number of records in the output stream until flush/close are actually called. Also, it would be good to clarify that this needs to be atomically incremented along with appending the record to the DataFileWriter (or else the final record count may not be correct when closing the blob). It looks like you are doing the atomic update already in AzureBlobAvroWriter, but the general management of writers and output streams is a bit complex, so it would be good to add some more details.", "url": "https://github.com/apache/samza/pull/1364#discussion_r429424131", "createdAt": "2020-05-22T19:38:07Z", "author": {"login": "cameronlee314"}, "path": "samza-azure/src/main/java/org/apache/samza/system/azureblob/avro/AzureBlobOutputStream.java", "diffHunk": "@@ -230,6 +231,10 @@ public synchronized void releaseBuffer() throws IOException {\n     }\n   }\n \n+  public synchronized void incrementNumberOfRecordsInBlob() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ac55fe66e57aa6e11a67dacef14bc62f1d3696a"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "926a2cb84a11604e974b7ab6cf3884f8ddd3dfba", "author": {"user": {"login": "lakshmi-manasa-g", "name": null}}, "url": "https://github.com/apache/samza/commit/926a2cb84a11604e974b7ab6cf3884f8ddd3dfba", "committedDate": "2020-05-27T19:27:46Z", "message": "add java doc to clarify incrementNumberOfRecordsInBlob"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5NjM1MDIy", "url": "https://github.com/apache/samza/pull/1364#pullrequestreview-419635022", "createdAt": "2020-05-27T21:51:14Z", "commit": {"oid": "926a2cb84a11604e974b7ab6cf3884f8ddd3dfba"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4601, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}