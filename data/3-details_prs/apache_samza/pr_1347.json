{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAzNTIwOTEy", "number": 1347, "title": "SAMZA-2511 : Adding logic to handle container stop fail ", "bodyText": "Problem: The standby container manager does not handle container-stop-failures.\nThese events can happen as a result of certificate/authentication issue during the execution of the container-stop. The problem is the standby-container-failover flow relies on a stop-container succeeding and in this case does not complete the failover. This means the active container, for which a failover was initiated, is never started again.\nIn case of a container-placement action, that runs into container-stop-fail, the action is declared as failed.\nCause: Above.\nFix: The fix is for standby-container-manager to intercept and handle these events by continuing the failover by either selecting another standby container (if one is present i.e., rf > 2) or using a standby host or using any-host.\nAPI changes: None\nUpgrade Instructions: None", "createdAt": "2020-04-15T03:31:34Z", "url": "https://github.com/apache/samza/pull/1347", "merged": true, "mergeCommit": {"oid": "9eadad1a4f8f14619bb31c1fda526f656b4f5751"}, "closed": true, "closedAt": "2020-04-16T17:01:28Z", "author": {"login": "rmatharu"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcXvakfAH2gAyNDAzNTIwOTEyOjhlNTA5ZmMxOGY4MmYxYjdhNjMzNGEwMmY0MTUwNjYxNTE3OTAxYzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcYDLlbAH2gAyNDAzNTIwOTEyOjhlN2QwZjA4ZWQzNjFkZTVmNmM2ZDczMTJkOWY4MzI5NDdjY2IxMTI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8e509fc18f82f1b7a6334a02f4150661517901c9", "author": {"user": null}, "url": "https://github.com/apache/samza/commit/8e509fc18f82f1b7a6334a02f4150661517901c9", "committedDate": "2020-04-15T03:20:54Z", "message": "Adding logic to handle container stop fail"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzNDUxMTM1", "url": "https://github.com/apache/samza/pull/1347#pullrequestreview-393451135", "createdAt": "2020-04-15T04:40:04Z", "commit": {"oid": "8e509fc18f82f1b7a6334a02f4150661517901c9"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQwNDo0MDowNFrOGFpiNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQwNDo1MjozNVrOGFpuAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODU3NjU2Ng==", "bodyText": "ContainerAllocator only relinquishes resources when there are no requests in the queue. It will be worth manually releasing the resource in this case.", "url": "https://github.com/apache/samza/pull/1347#discussion_r408576566", "createdAt": "2020-04-15T04:40:04Z", "author": {"login": "Sanil15"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ContainerManager.java", "diffHunk": "@@ -233,6 +233,30 @@ void handleContainerLaunchFail(String processorId, String containerId, String pr\n     }\n   }\n \n+  /**\n+   * Handle the container stop failure for active containers and standby (if enabled).\n+   * @param processorId logical id of the container eg 1,2,3\n+   * @param containerId last known id of the container deployed\n+   * @param containerHost host on which container is requested to be deployed\n+   * @param containerAllocator allocator for requesting resources\n+   */\n+  void handleContainerStopFail(String processorId, String containerId, String containerHost,\n+      ContainerAllocator containerAllocator) {\n+    if (processorId != null && hasActiveContainerPlacementAction(processorId)) {\n+      // Assuming resource acquired on destination host will be relinquished by the containerAllocator,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e509fc18f82f1b7a6334a02f4150661517901c9"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODU3OTU4NA==", "bodyText": "In the case of ContainerPlacement actions, request in the allocator is waiting for active container to stop and since the active container stop fails here, you also want to cancel the resource request tied to the placement action\nresourceRequestState.cancelResourceRequest(request);\nI believe ContainerPlacementMetadata maintains a set the resource-request that we can read, but only need to cancel the latest one from that set (since that is the one that is active)", "url": "https://github.com/apache/samza/pull/1347#discussion_r408579584", "createdAt": "2020-04-15T04:52:35Z", "author": {"login": "Sanil15"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ContainerManager.java", "diffHunk": "@@ -233,6 +233,30 @@ void handleContainerLaunchFail(String processorId, String containerId, String pr\n     }\n   }\n \n+  /**\n+   * Handle the container stop failure for active containers and standby (if enabled).\n+   * @param processorId logical id of the container eg 1,2,3\n+   * @param containerId last known id of the container deployed\n+   * @param containerHost host on which container is requested to be deployed\n+   * @param containerAllocator allocator for requesting resources\n+   */\n+  void handleContainerStopFail(String processorId, String containerId, String containerHost,\n+      ContainerAllocator containerAllocator) {\n+    if (processorId != null && hasActiveContainerPlacementAction(processorId)) {\n+      // Assuming resource acquired on destination host will be relinquished by the containerAllocator,\n+      // we mark the placement action as failed, and return.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e509fc18f82f1b7a6334a02f4150661517901c9"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ddebe6e954a27aba3276b25def49eb65e42bba28", "author": {"user": null}, "url": "https://github.com/apache/samza/commit/ddebe6e954a27aba3276b25def49eb65e42bba28", "committedDate": "2020-04-15T18:17:14Z", "message": "Fixing test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "187a3857b31b570b4511c9d30f35a6619ac0b4bb", "author": {"user": null}, "url": "https://github.com/apache/samza/commit/187a3857b31b570b4511c9d30f35a6619ac0b4bb", "committedDate": "2020-04-15T18:52:04Z", "message": "Adding cancel resource request"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8ce199bbda43bd45b5732e9622df7fd4174d0c7", "author": {"user": null}, "url": "https://github.com/apache/samza/commit/f8ce199bbda43bd45b5732e9622df7fd4174d0c7", "committedDate": "2020-04-15T20:27:59Z", "message": "Adding status for stop-failed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0MjI0NTI4", "url": "https://github.com/apache/samza/pull/1347#pullrequestreview-394224528", "createdAt": "2020-04-16T00:36:55Z", "commit": {"oid": "f8ce199bbda43bd45b5732e9622df7fd4174d0c7"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwMDozNjo1NVrOGGQYKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwMDo0NjozOFrOGGQi5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIxMjk2OA==", "bodyText": "AMRMAsync thread will do a container status update here, allocator thread marks the actions as failed. Please remove the comments.", "url": "https://github.com/apache/samza/pull/1347#discussion_r409212968", "createdAt": "2020-04-16T00:36:55Z", "author": {"login": "Sanil15"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ContainerManager.java", "diffHunk": "@@ -233,6 +239,28 @@ void handleContainerLaunchFail(String processorId, String containerId, String pr\n     }\n   }\n \n+  /**\n+   * Handle the container stop failure for active containers and standby (if enabled).\n+   * @param processorId logical id of the container eg 1,2,3\n+   * @param containerId last known id of the container deployed\n+   * @param containerHost host on which container is requested to be deployed\n+   * @param containerAllocator allocator for requesting resources\n+   */\n+  void handleContainerStopFail(String processorId, String containerId, String containerHost,\n+      ContainerAllocator containerAllocator) {\n+    if (processorId != null && hasActiveContainerPlacementAction(processorId)) {\n+      // Assuming resource acquired on destination host will be relinquished by the containerAllocator,\n+      // We mark the placement action as failed, and return.\n+      ContainerPlacementMetadata metaData = getPlacementActionMetadata(processorId).get();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f8ce199bbda43bd45b5732e9622df7fd4174d0c7"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIxNTA3OA==", "bodyText": "Please correct the comment here, Case 2. If this is an active container, throw an exception restart the AM.", "url": "https://github.com/apache/samza/pull/1347#discussion_r409215078", "createdAt": "2020-04-16T00:44:12Z", "author": {"login": "Sanil15"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java", "diffHunk": "@@ -126,6 +126,30 @@ public void handleContainerLaunchFail(String containerID, String resourceID,\n     }\n   }\n \n+  /**\n+   *  Handle the failed stop for a container, based on\n+   *  Case 1. If it is standby container, continue the failover\n+   *  Case 2. If it is an active container, then log a warning and return.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f8ce199bbda43bd45b5732e9622df7fd4174d0c7"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIxNTcxNw==", "bodyText": "nit: @param containerID logical id ex 0,1,2 of the failed samza container\n@param resourceID physical id of the failed container", "url": "https://github.com/apache/samza/pull/1347#discussion_r409215717", "createdAt": "2020-04-16T00:46:38Z", "author": {"login": "Sanil15"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java", "diffHunk": "@@ -126,6 +126,30 @@ public void handleContainerLaunchFail(String containerID, String resourceID,\n     }\n   }\n \n+  /**\n+   *  Handle the failed stop for a container, based on\n+   *  Case 1. If it is standby container, continue the failover\n+   *  Case 2. If it is an active container, then log a warning and return.\n+   * @param containerID the ID of the container that has failed", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f8ce199bbda43bd45b5732e9622df7fd4174d0c7"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0MjI4MjM1", "url": "https://github.com/apache/samza/pull/1347#pullrequestreview-394228235", "createdAt": "2020-04-16T00:48:47Z", "commit": {"oid": "f8ce199bbda43bd45b5732e9622df7fd4174d0c7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwMDo0ODo0N1rOGGQlWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwMDo0ODo0N1rOGGQlWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIxNjM0NQ==", "bodyText": "Please add a todo for adding an integ test for this, I can pick that up later!", "url": "https://github.com/apache/samza/pull/1347#discussion_r409216345", "createdAt": "2020-04-16T00:48:47Z", "author": {"login": "Sanil15"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ContainerManager.java", "diffHunk": "@@ -233,6 +239,28 @@ void handleContainerLaunchFail(String processorId, String containerId, String pr\n     }\n   }\n \n+  /**\n+   * Handle the container stop failure for active containers and standby (if enabled).\n+   * @param processorId logical id of the container eg 1,2,3\n+   * @param containerId last known id of the container deployed\n+   * @param containerHost host on which container is requested to be deployed\n+   * @param containerAllocator allocator for requesting resources\n+   */\n+  void handleContainerStopFail(String processorId, String containerId, String containerHost,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f8ce199bbda43bd45b5732e9622df7fd4174d0c7"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e7d0f08ed361de5f6c6d7312d9f832947ccb112", "author": {"user": null}, "url": "https://github.com/apache/samza/commit/8e7d0f08ed361de5f6c6d7312d9f832947ccb112", "committedDate": "2020-04-16T02:22:38Z", "message": "Adding comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4569, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}