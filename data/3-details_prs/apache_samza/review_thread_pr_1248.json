{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYxNTgzNjc0", "number": 1248, "reviewThreads": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMVQwMDo0MToyMFrODXTXbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxODoyNDoxMVrODY5oag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI1NzYxMTM0OnYy", "diffSide": "RIGHT", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMVQwMDo0MToyMFrOFcjREw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMVQwMToxMjoxNVrOFcjgvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ4MjI1OQ==", "bodyText": "Do we still need this method to return a list if RemoteApplicationRunner will only ever submit a single job?", "url": "https://github.com/apache/samza/pull/1248#discussion_r365482259", "createdAt": "2020-01-11T00:41:20Z", "author": {"login": "bkonold"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java", "diffHunk": "@@ -178,9 +185,35 @@\n   public ClusterBasedJobCoordinator(Config coordinatorSystemConfig) {\n     metrics = new MetricsRegistryMap();\n \n-    coordinatorStreamStore = new CoordinatorStreamStore(coordinatorSystemConfig, metrics);\n-    coordinatorStreamStore.init();\n-    config = CoordinatorStreamUtil.readConfigFromCoordinatorStream(coordinatorStreamStore);\n+    JobConfig jobConfig = new JobConfig(coordinatorSystemConfig);\n+\n+    if (jobConfig.getConfigLoaderFactory().isPresent()) {\n+      // load full job config with ConfigLoader\n+      Config originalConfig = ConfigUtil.loadConfig(coordinatorSystemConfig);\n+\n+      // Execute planning\n+      ApplicationDescriptorImpl<? extends ApplicationDescriptor>\n+          appDesc = ApplicationDescriptorUtil.getAppDescriptor(ApplicationUtil.fromConfig(originalConfig), originalConfig);\n+      RemoteJobPlanner planner = new RemoteJobPlanner(appDesc);\n+      List<JobConfig> jobConfigs = planner.prepareJobs();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d65377e8dacfe79f5a32b6ab196066e8a674e9f"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ4NjI3MA==", "bodyText": "Good question, both RemoteApplicationRunner and LocalJobPlanner themselves only works for single-job applications anyway, we may update them, but I think it is better to do it separately. It also relies on our plan to support multi job applications too.", "url": "https://github.com/apache/samza/pull/1248#discussion_r365486270", "createdAt": "2020-01-11T01:12:15Z", "author": {"login": "kw2542"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java", "diffHunk": "@@ -178,9 +185,35 @@\n   public ClusterBasedJobCoordinator(Config coordinatorSystemConfig) {\n     metrics = new MetricsRegistryMap();\n \n-    coordinatorStreamStore = new CoordinatorStreamStore(coordinatorSystemConfig, metrics);\n-    coordinatorStreamStore.init();\n-    config = CoordinatorStreamUtil.readConfigFromCoordinatorStream(coordinatorStreamStore);\n+    JobConfig jobConfig = new JobConfig(coordinatorSystemConfig);\n+\n+    if (jobConfig.getConfigLoaderFactory().isPresent()) {\n+      // load full job config with ConfigLoader\n+      Config originalConfig = ConfigUtil.loadConfig(coordinatorSystemConfig);\n+\n+      // Execute planning\n+      ApplicationDescriptorImpl<? extends ApplicationDescriptor>\n+          appDesc = ApplicationDescriptorUtil.getAppDescriptor(ApplicationUtil.fromConfig(originalConfig), originalConfig);\n+      RemoteJobPlanner planner = new RemoteJobPlanner(appDesc);\n+      List<JobConfig> jobConfigs = planner.prepareJobs();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ4MjI1OQ=="}, "originalCommit": {"oid": "0d65377e8dacfe79f5a32b6ab196066e8a674e9f"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI1NzYxOTQyOnYy", "diffSide": "RIGHT", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMVQwMDo0OToxMFrOFcjVuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMVQwMToxNDozOVrOFcjhhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ4MzQ0OA==", "bodyText": "s/submissionEnv/submissiongConfig?", "url": "https://github.com/apache/samza/pull/1248#discussion_r365483448", "createdAt": "2020-01-11T00:49:10Z", "author": {"login": "bkonold"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java", "diffHunk": "@@ -480,20 +512,41 @@ private static void executeRunClusterBasedJobCoordinatorForClass(Class<?> cluste\n    * {@link #main(String[])} so that it can be executed directly or from a separate classloader.\n    */\n   private static void runClusterBasedJobCoordinator(String[] args) {\n-    Config coordinatorSystemConfig;\n     final String coordinatorSystemEnv = System.getenv(ShellCommandConfig.ENV_COORDINATOR_SYSTEM_CONFIG());\n-    try {\n-      //Read and parse the coordinator system config.\n-      LOG.info(\"Parsing coordinator system config {}\", coordinatorSystemEnv);\n-      coordinatorSystemConfig =\n-          new MapConfig(SamzaObjectMapper.getObjectMapper().readValue(coordinatorSystemEnv, Config.class));\n-      LOG.info(\"Using the coordinator system config: {}.\", coordinatorSystemConfig);\n-    } catch (IOException e) {\n-      LOG.error(\"Exception while reading coordinator stream config\", e);\n-      throw new SamzaException(e);\n+    final String submissionEnv = System.getenv(ShellCommandConfig.ENV_SUBMISSION_CONFIG());\n+\n+    if (submissionEnv != null) {\n+      Config submissionConfig;\n+      try {\n+        //Read and parse the coordinator system config.\n+        LOG.info(\"Parsing submission config {}\", submissionEnv);\n+        submissionConfig =\n+            new MapConfig(SamzaObjectMapper.getObjectMapper().readValue(submissionEnv, Config.class));\n+        LOG.info(\"Using the submission config: {}.\", submissionEnv);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d65377e8dacfe79f5a32b6ab196066e8a674e9f"}, "originalPosition": 107}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ4NjQ2OA==", "bodyText": "Fixed.", "url": "https://github.com/apache/samza/pull/1248#discussion_r365486468", "createdAt": "2020-01-11T01:14:39Z", "author": {"login": "kw2542"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java", "diffHunk": "@@ -480,20 +512,41 @@ private static void executeRunClusterBasedJobCoordinatorForClass(Class<?> cluste\n    * {@link #main(String[])} so that it can be executed directly or from a separate classloader.\n    */\n   private static void runClusterBasedJobCoordinator(String[] args) {\n-    Config coordinatorSystemConfig;\n     final String coordinatorSystemEnv = System.getenv(ShellCommandConfig.ENV_COORDINATOR_SYSTEM_CONFIG());\n-    try {\n-      //Read and parse the coordinator system config.\n-      LOG.info(\"Parsing coordinator system config {}\", coordinatorSystemEnv);\n-      coordinatorSystemConfig =\n-          new MapConfig(SamzaObjectMapper.getObjectMapper().readValue(coordinatorSystemEnv, Config.class));\n-      LOG.info(\"Using the coordinator system config: {}.\", coordinatorSystemConfig);\n-    } catch (IOException e) {\n-      LOG.error(\"Exception while reading coordinator stream config\", e);\n-      throw new SamzaException(e);\n+    final String submissionEnv = System.getenv(ShellCommandConfig.ENV_SUBMISSION_CONFIG());\n+\n+    if (submissionEnv != null) {\n+      Config submissionConfig;\n+      try {\n+        //Read and parse the coordinator system config.\n+        LOG.info(\"Parsing submission config {}\", submissionEnv);\n+        submissionConfig =\n+            new MapConfig(SamzaObjectMapper.getObjectMapper().readValue(submissionEnv, Config.class));\n+        LOG.info(\"Using the submission config: {}.\", submissionEnv);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ4MzQ0OA=="}, "originalCommit": {"oid": "0d65377e8dacfe79f5a32b6ab196066e8a674e9f"}, "originalPosition": 107}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI1NzYyNzE5OnYy", "diffSide": "RIGHT", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMVQwMDo1ODo0NVrOFcjaqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMVQwMToyMToxOFrOFcjj3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ4NDcxMg==", "bodyText": "Why are we merging these config keys in? From what I see these were not being written to the coordinator stream previously but only built and sent along with the submission to the RM", "url": "https://github.com/apache/samza/pull/1248#discussion_r365484712", "createdAt": "2020-01-11T00:58:45Z", "author": {"login": "bkonold"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java", "diffHunk": "@@ -178,9 +185,35 @@\n   public ClusterBasedJobCoordinator(Config coordinatorSystemConfig) {\n     metrics = new MetricsRegistryMap();\n \n-    coordinatorStreamStore = new CoordinatorStreamStore(coordinatorSystemConfig, metrics);\n-    coordinatorStreamStore.init();\n-    config = CoordinatorStreamUtil.readConfigFromCoordinatorStream(coordinatorStreamStore);\n+    JobConfig jobConfig = new JobConfig(coordinatorSystemConfig);\n+\n+    if (jobConfig.getConfigLoaderFactory().isPresent()) {\n+      // load full job config with ConfigLoader\n+      Config originalConfig = ConfigUtil.loadConfig(coordinatorSystemConfig);\n+\n+      // Execute planning\n+      ApplicationDescriptorImpl<? extends ApplicationDescriptor>\n+          appDesc = ApplicationDescriptorUtil.getAppDescriptor(ApplicationUtil.fromConfig(originalConfig), originalConfig);\n+      RemoteJobPlanner planner = new RemoteJobPlanner(appDesc);\n+      List<JobConfig> jobConfigs = planner.prepareJobs();\n+\n+      if (jobConfigs.size() != 1) {\n+        throw new SamzaException(\"Only support single remote job is supported.\");\n+      }\n+\n+      // Merge with default coordinator stream config\n+      config = ConfigUtil.override(jobConfigs.get(0), CoordinatorStreamUtil.buildCoordinatorStreamConfig(jobConfigs.get(0)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d65377e8dacfe79f5a32b6ab196066e8a674e9f"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ4NzA3MQ==", "bodyText": "Good question, you are right, we should not need to merge it with the full job config, we only need to build it from the full job config and initialize CoordinatorStreamStore.", "url": "https://github.com/apache/samza/pull/1248#discussion_r365487071", "createdAt": "2020-01-11T01:21:18Z", "author": {"login": "kw2542"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java", "diffHunk": "@@ -178,9 +185,35 @@\n   public ClusterBasedJobCoordinator(Config coordinatorSystemConfig) {\n     metrics = new MetricsRegistryMap();\n \n-    coordinatorStreamStore = new CoordinatorStreamStore(coordinatorSystemConfig, metrics);\n-    coordinatorStreamStore.init();\n-    config = CoordinatorStreamUtil.readConfigFromCoordinatorStream(coordinatorStreamStore);\n+    JobConfig jobConfig = new JobConfig(coordinatorSystemConfig);\n+\n+    if (jobConfig.getConfigLoaderFactory().isPresent()) {\n+      // load full job config with ConfigLoader\n+      Config originalConfig = ConfigUtil.loadConfig(coordinatorSystemConfig);\n+\n+      // Execute planning\n+      ApplicationDescriptorImpl<? extends ApplicationDescriptor>\n+          appDesc = ApplicationDescriptorUtil.getAppDescriptor(ApplicationUtil.fromConfig(originalConfig), originalConfig);\n+      RemoteJobPlanner planner = new RemoteJobPlanner(appDesc);\n+      List<JobConfig> jobConfigs = planner.prepareJobs();\n+\n+      if (jobConfigs.size() != 1) {\n+        throw new SamzaException(\"Only support single remote job is supported.\");\n+      }\n+\n+      // Merge with default coordinator stream config\n+      config = ConfigUtil.override(jobConfigs.get(0), CoordinatorStreamUtil.buildCoordinatorStreamConfig(jobConfigs.get(0)));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ4NDcxMg=="}, "originalCommit": {"oid": "0d65377e8dacfe79f5a32b6ab196066e8a674e9f"}, "originalPosition": 58}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2MTA4MDg5OnYy", "diffSide": "RIGHT", "path": "samza-core/src/main/java/org/apache/samza/util/ConfigUtil.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxOTozNzoxM1rOFdCQdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxODozMzowNVrOFfBn3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTk5MDAwNQ==", "bodyText": "Is it an exceptional case for ConfigLoaderFactory to not be present here?", "url": "https://github.com/apache/samza/pull/1248#discussion_r365990005", "createdAt": "2020-01-13T19:37:13Z", "author": {"login": "bkonold"}, "path": "samza-core/src/main/java/org/apache/samza/util/ConfigUtil.java", "diffHunk": "@@ -67,4 +72,42 @@ public static Config applyRewriter(Config config, String rewriterName) {\n     LOG.info(\"Re-writing config with {}\", rewriter);\n     return rewriter.rewrite(rewriterName, config);\n   }\n+\n+  /**\n+   * Load full job config with {@link ConfigLoaderFactory} when present.\n+   *\n+   * @param original config\n+   * @return full job config\n+   */\n+  public static Config loadConfig(Config original) {\n+    JobConfig jobConfig = new JobConfig(original);\n+    Config fullConfig = original;\n+\n+    if (jobConfig.getConfigLoaderFactory().isPresent()) {\n+      ConfigLoaderFactory factory = ReflectionUtil.getObj(jobConfig.getConfigLoaderFactory().get(), ConfigLoaderFactory.class);\n+      ConfigLoader loader = factory.getLoader(original.subset(ConfigLoaderFactory.CONFIG_LOADER_PROPERTIES_PREFIX));\n+      // overrides config loaded with original config, which may contain overridden values.\n+      fullConfig = override(ConfigUtil.rewriteConfig(loader.getConfig()), original);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7b0d0f6c7b4be861fef8200040e0d8dbd67d30b"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTk5MzE4OQ==", "bodyText": "Eventually Yes, but during the migration, there will be cases where jobs are still following the legacy submission flow, but still goes to this new method in code.\nFor example, this util will be called by LocalApplicationRunner too, which will first support both legacy and new flow.", "url": "https://github.com/apache/samza/pull/1248#discussion_r365993189", "createdAt": "2020-01-13T19:44:26Z", "author": {"login": "kw2542"}, "path": "samza-core/src/main/java/org/apache/samza/util/ConfigUtil.java", "diffHunk": "@@ -67,4 +72,42 @@ public static Config applyRewriter(Config config, String rewriterName) {\n     LOG.info(\"Re-writing config with {}\", rewriter);\n     return rewriter.rewrite(rewriterName, config);\n   }\n+\n+  /**\n+   * Load full job config with {@link ConfigLoaderFactory} when present.\n+   *\n+   * @param original config\n+   * @return full job config\n+   */\n+  public static Config loadConfig(Config original) {\n+    JobConfig jobConfig = new JobConfig(original);\n+    Config fullConfig = original;\n+\n+    if (jobConfig.getConfigLoaderFactory().isPresent()) {\n+      ConfigLoaderFactory factory = ReflectionUtil.getObj(jobConfig.getConfigLoaderFactory().get(), ConfigLoaderFactory.class);\n+      ConfigLoader loader = factory.getLoader(original.subset(ConfigLoaderFactory.CONFIG_LOADER_PROPERTIES_PREFIX));\n+      // overrides config loaded with original config, which may contain overridden values.\n+      fullConfig = override(ConfigUtil.rewriteConfig(loader.getConfig()), original);\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTk5MDAwNQ=="}, "originalCommit": {"oid": "a7b0d0f6c7b4be861fef8200040e0d8dbd67d30b"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA1NTQwNw==", "bodyText": "The method name loadConfig is a bit misleading if it just might return the config that is passed in. If you still prefer to allow this to succeed when ConfigLoaderFactory is not present, then maybe at least rename the method to help clarify what it might do, so that someone doesn't accidentally call it in an unexpected way.", "url": "https://github.com/apache/samza/pull/1248#discussion_r367055407", "createdAt": "2020-01-15T19:10:20Z", "author": {"login": "cameronlee314"}, "path": "samza-core/src/main/java/org/apache/samza/util/ConfigUtil.java", "diffHunk": "@@ -67,4 +72,42 @@ public static Config applyRewriter(Config config, String rewriterName) {\n     LOG.info(\"Re-writing config with {}\", rewriter);\n     return rewriter.rewrite(rewriterName, config);\n   }\n+\n+  /**\n+   * Load full job config with {@link ConfigLoaderFactory} when present.\n+   *\n+   * @param original config\n+   * @return full job config\n+   */\n+  public static Config loadConfig(Config original) {\n+    JobConfig jobConfig = new JobConfig(original);\n+    Config fullConfig = original;\n+\n+    if (jobConfig.getConfigLoaderFactory().isPresent()) {\n+      ConfigLoaderFactory factory = ReflectionUtil.getObj(jobConfig.getConfigLoaderFactory().get(), ConfigLoaderFactory.class);\n+      ConfigLoader loader = factory.getLoader(original.subset(ConfigLoaderFactory.CONFIG_LOADER_PROPERTIES_PREFIX));\n+      // overrides config loaded with original config, which may contain overridden values.\n+      fullConfig = override(ConfigUtil.rewriteConfig(loader.getConfig()), original);\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTk5MDAwNQ=="}, "originalCommit": {"oid": "a7b0d0f6c7b4be861fef8200040e0d8dbd67d30b"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA3MDAyMQ==", "bodyText": "Is there something you can do to clarify that this may not actually load any additional configs?", "url": "https://github.com/apache/samza/pull/1248#discussion_r368070021", "createdAt": "2020-01-17T18:16:23Z", "author": {"login": "cameronlee314"}, "path": "samza-core/src/main/java/org/apache/samza/util/ConfigUtil.java", "diffHunk": "@@ -67,4 +72,42 @@ public static Config applyRewriter(Config config, String rewriterName) {\n     LOG.info(\"Re-writing config with {}\", rewriter);\n     return rewriter.rewrite(rewriterName, config);\n   }\n+\n+  /**\n+   * Load full job config with {@link ConfigLoaderFactory} when present.\n+   *\n+   * @param original config\n+   * @return full job config\n+   */\n+  public static Config loadConfig(Config original) {\n+    JobConfig jobConfig = new JobConfig(original);\n+    Config fullConfig = original;\n+\n+    if (jobConfig.getConfigLoaderFactory().isPresent()) {\n+      ConfigLoaderFactory factory = ReflectionUtil.getObj(jobConfig.getConfigLoaderFactory().get(), ConfigLoaderFactory.class);\n+      ConfigLoader loader = factory.getLoader(original.subset(ConfigLoaderFactory.CONFIG_LOADER_PROPERTIES_PREFIX));\n+      // overrides config loaded with original config, which may contain overridden values.\n+      fullConfig = override(ConfigUtil.rewriteConfig(loader.getConfig()), original);\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTk5MDAwNQ=="}, "originalCommit": {"oid": "a7b0d0f6c7b4be861fef8200040e0d8dbd67d30b"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA3Njc2NQ==", "bodyText": "Updated to disallow the case when ConfigLoaderFactory is not present.", "url": "https://github.com/apache/samza/pull/1248#discussion_r368076765", "createdAt": "2020-01-17T18:33:05Z", "author": {"login": "kw2542"}, "path": "samza-core/src/main/java/org/apache/samza/util/ConfigUtil.java", "diffHunk": "@@ -67,4 +72,42 @@ public static Config applyRewriter(Config config, String rewriterName) {\n     LOG.info(\"Re-writing config with {}\", rewriter);\n     return rewriter.rewrite(rewriterName, config);\n   }\n+\n+  /**\n+   * Load full job config with {@link ConfigLoaderFactory} when present.\n+   *\n+   * @param original config\n+   * @return full job config\n+   */\n+  public static Config loadConfig(Config original) {\n+    JobConfig jobConfig = new JobConfig(original);\n+    Config fullConfig = original;\n+\n+    if (jobConfig.getConfigLoaderFactory().isPresent()) {\n+      ConfigLoaderFactory factory = ReflectionUtil.getObj(jobConfig.getConfigLoaderFactory().get(), ConfigLoaderFactory.class);\n+      ConfigLoader loader = factory.getLoader(original.subset(ConfigLoaderFactory.CONFIG_LOADER_PROPERTIES_PREFIX));\n+      // overrides config loaded with original config, which may contain overridden values.\n+      fullConfig = override(ConfigUtil.rewriteConfig(loader.getConfig()), original);\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTk5MDAwNQ=="}, "originalCommit": {"oid": "a7b0d0f6c7b4be861fef8200040e0d8dbd67d30b"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2NTAzNjgzOnYy", "diffSide": "RIGHT", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQyMjozNzo1M1rOFdoGVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQyMzoyMTozMlrOFdpAcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYxMDAwNA==", "bodyText": "Should we rename this to something more general now that it won't always be just the coordinator system configs?", "url": "https://github.com/apache/samza/pull/1248#discussion_r366610004", "createdAt": "2020-01-14T22:37:53Z", "author": {"login": "bkonold"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java", "diffHunk": "@@ -178,9 +185,33 @@\n   public ClusterBasedJobCoordinator(Config coordinatorSystemConfig) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "86032a6feaa1e25db3e18e18a1dd1f019ec473b7"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYxMDc3OA==", "bodyText": "I was planning to rename this variable when cleaning up the legacy flow, but we can choose a generic name in the mid now as well, what do you think?", "url": "https://github.com/apache/samza/pull/1248#discussion_r366610778", "createdAt": "2020-01-14T22:39:57Z", "author": {"login": "kw2542"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java", "diffHunk": "@@ -178,9 +185,33 @@\n   public ClusterBasedJobCoordinator(Config coordinatorSystemConfig) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYxMDAwNA=="}, "originalCommit": {"oid": "86032a6feaa1e25db3e18e18a1dd1f019ec473b7"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYxNDIwMA==", "bodyText": "I think changing it now would be less misleading in the interim. \"jobCoordinatorConfig\"?", "url": "https://github.com/apache/samza/pull/1248#discussion_r366614200", "createdAt": "2020-01-14T22:49:25Z", "author": {"login": "bkonold"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java", "diffHunk": "@@ -178,9 +185,33 @@\n   public ClusterBasedJobCoordinator(Config coordinatorSystemConfig) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYxMDAwNA=="}, "originalCommit": {"oid": "86032a6feaa1e25db3e18e18a1dd1f019ec473b7"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYyNDg4Mw==", "bodyText": "Renamed to jobCoordinatorConfig and updated the javadoc as well.", "url": "https://github.com/apache/samza/pull/1248#discussion_r366624883", "createdAt": "2020-01-14T23:21:32Z", "author": {"login": "kw2542"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java", "diffHunk": "@@ -178,9 +185,33 @@\n   public ClusterBasedJobCoordinator(Config coordinatorSystemConfig) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYxMDAwNA=="}, "originalCommit": {"oid": "86032a6feaa1e25db3e18e18a1dd1f019ec473b7"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2NzgwNjQ5OnYy", "diffSide": "RIGHT", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxODo0NDo0NVrOFeCkng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQyMjoyMToxNFrOFeIWBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA0Mzc0Mg==", "bodyText": "Does this need to match the set-up done in JobRunner.run? Maybe it would be good to put a comment in here and in JobRunner to make sure they are consistent. I know it will be cleaned up eventually, but there will be some time in which both flows exist.", "url": "https://github.com/apache/samza/pull/1248#discussion_r367043742", "createdAt": "2020-01-15T18:44:45Z", "author": {"login": "cameronlee314"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java", "diffHunk": "@@ -172,15 +179,39 @@\n    * Creates a new ClusterBasedJobCoordinator instance from a config. Invoke run() to actually\n    * run the jobcoordinator.\n    *\n-   * @param coordinatorSystemConfig the coordinator stream config that can be used to read the\n-   *                                {@link org.apache.samza.job.model.JobModel} from.\n+   * @param jobCoordinatorConfig job coordinator config that either contains coordinator stream properties\n+   *                             or config loader properties to load full job config.\n    */\n-  public ClusterBasedJobCoordinator(Config coordinatorSystemConfig) {\n+  public ClusterBasedJobCoordinator(Config jobCoordinatorConfig) {\n     metrics = new MetricsRegistryMap();\n \n-    coordinatorStreamStore = new CoordinatorStreamStore(coordinatorSystemConfig, metrics);\n-    coordinatorStreamStore.init();\n-    config = CoordinatorStreamUtil.readConfigFromCoordinatorStream(coordinatorStreamStore);\n+    JobConfig jobConfig = new JobConfig(jobCoordinatorConfig);\n+\n+    if (jobConfig.getConfigLoaderFactory().isPresent()) {\n+      // load full job config with ConfigLoader\n+      Config originalConfig = ConfigUtil.loadConfig(jobCoordinatorConfig);\n+\n+      // Execute planning\n+      ApplicationDescriptorImpl<? extends ApplicationDescriptor>\n+          appDesc = ApplicationDescriptorUtil.getAppDescriptor(ApplicationUtil.fromConfig(originalConfig), originalConfig);\n+      RemoteJobPlanner planner = new RemoteJobPlanner(appDesc);\n+      List<JobConfig> jobConfigs = planner.prepareJobs();\n+\n+      if (jobConfigs.size() != 1) {\n+        throw new SamzaException(\"Only support single remote job is supported.\");\n+      }\n+\n+      config = jobConfigs.get(0);\n+      coordinatorStreamStore = new CoordinatorStreamStore(CoordinatorStreamUtil.buildCoordinatorStreamConfig(config), metrics);\n+      coordinatorStreamStore.init();\n+      CoordinatorStreamUtil.writeConfigToCoordinatorStream(config, true);\n+      DiagnosticsUtil.createDiagnosticsStream(config);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d381c46c2b7e55631d744e835feed934f63c27d"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzEzODMwOA==", "bodyText": "Added a comment", "url": "https://github.com/apache/samza/pull/1248#discussion_r367138308", "createdAt": "2020-01-15T22:21:14Z", "author": {"login": "kw2542"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java", "diffHunk": "@@ -172,15 +179,39 @@\n    * Creates a new ClusterBasedJobCoordinator instance from a config. Invoke run() to actually\n    * run the jobcoordinator.\n    *\n-   * @param coordinatorSystemConfig the coordinator stream config that can be used to read the\n-   *                                {@link org.apache.samza.job.model.JobModel} from.\n+   * @param jobCoordinatorConfig job coordinator config that either contains coordinator stream properties\n+   *                             or config loader properties to load full job config.\n    */\n-  public ClusterBasedJobCoordinator(Config coordinatorSystemConfig) {\n+  public ClusterBasedJobCoordinator(Config jobCoordinatorConfig) {\n     metrics = new MetricsRegistryMap();\n \n-    coordinatorStreamStore = new CoordinatorStreamStore(coordinatorSystemConfig, metrics);\n-    coordinatorStreamStore.init();\n-    config = CoordinatorStreamUtil.readConfigFromCoordinatorStream(coordinatorStreamStore);\n+    JobConfig jobConfig = new JobConfig(jobCoordinatorConfig);\n+\n+    if (jobConfig.getConfigLoaderFactory().isPresent()) {\n+      // load full job config with ConfigLoader\n+      Config originalConfig = ConfigUtil.loadConfig(jobCoordinatorConfig);\n+\n+      // Execute planning\n+      ApplicationDescriptorImpl<? extends ApplicationDescriptor>\n+          appDesc = ApplicationDescriptorUtil.getAppDescriptor(ApplicationUtil.fromConfig(originalConfig), originalConfig);\n+      RemoteJobPlanner planner = new RemoteJobPlanner(appDesc);\n+      List<JobConfig> jobConfigs = planner.prepareJobs();\n+\n+      if (jobConfigs.size() != 1) {\n+        throw new SamzaException(\"Only support single remote job is supported.\");\n+      }\n+\n+      config = jobConfigs.get(0);\n+      coordinatorStreamStore = new CoordinatorStreamStore(CoordinatorStreamUtil.buildCoordinatorStreamConfig(config), metrics);\n+      coordinatorStreamStore.init();\n+      CoordinatorStreamUtil.writeConfigToCoordinatorStream(config, true);\n+      DiagnosticsUtil.createDiagnosticsStream(config);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA0Mzc0Mg=="}, "originalCommit": {"oid": "5d381c46c2b7e55631d744e835feed934f63c27d"}, "originalPosition": 70}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2NzgxMjQwOnYy", "diffSide": "RIGHT", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxODo0Njo1M1rOFeCoVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxODoyNzozNVrOFfBfAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA0NDY5NA==", "bodyText": "Should this check for a blank string instead of just null? It might be easier since it might sometimes be hard to fill in null for an env variable (easier to put the empty string).", "url": "https://github.com/apache/samza/pull/1248#discussion_r367044694", "createdAt": "2020-01-15T18:46:53Z", "author": {"login": "cameronlee314"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java", "diffHunk": "@@ -480,20 +510,41 @@ private static void executeRunClusterBasedJobCoordinatorForClass(Class<?> cluste\n    * {@link #main(String[])} so that it can be executed directly or from a separate classloader.\n    */\n   private static void runClusterBasedJobCoordinator(String[] args) {\n-    Config coordinatorSystemConfig;\n     final String coordinatorSystemEnv = System.getenv(ShellCommandConfig.ENV_COORDINATOR_SYSTEM_CONFIG());\n-    try {\n-      //Read and parse the coordinator system config.\n-      LOG.info(\"Parsing coordinator system config {}\", coordinatorSystemEnv);\n-      coordinatorSystemConfig =\n-          new MapConfig(SamzaObjectMapper.getObjectMapper().readValue(coordinatorSystemEnv, Config.class));\n-      LOG.info(\"Using the coordinator system config: {}.\", coordinatorSystemConfig);\n-    } catch (IOException e) {\n-      LOG.error(\"Exception while reading coordinator stream config\", e);\n-      throw new SamzaException(e);\n+    final String submissionEnv = System.getenv(ShellCommandConfig.ENV_SUBMISSION_CONFIG());\n+\n+    if (submissionEnv != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d381c46c2b7e55631d744e835feed934f63c27d"}, "originalPosition": 107}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzEzNjEwMQ==", "bodyText": "Good catch. Updated.", "url": "https://github.com/apache/samza/pull/1248#discussion_r367136101", "createdAt": "2020-01-15T22:15:51Z", "author": {"login": "kw2542"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java", "diffHunk": "@@ -480,20 +510,41 @@ private static void executeRunClusterBasedJobCoordinatorForClass(Class<?> cluste\n    * {@link #main(String[])} so that it can be executed directly or from a separate classloader.\n    */\n   private static void runClusterBasedJobCoordinator(String[] args) {\n-    Config coordinatorSystemConfig;\n     final String coordinatorSystemEnv = System.getenv(ShellCommandConfig.ENV_COORDINATOR_SYSTEM_CONFIG());\n-    try {\n-      //Read and parse the coordinator system config.\n-      LOG.info(\"Parsing coordinator system config {}\", coordinatorSystemEnv);\n-      coordinatorSystemConfig =\n-          new MapConfig(SamzaObjectMapper.getObjectMapper().readValue(coordinatorSystemEnv, Config.class));\n-      LOG.info(\"Using the coordinator system config: {}.\", coordinatorSystemConfig);\n-    } catch (IOException e) {\n-      LOG.error(\"Exception while reading coordinator stream config\", e);\n-      throw new SamzaException(e);\n+    final String submissionEnv = System.getenv(ShellCommandConfig.ENV_SUBMISSION_CONFIG());\n+\n+    if (submissionEnv != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA0NDY5NA=="}, "originalCommit": {"oid": "5d381c46c2b7e55631d744e835feed934f63c27d"}, "originalPosition": 107}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA2NzAzMQ==", "bodyText": "The comment was resolved, but it looks like you are still just checking for null. Did you intend to check for blank string too?", "url": "https://github.com/apache/samza/pull/1248#discussion_r368067031", "createdAt": "2020-01-17T18:09:06Z", "author": {"login": "cameronlee314"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java", "diffHunk": "@@ -480,20 +510,41 @@ private static void executeRunClusterBasedJobCoordinatorForClass(Class<?> cluste\n    * {@link #main(String[])} so that it can be executed directly or from a separate classloader.\n    */\n   private static void runClusterBasedJobCoordinator(String[] args) {\n-    Config coordinatorSystemConfig;\n     final String coordinatorSystemEnv = System.getenv(ShellCommandConfig.ENV_COORDINATOR_SYSTEM_CONFIG());\n-    try {\n-      //Read and parse the coordinator system config.\n-      LOG.info(\"Parsing coordinator system config {}\", coordinatorSystemEnv);\n-      coordinatorSystemConfig =\n-          new MapConfig(SamzaObjectMapper.getObjectMapper().readValue(coordinatorSystemEnv, Config.class));\n-      LOG.info(\"Using the coordinator system config: {}.\", coordinatorSystemConfig);\n-    } catch (IOException e) {\n-      LOG.error(\"Exception while reading coordinator stream config\", e);\n-      throw new SamzaException(e);\n+    final String submissionEnv = System.getenv(ShellCommandConfig.ENV_SUBMISSION_CONFIG());\n+\n+    if (submissionEnv != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA0NDY5NA=="}, "originalCommit": {"oid": "5d381c46c2b7e55631d744e835feed934f63c27d"}, "originalPosition": 107}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA3NDQ5OA==", "bodyText": "My bad, changes are lost during updates. Updated again.", "url": "https://github.com/apache/samza/pull/1248#discussion_r368074498", "createdAt": "2020-01-17T18:27:35Z", "author": {"login": "kw2542"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java", "diffHunk": "@@ -480,20 +510,41 @@ private static void executeRunClusterBasedJobCoordinatorForClass(Class<?> cluste\n    * {@link #main(String[])} so that it can be executed directly or from a separate classloader.\n    */\n   private static void runClusterBasedJobCoordinator(String[] args) {\n-    Config coordinatorSystemConfig;\n     final String coordinatorSystemEnv = System.getenv(ShellCommandConfig.ENV_COORDINATOR_SYSTEM_CONFIG());\n-    try {\n-      //Read and parse the coordinator system config.\n-      LOG.info(\"Parsing coordinator system config {}\", coordinatorSystemEnv);\n-      coordinatorSystemConfig =\n-          new MapConfig(SamzaObjectMapper.getObjectMapper().readValue(coordinatorSystemEnv, Config.class));\n-      LOG.info(\"Using the coordinator system config: {}.\", coordinatorSystemConfig);\n-    } catch (IOException e) {\n-      LOG.error(\"Exception while reading coordinator stream config\", e);\n-      throw new SamzaException(e);\n+    final String submissionEnv = System.getenv(ShellCommandConfig.ENV_SUBMISSION_CONFIG());\n+\n+    if (submissionEnv != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA0NDY5NA=="}, "originalCommit": {"oid": "5d381c46c2b7e55631d744e835feed934f63c27d"}, "originalPosition": 107}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2Nzg0MTg0OnYy", "diffSide": "RIGHT", "path": "samza-core/src/main/java/org/apache/samza/util/ConfigUtil.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxODo1NzoxMlrOFeC7LQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQyMjo0NDoyMlrOFeI3zg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA0OTUxNw==", "bodyText": "I think the config rewriter sometimes overrides existing configs, so I don't think you want to re-override back to the original.\nDoes the existing flow do this override flow with the original config?", "url": "https://github.com/apache/samza/pull/1248#discussion_r367049517", "createdAt": "2020-01-15T18:57:12Z", "author": {"login": "cameronlee314"}, "path": "samza-core/src/main/java/org/apache/samza/util/ConfigUtil.java", "diffHunk": "@@ -67,4 +72,42 @@ public static Config applyRewriter(Config config, String rewriterName) {\n     LOG.info(\"Re-writing config with {}\", rewriter);\n     return rewriter.rewrite(rewriterName, config);\n   }\n+\n+  /**\n+   * Load full job config with {@link ConfigLoaderFactory} when present.\n+   *\n+   * @param original config\n+   * @return full job config\n+   */\n+  public static Config loadConfig(Config original) {\n+    JobConfig jobConfig = new JobConfig(original);\n+    Config fullConfig = original;\n+\n+    if (jobConfig.getConfigLoaderFactory().isPresent()) {\n+      ConfigLoaderFactory factory = ReflectionUtil.getObj(jobConfig.getConfigLoaderFactory().get(), ConfigLoaderFactory.class);\n+      ConfigLoader loader = factory.getLoader(original.subset(ConfigLoaderFactory.CONFIG_LOADER_PROPERTIES_PREFIX));\n+      // overrides config loaded with original config, which may contain overridden values.\n+      fullConfig = override(ConfigUtil.rewriteConfig(loader.getConfig()), original);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d381c46c2b7e55631d744e835feed934f63c27d"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzE0Njk1OA==", "bodyText": "Good point, we should override the original config with provided overrides and then invoke config rewriters.\nUpdated.", "url": "https://github.com/apache/samza/pull/1248#discussion_r367146958", "createdAt": "2020-01-15T22:44:22Z", "author": {"login": "kw2542"}, "path": "samza-core/src/main/java/org/apache/samza/util/ConfigUtil.java", "diffHunk": "@@ -67,4 +72,42 @@ public static Config applyRewriter(Config config, String rewriterName) {\n     LOG.info(\"Re-writing config with {}\", rewriter);\n     return rewriter.rewrite(rewriterName, config);\n   }\n+\n+  /**\n+   * Load full job config with {@link ConfigLoaderFactory} when present.\n+   *\n+   * @param original config\n+   * @return full job config\n+   */\n+  public static Config loadConfig(Config original) {\n+    JobConfig jobConfig = new JobConfig(original);\n+    Config fullConfig = original;\n+\n+    if (jobConfig.getConfigLoaderFactory().isPresent()) {\n+      ConfigLoaderFactory factory = ReflectionUtil.getObj(jobConfig.getConfigLoaderFactory().get(), ConfigLoaderFactory.class);\n+      ConfigLoader loader = factory.getLoader(original.subset(ConfigLoaderFactory.CONFIG_LOADER_PROPERTIES_PREFIX));\n+      // overrides config loaded with original config, which may contain overridden values.\n+      fullConfig = override(ConfigUtil.rewriteConfig(loader.getConfig()), original);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA0OTUxNw=="}, "originalCommit": {"oid": "5d381c46c2b7e55631d744e835feed934f63c27d"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NDMzMzE0OnYy", "diffSide": "RIGHT", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxODoxMToxM1rOFfBFSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxODozNDo1M1rOFfBqiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA2NzkxMw==", "bodyText": "It looks like you already call init in the shared constructor. Please call it only once.", "url": "https://github.com/apache/samza/pull/1248#discussion_r368067913", "createdAt": "2020-01-17T18:11:13Z", "author": {"login": "cameronlee314"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java", "diffHunk": "@@ -480,20 +485,101 @@ private static void executeRunClusterBasedJobCoordinatorForClass(Class<?> cluste\n    * {@link #main(String[])} so that it can be executed directly or from a separate classloader.\n    */\n   private static void runClusterBasedJobCoordinator(String[] args) {\n-    Config coordinatorSystemConfig;\n     final String coordinatorSystemEnv = System.getenv(ShellCommandConfig.ENV_COORDINATOR_SYSTEM_CONFIG());\n-    try {\n-      //Read and parse the coordinator system config.\n-      LOG.info(\"Parsing coordinator system config {}\", coordinatorSystemEnv);\n-      coordinatorSystemConfig =\n-          new MapConfig(SamzaObjectMapper.getObjectMapper().readValue(coordinatorSystemEnv, Config.class));\n-      LOG.info(\"Using the coordinator system config: {}.\", coordinatorSystemConfig);\n-    } catch (IOException e) {\n-      LOG.error(\"Exception while reading coordinator stream config\", e);\n-      throw new SamzaException(e);\n+    final String submissionEnv = System.getenv(ShellCommandConfig.ENV_SUBMISSION_CONFIG());\n+\n+    if (submissionEnv != null) {\n+      Config submissionConfig;\n+      try {\n+        //Read and parse the coordinator system config.\n+        LOG.info(\"Parsing submission config {}\", submissionEnv);\n+        submissionConfig =\n+            new MapConfig(SamzaObjectMapper.getObjectMapper().readValue(submissionEnv, Config.class));\n+        LOG.info(\"Using the submission config: {}.\", submissionConfig);\n+      } catch (IOException e) {\n+        LOG.error(\"Exception while reading submission config\", e);\n+        throw new SamzaException(e);\n+      }\n+\n+      ClusterBasedJobCoordinator jc = createFromConfigLoader(submissionConfig);\n+      jc.run();\n+      LOG.info(\"Finished running ClusterBasedJobCoordinator\");\n+    } else {\n+      // TODO: Clean this up once SAMZA-2405 is completed when legacy flow is removed.\n+      Config coordinatorSystemConfig;\n+      try {\n+        //Read and parse the coordinator system config.\n+        LOG.info(\"Parsing coordinator system config {}\", coordinatorSystemEnv);\n+        coordinatorSystemConfig =\n+            new MapConfig(SamzaObjectMapper.getObjectMapper().readValue(coordinatorSystemEnv, Config.class));\n+        LOG.info(\"Using the coordinator system config: {}.\", coordinatorSystemConfig);\n+      } catch (IOException e) {\n+        LOG.error(\"Exception while reading coordinator stream config\", e);\n+        throw new SamzaException(e);\n+      }\n+      ClusterBasedJobCoordinator jc = createFromMetadataStore(coordinatorSystemConfig);\n+      jc.run();\n+      LOG.info(\"Finished running ClusterBasedJobCoordinator\");\n+    }\n+  }\n+\n+  /**\n+   * Initialize {@link ClusterBasedJobCoordinator} with coordinator stream config, full job config will be fetched from\n+   * coordinator stream.\n+   *\n+   * @param metadataStoreConfig to initialize {@link MetadataStore}\n+   * @return {@link ClusterBasedJobCoordinator}\n+   */\n+  // TODO SAMZA-2432: Clean this up once SAMZA-2405 is completed when legacy flow is removed.\n+  public static ClusterBasedJobCoordinator createFromMetadataStore(Config metadataStoreConfig) {\n+    MetricsRegistryMap metrics = new MetricsRegistryMap();\n+\n+    CoordinatorStreamStore coordinatorStreamStore = new CoordinatorStreamStore(metadataStoreConfig, metrics);\n+    coordinatorStreamStore.init();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de8ed411e5118dce7ce4f6587379fb29a36495ef"}, "originalPosition": 212}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA3NzQ1MQ==", "bodyText": "Update to call outside constructor as we need it to be initialized before we can read full job config from it in the legacy flow.", "url": "https://github.com/apache/samza/pull/1248#discussion_r368077451", "createdAt": "2020-01-17T18:34:53Z", "author": {"login": "kw2542"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java", "diffHunk": "@@ -480,20 +485,101 @@ private static void executeRunClusterBasedJobCoordinatorForClass(Class<?> cluste\n    * {@link #main(String[])} so that it can be executed directly or from a separate classloader.\n    */\n   private static void runClusterBasedJobCoordinator(String[] args) {\n-    Config coordinatorSystemConfig;\n     final String coordinatorSystemEnv = System.getenv(ShellCommandConfig.ENV_COORDINATOR_SYSTEM_CONFIG());\n-    try {\n-      //Read and parse the coordinator system config.\n-      LOG.info(\"Parsing coordinator system config {}\", coordinatorSystemEnv);\n-      coordinatorSystemConfig =\n-          new MapConfig(SamzaObjectMapper.getObjectMapper().readValue(coordinatorSystemEnv, Config.class));\n-      LOG.info(\"Using the coordinator system config: {}.\", coordinatorSystemConfig);\n-    } catch (IOException e) {\n-      LOG.error(\"Exception while reading coordinator stream config\", e);\n-      throw new SamzaException(e);\n+    final String submissionEnv = System.getenv(ShellCommandConfig.ENV_SUBMISSION_CONFIG());\n+\n+    if (submissionEnv != null) {\n+      Config submissionConfig;\n+      try {\n+        //Read and parse the coordinator system config.\n+        LOG.info(\"Parsing submission config {}\", submissionEnv);\n+        submissionConfig =\n+            new MapConfig(SamzaObjectMapper.getObjectMapper().readValue(submissionEnv, Config.class));\n+        LOG.info(\"Using the submission config: {}.\", submissionConfig);\n+      } catch (IOException e) {\n+        LOG.error(\"Exception while reading submission config\", e);\n+        throw new SamzaException(e);\n+      }\n+\n+      ClusterBasedJobCoordinator jc = createFromConfigLoader(submissionConfig);\n+      jc.run();\n+      LOG.info(\"Finished running ClusterBasedJobCoordinator\");\n+    } else {\n+      // TODO: Clean this up once SAMZA-2405 is completed when legacy flow is removed.\n+      Config coordinatorSystemConfig;\n+      try {\n+        //Read and parse the coordinator system config.\n+        LOG.info(\"Parsing coordinator system config {}\", coordinatorSystemEnv);\n+        coordinatorSystemConfig =\n+            new MapConfig(SamzaObjectMapper.getObjectMapper().readValue(coordinatorSystemEnv, Config.class));\n+        LOG.info(\"Using the coordinator system config: {}.\", coordinatorSystemConfig);\n+      } catch (IOException e) {\n+        LOG.error(\"Exception while reading coordinator stream config\", e);\n+        throw new SamzaException(e);\n+      }\n+      ClusterBasedJobCoordinator jc = createFromMetadataStore(coordinatorSystemConfig);\n+      jc.run();\n+      LOG.info(\"Finished running ClusterBasedJobCoordinator\");\n+    }\n+  }\n+\n+  /**\n+   * Initialize {@link ClusterBasedJobCoordinator} with coordinator stream config, full job config will be fetched from\n+   * coordinator stream.\n+   *\n+   * @param metadataStoreConfig to initialize {@link MetadataStore}\n+   * @return {@link ClusterBasedJobCoordinator}\n+   */\n+  // TODO SAMZA-2432: Clean this up once SAMZA-2405 is completed when legacy flow is removed.\n+  public static ClusterBasedJobCoordinator createFromMetadataStore(Config metadataStoreConfig) {\n+    MetricsRegistryMap metrics = new MetricsRegistryMap();\n+\n+    CoordinatorStreamStore coordinatorStreamStore = new CoordinatorStreamStore(metadataStoreConfig, metrics);\n+    coordinatorStreamStore.init();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA2NzkxMw=="}, "originalCommit": {"oid": "de8ed411e5118dce7ce4f6587379fb29a36495ef"}, "originalPosition": 212}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NDMzNzE4OnYy", "diffSide": "RIGHT", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxODoxMjo0OFrOFfBHqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxODozNToyM1rOFfBrbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA2ODUyMg==", "bodyText": "Does this need to be public? If you need in tests, could you make it package private and mark as VisibleForTesting?", "url": "https://github.com/apache/samza/pull/1248#discussion_r368068522", "createdAt": "2020-01-17T18:12:48Z", "author": {"login": "cameronlee314"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java", "diffHunk": "@@ -480,20 +485,101 @@ private static void executeRunClusterBasedJobCoordinatorForClass(Class<?> cluste\n    * {@link #main(String[])} so that it can be executed directly or from a separate classloader.\n    */\n   private static void runClusterBasedJobCoordinator(String[] args) {\n-    Config coordinatorSystemConfig;\n     final String coordinatorSystemEnv = System.getenv(ShellCommandConfig.ENV_COORDINATOR_SYSTEM_CONFIG());\n-    try {\n-      //Read and parse the coordinator system config.\n-      LOG.info(\"Parsing coordinator system config {}\", coordinatorSystemEnv);\n-      coordinatorSystemConfig =\n-          new MapConfig(SamzaObjectMapper.getObjectMapper().readValue(coordinatorSystemEnv, Config.class));\n-      LOG.info(\"Using the coordinator system config: {}.\", coordinatorSystemConfig);\n-    } catch (IOException e) {\n-      LOG.error(\"Exception while reading coordinator stream config\", e);\n-      throw new SamzaException(e);\n+    final String submissionEnv = System.getenv(ShellCommandConfig.ENV_SUBMISSION_CONFIG());\n+\n+    if (submissionEnv != null) {\n+      Config submissionConfig;\n+      try {\n+        //Read and parse the coordinator system config.\n+        LOG.info(\"Parsing submission config {}\", submissionEnv);\n+        submissionConfig =\n+            new MapConfig(SamzaObjectMapper.getObjectMapper().readValue(submissionEnv, Config.class));\n+        LOG.info(\"Using the submission config: {}.\", submissionConfig);\n+      } catch (IOException e) {\n+        LOG.error(\"Exception while reading submission config\", e);\n+        throw new SamzaException(e);\n+      }\n+\n+      ClusterBasedJobCoordinator jc = createFromConfigLoader(submissionConfig);\n+      jc.run();\n+      LOG.info(\"Finished running ClusterBasedJobCoordinator\");\n+    } else {\n+      // TODO: Clean this up once SAMZA-2405 is completed when legacy flow is removed.\n+      Config coordinatorSystemConfig;\n+      try {\n+        //Read and parse the coordinator system config.\n+        LOG.info(\"Parsing coordinator system config {}\", coordinatorSystemEnv);\n+        coordinatorSystemConfig =\n+            new MapConfig(SamzaObjectMapper.getObjectMapper().readValue(coordinatorSystemEnv, Config.class));\n+        LOG.info(\"Using the coordinator system config: {}.\", coordinatorSystemConfig);\n+      } catch (IOException e) {\n+        LOG.error(\"Exception while reading coordinator stream config\", e);\n+        throw new SamzaException(e);\n+      }\n+      ClusterBasedJobCoordinator jc = createFromMetadataStore(coordinatorSystemConfig);\n+      jc.run();\n+      LOG.info(\"Finished running ClusterBasedJobCoordinator\");\n+    }\n+  }\n+\n+  /**\n+   * Initialize {@link ClusterBasedJobCoordinator} with coordinator stream config, full job config will be fetched from\n+   * coordinator stream.\n+   *\n+   * @param metadataStoreConfig to initialize {@link MetadataStore}\n+   * @return {@link ClusterBasedJobCoordinator}\n+   */\n+  // TODO SAMZA-2432: Clean this up once SAMZA-2405 is completed when legacy flow is removed.\n+  public static ClusterBasedJobCoordinator createFromMetadataStore(Config metadataStoreConfig) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de8ed411e5118dce7ce4f6587379fb29a36495ef"}, "originalPosition": 208}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA3NzY3OA==", "bodyText": "Update to private.", "url": "https://github.com/apache/samza/pull/1248#discussion_r368077678", "createdAt": "2020-01-17T18:35:23Z", "author": {"login": "kw2542"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java", "diffHunk": "@@ -480,20 +485,101 @@ private static void executeRunClusterBasedJobCoordinatorForClass(Class<?> cluste\n    * {@link #main(String[])} so that it can be executed directly or from a separate classloader.\n    */\n   private static void runClusterBasedJobCoordinator(String[] args) {\n-    Config coordinatorSystemConfig;\n     final String coordinatorSystemEnv = System.getenv(ShellCommandConfig.ENV_COORDINATOR_SYSTEM_CONFIG());\n-    try {\n-      //Read and parse the coordinator system config.\n-      LOG.info(\"Parsing coordinator system config {}\", coordinatorSystemEnv);\n-      coordinatorSystemConfig =\n-          new MapConfig(SamzaObjectMapper.getObjectMapper().readValue(coordinatorSystemEnv, Config.class));\n-      LOG.info(\"Using the coordinator system config: {}.\", coordinatorSystemConfig);\n-    } catch (IOException e) {\n-      LOG.error(\"Exception while reading coordinator stream config\", e);\n-      throw new SamzaException(e);\n+    final String submissionEnv = System.getenv(ShellCommandConfig.ENV_SUBMISSION_CONFIG());\n+\n+    if (submissionEnv != null) {\n+      Config submissionConfig;\n+      try {\n+        //Read and parse the coordinator system config.\n+        LOG.info(\"Parsing submission config {}\", submissionEnv);\n+        submissionConfig =\n+            new MapConfig(SamzaObjectMapper.getObjectMapper().readValue(submissionEnv, Config.class));\n+        LOG.info(\"Using the submission config: {}.\", submissionConfig);\n+      } catch (IOException e) {\n+        LOG.error(\"Exception while reading submission config\", e);\n+        throw new SamzaException(e);\n+      }\n+\n+      ClusterBasedJobCoordinator jc = createFromConfigLoader(submissionConfig);\n+      jc.run();\n+      LOG.info(\"Finished running ClusterBasedJobCoordinator\");\n+    } else {\n+      // TODO: Clean this up once SAMZA-2405 is completed when legacy flow is removed.\n+      Config coordinatorSystemConfig;\n+      try {\n+        //Read and parse the coordinator system config.\n+        LOG.info(\"Parsing coordinator system config {}\", coordinatorSystemEnv);\n+        coordinatorSystemConfig =\n+            new MapConfig(SamzaObjectMapper.getObjectMapper().readValue(coordinatorSystemEnv, Config.class));\n+        LOG.info(\"Using the coordinator system config: {}.\", coordinatorSystemConfig);\n+      } catch (IOException e) {\n+        LOG.error(\"Exception while reading coordinator stream config\", e);\n+        throw new SamzaException(e);\n+      }\n+      ClusterBasedJobCoordinator jc = createFromMetadataStore(coordinatorSystemConfig);\n+      jc.run();\n+      LOG.info(\"Finished running ClusterBasedJobCoordinator\");\n+    }\n+  }\n+\n+  /**\n+   * Initialize {@link ClusterBasedJobCoordinator} with coordinator stream config, full job config will be fetched from\n+   * coordinator stream.\n+   *\n+   * @param metadataStoreConfig to initialize {@link MetadataStore}\n+   * @return {@link ClusterBasedJobCoordinator}\n+   */\n+  // TODO SAMZA-2432: Clean this up once SAMZA-2405 is completed when legacy flow is removed.\n+  public static ClusterBasedJobCoordinator createFromMetadataStore(Config metadataStoreConfig) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA2ODUyMg=="}, "originalCommit": {"oid": "de8ed411e5118dce7ce4f6587379fb29a36495ef"}, "originalPosition": 208}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NDMzNzMzOnYy", "diffSide": "RIGHT", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxODoxMjo1M1rOFfBHxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxODozNjoxM1rOFfBsyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA2ODU1MQ==", "bodyText": "Does this need to be public? If you need in tests, could you make it package private and mark as VisibleForTesting?", "url": "https://github.com/apache/samza/pull/1248#discussion_r368068551", "createdAt": "2020-01-17T18:12:53Z", "author": {"login": "cameronlee314"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java", "diffHunk": "@@ -480,20 +485,101 @@ private static void executeRunClusterBasedJobCoordinatorForClass(Class<?> cluste\n    * {@link #main(String[])} so that it can be executed directly or from a separate classloader.\n    */\n   private static void runClusterBasedJobCoordinator(String[] args) {\n-    Config coordinatorSystemConfig;\n     final String coordinatorSystemEnv = System.getenv(ShellCommandConfig.ENV_COORDINATOR_SYSTEM_CONFIG());\n-    try {\n-      //Read and parse the coordinator system config.\n-      LOG.info(\"Parsing coordinator system config {}\", coordinatorSystemEnv);\n-      coordinatorSystemConfig =\n-          new MapConfig(SamzaObjectMapper.getObjectMapper().readValue(coordinatorSystemEnv, Config.class));\n-      LOG.info(\"Using the coordinator system config: {}.\", coordinatorSystemConfig);\n-    } catch (IOException e) {\n-      LOG.error(\"Exception while reading coordinator stream config\", e);\n-      throw new SamzaException(e);\n+    final String submissionEnv = System.getenv(ShellCommandConfig.ENV_SUBMISSION_CONFIG());\n+\n+    if (submissionEnv != null) {\n+      Config submissionConfig;\n+      try {\n+        //Read and parse the coordinator system config.\n+        LOG.info(\"Parsing submission config {}\", submissionEnv);\n+        submissionConfig =\n+            new MapConfig(SamzaObjectMapper.getObjectMapper().readValue(submissionEnv, Config.class));\n+        LOG.info(\"Using the submission config: {}.\", submissionConfig);\n+      } catch (IOException e) {\n+        LOG.error(\"Exception while reading submission config\", e);\n+        throw new SamzaException(e);\n+      }\n+\n+      ClusterBasedJobCoordinator jc = createFromConfigLoader(submissionConfig);\n+      jc.run();\n+      LOG.info(\"Finished running ClusterBasedJobCoordinator\");\n+    } else {\n+      // TODO: Clean this up once SAMZA-2405 is completed when legacy flow is removed.\n+      Config coordinatorSystemConfig;\n+      try {\n+        //Read and parse the coordinator system config.\n+        LOG.info(\"Parsing coordinator system config {}\", coordinatorSystemEnv);\n+        coordinatorSystemConfig =\n+            new MapConfig(SamzaObjectMapper.getObjectMapper().readValue(coordinatorSystemEnv, Config.class));\n+        LOG.info(\"Using the coordinator system config: {}.\", coordinatorSystemConfig);\n+      } catch (IOException e) {\n+        LOG.error(\"Exception while reading coordinator stream config\", e);\n+        throw new SamzaException(e);\n+      }\n+      ClusterBasedJobCoordinator jc = createFromMetadataStore(coordinatorSystemConfig);\n+      jc.run();\n+      LOG.info(\"Finished running ClusterBasedJobCoordinator\");\n+    }\n+  }\n+\n+  /**\n+   * Initialize {@link ClusterBasedJobCoordinator} with coordinator stream config, full job config will be fetched from\n+   * coordinator stream.\n+   *\n+   * @param metadataStoreConfig to initialize {@link MetadataStore}\n+   * @return {@link ClusterBasedJobCoordinator}\n+   */\n+  // TODO SAMZA-2432: Clean this up once SAMZA-2405 is completed when legacy flow is removed.\n+  public static ClusterBasedJobCoordinator createFromMetadataStore(Config metadataStoreConfig) {\n+    MetricsRegistryMap metrics = new MetricsRegistryMap();\n+\n+    CoordinatorStreamStore coordinatorStreamStore = new CoordinatorStreamStore(metadataStoreConfig, metrics);\n+    coordinatorStreamStore.init();\n+    Config config = CoordinatorStreamUtil.readConfigFromCoordinatorStream(coordinatorStreamStore);\n+\n+    return new ClusterBasedJobCoordinator(metrics, coordinatorStreamStore, config);\n+  }\n+\n+  /**\n+   * Initialize {@link ClusterBasedJobCoordinator} with submission config, full job config will be fetched using\n+   * specified {@link org.apache.samza.config.ConfigLoaderFactory}\n+   *\n+   * @param submissionConfig specifies {@link org.apache.samza.config.ConfigLoaderFactory}\n+   * @return {@link ClusterBasedJobCoordinator}\n+   */\n+  public static ClusterBasedJobCoordinator createFromConfigLoader(Config submissionConfig) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de8ed411e5118dce7ce4f6587379fb29a36495ef"}, "originalPosition": 225}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA3ODAyNA==", "bodyText": "Update to package private and mark as VisibleForTesting", "url": "https://github.com/apache/samza/pull/1248#discussion_r368078024", "createdAt": "2020-01-17T18:36:13Z", "author": {"login": "kw2542"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java", "diffHunk": "@@ -480,20 +485,101 @@ private static void executeRunClusterBasedJobCoordinatorForClass(Class<?> cluste\n    * {@link #main(String[])} so that it can be executed directly or from a separate classloader.\n    */\n   private static void runClusterBasedJobCoordinator(String[] args) {\n-    Config coordinatorSystemConfig;\n     final String coordinatorSystemEnv = System.getenv(ShellCommandConfig.ENV_COORDINATOR_SYSTEM_CONFIG());\n-    try {\n-      //Read and parse the coordinator system config.\n-      LOG.info(\"Parsing coordinator system config {}\", coordinatorSystemEnv);\n-      coordinatorSystemConfig =\n-          new MapConfig(SamzaObjectMapper.getObjectMapper().readValue(coordinatorSystemEnv, Config.class));\n-      LOG.info(\"Using the coordinator system config: {}.\", coordinatorSystemConfig);\n-    } catch (IOException e) {\n-      LOG.error(\"Exception while reading coordinator stream config\", e);\n-      throw new SamzaException(e);\n+    final String submissionEnv = System.getenv(ShellCommandConfig.ENV_SUBMISSION_CONFIG());\n+\n+    if (submissionEnv != null) {\n+      Config submissionConfig;\n+      try {\n+        //Read and parse the coordinator system config.\n+        LOG.info(\"Parsing submission config {}\", submissionEnv);\n+        submissionConfig =\n+            new MapConfig(SamzaObjectMapper.getObjectMapper().readValue(submissionEnv, Config.class));\n+        LOG.info(\"Using the submission config: {}.\", submissionConfig);\n+      } catch (IOException e) {\n+        LOG.error(\"Exception while reading submission config\", e);\n+        throw new SamzaException(e);\n+      }\n+\n+      ClusterBasedJobCoordinator jc = createFromConfigLoader(submissionConfig);\n+      jc.run();\n+      LOG.info(\"Finished running ClusterBasedJobCoordinator\");\n+    } else {\n+      // TODO: Clean this up once SAMZA-2405 is completed when legacy flow is removed.\n+      Config coordinatorSystemConfig;\n+      try {\n+        //Read and parse the coordinator system config.\n+        LOG.info(\"Parsing coordinator system config {}\", coordinatorSystemEnv);\n+        coordinatorSystemConfig =\n+            new MapConfig(SamzaObjectMapper.getObjectMapper().readValue(coordinatorSystemEnv, Config.class));\n+        LOG.info(\"Using the coordinator system config: {}.\", coordinatorSystemConfig);\n+      } catch (IOException e) {\n+        LOG.error(\"Exception while reading coordinator stream config\", e);\n+        throw new SamzaException(e);\n+      }\n+      ClusterBasedJobCoordinator jc = createFromMetadataStore(coordinatorSystemConfig);\n+      jc.run();\n+      LOG.info(\"Finished running ClusterBasedJobCoordinator\");\n+    }\n+  }\n+\n+  /**\n+   * Initialize {@link ClusterBasedJobCoordinator} with coordinator stream config, full job config will be fetched from\n+   * coordinator stream.\n+   *\n+   * @param metadataStoreConfig to initialize {@link MetadataStore}\n+   * @return {@link ClusterBasedJobCoordinator}\n+   */\n+  // TODO SAMZA-2432: Clean this up once SAMZA-2405 is completed when legacy flow is removed.\n+  public static ClusterBasedJobCoordinator createFromMetadataStore(Config metadataStoreConfig) {\n+    MetricsRegistryMap metrics = new MetricsRegistryMap();\n+\n+    CoordinatorStreamStore coordinatorStreamStore = new CoordinatorStreamStore(metadataStoreConfig, metrics);\n+    coordinatorStreamStore.init();\n+    Config config = CoordinatorStreamUtil.readConfigFromCoordinatorStream(coordinatorStreamStore);\n+\n+    return new ClusterBasedJobCoordinator(metrics, coordinatorStreamStore, config);\n+  }\n+\n+  /**\n+   * Initialize {@link ClusterBasedJobCoordinator} with submission config, full job config will be fetched using\n+   * specified {@link org.apache.samza.config.ConfigLoaderFactory}\n+   *\n+   * @param submissionConfig specifies {@link org.apache.samza.config.ConfigLoaderFactory}\n+   * @return {@link ClusterBasedJobCoordinator}\n+   */\n+  public static ClusterBasedJobCoordinator createFromConfigLoader(Config submissionConfig) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA2ODU1MQ=="}, "originalCommit": {"oid": "de8ed411e5118dce7ce4f6587379fb29a36495ef"}, "originalPosition": 225}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NDM1ODIxOnYy", "diffSide": "RIGHT", "path": "samza-core/src/test/java/org/apache/samza/clustermanager/TestClusterBasedJobCoordinator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxODoyMTowMFrOFfBUwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxOTo0Nzo1OFrOFfDgDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA3MTg3Mw==", "bodyText": "Is it practical to do any more-specific validation on the arguments here?", "url": "https://github.com/apache/samza/pull/1248#discussion_r368071873", "createdAt": "2020-01-17T18:21:00Z", "author": {"login": "cameronlee314"}, "path": "samza-core/src/test/java/org/apache/samza/clustermanager/TestClusterBasedJobCoordinator.java", "diffHunk": "@@ -198,4 +203,31 @@ public void testRunWithClassLoader() throws Exception {\n     // make sure runClusterBasedJobCoordinator only got called once\n     verifyPrivate(ClusterBasedJobCoordinator.class).invoke(\"runClusterBasedJobCoordinator\", new Object[]{aryEq(args)});\n   }\n+\n+  @Test(expected = SamzaException.class)\n+  public void testCreateFromConfigLoaderWithoutConfigLoaderFactory() {\n+    ClusterBasedJobCoordinator.createFromConfigLoader(new MapConfig());\n+  }\n+\n+  @Test\n+  public void testCreateFromConfigLoader() throws Exception {\n+    // partially mock ClusterBasedJobCoordinator (mock prepareJob method only)\n+    PowerMockito.spy(ClusterBasedJobCoordinator.class);\n+\n+    Map<String, String> config = new HashMap<>();\n+    config.put(ApplicationConfig.APP_CLASS, MockStreamApplication.class.getCanonicalName());\n+    config.put(JobConfig.CONFIG_LOADER_FACTORY, PropertiesConfigLoaderFactory.class.getCanonicalName());\n+    config.put(PropertiesConfigLoaderFactory.CONFIG_LOADER_PROPERTIES_PREFIX + \"path\",\n+        getClass().getResource(\"/test.properties\").getPath());\n+\n+    PowerMockito.doAnswer(invocation -> invocation.getArgumentAt(0, Config.class))\n+        .when(ClusterBasedJobCoordinator.class, \"prepareJob\", any());\n+    PowerMockito.whenNew(ClusterBasedJobCoordinator.class).withAnyArguments().thenReturn(mock(ClusterBasedJobCoordinator.class));\n+    PowerMockito.whenNew(CoordinatorStreamStore.class).withAnyArguments().thenReturn(mock(CoordinatorStreamStore.class));\n+\n+    ClusterBasedJobCoordinator.createFromConfigLoader(new MapConfig(config));\n+\n+    verifyPrivate(ClusterBasedJobCoordinator.class).invoke(\"prepareJob\", any());\n+    verifyNew(ClusterBasedJobCoordinator.class).withArguments(any(), any(), any());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de8ed411e5118dce7ce4f6587379fb29a36495ef"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODEwNzUzMg==", "bodyText": "Updated the unit test have to explicit validation on arguments.", "url": "https://github.com/apache/samza/pull/1248#discussion_r368107532", "createdAt": "2020-01-17T19:47:58Z", "author": {"login": "kw2542"}, "path": "samza-core/src/test/java/org/apache/samza/clustermanager/TestClusterBasedJobCoordinator.java", "diffHunk": "@@ -198,4 +203,31 @@ public void testRunWithClassLoader() throws Exception {\n     // make sure runClusterBasedJobCoordinator only got called once\n     verifyPrivate(ClusterBasedJobCoordinator.class).invoke(\"runClusterBasedJobCoordinator\", new Object[]{aryEq(args)});\n   }\n+\n+  @Test(expected = SamzaException.class)\n+  public void testCreateFromConfigLoaderWithoutConfigLoaderFactory() {\n+    ClusterBasedJobCoordinator.createFromConfigLoader(new MapConfig());\n+  }\n+\n+  @Test\n+  public void testCreateFromConfigLoader() throws Exception {\n+    // partially mock ClusterBasedJobCoordinator (mock prepareJob method only)\n+    PowerMockito.spy(ClusterBasedJobCoordinator.class);\n+\n+    Map<String, String> config = new HashMap<>();\n+    config.put(ApplicationConfig.APP_CLASS, MockStreamApplication.class.getCanonicalName());\n+    config.put(JobConfig.CONFIG_LOADER_FACTORY, PropertiesConfigLoaderFactory.class.getCanonicalName());\n+    config.put(PropertiesConfigLoaderFactory.CONFIG_LOADER_PROPERTIES_PREFIX + \"path\",\n+        getClass().getResource(\"/test.properties\").getPath());\n+\n+    PowerMockito.doAnswer(invocation -> invocation.getArgumentAt(0, Config.class))\n+        .when(ClusterBasedJobCoordinator.class, \"prepareJob\", any());\n+    PowerMockito.whenNew(ClusterBasedJobCoordinator.class).withAnyArguments().thenReturn(mock(ClusterBasedJobCoordinator.class));\n+    PowerMockito.whenNew(CoordinatorStreamStore.class).withAnyArguments().thenReturn(mock(CoordinatorStreamStore.class));\n+\n+    ClusterBasedJobCoordinator.createFromConfigLoader(new MapConfig(config));\n+\n+    verifyPrivate(ClusterBasedJobCoordinator.class).invoke(\"prepareJob\", any());\n+    verifyNew(ClusterBasedJobCoordinator.class).withArguments(any(), any(), any());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA3MTg3Mw=="}, "originalCommit": {"oid": "de8ed411e5118dce7ce4f6587379fb29a36495ef"}, "originalPosition": 88}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NDM2MDMyOnYy", "diffSide": "RIGHT", "path": "samza-core/src/test/java/org/apache/samza/util/TestConfigUtil.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxODoyMTo0M1rOFfBV6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxODozOToyM1rOFfBx1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA3MjE3MA==", "bodyText": "Can this just be assertEquals(config, actual)?", "url": "https://github.com/apache/samza/pull/1248#discussion_r368072170", "createdAt": "2020-01-17T18:21:43Z", "author": {"login": "cameronlee314"}, "path": "samza-core/src/test/java/org/apache/samza/util/TestConfigUtil.java", "diffHunk": "@@ -161,6 +162,31 @@ public void testApplyRewriterClassDoesNotExist() {\n     assertEquals(expectedConfig, ConfigUtil.applyRewriter(new MapConfig(fullConfig), REWRITER_NAME));\n   }\n \n+  @Test\n+  public void testLoadConfigWithoutLoader() {\n+    Map<String, String> config = new HashMap<>();\n+    config.put(JobConfig.JOB_NAME, \"new-test-job\");\n+\n+    Config actual = ConfigUtil.loadConfig(new MapConfig(config));\n+\n+    assertEquals(config.size(), actual.size());\n+    assertEquals(\"new-test-job\", actual.get(JobConfig.JOB_NAME));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de8ed411e5118dce7ce4f6587379fb29a36495ef"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA3OTMxOA==", "bodyText": "Update the unit test to check ConfigException instead as we disallow config w/o loader.", "url": "https://github.com/apache/samza/pull/1248#discussion_r368079318", "createdAt": "2020-01-17T18:39:23Z", "author": {"login": "kw2542"}, "path": "samza-core/src/test/java/org/apache/samza/util/TestConfigUtil.java", "diffHunk": "@@ -161,6 +162,31 @@ public void testApplyRewriterClassDoesNotExist() {\n     assertEquals(expectedConfig, ConfigUtil.applyRewriter(new MapConfig(fullConfig), REWRITER_NAME));\n   }\n \n+  @Test\n+  public void testLoadConfigWithoutLoader() {\n+    Map<String, String> config = new HashMap<>();\n+    config.put(JobConfig.JOB_NAME, \"new-test-job\");\n+\n+    Config actual = ConfigUtil.loadConfig(new MapConfig(config));\n+\n+    assertEquals(config.size(), actual.size());\n+    assertEquals(\"new-test-job\", actual.get(JobConfig.JOB_NAME));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA3MjE3MA=="}, "originalCommit": {"oid": "de8ed411e5118dce7ce4f6587379fb29a36495ef"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NDM2MzYyOnYy", "diffSide": "RIGHT", "path": "samza-core/src/test/java/org/apache/samza/util/TestConfigUtil.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxODoyMzowM1rOFfBYAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxODo1MTo1MFrOFfCFVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA3MjcwNA==", "bodyText": "Should this also test config rewriting and overriding?", "url": "https://github.com/apache/samza/pull/1248#discussion_r368072704", "createdAt": "2020-01-17T18:23:03Z", "author": {"login": "cameronlee314"}, "path": "samza-core/src/test/java/org/apache/samza/util/TestConfigUtil.java", "diffHunk": "@@ -161,6 +162,31 @@ public void testApplyRewriterClassDoesNotExist() {\n     assertEquals(expectedConfig, ConfigUtil.applyRewriter(new MapConfig(fullConfig), REWRITER_NAME));\n   }\n \n+  @Test\n+  public void testLoadConfigWithoutLoader() {\n+    Map<String, String> config = new HashMap<>();\n+    config.put(JobConfig.JOB_NAME, \"new-test-job\");\n+\n+    Config actual = ConfigUtil.loadConfig(new MapConfig(config));\n+\n+    assertEquals(config.size(), actual.size());\n+    assertEquals(\"new-test-job\", actual.get(JobConfig.JOB_NAME));\n+  }\n+\n+  @Test\n+  public void testLoadConfigWithLoader() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de8ed411e5118dce7ce4f6587379fb29a36495ef"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA4NDMwOA==", "bodyText": "Updated to include both overrides and rewrites.", "url": "https://github.com/apache/samza/pull/1248#discussion_r368084308", "createdAt": "2020-01-17T18:51:50Z", "author": {"login": "kw2542"}, "path": "samza-core/src/test/java/org/apache/samza/util/TestConfigUtil.java", "diffHunk": "@@ -161,6 +162,31 @@ public void testApplyRewriterClassDoesNotExist() {\n     assertEquals(expectedConfig, ConfigUtil.applyRewriter(new MapConfig(fullConfig), REWRITER_NAME));\n   }\n \n+  @Test\n+  public void testLoadConfigWithoutLoader() {\n+    Map<String, String> config = new HashMap<>();\n+    config.put(JobConfig.JOB_NAME, \"new-test-job\");\n+\n+    Config actual = ConfigUtil.loadConfig(new MapConfig(config));\n+\n+    assertEquals(config.size(), actual.size());\n+    assertEquals(\"new-test-job\", actual.get(JobConfig.JOB_NAME));\n+  }\n+\n+  @Test\n+  public void testLoadConfigWithLoader() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA3MjcwNA=="}, "originalCommit": {"oid": "de8ed411e5118dce7ce4f6587379fb29a36495ef"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NDM2NjUwOnYy", "diffSide": "RIGHT", "path": "samza-core/src/main/java/org/apache/samza/util/ConfigUtil.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxODoyNDoxMVrOFfBZ0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxODozOTo1OFrOFfByoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA3MzE3MA==", "bodyText": "If this is public, can you please add a unit test for it? Or you could make it private.\nYou could also simplify it to only take in one extra argument since that is currently the only way it is used.", "url": "https://github.com/apache/samza/pull/1248#discussion_r368073170", "createdAt": "2020-01-17T18:24:11Z", "author": {"login": "cameronlee314"}, "path": "samza-core/src/main/java/org/apache/samza/util/ConfigUtil.java", "diffHunk": "@@ -67,4 +72,42 @@ public static Config applyRewriter(Config config, String rewriterName) {\n     LOG.info(\"Re-writing config with {}\", rewriter);\n     return rewriter.rewrite(rewriterName, config);\n   }\n+\n+  /**\n+   * Load full job config with {@link ConfigLoaderFactory} when present.\n+   *\n+   * @param original config\n+   * @return full job config\n+   */\n+  public static Config loadConfig(Config original) {\n+    JobConfig jobConfig = new JobConfig(original);\n+    Config fullConfig = original;\n+\n+    if (jobConfig.getConfigLoaderFactory().isPresent()) {\n+      ConfigLoaderFactory factory = ReflectionUtil.getObj(jobConfig.getConfigLoaderFactory().get(), ConfigLoaderFactory.class);\n+      ConfigLoader loader = factory.getLoader(original.subset(ConfigLoaderFactory.CONFIG_LOADER_PROPERTIES_PREFIX));\n+      // overrides config loaded with original config, which may contain overridden values.\n+      fullConfig = ConfigUtil.rewriteConfig(override(loader.getConfig(), original));\n+    }\n+\n+    return fullConfig;\n+  }\n+\n+  /**\n+   * Overrides original config with overridden values.\n+   *\n+   * @param original config to be overridden.\n+   * @param overrides overridden values.\n+   * @return the overridden config.\n+   */\n+  @SafeVarargs\n+  public static Config override(Config original, Map<String, String>... overrides) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de8ed411e5118dce7ce4f6587379fb29a36495ef"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA3OTUyMA==", "bodyText": "Updated to private", "url": "https://github.com/apache/samza/pull/1248#discussion_r368079520", "createdAt": "2020-01-17T18:39:58Z", "author": {"login": "kw2542"}, "path": "samza-core/src/main/java/org/apache/samza/util/ConfigUtil.java", "diffHunk": "@@ -67,4 +72,42 @@ public static Config applyRewriter(Config config, String rewriterName) {\n     LOG.info(\"Re-writing config with {}\", rewriter);\n     return rewriter.rewrite(rewriterName, config);\n   }\n+\n+  /**\n+   * Load full job config with {@link ConfigLoaderFactory} when present.\n+   *\n+   * @param original config\n+   * @return full job config\n+   */\n+  public static Config loadConfig(Config original) {\n+    JobConfig jobConfig = new JobConfig(original);\n+    Config fullConfig = original;\n+\n+    if (jobConfig.getConfigLoaderFactory().isPresent()) {\n+      ConfigLoaderFactory factory = ReflectionUtil.getObj(jobConfig.getConfigLoaderFactory().get(), ConfigLoaderFactory.class);\n+      ConfigLoader loader = factory.getLoader(original.subset(ConfigLoaderFactory.CONFIG_LOADER_PROPERTIES_PREFIX));\n+      // overrides config loaded with original config, which may contain overridden values.\n+      fullConfig = ConfigUtil.rewriteConfig(override(loader.getConfig(), original));\n+    }\n+\n+    return fullConfig;\n+  }\n+\n+  /**\n+   * Overrides original config with overridden values.\n+   *\n+   * @param original config to be overridden.\n+   * @param overrides overridden values.\n+   * @return the overridden config.\n+   */\n+  @SafeVarargs\n+  public static Config override(Config original, Map<String, String>... overrides) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA3MzE3MA=="}, "originalCommit": {"oid": "de8ed411e5118dce7ce4f6587379fb29a36495ef"}, "originalPosition": 50}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1543, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}