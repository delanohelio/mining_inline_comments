{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM0MTcxNDY1", "number": 1384, "title": "SAMZA-2549 - Samza-sql: Add query optimizations for remote table joins", "bodyText": "Feature:\nSamza Sql currently does not have a query optimizer. As a result, we rely on users to write their queries in such a way that the sql execution is optimized which is often clumsy and non-intuitive. Adding Query optimization will make sql query more intuitive at the same time making the plan optimized.\nChanges\nThis change adds rule based optimizer (HepPlanner) to Samza Sql query planner. As part of this commit, FilterJoinRule is added for remote table joins.\nAdded remote table join tests to ensure the plan is optimized.", "createdAt": "2020-06-14T16:50:13Z", "url": "https://github.com/apache/samza/pull/1384", "merged": true, "mergeCommit": {"oid": "f665824c1043bc3088bb629cedcabb37e8e91b4d"}, "closed": true, "closedAt": "2020-07-20T06:03:01Z", "author": {"login": "atoomula"}, "timelineItems": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcrj1qZgFqTQzMDgzNjY3MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc2o96MgFqTQ1MTI3Mzc0NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwODM2Njcw", "url": "https://github.com/apache/samza/pull/1384#pullrequestreview-430836670", "createdAt": "2020-06-15T17:10:06Z", "commit": {"oid": "1d85cbeb832ed5b3411599f52d505790aef5a76e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNzoxMDowN1rOGj7NVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNzoxMDowN1rOGj7NVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMyMzQxMw==", "bodyText": "This is basically tricking the planner to use Enum Convention plus Volcano planner to generate a Plan with Convention of  EnumerableConvention.INSTANCE. This will lead to complex branches down the line when doing the conversion as a follow up stage. You don't think the best way to do this is by using Calcite Conventions where Rules and Translation is happening at the same time to avoid complex code and very cryptic comments on what to expect when doing the translation ?", "url": "https://github.com/apache/samza/pull/1384#discussion_r440323413", "createdAt": "2020-06-15T17:10:07Z", "author": {"login": "b-slim"}, "path": "samza-sql/src/main/java/org/apache/samza/sql/planner/QueryPlanner.java", "diffHunk": "@@ -140,16 +171,46 @@ public RelRoot plan(String query) {\n           .operatorTable(new ChainedSqlOperatorTable(sqlOperatorTables))\n           .sqlToRelConverterConfig(SqlToRelConverter.Config.DEFAULT)\n           .traitDefs(traitDefs)\n-          .context(Contexts.EMPTY_CONTEXT)\n-          .costFactory(null)\n+          .programs(Programs.hep(rules, true, DefaultRelMetadataProvider.INSTANCE))\n           .build();\n-      Planner planner = Frameworks.getPlanner(frameworkConfig);\n+      planner = Frameworks.getPlanner(frameworkConfig);\n+      return planner;\n+    } catch (Exception e) {\n+      String errorMsg = \"Failed to create planner.\";\n+      LOG.error(errorMsg, e);\n+      throw new SamzaException(errorMsg, e);\n+    }\n+  }\n \n+  private RelRoot optimize(RelRoot relRoot) {\n+    RelTraitSet relTraitSet = RelTraitSet.createEmpty();\n+    relTraitSet = relTraitSet.plus(EnumerableConvention.INSTANCE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d85cbeb832ed5b3411599f52d505790aef5a76e"}, "originalPosition": 126}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwODM5NjU2", "url": "https://github.com/apache/samza/pull/1384#pullrequestreview-430839656", "createdAt": "2020-06-15T17:14:26Z", "commit": {"oid": "1d85cbeb832ed5b3411599f52d505790aef5a76e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNzoxNDoyNlrOGj7WLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNzoxNDoyNlrOGj7WLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMyNTY3OA==", "bodyText": "When would you turn off the optimization ? if it is just optimization it should be always turned on ?", "url": "https://github.com/apache/samza/pull/1384#discussion_r440325678", "createdAt": "2020-06-15T17:14:26Z", "author": {"login": "b-slim"}, "path": "samza-sql/src/main/java/org/apache/samza/sql/planner/QueryPlanner.java", "diffHunk": "@@ -140,16 +171,46 @@ public RelRoot plan(String query) {\n           .operatorTable(new ChainedSqlOperatorTable(sqlOperatorTables))\n           .sqlToRelConverterConfig(SqlToRelConverter.Config.DEFAULT)\n           .traitDefs(traitDefs)\n-          .context(Contexts.EMPTY_CONTEXT)\n-          .costFactory(null)\n+          .programs(Programs.hep(rules, true, DefaultRelMetadataProvider.INSTANCE))\n           .build();\n-      Planner planner = Frameworks.getPlanner(frameworkConfig);\n+      planner = Frameworks.getPlanner(frameworkConfig);\n+      return planner;\n+    } catch (Exception e) {\n+      String errorMsg = \"Failed to create planner.\";\n+      LOG.error(errorMsg, e);\n+      throw new SamzaException(errorMsg, e);\n+    }\n+  }\n \n+  private RelRoot optimize(RelRoot relRoot) {\n+    RelTraitSet relTraitSet = RelTraitSet.createEmpty();\n+    relTraitSet = relTraitSet.plus(EnumerableConvention.INSTANCE);\n+    try {\n+      RelRoot optimizedRelRoot =\n+          RelRoot.of(getPlanner().transform(0, relTraitSet, relRoot.project()), SqlKind.SELECT);\n+      LOG.info(\"query plan with optimization:\\n\"\n+          + RelOptUtil.toString(optimizedRelRoot.rel, SqlExplainLevel.EXPPLAN_ATTRIBUTES));\n+      return optimizedRelRoot;\n+    } catch (Exception e) {\n+      String errorMsg =\n+          \"Error while optimizing query plan:\\n\" + RelOptUtil.toString(relRoot.rel, SqlExplainLevel.EXPPLAN_ATTRIBUTES);\n+      LOG.error(errorMsg, e);\n+      throw new SamzaException(errorMsg, e);\n+    }\n+  }\n+\n+  public RelRoot plan(String query) {\n+    try {\n+      Planner planner = getPlanner();\n       SqlNode sql = planner.parse(query);\n       SqlNode validatedSql = planner.validate(sql);\n       RelRoot relRoot = planner.rel(validatedSql);\n-      LOG.info(\"query plan:\\n\" + RelOptUtil.toString(relRoot.rel, SqlExplainLevel.ALL_ATTRIBUTES));\n-      return relRoot;\n+      LOG.info(\"query plan without optimization:\\n\"\n+          + RelOptUtil.toString(relRoot.rel, SqlExplainLevel.EXPPLAN_ATTRIBUTES));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d85cbeb832ed5b3411599f52d505790aef5a76e"}, "originalPosition": 150}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwODQyMDQ3", "url": "https://github.com/apache/samza/pull/1384#pullrequestreview-430842047", "createdAt": "2020-06-15T17:17:44Z", "commit": {"oid": "1d85cbeb832ed5b3411599f52d505790aef5a76e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNzoxNzo0NFrOGj7dVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNzoxNzo0NFrOGj7dVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMyNzUxMA==", "bodyText": "As far I can tell it is only testing if filter is on the good side of the join, seems to me most of the work can be done at the onMatch, we can just extend and override onMatch ?", "url": "https://github.com/apache/samza/pull/1384#discussion_r440327510", "createdAt": "2020-06-15T17:17:44Z", "author": {"login": "b-slim"}, "path": "samza-sql/src/main/java/org/apache/samza/sql/planner/SamzaSqlFilterRemoteJoinRule.java", "diffHunk": "@@ -0,0 +1,259 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.samza.sql.planner;\n+\n+import java.util.Map;\n+import org.apache.calcite.plan.RelOptRule;\n+import org.apache.calcite.plan.RelOptRuleCall;\n+import org.apache.calcite.plan.RelOptRuleOperand;\n+import org.apache.calcite.plan.RelOptUtil;\n+import org.apache.calcite.rel.RelNode;\n+import org.apache.calcite.rel.core.Filter;\n+import org.apache.calcite.rel.core.Join;\n+import org.apache.calcite.rel.core.JoinRelType;\n+import org.apache.calcite.rel.type.RelDataType;\n+import org.apache.calcite.rex.RexBuilder;\n+import org.apache.calcite.rex.RexNode;\n+import org.apache.calcite.rex.RexUtil;\n+import org.apache.calcite.tools.RelBuilder;\n+import org.apache.calcite.tools.RelBuilderFactory;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import org.apache.samza.sql.interfaces.SqlIOConfig;\n+import org.apache.samza.sql.translator.JoinInputNode;\n+import org.apache.samza.sql.translator.JoinInputNode.InputType;\n+\n+/**\n+ * Planner rule for remote table joins that pushes filters above and\n+ * within a join node into its children nodes.\n+ * This class is customized form of Calcite's {@link org.apache.calcite.rel.rules.FilterJoinRule} for\n+ * remote table joins.\n+ */\n+public abstract class SamzaSqlFilterRemoteJoinRule extends RelOptRule {\n+  /** Whether to try to strengthen join-type. */\n+  private final boolean smart;\n+\n+  Map<String, SqlIOConfig> systemStreamConfigBySource;\n+\n+  //~ Constructors -----------------------------------------------------------\n+\n+  /**\n+   * Creates a FilterJoinRule with an explicit root operand and\n+   * factories.\n+   */\n+  protected SamzaSqlFilterRemoteJoinRule(RelOptRuleOperand operand, String id,\n+      boolean smart, RelBuilderFactory relBuilderFactory, Map<String, SqlIOConfig> systemStreamConfigBySource) {\n+    super(operand, relBuilderFactory, \"SamzaSqlFilterRemoteJoinRule:\" + id);\n+    this.smart = smart;\n+    this.systemStreamConfigBySource = systemStreamConfigBySource;\n+  }\n+\n+  //~ Methods ----------------------------------------------------------------\n+\n+  protected void perform(RelOptRuleCall call, Filter filter,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d85cbeb832ed5b3411599f52d505790aef5a76e"}, "originalPosition": 71}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1OTA1Nzk3", "url": "https://github.com/apache/samza/pull/1384#pullrequestreview-435905797", "createdAt": "2020-06-23T15:34:03Z", "commit": {"oid": "3f0587201e2ec9a8bd4d5e0aac7362986894036b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxNTozNDowM1rOGnu-Fg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxNTozNDowM1rOGnu-Fg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMxNzIwNg==", "bodyText": "The planner is a closable resource I think it would be better to use it within a try block or make sure to close it when done.", "url": "https://github.com/apache/samza/pull/1384#discussion_r444317206", "createdAt": "2020-06-23T15:34:03Z", "author": {"login": "b-slim"}, "path": "samza-sql/src/main/java/org/apache/samza/sql/planner/QueryPlanner.java", "diffHunk": "@@ -109,15 +124,19 @@ private void registerSourceSchemas(SchemaPlus rootSchema) {\n     }\n   }\n \n-  public RelRoot plan(String query) {\n+  private Planner getPlanner() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f0587201e2ec9a8bd4d5e0aac7362986894036b"}, "originalPosition": 68}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1OTEyMDc3", "url": "https://github.com/apache/samza/pull/1384#pullrequestreview-435912077", "createdAt": "2020-06-23T15:41:08Z", "commit": {"oid": "3f0587201e2ec9a8bd4d5e0aac7362986894036b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxNTo0MTowOFrOGnvQYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxNTo0MTowOFrOGnvQYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMyMTg5MQ==", "bodyText": "Why are we turning off for local tables things work fine, not sure I am getting this ?", "url": "https://github.com/apache/samza/pull/1384#discussion_r444321891", "createdAt": "2020-06-23T15:41:08Z", "author": {"login": "b-slim"}, "path": "samza-sql/src/main/java/org/apache/samza/sql/planner/SamzaSqlFilterRemoteJoinRule.java", "diffHunk": "@@ -0,0 +1,259 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.samza.sql.planner;\n+\n+import java.util.Map;\n+import org.apache.calcite.plan.RelOptRule;\n+import org.apache.calcite.plan.RelOptRuleCall;\n+import org.apache.calcite.plan.RelOptRuleOperand;\n+import org.apache.calcite.plan.RelOptUtil;\n+import org.apache.calcite.rel.RelNode;\n+import org.apache.calcite.rel.core.Filter;\n+import org.apache.calcite.rel.core.Join;\n+import org.apache.calcite.rel.core.JoinRelType;\n+import org.apache.calcite.rel.type.RelDataType;\n+import org.apache.calcite.rex.RexBuilder;\n+import org.apache.calcite.rex.RexNode;\n+import org.apache.calcite.rex.RexUtil;\n+import org.apache.calcite.tools.RelBuilder;\n+import org.apache.calcite.tools.RelBuilderFactory;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import org.apache.samza.sql.interfaces.SqlIOConfig;\n+import org.apache.samza.sql.translator.JoinInputNode;\n+import org.apache.samza.sql.translator.JoinInputNode.InputType;\n+\n+/**\n+ * Planner rule for remote table joins that pushes filters above and\n+ * within a join node into its children nodes.\n+ * This class is customized form of Calcite's {@link org.apache.calcite.rel.rules.FilterJoinRule} for\n+ * remote table joins.\n+ */\n+public abstract class SamzaSqlFilterRemoteJoinRule extends RelOptRule {\n+  /** Whether to try to strengthen join-type. */\n+  private final boolean smart;\n+\n+  Map<String, SqlIOConfig> systemStreamConfigBySource;\n+\n+  //~ Constructors -----------------------------------------------------------\n+\n+  /**\n+   * Creates a FilterJoinRule with an explicit root operand and\n+   * factories.\n+   */\n+  protected SamzaSqlFilterRemoteJoinRule(RelOptRuleOperand operand, String id,\n+      boolean smart, RelBuilderFactory relBuilderFactory, Map<String, SqlIOConfig> systemStreamConfigBySource) {\n+    super(operand, relBuilderFactory, \"SamzaSqlFilterRemoteJoinRule:\" + id);\n+    this.smart = smart;\n+    this.systemStreamConfigBySource = systemStreamConfigBySource;\n+  }\n+\n+  //~ Methods ----------------------------------------------------------------\n+\n+  protected void perform(RelOptRuleCall call, Filter filter,\n+      Join join) {\n+    final List<RexNode> joinFilters =\n+        RelOptUtil.conjunctions(join.getCondition());\n+\n+    boolean donotOptimizeLeft = false;\n+    boolean donotOptimizeRight = false;\n+\n+    JoinInputNode.InputType inputTypeOnLeft =\n+        JoinInputNode.getInputType(join.getLeft(), systemStreamConfigBySource);\n+    JoinInputNode.InputType inputTypeOnRight =\n+        JoinInputNode.getInputType(join.getRight(), systemStreamConfigBySource);\n+\n+    // Disable this optimnization for queries using local table.\n+    if (inputTypeOnLeft == InputType.LOCAL_TABLE || inputTypeOnRight == InputType.LOCAL_TABLE) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f0587201e2ec9a8bd4d5e0aac7362986894036b"}, "originalPosition": 85}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1OTIzMjg4", "url": "https://github.com/apache/samza/pull/1384#pullrequestreview-435923288", "createdAt": "2020-06-23T15:53:26Z", "commit": {"oid": "3f0587201e2ec9a8bd4d5e0aac7362986894036b"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8044b6a237328e32ffa7881a1b44b57803745927", "author": {"user": {"login": "atoomula", "name": "Aditya Toomula"}}, "url": "https://github.com/apache/samza/commit/8044b6a237328e32ffa7881a1b44b57803745927", "committedDate": "2020-07-01T02:32:07Z", "message": "SAMZA-2549 - Samza-sql: Add query optimizations for remote table joins"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc7863f3531465ff1a1a48509d302cf327ef6ab6", "author": {"user": {"login": "atoomula", "name": "Aditya Toomula"}}, "url": "https://github.com/apache/samza/commit/cc7863f3531465ff1a1a48509d302cf327ef6ab6", "committedDate": "2020-07-01T02:32:07Z", "message": "SAMZA-2549 - Samza-sql: Add query optimizations for remote table joins"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "853bcbbfae61207e0b3d9fd81ac149f440086090", "author": {"user": {"login": "atoomula", "name": "Aditya Toomula"}}, "url": "https://github.com/apache/samza/commit/853bcbbfae61207e0b3d9fd81ac149f440086090", "committedDate": "2020-07-01T02:32:07Z", "message": "SAMZA-2549 - Samza-sql: Add query optimizations for remote table joins"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1086936fe36c9486e73bfdf8f7b7177161a964c9", "author": {"user": {"login": "atoomula", "name": "Aditya Toomula"}}, "url": "https://github.com/apache/samza/commit/1086936fe36c9486e73bfdf8f7b7177161a964c9", "committedDate": "2020-07-01T02:32:07Z", "message": "SAMZA-2549 - Samza-sql: Add query optimizations for remote table joins"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4bbdd2c1d427cc7127c276adb8ac657c10359a83", "author": {"user": {"login": "atoomula", "name": "Aditya Toomula"}}, "url": "https://github.com/apache/samza/commit/4bbdd2c1d427cc7127c276adb8ac657c10359a83", "committedDate": "2020-07-01T02:32:07Z", "message": "SAMZA-2549 - Samza-sql: Add query optimizations for remote table joins"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b4e5d5f4f508f5d6f9bdf4f9d6cf1ea314da008", "author": {"user": {"login": "atoomula", "name": "Aditya Toomula"}}, "url": "https://github.com/apache/samza/commit/1b4e5d5f4f508f5d6f9bdf4f9d6cf1ea314da008", "committedDate": "2020-07-01T02:32:07Z", "message": "SAMZA-2549 - Samza-sql: Add query optimizations for remote table joins"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f73f4801af6f8d93436d52c961d67a25b40b12e3", "author": {"user": {"login": "atoomula", "name": "Aditya Toomula"}}, "url": "https://github.com/apache/samza/commit/f73f4801af6f8d93436d52c961d67a25b40b12e3", "committedDate": "2020-07-01T02:32:07Z", "message": "SAMZA-2549 - Samza-sql: Add query optimizations for remote table joins"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "63e101db7b87e089b8d101a094b824588532e162", "author": {"user": {"login": "atoomula", "name": "Aditya Toomula"}}, "url": "https://github.com/apache/samza/commit/63e101db7b87e089b8d101a094b824588532e162", "committedDate": "2020-07-01T02:32:07Z", "message": "SAMZA-2549 - Samza-sql: Add query optimizations for remote table joins"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "477d95f95bfc290e876735575112a153d26cc742", "author": {"user": {"login": "atoomula", "name": "Aditya Toomula"}}, "url": "https://github.com/apache/samza/commit/477d95f95bfc290e876735575112a153d26cc742", "committedDate": "2020-07-01T02:32:07Z", "message": "SAMZA-2549 - Samza-sql: Add query optimizations for remote table joins"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ced116cfc3778171a73c37646c56e6dd987f975b", "author": {"user": {"login": "atoomula", "name": "Aditya Toomula"}}, "url": "https://github.com/apache/samza/commit/ced116cfc3778171a73c37646c56e6dd987f975b", "committedDate": "2020-07-01T02:32:07Z", "message": "SAMZA-2549 - Samza-sql: Add query optimizations for remote table joins"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b6d375cc82492d55e85fd6bc2bccfda1cffa7d9", "author": {"user": {"login": "atoomula", "name": "Aditya Toomula"}}, "url": "https://github.com/apache/samza/commit/1b6d375cc82492d55e85fd6bc2bccfda1cffa7d9", "committedDate": "2020-07-01T02:32:07Z", "message": "Fix checkstyle errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b75106bd8931ab81048db2b3fa76fc3e0b8f32a", "author": {"user": {"login": "atoomula", "name": "Aditya Toomula"}}, "url": "https://github.com/apache/samza/commit/6b75106bd8931ab81048db2b3fa76fc3e0b8f32a", "committedDate": "2020-07-01T02:32:07Z", "message": "Fix checkstyle errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1642990a74d740ff7e464b2dd3fec9ea3c6bdd34", "author": {"user": {"login": "atoomula", "name": "Aditya Toomula"}}, "url": "https://github.com/apache/samza/commit/1642990a74d740ff7e464b2dd3fec9ea3c6bdd34", "committedDate": "2020-07-01T02:32:07Z", "message": "Fix checkstyle errors"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "99a1f4b5e8ced05a060a50f2ca2ab198a6bde8cf", "author": {"user": {"login": "atoomula", "name": "Aditya Toomula"}}, "url": "https://github.com/apache/samza/commit/99a1f4b5e8ced05a060a50f2ca2ab198a6bde8cf", "committedDate": "2020-07-01T02:20:25Z", "message": "Fix checkstyle errors"}, "afterCommit": {"oid": "1642990a74d740ff7e464b2dd3fec9ea3c6bdd34", "author": {"user": {"login": "atoomula", "name": "Aditya Toomula"}}, "url": "https://github.com/apache/samza/commit/1642990a74d740ff7e464b2dd3fec9ea3c6bdd34", "committedDate": "2020-07-01T02:32:07Z", "message": "Fix checkstyle errors"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxNzA5Mzgw", "url": "https://github.com/apache/samza/pull/1384#pullrequestreview-431709380", "createdAt": "2020-06-16T16:56:04Z", "commit": {"oid": "3f0587201e2ec9a8bd4d5e0aac7362986894036b"}, "state": "COMMENTED", "comments": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNjo1NjowNFrOGkkpFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxODo1MjozNVrOGw1fHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAwMjI2Mg==", "bodyText": "Nit:\n\nBy default, Logger adds \\n to EOL. Unnecessary to explicitly add it.\nAlso, it's better to capitalize all the log-messages.", "url": "https://github.com/apache/samza/pull/1384#discussion_r441002262", "createdAt": "2020-06-16T16:56:04Z", "author": {"login": "shanthoosh"}, "path": "samza-sql/src/main/java/org/apache/samza/sql/planner/QueryPlanner.java", "diffHunk": "@@ -140,16 +166,45 @@ public RelRoot plan(String query) {\n           .operatorTable(new ChainedSqlOperatorTable(sqlOperatorTables))\n           .sqlToRelConverterConfig(SqlToRelConverter.Config.DEFAULT)\n           .traitDefs(traitDefs)\n-          .context(Contexts.EMPTY_CONTEXT)\n-          .costFactory(null)\n+          .programs(Programs.hep(rules, true, DefaultRelMetadataProvider.INSTANCE))\n           .build();\n-      Planner planner = Frameworks.getPlanner(frameworkConfig);\n+      planner = Frameworks.getPlanner(frameworkConfig);\n+      return planner;\n+    } catch (Exception e) {\n+      String errorMsg = \"Failed to create planner.\";\n+      LOG.error(errorMsg, e);\n+      throw new SamzaException(errorMsg, e);\n+    }\n+  }\n \n+  private RelRoot optimize(RelRoot relRoot) {\n+    RelTraitSet relTraitSet = RelTraitSet.createEmpty();\n+    try {\n+      RelRoot optimizedRelRoot =\n+          RelRoot.of(getPlanner().transform(0, relTraitSet, relRoot.project()), SqlKind.SELECT);\n+      LOG.info(\"query plan with optimization:\\n\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f0587201e2ec9a8bd4d5e0aac7362986894036b"}, "originalPosition": 122}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAwNDkwMQ==", "bodyText": "What is the rationale for recreating the planner for every sql-statement in the app?", "url": "https://github.com/apache/samza/pull/1384#discussion_r441004901", "createdAt": "2020-06-16T17:00:15Z", "author": {"login": "shanthoosh"}, "path": "samza-sql/src/main/java/org/apache/samza/sql/dsl/SamzaSqlDslConverter.java", "diffHunk": "@@ -52,9 +52,9 @@\n   public Collection<RelRoot> convertDsl(String dsl) {\n     // TODO: Introduce an API to parse a dsl string and return one or more sql statements\n     List<String> sqlStmts = fetchSqlFromConfig(config);\n-    QueryPlanner planner = getQueryPlanner(getSqlConfig(sqlStmts, config));\n     List<RelRoot> relRoots = new LinkedList<>();\n     for (String sql: sqlStmts) {\n+      QueryPlanner planner = getQueryPlanner(getSqlConfig(Collections.singletonList(sql), config));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f0587201e2ec9a8bd4d5e0aac7362986894036b"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc3MTM4Nw==", "bodyText": "Would be better to create a follow-up ticket for this action-item.", "url": "https://github.com/apache/samza/pull/1384#discussion_r453771387", "createdAt": "2020-07-13T16:22:07Z", "author": {"login": "shanthoosh"}, "path": "samza-sql/src/main/java/org/apache/samza/sql/planner/QueryPlanner.java", "diffHunk": "@@ -129,6 +142,13 @@ public RelRoot plan(String query) {\n       sqlOperatorTables.add(new SamzaSqlOperatorTable());\n       sqlOperatorTables.add(new SamzaSqlUdfOperatorTable(samzaSqlFunctions));\n \n+      // TODO: Introduce a pluggable rule factory.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1642990a74d740ff7e464b2dd3fec9ea3c6bdd34"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzgyMDcyOA==", "bodyText": "nit: %s/optimnization/optimization", "url": "https://github.com/apache/samza/pull/1384#discussion_r453820728", "createdAt": "2020-07-13T17:43:28Z", "author": {"login": "shanthoosh"}, "path": "samza-sql/src/main/java/org/apache/samza/sql/planner/SamzaSqlFilterRemoteJoinRule.java", "diffHunk": "@@ -0,0 +1,259 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.samza.sql.planner;\n+\n+import java.util.Map;\n+import org.apache.calcite.plan.RelOptRule;\n+import org.apache.calcite.plan.RelOptRuleCall;\n+import org.apache.calcite.plan.RelOptRuleOperand;\n+import org.apache.calcite.plan.RelOptUtil;\n+import org.apache.calcite.rel.RelNode;\n+import org.apache.calcite.rel.core.Filter;\n+import org.apache.calcite.rel.core.Join;\n+import org.apache.calcite.rel.core.JoinRelType;\n+import org.apache.calcite.rel.type.RelDataType;\n+import org.apache.calcite.rex.RexBuilder;\n+import org.apache.calcite.rex.RexNode;\n+import org.apache.calcite.rex.RexUtil;\n+import org.apache.calcite.tools.RelBuilder;\n+import org.apache.calcite.tools.RelBuilderFactory;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import org.apache.samza.sql.interfaces.SqlIOConfig;\n+import org.apache.samza.sql.translator.JoinInputNode;\n+import org.apache.samza.sql.translator.JoinInputNode.InputType;\n+\n+/**\n+ * Planner rule for remote table joins that pushes filters above and\n+ * within a join node into its children nodes.\n+ * This class is customized form of Calcite's {@link org.apache.calcite.rel.rules.FilterJoinRule} for\n+ * remote table joins.\n+ */\n+public abstract class SamzaSqlFilterRemoteJoinRule extends RelOptRule {\n+  /** Whether to try to strengthen join-type. */\n+  private final boolean smart;\n+\n+  Map<String, SqlIOConfig> systemStreamConfigBySource;\n+\n+  //~ Constructors -----------------------------------------------------------\n+\n+  /**\n+   * Creates a SamzaSqlFilterRemoteJoinRule with an explicit root operand and\n+   * factories.\n+   */\n+  protected SamzaSqlFilterRemoteJoinRule(RelOptRuleOperand operand, String id,\n+      boolean smart, RelBuilderFactory relBuilderFactory, Map<String, SqlIOConfig> systemStreamConfigBySource) {\n+    super(operand, relBuilderFactory, \"SamzaSqlFilterRemoteJoinRule:\" + id);\n+    this.smart = smart;\n+    this.systemStreamConfigBySource = systemStreamConfigBySource;\n+  }\n+\n+  //~ Methods ----------------------------------------------------------------\n+\n+  protected void perform(RelOptRuleCall call, Filter filter,\n+      Join join) {\n+    final List<RexNode> joinFilters =\n+        RelOptUtil.conjunctions(join.getCondition());\n+\n+    boolean donotOptimizeLeft = false;\n+    boolean donotOptimizeRight = false;\n+\n+    JoinInputNode.InputType inputTypeOnLeft =\n+        JoinInputNode.getInputType(join.getLeft(), systemStreamConfigBySource);\n+    JoinInputNode.InputType inputTypeOnRight =\n+        JoinInputNode.getInputType(join.getRight(), systemStreamConfigBySource);\n+\n+    // Disable this optimnization for queries using local table.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1642990a74d740ff7e464b2dd3fec9ea3c6bdd34"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzgyMTExOA==", "bodyText": "Please import the ImmutableList class and don't hardcode the package paths. There're multiple occurrences in this file and else-where.", "url": "https://github.com/apache/samza/pull/1384#discussion_r453821118", "createdAt": "2020-07-13T17:44:10Z", "author": {"login": "shanthoosh"}, "path": "samza-sql/src/main/java/org/apache/samza/sql/planner/SamzaSqlFilterRemoteJoinRule.java", "diffHunk": "@@ -0,0 +1,259 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.samza.sql.planner;\n+\n+import java.util.Map;\n+import org.apache.calcite.plan.RelOptRule;\n+import org.apache.calcite.plan.RelOptRuleCall;\n+import org.apache.calcite.plan.RelOptRuleOperand;\n+import org.apache.calcite.plan.RelOptUtil;\n+import org.apache.calcite.rel.RelNode;\n+import org.apache.calcite.rel.core.Filter;\n+import org.apache.calcite.rel.core.Join;\n+import org.apache.calcite.rel.core.JoinRelType;\n+import org.apache.calcite.rel.type.RelDataType;\n+import org.apache.calcite.rex.RexBuilder;\n+import org.apache.calcite.rex.RexNode;\n+import org.apache.calcite.rex.RexUtil;\n+import org.apache.calcite.tools.RelBuilder;\n+import org.apache.calcite.tools.RelBuilderFactory;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import org.apache.samza.sql.interfaces.SqlIOConfig;\n+import org.apache.samza.sql.translator.JoinInputNode;\n+import org.apache.samza.sql.translator.JoinInputNode.InputType;\n+\n+/**\n+ * Planner rule for remote table joins that pushes filters above and\n+ * within a join node into its children nodes.\n+ * This class is customized form of Calcite's {@link org.apache.calcite.rel.rules.FilterJoinRule} for\n+ * remote table joins.\n+ */\n+public abstract class SamzaSqlFilterRemoteJoinRule extends RelOptRule {\n+  /** Whether to try to strengthen join-type. */\n+  private final boolean smart;\n+\n+  Map<String, SqlIOConfig> systemStreamConfigBySource;\n+\n+  //~ Constructors -----------------------------------------------------------\n+\n+  /**\n+   * Creates a SamzaSqlFilterRemoteJoinRule with an explicit root operand and\n+   * factories.\n+   */\n+  protected SamzaSqlFilterRemoteJoinRule(RelOptRuleOperand operand, String id,\n+      boolean smart, RelBuilderFactory relBuilderFactory, Map<String, SqlIOConfig> systemStreamConfigBySource) {\n+    super(operand, relBuilderFactory, \"SamzaSqlFilterRemoteJoinRule:\" + id);\n+    this.smart = smart;\n+    this.systemStreamConfigBySource = systemStreamConfigBySource;\n+  }\n+\n+  //~ Methods ----------------------------------------------------------------\n+\n+  protected void perform(RelOptRuleCall call, Filter filter,\n+      Join join) {\n+    final List<RexNode> joinFilters =\n+        RelOptUtil.conjunctions(join.getCondition());\n+\n+    boolean donotOptimizeLeft = false;\n+    boolean donotOptimizeRight = false;\n+\n+    JoinInputNode.InputType inputTypeOnLeft =\n+        JoinInputNode.getInputType(join.getLeft(), systemStreamConfigBySource);\n+    JoinInputNode.InputType inputTypeOnRight =\n+        JoinInputNode.getInputType(join.getRight(), systemStreamConfigBySource);\n+\n+    // Disable this optimnization for queries using local table.\n+    if (inputTypeOnLeft == InputType.LOCAL_TABLE || inputTypeOnRight == InputType.LOCAL_TABLE) {\n+      donotOptimizeLeft = true;\n+      donotOptimizeRight = true;\n+    }\n+\n+    // There is nothing to optimize on the remote table side as the lookup needs to happen first before filtering.\n+    if (inputTypeOnLeft == InputType.REMOTE_TABLE) {\n+      donotOptimizeLeft = true;\n+    }\n+    if (inputTypeOnRight == InputType.REMOTE_TABLE) {\n+      donotOptimizeRight = true;\n+    }\n+\n+    // If there is only the joinRel,\n+    // make sure it does not match a cartesian product joinRel\n+    // (with \"true\" condition), otherwise this rule will be applied\n+    // again on the new cartesian product joinRel.\n+    if (filter == null && joinFilters.isEmpty()) {\n+      return;\n+    }\n+\n+    final List<RexNode> aboveFilters =\n+        filter != null\n+            ? RelOptUtil.conjunctions(filter.getCondition())\n+            : new ArrayList<>();\n+    final com.google.common.collect.ImmutableList<RexNode> origAboveFilters =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1642990a74d740ff7e464b2dd3fec9ea3c6bdd34"}, "originalPosition": 110}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzgzNzU5NQ==", "bodyText": "Just curious. Why did we comment this out? If this is not necessary, then can we please remove it?", "url": "https://github.com/apache/samza/pull/1384#discussion_r453837595", "createdAt": "2020-07-13T18:12:23Z", "author": {"login": "shanthoosh"}, "path": "samza-sql/src/main/java/org/apache/samza/sql/util/SamzaSqlQueryParser.java", "diffHunk": "@@ -165,6 +165,7 @@ private static Planner createPlanner() {\n         .traitDefs(traitDefs)\n         .context(Contexts.EMPTY_CONTEXT)\n         .costFactory(null)\n+        //.programs(Programs.CALC_PROGRAM)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1642990a74d740ff7e464b2dd3fec9ea3c6bdd34"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg0OTY1OA==", "bodyText": "Just curious. Can you please clarify if we should use aboveFilters here for third argument? From the semantics  of classifyFilters method, it seems like appropriate choice. Might be better to rename the variable to something better(other than aboveFilters).", "url": "https://github.com/apache/samza/pull/1384#discussion_r453849658", "createdAt": "2020-07-13T18:32:42Z", "author": {"login": "shanthoosh"}, "path": "samza-sql/src/main/java/org/apache/samza/sql/planner/SamzaSqlFilterRemoteJoinRule.java", "diffHunk": "@@ -0,0 +1,259 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.samza.sql.planner;\n+\n+import java.util.Map;\n+import org.apache.calcite.plan.RelOptRule;\n+import org.apache.calcite.plan.RelOptRuleCall;\n+import org.apache.calcite.plan.RelOptRuleOperand;\n+import org.apache.calcite.plan.RelOptUtil;\n+import org.apache.calcite.rel.RelNode;\n+import org.apache.calcite.rel.core.Filter;\n+import org.apache.calcite.rel.core.Join;\n+import org.apache.calcite.rel.core.JoinRelType;\n+import org.apache.calcite.rel.type.RelDataType;\n+import org.apache.calcite.rex.RexBuilder;\n+import org.apache.calcite.rex.RexNode;\n+import org.apache.calcite.rex.RexUtil;\n+import org.apache.calcite.tools.RelBuilder;\n+import org.apache.calcite.tools.RelBuilderFactory;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import org.apache.samza.sql.interfaces.SqlIOConfig;\n+import org.apache.samza.sql.translator.JoinInputNode;\n+import org.apache.samza.sql.translator.JoinInputNode.InputType;\n+\n+/**\n+ * Planner rule for remote table joins that pushes filters above and\n+ * within a join node into its children nodes.\n+ * This class is customized form of Calcite's {@link org.apache.calcite.rel.rules.FilterJoinRule} for\n+ * remote table joins.\n+ */\n+public abstract class SamzaSqlFilterRemoteJoinRule extends RelOptRule {\n+  /** Whether to try to strengthen join-type. */\n+  private final boolean smart;\n+\n+  Map<String, SqlIOConfig> systemStreamConfigBySource;\n+\n+  //~ Constructors -----------------------------------------------------------\n+\n+  /**\n+   * Creates a SamzaSqlFilterRemoteJoinRule with an explicit root operand and\n+   * factories.\n+   */\n+  protected SamzaSqlFilterRemoteJoinRule(RelOptRuleOperand operand, String id,\n+      boolean smart, RelBuilderFactory relBuilderFactory, Map<String, SqlIOConfig> systemStreamConfigBySource) {\n+    super(operand, relBuilderFactory, \"SamzaSqlFilterRemoteJoinRule:\" + id);\n+    this.smart = smart;\n+    this.systemStreamConfigBySource = systemStreamConfigBySource;\n+  }\n+\n+  //~ Methods ----------------------------------------------------------------\n+\n+  protected void perform(RelOptRuleCall call, Filter filter,\n+      Join join) {\n+    final List<RexNode> joinFilters =\n+        RelOptUtil.conjunctions(join.getCondition());\n+\n+    boolean donotOptimizeLeft = false;\n+    boolean donotOptimizeRight = false;\n+\n+    JoinInputNode.InputType inputTypeOnLeft =\n+        JoinInputNode.getInputType(join.getLeft(), systemStreamConfigBySource);\n+    JoinInputNode.InputType inputTypeOnRight =\n+        JoinInputNode.getInputType(join.getRight(), systemStreamConfigBySource);\n+\n+    // Disable this optimnization for queries using local table.\n+    if (inputTypeOnLeft == InputType.LOCAL_TABLE || inputTypeOnRight == InputType.LOCAL_TABLE) {\n+      donotOptimizeLeft = true;\n+      donotOptimizeRight = true;\n+    }\n+\n+    // There is nothing to optimize on the remote table side as the lookup needs to happen first before filtering.\n+    if (inputTypeOnLeft == InputType.REMOTE_TABLE) {\n+      donotOptimizeLeft = true;\n+    }\n+    if (inputTypeOnRight == InputType.REMOTE_TABLE) {\n+      donotOptimizeRight = true;\n+    }\n+\n+    // If there is only the joinRel,\n+    // make sure it does not match a cartesian product joinRel\n+    // (with \"true\" condition), otherwise this rule will be applied\n+    // again on the new cartesian product joinRel.\n+    if (filter == null && joinFilters.isEmpty()) {\n+      return;\n+    }\n+\n+    final List<RexNode> aboveFilters =\n+        filter != null\n+            ? RelOptUtil.conjunctions(filter.getCondition())\n+            : new ArrayList<>();\n+    final com.google.common.collect.ImmutableList<RexNode> origAboveFilters =\n+        com.google.common.collect.ImmutableList.copyOf(aboveFilters);\n+\n+    // Simplify Outer Joins\n+    JoinRelType joinType = join.getJoinType();\n+    if (smart\n+        && !origAboveFilters.isEmpty()\n+        && join.getJoinType() != JoinRelType.INNER) {\n+      joinType = RelOptUtil.simplifyJoin(join, origAboveFilters, joinType);\n+    }\n+\n+    final List<RexNode> leftFilters = new ArrayList<>();\n+    final List<RexNode> rightFilters = new ArrayList<>();\n+\n+    // TODO - add logic to derive additional filters.  E.g., from\n+    // (t1.a = 1 AND t2.a = 2) OR (t1.b = 3 AND t2.b = 4), you can\n+    // derive table filters:\n+    // (t1.a = 1 OR t1.b = 3)\n+    // (t2.a = 2 OR t2.b = 4)\n+\n+    // Try to push down above filters. These are typically where clause\n+    // filters. They can be pushed down if they are not on the NULL\n+    // generating side.\n+    // We do not push into join condition as we do not benefit much. There is also correctness issue\n+    // with remote table as we will not have values for the remote table before the join/lookup.\n+    boolean filterPushed = false;\n+    if (RelOptUtil.classifyFilters(\n+        join,\n+        aboveFilters,\n+        joinType,\n+        false, // Let's not push into join filter\n+        !joinType.generatesNullsOnLeft() && !donotOptimizeLeft,\n+        !joinType.generatesNullsOnRight() && !donotOptimizeRight,\n+        joinFilters,\n+        leftFilters,\n+        rightFilters)) {\n+      filterPushed = true;\n+    }\n+\n+    // If no filter got pushed after validate, reset filterPushed flag\n+    if (leftFilters.isEmpty()\n+        && rightFilters.isEmpty()) {\n+      filterPushed = false;\n+    }\n+\n+    boolean isAntiJoin = joinType == JoinRelType.ANTI;\n+\n+    // Try to push down filters in ON clause. A ON clause filter can only be\n+    // pushed down if it does not affect the non-matching set, i.e. it is\n+    // not on the side which is preserved.\n+    // A ON clause filter of anti-join can not be pushed down.\n+    if (!isAntiJoin && RelOptUtil.classifyFilters(\n+        join,\n+        joinFilters,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1642990a74d740ff7e464b2dd3fec9ea3c6bdd34"}, "originalPosition": 163}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg1MjMyNg==", "bodyText": "Leftfilters and rightFilters are initialized and are not modified. It's very hard to find where they're populated. Please add a comment here that leftFilters and rightFilters will be populated by this classifyFilters method.", "url": "https://github.com/apache/samza/pull/1384#discussion_r453852326", "createdAt": "2020-07-13T18:37:15Z", "author": {"login": "shanthoosh"}, "path": "samza-sql/src/main/java/org/apache/samza/sql/planner/SamzaSqlFilterRemoteJoinRule.java", "diffHunk": "@@ -0,0 +1,259 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.samza.sql.planner;\n+\n+import java.util.Map;\n+import org.apache.calcite.plan.RelOptRule;\n+import org.apache.calcite.plan.RelOptRuleCall;\n+import org.apache.calcite.plan.RelOptRuleOperand;\n+import org.apache.calcite.plan.RelOptUtil;\n+import org.apache.calcite.rel.RelNode;\n+import org.apache.calcite.rel.core.Filter;\n+import org.apache.calcite.rel.core.Join;\n+import org.apache.calcite.rel.core.JoinRelType;\n+import org.apache.calcite.rel.type.RelDataType;\n+import org.apache.calcite.rex.RexBuilder;\n+import org.apache.calcite.rex.RexNode;\n+import org.apache.calcite.rex.RexUtil;\n+import org.apache.calcite.tools.RelBuilder;\n+import org.apache.calcite.tools.RelBuilderFactory;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import org.apache.samza.sql.interfaces.SqlIOConfig;\n+import org.apache.samza.sql.translator.JoinInputNode;\n+import org.apache.samza.sql.translator.JoinInputNode.InputType;\n+\n+/**\n+ * Planner rule for remote table joins that pushes filters above and\n+ * within a join node into its children nodes.\n+ * This class is customized form of Calcite's {@link org.apache.calcite.rel.rules.FilterJoinRule} for\n+ * remote table joins.\n+ */\n+public abstract class SamzaSqlFilterRemoteJoinRule extends RelOptRule {\n+  /** Whether to try to strengthen join-type. */\n+  private final boolean smart;\n+\n+  Map<String, SqlIOConfig> systemStreamConfigBySource;\n+\n+  //~ Constructors -----------------------------------------------------------\n+\n+  /**\n+   * Creates a SamzaSqlFilterRemoteJoinRule with an explicit root operand and\n+   * factories.\n+   */\n+  protected SamzaSqlFilterRemoteJoinRule(RelOptRuleOperand operand, String id,\n+      boolean smart, RelBuilderFactory relBuilderFactory, Map<String, SqlIOConfig> systemStreamConfigBySource) {\n+    super(operand, relBuilderFactory, \"SamzaSqlFilterRemoteJoinRule:\" + id);\n+    this.smart = smart;\n+    this.systemStreamConfigBySource = systemStreamConfigBySource;\n+  }\n+\n+  //~ Methods ----------------------------------------------------------------\n+\n+  protected void perform(RelOptRuleCall call, Filter filter,\n+      Join join) {\n+    final List<RexNode> joinFilters =\n+        RelOptUtil.conjunctions(join.getCondition());\n+\n+    boolean donotOptimizeLeft = false;\n+    boolean donotOptimizeRight = false;\n+\n+    JoinInputNode.InputType inputTypeOnLeft =\n+        JoinInputNode.getInputType(join.getLeft(), systemStreamConfigBySource);\n+    JoinInputNode.InputType inputTypeOnRight =\n+        JoinInputNode.getInputType(join.getRight(), systemStreamConfigBySource);\n+\n+    // Disable this optimnization for queries using local table.\n+    if (inputTypeOnLeft == InputType.LOCAL_TABLE || inputTypeOnRight == InputType.LOCAL_TABLE) {\n+      donotOptimizeLeft = true;\n+      donotOptimizeRight = true;\n+    }\n+\n+    // There is nothing to optimize on the remote table side as the lookup needs to happen first before filtering.\n+    if (inputTypeOnLeft == InputType.REMOTE_TABLE) {\n+      donotOptimizeLeft = true;\n+    }\n+    if (inputTypeOnRight == InputType.REMOTE_TABLE) {\n+      donotOptimizeRight = true;\n+    }\n+\n+    // If there is only the joinRel,\n+    // make sure it does not match a cartesian product joinRel\n+    // (with \"true\" condition), otherwise this rule will be applied\n+    // again on the new cartesian product joinRel.\n+    if (filter == null && joinFilters.isEmpty()) {\n+      return;\n+    }\n+\n+    final List<RexNode> aboveFilters =\n+        filter != null\n+            ? RelOptUtil.conjunctions(filter.getCondition())\n+            : new ArrayList<>();\n+    final com.google.common.collect.ImmutableList<RexNode> origAboveFilters =\n+        com.google.common.collect.ImmutableList.copyOf(aboveFilters);\n+\n+    // Simplify Outer Joins\n+    JoinRelType joinType = join.getJoinType();\n+    if (smart\n+        && !origAboveFilters.isEmpty()\n+        && join.getJoinType() != JoinRelType.INNER) {\n+      joinType = RelOptUtil.simplifyJoin(join, origAboveFilters, joinType);\n+    }\n+\n+    final List<RexNode> leftFilters = new ArrayList<>();\n+    final List<RexNode> rightFilters = new ArrayList<>();\n+\n+    // TODO - add logic to derive additional filters.  E.g., from\n+    // (t1.a = 1 AND t2.a = 2) OR (t1.b = 3 AND t2.b = 4), you can\n+    // derive table filters:\n+    // (t1.a = 1 OR t1.b = 3)\n+    // (t2.a = 2 OR t2.b = 4)\n+\n+    // Try to push down above filters. These are typically where clause\n+    // filters. They can be pushed down if they are not on the NULL\n+    // generating side.\n+    // We do not push into join condition as we do not benefit much. There is also correctness issue\n+    // with remote table as we will not have values for the remote table before the join/lookup.\n+    boolean filterPushed = false;\n+    if (RelOptUtil.classifyFilters(\n+        join,\n+        aboveFilters,\n+        joinType,\n+        false, // Let's not push into join filter\n+        !joinType.generatesNullsOnLeft() && !donotOptimizeLeft,\n+        !joinType.generatesNullsOnRight() && !donotOptimizeRight,\n+        joinFilters,\n+        leftFilters,\n+        rightFilters)) {\n+      filterPushed = true;\n+    }\n+\n+    // If no filter got pushed after validate, reset filterPushed flag\n+    if (leftFilters.isEmpty()\n+        && rightFilters.isEmpty()) {\n+      filterPushed = false;\n+    }\n+\n+    boolean isAntiJoin = joinType == JoinRelType.ANTI;\n+\n+    // Try to push down filters in ON clause. A ON clause filter can only be\n+    // pushed down if it does not affect the non-matching set, i.e. it is\n+    // not on the side which is preserved.\n+    // A ON clause filter of anti-join can not be pushed down.\n+    if (!isAntiJoin && RelOptUtil.classifyFilters(\n+        join,\n+        joinFilters,\n+        joinType,\n+        false,\n+        !joinType.generatesNullsOnLeft() && !donotOptimizeLeft,\n+        !joinType.generatesNullsOnRight() && !donotOptimizeRight,\n+        joinFilters,\n+        leftFilters,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1642990a74d740ff7e464b2dd3fec9ea3c6bdd34"}, "originalPosition": 169}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg1NDkwNw==", "bodyText": "Please capitalize log messages and remove \\n at the end(which gets added by default).", "url": "https://github.com/apache/samza/pull/1384#discussion_r453854907", "createdAt": "2020-07-13T18:41:49Z", "author": {"login": "shanthoosh"}, "path": "samza-sql/src/main/java/org/apache/samza/sql/planner/QueryPlanner.java", "diffHunk": "@@ -140,16 +160,48 @@ public RelRoot plan(String query) {\n           .operatorTable(new ChainedSqlOperatorTable(sqlOperatorTables))\n           .sqlToRelConverterConfig(SqlToRelConverter.Config.DEFAULT)\n           .traitDefs(traitDefs)\n-          .context(Contexts.EMPTY_CONTEXT)\n-          .costFactory(null)\n+          .programs(Programs.hep(rules, true, DefaultRelMetadataProvider.INSTANCE))\n           .build();\n-      Planner planner = Frameworks.getPlanner(frameworkConfig);\n+      planner = Frameworks.getPlanner(frameworkConfig);\n+      return planner;\n+    } catch (Exception e) {\n+      String errorMsg = \"Failed to create planner.\";\n+      LOG.error(errorMsg, e);\n+      if (planner != null) {\n+        planner.close();\n+      }\n+      throw new SamzaException(errorMsg, e);\n+    }\n+  }\n \n+  private RelRoot optimize(Planner planner, RelRoot relRoot) {\n+    RelTraitSet relTraitSet = RelTraitSet.createEmpty();\n+    try {\n+      RelRoot optimizedRelRoot =\n+          RelRoot.of(planner.transform(0, relTraitSet, relRoot.project()), SqlKind.SELECT);\n+      LOG.info(\"query plan with optimization:\\n\"\n+          + RelOptUtil.toString(optimizedRelRoot.rel, SqlExplainLevel.EXPPLAN_ATTRIBUTES));\n+      return optimizedRelRoot;\n+    } catch (Exception e) {\n+      String errorMsg =\n+          \"Error while optimizing query plan:\\n\" + RelOptUtil.toString(relRoot.rel, SqlExplainLevel.EXPPLAN_ATTRIBUTES);\n+      LOG.error(errorMsg, e);\n+      planner.close();\n+      throw new SamzaException(errorMsg, e);\n+    }\n+  }\n+\n+  public RelRoot plan(String query) {\n+    try (Planner planner = getPlanner()) {\n       SqlNode sql = planner.parse(query);\n       SqlNode validatedSql = planner.validate(sql);\n       RelRoot relRoot = planner.rel(validatedSql);\n-      LOG.info(\"query plan:\\n\" + RelOptUtil.toString(relRoot.rel, SqlExplainLevel.ALL_ATTRIBUTES));\n-      return relRoot;\n+      LOG.info(\n+          \"query plan without optimization:\\n\" + RelOptUtil.toString(relRoot.rel, SqlExplainLevel.EXPPLAN_ATTRIBUTES));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1642990a74d740ff7e464b2dd3fec9ea3c6bdd34"}, "originalPosition": 139}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg1Nzc1Mw==", "bodyText": "Calling close() here seems unnecessary, It's already closed at the caller already with try-with-resources-closeable.", "url": "https://github.com/apache/samza/pull/1384#discussion_r453857753", "createdAt": "2020-07-13T18:46:43Z", "author": {"login": "shanthoosh"}, "path": "samza-sql/src/main/java/org/apache/samza/sql/planner/QueryPlanner.java", "diffHunk": "@@ -140,16 +160,48 @@ public RelRoot plan(String query) {\n           .operatorTable(new ChainedSqlOperatorTable(sqlOperatorTables))\n           .sqlToRelConverterConfig(SqlToRelConverter.Config.DEFAULT)\n           .traitDefs(traitDefs)\n-          .context(Contexts.EMPTY_CONTEXT)\n-          .costFactory(null)\n+          .programs(Programs.hep(rules, true, DefaultRelMetadataProvider.INSTANCE))\n           .build();\n-      Planner planner = Frameworks.getPlanner(frameworkConfig);\n+      planner = Frameworks.getPlanner(frameworkConfig);\n+      return planner;\n+    } catch (Exception e) {\n+      String errorMsg = \"Failed to create planner.\";\n+      LOG.error(errorMsg, e);\n+      if (planner != null) {\n+        planner.close();\n+      }\n+      throw new SamzaException(errorMsg, e);\n+    }\n+  }\n \n+  private RelRoot optimize(Planner planner, RelRoot relRoot) {\n+    RelTraitSet relTraitSet = RelTraitSet.createEmpty();\n+    try {\n+      RelRoot optimizedRelRoot =\n+          RelRoot.of(planner.transform(0, relTraitSet, relRoot.project()), SqlKind.SELECT);\n+      LOG.info(\"query plan with optimization:\\n\"\n+          + RelOptUtil.toString(optimizedRelRoot.rel, SqlExplainLevel.EXPPLAN_ATTRIBUTES));\n+      return optimizedRelRoot;\n+    } catch (Exception e) {\n+      String errorMsg =\n+          \"Error while optimizing query plan:\\n\" + RelOptUtil.toString(relRoot.rel, SqlExplainLevel.EXPPLAN_ATTRIBUTES);\n+      LOG.error(errorMsg, e);\n+      planner.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1642990a74d740ff7e464b2dd3fec9ea3c6bdd34"}, "originalPosition": 126}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg1ODU0OA==", "bodyText": "Is there a way to determine if these rel-rules are applied on a rel-plan and emit a metric(or log it before/after the optimization) for debugging purposes.", "url": "https://github.com/apache/samza/pull/1384#discussion_r453858548", "createdAt": "2020-07-13T18:47:58Z", "author": {"login": "shanthoosh"}, "path": "samza-sql/src/main/java/org/apache/samza/sql/planner/QueryPlanner.java", "diffHunk": "@@ -129,6 +142,13 @@ public RelRoot plan(String query) {\n       sqlOperatorTables.add(new SamzaSqlOperatorTable());\n       sqlOperatorTables.add(new SamzaSqlUdfOperatorTable(samzaSqlFunctions));\n \n+      // TODO: Introduce a pluggable rule factory.\n+      List<RelOptRule> rules = ImmutableList.of(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1642990a74d740ff7e464b2dd3fec9ea3c6bdd34"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg2MTE1MA==", "bodyText": "Just curious. There seems to be considerable duplication with FilterJoinRule calcite native-class. Post CALCITE-3170, calcite supports anti-join on conditions push-down natively. If we upgrade to 1.21.0 rel-planner, then wouldn't overriding match suffice here?", "url": "https://github.com/apache/samza/pull/1384#discussion_r453861150", "createdAt": "2020-07-13T18:52:35Z", "author": {"login": "shanthoosh"}, "path": "samza-sql/src/main/java/org/apache/samza/sql/planner/SamzaSqlFilterRemoteJoinRule.java", "diffHunk": "@@ -0,0 +1,259 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.samza.sql.planner;\n+\n+import java.util.Map;\n+import org.apache.calcite.plan.RelOptRule;\n+import org.apache.calcite.plan.RelOptRuleCall;\n+import org.apache.calcite.plan.RelOptRuleOperand;\n+import org.apache.calcite.plan.RelOptUtil;\n+import org.apache.calcite.rel.RelNode;\n+import org.apache.calcite.rel.core.Filter;\n+import org.apache.calcite.rel.core.Join;\n+import org.apache.calcite.rel.core.JoinRelType;\n+import org.apache.calcite.rel.type.RelDataType;\n+import org.apache.calcite.rex.RexBuilder;\n+import org.apache.calcite.rex.RexNode;\n+import org.apache.calcite.rex.RexUtil;\n+import org.apache.calcite.tools.RelBuilder;\n+import org.apache.calcite.tools.RelBuilderFactory;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import org.apache.samza.sql.interfaces.SqlIOConfig;\n+import org.apache.samza.sql.translator.JoinInputNode;\n+import org.apache.samza.sql.translator.JoinInputNode.InputType;\n+\n+/**\n+ * Planner rule for remote table joins that pushes filters above and\n+ * within a join node into its children nodes.\n+ * This class is customized form of Calcite's {@link org.apache.calcite.rel.rules.FilterJoinRule} for\n+ * remote table joins.\n+ */\n+public abstract class SamzaSqlFilterRemoteJoinRule extends RelOptRule {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1642990a74d740ff7e464b2dd3fec9ea3c6bdd34"}, "originalPosition": 50}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e46ca37d3039c9b4d31c6b5040ce6ff51c8c8922", "author": {"user": {"login": "atoomula", "name": "Aditya Toomula"}}, "url": "https://github.com/apache/samza/commit/e46ca37d3039c9b4d31c6b5040ce6ff51c8c8922", "committedDate": "2020-07-19T17:26:22Z", "message": "SAMZA-2549 - Samza-sql: Add query optimizations for remote table joins"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxMjczNzQ1", "url": "https://github.com/apache/samza/pull/1384#pullrequestreview-451273745", "createdAt": "2020-07-20T03:21:49Z", "commit": {"oid": "e46ca37d3039c9b4d31c6b5040ce6ff51c8c8922"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4636, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}