{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk2NjQyMDUw", "number": 1335, "title": "SAMZA-2501 : Optimizing startpoint manager to not make successive bootstrapMessage calls to coordinator-store", "bodyText": "Symptom: Currently the startpoint manager queries metastore for task-ssps and for each ssp queries coordinator-store, issuing a re-read on the coordinator store. This causes increased AM startup time and depending on the number of input SSPs to a job (thousands in case of regex), YARN may timeout the AM.\nCause: Above.\nFix: This change reduces to number of metastore reads to 2; one for startpoints keyed by ssp and the other for startpoints keyed by ssp+taskname.\nAPI changes: None\nUpgrade Instructions: None", "createdAt": "2020-03-31T22:25:45Z", "url": "https://github.com/apache/samza/pull/1335", "merged": true, "mergeCommit": {"oid": "26d9eecac76f3b87610312d0066d96a5b36eef35"}, "closed": true, "closedAt": "2020-04-01T23:43:06Z", "author": {"login": "rmatharu"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcTKs2egH2gAyMzk2NjQyMDUwOjgxNzk4N2IwMWI1MGVkNWIwNzQ4Y2YyY2I3MDQwYjg5MWFkOWQwOGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTf-2cgFqTM4NjAwOTE2MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "817987b01b50ed5b0748cf2cb7040b891ad9d08d", "author": {"user": null}, "url": "https://github.com/apache/samza/commit/817987b01b50ed5b0748cf2cb7040b891ad9d08d", "committedDate": "2020-03-31T22:18:41Z", "message": "Optimizing startpoint manager"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fbe8dc71509e2b06aac6508f30149c91e2f6936f", "author": {"user": null}, "url": "https://github.com/apache/samza/commit/fbe8dc71509e2b06aac6508f30149c91e2f6936f", "committedDate": "2020-03-31T22:40:06Z", "message": "Minor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d318de7bca18592ac00b5efe614e2b1aaaf21f71", "author": {"user": null}, "url": "https://github.com/apache/samza/commit/d318de7bca18592ac00b5efe614e2b1aaaf21f71", "committedDate": "2020-03-31T22:53:49Z", "message": "Updating deleteKeys after fanout behavior"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1MjYzMjg2", "url": "https://github.com/apache/samza/pull/1335#pullrequestreview-385263286", "createdAt": "2020-04-01T04:49:20Z", "commit": {"oid": "d318de7bca18592ac00b5efe614e2b1aaaf21f71"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwNDo0OToyMFrOF-wt0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwNDo0OToyMFrOF-wt0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM1NDE5NQ==", "bodyText": "null as a key and .get(null) looks atypical and not readable on the go. It does require some context for someone to get the background on this.", "url": "https://github.com/apache/samza/pull/1335#discussion_r401354195", "createdAt": "2020-04-01T04:49:20Z", "author": {"login": "mynameborat"}, "path": "samza-core/src/main/java/org/apache/samza/startpoint/StartpointManager.java", "diffHunk": "@@ -159,38 +160,63 @@ public void writeStartpoint(SystemStreamPartition ssp, TaskName taskName, Startp\n    *         It is empty if it does not exist or if it is too stale.\n    */\n   public Optional<Startpoint> readStartpoint(SystemStreamPartition ssp) {\n-    return readStartpoint(ssp, null);\n+    return readStartpointMap(Collections.singletonMap(null, Collections.singleton(ssp)), false).get(null)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d318de7bca18592ac00b5efe614e2b1aaaf21f71"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9497014fd36d7e02d45f429e146e530d8be9f22f", "author": {"user": null}, "url": "https://github.com/apache/samza/commit/9497014fd36d7e02d45f429e146e530d8be9f22f", "committedDate": "2020-04-01T17:31:46Z", "message": "Making read once"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e36107973554517d6f58ad3822a0047359ea542f", "author": {"user": null}, "url": "https://github.com/apache/samza/commit/e36107973554517d6f58ad3822a0047359ea542f", "committedDate": "2020-04-01T17:54:23Z", "message": "Major refactor adding config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23290222031cd2d9f73f1eef7c4432fda43e02b9", "author": {"user": null}, "url": "https://github.com/apache/samza/commit/23290222031cd2d9f73f1eef7c4432fda43e02b9", "committedDate": "2020-04-01T17:56:00Z", "message": "Making config as \"enabled\""}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1ODc0ODAw", "url": "https://github.com/apache/samza/pull/1335#pullrequestreview-385874800", "createdAt": "2020-04-01T19:13:33Z", "commit": {"oid": "23290222031cd2d9f73f1eef7c4432fda43e02b9"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxOToxMzozM1rOF_O4nw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxOToxNDoyMFrOF_O6mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg0ODQ3OQ==", "bodyText": "Revert the change on line line 162 calling readStartpoint(ssp, null); will still do the intended, do not need line 163-165", "url": "https://github.com/apache/samza/pull/1335#discussion_r401848479", "createdAt": "2020-04-01T19:13:33Z", "author": {"login": "Sanil15"}, "path": "samza-core/src/main/java/org/apache/samza/startpoint/StartpointManager.java", "diffHunk": "@@ -158,8 +158,25 @@ public void writeStartpoint(SystemStreamPartition ssp, TaskName taskName, Startp\n    * @return {@link Optional} of {@link Startpoint} for the {@link SystemStreamPartition}.\n    *         It is empty if it does not exist or if it is too stale.\n    */\n+  @VisibleForTesting\n   public Optional<Startpoint> readStartpoint(SystemStreamPartition ssp) {\n-    return readStartpoint(ssp, null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23290222031cd2d9f73f1eef7c4432fda43e02b9"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg0ODk4Nw==", "bodyText": "Please correct the comment, task-name can be non-null", "url": "https://github.com/apache/samza/pull/1335#discussion_r401848987", "createdAt": "2020-04-01T19:14:20Z", "author": {"login": "Sanil15"}, "path": "samza-core/src/main/java/org/apache/samza/startpoint/StartpointManager.java", "diffHunk": "@@ -158,8 +158,25 @@ public void writeStartpoint(SystemStreamPartition ssp, TaskName taskName, Startp\n    * @return {@link Optional} of {@link Startpoint} for the {@link SystemStreamPartition}.\n    *         It is empty if it does not exist or if it is too stale.\n    */\n+  @VisibleForTesting\n   public Optional<Startpoint> readStartpoint(SystemStreamPartition ssp) {\n-    return readStartpoint(ssp, null);\n+    Map<String, byte[]> startpointBytes = readWriteStore.all();\n+    // there is no task-name to use as key for the startpoint in this case (only the ssp), so we use a null task-name\n+    return readStartpoint(startpointBytes, ssp, null);\n+  }\n+\n+  /**\n+   * Returns the last {@link Startpoint} that defines the start position for a {@link SystemStreamPartition} and {@link TaskName}.\n+   * @param ssp The {@link SystemStreamPartition} to fetch the {@link Startpoint} for.\n+   * @param taskName the {@link TaskName} to fetch the {@link Startpoint} for.\n+   * @return {@link Optional} of {@link Startpoint} for the {@link SystemStreamPartition}.\n+   *         It is empty if it does not exist or if it is too stale.\n+   */\n+  @VisibleForTesting\n+  public Optional<Startpoint> readStartpoint(SystemStreamPartition ssp, TaskName taskName) {\n+    Map<String, byte[]> startpointBytes = readWriteStore.all();\n+    // there is no task-name to use as key for the startpoint in this case (only the ssp), so we use a null task-name", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23290222031cd2d9f73f1eef7c4432fda43e02b9"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1ODc4MDU0", "url": "https://github.com/apache/samza/pull/1335#pullrequestreview-385878054", "createdAt": "2020-04-01T19:18:24Z", "commit": {"oid": "23290222031cd2d9f73f1eef7c4432fda43e02b9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxOToxODoyNFrOF_PDNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxOToxODoyNFrOF_PDNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg1MTE4OA==", "bodyText": "If this config is called job.startpoint.fanout.enabled, isn't it better to be a part of JobConfig than ClusterManagerConfig?", "url": "https://github.com/apache/samza/pull/1335#discussion_r401851188", "createdAt": "2020-04-01T19:18:24Z", "author": {"login": "Sanil15"}, "path": "samza-core/src/main/java/org/apache/samza/config/ClusterManagerConfig.java", "diffHunk": "@@ -127,6 +127,7 @@\n    */\n   private static final String AM_JMX_ENABLED = \"yarn.am.jmx.enabled\";\n   private static final String CLUSTER_MANAGER_JMX_ENABLED = \"cluster-manager.jobcoordinator.jmx.enabled\";\n+  private static final String CLUSTER_MANAGER_STARTPOINT_FANOUT_ENABLED = \"job.startpoint.fanout.enabled\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23290222031cd2d9f73f1eef7c4432fda43e02b9"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "099730963a7f42732e3d3002806c50388733e6bc", "author": {"user": null}, "url": "https://github.com/apache/samza/commit/099730963a7f42732e3d3002806c50388733e6bc", "committedDate": "2020-04-01T19:22:38Z", "message": "some minor comment changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7965d51c2e7879efd54825ced4733d5c4c5b508e", "author": {"user": null}, "url": "https://github.com/apache/samza/commit/7965d51c2e7879efd54825ced4733d5c4c5b508e", "committedDate": "2020-04-01T22:57:43Z", "message": "Adding jobconfig for startpoints"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2MDA5MTYw", "url": "https://github.com/apache/samza/pull/1335#pullrequestreview-386009160", "createdAt": "2020-04-01T23:06:21Z", "commit": {"oid": "7965d51c2e7879efd54825ced4733d5c4c5b508e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4847, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}