{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMyODcxNzkz", "number": 1452, "title": "SAMZA-2611: [AM-HA] heartbeat reestablish causes container's heartbeat thread to die", "bodyText": "Symptom: When new AM takes a long time to to start up, already running container's heartbeat thread silently dies and does not make any heartbeat requests to the new AM.\nCause: AM url (yarn.am.tracking.url) key-value is removed from Coordinator stream when new AM is starting up - as this config is present in old config (aka coordinator stream) but not in the new AM generated config. This causes the running container to fetch a null when its constantly fetching value for this key and thus throws NPE.\nChanges: When AMHA is enabled, do not remove this config\nTests: works with hello-samza. Trying to write a unit test but CoordinatorStreamUtil  is tricky to mock and inject stuff.\nUsage Instructions: N/A\nUpgrade Instructions: N/A", "createdAt": "2020-12-05T01:39:17Z", "url": "https://github.com/apache/samza/pull/1452", "merged": true, "mergeCommit": {"oid": "220cbe29911718b5b49509d3f42e8851237f6249"}, "closed": true, "closedAt": "2020-12-07T15:50:26Z", "author": {"login": "lakshmi-manasa-g"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdjCFh1AH2gAyNTMyODcxNzkzOjA5NzE0NzBkNTYxMDVlNjlmMjhkYjY4ZDNjYjFjMTQwZDFjOTU4NjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdj3kaSAFqTU0NjI3NjMxMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0971470d56105e69f28db68d3cb1c140d1c95864", "author": {"user": {"login": "lakshmi-manasa-g", "name": null}}, "url": "https://github.com/apache/samza/commit/0971470d56105e69f28db68d3cb1c140d1c95864", "committedDate": "2020-12-05T01:30:26Z", "message": "SAMZA-2611: [AM-HA] heartbeat reestablish causes container's heartbeat thread to die"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1MzkwMTYx", "url": "https://github.com/apache/samza/pull/1452#pullrequestreview-545390161", "createdAt": "2020-12-05T01:46:32Z", "commit": {"oid": "0971470d56105e69f28db68d3cb1c140d1c95864"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNVQwMTo0NjozMlrOH_n_1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNVQwMTo0ODo0MlrOH_oBWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQ3NzY1NA==", "bodyText": "It will kill the thread and recreate one. I'd suggest instead to proceed with exit code as below except log the error of the exception too.\nRecreating the thread doesn't guarantee that the subsequent thread can recover from the previous error and potentially run into this in a loop of some sorts without any concrete action.", "url": "https://github.com/apache/samza/pull/1452#discussion_r536477654", "createdAt": "2020-12-05T01:46:32Z", "author": {"login": "mynameborat"}, "path": "samza-core/src/main/java/org/apache/samza/container/ContainerHeartbeatMonitor.java", "diffHunk": "@@ -92,8 +93,13 @@ public void start() {\n       if (!response.isAlive()) {\n         if (isApplicationMasterHighAvailabilityEnabled) {\n           LOG.warn(\"Failed to establish connection with {}. Checking for new AM\", coordinatorUrl);\n-          if (checkAndEstablishConnectionWithNewAM()) {\n-            return;\n+          try {\n+            if (checkAndEstablishConnectionWithNewAM()) {\n+              return;\n+            }\n+          } catch (Exception e) {\n+            LOG.warn(\"Exception trying to connect with new AM\", e);\n+            throw new SamzaException(e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0971470d56105e69f28db68d3cb1c140d1c95864"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQ3ODA0MQ==", "bodyText": "Should be a LOG.error as this is fatal and should be treat as such.", "url": "https://github.com/apache/samza/pull/1452#discussion_r536478041", "createdAt": "2020-12-05T01:48:42Z", "author": {"login": "mynameborat"}, "path": "samza-core/src/main/java/org/apache/samza/container/ContainerHeartbeatMonitor.java", "diffHunk": "@@ -92,8 +93,13 @@ public void start() {\n       if (!response.isAlive()) {\n         if (isApplicationMasterHighAvailabilityEnabled) {\n           LOG.warn(\"Failed to establish connection with {}. Checking for new AM\", coordinatorUrl);\n-          if (checkAndEstablishConnectionWithNewAM()) {\n-            return;\n+          try {\n+            if (checkAndEstablishConnectionWithNewAM()) {\n+              return;\n+            }\n+          } catch (Exception e) {\n+            LOG.warn(\"Exception trying to connect with new AM\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0971470d56105e69f28db68d3cb1c140d1c95864"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24eb44691ade8acf574d781a1ea8ae8ed38d3603", "author": {"user": {"login": "lakshmi-manasa-g", "name": null}}, "url": "https://github.com/apache/samza/commit/24eb44691ade8acf574d781a1ea8ae8ed38d3603", "committedDate": "2020-12-06T20:49:01Z", "message": "address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2f1a256d40b26536701595a0c5ea92b3974fd0f", "author": {"user": {"login": "lakshmi-manasa-g", "name": null}}, "url": "https://github.com/apache/samza/commit/d2f1a256d40b26536701595a0c5ea92b3974fd0f", "committedDate": "2020-12-07T01:19:26Z", "message": "fix typo"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2Mjc2MzEw", "url": "https://github.com/apache/samza/pull/1452#pullrequestreview-546276310", "createdAt": "2020-12-07T15:46:07Z", "commit": {"oid": "d2f1a256d40b26536701595a0c5ea92b3974fd0f"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNTo0NjowN1rOIAtH0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNTo0NjowN1rOIAtH0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYxMDE5Mw==", "bodyText": "nit: typo s/cconnection/connection", "url": "https://github.com/apache/samza/pull/1452#discussion_r537610193", "createdAt": "2020-12-07T15:46:07Z", "author": {"login": "mynameborat"}, "path": "samza-core/src/main/java/org/apache/samza/container/ContainerHeartbeatMonitor.java", "diffHunk": "@@ -92,17 +93,19 @@ public void start() {\n       if (!response.isAlive()) {\n         if (isApplicationMasterHighAvailabilityEnabled) {\n           LOG.warn(\"Failed to establish connection with {}. Checking for new AM\", coordinatorUrl);\n-          if (checkAndEstablishConnectionWithNewAM()) {\n+          try {\n+            if (checkAndEstablishConnectionWithNewAM()) {\n+              return;\n+            }\n+          } catch (Exception e) {\n+            // On exception in re-establish connection with new AM, force exit.\n+            LOG.error(\"Exception trying to connect with new AM\", e);\n+            forceExit(\"failure in establishing cconnection with new AM\", 0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2f1a256d40b26536701595a0c5ea92b3974fd0f"}, "originalPosition": 20}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4554, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}