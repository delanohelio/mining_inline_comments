{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEwNTMwODQ5", "number": 1353, "title": "SAMZA-2517 : Adding handling and relevant exception message for null in oldest offset from system-admin", "bodyText": "Problem: When a Kafka broker returns null for oldest-offset, because of a OpenJDK bug (https://bugs.openjdk.java.net/browse/JDK-8148463), the collect() operation in TaskSideInputStorageManager can fail with a misleading null-pointer-exception message.\nNote however that, Kafka broker cannot return null for oldest-offset.\nCause: Above.\nFix: The fix is to use the suggested workaround for the bug https://bugs.openjdk.java.net/browse/JDK-8148463\nAnd update the exception and log messages in case the oldest-offset are returned as null from Kafka.\nAPI changes: None\nUpgrade Instructions: None", "createdAt": "2020-04-29T07:09:51Z", "url": "https://github.com/apache/samza/pull/1353", "merged": true, "mergeCommit": {"oid": "9977adf32da1bb17e11bed452196a0be666cb33b"}, "closed": true, "closedAt": "2020-05-01T18:12:15Z", "author": {"login": "rmatharu"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABccTDC2gH2gAyNDEwNTMwODQ5OmQ5NjZhY2ViOGQ3ZDZiMDBjNjg3ZmFkNzE4OTMxYTEwYzk3NWZlOGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcdFlKQAFqTQwNDMwNjU3Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d966aceb8d7d6b00c687fad718931a10c975fe8f", "author": {"user": null}, "url": "https://github.com/apache/samza/commit/d966aceb8d7d6b00c687fad718931a10c975fe8f", "committedDate": "2020-04-29T07:07:29Z", "message": "Adding handling and relevant exception message for null in oldest offset from system-admin"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyNDI4MjE5", "url": "https://github.com/apache/samza/pull/1353#pullrequestreview-402428219", "createdAt": "2020-04-29T07:40:37Z", "commit": {"oid": "d966aceb8d7d6b00c687fad718931a10c975fe8f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQwNzo0MDozOFrOGNzLfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQwNzo0MDozOFrOGNzLfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzEyMzE5OQ==", "bodyText": "This map seems redundant. Why not directly put to oldestOffsets?", "url": "https://github.com/apache/samza/pull/1353#discussion_r417123199", "createdAt": "2020-04-29T07:40:38Z", "author": {"login": "bkonold"}, "path": "samza-core/src/main/java/org/apache/samza/storage/TaskSideInputStorageManager.java", "diffHunk": "@@ -363,15 +364,22 @@ File getStoreLocation(String storeName) {\n \n     // Step 3\n     metadata.forEach((systemStream, systemStreamMetadata) -> {\n+\n         // get the partition metadata for each system stream\n         Map<Partition, SystemStreamMetadata.SystemStreamPartitionMetadata> partitionMetadata =\n           systemStreamMetadata.getSystemStreamPartitionMetadata();\n \n         // For SSPs belonging to the system stream, use the partition metadata to get the oldest offset\n-        Map<SystemStreamPartition, String> offsets = systemStreamToSsp.get(systemStream).stream()\n-          .collect(\n-              Collectors.toMap(Function.identity(), ssp -> partitionMetadata.get(ssp.getPartition()).getOldestOffset()));\n-\n+        // if partitionMetadata was not obtained for any SSP, populate oldest-offset as null\n+        // Because of https://bugs.openjdk.java.net/browse/JDK-8148463 using lambda will NPE when getOldestOffset() is null\n+        Map<SystemStreamPartition, String> offsets = new HashMap<>();\n+        for (SystemStreamPartition ssp : systemStreamToSsp.get(systemStream)) {\n+          if (partitionMetadata == null || partitionMetadata.get(ssp.getPartition()) == null) {\n+            offsets.put(ssp, null);\n+          } else {\n+            offsets.put(ssp, partitionMetadata.get(ssp.getPartition()).getOldestOffset());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d966aceb8d7d6b00c687fad718931a10c975fe8f"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyODgyMDM2", "url": "https://github.com/apache/samza/pull/1353#pullrequestreview-402882036", "createdAt": "2020-04-29T17:25:25Z", "commit": {"oid": "d966aceb8d7d6b00c687fad718931a10c975fe8f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNzoyNToyNVrOGOJSYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNzoyNToyNVrOGOJSYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ4NTQwOQ==", "bodyText": "SystemStreamMetadata#getSystemStreamPartitionMetadata is also used in CoordinatorStreamStore, ContainerStorageManager and other places, we should also do null handling there right?\nIsn't it better to do at StreamMetadataCache level?", "url": "https://github.com/apache/samza/pull/1353#discussion_r417485409", "createdAt": "2020-04-29T17:25:25Z", "author": {"login": "Sanil15"}, "path": "samza-core/src/main/java/org/apache/samza/storage/TaskSideInputStorageManager.java", "diffHunk": "@@ -363,15 +364,22 @@ File getStoreLocation(String storeName) {\n \n     // Step 3\n     metadata.forEach((systemStream, systemStreamMetadata) -> {\n+\n         // get the partition metadata for each system stream\n         Map<Partition, SystemStreamMetadata.SystemStreamPartitionMetadata> partitionMetadata =\n           systemStreamMetadata.getSystemStreamPartitionMetadata();\n \n         // For SSPs belonging to the system stream, use the partition metadata to get the oldest offset\n-        Map<SystemStreamPartition, String> offsets = systemStreamToSsp.get(systemStream).stream()\n-          .collect(\n-              Collectors.toMap(Function.identity(), ssp -> partitionMetadata.get(ssp.getPartition()).getOldestOffset()));\n-\n+        // if partitionMetadata was not obtained for any SSP, populate oldest-offset as null\n+        // Because of https://bugs.openjdk.java.net/browse/JDK-8148463 using lambda will NPE when getOldestOffset() is null\n+        Map<SystemStreamPartition, String> offsets = new HashMap<>();\n+        for (SystemStreamPartition ssp : systemStreamToSsp.get(systemStream)) {\n+          if (partitionMetadata == null || partitionMetadata.get(ssp.getPartition()) == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d966aceb8d7d6b00c687fad718931a10c975fe8f"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b8eef38312623ee519afece2f122b2ac4675166", "author": {"user": null}, "url": "https://github.com/apache/samza/commit/2b8eef38312623ee519afece2f122b2ac4675166", "committedDate": "2020-04-29T19:33:00Z", "message": "Addressing review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzMDQ5MDM2", "url": "https://github.com/apache/samza/pull/1353#pullrequestreview-403049036", "createdAt": "2020-04-29T21:21:40Z", "commit": {"oid": "2b8eef38312623ee519afece2f122b2ac4675166"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQyMToyMTo0MVrOGOReyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQyMToyNDowOVrOGORjuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYxOTY1OA==", "bodyText": "What's the purpose for multiple ssps if they are each testing the same condition?", "url": "https://github.com/apache/samza/pull/1353#discussion_r417619658", "createdAt": "2020-04-29T21:21:41Z", "author": {"login": "bkonold"}, "path": "samza-core/src/test/java/org/apache/samza/storage/TestTaskSideInputStorageManager.java", "diffHunk": "@@ -182,6 +186,36 @@ public void testGetFileOffsets() {\n       });\n   }\n \n+  /**\n+   * This test is for cases, when calls to systemAdmin (e.g., KafkaSystemAdmin's) get-stream-metadata method return null.\n+   */\n+  @Test\n+  public void testGetStartingOffsetsWhenStreamMetadataIsNull() {\n+    final String storeName = \"test-get-starting-offset-store\";\n+    final String taskName = \"test-get-starting-offset-task\";\n+\n+    Set<SystemStreamPartition> ssps = IntStream.range(1, 6)\n+        .mapToObj(idx -> new SystemStreamPartition(\"test-system\", \"test-stream\", new Partition(idx)))\n+        .collect(Collectors.toSet());\n+    Map<Partition, SystemStreamMetadata.SystemStreamPartitionMetadata> partitionMetadata = ssps.stream()\n+        .collect(Collectors.toMap(SystemStreamPartition::getPartition,\n+            x -> new SystemStreamMetadata.SystemStreamPartitionMetadata(null, \"1\", \"2\")));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2b8eef38312623ee519afece2f122b2ac4675166"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYyMDkyMw==", "bodyText": "thanks for adding docs", "url": "https://github.com/apache/samza/pull/1353#discussion_r417620923", "createdAt": "2020-04-29T21:24:09Z", "author": {"login": "bkonold"}, "path": "samza-core/src/main/java/org/apache/samza/storage/TaskSideInputStorageManager.java", "diffHunk": "@@ -346,7 +346,8 @@ File getStoreLocation(String storeName) {\n    *   3. Fetches the partition metadata for each system stream and fetch the corresponding partition metadata\n    *      and populates the oldest offset for SSPs belonging to the system stream.\n    *\n-   * @return a {@link Map} of {@link SystemStreamPartition} to their oldest offset.\n+   * @return a {@link Map} of {@link SystemStreamPartition} to their oldest offset. If partitionMetadata could not be\n+   * obtained for any {@link SystemStreamPartition} the offset for it is populated as null.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2b8eef38312623ee519afece2f122b2ac4675166"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c0ee00cccdabc6e55ceef5ab966ffdc503b5316", "author": {"user": null}, "url": "https://github.com/apache/samza/commit/0c0ee00cccdabc6e55ceef5ab966ffdc503b5316", "committedDate": "2020-05-01T05:43:09Z", "message": "Addressing comment on testtasksideinputstoragemanager"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0MzA2NTc2", "url": "https://github.com/apache/samza/pull/1353#pullrequestreview-404306576", "createdAt": "2020-05-01T18:00:00Z", "commit": {"oid": "0c0ee00cccdabc6e55ceef5ab966ffdc503b5316"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4583, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}