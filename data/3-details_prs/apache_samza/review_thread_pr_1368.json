{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIzNjMxMTM0", "number": 1368, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxNzoxMzoxOVrOEAMlKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNzoyNDo1M1rOECQF-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4NjQxNTc4OnYy", "diffSide": "LEFT", "path": "samza-core/src/main/scala/org/apache/samza/metrics/reporter/MetricsSnapshotReporter.scala", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxNzoxMzoxOVrOGbU-jA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxODozNTowMlrOGbYEwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTMwODQyOA==", "bodyText": "Unrelated to PR but useful: Can you change the info log below \"Blacklisted metric %s because it matched ...\" to either only be logged once with all metrics or logged at debug?", "url": "https://github.com/apache/samza/pull/1368#discussion_r431308428", "createdAt": "2020-05-27T17:13:19Z", "author": {"login": "prateekm"}, "path": "samza-core/src/main/scala/org/apache/samza/metrics/reporter/MetricsSnapshotReporter.scala", "diffHunk": "@@ -160,12 +171,9 @@ class MetricsSnapshotReporter(\n         }\n       }\n     }\n-\n-\n     debug(\"Finished flushing metrics.\")\n   }\n \n-", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c712ae0122c4bfb12ba81adee3e0ed5e7adf386"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTM1OTE3MA==", "bodyText": "Makes sense. Fixed the log level.", "url": "https://github.com/apache/samza/pull/1368#discussion_r431359170", "createdAt": "2020-05-27T18:35:02Z", "author": {"login": "abhishekshivanna"}, "path": "samza-core/src/main/scala/org/apache/samza/metrics/reporter/MetricsSnapshotReporter.scala", "diffHunk": "@@ -160,12 +171,9 @@ class MetricsSnapshotReporter(\n         }\n       }\n     }\n-\n-\n     debug(\"Finished flushing metrics.\")\n   }\n \n-", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTMwODQyOA=="}, "originalCommit": {"oid": "0c712ae0122c4bfb12ba81adee3e0ed5e7adf386"}, "originalPosition": 68}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4NzIyNzk3OnYy", "diffSide": "RIGHT", "path": "samza-core/src/main/scala/org/apache/samza/metrics/reporter/MetricsSnapshotReporterFactory.scala", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QyMTowMjo1MVrOGbdCCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwMDozODo0MVrOGbh3nQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ0MDM5Mg==", "bodyText": "why is this pollingInterval instead of reportingInterval? makes me think we poll for metrics at this interval but then the error statement above which says \"Error reporting ... pollingInterval\" is confusing.", "url": "https://github.com/apache/samza/pull/1368#discussion_r431440392", "createdAt": "2020-05-27T21:02:51Z", "author": {"login": "mynameborat"}, "path": "samza-core/src/main/scala/org/apache/samza/metrics/reporter/MetricsSnapshotReporterFactory.scala", "diffHunk": "@@ -77,15 +71,48 @@ class MetricsSnapshotReporterFactory extends MetricsReporterFactory with Logging\n     } else {\n       new MetricsSnapshotSerdeV2\n     }\n-\n     info(\"Got serde %s.\" format serde)\n+    serde\n+  }\n+\n \n-    val pollingInterval: Int = metricsConfig.getMetricsSnapshotReporterInterval(name)\n+  def getBlacklist(reporterName: String, config: Config): Option[String] = {\n+    val metricsConfig = new MetricsConfig(config)\n+    val blacklist = JavaOptionals.toRichOptional(metricsConfig.getMetricsSnapshotReporterBlacklist(reporterName)).toOption\n+    info(\"Got blacklist as: %s\" format blacklist)\n+    blacklist\n+  }\n \n-    info(\"Setting polling interval to %d\" format pollingInterval)\n+  def getPollingInterval(reporterName: String, config: Config): Int = {\n+    val metricsConfig = new MetricsConfig(config)\n+    val pollingInterval = metricsConfig.getMetricsSnapshotReporterInterval(reporterName)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5ae87bb7c2e8d52128583b9f390ce9062c738ee"}, "originalPosition": 99}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUxOTY0NQ==", "bodyText": "Good point! I'm not sure why this was called pollingInterval to begin with.\nFixed it.", "url": "https://github.com/apache/samza/pull/1368#discussion_r431519645", "createdAt": "2020-05-28T00:38:41Z", "author": {"login": "abhishekshivanna"}, "path": "samza-core/src/main/scala/org/apache/samza/metrics/reporter/MetricsSnapshotReporterFactory.scala", "diffHunk": "@@ -77,15 +71,48 @@ class MetricsSnapshotReporterFactory extends MetricsReporterFactory with Logging\n     } else {\n       new MetricsSnapshotSerdeV2\n     }\n-\n     info(\"Got serde %s.\" format serde)\n+    serde\n+  }\n+\n \n-    val pollingInterval: Int = metricsConfig.getMetricsSnapshotReporterInterval(name)\n+  def getBlacklist(reporterName: String, config: Config): Option[String] = {\n+    val metricsConfig = new MetricsConfig(config)\n+    val blacklist = JavaOptionals.toRichOptional(metricsConfig.getMetricsSnapshotReporterBlacklist(reporterName)).toOption\n+    info(\"Got blacklist as: %s\" format blacklist)\n+    blacklist\n+  }\n \n-    info(\"Setting polling interval to %d\" format pollingInterval)\n+  def getPollingInterval(reporterName: String, config: Config): Int = {\n+    val metricsConfig = new MetricsConfig(config)\n+    val pollingInterval = metricsConfig.getMetricsSnapshotReporterInterval(reporterName)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ0MDM5Mg=="}, "originalCommit": {"oid": "b5ae87bb7c2e8d52128583b9f390ce9062c738ee"}, "originalPosition": 99}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5NDMwNTgwOnYy", "diffSide": "RIGHT", "path": "samza-core/src/main/scala/org/apache/samza/metrics/reporter/MetricsSnapshotReporterFactory.scala", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxNjowMDowOFrOGcizNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxNzoxOToxOFrOGclhew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjU4MzQ3OQ==", "bodyText": "private ?", "url": "https://github.com/apache/samza/pull/1368#discussion_r432583479", "createdAt": "2020-05-29T16:00:08Z", "author": {"login": "rmatharu"}, "path": "samza-core/src/main/scala/org/apache/samza/metrics/reporter/MetricsSnapshotReporterFactory.scala", "diffHunk": "@@ -19,53 +19,47 @@\n \n package org.apache.samza.metrics.reporter\n \n-import org.apache.samza.util.{Logging, ReflectionUtil, StreamUtil, Util}\n import org.apache.samza.SamzaException\n-import org.apache.samza.config.{Config, JobConfig, MetricsConfig, SerializerConfig, StreamConfig, SystemConfig}\n-import org.apache.samza.metrics.MetricsReporter\n-import org.apache.samza.metrics.MetricsReporterFactory\n-import org.apache.samza.metrics.MetricsRegistryMap\n-import org.apache.samza.serializers.{MetricsSnapshotSerdeV2, SerdeFactory}\n-import org.apache.samza.system.SystemFactory\n+import org.apache.samza.config._\n+import org.apache.samza.metrics.{MetricsRegistryMap, MetricsReporter, MetricsReporterFactory}\n+import org.apache.samza.serializers.{MetricsSnapshotSerdeV2, Serde, SerdeFactory}\n+import org.apache.samza.system.{SystemFactory, SystemProducer, SystemStream}\n import org.apache.samza.util.ScalaJavaUtil.JavaOptionals\n+import org.apache.samza.util.{Logging, ReflectionUtil, StreamUtil, Util}\n \n class MetricsSnapshotReporterFactory extends MetricsReporterFactory with Logging {\n-  def getMetricsReporter(name: String, containerName: String, config: Config): MetricsReporter = {\n-    info(\"Creating new metrics snapshot reporter.\")\n-\n-    val jobConfig = new JobConfig(config)\n-    val jobName = JavaOptionals.toRichOptional(jobConfig.getName).toOption\n-      .getOrElse(throw new SamzaException(\"Job name must be defined in config.\"))\n-    val jobId = jobConfig.getJobId\n-\n-    val metricsConfig = new MetricsConfig(config)\n-    val metricsSystemStreamName = JavaOptionals.toRichOptional(metricsConfig.getMetricsSnapshotReporterStream(name))\n-      .toOption\n-      .getOrElse(throw new SamzaException(\"No metrics stream defined in config.\"))\n-\n-    val systemStream = StreamUtil.getSystemStreamFromNames(metricsSystemStreamName)\n-\n-    info(\"Got system stream %s.\" format systemStream)\n-\n-    val systemName = systemStream.getSystem\n \n+  def getProducer(reporterName: String, config: Config, registry: MetricsRegistryMap): SystemProducer = {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "071b0456a53f1ebdc6e729d7d89e45ef158e33d4"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjYyODA5MQ==", "bodyText": "This kinda relates to @bharathkk comment - where we need to share this producer externally in DiagnosticsUtil. See changes in https://github.com/apache/samza/pull/1369/files\nDo you think if we had two separate producers for DiagnosticsManager and MetricsSnapshotReporter would pose a problem?", "url": "https://github.com/apache/samza/pull/1368#discussion_r432628091", "createdAt": "2020-05-29T17:19:18Z", "author": {"login": "abhishekshivanna"}, "path": "samza-core/src/main/scala/org/apache/samza/metrics/reporter/MetricsSnapshotReporterFactory.scala", "diffHunk": "@@ -19,53 +19,47 @@\n \n package org.apache.samza.metrics.reporter\n \n-import org.apache.samza.util.{Logging, ReflectionUtil, StreamUtil, Util}\n import org.apache.samza.SamzaException\n-import org.apache.samza.config.{Config, JobConfig, MetricsConfig, SerializerConfig, StreamConfig, SystemConfig}\n-import org.apache.samza.metrics.MetricsReporter\n-import org.apache.samza.metrics.MetricsReporterFactory\n-import org.apache.samza.metrics.MetricsRegistryMap\n-import org.apache.samza.serializers.{MetricsSnapshotSerdeV2, SerdeFactory}\n-import org.apache.samza.system.SystemFactory\n+import org.apache.samza.config._\n+import org.apache.samza.metrics.{MetricsRegistryMap, MetricsReporter, MetricsReporterFactory}\n+import org.apache.samza.serializers.{MetricsSnapshotSerdeV2, Serde, SerdeFactory}\n+import org.apache.samza.system.{SystemFactory, SystemProducer, SystemStream}\n import org.apache.samza.util.ScalaJavaUtil.JavaOptionals\n+import org.apache.samza.util.{Logging, ReflectionUtil, StreamUtil, Util}\n \n class MetricsSnapshotReporterFactory extends MetricsReporterFactory with Logging {\n-  def getMetricsReporter(name: String, containerName: String, config: Config): MetricsReporter = {\n-    info(\"Creating new metrics snapshot reporter.\")\n-\n-    val jobConfig = new JobConfig(config)\n-    val jobName = JavaOptionals.toRichOptional(jobConfig.getName).toOption\n-      .getOrElse(throw new SamzaException(\"Job name must be defined in config.\"))\n-    val jobId = jobConfig.getJobId\n-\n-    val metricsConfig = new MetricsConfig(config)\n-    val metricsSystemStreamName = JavaOptionals.toRichOptional(metricsConfig.getMetricsSnapshotReporterStream(name))\n-      .toOption\n-      .getOrElse(throw new SamzaException(\"No metrics stream defined in config.\"))\n-\n-    val systemStream = StreamUtil.getSystemStreamFromNames(metricsSystemStreamName)\n-\n-    info(\"Got system stream %s.\" format systemStream)\n-\n-    val systemName = systemStream.getSystem\n \n+  def getProducer(reporterName: String, config: Config, registry: MetricsRegistryMap): SystemProducer = {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjU4MzQ3OQ=="}, "originalCommit": {"oid": "071b0456a53f1ebdc6e729d7d89e45ef158e33d4"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5NDMwNjQ0OnYy", "diffSide": "RIGHT", "path": "samza-core/src/main/scala/org/apache/samza/metrics/reporter/MetricsSnapshotReporterFactory.scala", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxNjowMDoxN1rOGcizog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxNzozMDo1OFrOGcl6bQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjU4MzU4Ng==", "bodyText": "private ?\nsame for all the other helper methods below that are invoked only from within this class.", "url": "https://github.com/apache/samza/pull/1368#discussion_r432583586", "createdAt": "2020-05-29T16:00:17Z", "author": {"login": "rmatharu"}, "path": "samza-core/src/main/scala/org/apache/samza/metrics/reporter/MetricsSnapshotReporterFactory.scala", "diffHunk": "@@ -19,53 +19,47 @@\n \n package org.apache.samza.metrics.reporter\n \n-import org.apache.samza.util.{Logging, ReflectionUtil, StreamUtil, Util}\n import org.apache.samza.SamzaException\n-import org.apache.samza.config.{Config, JobConfig, MetricsConfig, SerializerConfig, StreamConfig, SystemConfig}\n-import org.apache.samza.metrics.MetricsReporter\n-import org.apache.samza.metrics.MetricsReporterFactory\n-import org.apache.samza.metrics.MetricsRegistryMap\n-import org.apache.samza.serializers.{MetricsSnapshotSerdeV2, SerdeFactory}\n-import org.apache.samza.system.SystemFactory\n+import org.apache.samza.config._\n+import org.apache.samza.metrics.{MetricsRegistryMap, MetricsReporter, MetricsReporterFactory}\n+import org.apache.samza.serializers.{MetricsSnapshotSerdeV2, Serde, SerdeFactory}\n+import org.apache.samza.system.{SystemFactory, SystemProducer, SystemStream}\n import org.apache.samza.util.ScalaJavaUtil.JavaOptionals\n+import org.apache.samza.util.{Logging, ReflectionUtil, StreamUtil, Util}\n \n class MetricsSnapshotReporterFactory extends MetricsReporterFactory with Logging {\n-  def getMetricsReporter(name: String, containerName: String, config: Config): MetricsReporter = {\n-    info(\"Creating new metrics snapshot reporter.\")\n-\n-    val jobConfig = new JobConfig(config)\n-    val jobName = JavaOptionals.toRichOptional(jobConfig.getName).toOption\n-      .getOrElse(throw new SamzaException(\"Job name must be defined in config.\"))\n-    val jobId = jobConfig.getJobId\n-\n-    val metricsConfig = new MetricsConfig(config)\n-    val metricsSystemStreamName = JavaOptionals.toRichOptional(metricsConfig.getMetricsSnapshotReporterStream(name))\n-      .toOption\n-      .getOrElse(throw new SamzaException(\"No metrics stream defined in config.\"))\n-\n-    val systemStream = StreamUtil.getSystemStreamFromNames(metricsSystemStreamName)\n-\n-    info(\"Got system stream %s.\" format systemStream)\n-\n-    val systemName = systemStream.getSystem\n \n+  def getProducer(reporterName: String, config: Config, registry: MetricsRegistryMap): SystemProducer = {\n     val systemConfig = new SystemConfig(config)\n+    val systemName = getSystemStream(reporterName, config).getSystem\n     val systemFactoryClassName = JavaOptionals.toRichOptional(systemConfig.getSystemFactory(systemName)).toOption\n       .getOrElse(throw new SamzaException(\"Trying to fetch system factory for system %s, which isn't defined in config.\" format systemName))\n-\n     val systemFactory = ReflectionUtil.getObj(systemFactoryClassName, classOf[SystemFactory])\n \n     info(\"Got system factory %s.\" format systemFactory)\n+    val producer = systemFactory.getProducer(systemName, config, registry)\n+    info(\"Got producer %s.\" format producer)\n \n-    val registry = new MetricsRegistryMap\n+    producer\n+  }\n \n-    val producer = systemFactory.getProducer(systemName, config, registry)\n+  def getSystemStream(reporterName: String, config: Config): SystemStream = {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "071b0456a53f1ebdc6e729d7d89e45ef158e33d4"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjYzNDQ3Nw==", "bodyText": "Agreed! Except for the shared producer (discussion on this thread above) changed all these methods to be protected so custom factories that extend from this class, don't have to duplicate code.", "url": "https://github.com/apache/samza/pull/1368#discussion_r432634477", "createdAt": "2020-05-29T17:30:58Z", "author": {"login": "abhishekshivanna"}, "path": "samza-core/src/main/scala/org/apache/samza/metrics/reporter/MetricsSnapshotReporterFactory.scala", "diffHunk": "@@ -19,53 +19,47 @@\n \n package org.apache.samza.metrics.reporter\n \n-import org.apache.samza.util.{Logging, ReflectionUtil, StreamUtil, Util}\n import org.apache.samza.SamzaException\n-import org.apache.samza.config.{Config, JobConfig, MetricsConfig, SerializerConfig, StreamConfig, SystemConfig}\n-import org.apache.samza.metrics.MetricsReporter\n-import org.apache.samza.metrics.MetricsReporterFactory\n-import org.apache.samza.metrics.MetricsRegistryMap\n-import org.apache.samza.serializers.{MetricsSnapshotSerdeV2, SerdeFactory}\n-import org.apache.samza.system.SystemFactory\n+import org.apache.samza.config._\n+import org.apache.samza.metrics.{MetricsRegistryMap, MetricsReporter, MetricsReporterFactory}\n+import org.apache.samza.serializers.{MetricsSnapshotSerdeV2, Serde, SerdeFactory}\n+import org.apache.samza.system.{SystemFactory, SystemProducer, SystemStream}\n import org.apache.samza.util.ScalaJavaUtil.JavaOptionals\n+import org.apache.samza.util.{Logging, ReflectionUtil, StreamUtil, Util}\n \n class MetricsSnapshotReporterFactory extends MetricsReporterFactory with Logging {\n-  def getMetricsReporter(name: String, containerName: String, config: Config): MetricsReporter = {\n-    info(\"Creating new metrics snapshot reporter.\")\n-\n-    val jobConfig = new JobConfig(config)\n-    val jobName = JavaOptionals.toRichOptional(jobConfig.getName).toOption\n-      .getOrElse(throw new SamzaException(\"Job name must be defined in config.\"))\n-    val jobId = jobConfig.getJobId\n-\n-    val metricsConfig = new MetricsConfig(config)\n-    val metricsSystemStreamName = JavaOptionals.toRichOptional(metricsConfig.getMetricsSnapshotReporterStream(name))\n-      .toOption\n-      .getOrElse(throw new SamzaException(\"No metrics stream defined in config.\"))\n-\n-    val systemStream = StreamUtil.getSystemStreamFromNames(metricsSystemStreamName)\n-\n-    info(\"Got system stream %s.\" format systemStream)\n-\n-    val systemName = systemStream.getSystem\n \n+  def getProducer(reporterName: String, config: Config, registry: MetricsRegistryMap): SystemProducer = {\n     val systemConfig = new SystemConfig(config)\n+    val systemName = getSystemStream(reporterName, config).getSystem\n     val systemFactoryClassName = JavaOptionals.toRichOptional(systemConfig.getSystemFactory(systemName)).toOption\n       .getOrElse(throw new SamzaException(\"Trying to fetch system factory for system %s, which isn't defined in config.\" format systemName))\n-\n     val systemFactory = ReflectionUtil.getObj(systemFactoryClassName, classOf[SystemFactory])\n \n     info(\"Got system factory %s.\" format systemFactory)\n+    val producer = systemFactory.getProducer(systemName, config, registry)\n+    info(\"Got producer %s.\" format producer)\n \n-    val registry = new MetricsRegistryMap\n+    producer\n+  }\n \n-    val producer = systemFactory.getProducer(systemName, config, registry)\n+  def getSystemStream(reporterName: String, config: Config): SystemStream = {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjU4MzU4Ng=="}, "originalCommit": {"oid": "071b0456a53f1ebdc6e729d7d89e45ef158e33d4"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5NDMxMTIwOnYy", "diffSide": "RIGHT", "path": "samza-core/src/main/scala/org/apache/samza/metrics/reporter/MetricsSnapshotReporterFactory.scala", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxNjowMTozOVrOGci2wQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxNzoyNToxM1rOGcltjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjU4NDM4NQ==", "bodyText": "nit: For the things are just methods in jobConfig perhaps separate helper-methods are an overkill?", "url": "https://github.com/apache/samza/pull/1368#discussion_r432584385", "createdAt": "2020-05-29T16:01:39Z", "author": {"login": "rmatharu"}, "path": "samza-core/src/main/scala/org/apache/samza/metrics/reporter/MetricsSnapshotReporterFactory.scala", "diffHunk": "@@ -77,29 +71,62 @@ class MetricsSnapshotReporterFactory extends MetricsReporterFactory with Logging\n     } else {\n       new MetricsSnapshotSerdeV2\n     }\n-\n     info(\"Got serde %s.\" format serde)\n+    serde\n+  }\n+\n \n-    val pollingInterval: Int = metricsConfig.getMetricsSnapshotReporterInterval(name)\n+  def getBlacklist(reporterName: String, config: Config): Option[String] = {\n+    val metricsConfig = new MetricsConfig(config)\n+    val blacklist = JavaOptionals.toRichOptional(metricsConfig.getMetricsSnapshotReporterBlacklist(reporterName)).toOption\n+    info(\"Got blacklist as: %s\" format blacklist)\n+    blacklist\n+  }\n \n-    info(\"Setting polling interval to %d\" format pollingInterval)\n+  def getReportingInterval(reporterName: String, config: Config): Int = {\n+    val metricsConfig = new MetricsConfig(config)\n+    val reportingInterval = metricsConfig.getMetricsSnapshotReporterInterval(reporterName)\n+    info(\"Got reporting interval: %d\" format reportingInterval)\n+    reportingInterval\n+  }\n+\n+  def getJobId(config: Config): String = {\n+    val jobConfig = new JobConfig(config)\n+    jobConfig.getJobId\n+  }\n+\n+  def getJobName(config: Config): String = {\n+    val jobConfig = new JobConfig(config)\n+    JavaOptionals.toRichOptional(jobConfig.getName).toOption\n+      .getOrElse(throw new SamzaException(\"Job name must be defined in config.\"))\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "071b0456a53f1ebdc6e729d7d89e45ef158e33d4"}, "originalPosition": 113}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjYzMTE4Mg==", "bodyText": "I feel it helps read the code better. Since this is not a frequently executed code path it should be fine to trade-off readability for a stack that is one level deeper.", "url": "https://github.com/apache/samza/pull/1368#discussion_r432631182", "createdAt": "2020-05-29T17:25:13Z", "author": {"login": "abhishekshivanna"}, "path": "samza-core/src/main/scala/org/apache/samza/metrics/reporter/MetricsSnapshotReporterFactory.scala", "diffHunk": "@@ -77,29 +71,62 @@ class MetricsSnapshotReporterFactory extends MetricsReporterFactory with Logging\n     } else {\n       new MetricsSnapshotSerdeV2\n     }\n-\n     info(\"Got serde %s.\" format serde)\n+    serde\n+  }\n+\n \n-    val pollingInterval: Int = metricsConfig.getMetricsSnapshotReporterInterval(name)\n+  def getBlacklist(reporterName: String, config: Config): Option[String] = {\n+    val metricsConfig = new MetricsConfig(config)\n+    val blacklist = JavaOptionals.toRichOptional(metricsConfig.getMetricsSnapshotReporterBlacklist(reporterName)).toOption\n+    info(\"Got blacklist as: %s\" format blacklist)\n+    blacklist\n+  }\n \n-    info(\"Setting polling interval to %d\" format pollingInterval)\n+  def getReportingInterval(reporterName: String, config: Config): Int = {\n+    val metricsConfig = new MetricsConfig(config)\n+    val reportingInterval = metricsConfig.getMetricsSnapshotReporterInterval(reporterName)\n+    info(\"Got reporting interval: %d\" format reportingInterval)\n+    reportingInterval\n+  }\n+\n+  def getJobId(config: Config): String = {\n+    val jobConfig = new JobConfig(config)\n+    jobConfig.getJobId\n+  }\n+\n+  def getJobName(config: Config): String = {\n+    val jobConfig = new JobConfig(config)\n+    JavaOptionals.toRichOptional(jobConfig.getName).toOption\n+      .getOrElse(throw new SamzaException(\"Job name must be defined in config.\"))\n+  }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjU4NDM4NQ=="}, "originalCommit": {"oid": "071b0456a53f1ebdc6e729d7d89e45ef158e33d4"}, "originalPosition": 113}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5NDMyODgyOnYy", "diffSide": "RIGHT", "path": "samza-core/src/main/scala/org/apache/samza/metrics/reporter/MetricsSnapshotReporter.scala", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxNjowNjo0MFrOGcjCLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQyMDoxMDo1OVrOGcqqRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjU4NzMwOQ==", "bodyText": "Do you think it'd be possible to add a test to test the emission logic in TestMetricsSnapshotReporter?\nSomehow it was overlooked before.", "url": "https://github.com/apache/samza/pull/1368#discussion_r432587309", "createdAt": "2020-05-29T16:06:40Z", "author": {"login": "rmatharu"}, "path": "samza-core/src/main/scala/org/apache/samza/metrics/reporter/MetricsSnapshotReporter.scala", "diffHunk": "@@ -106,9 +106,20 @@ class MetricsSnapshotReporter(\n     }\n   }\n \n-  def run {\n-    debug(\"Begin flushing metrics.\")\n+  def run() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "071b0456a53f1ebdc6e729d7d89e45ef158e33d4"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjcxMjI2MA==", "bodyText": "Done", "url": "https://github.com/apache/samza/pull/1368#discussion_r432712260", "createdAt": "2020-05-29T20:10:59Z", "author": {"login": "abhishekshivanna"}, "path": "samza-core/src/main/scala/org/apache/samza/metrics/reporter/MetricsSnapshotReporter.scala", "diffHunk": "@@ -106,9 +106,20 @@ class MetricsSnapshotReporter(\n     }\n   }\n \n-  def run {\n-    debug(\"Begin flushing metrics.\")\n+  def run() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjU4NzMwOQ=="}, "originalCommit": {"oid": "071b0456a53f1ebdc6e729d7d89e45ef158e33d4"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNzk2MjgxOnYy", "diffSide": "RIGHT", "path": "samza-core/src/test/java/org/apache/samza/metrics/TestMetricsSnapshotReporter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNzoyNDo1M1rOGemCeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNzoyNDo1M1rOGemCeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDczMzY4OQ==", "bodyText": "can we use explicit exports instead of wildcards?", "url": "https://github.com/apache/samza/pull/1368#discussion_r434733689", "createdAt": "2020-06-03T17:24:53Z", "author": {"login": "mynameborat"}, "path": "samza-core/src/test/java/org/apache/samza/metrics/TestMetricsSnapshotReporter.java", "diffHunk": "@@ -19,23 +19,51 @@\n \n package org.apache.samza.metrics;\n \n+import java.util.List;\n+import java.util.Map;\n+import org.apache.samza.metrics.reporter.MetricsSnapshot;\n import org.apache.samza.metrics.reporter.MetricsSnapshotReporter;\n import org.apache.samza.serializers.MetricsSnapshotSerdeV2;\n+import org.apache.samza.serializers.Serializer;\n+import org.apache.samza.system.OutgoingMessageEnvelope;\n+import org.apache.samza.system.SystemProducer;\n import org.apache.samza.system.SystemStream;\n-import org.apache.samza.system.inmemory.InMemorySystemProducer;\n import org.junit.Assert;\n+import org.junit.Before;\n import org.junit.Test;\n+import org.mockito.ArgumentCaptor;\n import scala.Some;\n import scala.runtime.AbstractFunction0;\n \n+import static org.mockito.Mockito.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a5e68853b934cee9aac461734d4bf26e34e5bc54"}, "originalPosition": 21}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1437, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}