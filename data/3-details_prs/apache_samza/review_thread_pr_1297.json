{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgxNTExOTI5", "number": 1297, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMDozMjoyNlrODlMV7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxNzo0NDo1NVrODl4pYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMzI2MTI0OnYy", "diffSide": "RIGHT", "path": "samza-core/src/test/java/org/apache/samza/clustermanager/MockClusterResourceManager.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMDozMjoyNlrOFx8nrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxODoyMjo1NVrOFz0O5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkxNzc0MA==", "bodyText": "Is this required only for testing?", "url": "https://github.com/apache/samza/pull/1297#discussion_r387917740", "createdAt": "2020-03-04T20:32:26Z", "author": {"login": "rmatharu"}, "path": "samza-core/src/test/java/org/apache/samza/clustermanager/MockClusterResourceManager.java", "diffHunk": "@@ -102,12 +102,17 @@ public void launchStreamProcessor(SamzaResource resource, CommandBuilder builder\n \n   @Override\n   public void stopStreamProcessor(SamzaResource resource) {\n-    SamzaResourceStatus status = new SamzaResourceStatus(resource.getContainerId(), \"diagnostics\", SamzaResourceStatus.PREEMPTED);\n+    stopStreamProcessor(resource, SamzaResourceStatus.PREEMPTED);\n+  }\n+\n+  void stopStreamProcessor(SamzaResource resource, int exitCode) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "087a20f160e7f411b1bfa7a138e0b58f60875a8f"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU5Njg4Mg==", "bodyText": "yes", "url": "https://github.com/apache/samza/pull/1297#discussion_r388596882", "createdAt": "2020-03-05T22:10:25Z", "author": {"login": "Sanil15"}, "path": "samza-core/src/test/java/org/apache/samza/clustermanager/MockClusterResourceManager.java", "diffHunk": "@@ -102,12 +102,17 @@ public void launchStreamProcessor(SamzaResource resource, CommandBuilder builder\n \n   @Override\n   public void stopStreamProcessor(SamzaResource resource) {\n-    SamzaResourceStatus status = new SamzaResourceStatus(resource.getContainerId(), \"diagnostics\", SamzaResourceStatus.PREEMPTED);\n+    stopStreamProcessor(resource, SamzaResourceStatus.PREEMPTED);\n+  }\n+\n+  void stopStreamProcessor(SamzaResource resource, int exitCode) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkxNzc0MA=="}, "originalCommit": {"oid": "087a20f160e7f411b1bfa7a138e0b58f60875a8f"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTA0MTQyNA==", "bodyText": "Maybe @visible for testing or\n// package private for testing?", "url": "https://github.com/apache/samza/pull/1297#discussion_r389041424", "createdAt": "2020-03-06T17:31:02Z", "author": {"login": "rmatharu"}, "path": "samza-core/src/test/java/org/apache/samza/clustermanager/MockClusterResourceManager.java", "diffHunk": "@@ -102,12 +102,17 @@ public void launchStreamProcessor(SamzaResource resource, CommandBuilder builder\n \n   @Override\n   public void stopStreamProcessor(SamzaResource resource) {\n-    SamzaResourceStatus status = new SamzaResourceStatus(resource.getContainerId(), \"diagnostics\", SamzaResourceStatus.PREEMPTED);\n+    stopStreamProcessor(resource, SamzaResourceStatus.PREEMPTED);\n+  }\n+\n+  void stopStreamProcessor(SamzaResource resource, int exitCode) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkxNzc0MA=="}, "originalCommit": {"oid": "087a20f160e7f411b1bfa7a138e0b58f60875a8f"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg3NzQ3OA==", "bodyText": "this class is a Mock itself but sure Ill add it", "url": "https://github.com/apache/samza/pull/1297#discussion_r389877478", "createdAt": "2020-03-09T18:22:55Z", "author": {"login": "Sanil15"}, "path": "samza-core/src/test/java/org/apache/samza/clustermanager/MockClusterResourceManager.java", "diffHunk": "@@ -102,12 +102,17 @@ public void launchStreamProcessor(SamzaResource resource, CommandBuilder builder\n \n   @Override\n   public void stopStreamProcessor(SamzaResource resource) {\n-    SamzaResourceStatus status = new SamzaResourceStatus(resource.getContainerId(), \"diagnostics\", SamzaResourceStatus.PREEMPTED);\n+    stopStreamProcessor(resource, SamzaResourceStatus.PREEMPTED);\n+  }\n+\n+  void stopStreamProcessor(SamzaResource resource, int exitCode) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkxNzc0MA=="}, "originalCommit": {"oid": "087a20f160e7f411b1bfa7a138e0b58f60875a8f"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMzI5NzgzOnYy", "diffSide": "RIGHT", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ContainerManager.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMDo0NDoyNVrOFx89xg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxODoyMDozN1rOFz0KBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkyMzM5OA==", "bodyText": "CPM does a similar thing at\nString lastSeenOn = state.jobModelManager.jobModel().getContainerToHostValue(processorId, SetContainerHostMapping.HOST_KEY);\n\nIs it possible to consolidate these multiple job-model-manager accesses?\nmaybe call it just getHostForContainer?", "url": "https://github.com/apache/samza/pull/1297#discussion_r387923398", "createdAt": "2020-03-04T20:44:25Z", "author": {"login": "rmatharu"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ContainerManager.java", "diffHunk": "@@ -429,6 +429,25 @@ private void writeContainerPlacementResponseMessage(ContainerPlacementRequestMes\n             responseMessage, System.currentTimeMillis()));\n   }\n \n+  /**\n+   * Gets the hostname on which container is either currently running or was last seen on if it is not running\n+   */\n+  private String getSourceHostForContainer(ContainerPlacementRequestMessage requestMessage) {\n+    String sourceHost = null;\n+    String processorId = requestMessage.getProcessorId();\n+    if (samzaApplicationState.runningProcessors.containsKey(processorId)) {\n+      SamzaResource currentResource = samzaApplicationState.runningProcessors.get(processorId);\n+      LOG.info(\"Processor ID: {} matched a running container with containerId ID: {} is running on host: {} for ContainerPlacement action: {}\",\n+          processorId, currentResource.getContainerId(), currentResource.getHost(), requestMessage);\n+      sourceHost = currentResource.getHost();\n+    } else {\n+      sourceHost = samzaApplicationState.jobModelManager.jobModel().getContainerToHostValue(processorId, SetContainerHostMapping.HOST_KEY);\n+      LOG.info(\"Processor ID: {} is not running and was last seen on host: {} for ContainerPlacement action: {}\",\n+          processorId, sourceHost, requestMessage);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "087a20f160e7f411b1bfa7a138e0b58f60875a8f"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYwMTc3Nw==", "bodyText": "Yes it is possible, one last part left in CPM refactor is moving onResourcesCompleted logic to container manager, let's do this as a part of that logic", "url": "https://github.com/apache/samza/pull/1297#discussion_r388601777", "createdAt": "2020-03-05T22:22:09Z", "author": {"login": "Sanil15"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ContainerManager.java", "diffHunk": "@@ -429,6 +429,25 @@ private void writeContainerPlacementResponseMessage(ContainerPlacementRequestMes\n             responseMessage, System.currentTimeMillis()));\n   }\n \n+  /**\n+   * Gets the hostname on which container is either currently running or was last seen on if it is not running\n+   */\n+  private String getSourceHostForContainer(ContainerPlacementRequestMessage requestMessage) {\n+    String sourceHost = null;\n+    String processorId = requestMessage.getProcessorId();\n+    if (samzaApplicationState.runningProcessors.containsKey(processorId)) {\n+      SamzaResource currentResource = samzaApplicationState.runningProcessors.get(processorId);\n+      LOG.info(\"Processor ID: {} matched a running container with containerId ID: {} is running on host: {} for ContainerPlacement action: {}\",\n+          processorId, currentResource.getContainerId(), currentResource.getHost(), requestMessage);\n+      sourceHost = currentResource.getHost();\n+    } else {\n+      sourceHost = samzaApplicationState.jobModelManager.jobModel().getContainerToHostValue(processorId, SetContainerHostMapping.HOST_KEY);\n+      LOG.info(\"Processor ID: {} is not running and was last seen on host: {} for ContainerPlacement action: {}\",\n+          processorId, sourceHost, requestMessage);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkyMzM5OA=="}, "originalCommit": {"oid": "087a20f160e7f411b1bfa7a138e0b58f60875a8f"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTAzMjM4MQ==", "bodyText": "maybe link jira for that here?", "url": "https://github.com/apache/samza/pull/1297#discussion_r389032381", "createdAt": "2020-03-06T17:13:29Z", "author": {"login": "rmatharu"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ContainerManager.java", "diffHunk": "@@ -429,6 +429,25 @@ private void writeContainerPlacementResponseMessage(ContainerPlacementRequestMes\n             responseMessage, System.currentTimeMillis()));\n   }\n \n+  /**\n+   * Gets the hostname on which container is either currently running or was last seen on if it is not running\n+   */\n+  private String getSourceHostForContainer(ContainerPlacementRequestMessage requestMessage) {\n+    String sourceHost = null;\n+    String processorId = requestMessage.getProcessorId();\n+    if (samzaApplicationState.runningProcessors.containsKey(processorId)) {\n+      SamzaResource currentResource = samzaApplicationState.runningProcessors.get(processorId);\n+      LOG.info(\"Processor ID: {} matched a running container with containerId ID: {} is running on host: {} for ContainerPlacement action: {}\",\n+          processorId, currentResource.getContainerId(), currentResource.getHost(), requestMessage);\n+      sourceHost = currentResource.getHost();\n+    } else {\n+      sourceHost = samzaApplicationState.jobModelManager.jobModel().getContainerToHostValue(processorId, SetContainerHostMapping.HOST_KEY);\n+      LOG.info(\"Processor ID: {} is not running and was last seen on host: {} for ContainerPlacement action: {}\",\n+          processorId, sourceHost, requestMessage);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkyMzM5OA=="}, "originalCommit": {"oid": "087a20f160e7f411b1bfa7a138e0b58f60875a8f"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg3NjIyOQ==", "bodyText": "sure", "url": "https://github.com/apache/samza/pull/1297#discussion_r389876229", "createdAt": "2020-03-09T18:20:37Z", "author": {"login": "Sanil15"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ContainerManager.java", "diffHunk": "@@ -429,6 +429,25 @@ private void writeContainerPlacementResponseMessage(ContainerPlacementRequestMes\n             responseMessage, System.currentTimeMillis()));\n   }\n \n+  /**\n+   * Gets the hostname on which container is either currently running or was last seen on if it is not running\n+   */\n+  private String getSourceHostForContainer(ContainerPlacementRequestMessage requestMessage) {\n+    String sourceHost = null;\n+    String processorId = requestMessage.getProcessorId();\n+    if (samzaApplicationState.runningProcessors.containsKey(processorId)) {\n+      SamzaResource currentResource = samzaApplicationState.runningProcessors.get(processorId);\n+      LOG.info(\"Processor ID: {} matched a running container with containerId ID: {} is running on host: {} for ContainerPlacement action: {}\",\n+          processorId, currentResource.getContainerId(), currentResource.getHost(), requestMessage);\n+      sourceHost = currentResource.getHost();\n+    } else {\n+      sourceHost = samzaApplicationState.jobModelManager.jobModel().getContainerToHostValue(processorId, SetContainerHostMapping.HOST_KEY);\n+      LOG.info(\"Processor ID: {} is not running and was last seen on host: {} for ContainerPlacement action: {}\",\n+          processorId, sourceHost, requestMessage);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkyMzM5OA=="}, "originalCommit": {"oid": "087a20f160e7f411b1bfa7a138e0b58f60875a8f"}, "originalPosition": 68}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMzMwMzMxOnYy", "diffSide": "RIGHT", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ContainerManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMDo0NjoxM1rOFx9BLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMjoxNzowMlrOFymPzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkyNDI3MA==", "bodyText": "Log statements needed?", "url": "https://github.com/apache/samza/pull/1297#discussion_r387924270", "createdAt": "2020-03-04T20:46:13Z", "author": {"login": "rmatharu"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ContainerManager.java", "diffHunk": "@@ -443,6 +462,11 @@ private boolean deQueueAction(ContainerPlacementRequestMessage requestMessage) {\n     if (checkIfActiveOrStandbyContainerHasActivePlacementAction(requestMessage)) {\n       return false;\n     }\n+\n+    if (samzaApplicationState.failedProcessors.containsKey(requestMessage.getProcessorId())) {\n+      return true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "087a20f160e7f411b1bfa7a138e0b58f60875a8f"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU5OTc1OA==", "bodyText": "I can add one but the de-queuing is already logged at the caller", "url": "https://github.com/apache/samza/pull/1297#discussion_r388599758", "createdAt": "2020-03-05T22:17:02Z", "author": {"login": "Sanil15"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ContainerManager.java", "diffHunk": "@@ -443,6 +462,11 @@ private boolean deQueueAction(ContainerPlacementRequestMessage requestMessage) {\n     if (checkIfActiveOrStandbyContainerHasActivePlacementAction(requestMessage)) {\n       return false;\n     }\n+\n+    if (samzaApplicationState.failedProcessors.containsKey(requestMessage.getProcessorId())) {\n+      return true;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkyNDI3MA=="}, "originalCommit": {"oid": "087a20f160e7f411b1bfa7a138e0b58f60875a8f"}, "originalPosition": 82}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMzMwNzU2OnYy", "diffSide": "RIGHT", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ContainerManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMDo0Nzo0NVrOFx9EDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMjowNzozOVrOFyl_qw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkyNTAwNQ==", "bodyText": "To make this readable, maybe define variables for each of the lookups and\ndefine the if to be\nif (inRunning || inPending || inFailed) {//do blah}\nelse {\nthis\n}", "url": "https://github.com/apache/samza/pull/1297#discussion_r387925005", "createdAt": "2020-03-04T20:47:45Z", "author": {"login": "rmatharu"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ContainerManager.java", "diffHunk": "@@ -464,7 +488,8 @@ private boolean deQueueAction(ContainerPlacementRequestMessage requestMessage) {\n     Boolean invalidAction = false;\n     String errorMessage = null;\n     if (!samzaApplicationState.runningProcessors.containsKey(requestMessage.getProcessorId()) &&\n-        !samzaApplicationState.pendingProcessors.containsKey(requestMessage.getProcessorId())\n+        !samzaApplicationState.pendingProcessors.containsKey(requestMessage.getProcessorId()) &&\n+        !samzaApplicationState.failedProcessors.containsKey(requestMessage.getProcessorId())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "087a20f160e7f411b1bfa7a138e0b58f60875a8f"}, "originalPosition": 94}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU5NTYyNw==", "bodyText": "sure", "url": "https://github.com/apache/samza/pull/1297#discussion_r388595627", "createdAt": "2020-03-05T22:07:39Z", "author": {"login": "Sanil15"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ContainerManager.java", "diffHunk": "@@ -464,7 +488,8 @@ private boolean deQueueAction(ContainerPlacementRequestMessage requestMessage) {\n     Boolean invalidAction = false;\n     String errorMessage = null;\n     if (!samzaApplicationState.runningProcessors.containsKey(requestMessage.getProcessorId()) &&\n-        !samzaApplicationState.pendingProcessors.containsKey(requestMessage.getProcessorId())\n+        !samzaApplicationState.pendingProcessors.containsKey(requestMessage.getProcessorId()) &&\n+        !samzaApplicationState.failedProcessors.containsKey(requestMessage.getProcessorId())", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkyNTAwNQ=="}, "originalCommit": {"oid": "087a20f160e7f411b1bfa7a138e0b58f60875a8f"}, "originalPosition": 94}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMzMxMzc1OnYy", "diffSide": "RIGHT", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/SamzaApplicationState.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMDo0OTo0N1rOFx9H6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxODoyMTo1OVrOFz0M7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkyNTk5NQ==", "bodyText": "This class already has a map called\n/**\n   * ContainerStatuses of failed containers.\t   * ContainerStatuses of failed containers.\n   */\t \n  public final ConcurrentMap<String, SamzaResourceStatus> failedContainersStatus = new ConcurrentHashMap<>();\t \n\nCould we please reuse that?\nAlso the variable type can just be a Map<,> doesnt need to be ConcurrentHashMap", "url": "https://github.com/apache/samza/pull/1297#discussion_r387925995", "createdAt": "2020-03-04T20:49:47Z", "author": {"login": "rmatharu"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/SamzaApplicationState.java", "diffHunk": "@@ -110,7 +110,17 @@\n    */\n   public final ConcurrentMap<String, SamzaResource> runningProcessors = new ConcurrentHashMap<>(0);\n \n-   /**\n+  /**\n+   *  Map of the failed Samza processor ID to resource status of the last attempted of the container.\n+   *  This map is only used when {@link org.apache.samza.config.ClusterManagerConfig#CLUSTER_MANAGER_CONTAINER_FAIL_JOB_AFTER_RETRIES}\n+   *  is set to false, this map tracks the containers which have exhausted all retires for restart and JobCoordinator is\n+   *  no longer attempting to restart this container\n+   *\n+   *  Modified by both the AMRMCallbackThread and the ContainerAllocator thread\n+   */\n+  public final ConcurrentHashMap<String, SamzaResourceStatus> failedProcessors = new ConcurrentHashMap<>(0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "087a20f160e7f411b1bfa7a138e0b58f60875a8f"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU5NTU2Nw==", "bodyText": "good catch, it was there but was only populated by onResourceCompletedWithUnknownStatus and not used anywhere else, we do not need it I will remove that one", "url": "https://github.com/apache/samza/pull/1297#discussion_r388595567", "createdAt": "2020-03-05T22:07:32Z", "author": {"login": "Sanil15"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/SamzaApplicationState.java", "diffHunk": "@@ -110,7 +110,17 @@\n    */\n   public final ConcurrentMap<String, SamzaResource> runningProcessors = new ConcurrentHashMap<>(0);\n \n-   /**\n+  /**\n+   *  Map of the failed Samza processor ID to resource status of the last attempted of the container.\n+   *  This map is only used when {@link org.apache.samza.config.ClusterManagerConfig#CLUSTER_MANAGER_CONTAINER_FAIL_JOB_AFTER_RETRIES}\n+   *  is set to false, this map tracks the containers which have exhausted all retires for restart and JobCoordinator is\n+   *  no longer attempting to restart this container\n+   *\n+   *  Modified by both the AMRMCallbackThread and the ContainerAllocator thread\n+   */\n+  public final ConcurrentHashMap<String, SamzaResourceStatus> failedProcessors = new ConcurrentHashMap<>(0);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkyNTk5NQ=="}, "originalCommit": {"oid": "087a20f160e7f411b1bfa7a138e0b58f60875a8f"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTA0MDg2NA==", "bodyText": "As long as we use one of the two.\nIts also used by YarnClusterResourceManager for updating \"completed\" containers,\nwhich are containers that exit after finishing gracefully.", "url": "https://github.com/apache/samza/pull/1297#discussion_r389040864", "createdAt": "2020-03-06T17:29:55Z", "author": {"login": "rmatharu"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/SamzaApplicationState.java", "diffHunk": "@@ -110,7 +110,17 @@\n    */\n   public final ConcurrentMap<String, SamzaResource> runningProcessors = new ConcurrentHashMap<>(0);\n \n-   /**\n+  /**\n+   *  Map of the failed Samza processor ID to resource status of the last attempted of the container.\n+   *  This map is only used when {@link org.apache.samza.config.ClusterManagerConfig#CLUSTER_MANAGER_CONTAINER_FAIL_JOB_AFTER_RETRIES}\n+   *  is set to false, this map tracks the containers which have exhausted all retires for restart and JobCoordinator is\n+   *  no longer attempting to restart this container\n+   *\n+   *  Modified by both the AMRMCallbackThread and the ContainerAllocator thread\n+   */\n+  public final ConcurrentHashMap<String, SamzaResourceStatus> failedProcessors = new ConcurrentHashMap<>(0);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkyNTk5NQ=="}, "originalCommit": {"oid": "087a20f160e7f411b1bfa7a138e0b58f60875a8f"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg3Njk3Mw==", "bodyText": "thats YarnAppState not SamzaApplicationState", "url": "https://github.com/apache/samza/pull/1297#discussion_r389876973", "createdAt": "2020-03-09T18:21:59Z", "author": {"login": "Sanil15"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/SamzaApplicationState.java", "diffHunk": "@@ -110,7 +110,17 @@\n    */\n   public final ConcurrentMap<String, SamzaResource> runningProcessors = new ConcurrentHashMap<>(0);\n \n-   /**\n+  /**\n+   *  Map of the failed Samza processor ID to resource status of the last attempted of the container.\n+   *  This map is only used when {@link org.apache.samza.config.ClusterManagerConfig#CLUSTER_MANAGER_CONTAINER_FAIL_JOB_AFTER_RETRIES}\n+   *  is set to false, this map tracks the containers which have exhausted all retires for restart and JobCoordinator is\n+   *  no longer attempting to restart this container\n+   *\n+   *  Modified by both the AMRMCallbackThread and the ContainerAllocator thread\n+   */\n+  public final ConcurrentHashMap<String, SamzaResourceStatus> failedProcessors = new ConcurrentHashMap<>(0);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkyNTk5NQ=="}, "originalCommit": {"oid": "087a20f160e7f411b1bfa7a138e0b58f60875a8f"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMDQxNzgzOnYy", "diffSide": "RIGHT", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ContainerManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxNzoxNDozMVrOFzAr1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxNzoxNDozMVrOFzAr1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTAzMjkxOQ==", "bodyText": "\"neither in running, pending or failed state\"", "url": "https://github.com/apache/samza/pull/1297#discussion_r389032919", "createdAt": "2020-03-06T17:14:31Z", "author": {"login": "rmatharu"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ContainerManager.java", "diffHunk": "@@ -486,9 +512,12 @@ private boolean deQueueAction(ContainerPlacementRequestMessage requestMessage) {\n     String errorMessagePrefix = ContainerPlacementMessage.StatusCode.BAD_REQUEST + \" reason: %s\";\n     Boolean invalidAction = false;\n     String errorMessage = null;\n-    if (!samzaApplicationState.runningProcessors.containsKey(requestMessage.getProcessorId()) &&\n-        !samzaApplicationState.pendingProcessors.containsKey(requestMessage.getProcessorId())\n-    ) {\n+\n+    boolean isRunning = samzaApplicationState.runningProcessors.containsKey(requestMessage.getProcessorId());\n+    boolean isPending = samzaApplicationState.pendingProcessors.containsKey(requestMessage.getProcessorId());\n+    boolean isFailed = samzaApplicationState.failedProcessors.containsKey(requestMessage.getProcessorId());\n+\n+    if (!isRunning && !isPending && !isFailed) {\n       errorMessage = String.format(errorMessagePrefix, \"invalid processor id neither in running or pending processors\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "acb86bc5982afcda840137fb5030a4821bb55ea8"}, "originalPosition": 103}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMDUyMDAxOnYy", "diffSide": "RIGHT", "path": "samza-core/src/test/java/org/apache/samza/clustermanager/TestContainerPlacementActions.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxNzo0NDo1NVrOFzBqOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxODoyOToyOFrOFz0ckA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTA0ODg4OA==", "bodyText": "This test is littered with thread.sleep and timeouts -- a typical recipe for flaky jarvis/test, and increasing build times.\nWould it be possible to reduce/consolidate them?", "url": "https://github.com/apache/samza/pull/1297#discussion_r389048888", "createdAt": "2020-03-06T17:44:55Z", "author": {"login": "rmatharu"}, "path": "samza-core/src/test/java/org/apache/samza/clustermanager/TestContainerPlacementActions.java", "diffHunk": "@@ -528,6 +528,124 @@ public Void answer(InvocationOnMock invocation) {\n     assertFalse(containerPlacementMetadataStore.readContainerPlacementRequestMessage(requestMessage.getUuid()).isPresent());\n   }\n \n+\n+  @Test(timeout = 20000)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "acb86bc5982afcda840137fb5030a4821bb55ea8"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg3OTAyMw==", "bodyText": "I have used semaphores where it was easy to inject (awaiting container launch), this timeout configured on tests is generous enough, each callback spawns a different thread to mimic AMRMClientAsync behavior, so if I were to do all of these with using semaphores instead of thread.sleep for state change, I would need some significant refactors", "url": "https://github.com/apache/samza/pull/1297#discussion_r389879023", "createdAt": "2020-03-09T18:25:51Z", "author": {"login": "Sanil15"}, "path": "samza-core/src/test/java/org/apache/samza/clustermanager/TestContainerPlacementActions.java", "diffHunk": "@@ -528,6 +528,124 @@ public Void answer(InvocationOnMock invocation) {\n     assertFalse(containerPlacementMetadataStore.readContainerPlacementRequestMessage(requestMessage.getUuid()).isPresent());\n   }\n \n+\n+  @Test(timeout = 20000)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTA0ODg4OA=="}, "originalCommit": {"oid": "acb86bc5982afcda840137fb5030a4821bb55ea8"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg4MDk3Ng==", "bodyText": "These are integ tests and it takes 35 seconds to run all of them serially, we can also make them run in parallel to further reduce build times", "url": "https://github.com/apache/samza/pull/1297#discussion_r389880976", "createdAt": "2020-03-09T18:29:28Z", "author": {"login": "Sanil15"}, "path": "samza-core/src/test/java/org/apache/samza/clustermanager/TestContainerPlacementActions.java", "diffHunk": "@@ -528,6 +528,124 @@ public Void answer(InvocationOnMock invocation) {\n     assertFalse(containerPlacementMetadataStore.readContainerPlacementRequestMessage(requestMessage.getUuid()).isPresent());\n   }\n \n+\n+  @Test(timeout = 20000)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTA0ODg4OA=="}, "originalCommit": {"oid": "acb86bc5982afcda840137fb5030a4821bb55ea8"}, "originalPosition": 23}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1589, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}