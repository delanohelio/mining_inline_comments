{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYxNTc5MzM5", "number": 1247, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQwMDozNjoyNFrODXs4ew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxODoyMTowOVrODYRLbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2MTc5MTk1OnYy", "diffSide": "RIGHT", "path": "samza-core/src/main/java/org/apache/samza/runtime/RemoteApplicationRunner.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQwMDozNjoyNFrOFdJE3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQwMDo0MDowN1rOFdJIjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjEwMTcyNg==", "bodyText": "Would it be helpful to create a ticket for this cleanup work (for all changes related to the SEP) so we don't lose track of it?", "url": "https://github.com/apache/samza/pull/1247#discussion_r366101726", "createdAt": "2020-01-14T00:36:24Z", "author": {"login": "bkonold"}, "path": "samza-core/src/main/java/org/apache/samza/runtime/RemoteApplicationRunner.java", "diffHunk": "@@ -57,13 +55,21 @@\n    * @param config configuration for the application\n    */\n   public RemoteApplicationRunner(SamzaApplication app, Config config) {\n-    this.appDesc = ApplicationDescriptorUtil.getAppDescriptor(app, config);\n-    this.planner = new RemoteJobPlanner(appDesc);\n+    this.app = app;\n+    this.config = config;\n   }\n \n   @Override\n   public void run(ExternalContext externalContext) {\n+    if (new JobConfig(config).getConfigLoaderFactory().isPresent()) {\n+      JobRunner runner = new JobRunner(config);\n+      runner.submit();\n+      return;\n+    }\n+\n+    // TODO: Clean this up once SAMZA-2405 is completed when legacy flow is removed.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4105111a81a0921ccccf61598eba3589f7b23d60"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjEwMjY3MQ==", "bodyText": "Good point, I will create a ticket for it.", "url": "https://github.com/apache/samza/pull/1247#discussion_r366102671", "createdAt": "2020-01-14T00:40:07Z", "author": {"login": "kw2542"}, "path": "samza-core/src/main/java/org/apache/samza/runtime/RemoteApplicationRunner.java", "diffHunk": "@@ -57,13 +55,21 @@\n    * @param config configuration for the application\n    */\n   public RemoteApplicationRunner(SamzaApplication app, Config config) {\n-    this.appDesc = ApplicationDescriptorUtil.getAppDescriptor(app, config);\n-    this.planner = new RemoteJobPlanner(appDesc);\n+    this.app = app;\n+    this.config = config;\n   }\n \n   @Override\n   public void run(ExternalContext externalContext) {\n+    if (new JobConfig(config).getConfigLoaderFactory().isPresent()) {\n+      JobRunner runner = new JobRunner(config);\n+      runner.submit();\n+      return;\n+    }\n+\n+    // TODO: Clean this up once SAMZA-2405 is completed when legacy flow is removed.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjEwMTcyNg=="}, "originalCommit": {"oid": "4105111a81a0921ccccf61598eba3589f7b23d60"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2NTA4NzIwOnYy", "diffSide": "RIGHT", "path": "samza-core/src/test/java/org/apache/samza/runtime/TestRemoteApplicationRunner.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQyMjo1OTo0MVrOFdok7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQyMjoxMzoyMFrOFeIJLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYxNzgzOQ==", "bodyText": "Hmm. I guess the code as-is isn't very unit test friendly. It would be nice to test the invocation of .submit vs .run on JobRunner depending on the presence of the ConfigLoaderFactory.\nMaybe we could factor out the JobRunner creation into its own method, and use a spy to stub out the return value of that method to be a mock JobRunner that we can verify? Disclaimer though, I'm not sure what the best practices are of using spies...", "url": "https://github.com/apache/samza/pull/1247#discussion_r366617839", "createdAt": "2020-01-14T22:59:41Z", "author": {"login": "bkonold"}, "path": "samza-core/src/test/java/org/apache/samza/runtime/TestRemoteApplicationRunner.java", "diffHunk": "@@ -75,9 +75,20 @@ public void testWaitForFinishTimesout() {\n     assertFalse(\"Application finished before the timeout.\", finished);\n   }\n \n+  @Test\n+  public void testRunWithConfigLoaderFactoryPresent() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f864b2f87dc3a364e5344340b6768de942fc9ea"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYyNDA4MA==", "bodyText": "Haha, I figured that too. In general, I prefer not to mess with production code for the sake of unit tests.\nThe current unit actually test the new flow, I passed null SamzaApplication to RemoteApplicationRunner's constructor. In RemoteApplicationRunner#run, if it goes the legacy flow, it will throw exception when constructing RemoteJobPlanner where SamzaApplication is required. Do you think this is enough?", "url": "https://github.com/apache/samza/pull/1247#discussion_r366624080", "createdAt": "2020-01-14T23:18:51Z", "author": {"login": "kw2542"}, "path": "samza-core/src/test/java/org/apache/samza/runtime/TestRemoteApplicationRunner.java", "diffHunk": "@@ -75,9 +75,20 @@ public void testWaitForFinishTimesout() {\n     assertFalse(\"Application finished before the timeout.\", finished);\n   }\n \n+  @Test\n+  public void testRunWithConfigLoaderFactoryPresent() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYxNzgzOQ=="}, "originalCommit": {"oid": "4f864b2f87dc3a364e5344340b6768de942fc9ea"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjY0NjYwMg==", "bodyText": "There is some precedence elsewhere in samza code; ZkJobCoordinator.readJobModelFromMetadataStore for example uses a similar method structure + spy in unit test.\nYou are correct that the test written now does ensure that the legacy flow isn't triggered, but it does little to verify the behavior of the new flow. I won't block the PR on this though.", "url": "https://github.com/apache/samza/pull/1247#discussion_r366646602", "createdAt": "2020-01-15T00:42:46Z", "author": {"login": "bkonold"}, "path": "samza-core/src/test/java/org/apache/samza/runtime/TestRemoteApplicationRunner.java", "diffHunk": "@@ -75,9 +75,20 @@ public void testWaitForFinishTimesout() {\n     assertFalse(\"Application finished before the timeout.\", finished);\n   }\n \n+  @Test\n+  public void testRunWithConfigLoaderFactoryPresent() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYxNzgzOQ=="}, "originalCommit": {"oid": "4f864b2f87dc3a364e5344340b6768de942fc9ea"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzEzNTAyMw==", "bodyText": "+1 that there is a bit of missing test coverage here. It would be nice if this class was set up better for improved testing, but I also won't block the PR on this.", "url": "https://github.com/apache/samza/pull/1247#discussion_r367135023", "createdAt": "2020-01-15T22:13:20Z", "author": {"login": "cameronlee314"}, "path": "samza-core/src/test/java/org/apache/samza/runtime/TestRemoteApplicationRunner.java", "diffHunk": "@@ -75,9 +75,20 @@ public void testWaitForFinishTimesout() {\n     assertFalse(\"Application finished before the timeout.\", finished);\n   }\n \n+  @Test\n+  public void testRunWithConfigLoaderFactoryPresent() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYxNzgzOQ=="}, "originalCommit": {"oid": "4f864b2f87dc3a364e5344340b6768de942fc9ea"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2NzczODcxOnYy", "diffSide": "RIGHT", "path": "samza-core/src/main/java/org/apache/samza/runtime/RemoteApplicationRunner.java", "isResolved": true, "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxODoyMTowOVrOFeB5rQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQyMTo1MTo0OFrOFeHnFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzAzMjc0OQ==", "bodyText": "This is a question for kill, status, and waitForFinish:\nShould you be calling JobPlanner.generateSingleJobConfig even when config loader factory is specified? It seems like you would want to call JobRunner, similar to how you changed it for run.", "url": "https://github.com/apache/samza/pull/1247#discussion_r367032749", "createdAt": "2020-01-15T18:21:09Z", "author": {"login": "cameronlee314"}, "path": "samza-core/src/main/java/org/apache/samza/runtime/RemoteApplicationRunner.java", "diffHunk": "@@ -85,7 +91,7 @@ public void kill() {\n     // since currently we only support single actual remote job, we can get its status without\n     // building the execution plan.\n     try {\n-      JobConfig jc = new JobConfig(JobPlanner.generateSingleJobConfig(appDesc.getConfig()));\n+      JobConfig jc = new JobConfig(JobPlanner.generateSingleJobConfig(config));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "077d4d22063bb6623c3f376a09a28613c3c60fa1"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA5MjQwNA==", "bodyText": "JobPlanner.generateSingleJobConfig is a util method which overrides job.name and job.id based on app.name and app.id, which I suppose is safe to keep.\nkill, status and waitForFinish are still using calling JobRunner.", "url": "https://github.com/apache/samza/pull/1247#discussion_r367092404", "createdAt": "2020-01-15T20:32:15Z", "author": {"login": "kw2542"}, "path": "samza-core/src/main/java/org/apache/samza/runtime/RemoteApplicationRunner.java", "diffHunk": "@@ -85,7 +91,7 @@ public void kill() {\n     // since currently we only support single actual remote job, we can get its status without\n     // building the execution plan.\n     try {\n-      JobConfig jc = new JobConfig(JobPlanner.generateSingleJobConfig(appDesc.getConfig()));\n+      JobConfig jc = new JobConfig(JobPlanner.generateSingleJobConfig(config));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzAzMjc0OQ=="}, "originalCommit": {"oid": "077d4d22063bb6623c3f376a09a28613c3c60fa1"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzExMjM1MA==", "bodyText": "But in run, you don't call JobPlanner.generateSingleJobConfig. For consistency, it seems like you should call generateSingleJobConfig for all cases or for no cases.", "url": "https://github.com/apache/samza/pull/1247#discussion_r367112350", "createdAt": "2020-01-15T21:19:02Z", "author": {"login": "cameronlee314"}, "path": "samza-core/src/main/java/org/apache/samza/runtime/RemoteApplicationRunner.java", "diffHunk": "@@ -85,7 +91,7 @@ public void kill() {\n     // since currently we only support single actual remote job, we can get its status without\n     // building the execution plan.\n     try {\n-      JobConfig jc = new JobConfig(JobPlanner.generateSingleJobConfig(appDesc.getConfig()));\n+      JobConfig jc = new JobConfig(JobPlanner.generateSingleJobConfig(config));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzAzMjc0OQ=="}, "originalCommit": {"oid": "077d4d22063bb6623c3f376a09a28613c3c60fa1"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzExOTM5Ng==", "bodyText": "Got you, JobPlanner.generateSingleJobConfig is not being used in run() but it is used in ExecutionPlanner. I will update the code.", "url": "https://github.com/apache/samza/pull/1247#discussion_r367119396", "createdAt": "2020-01-15T21:35:36Z", "author": {"login": "kw2542"}, "path": "samza-core/src/main/java/org/apache/samza/runtime/RemoteApplicationRunner.java", "diffHunk": "@@ -85,7 +91,7 @@ public void kill() {\n     // since currently we only support single actual remote job, we can get its status without\n     // building the execution plan.\n     try {\n-      JobConfig jc = new JobConfig(JobPlanner.generateSingleJobConfig(appDesc.getConfig()));\n+      JobConfig jc = new JobConfig(JobPlanner.generateSingleJobConfig(config));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzAzMjc0OQ=="}, "originalCommit": {"oid": "077d4d22063bb6623c3f376a09a28613c3c60fa1"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzEyNDM5Nw==", "bodyText": "It looks like ExecutionPlanner.createJobGraph (part of planning) uses JobPlanner.generateSingleJobConfig, so it looks like JobPlanner.generateSingleJobConfig is used in run in the legacy path. Can you please check if I am reading the code correctly here?", "url": "https://github.com/apache/samza/pull/1247#discussion_r367124397", "createdAt": "2020-01-15T21:47:22Z", "author": {"login": "cameronlee314"}, "path": "samza-core/src/main/java/org/apache/samza/runtime/RemoteApplicationRunner.java", "diffHunk": "@@ -85,7 +91,7 @@ public void kill() {\n     // since currently we only support single actual remote job, we can get its status without\n     // building the execution plan.\n     try {\n-      JobConfig jc = new JobConfig(JobPlanner.generateSingleJobConfig(appDesc.getConfig()));\n+      JobConfig jc = new JobConfig(JobPlanner.generateSingleJobConfig(config));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzAzMjc0OQ=="}, "originalCommit": {"oid": "077d4d22063bb6623c3f376a09a28613c3c60fa1"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzEyNjIxMA==", "bodyText": "Updated.", "url": "https://github.com/apache/samza/pull/1247#discussion_r367126210", "createdAt": "2020-01-15T21:51:38Z", "author": {"login": "kw2542"}, "path": "samza-core/src/main/java/org/apache/samza/runtime/RemoteApplicationRunner.java", "diffHunk": "@@ -85,7 +91,7 @@ public void kill() {\n     // since currently we only support single actual remote job, we can get its status without\n     // building the execution plan.\n     try {\n-      JobConfig jc = new JobConfig(JobPlanner.generateSingleJobConfig(appDesc.getConfig()));\n+      JobConfig jc = new JobConfig(JobPlanner.generateSingleJobConfig(config));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzAzMjc0OQ=="}, "originalCommit": {"oid": "077d4d22063bb6623c3f376a09a28613c3c60fa1"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzEyNjI5NQ==", "bodyText": "Thanks for pointing this out!", "url": "https://github.com/apache/samza/pull/1247#discussion_r367126295", "createdAt": "2020-01-15T21:51:48Z", "author": {"login": "kw2542"}, "path": "samza-core/src/main/java/org/apache/samza/runtime/RemoteApplicationRunner.java", "diffHunk": "@@ -85,7 +91,7 @@ public void kill() {\n     // since currently we only support single actual remote job, we can get its status without\n     // building the execution plan.\n     try {\n-      JobConfig jc = new JobConfig(JobPlanner.generateSingleJobConfig(appDesc.getConfig()));\n+      JobConfig jc = new JobConfig(JobPlanner.generateSingleJobConfig(config));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzAzMjc0OQ=="}, "originalCommit": {"oid": "077d4d22063bb6623c3f376a09a28613c3c60fa1"}, "originalPosition": 49}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1539, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}