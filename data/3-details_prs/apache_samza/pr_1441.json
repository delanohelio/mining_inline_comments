{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIxODQ0NTA2", "number": 1441, "title": "SAMZA-2601: avoid infinite loop on container allocation", "bodyText": "Problem: If YARN does not immediately allocate resources for a container and host affinity is disabled for the job, then the container allocator will spam the logs with messages about the request, even if the request is considered expired. This is because the allocator loops over the pending requests to check if they have been allocated, but there is no delay between loop iterations, so it might just keep checking the same pending request over and over as fast as possible. A metric is also incremented in this flow, so that metric is extremely high, which is probably not the intention.\nChanges: Avoid infinite loop by breaking the loop if host affinity is disabled\nTests: new unit test\nAPI changes: N/A\nUsage instructions: N/A\nUpgrade instructions: None", "createdAt": "2020-11-16T18:19:58Z", "url": "https://github.com/apache/samza/pull/1441", "merged": true, "mergeCommit": {"oid": "4ad502f67470c74c98be0c8f9a884a05ade28483"}, "closed": true, "closedAt": "2020-11-22T01:02:51Z", "author": {"login": "lhaiesp"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABddJKOOgH2gAyNTIxODQ0NTA2OjY2NjUwOThiMjViYWQ0MDYxMDgzZTU0OWNhNTdkNTU2ZWI1MTc4OGM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABde1vQggH2gAyNTIxODQ0NTA2OmE1ODEyNWJiNTcwNzE5OTZhNjk4MzcwZTI2MDQxOWEyYTQwM2QwZDQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6665098b25bad4061083e549ca57d556eb51788c", "author": {"user": {"login": "lhaiesp", "name": "Hai Lu"}}, "url": "https://github.com/apache/samza/commit/6665098b25bad4061083e549ca57d556eb51788c", "committedDate": "2020-11-16T18:21:21Z", "message": "SAMZA-2601: avoid infinite loop when resource not allocated with host affinity disabled"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eb218f4c6745ac960f696aef47a26cc0b58fffac", "author": {"user": {"login": "lhaiesp", "name": "Hai Lu"}}, "url": "https://github.com/apache/samza/commit/eb218f4c6745ac960f696aef47a26cc0b58fffac", "committedDate": "2020-11-16T18:16:03Z", "message": "SAMZA-2601: avoid infinite loop when resource not allocated with host affinity disabled"}, "afterCommit": {"oid": "6665098b25bad4061083e549ca57d556eb51788c", "author": {"user": {"login": "lhaiesp", "name": "Hai Lu"}}, "url": "https://github.com/apache/samza/commit/6665098b25bad4061083e549ca57d556eb51788c", "committedDate": "2020-11-16T18:21:21Z", "message": "SAMZA-2601: avoid infinite loop when resource not allocated with host affinity disabled"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1ODUxNzcy", "url": "https://github.com/apache/samza/pull/1441#pullrequestreview-535851772", "createdAt": "2020-11-21T00:06:11Z", "commit": {"oid": "6665098b25bad4061083e549ca57d556eb51788c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMVQwMDowNjoxMlrOH3kkNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMVQwMDowNjoxMlrOH3kkNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAzMjgyMQ==", "bodyText": "Replace it with something like this:\nLOG.info(\"Waiting for resources to get allocated for request {}, no retries will be issued since host affinity is disabled\", request);", "url": "https://github.com/apache/samza/pull/1441#discussion_r528032821", "createdAt": "2020-11-21T00:06:12Z", "author": {"login": "Sanil15"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ContainerAllocator.java", "diffHunk": "@@ -234,6 +234,12 @@ void assignResourceRequests() {\n         if (isRequestExpired(request)) {\n           updateExpiryMetrics(request);\n           containerManager.handleExpiredRequest(processorId, preferredHost, request, this, resourceRequestState);\n+          // SAMZA-2601: to prevent infinite looping and logs filling up the disk, when host affinity is disabled,\n+          // we explicitly break the loop here and the whole process gets retried in run() after allocatorSleepIntervalMs\n+          if (!hostAffinityEnabled) {\n+            LOG.info(\"Host affinity is disabled on expired request.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6665098b25bad4061083e549ca57d556eb51788c"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1ODUyMjI1", "url": "https://github.com/apache/samza/pull/1441#pullrequestreview-535852225", "createdAt": "2020-11-21T00:08:03Z", "commit": {"oid": "6665098b25bad4061083e549ca57d556eb51788c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a58125bb57071996a698370e260419a2a403d0d4", "author": {"user": {"login": "lhaiesp", "name": "Hai Lu"}}, "url": "https://github.com/apache/samza/commit/a58125bb57071996a698370e260419a2a403d0d4", "committedDate": "2020-11-22T00:51:33Z", "message": "update log messages based on feedback"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4734, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}