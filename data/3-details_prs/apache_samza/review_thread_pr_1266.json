{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcwNDg0NzIy", "number": 1266, "reviewThreads": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxODo0Mjo1NFrODdFhlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxOTo0OToyOVrODddedA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxODI1ODEzOnYy", "diffSide": "RIGHT", "path": "samza-core/src/main/java/org/apache/samza/config/ClusterManagerConfig.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxODo0Mjo1NFrOFlfMLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxODo0Mjo1NFrOFlfMLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg1MjY1NA==", "bodyText": "Should this use getAutosizingEnabled instead of checking the config directly? Then if getAutosizingEnabled gets changed in the future, this would not change.", "url": "https://github.com/apache/samza/pull/1266#discussion_r374852654", "createdAt": "2020-02-04T18:42:54Z", "author": {"login": "cameronlee314"}, "path": "samza-core/src/main/java/org/apache/samza/config/ClusterManagerConfig.java", "diffHunk": "@@ -143,8 +143,15 @@ public int getAllocatorSleepTime() {\n     }\n   }\n \n+  /**\n+   * Return the value of CLUSTER_MANAGER_MAX_CORES or CONTAINER_MAX_CPU_CORES (in that order) if autosizing is not enabled,\n+   * otherwise returns the value of JOB_AUTOSIZING_CONTAINER_MAX_CORES.\n+   * @return\n+   */\n   public int getNumCores() {\n-    if (containsKey(CLUSTER_MANAGER_MAX_CORES)) {\n+    if (getBoolean(JobConfig.JOB_AUTOSIZING_ENABLED, false) && containsKey(JobConfig.JOB_AUTOSIZING_CONTAINER_MAX_CORES)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02454631d2c544e7b1119146b81d3df1a6dbe57e"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxODI1ODkxOnYy", "diffSide": "RIGHT", "path": "samza-core/src/main/java/org/apache/samza/config/ClusterManagerConfig.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxODo0MzowOFrOFlfMoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxODo0MzowOFrOFlfMoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg1Mjc2OQ==", "bodyText": "Same about using getAutosizingEnabled", "url": "https://github.com/apache/samza/pull/1266#discussion_r374852769", "createdAt": "2020-02-04T18:43:08Z", "author": {"login": "cameronlee314"}, "path": "samza-core/src/main/java/org/apache/samza/config/ClusterManagerConfig.java", "diffHunk": "@@ -154,8 +161,15 @@ public int getNumCores() {\n     }\n   }\n \n+  /**\n+   * Return the value of CLUSTER_MANAGER_MEMORY_MB or CONTAINER_MAX_MEMORY_MB (in that order) if autosizing is not enabled,\n+   * otherwise returns the value of JOB_AUTOSIZING_CONTAINER_MEMORY_MB.\n+   * @return\n+   */\n   public int getContainerMemoryMb() {\n-    if (containsKey(CLUSTER_MANAGER_MEMORY_MB)) {\n+    if (getBoolean(JobConfig.JOB_AUTOSIZING_ENABLED, false) && containsKey(JobConfig.JOB_AUTOSIZING_CONTAINER_MEMORY_MB)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02454631d2c544e7b1119146b81d3df1a6dbe57e"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxODI2NzMxOnYy", "diffSide": "RIGHT", "path": "samza-core/src/main/java/org/apache/samza/config/JobConfig.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxODo0NTozNVrOFlfRxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxODo0NTozNVrOFlfRxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg1NDA4NQ==", "bodyText": "Could you please use autosizing instead of autoscaling to keep terminology consistent?", "url": "https://github.com/apache/samza/pull/1266#discussion_r374854085", "createdAt": "2020-02-04T18:45:35Z", "author": {"login": "cameronlee314"}, "path": "samza-core/src/main/java/org/apache/samza/config/JobConfig.java", "diffHunk": "@@ -165,9 +174,18 @@ public String getCoordinatorSystemNameOrNull() {\n     return Optional.ofNullable(get(JOB_DEFAULT_SYSTEM));\n   }\n \n+  /**\n+   * Return the value of JOB_CONTAINER_COUNT or \"yarn.container.count\" (in that order) if autosizing is not enabled,\n+   * otherwise returns the value of JOB_AUTOSIZING_CONTAINER_COUNT.\n+   * @return\n+   */\n   public int getContainerCount() {\n+    Optional<String> autoscalingContainerCountValue = Optional.ofNullable(get(JOB_AUTOSIZING_CONTAINER_COUNT));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02454631d2c544e7b1119146b81d3df1a6dbe57e"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxODI3MTEzOnYy", "diffSide": "RIGHT", "path": "samza-core/src/main/java/org/apache/samza/config/JobConfig.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxODo0NjozOFrOFlfUIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxODo0NjozOFrOFlfUIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg1NDY4OQ==", "bodyText": "Same about autosizing instead of autoscaling.", "url": "https://github.com/apache/samza/pull/1266#discussion_r374854689", "createdAt": "2020-02-04T18:46:38Z", "author": {"login": "cameronlee314"}, "path": "samza-core/src/main/java/org/apache/samza/config/JobConfig.java", "diffHunk": "@@ -286,8 +304,19 @@ public String getSSPMatcherConfigJobFactoryRegex() {\n     return get(SSP_MATCHER_CONFIG_JOB_FACTORY_REGEX, DEFAULT_SSP_MATCHER_CONFIG_JOB_FACTORY_REGEX);\n   }\n \n+  /**\n+   * Return the value of JOB_CONTAINER_THREAD_POOL_SIZE if autosizing is not enabled,\n+   * otherwise returns the value of JOB_AUTOSIZING_CONTAINER_THREAD_POOL_SIZE.\n+   * @return\n+   */\n   public int getThreadPoolSize() {\n-    return getInt(JOB_CONTAINER_THREAD_POOL_SIZE, 0);\n+    Optional<String> autoscalingContainerThreadPoolSize = Optional.ofNullable(get(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02454631d2c544e7b1119146b81d3df1a6dbe57e"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxODI5NjQ3OnYy", "diffSide": "RIGHT", "path": "samza-core/src/main/java/org/apache/samza/config/JobConfig.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxODo1NDozMlrOFlfkRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQyMjozNzo0OFrOFll84g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg1ODgyMg==", "bodyText": "If someone adds a new autosizing config, then it might not be obvious to remember to update this method, especially since it is a couple hundred lines away from the config key declaration.\nHere are a couple suggestions that might help:\n\nCreate a new enum class in which each autosizing config is a value in the enum. Then, you could use Enum.values() to create a set of autosizing configs. This is nice, because someone only needs to add the enum value, and then the code automatically picks it up.\nCreate a static Set of autosizing keys, and then declare that set as a static variable right next to where you declare the autosizing constants. There is still a chance of forgetting to update the set, but it's at least close in proximity to the declarations.\nChange the implementation of this method to check that the config key matches a prefix (e.g. job.autosizing). It's \"convention\"-y, but then no one will need to update this implementation as long as they follow the prefix pattern.", "url": "https://github.com/apache/samza/pull/1266#discussion_r374858822", "createdAt": "2020-02-04T18:54:32Z", "author": {"login": "cameronlee314"}, "path": "samza-core/src/main/java/org/apache/samza/config/JobConfig.java", "diffHunk": "@@ -310,6 +339,23 @@ public boolean getDiagnosticsEnabled() {\n     return getBoolean(JOB_DIAGNOSTICS_ENABLED, false);\n   }\n \n+  public boolean getAutosizingEnabled() {\n+    return getBoolean(JOB_AUTOSIZING_ENABLED, false);\n+  }\n+\n+  public boolean isAutosizingConfig(String configParam) {\n+    switch (configParam) {\n+      case JOB_AUTOSIZING_CONTAINER_COUNT:\n+      case JOB_AUTOSIZING_CONTAINER_MAX_CORES:\n+      case JOB_AUTOSIZING_CONTAINER_MAX_HEAP_MB:\n+      case JOB_AUTOSIZING_CONTAINER_MEMORY_MB:\n+      case JOB_AUTOSIZING_CONTAINER_THREAD_POOL_SIZE:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02454631d2c544e7b1119146b81d3df1a6dbe57e"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk2MzQyNg==", "bodyText": "Chose 3, and added comments and a config prefix variable.", "url": "https://github.com/apache/samza/pull/1266#discussion_r374963426", "createdAt": "2020-02-04T22:37:48Z", "author": {"login": "rmatharu"}, "path": "samza-core/src/main/java/org/apache/samza/config/JobConfig.java", "diffHunk": "@@ -310,6 +339,23 @@ public boolean getDiagnosticsEnabled() {\n     return getBoolean(JOB_DIAGNOSTICS_ENABLED, false);\n   }\n \n+  public boolean getAutosizingEnabled() {\n+    return getBoolean(JOB_AUTOSIZING_ENABLED, false);\n+  }\n+\n+  public boolean isAutosizingConfig(String configParam) {\n+    switch (configParam) {\n+      case JOB_AUTOSIZING_CONTAINER_COUNT:\n+      case JOB_AUTOSIZING_CONTAINER_MAX_CORES:\n+      case JOB_AUTOSIZING_CONTAINER_MAX_HEAP_MB:\n+      case JOB_AUTOSIZING_CONTAINER_MEMORY_MB:\n+      case JOB_AUTOSIZING_CONTAINER_THREAD_POOL_SIZE:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg1ODgyMg=="}, "originalCommit": {"oid": "02454631d2c544e7b1119146b81d3df1a6dbe57e"}, "originalPosition": 71}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxODM4MDMwOnYy", "diffSide": "RIGHT", "path": "samza-core/src/main/scala/org/apache/samza/util/CoordinatorStreamUtil.scala", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxOToyMDo0NVrOFlgYwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQyMjozNjoyN1rOFll6pA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg3MjI1Ng==", "bodyText": "Is there a case where you want to intentionally delete an autosizing config? For example, for cleaning up after getting a stable set of parameters.", "url": "https://github.com/apache/samza/pull/1266#discussion_r374872256", "createdAt": "2020-02-04T19:20:45Z", "author": {"login": "cameronlee314"}, "path": "samza-core/src/main/scala/org/apache/samza/util/CoordinatorStreamUtil.scala", "diffHunk": "@@ -163,7 +163,14 @@ object CoordinatorStreamUtil extends Logging {\n \n     val oldConfig = coordinatorSystemConsumer.getConfig\n     if (resetJobConfig) {\n-      val keysToRemove = oldConfig.keySet.asScala.toSet.diff(config.keySet.asScala)\n+      var keysToRemove = oldConfig.keySet.asScala.toSet.diff(config.keySet.asScala)\n+\n+      val jobConfig = new JobConfig(config)\n+      if (jobConfig.getAutosizingEnabled) {\n+        // If autosizing is enabled, we retain auto-sizing related configs\n+        keysToRemove = keysToRemove.filter(configKey => !jobConfig.isAutosizingConfig(configKey))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02454631d2c544e7b1119146b81d3df1a6dbe57e"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk2Mjg1Mg==", "bodyText": "The expectation there is that the user copies the internal config values to respective user configs (e.g., using a tool), and disables autosizing (which will delete these internal configs).", "url": "https://github.com/apache/samza/pull/1266#discussion_r374962852", "createdAt": "2020-02-04T22:36:27Z", "author": {"login": "rmatharu"}, "path": "samza-core/src/main/scala/org/apache/samza/util/CoordinatorStreamUtil.scala", "diffHunk": "@@ -163,7 +163,14 @@ object CoordinatorStreamUtil extends Logging {\n \n     val oldConfig = coordinatorSystemConsumer.getConfig\n     if (resetJobConfig) {\n-      val keysToRemove = oldConfig.keySet.asScala.toSet.diff(config.keySet.asScala)\n+      var keysToRemove = oldConfig.keySet.asScala.toSet.diff(config.keySet.asScala)\n+\n+      val jobConfig = new JobConfig(config)\n+      if (jobConfig.getAutosizingEnabled) {\n+        // If autosizing is enabled, we retain auto-sizing related configs\n+        keysToRemove = keysToRemove.filter(configKey => !jobConfig.isAutosizingConfig(configKey))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg3MjI1Ng=="}, "originalCommit": {"oid": "02454631d2c544e7b1119146b81d3df1a6dbe57e"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxODM5MDM0OnYy", "diffSide": "RIGHT", "path": "samza-core/src/main/scala/org/apache/samza/config/ShellCommandConfig.scala", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxOToyNDowMlrOFlgfQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxOToyNDowMlrOFlgfQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg3MzkyMw==", "bodyText": "Could you please add a unit test for this?", "url": "https://github.com/apache/samza/pull/1266#discussion_r374873923", "createdAt": "2020-02-04T19:24:02Z", "author": {"login": "cameronlee314"}, "path": "samza-core/src/main/scala/org/apache/samza/config/ShellCommandConfig.scala", "diffHunk": "@@ -116,7 +116,25 @@ object ShellCommandConfig {\n class ShellCommandConfig(config: Config) extends ScalaMapConfig(config) {\n   def getCommand = getOption(ShellCommandConfig.COMMAND_SHELL_EXECUTE).getOrElse(\"bin/run-container.sh\")\n \n-  def getTaskOpts = getOption(ShellCommandConfig.TASK_JVM_OPTS)\n+  def getTaskOpts = {\n+    var jvmOpts = getOption(ShellCommandConfig.TASK_JVM_OPTS)\n+    val jobConfig = new JobConfig(config)\n+\n+    if (jobConfig.getAutosizingEnabled && getOption(JobConfig.JOB_AUTOSIZING_CONTAINER_MAX_HEAP_MB).isDefined) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02454631d2c544e7b1119146b81d3df1a6dbe57e"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxODgyNjIyOnYy", "diffSide": "RIGHT", "path": "samza-core/src/main/java/org/apache/samza/config/JobConfig.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQyMTo1MTo1M1rOFlkvAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxOTo1MDoyOFrOFmFCjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk0MzQ5MQ==", "bodyText": "nit: typo tthat ake", "url": "https://github.com/apache/samza/pull/1266#discussion_r374943491", "createdAt": "2020-02-04T21:51:53Z", "author": {"login": "abhishekshivanna"}, "path": "samza-core/src/main/java/org/apache/samza/config/JobConfig.java", "diffHunk": "@@ -130,6 +130,15 @@\n   public static final String CONTAINER_METADATA_FILENAME_FORMAT = \"%s.metadata\"; // Filename: <containerID>.metadata\n   public static final String CONTAINER_METADATA_DIRECTORY_SYS_PROPERTY = \"samza.log.dir\";\n \n+  // Auto-sizing related configs tthat ake precedence over respective sizing confings job.container.count, etc,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02454631d2c544e7b1119146b81d3df1a6dbe57e"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQ3Mjc4MA==", "bodyText": "It looks like you still have a typo (\"that ake\") after your last change.", "url": "https://github.com/apache/samza/pull/1266#discussion_r375472780", "createdAt": "2020-02-05T19:50:28Z", "author": {"login": "cameronlee314"}, "path": "samza-core/src/main/java/org/apache/samza/config/JobConfig.java", "diffHunk": "@@ -130,6 +130,15 @@\n   public static final String CONTAINER_METADATA_FILENAME_FORMAT = \"%s.metadata\"; // Filename: <containerID>.metadata\n   public static final String CONTAINER_METADATA_DIRECTORY_SYS_PROPERTY = \"samza.log.dir\";\n \n+  // Auto-sizing related configs tthat ake precedence over respective sizing confings job.container.count, etc,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk0MzQ5MQ=="}, "originalCommit": {"oid": "02454631d2c544e7b1119146b81d3df1a6dbe57e"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxOTAwNjY3OnYy", "diffSide": "RIGHT", "path": "samza-core/src/test/java/org/apache/samza/config/TestJobConfig.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQyMjo1ODoxNFrOFlmdbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxOTo1Mjo0MVrOFmFG9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk3MTc1Nw==", "bodyText": "I think this section is the same as the block above. Seems like the code doesn't match the comment.", "url": "https://github.com/apache/samza/pull/1266#discussion_r374971757", "createdAt": "2020-02-04T22:58:14Z", "author": {"login": "cameronlee314"}, "path": "samza-core/src/test/java/org/apache/samza/config/TestJobConfig.java", "diffHunk": "@@ -608,4 +604,42 @@ public void testAutosizingConfig() {\n     Assert.assertEquals(900, clusterManagerConfig.getContainerMemoryMb());\n     Assert.assertEquals(2, clusterManagerConfig.getNumCores());\n   }\n+\n+  @Test\n+  public void testGetTaskOptsAutosizingDisabled() {\n+    ShellCommandConfig shellCommandConfig =\n+        new ShellCommandConfig(new MapConfig(ImmutableMap.of(JobConfig.JOB_AUTOSIZING_ENABLED, \"false\")));\n+    assertEquals(Option.empty(), shellCommandConfig.getTaskOpts());\n+\n+    String taskOpts = \"-Dproperty=value\";\n+    shellCommandConfig = new ShellCommandConfig(new MapConfig(\n+        ImmutableMap.of(ShellCommandConfig.TASK_JVM_OPTS(), taskOpts, JobConfig.JOB_AUTOSIZING_ENABLED, \"false\")));\n+    assertEquals(Option.apply(taskOpts), shellCommandConfig.getTaskOpts());\n+  }\n+\n+  @Test\n+  public void testGetTaskOptsAutosizingEnabled() {\n+    // opts not set, autosizing max heap not set\n+    ShellCommandConfig shellCommandConfig =\n+        new ShellCommandConfig(new MapConfig(ImmutableMap.of(JobConfig.JOB_AUTOSIZING_ENABLED, \"true\")));\n+    assertEquals(Option.empty(), shellCommandConfig.getTaskOpts());\n+\n+    // opts set, autosizing max heap not set\n+    String taskOpts = \"-Dproperty=value\";\n+    shellCommandConfig = new ShellCommandConfig(new MapConfig(\n+        ImmutableMap.of(ShellCommandConfig.TASK_JVM_OPTS(), taskOpts, JobConfig.JOB_AUTOSIZING_ENABLED, \"true\")));\n+    assertEquals(Option.apply(taskOpts), shellCommandConfig.getTaskOpts());\n+\n+    // opts not set, autosizing max heap set\n+    shellCommandConfig = new ShellCommandConfig(new MapConfig(\n+        ImmutableMap.of(JobConfig.JOB_AUTOSIZING_ENABLED, \"true\", JobConfig.JOB_AUTOSIZING_CONTAINER_MAX_HEAP_MB,\n+            \"1024\")));\n+    assertEquals(Option.apply(\"-Xmx1024m\"), shellCommandConfig.getTaskOpts());\n+\n+    // opts set without -Xmx, autosizing max heap set\n+    shellCommandConfig = new ShellCommandConfig(new MapConfig(\n+        ImmutableMap.of(JobConfig.JOB_AUTOSIZING_ENABLED, \"true\", JobConfig.JOB_AUTOSIZING_CONTAINER_MAX_HEAP_MB,\n+            \"1024\")));\n+    assertEquals(Option.apply(\"-Xmx1024m\"), shellCommandConfig.getTaskOpts());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "77b6b331e16408f6215a0c03a64a8128d040744c"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQ3MzkwOA==", "bodyText": "I saw your change, but I meant to refer to the lines immediately above this. I think this code block needs to be changed (not removed) to have a non-empty opts that doesn't have an -Xmx param.\nI would also suggest adding a test in which opts has -Xmx but needs to be replaced by the autosizing config.", "url": "https://github.com/apache/samza/pull/1266#discussion_r375473908", "createdAt": "2020-02-05T19:52:41Z", "author": {"login": "cameronlee314"}, "path": "samza-core/src/test/java/org/apache/samza/config/TestJobConfig.java", "diffHunk": "@@ -608,4 +604,42 @@ public void testAutosizingConfig() {\n     Assert.assertEquals(900, clusterManagerConfig.getContainerMemoryMb());\n     Assert.assertEquals(2, clusterManagerConfig.getNumCores());\n   }\n+\n+  @Test\n+  public void testGetTaskOptsAutosizingDisabled() {\n+    ShellCommandConfig shellCommandConfig =\n+        new ShellCommandConfig(new MapConfig(ImmutableMap.of(JobConfig.JOB_AUTOSIZING_ENABLED, \"false\")));\n+    assertEquals(Option.empty(), shellCommandConfig.getTaskOpts());\n+\n+    String taskOpts = \"-Dproperty=value\";\n+    shellCommandConfig = new ShellCommandConfig(new MapConfig(\n+        ImmutableMap.of(ShellCommandConfig.TASK_JVM_OPTS(), taskOpts, JobConfig.JOB_AUTOSIZING_ENABLED, \"false\")));\n+    assertEquals(Option.apply(taskOpts), shellCommandConfig.getTaskOpts());\n+  }\n+\n+  @Test\n+  public void testGetTaskOptsAutosizingEnabled() {\n+    // opts not set, autosizing max heap not set\n+    ShellCommandConfig shellCommandConfig =\n+        new ShellCommandConfig(new MapConfig(ImmutableMap.of(JobConfig.JOB_AUTOSIZING_ENABLED, \"true\")));\n+    assertEquals(Option.empty(), shellCommandConfig.getTaskOpts());\n+\n+    // opts set, autosizing max heap not set\n+    String taskOpts = \"-Dproperty=value\";\n+    shellCommandConfig = new ShellCommandConfig(new MapConfig(\n+        ImmutableMap.of(ShellCommandConfig.TASK_JVM_OPTS(), taskOpts, JobConfig.JOB_AUTOSIZING_ENABLED, \"true\")));\n+    assertEquals(Option.apply(taskOpts), shellCommandConfig.getTaskOpts());\n+\n+    // opts not set, autosizing max heap set\n+    shellCommandConfig = new ShellCommandConfig(new MapConfig(\n+        ImmutableMap.of(JobConfig.JOB_AUTOSIZING_ENABLED, \"true\", JobConfig.JOB_AUTOSIZING_CONTAINER_MAX_HEAP_MB,\n+            \"1024\")));\n+    assertEquals(Option.apply(\"-Xmx1024m\"), shellCommandConfig.getTaskOpts());\n+\n+    // opts set without -Xmx, autosizing max heap set\n+    shellCommandConfig = new ShellCommandConfig(new MapConfig(\n+        ImmutableMap.of(JobConfig.JOB_AUTOSIZING_ENABLED, \"true\", JobConfig.JOB_AUTOSIZING_CONTAINER_MAX_HEAP_MB,\n+            \"1024\")));\n+    assertEquals(Option.apply(\"-Xmx1024m\"), shellCommandConfig.getTaskOpts());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk3MTc1Nw=="}, "originalCommit": {"oid": "77b6b331e16408f6215a0c03a64a8128d040744c"}, "originalPosition": 73}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMyMjE4MjI4OnYy", "diffSide": "LEFT", "path": "samza-core/src/test/java/org/apache/samza/config/TestJobConfig.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxOTo0OToyOVrOFmFAyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxOTo0OToyOVrOFmFAyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQ3MjMzMQ==", "bodyText": "I don't think this should be removed. It is actually a different test case (i.e. autosizing is disabled).", "url": "https://github.com/apache/samza/pull/1266#discussion_r375472331", "createdAt": "2020-02-05T19:49:29Z", "author": {"login": "cameronlee314"}, "path": "samza-core/src/test/java/org/apache/samza/config/TestJobConfig.java", "diffHunk": "@@ -610,11 +610,6 @@ public void testGetTaskOptsAutosizingDisabled() {\n     ShellCommandConfig shellCommandConfig =\n         new ShellCommandConfig(new MapConfig(ImmutableMap.of(JobConfig.JOB_AUTOSIZING_ENABLED, \"false\")));\n     assertEquals(Option.empty(), shellCommandConfig.getTaskOpts());\n-\n-    String taskOpts = \"-Dproperty=value\";\n-    shellCommandConfig = new ShellCommandConfig(new MapConfig(\n-        ImmutableMap.of(ShellCommandConfig.TASK_JVM_OPTS(), taskOpts, JobConfig.JOB_AUTOSIZING_ENABLED, \"false\")));\n-    assertEquals(Option.apply(taskOpts), shellCommandConfig.getTaskOpts());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "972c8225c38dbf9f292078e0d1718990e01c6ee6"}, "originalPosition": 8}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1566, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}