{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUwNjg5NTI5", "number": 1401, "title": "SAMZA-2560: Generate SamzaSQLRelRecord using avro schema of input event instead of cached-schema.", "bodyText": "Symptom: Input messages consumed by the Samza SQL queries were incorrectly serialized.\nCause: Samza SQL engine uses AvroRelConverter to convert the input messages from Avro-type to SamzaSqlRelRecord before they're processed by the high-level operators in samza. Currently AvroRelConverter incorrectly converts the nested non-nullable unions in the input messages. If the schema of input event contains nested non-nullable union, then AvroRelConverter always produces null values for corresponding fields in resultant SamzaSQLRelRecord.  This problem happens since cached schema of input source is used to convert the input event to SamzaSqlRelRecord.\nChanges: Use the input event schema to convert the event to SamzaSqlRelRecord rather than using the cached-schema.\nAPI changes: None\nUpgrade Instructions: None\nUsage Instructions: None", "createdAt": "2020-07-17T02:23:54Z", "url": "https://github.com/apache/samza/pull/1401", "merged": true, "mergeCommit": {"oid": "0d8de7ab34de9c851d8bc32c57933d2550e26ecd"}, "closed": true, "closedAt": "2020-07-20T18:17:38Z", "author": {"login": "shanthoosh"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc1n8n7gH2gAyNDUwNjg5NTI5OjQxNDk4NTFmODM2ZTA5YzUyMWU0OWE3NjcwM2UzNWYyYzMwMzg1ZTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc214S3gFqTQ1MTg1MjY1OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4149851f836e09c521e49a76703e35f2c30385e0", "author": {"user": {"login": "shanthoosh", "name": null}}, "url": "https://github.com/apache/samza/commit/4149851f836e09c521e49a76703e35f2c30385e0", "committedDate": "2020-07-16T23:36:35Z", "message": "Generate SamzaSQLRelRecord using schema of input avro-record rather than the cached-schema."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0cc1f26349ac643c0dcbf36f953b9c2896a710f2", "author": {"user": {"login": "shanthoosh", "name": null}}, "url": "https://github.com/apache/samza/commit/0cc1f26349ac643c0dcbf36f953b9c2896a710f2", "committedDate": "2020-07-17T02:52:16Z", "message": "Fix checkstyle violations."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwMzY3OTIy", "url": "https://github.com/apache/samza/pull/1401#pullrequestreview-450367922", "createdAt": "2020-07-17T04:40:38Z", "commit": {"oid": "0cc1f26349ac643c0dcbf36f953b9c2896a710f2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwNDo0MDozOFrOGzFHaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwNDo0MDozOFrOGzFHaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIxNDM3Ng==", "bodyText": "Can you revert the change for validation here and below ?", "url": "https://github.com/apache/samza/pull/1401#discussion_r456214376", "createdAt": "2020-07-17T04:40:38Z", "author": {"login": "atoomula"}, "path": "samza-sql/src/main/java/org/apache/samza/sql/interfaces/SqlIOConfig.java", "diffHunk": "@@ -81,11 +81,13 @@ public SqlIOConfig(String systemName, String streamName, List<String> sourcePart\n     this.streamId = String.format(\"%s-%s\", systemName, streamName);\n \n     samzaRelConverterName = streamConfigs.get(CFG_SAMZA_REL_CONVERTER);\n-    Validate.notEmpty(samzaRelConverterName, String.format(\"System %s is not supported. Please check if the system name is provided correctly.\", systemName));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0cc1f26349ac643c0dcbf36f953b9c2896a710f2"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d89f2f57535cee39439d7a16b49058f305dc18cd", "author": {"user": {"login": "shanthoosh", "name": null}}, "url": "https://github.com/apache/samza/commit/d89f2f57535cee39439d7a16b49058f305dc18cd", "committedDate": "2020-07-17T05:39:22Z", "message": "Address review comments."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwMzg1ODkx", "url": "https://github.com/apache/samza/pull/1401#pullrequestreview-450385891", "createdAt": "2020-07-17T05:42:37Z", "commit": {"oid": "d89f2f57535cee39439d7a16b49058f305dc18cd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwNzczMzQz", "url": "https://github.com/apache/samza/pull/1401#pullrequestreview-450773343", "createdAt": "2020-07-17T15:55:09Z", "commit": {"oid": "d89f2f57535cee39439d7a16b49058f305dc18cd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxNTo1NTowOVrOGzYXng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxNTo1NTowOVrOGzYXng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjUyOTgyMg==", "bodyText": "Can we add a simple unit test or at least a comment to avoid that this happens again in the future ?", "url": "https://github.com/apache/samza/pull/1401#discussion_r456529822", "createdAt": "2020-07-17T15:55:09Z", "author": {"login": "b-slim"}, "path": "samza-sql/src/main/java/org/apache/samza/sql/avro/AvroRelConverter.java", "diffHunk": "@@ -125,11 +125,18 @@ public static void fetchFieldNamesAndValuesFromIndexedRecord(IndexedRecord recor\n         .collect(Collectors.toList()));\n   }\n \n-  private static SamzaSqlRelRecord convertToRelRecord(IndexedRecord avroRecord, Schema schema) {\n+  private static SamzaSqlRelRecord convertToRelRecord(IndexedRecord avroRecord) {\n     List<Object> fieldValues = new ArrayList<>();\n     List<String> fieldNames = new ArrayList<>();\n     if (avroRecord != null) {\n-      fetchFieldNamesAndValuesFromIndexedRecord(avroRecord, fieldNames, fieldValues, schema);\n+      fieldNames.addAll(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d89f2f57535cee39439d7a16b49058f305dc18cd"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13c02ec3733a09134ea1a4c09f1923cd3c6acabb", "author": {"user": {"login": "shanthoosh", "name": null}}, "url": "https://github.com/apache/samza/commit/13c02ec3733a09134ea1a4c09f1923cd3c6acabb", "committedDate": "2020-07-20T17:32:50Z", "message": "Address review comments\n\nAdd unit tests for non-nullable union conversion with nested records."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43142aee99e0debdb0699fe7b1efdc3f7af7726c", "author": {"user": {"login": "shanthoosh", "name": null}}, "url": "https://github.com/apache/samza/commit/43142aee99e0debdb0699fe7b1efdc3f7af7726c", "committedDate": "2020-07-20T17:37:55Z", "message": "Fix rat failures."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxODI0NDY1", "url": "https://github.com/apache/samza/pull/1401#pullrequestreview-451824465", "createdAt": "2020-07-20T17:44:03Z", "commit": {"oid": "13c02ec3733a09134ea1a4c09f1923cd3c6acabb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxNzo0NDowM1rOG0YsuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxNzo0NDowM1rOG0YsuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU4MzgwMQ==", "bodyText": "I am wondering if this can be auto generated by the Build/Testing framework at runtime ? using something like avro-maven-plugin  here is an example https://github.com/alexholmes/avro-maven.\nFYI this is a suggestion comment and can be tackled as a followup if it is has a big scope.", "url": "https://github.com/apache/samza/pull/1401#discussion_r457583801", "createdAt": "2020-07-20T17:44:03Z", "author": {"login": "b-slim"}, "path": "samza-sql/src/test/java/org/apache/samza/sql/avro/schemas/ComplexUnion.java", "diffHunk": "@@ -0,0 +1,143 @@\n+/**\n+ * Autogenerated by Avro\n+ * \n+ * DO NOT EDIT DIRECTLY\n+ */\n+package org.apache.samza.sql.avro.schemas;  ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13c02ec3733a09134ea1a4c09f1923cd3c6acabb"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxODUyNjU4", "url": "https://github.com/apache/samza/pull/1401#pullrequestreview-451852658", "createdAt": "2020-07-20T18:24:27Z", "commit": {"oid": "43142aee99e0debdb0699fe7b1efdc3f7af7726c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxODoyNDoyN1rOG0aFVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxODoyNDoyN1rOG0aFVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzYwNjQ4Ng==", "bodyText": "Were you able to repro the issue with this unit test by having the older changes (with cached schema) ?", "url": "https://github.com/apache/samza/pull/1401#discussion_r457606486", "createdAt": "2020-07-20T18:24:27Z", "author": {"login": "atoomula"}, "path": "samza-sql/src/test/java/org/apache/samza/sql/avro/TestAvroRelConversion.java", "diffHunk": "@@ -231,6 +240,42 @@ public void testComplexRecordConversion() throws IOException {\n     validateAvroSerializedData(serializedData, testStrValue);\n   }\n \n+  @Test\n+  public void testComplexUnionConversionShouldWorkWithBothStringAndIntTypes() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43142aee99e0debdb0699fe7b1efdc3f7af7726c"}, "originalPosition": 54}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4657, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}