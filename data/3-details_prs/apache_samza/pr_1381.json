{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMyODEwMDk3", "number": 1381, "title": "SAMZA-2547: Add missing \"tableId\" for SendToTableOperatorSpec in Samza job execution plan", "bodyText": "Symptom\nThere is tableId information for StreamTableJoinOperatorSpec in Samza job execution plan:\n\"samza-hello-fluent-api-remote-table-venice-i001-alazhang-join-1\": {\n    \"opId\": \"samza-hello-fluent-api-remote-table-venice-i001-alazhang-join-1\",\n    \"tableId\": \"table-id\",\n    \"opCode\": \"JOIN\",\n    \"sourceLocation\": \"VeniceRemoteTableJoinApp.java:69\",\n    \"nextOperatorIds\": [\n        \"samza-hello-fluent-api-remote-table-venice-i001-alazhang-send_to-2\"\n    ]\n}\nHowever, there is no tableId  information for SendToTableOperatorSpec.\n \"samza-hello-fluent-api-remote-table-venice-i001-alazhang-send_to-2\": {\n    \"opId\": \"samza-hello-fluent-api-remote-table-venice-i001-alazhang-send_to-2\",\n    \"opCode\": \"SEND_TO\",\n    \"sourceLocation\": \"VeniceRemoteTableJoinApp.java:70\",\n    \"outputStreamId\": \"PageViewUserAgentTypeEvent\",\n    \"nextOperatorIds\": []\n}           \nCause\nCurrently, JobGraphJsonGenerator.operatorToMap() function populates \"tableId\" field when the given operator spec is table related.\nHowever, as shown in the below codes, we forgot to handle SendToTableOperatorSpec, but handle StreamTableJoinOperatorSpec twice somehow.\nprivate Map<String, Object> operatorToMap(OperatorSpec spec) {\n    Map<String, Object> map = new HashMap<>();\n    map.put(\"opCode\", spec.getOpCode().name());\n    map.put(\"opId\", spec.getOpId());\n    map.put(\"sourceLocation\", spec.getSourceLocation());\n    ...\n\n    if (spec instanceof StreamTableJoinOperatorSpec) {\n      String tableId = ((StreamTableJoinOperatorSpec) spec).getTableId();\n      map.put(\"tableId\", tableId);\n    }\n\n    if (spec instanceof StreamTableJoinOperatorSpec) {\n      String tableId = ((StreamTableJoinOperatorSpec) spec).getTableId();\n      map.put(\"tableId\", tableId);\n    }\n\n    if (spec instanceof JoinOperatorSpec) {\n      map.put(\"ttlMs\", ((JoinOperatorSpec) spec).getTtlMs());\n    }\n\n    return map;\n  }\nChanges\nReplace StreamTableJoinOperatorSpec with SendToTableOperatorSpec in one of above if statements.\nTests\nAdd test case to test all Table related operators.", "createdAt": "2020-06-11T03:05:05Z", "url": "https://github.com/apache/samza/pull/1381", "merged": true, "mergeCommit": {"oid": "322bfdd7cedcbaa6112d61623111ac2e7726f88f"}, "closed": true, "closedAt": "2020-06-11T05:50:23Z", "author": {"login": "alnzng"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcqFNSAAH2gAyNDMyODEwMDk3OjhjODkwZGM2OTNlZjU4MmY2MjE1OTU4MDA0ODczZjJlZGYwNDllOTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcqHtf6AFqTQyODYwOTIwNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8c890dc693ef582f6215958004873f2edf049e94", "author": {"user": {"login": "alnzng", "name": "Alan Zhang"}}, "url": "https://github.com/apache/samza/commit/8c890dc693ef582f6215958004873f2edf049e94", "committedDate": "2020-06-11T02:54:56Z", "message": "Add missing \"tableId\" for SendToTableOperatorSpec\n\nSigned-off-by: Alan Zhang <shuai.xyz@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4NTc5ODQ4", "url": "https://github.com/apache/samza/pull/1381#pullrequestreview-428579848", "createdAt": "2020-06-11T04:12:03Z", "commit": {"oid": "8c890dc693ef582f6215958004873f2edf049e94"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQwNDoxMjowM1rOGiN41w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQwNDoxMjowM1rOGiN41w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODUzMjMxMQ==", "bodyText": "why do you need this? can we just use mock instead?", "url": "https://github.com/apache/samza/pull/1381#discussion_r438532311", "createdAt": "2020-06-11T04:12:03Z", "author": {"login": "mynameborat"}, "path": "samza-core/src/test/java/org/apache/samza/execution/TestJobGraphJsonGenerator.java", "diffHunk": "@@ -368,4 +373,41 @@ String getCountry() {\n       return \"\";\n     }\n   }\n+\n+  @Test\n+  public void testOperatorToMapForTable() {\n+    JobGraphJsonGenerator jsonGenerator = new JobGraphJsonGenerator();\n+    Map<String, Object> map;\n+    SendToTableOperatorSpec<Object, Object> sendToTableOperatorSpec =\n+        OperatorSpecs.createSendToTableOperatorSpec(\"test-sent-to-table\", \"test-sent-to\");\n+    map = jsonGenerator.operatorToMap(sendToTableOperatorSpec);\n+    assertTrue(map.containsKey(\"tableId\"));\n+    assertEquals(map.get(\"tableId\"), \"test-sent-to-table\");\n+    assertEquals(map.get(\"opCode\"), OperatorSpec.OpCode.SEND_TO.name());\n+    assertEquals(map.get(\"opId\"), \"test-sent-to\");\n+    StreamTableJoinOperatorSpec<String, String, String, String> streamTableJoinOperatorSpec =\n+        OperatorSpecs.createStreamTableJoinOperatorSpec(\"test-join-table\", new TestStreamTableJoinFunction(),\n+            \"test-join\");\n+    map = jsonGenerator.operatorToMap(streamTableJoinOperatorSpec);\n+    assertTrue(map.containsKey(\"tableId\"));\n+    assertEquals(map.get(\"tableId\"), \"test-join-table\");\n+    assertEquals(map.get(\"opCode\"), OperatorSpec.OpCode.JOIN.name());\n+    assertEquals(map.get(\"opId\"), \"test-join\");\n+  }\n+\n+  private class TestStreamTableJoinFunction implements StreamTableJoinFunction<String, String, String, String> {\n+    @Override\n+    public String apply(String message, String record) {\n+      return null;\n+    }\n+    @Override\n+    public String getMessageKey(String message) {\n+      return null;\n+    }\n+    @Override\n+    public String getRecordKey(String record) {\n+      return null;\n+    }\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c890dc693ef582f6215958004873f2edf049e94"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "285c7fdedda89b0b810b7e31b9c3abde30a36af0", "author": {"user": {"login": "alnzng", "name": "Alan Zhang"}}, "url": "https://github.com/apache/samza/commit/285c7fdedda89b0b810b7e31b9c3abde30a36af0", "committedDate": "2020-06-11T04:18:39Z", "message": "remove useless codes\n\nSigned-off-by: Alan Zhang <shuai.xyz@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4NjA5MjA3", "url": "https://github.com/apache/samza/pull/1381#pullrequestreview-428609207", "createdAt": "2020-06-11T05:49:56Z", "commit": {"oid": "285c7fdedda89b0b810b7e31b9c3abde30a36af0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4631, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}