{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY3MDkzOTM0", "number": 1414, "title": "SAMZA-2579: Force restart feature for Container Placements", "bodyText": "Changes: The current restart ability for container placements works in the following way:\n\nTries to fetch resources on a host\nStops the active container if resources are accrued\nTried to start the container on host accrued\n\nIn production, we have seen the following observation at Linkedin\n\nSome jobs are configured to use resources for the peak which leads to no headroom left on a host for requesting additional resources\nThis leads to restart requests failing due to not able to get resources on that host\n\nA fix to this is to implement a force-restart utility , in this version we will stop the container first and then accrue resources. The upside being we will at least free up the resources on the host before issuing resource request, the downside being it will be a best-effort scenario to bring that container back up on that host\nAPI Changes: Added new param values to destinationHost param for container placement request message\nLAST_SEEN: Tries to restart a container on last seen host with RESERVE -> STOP -> MOVE policy\nFORCE_RESTART_LAST_SEEN: Tries to restart a container on last seen host with STOP -> RESERVE -> MOVE policy\nTests: Tested the change with a yarn job\nUpgrade Instructions: None\nUsage Instructions: None", "createdAt": "2020-08-13T01:31:07Z", "url": "https://github.com/apache/samza/pull/1414", "merged": true, "mergeCommit": {"oid": "29f2ef7cd9169ce8e0b474228c59a3a1da71e5c2"}, "closed": true, "closedAt": "2020-08-24T18:59:27Z", "author": {"login": "Sanil15"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-VrXzAH2gAyNDY3MDkzOTM0OjNhZTYyNmE2MjZhNWRlMTg3MmRkY2QxOGRkYmVmMTFiNjVkNmEyODU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCF2lnAFqTQ3MzY5NzE3Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3ae626a626a5de1872ddcd18ddbef11b65d6a285", "author": {"user": {"login": "Sanil15", "name": "Sanil Jain"}}, "url": "https://github.com/apache/samza/commit/3ae626a626a5de1872ddcd18ddbef11b65d6a285", "committedDate": "2020-08-13T01:24:46Z", "message": "Force restart feature for Container Placements"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwNzYzNjI0", "url": "https://github.com/apache/samza/pull/1414#pullrequestreview-470763624", "createdAt": "2020-08-19T19:16:34Z", "commit": {"oid": "3ae626a626a5de1872ddcd18ddbef11b65d6a285"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxOToxNjozNFrOHDVpkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxOToxNjozNFrOHDVpkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI2MjQ4MQ==", "bodyText": "Isnt force-restart a misnomer here?\nAll its really doing is issuing a stop and relying on the AM to bring it back up?\nIn a corner case, AM will not be able to bring it back up on the same host, rather on a different available host?", "url": "https://github.com/apache/samza/pull/1414#discussion_r473262481", "createdAt": "2020-08-19T19:16:34Z", "author": {"login": "rmatharu"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ContainerManager.java", "diffHunk": "@@ -54,6 +54,8 @@\n \n   private static final Logger LOG = LoggerFactory.getLogger(ContainerManager.class);\n   private static final String ANY_HOST = ResourceRequestState.ANY_HOST;\n+  private static final String LAST_SEEN = \"LAST_SEEN\";\n+  private static final String FORCE_RESTART_LAST_SEEN = \"FORCE_RESTART_LAST_SEEN\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ae626a626a5de1872ddcd18ddbef11b65d6a285"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwNzY0NTcz", "url": "https://github.com/apache/samza/pull/1414#pullrequestreview-470764573", "createdAt": "2020-08-19T19:18:01Z", "commit": {"oid": "3ae626a626a5de1872ddcd18ddbef11b65d6a285"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxOToxODowMVrOHDVsSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxOToxODowMVrOHDVsSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI2MzE3OA==", "bodyText": "This comment has the same meaning as the one above\n\"if (destinationHost.equals(FORCE_RESTART_LAST_SEEN))\"\nCould we write the difference", "url": "https://github.com/apache/samza/pull/1414#discussion_r473263178", "createdAt": "2020-08-19T19:18:01Z", "author": {"login": "rmatharu"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ContainerManager.java", "diffHunk": "@@ -391,6 +402,28 @@ public void registerContainerPlacementAction(ContainerPlacementRequestMessage re\n       return;\n     }\n \n+    /*\n+     * When destination host is {@code FORCE_RESTART_LAST_SEEN} its treated as eqvivalent to kill -9 operation for the container\n+     * In this scenario container is stopped first and we fallback to normal restart path\n+     */\n+    if (destinationHost.equals(FORCE_RESTART_LAST_SEEN)) {\n+      LOG.info(\"Issuing a force restart for Processor ID: {} for ContainerPlacement action request {}\", processorId, requestMessage);\n+      clusterResourceManager.stopStreamProcessor(samzaApplicationState.runningProcessors.get(processorId));\n+      writeContainerPlacementResponseMessage(requestMessage, ContainerPlacementMessage.StatusCode.SUCCEEDED,\n+          \"Successfully issued a stop container request falling back to normal restart path\");\n+      return;\n+    }\n+\n+    /**\n+     * When destination host is {@code LAST_SEEN} its treated as a restart request on the host where container is running\n+     * on or has been seen last\n+     */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ae626a626a5de1872ddcd18ddbef11b65d6a285"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwNzY0NzUz", "url": "https://github.com/apache/samza/pull/1414#pullrequestreview-470764753", "createdAt": "2020-08-19T19:18:17Z", "commit": {"oid": "3ae626a626a5de1872ddcd18ddbef11b65d6a285"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6e3cc0857e5a43691b8864674c7541a56a03815", "author": {"user": {"login": "Sanil15", "name": "Sanil Jain"}}, "url": "https://github.com/apache/samza/commit/a6e3cc0857e5a43691b8864674c7541a56a03815", "committedDate": "2020-08-21T00:12:19Z", "message": "Cleanup comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczNjk3MDc4", "url": "https://github.com/apache/samza/pull/1414#pullrequestreview-473697078", "createdAt": "2020-08-24T17:14:07Z", "commit": {"oid": "a6e3cc0857e5a43691b8864674c7541a56a03815"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxNzoxNDowN1rOHFunJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxNzoxNDowN1rOHFunJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc2ODYxNA==", "bodyText": "small thing:\nI think its equivalent to a \"kill\"  (i.e., sigstop), not \"kill -9\" (sigkill).\nCould you verify using the yarn docs", "url": "https://github.com/apache/samza/pull/1414#discussion_r475768614", "createdAt": "2020-08-24T17:14:07Z", "author": {"login": "rmatharu"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ContainerManager.java", "diffHunk": "@@ -391,6 +402,30 @@ public void registerContainerPlacementAction(ContainerPlacementRequestMessage re\n       return;\n     }\n \n+    /*\n+     * When destination host is {@code FORCE_RESTART_LAST_SEEN} its treated as eqvivalent to kill -9 operation for the container", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a6e3cc0857e5a43691b8864674c7541a56a03815"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczNjk3MTc2", "url": "https://github.com/apache/samza/pull/1414#pullrequestreview-473697176", "createdAt": "2020-08-24T17:14:14Z", "commit": {"oid": "a6e3cc0857e5a43691b8864674c7541a56a03815"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4685, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}