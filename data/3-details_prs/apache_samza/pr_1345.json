{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAzMzg4NDc0", "number": 1345, "title": "SAMZA-2506: Inconsistent end of stream semantics in SystemStreamPartitionMetadata", "bodyText": "I found this when refactoring side input restore to use RunLoop (#1343); this patch is necessary to prevent integration tests from failing after that refactor as marking side inputs as caught up relies on newest offset.\nSymptom: When an end of stream message is present in an in memory SSP, the new and upcoming offset are reported as 1 higher than they should be.\nExample:\n| E0, offset: 0 | E1, offset: 1 | ... | E3, offset: 3 | EndOfStream |\nIn the above case, InMemoryManager will report a newestOffset of 4 and an upcomingOffset of 5; they should be 3 and 4 respectively.\nSee the jira ticket for a more in depth analysis of semantics of end of stream as it relates to offset metadata.\nCause: InMemoryManager treats end of stream as any other envelope with a numeric offset even though it is not.\nChanges: Check in InMemoryManager.constructSystemStreamMetadata whether the last message in the stream is an EndOfStream, and adjust offsets accordingly.\nTests: Added a unit test to verify that offsets are adjusted by 1 in the case of EndOfStream.", "createdAt": "2020-04-14T20:07:04Z", "url": "https://github.com/apache/samza/pull/1345", "merged": true, "mergeCommit": {"oid": "0a7760a55be2b6089088016c55217814b5c9675f"}, "closed": true, "closedAt": "2020-05-19T01:28:20Z", "author": {"login": "bkonold"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcRV0rCAH2gAyNDAzMzg4NDc0OjdlNDIzZDhmMGVmMWI2YWU4OTRjNWRkNzZhNTFiODRjNWZlZGFhZGM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABciqLdNAFqTQxNDA0MDM1MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7e423d8f0ef1b6ae894c5dd76a51b84c5fedaadc", "author": {"user": null}, "url": "https://github.com/apache/samza/commit/7e423d8f0ef1b6ae894c5dd76a51b84c5fedaadc", "committedDate": "2020-03-26T06:08:20Z", "message": "fixing in memory system admin offsets in case where stream is terminated by an 'end of stream' message"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83cb9dd515c1994d967060c442b5fe9ff3f3c391", "author": {"user": null}, "url": "https://github.com/apache/samza/commit/83cb9dd515c1994d967060c442b5fe9ff3f3c391", "committedDate": "2020-03-26T08:34:44Z", "message": "adding end of stream unit test to InMemoryManager"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e38cb0635466470d3585be45a6c733087f9ce24b", "author": {"user": null}, "url": "https://github.com/apache/samza/commit/e38cb0635466470d3585be45a6c733087f9ce24b", "committedDate": "2020-04-09T00:05:39Z", "message": "modifying initialization of offset vars used to construct SystemStreamPartitionMetadata"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzMzA5MzU4", "url": "https://github.com/apache/samza/pull/1345#pullrequestreview-393309358", "createdAt": "2020-04-14T21:28:54Z", "commit": {"oid": "e38cb0635466470d3585be45a6c733087f9ce24b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwNDk3MDYz", "url": "https://github.com/apache/samza/pull/1345#pullrequestreview-400497063", "createdAt": "2020-04-26T12:11:45Z", "commit": {"oid": "e38cb0635466470d3585be45a6c733087f9ce24b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNlQxMjoxMTo0NlrOGMDo2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNlQxMjoxMTo0NlrOGMDo2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTI5NTcwNQ==", "bodyText": "maybe simplify this to have it default to original values 0, messages.size() - 1, messages.size and only modify in case of the last message being end of stream?", "url": "https://github.com/apache/samza/pull/1345#discussion_r415295705", "createdAt": "2020-04-26T12:11:46Z", "author": {"login": "mynameborat"}, "path": "samza-core/src/main/java/org/apache/samza/system/inmemory/InMemoryManager.java", "diffHunk": "@@ -181,12 +181,26 @@ private SystemStreamMetadata constructSystemStreamMetadata(\n             .stream()\n             .collect(Collectors.toMap(entry -> entry.getKey().getPartition(), entry -> {\n                 List<IncomingMessageEnvelope> messages = entry.getValue();\n-                String oldestOffset = messages.isEmpty() ? null : \"0\";\n-                String newestOffset = messages.isEmpty() ? null : String.valueOf(messages.size() - 1);\n-                String upcomingOffset = String.valueOf(messages.size());\n-\n-                return new SystemStreamMetadata.SystemStreamPartitionMetadata(oldestOffset, newestOffset, upcomingOffset);\n-\n+                Integer oldestOffset = null;\n+                Integer newestOffset = null;\n+                int upcomingOffset = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e38cb0635466470d3585be45a6c733087f9ce24b"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "813e75d5f95bd53867a5761e82e3f2422d63067f", "author": {"user": null}, "url": "https://github.com/apache/samza/commit/813e75d5f95bd53867a5761e82e3f2422d63067f", "committedDate": "2020-05-05T23:56:35Z", "message": "addressing review comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0MDQwMzUw", "url": "https://github.com/apache/samza/pull/1345#pullrequestreview-414040350", "createdAt": "2020-05-19T01:28:02Z", "commit": {"oid": "813e75d5f95bd53867a5761e82e3f2422d63067f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4566, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}