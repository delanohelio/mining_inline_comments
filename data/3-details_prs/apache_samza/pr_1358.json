{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE1MDE1NzAz", "number": 1358, "title": "SAMZA-2522: Add metadata generator for azure storage blob", "bodyText": "Feature: This PR extends the existing AzureBlobSystemProducer by adding the ability to enhance an azure storage blob with metadata - basically key-value pairs to the blob's metadata (sits outside of the blob's actual content). This aids tremendously in ingesting these blobs into Kusto (Azure's data explorer).\nChanges: New interfaces BlobMetadataGeneratorFactory, BlobMetadataGenerator and class BlobMetadataContext added where the user needs to implement BlobMetadataGeneratorFactory and BlobMetadataGenerator which takes in a BlobMetadataContext containing the stream name and the size of the current blob being committed. An instance of the generator will be created when the blob is about to be committed. Generator is invoked to get metadata and the returned metadata is attached to the blob.\nAny additional configs (key:value pairs) needed for this generator can be passed as with prefix systems..azureblob.metadataGeneratorConfig.<key> with value <value>.\nA default impl is provided which does not add anything to the blob.\nAPI changes: New interfaces BlobMetadataGeneratorFactory, BlobMetadataGenerator and class BlobMetadataContext added. New configs with prefix systems..azureblob.metadataGeneratorConfig. The factory is wired in through systems..azureblob.metadataPropertiesGeneratorFactory.\nPrior to this PR, \"rawSizeBytes\" metadata was always added  by default to the blobs committed. Now, that will not be the case. A BlobMetadataGenerator implementation has to be provided to add this.\nUpgrade instructions: Backwards incompatible. \"rawSizeBytes\" metadata will no longer be added by default. Instead a generator will have to be provided.\nUsage instructions: Wire in the generator factory through systems..azureblob.metadataPropertiesGeneratorFactory and pass in additional configs with prefix systems..azureblob.metadataGeneratorConfig\nTests: Existing tests updated to assert for metadata attached.", "createdAt": "2020-05-08T02:47:17Z", "url": "https://github.com/apache/samza/pull/1358", "merged": true, "mergeCommit": {"oid": "9f24f1526d8f1c47e6e8fa4d9f68577cc2995f69"}, "closed": true, "closedAt": "2020-05-15T21:16:18Z", "author": {"login": "lakshmi-manasa-g"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcfIWf8gH2gAyNDE1MDE1NzAzOjIxZmViYzBhN2RlZDEzYzVjNzNlYTYwODNkMmMwNGRjYTRjYjYyZDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABchlZsUAH2gAyNDE1MDE1NzAzOjUxZThmMTlmYWM0ZWE2MDY1ODg5MjI4YjI1NWU2NmI1YmRjMDJkY2Y=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "21febc0a7ded13c5c73ea6083d2c04dca4cb62d1", "author": {"user": {"login": "lakshmi-manasa-g", "name": null}}, "url": "https://github.com/apache/samza/commit/21febc0a7ded13c5c73ea6083d2c04dca4cb62d1", "committedDate": "2020-05-08T02:21:33Z", "message": "SAMZA-2522: Add metadata to azure storage blob"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c340bd00ed9a20d9c992fbf5ba009041ccac22ee", "author": {"user": {"login": "lakshmi-manasa-g", "name": null}}, "url": "https://github.com/apache/samza/commit/c340bd00ed9a20d9c992fbf5ba009041ccac22ee", "committedDate": "2020-05-08T02:46:23Z", "message": "fix typo"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyMjgxMjMy", "url": "https://github.com/apache/samza/pull/1358#pullrequestreview-412281232", "createdAt": "2020-05-15T01:00:47Z", "commit": {"oid": "c340bd00ed9a20d9c992fbf5ba009041ccac22ee"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwMTowMDo0N1rOGVzEZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwMToxNzowM1rOGVzTvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTUwOTk4OQ==", "bodyText": "Does this need to have an extra . at the end so it gets stripped off in getSystemMetadataGeneratorConfigs?", "url": "https://github.com/apache/samza/pull/1358#discussion_r425509989", "createdAt": "2020-05-15T01:00:47Z", "author": {"login": "cameronlee314"}, "path": "samza-azure/src/main/java/org/apache/samza/system/azureblob/AzureBlobConfig.java", "diffHunk": "@@ -94,6 +95,18 @@\n   public static final String SYSTEM_SUFFIX_RANDOM_STRING_TO_BLOB_NAME = SYSTEM_AZUREBLOB_PREFIX + \"suffixRandomStringToBlobName\";\n   private static final boolean SYSTEM_SUFFIX_RANDOM_STRING_TO_BLOB_NAME_DEFAULT = true;\n \n+  // full class name of an implementation of org.apache.samza.system.azureblob.utils.BlobMetadataGeneratorFactory\n+  // this factory should return an implementation of org.apache.samza.system.azureblob.utils.BlobMetadataGenerator\n+  // this generator will be invoked when a blob is committed to add metadata properties to it\n+  public static final String SYSTEM_BLOB_METADATA_PROPERTIES_GENERATOR_FACTORY = SYSTEM_AZUREBLOB_PREFIX + \"metadataPropertiesGeneratorFactory\";\n+  private static final String SYSTEM_BLOB_METADATA_PROPERTIES_GENERATOR_FACTORY_DEFAULT =\n+      \"org.apache.samza.system.azureblob.utils.NullBlobMetadataGeneratorFactory\";\n+\n+  // Additional configs for the metadata generator should be prefixed with this string which is passed to the generator.\n+  // for example, to pass a \"key\":\"value\" pair to the metadata generator, add config like\n+  // systems.<system-name>.azureblob.metadataGeneratorConfig.<key> with value <value>\n+  public static final String SYSTEM_BLOB_METADATA_GENERATOR_CONFIG_PREFIX = SYSTEM_AZUREBLOB_PREFIX + \"metadataGeneratorConfig\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c340bd00ed9a20d9c992fbf5ba009041ccac22ee"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTUxMTgyNA==", "bodyText": "Minor: For consistency, consider naming these getSystemBlobMetadata...", "url": "https://github.com/apache/samza/pull/1358#discussion_r425511824", "createdAt": "2020-05-15T01:08:35Z", "author": {"login": "cameronlee314"}, "path": "samza-azure/src/main/java/org/apache/samza/system/azureblob/AzureBlobConfig.java", "diffHunk": "@@ -185,4 +198,13 @@ public long getMaxBlobSize(String systemName) {\n   public long getMaxMessagesPerBlob(String systemName) {\n     return getLong(String.format(SYSTEM_MAX_MESSAGES_PER_BLOB, systemName), SYSTEM_MAX_MESSAGES_PER_BLOB_DEFAULT);\n   }\n+\n+  public String getSystemMetadataPropertiesGeneratorFactory(String systemName) {\n+    return get(String.format(SYSTEM_BLOB_METADATA_PROPERTIES_GENERATOR_FACTORY, systemName),\n+        SYSTEM_BLOB_METADATA_PROPERTIES_GENERATOR_FACTORY_DEFAULT);\n+  }\n+\n+  public Config getSystemMetadataGeneratorConfigs(String systemName) {\n+    return subset(String.format(SYSTEM_BLOB_METADATA_GENERATOR_CONFIG_PREFIX, systemName));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c340bd00ed9a20d9c992fbf5ba009041ccac22ee"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTUxMzkxOQ==", "bodyText": "If an existing case needs this BLOB_RAW_SIZE_BYTES_METADATA, then will they need to implement their own blob metadata generator?", "url": "https://github.com/apache/samza/pull/1358#discussion_r425513919", "createdAt": "2020-05-15T01:17:03Z", "author": {"login": "cameronlee314"}, "path": "samza-azure/src/main/java/org/apache/samza/system/azureblob/avro/AzureBlobOutputStream.java", "diffHunk": "@@ -172,8 +193,8 @@ public synchronized void close() {\n       future.get((long) flushTimeoutMs, TimeUnit.MILLISECONDS);\n       LOG.info(\"For blob: {} committing blockList size:{}\", blobAsyncClient.getBlobUrl().toString(), blockList.size());\n       metrics.updateAzureCommitMetrics();\n-      Map<String, String> blobMetadata = Collections.singletonMap(BLOB_RAW_SIZE_BYTES_METADATA, Long.toString(totalUploadedBlockSize));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c340bd00ed9a20d9c992fbf5ba009041ccac22ee"}, "originalPosition": 69}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d0cf1fd64c9654c755c3053c99c6123eadbd919", "author": {"user": {"login": "lakshmi-manasa-g", "name": null}}, "url": "https://github.com/apache/samza/commit/6d0cf1fd64c9654c755c3053c99c6123eadbd919", "committedDate": "2020-05-15T02:33:51Z", "message": "address comments for configs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyODIzOTM0", "url": "https://github.com/apache/samza/pull/1358#pullrequestreview-412823934", "createdAt": "2020-05-15T17:10:21Z", "commit": {"oid": "6d0cf1fd64c9654c755c3053c99c6123eadbd919"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51e8f19fac4ea6065889228b255e66b5bdc02dcf", "author": {"user": {"login": "lakshmi-manasa-g", "name": null}}, "url": "https://github.com/apache/samza/commit/51e8f19fac4ea6065889228b255e66b5bdc02dcf", "committedDate": "2020-05-15T17:20:08Z", "message": "Trigger build"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4590, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}