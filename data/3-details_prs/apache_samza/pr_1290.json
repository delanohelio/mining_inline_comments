{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc5NzI0NzI5", "number": 1290, "title": "SAMZA-2468: Make Standby containers respond to shutdown request", "bodyText": "Issues: Currently, standby containers don't spin up run loop and do an infinite wait after starting the container storage manager. In the event of a shutdown request from LocalApplicationRunner, these containers don't respond since the shutdown request is coordinator through runloop and it leaves us with the only option of forcefully killing it.\nChanges: Add a countdown latch to signal the main thread to make standby containers to respond to shutdown instead of infinite sleeping\nImprovement: StandbyContainer invoke a clean shutdown within a few seconds rather than waiting to be killed for 30 secs\nTests: Manually tested the shutdown sequence\nAPI Changes: None\nUpgrade instructions: None\nUsage instructions: None", "createdAt": "2020-02-25T18:11:22Z", "url": "https://github.com/apache/samza/pull/1290", "merged": true, "mergeCommit": {"oid": "ded197de57a3c218780a1bf81130822e078a960d"}, "closed": true, "closedAt": "2020-02-26T19:04:44Z", "author": {"login": "Sanil15"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcH167QgH2gAyMzc5NzI0NzI5OjBmNmJmMjZmYmYzY2ZiNGNiMTJhNmVmYTFhOTk1ZTljMjczZDdjYzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcH7LXfAH2gAyMzc5NzI0NzI5OjU0OTEyMjczMzYxNzgzYjAxZWY4ZmRjMmM5MzIyNDhiMWJmMjBiNmI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0f6bf26fbf3cfb4cb12a6efa1a995e9c273d7cc4", "author": {"user": {"login": "Sanil15", "name": "Sanil Jain"}}, "url": "https://github.com/apache/samza/commit/0f6bf26fbf3cfb4cb12a6efa1a995e9c273d7cc4", "committedDate": "2020-02-25T17:52:53Z", "message": "Make Standby containers to respond to shutdown request"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "619318bf61e902b4e57f0b99dc630e3d0d7696cf", "author": {"user": {"login": "Sanil15", "name": "Sanil Jain"}}, "url": "https://github.com/apache/samza/commit/619318bf61e902b4e57f0b99dc630e3d0d7696cf", "committedDate": "2020-02-25T18:31:48Z", "message": "Adressing feedback"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c128cc65cbd6016e790fa66feb493f99b12049ff", "author": {"user": {"login": "Sanil15", "name": "Sanil Jain"}}, "url": "https://github.com/apache/samza/commit/c128cc65cbd6016e790fa66feb493f99b12049ff", "committedDate": "2020-02-25T18:30:35Z", "message": "Adressing feedback"}, "afterCommit": {"oid": "619318bf61e902b4e57f0b99dc630e3d0d7696cf", "author": {"user": {"login": "Sanil15", "name": "Sanil Jain"}}, "url": "https://github.com/apache/samza/commit/619318bf61e902b4e57f0b99dc630e3d0d7696cf", "committedDate": "2020-02-25T18:31:48Z", "message": "Adressing feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0Mzc4MDA2", "url": "https://github.com/apache/samza/pull/1290#pullrequestreview-364378006", "createdAt": "2020-02-25T19:14:23Z", "commit": {"oid": "619318bf61e902b4e57f0b99dc630e3d0d7696cf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxOToxNDoyM1rOFuRvuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxOToxNDoyM1rOFuRvuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA2OTU2MA==", "bodyText": "please add a unit test :)", "url": "https://github.com/apache/samza/pull/1290#discussion_r384069560", "createdAt": "2020-02-25T19:14:23Z", "author": {"login": "mynameborat"}, "path": "samza-core/src/main/scala/org/apache/samza/container/SamzaContainer.scala", "diffHunk": "@@ -865,6 +868,11 @@ class SamzaContainer(\n       return\n     }\n \n+    /**\n+      * Countdown the standbyContainerShutdownLatch so standby container can invoke a shutdown sequence\n+      */\n+    standbyContainerShutdownLatch.countDown();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "619318bf61e902b4e57f0b99dc630e3d0d7696cf"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c612eb2cc30e11963a9832a3b611dc4af86b40c", "author": {"user": {"login": "Sanil15", "name": "Sanil Jain"}}, "url": "https://github.com/apache/samza/commit/5c612eb2cc30e11963a9832a3b611dc4af86b40c", "committedDate": "2020-02-25T20:01:32Z", "message": "Adding unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5831bbc1768c84be72036c778154edd5e0f31aa", "author": {"user": {"login": "Sanil15", "name": "Sanil Jain"}}, "url": "https://github.com/apache/samza/commit/b5831bbc1768c84be72036c778154edd5e0f31aa", "committedDate": "2020-02-25T20:10:02Z", "message": "Nit pick improve"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "03e2cfcc65dbd957b361e3e26242cddf0c0977c3", "author": {"user": {"login": "Sanil15", "name": "Sanil Jain"}}, "url": "https://github.com/apache/samza/commit/03e2cfcc65dbd957b361e3e26242cddf0c0977c3", "committedDate": "2020-02-25T20:04:34Z", "message": "Nit pick improve"}, "afterCommit": {"oid": "b5831bbc1768c84be72036c778154edd5e0f31aa", "author": {"user": {"login": "Sanil15", "name": "Sanil Jain"}}, "url": "https://github.com/apache/samza/commit/b5831bbc1768c84be72036c778154edd5e0f31aa", "committedDate": "2020-02-25T20:10:02Z", "message": "Nit pick improve"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0NDE0ODcw", "url": "https://github.com/apache/samza/pull/1290#pullrequestreview-364414870", "createdAt": "2020-02-25T20:10:35Z", "commit": {"oid": "03e2cfcc65dbd957b361e3e26242cddf0c0977c3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0NTExODEw", "url": "https://github.com/apache/samza/pull/1290#pullrequestreview-364511810", "createdAt": "2020-02-25T22:57:39Z", "commit": {"oid": "b5831bbc1768c84be72036c778154edd5e0f31aa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQyMjo1NzozOVrOFuYWzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQyMjo1NzozOVrOFuYWzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDE3Nzg3MA==", "bodyText": "Can we do without the sleep in the test ?  Also, we should verify that the countdown() was actually called.\nI think it should be possible to test the behavior by making the latch visible for testing ?", "url": "https://github.com/apache/samza/pull/1290#discussion_r384177870", "createdAt": "2020-02-25T22:57:39Z", "author": {"login": "abhishekshivanna"}, "path": "samza-core/src/test/scala/org/apache/samza/container/TestSamzaContainer.scala", "diffHunk": "@@ -126,6 +126,45 @@ class TestSamzaContainer extends AssertionsForJUnit with MockitoSugar {\n     verify(this.runLoop).run()\n   }\n \n+\n+  @Test\n+  def testShutDownSequenceForStandbyContainers() {\n+    class ShutDownSignal(container: SamzaContainer) extends Runnable {\n+      def run(): Unit = {\n+        Thread.sleep(2000)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5831bbc1768c84be72036c778154edd5e0f31aa"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba75f0eac2fbd7e5be4b98decf9377a310e2bae9", "author": {"user": {"login": "Sanil15", "name": "Sanil Jain"}}, "url": "https://github.com/apache/samza/commit/ba75f0eac2fbd7e5be4b98decf9377a310e2bae9", "committedDate": "2020-02-26T00:00:12Z", "message": "Empty Commit to trigger build"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54912273361783b01ef8fdc2c932248b1bf20b6b", "author": {"user": {"login": "Sanil15", "name": "Sanil Jain"}}, "url": "https://github.com/apache/samza/commit/54912273361783b01ef8fdc2c932248b1bf20b6b", "committedDate": "2020-02-26T00:00:22Z", "message": "Empty Commit to trigger build"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4790, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}