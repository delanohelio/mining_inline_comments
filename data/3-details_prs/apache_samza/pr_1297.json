{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgxNTExOTI5", "number": 1297, "title": "SAMZA-2379: Support Container Placements for job running in degraded state ", "bodyText": "Design: SEP-22: Container Placements in Samza\nChanges:: Today if the config \"cluster-manager.container.fail.job.after.retries\" is set to false that means after exhausting all the retry on the containers, Job Coordinator does not fail the job but keeps running the job without the failed container. In such scenarios, this container can be started back on the host it was last running on or any other host using container placements APIs\nAPI Changes: None\nUpgrade Instructions: None\nUsage Instructions: Instantiate ContainerPlacementMetadataStore to write Container placement messages to Metastore, query it by the UUID generated", "createdAt": "2020-02-28T17:39:02Z", "url": "https://github.com/apache/samza/pull/1297", "merged": true, "mergeCommit": {"oid": "d6e4f679c445ad840ac649fbd39fef7d841d2963"}, "closed": true, "closedAt": "2020-03-09T22:21:24Z", "author": {"login": "Sanil15"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcI5MNWABqjMwODM5Mzg3MjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMCpr9gH2gAyMzgxNTExOTI5OjgwMGNhMzBlNjc5ODU3YTYyMGYxNDZiMzQyODk3ZTU3YTdiNzMwOTc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9d8df53c2315b73cb21d099eb95f2bd309d6334d", "author": {"user": {"login": "Sanil15", "name": "Sanil Jain"}}, "url": "https://github.com/apache/samza/commit/9d8df53c2315b73cb21d099eb95f2bd309d6334d", "committedDate": "2020-02-28T17:38:19Z", "message": "SAMZA-2379: Container Placements support for job running in degraded state"}, "afterCommit": {"oid": "e9acfc6a7feaeb9fdeb05a441a1d11fb4c2d4d21", "author": {"user": {"login": "Sanil15", "name": "Sanil Jain"}}, "url": "https://github.com/apache/samza/commit/e9acfc6a7feaeb9fdeb05a441a1d11fb4c2d4d21", "committedDate": "2020-02-29T00:15:14Z", "message": "Container Placements support for Job Running in degraded state"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14034f3b441ae79ec4ba43f4a0e8e94836dd34f1", "author": {"user": {"login": "Sanil15", "name": "Sanil Jain"}}, "url": "https://github.com/apache/samza/commit/14034f3b441ae79ec4ba43f4a0e8e94836dd34f1", "committedDate": "2020-03-02T20:21:29Z", "message": "Container Placements support for Job Running in degraded state"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e9acfc6a7feaeb9fdeb05a441a1d11fb4c2d4d21", "author": {"user": {"login": "Sanil15", "name": "Sanil Jain"}}, "url": "https://github.com/apache/samza/commit/e9acfc6a7feaeb9fdeb05a441a1d11fb4c2d4d21", "committedDate": "2020-02-29T00:15:14Z", "message": "Container Placements support for Job Running in degraded state"}, "afterCommit": {"oid": "14034f3b441ae79ec4ba43f4a0e8e94836dd34f1", "author": {"user": {"login": "Sanil15", "name": "Sanil Jain"}}, "url": "https://github.com/apache/samza/commit/14034f3b441ae79ec4ba43f4a0e8e94836dd34f1", "committedDate": "2020-03-02T20:21:29Z", "message": "Container Placements support for Job Running in degraded state"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "087a20f160e7f411b1bfa7a138e0b58f60875a8f", "author": {"user": {"login": "Sanil15", "name": "Sanil Jain"}}, "url": "https://github.com/apache/samza/commit/087a20f160e7f411b1bfa7a138e0b58f60875a8f", "committedDate": "2020-03-03T00:39:34Z", "message": "Improve comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MTAxMDcx", "url": "https://github.com/apache/samza/pull/1297#pullrequestreview-369101071", "createdAt": "2020-03-04T20:32:26Z", "commit": {"oid": "087a20f160e7f411b1bfa7a138e0b58f60875a8f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMDozMjoyNlrOFx8nrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMDozMjoyNlrOFx8nrA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkxNzc0MA==", "bodyText": "Is this required only for testing?", "url": "https://github.com/apache/samza/pull/1297#discussion_r387917740", "createdAt": "2020-03-04T20:32:26Z", "author": {"login": "rmatharu"}, "path": "samza-core/src/test/java/org/apache/samza/clustermanager/MockClusterResourceManager.java", "diffHunk": "@@ -102,12 +102,17 @@ public void launchStreamProcessor(SamzaResource resource, CommandBuilder builder\n \n   @Override\n   public void stopStreamProcessor(SamzaResource resource) {\n-    SamzaResourceStatus status = new SamzaResourceStatus(resource.getContainerId(), \"diagnostics\", SamzaResourceStatus.PREEMPTED);\n+    stopStreamProcessor(resource, SamzaResourceStatus.PREEMPTED);\n+  }\n+\n+  void stopStreamProcessor(SamzaResource resource, int exitCode) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "087a20f160e7f411b1bfa7a138e0b58f60875a8f"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MTA4MzMx", "url": "https://github.com/apache/samza/pull/1297#pullrequestreview-369108331", "createdAt": "2020-03-04T20:44:25Z", "commit": {"oid": "087a20f160e7f411b1bfa7a138e0b58f60875a8f"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMDo0NDoyNVrOFx89xg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMDo0OTo0N1rOFx9H6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkyMzM5OA==", "bodyText": "CPM does a similar thing at\nString lastSeenOn = state.jobModelManager.jobModel().getContainerToHostValue(processorId, SetContainerHostMapping.HOST_KEY);\n\nIs it possible to consolidate these multiple job-model-manager accesses?\nmaybe call it just getHostForContainer?", "url": "https://github.com/apache/samza/pull/1297#discussion_r387923398", "createdAt": "2020-03-04T20:44:25Z", "author": {"login": "rmatharu"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ContainerManager.java", "diffHunk": "@@ -429,6 +429,25 @@ private void writeContainerPlacementResponseMessage(ContainerPlacementRequestMes\n             responseMessage, System.currentTimeMillis()));\n   }\n \n+  /**\n+   * Gets the hostname on which container is either currently running or was last seen on if it is not running\n+   */\n+  private String getSourceHostForContainer(ContainerPlacementRequestMessage requestMessage) {\n+    String sourceHost = null;\n+    String processorId = requestMessage.getProcessorId();\n+    if (samzaApplicationState.runningProcessors.containsKey(processorId)) {\n+      SamzaResource currentResource = samzaApplicationState.runningProcessors.get(processorId);\n+      LOG.info(\"Processor ID: {} matched a running container with containerId ID: {} is running on host: {} for ContainerPlacement action: {}\",\n+          processorId, currentResource.getContainerId(), currentResource.getHost(), requestMessage);\n+      sourceHost = currentResource.getHost();\n+    } else {\n+      sourceHost = samzaApplicationState.jobModelManager.jobModel().getContainerToHostValue(processorId, SetContainerHostMapping.HOST_KEY);\n+      LOG.info(\"Processor ID: {} is not running and was last seen on host: {} for ContainerPlacement action: {}\",\n+          processorId, sourceHost, requestMessage);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "087a20f160e7f411b1bfa7a138e0b58f60875a8f"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkyNDI3MA==", "bodyText": "Log statements needed?", "url": "https://github.com/apache/samza/pull/1297#discussion_r387924270", "createdAt": "2020-03-04T20:46:13Z", "author": {"login": "rmatharu"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ContainerManager.java", "diffHunk": "@@ -443,6 +462,11 @@ private boolean deQueueAction(ContainerPlacementRequestMessage requestMessage) {\n     if (checkIfActiveOrStandbyContainerHasActivePlacementAction(requestMessage)) {\n       return false;\n     }\n+\n+    if (samzaApplicationState.failedProcessors.containsKey(requestMessage.getProcessorId())) {\n+      return true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "087a20f160e7f411b1bfa7a138e0b58f60875a8f"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkyNTAwNQ==", "bodyText": "To make this readable, maybe define variables for each of the lookups and\ndefine the if to be\nif (inRunning || inPending || inFailed) {//do blah}\nelse {\nthis\n}", "url": "https://github.com/apache/samza/pull/1297#discussion_r387925005", "createdAt": "2020-03-04T20:47:45Z", "author": {"login": "rmatharu"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ContainerManager.java", "diffHunk": "@@ -464,7 +488,8 @@ private boolean deQueueAction(ContainerPlacementRequestMessage requestMessage) {\n     Boolean invalidAction = false;\n     String errorMessage = null;\n     if (!samzaApplicationState.runningProcessors.containsKey(requestMessage.getProcessorId()) &&\n-        !samzaApplicationState.pendingProcessors.containsKey(requestMessage.getProcessorId())\n+        !samzaApplicationState.pendingProcessors.containsKey(requestMessage.getProcessorId()) &&\n+        !samzaApplicationState.failedProcessors.containsKey(requestMessage.getProcessorId())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "087a20f160e7f411b1bfa7a138e0b58f60875a8f"}, "originalPosition": 94}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkyNTk5NQ==", "bodyText": "This class already has a map called\n/**\n   * ContainerStatuses of failed containers.\t   * ContainerStatuses of failed containers.\n   */\t \n  public final ConcurrentMap<String, SamzaResourceStatus> failedContainersStatus = new ConcurrentHashMap<>();\t \n\nCould we please reuse that?\nAlso the variable type can just be a Map<,> doesnt need to be ConcurrentHashMap", "url": "https://github.com/apache/samza/pull/1297#discussion_r387925995", "createdAt": "2020-03-04T20:49:47Z", "author": {"login": "rmatharu"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/SamzaApplicationState.java", "diffHunk": "@@ -110,7 +110,17 @@\n    */\n   public final ConcurrentMap<String, SamzaResource> runningProcessors = new ConcurrentHashMap<>(0);\n \n-   /**\n+  /**\n+   *  Map of the failed Samza processor ID to resource status of the last attempted of the container.\n+   *  This map is only used when {@link org.apache.samza.config.ClusterManagerConfig#CLUSTER_MANAGER_CONTAINER_FAIL_JOB_AFTER_RETRIES}\n+   *  is set to false, this map tracks the containers which have exhausted all retires for restart and JobCoordinator is\n+   *  no longer attempting to restart this container\n+   *\n+   *  Modified by both the AMRMCallbackThread and the ContainerAllocator thread\n+   */\n+  public final ConcurrentHashMap<String, SamzaResourceStatus> failedProcessors = new ConcurrentHashMap<>(0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "087a20f160e7f411b1bfa7a138e0b58f60875a8f"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54c4148a9d81ecf5430e60a1c65dc26afd68e221", "author": {"user": {"login": "Sanil15", "name": "Sanil Jain"}}, "url": "https://github.com/apache/samza/commit/54c4148a9d81ecf5430e60a1c65dc26afd68e221", "committedDate": "2020-03-05T22:44:43Z", "message": "Address comments and remove unused maps in samza"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "acb86bc5982afcda840137fb5030a4821bb55ea8", "author": {"user": {"login": "Sanil15", "name": "Sanil Jain"}}, "url": "https://github.com/apache/samza/commit/acb86bc5982afcda840137fb5030a4821bb55ea8", "committedDate": "2020-03-05T23:03:57Z", "message": "Merging master branch"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNDg5OTI0", "url": "https://github.com/apache/samza/pull/1297#pullrequestreview-370489924", "createdAt": "2020-03-06T17:14:31Z", "commit": {"oid": "acb86bc5982afcda840137fb5030a4821bb55ea8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxNzoxNDozMVrOFzAr1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxNzoxNDozMVrOFzAr1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTAzMjkxOQ==", "bodyText": "\"neither in running, pending or failed state\"", "url": "https://github.com/apache/samza/pull/1297#discussion_r389032919", "createdAt": "2020-03-06T17:14:31Z", "author": {"login": "rmatharu"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ContainerManager.java", "diffHunk": "@@ -486,9 +512,12 @@ private boolean deQueueAction(ContainerPlacementRequestMessage requestMessage) {\n     String errorMessagePrefix = ContainerPlacementMessage.StatusCode.BAD_REQUEST + \" reason: %s\";\n     Boolean invalidAction = false;\n     String errorMessage = null;\n-    if (!samzaApplicationState.runningProcessors.containsKey(requestMessage.getProcessorId()) &&\n-        !samzaApplicationState.pendingProcessors.containsKey(requestMessage.getProcessorId())\n-    ) {\n+\n+    boolean isRunning = samzaApplicationState.runningProcessors.containsKey(requestMessage.getProcessorId());\n+    boolean isPending = samzaApplicationState.pendingProcessors.containsKey(requestMessage.getProcessorId());\n+    boolean isFailed = samzaApplicationState.failedProcessors.containsKey(requestMessage.getProcessorId());\n+\n+    if (!isRunning && !isPending && !isFailed) {\n       errorMessage = String.format(errorMessagePrefix, \"invalid processor id neither in running or pending processors\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "acb86bc5982afcda840137fb5030a4821bb55ea8"}, "originalPosition": 103}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNTA4OTMz", "url": "https://github.com/apache/samza/pull/1297#pullrequestreview-370508933", "createdAt": "2020-03-06T17:44:55Z", "commit": {"oid": "acb86bc5982afcda840137fb5030a4821bb55ea8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxNzo0NDo1NVrOFzBqOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxNzo0NDo1NVrOFzBqOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTA0ODg4OA==", "bodyText": "This test is littered with thread.sleep and timeouts -- a typical recipe for flaky jarvis/test, and increasing build times.\nWould it be possible to reduce/consolidate them?", "url": "https://github.com/apache/samza/pull/1297#discussion_r389048888", "createdAt": "2020-03-06T17:44:55Z", "author": {"login": "rmatharu"}, "path": "samza-core/src/test/java/org/apache/samza/clustermanager/TestContainerPlacementActions.java", "diffHunk": "@@ -528,6 +528,124 @@ public Void answer(InvocationOnMock invocation) {\n     assertFalse(containerPlacementMetadataStore.readContainerPlacementRequestMessage(requestMessage.getUuid()).isPresent());\n   }\n \n+\n+  @Test(timeout = 20000)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "acb86bc5982afcda840137fb5030a4821bb55ea8"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNTEwOTMx", "url": "https://github.com/apache/samza/pull/1297#pullrequestreview-370510931", "createdAt": "2020-03-06T17:48:13Z", "commit": {"oid": "acb86bc5982afcda840137fb5030a4821bb55ea8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d8d34a9bb9ba4bff5718034b6529def06142b57", "author": {"user": {"login": "Sanil15", "name": "Sanil Jain"}}, "url": "https://github.com/apache/samza/commit/5d8d34a9bb9ba4bff5718034b6529def06142b57", "committedDate": "2020-03-09T18:30:33Z", "message": "Address feedback remove flaky assertions due to thread contention flakiness"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "800ca30e679857a620f146b342897e57a7b73097", "author": {"user": {"login": "Sanil15", "name": "Sanil Jain"}}, "url": "https://github.com/apache/samza/commit/800ca30e679857a620f146b342897e57a7b73097", "committedDate": "2020-03-09T18:58:31Z", "message": "Empty Commit to Trigger Build"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4799, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}