{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgxMTM4Mjg0", "number": 1296, "title": "SAMZA-2475: Add a allocated resource expiry timeout in samza yarn type of apps", "bodyText": "Changes: Today if samza apps are not able to use an allocated resource within\nyarn.resourcemanager.rm.container-allocation.expiry-interval-ms\nstart of the container fails with this exception, this can be avoided by just setting an allocated resource timeout check before issuing a start\nAPI Changes: Added isResourceExpired to ClusterResourceManager\nUpgrade Instructions: None\nUsage Instructions: None", "createdAt": "2020-02-28T00:19:06Z", "url": "https://github.com/apache/samza/pull/1296", "merged": true, "mergeCommit": {"oid": "3a6e48cc91d3e03e8fe17ab4283182fe4d3f98a5"}, "closed": true, "closedAt": "2020-03-04T20:27:57Z", "author": {"login": "Sanil15"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcI1P63AFqTM2NjYzOTI3NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKc7ZwgFqTM2OTA5ODAwNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2NjM5Mjc1", "url": "https://github.com/apache/samza/pull/1296#pullrequestreview-366639275", "createdAt": "2020-02-28T19:39:49Z", "commit": {"oid": "2a0a39da0a12b7f2fb762c5a29102f6c625aafc5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxOTozOTo0OVrOFwAliQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxOTozOTo0OVrOFwAliQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTg4NTU3Nw==", "bodyText": "javadoc please\nalso, this method likely belongs in SamzaResource?\n(if it really needs to be here, needs to be abstract)", "url": "https://github.com/apache/samza/pull/1296#discussion_r385885577", "createdAt": "2020-02-28T19:39:49Z", "author": {"login": "rmatharu"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ClusterResourceManager.java", "diffHunk": "@@ -132,6 +132,9 @@ public ClusterResourceManager(Callback callback) {\n \n   public abstract void stop(SamzaApplicationState.SamzaAppStatus status);\n \n+  public boolean isResourceExpired(SamzaResource resource) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a0a39da0a12b7f2fb762c5a29102f6c625aafc5"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2NjM5NDU3", "url": "https://github.com/apache/samza/pull/1296#pullrequestreview-366639457", "createdAt": "2020-02-28T19:40:09Z", "commit": {"oid": "2a0a39da0a12b7f2fb762c5a29102f6c625aafc5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxOTo0MDowOVrOFwAmBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxOTo0MDowOVrOFwAmBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTg4NTcwMg==", "bodyText": "resource.isExpired()", "url": "https://github.com/apache/samza/pull/1296#discussion_r385885702", "createdAt": "2020-02-28T19:40:09Z", "author": {"login": "rmatharu"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ContainerAllocator.java", "diffHunk": "@@ -261,6 +261,14 @@ protected void runStreamProcessor(SamzaResourceRequest request, String preferred\n       throw new SamzaException(\"Expected resource for Processor ID: \" + request.getProcessorId() + \" was unavailable on host: \" + preferredHost);\n     }\n \n+    if(clusterResourceManager.isResourceExpired(resource)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a0a39da0a12b7f2fb762c5a29102f6c625aafc5"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2NjM5OTEw", "url": "https://github.com/apache/samza/pull/1296#pullrequestreview-366639910", "createdAt": "2020-02-28T19:40:57Z", "commit": {"oid": "2a0a39da0a12b7f2fb762c5a29102f6c625aafc5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxOTo0MDo1N1rOFwAngA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxOTo0MDo1N1rOFwAngA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTg4NjA4MA==", "bodyText": "Resource has expired, re-requesting resource for ..... processorId:\nHaving the processorId: pattern in the logs makes for easy searcheability when we're debugging", "url": "https://github.com/apache/samza/pull/1296#discussion_r385886080", "createdAt": "2020-02-28T19:40:57Z", "author": {"login": "rmatharu"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ContainerAllocator.java", "diffHunk": "@@ -261,6 +261,14 @@ protected void runStreamProcessor(SamzaResourceRequest request, String preferred\n       throw new SamzaException(\"Expected resource for Processor ID: \" + request.getProcessorId() + \" was unavailable on host: \" + preferredHost);\n     }\n \n+    if(clusterResourceManager.isResourceExpired(resource)) {\n+      LOG.info(\"Lease for the resource has been expired for resource: {} request: {}\", resource, request);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a0a39da0a12b7f2fb762c5a29102f6c625aafc5"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2NjQxMDI5", "url": "https://github.com/apache/samza/pull/1296#pullrequestreview-366641029", "createdAt": "2020-02-28T19:42:58Z", "commit": {"oid": "2a0a39da0a12b7f2fb762c5a29102f6c625aafc5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxOTo0Mjo1OFrOFwArEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxOTo0Mjo1OFrOFwArEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTg4Njk5NQ==", "bodyText": "Could DEFAULT_RM_CONTAINER_ALLOC_EXPIRY_INTERVAL_MS be a Duration?\nDuration.between(resource.getTS, Instant.now()).compareTo(DEFAULT_RM_CONTAINER_ALLOC_EXPIRY_INTERVAL_MS) > 0;", "url": "https://github.com/apache/samza/pull/1296#discussion_r385886995", "createdAt": "2020-02-28T19:42:58Z", "author": {"login": "rmatharu"}, "path": "samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnClusterResourceManager.java", "diffHunk": "@@ -575,6 +576,15 @@ public void onStopContainerError(ContainerId containerId, Throwable t) {\n     }\n   }\n \n+  @Override\n+  public boolean isResourceExpired(SamzaResource resource) {\n+    /**\n+     * Time from which resource was allocated + 1 min (to account for clock skew) > Yarn Expiry Timeout\n+     */\n+    return System.currentTimeMillis() - resource.getTimestamp() + Duration.ofMinutes(1).toMillis()\n+        > YarnConfiguration.DEFAULT_RM_CONTAINER_ALLOC_EXPIRY_INTERVAL_MS;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a0a39da0a12b7f2fb762c5a29102f6c625aafc5"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2NjQxMTEx", "url": "https://github.com/apache/samza/pull/1296#pullrequestreview-366641111", "createdAt": "2020-02-28T19:43:06Z", "commit": {"oid": "2a0a39da0a12b7f2fb762c5a29102f6c625aafc5"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4eb8cb905998a5104d88ffa7922b4da628f25e7a", "author": {"user": {"login": "Sanil15", "name": "Sanil Jain"}}, "url": "https://github.com/apache/samza/commit/4eb8cb905998a5104d88ffa7922b4da628f25e7a", "committedDate": "2020-03-03T00:25:57Z", "message": "Expiry check for allocated resources"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2a0a39da0a12b7f2fb762c5a29102f6c625aafc5", "author": {"user": {"login": "Sanil15", "name": "Sanil Jain"}}, "url": "https://github.com/apache/samza/commit/2a0a39da0a12b7f2fb762c5a29102f6c625aafc5", "committedDate": "2020-02-28T00:12:42Z", "message": "Expiry check for allocated resources"}, "afterCommit": {"oid": "4eb8cb905998a5104d88ffa7922b4da628f25e7a", "author": {"user": {"login": "Sanil15", "name": "Sanil Jain"}}, "url": "https://github.com/apache/samza/commit/4eb8cb905998a5104d88ffa7922b4da628f25e7a", "committedDate": "2020-03-03T00:25:57Z", "message": "Expiry check for allocated resources"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0c25aaf35699ddd3a42bab694ef19307f6d3066", "author": {"user": {"login": "Sanil15", "name": "Sanil Jain"}}, "url": "https://github.com/apache/samza/commit/e0c25aaf35699ddd3a42bab694ef19307f6d3066", "committedDate": "2020-03-03T02:16:49Z", "message": "Configure timeout using Yarn default"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4MTg3OTkw", "url": "https://github.com/apache/samza/pull/1296#pullrequestreview-368187990", "createdAt": "2020-03-03T17:41:44Z", "commit": {"oid": "e0c25aaf35699ddd3a42bab694ef19307f6d3066"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxNzo0MTo0NVrOFxP6Qg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxNzo0Mjo1M1rOFxP8mQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE4NTIxOA==", "bodyText": "\"has expired\"  \"{}. Re-requesting again\"", "url": "https://github.com/apache/samza/pull/1296#discussion_r387185218", "createdAt": "2020-03-03T17:41:45Z", "author": {"login": "prateekm"}, "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ContainerManager.java", "diffHunk": "@@ -290,6 +290,29 @@ void handleExpiredRequest(String processorId, String preferredHost,\n     }\n   }\n \n+  /**\n+   * Handles expired allocated resource by requesting the same resource again and release the expired allocated resource\n+   *\n+   * @param request pending request for the preferred host\n+   * @param resource resource allocated from {@link ClusterResourceManager} which has expired\n+   * @param preferredHost host on which container is requested to be deployed\n+   * @param resourceRequestState state of request in {@link ContainerAllocator}\n+   * @param allocator allocator for requesting resources\n+   */\n+  void handleExpiredResource(SamzaResourceRequest request, SamzaResource resource, String preferredHost,\n+      ResourceRequestState resourceRequestState, ContainerAllocator allocator) {\n+    LOG.info(\"Allocated resource {} has been expired for Processor ID: {} request: {} re-requesting resource again\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0c25aaf35699ddd3a42bab694ef19307f6d3066"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE4NTgxNw==", "bodyText": "Use // for comments inside methods, not /*. IntelliJ warns about dangling javadocs for these.", "url": "https://github.com/apache/samza/pull/1296#discussion_r387185817", "createdAt": "2020-03-03T17:42:53Z", "author": {"login": "prateekm"}, "path": "samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnClusterResourceManager.java", "diffHunk": "@@ -575,6 +576,17 @@ public void onStopContainerError(ContainerId containerId, Throwable t) {\n     }\n   }\n \n+  @Override\n+  public boolean isResourceExpired(SamzaResource resource) {\n+    /**", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0c25aaf35699ddd3a42bab694ef19307f6d3066"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b49d2213187116126e3af6ff3eb86479309c610", "author": {"user": {"login": "Sanil15", "name": "Sanil Jain"}}, "url": "https://github.com/apache/samza/commit/1b49d2213187116126e3af6ff3eb86479309c610", "committedDate": "2020-03-03T18:06:31Z", "message": "Address feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a1a4a3e12ce4af1d8af734fb6aa1a8b77e9b812", "author": {"user": {"login": "Sanil15", "name": "Sanil Jain"}}, "url": "https://github.com/apache/samza/commit/9a1a4a3e12ce4af1d8af734fb6aa1a8b77e9b812", "committedDate": "2020-03-03T18:17:11Z", "message": "Issuing correct resource request"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MDk4MDA3", "url": "https://github.com/apache/samza/pull/1296#pullrequestreview-369098007", "createdAt": "2020-03-04T20:27:33Z", "commit": {"oid": "9a1a4a3e12ce4af1d8af734fb6aa1a8b77e9b812"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4796, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}