{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA3Mzg0NDAx", "number": 504, "title": "Repeating grp fix", "bodyText": "Updates the logic to update the repeating group count object", "createdAt": "2020-10-21T09:18:13Z", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/504", "merged": true, "mergeCommit": {"oid": "dbd4e530e590ddca6d715e3c67fa236433136595"}, "closed": true, "closedAt": "2020-10-29T14:30:33Z", "author": {"login": "bennsimon"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSDq62AH2gAyNTA3Mzg0NDAxOmZjMzg1NDNkYzZiOGVhOGFiNmJmMjI4ODg2MmRlMzBiOWRiMzIyYTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXTA_HAFqTUxOTcyMjQ5Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fc38543dc6b8ea8ab6bf2288862de30b9db322a2", "author": {"user": {"login": "bennsimon", "name": "Benn Simon"}}, "url": "https://github.com/opensrp/opensrp-client-native-form/commit/fc38543dc6b8ea8ab6bf2288862de30b9db322a2", "committedDate": "2020-10-13T07:44:28Z", "message": "implement feeedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4392e20851fb8d56373ba20ef2bb1d57ed3834d1", "author": {"user": {"login": "bennsimon", "name": "Benn Simon"}}, "url": "https://github.com/opensrp/opensrp-client-native-form/commit/4392e20851fb8d56373ba20ef2bb1d57ed3834d1", "committedDate": "2020-10-21T08:27:44Z", "message": "Merge branch 'optimize-native-forms' into repeating_grp_fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1aad2ab5f579babfc81ec1f18998078060fd098", "author": {"user": {"login": "bennsimon", "name": "Benn Simon"}}, "url": "https://github.com/opensrp/opensrp-client-native-form/commit/f1aad2ab5f579babfc81ec1f18998078060fd098", "committedDate": "2020-10-21T09:16:40Z", "message": "update repeating grp done action with new logic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "504f0a588d4b47724c9b254923da7cf314feb156", "author": {"user": {"login": "bennsimon", "name": "Benn Simon"}}, "url": "https://github.com/opensrp/opensrp-client-native-form/commit/504f0a588d4b47724c9b254923da7cf314feb156", "committedDate": "2020-10-21T09:24:54Z", "message": "fix code when updating the repeating grp count"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "054bd64b23902cc49a7f31dc08a98b7a8fdf8bf8", "author": {"user": {"login": "bennsimon", "name": "Benn Simon"}}, "url": "https://github.com/opensrp/opensrp-client-native-form/commit/054bd64b23902cc49a7f31dc08a98b7a8fdf8bf8", "committedDate": "2020-10-23T06:18:42Z", "message": "fix test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2ODU1OTM4", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/504#pullrequestreview-516855938", "createdAt": "2020-10-26T14:49:12Z", "commit": {"oid": "054bd64b23902cc49a7f31dc08a98b7a8fdf8bf8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNDo0OToxMlrOHoTKiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNDo0OToxMlrOHoTKiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAxOTA4MA==", "bodyText": "Not sure why this is +=. In the case that the value in the reference edit text changes, shouldn't the new value be the new number of repeating groups generated?\nThe logic atm looks at the difference and either generates extra groups for a +ve diff or deletes excess groups for a -ve diff.", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/504#discussion_r512019080", "createdAt": "2020-10-26T14:49:12Z", "author": {"login": "vincent-karuri"}, "path": "android-json-form-wizard/src/main/java/com/vijay/jsonwizard/task/AttachRepeatingGroupTask.java", "diffHunk": "@@ -82,14 +82,35 @@ protected void onPreExecute() {\n         diff = numRepeatingGroups - currNumRepeatingGroups;\n         for (int i = 0; i < diff; i++) {\n             try {\n+\n                 repeatingGroups.add(buildRepeatingGroupLayout(parent));\n+\n             } catch (Exception e) {\n                 Timber.e(e);\n             }\n         }\n+\n+        updateRepeatingGrpCountObject();\n+\n         return repeatingGroups;\n     }\n \n+    private void updateRepeatingGrpCountObject() {\n+        try {\n+            JSONObject countFieldObject = Utils.getRepeatingGroupCountObj(widgetArgs);\n+            if (countFieldObject != null) {\n+                int currentCount = numRepeatingGroups;\n+                String strNumOfRepeatedGroups = countFieldObject.optString(VALUE);\n+                if (StringUtils.isNotBlank(strNumOfRepeatedGroups)) {\n+                    currentCount += Integer.parseInt(strNumOfRepeatedGroups);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "054bd64b23902cc49a7f31dc08a98b7a8fdf8bf8"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2ODU4NjMz", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/504#pullrequestreview-516858633", "createdAt": "2020-10-26T14:51:35Z", "commit": {"oid": "054bd64b23902cc49a7f31dc08a98b7a8fdf8bf8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNDo1MTozNVrOHoTScQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNDo1MTozNVrOHoTScQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAyMTEwNQ==", "bodyText": "Do we need the else block? Is there ever an instance when stepJsonObject is null?", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/504#discussion_r512021105", "createdAt": "2020-10-26T14:51:35Z", "author": {"login": "vincent-karuri"}, "path": "android-json-form-wizard/src/main/java/com/vijay/jsonwizard/utils/Utils.java", "diffHunk": "@@ -874,6 +882,38 @@ public static int getResourceId(Context context, String name, ResourceType resou\n     public static boolean isEmptyJsonArray(JSONArray jsonArray) {\n         return jsonArray == null || jsonArray.length() == 0;\n     }\n+\n+    /**\n+     * Returns the object that holds the repeating group count\n+     *\n+     * @return\n+     * @throws JSONException\n+     */\n+    @Nullable\n+    public static JSONObject getRepeatingGroupCountObj(@NotNull WidgetArgs widgetArgs) throws JSONException {\n+        String repeatingGroupCountObjKey = widgetArgs.getJsonObject().get(KEY) + \"_count\";\n+        JSONObject stepJsonObject = widgetArgs.getFormFragment().getStep(widgetArgs.getStepName());\n+        if (stepJsonObject != null) {\n+            JSONArray stepFields = stepJsonObject.optJSONArray(JsonFormConstants.FIELDS);\n+            JSONObject repeatingGroupCountObj = FormUtils.getFieldJSONObject(stepFields, repeatingGroupCountObjKey);\n+            // prevents re-adding the count object during form traversals\n+            if (repeatingGroupCountObj != null) {\n+                return repeatingGroupCountObj;\n+            }\n+\n+            repeatingGroupCountObj = new JSONObject();\n+            repeatingGroupCountObj.put(KEY, repeatingGroupCountObjKey);\n+            repeatingGroupCountObj.put(OPENMRS_ENTITY_PARENT, \"\");\n+            repeatingGroupCountObj.put(OPENMRS_ENTITY, \"\");\n+            repeatingGroupCountObj.put(OPENMRS_ENTITY_ID, \"\");\n+            repeatingGroupCountObj.put(TYPE, \"\");\n+            repeatingGroupCountObj.put(TEXT, widgetArgs.getJsonObject().get(REFERENCE_EDIT_TEXT_HINT));\n+            stepFields.put(repeatingGroupCountObj);\n+            return repeatingGroupCountObj;\n+        } else {\n+            return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "054bd64b23902cc49a7f31dc08a98b7a8fdf8bf8"}, "originalPosition": 56}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2ODYyMjY2", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/504#pullrequestreview-516862266", "createdAt": "2020-10-26T14:55:06Z", "commit": {"oid": "054bd64b23902cc49a7f31dc08a98b7a8fdf8bf8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNDo1NTowNlrOHoTdRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNDo1NTowNlrOHoTdRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAyMzg3OA==", "bodyText": "Based on https://github.com/OpenSRP/opensrp-client-native-form/pull/504/files#r512021105. Should countFieldObject ever be null?", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/504#discussion_r512023878", "createdAt": "2020-10-26T14:55:06Z", "author": {"login": "vincent-karuri"}, "path": "android-json-form-wizard/src/main/java/com/vijay/jsonwizard/widgets/RepeatingGroupFactory.java", "diffHunk": "@@ -106,30 +99,33 @@\n \n         setRepeatingGroupNumLimits(widgetArgs);\n \n+        JSONObject countFieldObject = Utils.getRepeatingGroupCountObj(widgetArgs);\n+\n         //get the generated number of groups\n-        final String generatedGroupsCount = jsonObject.optString(REPEATING_GROUPS_GENERATED_COUNT);\n+        final String generatedGroupsCount = countFieldObject != null ? countFieldObject.optString(VALUE) : \"\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "054bd64b23902cc49a7f31dc08a98b7a8fdf8bf8"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2ODY1NTc1", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/504#pullrequestreview-516865575", "createdAt": "2020-10-26T14:58:05Z", "commit": {"oid": "054bd64b23902cc49a7f31dc08a98b7a8fdf8bf8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNDo1ODowNVrOHoTmnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNDo1ODowNVrOHoTmnQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAyNjI2OQ==", "bodyText": "Any reason to remove this? This was recommended as a better user experience by Roger onaio/rdt-standard#319 (comment).", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/504#discussion_r512026269", "createdAt": "2020-10-26T14:58:05Z", "author": {"login": "vincent-karuri"}, "path": "android-json-form-wizard/src/main/java/com/vijay/jsonwizard/widgets/RepeatingGroupFactory.java", "diffHunk": "@@ -327,15 +295,6 @@ public boolean onEditorAction(TextView focusTextView, int actionId, KeyEvent eve\n                     return false;\n                 }\n             });\n-            // generate repeating groups on focus change\n-            referenceEditText.setOnFocusChangeListener(new View.OnFocusChangeListener() {\n-                @Override\n-                public void onFocusChange(View view, boolean hasFocus) {\n-                    if (!hasFocus) {\n-                        addOnDoneAction((TextView) view, doneButton, widgetArgs);\n-                    }\n-                }\n-            });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "054bd64b23902cc49a7f31dc08a98b7a8fdf8bf8"}, "originalPosition": 123}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2ODY3NzA2", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/504#pullrequestreview-516867706", "createdAt": "2020-10-26T15:00:03Z", "commit": {"oid": "054bd64b23902cc49a7f31dc08a98b7a8fdf8bf8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNTowMDowNFrOHoTtkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNTowMDowNFrOHoTtkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAyODA0OQ==", "bodyText": "I see the logic to write into the count object was moved but is the validation still being done? i.e. is JsonFormFragmentPresenter .validate(widgetArgs.getFormFragment(), referenceEditText, false); still called?", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/504#discussion_r512028049", "createdAt": "2020-10-26T15:00:04Z", "author": {"login": "vincent-karuri"}, "path": "android-json-form-wizard/src/main/java/com/vijay/jsonwizard/widgets/RepeatingGroupFactory.java", "diffHunk": "@@ -377,23 +336,10 @@ public void onTextChanged(CharSequence s, int start, int before, int count) {\n             @Override\n             public void afterTextChanged(Editable s) {\n                 doneButton.setImageResource(R.drawable.ic_done_grey);\n-                ValidationStatus validationStatus = JsonFormFragmentPresenter\n-                        .validate(widgetArgs.getFormFragment(), referenceEditText, false);\n-                if (validationStatus.isValid()) {\n-                    writeJsonObjectValue(repeatingGroupCount, s.toString());\n-                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "054bd64b23902cc49a7f31dc08a98b7a8fdf8bf8"}, "originalPosition": 135}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "535729d20c144e2bff4b6101c834a81340df64bd", "author": {"user": {"login": "bennsimon", "name": "Benn Simon"}}, "url": "https://github.com/opensrp/opensrp-client-native-form/commit/535729d20c144e2bff4b6101c834a81340df64bd", "committedDate": "2020-10-27T06:36:38Z", "message": "update code based on feedback"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f4ed03a4716f0d0ff7fd3c624123294058b59615", "author": {"user": {"login": "bennsimon", "name": "Benn Simon"}}, "url": "https://github.com/opensrp/opensrp-client-native-form/commit/f4ed03a4716f0d0ff7fd3c624123294058b59615", "committedDate": "2020-10-29T12:47:16Z", "message": "add onFocus change generation config"}, "afterCommit": {"oid": "535729d20c144e2bff4b6101c834a81340df64bd", "author": {"user": {"login": "bennsimon", "name": "Benn Simon"}}, "url": "https://github.com/opensrp/opensrp-client-native-form/commit/535729d20c144e2bff4b6101c834a81340df64bd", "committedDate": "2020-10-27T06:36:38Z", "message": "update code based on feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22af1cc0e32958845608af752ed481e565396708", "author": {"user": {"login": "bennsimon", "name": "Benn Simon"}}, "url": "https://github.com/opensrp/opensrp-client-native-form/commit/22af1cc0e32958845608af752ed481e565396708", "committedDate": "2020-10-29T13:29:45Z", "message": "cleanup code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5NzIyNDky", "url": "https://github.com/opensrp/opensrp-client-native-form/pull/504#pullrequestreview-519722492", "createdAt": "2020-10-29T14:26:46Z", "commit": {"oid": "22af1cc0e32958845608af752ed481e565396708"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2330, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}