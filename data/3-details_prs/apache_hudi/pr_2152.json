{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk5NTkwMzQ4", "number": 2152, "title": "[HUDI-1326] Added an API to force publish metrics and flush them.", "bodyText": "Using the added API, publish metrics after each level of the DAG completed in hudi-test-suite.\nWhat is the purpose of the pull request\nHUDI metrics are published at two stages:\n\nWhen an action completed (e.g. HoodieMetrics.updateCommitMetrics)\nWhen the JVM is shutdown (Metrics.java addShutdownHook)\n\nhudi-test-suite includes multiple jobs each of which is an action on the table. All these jobs are run in a single JVM. Hence, currently some metrics are not published till the entire hudi-test-suite run is over.\nEnhancements:\n\nAllow metrics to be published after each job\nFlush metrics so redundant metrics (from the last job) are not published again.\n\nBrief change log\nAdded Metrics.flush()\nVerify this pull request\nThis pull request is a trivial rework / code cleanup without any test coverage.\nCommitter checklist\n\n\n Has a corresponding JIRA in PR title & commit\n\n\n Commit message is descriptive of the change\n\n\n CI is green\n\n\n Necessary doc changes done or have another open PR\n\n\n For large changes, please consider breaking it into sub-tasks under an umbrella JIRA.", "createdAt": "2020-10-08T00:42:26Z", "url": "https://github.com/apache/hudi/pull/2152", "merged": true, "mergeCommit": {"oid": "49e855c3488ebe53af3a72fc3b5a22ba47a45e01"}, "closed": true, "closedAt": "2020-10-24T23:47:24Z", "author": {"login": "prashantwason"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQuPtegFqTUwNTM1MjEyOQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdVyxyogFqTUxMzMzOTQ3OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1MzUyMTI5", "url": "https://github.com/apache/hudi/pull/2152#pullrequestreview-505352129", "createdAt": "2020-10-09T04:12:49Z", "commit": {"oid": "45d75c6ad92d9a4ee0478c9c3703b74ebd8fc738"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwNDoxMjo0OVrOHe6nAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwNDoxMjo0OVrOHe6nAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE3OTU4NA==", "bodyText": "Can we do LOG.error ?", "url": "https://github.com/apache/hudi/pull/2152#discussion_r502179584", "createdAt": "2020-10-09T04:12:49Z", "author": {"login": "n3nash"}, "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/metrics/Metrics.java", "diffHunk": "@@ -68,8 +69,20 @@ private void reportAndCloseReporter() {\n     }\n   }\n \n+  private void reportAndFlushMetrics() {\n+    try {\n+      LOG.info(\"Reporting and flushing all metrics\");\n+\n+      this.registerHoodieCommonMetrics();\n+      this.reporter.report();\n+      this.registry.getNames().forEach(name -> this.registry.remove(name));\n+    } catch (Exception e) {\n+      Metrics.LOG.warn((Object)\"Error while reporting and flushing metrics\", (Throwable)e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "45d75c6ad92d9a4ee0478c9c3703b74ebd8fc738"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1MzUyMjc2", "url": "https://github.com/apache/hudi/pull/2152#pullrequestreview-505352276", "createdAt": "2020-10-09T04:13:28Z", "commit": {"oid": "45d75c6ad92d9a4ee0478c9c3703b74ebd8fc738"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwNDoxMzoyOFrOHe6nig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwNDoxMzoyOFrOHe6nig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE3OTcyMg==", "bodyText": "What should be the right expectation if it's not initialized ? Simply returning gives a false impression to the client that it's flushed.", "url": "https://github.com/apache/hudi/pull/2152#discussion_r502179722", "createdAt": "2020-10-09T04:13:28Z", "author": {"login": "n3nash"}, "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/metrics/Metrics.java", "diffHunk": "@@ -97,6 +110,14 @@ public static synchronized void shutdown() {\n     initialized = false;\n   }\n \n+  public static synchronized void flush() {\n+    if (!Metrics.initialized) {\n+      return;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "45d75c6ad92d9a4ee0478c9c3703b74ebd8fc738"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "306bf62c3f0b80da791788ca9ddacc1aef9ea6a5", "author": {"user": {"login": "prashantwason", "name": "Prashant Wason"}}, "url": "https://github.com/apache/hudi/commit/306bf62c3f0b80da791788ca9ddacc1aef9ea6a5", "committedDate": "2020-10-22T06:42:14Z", "message": "[HUDI-1326] Added an API to force publish metrics and flush them.\n\nUsing the added API, publish metrics after each level of the DAG completed in hudi-test-suite."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "45d75c6ad92d9a4ee0478c9c3703b74ebd8fc738", "author": {"user": {"login": "prashantwason", "name": "Prashant Wason"}}, "url": "https://github.com/apache/hudi/commit/45d75c6ad92d9a4ee0478c9c3703b74ebd8fc738", "committedDate": "2020-10-08T00:40:20Z", "message": "[HUDI-1326] Added an API to force publish metrics and flush them.\n\nUsing the added API, publish metrics after each level of the DAG completed in hudi-test-suite."}, "afterCommit": {"oid": "306bf62c3f0b80da791788ca9ddacc1aef9ea6a5", "author": {"user": {"login": "prashantwason", "name": "Prashant Wason"}}, "url": "https://github.com/apache/hudi/commit/306bf62c3f0b80da791788ca9ddacc1aef9ea6a5", "committedDate": "2020-10-22T06:42:14Z", "message": "[HUDI-1326] Added an API to force publish metrics and flush them.\n\nUsing the added API, publish metrics after each level of the DAG completed in hudi-test-suite."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd02a8bfd91146c3ea35988b8760799c27191769", "author": {"user": {"login": "vinothchandar", "name": "vinoth chandar"}}, "url": "https://github.com/apache/hudi/commit/cd02a8bfd91146c3ea35988b8760799c27191769", "committedDate": "2020-10-24T22:18:11Z", "message": "Code cleanups"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzMzM5NDc4", "url": "https://github.com/apache/hudi/pull/2152#pullrequestreview-513339478", "createdAt": "2020-10-21T06:22:38Z", "commit": {"oid": "45d75c6ad92d9a4ee0478c9c3703b74ebd8fc738"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQwNjoyMjozOFrOHlb7dQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQwNjoyMjozOFrOHlb7dQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTAxNjk0OQ==", "bodyText": "+1", "url": "https://github.com/apache/hudi/pull/2152#discussion_r509016949", "createdAt": "2020-10-21T06:22:38Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/metrics/Metrics.java", "diffHunk": "@@ -68,8 +69,20 @@ private void reportAndCloseReporter() {\n     }\n   }\n \n+  private void reportAndFlushMetrics() {\n+    try {\n+      LOG.info(\"Reporting and flushing all metrics\");\n+\n+      this.registerHoodieCommonMetrics();\n+      this.reporter.report();\n+      this.registry.getNames().forEach(name -> this.registry.remove(name));\n+    } catch (Exception e) {\n+      Metrics.LOG.warn((Object)\"Error while reporting and flushing metrics\", (Throwable)e);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE3OTU4NA=="}, "originalCommit": {"oid": "45d75c6ad92d9a4ee0478c9c3703b74ebd8fc738"}, "originalPosition": 25}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4656, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}