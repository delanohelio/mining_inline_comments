{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAzMzczMTE1", "number": 1513, "title": "[HUDI-793] Adding proper default to hudi metadata fields and proper handling to rewrite routine", "bodyText": "#1027  What is the purpose of the pull request\nFixing issue with avro and default. Current implementation doesn't set correct default fields when adding hudi metadata and also fails if record's schema has them set to:\n\"default\": null\nBrief change log\n\n*Modified HoodieAvroUtils\n\nVerify this pull request\nI added default to the already existing test.\nCommitter checklist\n\n\n Has a corresponding JIRA in PR title & commit\n\n\n Commit message is descriptive of the change\n\n\n CI is green\n\n\n Necessary doc changes done or have another open PR\n\n\n For large changes, please consider breaking it into sub-tasks under an umbrella JIRA.", "createdAt": "2020-04-14T19:31:36Z", "url": "https://github.com/apache/hudi/pull/1513", "merged": true, "mergeCommit": {"oid": "83796b3189570182c68a9c41e57b356124c301ca"}, "closed": true, "closedAt": "2020-05-14T01:04:39Z", "author": {"login": "afilipchik"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcXpuzPAFqTM5MzI4MDc2Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABchC1oDAFqTQxMTM5ODA1Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzMjgwNzY3", "url": "https://github.com/apache/hudi/pull/1513#pullrequestreview-393280767", "createdAt": "2020-04-14T20:43:33Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQyMDo0MzozNFrOGFgLBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQyMDo0MzozNFrOGFgLBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQyMzE3NQ==", "bodyText": "By doing this change, we are effectively going back to deprecated constructors again. Can you please explain the purpose of doing this?", "url": "https://github.com/apache/hudi/pull/1513#discussion_r408423175", "createdAt": "2020-04-14T20:43:34Z", "author": {"login": "pratyakshsharma"}, "path": "hudi-common/src/main/java/org/apache/hudi/avro/HoodieAvroUtils.java", "diffHunk": "@@ -104,15 +105,15 @@ public static Schema addMetadataFields(Schema schema) {\n     List<Schema.Field> parentFields = new ArrayList<>();\n \n     Schema.Field commitTimeField =\n-        new Schema.Field(HoodieRecord.COMMIT_TIME_METADATA_FIELD, METADATA_FIELD_SCHEMA, \"\", (Object) null);\n+        new Schema.Field(HoodieRecord.COMMIT_TIME_METADATA_FIELD, METADATA_FIELD_SCHEMA, \"\", NullNode.getInstance());\n     Schema.Field commitSeqnoField =\n-        new Schema.Field(HoodieRecord.COMMIT_SEQNO_METADATA_FIELD, METADATA_FIELD_SCHEMA, \"\", (Object) null);\n+        new Schema.Field(HoodieRecord.COMMIT_SEQNO_METADATA_FIELD, METADATA_FIELD_SCHEMA, \"\", NullNode.getInstance());\n     Schema.Field recordKeyField =\n-        new Schema.Field(HoodieRecord.RECORD_KEY_METADATA_FIELD, METADATA_FIELD_SCHEMA, \"\", (Object) null);\n+        new Schema.Field(HoodieRecord.RECORD_KEY_METADATA_FIELD, METADATA_FIELD_SCHEMA, \"\", NullNode.getInstance());\n     Schema.Field partitionPathField =\n-        new Schema.Field(HoodieRecord.PARTITION_PATH_METADATA_FIELD, METADATA_FIELD_SCHEMA, \"\", (Object) null);\n+        new Schema.Field(HoodieRecord.PARTITION_PATH_METADATA_FIELD, METADATA_FIELD_SCHEMA, \"\", NullNode.getInstance());\n     Schema.Field fileNameField =\n-        new Schema.Field(HoodieRecord.FILENAME_METADATA_FIELD, METADATA_FIELD_SCHEMA, \"\", (Object) null);\n+        new Schema.Field(HoodieRecord.FILENAME_METADATA_FIELD, METADATA_FIELD_SCHEMA, \"\", NullNode.getInstance());", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzMjgzNDc4", "url": "https://github.com/apache/hudi/pull/1513#pullrequestreview-393283478", "createdAt": "2020-04-14T20:47:44Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQyMDo0Nzo0NFrOGFgTnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQyMDo0Nzo0NFrOGFgTnQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQyNTM3Mw==", "bodyText": "Why do you need this? If f.defaultVal() is null, it will be automatically populated like that.", "url": "https://github.com/apache/hudi/pull/1513#discussion_r408425373", "createdAt": "2020-04-14T20:47:44Z", "author": {"login": "pratyakshsharma"}, "path": "hudi-common/src/main/java/org/apache/hudi/avro/HoodieAvroUtils.java", "diffHunk": "@@ -206,7 +207,11 @@ private static GenericRecord rewrite(GenericRecord record, LinkedHashSet<Field>\n     GenericRecord newRecord = new GenericData.Record(newSchema);\n     for (Schema.Field f : fieldsToWrite) {\n       if (record.get(f.name()) == null) {\n-        newRecord.put(f.name(), f.defaultVal());\n+        if (f.defaultVal() instanceof Null) {\n+          newRecord.put(f.name(), null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9bccd32376962ae43997cd1510f6b2baa488492e", "author": {"user": null}, "url": "https://github.com/apache/hudi/commit/9bccd32376962ae43997cd1510f6b2baa488492e", "committedDate": "2020-04-20T22:19:25Z", "message": "Adding proper default to hudi metadata fields and proper handling to rewrite routine"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e208a6e95f93b106fb219f30b4deccd6dab1f84", "author": {"user": null}, "url": "https://github.com/apache/hudi/commit/8e208a6e95f93b106fb219f30b4deccd6dab1f84", "committedDate": "2020-04-20T22:19:26Z", "message": "Force spark to generate nullables"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97fbcf55a6dcf423ba30a5e03ca6dc5e3b0d32fb", "author": {"user": null}, "url": "https://github.com/apache/hudi/commit/97fbcf55a6dcf423ba30a5e03ca6dc5e3b0d32fb", "committedDate": "2020-04-20T22:19:26Z", "message": "Removed nullables as spark generates broken schema :("}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "97fbcf55a6dcf423ba30a5e03ca6dc5e3b0d32fb", "author": {"user": null}, "url": "https://github.com/apache/hudi/commit/97fbcf55a6dcf423ba30a5e03ca6dc5e3b0d32fb", "committedDate": "2020-04-20T22:19:26Z", "message": "Removed nullables as spark generates broken schema :("}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMzk4MDU2", "url": "https://github.com/apache/hudi/pull/1513#pullrequestreview-411398056", "createdAt": "2020-05-14T01:03:58Z", "commit": {"oid": "97fbcf55a6dcf423ba30a5e03ca6dc5e3b0d32fb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3384, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}