{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc2MTUwNTk3", "number": 2056, "title": "[HUDI-1255] Add new Payload(OverwriteNonDefaultsWithLatestAvroPayload) for updating specified fields in storage", "bodyText": "Tips\n\nThank you very much for contributing to Apache Hudi.\nPlease review https://hudi.apache.org/contributing.html before opening a pull request.\n\nWhat is the purpose of the pull request\nAdd new Payload(OverwriteNonDefaultsWithLatestAvroPayload) for updating specified fields in storage\nBrief change log\nupdate current value for several fields that you want to change.\nThe default payload OverwriteWithLatestAvroPayload overwrite the whole record when\ncompared to orderingVal.This doesn't meet our need when we just want to change specified fields.\nFor example: (suppose Default value is null)\ncurrent Value \nField:      name   age   gender\nValue:     karl     20    male\n\ninsert Value\nField:      name   age   gender\nValue:     null     30    null\n\nAfter insert:\nField:      name   age   gender\nValue:     karl     30    male\n\nVerify this pull request\nAdded TestOverwriteNonDefaultsWithLatestAvroPayload to verify the change.\nCommitter checklist\n\n\n  Has a corresponding JIRA in PR title & commit\n\n\n Commit message is descriptive of the change\n\n\n CI is green\n\n\n Necessary doc changes done or have another open PR\n\n\n For large changes, please consider breaking it into sub-tasks under an umbrella JIRA.", "createdAt": "2020-08-31T08:34:14Z", "url": "https://github.com/apache/hudi/pull/2056", "merged": true, "mergeCommit": {"oid": "a1cff8abae9d9dab87d439c90451da73cc71eebf"}, "closed": true, "closedAt": "2020-09-10T04:54:22Z", "author": {"login": "Karl-WangSK"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdEOTvfAH2gAyNDc2MTUwNTk3OjkxYjZiZjJhY2UxNTAzZWJiMzEzM2IzMTJhNTFlZDA0YzMzOWUyYTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHZcNwgFqTQ4NTU2NzQzOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "91b6bf2ace1503ebb3133b312a51ed04c339e2a3", "author": {"user": {"login": "Karl-WangSK", "name": "Karl_Wang"}}, "url": "https://github.com/apache/hudi/commit/91b6bf2ace1503ebb3133b312a51ed04c339e2a3", "committedDate": "2020-08-31T08:13:10Z", "message": "add new Payload for updating specified fields in storage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a99f33168bcbe9be29cbb6411541184638db44e", "author": {"user": {"login": "Karl-WangSK", "name": "Karl_Wang"}}, "url": "https://github.com/apache/hudi/commit/4a99f33168bcbe9be29cbb6411541184638db44e", "committedDate": "2020-08-31T09:54:28Z", "message": "change precede"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "46debafa5d3c57e7817f168a321c9fb0fe5400d0", "author": {"user": {"login": "Karl-WangSK", "name": "Karl_Wang"}}, "url": "https://github.com/apache/hudi/commit/46debafa5d3c57e7817f168a321c9fb0fe5400d0", "committedDate": "2020-08-31T12:05:59Z", "message": "Update OverwriteWithLatestAvroPayload.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15436a69440da2a52ba144835419d1dccbfd7d13", "author": {"user": {"login": "Karl-WangSK", "name": "Karl_Wang"}}, "url": "https://github.com/apache/hudi/commit/15436a69440da2a52ba144835419d1dccbfd7d13", "committedDate": "2020-08-31T12:13:49Z", "message": "change precede"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4NzY0MTgy", "url": "https://github.com/apache/hudi/pull/2056#pullrequestreview-478764182", "createdAt": "2020-08-31T16:31:03Z", "commit": {"oid": "15436a69440da2a52ba144835419d1dccbfd7d13"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNjozMTowNFrOHJ_6ow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNzoxMDoyOFrOHKBRog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI0NjQzNQ==", "bodyText": "surprised checkstyle is happy with space after comma after Object value,", "url": "https://github.com/apache/hudi/pull/2056#discussion_r480246435", "createdAt": "2020-08-31T16:31:04Z", "author": {"login": "vinothchandar"}, "path": "hudi-common/src/main/java/org/apache/hudi/common/model/OverwriteWithLatestAvroPayload.java", "diffHunk": "@@ -79,8 +79,18 @@ public OverwriteWithLatestAvroPayload preCombine(OverwriteWithLatestAvroPayload\n    * @param genericRecord instance of {@link GenericRecord} of interest.\n    * @returns {@code true} if record represents a delete record. {@code false} otherwise.\n    */\n-  private boolean isDeleteRecord(GenericRecord genericRecord) {\n+  public boolean isDeleteRecord(GenericRecord genericRecord) {\n     Object deleteMarker = genericRecord.get(\"_hoodie_is_deleted\");\n     return (deleteMarker instanceof Boolean && (boolean) deleteMarker);\n   }\n+\n+  /**\n+   *\n+   * @param value value in Insert Value\n+   * @param defaultValue defaultValue of the field\n+   * @return {@code true} if value equals defaultValue {@code false} otherwise.\n+   */\n+  public Boolean fieldJudge(Object value,Object defaultValue) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15436a69440da2a52ba144835419d1dccbfd7d13"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI2NTk1NA==", "bodyText": "can we name this something like OverwriteNonDefaultsWithLatestAvroPayload\nTrying to make sure it captures the fact that default value is used to decide whether we overwrite or not. Initially, I thought this was doing a partial merge (which is also something we should add IMO) - which just updates some columns. We eventually need soemthing like that to support a SQL MERGE", "url": "https://github.com/apache/hudi/pull/2056#discussion_r480265954", "createdAt": "2020-08-31T17:05:15Z", "author": {"login": "vinothchandar"}, "path": "hudi-common/src/main/java/org/apache/hudi/common/model/OverwriteMulColAvroPayload.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.common.model;\n+\n+import org.apache.hudi.common.util.Option;\n+\n+import org.apache.avro.Schema;\n+import org.apache.avro.generic.GenericRecord;\n+import org.apache.avro.generic.IndexedRecord;\n+\n+import java.io.IOException;\n+import java.util.List;\n+\n+/**\n+ * subclass of OverwriteWithLatestAvroPayload used for delta streamer.\n+ * <p>\n+ * 1. preCombine - Picks the latest delta record for a key, based on an ordering field.\n+ * 2. combineAndGetUpdateValue/getInsertValue - overwrite storage for specified fields\n+ * that doesn't equal defaultValue.\n+ */\n+public class OverwriteMulColAvroPayload extends OverwriteWithLatestAvroPayload {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15436a69440da2a52ba144835419d1dccbfd7d13"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI2NjMxNg==", "bodyText": "can we call super(..) here", "url": "https://github.com/apache/hudi/pull/2056#discussion_r480266316", "createdAt": "2020-08-31T17:05:53Z", "author": {"login": "vinothchandar"}, "path": "hudi-common/src/main/java/org/apache/hudi/common/model/OverwriteMulColAvroPayload.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.common.model;\n+\n+import org.apache.hudi.common.util.Option;\n+\n+import org.apache.avro.Schema;\n+import org.apache.avro.generic.GenericRecord;\n+import org.apache.avro.generic.IndexedRecord;\n+\n+import java.io.IOException;\n+import java.util.List;\n+\n+/**\n+ * subclass of OverwriteWithLatestAvroPayload used for delta streamer.\n+ * <p>\n+ * 1. preCombine - Picks the latest delta record for a key, based on an ordering field.\n+ * 2. combineAndGetUpdateValue/getInsertValue - overwrite storage for specified fields\n+ * that doesn't equal defaultValue.\n+ */\n+public class OverwriteMulColAvroPayload extends OverwriteWithLatestAvroPayload {\n+\n+  /**\n+   * @param record      Generic record for the payload.\n+   * @param orderingVal {@link Comparable} to be used in pre combine.\n+   */\n+  public OverwriteMulColAvroPayload(GenericRecord record, Comparable orderingVal) {\n+    super(record, orderingVal);\n+  }\n+\n+  public OverwriteMulColAvroPayload(Option<GenericRecord> record) {\n+    this(record.isPresent() ? record.get() : null, (record1) -> 0); // natural order", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15436a69440da2a52ba144835419d1dccbfd7d13"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI2Njg2NA==", "bodyText": "this check can be done using the isDeleteRecord() method. we can make that protected . wdyt?", "url": "https://github.com/apache/hudi/pull/2056#discussion_r480266864", "createdAt": "2020-08-31T17:06:57Z", "author": {"login": "vinothchandar"}, "path": "hudi-common/src/main/java/org/apache/hudi/common/model/OverwriteMulColAvroPayload.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.common.model;\n+\n+import org.apache.hudi.common.util.Option;\n+\n+import org.apache.avro.Schema;\n+import org.apache.avro.generic.GenericRecord;\n+import org.apache.avro.generic.IndexedRecord;\n+\n+import java.io.IOException;\n+import java.util.List;\n+\n+/**\n+ * subclass of OverwriteWithLatestAvroPayload used for delta streamer.\n+ * <p>\n+ * 1. preCombine - Picks the latest delta record for a key, based on an ordering field.\n+ * 2. combineAndGetUpdateValue/getInsertValue - overwrite storage for specified fields\n+ * that doesn't equal defaultValue.\n+ */\n+public class OverwriteMulColAvroPayload extends OverwriteWithLatestAvroPayload {\n+\n+  /**\n+   * @param record      Generic record for the payload.\n+   * @param orderingVal {@link Comparable} to be used in pre combine.\n+   */\n+  public OverwriteMulColAvroPayload(GenericRecord record, Comparable orderingVal) {\n+    super(record, orderingVal);\n+  }\n+\n+  public OverwriteMulColAvroPayload(Option<GenericRecord> record) {\n+    this(record.isPresent() ? record.get() : null, (record1) -> 0); // natural order\n+  }\n+\n+  @Override\n+  public Option<IndexedRecord> combineAndGetUpdateValue(IndexedRecord currentValue, Schema schema) throws IOException {\n+\n+    Option<IndexedRecord> recordOption = getInsertValue(schema);\n+    if (!recordOption.isPresent()) {\n+      return Option.empty();\n+    }\n+\n+    GenericRecord insertRecord = (GenericRecord) recordOption.get();\n+    GenericRecord currentRecord = (GenericRecord) currentValue;\n+\n+    Object deleteMarker = insertRecord.get(\"_hoodie_is_deleted\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15436a69440da2a52ba144835419d1dccbfd7d13"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI2NzQyNw==", "bodyText": "would renaming to ovewriteField() be more understandable?", "url": "https://github.com/apache/hudi/pull/2056#discussion_r480267427", "createdAt": "2020-08-31T17:08:02Z", "author": {"login": "vinothchandar"}, "path": "hudi-common/src/main/java/org/apache/hudi/common/model/OverwriteWithLatestAvroPayload.java", "diffHunk": "@@ -79,8 +79,18 @@ public OverwriteWithLatestAvroPayload preCombine(OverwriteWithLatestAvroPayload\n    * @param genericRecord instance of {@link GenericRecord} of interest.\n    * @returns {@code true} if record represents a delete record. {@code false} otherwise.\n    */\n-  private boolean isDeleteRecord(GenericRecord genericRecord) {\n+  public boolean isDeleteRecord(GenericRecord genericRecord) {\n     Object deleteMarker = genericRecord.get(\"_hoodie_is_deleted\");\n     return (deleteMarker instanceof Boolean && (boolean) deleteMarker);\n   }\n+\n+  /**\n+   *\n+   * @param value value in Insert Value\n+   * @param defaultValue defaultValue of the field\n+   * @return {@code true} if value equals defaultValue {@code false} otherwise.\n+   */\n+  public Boolean fieldJudge(Object value,Object defaultValue) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI0NjQzNQ=="}, "originalCommit": {"oid": "15436a69440da2a52ba144835419d1dccbfd7d13"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI2ODExNg==", "bodyText": "would Objects.equals() help us compare more easily.. it can deal with one argument being null. we can then avoid this whole method.", "url": "https://github.com/apache/hudi/pull/2056#discussion_r480268116", "createdAt": "2020-08-31T17:09:24Z", "author": {"login": "vinothchandar"}, "path": "hudi-common/src/main/java/org/apache/hudi/common/model/OverwriteWithLatestAvroPayload.java", "diffHunk": "@@ -79,8 +79,18 @@ public OverwriteWithLatestAvroPayload preCombine(OverwriteWithLatestAvroPayload\n    * @param genericRecord instance of {@link GenericRecord} of interest.\n    * @returns {@code true} if record represents a delete record. {@code false} otherwise.\n    */\n-  private boolean isDeleteRecord(GenericRecord genericRecord) {\n+  public boolean isDeleteRecord(GenericRecord genericRecord) {\n     Object deleteMarker = genericRecord.get(\"_hoodie_is_deleted\");\n     return (deleteMarker instanceof Boolean && (boolean) deleteMarker);\n   }\n+\n+  /**\n+   *\n+   * @param value value in Insert Value\n+   * @param defaultValue defaultValue of the field\n+   * @return {@code true} if value equals defaultValue {@code false} otherwise.\n+   */\n+  public Boolean fieldJudge(Object value,Object defaultValue) {\n+    return  defaultValue == null ? value == defaultValue : value.toString().equals(defaultValue.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15436a69440da2a52ba144835419d1dccbfd7d13"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI2ODcwNg==", "bodyText": "can we just compare without the .toString() .. coz otherwise data type mismatches may be masked. i.e \"1\" vs 1L , which will both probably get the same string representation", "url": "https://github.com/apache/hudi/pull/2056#discussion_r480268706", "createdAt": "2020-08-31T17:10:28Z", "author": {"login": "vinothchandar"}, "path": "hudi-common/src/main/java/org/apache/hudi/common/model/OverwriteWithLatestAvroPayload.java", "diffHunk": "@@ -79,8 +79,18 @@ public OverwriteWithLatestAvroPayload preCombine(OverwriteWithLatestAvroPayload\n    * @param genericRecord instance of {@link GenericRecord} of interest.\n    * @returns {@code true} if record represents a delete record. {@code false} otherwise.\n    */\n-  private boolean isDeleteRecord(GenericRecord genericRecord) {\n+  public boolean isDeleteRecord(GenericRecord genericRecord) {\n     Object deleteMarker = genericRecord.get(\"_hoodie_is_deleted\");\n     return (deleteMarker instanceof Boolean && (boolean) deleteMarker);\n   }\n+\n+  /**\n+   *\n+   * @param value value in Insert Value\n+   * @param defaultValue defaultValue of the field\n+   * @return {@code true} if value equals defaultValue {@code false} otherwise.\n+   */\n+  public Boolean fieldJudge(Object value,Object defaultValue) {\n+    return  defaultValue == null ? value == defaultValue : value.toString().equals(defaultValue.toString());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI2ODExNg=="}, "originalCommit": {"oid": "15436a69440da2a52ba144835419d1dccbfd7d13"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b85cecc69574cc7b650253c3fbdcf10a860e6935", "author": {"user": {"login": "Karl-WangSK", "name": "Karl_Wang"}}, "url": "https://github.com/apache/hudi/commit/b85cecc69574cc7b650253c3fbdcf10a860e6935", "committedDate": "2020-09-01T03:41:10Z", "message": "update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61ac5654570400a97d348c697e5ac2954a4874cb", "author": {"user": {"login": "Karl-WangSK", "name": "Karl_Wang"}}, "url": "https://github.com/apache/hudi/commit/61ac5654570400a97d348c697e5ac2954a4874cb", "committedDate": "2020-09-01T03:43:12Z", "message": "update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c03852069603286dd70ab6a4054d2fea0c09c088", "author": {"user": {"login": "Karl-WangSK", "name": "Karl_Wang"}}, "url": "https://github.com/apache/hudi/commit/c03852069603286dd70ab6a4054d2fea0c09c088", "committedDate": "2020-09-01T05:48:02Z", "message": "fix test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5NjUxOTQz", "url": "https://github.com/apache/hudi/pull/2056#pullrequestreview-479651943", "createdAt": "2020-09-01T11:34:29Z", "commit": {"oid": "c03852069603286dd70ab6a4054d2fea0c09c088"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxMTozNDoyOVrOHKyOGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxMTozNToyNFrOHKyQBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA3MDYxNg==", "bodyText": "foreach  grammar is more graceful than for loop.", "url": "https://github.com/apache/hudi/pull/2056#discussion_r481070616", "createdAt": "2020-09-01T11:34:29Z", "author": {"login": "yanghua"}, "path": "hudi-common/src/main/java/org/apache/hudi/common/model/OverwriteNonDefaultsWithLatestAvroPayload.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.common.model;\n+\n+import org.apache.hudi.common.util.Option;\n+\n+import org.apache.avro.Schema;\n+import org.apache.avro.generic.GenericRecord;\n+import org.apache.avro.generic.IndexedRecord;\n+\n+import java.io.IOException;\n+import java.util.List;\n+\n+/**\n+ * subclass of OverwriteWithLatestAvroPayload used for delta streamer.\n+ * <p>\n+ * 1. preCombine - Picks the latest delta record for a key, based on an ordering field.\n+ * 2. combineAndGetUpdateValue/getInsertValue - overwrite storage for specified fields\n+ * that doesn't equal defaultValue.\n+ */\n+public class OverwriteNonDefaultsWithLatestAvroPayload extends OverwriteWithLatestAvroPayload {\n+\n+  /**\n+   * @param record      Generic record for the payload.\n+   * @param orderingVal {@link Comparable} to be used in pre combine.\n+   */\n+  public OverwriteNonDefaultsWithLatestAvroPayload(GenericRecord record, Comparable orderingVal) {\n+    super(record, orderingVal);\n+  }\n+\n+  public OverwriteNonDefaultsWithLatestAvroPayload(Option<GenericRecord> record) {\n+    super(record); // natural order\n+  }\n+\n+  @Override\n+  public Option<IndexedRecord> combineAndGetUpdateValue(IndexedRecord currentValue, Schema schema) throws IOException {\n+\n+    Option<IndexedRecord> recordOption = getInsertValue(schema);\n+    if (!recordOption.isPresent()) {\n+      return Option.empty();\n+    }\n+\n+    GenericRecord insertRecord = (GenericRecord) recordOption.get();\n+    GenericRecord currentRecord = (GenericRecord) currentValue;\n+\n+    if (isDeleteRecord(insertRecord)) {\n+      return Option.empty();\n+    } else {\n+      List<Schema.Field> fields = schema.getFields();\n+      for (int i = 0; i < fields.size(); i++) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c03852069603286dd70ab6a4054d2fea0c09c088"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA3MTExMA==", "bodyText": "Here continue is unnecessary.", "url": "https://github.com/apache/hudi/pull/2056#discussion_r481071110", "createdAt": "2020-09-01T11:35:24Z", "author": {"login": "yanghua"}, "path": "hudi-common/src/main/java/org/apache/hudi/common/model/OverwriteNonDefaultsWithLatestAvroPayload.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.common.model;\n+\n+import org.apache.hudi.common.util.Option;\n+\n+import org.apache.avro.Schema;\n+import org.apache.avro.generic.GenericRecord;\n+import org.apache.avro.generic.IndexedRecord;\n+\n+import java.io.IOException;\n+import java.util.List;\n+\n+/**\n+ * subclass of OverwriteWithLatestAvroPayload used for delta streamer.\n+ * <p>\n+ * 1. preCombine - Picks the latest delta record for a key, based on an ordering field.\n+ * 2. combineAndGetUpdateValue/getInsertValue - overwrite storage for specified fields\n+ * that doesn't equal defaultValue.\n+ */\n+public class OverwriteNonDefaultsWithLatestAvroPayload extends OverwriteWithLatestAvroPayload {\n+\n+  /**\n+   * @param record      Generic record for the payload.\n+   * @param orderingVal {@link Comparable} to be used in pre combine.\n+   */\n+  public OverwriteNonDefaultsWithLatestAvroPayload(GenericRecord record, Comparable orderingVal) {\n+    super(record, orderingVal);\n+  }\n+\n+  public OverwriteNonDefaultsWithLatestAvroPayload(Option<GenericRecord> record) {\n+    super(record); // natural order\n+  }\n+\n+  @Override\n+  public Option<IndexedRecord> combineAndGetUpdateValue(IndexedRecord currentValue, Schema schema) throws IOException {\n+\n+    Option<IndexedRecord> recordOption = getInsertValue(schema);\n+    if (!recordOption.isPresent()) {\n+      return Option.empty();\n+    }\n+\n+    GenericRecord insertRecord = (GenericRecord) recordOption.get();\n+    GenericRecord currentRecord = (GenericRecord) currentValue;\n+\n+    if (isDeleteRecord(insertRecord)) {\n+      return Option.empty();\n+    } else {\n+      List<Schema.Field> fields = schema.getFields();\n+      for (int i = 0; i < fields.size(); i++) {\n+        Object value = insertRecord.get(fields.get(i).name());\n+        Object defaultValue = fields.get(i).defaultVal();\n+        if (ovewriteField(value, defaultValue)) {\n+          continue;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c03852069603286dd70ab6a4054d2fea0c09c088"}, "originalPosition": 70}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c74e3f0f8f9631aa51d69467584320e656d508e", "author": {"user": {"login": "Karl-WangSK", "name": "Karl_Wang"}}, "url": "https://github.com/apache/hudi/commit/8c74e3f0f8f9631aa51d69467584320e656d508e", "committedDate": "2020-09-01T12:26:12Z", "message": "update"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxNzM0NjY1", "url": "https://github.com/apache/hudi/pull/2056#pullrequestreview-481734665", "createdAt": "2020-09-03T11:11:35Z", "commit": {"oid": "8c74e3f0f8f9631aa51d69467584320e656d508e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxMToxMTozNlrOHMhu2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxMToyMDo0OVrOHMiC3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg5NzYyNA==", "bodyText": "If you want to add java doc, it would be better to add a description for the method?", "url": "https://github.com/apache/hudi/pull/2056#discussion_r482897624", "createdAt": "2020-09-03T11:11:36Z", "author": {"login": "yanghua"}, "path": "hudi-common/src/main/java/org/apache/hudi/common/model/OverwriteNonDefaultsWithLatestAvroPayload.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.common.model;\n+\n+import org.apache.hudi.common.util.Option;\n+\n+import org.apache.avro.Schema;\n+import org.apache.avro.generic.GenericRecord;\n+import org.apache.avro.generic.IndexedRecord;\n+\n+import java.io.IOException;\n+import java.util.List;\n+\n+/**\n+ * subclass of OverwriteWithLatestAvroPayload used for delta streamer.\n+ * <p>\n+ * 1. preCombine - Picks the latest delta record for a key, based on an ordering field.\n+ * 2. combineAndGetUpdateValue/getInsertValue - overwrite storage for specified fields\n+ * that doesn't equal defaultValue.\n+ */\n+public class OverwriteNonDefaultsWithLatestAvroPayload extends OverwriteWithLatestAvroPayload {\n+\n+  /**\n+   * @param record      Generic record for the payload.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c74e3f0f8f9631aa51d69467584320e656d508e"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg5Nzc4Ng==", "bodyText": "ditto", "url": "https://github.com/apache/hudi/pull/2056#discussion_r482897786", "createdAt": "2020-09-03T11:11:54Z", "author": {"login": "yanghua"}, "path": "hudi-common/src/main/java/org/apache/hudi/common/model/OverwriteWithLatestAvroPayload.java", "diffHunk": "@@ -79,8 +79,18 @@ public OverwriteWithLatestAvroPayload preCombine(OverwriteWithLatestAvroPayload\n    * @param genericRecord instance of {@link GenericRecord} of interest.\n    * @returns {@code true} if record represents a delete record. {@code false} otherwise.\n    */\n-  private boolean isDeleteRecord(GenericRecord genericRecord) {\n+  protected boolean isDeleteRecord(GenericRecord genericRecord) {\n     Object deleteMarker = genericRecord.get(\"_hoodie_is_deleted\");\n     return (deleteMarker instanceof Boolean && (boolean) deleteMarker);\n   }\n+\n+  /**\n+   *\n+   * @param value value in Insert Value", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c74e3f0f8f9631aa51d69467584320e656d508e"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjkwMTE1NA==", "bodyText": "overwriteField?", "url": "https://github.com/apache/hudi/pull/2056#discussion_r482901154", "createdAt": "2020-09-03T11:18:05Z", "author": {"login": "yanghua"}, "path": "hudi-common/src/main/java/org/apache/hudi/common/model/OverwriteWithLatestAvroPayload.java", "diffHunk": "@@ -79,8 +79,18 @@ public OverwriteWithLatestAvroPayload preCombine(OverwriteWithLatestAvroPayload\n    * @param genericRecord instance of {@link GenericRecord} of interest.\n    * @returns {@code true} if record represents a delete record. {@code false} otherwise.\n    */\n-  private boolean isDeleteRecord(GenericRecord genericRecord) {\n+  protected boolean isDeleteRecord(GenericRecord genericRecord) {\n     Object deleteMarker = genericRecord.get(\"_hoodie_is_deleted\");\n     return (deleteMarker instanceof Boolean && (boolean) deleteMarker);\n   }\n+\n+  /**\n+   *\n+   * @param value value in Insert Value\n+   * @param defaultValue defaultValue of the field\n+   * @return {@code true} if value equals defaultValue {@code false} otherwise.\n+   */\n+  public Boolean ovewriteField(Object value, Object defaultValue) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c74e3f0f8f9631aa51d69467584320e656d508e"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjkwMTYwNw==", "bodyText": "change to : return defaultValue == null ? value == null : defaultValue.toString().equals(value.toString());?", "url": "https://github.com/apache/hudi/pull/2056#discussion_r482901607", "createdAt": "2020-09-03T11:18:58Z", "author": {"login": "yanghua"}, "path": "hudi-common/src/main/java/org/apache/hudi/common/model/OverwriteWithLatestAvroPayload.java", "diffHunk": "@@ -79,8 +79,18 @@ public OverwriteWithLatestAvroPayload preCombine(OverwriteWithLatestAvroPayload\n    * @param genericRecord instance of {@link GenericRecord} of interest.\n    * @returns {@code true} if record represents a delete record. {@code false} otherwise.\n    */\n-  private boolean isDeleteRecord(GenericRecord genericRecord) {\n+  protected boolean isDeleteRecord(GenericRecord genericRecord) {\n     Object deleteMarker = genericRecord.get(\"_hoodie_is_deleted\");\n     return (deleteMarker instanceof Boolean && (boolean) deleteMarker);\n   }\n+\n+  /**\n+   *\n+   * @param value value in Insert Value\n+   * @param defaultValue defaultValue of the field\n+   * @return {@code true} if value equals defaultValue {@code false} otherwise.\n+   */\n+  public Boolean ovewriteField(Object value, Object defaultValue) {\n+    return defaultValue == null ? value == defaultValue : defaultValue.toString().equals(value.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c74e3f0f8f9631aa51d69467584320e656d508e"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjkwMjc0OQ==", "bodyText": "Can we add a use case for default value which neither null nor ''?", "url": "https://github.com/apache/hudi/pull/2056#discussion_r482902749", "createdAt": "2020-09-03T11:20:49Z", "author": {"login": "yanghua"}, "path": "hudi-common/src/test/java/org/apache/hudi/common/model/TestOverwriteNonDefaultsWithLatestAvroPayload.java", "diffHunk": "@@ -0,0 +1,114 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.common.model;\n+\n+import org.apache.avro.Schema;\n+import org.apache.avro.generic.GenericData;\n+import org.apache.avro.generic.GenericRecord;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+\n+import java.io.IOException;\n+import java.util.Arrays;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertFalse;\n+\n+/**\n+ * Unit tests {@link TestOverwriteNonDefaultsWithLatestAvroPayload}.\n+ */\n+public class TestOverwriteNonDefaultsWithLatestAvroPayload {\n+  private Schema schema;\n+\n+  @BeforeEach\n+  public void setUp() throws Exception {\n+    schema = Schema.createRecord(Arrays.asList(\n+            new Schema.Field(\"id\", Schema.create(Schema.Type.STRING), \"\", null),\n+            new Schema.Field(\"partition\", Schema.create(Schema.Type.STRING), \"\", \"\"),\n+            new Schema.Field(\"ts\", Schema.create(Schema.Type.LONG), \"\", null),\n+            new Schema.Field(\"_hoodie_is_deleted\", Schema.create(Schema.Type.BOOLEAN), \"\", false)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c74e3f0f8f9631aa51d69467584320e656d508e"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1acb278cc58f7e3522396892946d7f011ff647ef", "author": {"user": {"login": "Karl-WangSK", "name": "Karl_Wang"}}, "url": "https://github.com/apache/hudi/commit/1acb278cc58f7e3522396892946d7f011ff647ef", "committedDate": "2020-09-03T12:50:21Z", "message": "update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aace5c077a1fe4298cfbac9d0316d054894c9f7e", "author": {"user": {"login": "Karl-WangSK", "name": "Karl_Wang"}}, "url": "https://github.com/apache/hudi/commit/aace5c077a1fe4298cfbac9d0316d054894c9f7e", "committedDate": "2020-09-03T12:51:55Z", "message": "update"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxOTA2MjM2", "url": "https://github.com/apache/hudi/pull/2056#pullrequestreview-481906236", "createdAt": "2020-09-03T14:36:46Z", "commit": {"oid": "aace5c077a1fe4298cfbac9d0316d054894c9f7e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1NTY3NDM5", "url": "https://github.com/apache/hudi/pull/2056#pullrequestreview-485567439", "createdAt": "2020-09-10T04:53:09Z", "commit": {"oid": "aace5c077a1fe4298cfbac9d0316d054894c9f7e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4482, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}