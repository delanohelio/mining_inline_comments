{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIwOTU4NDA2", "number": 2253, "title": "[HUDI-1396] Fix for preventing bootstrap datasource jobs from hanging", "bodyText": "Tips\n\nThank you very much for contributing to Apache Hudi.\nPlease review https://hudi.apache.org/contributing.html before opening a pull request.\n\nWhat is the purpose of the pull request\nBootstrap job via Hudi datasource hangs at the end of the spark-submit job.\nThis issue is similar to https://issues.apache.org/jira/browse/HUDI-1230. Basically, HoodieWriteClient at https://github.com/apache/hudi/blob/release-0.6.0/hudi-spark/src/main/scala/org/apache/hudi/HoodieSparkSqlWriter.scala#L255 will not be closed and as a result, the corresponding timeline server will not stop at the end. Therefore the job hangs and never exits.\nBrief change log\nClosed HoodieWriteClient after bootstrap action.\nAdded corresponding test cases.\nVerify this pull request\n(Please pick either of the following options)\nThis pull request is a trivial rework / code cleanup without any test coverage.\n(or)\nThis pull request is already covered by existing tests, such as (please describe tests).\n(or)\nThis change added tests and can be verified as follows:\n(example:)\n\nAdded integration tests for end-to-end.\nAdded HoodieClientWriteTest to verify the change.\nManually verified the change by running a job locally.\n\nCommitter checklist\n\n\n Has a corresponding JIRA in PR title & commit\n\n\n Commit message is descriptive of the change\n\n\n CI is green\n\n\n Necessary doc changes done or have another open PR\n\n\n For large changes, please consider breaking it into sub-tasks under an umbrella JIRA.", "createdAt": "2020-11-14T04:29:21Z", "url": "https://github.com/apache/hudi/pull/2253", "merged": true, "mergeCommit": {"oid": "751e4ee88219c9d7d212cd2abcfe57ec59bb322e"}, "closed": true, "closedAt": "2020-11-23T18:43:24Z", "author": {"login": "zhedoubushishi"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdcUBrdgH2gAyNTIwOTU4NDA2OjkyYzRhNDE4ZjFmZmVkNGRhYWMxMzQyZjZhMDA4M2ZjZjFkYzJmZmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdfZqzaAFqTUzNjc1MDY0OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "92c4a418f1ffed4daac1342f6a0083fcf1dc2ffb", "author": {"user": null}, "url": "https://github.com/apache/hudi/commit/92c4a418f1ffed4daac1342f6a0083fcf1dc2ffb", "committedDate": "2020-11-14T04:27:03Z", "message": "[HUDI-1396] Fix for preventing bootstrap datasource jobs from hanging via spark-submit"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2NzUwMjE0", "url": "https://github.com/apache/hudi/pull/2253#pullrequestreview-536750214", "createdAt": "2020-11-23T18:42:37Z", "commit": {"oid": "92c4a418f1ffed4daac1342f6a0083fcf1dc2ffb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxODo0MjozOFrOH4arGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxODo0MjozOFrOH4arGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODkxOTMyMg==", "bodyText": "guess, this is the real fix here.", "url": "https://github.com/apache/hudi/pull/2253#discussion_r528919322", "createdAt": "2020-11-23T18:42:38Z", "author": {"login": "vinothchandar"}, "path": "hudi-spark/src/main/scala/org/apache/hudi/HoodieSparkSqlWriter.scala", "diffHunk": "@@ -263,8 +264,13 @@ private[hudi] object HoodieSparkSqlWriter {\n     }\n \n     val jsc = new JavaSparkContext(sqlContext.sparkContext)\n-    val writeClient = DataSourceUtils.createHoodieClient(jsc, schema, path, tableName, mapAsJavaMap(parameters))\n-    writeClient.bootstrap(org.apache.hudi.common.util.Option.empty())\n+    val writeClient = hoodieWriteClient.getOrElse(DataSourceUtils.createHoodieClient(jsc,\n+      schema, path, tableName, mapAsJavaMap(parameters)))\n+    try {\n+      writeClient.bootstrap(org.apache.hudi.common.util.Option.empty())\n+    } finally {\n+      writeClient.close()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "92c4a418f1ffed4daac1342f6a0083fcf1dc2ffb"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2NzUwNjQ4", "url": "https://github.com/apache/hudi/pull/2253#pullrequestreview-536750648", "createdAt": "2020-11-23T18:43:16Z", "commit": {"oid": "92c4a418f1ffed4daac1342f6a0083fcf1dc2ffb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4310, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}