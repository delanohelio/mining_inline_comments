{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg0NDUwNzQ0", "number": 1377, "title": "[HUDI-663] Fix HoodieDeltaStreamer offset not handled correctly", "bodyText": "What is the purpose of the pull request\nMore detail, please go ahead with #1375\n\nthe first commit content like following:\n\n{\n  \"partitionToWriteStats\" : { },\n  \"compacted\" : false,\n  \"extraMetadata\" : {\n    \"ROLLING_STAT\" : \"{\\n  \\\"partitionToRollingStats\\\" : { },\\n  \\\"actionType\\\" : \\\"commit\\\"\\n}\",\n    \"schema\" : \"{\\\"type\\\":\\\"record\\\",\\\"name\\\":\\\"stock_ticks\\\",\\\"fields\\\":[{\\\"name\\\":\\\"volume\\\",\\\"type\\\":\\\"long\\\"},{\\\"name\\\":\\\"ts\\\",\\\"type\\\":\\\"string\\\"},{\\\"name\\\":\\\"symbol\\\",\\\"type\\\":\\\"string\\\"},{\\\"name\\\":\\\"year\\\",\\\"type\\\":\\\"int\\\"},{\\\"name\\\":\\\"month\\\",\\\"type\\\":\\\"string\\\"},{\\\"name\\\":\\\"high\\\",\\\"type\\\":\\\"double\\\"},{\\\"name\\\":\\\"low\\\",\\\"type\\\":\\\"double\\\"},{\\\"name\\\":\\\"key\\\",\\\"type\\\":\\\"string\\\"},{\\\"name\\\":\\\"date\\\",\\\"type\\\":\\\"string\\\"},{\\\"name\\\":\\\"close\\\",\\\"type\\\":\\\"double\\\"},{\\\"name\\\":\\\"open\\\",\\\"type\\\":\\\"double\\\"},{\\\"name\\\":\\\"day\\\",\\\"type\\\":\\\"string\\\"}]}\",\n    \"deltastreamer.checkpoint.key\" : \"\"\n  },\n  \"operationType\" : \"UPSERT\",\n  \"fileIdAndRelativePaths\" : { },\n  \"totalRecordsDeleted\" : 0,\n  \"totalLogRecordsCompacted\" : 0,\n  \"totalScanTime\" : 0,\n  \"totalCreateTime\" : 0,\n  \"totalUpsertTime\" : 0,\n  \"totalCompactedRecordsUpdated\" : 0,\n  \"totalLogFilesCompacted\" : 0,\n  \"totalLogFilesSize\" : 0\n}\n\n\nthe second commit will use the last checkpoint {}, which means the fromoffset is 0.\nbut the previous messages may be removed because of kafka retention mechanism.\nso the low_watermark is greater than 0.\n\nBrief change log\n\ndouble check the lastCheckpointStr\n\nVerify this pull request\nFollow steps: #1375\nCommitter checklist\n\n\n Has a corresponding JIRA in PR title & commit\n\n\n Commit message is descriptive of the change\n\n\n CI is green\n\n\n Necessary doc changes done or have another open PR\n\n\n For large changes, please consider breaking it into sub-tasks under an umbrella JIRA.", "createdAt": "2020-03-05T19:09:52Z", "url": "https://github.com/apache/hudi/pull/1377", "merged": true, "mergeCommit": {"oid": "38c3ccc51a069dbccab718423055c0a708b44d63"}, "closed": true, "closedAt": "2020-03-22T17:31:49Z", "author": {"login": "lamberken"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKwSO6gH2gAyMzg0NDUwNzQ0OjgyMWM0NTQ5MDkxOTA0NmJlMzZhODRhMjJmZGExMmM2NTY3MDkzNGU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcPSUr_AFqTM3ODA4NjgzMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "821c45490919046be36a84a22fda12c65670934e", "author": {"user": {"login": "lamberken", "name": "lamberken"}}, "url": "https://github.com/apache/hudi/commit/821c45490919046be36a84a22fda12c65670934e", "committedDate": "2020-03-05T19:00:41Z", "message": "[HUDI-663] Fix HoodieDeltaStreamer offset not handled correctly"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwMDczMjgz", "url": "https://github.com/apache/hudi/pull/1377#pullrequestreview-370073283", "createdAt": "2020-03-06T04:15:14Z", "commit": {"oid": "821c45490919046be36a84a22fda12c65670934e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQwNDoxNToxNFrOFystSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQwNDoxNToxNFrOFystSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODcwNTYwOA==", "bodyText": "I think this may potentially hide some concerning errors.\ne.g. The delta streamer is consuming Kafka source, but a hidden bug happens and stored an empty checkpoint.  The next run will just ignore the empty checkpoint and reset to the LATEST. Then there will be data loss", "url": "https://github.com/apache/hudi/pull/1377#discussion_r388705608", "createdAt": "2020-03-06T04:15:14Z", "author": {"login": "garyli1019"}, "path": "hudi-utilities/src/main/java/org/apache/hudi/utilities/sources/helpers/KafkaOffsetGen.java", "diffHunk": "@@ -180,7 +180,7 @@ public KafkaOffsetGen(TypedProperties props) {\n               .map(x -> new TopicPartition(x.topic(), x.partition())).collect(Collectors.toSet());\n \n       // Determine the offset ranges to read from\n-      if (lastCheckpointStr.isPresent()) {\n+      if (lastCheckpointStr.isPresent() && !lastCheckpointStr.get().isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "821c45490919046be36a84a22fda12c65670934e"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNTQyMTY2", "url": "https://github.com/apache/hudi/pull/1377#pullrequestreview-370542166", "createdAt": "2020-03-06T18:40:26Z", "commit": {"oid": "821c45490919046be36a84a22fda12c65670934e"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4MDg2ODMy", "url": "https://github.com/apache/hudi/pull/1377#pullrequestreview-378086832", "createdAt": "2020-03-19T20:55:50Z", "commit": {"oid": "821c45490919046be36a84a22fda12c65670934e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3762, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}