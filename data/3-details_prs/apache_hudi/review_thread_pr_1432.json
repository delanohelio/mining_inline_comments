{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxODI0NzM4", "number": 1432, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMlQxNjo1NjoxN1rODqLCGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQwOToxNzo1MVrODslUqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1NTQ3NTQ2OnYy", "diffSide": "RIGHT", "path": "hudi-client/src/main/java/org/apache/hudi/client/HoodieCleanClient.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMlQxNjo1NjoxN1rOF5xAmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxODoxNTo1M1rOF88z_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjExNjEyMw==", "bodyText": "@lamber-ken : Can we rollback the corrupted instant seamlessly in this case ?\nCan you also add a CLI (called timeline upgrade) which would read the timeline  and fix upgrade issues.  For now, the CLI can just handle only known issue - to deal with corrupted inflight clean instants.  We can have users run them before upgrade for now and also see if this can be done seamlessly.", "url": "https://github.com/apache/hudi/pull/1432#discussion_r396116123", "createdAt": "2020-03-22T16:56:17Z", "author": {"login": "bvaradar"}, "path": "hudi-client/src/main/java/org/apache/hudi/client/HoodieCleanClient.java", "diffHunk": "@@ -85,7 +85,11 @@ public HoodieCleanMetadata clean(String startCleanTime) throws HoodieIOException\n     // If there are inflight(failed) or previously requested clean operation, first perform them\n     table.getCleanTimeline().filterInflightsAndRequested().getInstants().forEach(hoodieInstant -> {\n       LOG.info(\"There were previously unfinished cleaner operations. Finishing Instant=\" + hoodieInstant);\n-      runClean(table, hoodieInstant);\n+      try {\n+        runClean(table, hoodieInstant);\n+      } catch (Exception e) {\n+        LOG.warn(\"Failed to perform previous clean operation, instant: \" + hoodieInstant, e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjExNjg4Mg==", "bodyText": "Good idea \ud83d\udc4d , will update the pr.", "url": "https://github.com/apache/hudi/pull/1432#discussion_r396116882", "createdAt": "2020-03-22T17:03:32Z", "author": {"login": "lamberken"}, "path": "hudi-client/src/main/java/org/apache/hudi/client/HoodieCleanClient.java", "diffHunk": "@@ -85,7 +85,11 @@ public HoodieCleanMetadata clean(String startCleanTime) throws HoodieIOException\n     // If there are inflight(failed) or previously requested clean operation, first perform them\n     table.getCleanTimeline().filterInflightsAndRequested().getInstants().forEach(hoodieInstant -> {\n       LOG.info(\"There were previously unfinished cleaner operations. Finishing Instant=\" + hoodieInstant);\n-      runClean(table, hoodieInstant);\n+      try {\n+        runClean(table, hoodieInstant);\n+      } catch (Exception e) {\n+        LOG.warn(\"Failed to perform previous clean operation, instant: \" + hoodieInstant, e);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjExNjEyMw=="}, "originalCommit": null, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ1NTIzMQ==", "bodyText": "Sorry for delay, had updated the pr, any suggestion are welcome, thanks @bvaradar", "url": "https://github.com/apache/hudi/pull/1432#discussion_r399455231", "createdAt": "2020-03-27T18:15:53Z", "author": {"login": "lamberken"}, "path": "hudi-client/src/main/java/org/apache/hudi/client/HoodieCleanClient.java", "diffHunk": "@@ -85,7 +85,11 @@ public HoodieCleanMetadata clean(String startCleanTime) throws HoodieIOException\n     // If there are inflight(failed) or previously requested clean operation, first perform them\n     table.getCleanTimeline().filterInflightsAndRequested().getInstants().forEach(hoodieInstant -> {\n       LOG.info(\"There were previously unfinished cleaner operations. Finishing Instant=\" + hoodieInstant);\n-      runClean(table, hoodieInstant);\n+      try {\n+        runClean(table, hoodieInstant);\n+      } catch (Exception e) {\n+        LOG.warn(\"Failed to perform previous clean operation, instant: \" + hoodieInstant, e);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjExNjEyMw=="}, "originalCommit": null, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4MDc0NjIyOnYy", "diffSide": "RIGHT", "path": "hudi-cli/src/main/java/org/apache/hudi/cli/commands/UpgradesCommand.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQwOToxNTo1MlrOF9gnbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQwOToxNTo1MlrOF9gnbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA0MTgzOA==", "bodyText": "minor : rename to removeCorruptedPendingCleanAction ?", "url": "https://github.com/apache/hudi/pull/1432#discussion_r400041838", "createdAt": "2020-03-30T09:15:52Z", "author": {"login": "bvaradar"}, "path": "hudi-cli/src/main/java/org/apache/hudi/cli/commands/UpgradesCommand.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.cli.commands;\n+\n+import org.apache.hudi.cli.HoodieCLI;\n+import org.apache.hudi.common.table.HoodieTableMetaClient;\n+import org.apache.hudi.common.table.timeline.HoodieActiveTimeline;\n+import org.apache.hudi.common.util.CleanerUtils;\n+import org.apache.hudi.common.util.FSUtils;\n+import org.apache.log4j.Logger;\n+import org.springframework.shell.core.CommandMarker;\n+import org.springframework.shell.core.annotation.CliCommand;\n+import org.springframework.stereotype.Component;\n+\n+import java.io.IOException;\n+\n+/**\n+ * CLI command to during upgrading.\n+ */\n+@Component\n+public class UpgradesCommand implements CommandMarker {\n+  private static final Logger LOG = Logger.getLogger(UpgradesCommand.class);\n+\n+  @CliCommand(value = \"cleanup corrupted files\", help = \"cleanup corrupted files\")\n+  public void cleanUpCorruptedFiles() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4MDc1MDY4OnYy", "diffSide": "RIGHT", "path": "hudi-cli/src/main/java/org/apache/hudi/cli/commands/UpgradesCommand.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQwOToxNzowNFrOF9gqPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQwOToxNzowNFrOF9gqPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA0MjU1Nw==", "bodyText": "On second thought, I think this method can be best present in existing RepairsCommand class instead of this new class. Let me know your thoughts ?", "url": "https://github.com/apache/hudi/pull/1432#discussion_r400042557", "createdAt": "2020-03-30T09:17:04Z", "author": {"login": "bvaradar"}, "path": "hudi-cli/src/main/java/org/apache/hudi/cli/commands/UpgradesCommand.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.cli.commands;\n+\n+import org.apache.hudi.cli.HoodieCLI;\n+import org.apache.hudi.common.table.HoodieTableMetaClient;\n+import org.apache.hudi.common.table.timeline.HoodieActiveTimeline;\n+import org.apache.hudi.common.util.CleanerUtils;\n+import org.apache.hudi.common.util.FSUtils;\n+import org.apache.log4j.Logger;\n+import org.springframework.shell.core.CommandMarker;\n+import org.springframework.shell.core.annotation.CliCommand;\n+import org.springframework.stereotype.Component;\n+\n+import java.io.IOException;\n+\n+/**\n+ * CLI command to during upgrading.\n+ */\n+@Component\n+public class UpgradesCommand implements CommandMarker {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4MDc1NDMzOnYy", "diffSide": "RIGHT", "path": "hudi-common/src/main/java/org/apache/hudi/common/util/FSUtils.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQwOToxNzo1MVrOF9gsaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxMDowMjoxNFrOF9iZJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA0MzExNQ==", "bodyText": "Add a Log message to not what is getting deleted ?", "url": "https://github.com/apache/hudi/pull/1432#discussion_r400043115", "createdAt": "2020-03-30T09:17:51Z", "author": {"login": "bvaradar"}, "path": "hudi-common/src/main/java/org/apache/hudi/common/util/FSUtils.java", "diffHunk": "@@ -485,6 +485,14 @@ public static void deleteOlderRollbackMetaFiles(FileSystem fs, String metaPath,\n     });\n   }\n \n+  public static void deleteInstantFile(FileSystem fs, String metaPath, HoodieInstant instant) {\n+    try {\n+      fs.delete(new Path(metaPath, instant.getFileName()), false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA3MDk0OQ==", "bodyText": "reasonable", "url": "https://github.com/apache/hudi/pull/1432#discussion_r400070949", "createdAt": "2020-03-30T10:02:14Z", "author": {"login": "lamberken"}, "path": "hudi-common/src/main/java/org/apache/hudi/common/util/FSUtils.java", "diffHunk": "@@ -485,6 +485,14 @@ public static void deleteOlderRollbackMetaFiles(FileSystem fs, String metaPath,\n     });\n   }\n \n+  public static void deleteInstantFile(FileSystem fs, String metaPath, HoodieInstant instant) {\n+    try {\n+      fs.delete(new Path(metaPath, instant.getFileName()), false);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA0MzExNQ=="}, "originalCommit": null, "originalPosition": 6}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4954, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}