{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE5NTQwNzY3", "number": 2246, "title": "[HUDI-1393] Add compaction action in archive command", "bodyText": "What is the purpose of the pull request\nshow archived commits command can not recognize compaction action, add it.\nBrief change log\n(for example:)\n\nAdd compaction action in archive command\n\nVerify this pull request\nThis pull request is a trivial rework / code cleanup without any test coverage.\nCommitter checklist\n\n\n Has a corresponding JIRA in PR title & commit\n\n\n Commit message is descriptive of the change\n\n\n CI is green\n\n\n Necessary doc changes done or have another open PR\n\n\n For large changes, please consider breaking it into sub-tasks under an umbrella JIRA.", "createdAt": "2020-11-12T00:44:08Z", "url": "https://github.com/apache/hudi/pull/2246", "merged": true, "mergeCommit": {"oid": "971f028aaf3e90ddee571e9862509d34a637782d"}, "closed": true, "closedAt": "2020-11-23T08:53:02Z", "author": {"login": "hddong"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdb5C6xABqjM5OTA2NTc4Mjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdfRN4RAFqTUzNjI2NzgyMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4e1202cd27f73af4c38630fe45e08c61e70657cf", "author": {"user": {"login": "hddong", "name": "hongdd"}}, "url": "https://github.com/apache/hudi/commit/4e1202cd27f73af4c38630fe45e08c61e70657cf", "committedDate": "2020-11-12T09:12:55Z", "message": "reset"}, "afterCommit": {"oid": "a7c727b6650c4c1b0a64bf220bb2795106a03321", "author": {"user": {"login": "hddong", "name": "hongdd"}}, "url": "https://github.com/apache/hudi/commit/a7c727b6650c4c1b0a64bf220bb2795106a03321", "committedDate": "2020-11-11T08:08:09Z", "message": "[HUDI-1393]Add compaction action in archive command"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a7c727b6650c4c1b0a64bf220bb2795106a03321", "author": {"user": {"login": "hddong", "name": "hongdd"}}, "url": "https://github.com/apache/hudi/commit/a7c727b6650c4c1b0a64bf220bb2795106a03321", "committedDate": "2020-11-11T08:08:09Z", "message": "[HUDI-1393]Add compaction action in archive command"}, "afterCommit": {"oid": "a311bc1ea251f8c40cf9ae09fee856b9f83265cf", "author": {"user": {"login": "hddong", "name": "hongdd"}}, "url": "https://github.com/apache/hudi/commit/a311bc1ea251f8c40cf9ae09fee856b9f83265cf", "committedDate": "2020-11-12T21:03:28Z", "message": "[HUDI-1393]Add compaction action in archive command"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47778897fbd46f552bc029a942b42df1cae72796", "author": {"user": {"login": "hddong", "name": "hongdd"}}, "url": "https://github.com/apache/hudi/commit/47778897fbd46f552bc029a942b42df1cae72796", "committedDate": "2020-11-17T00:55:16Z", "message": "[HUDI-1393]Add compaction action in archive command"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6f376b10c9edde1c68e356e632ad2c51d6cc280a", "author": {"user": {"login": "hddong", "name": "hongdd"}}, "url": "https://github.com/apache/hudi/commit/6f376b10c9edde1c68e356e632ad2c51d6cc280a", "committedDate": "2020-11-16T01:15:00Z", "message": "reset\n\nreset"}, "afterCommit": {"oid": "47778897fbd46f552bc029a942b42df1cae72796", "author": {"user": {"login": "hddong", "name": "hongdd"}}, "url": "https://github.com/apache/hudi/commit/47778897fbd46f552bc029a942b42df1cae72796", "committedDate": "2020-11-17T00:55:16Z", "message": "[HUDI-1393]Add compaction action in archive command"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1OTE2NzM4", "url": "https://github.com/apache/hudi/pull/2246#pullrequestreview-535916738", "createdAt": "2020-11-21T06:12:50Z", "commit": {"oid": "47778897fbd46f552bc029a942b42df1cae72796"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMVQwNjoxMjo1MFrOH3naqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMVQwNjoxMjo1MFrOH3naqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODA3OTUyOQ==", "bodyText": "Hi @hddong, how about return an empty array here as before. it seems will cause an NPE in org/apache/hudi/cli/HoodiePrintHelper.java:92", "url": "https://github.com/apache/hudi/pull/2246#discussion_r528079529", "createdAt": "2020-11-21T06:12:50Z", "author": {"login": "wangxianghu"}, "path": "hudi-cli/src/main/java/org/apache/hudi/cli/commands/ArchivedCommitsCommand.java", "diffHunk": "@@ -172,49 +173,38 @@ public String showCommits(\n     return HoodiePrintHelper.print(header, new HashMap<>(), sortByField, descending, limit, headerOnly, allCommits);\n   }\n \n-  private Comparable[] readCommit(GenericRecord record, boolean skipMetadata) {\n+  private Comparable[] commitDetail(GenericRecord record, String metadataName,\n+                                    boolean skipMetadata) {\n     List<Object> commitDetails = new ArrayList<>();\n+    commitDetails.add(record.get(\"commitTime\"));\n+    commitDetails.add(record.get(\"actionType\").toString());\n+    if (!skipMetadata) {\n+      commitDetails.add(Option.ofNullable(record.get(metadataName)).orElse(\"{}\").toString());\n+    }\n+    return commitDetails.toArray(new Comparable[commitDetails.size()]);\n+  }\n+\n+  private Comparable[] readCommit(GenericRecord record, boolean skipMetadata) {\n     try {\n       switch (record.get(\"actionType\").toString()) {\n-        case HoodieTimeline.CLEAN_ACTION: {\n-          commitDetails.add(record.get(\"commitTime\"));\n-          commitDetails.add(record.get(\"actionType\").toString());\n-          if (!skipMetadata) {\n-            commitDetails.add(record.get(\"hoodieCleanMetadata\").toString());\n-          }\n-          break;\n-        }\n+        case HoodieTimeline.CLEAN_ACTION:\n+          return commitDetail(record, \"hoodieCleanMetadata\", skipMetadata);\n         case HoodieTimeline.COMMIT_ACTION:\n-        case HoodieTimeline.DELTA_COMMIT_ACTION: {\n-          commitDetails.add(record.get(\"commitTime\"));\n-          commitDetails.add(record.get(\"actionType\").toString());\n-          if (!skipMetadata) {\n-            commitDetails.add(record.get(\"hoodieCommitMetadata\").toString());\n-          }\n-          break;\n-        }\n-        case HoodieTimeline.ROLLBACK_ACTION: {\n-          commitDetails.add(record.get(\"commitTime\"));\n-          commitDetails.add(record.get(\"actionType\").toString());\n-          if (!skipMetadata) {\n-            commitDetails.add(record.get(\"hoodieRollbackMetadata\").toString());\n-          }\n-          break;\n+        case HoodieTimeline.DELTA_COMMIT_ACTION:\n+          return commitDetail(record, \"hoodieCommitMetadata\", skipMetadata);\n+        case HoodieTimeline.ROLLBACK_ACTION:\n+          return commitDetail(record, \"hoodieRollbackMetadata\", skipMetadata);\n+        case HoodieTimeline.SAVEPOINT_ACTION:\n+          return commitDetail(record, \"hoodieSavePointMetadata\", skipMetadata);\n+        case HoodieTimeline.COMPACTION_ACTION:\n+          return commitDetail(record, \"hoodieCompactionMetadata\", skipMetadata);\n+        default: {\n+          return new Comparable[]{};\n         }\n-        case HoodieTimeline.SAVEPOINT_ACTION: {\n-          commitDetails.add(record.get(\"commitTime\"));\n-          commitDetails.add(record.get(\"actionType\").toString());\n-          if (!skipMetadata) {\n-            commitDetails.add(record.get(\"hoodieSavePointMetadata\").toString());\n-          }\n-          break;\n-        }\n-        default:\n-          return commitDetails.toArray(new Comparable[commitDetails.size()]);\n       }\n     } catch (Exception e) {\n       e.printStackTrace();\n+      return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47778897fbd46f552bc029a942b42df1cae72796"}, "originalPosition": 77}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2bf49c507a5da57c861e2ff4071cac307c91d953", "author": {"user": {"login": "hddong", "name": "hongdd"}}, "url": "https://github.com/apache/hudi/commit/2bf49c507a5da57c861e2ff4071cac307c91d953", "committedDate": "2020-11-23T05:58:38Z", "message": "Update ArchivedCommitsCommand.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2MTk0NDk1", "url": "https://github.com/apache/hudi/pull/2246#pullrequestreview-536194495", "createdAt": "2020-11-23T06:11:11Z", "commit": {"oid": "2bf49c507a5da57c861e2ff4071cac307c91d953"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8fbdf8310a23d12a6905006610e0ef45290866e0", "author": {"user": {"login": "hddong", "name": "hongdd"}}, "url": "https://github.com/apache/hudi/commit/8fbdf8310a23d12a6905006610e0ef45290866e0", "committedDate": "2020-11-23T07:42:41Z", "message": "Update ArchivedCommitsCommand.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2MjY3ODIx", "url": "https://github.com/apache/hudi/pull/2246#pullrequestreview-536267821", "createdAt": "2020-11-23T08:52:26Z", "commit": {"oid": "8fbdf8310a23d12a6905006610e0ef45290866e0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4296, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}