{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM1MjAxNTA0", "number": 1739, "title": "[HUDI-760]Remove Rolling Stat management from Hudi Writer", "bodyText": "What is the purpose of the pull request\nThis pull request cleaned some rolling stat metadata's abandoned operation, when commit\nand clean up related operations in unit tests\nBrief change log\n\nRemove Rolling Stat management from Hudi Writer\n\nVerify this pull request\nThis pull request is already covered by existing tests, such as\n\nTestHoodieClientOnCopyOnWriteStorage.java\nTestHoodieMergeOnReadTable.java\n\nCommitter checklist\n\n\n Has a corresponding JIRA in PR title & commit\n\n\n Commit message is descriptive of the change\n\n\n CI is green\n\n\n Necessary doc changes done or have another open PR\n\n\n For large changes, please consider breaking it into sub-tasks under an umbrella JIRA.", "createdAt": "2020-06-16T13:07:03Z", "url": "https://github.com/apache/hudi/pull/1739", "merged": true, "mergeCommit": {"oid": "2be924fd3a04e2106f1ad3f9ce91890ea58c8a88"}, "closed": true, "closedAt": "2020-07-01T03:07:10Z", "author": {"login": "baobaoyeye"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABctgvweAFqTQzNDUyMzM5OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwhWxLgFqTQ0MDUxNjUwNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0NTIzMzk4", "url": "https://github.com/apache/hudi/pull/1739#pullrequestreview-434523398", "createdAt": "2020-06-21T18:41:49Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwMTg1OTg3", "url": "https://github.com/apache/hudi/pull/1739#pullrequestreview-440185987", "createdAt": "2020-06-30T16:25:06Z", "commit": null, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNjoyNTowNlrOGrEfRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNjozNzo1NVrOGrFFBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgxNTQ5Mg==", "bodyText": "Since, this method is just callling writeStats.forEach(stat -> metadata.addWriteStat(stat.getPartitionPath(), stat)); , can we remove this function altogether and move \"writeStats.forEach(stat -> metadata.addWriteStat(stat.getPartitionPath(), stat));\" to the caller.", "url": "https://github.com/apache/hudi/pull/1739#discussion_r447815492", "createdAt": "2020-06-30T16:25:06Z", "author": {"login": "bvaradar"}, "path": "hudi-client/src/main/java/org/apache/hudi/client/AbstractHoodieWriteClient.java", "diffHunk": "@@ -177,44 +175,7 @@ protected void finalizeWrite(HoodieTable<T> table, String instantTime, List<Hood\n \n   private void updateMetadataAndRollingStats(String actionType, HoodieCommitMetadata metadata,", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgxNzM2OA==", "bodyText": "Same case for this also. Can you remove this method and move \"writeStats.forEach(stat -> metadata.addWriteStat(stat.getPartitionPath(), stat));\" to caller", "url": "https://github.com/apache/hudi/pull/1739#discussion_r447817368", "createdAt": "2020-06-30T16:27:40Z", "author": {"login": "bvaradar"}, "path": "hudi-client/src/main/java/org/apache/hudi/table/action/commit/BaseCommitActionExecutor.java", "diffHunk": "@@ -231,15 +231,7 @@ protected void finalizeWrite(String instantTime, List<HoodieWriteStat> stats, Ho\n   }\n \n   private void updateMetadataAndRollingStats(HoodieCommitMetadata metadata, List<HoodieWriteStat> writeStats) {\n-    // 1. Look up the previous compaction/commit and get the HoodieCommitMetadata from there.\n-    // 2. Now, first read the existing rolling stats and merge with the result of current metadata.\n-\n-    // Need to do this on every commit (delta or commit) to support COW and MOR.\n-    for (HoodieWriteStat stat : writeStats) {\n-      String partitionPath = stat.getPartitionPath();\n-      // TODO: why is stat.getPartitionPath() null at times here.\n-      metadata.addWriteStat(partitionPath, stat);\n-    }\n+    writeStats.forEach(stat -> metadata.addWriteStat(stat.getPartitionPath(), stat));", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgyMjkxOQ==", "bodyText": "Rename to testMetadataStatsOnCommit", "url": "https://github.com/apache/hudi/pull/1739#discussion_r447822919", "createdAt": "2020-06-30T16:34:55Z", "author": {"login": "bvaradar"}, "path": "hudi-client/src/test/java/org/apache/hudi/client/TestHoodieClientOnCopyOnWriteStorage.java", "diffHunk": "@@ -849,7 +848,7 @@ public void testCommitWritesRelativePaths() throws Exception {\n   }\n \n   /**\n-   * Test to ensure commit metadata points to valid files.\n+   * Test to ensure commit metadata points to valid files.10.\n    */\n   @Test\n   public void testRollingStatsInMetadata() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgyNTE1OQ==", "bodyText": "Also rename this test in the same way.", "url": "https://github.com/apache/hudi/pull/1739#discussion_r447825159", "createdAt": "2020-06-30T16:37:55Z", "author": {"login": "bvaradar"}, "path": "hudi-client/src/test/java/org/apache/hudi/table/TestHoodieMergeOnReadTable.java", "diffHunk": "@@ -1094,14 +1093,10 @@ public void testRollingStatsInMetadata() throws Exception {\n       HoodieCommitMetadata metadata = HoodieCommitMetadata.fromBytes(\n           table.getActiveTimeline().getInstantDetails(table.getActiveTimeline().getDeltaCommitTimeline().lastInstant().get()).get(),\n           HoodieCommitMetadata.class);\n-      HoodieRollingStatMetadata rollingStatMetadata = HoodieCommitMetadata.fromBytes(\n-          metadata.getExtraMetadata().get(HoodieRollingStatMetadata.ROLLING_STAT_METADATA_KEY).getBytes(),\n-          HoodieRollingStatMetadata.class);\n       int inserts = 0;\n-      for (Map.Entry<String, Map<String, HoodieRollingStat>> pstat : rollingStatMetadata.getPartitionToRollingStats()\n-          .entrySet()) {\n-        for (Map.Entry<String, HoodieRollingStat> stat : pstat.getValue().entrySet()) {\n-          inserts += stat.getValue().getInserts();\n+      for (Map.Entry<String, List<HoodieWriteStat>> pstat : metadata.getPartitionToWriteStats().entrySet()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8eaff57aa7a458c1c044433a8820226b60bc2694", "author": {"user": {"login": "baobaoyeye", "name": null}}, "url": "https://github.com/apache/hudi/commit/8eaff57aa7a458c1c044433a8820226b60bc2694", "committedDate": "2020-06-30T20:16:39Z", "message": "[HUDI-760]Remove Rolling Stat management from Hudi Writer"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "8eaff57aa7a458c1c044433a8820226b60bc2694", "author": {"user": {"login": "baobaoyeye", "name": null}}, "url": "https://github.com/apache/hudi/commit/8eaff57aa7a458c1c044433a8820226b60bc2694", "committedDate": "2020-06-30T20:16:39Z", "message": "[HUDI-760]Remove Rolling Stat management from Hudi Writer"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwNTE2NTA2", "url": "https://github.com/apache/hudi/pull/1739#pullrequestreview-440516506", "createdAt": "2020-07-01T03:06:11Z", "commit": {"oid": "8eaff57aa7a458c1c044433a8820226b60bc2694"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2807, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}