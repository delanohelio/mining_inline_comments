{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDExMzI0NjAz", "number": 1577, "title": "[HUDI-855] Run Auto Cleaner in parallel with ingestion", "bodyText": "When auto-clean is enabled, Writer would automatically run the cleaner job asynchronously along with the write operation.", "createdAt": "2020-04-30T10:26:31Z", "url": "https://github.com/apache/hudi/pull/1577", "merged": true, "mergeCommit": {"oid": "8919be6a5d8038db7265bfd7459d72fbd545f133"}, "closed": true, "closedAt": "2020-06-28T09:04:51Z", "author": {"login": "bvaradar"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABccu0hpAFqTQwMzYyNzI2NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcvorgpgFqTQzODc2MDQzMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzNjI3MjY0", "url": "https://github.com/apache/hudi/pull/1577#pullrequestreview-403627264", "createdAt": "2020-04-30T15:22:43Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxNToyMjo0M1rOGOuVGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxNToyNzozMFrOGOuitQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA5MjMxNQ==", "bodyText": "let's move this into its own method for readability?", "url": "https://github.com/apache/hudi/pull/1577#discussion_r418092315", "createdAt": "2020-04-30T15:22:43Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/src/main/java/org/apache/hudi/client/HoodieWriteClient.java", "diffHunk": "@@ -339,8 +352,13 @@ protected void postCommit(HoodieCommitMetadata metadata, String instantTime,\n       archiveLog.archiveIfRequired(jsc);\n       if (config.isAutoClean()) {\n         // Call clean to cleanup if there is anything to cleanup after the commit,\n-        LOG.info(\"Auto cleaning is enabled. Running cleaner now\");\n-        clean(instantTime);\n+        if (config.isRunParallelAutoClean()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA5MzI3OA==", "bodyText": "lets move this to its own class?", "url": "https://github.com/apache/hudi/pull/1577#discussion_r418093278", "createdAt": "2020-04-30T15:24:03Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/src/main/java/org/apache/hudi/client/HoodieWriteClient.java", "diffHunk": "@@ -677,4 +714,27 @@ private void rollbackPendingCommits() {\n     });\n     return compactionInstantTimeOpt;\n   }\n+\n+  /**\n+   * Auto Clean service running concurrently.\n+   */\n+  private static class AutoCleanerService extends AbstractAsyncService {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 138}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA5NDIyNA==", "bodyText": "And even the spawnAutoCleanerIfEnabled and waitForAutoCleanerToShutdown as static helpers in this class.. (trying to avoid code creep inside HoodieWriteClient :))", "url": "https://github.com/apache/hudi/pull/1577#discussion_r418094224", "createdAt": "2020-04-30T15:25:19Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/src/main/java/org/apache/hudi/client/HoodieWriteClient.java", "diffHunk": "@@ -677,4 +714,27 @@ private void rollbackPendingCommits() {\n     });\n     return compactionInstantTimeOpt;\n   }\n+\n+  /**\n+   * Auto Clean service running concurrently.\n+   */\n+  private static class AutoCleanerService extends AbstractAsyncService {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA5MzI3OA=="}, "originalCommit": null, "originalPosition": 138}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA5NDY1Ng==", "bodyText": "move to constructor and reuse for the duration of a HoodieWriteClient ?", "url": "https://github.com/apache/hudi/pull/1577#discussion_r418094656", "createdAt": "2020-04-30T15:25:58Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/src/main/java/org/apache/hudi/client/HoodieWriteClient.java", "diffHunk": "@@ -677,4 +714,27 @@ private void rollbackPendingCommits() {\n     });\n     return compactionInstantTimeOpt;\n   }\n+\n+  /**\n+   * Auto Clean service running concurrently.\n+   */\n+  private static class AutoCleanerService extends AbstractAsyncService {\n+\n+    private final HoodieWriteClient writeClient;\n+    private final String cleanInstant;\n+\n+    private AutoCleanerService(HoodieWriteClient writeClient, String cleanInstant) {\n+      this.writeClient = writeClient;\n+      this.cleanInstant = cleanInstant;\n+    }\n+\n+    @Override\n+    protected Pair<CompletableFuture, ExecutorService> startService() {\n+      ExecutorService executor = Executors.newFixedThreadPool(1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 150}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA5NTA4Nw==", "bodyText": "this is from the other PR.", "url": "https://github.com/apache/hudi/pull/1577#discussion_r418095087", "createdAt": "2020-04-30T15:26:36Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/src/main/java/org/apache/hudi/table/action/clean/CleanPlanner.java", "diffHunk": "@@ -111,10 +111,15 @@ public CleanPlanner(HoodieTable<T> hoodieTable, HoodieWriteConfig config) {\n    * @throws IOException when underlying file-system throws this exception\n    */\n   public List<String> getPartitionPathsToClean(Option<HoodieInstant> newInstantToRetain) throws IOException {\n-    if (config.incrementalCleanerModeEnabled() && newInstantToRetain.isPresent()\n+\n+    if (!newInstantToRetain.isPresent() && (HoodieCleaningPolicy.KEEP_LATEST_COMMITS == config.getCleanerPolicy())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA5NTc5Nw==", "bodyText": "does this really belong in hudi-common or it can stay in hudi-client (execution package?)", "url": "https://github.com/apache/hudi/pull/1577#discussion_r418095797", "createdAt": "2020-04-30T15:27:30Z", "author": {"login": "vinothchandar"}, "path": "hudi-common/src/main/java/org/apache/hudi/common/async/AbstractAsyncService.java", "diffHunk": "@@ -16,7 +16,7 @@\n  * limitations under the License.\n  */\n \n-package org.apache.hudi.utilities.deltastreamer;\n+package org.apache.hudi.common.async;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "bcbdae42b758b5297571851c365863a8c2a93961", "author": {"user": {"login": "bvaradar", "name": "Balaji Varadarajan"}}, "url": "https://github.com/apache/hudi/commit/bcbdae42b758b5297571851c365863a8c2a93961", "committedDate": "2020-06-12T05:23:45Z", "message": "[HUDI-855] Run Auto Cleaner in parallel with ingestion"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bcbdae42b758b5297571851c365863a8c2a93961", "author": {"user": {"login": "bvaradar", "name": "Balaji Varadarajan"}}, "url": "https://github.com/apache/hudi/commit/bcbdae42b758b5297571851c365863a8c2a93961", "committedDate": "2020-06-12T05:23:45Z", "message": "[HUDI-855] Run Auto Cleaner in parallel with ingestion"}, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0NDU1NTU2", "url": "https://github.com/apache/hudi/pull/1577#pullrequestreview-434455556", "createdAt": "2020-06-20T21:44:31Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMFQyMTo0NDozMVrOGmoeFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMFQyMTo0NDozMVrOGmoeFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE2MjEzNA==", "bodyText": "@yanghua : I went ahead and removed this class. I have added a jira : https://issues.apache.org/jira/browse/HUDI-1033 to go through other such examples and see if multiple CLI tests are still needed.", "url": "https://github.com/apache/hudi/pull/1577#discussion_r443162134", "createdAt": "2020-06-20T21:44:31Z", "author": {"login": "bvaradar"}, "path": "hudi-cli/src/test/java/org/apache/hudi/cli/integ/ITTestCleansCommand.java", "diffHunk": "@@ -1,106 +0,0 @@\n-/*", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3746e7002ccac79375f6905e1c8964bd03531092", "author": {"user": {"login": "bvaradar", "name": "Balaji Varadarajan"}}, "url": "https://github.com/apache/hudi/commit/3746e7002ccac79375f6905e1c8964bd03531092", "committedDate": "2020-06-28T06:44:47Z", "message": "[HUDI-855] Run Auto Cleaner in parallel with ingestion"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4NzQ3NzE3", "url": "https://github.com/apache/hudi/pull/1577#pullrequestreview-438747717", "createdAt": "2020-06-28T06:20:18Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOFQwNjoyMDoxOFrOGp6uKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOFQwNzoyNzoxMFrOGp7F9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYwNjg4OA==", "bodyText": "org.apache.hudi.client.service is a better location? we should have this, the timeline server etc in a single place?", "url": "https://github.com/apache/hudi/pull/1577#discussion_r446606888", "createdAt": "2020-06-28T06:20:18Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/src/main/java/org/apache/hudi/async/AbstractAsyncService.java", "diffHunk": "@@ -16,7 +16,7 @@\n  * limitations under the License.\n  */\n \n-package org.apache.hudi.utilities.deltastreamer;\n+package org.apache.hudi.async;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYwNjk1MQ==", "bodyText": "we ideally should be reusing the same for #1752 ?", "url": "https://github.com/apache/hudi/pull/1577#discussion_r446606951", "createdAt": "2020-06-28T06:21:03Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/src/main/java/org/apache/hudi/async/AbstractAsyncService.java", "diffHunk": "@@ -32,11 +32,11 @@\n import java.util.function.Function;\n \n /**\n- * Base Class for running delta-sync/compaction in separate thread and controlling their life-cycle.\n+ * Base Class for running clean/delta-sync/compaction in separate thread and controlling their life-cycle.\n  */\n-public abstract class AbstractDeltaStreamerService implements Serializable {\n+public abstract class AbstractAsyncService implements Serializable {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYwODQ3Nw==", "bodyText": "just rename to AsyncCleanerService", "url": "https://github.com/apache/hudi/pull/1577#discussion_r446608477", "createdAt": "2020-06-28T06:39:00Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/src/main/java/org/apache/hudi/client/HoodieWriteClient.java", "diffHunk": "@@ -81,6 +81,8 @@\n   private final transient HoodieMetrics metrics;\n   private transient Timer.Context compactionTimer;\n \n+  private transient AutoCleanerService autoCleanerService;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYwODUyMQ==", "bodyText": "auto or not, is a configuration that should not be leaked into class names.", "url": "https://github.com/apache/hudi/pull/1577#discussion_r446608521", "createdAt": "2020-06-28T06:39:23Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/src/main/java/org/apache/hudi/client/HoodieWriteClient.java", "diffHunk": "@@ -81,6 +81,8 @@\n   private final transient HoodieMetrics metrics;\n   private transient Timer.Context compactionTimer;\n \n+  private transient AutoCleanerService autoCleanerService;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYwODQ3Nw=="}, "originalCommit": null, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYwOTM2Ng==", "bodyText": "there are a lot of terms being overloaded here -- parallel, async, auto.. what you mean by parallel is async.. correct?", "url": "https://github.com/apache/hudi/pull/1577#discussion_r446609366", "createdAt": "2020-06-28T06:48:16Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/src/main/java/org/apache/hudi/client/HoodieWriteClient.java", "diffHunk": "@@ -338,15 +346,27 @@ protected void postCommit(HoodieCommitMetadata metadata, String instantTime,\n       // We cannot have unbounded commit files. Archive commits if we have to archive\n       HoodieTimelineArchiveLog archiveLog = new HoodieTimelineArchiveLog(config, createMetaClient(true));\n       archiveLog.archiveIfRequired(hadoopConf);\n-      if (config.isAutoClean()) {\n-        // Call clean to cleanup if there is anything to cleanup after the commit,\n+      autoCleanOnCommit(instantTime);\n+    } catch (IOException ioe) {\n+      throw new HoodieIOException(ioe.getMessage(), ioe);\n+    }\n+  }\n+\n+  /**\n+   * Handle auto clean during commit.\n+   * @param instantTime\n+   */\n+  private void autoCleanOnCommit(String instantTime) {\n+    if (config.isAutoClean()) {\n+      // Call clean to cleanup if there is anything to cleanup after the commit,\n+      if (config.isRunParallelAutoClean()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYxMTI5Nw==", "bodyText": "This class feels more like a AsyncTask , rather than a service.. i.e something that is long running and accepts tasks.. can we file a follow on to clean this code uop?", "url": "https://github.com/apache/hudi/pull/1577#discussion_r446611297", "createdAt": "2020-06-28T07:09:40Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/src/main/java/org/apache/hudi/client/AutoCleanerService.java", "diffHunk": "@@ -0,0 +1,96 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.client;\n+\n+import org.apache.hudi.async.AbstractAsyncService;\n+import org.apache.hudi.common.util.collection.Pair;\n+import org.apache.hudi.exception.HoodieException;\n+import org.apache.log4j.LogManager;\n+import org.apache.log4j.Logger;\n+\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+\n+/**\n+ * Auto Clean service running concurrently with write operation.\n+ */\n+class AutoCleanerService extends AbstractAsyncService {\n+\n+  private static final Logger LOG = LogManager.getLogger(AutoCleanerService.class);\n+\n+  private final HoodieWriteClient writeClient;\n+  private final String cleanInstant;\n+  private final transient ExecutorService executor = Executors.newFixedThreadPool(1);\n+\n+  protected AutoCleanerService(HoodieWriteClient writeClient, String cleanInstant) {\n+    this.writeClient = writeClient;\n+    this.cleanInstant = cleanInstant;\n+  }\n+\n+  @Override\n+  protected Pair<CompletableFuture, ExecutorService> startService() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYxMTUyNQ==", "bodyText": "how come the return value is never set to the instance variable?", "url": "https://github.com/apache/hudi/pull/1577#discussion_r446611525", "createdAt": "2020-06-28T07:12:19Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/src/main/java/org/apache/hudi/client/HoodieWriteClient.java", "diffHunk": "@@ -254,6 +260,7 @@ public static SparkConf registerClasses(SparkConf conf) {\n     HoodieTable<T> table = getTableAndInitCtx(WriteOperationType.BULK_INSERT);\n     table.validateInsertSchema();\n     setOperationType(WriteOperationType.BULK_INSERT);\n+    AutoCleanerService.spawnAutoCleanerIfEnabled(this, instantTime);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYxMjk4Mw==", "bodyText": "this kind of resetting is probably needed after each write operation as well? may be its fine to just reinitialize the service after waitForCompletion.. food for thought..", "url": "https://github.com/apache/hudi/pull/1577#discussion_r446612983", "createdAt": "2020-06-28T07:27:10Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/src/main/java/org/apache/hudi/client/HoodieWriteClient.java", "diffHunk": "@@ -477,6 +497,8 @@ public HoodieRestoreMetadata restoreToInstant(final String instantTime) throws H\n    */\n   @Override\n   public void close() {\n+    AutoCleanerService.shutdownAutoCleaner(autoCleanerService);\n+    autoCleanerService = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 96}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4739becf6f7860d64cde664e5f997103f65989bd", "author": {"user": {"login": "vinothchandar", "name": "vinoth chandar"}}, "url": "https://github.com/apache/hudi/commit/4739becf6f7860d64cde664e5f997103f65989bd", "committedDate": "2020-06-28T07:40:38Z", "message": "[HUDI-855] Code review comments\n\n - Configs renamed\n - AutoCleanerService renamed more aptly to AsyncCleanerService\n - Fix issue with missed assignment to local variable"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "4739becf6f7860d64cde664e5f997103f65989bd", "author": {"user": {"login": "vinothchandar", "name": "vinoth chandar"}}, "url": "https://github.com/apache/hudi/commit/4739becf6f7860d64cde664e5f997103f65989bd", "committedDate": "2020-06-28T07:40:38Z", "message": "[HUDI-855] Code review comments\n\n - Configs renamed\n - AutoCleanerService renamed more aptly to AsyncCleanerService\n - Fix issue with missed assignment to local variable"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4NzYwNDMz", "url": "https://github.com/apache/hudi/pull/1577#pullrequestreview-438760433", "createdAt": "2020-06-28T09:04:15Z", "commit": {"oid": "4739becf6f7860d64cde664e5f997103f65989bd"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3056, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}