{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgwOTkzMjcy", "number": 2074, "title": "[HUDI-1233] Deltastreamer Kafka consumption delay reporting indicators", "bodyText": "Tips\n\nThank you very much for contributing to Apache Hudi.\nPlease review https://hudi.apache.org/contributing.html before opening a pull request.\n\nWhat is the purpose of the pull request\nCurrently hudi-deltastreamer does not report the indicator of Kafka data consumption delay, I suggest that this function can be added\nCommitter checklist\n\n\n Has a corresponding JIRA in PR title & commit\n\n\n Commit message is descriptive of the change\n\n\n CI is green\n\n\n Necessary doc changes done or have another open PR\n\n\n For large changes, please consider breaking it into sub-tasks under an umbrella JIRA.", "createdAt": "2020-09-07T02:43:09Z", "url": "https://github.com/apache/hudi/pull/2074", "merged": true, "mergeCommit": {"oid": "20b9b399c980270afdd60cc5fbce783c700a8376"}, "closed": true, "closedAt": "2020-09-29T05:44:32Z", "author": {"login": "liujinhui1994"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdGZvzIgH2gAyNDgwOTkzMjcyOmQzNTdhZGE1NWE2OWU2YzM5MjAzNWI3OTViYzgzYmQxYzgzMTcwNzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdNhjK6AFqTQ5ODExMTE2MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d357ada55a69e6c392035b795bc83bd1c8317070", "author": {"user": {"login": "liujinhui1994", "name": "liujinhui"}}, "url": "https://github.com/apache/hudi/commit/d357ada55a69e6c392035b795bc83bd1c8317070", "committedDate": "2020-09-07T02:40:37Z", "message": "HUDI-1233"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d3c82857f0bbae01ab7df8c42b19f1075ac0048", "author": {"user": {"login": "liujinhui1994", "name": "liujinhui"}}, "url": "https://github.com/apache/hudi/commit/4d3c82857f0bbae01ab7df8c42b19f1075ac0048", "committedDate": "2020-09-07T06:17:41Z", "message": "HUDI-1233"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a258c019dc33e928935a6a1725f2792912907ff3", "author": {"user": {"login": "liujinhui1994", "name": "liujinhui"}}, "url": "https://github.com/apache/hudi/commit/a258c019dc33e928935a6a1725f2792912907ff3", "committedDate": "2020-09-16T14:39:44Z", "message": "hudi-1233"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "086cd7db0eb1d9a4f5911f31fca7cb9b431b243b", "author": {"user": {"login": "liujinhui1994", "name": "liujinhui"}}, "url": "https://github.com/apache/hudi/commit/086cd7db0eb1d9a4f5911f31fca7cb9b431b243b", "committedDate": "2020-09-16T14:54:31Z", "message": "Merge branch 'master' into HUDI-1233\n\n# Conflicts:\n#\thudi-utilities/src/main/java/org/apache/hudi/utilities/sources/helpers/KafkaOffsetGen.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwMjA3NTIw", "url": "https://github.com/apache/hudi/pull/2074#pullrequestreview-490207520", "createdAt": "2020-09-17T02:52:55Z", "commit": {"oid": "086cd7db0eb1d9a4f5911f31fca7cb9b431b243b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QwMjo1Mjo1NVrOHTNnRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QwMjo1Mjo1NVrOHTNnRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTkwODAzNw==", "bodyText": "Why two empty lines?", "url": "https://github.com/apache/hudi/pull/2074#discussion_r489908037", "createdAt": "2020-09-17T02:52:55Z", "author": {"login": "yanghua"}, "path": "hudi-utilities/src/main/java/org/apache/hudi/utilities/deltastreamer/DeltaSync.java", "diffHunk": "@@ -191,9 +193,13 @@ public DeltaSync(HoodieDeltaStreamer.Config cfg, SparkSession sparkSession, Sche\n     this.transformer = UtilHelpers.createTransformer(cfg.transformerClassNames);\n     this.keyGenerator = DataSourceUtils.createKeyGenerator(props);\n \n+    this.metrics = new HoodieDeltaStreamerMetrics(getHoodieClientConfig(this.schemaProvider));\n+\n     this.formatAdapter = new SourceFormatAdapter(\n-        UtilHelpers.createSource(cfg.sourceClassName, props, jssc, sparkSession, schemaProvider));\n+        UtilHelpers.createSource(cfg.sourceClassName, props, jssc, sparkSession, schemaProvider, metrics));\n     this.conf = conf;\n+\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "086cd7db0eb1d9a4f5911f31fca7cb9b431b243b"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85aa4a3c0ea12494db45d2b3df3901606f07ff3a", "author": {"user": {"login": "liujinhui1994", "name": "liujinhui"}}, "url": "https://github.com/apache/hudi/commit/85aa4a3c0ea12494db45d2b3df3901606f07ff3a", "committedDate": "2020-09-18T06:39:19Z", "message": "HUDI-1282"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0fb592e72645c45e1cd084ea735ea0eca6c3dffe", "author": {"user": {"login": "liujinhui1994", "name": "liujinhui"}}, "url": "https://github.com/apache/hudi/commit/0fb592e72645c45e1cd084ea735ea0eca6c3dffe", "committedDate": "2020-09-18T06:40:21Z", "message": "HUDI-1282"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de68e7a5addf4a333039a13b744e932db0cfba81", "author": {"user": {"login": "liujinhui1994", "name": "liujinhui"}}, "url": "https://github.com/apache/hudi/commit/de68e7a5addf4a333039a13b744e932db0cfba81", "committedDate": "2020-09-25T15:23:32Z", "message": "Merge branch 'master' into HUDI-1233\n\n# Conflicts:\n#\thudi-utilities/src/main/java/org/apache/hudi/utilities/sources/helpers/KafkaOffsetGen.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "765d7df68c4b0f4923df6bf834032e1ed56df4c7", "author": {"user": {"login": "liujinhui1994", "name": "liujinhui"}}, "url": "https://github.com/apache/hudi/commit/765d7df68c4b0f4923df6bf834032e1ed56df4c7", "committedDate": "2020-09-25T15:26:00Z", "message": "Merge branch 'master' into HUDI-1233\n\n# Conflicts:\n#\thudi-utilities/src/main/java/org/apache/hudi/utilities/sources/helpers/KafkaOffsetGen.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a60ed846064adc016146783b09f1061c5456e14", "author": {"user": {"login": "liujinhui1994", "name": "liujinhui"}}, "url": "https://github.com/apache/hudi/commit/3a60ed846064adc016146783b09f1061c5456e14", "committedDate": "2020-09-25T15:37:08Z", "message": "Merge branch 'master' into HUDI-1233\n\n# Conflicts:\n#\thudi-utilities/src/main/java/org/apache/hudi/utilities/UtilHelpers.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "53dcd36258f746ed5ae1629dfccb58f911712b8d", "author": {"user": {"login": "liujinhui1994", "name": "liujinhui"}}, "url": "https://github.com/apache/hudi/commit/53dcd36258f746ed5ae1629dfccb58f911712b8d", "committedDate": "2020-09-26T03:22:05Z", "message": "hudi-1233"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed39ee43058bbd3efd46400a9801a0401150e4ea", "author": {"user": {"login": "liujinhui1994", "name": "liujinhui"}}, "url": "https://github.com/apache/hudi/commit/ed39ee43058bbd3efd46400a9801a0401150e4ea", "committedDate": "2020-09-26T03:50:34Z", "message": "hudi-1233"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3MDQxOTI4", "url": "https://github.com/apache/hudi/pull/2074#pullrequestreview-497041928", "createdAt": "2020-09-27T01:36:09Z", "commit": {"oid": "ed39ee43058bbd3efd46400a9801a0401150e4ea"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QwMTozNjowOVrOHYjyqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QwMjoxMDoxM1rOHYj8Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUxNDI4Mg==", "bodyText": "Replace class name  with XXX.class.getName() should be better", "url": "https://github.com/apache/hudi/pull/2074#discussion_r495514282", "createdAt": "2020-09-27T01:36:09Z", "author": {"login": "wangxianghu"}, "path": "hudi-utilities/src/main/java/org/apache/hudi/utilities/deltastreamer/DeltaSync.java", "diffHunk": "@@ -190,8 +192,16 @@ public DeltaSync(HoodieDeltaStreamer.Config cfg, SparkSession sparkSession, Sche\n     this.transformer = UtilHelpers.createTransformer(cfg.transformerClassNames);\n     this.keyGenerator = DataSourceUtils.createKeyGenerator(props);\n \n-    this.formatAdapter = new SourceFormatAdapter(\n-        UtilHelpers.createSource(cfg.sourceClassName, props, jssc, sparkSession, schemaProvider));\n+    this.metrics = new HoodieDeltaStreamerMetrics(getHoodieClientConfig(this.schemaProvider));\n+\n+    if (\"org.apache.hudi.utilities.sources.JsonKafkaSource\".equals(cfg.sourceClassName)\n+            || \"org.apache.hudi.utilities.sources.AvroKafkaSource\".equals(cfg.sourceClassName)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed39ee43058bbd3efd46400a9801a0401150e4ea"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUxNjcyMg==", "bodyText": "@liujinhui1994 thanks for your contribution, I left some comments you can consider.", "url": "https://github.com/apache/hudi/pull/2074#discussion_r495516722", "createdAt": "2020-09-27T02:10:13Z", "author": {"login": "wangxianghu"}, "path": "hudi-utilities/src/test/java/org/apache/hudi/utilities/sources/TestKafkaSource.java", "diffHunk": "@@ -242,7 +245,7 @@ public void testJsonKafkaSourceWithConfigurableUpperCap() {\n     HoodieTestDataGenerator dataGenerator = new HoodieTestDataGenerator();\n     TypedProperties props = createPropsForJsonSource(500L, \"earliest\");\n \n-    Source jsonSource = new JsonKafkaSource(props, jsc, sparkSession, schemaProvider);\n+    Source jsonSource = new JsonKafkaSource(props, jsc, sparkSession, schemaProvider, metrics);\n     SourceFormatAdapter kafkaSource = new SourceFormatAdapter(jsonSource);\n \n     // 1. Extract without any checkpoint => get all the data, respecting sourceLimit", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed39ee43058bbd3efd46400a9801a0401150e4ea"}, "originalPosition": 73}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da4b7808fbf299645670183fac0b3b05a586d436", "author": {"user": {"login": "liujinhui1994", "name": "liujinhui"}}, "url": "https://github.com/apache/hudi/commit/da4b7808fbf299645670183fac0b3b05a586d436", "committedDate": "2020-09-27T02:27:27Z", "message": "HUDI-1233"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3MDQ1MzE0", "url": "https://github.com/apache/hudi/pull/2074#pullrequestreview-497045314", "createdAt": "2020-09-27T02:47:02Z", "commit": {"oid": "da4b7808fbf299645670183fac0b3b05a586d436"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QwMjo0NzowM1rOHYkGpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QwMjo0NzowM1rOHYkGpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUxOTM5Nw==", "bodyText": "Move this check into UtilHelpers#createSource?  use different constructor according to source type\nthis can avoid checking two times", "url": "https://github.com/apache/hudi/pull/2074#discussion_r495519397", "createdAt": "2020-09-27T02:47:03Z", "author": {"login": "wangxianghu"}, "path": "hudi-utilities/src/main/java/org/apache/hudi/utilities/deltastreamer/DeltaSync.java", "diffHunk": "@@ -190,8 +194,16 @@ public DeltaSync(HoodieDeltaStreamer.Config cfg, SparkSession sparkSession, Sche\n     this.transformer = UtilHelpers.createTransformer(cfg.transformerClassNames);\n     this.keyGenerator = DataSourceUtils.createKeyGenerator(props);\n \n-    this.formatAdapter = new SourceFormatAdapter(\n-        UtilHelpers.createSource(cfg.sourceClassName, props, jssc, sparkSession, schemaProvider));\n+    this.metrics = new HoodieDeltaStreamerMetrics(getHoodieClientConfig(this.schemaProvider));\n+\n+    if (JsonKafkaSource.class.getName().equals(cfg.sourceClassName)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "da4b7808fbf299645670183fac0b3b05a586d436"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c404b86975ee84fdc8de271915ffc81c3da0148b", "author": {"user": {"login": "liujinhui1994", "name": "liujinhui"}}, "url": "https://github.com/apache/hudi/commit/c404b86975ee84fdc8de271915ffc81c3da0148b", "committedDate": "2020-09-27T03:35:44Z", "message": "HUDI-1233"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37eaf056a1763394fe46147462eb7df97cd01d4c", "author": {"user": {"login": "liujinhui1994", "name": "liujinhui"}}, "url": "https://github.com/apache/hudi/commit/37eaf056a1763394fe46147462eb7df97cd01d4c", "committedDate": "2020-09-27T06:35:23Z", "message": "HUDI-1233"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fbf281f59d808b3ea021012019d3f35ce524fa15", "author": {"user": {"login": "liujinhui1994", "name": "liujinhui"}}, "url": "https://github.com/apache/hudi/commit/fbf281f59d808b3ea021012019d3f35ce524fa15", "committedDate": "2020-09-27T08:39:07Z", "message": "HUDI-1233"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3MTMwNzkz", "url": "https://github.com/apache/hudi/pull/2074#pullrequestreview-497130793", "createdAt": "2020-09-28T00:32:35Z", "commit": {"oid": "fbf281f59d808b3ea021012019d3f35ce524fa15"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQwMDozMjozNVrOHYrbLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQwMDozNTozNlrOHYrcsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTYzOTM0Mg==", "bodyText": "Why change this indent?", "url": "https://github.com/apache/hudi/pull/2074#discussion_r495639342", "createdAt": "2020-09-28T00:32:35Z", "author": {"login": "yanghua"}, "path": "hudi-utilities/src/main/java/org/apache/hudi/utilities/UtilHelpers.java", "diffHunk": "@@ -93,11 +96,19 @@\n   private static final Logger LOG = LogManager.getLogger(UtilHelpers.class);\n \n   public static Source createSource(String sourceClass, TypedProperties cfg, JavaSparkContext jssc,\n-                                    SparkSession sparkSession, SchemaProvider schemaProvider) throws IOException {\n+                                    SparkSession sparkSession, SchemaProvider schemaProvider, HoodieDeltaStreamerMetrics metrics) throws IOException {\n+\n     try {\n+      if (JsonKafkaSource.class.getName().equals(sourceClass)\n+              || AvroKafkaSource.class.getName().equals(sourceClass)) {\n+        return (Source) ReflectionUtils.loadClass(sourceClass,\n+                new Class<?>[]{TypedProperties.class, JavaSparkContext.class, SparkSession.class, SchemaProvider.class, HoodieDeltaStreamerMetrics.class}, cfg,\n+                jssc, sparkSession, schemaProvider, metrics);\n+      }\n+\n       return (Source) ReflectionUtils.loadClass(sourceClass,\n-          new Class<?>[] {TypedProperties.class, JavaSparkContext.class, SparkSession.class, SchemaProvider.class}, cfg,\n-          jssc, sparkSession, schemaProvider);\n+              new Class<?>[] {TypedProperties.class, JavaSparkContext.class, SparkSession.class, SchemaProvider.class}, cfg,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fbf281f59d808b3ea021012019d3f35ce524fa15"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTYzOTM5NQ==", "bodyText": "The first indent is correct?", "url": "https://github.com/apache/hudi/pull/2074#discussion_r495639395", "createdAt": "2020-09-28T00:32:58Z", "author": {"login": "yanghua"}, "path": "hudi-utilities/src/main/java/org/apache/hudi/utilities/deltastreamer/DeltaSync.java", "diffHunk": "@@ -190,8 +192,10 @@ public DeltaSync(HoodieDeltaStreamer.Config cfg, SparkSession sparkSession, Sche\n     this.transformer = UtilHelpers.createTransformer(cfg.transformerClassNames);\n     this.keyGenerator = DataSourceUtils.createKeyGenerator(props);\n \n+    this.metrics = new HoodieDeltaStreamerMetrics(getHoodieClientConfig(this.schemaProvider));\n+\n     this.formatAdapter = new SourceFormatAdapter(\n-        UtilHelpers.createSource(cfg.sourceClassName, props, jssc, sparkSession, schemaProvider));\n+         UtilHelpers.createSource(cfg.sourceClassName, props, jssc, sparkSession, schemaProvider, metrics));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fbf281f59d808b3ea021012019d3f35ce524fa15"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTYzOTczMQ==", "bodyText": "delayOffectCalculation  -> delayOffsetCalculation ?", "url": "https://github.com/apache/hudi/pull/2074#discussion_r495639731", "createdAt": "2020-09-28T00:35:36Z", "author": {"login": "yanghua"}, "path": "hudi-utilities/src/main/java/org/apache/hudi/utilities/sources/helpers/KafkaOffsetGen.java", "diffHunk": "@@ -233,6 +235,18 @@ public KafkaOffsetGen(TypedProperties props) {\n     return checkpointOffsetReseter ? earliestOffsets : checkpointOffsets;\n   }\n \n+  private Long delayOffectCalculation(Option<String> lastCheckpointStr, Set<TopicPartition> topicPartitions, KafkaConsumer consumer) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fbf281f59d808b3ea021012019d3f35ce524fa15"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "625bd7fa9719fdb65fbfdaca3594be509dfd35e1", "author": {"user": {"login": "liujinhui1994", "name": "liujinhui"}}, "url": "https://github.com/apache/hudi/commit/625bd7fa9719fdb65fbfdaca3594be509dfd35e1", "committedDate": "2020-09-28T01:17:12Z", "message": "HUDI-1233"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "478633269aafefcb7fdc8f0c2d12dc2bb93387df", "author": {"user": {"login": "liujinhui1994", "name": "liujinhui"}}, "url": "https://github.com/apache/hudi/commit/478633269aafefcb7fdc8f0c2d12dc2bb93387df", "committedDate": "2020-09-29T02:51:11Z", "message": "HUDI-1233"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk4MTExMTYw", "url": "https://github.com/apache/hudi/pull/2074#pullrequestreview-498111160", "createdAt": "2020-09-29T05:43:32Z", "commit": {"oid": "478633269aafefcb7fdc8f0c2d12dc2bb93387df"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4514, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}