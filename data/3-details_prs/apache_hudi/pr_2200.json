{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA4MzA4NDU5", "number": 2200, "title": "[HUDI-912]Refactor and relocate KeyGenerator to support more engines", "bodyText": "Tips\n\nThank you very much for contributing to Apache Hudi.\nPlease review https://hudi.apache.org/contributing.html before opening a pull request.\n\nWhat is the purpose of the pull request\nRefactor and relocate KeyGenerator to support more engines\nBrief change log\n*Currently, keyGenerators are implemented in hudi-spark module,  they can only be used by spark engine.\nSince keyGenerator is a core tool for hudi, they should be engine-independent.*\nVerify this pull request\nThis pull request is already covered by existing tests, such as (please describe tests).\nCommitter checklist\n\n\n Has a corresponding JIRA in PR title & commit\n\n\n Commit message is descriptive of the change\n\n\n CI is green\n\n\n Necessary doc changes done or have another open PR\n\n\n For large changes, please consider breaking it into sub-tasks under an umbrella JIRA.", "createdAt": "2020-10-22T13:51:53Z", "url": "https://github.com/apache/hudi/pull/2200", "merged": true, "mergeCommit": {"oid": "d160abb43740e0bcdf40458c345ecd2d74e6698c"}, "closed": true, "closedAt": "2020-11-02T21:12:52Z", "author": {"login": "wangxianghu"}, "timelineItems": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdVCYWTgBqjM5MDkyMTc0MTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXvhPEAH2gAyNTA4MzA4NDU5OmRlODE2OWQxYTI5NTUyMjMyYjdiZmI1ZWJmYjIyMjg2MjA0MjYwY2U=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d7d5edc70053e202e6c63e783494663c70d4463c", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/d7d5edc70053e202e6c63e783494663c70d4463c", "committedDate": "2020-10-22T13:49:46Z", "message": "[HUDI-912][WIP]Refactor and relocate KeyGenerator to support more engines"}, "afterCommit": {"oid": "c34ace12afae11a6011a6d4933c4c554118cc82e", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/c34ace12afae11a6011a6d4933c4c554118cc82e", "committedDate": "2020-10-22T13:55:20Z", "message": "[HUDI-912][WIP]Refactor and relocate KeyGenerator to support more engines"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c34ace12afae11a6011a6d4933c4c554118cc82e", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/c34ace12afae11a6011a6d4933c4c554118cc82e", "committedDate": "2020-10-22T13:55:20Z", "message": "[HUDI-912][WIP]Refactor and relocate KeyGenerator to support more engines"}, "afterCommit": {"oid": "26d6459163dc0e1afa93fd9ace47fa23f7cd1cac", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/26d6459163dc0e1afa93fd9ace47fa23f7cd1cac", "committedDate": "2020-10-23T03:05:03Z", "message": "[HUDI-912][WIP]Refactor and relocate KeyGenerator to support more engines"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "26d6459163dc0e1afa93fd9ace47fa23f7cd1cac", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/26d6459163dc0e1afa93fd9ace47fa23f7cd1cac", "committedDate": "2020-10-23T03:05:03Z", "message": "[HUDI-912][WIP]Refactor and relocate KeyGenerator to support more engines"}, "afterCommit": {"oid": "de9dc93ff7341d9f818727c984f9a9989b0b4be6", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/de9dc93ff7341d9f818727c984f9a9989b0b4be6", "committedDate": "2020-10-23T03:41:41Z", "message": "[HUDI-912][WIP]Refactor and relocate KeyGenerator to support more engines"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "de9dc93ff7341d9f818727c984f9a9989b0b4be6", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/de9dc93ff7341d9f818727c984f9a9989b0b4be6", "committedDate": "2020-10-23T03:41:41Z", "message": "[HUDI-912][WIP]Refactor and relocate KeyGenerator to support more engines"}, "afterCommit": {"oid": "1d7b1778c0acc7c42867230b2cd0500a33cacf10", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/1d7b1778c0acc7c42867230b2cd0500a33cacf10", "committedDate": "2020-10-23T04:32:38Z", "message": "[HUDI-912][WIP]Refactor and relocate KeyGenerator to support more engines"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1d7b1778c0acc7c42867230b2cd0500a33cacf10", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/1d7b1778c0acc7c42867230b2cd0500a33cacf10", "committedDate": "2020-10-23T04:32:38Z", "message": "[HUDI-912][WIP]Refactor and relocate KeyGenerator to support more engines"}, "afterCommit": {"oid": "66aea93da8c1aa3254b835cfa5e4fa8593f7b094", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/66aea93da8c1aa3254b835cfa5e4fa8593f7b094", "committedDate": "2020-10-23T05:00:40Z", "message": "[HUDI-912][WIP]Refactor and relocate KeyGenerator to support more engines"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "66aea93da8c1aa3254b835cfa5e4fa8593f7b094", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/66aea93da8c1aa3254b835cfa5e4fa8593f7b094", "committedDate": "2020-10-23T05:00:40Z", "message": "[HUDI-912][WIP]Refactor and relocate KeyGenerator to support more engines"}, "afterCommit": {"oid": "a7c54a88e0426f25665624b25cbe7efebea54f6e", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/a7c54a88e0426f25665624b25cbe7efebea54f6e", "committedDate": "2020-10-23T05:04:43Z", "message": "[HUDI-912][WIP]Refactor and relocate KeyGenerator to support more engines"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a7c54a88e0426f25665624b25cbe7efebea54f6e", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/a7c54a88e0426f25665624b25cbe7efebea54f6e", "committedDate": "2020-10-23T05:04:43Z", "message": "[HUDI-912][WIP]Refactor and relocate KeyGenerator to support more engines"}, "afterCommit": {"oid": "8bdea5d0f14ad0c47f671f01cf5fef4457c87677", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/8bdea5d0f14ad0c47f671f01cf5fef4457c87677", "committedDate": "2020-10-23T05:09:38Z", "message": "[HUDI-912][WIP]Refactor and relocate KeyGenerator to support more engines"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8bdea5d0f14ad0c47f671f01cf5fef4457c87677", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/8bdea5d0f14ad0c47f671f01cf5fef4457c87677", "committedDate": "2020-10-23T05:09:38Z", "message": "[HUDI-912][WIP]Refactor and relocate KeyGenerator to support more engines"}, "afterCommit": {"oid": "12d34b1c1f89d2a48de04d52ec925d9d9733cc1f", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/12d34b1c1f89d2a48de04d52ec925d9d9733cc1f", "committedDate": "2020-10-23T05:12:22Z", "message": "[HUDI-912][WIP]Refactor and relocate KeyGenerator to support more engines"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "12d34b1c1f89d2a48de04d52ec925d9d9733cc1f", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/12d34b1c1f89d2a48de04d52ec925d9d9733cc1f", "committedDate": "2020-10-23T05:12:22Z", "message": "[HUDI-912][WIP]Refactor and relocate KeyGenerator to support more engines"}, "afterCommit": {"oid": "970a6e5ba50e003576f08b889d8d9552945f8e7d", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/970a6e5ba50e003576f08b889d8d9552945f8e7d", "committedDate": "2020-10-23T05:16:14Z", "message": "[HUDI-912][WIP]Refactor and relocate KeyGenerator to support more engines"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "970a6e5ba50e003576f08b889d8d9552945f8e7d", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/970a6e5ba50e003576f08b889d8d9552945f8e7d", "committedDate": "2020-10-23T05:16:14Z", "message": "[HUDI-912][WIP]Refactor and relocate KeyGenerator to support more engines"}, "afterCommit": {"oid": "7dcd1156d0a8ec55cdcaf1125bf4d568e6062c32", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/7dcd1156d0a8ec55cdcaf1125bf4d568e6062c32", "committedDate": "2020-10-23T14:28:02Z", "message": "[HUDI-912][WIP]Refactor and relocate KeyGenerator to support more engines"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7dcd1156d0a8ec55cdcaf1125bf4d568e6062c32", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/7dcd1156d0a8ec55cdcaf1125bf4d568e6062c32", "committedDate": "2020-10-23T14:28:02Z", "message": "[HUDI-912][WIP]Refactor and relocate KeyGenerator to support more engines"}, "afterCommit": {"oid": "f1a0256db22b786983f49c5d0a8e704ab1c74ece", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/f1a0256db22b786983f49c5d0a8e704ab1c74ece", "committedDate": "2020-10-23T15:25:47Z", "message": "[HUDI-912][WIP]Refactor and relocate KeyGenerator to support more engines"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f1a0256db22b786983f49c5d0a8e704ab1c74ece", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/f1a0256db22b786983f49c5d0a8e704ab1c74ece", "committedDate": "2020-10-23T15:25:47Z", "message": "[HUDI-912][WIP]Refactor and relocate KeyGenerator to support more engines"}, "afterCommit": {"oid": "9edd7ea4edde76b31e61ec44d75401d939d4275f", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/9edd7ea4edde76b31e61ec44d75401d939d4275f", "committedDate": "2020-10-24T02:01:48Z", "message": "[HUDI-912] Refactor and relocate KeyGenerator to support more engines"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4NzEyMTMy", "url": "https://github.com/apache/hudi/pull/2200#pullrequestreview-518712132", "createdAt": "2020-10-28T14:18:20Z", "commit": {"oid": "9edd7ea4edde76b31e61ec44d75401d939d4275f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxNDoxODoyMFrOHpsWxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxNDoxODoyMFrOHpsWxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzQ4MDM5MQ==", "bodyText": "would this change the above behavior? above would also get row.get", "url": "https://github.com/apache/hudi/pull/2200#discussion_r513480391", "createdAt": "2020-10-28T14:18:20Z", "author": {"login": "leesf"}, "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/keygen/CustomKeyGenerator.java", "diffHunk": "@@ -94,27 +82,18 @@ private String getPartitionPath(Option<GenericRecord> record, Option<Row> row) {\n       PartitionKeyType keyType = PartitionKeyType.valueOf(fieldWithType[1].toUpperCase());\n       switch (keyType) {\n         case SIMPLE:\n-          if (record.isPresent()) {\n-            partitionPath.append(new SimpleKeyGenerator(config, partitionPathField).getPartitionPath(record.get()));\n-          } else {\n-            partitionPath.append(new SimpleKeyGenerator(config, partitionPathField).getPartitionPath(row.get()));\n-          }\n+          partitionPath.append(new SimpleKeyGenerator(config, partitionPathField).getPartitionPath(record));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9edd7ea4edde76b31e61ec44d75401d939d4275f"}, "originalPosition": 50}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4NzE1MzI1", "url": "https://github.com/apache/hudi/pull/2200#pullrequestreview-518715325", "createdAt": "2020-10-28T14:21:17Z", "commit": {"oid": "9edd7ea4edde76b31e61ec44d75401d939d4275f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxNDoyMToxN1rOHpsf_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxNDoyMToxN1rOHpsf_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzQ4Mjc0OA==", "bodyText": "does it exist before\uff1f", "url": "https://github.com/apache/hudi/pull/2200#discussion_r513482748", "createdAt": "2020-10-28T14:21:17Z", "author": {"login": "leesf"}, "path": "hudi-client/hudi-spark-client/pom.xml", "diffHunk": "@@ -31,6 +31,13 @@\n   <packaging>jar</packaging>\n \n   <dependencies>\n+    <!-- Scala -->\n+    <dependency>\n+      <groupId>org.scala-lang</groupId>\n+      <artifactId>scala-library</artifactId>\n+      <version>${scala.version}</version>\n+    </dependency>\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9edd7ea4edde76b31e61ec44d75401d939d4275f"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4NzE2ODk2", "url": "https://github.com/apache/hudi/pull/2200#pullrequestreview-518716896", "createdAt": "2020-10-28T14:22:41Z", "commit": {"oid": "9edd7ea4edde76b31e61ec44d75401d939d4275f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxNDoyMjo0MVrOHpskgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxNDoyMjo0MVrOHpskgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzQ4MzkwNA==", "bodyText": "looks like the above logic move to this place.", "url": "https://github.com/apache/hudi/pull/2200#discussion_r513483904", "createdAt": "2020-10-28T14:22:41Z", "author": {"login": "leesf"}, "path": "hudi-client/hudi-spark-client/src/main/java/org/apache/hudi/keygen/SparkCustomKeyGenerator.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.keygen;\n+\n+import org.apache.avro.generic.GenericRecord;\n+import org.apache.hudi.common.config.TypedProperties;\n+import org.apache.hudi.common.util.Option;\n+import org.apache.hudi.exception.HoodieDeltaStreamerException;\n+import org.apache.hudi.exception.HoodieKeyException;\n+import org.apache.hudi.keygen.common.KeyGeneratorOptions;\n+import org.apache.spark.sql.Row;\n+\n+import java.io.IOException;\n+import java.util.Arrays;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * This is a generic implementation of KeyGenerator where users can configure record key as a single field or a combination of fields. Similarly partition path can be configured to have multiple\n+ * fields or only one field. This class expects value for prop \"hoodie.datasource.write.partitionpath.field\" in a specific format. For example:\n+ *\n+ * properties.put(\"hoodie.datasource.write.partitionpath.field\", \"field1:PartitionKeyType1,field2:PartitionKeyType2\").\n+ *\n+ * The complete partition path is created as <value for field1 basis PartitionKeyType1>/<value for field2 basis PartitionKeyType2> and so on.\n+ *\n+ * Few points to consider: 1. If you want to customize some partition path field on a timestamp basis, you can use field1:timestampBased 2. If you simply want to have the value of your configured\n+ * field in the partition path, use field1:simple 3. If you want your table to be non partitioned, simply leave it as blank.\n+ *\n+ * RecordKey is internally generated using either SimpleKeyGenerator or ComplexKeyGenerator.\n+ */\n+public class SparkCustomKeyGenerator extends BaseSparkKeyGenerator {\n+\n+  private CustomKeyGenerator customKeyGenerator;\n+\n+  public SparkCustomKeyGenerator(TypedProperties props) {\n+    super(props);\n+    this.recordKeyFields = Arrays.stream(props.getString(KeyGeneratorOptions.RECORDKEY_FIELD_OPT_KEY).split(\",\")).map(String::trim).collect(Collectors.toList());\n+    this.partitionPathFields = Arrays.stream(props.getString(KeyGeneratorOptions.PARTITIONPATH_FIELD_OPT_KEY).split(\",\")).map(String::trim).collect(Collectors.toList());\n+    customKeyGenerator = new CustomKeyGenerator(props);\n+  }\n+\n+  @Override\n+  public String getRecordKey(GenericRecord record) {\n+    return customKeyGenerator.getRecordKey(record);\n+  }\n+\n+  @Override\n+  public String getPartitionPath(GenericRecord record) {\n+    return customKeyGenerator.getPartitionPath(record);\n+  }\n+\n+  @Override\n+  public String getRecordKey(Row row) {\n+    validateRecordKeyFields();\n+    return getRecordKeyFields().size() == 1\n+        ? new SparkSimpleKeyGenerator(config).getRecordKey(row)\n+        : new SparkComplexKeyGenerator(config).getRecordKey(row);\n+  }\n+\n+  @Override\n+  public String getPartitionPath(Row row) {\n+    return getPartitionPath(Option.empty(), Option.of(row));\n+  }\n+\n+  private String getPartitionPath(Option<GenericRecord> record, Option<Row> row) {\n+    if (getPartitionPathFields() == null) {\n+      throw new HoodieKeyException(\"Unable to find field names for partition path in cfg\");\n+    }\n+\n+    String partitionPathField;\n+    StringBuilder partitionPath = new StringBuilder();\n+\n+    //Corresponds to no partition case\n+    if (getPartitionPathFields().size() == 1 && getPartitionPathFields().get(0).isEmpty()) {\n+      return \"\";\n+    }\n+    for (String field : getPartitionPathFields()) {\n+      String[] fieldWithType = field.split(customKeyGenerator.getSplitRegex());\n+      if (fieldWithType.length != 2) {\n+        throw new HoodieKeyException(\"Unable to find field names for partition path in proper format\");\n+      }\n+\n+      partitionPathField = fieldWithType[0];\n+      CustomKeyGenerator.PartitionKeyType keyType = CustomKeyGenerator.PartitionKeyType.valueOf(fieldWithType[1].toUpperCase());\n+      switch (keyType) {\n+        case SIMPLE:\n+          if (record.isPresent()) {\n+            partitionPath.append(new SparkSimpleKeyGenerator(config, partitionPathField).getPartitionPath(record.get()));\n+          } else {\n+            partitionPath.append(new SparkSimpleKeyGenerator(config, partitionPathField).getPartitionPath(row.get()));\n+          }\n+          break;\n+        case TIMESTAMP:\n+          try {\n+            if (record.isPresent()) {\n+              partitionPath.append(new SparkTimestampBasedKeyGenerator(config, partitionPathField).getPartitionPath(record.get()));\n+            } else {\n+              partitionPath.append(new SparkTimestampBasedKeyGenerator(config, partitionPathField).getPartitionPath(row.get()));\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9edd7ea4edde76b31e61ec44d75401d939d4275f"}, "originalPosition": 114}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9edd7ea4edde76b31e61ec44d75401d939d4275f", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/9edd7ea4edde76b31e61ec44d75401d939d4275f", "committedDate": "2020-10-24T02:01:48Z", "message": "[HUDI-912] Refactor and relocate KeyGenerator to support more engines"}, "afterCommit": {"oid": "74dbcf94b8f8ea50877f8fa27632cb8625e56eb4", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/74dbcf94b8f8ea50877f8fa27632cb8625e56eb4", "committedDate": "2020-10-29T08:45:14Z", "message": "[HUDI-912] Refactor and relocate KeyGenerator to support more engines"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "74dbcf94b8f8ea50877f8fa27632cb8625e56eb4", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/74dbcf94b8f8ea50877f8fa27632cb8625e56eb4", "committedDate": "2020-10-29T08:45:14Z", "message": "[HUDI-912] Refactor and relocate KeyGenerator to support more engines"}, "afterCommit": {"oid": "9a9c9d2b26863b4165d93f9ffc85f61a80ec21f9", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/9a9c9d2b26863b4165d93f9ffc85f61a80ec21f9", "committedDate": "2020-10-29T13:54:34Z", "message": "[HUDI-912] Refactor and relocate KeyGenerator to support more engines"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwMzUwNjUz", "url": "https://github.com/apache/hudi/pull/2200#pullrequestreview-520350653", "createdAt": "2020-10-30T03:13:36Z", "commit": {"oid": "9a9c9d2b26863b4165d93f9ffc85f61a80ec21f9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQwMzoxMzozN1rOHq6spg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQwMzoxMzozN1rOHq6spg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDc2Mzk0Mg==", "bodyText": "This is what I meant in the first comment. we have to be backwards compatible with existing clients. It will be disruptive change for everyone to reconfigure all their jobs. Can we avoid renaming of keygenerator classes or changing their package names", "url": "https://github.com/apache/hudi/pull/2200#discussion_r514763942", "createdAt": "2020-10-30T03:13:37Z", "author": {"login": "vinothchandar"}, "path": "hudi-cli/src/main/java/org/apache/hudi/cli/commands/BootstrapCommand.java", "diffHunk": "@@ -68,7 +68,7 @@ public String bootstrap(\n           help = \"Bootstrap Index Class\") final String bootstrapIndexClass,\n       @CliOption(key = {\"selectorClass\"}, unspecifiedDefaultValue = \"org.apache.hudi.client.bootstrap.selector.MetadataOnlyBootstrapModeSelector\",\n           help = \"Selector class for bootstrap\") final String selectorClass,\n-      @CliOption(key = {\"keyGeneratorClass\"}, unspecifiedDefaultValue = \"org.apache.hudi.keygen.SimpleKeyGenerator\",\n+      @CliOption(key = {\"keyGeneratorClass\"}, unspecifiedDefaultValue = \"org.apache.hudi.keygen.SparkSimpleKeyGenerator\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a9c9d2b26863b4165d93f9ffc85f61a80ec21f9"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6be7a546e1c4ef26be51602c1ce9a08d88250d74", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/6be7a546e1c4ef26be51602c1ce9a08d88250d74", "committedDate": "2020-10-30T08:30:38Z", "message": "[HUDI-912] Refactor and relocate KeyGenerator to support more engines"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9a9c9d2b26863b4165d93f9ffc85f61a80ec21f9", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/9a9c9d2b26863b4165d93f9ffc85f61a80ec21f9", "committedDate": "2020-10-29T13:54:34Z", "message": "[HUDI-912] Refactor and relocate KeyGenerator to support more engines"}, "afterCommit": {"oid": "6be7a546e1c4ef26be51602c1ce9a08d88250d74", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/6be7a546e1c4ef26be51602c1ce9a08d88250d74", "committedDate": "2020-10-30T08:30:38Z", "message": "[HUDI-912] Refactor and relocate KeyGenerator to support more engines"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwNDczNzQz", "url": "https://github.com/apache/hudi/pull/2200#pullrequestreview-520473743", "createdAt": "2020-10-30T08:53:54Z", "commit": {"oid": "6be7a546e1c4ef26be51602c1ce9a08d88250d74"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQwODo1Mzo1NFrOHrGEwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQwODo1Mzo1NFrOHrGEwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDk1MDMzNw==", "bodyText": "Those CommonKeyGenerators can be used for both flink and java engine.\nI will add some flink specific KeyGenerators  when flink implementation(#2176) is  landed", "url": "https://github.com/apache/hudi/pull/2200#discussion_r514950337", "createdAt": "2020-10-30T08:53:54Z", "author": {"login": "wangxianghu"}, "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/keygen/CommonComplexKeyGenerator.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6be7a546e1c4ef26be51602c1ce9a08d88250d74"}, "originalPosition": 1}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwODUxMjg3", "url": "https://github.com/apache/hudi/pull/2200#pullrequestreview-520851287", "createdAt": "2020-10-30T16:48:27Z", "commit": {"oid": "6be7a546e1c4ef26be51602c1ce9a08d88250d74"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxNjo0ODoyN1rOHrXdQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQyMTo0MzowOFrOHrhREA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIzNTEzNg==", "bodyText": "rename: HoodieKeyGeneratorException", "url": "https://github.com/apache/hudi/pull/2200#discussion_r515235136", "createdAt": "2020-10-30T16:48:27Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/exception/HoodieKeyGenerateException.java", "diffHunk": "@@ -0,0 +1,33 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.exception;\n+\n+/**\n+ * Exception thrown for any higher level errors when {@link org.apache.hudi.keygen.KeyGeneratorInterface} is generating\n+ * a {@link org.apache.hudi.common.model.HoodieKey}.\n+ */\n+public class HoodieKeyGenerateException extends HoodieException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6be7a546e1c4ef26be51602c1ce9a08d88250d74"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTM5NDk4Ng==", "bodyText": "what the user sets is is actually DataSourceWriteOptions.RECORDKEY_FIELD_OPT_KEY(). So might be good to avoid duplicating this in KeyGeneratorOptions.RECORDKEY_FIELD_OPT_KEY . can we revert?", "url": "https://github.com/apache/hudi/pull/2200#discussion_r515394986", "createdAt": "2020-10-30T21:40:44Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-spark-client/src/main/java/org/apache/hudi/keygen/ComplexKeyGenerator.java", "diffHunk": "@@ -18,38 +17,38 @@\n \n package org.apache.hudi.keygen;\n \n-import org.apache.hudi.DataSourceWriteOptions;\n-import org.apache.hudi.common.config.TypedProperties;\n-\n import org.apache.avro.generic.GenericRecord;\n+import org.apache.hudi.common.config.TypedProperties;\n+import org.apache.hudi.keygen.constant.KeyGeneratorOptions;\n+import org.apache.spark.sql.Row;\n \n import java.util.Arrays;\n import java.util.stream.Collectors;\n-import org.apache.spark.sql.Row;\n \n /**\n  * Complex key generator, which takes names of fields to be used for recordKey and partitionPath as configs.\n  */\n public class ComplexKeyGenerator extends BuiltinKeyGenerator {\n \n-  public static final String DEFAULT_RECORD_KEY_SEPARATOR = \":\";\n+  private CommonComplexKeyGenerator commonComplexKeyGenerator;\n \n   public ComplexKeyGenerator(TypedProperties props) {\n     super(props);\n-    this.recordKeyFields = Arrays.stream(props.getString(DataSourceWriteOptions.RECORDKEY_FIELD_OPT_KEY())\n+    this.recordKeyFields = Arrays.stream(props.getString(KeyGeneratorOptions.RECORDKEY_FIELD_OPT_KEY)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6be7a546e1c4ef26be51602c1ce9a08d88250d74"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTM5NTA4OA==", "bodyText": "can all these members be final (intellij tip)", "url": "https://github.com/apache/hudi/pull/2200#discussion_r515395088", "createdAt": "2020-10-30T21:41:01Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-spark-client/src/main/java/org/apache/hudi/keygen/ComplexKeyGenerator.java", "diffHunk": "@@ -18,38 +17,38 @@\n \n package org.apache.hudi.keygen;\n \n-import org.apache.hudi.DataSourceWriteOptions;\n-import org.apache.hudi.common.config.TypedProperties;\n-\n import org.apache.avro.generic.GenericRecord;\n+import org.apache.hudi.common.config.TypedProperties;\n+import org.apache.hudi.keygen.constant.KeyGeneratorOptions;\n+import org.apache.spark.sql.Row;\n \n import java.util.Arrays;\n import java.util.stream.Collectors;\n-import org.apache.spark.sql.Row;\n \n /**\n  * Complex key generator, which takes names of fields to be used for recordKey and partitionPath as configs.\n  */\n public class ComplexKeyGenerator extends BuiltinKeyGenerator {\n \n-  public static final String DEFAULT_RECORD_KEY_SEPARATOR = \":\";\n+  private CommonComplexKeyGenerator commonComplexKeyGenerator;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6be7a546e1c4ef26be51602c1ce9a08d88250d74"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTM5NTg1Ng==", "bodyText": "all the Common generators. are avro based. So let's name them like SimpleAvroKeyGenerator , TimestampBasedAvroKeyGenerator ?", "url": "https://github.com/apache/hudi/pull/2200#discussion_r515395856", "createdAt": "2020-10-30T21:43:08Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/keygen/CommonTimestampBasedKeyGenerator.java", "diffHunk": "@@ -46,15 +42,11 @@\n \n import static java.util.concurrent.TimeUnit.MILLISECONDS;\n import static java.util.concurrent.TimeUnit.SECONDS;\n-import static org.apache.hudi.keygen.KeyGenUtils.DEFAULT_PARTITION_PATH;\n-import static org.apache.hudi.keygen.KeyGenUtils.EMPTY_RECORDKEY_PLACEHOLDER;\n-import static org.apache.hudi.keygen.KeyGenUtils.NULL_RECORDKEY_PLACEHOLDER;\n \n /**\n- * Key generator, that relies on timestamps for partitioning field. Still picks record key by name.\n+ * Common Key generator, that relies on timestamps for partitioning field. Still picks record key by name.\n  */\n-public class TimestampBasedKeyGenerator extends SimpleKeyGenerator {\n-\n+public class CommonTimestampBasedKeyGenerator extends CommonSimpleKeyGenerator {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6be7a546e1c4ef26be51602c1ce9a08d88250d74"}, "originalPosition": 58}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de8169d1a29552232b7bfb5ebfb22286204260ce", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/de8169d1a29552232b7bfb5ebfb22286204260ce", "committedDate": "2020-10-30T23:39:20Z", "message": "Rename KeyGenerators"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4220, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}