{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYzMDA2MjQ4", "number": 1229, "title": "[HUDI-535] Ensure Compaction Plan is always written in .aux folder to avoid 0.5.0/0.5.1 reader-writer compatibility issues", "bodyText": "What is the purpose of the pull request\nPR #1009 introduces table layout version which is used to determine if rename must be allowed or not. Renames are disabled by default in 0.5.1 but users can enable them in ingestion through write config. Along with this feature, another related change to avoid writing compaction plans in .aux folder is added. This change could result in race conditions when we use different versions for reader and writer. This PR effectively reverts the compaction plan storage change allowing it to be also stored in .aux folder.\nBrief change log\n(for example:)\n\nEnsure Compaction Plan is always written in .aux folder to avoid 0.5.0/0.5.1 reader-writer compatibility issues\n\nVerify this pull request\n(Please pick either of the following options)\nExisting unit-tests covers the code change that is done\nCommitter checklist\n\n\n Has a corresponding JIRA in PR title & commit\n\n\n Commit message is descriptive of the change\n\n\n CI is green\n\n\n Necessary doc changes done or have another open PR\n\n\n For large changes, please consider breaking it into sub-tasks under an umbrella JIRA.", "createdAt": "2020-01-15T08:04:26Z", "url": "https://github.com/apache/hudi/pull/1229", "merged": true, "mergeCommit": {"oid": "923e2b4a1ef0645596eabcd41832cdf8acba4b9a"}, "closed": true, "closedAt": "2020-01-17T18:56:36Z", "author": {"login": "bvaradar"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb6umklAFqTM0MzU5ODY0OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb7SJiPABqjI5NTg5MTYzNzQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzNTk4NjQ5", "url": "https://github.com/apache/hudi/pull/1229#pullrequestreview-343598649", "createdAt": "2020-01-15T23:52:51Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQyMzo1Mjo1MVrOFeKIyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQyMzo1Mjo1MVrOFeKIyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzE2NzY4OA==", "bodyText": "why is this ok?", "url": "https://github.com/apache/hudi/pull/1229#discussion_r367167688", "createdAt": "2020-01-15T23:52:51Z", "author": {"login": "vinothchandar"}, "path": "hudi-common/src/main/java/org/apache/hudi/common/table/timeline/HoodieActiveTimeline.java", "diffHunk": "@@ -369,8 +366,6 @@ public HoodieInstant transitionCleanInflightToComplete(HoodieInstant inflightIns\n     Preconditions.checkArgument(inflightInstant.getAction().equals(HoodieTimeline.CLEAN_ACTION));\n     Preconditions.checkArgument(inflightInstant.isInflight());\n     HoodieInstant commitInstant = new HoodieInstant(State.COMPLETED, CLEAN_ACTION, inflightInstant.getTimestamp());\n-    // First write metadata to aux folder", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 51}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzOTgzMDM5", "url": "https://github.com/apache/hudi/pull/1229#pullrequestreview-343983039", "createdAt": "2020-01-16T15:09:30Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNTowOTozMFrOFecq0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNTowOTozMFrOFecq0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ3MTMxNA==", "bodyText": "but then in the meantime, every reader will be doing two RPCs for this method right? I am thinking about flipping the order.. read from aux first, then fallback to meta path...\nThis way, when we switch to writing in metapath, only the older readers will incur this additional RPC... Does it make sense?", "url": "https://github.com/apache/hudi/pull/1229#discussion_r367471314", "createdAt": "2020-01-16T15:09:30Z", "author": {"login": "vinothchandar"}, "path": "hudi-common/src/main/java/org/apache/hudi/common/table/timeline/HoodieActiveTimeline.java", "diffHunk": "@@ -279,18 +280,28 @@ private void deleteInstantFile(HoodieInstant instant) {\n     return readDataFromPath(detailPath);\n   }\n \n+  public Option<byte[]> readCleanerInfoAsBytes(HoodieInstant instant) {\n+    // Cleaner metadata are always stored only in timeline .hoodie\n+    return readDataFromPath(new Path(metaClient.getMetaPath(), instant.getFileName()));\n+  }\n+\n   //-----------------------------------------------------------------\n   //      BEGIN - COMPACTION RELATED META-DATA MANAGEMENT.\n   //-----------------------------------------------------------------\n \n-  public Option<byte[]> readPlanAsBytes(HoodieInstant instant) {\n-    Path detailPath = null;\n-    if (metaClient.getTimelineLayoutVersion().isNullVersion()) {\n-      detailPath = new Path(metaClient.getMetaAuxiliaryPath(), instant.getFileName());\n-    } else {\n-      detailPath = new Path(metaClient.getMetaPath(), instant.getFileName());\n+  public Option<byte[]> readCompactionPlanAsBytes(HoodieInstant instant) {\n+    try {\n+      // This is going to be the common case in future when 0.5.1 is deployed.", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34fc8096e529cbfeeeb8f7742bba7710e8f69c50", "author": {"user": {"login": "bvaradar", "name": "Balaji Varadarajan"}}, "url": "https://github.com/apache/hudi/commit/34fc8096e529cbfeeeb8f7742bba7710e8f69c50", "committedDate": "2020-01-17T17:16:32Z", "message": "[HUDI-535] Ensure Compaction Plan is always written in .aux folder to avoid 0.5.0/0.5.1 reader-writer compatibility issues"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "34fc8096e529cbfeeeb8f7742bba7710e8f69c50", "author": {"user": {"login": "bvaradar", "name": "Balaji Varadarajan"}}, "url": "https://github.com/apache/hudi/commit/34fc8096e529cbfeeeb8f7742bba7710e8f69c50", "committedDate": "2020-01-17T17:16:32Z", "message": "[HUDI-535] Ensure Compaction Plan is always written in .aux folder to avoid 0.5.0/0.5.1 reader-writer compatibility issues"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4080, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}