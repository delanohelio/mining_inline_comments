{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMwODIzMTU2", "number": 2292, "title": "[HUDI-1428] Clean old fileslice is invalid", "bodyText": "Tips\n\nThank you very much for contributing to Apache Hudi.\nPlease review https://hudi.apache.org/contributing.html before opening a pull request.\n\nWhat is the purpose of the pull request\nfix  clean old fileslice is invalid\nReproduce :\nTable type MERGE_ON_READ and set hoodie.cleaner.commits.retained=2\nDo insert into table three times  into same partition\nAnd it will create follow parquet file\na2c57b73-5ba9-4744-9027-640075a179ec-0_0-213-1740_20201201200149.parquet\na2c57b73-5ba9-4744-9027-640075a179ec-0_0-176-1702_20201201195638.parquet\na2c57b73-5ba9-4744-9027-640075a179ec-0_0-139-1664_20201201195219.parquet\na2c57b73-5ba9-4744-9027-640075a179ec-0_0-103-1632_20201201193835.parquet\nAnd 20201201200149.parquet is newest\nThe old parquet files have not be deleted when do client.clean()\nThe reason is CleanPlanner  init commitTimeline with hoodieTable.getCompletedCommitTimeline();\nAnd getCompletedCommitTimeline method not include DELTA_COMMIT_ACTION\nBrief change log\nusing hoodieTable.getCompletedCommitsTimeline() replace hoodieTable.getCompletedCommitTimeline()\nVerify this pull request\n(Please pick either of the following options)\nThis pull request is a trivial rework / code cleanup without any test coverage.\n(or)\nThis pull request is already covered by existing tests, such as (please describe tests).\n(or)\nThis change added tests and can be verified as follows:\nCommitter checklist\n\n\n Has a corresponding JIRA in PR title & commit\n\n\n Commit message is descriptive of the change\n\n\n CI is green\n\n\n Necessary doc changes done or have another open PR\n\n\n For large changes, please consider breaking it into sub-tasks under an umbrella JIRA.", "createdAt": "2020-12-02T07:48:03Z", "url": "https://github.com/apache/hudi/pull/2292", "merged": true, "mergeCommit": {"oid": "11bc1fe6f498850d2c496151741813001d3850a3"}, "closed": true, "closedAt": "2020-12-13T14:28:54Z", "author": {"login": "yui2010"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdiJlJlgH2gAyNTMwODIzMTU2OjIyMmE0ZWZkMzMzZTc3YjZhNzkwMTkyZmI1ZWZlMTYwZDMwNTE4MzM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdlojToAH2gAyNTMwODIzMTU2OjMzYTczODM5MjhiMTkxYjMyYzViMjY5OGRkMTQwODk0ZTJjZWU5ZDA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "222a4efd333e77b6a790192fb5efe160d3051833", "author": {"user": null}, "url": "https://github.com/apache/hudi/commit/222a4efd333e77b6a790192fb5efe160d3051833", "committedDate": "2020-12-02T07:40:23Z", "message": "[HUDI-1428] Clean old fileslice is invalid"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzNzgwNzAw", "url": "https://github.com/apache/hudi/pull/2292#pullrequestreview-543780700", "createdAt": "2020-12-03T09:52:37Z", "commit": {"oid": "222a4efd333e77b6a790192fb5efe160d3051833"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QwOTo1MjozN1rOH-PiLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QwOTo1MjozN1rOH-PiLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTAyODI2OQ==", "bodyText": "This looks like a bug, @vinothchandar please double check.", "url": "https://github.com/apache/hudi/pull/2292#discussion_r535028269", "createdAt": "2020-12-03T09:52:37Z", "author": {"login": "garyli1019"}, "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/table/action/clean/CleanPlanner.java", "diffHunk": "@@ -80,7 +80,7 @@\n   public CleanPlanner(HoodieTable<T, I, K, O> hoodieTable, HoodieWriteConfig config) {\n     this.hoodieTable = hoodieTable;\n     this.fileSystemView = hoodieTable.getHoodieView();\n-    this.commitTimeline = hoodieTable.getCompletedCommitTimeline();\n+    this.commitTimeline = hoodieTable.getCompletedCommitsTimeline();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "222a4efd333e77b6a790192fb5efe160d3051833"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d492dc58edf66b5e589e07b7f72c97a377315175", "author": {"user": null}, "url": "https://github.com/apache/hudi/commit/d492dc58edf66b5e589e07b7f72c97a377315175", "committedDate": "2020-12-13T03:08:42Z", "message": "Merge branch 'master' into HUDI-1428"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33a7383928b191b32c5b2698dd140894e2cee9d0", "author": {"user": null}, "url": "https://github.com/apache/hudi/commit/33a7383928b191b32c5b2698dd140894e2cee9d0", "committedDate": "2020-12-13T03:27:12Z", "message": "[HUDI-1428] Clean old fileslice is invalid"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4379, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}