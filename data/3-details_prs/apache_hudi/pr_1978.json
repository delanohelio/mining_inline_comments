{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY5NDkwMzQ5", "number": 1978, "title": "[HUDI-1184] Fix the support of hbase index partition path change", "bodyText": "Tips\n\nThank you very much for contributing to Apache Hudi.\nPlease review https://hudi.apache.org/contributing.html before opening a pull request.\n\nWhat is the purpose of the pull request\n(When the hbase index is used, when the record partition is changed to another partition, the path does not change according to the value of the partition column.)\nBrief change log\n\nadded the HBASE_INDEX_UPDATE_PARTITION_PATH parameter to turn on and off similar to GlobalBloom.\nAfter obtaining the hbase index, determine whether the previous partition path and the current partition path have been changed. If changed , insert a deleted record and insert a new record.\n\nVerify this pull request\n\nTestHbaseIndex class added a test case to verify hbase index partition path has been changed.\nUse the following code to further verify.\nupsertData.write.format(\"org.apache.hudi\") .option(DataSourceWriteOptions.RECORDKEY_FIELD_OPT_KEY, \"rowkey\") .option(DataSourceWriteOptions.PRECOMBINE_FIELD_OPT_KEY, \"lastupdatedttm\") .option(DataSourceWriteOptions.PARTITIONPATH_FIELD_OPT_KEY, \"dt\") .option(HoodieIndexConfig.INDEX_TYPE_PROP, HoodieIndex.IndexType.HBASE.name()) .option(HoodieHBaseIndexConfig.HBASE_INDEX_UPDATE_PARTITION_PATH,\"true\") .option(HoodieHBaseIndexConfig.HBASE_ZKQUORUM_PROP, \"localhost\") .option(HoodieHBaseIndexConfig.HBASE_ZKPORT_PROP, \"2181\") .option(HoodieHBaseIndexConfig.HBASE_ZK_ZNODEPARENT, \"/hbase\") .option(HoodieHBaseIndexConfig.HBASE_TABLENAME_PROP, \"TEST_HBASE_INDEX\") .option(\"hoodie.insert.shuffle.parallelism\", \"2\") .option(\"hoodie.upsert.shuffle.parallelism\", \"2\") .option(HoodieHBaseIndexConfig.HBASE_GET_BATCH_SIZE_PROP, \"10000\") .option(HoodieHBaseIndexConfig.HBASE_QPS_FRACTION_PROP, \"0.5\") .option(HoodieWriteConfig.TABLE_NAME, \"test_hbase\") .option(HoodieHBaseIndexConfig.HBASE_MAX_QPS_PER_REGION_SERVER_PROP, \"1000\") .option(HoodieHBaseIndexConfig.HBASE_INDEX_QPS_ALLOCATOR_CLASS, HoodieHBaseIndexConfig.DEFAULT_HBASE_INDEX_QPS_ALLOCATOR_CLASS) .mode(SaveMode.Append) .save(\"/tmp/test_hbase\")\n\nCommitter checklist\n\n\n Has a corresponding JIRA in PR title & commit\n\n\n Commit message is descriptive of the change\n\n\n CI is green\n\n\n Necessary doc changes done or have another open PR\n\n\n For large changes, please consider breaking it into sub-tasks under an umbrella JIRA.", "createdAt": "2020-08-18T13:13:55Z", "url": "https://github.com/apache/hudi/pull/1978", "merged": true, "mergeCommit": {"oid": "c0472d3317e9bfe0b39ee2212e760e96b5a67ee9"}, "closed": true, "closedAt": "2020-10-12T02:05:57Z", "author": {"login": "hj2016"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdAULTcgFqTQ3MDEyMTYwNg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdRpnruABqjM4NjQzMTk2OTg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwMTIxNjA2", "url": "https://github.com/apache/hudi/pull/1978#pullrequestreview-470121606", "createdAt": "2020-08-19T04:47:41Z", "commit": {"oid": "4fc3471b6ff9ddab370a6c2155a7932bba523a60"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5MDIzOTk4", "url": "https://github.com/apache/hudi/pull/1978#pullrequestreview-479023998", "createdAt": "2020-08-31T22:56:51Z", "commit": {"oid": "4fc3471b6ff9ddab370a6c2155a7932bba523a60"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMjo1Njo1MVrOHKMktA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMjo1Njo1MVrOHKMktA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ1MzgxMg==", "bodyText": "It seems like only the following lines have changed but the PR changes indentation for other lines making it hard to understand the exact changes, can you please rework this to change only what is intended ?", "url": "https://github.com/apache/hudi/pull/1978#discussion_r480453812", "createdAt": "2020-08-31T22:56:51Z", "author": {"login": "n3nash"}, "path": "hudi-client/src/main/java/org/apache/hudi/index/hbase/HBaseIndex.java", "diffHunk": "@@ -213,36 +215,61 @@ private boolean checkIfValidCommit(HoodieTableMetaClient metaClient, String comm\n           statements.add(generateStatement(rec.getRecordKey()));\n           currentBatchOfRecords.add(rec);\n           // iterator till we reach batch size\n-          if (statements.size() >= multiGetBatchSize || !hoodieRecordIterator.hasNext()) {\n-            // get results for batch from Hbase\n-            Result[] results = doGet(hTable, statements);\n-            // clear statements to be GC'd\n-            statements.clear();\n-            for (Result result : results) {\n-              // first, attempt to grab location from HBase\n-              HoodieRecord currentRecord = currentBatchOfRecords.remove(0);\n-              if (result.getRow() != null) {\n-                String keyFromResult = Bytes.toString(result.getRow());\n-                String commitTs = Bytes.toString(result.getValue(SYSTEM_COLUMN_FAMILY, COMMIT_TS_COLUMN));\n-                String fileId = Bytes.toString(result.getValue(SYSTEM_COLUMN_FAMILY, FILE_NAME_COLUMN));\n-                String partitionPath = Bytes.toString(result.getValue(SYSTEM_COLUMN_FAMILY, PARTITION_PATH_COLUMN));\n-\n-                if (checkIfValidCommit(metaClient, commitTs)) {\n-                  currentRecord = new HoodieRecord(new HoodieKey(currentRecord.getRecordKey(), partitionPath),\n+          if (hoodieRecordIterator.hasNext() && statements.size() < multiGetBatchSize) {\n+            continue;\n+          }\n+\n+          // get results for batch from Hbase\n+          Result[] results = doGet(hTable, statements);\n+          // clear statements to be GC'd\n+          statements.clear();\n+          for (Result result : results) {\n+            // first, attempt to grab location from HBase\n+            HoodieRecord currentRecord = currentBatchOfRecords.remove(0);\n+\n+            if (result.getRow() == null) {\n+              taggedRecords.add(currentRecord);\n+              continue;\n+            }\n+\n+            String keyFromResult = Bytes.toString(result.getRow());\n+            String commitTs = Bytes.toString(result.getValue(SYSTEM_COLUMN_FAMILY, COMMIT_TS_COLUMN));\n+            String fileId = Bytes.toString(result.getValue(SYSTEM_COLUMN_FAMILY, FILE_NAME_COLUMN));\n+            String partitionPath = Bytes.toString(result.getValue(SYSTEM_COLUMN_FAMILY, PARTITION_PATH_COLUMN));\n+\n+            if (!checkIfValidCommit(metaClient, commitTs)) {\n+              // if commit is invalid, treat this as a new taggedRecord\n+              taggedRecords.add(currentRecord);\n+              continue;\n+            }\n+\n+\n+            if (updatePartitionPath && !partitionPath.equals(currentRecord.getPartitionPath())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4fc3471b6ff9ddab370a6c2155a7932bba523a60"}, "originalPosition": 65}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5OTQwNDcy", "url": "https://github.com/apache/hudi/pull/1978#pullrequestreview-479940472", "createdAt": "2020-09-01T16:52:55Z", "commit": {"oid": "4fc3471b6ff9ddab370a6c2155a7932bba523a60"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxNjo1Mjo1NVrOHK_wiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxNjo1Mjo1NVrOHK_wiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTI5MjQyNw==", "bodyText": "can we also have another test where, the config value is set to false and the record is tagged w/ old partition. since we have introduced a new config, would be good to have tests covering both branches.", "url": "https://github.com/apache/hudi/pull/1978#discussion_r481292427", "createdAt": "2020-09-01T16:52:55Z", "author": {"login": "nsivabalan"}, "path": "hudi-client/src/test/java/org/apache/hudi/index/hbase/TestHBaseIndex.java", "diffHunk": "@@ -156,6 +160,46 @@ public void testSimpleTagLocationAndUpdate() throws Exception {\n     }\n   }\n \n+  @Test\n+  public void testTagLocationAndPartitionPathUpdate() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4fc3471b6ff9ddab370a6c2155a7932bba523a60"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0MDA5MjQ5", "url": "https://github.com/apache/hudi/pull/1978#pullrequestreview-484009249", "createdAt": "2020-09-08T10:38:59Z", "commit": {"oid": "2a26f557059b37dddc601dc8780b6aba7a395de3"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxMDozODo1OVrOHOXF2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxMDozODo1OVrOHOXF2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDgyMDQ0MA==", "bodyText": "sorry, I missed to take a closer look at the test last time. instead of fiddling w/ table directly, can we test using index apis only.\n\ngenerate records with pp_1 and insert\nupdate records with pp_2 and call index.tagLocation.\nYou should be able to test both paths (false and true for the interested config) with this.\ntrue path:\nVerify that index.tagLocation returns 2 * #records, and half of them are referring to delete records in pp_1 and remaining records are pointing to pp_2\nfalse path:\nVerify that index.tagLocation return 1 * #records, and all of them are pointing to pp_1.", "url": "https://github.com/apache/hudi/pull/1978#discussion_r484820440", "createdAt": "2020-09-08T10:38:59Z", "author": {"login": "nsivabalan"}, "path": "hudi-client/src/test/java/org/apache/hudi/index/hbase/TestHBaseIndex.java", "diffHunk": "@@ -156,6 +160,53 @@ public void testSimpleTagLocationAndUpdate() throws Exception {\n     }\n   }\n \n+  @Test\n+  public void testTagLocationAndPartitionPathUpdate() throws Exception {\n+    final String newCommitTime = \"001\";\n+    final int numRecords = 10;\n+    final String oldPartitionPath = \"1970/01/01\";\n+\n+    // init old index to hbase\n+    List<HoodieRecord> records = dataGen.generateInserts(newCommitTime, numRecords);\n+    JavaRDD<HoodieRecord> writeRecords = jsc().parallelize(records, 1);\n+    HoodieWriteConfig config = getConfig(true);\n+    HBaseIndex index = new HBaseIndex(getConfig(true));\n+\n+    try (HoodieWriteClient writeClient = getHoodieWriteClient(config);) {\n+      // allowed path change test\n+      metaClient = HoodieTableMetaClient.reload(metaClient);\n+      HoodieTable hoodieTable = HoodieTable.create(metaClient, config, hadoopConf);\n+\n+      JavaRDD<HoodieRecord> records1 = index.tagLocation(writeRecords, jsc(), hoodieTable);\n+      assertEquals(0, records1.filter(record -> record.isCurrentLocationKnown()).count());\n+      writeClient.startCommitWithTime(newCommitTime);\n+      JavaRDD<WriteStatus> writeStatues = writeClient.upsert(writeRecords, newCommitTime);\n+      writeClient.commit(newCommitTime, writeStatues);\n+      assertNoWriteErrors(writeStatues.collect());\n+      // mock old partition data\n+      Table table = utility.getConnection().getTable(TableName.valueOf(TABLE_NAME));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a26f557059b37dddc601dc8780b6aba7a395de3"}, "originalPosition": 63}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0MzczOTY3", "url": "https://github.com/apache/hudi/pull/1978#pullrequestreview-484373967", "createdAt": "2020-09-08T18:00:53Z", "commit": {"oid": "b4261e6311da271bc31263acdb31eb07f3b6a4cd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwMTM1MDYw", "url": "https://github.com/apache/hudi/pull/1978#pullrequestreview-490135060", "createdAt": "2020-09-17T00:27:12Z", "commit": {"oid": "2cd91a94a08e2bd5db22ee9df26bce79b6e49af5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d8621702f92f84a90268aa556fbcc7bfcf1b890", "author": {"user": null}, "url": "https://github.com/apache/hudi/commit/6d8621702f92f84a90268aa556fbcc7bfcf1b890", "committedDate": "2020-10-12T01:22:00Z", "message": "[HUDI-1184] Fix the support of hbase index partition path change\n\nWhen the hbase index is used, when the record partition is changed to another partition, the path does not change according to the value of the partition column"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a89c8c6d75ae3264696ed73fd37b855d6594b54a", "author": {"user": null}, "url": "https://github.com/apache/hudi/commit/a89c8c6d75ae3264696ed73fd37b855d6594b54a", "committedDate": "2020-09-29T01:45:30Z", "message": "Merge branch 'master' of https://github.com/hj2016/incubator-hudi"}, "afterCommit": {"oid": "6d8621702f92f84a90268aa556fbcc7bfcf1b890", "author": {"user": null}, "url": "https://github.com/apache/hudi/commit/6d8621702f92f84a90268aa556fbcc7bfcf1b890", "committedDate": "2020-10-12T01:22:00Z", "message": "[HUDI-1184] Fix the support of hbase index partition path change\n\nWhen the hbase index is used, when the record partition is changed to another partition, the path does not change according to the value of the partition column"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4860, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}