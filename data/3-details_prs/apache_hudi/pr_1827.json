{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ4ODM0MzIz", "number": 1827, "title": "[HUDI-1089] Refactor hudi-client to support multi-engine", "bodyText": "Tips\n\nThank you very much for contributing to Apache Hudi.\nPlease review https://hudi.apache.org/contributing.html before opening a pull request.\n\nWhat is the purpose of the pull request\nRefactor hudi-client to support multi-engine\nBrief change log\n\nRefactor hudi-client to support multi-engine\n\nVerify this pull request\nThis pull request is already covered by existing tests.\nCommitter checklist\n\n\n Has a corresponding JIRA in PR title & commit\n\n\n Commit message is descriptive of the change\n\n\n CI is green\n\n\n Necessary doc changes done or have another open PR\n\n\n For large changes, please consider breaking it into sub-tasks under an umbrella JIRA.", "createdAt": "2020-07-14T11:56:30Z", "url": "https://github.com/apache/hudi/pull/1827", "merged": true, "mergeCommit": {"oid": "1f7add92916c37b05be270d9c75a9042134ec506"}, "closed": true, "closedAt": "2020-10-01T21:25:30Z", "author": {"login": "wangxianghu"}, "timelineItems": {"totalCount": 103, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdOTw_egH2gAyNDQ4ODM0MzIzOjlkN2E1MWRlNjZiMDE5OGRmODVjMDRkOTNkMmU3M2VkNTM4MTcxNGM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdOVmKgAH2gAyNDQ4ODM0MzIzOjEzN2RhMmI0YWI4NjJlMTZhNDhjZmJhODRkNTZmYzYxY2E3NjJkNjk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9d7a51de66b0198df85c04d93d2e73ed5381714c", "author": {"user": {"login": "vinothchandar", "name": "vinoth chandar"}}, "url": "https://github.com/apache/hudi/commit/9d7a51de66b0198df85c04d93d2e73ed5381714c", "committedDate": "2020-10-01T16:13:53Z", "message": "Renaming some Abstract* classes as Hoodie* to improve readability"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d99096df897e64ca200df2cd9ca269c327faebf1", "author": {"user": {"login": "vinothchandar", "name": "vinoth chandar"}}, "url": "https://github.com/apache/hudi/commit/d99096df897e64ca200df2cd9ca269c327faebf1", "committedDate": "2020-10-01T14:31:47Z", "message": "Renaming some Abstract* classes as Hoodie* to improve readability"}, "afterCommit": {"oid": "9d7a51de66b0198df85c04d93d2e73ed5381714c", "author": {"user": {"login": "vinothchandar", "name": "vinoth chandar"}}, "url": "https://github.com/apache/hudi/commit/9d7a51de66b0198df85c04d93d2e73ed5381714c", "committedDate": "2020-10-01T16:13:53Z", "message": "Renaming some Abstract* classes as Hoodie* to improve readability"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "137da2b4ab862e16a48cfba84d56fc61ca762d69", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/137da2b4ab862e16a48cfba84d56fc61ca762d69", "committedDate": "2020-10-01T18:21:52Z", "message": "fix Unable to find driver bind address from spark config"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "13795f5c1223424d44244e46acb0864b93ec403e", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/13795f5c1223424d44244e46acb0864b93ec403e", "committedDate": "2020-07-15T15:22:08Z", "message": "[HUDI-1089] Refactor hudi-client to support multi-engine"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5NzM5NTU2", "url": "https://github.com/apache/hudi/pull/1827#pullrequestreview-449739556", "createdAt": "2020-07-16T10:58:13Z", "commit": {"oid": "13795f5c1223424d44244e46acb0864b93ec403e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQxMDo1ODoxNFrOGyl2vg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQxMTowNDoxMVrOGymCqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTcwMjIwNg==", "bodyText": "The new style or the old style, which one is right?", "url": "https://github.com/apache/hudi/pull/1827#discussion_r455702206", "createdAt": "2020-07-16T10:58:14Z", "author": {"login": "yanghua"}, "path": "hudi-cli/src/main/java/org/apache/hudi/cli/commands/CompactionCommand.java", "diffHunk": "@@ -593,8 +592,8 @@ public String repairCompaction(\n     return output;\n   }\n \n-  private String getRenamesToBePrinted(List<RenameOpResult> res, Integer limit, String sortByField, boolean descending,\n-      boolean headerOnly, String operation) {\n+  private String getRenamesToBePrinted(List<BaseCompactionAdminClient.RenameOpResult> res, Integer limit, String sortByField, boolean descending,\n+                                       boolean headerOnly, String operation) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13795f5c1223424d44244e46acb0864b93ec403e"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTcwNTI1OA==", "bodyText": "Why do we need to change this class?", "url": "https://github.com/apache/hudi/pull/1827#discussion_r455705258", "createdAt": "2020-07-16T11:04:11Z", "author": {"login": "yanghua"}, "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/io/storage/HoodieParquetWriter.java", "diffHunk": "@@ -40,7 +39,7 @@\n  * HoodieParquetWriter extends the ParquetWriter to help limit the size of underlying file. Provides a way to check if\n  * the current file can take more records with the <code>canWrite()</code>\n  */\n-public class HoodieParquetWriter<T extends HoodieRecordPayload, R extends IndexedRecord>\n+public class HoodieParquetWriter<R extends IndexedRecord>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13795f5c1223424d44244e46acb0864b93ec403e"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxMTk3MjY0", "url": "https://github.com/apache/hudi/pull/1827#pullrequestreview-451197264", "createdAt": "2020-07-20T01:04:42Z", "commit": {"oid": "88c6661e865945059f782880c395547c16ef1a1c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwMTowNDo0MlrOGzz5Dw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwMTowNDo0MlrOGzz5Dw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk4MDc1MQ==", "bodyText": "Just bump into this... Since this is a generic engine context, will it be better to use a generic name like engineConfig?", "url": "https://github.com/apache/hudi/pull/1827#discussion_r456980751", "createdAt": "2020-07-20T01:04:42Z", "author": {"login": "henrywu2019"}, "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/common/HoodieEngineContext.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.common;\n+\n+import org.apache.hudi.client.TaskContextSupplier;\n+import org.apache.hudi.common.config.SerializableConfiguration;\n+\n+/**\n+ * Base class contains the context information needed by the engine at runtime. It will be extended by different\n+ * engine implementation if needed.\n+ */\n+public class HoodieEngineContext {\n+  /**\n+   * A wrapped hadoop configuration which can be serialized.\n+   */\n+  private SerializableConfiguration hadoopConf;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88c6661e865945059f782880c395547c16ef1a1c"}, "originalPosition": 32}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "88c6661e865945059f782880c395547c16ef1a1c", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/88c6661e865945059f782880c395547c16ef1a1c", "committedDate": "2020-07-17T11:12:34Z", "message": "rollback style"}, "afterCommit": {"oid": "b30f9738a504ac28bdb30485b83a1313ee3ee248", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/b30f9738a504ac28bdb30485b83a1313ee3ee248", "committedDate": "2020-07-20T11:21:19Z", "message": "resolve conflicts"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b30f9738a504ac28bdb30485b83a1313ee3ee248", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/b30f9738a504ac28bdb30485b83a1313ee3ee248", "committedDate": "2020-07-20T11:21:19Z", "message": "resolve conflicts"}, "afterCommit": {"oid": "39db50b5e64666e7f688a83aa06e7096cdf8ce16", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/39db50b5e64666e7f688a83aa06e7096cdf8ce16", "committedDate": "2020-07-21T11:53:45Z", "message": "mv class to hudi-client-common"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "39db50b5e64666e7f688a83aa06e7096cdf8ce16", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/39db50b5e64666e7f688a83aa06e7096cdf8ce16", "committedDate": "2020-07-21T11:53:45Z", "message": "mv class to hudi-client-common"}, "afterCommit": {"oid": "9fa51f49f38ef3b80fa391b27fc45d9d2d424ed2", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/9fa51f49f38ef3b80fa391b27fc45d9d2d424ed2", "committedDate": "2020-07-22T15:34:37Z", "message": "rebase master"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9fa51f49f38ef3b80fa391b27fc45d9d2d424ed2", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/9fa51f49f38ef3b80fa391b27fc45d9d2d424ed2", "committedDate": "2020-07-22T15:34:37Z", "message": "rebase master"}, "afterCommit": {"oid": "c42bed02e73b74d730d489ebb0a8ce297d074517", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/c42bed02e73b74d730d489ebb0a8ce297d074517", "committedDate": "2020-07-22T15:35:49Z", "message": "rebase master"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c42bed02e73b74d730d489ebb0a8ce297d074517", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/c42bed02e73b74d730d489ebb0a8ce297d074517", "committedDate": "2020-07-22T15:35:49Z", "message": "rebase master"}, "afterCommit": {"oid": "56dfec1d2da5b27397ee7821cd90aa3e81728f56", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/56dfec1d2da5b27397ee7821cd90aa3e81728f56", "committedDate": "2020-07-30T15:31:03Z", "message": "fix conflicts"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "56dfec1d2da5b27397ee7821cd90aa3e81728f56", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/56dfec1d2da5b27397ee7821cd90aa3e81728f56", "committedDate": "2020-07-30T15:31:03Z", "message": "fix conflicts"}, "afterCommit": {"oid": "b5c1ad3daaf17404d22e52efd54687687dc9d1a2", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/b5c1ad3daaf17404d22e52efd54687687dc9d1a2", "committedDate": "2020-08-19T15:49:09Z", "message": "fix conflicts"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b5c1ad3daaf17404d22e52efd54687687dc9d1a2", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/b5c1ad3daaf17404d22e52efd54687687dc9d1a2", "committedDate": "2020-08-19T15:49:09Z", "message": "fix conflicts"}, "afterCommit": {"oid": "85a8457d29d315c4c7f1766e46ad4fca5ab211e9", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/85a8457d29d315c4c7f1766e46ad4fca5ab211e9", "committedDate": "2020-08-20T12:39:10Z", "message": "[HUDI-1089] [WIP]Refactor hudi-client to support multi-engine"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f08cb179e5a91db0f770698b2ac3bdb2f161759b", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/f08cb179e5a91db0f770698b2ac3bdb2f161759b", "committedDate": "2020-08-21T03:15:50Z", "message": "finish index refactor"}, "afterCommit": {"oid": "2d9cc47260d6f35584db45b75261fbbd343c7b0c", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/2d9cc47260d6f35584db45b75261fbbd343c7b0c", "committedDate": "2020-08-21T03:32:22Z", "message": "finish index refactor"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2d9cc47260d6f35584db45b75261fbbd343c7b0c", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/2d9cc47260d6f35584db45b75261fbbd343c7b0c", "committedDate": "2020-08-21T03:32:22Z", "message": "finish index refactor"}, "afterCommit": {"oid": "e7e8cb85fc7ee38bcbc56a6c2479931d4fde4fcb", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/e7e8cb85fc7ee38bcbc56a6c2479931d4fde4fcb", "committedDate": "2020-08-21T07:21:35Z", "message": "finish index refactor"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e7e8cb85fc7ee38bcbc56a6c2479931d4fde4fcb", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/e7e8cb85fc7ee38bcbc56a6c2479931d4fde4fcb", "committedDate": "2020-08-21T07:21:35Z", "message": "finish index refactor"}, "afterCommit": {"oid": "b8d06e925943ee02d5e19ae89256b5aa404e197d", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/b8d06e925943ee02d5e19ae89256b5aa404e197d", "committedDate": "2020-08-21T10:13:31Z", "message": "rebase master WIP"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b8d06e925943ee02d5e19ae89256b5aa404e197d", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/b8d06e925943ee02d5e19ae89256b5aa404e197d", "committedDate": "2020-08-21T10:13:31Z", "message": "rebase master WIP"}, "afterCommit": {"oid": "958dac8b6c33b0ee46645c901f0ee0fafcd0f846", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/958dac8b6c33b0ee46645c901f0ee0fafcd0f846", "committedDate": "2020-08-23T03:58:42Z", "message": "rebase master WIP"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "798ebb9f2da632512163f934539c2ac3602b7323", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/798ebb9f2da632512163f934539c2ac3602b7323", "committedDate": "2020-08-24T07:42:06Z", "message": "add HooodieSparkWriteClient timeline servie"}, "afterCommit": {"oid": "009fae91da08a60624f054cebff04d5c59077251", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/009fae91da08a60624f054cebff04d5c59077251", "committedDate": "2020-08-24T13:06:54Z", "message": "abstract Helper class and write client"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4417de08cf9552cc3601541fcc87e0d493500ed2", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/4417de08cf9552cc3601541fcc87e0d493500ed2", "committedDate": "2020-08-27T10:57:34Z", "message": "finish most source class"}, "afterCommit": {"oid": "1c7d03a43097ffecf404dda29dd5aaa74fde95ca", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/1c7d03a43097ffecf404dda29dd5aaa74fde95ca", "committedDate": "2020-08-27T15:31:57Z", "message": "finish most source class"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a19abf774515091a657a607fb2c3f8cfdc5ea9c6", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/a19abf774515091a657a607fb2c3f8cfdc5ea9c6", "committedDate": "2020-08-30T04:29:02Z", "message": "move test to hudi-spark-client"}, "afterCommit": {"oid": "48cf8c614f745ec91612cf1ba04063838891d8e5", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/48cf8c614f745ec91612cf1ba04063838891d8e5", "committedDate": "2020-08-30T04:33:48Z", "message": "rebase master"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b91cbda77c77f3889aa6dcec5faba33414100c3b", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/b91cbda77c77f3889aa6dcec5faba33414100c3b", "committedDate": "2020-08-30T11:40:00Z", "message": "Make it compilable"}, "afterCommit": {"oid": "e755bf5d58817c627aeda63c504902ef504b9de5", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/e755bf5d58817c627aeda63c504902ef504b9de5", "committedDate": "2020-08-30T11:46:09Z", "message": "Make it compilable"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e755bf5d58817c627aeda63c504902ef504b9de5", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/e755bf5d58817c627aeda63c504902ef504b9de5", "committedDate": "2020-08-30T11:46:09Z", "message": "Make it compilable"}, "afterCommit": {"oid": "74a0af4ffab2de6032e90ac31e0aae3787823a86", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/74a0af4ffab2de6032e90ac31e0aae3787823a86", "committedDate": "2020-08-30T11:48:13Z", "message": "Make it compilable"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "74a0af4ffab2de6032e90ac31e0aae3787823a86", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/74a0af4ffab2de6032e90ac31e0aae3787823a86", "committedDate": "2020-08-30T11:48:13Z", "message": "Make it compilable"}, "afterCommit": {"oid": "cd697a95bafc5ae0566a8cacbe8c4a93c053a91f", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/cd697a95bafc5ae0566a8cacbe8c4a93c053a91f", "committedDate": "2020-08-30T12:14:27Z", "message": "Make it compilable"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cd697a95bafc5ae0566a8cacbe8c4a93c053a91f", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/cd697a95bafc5ae0566a8cacbe8c4a93c053a91f", "committedDate": "2020-08-30T12:14:27Z", "message": "Make it compilable"}, "afterCommit": {"oid": "57660f91ea21db5d011af54511abbe9a2c75b5c7", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/57660f91ea21db5d011af54511abbe9a2c75b5c7", "committedDate": "2020-08-30T16:18:15Z", "message": "Make it compilable"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "57660f91ea21db5d011af54511abbe9a2c75b5c7", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/57660f91ea21db5d011af54511abbe9a2c75b5c7", "committedDate": "2020-08-30T16:18:15Z", "message": "Make it compilable"}, "afterCommit": {"oid": "0808014b1b90aadcef14ccb8907b4215ccafe586", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/0808014b1b90aadcef14ccb8907b4215ccafe586", "committedDate": "2020-08-31T09:43:57Z", "message": "Make it compilable"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0808014b1b90aadcef14ccb8907b4215ccafe586", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/0808014b1b90aadcef14ccb8907b4215ccafe586", "committedDate": "2020-08-31T09:43:57Z", "message": "Make it compilable"}, "afterCommit": {"oid": "5d6f909a4006cfb8c54b6ed70baa2256077cab4e", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/5d6f909a4006cfb8c54b6ed70baa2256077cab4e", "committedDate": "2020-08-31T15:04:30Z", "message": "Make it compilable"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5d6f909a4006cfb8c54b6ed70baa2256077cab4e", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/5d6f909a4006cfb8c54b6ed70baa2256077cab4e", "committedDate": "2020-08-31T15:04:30Z", "message": "Make it compilable"}, "afterCommit": {"oid": "4d71c51ba6a1dd2401473a668565b965b37505a3", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/4d71c51ba6a1dd2401473a668565b965b37505a3", "committedDate": "2020-08-31T15:57:40Z", "message": "rebase master"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4d71c51ba6a1dd2401473a668565b965b37505a3", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/4d71c51ba6a1dd2401473a668565b965b37505a3", "committedDate": "2020-08-31T15:57:40Z", "message": "rebase master"}, "afterCommit": {"oid": "9d83635dd77d77d003946c6d39c5aaeb64c975a4", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/9d83635dd77d77d003946c6d39c5aaeb64c975a4", "committedDate": "2020-08-31T16:50:36Z", "message": "rebase master"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9d83635dd77d77d003946c6d39c5aaeb64c975a4", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/9d83635dd77d77d003946c6d39c5aaeb64c975a4", "committedDate": "2020-08-31T16:50:36Z", "message": "rebase master"}, "afterCommit": {"oid": "a7b3a4e268842d87ebace4c03d7f12dd3be1f103", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/a7b3a4e268842d87ebace4c03d7f12dd3be1f103", "committedDate": "2020-09-01T16:42:44Z", "message": "rebase master"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a7b3a4e268842d87ebace4c03d7f12dd3be1f103", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/a7b3a4e268842d87ebace4c03d7f12dd3be1f103", "committedDate": "2020-09-01T16:42:44Z", "message": "rebase master"}, "afterCommit": {"oid": "93fa69ebbc770c191c6834330e0bcb2898eba88b", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/93fa69ebbc770c191c6834330e0bcb2898eba88b", "committedDate": "2020-09-01T16:51:21Z", "message": "rebase master"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "93fa69ebbc770c191c6834330e0bcb2898eba88b", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/93fa69ebbc770c191c6834330e0bcb2898eba88b", "committedDate": "2020-09-01T16:51:21Z", "message": "rebase master"}, "afterCommit": {"oid": "c51ef79e9c7fb5ff47558d701b37c73b16499834", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/c51ef79e9c7fb5ff47558d701b37c73b16499834", "committedDate": "2020-09-01T17:40:25Z", "message": "rebase master"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c51ef79e9c7fb5ff47558d701b37c73b16499834", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/c51ef79e9c7fb5ff47558d701b37c73b16499834", "committedDate": "2020-09-01T17:40:25Z", "message": "rebase master"}, "afterCommit": {"oid": "abf3c654665362be70a78392f638d0ae7ad7bc6d", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/abf3c654665362be70a78392f638d0ae7ad7bc6d", "committedDate": "2020-09-02T15:06:58Z", "message": "rebase master"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "abf3c654665362be70a78392f638d0ae7ad7bc6d", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/abf3c654665362be70a78392f638d0ae7ad7bc6d", "committedDate": "2020-09-02T15:06:58Z", "message": "rebase master"}, "afterCommit": {"oid": "3901bcbcc191319a8cd7394f0f058b6c5e28d566", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/3901bcbcc191319a8cd7394f0f058b6c5e28d566", "committedDate": "2020-09-03T15:27:15Z", "message": "rebase master"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5af5fbd0e8f6d2934cc794959e20d2189765d2bb", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/5af5fbd0e8f6d2934cc794959e20d2189765d2bb", "committedDate": "2020-09-05T06:17:03Z", "message": "rebase master"}, "afterCommit": {"oid": "7902ca9485788a5eada5e8f2b0bd0b0389ad90a3", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/7902ca9485788a5eada5e8f2b0bd0b0389ad90a3", "committedDate": "2020-09-05T09:48:06Z", "message": "rebase master"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7902ca9485788a5eada5e8f2b0bd0b0389ad90a3", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/7902ca9485788a5eada5e8f2b0bd0b0389ad90a3", "committedDate": "2020-09-05T09:48:06Z", "message": "rebase master"}, "afterCommit": {"oid": "3e637ea42d9228eacbb4d76bb9f551334a05f01d", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/3e637ea42d9228eacbb4d76bb9f551334a05f01d", "committedDate": "2020-09-05T09:52:53Z", "message": "rebase master"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3e637ea42d9228eacbb4d76bb9f551334a05f01d", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/3e637ea42d9228eacbb4d76bb9f551334a05f01d", "committedDate": "2020-09-05T09:52:53Z", "message": "rebase master"}, "afterCommit": {"oid": "32d00412e619964df8ded5c8bd273d941f23acf8", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/32d00412e619964df8ded5c8bd273d941f23acf8", "committedDate": "2020-09-05T10:18:42Z", "message": "rebase master"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "32d00412e619964df8ded5c8bd273d941f23acf8", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/32d00412e619964df8ded5c8bd273d941f23acf8", "committedDate": "2020-09-05T10:18:42Z", "message": "rebase master"}, "afterCommit": {"oid": "e13408780ee7dfd29680551d397ecdc0b4d6505f", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/e13408780ee7dfd29680551d397ecdc0b4d6505f", "committedDate": "2020-09-06T03:52:05Z", "message": "rebase master"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e13408780ee7dfd29680551d397ecdc0b4d6505f", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/e13408780ee7dfd29680551d397ecdc0b4d6505f", "committedDate": "2020-09-06T03:52:05Z", "message": "rebase master"}, "afterCommit": {"oid": "f16ded111e1cef45443da8df30c3d060a82758e8", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/f16ded111e1cef45443da8df30c3d060a82758e8", "committedDate": "2020-09-06T05:02:44Z", "message": "rebase master"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f16ded111e1cef45443da8df30c3d060a82758e8", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/f16ded111e1cef45443da8df30c3d060a82758e8", "committedDate": "2020-09-06T05:02:44Z", "message": "rebase master"}, "afterCommit": {"oid": "71ad86f3a89e42fabbcb6d0ebb2734113c8c2323", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/71ad86f3a89e42fabbcb6d0ebb2734113c8c2323", "committedDate": "2020-09-06T05:59:51Z", "message": "rebase master"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "71ad86f3a89e42fabbcb6d0ebb2734113c8c2323", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/71ad86f3a89e42fabbcb6d0ebb2734113c8c2323", "committedDate": "2020-09-06T05:59:51Z", "message": "rebase master"}, "afterCommit": {"oid": "36573ef00199fc7648c2cbf543f811f1697306f2", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/36573ef00199fc7648c2cbf543f811f1697306f2", "committedDate": "2020-09-06T13:19:56Z", "message": "rebase master"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "36573ef00199fc7648c2cbf543f811f1697306f2", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/36573ef00199fc7648c2cbf543f811f1697306f2", "committedDate": "2020-09-06T13:19:56Z", "message": "rebase master"}, "afterCommit": {"oid": "28eecab55cb62bb602e6ed7fe1cb9d5b188a87df", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/28eecab55cb62bb602e6ed7fe1cb9d5b188a87df", "committedDate": "2020-09-06T14:29:42Z", "message": "rebase master"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "28eecab55cb62bb602e6ed7fe1cb9d5b188a87df", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/28eecab55cb62bb602e6ed7fe1cb9d5b188a87df", "committedDate": "2020-09-06T14:29:42Z", "message": "rebase master"}, "afterCommit": {"oid": "2348f73b4a270e4d04d2f67f9d7bd9691391b569", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/2348f73b4a270e4d04d2f67f9d7bd9691391b569", "committedDate": "2020-09-06T15:41:07Z", "message": "rebase master"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2348f73b4a270e4d04d2f67f9d7bd9691391b569", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/2348f73b4a270e4d04d2f67f9d7bd9691391b569", "committedDate": "2020-09-06T15:41:07Z", "message": "rebase master"}, "afterCommit": {"oid": "ac3339704c703741f9ff50f2d96019cef2d2c72b", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/ac3339704c703741f9ff50f2d96019cef2d2c72b", "committedDate": "2020-09-06T16:35:49Z", "message": "rebase master"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyMjQ5Mjc0", "url": "https://github.com/apache/hudi/pull/1827#pullrequestreview-482249274", "createdAt": "2020-09-03T22:41:17Z", "commit": {"oid": "3901bcbcc191319a8cd7394f0f058b6c5e28d566"}, "state": "COMMENTED", "comments": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QyMjo0MToxOFrOHM5vfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNlQxODoxMjoxNVrOHNrDTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzI5MTAwNw==", "bodyText": "nit: extra line.", "url": "https://github.com/apache/hudi/pull/1827#discussion_r483291007", "createdAt": "2020-09-03T22:41:18Z", "author": {"login": "vinothchandar"}, "path": "hudi-cli/src/test/java/org/apache/hudi/cli/commands/TestArchivedCommitsCommand.java", "diffHunk": "@@ -92,8 +92,9 @@ public void init() throws IOException {\n     metaClient.getActiveTimeline().reload().getAllCommitsTimeline().filterCompletedInstants();\n \n     // archive\n-    HoodieTimelineArchiveLog archiveLog = new HoodieTimelineArchiveLog(cfg, hadoopConf);\n-    archiveLog.archiveIfRequired(jsc);\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3901bcbcc191319a8cd7394f0f058b6c5e28d566"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzI5MTYzNg==", "bodyText": "surprised that this has so few dependencies.", "url": "https://github.com/apache/hudi/pull/1827#discussion_r483291636", "createdAt": "2020-09-03T22:43:26Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-client-common/pom.xml", "diffHunk": "@@ -0,0 +1,44 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<!--\n+  Licensed to the Apache Software Foundation (ASF) under one or more\n+  contributor license agreements.  See the NOTICE file distributed with\n+  this work for additional information regarding copyright ownership.\n+  The ASF licenses this file to You under the Apache License, Version 2.0\n+  (the \"License\"); you may not use this file except in compliance with\n+  the License.  You may obtain a copy of the License at\n+\n+       http://www.apache.org/licenses/LICENSE-2.0\n+\n+  Unless required by applicable law or agreed to in writing, software\n+  distributed under the License is distributed on an \"AS IS\" BASIS,\n+  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+  See the License for the specific language governing permissions and\n+  limitations under the License.\n+-->\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+  <parent>\n+    <artifactId>hudi-client</artifactId>\n+    <groupId>org.apache.hudi</groupId>\n+    <version>0.6.1-SNAPSHOT</version>\n+  </parent>\n+  <modelVersion>4.0.0</modelVersion>\n+\n+  <artifactId>hudi-client-common</artifactId>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3901bcbcc191319a8cd7394f0f058b6c5e28d566"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzI5MTcwNQ==", "bodyText": "typo: async", "url": "https://github.com/apache/hudi/pull/1827#discussion_r483291705", "createdAt": "2020-09-03T22:43:39Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/asyc/AbstractAsyncService.java", "diffHunk": "@@ -16,7 +16,7 @@\n  * limitations under the License.\n  */\n \n-package org.apache.hudi.async;\n+package org.apache.hudi.asyc;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3901bcbcc191319a8cd7394f0f058b6c5e28d566"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDA4MjkzNg==", "bodyText": "not sure if this is right. index must be not be needed at the the write client level.", "url": "https://github.com/apache/hudi/pull/1827#discussion_r484082936", "createdAt": "2020-09-06T15:25:44Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/client/AbstractHoodieWriteClient.java", "diffHunk": "@@ -18,120 +18,195 @@\n \n package org.apache.hudi.client;\n \n+import com.codahale.metrics.Timer;\n+import org.apache.hadoop.conf.Configuration;\n import org.apache.hudi.avro.model.HoodieCleanMetadata;\n import org.apache.hudi.avro.model.HoodieCompactionPlan;\n import org.apache.hudi.avro.model.HoodieRestoreMetadata;\n import org.apache.hudi.avro.model.HoodieRollbackMetadata;\n-import org.apache.hudi.client.embedded.EmbeddedTimelineService;\n+import org.apache.hudi.callback.HoodieWriteCommitCallback;\n+import org.apache.hudi.callback.common.HoodieWriteCommitCallbackMessage;\n+import org.apache.hudi.callback.util.HoodieCommitCallbackFactory;\n+import org.apache.hudi.client.embebbed.BaseEmbeddedTimelineService;\n+import org.apache.hudi.common.HoodieEngineContext;\n import org.apache.hudi.common.model.HoodieCommitMetadata;\n import org.apache.hudi.common.model.HoodieKey;\n-import org.apache.hudi.common.model.HoodieRecord;\n import org.apache.hudi.common.model.HoodieRecordPayload;\n import org.apache.hudi.common.model.HoodieWriteStat;\n import org.apache.hudi.common.model.WriteOperationType;\n import org.apache.hudi.common.table.HoodieTableMetaClient;\n import org.apache.hudi.common.table.timeline.HoodieActiveTimeline;\n import org.apache.hudi.common.table.timeline.HoodieInstant;\n-import org.apache.hudi.common.table.timeline.HoodieInstant.State;\n import org.apache.hudi.common.table.timeline.HoodieTimeline;\n import org.apache.hudi.common.util.Option;\n import org.apache.hudi.common.util.ValidationUtils;\n-import org.apache.hudi.config.HoodieCompactionConfig;\n import org.apache.hudi.config.HoodieWriteConfig;\n+\n import org.apache.hudi.exception.HoodieCommitException;\n import org.apache.hudi.exception.HoodieIOException;\n import org.apache.hudi.exception.HoodieRestoreException;\n import org.apache.hudi.exception.HoodieRollbackException;\n import org.apache.hudi.exception.HoodieSavepointException;\n import org.apache.hudi.index.HoodieIndex;\n import org.apache.hudi.metrics.HoodieMetrics;\n-import org.apache.hudi.table.HoodieTable;\n-import org.apache.hudi.table.HoodieTimelineArchiveLog;\n-import org.apache.hudi.table.MarkerFiles;\n import org.apache.hudi.table.BulkInsertPartitioner;\n+import org.apache.hudi.table.HoodieTable;\n import org.apache.hudi.table.action.HoodieWriteMetadata;\n-import org.apache.hudi.table.action.compact.CompactHelpers;\n import org.apache.hudi.table.action.savepoint.SavepointHelpers;\n-\n-import com.codahale.metrics.Timer;\n import org.apache.log4j.LogManager;\n import org.apache.log4j.Logger;\n-import org.apache.spark.SparkConf;\n-import org.apache.spark.api.java.JavaRDD;\n-import org.apache.spark.api.java.JavaSparkContext;\n \n import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n import java.text.ParseException;\n import java.util.Collection;\n import java.util.List;\n import java.util.Map;\n import java.util.stream.Collectors;\n \n /**\n- * Hoodie Write Client helps you build tables on HDFS [insert()] and then perform efficient mutations on an HDFS\n- * table [upsert()]\n- * <p>\n- * Note that, at any given time, there can only be one Spark job performing these operations on a Hoodie table.\n+ * Abstract Write Client providing functionality for performing commit, index updates and rollback\n+ * Reused for regular write operations like upsert/insert/bulk-insert.. as well as bootstrap\n+ *\n+ * @param <T> Sub type of HoodieRecordPayload\n+ * @param <I> Type of inputs\n+ * @param <K> Type of keys\n+ * @param <O> Type of outputs\n+ * @param <P> Type of record position [Key, Option[partitionPath, fileID]] in hoodie table\n  */\n-public class HoodieWriteClient<T extends HoodieRecordPayload> extends AbstractHoodieWriteClient<T> {\n-\n+public abstract class AbstractHoodieWriteClient<T extends HoodieRecordPayload, I, K, O, P> extends AbstractHoodieClient {\n   private static final long serialVersionUID = 1L;\n-  private static final Logger LOG = LogManager.getLogger(HoodieWriteClient.class);\n-  private static final String LOOKUP_STR = \"lookup\";\n-  private final boolean rollbackPending;\n-  private final transient HoodieMetrics metrics;\n-  private transient Timer.Context compactionTimer;\n+  private static final Logger LOG = LogManager.getLogger(AbstractHoodieWriteClient.class);\n+\n+  protected final transient HoodieMetrics metrics;\n+  private final transient HoodieIndex<T, I, K, O, P> index;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "28eecab55cb62bb602e6ed7fe1cb9d5b188a87df"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDA4MzA3MQ==", "bodyText": "can we move all the static members to the top, like how it was before.", "url": "https://github.com/apache/hudi/pull/1827#discussion_r484083071", "createdAt": "2020-09-06T15:27:01Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/client/AbstractHoodieWriteClient.java", "diffHunk": "@@ -18,120 +18,195 @@\n \n package org.apache.hudi.client;\n \n+import com.codahale.metrics.Timer;\n+import org.apache.hadoop.conf.Configuration;\n import org.apache.hudi.avro.model.HoodieCleanMetadata;\n import org.apache.hudi.avro.model.HoodieCompactionPlan;\n import org.apache.hudi.avro.model.HoodieRestoreMetadata;\n import org.apache.hudi.avro.model.HoodieRollbackMetadata;\n-import org.apache.hudi.client.embedded.EmbeddedTimelineService;\n+import org.apache.hudi.callback.HoodieWriteCommitCallback;\n+import org.apache.hudi.callback.common.HoodieWriteCommitCallbackMessage;\n+import org.apache.hudi.callback.util.HoodieCommitCallbackFactory;\n+import org.apache.hudi.client.embebbed.BaseEmbeddedTimelineService;\n+import org.apache.hudi.common.HoodieEngineContext;\n import org.apache.hudi.common.model.HoodieCommitMetadata;\n import org.apache.hudi.common.model.HoodieKey;\n-import org.apache.hudi.common.model.HoodieRecord;\n import org.apache.hudi.common.model.HoodieRecordPayload;\n import org.apache.hudi.common.model.HoodieWriteStat;\n import org.apache.hudi.common.model.WriteOperationType;\n import org.apache.hudi.common.table.HoodieTableMetaClient;\n import org.apache.hudi.common.table.timeline.HoodieActiveTimeline;\n import org.apache.hudi.common.table.timeline.HoodieInstant;\n-import org.apache.hudi.common.table.timeline.HoodieInstant.State;\n import org.apache.hudi.common.table.timeline.HoodieTimeline;\n import org.apache.hudi.common.util.Option;\n import org.apache.hudi.common.util.ValidationUtils;\n-import org.apache.hudi.config.HoodieCompactionConfig;\n import org.apache.hudi.config.HoodieWriteConfig;\n+\n import org.apache.hudi.exception.HoodieCommitException;\n import org.apache.hudi.exception.HoodieIOException;\n import org.apache.hudi.exception.HoodieRestoreException;\n import org.apache.hudi.exception.HoodieRollbackException;\n import org.apache.hudi.exception.HoodieSavepointException;\n import org.apache.hudi.index.HoodieIndex;\n import org.apache.hudi.metrics.HoodieMetrics;\n-import org.apache.hudi.table.HoodieTable;\n-import org.apache.hudi.table.HoodieTimelineArchiveLog;\n-import org.apache.hudi.table.MarkerFiles;\n import org.apache.hudi.table.BulkInsertPartitioner;\n+import org.apache.hudi.table.HoodieTable;\n import org.apache.hudi.table.action.HoodieWriteMetadata;\n-import org.apache.hudi.table.action.compact.CompactHelpers;\n import org.apache.hudi.table.action.savepoint.SavepointHelpers;\n-\n-import com.codahale.metrics.Timer;\n import org.apache.log4j.LogManager;\n import org.apache.log4j.Logger;\n-import org.apache.spark.SparkConf;\n-import org.apache.spark.api.java.JavaRDD;\n-import org.apache.spark.api.java.JavaSparkContext;\n \n import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n import java.text.ParseException;\n import java.util.Collection;\n import java.util.List;\n import java.util.Map;\n import java.util.stream.Collectors;\n \n /**\n- * Hoodie Write Client helps you build tables on HDFS [insert()] and then perform efficient mutations on an HDFS\n- * table [upsert()]\n- * <p>\n- * Note that, at any given time, there can only be one Spark job performing these operations on a Hoodie table.\n+ * Abstract Write Client providing functionality for performing commit, index updates and rollback\n+ * Reused for regular write operations like upsert/insert/bulk-insert.. as well as bootstrap\n+ *\n+ * @param <T> Sub type of HoodieRecordPayload\n+ * @param <I> Type of inputs\n+ * @param <K> Type of keys\n+ * @param <O> Type of outputs\n+ * @param <P> Type of record position [Key, Option[partitionPath, fileID]] in hoodie table\n  */\n-public class HoodieWriteClient<T extends HoodieRecordPayload> extends AbstractHoodieWriteClient<T> {\n-\n+public abstract class AbstractHoodieWriteClient<T extends HoodieRecordPayload, I, K, O, P> extends AbstractHoodieClient {\n   private static final long serialVersionUID = 1L;\n-  private static final Logger LOG = LogManager.getLogger(HoodieWriteClient.class);\n-  private static final String LOOKUP_STR = \"lookup\";\n-  private final boolean rollbackPending;\n-  private final transient HoodieMetrics metrics;\n-  private transient Timer.Context compactionTimer;\n+  private static final Logger LOG = LogManager.getLogger(AbstractHoodieWriteClient.class);\n+\n+  protected final transient HoodieMetrics metrics;\n+  private final transient HoodieIndex<T, I, K, O, P> index;\n+\n+  protected transient Timer.Context writeContext = null;\n+  private transient WriteOperationType operationType;\n+  private transient HoodieWriteCommitCallback commitCallback;\n+\n+  protected static final String LOOKUP_STR = \"lookup\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "28eecab55cb62bb602e6ed7fe1cb9d5b188a87df"}, "originalPosition": 95}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDA4MzIxNg==", "bodyText": "why did this constructor have to change", "url": "https://github.com/apache/hudi/pull/1827#discussion_r484083216", "createdAt": "2020-09-06T15:28:40Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/client/AbstractHoodieWriteClient.java", "diffHunk": "@@ -18,120 +18,195 @@\n \n package org.apache.hudi.client;\n \n+import com.codahale.metrics.Timer;\n+import org.apache.hadoop.conf.Configuration;\n import org.apache.hudi.avro.model.HoodieCleanMetadata;\n import org.apache.hudi.avro.model.HoodieCompactionPlan;\n import org.apache.hudi.avro.model.HoodieRestoreMetadata;\n import org.apache.hudi.avro.model.HoodieRollbackMetadata;\n-import org.apache.hudi.client.embedded.EmbeddedTimelineService;\n+import org.apache.hudi.callback.HoodieWriteCommitCallback;\n+import org.apache.hudi.callback.common.HoodieWriteCommitCallbackMessage;\n+import org.apache.hudi.callback.util.HoodieCommitCallbackFactory;\n+import org.apache.hudi.client.embebbed.BaseEmbeddedTimelineService;\n+import org.apache.hudi.common.HoodieEngineContext;\n import org.apache.hudi.common.model.HoodieCommitMetadata;\n import org.apache.hudi.common.model.HoodieKey;\n-import org.apache.hudi.common.model.HoodieRecord;\n import org.apache.hudi.common.model.HoodieRecordPayload;\n import org.apache.hudi.common.model.HoodieWriteStat;\n import org.apache.hudi.common.model.WriteOperationType;\n import org.apache.hudi.common.table.HoodieTableMetaClient;\n import org.apache.hudi.common.table.timeline.HoodieActiveTimeline;\n import org.apache.hudi.common.table.timeline.HoodieInstant;\n-import org.apache.hudi.common.table.timeline.HoodieInstant.State;\n import org.apache.hudi.common.table.timeline.HoodieTimeline;\n import org.apache.hudi.common.util.Option;\n import org.apache.hudi.common.util.ValidationUtils;\n-import org.apache.hudi.config.HoodieCompactionConfig;\n import org.apache.hudi.config.HoodieWriteConfig;\n+\n import org.apache.hudi.exception.HoodieCommitException;\n import org.apache.hudi.exception.HoodieIOException;\n import org.apache.hudi.exception.HoodieRestoreException;\n import org.apache.hudi.exception.HoodieRollbackException;\n import org.apache.hudi.exception.HoodieSavepointException;\n import org.apache.hudi.index.HoodieIndex;\n import org.apache.hudi.metrics.HoodieMetrics;\n-import org.apache.hudi.table.HoodieTable;\n-import org.apache.hudi.table.HoodieTimelineArchiveLog;\n-import org.apache.hudi.table.MarkerFiles;\n import org.apache.hudi.table.BulkInsertPartitioner;\n+import org.apache.hudi.table.HoodieTable;\n import org.apache.hudi.table.action.HoodieWriteMetadata;\n-import org.apache.hudi.table.action.compact.CompactHelpers;\n import org.apache.hudi.table.action.savepoint.SavepointHelpers;\n-\n-import com.codahale.metrics.Timer;\n import org.apache.log4j.LogManager;\n import org.apache.log4j.Logger;\n-import org.apache.spark.SparkConf;\n-import org.apache.spark.api.java.JavaRDD;\n-import org.apache.spark.api.java.JavaSparkContext;\n \n import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n import java.text.ParseException;\n import java.util.Collection;\n import java.util.List;\n import java.util.Map;\n import java.util.stream.Collectors;\n \n /**\n- * Hoodie Write Client helps you build tables on HDFS [insert()] and then perform efficient mutations on an HDFS\n- * table [upsert()]\n- * <p>\n- * Note that, at any given time, there can only be one Spark job performing these operations on a Hoodie table.\n+ * Abstract Write Client providing functionality for performing commit, index updates and rollback\n+ * Reused for regular write operations like upsert/insert/bulk-insert.. as well as bootstrap\n+ *\n+ * @param <T> Sub type of HoodieRecordPayload\n+ * @param <I> Type of inputs\n+ * @param <K> Type of keys\n+ * @param <O> Type of outputs\n+ * @param <P> Type of record position [Key, Option[partitionPath, fileID]] in hoodie table\n  */\n-public class HoodieWriteClient<T extends HoodieRecordPayload> extends AbstractHoodieWriteClient<T> {\n-\n+public abstract class AbstractHoodieWriteClient<T extends HoodieRecordPayload, I, K, O, P> extends AbstractHoodieClient {\n   private static final long serialVersionUID = 1L;\n-  private static final Logger LOG = LogManager.getLogger(HoodieWriteClient.class);\n-  private static final String LOOKUP_STR = \"lookup\";\n-  private final boolean rollbackPending;\n-  private final transient HoodieMetrics metrics;\n-  private transient Timer.Context compactionTimer;\n+  private static final Logger LOG = LogManager.getLogger(AbstractHoodieWriteClient.class);\n+\n+  protected final transient HoodieMetrics metrics;\n+  private final transient HoodieIndex<T, I, K, O, P> index;\n+\n+  protected transient Timer.Context writeContext = null;\n+  private transient WriteOperationType operationType;\n+  private transient HoodieWriteCommitCallback commitCallback;\n+\n+  protected static final String LOOKUP_STR = \"lookup\";\n+  protected final boolean rollbackPending;\n+  protected transient Timer.Context compactionTimer;\n   private transient AsyncCleanerService asyncCleanerService;\n \n+  public void setOperationType(WriteOperationType operationType) {\n+    this.operationType = operationType;\n+  }\n+\n+  public WriteOperationType getOperationType() {\n+    return this.operationType;\n+  }\n+\n   /**\n    * Create a write client, without cleaning up failed/inflight commits.\n    *\n-   * @param jsc Java Spark Context\n+   * @param context      Java Spark Context\n    * @param clientConfig instance of HoodieWriteConfig\n    */\n-  public HoodieWriteClient(JavaSparkContext jsc, HoodieWriteConfig clientConfig) {\n-    this(jsc, clientConfig, false);\n+  public AbstractHoodieWriteClient(HoodieEngineContext context, HoodieWriteConfig clientConfig) {\n+    this(context, clientConfig, false);\n   }\n \n   /**\n    * Create a write client, with new hudi index.\n    *\n-   * @param jsc Java Spark Context\n-   * @param writeConfig instance of HoodieWriteConfig\n+   * @param context         HoodieEngineContext\n+   * @param writeConfig     instance of HoodieWriteConfig\n    * @param rollbackPending whether need to cleanup pending commits\n    */\n-  public HoodieWriteClient(JavaSparkContext jsc, HoodieWriteConfig writeConfig, boolean rollbackPending) {\n-    this(jsc, writeConfig, rollbackPending, HoodieIndex.createIndex(writeConfig));\n-  }\n-\n-  public HoodieWriteClient(JavaSparkContext jsc, HoodieWriteConfig writeConfig, boolean rollbackPending, HoodieIndex index) {\n-    this(jsc, writeConfig, rollbackPending, index, Option.empty());\n+  public AbstractHoodieWriteClient(HoodieEngineContext context, HoodieWriteConfig writeConfig, boolean rollbackPending) {\n+    this(context, writeConfig, rollbackPending, Option.empty());\n   }\n \n   /**\n-   *  Create a write client, allows to specify all parameters.\n+   * Create a write client, allows to specify all parameters.\n    *\n-   * @param jsc Java Spark Context\n-   * @param writeConfig instance of HoodieWriteConfig\n+   * @param context         HoodieEngineContext\n+   * @param writeConfig     instance of HoodieWriteConfig\n    * @param rollbackPending whether need to cleanup pending commits\n    * @param timelineService Timeline Service that runs as part of write client.\n    */\n-  public HoodieWriteClient(JavaSparkContext jsc, HoodieWriteConfig writeConfig, boolean rollbackPending,\n-      HoodieIndex index, Option<EmbeddedTimelineService> timelineService) {\n-    super(jsc, index, writeConfig, timelineService);\n+  public AbstractHoodieWriteClient(HoodieEngineContext context, HoodieWriteConfig writeConfig, boolean rollbackPending,\n+                                   Option<BaseEmbeddedTimelineService> timelineService) {\n+    super(context, writeConfig, timelineService);\n     this.metrics = new HoodieMetrics(config, config.getTableName());\n     this.rollbackPending = rollbackPending;\n+    this.index = createIndex(writeConfig);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "28eecab55cb62bb602e6ed7fe1cb9d5b188a87df"}, "originalPosition": 159}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDA4MzI3NA==", "bodyText": "same point, not sure if this is correct.", "url": "https://github.com/apache/hudi/pull/1827#discussion_r484083274", "createdAt": "2020-09-06T15:29:19Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/client/AbstractHoodieWriteClient.java", "diffHunk": "@@ -18,120 +18,195 @@\n \n package org.apache.hudi.client;\n \n+import com.codahale.metrics.Timer;\n+import org.apache.hadoop.conf.Configuration;\n import org.apache.hudi.avro.model.HoodieCleanMetadata;\n import org.apache.hudi.avro.model.HoodieCompactionPlan;\n import org.apache.hudi.avro.model.HoodieRestoreMetadata;\n import org.apache.hudi.avro.model.HoodieRollbackMetadata;\n-import org.apache.hudi.client.embedded.EmbeddedTimelineService;\n+import org.apache.hudi.callback.HoodieWriteCommitCallback;\n+import org.apache.hudi.callback.common.HoodieWriteCommitCallbackMessage;\n+import org.apache.hudi.callback.util.HoodieCommitCallbackFactory;\n+import org.apache.hudi.client.embebbed.BaseEmbeddedTimelineService;\n+import org.apache.hudi.common.HoodieEngineContext;\n import org.apache.hudi.common.model.HoodieCommitMetadata;\n import org.apache.hudi.common.model.HoodieKey;\n-import org.apache.hudi.common.model.HoodieRecord;\n import org.apache.hudi.common.model.HoodieRecordPayload;\n import org.apache.hudi.common.model.HoodieWriteStat;\n import org.apache.hudi.common.model.WriteOperationType;\n import org.apache.hudi.common.table.HoodieTableMetaClient;\n import org.apache.hudi.common.table.timeline.HoodieActiveTimeline;\n import org.apache.hudi.common.table.timeline.HoodieInstant;\n-import org.apache.hudi.common.table.timeline.HoodieInstant.State;\n import org.apache.hudi.common.table.timeline.HoodieTimeline;\n import org.apache.hudi.common.util.Option;\n import org.apache.hudi.common.util.ValidationUtils;\n-import org.apache.hudi.config.HoodieCompactionConfig;\n import org.apache.hudi.config.HoodieWriteConfig;\n+\n import org.apache.hudi.exception.HoodieCommitException;\n import org.apache.hudi.exception.HoodieIOException;\n import org.apache.hudi.exception.HoodieRestoreException;\n import org.apache.hudi.exception.HoodieRollbackException;\n import org.apache.hudi.exception.HoodieSavepointException;\n import org.apache.hudi.index.HoodieIndex;\n import org.apache.hudi.metrics.HoodieMetrics;\n-import org.apache.hudi.table.HoodieTable;\n-import org.apache.hudi.table.HoodieTimelineArchiveLog;\n-import org.apache.hudi.table.MarkerFiles;\n import org.apache.hudi.table.BulkInsertPartitioner;\n+import org.apache.hudi.table.HoodieTable;\n import org.apache.hudi.table.action.HoodieWriteMetadata;\n-import org.apache.hudi.table.action.compact.CompactHelpers;\n import org.apache.hudi.table.action.savepoint.SavepointHelpers;\n-\n-import com.codahale.metrics.Timer;\n import org.apache.log4j.LogManager;\n import org.apache.log4j.Logger;\n-import org.apache.spark.SparkConf;\n-import org.apache.spark.api.java.JavaRDD;\n-import org.apache.spark.api.java.JavaSparkContext;\n \n import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n import java.text.ParseException;\n import java.util.Collection;\n import java.util.List;\n import java.util.Map;\n import java.util.stream.Collectors;\n \n /**\n- * Hoodie Write Client helps you build tables on HDFS [insert()] and then perform efficient mutations on an HDFS\n- * table [upsert()]\n- * <p>\n- * Note that, at any given time, there can only be one Spark job performing these operations on a Hoodie table.\n+ * Abstract Write Client providing functionality for performing commit, index updates and rollback\n+ * Reused for regular write operations like upsert/insert/bulk-insert.. as well as bootstrap\n+ *\n+ * @param <T> Sub type of HoodieRecordPayload\n+ * @param <I> Type of inputs\n+ * @param <K> Type of keys\n+ * @param <O> Type of outputs\n+ * @param <P> Type of record position [Key, Option[partitionPath, fileID]] in hoodie table\n  */\n-public class HoodieWriteClient<T extends HoodieRecordPayload> extends AbstractHoodieWriteClient<T> {\n-\n+public abstract class AbstractHoodieWriteClient<T extends HoodieRecordPayload, I, K, O, P> extends AbstractHoodieClient {\n   private static final long serialVersionUID = 1L;\n-  private static final Logger LOG = LogManager.getLogger(HoodieWriteClient.class);\n-  private static final String LOOKUP_STR = \"lookup\";\n-  private final boolean rollbackPending;\n-  private final transient HoodieMetrics metrics;\n-  private transient Timer.Context compactionTimer;\n+  private static final Logger LOG = LogManager.getLogger(AbstractHoodieWriteClient.class);\n+\n+  protected final transient HoodieMetrics metrics;\n+  private final transient HoodieIndex<T, I, K, O, P> index;\n+\n+  protected transient Timer.Context writeContext = null;\n+  private transient WriteOperationType operationType;\n+  private transient HoodieWriteCommitCallback commitCallback;\n+\n+  protected static final String LOOKUP_STR = \"lookup\";\n+  protected final boolean rollbackPending;\n+  protected transient Timer.Context compactionTimer;\n   private transient AsyncCleanerService asyncCleanerService;\n \n+  public void setOperationType(WriteOperationType operationType) {\n+    this.operationType = operationType;\n+  }\n+\n+  public WriteOperationType getOperationType() {\n+    return this.operationType;\n+  }\n+\n   /**\n    * Create a write client, without cleaning up failed/inflight commits.\n    *\n-   * @param jsc Java Spark Context\n+   * @param context      Java Spark Context\n    * @param clientConfig instance of HoodieWriteConfig\n    */\n-  public HoodieWriteClient(JavaSparkContext jsc, HoodieWriteConfig clientConfig) {\n-    this(jsc, clientConfig, false);\n+  public AbstractHoodieWriteClient(HoodieEngineContext context, HoodieWriteConfig clientConfig) {\n+    this(context, clientConfig, false);\n   }\n \n   /**\n    * Create a write client, with new hudi index.\n    *\n-   * @param jsc Java Spark Context\n-   * @param writeConfig instance of HoodieWriteConfig\n+   * @param context         HoodieEngineContext\n+   * @param writeConfig     instance of HoodieWriteConfig\n    * @param rollbackPending whether need to cleanup pending commits\n    */\n-  public HoodieWriteClient(JavaSparkContext jsc, HoodieWriteConfig writeConfig, boolean rollbackPending) {\n-    this(jsc, writeConfig, rollbackPending, HoodieIndex.createIndex(writeConfig));\n-  }\n-\n-  public HoodieWriteClient(JavaSparkContext jsc, HoodieWriteConfig writeConfig, boolean rollbackPending, HoodieIndex index) {\n-    this(jsc, writeConfig, rollbackPending, index, Option.empty());\n+  public AbstractHoodieWriteClient(HoodieEngineContext context, HoodieWriteConfig writeConfig, boolean rollbackPending) {\n+    this(context, writeConfig, rollbackPending, Option.empty());\n   }\n \n   /**\n-   *  Create a write client, allows to specify all parameters.\n+   * Create a write client, allows to specify all parameters.\n    *\n-   * @param jsc Java Spark Context\n-   * @param writeConfig instance of HoodieWriteConfig\n+   * @param context         HoodieEngineContext\n+   * @param writeConfig     instance of HoodieWriteConfig\n    * @param rollbackPending whether need to cleanup pending commits\n    * @param timelineService Timeline Service that runs as part of write client.\n    */\n-  public HoodieWriteClient(JavaSparkContext jsc, HoodieWriteConfig writeConfig, boolean rollbackPending,\n-      HoodieIndex index, Option<EmbeddedTimelineService> timelineService) {\n-    super(jsc, index, writeConfig, timelineService);\n+  public AbstractHoodieWriteClient(HoodieEngineContext context, HoodieWriteConfig writeConfig, boolean rollbackPending,\n+                                   Option<BaseEmbeddedTimelineService> timelineService) {\n+    super(context, writeConfig, timelineService);\n     this.metrics = new HoodieMetrics(config, config.getTableName());\n     this.rollbackPending = rollbackPending;\n+    this.index = createIndex(writeConfig);\n   }\n \n+  protected abstract HoodieIndex<T, I, K, O, P> createIndex(HoodieWriteConfig writeConfig);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "28eecab55cb62bb602e6ed7fe1cb9d5b188a87df"}, "originalPosition": 162}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDA4MzQ0Mg==", "bodyText": "guessing this is all moved to spark client now?", "url": "https://github.com/apache/hudi/pull/1827#discussion_r484083442", "createdAt": "2020-09-06T15:30:50Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/client/AbstractHoodieWriteClient.java", "diffHunk": "@@ -18,120 +18,195 @@\n \n package org.apache.hudi.client;\n \n+import com.codahale.metrics.Timer;\n+import org.apache.hadoop.conf.Configuration;\n import org.apache.hudi.avro.model.HoodieCleanMetadata;\n import org.apache.hudi.avro.model.HoodieCompactionPlan;\n import org.apache.hudi.avro.model.HoodieRestoreMetadata;\n import org.apache.hudi.avro.model.HoodieRollbackMetadata;\n-import org.apache.hudi.client.embedded.EmbeddedTimelineService;\n+import org.apache.hudi.callback.HoodieWriteCommitCallback;\n+import org.apache.hudi.callback.common.HoodieWriteCommitCallbackMessage;\n+import org.apache.hudi.callback.util.HoodieCommitCallbackFactory;\n+import org.apache.hudi.client.embebbed.BaseEmbeddedTimelineService;\n+import org.apache.hudi.common.HoodieEngineContext;\n import org.apache.hudi.common.model.HoodieCommitMetadata;\n import org.apache.hudi.common.model.HoodieKey;\n-import org.apache.hudi.common.model.HoodieRecord;\n import org.apache.hudi.common.model.HoodieRecordPayload;\n import org.apache.hudi.common.model.HoodieWriteStat;\n import org.apache.hudi.common.model.WriteOperationType;\n import org.apache.hudi.common.table.HoodieTableMetaClient;\n import org.apache.hudi.common.table.timeline.HoodieActiveTimeline;\n import org.apache.hudi.common.table.timeline.HoodieInstant;\n-import org.apache.hudi.common.table.timeline.HoodieInstant.State;\n import org.apache.hudi.common.table.timeline.HoodieTimeline;\n import org.apache.hudi.common.util.Option;\n import org.apache.hudi.common.util.ValidationUtils;\n-import org.apache.hudi.config.HoodieCompactionConfig;\n import org.apache.hudi.config.HoodieWriteConfig;\n+\n import org.apache.hudi.exception.HoodieCommitException;\n import org.apache.hudi.exception.HoodieIOException;\n import org.apache.hudi.exception.HoodieRestoreException;\n import org.apache.hudi.exception.HoodieRollbackException;\n import org.apache.hudi.exception.HoodieSavepointException;\n import org.apache.hudi.index.HoodieIndex;\n import org.apache.hudi.metrics.HoodieMetrics;\n-import org.apache.hudi.table.HoodieTable;\n-import org.apache.hudi.table.HoodieTimelineArchiveLog;\n-import org.apache.hudi.table.MarkerFiles;\n import org.apache.hudi.table.BulkInsertPartitioner;\n+import org.apache.hudi.table.HoodieTable;\n import org.apache.hudi.table.action.HoodieWriteMetadata;\n-import org.apache.hudi.table.action.compact.CompactHelpers;\n import org.apache.hudi.table.action.savepoint.SavepointHelpers;\n-\n-import com.codahale.metrics.Timer;\n import org.apache.log4j.LogManager;\n import org.apache.log4j.Logger;\n-import org.apache.spark.SparkConf;\n-import org.apache.spark.api.java.JavaRDD;\n-import org.apache.spark.api.java.JavaSparkContext;\n \n import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n import java.text.ParseException;\n import java.util.Collection;\n import java.util.List;\n import java.util.Map;\n import java.util.stream.Collectors;\n \n /**\n- * Hoodie Write Client helps you build tables on HDFS [insert()] and then perform efficient mutations on an HDFS\n- * table [upsert()]\n- * <p>\n- * Note that, at any given time, there can only be one Spark job performing these operations on a Hoodie table.\n+ * Abstract Write Client providing functionality for performing commit, index updates and rollback\n+ * Reused for regular write operations like upsert/insert/bulk-insert.. as well as bootstrap\n+ *\n+ * @param <T> Sub type of HoodieRecordPayload\n+ * @param <I> Type of inputs\n+ * @param <K> Type of keys\n+ * @param <O> Type of outputs\n+ * @param <P> Type of record position [Key, Option[partitionPath, fileID]] in hoodie table\n  */\n-public class HoodieWriteClient<T extends HoodieRecordPayload> extends AbstractHoodieWriteClient<T> {\n-\n+public abstract class AbstractHoodieWriteClient<T extends HoodieRecordPayload, I, K, O, P> extends AbstractHoodieClient {\n   private static final long serialVersionUID = 1L;\n-  private static final Logger LOG = LogManager.getLogger(HoodieWriteClient.class);\n-  private static final String LOOKUP_STR = \"lookup\";\n-  private final boolean rollbackPending;\n-  private final transient HoodieMetrics metrics;\n-  private transient Timer.Context compactionTimer;\n+  private static final Logger LOG = LogManager.getLogger(AbstractHoodieWriteClient.class);\n+\n+  protected final transient HoodieMetrics metrics;\n+  private final transient HoodieIndex<T, I, K, O, P> index;\n+\n+  protected transient Timer.Context writeContext = null;\n+  private transient WriteOperationType operationType;\n+  private transient HoodieWriteCommitCallback commitCallback;\n+\n+  protected static final String LOOKUP_STR = \"lookup\";\n+  protected final boolean rollbackPending;\n+  protected transient Timer.Context compactionTimer;\n   private transient AsyncCleanerService asyncCleanerService;\n \n+  public void setOperationType(WriteOperationType operationType) {\n+    this.operationType = operationType;\n+  }\n+\n+  public WriteOperationType getOperationType() {\n+    return this.operationType;\n+  }\n+\n   /**\n    * Create a write client, without cleaning up failed/inflight commits.\n    *\n-   * @param jsc Java Spark Context\n+   * @param context      Java Spark Context\n    * @param clientConfig instance of HoodieWriteConfig\n    */\n-  public HoodieWriteClient(JavaSparkContext jsc, HoodieWriteConfig clientConfig) {\n-    this(jsc, clientConfig, false);\n+  public AbstractHoodieWriteClient(HoodieEngineContext context, HoodieWriteConfig clientConfig) {\n+    this(context, clientConfig, false);\n   }\n \n   /**\n    * Create a write client, with new hudi index.\n    *\n-   * @param jsc Java Spark Context\n-   * @param writeConfig instance of HoodieWriteConfig\n+   * @param context         HoodieEngineContext\n+   * @param writeConfig     instance of HoodieWriteConfig\n    * @param rollbackPending whether need to cleanup pending commits\n    */\n-  public HoodieWriteClient(JavaSparkContext jsc, HoodieWriteConfig writeConfig, boolean rollbackPending) {\n-    this(jsc, writeConfig, rollbackPending, HoodieIndex.createIndex(writeConfig));\n-  }\n-\n-  public HoodieWriteClient(JavaSparkContext jsc, HoodieWriteConfig writeConfig, boolean rollbackPending, HoodieIndex index) {\n-    this(jsc, writeConfig, rollbackPending, index, Option.empty());\n+  public AbstractHoodieWriteClient(HoodieEngineContext context, HoodieWriteConfig writeConfig, boolean rollbackPending) {\n+    this(context, writeConfig, rollbackPending, Option.empty());\n   }\n \n   /**\n-   *  Create a write client, allows to specify all parameters.\n+   * Create a write client, allows to specify all parameters.\n    *\n-   * @param jsc Java Spark Context\n-   * @param writeConfig instance of HoodieWriteConfig\n+   * @param context         HoodieEngineContext\n+   * @param writeConfig     instance of HoodieWriteConfig\n    * @param rollbackPending whether need to cleanup pending commits\n    * @param timelineService Timeline Service that runs as part of write client.\n    */\n-  public HoodieWriteClient(JavaSparkContext jsc, HoodieWriteConfig writeConfig, boolean rollbackPending,\n-      HoodieIndex index, Option<EmbeddedTimelineService> timelineService) {\n-    super(jsc, index, writeConfig, timelineService);\n+  public AbstractHoodieWriteClient(HoodieEngineContext context, HoodieWriteConfig writeConfig, boolean rollbackPending,\n+                                   Option<BaseEmbeddedTimelineService> timelineService) {\n+    super(context, writeConfig, timelineService);\n     this.metrics = new HoodieMetrics(config, config.getTableName());\n     this.rollbackPending = rollbackPending;\n+    this.index = createIndex(writeConfig);\n   }\n \n+  protected abstract HoodieIndex<T, I, K, O, P> createIndex(HoodieWriteConfig writeConfig);\n+\n   /**\n-   * Register hudi classes for Kryo serialization.\n-   *\n-   * @param conf instance of SparkConf\n-   * @return SparkConf\n+   * Commit changes performed at the given instantTime marker.\n    */\n-  public static SparkConf registerClasses(SparkConf conf) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "28eecab55cb62bb602e6ed7fe1cb9d5b188a87df"}, "originalPosition": 171}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDA4NDI5NQ==", "bodyText": "it would be great, if you can avoid the whitespace changes :) Have to fish for what the real changes are", "url": "https://github.com/apache/hudi/pull/1827#discussion_r484084295", "createdAt": "2020-09-06T15:39:17Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/client/AbstractHoodieWriteClient.java", "diffHunk": "@@ -242,150 +286,93 @@ protected void rollBackInflightBootstrap() {\n    * de-duped if needed.\n    *\n    * @param preppedRecords HoodieRecords to insert\n-   * @param instantTime Instant time of the commit\n+   * @param instantTime    Instant time of the commit\n    * @return JavaRDD[WriteStatus] - RDD of WriteStatus to inspect errors and counts\n    */\n-  public JavaRDD<WriteStatus> insertPreppedRecords(JavaRDD<HoodieRecord<T>> preppedRecords, final String instantTime) {\n-    HoodieTable<T> table = getTableAndInitCtx(WriteOperationType.INSERT_PREPPED, instantTime);\n-    table.validateInsertSchema();\n-    setOperationType(WriteOperationType.INSERT_PREPPED);\n-    this.asyncCleanerService = AsyncCleanerService.startAsyncCleaningIfEnabled(this, instantTime);\n-    HoodieWriteMetadata result = table.insertPrepped(jsc,instantTime, preppedRecords);\n-    return postWrite(result, instantTime, table);\n-  }\n+  public abstract O insertPreppedRecords(I preppedRecords, final String instantTime);\n \n   /**\n    * Loads the given HoodieRecords, as inserts into the table. This is suitable for doing big bulk loads into a Hoodie\n    * table for the very first time (e.g: converting an existing table to Hoodie).\n    * <p>\n    * This implementation uses sortBy (which does range partitioning based on reservoir sampling) and attempts to control\n-   * the numbers of files with less memory compared to the {@link HoodieWriteClient#insert(JavaRDD, String)}\n+   * the numbers of files with less memory compared to the {@link AbstractHoodieWriteClient#insert(I, String)}\n    *\n-   * @param records HoodieRecords to insert\n+   * @param records     HoodieRecords to insert\n    * @param instantTime Instant time of the commit\n    * @return JavaRDD[WriteStatus] - RDD of WriteStatus to inspect errors and counts\n    */\n-  public JavaRDD<WriteStatus> bulkInsert(JavaRDD<HoodieRecord<T>> records, final String instantTime) {\n-    return bulkInsert(records, instantTime, Option.empty());\n-  }\n+  public abstract O bulkInsert(I records, final String instantTime);\n \n   /**\n    * Loads the given HoodieRecords, as inserts into the table. This is suitable for doing big bulk loads into a Hoodie\n    * table for the very first time (e.g: converting an existing table to Hoodie).\n    * <p>\n    * This implementation uses sortBy (which does range partitioning based on reservoir sampling) and attempts to control\n-   * the numbers of files with less memory compared to the {@link HoodieWriteClient#insert(JavaRDD, String)}. Optionally\n+   * the numbers of files with less memory compared to the {@link AbstractHoodieWriteClient#insert(I, String)}. Optionally\n    * it allows users to specify their own partitioner. If specified then it will be used for repartitioning records. See\n    * {@link BulkInsertPartitioner}.\n    *\n-   * @param records HoodieRecords to insert\n-   * @param instantTime Instant time of the commit\n+   * @param records                          HoodieRecords to insert\n+   * @param instantTime                      Instant time of the commit\n    * @param userDefinedBulkInsertPartitioner If specified then it will be used to partition input records before they are inserted\n-   * into hoodie.\n+   *                                         into hoodie.\n    * @return JavaRDD[WriteStatus] - RDD of WriteStatus to inspect errors and counts\n    */\n-  public JavaRDD<WriteStatus> bulkInsert(JavaRDD<HoodieRecord<T>> records, final String instantTime,\n-                                         Option<BulkInsertPartitioner> userDefinedBulkInsertPartitioner) {\n-    HoodieTable<T> table = getTableAndInitCtx(WriteOperationType.BULK_INSERT, instantTime);\n-    table.validateInsertSchema();\n-    setOperationType(WriteOperationType.BULK_INSERT);\n-    this.asyncCleanerService = AsyncCleanerService.startAsyncCleaningIfEnabled(this, instantTime);\n-    HoodieWriteMetadata result = table.bulkInsert(jsc,instantTime, records, userDefinedBulkInsertPartitioner);\n-    return postWrite(result, instantTime, table);\n-  }\n+  public abstract O bulkInsert(I records, final String instantTime,\n+                      Option<BulkInsertPartitioner<I>> userDefinedBulkInsertPartitioner);\n+\n \n   /**\n    * Loads the given HoodieRecords, as inserts into the table. This is suitable for doing big bulk loads into a Hoodie\n    * table for the very first time (e.g: converting an existing table to Hoodie). The input records should contain no\n    * duplicates if needed.\n    * <p>\n    * This implementation uses sortBy (which does range partitioning based on reservoir sampling) and attempts to control\n-   * the numbers of files with less memory compared to the {@link HoodieWriteClient#insert(JavaRDD, String)}. Optionally\n+   * the numbers of files with less memory compared to the {@link AbstractHoodieWriteClient#insert(I, String)}. Optionally\n    * it allows users to specify their own partitioner. If specified then it will be used for repartitioning records. See\n    * {@link BulkInsertPartitioner}.\n    *\n-   * @param preppedRecords HoodieRecords to insert\n-   * @param instantTime Instant time of the commit\n+   * @param preppedRecords        HoodieRecords to insert", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "28eecab55cb62bb602e6ed7fe1cb9d5b188a87df"}, "originalPosition": 434}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDA4NDg3Mw==", "bodyText": "this method need not have moved?", "url": "https://github.com/apache/hudi/pull/1827#discussion_r484084873", "createdAt": "2020-09-06T15:44:19Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/client/AsyncCleanerService.java", "diffHunk": "@@ -52,19 +52,6 @@ protected AsyncCleanerService(HoodieWriteClient<?> writeClient, String cleanInst\n     }), executor);\n   }\n \n-  public static AsyncCleanerService startAsyncCleaningIfEnabled(HoodieWriteClient writeClient,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2348f73b4a270e4d04d2f67f9d7bd9691391b569"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDA5Njc3Ng==", "bodyText": "are these from reformatting via IDE .", "url": "https://github.com/apache/hudi/pull/1827#discussion_r484096776", "createdAt": "2020-09-06T17:48:51Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/client/bootstrap/selector/BootstrapRegexModeSelector.java", "diffHunk": "@@ -18,17 +18,18 @@\n \n package org.apache.hudi.client.bootstrap.selector;\n \n-import java.util.List;\n-import java.util.Map;\n-import java.util.regex.Pattern;\n-import java.util.stream.Collectors;\n import org.apache.hudi.avro.model.HoodieFileStatus;\n import org.apache.hudi.client.bootstrap.BootstrapMode;\n import org.apache.hudi.common.util.collection.Pair;\n import org.apache.hudi.config.HoodieWriteConfig;\n import org.apache.log4j.LogManager;\n import org.apache.log4j.Logger;\n \n+import java.util.List;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac3339704c703741f9ff50f2d96019cef2d2c72b"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDA5Njk4Nw==", "bodyText": "I am okay leaving it as hadoopConf given that's what we wrap. leave it you both :)", "url": "https://github.com/apache/hudi/pull/1827#discussion_r484096987", "createdAt": "2020-09-06T17:51:01Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/common/HoodieEngineContext.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.common;\n+\n+import org.apache.hudi.client.TaskContextSupplier;\n+import org.apache.hudi.common.config.SerializableConfiguration;\n+\n+/**\n+ * Base class contains the context information needed by the engine at runtime. It will be extended by different\n+ * engine implementation if needed.\n+ */\n+public class HoodieEngineContext {\n+  /**\n+   * A wrapped hadoop configuration which can be serialized.\n+   */\n+  private SerializableConfiguration hadoopConf;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk4MDc1MQ=="}, "originalCommit": {"oid": "88c6661e865945059f782880c395547c16ef1a1c"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDA5NzE2MA==", "bodyText": "In general, not sure if this class is applicable outside of Spark. but we do use it in all of the code paths. So understand that we needed to do this.", "url": "https://github.com/apache/hudi/pull/1827#discussion_r484097160", "createdAt": "2020-09-06T17:52:53Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/execution/BaseLazyInsertIterable.java", "diffHunk": "@@ -18,64 +18,47 @@\n \n package org.apache.hudi.execution;\n \n-import org.apache.hudi.client.SparkTaskContextSupplier;\n+import org.apache.avro.Schema;\n+import org.apache.avro.generic.IndexedRecord;\n+import org.apache.hudi.client.TaskContextSupplier;\n import org.apache.hudi.client.WriteStatus;\n import org.apache.hudi.client.utils.LazyIterableIterator;\n import org.apache.hudi.common.model.HoodieRecord;\n import org.apache.hudi.common.model.HoodieRecordPayload;\n import org.apache.hudi.common.util.Option;\n-import org.apache.hudi.common.util.queue.BoundedInMemoryExecutor;\n import org.apache.hudi.config.HoodieWriteConfig;\n-import org.apache.hudi.exception.HoodieException;\n-import org.apache.hudi.io.CreateHandleFactory;\n import org.apache.hudi.io.WriteHandleFactory;\n import org.apache.hudi.table.HoodieTable;\n \n-import org.apache.avro.Schema;\n-import org.apache.avro.generic.IndexedRecord;\n-\n import java.util.Iterator;\n import java.util.List;\n import java.util.function.Function;\n \n /**\n  * Lazy Iterable, that writes a stream of HoodieRecords sorted by the partitionPath, into new files.\n  */\n-public class LazyInsertIterable<T extends HoodieRecordPayload>\n+public abstract class BaseLazyInsertIterable<T extends HoodieRecordPayload>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac3339704c703741f9ff50f2d96019cef2d2c72b"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDA5NzM0Mw==", "bodyText": "some of these index types don't make sense without Spark Index now. actually almost all of them except may be HBaseIndex.\nSo these should all be renamed with the Spark prefix", "url": "https://github.com/apache/hudi/pull/1827#discussion_r484097343", "createdAt": "2020-09-06T17:55:12Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/index/HoodieIndex.java", "diffHunk": "@@ -21,94 +21,52 @@\n import org.apache.hudi.ApiMaturityLevel;\n import org.apache.hudi.PublicAPIClass;\n import org.apache.hudi.PublicAPIMethod;\n-import org.apache.hudi.client.WriteStatus;\n+import org.apache.hudi.common.HoodieEngineContext;\n import org.apache.hudi.common.model.FileSlice;\n import org.apache.hudi.common.model.HoodieKey;\n-import org.apache.hudi.common.model.HoodieRecord;\n import org.apache.hudi.common.model.HoodieRecordPayload;\n-import org.apache.hudi.common.util.Option;\n-import org.apache.hudi.common.util.ReflectionUtils;\n-import org.apache.hudi.common.util.StringUtils;\n-import org.apache.hudi.common.util.collection.Pair;\n import org.apache.hudi.config.HoodieWriteConfig;\n import org.apache.hudi.exception.HoodieIndexException;\n-import org.apache.hudi.index.bloom.HoodieBloomIndex;\n-import org.apache.hudi.index.bloom.HoodieGlobalBloomIndex;\n-import org.apache.hudi.index.hbase.HBaseIndex;\n-import org.apache.hudi.index.simple.HoodieGlobalSimpleIndex;\n-import org.apache.hudi.index.simple.HoodieSimpleIndex;\n import org.apache.hudi.table.HoodieTable;\n \n-import org.apache.spark.api.java.JavaPairRDD;\n-import org.apache.spark.api.java.JavaRDD;\n-import org.apache.spark.api.java.JavaSparkContext;\n-\n import java.io.Serializable;\n \n /**\n  * Base class for different types of indexes to determine the mapping from uuid.\n  */\n @PublicAPIClass(maturity = ApiMaturityLevel.EVOLVING)\n-public abstract class HoodieIndex<T extends HoodieRecordPayload> implements Serializable {\n+public abstract class HoodieIndex<T extends HoodieRecordPayload, I, K, O, P> implements Serializable {\n \n   protected final HoodieWriteConfig config;\n \n   protected HoodieIndex(HoodieWriteConfig config) {\n     this.config = config;\n   }\n \n-  public static <T extends HoodieRecordPayload> HoodieIndex<T> createIndex(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac3339704c703741f9ff50f2d96019cef2d2c72b"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDA5NzQxNg==", "bodyText": "now I understand P better.", "url": "https://github.com/apache/hudi/pull/1827#discussion_r484097416", "createdAt": "2020-09-06T17:56:00Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/index/HoodieIndex.java", "diffHunk": "@@ -21,94 +21,52 @@\n import org.apache.hudi.ApiMaturityLevel;\n import org.apache.hudi.PublicAPIClass;\n import org.apache.hudi.PublicAPIMethod;\n-import org.apache.hudi.client.WriteStatus;\n+import org.apache.hudi.common.HoodieEngineContext;\n import org.apache.hudi.common.model.FileSlice;\n import org.apache.hudi.common.model.HoodieKey;\n-import org.apache.hudi.common.model.HoodieRecord;\n import org.apache.hudi.common.model.HoodieRecordPayload;\n-import org.apache.hudi.common.util.Option;\n-import org.apache.hudi.common.util.ReflectionUtils;\n-import org.apache.hudi.common.util.StringUtils;\n-import org.apache.hudi.common.util.collection.Pair;\n import org.apache.hudi.config.HoodieWriteConfig;\n import org.apache.hudi.exception.HoodieIndexException;\n-import org.apache.hudi.index.bloom.HoodieBloomIndex;\n-import org.apache.hudi.index.bloom.HoodieGlobalBloomIndex;\n-import org.apache.hudi.index.hbase.HBaseIndex;\n-import org.apache.hudi.index.simple.HoodieGlobalSimpleIndex;\n-import org.apache.hudi.index.simple.HoodieSimpleIndex;\n import org.apache.hudi.table.HoodieTable;\n \n-import org.apache.spark.api.java.JavaPairRDD;\n-import org.apache.spark.api.java.JavaRDD;\n-import org.apache.spark.api.java.JavaSparkContext;\n-\n import java.io.Serializable;\n \n /**\n  * Base class for different types of indexes to determine the mapping from uuid.\n  */\n @PublicAPIClass(maturity = ApiMaturityLevel.EVOLVING)\n-public abstract class HoodieIndex<T extends HoodieRecordPayload> implements Serializable {\n+public abstract class HoodieIndex<T extends HoodieRecordPayload, I, K, O, P> implements Serializable {\n \n   protected final HoodieWriteConfig config;\n \n   protected HoodieIndex(HoodieWriteConfig config) {\n     this.config = config;\n   }\n \n-  public static <T extends HoodieRecordPayload> HoodieIndex<T> createIndex(\n-      HoodieWriteConfig config) throws HoodieIndexException {\n-    // first use index class config to create index.\n-    if (!StringUtils.isNullOrEmpty(config.getIndexClass())) {\n-      Object instance = ReflectionUtils.loadClass(config.getIndexClass(), config);\n-      if (!(instance instanceof HoodieIndex)) {\n-        throw new HoodieIndexException(config.getIndexClass() + \" is not a subclass of HoodieIndex\");\n-      }\n-      return (HoodieIndex) instance;\n-    }\n-    switch (config.getIndexType()) {\n-      case HBASE:\n-        return new HBaseIndex<>(config);\n-      case INMEMORY:\n-        return new InMemoryHashIndex<>(config);\n-      case BLOOM:\n-        return new HoodieBloomIndex<>(config);\n-      case GLOBAL_BLOOM:\n-        return new HoodieGlobalBloomIndex<>(config);\n-      case SIMPLE:\n-        return new HoodieSimpleIndex<>(config);\n-      case GLOBAL_SIMPLE:\n-        return new HoodieGlobalSimpleIndex<>(config);\n-      default:\n-        throw new HoodieIndexException(\"Index type unspecified, set \" + config.getIndexType());\n-    }\n-  }\n-\n   /**\n    * Checks if the given [Keys] exists in the hoodie table and returns [Key, Option[partitionPath, fileID]] If the\n    * optional is empty, then the key is not found.\n    */\n   @PublicAPIMethod(maturity = ApiMaturityLevel.STABLE)\n-  public abstract JavaPairRDD<HoodieKey, Option<Pair<String, String>>> fetchRecordLocation(\n-      JavaRDD<HoodieKey> hoodieKeys, final JavaSparkContext jsc, HoodieTable<T> hoodieTable);\n+  public abstract P fetchRecordLocation(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac3339704c703741f9ff50f2d96019cef2d2c72b"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDA5NzYxMw==", "bodyText": "these annotations needs to moved over to a SparkHoodieIndex class? it will be hard for end developers to program against HoodieIndex directly anymore. This is a general point actually. The current public APIs should all be annotated against the Spark child classes.  wdyt?", "url": "https://github.com/apache/hudi/pull/1827#discussion_r484097613", "createdAt": "2020-09-06T17:58:04Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/index/HoodieIndex.java", "diffHunk": "@@ -21,94 +21,52 @@\n import org.apache.hudi.ApiMaturityLevel;\n import org.apache.hudi.PublicAPIClass;\n import org.apache.hudi.PublicAPIMethod;\n-import org.apache.hudi.client.WriteStatus;\n+import org.apache.hudi.common.HoodieEngineContext;\n import org.apache.hudi.common.model.FileSlice;\n import org.apache.hudi.common.model.HoodieKey;\n-import org.apache.hudi.common.model.HoodieRecord;\n import org.apache.hudi.common.model.HoodieRecordPayload;\n-import org.apache.hudi.common.util.Option;\n-import org.apache.hudi.common.util.ReflectionUtils;\n-import org.apache.hudi.common.util.StringUtils;\n-import org.apache.hudi.common.util.collection.Pair;\n import org.apache.hudi.config.HoodieWriteConfig;\n import org.apache.hudi.exception.HoodieIndexException;\n-import org.apache.hudi.index.bloom.HoodieBloomIndex;\n-import org.apache.hudi.index.bloom.HoodieGlobalBloomIndex;\n-import org.apache.hudi.index.hbase.HBaseIndex;\n-import org.apache.hudi.index.simple.HoodieGlobalSimpleIndex;\n-import org.apache.hudi.index.simple.HoodieSimpleIndex;\n import org.apache.hudi.table.HoodieTable;\n \n-import org.apache.spark.api.java.JavaPairRDD;\n-import org.apache.spark.api.java.JavaRDD;\n-import org.apache.spark.api.java.JavaSparkContext;\n-\n import java.io.Serializable;\n \n /**\n  * Base class for different types of indexes to determine the mapping from uuid.\n  */\n @PublicAPIClass(maturity = ApiMaturityLevel.EVOLVING)\n-public abstract class HoodieIndex<T extends HoodieRecordPayload> implements Serializable {\n+public abstract class HoodieIndex<T extends HoodieRecordPayload, I, K, O, P> implements Serializable {\n \n   protected final HoodieWriteConfig config;\n \n   protected HoodieIndex(HoodieWriteConfig config) {\n     this.config = config;\n   }\n \n-  public static <T extends HoodieRecordPayload> HoodieIndex<T> createIndex(\n-      HoodieWriteConfig config) throws HoodieIndexException {\n-    // first use index class config to create index.\n-    if (!StringUtils.isNullOrEmpty(config.getIndexClass())) {\n-      Object instance = ReflectionUtils.loadClass(config.getIndexClass(), config);\n-      if (!(instance instanceof HoodieIndex)) {\n-        throw new HoodieIndexException(config.getIndexClass() + \" is not a subclass of HoodieIndex\");\n-      }\n-      return (HoodieIndex) instance;\n-    }\n-    switch (config.getIndexType()) {\n-      case HBASE:\n-        return new HBaseIndex<>(config);\n-      case INMEMORY:\n-        return new InMemoryHashIndex<>(config);\n-      case BLOOM:\n-        return new HoodieBloomIndex<>(config);\n-      case GLOBAL_BLOOM:\n-        return new HoodieGlobalBloomIndex<>(config);\n-      case SIMPLE:\n-        return new HoodieSimpleIndex<>(config);\n-      case GLOBAL_SIMPLE:\n-        return new HoodieGlobalSimpleIndex<>(config);\n-      default:\n-        throw new HoodieIndexException(\"Index type unspecified, set \" + config.getIndexType());\n-    }\n-  }\n-\n   /**\n    * Checks if the given [Keys] exists in the hoodie table and returns [Key, Option[partitionPath, fileID]] If the\n    * optional is empty, then the key is not found.\n    */\n   @PublicAPIMethod(maturity = ApiMaturityLevel.STABLE)\n-  public abstract JavaPairRDD<HoodieKey, Option<Pair<String, String>>> fetchRecordLocation(\n-      JavaRDD<HoodieKey> hoodieKeys, final JavaSparkContext jsc, HoodieTable<T> hoodieTable);\n+  public abstract P fetchRecordLocation(\n+      K hoodieKeys, final HoodieEngineContext context, HoodieTable<T, I, K, O, P> hoodieTable);\n \n   /**\n    * Looks up the index and tags each incoming record with a location of a file that contains the row (if it is actually\n    * present).\n    */\n   @PublicAPIMethod(maturity = ApiMaturityLevel.STABLE)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac3339704c703741f9ff50f2d96019cef2d2c72b"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDA5NzY1NA==", "bodyText": "I suggest introducing a SparkHoodieIndex base class", "url": "https://github.com/apache/hudi/pull/1827#discussion_r484097654", "createdAt": "2020-09-06T17:58:34Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/index/bloom/BaseHoodieBloomIndex.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.index.bloom;\n+\n+import org.apache.hudi.common.HoodieEngineContext;\n+import org.apache.hudi.common.model.HoodieRecordPayload;\n+import org.apache.hudi.config.HoodieWriteConfig;\n+import org.apache.hudi.exception.HoodieIndexException;\n+import org.apache.hudi.index.HoodieIndex;\n+import org.apache.hudi.table.HoodieTable;\n+\n+/**\n+ * Indexing mechanism based on bloom filter. Each parquet file includes its row_key bloom filter in its metadata.\n+ */\n+public abstract class BaseHoodieBloomIndex<T extends HoodieRecordPayload, I, K, O, P> extends HoodieIndex<T, I, K, O, P> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac3339704c703741f9ff50f2d96019cef2d2c72b"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDA5Nzk1MA==", "bodyText": "are there any code changes here, i.e logic changes?", "url": "https://github.com/apache/hudi/pull/1827#discussion_r484097950", "createdAt": "2020-09-06T18:01:32Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/index/hbase/BaseHoodieHBaseIndex.java", "diffHunk": "@@ -0,0 +1,295 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.index.hbase;\n+\n+import org.apache.hudi.common.HoodieEngineContext;\n+import org.apache.hudi.common.model.HoodieRecordPayload;\n+import org.apache.hudi.common.table.HoodieTableMetaClient;\n+import org.apache.hudi.common.table.timeline.HoodieTimeline;\n+import org.apache.hudi.common.util.ReflectionUtils;\n+import org.apache.hudi.config.HoodieHBaseIndexConfig;\n+import org.apache.hudi.config.HoodieWriteConfig;\n+import org.apache.hudi.exception.HoodieDependentSystemUnavailableException;\n+import org.apache.hudi.index.HoodieIndex;\n+import org.apache.hudi.table.HoodieTable;\n+\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.hbase.HBaseConfiguration;\n+import org.apache.hadoop.hbase.HRegionLocation;\n+import org.apache.hadoop.hbase.TableName;\n+import org.apache.hadoop.hbase.client.BufferedMutator;\n+import org.apache.hadoop.hbase.client.Connection;\n+import org.apache.hadoop.hbase.client.ConnectionFactory;\n+import org.apache.hadoop.hbase.client.Get;\n+import org.apache.hadoop.hbase.client.HTable;\n+import org.apache.hadoop.hbase.client.Mutation;\n+import org.apache.hadoop.hbase.client.RegionLocator;\n+import org.apache.hadoop.hbase.client.Result;\n+import org.apache.hadoop.hbase.util.Bytes;\n+import org.apache.log4j.LogManager;\n+import org.apache.log4j.Logger;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.List;\n+\n+/**\n+ * Hoodie Index implementation backed by HBase.\n+ */\n+public abstract class BaseHoodieHBaseIndex<T extends HoodieRecordPayload, I, K, O, P> extends HoodieIndex<T, I, K, O, P> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac3339704c703741f9ff50f2d96019cef2d2c72b"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDA5ODM1MA==", "bodyText": "we should make sure there are no backwards incompatible changes to the key generator interface", "url": "https://github.com/apache/hudi/pull/1827#discussion_r484098350", "createdAt": "2020-09-06T18:05:46Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/keygen/KeyGeneratorInterface.java", "diffHunk": "@@ -34,8 +33,4 @@\n \n   List<String> getRecordKeyFieldNames();\n \n-  String getRecordKey(Row row);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac3339704c703741f9ff50f2d96019cef2d2c72b"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDA5ODg5Mw==", "bodyText": "why is this no longer a mergeHandle?", "url": "https://github.com/apache/hudi/pull/1827#discussion_r484098893", "createdAt": "2020-09-06T18:12:15Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/table/action/commit/BaseMergeHelper.java", "diffHunk": "@@ -161,11 +108,11 @@ private static GenericRecord transformRecordBasedOnNewSchema(GenericDatumReader<\n   /**\n    * Consumer that dequeues records from queue and sends to Merge Handle.\n    */\n-  private static class UpdateHandler extends BoundedInMemoryQueueConsumer<GenericRecord, Void> {\n+  static class UpdateHandler extends BoundedInMemoryQueueConsumer<GenericRecord, Void> {\n \n-    private final HoodieMergeHandle upsertHandle;\n+    private final HoodieWriteHandle upsertHandle;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac3339704c703741f9ff50f2d96019cef2d2c72b"}, "originalPosition": 132}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ac3339704c703741f9ff50f2d96019cef2d2c72b", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/ac3339704c703741f9ff50f2d96019cef2d2c72b", "committedDate": "2020-09-06T16:35:49Z", "message": "rebase master"}, "afterCommit": {"oid": "57869f2f1ad83183779c98536ea3862eb30d0cc3", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/57869f2f1ad83183779c98536ea3862eb30d0cc3", "committedDate": "2020-09-07T05:36:24Z", "message": "rebase master"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "57869f2f1ad83183779c98536ea3862eb30d0cc3", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/57869f2f1ad83183779c98536ea3862eb30d0cc3", "committedDate": "2020-09-07T05:36:24Z", "message": "rebase master"}, "afterCommit": {"oid": "a9ddf89e5c79996b2a4720bb467b7dc696e4f3d8", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/a9ddf89e5c79996b2a4720bb467b7dc696e4f3d8", "committedDate": "2020-09-07T05:47:04Z", "message": "rebase master"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a9ddf89e5c79996b2a4720bb467b7dc696e4f3d8", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/a9ddf89e5c79996b2a4720bb467b7dc696e4f3d8", "committedDate": "2020-09-07T05:47:04Z", "message": "rebase master"}, "afterCommit": {"oid": "ac3339704c703741f9ff50f2d96019cef2d2c72b", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/ac3339704c703741f9ff50f2d96019cef2d2c72b", "committedDate": "2020-09-06T16:35:49Z", "message": "rebase master"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ac3339704c703741f9ff50f2d96019cef2d2c72b", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/ac3339704c703741f9ff50f2d96019cef2d2c72b", "committedDate": "2020-09-06T16:35:49Z", "message": "rebase master"}, "afterCommit": {"oid": "e24c968a27d9cdbb746e68ff09b86c25da758c82", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/e24c968a27d9cdbb746e68ff09b86c25da758c82", "committedDate": "2020-09-07T14:04:45Z", "message": "resolve conflicts"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0e364e10349837e361c88b89704b267c79b271d4", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/0e364e10349837e361c88b89704b267c79b271d4", "committedDate": "2020-09-07T14:19:51Z", "message": "tmp"}, "afterCommit": {"oid": "7aedc0bdc1565d47b044487aab04b659167bd086", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/7aedc0bdc1565d47b044487aab04b659167bd086", "committedDate": "2020-09-07T14:23:15Z", "message": "resolve conflicts"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzMTg3OTM4", "url": "https://github.com/apache/hudi/pull/1827#pullrequestreview-483187938", "createdAt": "2020-09-07T00:30:06Z", "commit": {"oid": "ac3339704c703741f9ff50f2d96019cef2d2c72b"}, "state": "COMMENTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwMDozMDowNlrOHNtPxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QxODoxNTowNlrOHOF5vw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDEzNDg1Mg==", "bodyText": "These sort of classes, we should have a way to implement with just a reference to engineContext ideally. Even though we cannot implement every method in sparkContext. This is a topic for later", "url": "https://github.com/apache/hudi/pull/1827#discussion_r484134852", "createdAt": "2020-09-07T00:30:06Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/table/action/rollback/BaseMarkerBasedRollbackStrategy.java", "diffHunk": "@@ -18,63 +18,58 @@\n \n package org.apache.hudi.table.action.rollback;\n \n+import org.apache.hadoop.fs.Path;\n+import org.apache.hudi.common.HoodieEngineContext;\n import org.apache.hudi.common.HoodieRollbackStat;\n import org.apache.hudi.common.fs.FSUtils;\n import org.apache.hudi.common.model.HoodieLogFile;\n-import org.apache.hudi.common.model.IOType;\n+import org.apache.hudi.common.model.HoodieRecordPayload;\n import org.apache.hudi.common.table.log.HoodieLogFormat;\n import org.apache.hudi.common.table.log.block.HoodieCommandBlock;\n import org.apache.hudi.common.table.log.block.HoodieLogBlock;\n import org.apache.hudi.common.table.timeline.HoodieInstant;\n import org.apache.hudi.config.HoodieWriteConfig;\n import org.apache.hudi.exception.HoodieIOException;\n-import org.apache.hudi.exception.HoodieRollbackException;\n import org.apache.hudi.table.HoodieTable;\n-import org.apache.hudi.table.MarkerFiles;\n \n-import org.apache.hadoop.fs.Path;\n import org.apache.log4j.LogManager;\n import org.apache.log4j.Logger;\n-import org.apache.spark.api.java.JavaSparkContext;\n \n import java.io.IOException;\n import java.util.Collections;\n-import java.util.List;\n import java.util.Map;\n \n-import scala.Tuple2;\n-\n /**\n  * Performs rollback using marker files generated during the write..\n  */\n-public class MarkerBasedRollbackStrategy implements BaseRollbackActionExecutor.RollbackStrategy {\n+public abstract class BaseMarkerBasedRollbackStrategy<T extends HoodieRecordPayload, I, K, O, P> implements BaseRollbackActionExecutor.RollbackStrategy {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac3339704c703741f9ff50f2d96019cef2d2c72b"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDEzNTEzNw==", "bodyText": "would a parallelDo(func, parallelism) method in HoodieEngineContext help us avoid a lot of base/child class duplication of logic like this?\nMost of clean, compact, rollback, restore etc can be implemented this way. Most of them just take a list, parallelize it, and execute some function, collect results and get the objects back", "url": "https://github.com/apache/hudi/pull/1827#discussion_r484135137", "createdAt": "2020-09-07T00:32:18Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/table/action/rollback/BaseMarkerBasedRollbackStrategy.java", "diffHunk": "@@ -132,32 +127,4 @@ private HoodieRollbackStat undoAppend(String appendBaseFilePath, HoodieInstant i\n         .build();\n   }\n \n-  @Override\n-  public List<HoodieRollbackStat> execute(HoodieInstant instantToRollback) {\n-    try {\n-      MarkerFiles markerFiles = new MarkerFiles(table, instantToRollback.getTimestamp());\n-      List<String> markerFilePaths = markerFiles.allMarkerFilePaths();\n-      int parallelism = Math.max(Math.min(markerFilePaths.size(), config.getRollbackParallelism()), 1);\n-      return jsc.parallelize(markerFilePaths, parallelism)\n-          .map(markerFilePath -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac3339704c703741f9ff50f2d96019cef2d2c72b"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUxNjMzOQ==", "bodyText": "the MOR equivalent method got moved I guess", "url": "https://github.com/apache/hudi/pull/1827#discussion_r484516339", "createdAt": "2020-09-07T16:33:44Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/table/action/rollback/RollbackUtils.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.table.action.rollback;\n+\n+import org.apache.hadoop.fs.FileStatus;\n+import org.apache.hadoop.fs.FileSystem;\n+import org.apache.log4j.LogManager;\n+import org.apache.log4j.Logger;\n+\n+import org.apache.hudi.common.HoodieRollbackStat;\n+import org.apache.hudi.common.fs.FSUtils;\n+import org.apache.hudi.common.model.FileSlice;\n+import org.apache.hudi.common.model.HoodieCommitMetadata;\n+import org.apache.hudi.common.model.HoodieWriteStat;\n+import org.apache.hudi.common.table.log.block.HoodieCommandBlock;\n+import org.apache.hudi.common.table.log.block.HoodieLogBlock;\n+import org.apache.hudi.common.table.timeline.HoodieInstant;\n+import org.apache.hudi.common.table.timeline.HoodieTimeline;\n+import org.apache.hudi.common.util.Option;\n+import org.apache.hudi.common.util.ValidationUtils;\n+import org.apache.hudi.exception.HoodieIOException;\n+import org.apache.hudi.table.HoodieTable;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+public class RollbackUtils {\n+\n+  private static final Logger LOG = LogManager.getLogger(RollbackUtils.class);\n+\n+  static Map<HoodieLogBlock.HeaderMetadataType, String> generateHeader(String instantToRollback, String rollbackInstantTime) {\n+    // generate metadata\n+    Map<HoodieLogBlock.HeaderMetadataType, String> header = new HashMap<>(3);\n+    header.put(HoodieLogBlock.HeaderMetadataType.INSTANT_TIME, rollbackInstantTime);\n+    header.put(HoodieLogBlock.HeaderMetadataType.TARGET_INSTANT_TIME, instantToRollback);\n+    header.put(HoodieLogBlock.HeaderMetadataType.COMMAND_BLOCK_TYPE,\n+        String.valueOf(HoodieCommandBlock.HoodieCommandBlockTypeEnum.ROLLBACK_PREVIOUS_BLOCK.ordinal()));\n+    return header;\n+  }\n+\n+  /**\n+   * Helper to merge 2 rollback-stats for a given partition.\n+   *\n+   * @param stat1 HoodieRollbackStat\n+   * @param stat2 HoodieRollbackStat\n+   * @return Merged HoodieRollbackStat\n+   */\n+  static HoodieRollbackStat mergeRollbackStat(HoodieRollbackStat stat1, HoodieRollbackStat stat2) {\n+    ValidationUtils.checkArgument(stat1.getPartitionPath().equals(stat2.getPartitionPath()));\n+    final List<String> successDeleteFiles = new ArrayList<>();\n+    final List<String> failedDeleteFiles = new ArrayList<>();\n+    final Map<FileStatus, Long> commandBlocksCount = new HashMap<>();\n+    final List<FileStatus> filesToRollback = new ArrayList<>();\n+    Option.ofNullable(stat1.getSuccessDeleteFiles()).ifPresent(successDeleteFiles::addAll);\n+    Option.ofNullable(stat2.getSuccessDeleteFiles()).ifPresent(successDeleteFiles::addAll);\n+    Option.ofNullable(stat1.getFailedDeleteFiles()).ifPresent(failedDeleteFiles::addAll);\n+    Option.ofNullable(stat2.getFailedDeleteFiles()).ifPresent(failedDeleteFiles::addAll);\n+    Option.ofNullable(stat1.getCommandBlocksCount()).ifPresent(commandBlocksCount::putAll);\n+    Option.ofNullable(stat2.getCommandBlocksCount()).ifPresent(commandBlocksCount::putAll);\n+    return new HoodieRollbackStat(stat1.getPartitionPath(), successDeleteFiles, failedDeleteFiles, commandBlocksCount);\n+  }\n+\n+  /**\n+   * Generate all rollback requests that needs rolling back this action without actually performing rollback for COW table type.\n+   * @param fs instance of {@link FileSystem} to use.\n+   * @param basePath base path of interest.\n+   * @param shouldAssumeDatePartitioning {@code true} if date partitioning should be assumed. {@code false} otherwise.\n+   * @return {@link List} of {@link ListingBasedRollbackRequest}s thus collected.\n+   */\n+  public static List<ListingBasedRollbackRequest> generateRollbackRequestsByListingCOW(FileSystem fs, String basePath, boolean shouldAssumeDatePartitioning) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7aedc0bdc1565d47b044487aab04b659167bd086"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUxNjk5Ng==", "bodyText": "might make sense to move the COMPACT_POOL_NAME also to the child class", "url": "https://github.com/apache/hudi/pull/1827#discussion_r484516996", "createdAt": "2020-09-07T16:35:59Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-spark-client/src/main/java/org/apache/hudi/async/HoodieSparkAsyncCompactService.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.async;\n+\n+import org.apache.hudi.asyc.BaseAsyncCompactService;\n+import org.apache.hudi.client.AbstractHoodieWriteClient;\n+import org.apache.hudi.client.BaseCompactor;\n+import org.apache.hudi.client.HoodieSparkCompactor;\n+import org.apache.hudi.common.HoodieEngineContext;\n+import org.apache.hudi.common.HoodieSparkEngineContext;\n+import org.apache.hudi.common.table.timeline.HoodieInstant;\n+import org.apache.hudi.common.util.collection.Pair;\n+import org.apache.hudi.exception.HoodieIOException;\n+import org.apache.log4j.LogManager;\n+import org.apache.log4j.Logger;\n+import org.apache.spark.api.java.JavaSparkContext;\n+\n+import java.io.IOException;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.stream.IntStream;\n+\n+public class HoodieSparkAsyncCompactService extends BaseAsyncCompactService {\n+\n+  private static final Logger LOG = LogManager.getLogger(HoodieSparkAsyncCompactService.class);\n+\n+  private transient JavaSparkContext jssc;\n+  public HoodieSparkAsyncCompactService(HoodieEngineContext context, AbstractHoodieWriteClient client) {\n+    super(context, client);\n+    this.jssc = HoodieSparkEngineContext.getSparkContext(context);\n+  }\n+\n+  public HoodieSparkAsyncCompactService(HoodieEngineContext context, AbstractHoodieWriteClient client, boolean runInDaemonMode) {\n+    super(context, client, runInDaemonMode);\n+    this.jssc = HoodieSparkEngineContext.getSparkContext(context);\n+  }\n+\n+  @Override\n+  protected BaseCompactor createCompactor(AbstractHoodieWriteClient client) {\n+    return new HoodieSparkCompactor(client);\n+  }\n+\n+  @Override\n+  protected Pair<CompletableFuture, ExecutorService> startService() {\n+    ExecutorService executor = Executors.newFixedThreadPool(maxConcurrentCompaction,\n+        r -> {\n+          Thread t = new Thread(r, \"async_compact_thread\");\n+          t.setDaemon(isRunInDaemonMode());\n+          return t;\n+        });\n+    return Pair.of(CompletableFuture.allOf(IntStream.range(0, maxConcurrentCompaction).mapToObj(i -> CompletableFuture.supplyAsync(() -> {\n+      try {\n+        // Set Compactor Pool Name for allowing users to prioritize compaction\n+        LOG.info(\"Setting Spark Pool name for compaction to \" + COMPACT_POOL_NAME);\n+        jssc.setLocalProperty(\"spark.scheduler.pool\", COMPACT_POOL_NAME);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7aedc0bdc1565d47b044487aab04b659167bd086"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUxOTE5MA==", "bodyText": "why is this necessary for this PR?", "url": "https://github.com/apache/hudi/pull/1827#discussion_r484519190", "createdAt": "2020-09-07T16:43:53Z", "author": {"login": "vinothchandar"}, "path": "style/checkstyle.xml", "diffHunk": "@@ -62,7 +62,7 @@\n             <property name=\"allowNonPrintableEscapes\" value=\"true\"/>\n         </module>\n         <module name=\"LineLength\">\n-            <property name=\"max\" value=\"200\"/>\n+            <property name=\"max\" value=\"500\"/>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7aedc0bdc1565d47b044487aab04b659167bd086"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUyMDAxMw==", "bodyText": "wondering if this renaming will have any impact on deserializing older plans. cc @bvaradar to confirm", "url": "https://github.com/apache/hudi/pull/1827#discussion_r484520013", "createdAt": "2020-09-07T16:46:49Z", "author": {"login": "vinothchandar"}, "path": "hudi-utilities/src/main/java/org/apache/hudi/utilities/HoodieCompactionAdminTool.java", "diffHunk": "@@ -60,38 +60,38 @@ public static void main(String[] args) throws Exception {\n    */\n   public void run(JavaSparkContext jsc) throws Exception {\n     HoodieTableMetaClient metaClient = new HoodieTableMetaClient(jsc.hadoopConfiguration(), cfg.basePath);\n-    try (CompactionAdminClient admin = new CompactionAdminClient(jsc, cfg.basePath)) {\n+    try (HoodieSparkCompactionAdminClient admin = new HoodieSparkCompactionAdminClient(new HoodieSparkEngineContext(jsc), cfg.basePath)) {\n       final FileSystem fs = FSUtils.getFs(cfg.basePath, jsc.hadoopConfiguration());\n       if (cfg.outputPath != null && fs.exists(new Path(cfg.outputPath))) {\n         throw new IllegalStateException(\"Output File Path already exists\");\n       }\n       switch (cfg.operation) {\n         case VALIDATE:\n-          List<ValidationOpResult> res =\n+          List<BaseCompactionAdminClient.ValidationOpResult> res =\n               admin.validateCompactionPlan(metaClient, cfg.compactionInstantTime, cfg.parallelism);\n           if (cfg.printOutput) {\n             printOperationResult(\"Result of Validation Operation :\", res);\n           }\n           serializeOperationResult(fs, res);\n           break;\n         case UNSCHEDULE_FILE:\n-          List<RenameOpResult> r = admin.unscheduleCompactionFileId(\n+          List<BaseCompactionAdminClient.RenameOpResult> r = admin.unscheduleCompactionFileId(\n               new HoodieFileGroupId(cfg.partitionPath, cfg.fileId), cfg.skipValidation, cfg.dryRun);\n           if (cfg.printOutput) {\n             System.out.println(r);\n           }\n           serializeOperationResult(fs, r);\n           break;\n         case UNSCHEDULE_PLAN:\n-          List<RenameOpResult> r2 = admin.unscheduleCompactionPlan(cfg.compactionInstantTime, cfg.skipValidation,\n+          List<BaseCompactionAdminClient.RenameOpResult> r2 = admin.unscheduleCompactionPlan(cfg.compactionInstantTime, cfg.skipValidation,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7aedc0bdc1565d47b044487aab04b659167bd086"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUyMDQ5MA==", "bodyText": "nit: no space before , and space after , metaClient", "url": "https://github.com/apache/hudi/pull/1827#discussion_r484520490", "createdAt": "2020-09-07T16:48:41Z", "author": {"login": "vinothchandar"}, "path": "hudi-spark/src/main/scala/org/apache/hudi/IncrementalRelation.scala", "diffHunk": "@@ -64,8 +64,7 @@ class IncrementalRelation(val sqlContext: SQLContext,\n     throw new HoodieException(\"Incremental view not implemented yet, for merge-on-read tables\")\n   }\n   // TODO : Figure out a valid HoodieWriteConfig\n-  private val hoodieTable = HoodieTable.create(metaClient, HoodieWriteConfig.newBuilder().withPath(basePath).build(),\n-    sqlContext.sparkContext.hadoopConfiguration)\n+  private val hoodieTable = HoodieSparkTable.create(HoodieWriteConfig.newBuilder().withPath(basePath).build(), new HoodieSparkEngineContext(new JavaSparkContext(sqlContext.sparkContext)) ,metaClient)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7aedc0bdc1565d47b044487aab04b659167bd086"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUyMDkyOQ==", "bodyText": "rename: generateInputRecords", "url": "https://github.com/apache/hudi/pull/1827#discussion_r484520929", "createdAt": "2020-09-07T16:50:14Z", "author": {"login": "vinothchandar"}, "path": "hudi-spark/src/main/java/org/apache/hudi/bootstrap/SparkParquetBootstrapDataProvider.java", "diffHunk": "@@ -43,18 +43,18 @@\n /**\n  * Spark Data frame based bootstrap input provider.\n  */\n-public class SparkParquetBootstrapDataProvider extends FullRecordBootstrapDataProvider {\n+public class SparkParquetBootstrapDataProvider extends FullRecordBootstrapDataProvider<JavaRDD<HoodieRecord>> {\n \n   private final transient SparkSession sparkSession;\n \n   public SparkParquetBootstrapDataProvider(TypedProperties props,\n-                                           JavaSparkContext jsc) {\n-    super(props, jsc);\n-    this.sparkSession = SparkSession.builder().config(jsc.getConf()).getOrCreate();\n+                                           HoodieSparkEngineContext context) {\n+    super(props, context);\n+    this.sparkSession = SparkSession.builder().config(context.getJavaSparkContext().getConf()).getOrCreate();\n   }\n \n   @Override\n-  public JavaRDD<HoodieRecord> generateInputRecordRDD(String tableName, String sourceBasePath,\n+  public JavaRDD<HoodieRecord> generateInputRecord(String tableName, String sourceBasePath,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7aedc0bdc1565d47b044487aab04b659167bd086"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUzODE0MA==", "bodyText": "let's discuss this in a separate PR? 500 is a really large threshold", "url": "https://github.com/apache/hudi/pull/1827#discussion_r484538140", "createdAt": "2020-09-07T18:11:09Z", "author": {"login": "vinothchandar"}, "path": "style/checkstyle.xml", "diffHunk": "@@ -62,7 +62,7 @@\n             <property name=\"allowNonPrintableEscapes\" value=\"true\"/>\n         </module>\n         <module name=\"LineLength\">\n-            <property name=\"max\" value=\"200\"/>\n+            <property name=\"max\" value=\"500\"/>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUxOTE5MA=="}, "originalCommit": {"oid": "7aedc0bdc1565d47b044487aab04b659167bd086"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUzODUwMQ==", "bodyText": "should we limit scala to just the spark module?", "url": "https://github.com/apache/hudi/pull/1827#discussion_r484538501", "createdAt": "2020-09-07T18:13:16Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/pom.xml", "diffHunk": "@@ -68,6 +107,12 @@\n   </build>\n \n   <dependencies>\n+    <!-- Scala -->\n+    <dependency>\n+      <groupId>org.scala-lang</groupId>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7aedc0bdc1565d47b044487aab04b659167bd086"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUzODgxNQ==", "bodyText": "why was this change required?", "url": "https://github.com/apache/hudi/pull/1827#discussion_r484538815", "createdAt": "2020-09-07T18:15:06Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-spark-client/src/test/java/org/apache/hudi/testutils/HoodieClientTestUtils.java", "diffHunk": "@@ -81,7 +82,9 @@\n    */\n   public static SparkConf getSparkConfForTest(String appName) {\n     SparkConf sparkConf = new SparkConf().setAppName(appName)\n-        .set(\"spark.serializer\", \"org.apache.spark.serializer.KryoSerializer\").setMaster(\"local[8]\");\n+        .set(\"spark.serializer\", \"org.apache.spark.serializer.KryoSerializer\")\n+        .set(\"spark.driver.host\",\"localhost\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7aedc0bdc1565d47b044487aab04b659167bd086"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzNzM4NDk0", "url": "https://github.com/apache/hudi/pull/1827#pullrequestreview-483738494", "createdAt": "2020-09-08T01:01:41Z", "commit": {"oid": "7aedc0bdc1565d47b044487aab04b659167bd086"}, "state": "COMMENTED", "comments": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwMTowMTo0MVrOHOJjHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwMTozNzozMFrOHOJ-TQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDU5ODU1OQ==", "bodyText": "need to ensure the ordering of closing resources is the same as before/", "url": "https://github.com/apache/hudi/pull/1827#discussion_r484598559", "createdAt": "2020-09-08T01:01:41Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/client/AbstractHoodieWriteClient.java", "diffHunk": "@@ -716,32 +674,97 @@ private void rollbackPendingCommits() {\n    * @param compactionInstantTime Compaction Instant Time\n    * @return RDD of Write Status\n    */\n-  private JavaRDD<WriteStatus> compact(String compactionInstantTime, boolean shouldComplete) {\n-    HoodieTable<T> table = HoodieTable.create(config, hadoopConf);\n-    HoodieTimeline pendingCompactionTimeline = table.getActiveTimeline().filterPendingCompactionTimeline();\n-    HoodieInstant inflightInstant = HoodieTimeline.getCompactionInflightInstant(compactionInstantTime);\n-    if (pendingCompactionTimeline.containsInstant(inflightInstant)) {\n-      rollbackInflightCompaction(inflightInstant, table);\n-      table.getMetaClient().reloadActiveTimeline();\n-    }\n-    compactionTimer = metrics.getCompactionCtx();\n-    HoodieWriteMetadata compactionMetadata = table.compact(jsc, compactionInstantTime);\n-    JavaRDD<WriteStatus> statuses = compactionMetadata.getWriteStatuses();\n-    if (shouldComplete && compactionMetadata.getCommitMetadata().isPresent()) {\n-      completeCompaction(compactionMetadata.getCommitMetadata().get(), statuses, table, compactionInstantTime);\n-    }\n-    return statuses;\n-  }\n+  protected abstract O compact(String compactionInstantTime, boolean shouldComplete);\n \n   /**\n    * Performs a compaction operation on a table, serially before or after an insert/upsert action.\n    */\n-  private Option<String> inlineCompact(Option<Map<String, String>> extraMetadata) {\n+  protected Option<String> inlineCompact(Option<Map<String, String>> extraMetadata) {\n     Option<String> compactionInstantTimeOpt = scheduleCompaction(extraMetadata);\n     compactionInstantTimeOpt.ifPresent(compactionInstantTime -> {\n       // inline compaction should auto commit as the user is never given control\n       compact(compactionInstantTime, true);\n     });\n     return compactionInstantTimeOpt;\n   }\n+\n+  /**\n+   * Finalize Write operation.\n+   *\n+   * @param table       HoodieTable\n+   * @param instantTime Instant Time\n+   * @param stats       Hoodie Write Stat\n+   */\n+  protected void finalizeWrite(HoodieTable<T, I, K, O, P> table, String instantTime, List<HoodieWriteStat> stats) {\n+    try {\n+      final Timer.Context finalizeCtx = metrics.getFinalizeCtx();\n+      table.finalizeWrite(context, instantTime, stats);\n+      if (finalizeCtx != null) {\n+        Option<Long> durationInMs = Option.of(metrics.getDurationInMs(finalizeCtx.stop()));\n+        durationInMs.ifPresent(duration -> {\n+          LOG.info(\"Finalize write elapsed time (milliseconds): \" + duration);\n+          metrics.updateFinalizeWriteMetrics(duration, stats.size());\n+        });\n+      }\n+    } catch (HoodieIOException ioe) {\n+      throw new HoodieCommitException(\"Failed to complete commit \" + instantTime + \" due to finalize errors.\", ioe);\n+    }\n+  }\n+\n+  public HoodieMetrics getMetrics() {\n+    return metrics;\n+  }\n+\n+  public HoodieIndex<T, I, K, O, P> getIndex() {\n+    return index;\n+  }\n+\n+  /**\n+   * Get HoodieTable and init {@link Timer.Context}.\n+   *\n+   * @param operationType write operation type\n+   * @param instantTime   current inflight instant time\n+   * @return HoodieTable\n+   */\n+  protected abstract HoodieTable<T, I, K, O, P> getTableAndInitCtx(WriteOperationType operationType, String instantTime);\n+\n+  /**\n+   * Sets write schema from last instant since deletes may not have schema set in the config.\n+   */\n+  protected void setWriteSchemaForDeletes(HoodieTableMetaClient metaClient) {\n+    try {\n+      HoodieActiveTimeline activeTimeline = metaClient.getActiveTimeline();\n+      Option<HoodieInstant> lastInstant =\n+          activeTimeline.filterCompletedInstants().filter(s -> s.getAction().equals(metaClient.getCommitActionType()))\n+              .lastInstant();\n+      if (lastInstant.isPresent()) {\n+        HoodieCommitMetadata commitMetadata = HoodieCommitMetadata.fromBytes(\n+            activeTimeline.getInstantDetails(lastInstant.get()).get(), HoodieCommitMetadata.class);\n+        if (commitMetadata.getExtraMetadata().containsKey(HoodieCommitMetadata.SCHEMA_KEY)) {\n+          config.setSchema(commitMetadata.getExtraMetadata().get(HoodieCommitMetadata.SCHEMA_KEY));\n+        } else {\n+          throw new HoodieIOException(\"Latest commit does not have any schema in commit metadata\");\n+        }\n+      } else {\n+        throw new HoodieIOException(\"Deletes issued without any prior commits\");\n+      }\n+    } catch (IOException e) {\n+      throw new HoodieIOException(\"IOException thrown while reading last commit metadata\", e);\n+    }\n+  }\n+\n+  public abstract AsyncCleanerService startAsyncCleaningIfEnabled(AbstractHoodieWriteClient<T, I, K, O, P> client, String instantTime);\n+\n+  @Override\n+  public void close() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7aedc0bdc1565d47b044487aab04b659167bd086"}, "originalPosition": 909}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDU5OTI3NQ==", "bodyText": "Let's name this SparkRDDWriteClient ?", "url": "https://github.com/apache/hudi/pull/1827#discussion_r484599275", "createdAt": "2020-09-08T01:05:55Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-spark-client/src/main/java/org/apache/hudi/client/HoodieSparkWriteClient.java", "diffHunk": "@@ -0,0 +1,360 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.client;\n+\n+import com.codahale.metrics.Timer;\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hudi.client.embebbed.BaseEmbeddedTimelineService;\n+import org.apache.hudi.client.embedded.SparkEmbeddedTimelineService;\n+import org.apache.hudi.common.HoodieEngineContext;\n+import org.apache.hudi.common.HoodieSparkEngineContext;\n+import org.apache.hudi.common.model.HoodieCommitMetadata;\n+import org.apache.hudi.common.model.HoodieKey;\n+import org.apache.hudi.common.model.HoodieRecord;\n+import org.apache.hudi.common.model.HoodieRecordPayload;\n+import org.apache.hudi.common.model.HoodieWriteStat;\n+import org.apache.hudi.common.model.WriteOperationType;\n+import org.apache.hudi.common.table.HoodieTableMetaClient;\n+import org.apache.hudi.common.table.HoodieTableVersion;\n+import org.apache.hudi.common.table.timeline.HoodieActiveTimeline;\n+import org.apache.hudi.common.table.timeline.HoodieInstant;\n+import org.apache.hudi.common.table.timeline.HoodieTimeline;\n+import org.apache.hudi.common.util.Option;\n+import org.apache.hudi.common.util.collection.Pair;\n+import org.apache.hudi.config.HoodieCompactionConfig;\n+import org.apache.hudi.config.HoodieWriteConfig;\n+import org.apache.hudi.exception.HoodieCommitException;\n+import org.apache.hudi.exception.HoodieIOException;\n+import org.apache.hudi.index.HoodieIndex;\n+import org.apache.hudi.index.HoodieSparkIndexFactory;\n+import org.apache.hudi.table.BaseHoodieTimelineArchiveLog;\n+import org.apache.hudi.table.BulkInsertPartitioner;\n+import org.apache.hudi.table.HoodieSparkTable;\n+import org.apache.hudi.table.HoodieSparkTimelineArchiveLog;\n+import org.apache.hudi.table.HoodieTable;\n+import org.apache.hudi.table.SparkMarkerFiles;\n+import org.apache.hudi.table.action.HoodieWriteMetadata;\n+import org.apache.hudi.table.action.compact.SparkCompactHelpers;\n+import org.apache.hudi.table.upgrade.SparkUpgradeDowngrade;\n+import org.apache.log4j.LogManager;\n+import org.apache.log4j.Logger;\n+import org.apache.spark.SparkConf;\n+import org.apache.spark.api.java.JavaPairRDD;\n+import org.apache.spark.api.java.JavaRDD;\n+\n+import java.io.IOException;\n+import java.text.ParseException;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class HoodieSparkWriteClient<T extends HoodieRecordPayload> extends AbstractHoodieWriteClient<T,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7aedc0bdc1565d47b044487aab04b659167bd086"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDYwMDc0Mg==", "bodyText": "why are we not hanging onto the returned object?", "url": "https://github.com/apache/hudi/pull/1827#discussion_r484600742", "createdAt": "2020-09-08T01:13:43Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-spark-client/src/main/java/org/apache/hudi/client/HoodieSparkWriteClient.java", "diffHunk": "@@ -0,0 +1,360 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.client;\n+\n+import com.codahale.metrics.Timer;\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hudi.client.embebbed.BaseEmbeddedTimelineService;\n+import org.apache.hudi.client.embedded.SparkEmbeddedTimelineService;\n+import org.apache.hudi.common.HoodieEngineContext;\n+import org.apache.hudi.common.HoodieSparkEngineContext;\n+import org.apache.hudi.common.model.HoodieCommitMetadata;\n+import org.apache.hudi.common.model.HoodieKey;\n+import org.apache.hudi.common.model.HoodieRecord;\n+import org.apache.hudi.common.model.HoodieRecordPayload;\n+import org.apache.hudi.common.model.HoodieWriteStat;\n+import org.apache.hudi.common.model.WriteOperationType;\n+import org.apache.hudi.common.table.HoodieTableMetaClient;\n+import org.apache.hudi.common.table.HoodieTableVersion;\n+import org.apache.hudi.common.table.timeline.HoodieActiveTimeline;\n+import org.apache.hudi.common.table.timeline.HoodieInstant;\n+import org.apache.hudi.common.table.timeline.HoodieTimeline;\n+import org.apache.hudi.common.util.Option;\n+import org.apache.hudi.common.util.collection.Pair;\n+import org.apache.hudi.config.HoodieCompactionConfig;\n+import org.apache.hudi.config.HoodieWriteConfig;\n+import org.apache.hudi.exception.HoodieCommitException;\n+import org.apache.hudi.exception.HoodieIOException;\n+import org.apache.hudi.index.HoodieIndex;\n+import org.apache.hudi.index.HoodieSparkIndexFactory;\n+import org.apache.hudi.table.BaseHoodieTimelineArchiveLog;\n+import org.apache.hudi.table.BulkInsertPartitioner;\n+import org.apache.hudi.table.HoodieSparkTable;\n+import org.apache.hudi.table.HoodieSparkTimelineArchiveLog;\n+import org.apache.hudi.table.HoodieTable;\n+import org.apache.hudi.table.SparkMarkerFiles;\n+import org.apache.hudi.table.action.HoodieWriteMetadata;\n+import org.apache.hudi.table.action.compact.SparkCompactHelpers;\n+import org.apache.hudi.table.upgrade.SparkUpgradeDowngrade;\n+import org.apache.log4j.LogManager;\n+import org.apache.log4j.Logger;\n+import org.apache.spark.SparkConf;\n+import org.apache.spark.api.java.JavaPairRDD;\n+import org.apache.spark.api.java.JavaRDD;\n+\n+import java.io.IOException;\n+import java.text.ParseException;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class HoodieSparkWriteClient<T extends HoodieRecordPayload> extends AbstractHoodieWriteClient<T,\n+    JavaRDD<HoodieRecord<T>>, JavaRDD<HoodieKey>, JavaRDD<WriteStatus>, JavaPairRDD<HoodieKey, Option<Pair<String, String>>>> {\n+\n+  private static final Logger LOG = LogManager.getLogger(HoodieSparkWriteClient.class);\n+\n+  public HoodieSparkWriteClient(HoodieEngineContext context, HoodieWriteConfig clientConfig) {\n+    super(context, clientConfig);\n+  }\n+\n+  public HoodieSparkWriteClient(HoodieEngineContext context, HoodieWriteConfig writeConfig, boolean rollbackPending) {\n+    super(context, writeConfig, rollbackPending);\n+  }\n+\n+  public HoodieSparkWriteClient(HoodieEngineContext context, HoodieWriteConfig writeConfig, boolean rollbackPending, Option<BaseEmbeddedTimelineService> timelineService) {\n+    super(context, writeConfig, rollbackPending, timelineService);\n+  }\n+\n+  /**\n+   * Register hudi classes for Kryo serialization.\n+   *\n+   * @param conf instance of SparkConf\n+   * @return SparkConf\n+   */\n+  public static SparkConf registerClasses(SparkConf conf) {\n+    conf.registerKryoClasses(new Class[]{HoodieWriteConfig.class, HoodieRecord.class, HoodieKey.class});\n+    return conf;\n+  }\n+\n+  @Override\n+  protected HoodieIndex<T, JavaRDD<HoodieRecord<T>>, JavaRDD<HoodieKey>, JavaRDD<WriteStatus>, JavaPairRDD<HoodieKey, Option<Pair<String, String>>>> createIndex(HoodieWriteConfig writeConfig) {\n+    return HoodieSparkIndexFactory.createIndex(config);\n+  }\n+\n+  @Override\n+  public boolean commit(String instantTime, JavaRDD<WriteStatus> writeStatuses, Option<Map<String, String>> extraMetadata) {\n+    List<HoodieWriteStat> stats = writeStatuses.map(WriteStatus::getStat).collect();\n+    return commitStats(instantTime, stats, extraMetadata);\n+  }\n+\n+  @Override\n+  protected HoodieTable<T, JavaRDD<HoodieRecord<T>>, JavaRDD<HoodieKey>, JavaRDD<WriteStatus>, JavaPairRDD<HoodieKey, Option<Pair<String, String>>>> createTable(HoodieWriteConfig config, Configuration hadoopConf) {\n+    return HoodieSparkTable.create(config, context);\n+  }\n+\n+  @Override\n+  public JavaRDD<HoodieRecord<T>> filterExists(JavaRDD<HoodieRecord<T>> hoodieRecords) {\n+    // Create a Hoodie table which encapsulated the commits and files visible\n+    HoodieTable table = HoodieSparkTable.create(config, context);\n+    Timer.Context indexTimer = metrics.getIndexCtx();\n+    JavaRDD<HoodieRecord<T>> recordsWithLocation = getIndex().tagLocation(hoodieRecords, context, table);\n+    metrics.updateIndexMetrics(LOOKUP_STR, metrics.getDurationInMs(indexTimer == null ? 0L : indexTimer.stop()));\n+    return recordsWithLocation.filter(v1 -> !v1.isCurrentLocationKnown());\n+  }\n+\n+  /**\n+   * Main API to run bootstrap to hudi.\n+   */\n+  @Override\n+  public void bootstrap(Option<Map<String, String>> extraMetadata) {\n+    if (rollbackPending) {\n+      rollBackInflightBootstrap();\n+    }\n+    HoodieSparkTable table = (HoodieSparkTable) getTableAndInitCtx(WriteOperationType.UPSERT, HoodieTimeline.METADATA_BOOTSTRAP_INSTANT_TS);\n+    table.bootstrap(context, extraMetadata);\n+  }\n+\n+  @Override\n+  public JavaRDD<WriteStatus> upsert(JavaRDD<HoodieRecord<T>> records, String instantTime) {\n+    HoodieSparkTable table = (HoodieSparkTable) getTableAndInitCtx(WriteOperationType.UPSERT, instantTime);\n+    table.validateUpsertSchema();\n+    setOperationType(WriteOperationType.UPSERT);\n+    startAsyncCleaningIfEnabled(this, instantTime);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7aedc0bdc1565d47b044487aab04b659167bd086"}, "originalPosition": 137}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDYwMDgwNw==", "bodyText": "same here and everywhere else.", "url": "https://github.com/apache/hudi/pull/1827#discussion_r484600807", "createdAt": "2020-09-08T01:14:01Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-spark-client/src/main/java/org/apache/hudi/client/HoodieSparkWriteClient.java", "diffHunk": "@@ -0,0 +1,360 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.client;\n+\n+import com.codahale.metrics.Timer;\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hudi.client.embebbed.BaseEmbeddedTimelineService;\n+import org.apache.hudi.client.embedded.SparkEmbeddedTimelineService;\n+import org.apache.hudi.common.HoodieEngineContext;\n+import org.apache.hudi.common.HoodieSparkEngineContext;\n+import org.apache.hudi.common.model.HoodieCommitMetadata;\n+import org.apache.hudi.common.model.HoodieKey;\n+import org.apache.hudi.common.model.HoodieRecord;\n+import org.apache.hudi.common.model.HoodieRecordPayload;\n+import org.apache.hudi.common.model.HoodieWriteStat;\n+import org.apache.hudi.common.model.WriteOperationType;\n+import org.apache.hudi.common.table.HoodieTableMetaClient;\n+import org.apache.hudi.common.table.HoodieTableVersion;\n+import org.apache.hudi.common.table.timeline.HoodieActiveTimeline;\n+import org.apache.hudi.common.table.timeline.HoodieInstant;\n+import org.apache.hudi.common.table.timeline.HoodieTimeline;\n+import org.apache.hudi.common.util.Option;\n+import org.apache.hudi.common.util.collection.Pair;\n+import org.apache.hudi.config.HoodieCompactionConfig;\n+import org.apache.hudi.config.HoodieWriteConfig;\n+import org.apache.hudi.exception.HoodieCommitException;\n+import org.apache.hudi.exception.HoodieIOException;\n+import org.apache.hudi.index.HoodieIndex;\n+import org.apache.hudi.index.HoodieSparkIndexFactory;\n+import org.apache.hudi.table.BaseHoodieTimelineArchiveLog;\n+import org.apache.hudi.table.BulkInsertPartitioner;\n+import org.apache.hudi.table.HoodieSparkTable;\n+import org.apache.hudi.table.HoodieSparkTimelineArchiveLog;\n+import org.apache.hudi.table.HoodieTable;\n+import org.apache.hudi.table.SparkMarkerFiles;\n+import org.apache.hudi.table.action.HoodieWriteMetadata;\n+import org.apache.hudi.table.action.compact.SparkCompactHelpers;\n+import org.apache.hudi.table.upgrade.SparkUpgradeDowngrade;\n+import org.apache.log4j.LogManager;\n+import org.apache.log4j.Logger;\n+import org.apache.spark.SparkConf;\n+import org.apache.spark.api.java.JavaPairRDD;\n+import org.apache.spark.api.java.JavaRDD;\n+\n+import java.io.IOException;\n+import java.text.ParseException;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class HoodieSparkWriteClient<T extends HoodieRecordPayload> extends AbstractHoodieWriteClient<T,\n+    JavaRDD<HoodieRecord<T>>, JavaRDD<HoodieKey>, JavaRDD<WriteStatus>, JavaPairRDD<HoodieKey, Option<Pair<String, String>>>> {\n+\n+  private static final Logger LOG = LogManager.getLogger(HoodieSparkWriteClient.class);\n+\n+  public HoodieSparkWriteClient(HoodieEngineContext context, HoodieWriteConfig clientConfig) {\n+    super(context, clientConfig);\n+  }\n+\n+  public HoodieSparkWriteClient(HoodieEngineContext context, HoodieWriteConfig writeConfig, boolean rollbackPending) {\n+    super(context, writeConfig, rollbackPending);\n+  }\n+\n+  public HoodieSparkWriteClient(HoodieEngineContext context, HoodieWriteConfig writeConfig, boolean rollbackPending, Option<BaseEmbeddedTimelineService> timelineService) {\n+    super(context, writeConfig, rollbackPending, timelineService);\n+  }\n+\n+  /**\n+   * Register hudi classes for Kryo serialization.\n+   *\n+   * @param conf instance of SparkConf\n+   * @return SparkConf\n+   */\n+  public static SparkConf registerClasses(SparkConf conf) {\n+    conf.registerKryoClasses(new Class[]{HoodieWriteConfig.class, HoodieRecord.class, HoodieKey.class});\n+    return conf;\n+  }\n+\n+  @Override\n+  protected HoodieIndex<T, JavaRDD<HoodieRecord<T>>, JavaRDD<HoodieKey>, JavaRDD<WriteStatus>, JavaPairRDD<HoodieKey, Option<Pair<String, String>>>> createIndex(HoodieWriteConfig writeConfig) {\n+    return HoodieSparkIndexFactory.createIndex(config);\n+  }\n+\n+  @Override\n+  public boolean commit(String instantTime, JavaRDD<WriteStatus> writeStatuses, Option<Map<String, String>> extraMetadata) {\n+    List<HoodieWriteStat> stats = writeStatuses.map(WriteStatus::getStat).collect();\n+    return commitStats(instantTime, stats, extraMetadata);\n+  }\n+\n+  @Override\n+  protected HoodieTable<T, JavaRDD<HoodieRecord<T>>, JavaRDD<HoodieKey>, JavaRDD<WriteStatus>, JavaPairRDD<HoodieKey, Option<Pair<String, String>>>> createTable(HoodieWriteConfig config, Configuration hadoopConf) {\n+    return HoodieSparkTable.create(config, context);\n+  }\n+\n+  @Override\n+  public JavaRDD<HoodieRecord<T>> filterExists(JavaRDD<HoodieRecord<T>> hoodieRecords) {\n+    // Create a Hoodie table which encapsulated the commits and files visible\n+    HoodieTable table = HoodieSparkTable.create(config, context);\n+    Timer.Context indexTimer = metrics.getIndexCtx();\n+    JavaRDD<HoodieRecord<T>> recordsWithLocation = getIndex().tagLocation(hoodieRecords, context, table);\n+    metrics.updateIndexMetrics(LOOKUP_STR, metrics.getDurationInMs(indexTimer == null ? 0L : indexTimer.stop()));\n+    return recordsWithLocation.filter(v1 -> !v1.isCurrentLocationKnown());\n+  }\n+\n+  /**\n+   * Main API to run bootstrap to hudi.\n+   */\n+  @Override\n+  public void bootstrap(Option<Map<String, String>> extraMetadata) {\n+    if (rollbackPending) {\n+      rollBackInflightBootstrap();\n+    }\n+    HoodieSparkTable table = (HoodieSparkTable) getTableAndInitCtx(WriteOperationType.UPSERT, HoodieTimeline.METADATA_BOOTSTRAP_INSTANT_TS);\n+    table.bootstrap(context, extraMetadata);\n+  }\n+\n+  @Override\n+  public JavaRDD<WriteStatus> upsert(JavaRDD<HoodieRecord<T>> records, String instantTime) {\n+    HoodieSparkTable table = (HoodieSparkTable) getTableAndInitCtx(WriteOperationType.UPSERT, instantTime);\n+    table.validateUpsertSchema();\n+    setOperationType(WriteOperationType.UPSERT);\n+    startAsyncCleaningIfEnabled(this, instantTime);\n+    HoodieWriteMetadata<JavaRDD<WriteStatus>> result = table.upsert(context, instantTime, records);\n+    if (result.getIndexLookupDuration().isPresent()) {\n+      metrics.updateIndexMetrics(LOOKUP_STR, result.getIndexLookupDuration().get().toMillis());\n+    }\n+    return postWrite(result, instantTime, table);\n+  }\n+\n+  @Override\n+  public JavaRDD<WriteStatus> upsertPreppedRecords(JavaRDD<HoodieRecord<T>> preppedRecords, String instantTime) {\n+    HoodieSparkTable table = (HoodieSparkTable) getTableAndInitCtx(WriteOperationType.UPSERT_PREPPED, instantTime);\n+    table.validateUpsertSchema();\n+    setOperationType(WriteOperationType.UPSERT_PREPPED);\n+    startAsyncCleaningIfEnabled(this, instantTime);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7aedc0bdc1565d47b044487aab04b659167bd086"}, "originalPosition": 150}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDYwMTYzMQ==", "bodyText": "I think we can eliminate the need for breaking this up into spark vs non-spark, by just passing in the host. This class does not make much sense being broken up.", "url": "https://github.com/apache/hudi/pull/1827#discussion_r484601631", "createdAt": "2020-09-08T01:18:10Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-spark-client/src/main/java/org/apache/hudi/client/embedded/SparkEmbeddedTimelineService.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.client.embedded;\n+\n+import org.apache.hudi.client.embebbed.BaseEmbeddedTimelineService;\n+import org.apache.hudi.common.HoodieEngineContext;\n+import org.apache.hudi.common.HoodieSparkEngineContext;\n+import org.apache.hudi.common.table.view.FileSystemViewStorageConfig;\n+import org.apache.log4j.LogManager;\n+import org.apache.log4j.Logger;\n+import org.apache.spark.SparkConf;\n+\n+/**\n+ * Spark implementation of Timeline Service.\n+ */\n+public class SparkEmbeddedTimelineService extends BaseEmbeddedTimelineService {\n+\n+  private static final Logger LOG = LogManager.getLogger(SparkEmbeddedTimelineService.class);\n+\n+  public SparkEmbeddedTimelineService(HoodieEngineContext context, FileSystemViewStorageConfig config) {\n+    super(context, config);\n+  }\n+\n+  @Override\n+  public void setHostAddrFromContext(HoodieEngineContext context) {\n+    SparkConf sparkConf = HoodieSparkEngineContext.getSparkContext(context).getConf();\n+    String hostAddr = sparkConf.get(\"spark.driver.host\", null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7aedc0bdc1565d47b044487aab04b659167bd086"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDYwMjU2Mg==", "bodyText": "note to self: make sure these methods are now in the base class", "url": "https://github.com/apache/hudi/pull/1827#discussion_r484602562", "createdAt": "2020-09-08T01:23:12Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-spark-client/src/main/java/org/apache/hudi/index/hbase/HoodieSparkHBaseIndex.java", "diffHunk": "@@ -18,169 +18,60 @@\n \n package org.apache.hudi.index.hbase;\n \n+import org.apache.hadoop.hbase.TableName;\n+import org.apache.hadoop.hbase.client.BufferedMutator;\n+import org.apache.hadoop.hbase.client.Delete;\n+import org.apache.hadoop.hbase.client.Get;\n+import org.apache.hadoop.hbase.client.HTable;\n+import org.apache.hadoop.hbase.client.Mutation;\n+import org.apache.hadoop.hbase.client.Put;\n+import org.apache.hadoop.hbase.client.Result;\n+import org.apache.hadoop.hbase.util.Bytes;\n import org.apache.hudi.client.WriteStatus;\n import org.apache.hudi.client.utils.SparkConfigUtils;\n+import org.apache.hudi.common.HoodieEngineContext;\n+import org.apache.hudi.common.HoodieSparkEngineContext;\n import org.apache.hudi.common.model.HoodieKey;\n import org.apache.hudi.common.model.HoodieRecord;\n import org.apache.hudi.common.model.HoodieRecordLocation;\n import org.apache.hudi.common.model.HoodieRecordPayload;\n import org.apache.hudi.common.table.HoodieTableMetaClient;\n-import org.apache.hudi.common.table.timeline.HoodieTimeline;\n import org.apache.hudi.common.util.Option;\n-import org.apache.hudi.common.util.ReflectionUtils;\n import org.apache.hudi.common.util.collection.Pair;\n-import org.apache.hudi.config.HoodieHBaseIndexConfig;\n import org.apache.hudi.config.HoodieWriteConfig;\n-import org.apache.hudi.exception.HoodieDependentSystemUnavailableException;\n import org.apache.hudi.exception.HoodieIndexException;\n-import org.apache.hudi.index.HoodieIndex;\n import org.apache.hudi.table.HoodieTable;\n-\n-import org.apache.hadoop.conf.Configuration;\n-import org.apache.hadoop.hbase.HBaseConfiguration;\n-import org.apache.hadoop.hbase.HRegionLocation;\n-import org.apache.hadoop.hbase.TableName;\n-import org.apache.hadoop.hbase.client.BufferedMutator;\n-import org.apache.hadoop.hbase.client.Connection;\n-import org.apache.hadoop.hbase.client.ConnectionFactory;\n-import org.apache.hadoop.hbase.client.Delete;\n-import org.apache.hadoop.hbase.client.Get;\n-import org.apache.hadoop.hbase.client.HTable;\n-import org.apache.hadoop.hbase.client.Mutation;\n-import org.apache.hadoop.hbase.client.Put;\n-import org.apache.hadoop.hbase.client.RegionLocator;\n-import org.apache.hadoop.hbase.client.Result;\n-import org.apache.hadoop.hbase.util.Bytes;\n import org.apache.log4j.LogManager;\n import org.apache.log4j.Logger;\n import org.apache.spark.SparkConf;\n import org.apache.spark.api.java.JavaPairRDD;\n import org.apache.spark.api.java.JavaRDD;\n import org.apache.spark.api.java.JavaSparkContext;\n import org.apache.spark.api.java.function.Function2;\n+import scala.Tuple2;\n \n import java.io.IOException;\n-import java.io.Serializable;\n import java.util.ArrayList;\n import java.util.Iterator;\n import java.util.LinkedList;\n import java.util.List;\n \n-import scala.Tuple2;\n+public class HoodieSparkHBaseIndex<T extends HoodieRecordPayload> extends BaseHoodieHBaseIndex<T, JavaRDD<HoodieRecord<T>>, JavaRDD<HoodieKey>, JavaRDD<WriteStatus>, JavaPairRDD<HoodieKey, Option<Pair<String, String>>>> {\n \n-/**\n- * Hoodie Index implementation backed by HBase.\n- */\n-public class HBaseIndex<T extends HoodieRecordPayload> extends HoodieIndex<T> {\n+  private static final Logger LOG = LogManager.getLogger(HoodieSparkHBaseIndex.class);\n \n   public static final String DEFAULT_SPARK_EXECUTOR_INSTANCES_CONFIG_NAME = \"spark.executor.instances\";\n   public static final String DEFAULT_SPARK_DYNAMIC_ALLOCATION_ENABLED_CONFIG_NAME = \"spark.dynamicAllocation.enabled\";\n   public static final String DEFAULT_SPARK_DYNAMIC_ALLOCATION_MAX_EXECUTORS_CONFIG_NAME =\n       \"spark.dynamicAllocation.maxExecutors\";\n \n-  private static final byte[] SYSTEM_COLUMN_FAMILY = Bytes.toBytes(\"_s\");\n-  private static final byte[] COMMIT_TS_COLUMN = Bytes.toBytes(\"commit_ts\");\n-  private static final byte[] FILE_NAME_COLUMN = Bytes.toBytes(\"file_name\");\n-  private static final byte[] PARTITION_PATH_COLUMN = Bytes.toBytes(\"partition_path\");\n-  private static final int SLEEP_TIME_MILLISECONDS = 100;\n-\n-  private static final Logger LOG = LogManager.getLogger(HBaseIndex.class);\n-  private static Connection hbaseConnection = null;\n-  private HBaseIndexQPSResourceAllocator hBaseIndexQPSResourceAllocator = null;\n-  private float qpsFraction;\n-  private int maxQpsPerRegionServer;\n-  /**\n-   * multiPutBatchSize will be computed and re-set in updateLocation if\n-   * {@link HoodieHBaseIndexConfig#HBASE_PUT_BATCH_SIZE_AUTO_COMPUTE_PROP} is set to true.\n-   */\n-  private Integer multiPutBatchSize;\n-  private Integer numRegionServersForTable;\n-  private final String tableName;\n-  private HBasePutBatchSizeCalculator putBatchSizeCalculator;\n-\n-  public HBaseIndex(HoodieWriteConfig config) {\n+  public HoodieSparkHBaseIndex(HoodieWriteConfig config) {\n     super(config);\n-    this.tableName = config.getHbaseTableName();\n-    addShutDownHook();\n-    init(config);\n-  }\n-\n-  private void init(HoodieWriteConfig config) {\n-    this.multiPutBatchSize = config.getHbaseIndexGetBatchSize();\n-    this.qpsFraction = config.getHbaseIndexQPSFraction();\n-    this.maxQpsPerRegionServer = config.getHbaseIndexMaxQPSPerRegionServer();\n-    this.putBatchSizeCalculator = new HBasePutBatchSizeCalculator();\n-    this.hBaseIndexQPSResourceAllocator = createQPSResourceAllocator(this.config);\n-  }\n-\n-  public HBaseIndexQPSResourceAllocator createQPSResourceAllocator(HoodieWriteConfig config) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7aedc0bdc1565d47b044487aab04b659167bd086"}, "originalPosition": 114}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDYwMzIzOA==", "bodyText": "note to self: make sure these methods are in the base class now", "url": "https://github.com/apache/hudi/pull/1827#discussion_r484603238", "createdAt": "2020-09-08T01:26:16Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-spark-client/src/main/java/org/apache/hudi/index/simple/HoodieSparkGlobalSimpleIndex.java", "diffHunk": "@@ -71,43 +75,14 @@ public HoodieGlobalSimpleIndex(HoodieWriteConfig config) {\n    * @return {@link JavaRDD} of records with record locations set\n    */\n   protected JavaRDD<HoodieRecord<T>> tagLocationInternal(JavaRDD<HoodieRecord<T>> inputRecordRDD, JavaSparkContext jsc,\n-                                                         HoodieTable<T> hoodieTable) {\n+                                                         HoodieTable hoodieTable) {\n \n     JavaPairRDD<String, HoodieRecord<T>> keyedInputRecordRDD = inputRecordRDD.mapToPair(entry -> new Tuple2<>(entry.getRecordKey(), entry));\n     JavaPairRDD<HoodieKey, HoodieRecordLocation> allRecordLocationsInTable = fetchAllRecordLocations(jsc, hoodieTable,\n         config.getGlobalSimpleIndexParallelism());\n     return getTaggedRecords(keyedInputRecordRDD, allRecordLocationsInTable);\n   }\n \n-  /**\n-   * Fetch record locations for passed in {@link HoodieKey}s.\n-   *\n-   * @param jsc         instance of {@link JavaSparkContext} to use\n-   * @param hoodieTable instance of {@link HoodieTable} of interest\n-   * @param parallelism parallelism to use\n-   * @return {@link JavaPairRDD} of {@link HoodieKey} and {@link HoodieRecordLocation}\n-   */\n-  protected JavaPairRDD<HoodieKey, HoodieRecordLocation> fetchAllRecordLocations(JavaSparkContext jsc,\n-                                                                                 HoodieTable hoodieTable,\n-                                                                                 int parallelism) {\n-    List<Pair<String, HoodieBaseFile>> latestBaseFiles = getAllBaseFilesInTable(jsc, hoodieTable);\n-    return fetchRecordLocations(jsc, hoodieTable, parallelism, latestBaseFiles);\n-  }\n-\n-  /**\n-   * Load all files for all partitions as <Partition, filename> pair RDD.\n-   */\n-  protected List<Pair<String, HoodieBaseFile>> getAllBaseFilesInTable(final JavaSparkContext jsc, final HoodieTable hoodieTable) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7aedc0bdc1565d47b044487aab04b659167bd086"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDYwMzgwMA==", "bodyText": "at the MergeHandle level, we need not introduce any notion of RDDs. the io package should be free of spark already. All we need to do is to pass in the taskContextSupplier correctly? This is a large outstanding issue we need to resolve", "url": "https://github.com/apache/hudi/pull/1827#discussion_r484603800", "createdAt": "2020-09-08T01:29:10Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-spark-client/src/main/java/org/apache/hudi/io/HoodieSparkMergeHandle.java", "diffHunk": "@@ -54,9 +60,9 @@\n import java.util.Set;\n \n @SuppressWarnings(\"Duplicates\")\n-public class HoodieMergeHandle<T extends HoodieRecordPayload> extends HoodieWriteHandle<T> {\n+public class HoodieSparkMergeHandle<T extends HoodieRecordPayload> extends HoodieWriteHandle<T, JavaRDD<HoodieRecord<T>>, JavaRDD<HoodieKey>, JavaRDD<WriteStatus>, JavaPairRDD<HoodieKey, Option<Pair<String, String>>>> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7aedc0bdc1565d47b044487aab04b659167bd086"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDYwNDAxMQ==", "bodyText": "please refrain from moving methods around within the file. it makes life hard during review :(", "url": "https://github.com/apache/hudi/pull/1827#discussion_r484604011", "createdAt": "2020-09-08T01:30:08Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-spark-client/src/main/java/org/apache/hudi/io/HoodieSparkMergeHandle.java", "diffHunk": "@@ -71,34 +77,25 @@\n   protected boolean useWriterSchema;\n   private HoodieBaseFile baseFileToMerge;\n \n-  public HoodieMergeHandle(HoodieWriteConfig config, String instantTime, HoodieTable<T> hoodieTable,\n-       Iterator<HoodieRecord<T>> recordItr, String partitionPath, String fileId, SparkTaskContextSupplier sparkTaskContextSupplier) {\n-    super(config, instantTime, partitionPath, fileId, hoodieTable, sparkTaskContextSupplier);\n+  public HoodieSparkMergeHandle(HoodieWriteConfig config, String instantTime, HoodieTable hoodieTable,\n+                                Iterator<HoodieRecord<T>> recordItr, String partitionPath, String fileId, TaskContextSupplier taskContextSupplier) {\n+    super(config, instantTime, partitionPath, fileId, hoodieTable, taskContextSupplier);\n     init(fileId, recordItr);\n     init(fileId, partitionPath, hoodieTable.getBaseFileOnlyView().getLatestBaseFile(partitionPath, fileId).get());\n   }\n \n   /**\n    * Called by compactor code path.\n    */\n-  public HoodieMergeHandle(HoodieWriteConfig config, String instantTime, HoodieTable<T> hoodieTable,\n-      Map<String, HoodieRecord<T>> keyToNewRecords, String partitionPath, String fileId,\n-      HoodieBaseFile dataFileToBeMerged, SparkTaskContextSupplier sparkTaskContextSupplier) {\n-    super(config, instantTime, partitionPath, fileId, hoodieTable, sparkTaskContextSupplier);\n+  public HoodieSparkMergeHandle(HoodieWriteConfig config, String instantTime, HoodieTable hoodieTable,\n+                                Map<String, HoodieRecord<T>> keyToNewRecords, String partitionPath, String fileId,\n+                                HoodieBaseFile dataFileToBeMerged, TaskContextSupplier taskContextSupplier) {\n+    super(config, instantTime, partitionPath, fileId, hoodieTable, taskContextSupplier);\n     this.keyToNewRecords = keyToNewRecords;\n     this.useWriterSchema = true;\n     init(fileId, this.partitionPath, dataFileToBeMerged);\n   }\n \n-  @Override", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7aedc0bdc1565d47b044487aab04b659167bd086"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDYwNDI5Mg==", "bodyText": "same here. we need to make sure these factory methods don't have spark vs non-spark versions", "url": "https://github.com/apache/hudi/pull/1827#discussion_r484604292", "createdAt": "2020-09-08T01:31:14Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-spark-client/src/main/java/org/apache/hudi/io/SparkAppendHandleFactory.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.io;\n+\n+import org.apache.hudi.client.SparkTaskContextSupplier;\n+import org.apache.hudi.client.TaskContextSupplier;\n+import org.apache.hudi.client.WriteStatus;\n+import org.apache.hudi.common.model.HoodieKey;\n+import org.apache.hudi.common.model.HoodieRecord;\n+import org.apache.hudi.common.model.HoodieRecordPayload;\n+import org.apache.hudi.common.util.Option;\n+import org.apache.hudi.common.util.collection.Pair;\n+import org.apache.hudi.config.HoodieWriteConfig;\n+\n+import org.apache.hudi.table.HoodieTable;\n+import org.apache.spark.api.java.JavaPairRDD;\n+import org.apache.spark.api.java.JavaRDD;\n+\n+/**\n+ * Factory to create {@link HoodieSparkAppendHandle}.\n+ */\n+public class SparkAppendHandleFactory<T extends HoodieRecordPayload> extends WriteHandleFactory<T, JavaRDD<HoodieRecord<T>>, JavaRDD<HoodieKey>, JavaRDD<WriteStatus>, JavaPairRDD<HoodieKey, Option<Pair<String, String>>>> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7aedc0bdc1565d47b044487aab04b659167bd086"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDYwNDM2OQ==", "bodyText": "same. is there a way to not make these spark specific", "url": "https://github.com/apache/hudi/pull/1827#discussion_r484604369", "createdAt": "2020-09-08T01:31:41Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-spark-client/src/main/java/org/apache/hudi/io/SparkCreateHandleFactory.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.io;\n+\n+import org.apache.hudi.client.TaskContextSupplier;\n+import org.apache.hudi.client.WriteStatus;\n+import org.apache.hudi.common.model.HoodieKey;\n+import org.apache.hudi.common.model.HoodieRecord;\n+import org.apache.hudi.common.model.HoodieRecordPayload;\n+import org.apache.hudi.common.util.Option;\n+import org.apache.hudi.common.util.collection.Pair;\n+import org.apache.hudi.config.HoodieWriteConfig;\n+import org.apache.hudi.table.HoodieTable;\n+import org.apache.spark.api.java.JavaPairRDD;\n+import org.apache.spark.api.java.JavaRDD;\n+\n+public class SparkCreateHandleFactory<T extends HoodieRecordPayload> extends WriteHandleFactory<T, JavaRDD<HoodieRecord<T>>, JavaRDD<HoodieKey>, JavaRDD<WriteStatus>, JavaPairRDD<HoodieKey, Option<Pair<String, String>>>> {\n+\n+  @Override\n+  public HoodieSparkCreateHandle create(final HoodieWriteConfig hoodieConfig,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7aedc0bdc1565d47b044487aab04b659167bd086"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDYwNTI5MA==", "bodyText": "we can actually try and keep this generic and just pass in what we need from taggedRecords to constructor instead of the entire thing", "url": "https://github.com/apache/hudi/pull/1827#discussion_r484605290", "createdAt": "2020-09-08T01:36:26Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-spark-client/src/main/java/org/apache/hudi/table/SparkWorkloadProfile.java", "diffHunk": "@@ -22,49 +22,22 @@\n import org.apache.hudi.common.model.HoodieRecordLocation;\n import org.apache.hudi.common.model.HoodieRecordPayload;\n import org.apache.hudi.common.util.Option;\n-\n import org.apache.spark.api.java.JavaRDD;\n+import scala.Tuple2;\n \n-import java.io.Serializable;\n-import java.util.HashMap;\n import java.util.Map;\n-import java.util.Set;\n-\n-import scala.Tuple2;\n \n /**\n- * Information about incoming records for upsert/insert obtained either via sampling or introspecting the data fully.\n- * <p>\n- * TODO(vc): Think about obtaining this directly from index.tagLocation\n+ * Spark implementation of {@link BaseWorkloadProfile}.\n+ * @param <T>\n  */\n-public class WorkloadProfile<T extends HoodieRecordPayload> implements Serializable {\n-\n-  /**\n-   * Input workload.\n-   */\n-  private final JavaRDD<HoodieRecord<T>> taggedRecords;\n-\n-  /**\n-   * Computed workload profile.\n-   */\n-  private final HashMap<String, WorkloadStat> partitionPathStatMap;\n-\n-  /**\n-   * Global workloadStat.\n-   */\n-  private final WorkloadStat globalStat;\n-\n-  public WorkloadProfile(JavaRDD<HoodieRecord<T>> taggedRecords) {\n-    this.taggedRecords = taggedRecords;\n-    this.partitionPathStatMap = new HashMap<>();\n-    this.globalStat = new WorkloadStat();\n-    buildProfile();\n+public class SparkWorkloadProfile<T extends HoodieRecordPayload> extends BaseWorkloadProfile<JavaRDD<HoodieRecord<T>>> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7aedc0bdc1565d47b044487aab04b659167bd086"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDYwNTUxNw==", "bodyText": "hmmm? why do we return null here", "url": "https://github.com/apache/hudi/pull/1827#discussion_r484605517", "createdAt": "2020-09-08T01:37:30Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-spark-client/src/main/java/org/apache/hudi/table/action/bootstrap/SparkBootstrapCommitActionExecutor.java", "diffHunk": "@@ -77,34 +81,44 @@\n import org.apache.parquet.hadoop.ParquetReader;\n import org.apache.parquet.hadoop.metadata.ParquetMetadata;\n import org.apache.parquet.schema.MessageType;\n-import org.apache.spark.Partitioner;\n+import org.apache.spark.api.java.JavaPairRDD;\n import org.apache.spark.api.java.JavaRDD;\n import org.apache.spark.api.java.JavaSparkContext;\n \n import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.time.Duration;\n+import java.time.Instant;\n import java.util.Collection;\n import java.util.Iterator;\n import java.util.List;\n import java.util.Map;\n import java.util.stream.Collectors;\n \n-public class BootstrapCommitActionExecutor<T extends HoodieRecordPayload<T>>\n-    extends BaseCommitActionExecutor<T, HoodieBootstrapWriteMetadata> {\n+public class SparkBootstrapCommitActionExecutor<T extends HoodieRecordPayload>\n+    extends BaseCommitActionExecutor<T, JavaRDD<HoodieRecord<T>>, JavaRDD<HoodieKey>, JavaRDD<WriteStatus>, JavaPairRDD<HoodieKey, Option<Pair<String, String>>>, HoodieBootstrapWriteMetadata> {\n \n-  private static final Logger LOG = LogManager.getLogger(BootstrapCommitActionExecutor.class);\n+  private static final Logger LOG = LogManager.getLogger(SparkBootstrapCommitActionExecutor.class);\n   protected String bootstrapSchema = null;\n   private transient FileSystem bootstrapSourceFileSystem;\n \n-  public BootstrapCommitActionExecutor(JavaSparkContext jsc, HoodieWriteConfig config, HoodieTable<?> table,\n-      Option<Map<String, String>> extraMetadata) {\n-    super(jsc, new HoodieWriteConfig.Builder().withProps(config.getProps())\n-        .withAutoCommit(true).withWriteStatusClass(BootstrapWriteStatus.class)\n-        .withBulkInsertParallelism(config.getBootstrapParallelism())\n-        .build(), table, HoodieTimeline.METADATA_BOOTSTRAP_INSTANT_TS, WriteOperationType.BOOTSTRAP,\n+  public SparkBootstrapCommitActionExecutor(HoodieSparkEngineContext context,\n+                                            HoodieWriteConfig config,\n+                                            HoodieTable<T, JavaRDD<HoodieRecord<T>>, JavaRDD<HoodieKey>, JavaRDD<WriteStatus>, JavaPairRDD<HoodieKey, Option<Pair<String, String>>>> table,\n+                                            Option<Map<String, String>> extraMetadata) {\n+    super(context, new HoodieWriteConfig.Builder().withProps(config.getProps())\n+            .withAutoCommit(true).withWriteStatusClass(BootstrapWriteStatus.class)\n+            .withBulkInsertParallelism(config.getBootstrapParallelism())\n+            .build(), table, HoodieTimeline.METADATA_BOOTSTRAP_INSTANT_TS, WriteOperationType.BOOTSTRAP,\n         extraMetadata);\n     bootstrapSourceFileSystem = FSUtils.getFs(config.getBootstrapSourceBasePath(), hadoopConf);\n   }\n \n+  @Override\n+  public HoodieWriteMetadata<JavaRDD<WriteStatus>> execute(JavaRDD<HoodieRecord<T>> inputRecordsRDD) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7aedc0bdc1565d47b044487aab04b659167bd086"}, "originalPosition": 120}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "98b9fd05bd7ec5d706b16615bf0731c5ac6901c8", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/98b9fd05bd7ec5d706b16615bf0731c5ac6901c8", "committedDate": "2020-09-08T08:59:30Z", "message": "add SparkHoodieIndex"}, "afterCommit": {"oid": "b002589fedc67299449c3356a4abd1cc6d363dae", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/b002589fedc67299449c3356a4abd1cc6d363dae", "committedDate": "2020-09-08T10:25:49Z", "message": "add SparkHoodieIndex"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b002589fedc67299449c3356a4abd1cc6d363dae", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/b002589fedc67299449c3356a4abd1cc6d363dae", "committedDate": "2020-09-08T10:25:49Z", "message": "add SparkHoodieIndex"}, "afterCommit": {"oid": "82f0cd83dfbed28aa693279943f89913025c6ccf", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/82f0cd83dfbed28aa693279943f89913025c6ccf", "committedDate": "2020-09-08T11:11:27Z", "message": "add SparkHoodieIndex"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "82f0cd83dfbed28aa693279943f89913025c6ccf", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/82f0cd83dfbed28aa693279943f89913025c6ccf", "committedDate": "2020-09-08T11:11:27Z", "message": "add SparkHoodieIndex"}, "afterCommit": {"oid": "84656038e5ebafbb1585dc42cea14b76ef58a489", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/84656038e5ebafbb1585dc42cea14b76ef58a489", "committedDate": "2020-09-08T13:50:57Z", "message": "add SparkHoodieIndex"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c3fae2ec06afe4c6946778d2b5a49cd79e04cfd3", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/c3fae2ec06afe4c6946778d2b5a49cd79e04cfd3", "committedDate": "2020-09-08T14:00:28Z", "message": "edit travis.yml"}, "afterCommit": {"oid": "f39dfa997704f0dbd02fba8745699a92af668049", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/f39dfa997704f0dbd02fba8745699a92af668049", "committedDate": "2020-09-08T14:32:33Z", "message": "edit travis.yml"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f39dfa997704f0dbd02fba8745699a92af668049", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/f39dfa997704f0dbd02fba8745699a92af668049", "committedDate": "2020-09-08T14:32:33Z", "message": "edit travis.yml"}, "afterCommit": {"oid": "d59df457569584145896f08855cf5e53e765e9d1", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/d59df457569584145896f08855cf5e53e765e9d1", "committedDate": "2020-09-08T14:40:46Z", "message": "edit travis.yml"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d59df457569584145896f08855cf5e53e765e9d1", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/d59df457569584145896f08855cf5e53e765e9d1", "committedDate": "2020-09-08T14:40:46Z", "message": "edit travis.yml"}, "afterCommit": {"oid": "58746a68aaa2ffa8dd85a9a6cbc68db6af02d457", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/58746a68aaa2ffa8dd85a9a6cbc68db6af02d457", "committedDate": "2020-09-08T14:51:47Z", "message": "add SparkHoodieIndex"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "58746a68aaa2ffa8dd85a9a6cbc68db6af02d457", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/58746a68aaa2ffa8dd85a9a6cbc68db6af02d457", "committedDate": "2020-09-08T14:51:47Z", "message": "add SparkHoodieIndex"}, "afterCommit": {"oid": "01b4f4a433c49a83df2d6370effaa1356df1343d", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/01b4f4a433c49a83df2d6370effaa1356df1343d", "committedDate": "2020-09-08T15:33:16Z", "message": "add SparkHoodieIndex"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3365df446a3e78494972b43598e65fd8b3414fe7", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/3365df446a3e78494972b43598e65fd8b3414fe7", "committedDate": "2020-09-09T14:28:13Z", "message": "triger ci"}, "afterCommit": {"oid": "54d352ac06b57da3116aefa00aec80cdd45ada5a", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/54d352ac06b57da3116aefa00aec80cdd45ada5a", "committedDate": "2020-09-09T14:57:00Z", "message": "trigger ci"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a29a2f40d40e48dbd457abc6c046482395786c83", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/a29a2f40d40e48dbd457abc6c046482395786c83", "committedDate": "2020-09-10T11:30:03Z", "message": "trigger ci"}, "afterCommit": {"oid": "e94a33d304341fc61b9ddaf82b3e0868f223b92c", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/e94a33d304341fc61b9ddaf82b3e0868f223b92c", "committedDate": "2020-09-10T13:47:42Z", "message": "trigger ci"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e94a33d304341fc61b9ddaf82b3e0868f223b92c", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/e94a33d304341fc61b9ddaf82b3e0868f223b92c", "committedDate": "2020-09-10T13:47:42Z", "message": "trigger ci"}, "afterCommit": {"oid": "23b9e3649bb337c5815b3d1234354667e0a47859", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/23b9e3649bb337c5815b3d1234354667e0a47859", "committedDate": "2020-09-10T13:53:02Z", "message": "trigger ci"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "23b9e3649bb337c5815b3d1234354667e0a47859", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/23b9e3649bb337c5815b3d1234354667e0a47859", "committedDate": "2020-09-10T13:53:02Z", "message": "trigger ci"}, "afterCommit": {"oid": "dc5e08a9eb3501c5a0bd86c12a5978d4070ea465", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/dc5e08a9eb3501c5a0bd86c12a5978d4070ea465", "committedDate": "2020-09-11T08:04:15Z", "message": "[HUDI-1089] Refactor hudi-client to support multi-engine"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dc5e08a9eb3501c5a0bd86c12a5978d4070ea465", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/dc5e08a9eb3501c5a0bd86c12a5978d4070ea465", "committedDate": "2020-09-11T08:04:15Z", "message": "[HUDI-1089] Refactor hudi-client to support multi-engine"}, "afterCommit": {"oid": "23b9e3649bb337c5815b3d1234354667e0a47859", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/23b9e3649bb337c5815b3d1234354667e0a47859", "committedDate": "2020-09-10T13:53:02Z", "message": "trigger ci"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "23b9e3649bb337c5815b3d1234354667e0a47859", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/23b9e3649bb337c5815b3d1234354667e0a47859", "committedDate": "2020-09-10T13:53:02Z", "message": "trigger ci"}, "afterCommit": {"oid": "bb34e0d3c3d8be74472276f0899cb369600380bb", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/bb34e0d3c3d8be74472276f0899cb369600380bb", "committedDate": "2020-09-11T08:17:16Z", "message": "[HUDI-1089] Refactor hudi-client to support multi-engine"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bb34e0d3c3d8be74472276f0899cb369600380bb", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/bb34e0d3c3d8be74472276f0899cb369600380bb", "committedDate": "2020-09-11T08:17:16Z", "message": "[HUDI-1089] Refactor hudi-client to support multi-engine"}, "afterCommit": {"oid": "23b9e3649bb337c5815b3d1234354667e0a47859", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/23b9e3649bb337c5815b3d1234354667e0a47859", "committedDate": "2020-09-10T13:53:02Z", "message": "trigger ci"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyODczNjAz", "url": "https://github.com/apache/hudi/pull/1827#pullrequestreview-492873603", "createdAt": "2020-09-21T18:26:33Z", "commit": {"oid": "2d1f2124db067f1379fd342b94b4fe1775ace663"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxODoyNjozNFrOHVdRzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxODozMjozM1rOHVde2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI2MTgzNw==", "bodyText": "I think we should leave this abstract and let the engines implement this?  even for Java. Its better to have a HoodieJavaEngineContext. From what I can see, this is not overridden in HoodieSparkEngineContext and thus we lose the parallel execution that we currently have with Spark with this change.", "url": "https://github.com/apache/hudi/pull/1827#discussion_r492261837", "createdAt": "2020-09-21T18:26:34Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/common/HoodieEngineContext.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.common;\n+\n+import org.apache.hudi.client.TaskContextSupplier;\n+import org.apache.hudi.common.config.SerializableConfiguration;\n+\n+import java.util.List;\n+import java.util.function.Consumer;\n+import java.util.function.Function;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+/**\n+ * Base class contains the context information needed by the engine at runtime. It will be extended by different\n+ * engine implementation if needed.\n+ */\n+public class HoodieEngineContext {\n+  /**\n+   * A wrapped hadoop configuration which can be serialized.\n+   */\n+  private SerializableConfiguration hadoopConf;\n+\n+  private TaskContextSupplier taskContextSupplier;\n+\n+  public HoodieEngineContext(SerializableConfiguration hadoopConf, TaskContextSupplier taskContextSupplier) {\n+    this.hadoopConf = hadoopConf;\n+    this.taskContextSupplier = taskContextSupplier;\n+  }\n+\n+  public SerializableConfiguration getHadoopConf() {\n+    return hadoopConf;\n+  }\n+\n+  public TaskContextSupplier getTaskContextSupplier() {\n+    return taskContextSupplier;\n+  }\n+\n+  public <I, O> List<O> map(List<I> data, Function<I, O> func) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d1f2124db067f1379fd342b94b4fe1775ace663"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI2Mjk2NA==", "bodyText": "can we implement versiosn of map, flatMap, forEach here which use javaSparkContext.parallelize() ? It would be good to keep this PR free of any changes in terms of whether we are executing the deletes/lists in parallel or in serial.", "url": "https://github.com/apache/hudi/pull/1827#discussion_r492262964", "createdAt": "2020-09-21T18:28:36Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-spark-client/src/main/java/org/apache/hudi/common/HoodieSparkEngineContext.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.common;\n+\n+import org.apache.hudi.client.SparkTaskContextSupplier;\n+import org.apache.hudi.common.config.SerializableConfiguration;\n+import org.apache.spark.api.java.JavaSparkContext;\n+import org.apache.spark.sql.SQLContext;\n+\n+/**\n+ * A Spark engine implementation of HoodieEngineContext.\n+ */\n+public class HoodieSparkEngineContext extends HoodieEngineContext {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d1f2124db067f1379fd342b94b4fe1775ace663"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI2NDM1Mg==", "bodyText": "Also these APIs should take in a parallelism parameter, no?", "url": "https://github.com/apache/hudi/pull/1827#discussion_r492264352", "createdAt": "2020-09-21T18:31:03Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/common/HoodieEngineContext.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.common;\n+\n+import org.apache.hudi.client.TaskContextSupplier;\n+import org.apache.hudi.common.config.SerializableConfiguration;\n+\n+import java.util.List;\n+import java.util.function.Consumer;\n+import java.util.function.Function;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+/**\n+ * Base class contains the context information needed by the engine at runtime. It will be extended by different\n+ * engine implementation if needed.\n+ */\n+public class HoodieEngineContext {\n+  /**\n+   * A wrapped hadoop configuration which can be serialized.\n+   */\n+  private SerializableConfiguration hadoopConf;\n+\n+  private TaskContextSupplier taskContextSupplier;\n+\n+  public HoodieEngineContext(SerializableConfiguration hadoopConf, TaskContextSupplier taskContextSupplier) {\n+    this.hadoopConf = hadoopConf;\n+    this.taskContextSupplier = taskContextSupplier;\n+  }\n+\n+  public SerializableConfiguration getHadoopConf() {\n+    return hadoopConf;\n+  }\n+\n+  public TaskContextSupplier getTaskContextSupplier() {\n+    return taskContextSupplier;\n+  }\n+\n+  public <I, O> List<O> map(List<I> data, Function<I, O> func) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI2MTgzNw=="}, "originalCommit": {"oid": "2d1f2124db067f1379fd342b94b4fe1775ace663"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI2NDkxOQ==", "bodyText": "we are not using parallelism here. This will lead to a perf regression w.r.t master.", "url": "https://github.com/apache/hudi/pull/1827#discussion_r492264919", "createdAt": "2020-09-21T18:32:04Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-spark-client/src/main/java/org/apache/hudi/table/SparkMarkerFiles.java", "diffHunk": "@@ -0,0 +1,124 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.table;\n+\n+import org.apache.hadoop.fs.FileStatus;\n+import org.apache.hadoop.fs.FileSystem;\n+import org.apache.hadoop.fs.LocatedFileStatus;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.fs.RemoteIterator;\n+import org.apache.hudi.bifunction.wrapper.ThrowingFunction;\n+import org.apache.hudi.common.HoodieEngineContext;\n+import org.apache.hudi.common.config.SerializableConfiguration;\n+import org.apache.hudi.common.model.IOType;\n+import org.apache.hudi.common.table.HoodieTableMetaClient;\n+import org.apache.hudi.exception.HoodieIOException;\n+import org.apache.log4j.LogManager;\n+import org.apache.log4j.Logger;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import static org.apache.hudi.bifunction.wrapper.BiFunctionWrapper.throwingConsumerWrapper;\n+import static org.apache.hudi.bifunction.wrapper.BiFunctionWrapper.throwingFlatMapWrapper;\n+\n+public class SparkMarkerFiles extends BaseMarkerFiles {\n+\n+  private static final Logger LOG = LogManager.getLogger(SparkMarkerFiles.class);\n+\n+  public SparkMarkerFiles(HoodieTable table, String instantTime) {\n+    super(table, instantTime);\n+  }\n+\n+  public SparkMarkerFiles(FileSystem fs, String basePath, String markerFolderPath, String instantTime) {\n+    super(fs, basePath, markerFolderPath, instantTime);\n+  }\n+\n+  @Override\n+  public boolean deleteMarkerDir(HoodieEngineContext context, int parallelism) {\n+    try {\n+      if (fs.exists(markerDirPath)) {\n+        FileStatus[] fileStatuses = fs.listStatus(markerDirPath);\n+        List<String> markerDirSubPaths = Arrays.stream(fileStatuses)\n+            .map(fileStatus -> fileStatus.getPath().toString())\n+            .collect(Collectors.toList());\n+\n+        if (markerDirSubPaths.size() > 0) {\n+          SerializableConfiguration conf = new SerializableConfiguration(fs.getConf());\n+          context.foreach(markerDirSubPaths, throwingConsumerWrapper(subPathStr -> {\n+            Path subPath = new Path(subPathStr);\n+            FileSystem fileSystem = subPath.getFileSystem(conf.get());\n+            fileSystem.delete(subPath, true);\n+          }));\n+        }\n+\n+        boolean result = fs.delete(markerDirPath, true);\n+        LOG.info(\"Removing marker directory at \" + markerDirPath);\n+        return result;\n+      }\n+    } catch (IOException ioe) {\n+      throw new HoodieIOException(ioe.getMessage(), ioe);\n+    }\n+    return false;\n+  }\n+\n+  @Override\n+  public Set<String> createdAndMergedDataPaths(HoodieEngineContext context, int parallelism) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d1f2124db067f1379fd342b94b4fe1775ace663"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI2NTE3Nw==", "bodyText": "Given this file is now free of Spark, we dont have the need of breaking these into base and child classes right.", "url": "https://github.com/apache/hudi/pull/1827#discussion_r492265177", "createdAt": "2020-09-21T18:32:33Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-spark-client/src/main/java/org/apache/hudi/table/SparkMarkerFiles.java", "diffHunk": "@@ -0,0 +1,124 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.table;\n+\n+import org.apache.hadoop.fs.FileStatus;\n+import org.apache.hadoop.fs.FileSystem;\n+import org.apache.hadoop.fs.LocatedFileStatus;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.fs.RemoteIterator;\n+import org.apache.hudi.bifunction.wrapper.ThrowingFunction;\n+import org.apache.hudi.common.HoodieEngineContext;\n+import org.apache.hudi.common.config.SerializableConfiguration;\n+import org.apache.hudi.common.model.IOType;\n+import org.apache.hudi.common.table.HoodieTableMetaClient;\n+import org.apache.hudi.exception.HoodieIOException;\n+import org.apache.log4j.LogManager;\n+import org.apache.log4j.Logger;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import static org.apache.hudi.bifunction.wrapper.BiFunctionWrapper.throwingConsumerWrapper;\n+import static org.apache.hudi.bifunction.wrapper.BiFunctionWrapper.throwingFlatMapWrapper;\n+\n+public class SparkMarkerFiles extends BaseMarkerFiles {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d1f2124db067f1379fd342b94b4fe1775ace663"}, "originalPosition": 47}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "827694d17a65572fe3ef9c1dd1aeecb65bf8dfb6", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/827694d17a65572fe3ef9c1dd1aeecb65bf8dfb6", "committedDate": "2020-09-22T07:07:12Z", "message": "refactor MarkerFile with parallelDo"}, "afterCommit": {"oid": "3a9b9a71a07c68dae940e5260ad1aab065652430", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/3a9b9a71a07c68dae940e5260ad1aab065652430", "committedDate": "2020-09-23T12:12:02Z", "message": "[HUDI-1089] Refactor hudi-client to support multi-engine"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3a9b9a71a07c68dae940e5260ad1aab065652430", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/3a9b9a71a07c68dae940e5260ad1aab065652430", "committedDate": "2020-09-23T12:12:02Z", "message": "[HUDI-1089] Refactor hudi-client to support multi-engine"}, "afterCommit": {"oid": "0609a9bafebb6fc4bb1b45bd26ab09bdfeb94e69", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/0609a9bafebb6fc4bb1b45bd26ab09bdfeb94e69", "committedDate": "2020-09-23T12:19:59Z", "message": "[HUDI-1089] Refactor hudi-client to support multi-engine"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0609a9bafebb6fc4bb1b45bd26ab09bdfeb94e69", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/0609a9bafebb6fc4bb1b45bd26ab09bdfeb94e69", "committedDate": "2020-09-23T12:19:59Z", "message": "[HUDI-1089] Refactor hudi-client to support multi-engine"}, "afterCommit": {"oid": "df2ffa1c2455538316551e9ecc71567d748ea3be", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/df2ffa1c2455538316551e9ecc71567d748ea3be", "committedDate": "2020-09-23T12:55:13Z", "message": "[HUDI-1089] Refactor hudi-client to support multi-engine"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "df2ffa1c2455538316551e9ecc71567d748ea3be", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/df2ffa1c2455538316551e9ecc71567d748ea3be", "committedDate": "2020-09-23T12:55:13Z", "message": "[HUDI-1089] Refactor hudi-client to support multi-engine"}, "afterCommit": {"oid": "20f3a866ebb92c7db34d4c8d15fbebee4e78016c", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/20f3a866ebb92c7db34d4c8d15fbebee4e78016c", "committedDate": "2020-09-23T13:13:58Z", "message": "[HUDI-1089] Refactor hudi-client to support multi-engine"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "20f3a866ebb92c7db34d4c8d15fbebee4e78016c", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/20f3a866ebb92c7db34d4c8d15fbebee4e78016c", "committedDate": "2020-09-23T13:13:58Z", "message": "[HUDI-1089] Refactor hudi-client to support multi-engine"}, "afterCommit": {"oid": "cab19a136418580dd69fc794787b63b07b372d08", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/cab19a136418580dd69fc794787b63b07b372d08", "committedDate": "2020-09-23T13:55:46Z", "message": "[HUDI-1089] Refactor hudi-client to support multi-engine"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MTUwOTMz", "url": "https://github.com/apache/hudi/pull/1827#pullrequestreview-495150933", "createdAt": "2020-09-24T00:55:55Z", "commit": {"oid": "cab19a136418580dd69fc794787b63b07b372d08"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwMDo1NTo1NVrOHXGE5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwMDo1NTo1NVrOHXGE5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk3ODg1Mw==", "bodyText": "Actually, I am thinking hudi-spark-client and hudi-client-spark, which is better? Given there is a module named hudi-client-common. wdyt? @vinothchandar", "url": "https://github.com/apache/hudi/pull/1827#discussion_r493978853", "createdAt": "2020-09-24T00:55:55Z", "author": {"login": "yanghua"}, "path": "hudi-cli/pom.xml", "diffHunk": "@@ -148,7 +148,14 @@\n     </dependency>\n     <dependency>\n       <groupId>org.apache.hudi</groupId>\n-      <artifactId>hudi-client</artifactId>\n+      <artifactId>hudi-client-common</artifactId>\n+      <version>${project.version}</version>\n+      <scope>test</scope>\n+      <type>test-jar</type>\n+    </dependency>\n+    <dependency>\n+      <groupId>org.apache.hudi</groupId>\n+      <artifactId>hudi-spark-client</artifactId>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cab19a136418580dd69fc794787b63b07b372d08"}, "originalPosition": 12}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cab19a136418580dd69fc794787b63b07b372d08", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/cab19a136418580dd69fc794787b63b07b372d08", "committedDate": "2020-09-23T13:55:46Z", "message": "[HUDI-1089] Refactor hudi-client to support multi-engine"}, "afterCommit": {"oid": "e675a4f9fc20fb9fc6aa017d66fab3da372580c5", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/e675a4f9fc20fb9fc6aa017d66fab3da372580c5", "committedDate": "2020-09-24T01:36:37Z", "message": "[HUDI-1089] Refactor hudi-client to support multi-engine"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e675a4f9fc20fb9fc6aa017d66fab3da372580c5", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/e675a4f9fc20fb9fc6aa017d66fab3da372580c5", "committedDate": "2020-09-24T01:36:37Z", "message": "[HUDI-1089] Refactor hudi-client to support multi-engine"}, "afterCommit": {"oid": "f05a20cf78dcc5c06558c8e8827e62acede4c4bf", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/f05a20cf78dcc5c06558c8e8827e62acede4c4bf", "committedDate": "2020-09-24T01:48:25Z", "message": "[HUDI-1089] Refactor hudi-client to support multi-engine"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f05a20cf78dcc5c06558c8e8827e62acede4c4bf", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/f05a20cf78dcc5c06558c8e8827e62acede4c4bf", "committedDate": "2020-09-24T01:48:25Z", "message": "[HUDI-1089] Refactor hudi-client to support multi-engine"}, "afterCommit": {"oid": "131aa883ec95f2cef0f9d4493ac4549770f59e8b", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/131aa883ec95f2cef0f9d4493ac4549770f59e8b", "committedDate": "2020-09-24T01:54:53Z", "message": "[HUDI-1089] Refactor hudi-client to support multi-engine"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MTcxMDQ1", "url": "https://github.com/apache/hudi/pull/1827#pullrequestreview-495171045", "createdAt": "2020-09-24T02:06:03Z", "commit": {"oid": "131aa883ec95f2cef0f9d4493ac4549770f59e8b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwMjowNjowNFrOHXHKYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwMjowNjowNFrOHXHKYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk5NjY0Mg==", "bodyText": "Here, I used org.apache.hudi.common.util.SizeEstimator#sizeEstimate to replace org.apache.spark.util.SizeEstimator#estimate is it ok?  @vinothchandar", "url": "https://github.com/apache/hudi/pull/1827#discussion_r493996642", "createdAt": "2020-09-24T02:06:04Z", "author": {"login": "wangxianghu"}, "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/io/HoodieAppendHandle.java", "diffHunk": "@@ -134,7 +138,7 @@ private void init(HoodieRecord record) {\n       writeStatus.setPartitionPath(partitionPath);\n       writeStatus.getStat().setPartitionPath(partitionPath);\n       writeStatus.getStat().setFileId(fileId);\n-      averageRecordSize = SizeEstimator.estimate(record);\n+      averageRecordSize = sizeEstimator.sizeEstimate(record);\n       try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "131aa883ec95f2cef0f9d4493ac4549770f59e8b"}, "originalPosition": 68}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "131aa883ec95f2cef0f9d4493ac4549770f59e8b", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/131aa883ec95f2cef0f9d4493ac4549770f59e8b", "committedDate": "2020-09-24T01:54:53Z", "message": "[HUDI-1089] Refactor hudi-client to support multi-engine"}, "afterCommit": {"oid": "6ebd0e664ee5a159db7b2fd60ccce3978f26c9ee", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/6ebd0e664ee5a159db7b2fd60ccce3978f26c9ee", "committedDate": "2020-09-24T02:09:34Z", "message": "[HUDI-1089] Refactor hudi-client to support multi-engine"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6ebd0e664ee5a159db7b2fd60ccce3978f26c9ee", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/6ebd0e664ee5a159db7b2fd60ccce3978f26c9ee", "committedDate": "2020-09-24T02:09:34Z", "message": "[HUDI-1089] Refactor hudi-client to support multi-engine"}, "afterCommit": {"oid": "4199bcce2b1568383b685b2c188732e2adbc22b5", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/4199bcce2b1568383b685b2c188732e2adbc22b5", "committedDate": "2020-09-24T05:34:54Z", "message": "[HUDI-1089] Refactor hudi-client to support multi-engine"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4199bcce2b1568383b685b2c188732e2adbc22b5", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/4199bcce2b1568383b685b2c188732e2adbc22b5", "committedDate": "2020-09-24T05:34:54Z", "message": "[HUDI-1089] Refactor hudi-client to support multi-engine"}, "afterCommit": {"oid": "c24a47c9eae815337d7b7ad42695958a3afa9e3c", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/c24a47c9eae815337d7b7ad42695958a3afa9e3c", "committedDate": "2020-09-24T06:20:31Z", "message": "[HUDI-1089] Refactor hudi-client to support multi-engine"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c24a47c9eae815337d7b7ad42695958a3afa9e3c", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/c24a47c9eae815337d7b7ad42695958a3afa9e3c", "committedDate": "2020-09-24T06:20:31Z", "message": "[HUDI-1089] Refactor hudi-client to support multi-engine"}, "afterCommit": {"oid": "9737063a0845f5c0525f054095dab463bcdc423f", "author": {"user": {"login": "vinothchandar", "name": "vinoth chandar"}}, "url": "https://github.com/apache/hudi/commit/9737063a0845f5c0525f054095dab463bcdc423f", "committedDate": "2020-09-28T01:08:28Z", "message": "Code Review Comments\n\n* Renaming HoodieSparkAsyncCompactService to SparkAsyncCompactService\n* Bug in SparkStreamingAsyncCompactService of not calling the super constructor with daemon mode.\n* Rename methods in HoodieEngineContext to setJobStatus() and setProperty()\n* Rename common packages to under client.common package\n* Bug in HoodieMergeHandle and compactor not getting the right merge memory"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1OTk2ODgx", "url": "https://github.com/apache/hudi/pull/1827#pullrequestreview-495996881", "createdAt": "2020-09-24T22:37:33Z", "commit": {"oid": "c24a47c9eae815337d7b7ad42695958a3afa9e3c"}, "state": "COMMENTED", "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQyMjozNzozM1rOHXu8SA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QxODoxODoxMVrOHYpBRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY0ODM5Mg==", "bodyText": "can we replace more of the code to direclty just use HoodieTable instead. Need to examine cases that need an explicit HoodieSparkTable", "url": "https://github.com/apache/hudi/pull/1827#discussion_r494648392", "createdAt": "2020-09-24T22:37:33Z", "author": {"login": "vinothchandar"}, "path": "hudi-cli/src/test/java/org/apache/hudi/cli/commands/TestArchivedCommitsCommand.java", "diffHunk": "@@ -92,8 +93,9 @@ public void init() throws IOException {\n     metaClient.getActiveTimeline().reload().getAllCommitsTimeline().filterCompletedInstants();\n \n     // archive\n-    HoodieTimelineArchiveLog archiveLog = new HoodieTimelineArchiveLog(cfg, hadoopConf);\n-    archiveLog.archiveIfRequired(jsc);\n+    HoodieSparkTable table = HoodieSparkTable.create(cfg, context, metaClient);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c24a47c9eae815337d7b7ad42695958a3afa9e3c"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY0ODg1Nw==", "bodyText": "just like this, we should try to  use the abstract class as much as we can", "url": "https://github.com/apache/hudi/pull/1827#discussion_r494648857", "createdAt": "2020-09-24T22:38:54Z", "author": {"login": "vinothchandar"}, "path": "hudi-cli/src/test/java/org/apache/hudi/cli/commands/TestRollbacksCommand.java", "diffHunk": "@@ -88,7 +88,7 @@ public void init() throws IOException {\n     HoodieWriteConfig config = HoodieWriteConfig.newBuilder().withPath(tablePath)\n         .withIndexConfig(HoodieIndexConfig.newBuilder().withIndexType(HoodieIndex.IndexType.INMEMORY).build()).build();\n \n-    try (HoodieWriteClient client = getHoodieWriteClient(config)) {\n+    try (AbstractHoodieWriteClient client = getHoodieWriteClient(config)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c24a47c9eae815337d7b7ad42695958a3afa9e3c"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY0OTg0MQ==", "bodyText": "Need to ensure there are no side effects in the pom due to this. i.e something that can affect bundles so forth.", "url": "https://github.com/apache/hudi/pull/1827#discussion_r494649841", "createdAt": "2020-09-24T22:41:47Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/pom.xml", "diffHunk": "@@ -24,294 +24,14 @@\n   <modelVersion>4.0.0</modelVersion>\n \n   <artifactId>hudi-client</artifactId>\n-  <packaging>jar</packaging>\n+  <packaging>pom</packaging>\n \n   <properties>\n     <main.basedir>${project.parent.basedir}</main.basedir>\n   </properties>\n \n-  <build>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c24a47c9eae815337d7b7ad42695958a3afa9e3c"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDc0NjE5Ng==", "bodyText": "this was actually same. fixing it", "url": "https://github.com/apache/hudi/pull/1827#discussion_r494746196", "createdAt": "2020-09-25T04:52:38Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/client/AbstractHoodieWriteClient.java", "diffHunk": "@@ -716,32 +669,95 @@ private void rollbackPendingCommits() {\n    * @param compactionInstantTime Compaction Instant Time\n    * @return RDD of Write Status\n    */\n-  private JavaRDD<WriteStatus> compact(String compactionInstantTime, boolean shouldComplete) {\n-    HoodieTable<T> table = HoodieTable.create(config, hadoopConf);\n-    HoodieTimeline pendingCompactionTimeline = table.getActiveTimeline().filterPendingCompactionTimeline();\n-    HoodieInstant inflightInstant = HoodieTimeline.getCompactionInflightInstant(compactionInstantTime);\n-    if (pendingCompactionTimeline.containsInstant(inflightInstant)) {\n-      rollbackInflightCompaction(inflightInstant, table);\n-      table.getMetaClient().reloadActiveTimeline();\n-    }\n-    compactionTimer = metrics.getCompactionCtx();\n-    HoodieWriteMetadata compactionMetadata = table.compact(jsc, compactionInstantTime);\n-    JavaRDD<WriteStatus> statuses = compactionMetadata.getWriteStatuses();\n-    if (shouldComplete && compactionMetadata.getCommitMetadata().isPresent()) {\n-      completeCompaction(compactionMetadata.getCommitMetadata().get(), statuses, table, compactionInstantTime);\n-    }\n-    return statuses;\n-  }\n+  protected abstract O compact(String compactionInstantTime, boolean shouldComplete);\n \n   /**\n    * Performs a compaction operation on a table, serially before or after an insert/upsert action.\n    */\n-  private Option<String> inlineCompact(Option<Map<String, String>> extraMetadata) {\n+  protected Option<String> inlineCompact(Option<Map<String, String>> extraMetadata) {\n     Option<String> compactionInstantTimeOpt = scheduleCompaction(extraMetadata);\n     compactionInstantTimeOpt.ifPresent(compactionInstantTime -> {\n       // inline compaction should auto commit as the user is never given control\n       compact(compactionInstantTime, true);\n     });\n     return compactionInstantTimeOpt;\n   }\n+\n+  /**\n+   * Finalize Write operation.\n+   *\n+   * @param table HoodieTable\n+   * @param instantTime Instant Time\n+   * @param stats Hoodie Write Stat\n+   */\n+  protected void finalizeWrite(HoodieTable<T, I, K, O, P> table, String instantTime, List<HoodieWriteStat> stats) {\n+    try {\n+      final Timer.Context finalizeCtx = metrics.getFinalizeCtx();\n+      table.finalizeWrite(context, instantTime, stats);\n+      if (finalizeCtx != null) {\n+        Option<Long> durationInMs = Option.of(metrics.getDurationInMs(finalizeCtx.stop()));\n+        durationInMs.ifPresent(duration -> {\n+          LOG.info(\"Finalize write elapsed time (milliseconds): \" + duration);\n+          metrics.updateFinalizeWriteMetrics(duration, stats.size());\n+        });\n+      }\n+    } catch (HoodieIOException ioe) {\n+      throw new HoodieCommitException(\"Failed to complete commit \" + instantTime + \" due to finalize errors.\", ioe);\n+    }\n+  }\n+\n+  public HoodieMetrics getMetrics() {\n+    return metrics;\n+  }\n+\n+  public HoodieIndex<T, I, K, O, P> getIndex() {\n+    return index;\n+  }\n+\n+  /**\n+   * Get HoodieTable and init {@link Timer.Context}.\n+   *\n+   * @param operationType write operation type\n+   * @param instantTime current inflight instant time\n+   * @return HoodieTable\n+   */\n+  protected abstract HoodieTable<T, I, K, O, P> getTableAndInitCtx(WriteOperationType operationType, String instantTime);\n+\n+  /**\n+   * Sets write schema from last instant since deletes may not have schema set in the config.\n+   */\n+  protected void setWriteSchemaForDeletes(HoodieTableMetaClient metaClient) {\n+    try {\n+      HoodieActiveTimeline activeTimeline = metaClient.getActiveTimeline();\n+      Option<HoodieInstant> lastInstant =\n+          activeTimeline.filterCompletedInstants().filter(s -> s.getAction().equals(metaClient.getCommitActionType()))\n+              .lastInstant();\n+      if (lastInstant.isPresent()) {\n+        HoodieCommitMetadata commitMetadata = HoodieCommitMetadata.fromBytes(\n+            activeTimeline.getInstantDetails(lastInstant.get()).get(), HoodieCommitMetadata.class);\n+        if (commitMetadata.getExtraMetadata().containsKey(HoodieCommitMetadata.SCHEMA_KEY)) {\n+          config.setSchema(commitMetadata.getExtraMetadata().get(HoodieCommitMetadata.SCHEMA_KEY));\n+        } else {\n+          throw new HoodieIOException(\"Latest commit does not have any schema in commit metadata\");\n+        }\n+      } else {\n+        throw new HoodieIOException(\"Deletes issued without any prior commits\");\n+      }\n+    } catch (IOException e) {\n+      throw new HoodieIOException(\"IOException thrown while reading last commit metadata\", e);\n+    }\n+  }\n+\n+  @Override\n+  public void close() {\n+    // Stop timeline-server if running\n+    super.close();\n+    // Calling this here releases any resources used by your index, so make sure to finish any related operations\n+    // before this point\n+    this.index.close();\n+\n+    // release AsyncCleanerService\n+    AsyncCleanerService.forceShutdown(asyncCleanerService);\n+    asyncCleanerService = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c24a47c9eae815337d7b7ad42695958a3afa9e3c"}, "originalPosition": 839}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDc0NzUxOQ==", "bodyText": "this needs to be removed. but not the issue for this PR to be bothered about may be", "url": "https://github.com/apache/hudi/pull/1827#discussion_r494747519", "createdAt": "2020-09-25T04:58:30Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/client/AbstractHoodieWriteClient.java", "diffHunk": "@@ -716,32 +669,95 @@ private void rollbackPendingCommits() {\n    * @param compactionInstantTime Compaction Instant Time\n    * @return RDD of Write Status\n    */\n-  private JavaRDD<WriteStatus> compact(String compactionInstantTime, boolean shouldComplete) {\n-    HoodieTable<T> table = HoodieTable.create(config, hadoopConf);\n-    HoodieTimeline pendingCompactionTimeline = table.getActiveTimeline().filterPendingCompactionTimeline();\n-    HoodieInstant inflightInstant = HoodieTimeline.getCompactionInflightInstant(compactionInstantTime);\n-    if (pendingCompactionTimeline.containsInstant(inflightInstant)) {\n-      rollbackInflightCompaction(inflightInstant, table);\n-      table.getMetaClient().reloadActiveTimeline();\n-    }\n-    compactionTimer = metrics.getCompactionCtx();\n-    HoodieWriteMetadata compactionMetadata = table.compact(jsc, compactionInstantTime);\n-    JavaRDD<WriteStatus> statuses = compactionMetadata.getWriteStatuses();\n-    if (shouldComplete && compactionMetadata.getCommitMetadata().isPresent()) {\n-      completeCompaction(compactionMetadata.getCommitMetadata().get(), statuses, table, compactionInstantTime);\n-    }\n-    return statuses;\n-  }\n+  protected abstract O compact(String compactionInstantTime, boolean shouldComplete);\n \n   /**\n    * Performs a compaction operation on a table, serially before or after an insert/upsert action.\n    */\n-  private Option<String> inlineCompact(Option<Map<String, String>> extraMetadata) {\n+  protected Option<String> inlineCompact(Option<Map<String, String>> extraMetadata) {\n     Option<String> compactionInstantTimeOpt = scheduleCompaction(extraMetadata);\n     compactionInstantTimeOpt.ifPresent(compactionInstantTime -> {\n       // inline compaction should auto commit as the user is never given control\n       compact(compactionInstantTime, true);\n     });\n     return compactionInstantTimeOpt;\n   }\n+\n+  /**\n+   * Finalize Write operation.\n+   *\n+   * @param table HoodieTable\n+   * @param instantTime Instant Time\n+   * @param stats Hoodie Write Stat\n+   */\n+  protected void finalizeWrite(HoodieTable<T, I, K, O, P> table, String instantTime, List<HoodieWriteStat> stats) {\n+    try {\n+      final Timer.Context finalizeCtx = metrics.getFinalizeCtx();\n+      table.finalizeWrite(context, instantTime, stats);\n+      if (finalizeCtx != null) {\n+        Option<Long> durationInMs = Option.of(metrics.getDurationInMs(finalizeCtx.stop()));\n+        durationInMs.ifPresent(duration -> {\n+          LOG.info(\"Finalize write elapsed time (milliseconds): \" + duration);\n+          metrics.updateFinalizeWriteMetrics(duration, stats.size());\n+        });\n+      }\n+    } catch (HoodieIOException ioe) {\n+      throw new HoodieCommitException(\"Failed to complete commit \" + instantTime + \" due to finalize errors.\", ioe);\n+    }\n+  }\n+\n+  public HoodieMetrics getMetrics() {\n+    return metrics;\n+  }\n+\n+  public HoodieIndex<T, I, K, O, P> getIndex() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c24a47c9eae815337d7b7ad42695958a3afa9e3c"}, "originalPosition": 791}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDc0NzY1MQ==", "bodyText": "Understood", "url": "https://github.com/apache/hudi/pull/1827#discussion_r494747651", "createdAt": "2020-09-25T04:59:10Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/client/AbstractHoodieWriteClient.java", "diffHunk": "@@ -18,120 +18,195 @@\n \n package org.apache.hudi.client;\n \n+import com.codahale.metrics.Timer;\n+import org.apache.hadoop.conf.Configuration;\n import org.apache.hudi.avro.model.HoodieCleanMetadata;\n import org.apache.hudi.avro.model.HoodieCompactionPlan;\n import org.apache.hudi.avro.model.HoodieRestoreMetadata;\n import org.apache.hudi.avro.model.HoodieRollbackMetadata;\n-import org.apache.hudi.client.embedded.EmbeddedTimelineService;\n+import org.apache.hudi.callback.HoodieWriteCommitCallback;\n+import org.apache.hudi.callback.common.HoodieWriteCommitCallbackMessage;\n+import org.apache.hudi.callback.util.HoodieCommitCallbackFactory;\n+import org.apache.hudi.client.embebbed.BaseEmbeddedTimelineService;\n+import org.apache.hudi.common.HoodieEngineContext;\n import org.apache.hudi.common.model.HoodieCommitMetadata;\n import org.apache.hudi.common.model.HoodieKey;\n-import org.apache.hudi.common.model.HoodieRecord;\n import org.apache.hudi.common.model.HoodieRecordPayload;\n import org.apache.hudi.common.model.HoodieWriteStat;\n import org.apache.hudi.common.model.WriteOperationType;\n import org.apache.hudi.common.table.HoodieTableMetaClient;\n import org.apache.hudi.common.table.timeline.HoodieActiveTimeline;\n import org.apache.hudi.common.table.timeline.HoodieInstant;\n-import org.apache.hudi.common.table.timeline.HoodieInstant.State;\n import org.apache.hudi.common.table.timeline.HoodieTimeline;\n import org.apache.hudi.common.util.Option;\n import org.apache.hudi.common.util.ValidationUtils;\n-import org.apache.hudi.config.HoodieCompactionConfig;\n import org.apache.hudi.config.HoodieWriteConfig;\n+\n import org.apache.hudi.exception.HoodieCommitException;\n import org.apache.hudi.exception.HoodieIOException;\n import org.apache.hudi.exception.HoodieRestoreException;\n import org.apache.hudi.exception.HoodieRollbackException;\n import org.apache.hudi.exception.HoodieSavepointException;\n import org.apache.hudi.index.HoodieIndex;\n import org.apache.hudi.metrics.HoodieMetrics;\n-import org.apache.hudi.table.HoodieTable;\n-import org.apache.hudi.table.HoodieTimelineArchiveLog;\n-import org.apache.hudi.table.MarkerFiles;\n import org.apache.hudi.table.BulkInsertPartitioner;\n+import org.apache.hudi.table.HoodieTable;\n import org.apache.hudi.table.action.HoodieWriteMetadata;\n-import org.apache.hudi.table.action.compact.CompactHelpers;\n import org.apache.hudi.table.action.savepoint.SavepointHelpers;\n-\n-import com.codahale.metrics.Timer;\n import org.apache.log4j.LogManager;\n import org.apache.log4j.Logger;\n-import org.apache.spark.SparkConf;\n-import org.apache.spark.api.java.JavaRDD;\n-import org.apache.spark.api.java.JavaSparkContext;\n \n import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n import java.text.ParseException;\n import java.util.Collection;\n import java.util.List;\n import java.util.Map;\n import java.util.stream.Collectors;\n \n /**\n- * Hoodie Write Client helps you build tables on HDFS [insert()] and then perform efficient mutations on an HDFS\n- * table [upsert()]\n- * <p>\n- * Note that, at any given time, there can only be one Spark job performing these operations on a Hoodie table.\n+ * Abstract Write Client providing functionality for performing commit, index updates and rollback\n+ * Reused for regular write operations like upsert/insert/bulk-insert.. as well as bootstrap\n+ *\n+ * @param <T> Sub type of HoodieRecordPayload\n+ * @param <I> Type of inputs\n+ * @param <K> Type of keys\n+ * @param <O> Type of outputs\n+ * @param <P> Type of record position [Key, Option[partitionPath, fileID]] in hoodie table\n  */\n-public class HoodieWriteClient<T extends HoodieRecordPayload> extends AbstractHoodieWriteClient<T> {\n-\n+public abstract class AbstractHoodieWriteClient<T extends HoodieRecordPayload, I, K, O, P> extends AbstractHoodieClient {\n   private static final long serialVersionUID = 1L;\n-  private static final Logger LOG = LogManager.getLogger(HoodieWriteClient.class);\n-  private static final String LOOKUP_STR = \"lookup\";\n-  private final boolean rollbackPending;\n-  private final transient HoodieMetrics metrics;\n-  private transient Timer.Context compactionTimer;\n+  private static final Logger LOG = LogManager.getLogger(AbstractHoodieWriteClient.class);\n+\n+  protected final transient HoodieMetrics metrics;\n+  private final transient HoodieIndex<T, I, K, O, P> index;\n+\n+  protected transient Timer.Context writeContext = null;\n+  private transient WriteOperationType operationType;\n+  private transient HoodieWriteCommitCallback commitCallback;\n+\n+  protected static final String LOOKUP_STR = \"lookup\";\n+  protected final boolean rollbackPending;\n+  protected transient Timer.Context compactionTimer;\n   private transient AsyncCleanerService asyncCleanerService;\n \n+  public void setOperationType(WriteOperationType operationType) {\n+    this.operationType = operationType;\n+  }\n+\n+  public WriteOperationType getOperationType() {\n+    return this.operationType;\n+  }\n+\n   /**\n    * Create a write client, without cleaning up failed/inflight commits.\n    *\n-   * @param jsc Java Spark Context\n+   * @param context      Java Spark Context\n    * @param clientConfig instance of HoodieWriteConfig\n    */\n-  public HoodieWriteClient(JavaSparkContext jsc, HoodieWriteConfig clientConfig) {\n-    this(jsc, clientConfig, false);\n+  public AbstractHoodieWriteClient(HoodieEngineContext context, HoodieWriteConfig clientConfig) {\n+    this(context, clientConfig, false);\n   }\n \n   /**\n    * Create a write client, with new hudi index.\n    *\n-   * @param jsc Java Spark Context\n-   * @param writeConfig instance of HoodieWriteConfig\n+   * @param context         HoodieEngineContext\n+   * @param writeConfig     instance of HoodieWriteConfig\n    * @param rollbackPending whether need to cleanup pending commits\n    */\n-  public HoodieWriteClient(JavaSparkContext jsc, HoodieWriteConfig writeConfig, boolean rollbackPending) {\n-    this(jsc, writeConfig, rollbackPending, HoodieIndex.createIndex(writeConfig));\n-  }\n-\n-  public HoodieWriteClient(JavaSparkContext jsc, HoodieWriteConfig writeConfig, boolean rollbackPending, HoodieIndex index) {\n-    this(jsc, writeConfig, rollbackPending, index, Option.empty());\n+  public AbstractHoodieWriteClient(HoodieEngineContext context, HoodieWriteConfig writeConfig, boolean rollbackPending) {\n+    this(context, writeConfig, rollbackPending, Option.empty());\n   }\n \n   /**\n-   *  Create a write client, allows to specify all parameters.\n+   * Create a write client, allows to specify all parameters.\n    *\n-   * @param jsc Java Spark Context\n-   * @param writeConfig instance of HoodieWriteConfig\n+   * @param context         HoodieEngineContext\n+   * @param writeConfig     instance of HoodieWriteConfig\n    * @param rollbackPending whether need to cleanup pending commits\n    * @param timelineService Timeline Service that runs as part of write client.\n    */\n-  public HoodieWriteClient(JavaSparkContext jsc, HoodieWriteConfig writeConfig, boolean rollbackPending,\n-      HoodieIndex index, Option<EmbeddedTimelineService> timelineService) {\n-    super(jsc, index, writeConfig, timelineService);\n+  public AbstractHoodieWriteClient(HoodieEngineContext context, HoodieWriteConfig writeConfig, boolean rollbackPending,\n+                                   Option<BaseEmbeddedTimelineService> timelineService) {\n+    super(context, writeConfig, timelineService);\n     this.metrics = new HoodieMetrics(config, config.getTableName());\n     this.rollbackPending = rollbackPending;\n+    this.index = createIndex(writeConfig);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDA4MzIxNg=="}, "originalCommit": {"oid": "28eecab55cb62bb602e6ed7fe1cb9d5b188a87df"}, "originalPosition": 159}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIzNTI3MQ==", "bodyText": "this cannot be configurable. yarn/k8s will decide the actual driver host. changing it to how it was before", "url": "https://github.com/apache/hudi/pull/1827#discussion_r495235271", "createdAt": "2020-09-25T21:14:01Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/config/HoodieWriteConfig.java", "diffHunk": "@@ -100,6 +99,7 @@\n \n   public static final String EMBEDDED_TIMELINE_SERVER_ENABLED = \"hoodie.embed.timeline.server\";\n   public static final String DEFAULT_EMBEDDED_TIMELINE_SERVER_ENABLED = \"true\";\n+  public static final String EMBEDDED_TIMELINE_SERVER_HOST = \"hoodie.embed.timeline.server.host\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c24a47c9eae815337d7b7ad42695958a3afa9e3c"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU5OTU4Mw==", "bodyText": "we are missing the dependency we had on hbase-client and hbase-server here. Will punt for now, as it will get picked up from hudi-common.", "url": "https://github.com/apache/hudi/pull/1827#discussion_r495599583", "createdAt": "2020-09-27T18:14:20Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-client-common/pom.xml", "diffHunk": "@@ -0,0 +1,264 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<!--\n+  Licensed to the Apache Software Foundation (ASF) under one or more\n+  contributor license agreements.  See the NOTICE file distributed with\n+  this work for additional information regarding copyright ownership.\n+  The ASF licenses this file to You under the Apache License, Version 2.0\n+  (the \"License\"); you may not use this file except in compliance with\n+  the License.  You may obtain a copy of the License at\n+\n+       http://www.apache.org/licenses/LICENSE-2.0\n+\n+  Unless required by applicable law or agreed to in writing, software\n+  distributed under the License is distributed on an \"AS IS\" BASIS,\n+  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+  See the License for the specific language governing permissions and\n+  limitations under the License.\n+-->\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c24a47c9eae815337d7b7ad42695958a3afa9e3c"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU5OTk0MA==", "bodyText": "this is a problem. it changes behavior and needs to be reworked.", "url": "https://github.com/apache/hudi/pull/1827#discussion_r495599940", "createdAt": "2020-09-27T18:18:11Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/io/HoodieMergeHandle.java", "diffHunk": "@@ -149,7 +148,7 @@ private void init(String fileId, String partitionPath, HoodieBaseFile baseFileTo\n   private void init(String fileId, Iterator<HoodieRecord<T>> newRecordsItr) {\n     try {\n       // Load the new records in a map\n-      long memoryForMerge = SparkConfigUtils.getMaxMemoryPerPartitionMerge(config.getProps());\n+      long memoryForMerge = config.getMaxMemoryPerPartitionMerge();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c24a47c9eae815337d7b7ad42695958a3afa9e3c"}, "originalPosition": 61}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9737063a0845f5c0525f054095dab463bcdc423f", "author": {"user": {"login": "vinothchandar", "name": "vinoth chandar"}}, "url": "https://github.com/apache/hudi/commit/9737063a0845f5c0525f054095dab463bcdc423f", "committedDate": "2020-09-28T01:08:28Z", "message": "Code Review Comments\n\n* Renaming HoodieSparkAsyncCompactService to SparkAsyncCompactService\n* Bug in SparkStreamingAsyncCompactService of not calling the super constructor with daemon mode.\n* Rename methods in HoodieEngineContext to setJobStatus() and setProperty()\n* Rename common packages to under client.common package\n* Bug in HoodieMergeHandle and compactor not getting the right merge memory"}, "afterCommit": {"oid": "c205bce39d13665e7393b743257d49a78d5f5f20", "author": {"user": {"login": "vinothchandar", "name": "vinoth chandar"}}, "url": "https://github.com/apache/hudi/commit/c205bce39d13665e7393b743257d49a78d5f5f20", "committedDate": "2020-09-28T16:37:54Z", "message": "Code Review Comments\n\n* Renaming HoodieSparkAsyncCompactService to SparkAsyncCompactService\n* Bug in SparkStreamingAsyncCompactService of not calling the super constructor with daemon mode.\n* Rename methods in HoodieEngineContext to setJobStatus() and setProperty()\n* Rename common packages to under client.common package\n* Bug in HoodieMergeHandle and compactor not getting the right merge memory"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3ODUwMzc3", "url": "https://github.com/apache/hudi/pull/1827#pullrequestreview-497850377", "createdAt": "2020-09-28T19:56:44Z", "commit": {"oid": "c205bce39d13665e7393b743257d49a78d5f5f20"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c205bce39d13665e7393b743257d49a78d5f5f20", "author": {"user": {"login": "vinothchandar", "name": "vinoth chandar"}}, "url": "https://github.com/apache/hudi/commit/c205bce39d13665e7393b743257d49a78d5f5f20", "committedDate": "2020-09-28T16:37:54Z", "message": "Code Review Comments\n\n* Renaming HoodieSparkAsyncCompactService to SparkAsyncCompactService\n* Bug in SparkStreamingAsyncCompactService of not calling the super constructor with daemon mode.\n* Rename methods in HoodieEngineContext to setJobStatus() and setProperty()\n* Rename common packages to under client.common package\n* Bug in HoodieMergeHandle and compactor not getting the right merge memory"}, "afterCommit": {"oid": "c158dee14355ec3cb24d1b16cb2fd7a84508fd44", "author": {"user": {"login": "vinothchandar", "name": "vinoth chandar"}}, "url": "https://github.com/apache/hudi/commit/c158dee14355ec3cb24d1b16cb2fd7a84508fd44", "committedDate": "2020-09-28T20:56:04Z", "message": "Code Review Comments\n\n* Renaming HoodieSparkAsyncCompactService to SparkAsyncCompactService\n* Bug in SparkStreamingAsyncCompactService of not calling the super constructor with daemon mode.\n* Rename methods in HoodieEngineContext to setJobStatus() and setProperty()\n* Rename common packages to under client.common package\n* Bug in HoodieMergeHandle and compactor not getting the right merge memory"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9dd4a0503f52fd0668c99fe48036553a61137210", "author": {"user": {"login": "vinothchandar", "name": "vinoth chandar"}}, "url": "https://github.com/apache/hudi/commit/9dd4a0503f52fd0668c99fe48036553a61137210", "committedDate": "2020-09-30T00:45:33Z", "message": "More code review changes\n\n* Making HoodieSnapshotCopier/HoodieSnapshotExporter all use HoodieContext\n* More replacements of jsc.parallelize across hudi-spark-client"}, "afterCommit": {"oid": "bcf84a65661c9bdb517e4d982f10bc4ca14ad623", "author": {"user": {"login": "vinothchandar", "name": "vinoth chandar"}}, "url": "https://github.com/apache/hudi/commit/bcf84a65661c9bdb517e4d982f10bc4ca14ad623", "committedDate": "2020-09-30T00:50:45Z", "message": "More code review changes\n\n* Making HoodieSnapshotCopier/HoodieSnapshotExporter all use HoodieContext\n* More replacements of jsc.parallelize across hudi-spark-client\n* More replacements of jsc.setJobGroup across hudi-spark-client"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b67ee14568ceb0bc0519594de42a20f6972ce2c0", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/b67ee14568ceb0bc0519594de42a20f6972ce2c0", "committedDate": "2020-09-30T23:53:10Z", "message": "[HUDI-1089] Refactor hudi-client to support multi-engine"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd5d75ec4eb8594f37b37f5cb78cdb0d0d138713", "author": {"user": {"login": "vinothchandar", "name": "vinoth chandar"}}, "url": "https://github.com/apache/hudi/commit/cd5d75ec4eb8594f37b37f5cb78cdb0d0d138713", "committedDate": "2020-10-01T04:48:20Z", "message": "Code Review Comments\n\n* Renaming HoodieSparkAsyncCompactService to SparkAsyncCompactService\n* Bug in SparkStreamingAsyncCompactService of not calling the super constructor with daemon mode.\n* Rename methods in HoodieEngineContext to setJobStatus() and setProperty()\n* Rename common packages to under client.common package\n* Bug in HoodieMergeHandle and compactor not getting the right merge memory"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bcf84a65661c9bdb517e4d982f10bc4ca14ad623", "author": {"user": {"login": "vinothchandar", "name": "vinoth chandar"}}, "url": "https://github.com/apache/hudi/commit/bcf84a65661c9bdb517e4d982f10bc4ca14ad623", "committedDate": "2020-09-30T00:50:45Z", "message": "More code review changes\n\n* Making HoodieSnapshotCopier/HoodieSnapshotExporter all use HoodieContext\n* More replacements of jsc.parallelize across hudi-spark-client\n* More replacements of jsc.setJobGroup across hudi-spark-client"}, "afterCommit": {"oid": "6c66d499ba941cbf0ed4e9f04a9256561fa55e9b", "author": {"user": {"login": "vinothchandar", "name": "vinoth chandar"}}, "url": "https://github.com/apache/hudi/commit/6c66d499ba941cbf0ed4e9f04a9256561fa55e9b", "committedDate": "2020-10-01T04:48:20Z", "message": "More code review changes\n\n* Making HoodieSnapshotCopier/HoodieSnapshotExporter all use HoodieContext\n* More replacements of jsc.parallelize across hudi-spark-client\n* More replacements of jsc.setJobGroup across hudi-spark-client"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6c66d499ba941cbf0ed4e9f04a9256561fa55e9b", "author": {"user": {"login": "vinothchandar", "name": "vinoth chandar"}}, "url": "https://github.com/apache/hudi/commit/6c66d499ba941cbf0ed4e9f04a9256561fa55e9b", "committedDate": "2020-10-01T04:48:20Z", "message": "More code review changes\n\n* Making HoodieSnapshotCopier/HoodieSnapshotExporter all use HoodieContext\n* More replacements of jsc.parallelize across hudi-spark-client\n* More replacements of jsc.setJobGroup across hudi-spark-client"}, "afterCommit": {"oid": "8b0670588e9d2d4454f5be0cf2dbbb28884e0cec", "author": {"user": {"login": "vinothchandar", "name": "vinoth chandar"}}, "url": "https://github.com/apache/hudi/commit/8b0670588e9d2d4454f5be0cf2dbbb28884e0cec", "committedDate": "2020-10-01T05:24:56Z", "message": "More code review changes\n\n* Making HoodieSnapshotCopier/HoodieSnapshotExporter all use HoodieContext\n* More replacements of jsc.parallelize across hudi-spark-client\n* More replacements of jsc.setJobGroup across hudi-spark-client"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8b0670588e9d2d4454f5be0cf2dbbb28884e0cec", "author": {"user": {"login": "vinothchandar", "name": "vinoth chandar"}}, "url": "https://github.com/apache/hudi/commit/8b0670588e9d2d4454f5be0cf2dbbb28884e0cec", "committedDate": "2020-10-01T05:24:56Z", "message": "More code review changes\n\n* Making HoodieSnapshotCopier/HoodieSnapshotExporter all use HoodieContext\n* More replacements of jsc.parallelize across hudi-spark-client\n* More replacements of jsc.setJobGroup across hudi-spark-client"}, "afterCommit": {"oid": "8512cac40d6990e6ce3276bee7c63907c6d5d96c", "author": {"user": {"login": "vinothchandar", "name": "vinoth chandar"}}, "url": "https://github.com/apache/hudi/commit/8512cac40d6990e6ce3276bee7c63907c6d5d96c", "committedDate": "2020-10-01T05:35:28Z", "message": "More code review changes\n\n* Making HoodieSnapshotCopier/HoodieSnapshotExporter all use HoodieContext\n* More replacements of jsc.parallelize across hudi-spark-client\n* More replacements of jsc.setJobGroup across hudi-spark-client"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8512cac40d6990e6ce3276bee7c63907c6d5d96c", "author": {"user": {"login": "vinothchandar", "name": "vinoth chandar"}}, "url": "https://github.com/apache/hudi/commit/8512cac40d6990e6ce3276bee7c63907c6d5d96c", "committedDate": "2020-10-01T05:35:28Z", "message": "More code review changes\n\n* Making HoodieSnapshotCopier/HoodieSnapshotExporter all use HoodieContext\n* More replacements of jsc.parallelize across hudi-spark-client\n* More replacements of jsc.setJobGroup across hudi-spark-client"}, "afterCommit": {"oid": "56690a5338b7cb0e10565544cbbd98daedd163c2", "author": {"user": {"login": "vinothchandar", "name": "vinoth chandar"}}, "url": "https://github.com/apache/hudi/commit/56690a5338b7cb0e10565544cbbd98daedd163c2", "committedDate": "2020-10-01T06:14:41Z", "message": "More code review changes\n\n* Making HoodieSnapshotCopier/HoodieSnapshotExporter all use HoodieContext\n* More replacements of jsc.parallelize across hudi-spark-client\n* More replacements of jsc.setJobGroup across hudi-spark-client"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "56690a5338b7cb0e10565544cbbd98daedd163c2", "author": {"user": {"login": "vinothchandar", "name": "vinoth chandar"}}, "url": "https://github.com/apache/hudi/commit/56690a5338b7cb0e10565544cbbd98daedd163c2", "committedDate": "2020-10-01T06:14:41Z", "message": "More code review changes\n\n* Making HoodieSnapshotCopier/HoodieSnapshotExporter all use HoodieContext\n* More replacements of jsc.parallelize across hudi-spark-client\n* More replacements of jsc.setJobGroup across hudi-spark-client"}, "afterCommit": {"oid": "c7b1cb1860496efcf90b2855e6b40600cb454efb", "author": {"user": {"login": "vinothchandar", "name": "vinoth chandar"}}, "url": "https://github.com/apache/hudi/commit/c7b1cb1860496efcf90b2855e6b40600cb454efb", "committedDate": "2020-10-01T06:41:31Z", "message": "More code review changes\n\n* Making HoodieSnapshotCopier/HoodieSnapshotExporter all use HoodieContext\n* More replacements of jsc.parallelize across hudi-spark-client\n* More replacements of jsc.setJobGroup across hudi-spark-client\n* Removing usages of HoodieIndex#fetchRecordLocation everywhere"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a79819a84ffb129574b218e4dd4c435f4e94b58", "author": {"user": {"login": "vinothchandar", "name": "vinoth chandar"}}, "url": "https://github.com/apache/hudi/commit/6a79819a84ffb129574b218e4dd4c435f4e94b58", "committedDate": "2020-10-01T06:52:52Z", "message": "More code review changes\n\n* Making HoodieSnapshotCopier/HoodieSnapshotExporter all use HoodieContext\n* More replacements of jsc.parallelize across hudi-spark-client\n* More replacements of jsc.setJobGroup across hudi-spark-client\n* Removing usages of HoodieIndex#fetchRecordLocation everywhere"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c7b1cb1860496efcf90b2855e6b40600cb454efb", "author": {"user": {"login": "vinothchandar", "name": "vinoth chandar"}}, "url": "https://github.com/apache/hudi/commit/c7b1cb1860496efcf90b2855e6b40600cb454efb", "committedDate": "2020-10-01T06:41:31Z", "message": "More code review changes\n\n* Making HoodieSnapshotCopier/HoodieSnapshotExporter all use HoodieContext\n* More replacements of jsc.parallelize across hudi-spark-client\n* More replacements of jsc.setJobGroup across hudi-spark-client\n* Removing usages of HoodieIndex#fetchRecordLocation everywhere"}, "afterCommit": {"oid": "6a79819a84ffb129574b218e4dd4c435f4e94b58", "author": {"user": {"login": "vinothchandar", "name": "vinoth chandar"}}, "url": "https://github.com/apache/hudi/commit/6a79819a84ffb129574b218e4dd4c435f4e94b58", "committedDate": "2020-10-01T06:52:52Z", "message": "More code review changes\n\n* Making HoodieSnapshotCopier/HoodieSnapshotExporter all use HoodieContext\n* More replacements of jsc.parallelize across hudi-spark-client\n* More replacements of jsc.setJobGroup across hudi-spark-client\n* Removing usages of HoodieIndex#fetchRecordLocation everywhere"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwMTE4MjQ1", "url": "https://github.com/apache/hudi/pull/1827#pullrequestreview-500118245", "createdAt": "2020-10-01T08:28:08Z", "commit": {"oid": "6a79819a84ffb129574b218e4dd4c435f4e94b58"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e33f73f70a65be635357e6fddc3053ac5a00694", "author": {"user": {"login": "vinothchandar", "name": "vinoth chandar"}}, "url": "https://github.com/apache/hudi/commit/7e33f73f70a65be635357e6fddc3053ac5a00694", "committedDate": "2020-10-01T08:34:51Z", "message": "Dropping HoodieIndex#fetchRecordLocation API\n\n* Not used by any other major API\n* Removing `P` from the templatized list of parameters"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "be83c080cdb7768dec660f8f3913b75b8cf4ce50", "author": {"user": {"login": "vinothchandar", "name": "vinoth chandar"}}, "url": "https://github.com/apache/hudi/commit/be83c080cdb7768dec660f8f3913b75b8cf4ce50", "committedDate": "2020-10-01T08:47:37Z", "message": "Renaming some Abstract* classes as Hoodie* to improve readability"}, "afterCommit": {"oid": "d99096df897e64ca200df2cd9ca269c327faebf1", "author": {"user": {"login": "vinothchandar", "name": "vinoth chandar"}}, "url": "https://github.com/apache/hudi/commit/d99096df897e64ca200df2cd9ca269c327faebf1", "committedDate": "2020-10-01T14:31:47Z", "message": "Renaming some Abstract* classes as Hoodie* to improve readability"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2954, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}