{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ0Mjg4MDAx", "number": 1792, "title": "[HUDI-802] Fixing deletes for inserts in same batch in write path", "bodyText": "What is the purpose of the pull request\nFixing deletes for inserts in same write batch.\nBrief change log\nIf same record is both inserted and deleted in same batch(possible when listening to events via deltastreamer), precombine will favor delete record. But then, in our OverwriteWithLatestAvroPayload, only combineAndGetUpdateValue checks for delete flag, where as getInsertValue does not. Hence the issue is that, for these cases, deleted records are still seen in read query.\nVerify this pull request\nThis change added tests and can be verified as follows:\n\nTestHoodieClientOnCopyOnWriteStorage#testDeletesForInsertsInSameBatch\n\nCommitter checklist\n\n\n Has a corresponding JIRA in PR title & commit\n\n\n Commit message is descriptive of the change\n\n\n CI is green\n\n\n Necessary doc changes done or have another open PR\n\n\n For large changes, please consider breaking it into sub-tasks under an umbrella JIRA.", "createdAt": "2020-07-04T14:00:53Z", "url": "https://github.com/apache/hudi/pull/1792", "merged": true, "mergeCommit": {"oid": "5b6026ba436f7bde0e810983b6934d07dbe46e8d"}, "closed": true, "closedAt": "2020-07-23T02:39:58Z", "author": {"login": "nsivabalan"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcyT5OmAFqTQ0MzIzMzg1Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc3ZFLcAFqTQ1MzIyNjI0OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzMjMzODUz", "url": "https://github.com/apache/hudi/pull/1792#pullrequestreview-443233853", "createdAt": "2020-07-06T16:32:59Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxNjozMjo1OVrOGteweA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxNjozMjo1OVrOGteweA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDM0MzAzMg==", "bodyText": "Trying to understand what we are really fixing here...\nIf there were an insert and delete in the same batch, precombining favors delete, then we actually skip the record and not do the insert?", "url": "https://github.com/apache/hudi/pull/1792#discussion_r450343032", "createdAt": "2020-07-06T16:32:59Z", "author": {"login": "vinothchandar"}, "path": "hudi-common/src/main/java/org/apache/hudi/common/model/OverwriteWithLatestAvroPayload.java", "diffHunk": "@@ -59,24 +59,28 @@ public OverwriteWithLatestAvroPayload preCombine(OverwriteWithLatestAvroPayload\n \n   @Override\n   public Option<IndexedRecord> combineAndGetUpdateValue(IndexedRecord currentValue, Schema schema) throws IOException {\n+    return getInsertValue(schema);\n+  }\n \n-    Option<IndexedRecord> recordOption = getInsertValue(schema);\n-    if (!recordOption.isPresent()) {\n+  @Override\n+  public Option<IndexedRecord> getInsertValue(Schema schema) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 10}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "28264931067eb20064e58452144a2bee448fcf13", "author": {"user": {"login": "nsivabalan", "name": "Sivabalan Narayanan"}}, "url": "https://github.com/apache/hudi/commit/28264931067eb20064e58452144a2bee448fcf13", "committedDate": "2020-07-10T11:46:56Z", "message": "Fixing deletes for inserts in same batch in write path"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34f31c4d68f21a0fb239f0508d0374e4d2ea3924", "author": {"user": {"login": "nsivabalan", "name": "Sivabalan Narayanan"}}, "url": "https://github.com/apache/hudi/commit/34f31c4d68f21a0fb239f0508d0374e4d2ea3924", "committedDate": "2020-07-22T03:23:48Z", "message": "Fixing deletes for inserts in same batch in write path"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c170bf35c122c2d4bb60fe4ed22ef8e9d6512245", "author": {"user": {"login": "nsivabalan", "name": "Sivabalan Narayanan"}}, "url": "https://github.com/apache/hudi/commit/c170bf35c122c2d4bb60fe4ed22ef8e9d6512245", "committedDate": "2020-07-22T03:23:53Z", "message": "Fixing delta streamer tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "715e6654a69368f1547787643697d0d893672eef", "author": {"user": {"login": "nsivabalan", "name": "Sivabalan Narayanan"}}, "url": "https://github.com/apache/hudi/commit/715e6654a69368f1547787643697d0d893672eef", "committedDate": "2020-07-22T03:17:20Z", "message": "Adding tests for OverwriteWithLatestAvroPayload"}, "afterCommit": {"oid": "d18b4096e82e31b34be73cf406b316296ee29f8f", "author": {"user": {"login": "nsivabalan", "name": "Sivabalan Narayanan"}}, "url": "https://github.com/apache/hudi/commit/d18b4096e82e31b34be73cf406b316296ee29f8f", "committedDate": "2020-07-22T03:23:53Z", "message": "Adding tests for OverwriteWithLatestAvroPayload"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyOTY4OTE2", "url": "https://github.com/apache/hudi/pull/1792#pullrequestreview-452968916", "createdAt": "2020-07-22T03:26:01Z", "commit": {"oid": "d18b4096e82e31b34be73cf406b316296ee29f8f"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa21405d06b884664a98a5d37ffec720214f5881", "author": {"user": {"login": "nsivabalan", "name": "Sivabalan Narayanan"}}, "url": "https://github.com/apache/hudi/commit/fa21405d06b884664a98a5d37ffec720214f5881", "committedDate": "2020-07-22T11:15:22Z", "message": "Adding tests for OverwriteWithLatestAvroPayload"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d18b4096e82e31b34be73cf406b316296ee29f8f", "author": {"user": {"login": "nsivabalan", "name": "Sivabalan Narayanan"}}, "url": "https://github.com/apache/hudi/commit/d18b4096e82e31b34be73cf406b316296ee29f8f", "committedDate": "2020-07-22T03:23:53Z", "message": "Adding tests for OverwriteWithLatestAvroPayload"}, "afterCommit": {"oid": "fa21405d06b884664a98a5d37ffec720214f5881", "author": {"user": {"login": "nsivabalan", "name": "Sivabalan Narayanan"}}, "url": "https://github.com/apache/hudi/commit/fa21405d06b884664a98a5d37ffec720214f5881", "committedDate": "2020-07-22T11:15:22Z", "message": "Adding tests for OverwriteWithLatestAvroPayload"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzMjI2MjQ4", "url": "https://github.com/apache/hudi/pull/1792#pullrequestreview-453226248", "createdAt": "2020-07-22T11:25:12Z", "commit": {"oid": "fa21405d06b884664a98a5d37ffec720214f5881"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2898, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}