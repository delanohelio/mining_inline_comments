{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM5MDQxMjU1", "number": 2332, "title": "[HUDI-1319] Make async operations work with metadata table", "bodyText": "Changes the syncing model to only move over completed instants on data timeline\nSyncing happens postCommit and on writeClient initialization\nLatest delta commit on the metadata table is sufficient as the watermark for data timeline archival\nCleaning/Compaction use a suffix to the last instant written to metadata table, such that we keep the 1-1\n.. mapping between data and metadata timelines.\nGot rid of a lot of the complexity around checking for valid commits during open of base/log files\nTests now use local FS, to simulate more failure scenarios\nSome failure scenarios exposed HUDI-1434, which is needed for MOR to work correctly\n\nTips\n\nThank you very much for contributing to Apache Hudi.\nPlease review https://hudi.apache.org/contributing.html before opening a pull request.\n\nWhat is the purpose of the pull request\n(For example: This pull request adds quick-start document.)\nBrief change log\n(for example:)\n\nModify AnnotationLocation checkstyle rule in checkstyle.xml\n\nVerify this pull request\n(Please pick either of the following options)\nThis pull request is a trivial rework / code cleanup without any test coverage.\n(or)\nThis pull request is already covered by existing tests, such as (please describe tests).\n(or)\nThis change added tests and can be verified as follows:\n(example:)\n\nAdded integration tests for end-to-end.\nAdded HoodieClientWriteTest to verify the change.\nManually verified the change by running a job locally.\n\nCommitter checklist\n\n\n Has a corresponding JIRA in PR title & commit\n\n\n Commit message is descriptive of the change\n\n\n CI is green\n\n\n Necessary doc changes done or have another open PR\n\n\n For large changes, please consider breaking it into sub-tasks under an umbrella JIRA.", "createdAt": "2020-12-13T23:22:35Z", "url": "https://github.com/apache/hudi/pull/2332", "merged": true, "mergeCommit": {"oid": "2e09aeca47a7f14cd83f644a5132d4dfd0f27813"}, "closed": true, "closedAt": "2020-12-16T03:36:24Z", "author": {"login": "vinothchandar"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdl5jA6AH2gAyNTM5MDQxMjU1Ojg2MmQ1MDFkM2UxZDI0N2RkODA4NmNlNWYyNWQxYWRhOTNjYmQ0ODY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmp2WnAFqTU1MzQxOTA1Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "862d501d3e1d247dd8086ce5f25d1ada93cbd486", "author": {"user": {"login": "vinothchandar", "name": "vinoth chandar"}}, "url": "https://github.com/apache/hudi/commit/862d501d3e1d247dd8086ce5f25d1ada93cbd486", "committedDate": "2020-12-13T23:15:16Z", "message": "[HUDI-1319] Make async operations work with metadata table\n\n - Changes the syncing model to only move over completed instants on data timeline\n - Syncing happens postCommit and on writeClient initialization\n - Latest delta commit on the metadata table is sufficient as the watermark for data timeline archival\n - Cleaning/Compaction use a suffix to the last instant written to metadata table, such that we keep the 1-1\n - .. mapping between data and metadata timelines.\n - Got rid of a lot of the complexity around checking for valid commits during open of base/log files\n - Tests now use local FS, to simulate more failure scenarios\n - Some failure scenarios exposed HUDI-1434, which is needed for MOR to work correctly"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzNDA1OTAy", "url": "https://github.com/apache/hudi/pull/2332#pullrequestreview-553405902", "createdAt": "2020-12-16T07:06:17Z", "commit": {"oid": "862d501d3e1d247dd8086ce5f25d1ada93cbd486"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQwNzowNjoxN1rOIG2c8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQwNzowNjoxN1rOIG2c8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDA1NDUxNQ==", "bodyText": "Clarification: Since we are not updating the metadata table here, for compactions the metadata table will be updated the next time the HoodieWriteClient is created.\nBut for commit operations the metadata table (may) be updated right after the commit completes in \"postCommit\" function. Right?", "url": "https://github.com/apache/hudi/pull/2332#discussion_r544054515", "createdAt": "2020-12-16T07:06:17Z", "author": {"login": "prashantwason"}, "path": "hudi-client/src/main/java/org/apache/hudi/client/HoodieWriteClient.java", "diffHunk": "@@ -701,8 +704,6 @@ protected void completeCompaction(HoodieCommitMetadata metadata, JavaRDD<WriteSt\n     finalizeWrite(table, compactionCommitTime, writeStats);\n     LOG.info(\"Committing Compaction \" + compactionCommitTime + \". Finished with result \" + metadata);\n \n-    table.metadataWriter(jsc).update(metadata, compactionCommitTime);\n-", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "862d501d3e1d247dd8086ce5f25d1ada93cbd486"}, "originalPosition": 53}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzNDE4NzA5", "url": "https://github.com/apache/hudi/pull/2332#pullrequestreview-553418709", "createdAt": "2020-12-16T07:31:12Z", "commit": {"oid": "862d501d3e1d247dd8086ce5f25d1ada93cbd486"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQwNzozMToxMlrOIG3jFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQwNzozMToxMlrOIG3jFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDA3MjQ2OA==", "bodyText": "This is a good idea. I hope it does not break some function which may depend on yyyyMMddHHmmss format of the instantTime.", "url": "https://github.com/apache/hudi/pull/2332#discussion_r544072468", "createdAt": "2020-12-16T07:31:12Z", "author": {"login": "prashantwason"}, "path": "hudi-client/src/main/java/org/apache/hudi/metadata/HoodieBackedTableMetadataWriter.java", "diffHunk": "@@ -725,6 +698,13 @@ private synchronized void commit(JavaSparkContext jsc, JavaRDD<HoodieRecord> rec\n           throw new HoodieMetadataException(\"Failed to commit metadata table records at instant \" + instantTime);\n         }\n       });\n+      // trigger cleaning, compaction, with suffixes based on the same instant time. This ensures that any future\n+      // delta commits synced over will not have an instant time lesser than the last completed instant on the\n+      // metadata table.\n+      writeClient.clean(instantTime + \"001\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "862d501d3e1d247dd8086ce5f25d1ada93cbd486"}, "originalPosition": 143}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzNDE5MDUz", "url": "https://github.com/apache/hudi/pull/2332#pullrequestreview-553419053", "createdAt": "2020-12-16T07:31:50Z", "commit": {"oid": "862d501d3e1d247dd8086ce5f25d1ada93cbd486"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4000, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}