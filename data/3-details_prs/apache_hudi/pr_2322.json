{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM2MDE0OTk4", "number": 2322, "title": "[HUDI-1437] support more accurate spark JobGroup for better performan tracking", "bodyText": "\u2026ce tracking\nTips\n\nThank you very much for contributing to Apache Hudi.\nPlease review https://hudi.apache.org/contributing.html before opening a pull request.\n\nWhat is the purpose of the pull request\nsome description in spark ui is not reality, Not good for performance tracking.\nsupport more accuracy spark JobGroup for better performance tracking.\nBrief change log\n(for example:)\n\nModify AnnotationLocation checkstyle rule in checkstyle.xml\n\nVerify this pull request\n(Please pick either of the following options)\nThis pull request is a trivial rework / code cleanup without any test coverage.\n(or)\nThis pull request is already covered by existing tests, such as (please describe tests).\n(or)\nThis change added tests and can be verified as follows:\n(example:)\n\nAdded integration tests for end-to-end.\nAdded HoodieClientWriteTest to verify the change.\nManually verified the change by running a job locally.\n\nCommitter checklist\n\n\n Has a corresponding JIRA in PR title & commit\n\n\n Commit message is descriptive of the change\n\n\n CI is green\n\n\n Necessary doc changes done or have another open PR\n\n\n For large changes, please consider breaking it into sub-tasks under an umbrella JIRA.", "createdAt": "2020-12-10T15:23:01Z", "url": "https://github.com/apache/hudi/pull/2322", "merged": true, "mergeCommit": {"oid": "8b5d6f94304229e9ec61d44aeda3b514dd67f2a6"}, "closed": true, "closedAt": "2020-12-17T23:20:13Z", "author": {"login": "lw309637554"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdk-CXAABqjQwOTgwNTQxNDU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdnMA3IgFqTU1NTA2NTc1NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "99aee36261b074d4813c11958c569b927d6a4f59", "author": {"user": {"login": "lw309637554", "name": "lw0090"}}, "url": "https://github.com/apache/hudi/commit/99aee36261b074d4813c11958c569b927d6a4f59", "committedDate": "2020-12-10T15:22:02Z", "message": "[HUDI-1437] support more accurate spark JobGroup for better performance tracking"}, "afterCommit": {"oid": "d7be7c992e707884206c835356068c28b079034b", "author": {"user": {"login": "lw309637554", "name": "lw0090"}}, "url": "https://github.com/apache/hudi/commit/d7be7c992e707884206c835356068c28b079034b", "committedDate": "2020-12-11T01:54:57Z", "message": "[HUDI-1437]  support more accurate spark JobGroup for better performance tracking"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwMTQwMTU1", "url": "https://github.com/apache/hudi/pull/2322#pullrequestreview-550140155", "createdAt": "2020-12-11T14:23:32Z", "commit": {"oid": "d7be7c992e707884206c835356068c28b079034b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxNDoyMzozMlrOID68HQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxNDoyMzozMlrOID68HQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDk4MjMwMQ==", "bodyText": ",\"Delete replaced file groups\" -> , \"Delete replaced file groups\"", "url": "https://github.com/apache/hudi/pull/2322#discussion_r540982301", "createdAt": "2020-12-11T14:23:32Z", "author": {"login": "leesf"}, "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/client/ReplaceArchivalHelper.java", "diffHunk": "@@ -68,7 +68,7 @@\n   public static boolean deleteReplacedFileGroups(HoodieEngineContext context, HoodieTableMetaClient metaClient,\n                                                  TableFileSystemView fileSystemView,\n                                                  HoodieInstant instant, List<String> replacedPartitions) {\n-\n+    context.setJobStatus(ReplaceArchivalHelper.class.getSimpleName(),\"Delete replaced file groups\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7be7c992e707884206c835356068c28b079034b"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d7be7c992e707884206c835356068c28b079034b", "author": {"user": {"login": "lw309637554", "name": "lw0090"}}, "url": "https://github.com/apache/hudi/commit/d7be7c992e707884206c835356068c28b079034b", "committedDate": "2020-12-11T01:54:57Z", "message": "[HUDI-1437]  support more accurate spark JobGroup for better performance tracking"}, "afterCommit": {"oid": "ab96d884a4fa8b8ce1657bbed5b9a5b3267bdad7", "author": {"user": {"login": "lw309637554", "name": "lw0090"}}, "url": "https://github.com/apache/hudi/commit/ab96d884a4fa8b8ce1657bbed5b9a5b3267bdad7", "committedDate": "2020-12-12T14:36:10Z", "message": "[HUDI-1437]  support more accurate spark JobGroup for better performance tracking"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwODk0MDg3", "url": "https://github.com/apache/hudi/pull/2322#pullrequestreview-550894087", "createdAt": "2020-12-13T07:52:00Z", "commit": {"oid": "ab96d884a4fa8b8ce1657bbed5b9a5b3267bdad7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xM1QwNzo1MjowMVrOIExICw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xM1QwNzo1MjowMVrOIExICw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTg3MDA5MQ==", "bodyText": "this would be inneccessary?", "url": "https://github.com/apache/hudi/pull/2322#discussion_r541870091", "createdAt": "2020-12-13T07:52:01Z", "author": {"login": "leesf"}, "path": "hudi-common/src/main/java/org/apache/hudi/common/util/queue/IteratorBasedQueueProducer.java", "diffHunk": "@@ -42,9 +42,10 @@ public IteratorBasedQueueProducer(Iterator<I> inputIterator) {\n   @Override\n   public void produce(BoundedInMemoryQueue<I, ?> queue) throws Exception {\n     LOG.info(\"starting to buffer records\");\n+    long start = System.currentTimeMillis();\n     while (inputIterator.hasNext()) {\n       queue.insertRecord(inputIterator.next());\n     }\n-    LOG.info(\"finished buffering records\");\n+    LOG.info(\"finished buffering records, cost = \" + ((System.currentTimeMillis() - start) / 1000));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab96d884a4fa8b8ce1657bbed5b9a5b3267bdad7"}, "originalPosition": 9}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ab96d884a4fa8b8ce1657bbed5b9a5b3267bdad7", "author": {"user": {"login": "lw309637554", "name": "lw0090"}}, "url": "https://github.com/apache/hudi/commit/ab96d884a4fa8b8ce1657bbed5b9a5b3267bdad7", "committedDate": "2020-12-12T14:36:10Z", "message": "[HUDI-1437]  support more accurate spark JobGroup for better performance tracking"}, "afterCommit": {"oid": "4181d08d22184035dcb6f73a1103fedcb95eaef3", "author": {"user": {"login": "lw309637554", "name": "lw0090"}}, "url": "https://github.com/apache/hudi/commit/4181d08d22184035dcb6f73a1103fedcb95eaef3", "committedDate": "2020-12-13T14:45:38Z", "message": "[HUDI-1437]  support more accurate spark JobGroup for better performance tracking"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxMjA0OTk1", "url": "https://github.com/apache/hudi/pull/2322#pullrequestreview-551204995", "createdAt": "2020-12-14T09:53:26Z", "commit": {"oid": "4181d08d22184035dcb6f73a1103fedcb95eaef3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQwOTo1MzoyNlrOIFIXvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQwOTo1MzoyNlrOIFIXvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjI1MDk0Mw==", "bodyText": "Should we clear the jobGroup after the job finish?If not, the next job will reuse the group name.", "url": "https://github.com/apache/hudi/pull/2322#discussion_r542250943", "createdAt": "2020-12-14T09:53:26Z", "author": {"login": "pengzhiwei2018"}, "path": "hudi-client/hudi-spark-client/src/main/java/org/apache/hudi/table/action/rollback/SparkMarkerBasedRollbackStrategy.java", "diffHunk": "@@ -52,6 +52,7 @@ public SparkMarkerBasedRollbackStrategy(HoodieTable<T, JavaRDD<HoodieRecord<T>>,\n       MarkerFiles markerFiles = new MarkerFiles(table, instantToRollback.getTimestamp());\n       List<String> markerFilePaths = markerFiles.allMarkerFilePaths();\n       int parallelism = Math.max(Math.min(markerFilePaths.size(), config.getRollbackParallelism()), 1);\n+      jsc.setJobGroup(this.getClass().getSimpleName(), \"Marker files rollback\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4181d08d22184035dcb6f73a1103fedcb95eaef3"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyMTUzMjkw", "url": "https://github.com/apache/hudi/pull/2322#pullrequestreview-552153290", "createdAt": "2020-12-15T06:59:06Z", "commit": {"oid": "4181d08d22184035dcb6f73a1103fedcb95eaef3"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwNjo1OTowNlrOIF7w1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwNzowNDoyNlrOIF76kg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA5Mjk0OA==", "bodyText": "change message to : \"Delete invalid files generated during the write operation\" ?", "url": "https://github.com/apache/hudi/pull/2322#discussion_r543092948", "createdAt": "2020-12-15T06:59:06Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/table/HoodieTable.java", "diffHunk": "@@ -403,6 +403,7 @@ public void finalizeWrite(HoodieEngineContext context, String instantTs, List<Ho\n \n   private void deleteInvalidFilesByPartitions(HoodieEngineContext context, Map<String, List<Pair<String, String>>> invalidFilesByPartition) {\n     // Now delete partially written files\n+    context.setJobStatus(this.getClass().getSimpleName(), \"Delete invalid files by partitions\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4181d08d22184035dcb6f73a1103fedcb95eaef3"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA5MzM4NA==", "bodyText": "change to : Obtaining marker files for all created, merged paths", "url": "https://github.com/apache/hudi/pull/2322#discussion_r543093384", "createdAt": "2020-12-15T07:00:03Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/table/MarkerFiles.java", "diffHunk": "@@ -135,6 +135,7 @@ public boolean doesMarkerDirExist() throws IOException {\n     if (subDirectories.size() > 0) {\n       parallelism = Math.min(subDirectories.size(), parallelism);\n       SerializableConfiguration serializedConf = new SerializableConfiguration(fs.getConf());\n+      context.setJobStatus(this.getClass().getSimpleName(), \"MarkerFiles created and merged data paths\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4181d08d22184035dcb6f73a1103fedcb95eaef3"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA5NDI2Ng==", "bodyText": "Change to : Compute all comparisons needed between records and files", "url": "https://github.com/apache/hudi/pull/2322#discussion_r543094266", "createdAt": "2020-12-15T07:01:59Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-spark-client/src/main/java/org/apache/hudi/index/bloom/SparkHoodieBloomIndex.java", "diffHunk": "@@ -137,12 +137,14 @@ public SparkHoodieBloomIndex(HoodieWriteConfig config) {\n    */\n   private Map<String, Long> computeComparisonsPerFileGroup(final Map<String, Long> recordsPerPartition,\n                                                            final Map<String, List<BloomIndexFileInfo>> partitionToFileInfo,\n-                                                           JavaPairRDD<String, String> partitionRecordKeyPairRDD) {\n+                                                           JavaPairRDD<String, String> partitionRecordKeyPairRDD,\n+                                                           final HoodieEngineContext context) {\n \n     Map<String, Long> fileToComparisons;\n     if (config.getBloomIndexPruneByRanges()) {\n       // we will just try exploding the input and then count to determine comparisons\n       // FIX(vc): Only do sampling here and extrapolate?\n+      context.setJobStatus(this.getClass().getSimpleName(), \"Explode recordRDD with file comparisons\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4181d08d22184035dcb6f73a1103fedcb95eaef3"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA5NDQ0OA==", "bodyText": "Change to : Building workload profile", "url": "https://github.com/apache/hudi/pull/2322#discussion_r543094448", "createdAt": "2020-12-15T07:02:26Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-spark-client/src/main/java/org/apache/hudi/table/action/commit/BaseSparkCommitActionExecutor.java", "diffHunk": "@@ -101,6 +101,7 @@ public BaseSparkCommitActionExecutor(HoodieEngineContext context,\n \n     WorkloadProfile profile = null;\n     if (isWorkloadProfileNeeded()) {\n+      context.setJobStatus(this.getClass().getSimpleName(), \"Build workload profile\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4181d08d22184035dcb6f73a1103fedcb95eaef3"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA5NTEwMw==", "bodyText": "Change to : Preparing compaction metadata", "url": "https://github.com/apache/hudi/pull/2322#discussion_r543095103", "createdAt": "2020-12-15T07:03:54Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-spark-client/src/main/java/org/apache/hudi/table/action/compact/SparkRunCompactionActionExecutor.java", "diffHunk": "@@ -76,6 +76,7 @@ public SparkRunCompactionActionExecutor(HoodieSparkEngineContext context,\n       JavaRDD<WriteStatus> statuses = compactor.compact(context, compactionPlan, table, config, instantTime);\n \n       statuses.persist(SparkMemoryUtils.getWriteStatusStorageLevel(config.getProps()));\n+      context.setJobStatus(this.getClass().getSimpleName(), \"Collect compaction metadata status\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4181d08d22184035dcb6f73a1103fedcb95eaef3"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA5NTQ0Mg==", "bodyText": "Change to:  Rolling back using marker files", "url": "https://github.com/apache/hudi/pull/2322#discussion_r543095442", "createdAt": "2020-12-15T07:04:26Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-spark-client/src/main/java/org/apache/hudi/table/action/rollback/SparkMarkerBasedRollbackStrategy.java", "diffHunk": "@@ -52,6 +52,7 @@ public SparkMarkerBasedRollbackStrategy(HoodieTable<T, JavaRDD<HoodieRecord<T>>,\n       MarkerFiles markerFiles = new MarkerFiles(table, instantToRollback.getTimestamp());\n       List<String> markerFilePaths = markerFiles.allMarkerFilePaths();\n       int parallelism = Math.max(Math.min(markerFilePaths.size(), config.getRollbackParallelism()), 1);\n+      jsc.setJobGroup(this.getClass().getSimpleName(), \"Marker files rollback\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4181d08d22184035dcb6f73a1103fedcb95eaef3"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65ed0cb2eb072e4a91dd5ebb6332e20b238d291e", "author": {"user": {"login": "lw309637554", "name": "lw0090"}}, "url": "https://github.com/apache/hudi/commit/65ed0cb2eb072e4a91dd5ebb6332e20b238d291e", "committedDate": "2020-12-16T11:03:15Z", "message": "[HUDI-1437]  support more accurate spark JobGroup for better performance tracking"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4181d08d22184035dcb6f73a1103fedcb95eaef3", "author": {"user": {"login": "lw309637554", "name": "lw0090"}}, "url": "https://github.com/apache/hudi/commit/4181d08d22184035dcb6f73a1103fedcb95eaef3", "committedDate": "2020-12-13T14:45:38Z", "message": "[HUDI-1437]  support more accurate spark JobGroup for better performance tracking"}, "afterCommit": {"oid": "65ed0cb2eb072e4a91dd5ebb6332e20b238d291e", "author": {"user": {"login": "lw309637554", "name": "lw0090"}}, "url": "https://github.com/apache/hudi/commit/65ed0cb2eb072e4a91dd5ebb6332e20b238d291e", "committedDate": "2020-12-16T11:03:15Z", "message": "[HUDI-1437]  support more accurate spark JobGroup for better performance tracking"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9eef5e89c314a0e99cfc41a91be94e457c7279cf", "author": {"user": {"login": "lw309637554", "name": "lw0090"}}, "url": "https://github.com/apache/hudi/commit/9eef5e89c314a0e99cfc41a91be94e457c7279cf", "committedDate": "2020-12-16T11:05:55Z", "message": "Merge branch 'master' into HUDI-1437-3"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1MDY1NzU1", "url": "https://github.com/apache/hudi/pull/2322#pullrequestreview-555065755", "createdAt": "2020-12-17T23:20:05Z", "commit": {"oid": "9eef5e89c314a0e99cfc41a91be94e457c7279cf"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3976, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}