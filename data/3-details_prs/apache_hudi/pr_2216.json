{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEyNTExMzM1", "number": 2216, "title": "[HUDI-1357] Added a check to ensure no records are lost during updates.", "bodyText": "What is the purpose of the pull request\nAdd a check to ensure there is no data loss when updating HUDI dataset\nBrief change log\n\nAdded a new HoodieWriteConfig setting to enable data loss checks\nAdded a new stat to HoodieWriteStat which tracks the number of records written to older version of the data file\nWhen data loss check is enabled:\n\nBefore HoodieMergeHandle is closed, it reads the last version of the data file (if present) and find the number of records written in that and compares against the current number of records written\n\n\n\nVerify this pull request\nThis change added tests and can be verified as follows:\nAdded a unit test to ./hudi-client/hudi-spark-client/src/test/java/org/apache/hudi/client/TestHoodieClientOnCopyOnWriteStorage.java\nCan be verified by running that unit test as follows:\nmvn test -pl hudi-client/hudi-spark-client -Dtest=TestHoodieClientOnCopyOnWriteStorage\nCommitter checklist\n\n\n Has a corresponding JIRA in PR title & commit\n\n\n Commit message is descriptive of the change\n\n\n CI is green\n\n\n Necessary doc changes done or have another open PR\n\n\n For large changes, please consider breaking it into sub-tasks under an umbrella JIRA.", "createdAt": "2020-10-29T19:30:44Z", "url": "https://github.com/apache/hudi/pull/2216", "merged": true, "mergeCommit": {"oid": "ac23d2587f58d2199535dea779925cec02304b2d"}, "closed": true, "closedAt": "2020-12-01T21:44:58Z", "author": {"login": "prashantwason"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdbR_oqgFqTUyNzY4OTU3OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdiBDU-AFqTU0MjMyMTI4MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3Njg5NTc5", "url": "https://github.com/apache/hudi/pull/2216#pullrequestreview-527689579", "createdAt": "2020-11-10T23:27:39Z", "commit": {"oid": "15a7807cce0f4e8347cb24b7c855431ef6fb92fc"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQyMzoyNzozOVrOHwznDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQyMzozMDozOFrOHwzrfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDkzOTI3Ng==", "bodyText": "as far as I can tell, we only use this within HoodieMergeHandle.  Can we avoid adding the extra member here and simply use a local variable? I am trying to understand the use-case for logging this in stat.", "url": "https://github.com/apache/hudi/pull/2216#discussion_r520939276", "createdAt": "2020-11-10T23:27:39Z", "author": {"login": "vinothchandar"}, "path": "hudi-common/src/main/java/org/apache/hudi/common/model/HoodieWriteStat.java", "diffHunk": "@@ -49,6 +49,12 @@\n    */\n   private String prevCommit;\n \n+  /**\n+   * Total number of records written to the previous version of the file slice.\n+   * If inflight commit is c2, then number of records present in f1_w1_c1.parquet.\n+   */\n+  private long oldNumWrites;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15a7807cce0f4e8347cb24b7c855431ef6fb92fc"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDkzOTY0NQ==", "bodyText": "sweet. I was going to suggest this. you are ahead!", "url": "https://github.com/apache/hudi/pull/2216#discussion_r520939645", "createdAt": "2020-11-10T23:28:38Z", "author": {"login": "vinothchandar"}, "path": "hudi-common/src/main/java/org/apache/hudi/common/util/ParquetUtils.java", "diffHunk": "@@ -261,6 +262,22 @@ public static BloomFilter readBloomFilterFromParquetMetadata(Configuration confi\n     return records;\n   }\n \n+  /**\n+   * Returns the number of records in the parquet file.\n+   *\n+   * @param conf Configuration\n+   * @param parquetFilePath path of the file\n+   */\n+  public static long getRowCount(Configuration conf, Path parquetFilePath) {\n+    ParquetMetadata footer;\n+    long rowCount = 0;\n+    footer = readMetadata(conf, parquetFilePath);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15a7807cce0f4e8347cb24b7c855431ef6fb92fc"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk0MDQxMw==", "bodyText": "let's name this specific to real purpose like. hoodie.merge.data.validation.enabled , avoiding the calling this loss checking etc, which can be rather disconcerting to users, when they read this.", "url": "https://github.com/apache/hudi/pull/2216#discussion_r520940413", "createdAt": "2020-11-10T23:30:38Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/config/HoodieWriteConfig.java", "diffHunk": "@@ -117,6 +117,10 @@\n   public static final String MAX_CONSISTENCY_CHECKS_PROP = \"hoodie.consistency.check.max_checks\";\n   public static int DEFAULT_MAX_CONSISTENCY_CHECKS = 7;\n \n+  // Data loss check before commits\n+  private static final String DATALOSS_CHECK_ENABLED = \"hoodie.dataloss.check.enabled\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15a7807cce0f4e8347cb24b7c855431ef6fb92fc"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "15a7807cce0f4e8347cb24b7c855431ef6fb92fc", "author": {"user": {"login": "prashantwason", "name": "Prashant Wason"}}, "url": "https://github.com/apache/hudi/commit/15a7807cce0f4e8347cb24b7c855431ef6fb92fc", "committedDate": "2020-10-29T19:25:55Z", "message": "[HUDI-1357] Added a check to ensure no records are lost during updates."}, "afterCommit": {"oid": "da2ff4596c8492212ec25047b9c30f818aa8a250", "author": {"user": {"login": "prashantwason", "name": "Prashant Wason"}}, "url": "https://github.com/apache/hudi/commit/da2ff4596c8492212ec25047b9c30f818aa8a250", "committedDate": "2020-11-18T14:45:53Z", "message": "[HUDI-1357] Added a check to ensure no records are lost during updates."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "da2ff4596c8492212ec25047b9c30f818aa8a250", "author": {"user": {"login": "prashantwason", "name": "Prashant Wason"}}, "url": "https://github.com/apache/hudi/commit/da2ff4596c8492212ec25047b9c30f818aa8a250", "committedDate": "2020-11-18T14:45:53Z", "message": "[HUDI-1357] Added a check to ensure no records are lost during updates."}, "afterCommit": {"oid": "d89cde4edf7ce2f09555622888d1b86f2d5f2015", "author": {"user": {"login": "prashantwason", "name": "Prashant Wason"}}, "url": "https://github.com/apache/hudi/commit/d89cde4edf7ce2f09555622888d1b86f2d5f2015", "committedDate": "2020-11-18T22:19:29Z", "message": "[HUDI-1357] Added a check to ensure no records are lost during updates."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2MTQ3MDU5", "url": "https://github.com/apache/hudi/pull/2216#pullrequestreview-536147059", "createdAt": "2020-11-23T02:10:12Z", "commit": {"oid": "d89cde4edf7ce2f09555622888d1b86f2d5f2015"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8f05c953beff33ac0dd174dee3edd52e2c37caa", "author": {"user": {"login": "prashantwason", "name": "Prashant Wason"}}, "url": "https://github.com/apache/hudi/commit/c8f05c953beff33ac0dd174dee3edd52e2c37caa", "committedDate": "2020-11-24T12:54:00Z", "message": "[HUDI-1357] Added a check to ensure no records are lost during updates."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d89cde4edf7ce2f09555622888d1b86f2d5f2015", "author": {"user": {"login": "prashantwason", "name": "Prashant Wason"}}, "url": "https://github.com/apache/hudi/commit/d89cde4edf7ce2f09555622888d1b86f2d5f2015", "committedDate": "2020-11-18T22:19:29Z", "message": "[HUDI-1357] Added a check to ensure no records are lost during updates."}, "afterCommit": {"oid": "c8f05c953beff33ac0dd174dee3edd52e2c37caa", "author": {"user": {"login": "prashantwason", "name": "Prashant Wason"}}, "url": "https://github.com/apache/hudi/commit/c8f05c953beff33ac0dd174dee3edd52e2c37caa", "committedDate": "2020-11-24T12:54:00Z", "message": "[HUDI-1357] Added a check to ensure no records are lost during updates."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyMzIxMjgw", "url": "https://github.com/apache/hudi/pull/2216#pullrequestreview-542321280", "createdAt": "2020-12-01T21:44:12Z", "commit": {"oid": "c8f05c953beff33ac0dd174dee3edd52e2c37caa"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4247, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}