{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYzMzkwMDU1", "number": 1921, "title": "[HUDI-1151]Fix NPE when no new data in kafka using HoodieDeltaStreamer", "bodyText": "Tips\n\nThank you very much for contributing to Apache Hudi.\nPlease review https://hudi.apache.org/contributing.html before opening a pull request.\n\nWhat is the purpose of the pull request\nFix NPE when no new data in kafka using HoodieDeltaStreamer\nBrief change log\nI get this NPE when using HoodieDeltaStreamer to etl kafka data to hudi table. the topic is newly created, and there is no data in topic when the job started\n20/08/05 21:18:00 INFO helpers.KafkaOffsetGen: SourceLimit not configured, set numEvents to default value : 5000000\n20/08/05 21:18:00 INFO sources.JsonKafkaSource: About to read 0 from Kafka for topic :hudi_test_callback\n20/08/05 21:18:00 INFO deltastreamer.DeltaSync: No new data, source checkpoint has not changed. Nothing to commit. Old checkpoint=(Option{val=hudi_test_callback,0:0}). New Checkpoint=(hudi_test_callback,0:0)\n20/08/05 21:18:00 ERROR deltastreamer.HoodieDeltaStreamer: Shutting down delta-sync due to exception\njava.lang.NullPointerException\nat org.apache.hudi.utilities.deltastreamer.HoodieDeltaStreamer$DeltaSyncService.lambda$startService$0(HoodieDeltaStreamer.java:570)\nat java.util.concurrent.CompletableFuture$AsyncSupply.run(CompletableFuture.java:1590)\nat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\nat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\nat java.lang.Thread.run(Thread.java:748)\n20/08/05 21:18:00 INFO deltastreamer.HoodieDeltaStreamer: Delta Sync shutdown. Error ?true\n20/08/05 21:18:00 ERROR async.AbstractAsyncService: Monitor noticed one or more threads failed. Requesting graceful shutdown of other threads\njava.util.concurrent.ExecutionException: org.apache.hudi.exception.HoodieException\nat java.util.concurrent.CompletableFuture.reportGet(CompletableFuture.java:357)\nat java.util.concurrent.CompletableFuture.get(CompletableFuture.java:1895)\nat org.apache.hudi.async.AbstractAsyncService.lambda$monitorThreads$0(AbstractAsyncService.java:136)\nat java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)\nat java.util.concurrent.FutureTask.run(FutureTask.java:266)\nat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\nat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\nat java.lang.Thread.run(Thread.java:748)\nCaused by: org.apache.hudi.exception.HoodieException\nat org.apache.hudi.utilities.deltastreamer.HoodieDeltaStreamer$DeltaSyncService.lambda$startService$0(HoodieDeltaStreamer.java:585)\nat java.util.concurrent.CompletableFuture$AsyncSupply.run(CompletableFuture.java:1590)\n... 3 more\nCaused by: java.lang.NullPointerException\nat org.apache.hudi.utilities.deltastreamer.HoodieDeltaStreamer$DeltaSyncService.lambda$startService$0(HoodieDeltaStreamer.java:570)\n... 4 more\n20/08/05 21:18:00 ERROR async.AbstractAsyncService: Service shutdown with error\njava.util.concurrent.ExecutionException: org.apache.hudi.exception.HoodieException\nat java.util.concurrent.CompletableFuture.reportGet(CompletableFuture.java:357)\nat java.util.concurrent.CompletableFuture.get(CompletableFuture.java:1895)\nat org.apache.hudi.async.AbstractAsyncService.waitForShutdown(AbstractAsyncService.java:72)\nat org.apache.hudi.utilities.deltastreamer.HoodieDeltaStreamer.lambda$sync$1(HoodieDeltaStreamer.java:152)\nat org.apache.hudi.common.util.Option.ifPresent(Option.java:96)\nat org.apache.hudi.utilities.deltastreamer.HoodieDeltaStreamer.sync(HoodieDeltaStreamer.java:149)\nat org.apache.hudi.utilities.deltastreamer.HoodieDeltaStreamer.main(HoodieDeltaStreamer.java:454)\nat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\nat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\nat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\nat java.lang.reflect.Method.invoke(Method.java:498)\nat org.apache.spark.deploy.yarn.ApplicationMaster$$anon$2.run(ApplicationMaster.scala:673)\nCaused by: org.apache.hudi.exception.HoodieException\nat org.apache.hudi.utilities.deltastreamer.HoodieDeltaStreamer$DeltaSyncService.lambda$startService$0(HoodieDeltaStreamer.java:585)\nat java.util.concurrent.CompletableFuture$AsyncSupply.run(CompletableFuture.java:1590)\nat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\nat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\nat java.lang.Thread.run(Thread.java:748)\nCaused by: java.lang.NullPointerException\nat org.apache.hudi.utilities.deltastreamer.HoodieDeltaStreamer$DeltaSyncService.lambda$startService$0(HoodieDeltaStreamer.java:570)\n... 4 more\nVerify this pull request\n(Please pick either of the following options)\nThis pull request is a trivial rework / code cleanup without any test coverage.\n(or)\nThis pull request is already covered by existing tests, such as (please describe tests).\n(or)\nThis change added tests and can be verified as follows:\n(example:)\n\nAdded integration tests for end-to-end.\nAdded HoodieClientWriteTest to verify the change.\nManually verified the change by running a job locally.\n\nCommitter checklist\n\n\n Has a corresponding JIRA in PR title & commit\n\n\n Commit message is descriptive of the change\n\n\n CI is green\n\n\n Necessary doc changes done or have another open PR\n\n\n For large changes, please consider breaking it into sub-tasks under an umbrella JIRA.", "createdAt": "2020-08-05T13:37:46Z", "url": "https://github.com/apache/hudi/pull/1921", "merged": true, "mergeCommit": {"oid": "b51646dcc76acc68e97dd6a67cc7557e362b590d"}, "closed": true, "closedAt": "2020-08-06T16:03:21Z", "author": {"login": "wangxianghu"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc78qY0gFqTQ2MTc1NjAwOA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc780WhABqjM2MjUxODM4NjI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxNzU2MDA4", "url": "https://github.com/apache/hudi/pull/1921#pullrequestreview-461756008", "createdAt": "2020-08-05T15:05:34Z", "commit": {"oid": "26219eaf54037232514362b86ff3293e313ae8db"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxNTowNTozNVrOG8N62A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxNTowNTozNVrOG8N62A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTc5NTgwMA==", "bodyText": "Good catch!", "url": "https://github.com/apache/hudi/pull/1921#discussion_r465795800", "createdAt": "2020-08-05T15:05:35Z", "author": {"login": "yanghua"}, "path": "hudi-utilities/src/main/java/org/apache/hudi/utilities/deltastreamer/HoodieDeltaStreamer.java", "diffHunk": "@@ -567,7 +567,7 @@ public DeltaSync getDeltaSync() {\n             try {\n               long start = System.currentTimeMillis();\n               Pair<Option<String>, JavaRDD<WriteStatus>> scheduledCompactionInstantAndRDD = deltaSync.syncOnce();\n-              if (scheduledCompactionInstantAndRDD.getLeft().isPresent()) {\n+              if (null != scheduledCompactionInstantAndRDD && scheduledCompactionInstantAndRDD.getLeft().isPresent()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "26219eaf54037232514362b86ff3293e313ae8db"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "26219eaf54037232514362b86ff3293e313ae8db", "author": {"user": null}, "url": "https://github.com/apache/hudi/commit/26219eaf54037232514362b86ff3293e313ae8db", "committedDate": "2020-08-05T13:36:02Z", "message": "[HUDI-1151]Fix NPE when no new data in kafka using HoodieDeltaStreamer"}, "afterCommit": {"oid": "27f81c778fad376ec955e9f205857d6c752d01a2", "author": {"user": null}, "url": "https://github.com/apache/hudi/commit/27f81c778fad376ec955e9f205857d6c752d01a2", "committedDate": "2020-08-05T15:11:11Z", "message": "[HUDI-1151] Fix NPE when no new data in kafka using HoodieDeltaStreamer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "927c0fb63cbdfac980ba90e4a9481ecc4e4851b0", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/927c0fb63cbdfac980ba90e4a9481ecc4e4851b0", "committedDate": "2020-08-05T15:18:55Z", "message": "[HUDI-1151]Fix NPE when no new data in kafka using HoodieDeltaStreamer"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "27f81c778fad376ec955e9f205857d6c752d01a2", "author": {"user": null}, "url": "https://github.com/apache/hudi/commit/27f81c778fad376ec955e9f205857d6c752d01a2", "committedDate": "2020-08-05T15:11:11Z", "message": "[HUDI-1151] Fix NPE when no new data in kafka using HoodieDeltaStreamer"}, "afterCommit": {"oid": "927c0fb63cbdfac980ba90e4a9481ecc4e4851b0", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/927c0fb63cbdfac980ba90e4a9481ecc4e4851b0", "committedDate": "2020-08-05T15:18:55Z", "message": "[HUDI-1151]Fix NPE when no new data in kafka using HoodieDeltaStreamer"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4788, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}