{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY3Njc4MTg1", "number": 1963, "title": "[HUDI-1188] Hbase index MOR tables records not being deduplicated", "bodyText": "What is the purpose of the pull request\nAfter fetching hbase index for a record, Hudi performs validation that the commit timestamp stored in hbase for that record is a commit on the timeline. This makes any record that is stored to hbase index during a deltacommit considered an invalid index and treated as a new record. This causes the hbase index to be updated every time which leads to records being able to be in multiple partitions and even in different file groups within same partition.\nBrief change log\n\nModify HbaseIndex.checkIfValidCommit to consider DELTA_COMMIT timestamp as valid index timestamp\n\nVerify this pull request\nThis change added tests and can be verified as follows:\n\nVerified test failed on MOR table before change and succeeding now\nManually verified by:\n\nUploaded patched JAR to EMR 5.30.1 cluster\nCreate MOR table w/ HBASE index\nUpsert record\nUpsert record with new partition\nValidate new partition was not created and existing partition displayed update to record", "createdAt": "2020-08-13T23:16:51Z", "url": "https://github.com/apache/hudi/pull/1963", "merged": true, "mergeCommit": {"oid": "1137b0b3434a788fa42a17e5755af8ffb0d3f473"}, "closed": true, "closedAt": "2020-08-19T21:56:00Z", "author": {"login": "rmpifer"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-ufgbAFqTQ2NzMzMTY1Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdAUJhMAFqTQ3MDEyMTAwNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3MzMxNjU3", "url": "https://github.com/apache/hudi/pull/1963#pullrequestreview-467331657", "createdAt": "2020-08-14T06:19:25Z", "commit": {"oid": "c97410397d0214b7171cd17b42ba636fecb2a92d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwNjoxOToyNVrOHAo3Tg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwNjoxOToyNVrOHAo3Tg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQzMTU2Ng==", "bodyText": "we could use the metaClient.getCommitsTimeline() or one of those methods which will automatically determine the commit instant type based on table type?", "url": "https://github.com/apache/hudi/pull/1963#discussion_r470431566", "createdAt": "2020-08-14T06:19:25Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/src/main/java/org/apache/hudi/index/hbase/HBaseIndex.java", "diffHunk": "@@ -182,6 +182,7 @@ private boolean checkIfValidCommit(HoodieTableMetaClient metaClient, String comm\n     // 2) is less than the first commit ts in the timeline\n     return !commitTimeline.empty()\n         && (commitTimeline.containsInstant(new HoodieInstant(false, HoodieTimeline.COMMIT_ACTION, commitTs))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c97410397d0214b7171cd17b42ba636fecb2a92d"}, "originalPosition": 3}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3NzY0NTQ0", "url": "https://github.com/apache/hudi/pull/1963#pullrequestreview-467764544", "createdAt": "2020-08-14T17:55:48Z", "commit": {"oid": "c97410397d0214b7171cd17b42ba636fecb2a92d"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c97410397d0214b7171cd17b42ba636fecb2a92d", "author": {"user": {"login": "rmpifer", "name": null}}, "url": "https://github.com/apache/hudi/commit/c97410397d0214b7171cd17b42ba636fecb2a92d", "committedDate": "2020-08-13T22:56:35Z", "message": "Fix HBASE index MOR tables not considering record index valid"}, "afterCommit": {"oid": "124b9324b0cc2eabac6ecbd60883220dbd0b0b35", "author": {"user": {"login": "rmpifer", "name": null}}, "url": "https://github.com/apache/hudi/commit/124b9324b0cc2eabac6ecbd60883220dbd0b0b35", "committedDate": "2020-08-18T00:22:10Z", "message": "Fix HBASE index MOR tables not considering record index valid"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "124b9324b0cc2eabac6ecbd60883220dbd0b0b35", "author": {"user": {"login": "rmpifer", "name": null}}, "url": "https://github.com/apache/hudi/commit/124b9324b0cc2eabac6ecbd60883220dbd0b0b35", "committedDate": "2020-08-18T00:22:10Z", "message": "Fix HBASE index MOR tables not considering record index valid"}, "afterCommit": {"oid": "93db938649e6a7bd07e1be4c95e4ff132c56b839", "author": {"user": {"login": "rmpifer", "name": null}}, "url": "https://github.com/apache/hudi/commit/93db938649e6a7bd07e1be4c95e4ff132c56b839", "committedDate": "2020-08-18T00:25:43Z", "message": "Fix HBASE index MOR tables not considering record index valid"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ded9dba8cff584fbbf31494bebecf4d9f199d68", "author": {"user": {"login": "rmpifer", "name": null}}, "url": "https://github.com/apache/hudi/commit/0ded9dba8cff584fbbf31494bebecf4d9f199d68", "committedDate": "2020-08-18T03:18:14Z", "message": "Fix HBASE index MOR tables not considering record index valid"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "93db938649e6a7bd07e1be4c95e4ff132c56b839", "author": {"user": {"login": "rmpifer", "name": null}}, "url": "https://github.com/apache/hudi/commit/93db938649e6a7bd07e1be4c95e4ff132c56b839", "committedDate": "2020-08-18T00:25:43Z", "message": "Fix HBASE index MOR tables not considering record index valid"}, "afterCommit": {"oid": "0ded9dba8cff584fbbf31494bebecf4d9f199d68", "author": {"user": {"login": "rmpifer", "name": null}}, "url": "https://github.com/apache/hudi/commit/0ded9dba8cff584fbbf31494bebecf4d9f199d68", "committedDate": "2020-08-18T03:18:14Z", "message": "Fix HBASE index MOR tables not considering record index valid"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwMTIxMDA0", "url": "https://github.com/apache/hudi/pull/1963#pullrequestreview-470121004", "createdAt": "2020-08-19T04:45:44Z", "commit": {"oid": "0ded9dba8cff584fbbf31494bebecf4d9f199d68"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwNDo0NTo0NFrOHCyjKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwNDo0NTo0NFrOHCyjKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY4NzQwMQ==", "bodyText": "Can you please change this to -> metaClient.getActiveTimeline().getCommitsTimeline(). For context, the getActiveTimeline() loads the timeline once and then caches it. The getCommitsTimeline() call will not force this, in this case it's working by coincidence because the metaClient passed already has the loaded timeline from the caller but I would want to avoid having that assumption.\n@rmpifer", "url": "https://github.com/apache/hudi/pull/1963#discussion_r472687401", "createdAt": "2020-08-19T04:45:44Z", "author": {"login": "n3nash"}, "path": "hudi-client/src/main/java/org/apache/hudi/index/hbase/HBaseIndex.java", "diffHunk": "@@ -177,13 +176,11 @@ private Get generateStatement(String key) throws IOException {\n   }\n \n   private boolean checkIfValidCommit(HoodieTableMetaClient metaClient, String commitTs) {\n-    HoodieTimeline commitTimeline = metaClient.getActiveTimeline().filterCompletedInstants();\n+    HoodieTimeline commitTimeline = metaClient.getCommitsTimeline().filterCompletedInstants();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ded9dba8cff584fbbf31494bebecf4d9f199d68"}, "originalPosition": 13}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4834, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}