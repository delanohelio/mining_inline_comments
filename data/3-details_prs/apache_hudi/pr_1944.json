{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY1NzY5MzM4", "number": 1944, "title": "[HUDI-1174] Changes for bootstrapped tables to work with presto", "bodyText": "What is the purpose of the pull request\nThe purpose of this pull request is to implement changes required on Hudi side to get Bootstrapped tables integrated with Presto. The testing was done against presto 0.232 and following changes were identified to make it work:\n\n\nAnnotation UseRecordReaderFromInputFormat is required on HoodieParquetInputFormat as well, because the reading for bootstrapped tables needs to happen through record reader to be able to perform the merge. On presto side, this annotation is already handled.\n\n\nWe need to internally maintain VIRTUAL_COLUMN_NAMES because presto's internal hive version hive-apache-1.2.2 has VirutalColumn as a class, versus the one we depend on in hudi which is an enum. This results in following error in presto:\n\n\n2020-08-10T21:59:58.957Z\tERROR\tremote-task-callback-2\tcom.facebook.presto.execution.StageExecutionStateMachine\tStage execution 20200810_215953_00006_34kqg.1.0 failed\njava.lang.NoSuchFieldError: VIRTUAL_COLUMN_NAMES\n\tat org.apache.hudi.hadoop.HoodieParquetInputFormat.lambda$getRecordReader$2(HoodieParquetInputFormat.java:201)\n\tat java.util.stream.ReferencePipeline$2$1.accept(ReferencePipeline.java:174)\n\tat java.util.ArrayList$ArrayListSpliterator.forEachRemaining(ArrayList.java:1382)\n\tat java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:482)\n\tat java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:472)\n\tat java.util.stream.ReduceOps$ReduceOp.evaluateSequential(ReduceOps.java:708)\n\tat java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)\n\tat java.util.stream.ReferencePipeline.collect(ReferencePipeline.java:566)\n\tat org.apache.hudi.hadoop.HoodieParquetInputFormat.getRecordReader(HoodieParquetInputFormat.java:203)\n\tat com.facebook.presto.hive.HiveUtil.createRecordReader(HiveUtil.java:253)\n\tat com.facebook.presto.hive.GenericHiveRecordCursorProvider.lambda$createRecordCursor$0(GenericHiveRecordCursorProvider.java:74)\n\tat com.facebook.presto.hive.authentication.UserGroupInformationUtils.lambda$executeActionInDoAs$0(UserGroupInformationUtils.java:29)\n\tat java.security.AccessController.doPrivileged(Native Method)\n\tat javax.security.auth.Subject.doAs(Subject.java:360)\n\tat org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1824)\n\tat com.facebook.presto.hive.authentication.UserGroupInformationUtils.executeActionInDoAs(UserGroupInformationUtils.java:27)\n\tat com.facebook.presto.hive.authentication.ImpersonatingHdfsAuthentication.doAs(ImpersonatingHdfsAuthentication.java:39)\n\tat com.facebook.presto.hive.HdfsEnvironment.doAs(HdfsEnvironment.java:82)\n\tat com.facebook.presto.hive.GenericHiveRecordCursorProvider.createRecordCursor(GenericHiveRecordCursorProvider.java:73)\n\tat com.facebook.presto.hive.HivePageSourceProvider.createHivePageSource(HivePageSourceProvider.java:374)\n\tat com.facebook.presto.hive.HivePageSourceProvider.createPageSource(HivePageSourceProvider.java:137)\n\tat com.facebook.presto.hive.HivePageSourceProvider.createPageSource(HivePageSourceProvider.java:113)\n\tat com.facebook.presto.spi.connector.classloader.ClassLoaderSafeConnectorPageSourceProvider.createPageSource(ClassLoaderSafeConnectorPageSourceProvider.java:52)\n\n\nDependency changes in hudi-presto-bundle to avoid runtime exceptions.\n\nBrief change log\nVerify this pull request\nThe changes have been tested on emr-5.30.1 against presto 0.232.\nCommitter checklist\n\n\n Has a corresponding JIRA in PR title & commit\n\n\n Commit message is descriptive of the change\n\n\n CI is green\n\n\n Necessary doc changes done or have another open PR\n\n\n For large changes, please consider breaking it into sub-tasks under an umbrella JIRA.", "createdAt": "2020-08-10T22:48:46Z", "url": "https://github.com/apache/hudi/pull/1944", "merged": true, "mergeCommit": {"oid": "8d0426826472f5b861b6bd7c43d8935917431467"}, "closed": true, "closedAt": "2020-08-13T00:51:32Z", "author": {"login": "umehrot2"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc95EGoAFqTQ2NTIxMjM1MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-TyK9gBqjM2NDk3Njk0NDI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1MjEyMzUw", "url": "https://github.com/apache/hudi/pull/1944#pullrequestreview-465212350", "createdAt": "2020-08-11T16:02:52Z", "commit": {"oid": "20ac8257f9f055229ae539dd193bb3e3f30e6517"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxNjowMjo1M1rOG--xGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxNjowMjo1M1rOG--xGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODY5MzI3NQ==", "bodyText": "why are we bundling guava?  we can just use presto's guava classes right?", "url": "https://github.com/apache/hudi/pull/1944#discussion_r468693275", "createdAt": "2020-08-11T16:02:53Z", "author": {"login": "vinothchandar"}, "path": "packaging/hudi-presto-bundle/pom.xml", "diffHunk": "@@ -159,5 +172,24 @@\n       <artifactId>avro</artifactId>\n       <scope>compile</scope>\n     </dependency>\n+\n+    <dependency>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20ac8257f9f055229ae539dd193bb3e3f30e6517"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1MjE2NDY1", "url": "https://github.com/apache/hudi/pull/1944#pullrequestreview-465216465", "createdAt": "2020-08-11T16:07:42Z", "commit": {"oid": "20ac8257f9f055229ae539dd193bb3e3f30e6517"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxNjowNzo0MlrOG--9Pg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxNjoxOTo1M1rOG-_cAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODY5NjM4Mg==", "bodyText": "Is this specific to Parquet or Hive in general. If this is specific to Parquet, can you move it to ParquetUtils ?", "url": "https://github.com/apache/hudi/pull/1944#discussion_r468696382", "createdAt": "2020-08-11T16:07:42Z", "author": {"login": "bvaradar"}, "path": "hudi-hadoop-mr/src/main/java/org/apache/hudi/hadoop/utils/HoodieHiveUtils.java", "diffHunk": "@@ -38,6 +40,9 @@\n   public static final String HOODIE_CONSUME_MODE_PATTERN = \"hoodie.%s.consume.mode\";\n   public static final String HOODIE_START_COMMIT_PATTERN = \"hoodie.%s.consume.start.timestamp\";\n   public static final String HOODIE_MAX_COMMIT_PATTERN = \"hoodie.%s.consume.max.commits\";\n+  public static final Set<String> VIRTUAL_COLUMN_NAMES = CollectionUtils.createImmutableSet(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20ac8257f9f055229ae539dd193bb3e3f30e6517"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcwMjA2MQ==", "bodyText": "@umehrot2  Are these jars not provided by Presto runtime itself ? Version mismatch with guava had been a regular issue earlier but I see that you have shaded them.\nPlease also check the licensing of the new dependencies. Are they Apache ?", "url": "https://github.com/apache/hudi/pull/1944#discussion_r468702061", "createdAt": "2020-08-11T16:16:31Z", "author": {"login": "bvaradar"}, "path": "packaging/hudi-presto-bundle/pom.xml", "diffHunk": "@@ -76,7 +76,12 @@\n                   <include>org.apache.hbase:hbase-common</include>\n                   <include>org.apache.hbase:hbase-protocol</include>\n                   <include>org.apache.hbase:hbase-server</include>\n+                  <include>org.apache.hbase:hbase-annotations</include>\n                   <include>org.apache.htrace:htrace-core</include>\n+                  <include>com.yammer.metrics:metrics-core</include>\n+                  <include>com.google.guava:guava</include>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20ac8257f9f055229ae539dd193bb3e3f30e6517"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcwMzQ3NQ==", "bodyText": "Can you also shade commons-lang and protobuf ?", "url": "https://github.com/apache/hudi/pull/1944#discussion_r468703475", "createdAt": "2020-08-11T16:18:41Z", "author": {"login": "bvaradar"}, "path": "packaging/hudi-presto-bundle/pom.xml", "diffHunk": "@@ -76,7 +76,12 @@\n                   <include>org.apache.hbase:hbase-common</include>\n                   <include>org.apache.hbase:hbase-protocol</include>\n                   <include>org.apache.hbase:hbase-server</include>\n+                  <include>org.apache.hbase:hbase-annotations</include>\n                   <include>org.apache.htrace:htrace-core</include>\n+                  <include>com.yammer.metrics:metrics-core</include>\n+                  <include>com.google.guava:guava</include>\n+                  <include>commons-lang:commons-lang</include>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20ac8257f9f055229ae539dd193bb3e3f30e6517"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcwNDI1Nw==", "bodyText": "Is this the main change ?", "url": "https://github.com/apache/hudi/pull/1944#discussion_r468704257", "createdAt": "2020-08-11T16:19:53Z", "author": {"login": "bvaradar"}, "path": "hudi-hadoop-mr/src/main/java/org/apache/hudi/hadoop/HoodieParquetInputFormat.java", "diffHunk": "@@ -63,6 +62,7 @@\n  * that does not correspond to a hoodie table then they are passed in as is (as what FileInputFormat.listStatus()\n  * would do). The JobConf could have paths from multipe Hoodie/Non-Hoodie tables\n  */\n+@UseRecordReaderFromInputFormat", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20ac8257f9f055229ae539dd193bb3e3f30e6517"}, "originalPosition": 12}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "20ac8257f9f055229ae539dd193bb3e3f30e6517", "author": {"user": {"login": "umehrot2", "name": "Udit Mehrotra"}}, "url": "https://github.com/apache/hudi/commit/20ac8257f9f055229ae539dd193bb3e3f30e6517", "committedDate": "2020-08-10T22:15:13Z", "message": "Changes for bootstrapped tables to work with presto"}, "afterCommit": {"oid": "2a24180728b8c8a89844a50c66f4396c2389a101", "author": {"user": {"login": "umehrot2", "name": "Udit Mehrotra"}}, "url": "https://github.com/apache/hudi/commit/2a24180728b8c8a89844a50c66f4396c2389a101", "committedDate": "2020-08-11T18:39:56Z", "message": "Changes for bootstrapped tables to work with presto"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2a24180728b8c8a89844a50c66f4396c2389a101", "author": {"user": {"login": "umehrot2", "name": "Udit Mehrotra"}}, "url": "https://github.com/apache/hudi/commit/2a24180728b8c8a89844a50c66f4396c2389a101", "committedDate": "2020-08-11T18:39:56Z", "message": "Changes for bootstrapped tables to work with presto"}, "afterCommit": {"oid": "8fb43b696fff4dc6da842c14bfda894109d320f3", "author": {"user": {"login": "umehrot2", "name": "Udit Mehrotra"}}, "url": "https://github.com/apache/hudi/commit/8fb43b696fff4dc6da842c14bfda894109d320f3", "committedDate": "2020-08-11T21:07:31Z", "message": "Changes for bootstrapped tables to work with presto"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2MjU3MDYy", "url": "https://github.com/apache/hudi/pull/1944#pullrequestreview-466257062", "createdAt": "2020-08-12T20:34:49Z", "commit": {"oid": "8fb43b696fff4dc6da842c14bfda894109d320f3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8687662fe3b041c745b536fad7e9d3d5f5b52849", "author": {"user": {"login": "umehrot2", "name": "Udit Mehrotra"}}, "url": "https://github.com/apache/hudi/commit/8687662fe3b041c745b536fad7e9d3d5f5b52849", "committedDate": "2020-08-12T23:12:07Z", "message": "Changes for bootstrapped tables to work with presto"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8fb43b696fff4dc6da842c14bfda894109d320f3", "author": {"user": {"login": "umehrot2", "name": "Udit Mehrotra"}}, "url": "https://github.com/apache/hudi/commit/8fb43b696fff4dc6da842c14bfda894109d320f3", "committedDate": "2020-08-11T21:07:31Z", "message": "Changes for bootstrapped tables to work with presto"}, "afterCommit": {"oid": "8687662fe3b041c745b536fad7e9d3d5f5b52849", "author": {"user": {"login": "umehrot2", "name": "Udit Mehrotra"}}, "url": "https://github.com/apache/hudi/commit/8687662fe3b041c745b536fad7e9d3d5f5b52849", "committedDate": "2020-08-12T23:12:07Z", "message": "Changes for bootstrapped tables to work with presto"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4815, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}