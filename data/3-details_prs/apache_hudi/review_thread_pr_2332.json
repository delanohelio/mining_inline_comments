{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM5MDQxMjU1", "number": 2332, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQwNzowNjoxN1rOFGCQ_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQwNzozMToxMlrOFGC-RA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQxODcyODkyOnYy", "diffSide": "LEFT", "path": "hudi-client/src/main/java/org/apache/hudi/client/HoodieWriteClient.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQwNzowNjoxN1rOIG2c8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QyMzoxNjoxMlrOIIMr5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDA1NDUxNQ==", "bodyText": "Clarification: Since we are not updating the metadata table here, for compactions the metadata table will be updated the next time the HoodieWriteClient is created.\nBut for commit operations the metadata table (may) be updated right after the commit completes in \"postCommit\" function. Right?", "url": "https://github.com/apache/hudi/pull/2332#discussion_r544054515", "createdAt": "2020-12-16T07:06:17Z", "author": {"login": "prashantwason"}, "path": "hudi-client/src/main/java/org/apache/hudi/client/HoodieWriteClient.java", "diffHunk": "@@ -701,8 +704,6 @@ protected void completeCompaction(HoodieCommitMetadata metadata, JavaRDD<WriteSt\n     finalizeWrite(table, compactionCommitTime, writeStats);\n     LOG.info(\"Committing Compaction \" + compactionCommitTime + \". Finished with result \" + metadata);\n \n-    table.metadataWriter(jsc).update(metadata, compactionCommitTime);\n-", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "862d501d3e1d247dd8086ce5f25d1ada93cbd486"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ2NzM2Nw==", "bodyText": "yes correct. even for compaction, once the compaction commits, it will trigger a sync. I think we should ensure the sync only happens for commit operations (i.e only one allowed at the moment). I ll double check this.", "url": "https://github.com/apache/hudi/pull/2332#discussion_r545467367", "createdAt": "2020-12-17T23:16:12Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/src/main/java/org/apache/hudi/client/HoodieWriteClient.java", "diffHunk": "@@ -701,8 +704,6 @@ protected void completeCompaction(HoodieCommitMetadata metadata, JavaRDD<WriteSt\n     finalizeWrite(table, compactionCommitTime, writeStats);\n     LOG.info(\"Committing Compaction \" + compactionCommitTime + \". Finished with result \" + metadata);\n \n-    table.metadataWriter(jsc).update(metadata, compactionCommitTime);\n-", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDA1NDUxNQ=="}, "originalCommit": {"oid": "862d501d3e1d247dd8086ce5f25d1ada93cbd486"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQxODg0NDg0OnYy", "diffSide": "RIGHT", "path": "hudi-client/src/main/java/org/apache/hudi/metadata/HoodieBackedTableMetadataWriter.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQwNzozMToxMlrOIG3jFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QwMTowNzozOFrOIKN9ag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDA3MjQ2OA==", "bodyText": "This is a good idea. I hope it does not break some function which may depend on yyyyMMddHHmmss format of the instantTime.", "url": "https://github.com/apache/hudi/pull/2332#discussion_r544072468", "createdAt": "2020-12-16T07:31:12Z", "author": {"login": "prashantwason"}, "path": "hudi-client/src/main/java/org/apache/hudi/metadata/HoodieBackedTableMetadataWriter.java", "diffHunk": "@@ -725,6 +698,13 @@ private synchronized void commit(JavaSparkContext jsc, JavaRDD<HoodieRecord> rec\n           throw new HoodieMetadataException(\"Failed to commit metadata table records at instant \" + instantTime);\n         }\n       });\n+      // trigger cleaning, compaction, with suffixes based on the same instant time. This ensures that any future\n+      // delta commits synced over will not have an instant time lesser than the last completed instant on the\n+      // metadata table.\n+      writeClient.clean(instantTime + \"001\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "862d501d3e1d247dd8086ce5f25d1ada93cbd486"}, "originalPosition": 143}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ2NjY5MQ==", "bodyText": "@prashantwason our tests use 001,002 etc. So code should be fine. but may be some metrics reporting code might have some issue. let me double check. good call", "url": "https://github.com/apache/hudi/pull/2332#discussion_r545466691", "createdAt": "2020-12-17T23:14:27Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/src/main/java/org/apache/hudi/metadata/HoodieBackedTableMetadataWriter.java", "diffHunk": "@@ -725,6 +698,13 @@ private synchronized void commit(JavaSparkContext jsc, JavaRDD<HoodieRecord> rec\n           throw new HoodieMetadataException(\"Failed to commit metadata table records at instant \" + instantTime);\n         }\n       });\n+      // trigger cleaning, compaction, with suffixes based on the same instant time. This ensures that any future\n+      // delta commits synced over will not have an instant time lesser than the last completed instant on the\n+      // metadata table.\n+      writeClient.clean(instantTime + \"001\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDA3MjQ2OA=="}, "originalCommit": {"oid": "862d501d3e1d247dd8086ce5f25d1ada93cbd486"}, "originalPosition": 143}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzU4NTM4Ng==", "bodyText": "Seems like the parser can handle this", "url": "https://github.com/apache/hudi/pull/2332#discussion_r547585386", "createdAt": "2020-12-23T01:07:38Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/src/main/java/org/apache/hudi/metadata/HoodieBackedTableMetadataWriter.java", "diffHunk": "@@ -725,6 +698,13 @@ private synchronized void commit(JavaSparkContext jsc, JavaRDD<HoodieRecord> rec\n           throw new HoodieMetadataException(\"Failed to commit metadata table records at instant \" + instantTime);\n         }\n       });\n+      // trigger cleaning, compaction, with suffixes based on the same instant time. This ensures that any future\n+      // delta commits synced over will not have an instant time lesser than the last completed instant on the\n+      // metadata table.\n+      writeClient.clean(instantTime + \"001\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDA3MjQ2OA=="}, "originalCommit": {"oid": "862d501d3e1d247dd8086ce5f25d1ada93cbd486"}, "originalPosition": 143}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4013, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}