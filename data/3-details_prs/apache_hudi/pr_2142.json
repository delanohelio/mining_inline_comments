{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk3MzY5MzM5", "number": 2142, "title": "[HUDI-1203] add port configuration for EmbeddedTimelineService", "bodyText": "Tips\n\nThank you very much for contributing to Apache Hudi.\nPlease review https://hudi.apache.org/contributing.html before opening a pull request.\n\nWhat is the purpose of the pull request\nAllow port configuration for EmbeddedTimelineService, because in some runtime environment such as spark on kubernets need to plan service port . So add hoodie.embed.timeline.server.port for user  to set the  Embedded port wanted. default is 0 (will generate random port). Also  add 16 retries when start server failed.\nBrief change log\n(for example:)\n\nModify AnnotationLocation checkstyle rule in checkstyle.xml\n\nVerify this pull request\n(Please pick either of the following options)\nThis pull request is a trivial rework / code cleanup without any test coverage.\n(or)\nThis pull request is already covered by existing tests, such as (please describe tests).\n(or)\nThis change added tests and can be verified as follows:\n(example:)\n\nAdded integration tests for end-to-end.\nAdded HoodieClientWriteTest to verify the change.\nManually verified the change by running a job locally.\n\nCommitter checklist\n\n\n Has a corresponding JIRA in PR title & commit\n\n\n Commit message is descriptive of the change\n\n\n CI is green\n\n\n Necessary doc changes done or have another open PR\n\n\n For large changes, please consider breaking it into sub-tasks under an umbrella JIRA.", "createdAt": "2020-10-04T03:25:48Z", "url": "https://github.com/apache/hudi/pull/2142", "merged": true, "mergeCommit": {"oid": "fdae388626b8d97acc01191aa0e7075c36a41132"}, "closed": true, "closedAt": "2020-10-05T18:36:55Z", "author": {"login": "lw309637554"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdPHcmAABqjM4MzcxOTc0MzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdPoNQhgFqTUwMjMxOTM0Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fba98be61da6ec56d05f88d591c1e3892eda46a0", "author": {"user": {"login": "lw309637554", "name": "lw0090"}}, "url": "https://github.com/apache/hudi/commit/fba98be61da6ec56d05f88d591c1e3892eda46a0", "committedDate": "2020-10-04T03:18:27Z", "message": "[HUDI-1203] add port configuration for EmbeddedTimelineService"}, "afterCommit": {"oid": "81f3be64241bae8d0d49b1dc36e84964fdaca6e1", "author": {"user": {"login": "lw309637554", "name": "lw0090"}}, "url": "https://github.com/apache/hudi/commit/81f3be64241bae8d0d49b1dc36e84964fdaca6e1", "committedDate": "2020-10-04T04:26:23Z", "message": "[HUDI-1203]  add port configuration for EmbeddedTimelineService"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "81f3be64241bae8d0d49b1dc36e84964fdaca6e1", "author": {"user": {"login": "lw309637554", "name": "lw0090"}}, "url": "https://github.com/apache/hudi/commit/81f3be64241bae8d0d49b1dc36e84964fdaca6e1", "committedDate": "2020-10-04T04:26:23Z", "message": "[HUDI-1203]  add port configuration for EmbeddedTimelineService"}, "afterCommit": {"oid": "4299cf8acfa6665a579319044644998c7d1994e5", "author": {"user": {"login": "lw309637554", "name": "lw0090"}}, "url": "https://github.com/apache/hudi/commit/4299cf8acfa6665a579319044644998c7d1994e5", "committedDate": "2020-10-04T05:16:49Z", "message": "[HUDI-1203]  add port  configuration for EmbeddedTimelineService"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4299cf8acfa6665a579319044644998c7d1994e5", "author": {"user": {"login": "lw309637554", "name": "lw0090"}}, "url": "https://github.com/apache/hudi/commit/4299cf8acfa6665a579319044644998c7d1994e5", "committedDate": "2020-10-04T05:16:49Z", "message": "[HUDI-1203]  add port  configuration for EmbeddedTimelineService"}, "afterCommit": {"oid": "a721bb685c47b78a110e71ed4e00ab47f6691a7c", "author": {"user": {"login": "lw309637554", "name": "lw0090"}}, "url": "https://github.com/apache/hudi/commit/a721bb685c47b78a110e71ed4e00ab47f6691a7c", "committedDate": "2020-10-04T09:40:06Z", "message": "[HUDI-1203]  add port  configuration for EmbeddedTimelineService"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a721bb685c47b78a110e71ed4e00ab47f6691a7c", "author": {"user": {"login": "lw309637554", "name": "lw0090"}}, "url": "https://github.com/apache/hudi/commit/a721bb685c47b78a110e71ed4e00ab47f6691a7c", "committedDate": "2020-10-04T09:40:06Z", "message": "[HUDI-1203]  add port  configuration for EmbeddedTimelineService"}, "afterCommit": {"oid": "cf745430a882774b1cdd714bd0eaf99bc0ddd094", "author": {"user": {"login": "lw309637554", "name": "lw0090"}}, "url": "https://github.com/apache/hudi/commit/cf745430a882774b1cdd714bd0eaf99bc0ddd094", "committedDate": "2020-10-04T12:29:04Z", "message": "[HUDI-1203]  add port  configuration for EmbeddedTimelineService"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxNjY5NzIx", "url": "https://github.com/apache/hudi/pull/2142#pullrequestreview-501669721", "createdAt": "2020-10-04T23:38:16Z", "commit": {"oid": "cf745430a882774b1cdd714bd0eaf99bc0ddd094"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMzozODoxNlrOHcK6GA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQyMzo0NDoyNFrOHcK8BQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTMwMDg4OA==", "bodyText": "nit: avoid the extra int variable?", "url": "https://github.com/apache/hudi/pull/2142#discussion_r499300888", "createdAt": "2020-10-04T23:38:16Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/client/AbstractHoodieClient.java", "diffHunk": "@@ -102,7 +102,8 @@ private synchronized void startEmbeddedServerView() {\n         // Run Embedded Timeline Server\n         LOG.info(\"Starting Timeline service !!\");\n         Option<String> hostAddr = context.getProperty(EngineProperty.EMBEDDED_SERVER_HOST);\n-        timelineServer = Option.of(new EmbeddedTimelineService(context, hostAddr.orElse(null),\n+        int embeddedTimelineServerPort = config.getEmbeddedTimelineServerPort();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf745430a882774b1cdd714bd0eaf99bc0ddd094"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTMwMDk4MQ==", "bodyText": "rename: preferredPort", "url": "https://github.com/apache/hudi/pull/2142#discussion_r499300981", "createdAt": "2020-10-04T23:39:23Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/hudi-client-common/src/main/java/org/apache/hudi/client/embedded/EmbeddedTimelineService.java", "diffHunk": "@@ -39,17 +39,19 @@\n   private static final Logger LOG = LogManager.getLogger(EmbeddedTimelineService.class);\n \n   private int serverPort;\n+  private int userConfigPort;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf745430a882774b1cdd714bd0eaf99bc0ddd094"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTMwMTA3Ng==", "bodyText": "pull into static final variable?", "url": "https://github.com/apache/hudi/pull/2142#discussion_r499301076", "createdAt": "2020-10-04T23:40:35Z", "author": {"login": "vinothchandar"}, "path": "hudi-timeline-service/src/main/java/org/apache/hudi/timeline/service/TimelineService.java", "diffHunk": "@@ -98,16 +98,42 @@ public TimelineService(Config config) throws IOException {\n     public Boolean help = false;\n   }\n \n+  private int startServiceOnPort(int port) throws IOException {\n+    if (!(port == 0 || (1024 <= port && port < 65536))) {\n+      throw new IllegalArgumentException(String.format(\"startPort should be between 1024 and 65535 (inclusive), \"\n+          + \"or 0 for a random free port. but now is %s.\", port));\n+    }\n+    int maxRetries = 16;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf745430a882774b1cdd714bd0eaf99bc0ddd094"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTMwMTE5Mw==", "bodyText": "rename: offset -> attempt?", "url": "https://github.com/apache/hudi/pull/2142#discussion_r499301193", "createdAt": "2020-10-04T23:41:47Z", "author": {"login": "vinothchandar"}, "path": "hudi-timeline-service/src/main/java/org/apache/hudi/timeline/service/TimelineService.java", "diffHunk": "@@ -98,16 +98,42 @@ public TimelineService(Config config) throws IOException {\n     public Boolean help = false;\n   }\n \n+  private int startServiceOnPort(int port) throws IOException {\n+    if (!(port == 0 || (1024 <= port && port < 65536))) {\n+      throw new IllegalArgumentException(String.format(\"startPort should be between 1024 and 65535 (inclusive), \"\n+          + \"or 0 for a random free port. but now is %s.\", port));\n+    }\n+    int maxRetries = 16;\n+    for (int offset = 0; offset < maxRetries; offset++) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf745430a882774b1cdd714bd0eaf99bc0ddd094"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTMwMTI1Nw==", "bodyText": "what are we trying to do in the : else part? a line of comment could help", "url": "https://github.com/apache/hudi/pull/2142#discussion_r499301257", "createdAt": "2020-10-04T23:42:39Z", "author": {"login": "vinothchandar"}, "path": "hudi-timeline-service/src/main/java/org/apache/hudi/timeline/service/TimelineService.java", "diffHunk": "@@ -98,16 +98,42 @@ public TimelineService(Config config) throws IOException {\n     public Boolean help = false;\n   }\n \n+  private int startServiceOnPort(int port) throws IOException {\n+    if (!(port == 0 || (1024 <= port && port < 65536))) {\n+      throw new IllegalArgumentException(String.format(\"startPort should be between 1024 and 65535 (inclusive), \"\n+          + \"or 0 for a random free port. but now is %s.\", port));\n+    }\n+    int maxRetries = 16;\n+    for (int offset = 0; offset < maxRetries; offset++) {\n+      int tryPort = port == 0 ? port : (port + offset - 1024) % (65536 - 1024) + 1024;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf745430a882774b1cdd714bd0eaf99bc0ddd094"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTMwMTMwOQ==", "bodyText": "you also probably want to add a small wait between attempts?", "url": "https://github.com/apache/hudi/pull/2142#discussion_r499301309", "createdAt": "2020-10-04T23:43:24Z", "author": {"login": "vinothchandar"}, "path": "hudi-timeline-service/src/main/java/org/apache/hudi/timeline/service/TimelineService.java", "diffHunk": "@@ -98,16 +98,42 @@ public TimelineService(Config config) throws IOException {\n     public Boolean help = false;\n   }\n \n+  private int startServiceOnPort(int port) throws IOException {\n+    if (!(port == 0 || (1024 <= port && port < 65536))) {\n+      throw new IllegalArgumentException(String.format(\"startPort should be between 1024 and 65535 (inclusive), \"\n+          + \"or 0 for a random free port. but now is %s.\", port));\n+    }\n+    int maxRetries = 16;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTMwMTA3Ng=="}, "originalCommit": {"oid": "cf745430a882774b1cdd714bd0eaf99bc0ddd094"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTMwMTM4MQ==", "bodyText": "nit: %d times", "url": "https://github.com/apache/hudi/pull/2142#discussion_r499301381", "createdAt": "2020-10-04T23:44:24Z", "author": {"login": "vinothchandar"}, "path": "hudi-timeline-service/src/main/java/org/apache/hudi/timeline/service/TimelineService.java", "diffHunk": "@@ -98,16 +98,42 @@ public TimelineService(Config config) throws IOException {\n     public Boolean help = false;\n   }\n \n+  private int startServiceOnPort(int port) throws IOException {\n+    if (!(port == 0 || (1024 <= port && port < 65536))) {\n+      throw new IllegalArgumentException(String.format(\"startPort should be between 1024 and 65535 (inclusive), \"\n+          + \"or 0 for a random free port. but now is %s.\", port));\n+    }\n+    int maxRetries = 16;\n+    for (int offset = 0; offset < maxRetries; offset++) {\n+      int tryPort = port == 0 ? port : (port + offset - 1024) % (65536 - 1024) + 1024;\n+      try {\n+        app.start(tryPort);\n+        return app.port();\n+      } catch (Exception e) {\n+        if (e.getMessage() != null && e.getMessage().contains(\"Failed to bind to\")) {\n+          if (tryPort == 0) {\n+            LOG.warn(\"Timeline server could not bind on a random free port.\");\n+          } else {\n+            LOG.warn(String.format(\"Timeline server could not bind on port %d. \"\n+                + \"Attempting port %d + 1.\",tryPort, tryPort));\n+          }\n+        } else {\n+          LOG.warn(String.format(\"Timeline server start failed on port %d. Attempting port %d + 1.\",tryPort, tryPort), e);\n+        }\n+      }\n+    }\n+    throw new IOException(String.format(\"Timeline server start failed on port %d, after retry %d time\", port, maxRetries));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf745430a882774b1cdd714bd0eaf99bc0ddd094"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f9d4fb983c94ff302a62ffe6d06077e142140d5", "author": {"user": {"login": "lw309637554", "name": "lw0090"}}, "url": "https://github.com/apache/hudi/commit/9f9d4fb983c94ff302a62ffe6d06077e142140d5", "committedDate": "2020-10-05T12:14:15Z", "message": "[HUDI-1203]  add port  configuration for EmbeddedTimelineService"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cf745430a882774b1cdd714bd0eaf99bc0ddd094", "author": {"user": {"login": "lw309637554", "name": "lw0090"}}, "url": "https://github.com/apache/hudi/commit/cf745430a882774b1cdd714bd0eaf99bc0ddd094", "committedDate": "2020-10-04T12:29:04Z", "message": "[HUDI-1203]  add port  configuration for EmbeddedTimelineService"}, "afterCommit": {"oid": "9f9d4fb983c94ff302a62ffe6d06077e142140d5", "author": {"user": {"login": "lw309637554", "name": "lw0090"}}, "url": "https://github.com/apache/hudi/commit/9f9d4fb983c94ff302a62ffe6d06077e142140d5", "committedDate": "2020-10-05T12:14:15Z", "message": "[HUDI-1203]  add port  configuration for EmbeddedTimelineService"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyMzE5MzQ3", "url": "https://github.com/apache/hudi/pull/2142#pullrequestreview-502319347", "createdAt": "2020-10-05T18:36:47Z", "commit": {"oid": "9f9d4fb983c94ff302a62ffe6d06077e142140d5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4643, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}