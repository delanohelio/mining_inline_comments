{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkyNjY4MjQy", "number": 2112, "title": "[HUDI-995] Migrate HoodieTestUtils APIs to HoodieTestTable", "bodyText": "Remove APIs in HoodieTestUtils\n\nHoodieTestUtils#createInflightCommitFiles\nHoodieTestUtils#getCommitFilePath\nHoodieTestUtils#doesCommitExist\n\nand migrate usages to HoodieTestTable in\n\nhudi-cli/src/test/java/org/apache/hudi/cli/commands/TestRollbacksCommand.java\nhudi-cli/src/test/java/org/apache/hudi/cli/commands/TestUpgradeDowngradeCommand.java\nhudi-cli/src/test/java/org/apache/hudi/cli/integ/ITTestCommitsCommand.java\nhudi-cli/src/test/java/org/apache/hudi/cli/testutils/HoodieTestCommitMetadataGenerator.java\nhudi-client/src/test/java/org/apache/hudi/client/TestHoodieClientOnCopyOnWriteStorage.java\n\nCommitter checklist\n\n\n Has a corresponding JIRA in PR title & commit\n\n\n Commit message is descriptive of the change\n\n\n CI is green\n\n\n Necessary doc changes done or have another open PR\n\n\n For large changes, please consider breaking it into sub-tasks under an umbrella JIRA.", "createdAt": "2020-09-24T19:58:08Z", "url": "https://github.com/apache/hudi/pull/2112", "merged": true, "mergeCommit": {"oid": "1be0b06ef8839c46318cfa900f18ac6e237d928b"}, "closed": true, "closedAt": "2020-09-26T13:21:48Z", "author": {"login": "xushiyan"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdMIfnbABqjM4MDUyMzY4NDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdMqTDYgFqTQ5NzAwNDM1Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "045049848d428f60959af12021061a1745b60e1e", "author": {"user": {"login": "xushiyan", "name": "Raymond Xu"}}, "url": "https://github.com/apache/hudi/commit/045049848d428f60959af12021061a1745b60e1e", "committedDate": "2020-09-24T17:44:49Z", "message": "[HUDI-995] Migrate HoodieTestUtils APIs to HoodieTestTable"}, "afterCommit": {"oid": "6fe876d5fc9db60777899f864dcdaf8857601f50", "author": {"user": {"login": "xushiyan", "name": "Raymond Xu"}}, "url": "https://github.com/apache/hudi/commit/6fe876d5fc9db60777899f864dcdaf8857601f50", "committedDate": "2020-09-24T21:57:59Z", "message": "[HUDI-995] Migrate HoodieTestUtils APIs to HoodieTestTable\n\nRemove APIs in HoodieTestUtils\n\n- HoodieTestUtils#createInflightCommitFiles\n- HoodieTestUtils#getCommitFilePath\n- HoodieTestUtils#doesCommitExist\n\nand migrate usages to HoodieTestTable in\n\n- hudi-cli/src/test/java/org/apache/hudi/cli/commands/TestRollbacksCommand.java\n- hudi-cli/src/test/java/org/apache/hudi/cli/commands/TestUpgradeDowngradeCommand.java\n- hudi-cli/src/test/java/org/apache/hudi/cli/integ/ITTestCommitsCommand.java\n- hudi-cli/src/test/java/org/apache/hudi/cli/testutils/HoodieTestCommitMetadataGenerator.java\n- hudi-client/src/test/java/org/apache/hudi/client/TestHoodieClientOnCopyOnWriteStorage.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1OTgxNjI1", "url": "https://github.com/apache/hudi/pull/2112#pullrequestreview-495981625", "createdAt": "2020-09-24T22:02:22Z", "commit": {"oid": "6fe876d5fc9db60777899f864dcdaf8857601f50"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQyMjowMjoyM1rOHXuKpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQyMjowMjoyM1rOHXuKpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYzNTY4Nw==", "bodyText": "change stream#foreach to for-loop to avoid the noisy try-catch block.", "url": "https://github.com/apache/hudi/pull/2112#discussion_r494635687", "createdAt": "2020-09-24T22:02:23Z", "author": {"login": "xushiyan"}, "path": "hudi-cli/src/test/java/org/apache/hudi/cli/testutils/HoodieTestCommitMetadataGenerator.java", "diffHunk": "@@ -62,67 +62,53 @@\n   /**\n    * Create a commit file with default CommitMetadata.\n    */\n-  public static void createCommitFileWithMetadata(String basePath, String commitTime, Configuration configuration) {\n+  public static void createCommitFileWithMetadata(String basePath, String commitTime, Configuration configuration) throws Exception {\n     createCommitFileWithMetadata(basePath, commitTime, configuration, Option.empty(), Option.empty());\n   }\n \n   public static void createCommitFileWithMetadata(String basePath, String commitTime, Configuration configuration,\n-      Option<Integer> writes, Option<Integer> updates) {\n+      Option<Integer> writes, Option<Integer> updates) throws Exception {\n     createCommitFileWithMetadata(basePath, commitTime, configuration, UUID.randomUUID().toString(),\n         UUID.randomUUID().toString(), writes, updates);\n   }\n \n   public static void createCommitFileWithMetadata(String basePath, String commitTime, Configuration configuration,\n-      String fileId1, String fileId2, Option<Integer> writes, Option<Integer> updates) {\n-    Arrays.asList(HoodieTimeline.makeCommitFileName(commitTime), HoodieTimeline.makeInflightCommitFileName(commitTime),\n-        HoodieTimeline.makeRequestedCommitFileName(commitTime))\n-        .forEach(f -> {\n-          Path commitFile = new Path(\n-              basePath + \"/\" + HoodieTableMetaClient.METAFOLDER_NAME + \"/\" + f);\n-          FSDataOutputStream os = null;\n-          try {\n-            FileSystem fs = FSUtils.getFs(basePath, configuration);\n-            os = fs.create(commitFile, true);\n-            // Generate commitMetadata\n-            HoodieCommitMetadata commitMetadata =\n-                generateCommitMetadata(basePath, commitTime, fileId1, fileId2, writes, updates);\n-            // Write empty commit metadata\n-            os.writeBytes(new String(commitMetadata.toJsonString().getBytes(StandardCharsets.UTF_8)));\n-          } catch (IOException ioe) {\n-            throw new HoodieIOException(ioe.getMessage(), ioe);\n-          } finally {\n-            if (null != os) {\n-              try {\n-                os.close();\n-              } catch (IOException e) {\n-                throw new HoodieIOException(e.getMessage(), e);\n-              }\n-            }\n-          }\n-        });\n+      String fileId1, String fileId2, Option<Integer> writes, Option<Integer> updates) throws Exception {\n+    List<String> commitFileNames = Arrays.asList(HoodieTimeline.makeCommitFileName(commitTime), HoodieTimeline.makeInflightCommitFileName(commitTime),\n+        HoodieTimeline.makeRequestedCommitFileName(commitTime));\n+    for (String name : commitFileNames) {\n+      Path commitFilePath = new Path(Paths.get(basePath, HoodieTableMetaClient.METAFOLDER_NAME, name).toString());\n+      try (FSDataOutputStream os = FSUtils.getFs(basePath, configuration).create(commitFilePath, true)) {\n+        // Generate commitMetadata\n+        HoodieCommitMetadata commitMetadata =\n+            generateCommitMetadata(basePath, commitTime, fileId1, fileId2, writes, updates);\n+        // Write empty commit metadata\n+        os.writeBytes(new String(commitMetadata.toJsonString().getBytes(StandardCharsets.UTF_8)));\n+      }\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6fe876d5fc9db60777899f864dcdaf8857601f50"}, "originalPosition": 87}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6fe876d5fc9db60777899f864dcdaf8857601f50", "author": {"user": {"login": "xushiyan", "name": "Raymond Xu"}}, "url": "https://github.com/apache/hudi/commit/6fe876d5fc9db60777899f864dcdaf8857601f50", "committedDate": "2020-09-24T21:57:59Z", "message": "[HUDI-995] Migrate HoodieTestUtils APIs to HoodieTestTable\n\nRemove APIs in HoodieTestUtils\n\n- HoodieTestUtils#createInflightCommitFiles\n- HoodieTestUtils#getCommitFilePath\n- HoodieTestUtils#doesCommitExist\n\nand migrate usages to HoodieTestTable in\n\n- hudi-cli/src/test/java/org/apache/hudi/cli/commands/TestRollbacksCommand.java\n- hudi-cli/src/test/java/org/apache/hudi/cli/commands/TestUpgradeDowngradeCommand.java\n- hudi-cli/src/test/java/org/apache/hudi/cli/integ/ITTestCommitsCommand.java\n- hudi-cli/src/test/java/org/apache/hudi/cli/testutils/HoodieTestCommitMetadataGenerator.java\n- hudi-client/src/test/java/org/apache/hudi/client/TestHoodieClientOnCopyOnWriteStorage.java"}, "afterCommit": {"oid": "52d31b061184ea94809c8a191ca9a817e39436a3", "author": {"user": {"login": "xushiyan", "name": "Raymond Xu"}}, "url": "https://github.com/apache/hudi/commit/52d31b061184ea94809c8a191ca9a817e39436a3", "committedDate": "2020-09-25T02:41:18Z", "message": "[HUDI-995] Migrate HoodieTestUtils APIs to HoodieTestTable\n\nRemove APIs in HoodieTestUtils\n\n- HoodieTestUtils#createInflightCommitFiles\n- HoodieTestUtils#getCommitFilePath\n- HoodieTestUtils#doesCommitExist\n\nand migrate usages to HoodieTestTable in\n\n- hudi-cli/src/test/java/org/apache/hudi/cli/commands/TestRollbacksCommand.java\n- hudi-cli/src/test/java/org/apache/hudi/cli/commands/TestUpgradeDowngradeCommand.java\n- hudi-cli/src/test/java/org/apache/hudi/cli/integ/ITTestCommitsCommand.java\n- hudi-cli/src/test/java/org/apache/hudi/cli/testutils/HoodieTestCommitMetadataGenerator.java\n- hudi-client/src/test/java/org/apache/hudi/client/TestHoodieClientOnCopyOnWriteStorage.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5171847b208e25557d23f81cc916f2646e0eb938", "author": {"user": {"login": "xushiyan", "name": "Raymond Xu"}}, "url": "https://github.com/apache/hudi/commit/5171847b208e25557d23f81cc916f2646e0eb938", "committedDate": "2020-09-25T04:13:06Z", "message": "[HUDI-995] Migrate HoodieTestUtils APIs to HoodieTestTable\n\nRemove APIs in HoodieTestUtils\n\n- HoodieTestUtils#createInflightCommitFiles\n- HoodieTestUtils#getCommitFilePath\n- HoodieTestUtils#doesCommitExist\n\nand migrate usages to HoodieTestTable in\n\n- hudi-cli/src/test/java/org/apache/hudi/cli/commands/TestRollbacksCommand.java\n- hudi-cli/src/test/java/org/apache/hudi/cli/commands/TestUpgradeDowngradeCommand.java\n- hudi-cli/src/test/java/org/apache/hudi/cli/integ/ITTestCommitsCommand.java\n- hudi-cli/src/test/java/org/apache/hudi/cli/testutils/HoodieTestCommitMetadataGenerator.java\n- hudi-client/src/test/java/org/apache/hudi/client/TestHoodieClientOnCopyOnWriteStorage.java"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "52d31b061184ea94809c8a191ca9a817e39436a3", "author": {"user": {"login": "xushiyan", "name": "Raymond Xu"}}, "url": "https://github.com/apache/hudi/commit/52d31b061184ea94809c8a191ca9a817e39436a3", "committedDate": "2020-09-25T02:41:18Z", "message": "[HUDI-995] Migrate HoodieTestUtils APIs to HoodieTestTable\n\nRemove APIs in HoodieTestUtils\n\n- HoodieTestUtils#createInflightCommitFiles\n- HoodieTestUtils#getCommitFilePath\n- HoodieTestUtils#doesCommitExist\n\nand migrate usages to HoodieTestTable in\n\n- hudi-cli/src/test/java/org/apache/hudi/cli/commands/TestRollbacksCommand.java\n- hudi-cli/src/test/java/org/apache/hudi/cli/commands/TestUpgradeDowngradeCommand.java\n- hudi-cli/src/test/java/org/apache/hudi/cli/integ/ITTestCommitsCommand.java\n- hudi-cli/src/test/java/org/apache/hudi/cli/testutils/HoodieTestCommitMetadataGenerator.java\n- hudi-client/src/test/java/org/apache/hudi/client/TestHoodieClientOnCopyOnWriteStorage.java"}, "afterCommit": {"oid": "5171847b208e25557d23f81cc916f2646e0eb938", "author": {"user": {"login": "xushiyan", "name": "Raymond Xu"}}, "url": "https://github.com/apache/hudi/commit/5171847b208e25557d23f81cc916f2646e0eb938", "committedDate": "2020-09-25T04:13:06Z", "message": "[HUDI-995] Migrate HoodieTestUtils APIs to HoodieTestTable\n\nRemove APIs in HoodieTestUtils\n\n- HoodieTestUtils#createInflightCommitFiles\n- HoodieTestUtils#getCommitFilePath\n- HoodieTestUtils#doesCommitExist\n\nand migrate usages to HoodieTestTable in\n\n- hudi-cli/src/test/java/org/apache/hudi/cli/commands/TestRollbacksCommand.java\n- hudi-cli/src/test/java/org/apache/hudi/cli/commands/TestUpgradeDowngradeCommand.java\n- hudi-cli/src/test/java/org/apache/hudi/cli/integ/ITTestCommitsCommand.java\n- hudi-cli/src/test/java/org/apache/hudi/cli/testutils/HoodieTestCommitMetadataGenerator.java\n- hudi-client/src/test/java/org/apache/hudi/client/TestHoodieClientOnCopyOnWriteStorage.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2MzcyMjIw", "url": "https://github.com/apache/hudi/pull/2112#pullrequestreview-496372220", "createdAt": "2020-09-25T12:26:43Z", "commit": {"oid": "5171847b208e25557d23f81cc916f2646e0eb938"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxMjoyNjo0M1rOHYBfYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxMjoyNjo1OVrOHYBf-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDk1MjI5MQ==", "bodyText": "Why we should do this refactor?", "url": "https://github.com/apache/hudi/pull/2112#discussion_r494952291", "createdAt": "2020-09-25T12:26:43Z", "author": {"login": "yanghua"}, "path": "hudi-cli/src/test/java/org/apache/hudi/cli/commands/TestCommitsCommand.java", "diffHunk": "@@ -76,17 +76,19 @@ public void init() throws IOException {\n         \"\", TimelineLayoutVersion.VERSION_1, \"org.apache.hudi.common.model.HoodieAvroPayload\");\n   }\n \n-  private LinkedHashMap<String, Integer[]> generateData() {\n+  private LinkedHashMap<String, Integer[]> generateData() throws Exception {\n     // generate data and metadata\n     LinkedHashMap<String, Integer[]> data = new LinkedHashMap<>();\n     data.put(\"102\", new Integer[] {15, 10});\n     data.put(\"101\", new Integer[] {20, 10});\n     data.put(\"100\", new Integer[] {15, 15});\n \n-    data.forEach((key, value) -> {\n+    for (Map.Entry<String, Integer[]> entry : data.entrySet()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5171847b208e25557d23f81cc916f2646e0eb938"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDk1MjQ0Mg==", "bodyText": "ditto", "url": "https://github.com/apache/hudi/pull/2112#discussion_r494952442", "createdAt": "2020-09-25T12:26:59Z", "author": {"login": "yanghua"}, "path": "hudi-cli/src/test/java/org/apache/hudi/cli/commands/TestCommitsCommand.java", "diffHunk": "@@ -168,10 +170,12 @@ public void testShowArchivedCommits() throws IOException {\n     data.put(\"102\", new Integer[] {25, 45});\n     data.put(\"101\", new Integer[] {35, 15});\n \n-    data.forEach((key, value) -> {\n+    for (Map.Entry<String, Integer[]> entry : data.entrySet()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5171847b208e25557d23f81cc916f2646e0eb938"}, "originalPosition": 46}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3MDA0MzU2", "url": "https://github.com/apache/hudi/pull/2112#pullrequestreview-497004356", "createdAt": "2020-09-26T13:21:09Z", "commit": {"oid": "5171847b208e25557d23f81cc916f2646e0eb938"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4574, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}