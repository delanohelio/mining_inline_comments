{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE2MDY3MDI5", "number": 2231, "title": "[HUDI-1373] Add Support for OpenJ9 JVM", "bodyText": "What is the purpose of the pull request\n\nAdd Support for OpenJ9 JVM by enabling the ObjectSizeCalculator to work also with OpenJ9 VM.\nThe implementation was done after a discussion with the OpenJ9 JVM community in Slack and by mail.\nThe following links were used as well in order to find out reasonable values for the MemoryLayoutSpecification implementation:\nhttps://blog.openj9.org/2020/06/02/arraylets-what-are-they/\nhttps://github.com/eclipse/openj9/blob/master/runtime/oti/j9nonbuilder.h#L2916:L2963\nhttps://github.com/eclipse/openj9/blob/master/runtime/oti/j9consts.h#L457\n\nthis also relates to HUDI-234\nBrief change log\n\nChanging the getEffectiveMemoryLayoutSpecification function in the ObjectSizeCalculator class to support also OpenJ9 jvm\n\nVerify this pull request\n\nWas tested on OpenJ9 VM\nTests are running fine\n\nCommitter checklist\n\n\n Has a corresponding JIRA in PR title & commit\n\n\n Commit message is descriptive of the change\n\n\n CI is green\n\n\n Necessary doc changes done or have another open PR\n\n\n For large changes, please consider breaking it into sub-tasks under an umbrella JIRA.", "createdAt": "2020-11-05T13:39:28Z", "url": "https://github.com/apache/hudi/pull/2231", "merged": true, "mergeCommit": {"oid": "b826c53e331fa5a80b7f9505dcdee0cbf16740e2"}, "closed": true, "closedAt": "2020-12-01T21:19:41Z", "author": {"login": "guykhazma"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdYMEH9gH2gAyNTE2MDY3MDI5OjQ3NTIxZGY2NzNhNmJhNzY5NzU2MDg2MDYwNmU4N2VhYWE3MmFlZmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdiAsImAFqTU0MjMwNDIzOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "47521df673a6ba7697560860606e87eaaa72aeff", "author": {"user": {"login": "guykhazma", "name": "Guy Khazma"}}, "url": "https://github.com/apache/hudi/commit/47521df673a6ba7697560860606e87eaaa72aeff", "committedDate": "2020-11-01T08:54:47Z", "message": "add supoort for OpenJ9 VM"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b3e05f195a51e81d33efb3920aa2bfbee2be01f7", "author": {"user": {"login": "guykhazma", "name": "Guy Khazma"}}, "url": "https://github.com/apache/hudi/commit/b3e05f195a51e81d33efb3920aa2bfbee2be01f7", "committedDate": "2020-11-01T08:55:34Z", "message": "Merge branch 'master' into addOpenJ9Support"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47ea7c8a95e3080c8c3b25d7e0509a1091525164", "author": {"user": {"login": "guykhazma", "name": "Guy Khazma"}}, "url": "https://github.com/apache/hudi/commit/47ea7c8a95e3080c8c3b25d7e0509a1091525164", "committedDate": "2020-11-01T08:58:04Z", "message": "minor fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7642d44d4f0ea705c6039bd8589406c2dd0b864", "author": {"user": {"login": "guykhazma", "name": "Guy Khazma"}}, "url": "https://github.com/apache/hudi/commit/d7642d44d4f0ea705c6039bd8589406c2dd0b864", "committedDate": "2020-11-02T06:54:50Z", "message": "add 32bit openJ9"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9be93b4596ba9c28d774f8cf8025fa46f62d6c40", "author": {"user": {"login": "guykhazma", "name": "Guy Khazma"}}, "url": "https://github.com/apache/hudi/commit/9be93b4596ba9c28d774f8cf8025fa46f62d6c40", "committedDate": "2020-11-05T12:35:14Z", "message": "Merge branch 'master' into addOpenJ9Support"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2MTQyMTU0", "url": "https://github.com/apache/hudi/pull/2231#pullrequestreview-536142154", "createdAt": "2020-11-23T01:34:36Z", "commit": {"oid": "9be93b4596ba9c28d774f8cf8025fa46f62d6c40"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QwMTozNDozNlrOH39TZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QwMTo1NTozMFrOH39fUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQzODExOQ==", "bodyText": "Not directly related to this PR. But given we are now actually evolving this code. Does it make sense to declare all the MemoryLayoutSpecification objects as descriptively named classes? That way this method is very readable.  Food for thought.", "url": "https://github.com/apache/hudi/pull/2231#discussion_r528438119", "createdAt": "2020-11-23T01:34:36Z", "author": {"login": "vinothchandar"}, "path": "hudi-common/src/main/java/org/apache/hudi/common/util/ObjectSizeCalculator.java", "diffHunk": "@@ -328,54 +328,53 @@ private static long getPrimitiveFieldSize(Class<?> type) {\n   static MemoryLayoutSpecification getEffectiveMemoryLayoutSpecification() {\n     final String vmName = System.getProperty(\"java.vm.name\");\n     if (vmName == null || !(vmName.startsWith(\"Java HotSpot(TM) \") || vmName.startsWith(\"OpenJDK\")\n-        || vmName.startsWith(\"TwitterJDK\"))) {\n-      throw new UnsupportedOperationException(\"ObjectSizeCalculator only supported on HotSpot VM\");\n+        || vmName.startsWith(\"TwitterJDK\") || vmName.startsWith(\"Eclipse OpenJ9\"))) {\n+      throw new UnsupportedOperationException(\"ObjectSizeCalculator only supported on HotSpot or Eclipse OpenJ9 VMs\");\n     }\n \n-    final String dataModel = System.getProperty(\"sun.arch.data.model\");\n-    if (\"32\".equals(dataModel)) {\n-      // Running with 32-bit data model\n-      return new MemoryLayoutSpecification() {\n-        @Override\n-        public int getArrayHeaderSize() {\n-          return 12;\n-        }\n+    final String strVmVersion = System.getProperty(\"java.vm.version\");\n+    // Support for OpenJ9 JVM\n+    if (strVmVersion.startsWith(\"openj9\")) {\n+      final String dataModel = System.getProperty(\"sun.arch.data.model\");\n+      if (\"32\".equals(dataModel)) {\n+        // Running with 32-bit data model\n+        return new MemoryLayoutSpecification() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9be93b4596ba9c28d774f8cf8025fa46f62d6c40"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQ0MTE3MA==", "bodyText": "Guess this was the original code. that only handled hotspot vm", "url": "https://github.com/apache/hudi/pull/2231#discussion_r528441170", "createdAt": "2020-11-23T01:55:30Z", "author": {"login": "vinothchandar"}, "path": "hudi-common/src/main/java/org/apache/hudi/common/util/ObjectSizeCalculator.java", "diffHunk": "@@ -384,9 +383,69 @@ public int getArrayHeaderSize() {\n \n           @Override\n           public int getObjectHeaderSize() {\n+            return 4;\n+          }\n+\n+          @Override\n+          public int getObjectPadding() {\n+            return 4;\n+          }\n+\n+          @Override\n+          public int getReferenceSize() {\n+            return 4;\n+          }\n+\n+          @Override\n+          public int getSuperclassFieldPadding() {\n+            return 4;\n+          }\n+        };\n+      } else {\n+        // it's a 64-bit uncompressed references object model\n+        return new MemoryLayoutSpecification() {\n+          @Override\n+          public int getArrayHeaderSize() {\n+            return 16;\n+          }\n+\n+          @Override\n+          public int getObjectHeaderSize() {\n+            return 16;\n+          }\n+\n+          @Override\n+          public int getObjectPadding() {\n+            return 8;\n+          }\n+\n+          @Override\n+          public int getReferenceSize() {\n+            return 8;\n+          }\n+\n+          @Override\n+          public int getSuperclassFieldPadding() {\n+            return 8;\n+          }\n+        };\n+      }\n+    } else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9be93b4596ba9c28d774f8cf8025fa46f62d6c40"}, "originalPosition": 151}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a0107c3f71079ec6b776ba034728e8deb29067a", "author": {"user": {"login": "guykhazma", "name": "Guy Khazma"}}, "url": "https://github.com/apache/hudi/commit/4a0107c3f71079ec6b776ba034728e8deb29067a", "committedDate": "2020-11-23T15:21:48Z", "message": "Merge branch 'master' into addOpenJ9Support"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f184406e6e0b7b091a3367cdc798f2699e8e99f2", "author": {"user": {"login": "guykhazma", "name": "Guy Khazma"}}, "url": "https://github.com/apache/hudi/commit/f184406e6e0b7b091a3367cdc798f2699e8e99f2", "committedDate": "2020-11-23T19:25:43Z", "message": "refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54a69be551d078a9d386db544ebd7c02dab273e6", "author": {"user": {"login": "guykhazma", "name": "Guy Khazma"}}, "url": "https://github.com/apache/hudi/commit/54a69be551d078a9d386db544ebd7c02dab273e6", "committedDate": "2020-11-23T19:26:11Z", "message": "refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11e5ce31f5ffb1cd1044942ecdff019b2c9918a9", "author": {"user": {"login": "guykhazma", "name": "Guy Khazma"}}, "url": "https://github.com/apache/hudi/commit/11e5ce31f5ffb1cd1044942ecdff019b2c9918a9", "committedDate": "2020-11-23T19:28:24Z", "message": "add license"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ce17628a17a8a378b0ae7ffa1aa5d3826a66933", "author": {"user": {"login": "guykhazma", "name": "Guy Khazma"}}, "url": "https://github.com/apache/hudi/commit/4ce17628a17a8a378b0ae7ffa1aa5d3826a66933", "committedDate": "2020-12-01T09:11:18Z", "message": "Merge branch 'master' into addOpenJ9Support"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyMzA0MjM4", "url": "https://github.com/apache/hudi/pull/2231#pullrequestreview-542304238", "createdAt": "2020-12-01T21:18:52Z", "commit": {"oid": "4ce17628a17a8a378b0ae7ffa1aa5d3826a66933"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4275, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}