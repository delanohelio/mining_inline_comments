{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU2MDgyNTI2", "number": 1870, "reviewThreads": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMTo1MTowOVrOET22xg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNzo1NjowMFrOEW5jtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5MjU3MTU4OnYy", "diffSide": "RIGHT", "path": "hudi-client/src/test/java/org/apache/hudi/table/TestCleaner.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMTo1MTowOVrOG51F0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOFQwNzoxOTozOFrOG9uNpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzI5MTg1Nw==", "bodyText": "I see some private functions in this class to test cleaning based on commits and file versions, that are re-used by other tests. Is it possible to re-use some of these already created ones. May be introduce another boolean flag for bootstrap which can do additional creation of source files and later check if they are cleaned up.", "url": "https://github.com/apache/hudi/pull/1870#discussion_r463291857", "createdAt": "2020-07-30T21:51:09Z", "author": {"login": "umehrot2"}, "path": "hudi-client/src/test/java/org/apache/hudi/table/TestCleaner.java", "diffHunk": "@@ -885,6 +888,109 @@ private void testKeepLatestCommits(boolean simulateFailureRetry, boolean enableI\n         file2P0C1));\n   }\n \n+  @Test\n+  public void testBootstrapSourceFileCleanWithKeepLatestFileVersions() throws IOException {\n+    testBootstrapSourceFileClean(HoodieCleaningPolicy.KEEP_LATEST_FILE_VERSIONS);\n+  }\n+\n+  @Test\n+  public void testBootstrapSourceFileCleanWithKeepLatestCommits() throws IOException {\n+    testBootstrapSourceFileClean(HoodieCleaningPolicy.KEEP_LATEST_COMMITS);\n+  }\n+\n+  /**\n+   * Test HoodieTable.clean() with Bootstrap source file clean enable.\n+   */\n+  @Test\n+  private void testBootstrapSourceFileClean(HoodieCleaningPolicy cleaningPolicy) throws IOException {\n+    HoodieWriteConfig config = HoodieWriteConfig.newBuilder().withPath(basePath).withAssumeDatePartitioning(true)\n+        .withCompactionConfig(HoodieCompactionConfig.newBuilder()\n+            .withCleanBootstrapSourceFileEnabled(true)\n+            .withCleanerPolicy(cleaningPolicy).retainCommits(1).retainFileVersions(2).build())\n+        .build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "946b08eeab23a8fe78d5916b96e502714fa9bee7"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM3MzQ3Nw==", "bodyText": "Rewrote the test part to make use of the original test code.", "url": "https://github.com/apache/hudi/pull/1870#discussion_r467373477", "createdAt": "2020-08-08T07:19:38Z", "author": {"login": "zhedoubushishi"}, "path": "hudi-client/src/test/java/org/apache/hudi/table/TestCleaner.java", "diffHunk": "@@ -885,6 +888,109 @@ private void testKeepLatestCommits(boolean simulateFailureRetry, boolean enableI\n         file2P0C1));\n   }\n \n+  @Test\n+  public void testBootstrapSourceFileCleanWithKeepLatestFileVersions() throws IOException {\n+    testBootstrapSourceFileClean(HoodieCleaningPolicy.KEEP_LATEST_FILE_VERSIONS);\n+  }\n+\n+  @Test\n+  public void testBootstrapSourceFileCleanWithKeepLatestCommits() throws IOException {\n+    testBootstrapSourceFileClean(HoodieCleaningPolicy.KEEP_LATEST_COMMITS);\n+  }\n+\n+  /**\n+   * Test HoodieTable.clean() with Bootstrap source file clean enable.\n+   */\n+  @Test\n+  private void testBootstrapSourceFileClean(HoodieCleaningPolicy cleaningPolicy) throws IOException {\n+    HoodieWriteConfig config = HoodieWriteConfig.newBuilder().withPath(basePath).withAssumeDatePartitioning(true)\n+        .withCompactionConfig(HoodieCompactionConfig.newBuilder()\n+            .withCleanBootstrapSourceFileEnabled(true)\n+            .withCleanerPolicy(cleaningPolicy).retainCommits(1).retainFileVersions(2).build())\n+        .build();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzI5MTg1Nw=="}, "originalCommit": {"oid": "946b08eeab23a8fe78d5916b96e502714fa9bee7"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxMjE4NTY0OnYy", "diffSide": "RIGHT", "path": "hudi-common/src/test/java/org/apache/hudi/common/testutils/HoodieTestUtils.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwODo0MzoyMVrOG8pN8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQyMzo0MDo0OFrOG9HsiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjI0MzA1Ng==", "bodyText": "can we move these to the test class itself? these are very specific to bootstrap.", "url": "https://github.com/apache/hudi/pull/1870#discussion_r466243056", "createdAt": "2020-08-06T08:43:21Z", "author": {"login": "vinothchandar"}, "path": "hudi-common/src/test/java/org/apache/hudi/common/testutils/HoodieTestUtils.java", "diffHunk": "@@ -513,4 +522,41 @@ public static void writeRecordsToLogFiles(FileSystem fs, String basePath, Schema\n     }\n     return writeStatList;\n   }\n+\n+  public static Map<String, List<BootstrapSourceFileMapping>> generateBootstrapIndex(HoodieTableMetaClient metaClient,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "946b08eeab23a8fe78d5916b96e502714fa9bee7"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njc0MjQwOQ==", "bodyText": "Sure. Done.", "url": "https://github.com/apache/hudi/pull/1870#discussion_r466742409", "createdAt": "2020-08-06T23:40:48Z", "author": {"login": "zhedoubushishi"}, "path": "hudi-common/src/test/java/org/apache/hudi/common/testutils/HoodieTestUtils.java", "diffHunk": "@@ -513,4 +522,41 @@ public static void writeRecordsToLogFiles(FileSystem fs, String basePath, Schema\n     }\n     return writeStatList;\n   }\n+\n+  public static Map<String, List<BootstrapSourceFileMapping>> generateBootstrapIndex(HoodieTableMetaClient metaClient,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjI0MzA1Ng=="}, "originalCommit": {"oid": "946b08eeab23a8fe78d5916b96e502714fa9bee7"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxOTY3NzI5OnYy", "diffSide": "RIGHT", "path": "hudi-client/src/main/java/org/apache/hudi/table/action/clean/CleanActionExecutor.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOFQwODo1MDoxMVrOG9v8kA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOVQwMTo1OToxNFrOG93cJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzQwMTg3Mg==", "bodyText": "@zhedoubushishi : I think this is an unnecessary call we will be making per file deletion. With embedded timeline service, this request will be routed to driver. Instead, I think we can handle it using versioning in clean plan.  Thoughts ?", "url": "https://github.com/apache/hudi/pull/1870#discussion_r467401872", "createdAt": "2020-08-08T08:50:11Z", "author": {"login": "bvaradar"}, "path": "hudi-client/src/main/java/org/apache/hudi/table/action/clean/CleanActionExecutor.java", "diffHunk": "@@ -116,6 +119,19 @@ HoodieCleanerPlan requestClean(JavaSparkContext jsc) {\n         PartitionCleanStat partitionCleanStat = partitionCleanStatMap.get(partitionPath);\n         partitionCleanStat.addDeleteFilePatterns(deletePath.getName());\n         partitionCleanStat.addDeletedFileResult(deletePath.getName(), deletedFileResult);\n+\n+        // If CleanBootstrapSourceFileEnabled and it is a metadata bootstrap commit, also delete the corresponding source file\n+        if (cleanBootstrapSourceFileEnabled && !FSUtils.isLogFile(deletePath)\n+            && FSUtils.getCommitTime(delFileName).equals(HoodieTimeline.METADATA_BOOTSTRAP_INSTANT_TS)) {\n+          Option<HoodieBaseFile> baseFile = fileSystemView.getBaseFileOn(partitionPath,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "82edf2206f83574f1577175cfa2606039683ffea"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzQ5Njk0NQ==", "bodyText": "I see what you mean. Yea we should avoid making unnecessary calls. So regarding to versioning, do you mean create a class like TimelineLayoutVersion or just simply handle this logic in the CleanActionExecutor. For example, if the parameter is a full file path then delete it. Else if the parameter is a file name, generate the file path and then delete it.", "url": "https://github.com/apache/hudi/pull/1870#discussion_r467496945", "createdAt": "2020-08-08T19:34:04Z", "author": {"login": "zhedoubushishi"}, "path": "hudi-client/src/main/java/org/apache/hudi/table/action/clean/CleanActionExecutor.java", "diffHunk": "@@ -116,6 +119,19 @@ HoodieCleanerPlan requestClean(JavaSparkContext jsc) {\n         PartitionCleanStat partitionCleanStat = partitionCleanStatMap.get(partitionPath);\n         partitionCleanStat.addDeleteFilePatterns(deletePath.getName());\n         partitionCleanStat.addDeletedFileResult(deletePath.getName(), deletedFileResult);\n+\n+        // If CleanBootstrapSourceFileEnabled and it is a metadata bootstrap commit, also delete the corresponding source file\n+        if (cleanBootstrapSourceFileEnabled && !FSUtils.isLogFile(deletePath)\n+            && FSUtils.getCommitTime(delFileName).equals(HoodieTimeline.METADATA_BOOTSTRAP_INSTANT_TS)) {\n+          Option<HoodieBaseFile> baseFile = fileSystemView.getBaseFileOn(partitionPath,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzQwMTg3Mg=="}, "originalCommit": {"oid": "82edf2206f83574f1577175cfa2606039683ffea"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzUyNDUwOQ==", "bodyText": "@zhedoubushishi : Tried reaching you on slack :) to discuss an approach. I went ahead and implemented it in the interest of time.\nThe basic idea is to ensure that Cleaner plan stores necessary information related to files to be deleted including bootstrap base files. The cleaner executor will simply read the cleaner plan and be able to distinguish normal vs bootstrap base files. It goes ahead and deletes those files. For bootstrap base files, it records the complete path of the file it deleted in a separate (new) avro field. This is very important in order to ensure incremental timeline syncing (which reads these metadata) to work properly.\nPlease take a look at this code changes if possible.\n( @vinothchandar  @umehrot2  : FYI )", "url": "https://github.com/apache/hudi/pull/1870#discussion_r467524509", "createdAt": "2020-08-09T01:56:56Z", "author": {"login": "bvaradar"}, "path": "hudi-client/src/main/java/org/apache/hudi/table/action/clean/CleanActionExecutor.java", "diffHunk": "@@ -116,6 +119,19 @@ HoodieCleanerPlan requestClean(JavaSparkContext jsc) {\n         PartitionCleanStat partitionCleanStat = partitionCleanStatMap.get(partitionPath);\n         partitionCleanStat.addDeleteFilePatterns(deletePath.getName());\n         partitionCleanStat.addDeletedFileResult(deletePath.getName(), deletedFileResult);\n+\n+        // If CleanBootstrapSourceFileEnabled and it is a metadata bootstrap commit, also delete the corresponding source file\n+        if (cleanBootstrapSourceFileEnabled && !FSUtils.isLogFile(deletePath)\n+            && FSUtils.getCommitTime(delFileName).equals(HoodieTimeline.METADATA_BOOTSTRAP_INSTANT_TS)) {\n+          Option<HoodieBaseFile> baseFile = fileSystemView.getBaseFileOn(partitionPath,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzQwMTg3Mg=="}, "originalCommit": {"oid": "82edf2206f83574f1577175cfa2606039683ffea"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzUyNDY0NQ==", "bodyText": "@zhedoubushishi : Please also note that for ensuring backwards compatibility, I add a migrator class (CleanPlanMigrator.java) to handle pre and post 0.6  .clean.requested files.", "url": "https://github.com/apache/hudi/pull/1870#discussion_r467524645", "createdAt": "2020-08-09T01:59:14Z", "author": {"login": "bvaradar"}, "path": "hudi-client/src/main/java/org/apache/hudi/table/action/clean/CleanActionExecutor.java", "diffHunk": "@@ -116,6 +119,19 @@ HoodieCleanerPlan requestClean(JavaSparkContext jsc) {\n         PartitionCleanStat partitionCleanStat = partitionCleanStatMap.get(partitionPath);\n         partitionCleanStat.addDeleteFilePatterns(deletePath.getName());\n         partitionCleanStat.addDeletedFileResult(deletePath.getName(), deletedFileResult);\n+\n+        // If CleanBootstrapSourceFileEnabled and it is a metadata bootstrap commit, also delete the corresponding source file\n+        if (cleanBootstrapSourceFileEnabled && !FSUtils.isLogFile(deletePath)\n+            && FSUtils.getCommitTime(delFileName).equals(HoodieTimeline.METADATA_BOOTSTRAP_INSTANT_TS)) {\n+          Option<HoodieBaseFile> baseFile = fileSystemView.getBaseFileOn(partitionPath,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzQwMTg3Mg=="}, "originalCommit": {"oid": "82edf2206f83574f1577175cfa2606039683ffea"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyMDYxNjk3OnYy", "diffSide": "LEFT", "path": "hudi-common/src/main/avro/HoodieCleanMetadata.avsc", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOVQwMjoyMTowNFrOG93iCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOVQyMjo1MDo0NFrOG9-XxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzUyNjE1NA==", "bodyText": "this is not deletion. I simply moved this to a separate file for it to be referenced in another place. The idea is to keep these information for bootstrap base files in a separate Avro field for it to be skipped by incremental timeline syncing.", "url": "https://github.com/apache/hudi/pull/1870#discussion_r467526154", "createdAt": "2020-08-09T02:21:04Z", "author": {"login": "bvaradar"}, "path": "hudi-common/src/main/avro/HoodieCleanMetadata.avsc", "diffHunk": "@@ -24,23 +24,22 @@\n      {\"name\": \"totalFilesDeleted\", \"type\": \"int\"},\n      {\"name\": \"earliestCommitToRetain\", \"type\": \"string\"},\n      {\"name\": \"partitionMetadata\", \"type\": {\n-     \"type\" : \"map\", \"values\" : {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8344982d6c125e70faa3ea83ac0dcd612d14694f"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzYzODIxMw==", "bodyText": "do we know that would be backwards compatible?", "url": "https://github.com/apache/hudi/pull/1870#discussion_r467638213", "createdAt": "2020-08-09T22:50:44Z", "author": {"login": "vinothchandar"}, "path": "hudi-common/src/main/avro/HoodieCleanMetadata.avsc", "diffHunk": "@@ -24,23 +24,22 @@\n      {\"name\": \"totalFilesDeleted\", \"type\": \"int\"},\n      {\"name\": \"earliestCommitToRetain\", \"type\": \"string\"},\n      {\"name\": \"partitionMetadata\", \"type\": {\n-     \"type\" : \"map\", \"values\" : {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzUyNjE1NA=="}, "originalCommit": {"oid": "8344982d6c125e70faa3ea83ac0dcd612d14694f"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyMDYxNzk0OnYy", "diffSide": "RIGHT", "path": "hudi-common/src/main/avro/HoodieCleanerPlan.avsc", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOVQwMjoyMjozOVrOG93ifw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOVQwMjoyMjozOVrOG93ifw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzUyNjI3MQ==", "bodyText": "I am adding a new field filePathsToBeDeletedPerPartition which deprecates filesToBeDeletedPerPartition field. filePathsToBeDeletedPerPartition retains information to distinguish cleaning of regular hudi and bootstrap base files.", "url": "https://github.com/apache/hudi/pull/1870#discussion_r467526271", "createdAt": "2020-08-09T02:22:39Z", "author": {"login": "bvaradar"}, "path": "hudi-common/src/main/avro/HoodieCleanerPlan.avsc", "diffHunk": "@@ -47,6 +47,7 @@\n       \"type\": \"string\"\n     },\n     {\n+      /** This is deprecated and replaced by the field filePathsToBeDeletedPerPartition **/", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8344982d6c125e70faa3ea83ac0dcd612d14694f"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyMTQ1OTE5OnYy", "diffSide": "RIGHT", "path": "hudi-client/src/main/java/org/apache/hudi/config/HoodieCompactionConfig.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOVQyMTowNDowOVrOG99yaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwNzozNDo0MFrOG-r2xw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzYyODY0OQ==", "bodyText": "rename : hoodie.cleaner.delete.bootstrap.base.file ?", "url": "https://github.com/apache/hudi/pull/1870#discussion_r467628649", "createdAt": "2020-08-09T21:04:09Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/src/main/java/org/apache/hudi/config/HoodieCompactionConfig.java", "diffHunk": "@@ -52,6 +52,8 @@\n   public static final String MAX_COMMITS_TO_KEEP_PROP = \"hoodie.keep.max.commits\";\n   public static final String MIN_COMMITS_TO_KEEP_PROP = \"hoodie.keep.min.commits\";\n   public static final String COMMITS_ARCHIVAL_BATCH_SIZE_PROP = \"hoodie.commits.archival.batch\";\n+  // Set true to clean bootstrap source files when necessary\n+  public static final String CLEANER_BOOTSTRAP_BASE_FILE_ENABLED = \"hoodie.cleaner.bootstrap.base.file\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "896828d0340183369b8faf0c96721f446c30135f"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM4MzQzMQ==", "bodyText": "Done", "url": "https://github.com/apache/hudi/pull/1870#discussion_r468383431", "createdAt": "2020-08-11T07:34:40Z", "author": {"login": "bvaradar"}, "path": "hudi-client/src/main/java/org/apache/hudi/config/HoodieCompactionConfig.java", "diffHunk": "@@ -52,6 +52,8 @@\n   public static final String MAX_COMMITS_TO_KEEP_PROP = \"hoodie.keep.max.commits\";\n   public static final String MIN_COMMITS_TO_KEEP_PROP = \"hoodie.keep.min.commits\";\n   public static final String COMMITS_ARCHIVAL_BATCH_SIZE_PROP = \"hoodie.commits.archival.batch\";\n+  // Set true to clean bootstrap source files when necessary\n+  public static final String CLEANER_BOOTSTRAP_BASE_FILE_ENABLED = \"hoodie.cleaner.bootstrap.base.file\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzYyODY0OQ=="}, "originalCommit": {"oid": "896828d0340183369b8faf0c96721f446c30135f"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyMzYxNTk5OnYy", "diffSide": "RIGHT", "path": "hudi-client/src/main/java/org/apache/hudi/table/action/clean/CleanActionExecutor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNDoyOTo1OFrOG-RDBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwNzozMzoyN1rOG-r0eg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzk0NDE5Ng==", "bodyText": "stylistic: in general, a stream within stream is a bit hard to read. flatMap() first? but guess this is a map. probably using a named lambda function may help", "url": "https://github.com/apache/hudi/pull/1870#discussion_r467944196", "createdAt": "2020-08-10T14:29:58Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/src/main/java/org/apache/hudi/table/action/clean/CleanActionExecutor.java", "diffHunk": "@@ -82,40 +83,45 @@ HoodieCleanerPlan requestClean(JavaSparkContext jsc) {\n       LOG.info(\"Using cleanerParallelism: \" + cleanerParallelism);\n \n       jsc.setJobGroup(this.getClass().getSimpleName(), \"Generates list of file slices to be cleaned\");\n-      Map<String, List<String>> cleanOps = jsc\n+      Map<String, List<HoodieCleanFileInfo>> cleanOps = jsc\n           .parallelize(partitionsToClean, cleanerParallelism)\n           .map(partitionPathToClean -> Pair.of(partitionPathToClean, planner.getDeletePaths(partitionPathToClean)))\n           .collect().stream()\n-          .collect(Collectors.toMap(Pair::getKey, Pair::getValue));\n+          .collect(Collectors.toMap(Pair::getKey,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "896828d0340183369b8faf0c96721f446c30135f"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM4Mjg0Mg==", "bodyText": "Done", "url": "https://github.com/apache/hudi/pull/1870#discussion_r468382842", "createdAt": "2020-08-11T07:33:27Z", "author": {"login": "bvaradar"}, "path": "hudi-client/src/main/java/org/apache/hudi/table/action/clean/CleanActionExecutor.java", "diffHunk": "@@ -82,40 +83,45 @@ HoodieCleanerPlan requestClean(JavaSparkContext jsc) {\n       LOG.info(\"Using cleanerParallelism: \" + cleanerParallelism);\n \n       jsc.setJobGroup(this.getClass().getSimpleName(), \"Generates list of file slices to be cleaned\");\n-      Map<String, List<String>> cleanOps = jsc\n+      Map<String, List<HoodieCleanFileInfo>> cleanOps = jsc\n           .parallelize(partitionsToClean, cleanerParallelism)\n           .map(partitionPathToClean -> Pair.of(partitionPathToClean, planner.getDeletePaths(partitionPathToClean)))\n           .collect().stream()\n-          .collect(Collectors.toMap(Pair::getKey, Pair::getValue));\n+          .collect(Collectors.toMap(Pair::getKey,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzk0NDE5Ng=="}, "originalCommit": {"oid": "896828d0340183369b8faf0c96721f446c30135f"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyMzYzNDU2OnYy", "diffSide": "RIGHT", "path": "hudi-client/src/main/java/org/apache/hudi/table/action/clean/CleanActionExecutor.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNDozNDoxMFrOG-ROWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwNzoxODowMVrOG-rWYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzk0NzA5OA==", "bodyText": "this is same as\npartitionCleanStat.addDeleteFilePatterns(deletePath.toString(), isBootstrapBasePathFile);\npartitionCleanStat.addDeletedFileResult(deletePath.toString(), deletedFileResult, isBootstrapBasePathFile);\n\nright", "url": "https://github.com/apache/hudi/pull/1870#discussion_r467947098", "createdAt": "2020-08-10T14:34:10Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/src/main/java/org/apache/hudi/table/action/clean/CleanActionExecutor.java", "diffHunk": "@@ -82,40 +83,45 @@ HoodieCleanerPlan requestClean(JavaSparkContext jsc) {\n       LOG.info(\"Using cleanerParallelism: \" + cleanerParallelism);\n \n       jsc.setJobGroup(this.getClass().getSimpleName(), \"Generates list of file slices to be cleaned\");\n-      Map<String, List<String>> cleanOps = jsc\n+      Map<String, List<HoodieCleanFileInfo>> cleanOps = jsc\n           .parallelize(partitionsToClean, cleanerParallelism)\n           .map(partitionPathToClean -> Pair.of(partitionPathToClean, planner.getDeletePaths(partitionPathToClean)))\n           .collect().stream()\n-          .collect(Collectors.toMap(Pair::getKey, Pair::getValue));\n+          .collect(Collectors.toMap(Pair::getKey,\n+            (y) -> y.getValue().stream().map(CleanFileInfo::toHoodieFileCleanInfo).collect(Collectors.toList())));\n \n       return new HoodieCleanerPlan(earliestInstant\n           .map(x -> new HoodieActionInstant(x.getTimestamp(), x.getAction(), x.getState().name())).orElse(null),\n-          config.getCleanerPolicy().name(), cleanOps, 1);\n+          config.getCleanerPolicy().name(), null, CleanPlanner.LATEST_CLEAN_PLAN_VERSION, cleanOps);\n     } catch (IOException e) {\n       throw new HoodieIOException(\"Failed to schedule clean operation\", e);\n     }\n   }\n \n-  private static PairFlatMapFunction<Iterator<Tuple2<String, String>>, String, PartitionCleanStat> deleteFilesFunc(\n-      HoodieTable table) {\n-    return (PairFlatMapFunction<Iterator<Tuple2<String, String>>, String, PartitionCleanStat>) iter -> {\n+  private static PairFlatMapFunction<Iterator<Tuple2<String, CleanFileInfo>>, String, PartitionCleanStat>\n+        deleteFilesFunc(HoodieTable table) {\n+    return (PairFlatMapFunction<Iterator<Tuple2<String, CleanFileInfo>>, String, PartitionCleanStat>) iter -> {\n       Map<String, PartitionCleanStat> partitionCleanStatMap = new HashMap<>();\n-\n       FileSystem fs = table.getMetaClient().getFs();\n-      Path basePath = new Path(table.getMetaClient().getBasePath());\n       while (iter.hasNext()) {\n-        Tuple2<String, String> partitionDelFileTuple = iter.next();\n+        Tuple2<String, CleanFileInfo> partitionDelFileTuple = iter.next();\n         String partitionPath = partitionDelFileTuple._1();\n-        String delFileName = partitionDelFileTuple._2();\n-        Path deletePath = FSUtils.getPartitionPath(FSUtils.getPartitionPath(basePath, partitionPath), delFileName);\n+        Path deletePath = new Path(partitionDelFileTuple._2().getFilePath());\n         String deletePathStr = deletePath.toString();\n         Boolean deletedFileResult = deleteFileAndGetResult(fs, deletePathStr);\n         if (!partitionCleanStatMap.containsKey(partitionPath)) {\n           partitionCleanStatMap.put(partitionPath, new PartitionCleanStat(partitionPath));\n         }\n+        boolean isBootstrapBasePathFile = partitionDelFileTuple._2().isBootstrapBaseFile();\n         PartitionCleanStat partitionCleanStat = partitionCleanStatMap.get(partitionPath);\n-        partitionCleanStat.addDeleteFilePatterns(deletePath.getName());\n-        partitionCleanStat.addDeletedFileResult(deletePath.getName(), deletedFileResult);\n+        if (isBootstrapBasePathFile) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "896828d0340183369b8faf0c96721f446c30135f"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM3NTEzNg==", "bodyText": "deletePath.toString() returns a full path whereas deletePath.getName() returns only the file name.  That was the reason why it was in if-else block.", "url": "https://github.com/apache/hudi/pull/1870#discussion_r468375136", "createdAt": "2020-08-11T07:18:01Z", "author": {"login": "bvaradar"}, "path": "hudi-client/src/main/java/org/apache/hudi/table/action/clean/CleanActionExecutor.java", "diffHunk": "@@ -82,40 +83,45 @@ HoodieCleanerPlan requestClean(JavaSparkContext jsc) {\n       LOG.info(\"Using cleanerParallelism: \" + cleanerParallelism);\n \n       jsc.setJobGroup(this.getClass().getSimpleName(), \"Generates list of file slices to be cleaned\");\n-      Map<String, List<String>> cleanOps = jsc\n+      Map<String, List<HoodieCleanFileInfo>> cleanOps = jsc\n           .parallelize(partitionsToClean, cleanerParallelism)\n           .map(partitionPathToClean -> Pair.of(partitionPathToClean, planner.getDeletePaths(partitionPathToClean)))\n           .collect().stream()\n-          .collect(Collectors.toMap(Pair::getKey, Pair::getValue));\n+          .collect(Collectors.toMap(Pair::getKey,\n+            (y) -> y.getValue().stream().map(CleanFileInfo::toHoodieFileCleanInfo).collect(Collectors.toList())));\n \n       return new HoodieCleanerPlan(earliestInstant\n           .map(x -> new HoodieActionInstant(x.getTimestamp(), x.getAction(), x.getState().name())).orElse(null),\n-          config.getCleanerPolicy().name(), cleanOps, 1);\n+          config.getCleanerPolicy().name(), null, CleanPlanner.LATEST_CLEAN_PLAN_VERSION, cleanOps);\n     } catch (IOException e) {\n       throw new HoodieIOException(\"Failed to schedule clean operation\", e);\n     }\n   }\n \n-  private static PairFlatMapFunction<Iterator<Tuple2<String, String>>, String, PartitionCleanStat> deleteFilesFunc(\n-      HoodieTable table) {\n-    return (PairFlatMapFunction<Iterator<Tuple2<String, String>>, String, PartitionCleanStat>) iter -> {\n+  private static PairFlatMapFunction<Iterator<Tuple2<String, CleanFileInfo>>, String, PartitionCleanStat>\n+        deleteFilesFunc(HoodieTable table) {\n+    return (PairFlatMapFunction<Iterator<Tuple2<String, CleanFileInfo>>, String, PartitionCleanStat>) iter -> {\n       Map<String, PartitionCleanStat> partitionCleanStatMap = new HashMap<>();\n-\n       FileSystem fs = table.getMetaClient().getFs();\n-      Path basePath = new Path(table.getMetaClient().getBasePath());\n       while (iter.hasNext()) {\n-        Tuple2<String, String> partitionDelFileTuple = iter.next();\n+        Tuple2<String, CleanFileInfo> partitionDelFileTuple = iter.next();\n         String partitionPath = partitionDelFileTuple._1();\n-        String delFileName = partitionDelFileTuple._2();\n-        Path deletePath = FSUtils.getPartitionPath(FSUtils.getPartitionPath(basePath, partitionPath), delFileName);\n+        Path deletePath = new Path(partitionDelFileTuple._2().getFilePath());\n         String deletePathStr = deletePath.toString();\n         Boolean deletedFileResult = deleteFileAndGetResult(fs, deletePathStr);\n         if (!partitionCleanStatMap.containsKey(partitionPath)) {\n           partitionCleanStatMap.put(partitionPath, new PartitionCleanStat(partitionPath));\n         }\n+        boolean isBootstrapBasePathFile = partitionDelFileTuple._2().isBootstrapBaseFile();\n         PartitionCleanStat partitionCleanStat = partitionCleanStatMap.get(partitionPath);\n-        partitionCleanStat.addDeleteFilePatterns(deletePath.getName());\n-        partitionCleanStat.addDeletedFileResult(deletePath.getName(), deletedFileResult);\n+        if (isBootstrapBasePathFile) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzk0NzA5OA=="}, "originalCommit": {"oid": "896828d0340183369b8faf0c96721f446c30135f"}, "originalPosition": 59}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyMzY3NzkwOnYy", "diffSide": "RIGHT", "path": "hudi-common/src/main/java/org/apache/hudi/common/HoodieCleanStat.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNDo0NDowOFrOG-RpTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNDo0NDowOFrOG-RpTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzk1Mzk5OQ==", "bodyText": "CollectionUtils.emptyList or something?", "url": "https://github.com/apache/hudi/pull/1870#discussion_r467953999", "createdAt": "2020-08-10T14:44:08Z", "author": {"login": "vinothchandar"}, "path": "hudi-common/src/main/java/org/apache/hudi/common/HoodieCleanStat.java", "diffHunk": "@@ -39,17 +40,34 @@\n   private final List<String> successDeleteFiles;\n   // Files that could not be deleted\n   private final List<String> failedDeleteFiles;\n+  // Boostrap Base Path patterns that were generated for the delete operation\n+  private final List<String> deleteBootstrapBasePathPatterns;\n+  private final List<String> successDeleteBootstrapBaseFiles;\n+  // Files that could not be deleted\n+  private final List<String> failedDeleteBootstrapBaseFiles;\n   // Earliest commit that was retained in this clean\n   private final String earliestCommitToRetain;\n \n   public HoodieCleanStat(HoodieCleaningPolicy policy, String partitionPath, List<String> deletePathPatterns,\n       List<String> successDeleteFiles, List<String> failedDeleteFiles, String earliestCommitToRetain) {\n+    this(policy, partitionPath, deletePathPatterns, successDeleteFiles, failedDeleteFiles, earliestCommitToRetain,\n+        new ArrayList<>(), new ArrayList<>(), new ArrayList<>());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "896828d0340183369b8faf0c96721f446c30135f"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyNDQxMjM2OnYy", "diffSide": "RIGHT", "path": "hudi-common/src/main/java/org/apache/hudi/common/HoodieCleanStat.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNzozOTozM1rOG-YtQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNzozOTozM1rOG-YtQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODA2OTY5OQ==", "bodyText": "[typo] boostrap -> bootstrap", "url": "https://github.com/apache/hudi/pull/1870#discussion_r468069699", "createdAt": "2020-08-10T17:39:33Z", "author": {"login": "zhedoubushishi"}, "path": "hudi-common/src/main/java/org/apache/hudi/common/HoodieCleanStat.java", "diffHunk": "@@ -39,17 +40,34 @@\n   private final List<String> successDeleteFiles;\n   // Files that could not be deleted\n   private final List<String> failedDeleteFiles;\n+  // Boostrap Base Path patterns that were generated for the delete operation", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "896828d0340183369b8faf0c96721f446c30135f"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyNDQxNzQ2OnYy", "diffSide": "RIGHT", "path": "hudi-common/src/main/java/org/apache/hudi/common/HoodieCleanStat.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNzo0MDo1OVrOG-YwTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNzo0MDo1OVrOG-YwTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODA3MDQ3OA==", "bodyText": "[nit] wrong line", "url": "https://github.com/apache/hudi/pull/1870#discussion_r468070478", "createdAt": "2020-08-10T17:40:59Z", "author": {"login": "zhedoubushishi"}, "path": "hudi-common/src/main/java/org/apache/hudi/common/HoodieCleanStat.java", "diffHunk": "@@ -18,6 +18,7 @@\n \n package org.apache.hudi.common;\n \n+import java.util.ArrayList;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "896828d0340183369b8faf0c96721f446c30135f"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyNDQ1MjU0OnYy", "diffSide": "RIGHT", "path": "hudi-common/src/main/java/org/apache/hudi/common/table/timeline/versioning/clean/CleanPlanV2MigrationHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNzo1MDo1MFrOG-ZGbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNzo1MDo1MFrOG-ZGbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODA3NjE0Mg==", "bodyText": "[nit] wrong line", "url": "https://github.com/apache/hudi/pull/1870#discussion_r468076142", "createdAt": "2020-08-10T17:50:50Z", "author": {"login": "zhedoubushishi"}, "path": "hudi-common/src/main/java/org/apache/hudi/common/table/timeline/versioning/clean/CleanPlanV2MigrationHandler.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.common.table.timeline.versioning.clean;\n+\n+import java.util.HashMap;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "896828d0340183369b8faf0c96721f446c30135f"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyNDQ3MTU4OnYy", "diffSide": "RIGHT", "path": "hudi-common/src/main/java/org/apache/hudi/common/util/CleanerUtils.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNzo1NjowMFrOG-ZSHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNzo1NjowMFrOG-ZSHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODA3OTEzMw==", "bodyText": "[nit] wrong line", "url": "https://github.com/apache/hudi/pull/1870#discussion_r468079133", "createdAt": "2020-08-10T17:56:00Z", "author": {"login": "zhedoubushishi"}, "path": "hudi-common/src/main/java/org/apache/hudi/common/util/CleanerUtils.java", "diffHunk": "@@ -26,39 +26,49 @@\n import org.apache.hudi.common.table.timeline.HoodieInstant;\n import org.apache.hudi.common.table.timeline.TimelineMetadataUtils;\n import org.apache.hudi.common.table.timeline.versioning.clean.CleanMetadataMigrator;\n-import org.apache.hudi.common.table.timeline.versioning.clean.CleanV1MigrationHandler;\n-import org.apache.hudi.common.table.timeline.versioning.clean.CleanV2MigrationHandler;\n+import org.apache.hudi.common.table.timeline.versioning.clean.CleanMetadataV1MigrationHandler;\n+import org.apache.hudi.common.table.timeline.versioning.clean.CleanMetadataV2MigrationHandler;\n \n import java.io.IOException;\n import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n+import org.apache.hudi.common.table.timeline.versioning.clean.CleanPlanMigrator;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "896828d0340183369b8faf0c96721f446c30135f"}, "originalPosition": 13}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4353, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}