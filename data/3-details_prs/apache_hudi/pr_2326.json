{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM2NDA3NDY1", "number": 2326, "title": "[HUDI-1450] [RFC-15] Use metadata table for listing in HoodieROTablePathFilter", "bodyText": "Tips\n\nThank you very much for contributing to Apache Hudi.\nPlease review https://hudi.apache.org/contributing.html before opening a pull request.\n\nWhat is the purpose of the pull request\nThis is part of the on-going work with the community on RFC-15 and is based off the branch https://github.com/apache/hudi/tree/rfc-15 where we are building this feature.\nThis implements reader side changes to be able to use metadata based file listing inside HoodieROTablePathFilter. This Path Filter is used within Spark and Presto to filter out the files from latest commit, in case of Copy On Write tables. For this it needs to fetch the FileSystemView which provides latest snapshot of the files. This adds a new FileSystemView which can fetch the file listing using the Hudi backed metadata table.\nVerify this pull request\n\nAdded unit test\nTested on EMR cluster\n\nCommitter checklist\n\n\n Has a corresponding JIRA in PR title & commit\n\n\n Commit message is descriptive of the change\n\n\n CI is green\n\n\n Necessary doc changes done or have another open PR\n\n\n For large changes, please consider breaking it into sub-tasks under an umbrella JIRA.", "createdAt": "2020-12-11T02:06:46Z", "url": "https://github.com/apache/hudi/pull/2326", "merged": true, "mergeCommit": {"oid": "3cab54e3b333c17d33b3a97cd543666a8db72b88"}, "closed": true, "closedAt": "2020-12-18T01:19:10Z", "author": {"login": "umehrot2"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmqJ3ogFqTU1MzQzMDQxNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdnNip7ABqjQxMjc2OTcxNzg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzNDMwNDE0", "url": "https://github.com/apache/hudi/pull/2326#pullrequestreview-553430414", "createdAt": "2020-12-16T07:53:09Z", "commit": {"oid": "877c4d60acdb9dd23dbd60b0b4e8d6db46098409"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQwNzo1MzowOVrOIG4NpA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQwNzo1MzowOVrOIG4NpA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDA4MzM2NA==", "bodyText": "minor: these seen to be duplicated from metadata code. If there is a simple way of moving them to a common class and accessing from there, that would be better.", "url": "https://github.com/apache/hudi/pull/2326#discussion_r544083364", "createdAt": "2020-12-16T07:53:09Z", "author": {"login": "prashantwason"}, "path": "hudi-hadoop-mr/src/main/java/org/apache/hudi/hadoop/HoodieROTablePathFilter.java", "diffHunk": "@@ -56,6 +58,15 @@\n public class HoodieROTablePathFilter implements Configurable, PathFilter, Serializable {\n \n   private static final long serialVersionUID = 1L;\n+  public static final String METADATA_PREFIX = \"hoodie.metadata\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "877c4d60acdb9dd23dbd60b0b4e8d6db46098409"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzNDMyOTE3", "url": "https://github.com/apache/hudi/pull/2326#pullrequestreview-553432917", "createdAt": "2020-12-16T07:57:23Z", "commit": {"oid": "877c4d60acdb9dd23dbd60b0b4e8d6db46098409"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQwNzo1NzoyM1rOIG4WJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQwNzo1NzoyM1rOIG4WJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDA4NTU0MA==", "bodyText": "This default can be true as within HoodieTableMetadata - If the metadata table does not exist, RPC calls are used to retrieve file listings from the file system.", "url": "https://github.com/apache/hudi/pull/2326#discussion_r544085540", "createdAt": "2020-12-16T07:57:23Z", "author": {"login": "prashantwason"}, "path": "hudi-hadoop-mr/src/main/java/org/apache/hudi/hadoop/HoodieROTablePathFilter.java", "diffHunk": "@@ -56,6 +58,15 @@\n public class HoodieROTablePathFilter implements Configurable, PathFilter, Serializable {\n \n   private static final long serialVersionUID = 1L;\n+  public static final String METADATA_PREFIX = \"hoodie.metadata\";\n+\n+  // List using internal metadata table which saves file listings\n+  public static final String METADATA_ENABLE_PROP = METADATA_PREFIX + \".enable\";\n+  public static final boolean DEFAULT_METADATA_ENABLE = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "877c4d60acdb9dd23dbd60b0b4e8d6db46098409"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzNDMzMjY5", "url": "https://github.com/apache/hudi/pull/2326#pullrequestreview-553433269", "createdAt": "2020-12-16T07:57:59Z", "commit": {"oid": "877c4d60acdb9dd23dbd60b0b4e8d6db46098409"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "877c4d60acdb9dd23dbd60b0b4e8d6db46098409", "author": {"user": {"login": "umehrot2", "name": "Udit Mehrotra"}}, "url": "https://github.com/apache/hudi/commit/877c4d60acdb9dd23dbd60b0b4e8d6db46098409", "committedDate": "2020-12-11T02:03:29Z", "message": "Use metadata table for listing in HoodieROTablePathFilter"}, "afterCommit": {"oid": "b08957f6270caf4e4392ce344fe8b24fa33bf8ec", "author": {"user": {"login": "umehrot2", "name": "Udit Mehrotra"}}, "url": "https://github.com/apache/hudi/commit/b08957f6270caf4e4392ce344fe8b24fa33bf8ec", "committedDate": "2020-12-17T02:19:38Z", "message": "Use metadata table for listing in HoodieROTablePathFilter"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b08957f6270caf4e4392ce344fe8b24fa33bf8ec", "author": {"user": {"login": "umehrot2", "name": "Udit Mehrotra"}}, "url": "https://github.com/apache/hudi/commit/b08957f6270caf4e4392ce344fe8b24fa33bf8ec", "committedDate": "2020-12-17T02:19:38Z", "message": "Use metadata table for listing in HoodieROTablePathFilter"}, "afterCommit": {"oid": "a3701aaf95988e65de3c45652f71f164a52b13fd", "author": {"user": {"login": "umehrot2", "name": "Udit Mehrotra"}}, "url": "https://github.com/apache/hudi/commit/a3701aaf95988e65de3c45652f71f164a52b13fd", "committedDate": "2020-12-17T02:38:28Z", "message": "Use metadata table for listing in HoodieROTablePathFilter"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0NjcxOTgw", "url": "https://github.com/apache/hudi/pull/2326#pullrequestreview-554671980", "createdAt": "2020-12-17T14:46:25Z", "commit": {"oid": "a3701aaf95988e65de3c45652f71f164a52b13fd"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxNDo0NjoyNlrOIH5A6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxNDo1Mjo1N1rOIH5VWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTE0NTA2Nw==", "bodyText": "trying to understand these formatting changes. can we use whichever aligns with checkstyle?", "url": "https://github.com/apache/hudi/pull/2326#discussion_r545145067", "createdAt": "2020-12-17T14:46:26Z", "author": {"login": "vinothchandar"}, "path": "hudi-common/src/main/java/org/apache/hudi/common/config/HoodieMetadataConfig.java", "diffHunk": "@@ -128,24 +128,23 @@ public Builder retainCommits(int commitsRetained) {\n     public HoodieMetadataConfig build() {\n       HoodieMetadataConfig config = new HoodieMetadataConfig(props);\n       setDefaultOnCondition(props, !props.containsKey(METADATA_ENABLE_PROP), METADATA_ENABLE_PROP,\n-          String.valueOf(DEFAULT_METADATA_ENABLE));\n+              String.valueOf(DEFAULT_METADATA_ENABLE));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3701aaf95988e65de3c45652f71f164a52b13fd"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTE0OTU4NQ==", "bodyText": "should we test via TestHoodieROTablePathFilter directly?  in the future, Datasource may not call the path filter at all for e.g?", "url": "https://github.com/apache/hudi/pull/2326#discussion_r545149585", "createdAt": "2020-12-17T14:52:03Z", "author": {"login": "vinothchandar"}, "path": "hudi-spark/src/test/scala/org/apache/hudi/functional/TestCOWDataSource.scala", "diffHunk": "@@ -194,4 +195,42 @@ class TestCOWDataSource extends HoodieClientTestBase {\n       .load(basePath)\n     assertEquals(hoodieIncViewDF2.count(), insert2NewKeyCnt)\n   }\n+\n+  @Test def testCopyOnWriteStorageWithMetadata() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3701aaf95988e65de3c45652f71f164a52b13fd"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTE1MDI5OA==", "bodyText": "any way to just parameterize this entire test with and without metadata. might be easier to extend down the line as well?", "url": "https://github.com/apache/hudi/pull/2326#discussion_r545150298", "createdAt": "2020-12-17T14:52:57Z", "author": {"login": "vinothchandar"}, "path": "hudi-spark/src/test/scala/org/apache/hudi/functional/TestCOWDataSource.scala", "diffHunk": "@@ -194,4 +195,42 @@ class TestCOWDataSource extends HoodieClientTestBase {\n       .load(basePath)\n     assertEquals(hoodieIncViewDF2.count(), insert2NewKeyCnt)\n   }\n+\n+  @Test def testCopyOnWriteStorageWithMetadata() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTE0OTU4NQ=="}, "originalCommit": {"oid": "a3701aaf95988e65de3c45652f71f164a52b13fd"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0Njc5MzU0", "url": "https://github.com/apache/hudi/pull/2326#pullrequestreview-554679354", "createdAt": "2020-12-17T14:53:50Z", "commit": {"oid": "a3701aaf95988e65de3c45652f71f164a52b13fd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b566fd933f40c1705b0fee5eb7e53328d8ab4b4", "author": {"user": {"login": "umehrot2", "name": "Udit Mehrotra"}}, "url": "https://github.com/apache/hudi/commit/0b566fd933f40c1705b0fee5eb7e53328d8ab4b4", "committedDate": "2020-12-18T01:05:41Z", "message": "Use metadata table for listing in HoodieROTablePathFilter"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a3701aaf95988e65de3c45652f71f164a52b13fd", "author": {"user": {"login": "umehrot2", "name": "Udit Mehrotra"}}, "url": "https://github.com/apache/hudi/commit/a3701aaf95988e65de3c45652f71f164a52b13fd", "committedDate": "2020-12-17T02:38:28Z", "message": "Use metadata table for listing in HoodieROTablePathFilter"}, "afterCommit": {"oid": "0b566fd933f40c1705b0fee5eb7e53328d8ab4b4", "author": {"user": {"login": "umehrot2", "name": "Udit Mehrotra"}}, "url": "https://github.com/apache/hudi/commit/0b566fd933f40c1705b0fee5eb7e53328d8ab4b4", "committedDate": "2020-12-18T01:05:41Z", "message": "Use metadata table for listing in HoodieROTablePathFilter"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3992, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}