{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA2Mjg0Njg5", "number": 2189, "reviewThreads": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxNzo0MDo1NlrOExTLrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMzozOTozMVrOEyINQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwMTI5OTY1OnYy", "diffSide": "RIGHT", "path": "hudi-common/src/main/java/org/apache/hudi/common/metrics/Registry.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxNzo0MDo1NlrOHnXW7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxNzo0MjoxMlrOHnXZbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAzOTIxNA==", "bodyText": "interfaces don't need to make methods public. Same for static fields. lets remove the qualifier?", "url": "https://github.com/apache/hudi/pull/2189#discussion_r511039214", "createdAt": "2020-10-23T17:40:56Z", "author": {"login": "vinothchandar"}, "path": "hudi-common/src/main/java/org/apache/hudi/common/metrics/Registry.java", "diffHunk": "@@ -18,87 +18,98 @@\n \n package org.apache.hudi.common.metrics;\n \n+import java.io.Serializable;\n import java.util.HashMap;\n import java.util.Map;\n import java.util.concurrent.ConcurrentHashMap;\n \n+import org.apache.hudi.common.util.ReflectionUtils;\n+\n \n /**\n- * Lightweight Metrics Registry to track Hudi events.\n+ * Interface which defines a lightweight Metrics Registry to track Hudi events.\n  */\n-public class Registry {\n-  ConcurrentHashMap<String, Counter> counters = new ConcurrentHashMap<>();\n-  final String name;\n-\n-  private static ConcurrentHashMap<String, Registry> registryMap = new ConcurrentHashMap<>();\n+public interface Registry extends Serializable {\n+  static ConcurrentHashMap<String, Registry> REGISTRYMAP = new ConcurrentHashMap<>();\n \n-  private Registry(String name) {\n-    this.name = name;\n+  /**\n+   * Get (or create) the registry for a provided name.\n+   *\n+   * This function creates a {@code LocalRegistry}.\n+   *\n+   * @param registryName Name of the registry\n+   */\n+  public static Registry getRegistry(String registryName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0e5957eb930e9450bed2fda90218fc638257685"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAzOTg1NA==", "bodyText": "same for abstract", "url": "https://github.com/apache/hudi/pull/2189#discussion_r511039854", "createdAt": "2020-10-23T17:42:12Z", "author": {"login": "vinothchandar"}, "path": "hudi-common/src/main/java/org/apache/hudi/common/metrics/Registry.java", "diffHunk": "@@ -18,87 +18,98 @@\n \n package org.apache.hudi.common.metrics;\n \n+import java.io.Serializable;\n import java.util.HashMap;\n import java.util.Map;\n import java.util.concurrent.ConcurrentHashMap;\n \n+import org.apache.hudi.common.util.ReflectionUtils;\n+\n \n /**\n- * Lightweight Metrics Registry to track Hudi events.\n+ * Interface which defines a lightweight Metrics Registry to track Hudi events.\n  */\n-public class Registry {\n-  ConcurrentHashMap<String, Counter> counters = new ConcurrentHashMap<>();\n-  final String name;\n-\n-  private static ConcurrentHashMap<String, Registry> registryMap = new ConcurrentHashMap<>();\n+public interface Registry extends Serializable {\n+  static ConcurrentHashMap<String, Registry> REGISTRYMAP = new ConcurrentHashMap<>();\n \n-  private Registry(String name) {\n-    this.name = name;\n+  /**\n+   * Get (or create) the registry for a provided name.\n+   *\n+   * This function creates a {@code LocalRegistry}.\n+   *\n+   * @param registryName Name of the registry\n+   */\n+  public static Registry getRegistry(String registryName) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAzOTIxNA=="}, "originalCommit": {"oid": "f0e5957eb930e9450bed2fda90218fc638257685"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwMTMwMTMwOnYy", "diffSide": "RIGHT", "path": "hudi-common/src/main/java/org/apache/hudi/common/metrics/Registry.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxNzo0MToyOFrOHnXX7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxNzo0MToyOFrOHnXX7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAzOTQ3MA==", "bodyText": "rename: REGISTRY_NAME", "url": "https://github.com/apache/hudi/pull/2189#discussion_r511039470", "createdAt": "2020-10-23T17:41:28Z", "author": {"login": "vinothchandar"}, "path": "hudi-common/src/main/java/org/apache/hudi/common/metrics/Registry.java", "diffHunk": "@@ -18,87 +18,98 @@\n \n package org.apache.hudi.common.metrics;\n \n+import java.io.Serializable;\n import java.util.HashMap;\n import java.util.Map;\n import java.util.concurrent.ConcurrentHashMap;\n \n+import org.apache.hudi.common.util.ReflectionUtils;\n+\n \n /**\n- * Lightweight Metrics Registry to track Hudi events.\n+ * Interface which defines a lightweight Metrics Registry to track Hudi events.\n  */\n-public class Registry {\n-  ConcurrentHashMap<String, Counter> counters = new ConcurrentHashMap<>();\n-  final String name;\n-\n-  private static ConcurrentHashMap<String, Registry> registryMap = new ConcurrentHashMap<>();\n+public interface Registry extends Serializable {\n+  static ConcurrentHashMap<String, Registry> REGISTRYMAP = new ConcurrentHashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0e5957eb930e9450bed2fda90218fc638257685"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwMTM0NjQwOnYy", "diffSide": "RIGHT", "path": "hudi-client/src/main/java/org/apache/hudi/client/AbstractHoodieClient.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxNzo1MjoxMFrOHnXxpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxNzo1MjoxMFrOHnXxpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA0NjA1Mw==", "bodyText": "Configuring this class at this layer feels adhoc. Can we do this inside HoodieWrapperFileSystem class or as a static block there?", "url": "https://github.com/apache/hudi/pull/2189#discussion_r511046053", "createdAt": "2020-10-23T17:52:10Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/src/main/java/org/apache/hudi/client/AbstractHoodieClient.java", "diffHunk": "@@ -122,6 +124,26 @@ public HoodieWriteConfig getConfig() {\n   }\n \n   protected HoodieTableMetaClient createMetaClient(boolean loadActiveTimelineOnLoad) {\n+    if (config.isMetricsOn()) {\n+      Registry registry;\n+      Registry registryMeta;\n+\n+      if (config.isExecutorMetricsEnabled()) {\n+        // Create a distributed registry for HoodieWrapperFileSystem\n+        registry = Registry.getRegistry(HoodieWrapperFileSystem.class.getSimpleName(),\n+            DistributedRegistry.class.getName());\n+        ((DistributedRegistry)registry).register(jsc);\n+        registryMeta = Registry.getRegistry(HoodieWrapperFileSystem.class.getSimpleName() + \"MetaFolder\",\n+            DistributedRegistry.class.getName());\n+        ((DistributedRegistry)registryMeta).register(jsc);\n+      } else {\n+        registry = Registry.getRegistry(HoodieWrapperFileSystem.class.getSimpleName());\n+        registryMeta = Registry.getRegistry(HoodieWrapperFileSystem.class.getSimpleName() + \"MetaFolder\");\n+      }\n+\n+      HoodieWrapperFileSystem.setMetricsRegistry(registry, registryMeta);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0e5957eb930e9450bed2fda90218fc638257685"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwMTM2MDM4OnYy", "diffSide": "RIGHT", "path": "hudi-client/src/main/java/org/apache/hudi/client/AbstractHoodieWriteClient.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxNzo1NjoxN1rOHnX6xw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxNzo1Njo1OFrOHnX8OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA0ODM5MQ==", "bodyText": "this is creating a new table, not fetching an existing member. Any reason we can't just use HoodieTable.create factory. It took me quite a bit of time to clean up usages last time around . :)", "url": "https://github.com/apache/hudi/pull/2189#discussion_r511048391", "createdAt": "2020-10-23T17:56:17Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/src/main/java/org/apache/hudi/client/AbstractHoodieWriteClient.java", "diffHunk": "@@ -232,6 +232,11 @@ private HoodieTable getTableAndInitCtx(HoodieTableMetaClient metaClient, WriteOp\n     return table;\n   }\n \n+  protected HoodieTable<T> getTable() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0e5957eb930e9450bed2fda90218fc638257685"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA0ODc2MQ==", "bodyText": "lets avoid this method please", "url": "https://github.com/apache/hudi/pull/2189#discussion_r511048761", "createdAt": "2020-10-23T17:56:58Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/src/main/java/org/apache/hudi/client/AbstractHoodieWriteClient.java", "diffHunk": "@@ -232,6 +232,11 @@ private HoodieTable getTableAndInitCtx(HoodieTableMetaClient metaClient, WriteOp\n     return table;\n   }\n \n+  protected HoodieTable<T> getTable() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA0ODM5MQ=="}, "originalCommit": {"oid": "f0e5957eb930e9450bed2fda90218fc638257685"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwMTM3Mjc1OnYy", "diffSide": "RIGHT", "path": "hudi-client/src/main/java/org/apache/hudi/config/HoodieMetadataConfig.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxODowMDowMFrOHnYCdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxODowMDowMFrOHnYCdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA1MDM1Ng==", "bodyText": "please name properties using the (mostly followed) convention of ending the property name with _PROP.\nMETADATA_ENABLE -> METADATA_ENABLE_PROP", "url": "https://github.com/apache/hudi/pull/2189#discussion_r511050356", "createdAt": "2020-10-23T18:00:00Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/src/main/java/org/apache/hudi/config/HoodieMetadataConfig.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.config;\n+\n+import org.apache.hudi.common.config.DefaultHoodieConfig;\n+import org.apache.hudi.config.HoodieCompactionConfig.Builder;\n+\n+import javax.annotation.concurrent.Immutable;\n+\n+import java.io.File;\n+import java.io.FileReader;\n+import java.io.IOException;\n+import java.util.Properties;\n+\n+/**\n+ * Configurations used by the HUDI Metadata Table.\n+ */\n+@Immutable\n+public class HoodieMetadataConfig extends DefaultHoodieConfig {\n+\n+  public static final String METADATA_PREFIX = \"hoodie.metadata\";\n+\n+  // Enable the internal Metadata Table which saves file listings\n+  public static final String METADATA_ENABLE = METADATA_PREFIX + \".enable\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0e5957eb930e9450bed2fda90218fc638257685"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwMTM3NzA3OnYy", "diffSide": "RIGHT", "path": "hudi-client/src/main/java/org/apache/hudi/config/HoodieMetadataConfig.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxODowMToyMFrOHnYFKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxODowMToyMFrOHnYFKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA1MTA1MQ==", "bodyText": "FWIW I still prefer honoring all table/write configs for metadata. This file can then contain different defaults for eg. Redefining every param here again, is going to be cumbersome.", "url": "https://github.com/apache/hudi/pull/2189#discussion_r511051051", "createdAt": "2020-10-23T18:01:20Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/src/main/java/org/apache/hudi/config/HoodieMetadataConfig.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.config;\n+\n+import org.apache.hudi.common.config.DefaultHoodieConfig;\n+import org.apache.hudi.config.HoodieCompactionConfig.Builder;\n+\n+import javax.annotation.concurrent.Immutable;\n+\n+import java.io.File;\n+import java.io.FileReader;\n+import java.io.IOException;\n+import java.util.Properties;\n+\n+/**\n+ * Configurations used by the HUDI Metadata Table.\n+ */\n+@Immutable\n+public class HoodieMetadataConfig extends DefaultHoodieConfig {\n+\n+  public static final String METADATA_PREFIX = \"hoodie.metadata\";\n+\n+  // Enable the internal Metadata Table which saves file listings\n+  public static final String METADATA_ENABLE = METADATA_PREFIX + \".enable\";\n+  public static final boolean DEFAULT_METADATA_ENABLE = false;\n+\n+  // Validate contents of Metadata Table on each access against the actual filesystem\n+  public static final String METADATA_VALIDATE = METADATA_PREFIX + \".validate\";\n+  public static final boolean DEFAULT_METADATA_VALIDATE = false;\n+\n+  // Parallelism for inserts\n+  public static final String INSERT_PARALLELISM = METADATA_PREFIX + \".insert.parallelism\";\n+  public static final int DEFAULT_INSERT_PARALLELISM = 1;\n+\n+  // Async clean\n+  public static final String ASYNC_CLEAN = METADATA_PREFIX + \".clean.async\";\n+  public static final boolean DEFAULT_ASYNC_CLEAN = false;\n+\n+  // Maximum delta commits before compaction occurs\n+  public static final String COMPACT_NUM_DELTA_COMMITS = METADATA_PREFIX + \".compact.max.delta.commits\";\n+  public static final int DEFAULT_COMPACT_NUM_DELTA_COMMITS = 24;\n+\n+  // Archival settings\n+  public static final String MIN_COMMITS_TO_KEEP = METADATA_PREFIX + \".keep.min.commits\";\n+  public static final int DEFAULT_MIN_COMMITS_TO_KEEP = 20;\n+  public static final String MAX_COMMITS_TO_KEEP = METADATA_PREFIX + \".keep.max.commits\";\n+  public static final int DEFAULT_MAX_COMMITS_TO_KEEP = 30;\n+\n+  // Cleaner commits retained\n+  public static final String CLEANER_COMMITS_RETAINED = METADATA_PREFIX + \".cleaner.commits.retained\";\n+  public static final int DEFAULT_CLEANER_COMMITS_RETAINED = 3;\n+\n+  private HoodieMetadataConfig(Properties props) {\n+    super(props);\n+  }\n+\n+  public static HoodieMetadataConfig.Builder newBuilder() {\n+    return new Builder();\n+  }\n+\n+  public static class Builder {\n+\n+    private final Properties props = new Properties();\n+\n+    public Builder fromFile(File propertiesFile) throws IOException {\n+      try (FileReader reader = new FileReader(propertiesFile)) {\n+        this.props.load(reader);\n+        return this;\n+      }\n+    }\n+\n+    public Builder fromProperties(Properties props) {\n+      this.props.putAll(props);\n+      return this;\n+    }\n+\n+    public Builder enable(boolean enable) {\n+      props.setProperty(METADATA_ENABLE, String.valueOf(enable));\n+      return this;\n+    }\n+\n+    public Builder validate(boolean validate) {\n+      props.setProperty(METADATA_VALIDATE, String.valueOf(validate));\n+      return this;\n+    }\n+\n+    public Builder withInsertParallelism(int parallelism) {\n+      props.setProperty(INSERT_PARALLELISM, String.valueOf(parallelism));\n+      return this;\n+    }\n+\n+    public Builder withAsyncClean(boolean asyncClean) {\n+      props.setProperty(ASYNC_CLEAN, String.valueOf(asyncClean));\n+      return this;\n+    }\n+\n+    public Builder withMaxNumDeltaCommitsBeforeCompaction(int maxNumDeltaCommitsBeforeCompaction) {\n+      props.setProperty(COMPACT_NUM_DELTA_COMMITS, String.valueOf(maxNumDeltaCommitsBeforeCompaction));\n+      return this;\n+    }\n+\n+    public Builder archiveCommitsWith(int minToKeep, int maxToKeep) {\n+      props.setProperty(MIN_COMMITS_TO_KEEP, String.valueOf(minToKeep));\n+      props.setProperty(MAX_COMMITS_TO_KEEP, String.valueOf(maxToKeep));\n+      return this;\n+    }\n+\n+    public Builder retainCommits(int commitsRetained) {\n+      props.setProperty(CLEANER_COMMITS_RETAINED, String.valueOf(commitsRetained));\n+      return this;\n+    }\n+\n+    public HoodieMetadataConfig build() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0e5957eb930e9450bed2fda90218fc638257685"}, "originalPosition": 129}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwOTk1MjAxOnYy", "diffSide": "RIGHT", "path": "hudi-client/src/main/java/org/apache/hudi/metadata/HoodieMetadataWriter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMzoyMjo1MlrOHol9-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMzoyMjo1MlrOHol9-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMyNzE2MA==", "bodyText": "rename: create() per standard factory pattern conventions?", "url": "https://github.com/apache/hudi/pull/2189#discussion_r512327160", "createdAt": "2020-10-26T23:22:52Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/src/main/java/org/apache/hudi/metadata/HoodieMetadataWriter.java", "diffHunk": "@@ -95,25 +102,26 @@\n   private static Map<String, HoodieMetadataWriter> instances = new HashMap<>();\n \n   public static HoodieMetadataWriter instance(Configuration conf, HoodieWriteConfig writeConfig) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0e5957eb930e9450bed2fda90218fc638257685"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwOTk1NDAyOnYy", "diffSide": "RIGHT", "path": "hudi-client/src/main/java/org/apache/hudi/metadata/HoodieMetadataWriter.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMzoyMzo1MVrOHol_Mg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMzoyMzo1MVrOHol_Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMyNzQ3NA==", "bodyText": "I am still not a fan of this caching. specifically, coz it creates extra complexity like this.", "url": "https://github.com/apache/hudi/pull/2189#discussion_r512327474", "createdAt": "2020-10-26T23:23:51Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/src/main/java/org/apache/hudi/metadata/HoodieMetadataWriter.java", "diffHunk": "@@ -95,25 +102,26 @@\n   private static Map<String, HoodieMetadataWriter> instances = new HashMap<>();\n \n   public static HoodieMetadataWriter instance(Configuration conf, HoodieWriteConfig writeConfig) {\n-    try {\n-      return new HoodieMetadataWriter(conf, writeConfig);\n-    } catch (IOException e) {\n-      throw new HoodieMetadataException(\"Could not initialize HoodieMetadataWriter\", e);\n+    String key = writeConfig.getBasePath();\n+    if (instances.containsKey(key)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0e5957eb930e9450bed2fda90218fc638257685"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwOTk1NTcyOnYy", "diffSide": "RIGHT", "path": "hudi-client/src/main/java/org/apache/hudi/metadata/HoodieMetadataWriter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMzoyNDozNFrOHomAIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMzoyNDozNFrOHomAIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMyNzcxMw==", "bodyText": "combine into one if statement?", "url": "https://github.com/apache/hudi/pull/2189#discussion_r512327713", "createdAt": "2020-10-26T23:24:34Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/src/main/java/org/apache/hudi/metadata/HoodieMetadataWriter.java", "diffHunk": "@@ -126,6 +134,14 @@ public static HoodieMetadataWriter instance(Configuration conf, HoodieWriteConfi\n       // Metadata Table cannot have its metadata optimized\n       ValidationUtils.checkArgument(this.config.shouldAutoCommit(), \"Auto commit is required for Metadata Table\");\n       ValidationUtils.checkArgument(!this.config.useFileListingMetadata(), \"File listing cannot be used for Metadata Table\");\n+\n+      if (config.isMetricsOn()) {\n+        if (config.isExecutorMetricsEnabled()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0e5957eb930e9450bed2fda90218fc638257685"}, "originalPosition": 75}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwOTk2MTI2OnYy", "diffSide": "RIGHT", "path": "hudi-client/src/main/java/org/apache/hudi/metadata/HoodieMetadataWriter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMzoyNzoxMFrOHomDaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMzoyNzoxMFrOHomDaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMyODU1Mg==", "bodyText": "stream.forEach()?", "url": "https://github.com/apache/hudi/pull/2189#discussion_r512328552", "createdAt": "2020-10-26T23:27:10Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/src/main/java/org/apache/hudi/metadata/HoodieMetadataWriter.java", "diffHunk": "@@ -278,7 +305,16 @@ private void initFromFilesystem(JavaSparkContext jsc, HoodieTableMetaClient data\n     ValidationUtils.checkState(enabled, \"Metadata table cannot be initialized as it is not enabled\");\n \n     // If there is no commit on the dataset yet, use the SOLO_COMMIT_TIMESTAMP as the instant time for initial commit\n-    Option<HoodieInstant> latestInstant = datasetMetaClient.getActiveTimeline().filterCompletedInstants().lastInstant();\n+    // Otherwise, we use the timestamp of the instant which does not have any non-completed instants before it.\n+    Option<HoodieInstant> latestInstant = Option.empty();\n+    boolean foundNonComplete = false;\n+    for (HoodieInstant instant : datasetMetaClient.getActiveTimeline().getInstants().collect(Collectors.toList())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0e5957eb930e9450bed2fda90218fc638257685"}, "originalPosition": 165}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwOTk2NDI3OnYy", "diffSide": "RIGHT", "path": "hudi-client/src/test/java/org/apache/hudi/metadata/TestHoodieMetadata.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMzoyODo0OVrOHomFMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMzoyODo0OVrOHomFMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMyOTAwOQ==", "bodyText": "this kind of randomization makes test non-deterministic. Please make this parameterized .", "url": "https://github.com/apache/hudi/pull/2189#discussion_r512329009", "createdAt": "2020-10-26T23:28:49Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/src/test/java/org/apache/hudi/metadata/TestHoodieMetadata.java", "diffHunk": "@@ -457,14 +479,14 @@ public void testArchivingAndCompaction() throws Exception {\n     init(HoodieTableType.COPY_ON_WRITE);\n \n     final int maxDeltaCommitsBeforeCompaction = 6;\n+    // Test autoClean and asyncClean based on this flag which is randomly chosen.\n+    boolean asyncClean = new Random().nextBoolean();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0e5957eb930e9450bed2fda90218fc638257685"}, "originalPosition": 111}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwOTk3MTExOnYy", "diffSide": "RIGHT", "path": "hudi-common/src/main/java/org/apache/hudi/common/fs/HoodieWrapperFileSystem.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMzozMTo0NVrOHomJFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMzozMTo0NVrOHomJFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMzMDAwNA==", "bodyText": "lets use the HoodieTimer class here?", "url": "https://github.com/apache/hudi/pull/2189#discussion_r512330004", "createdAt": "2020-10-26T23:31:45Z", "author": {"login": "vinothchandar"}, "path": "hudi-common/src/main/java/org/apache/hudi/common/fs/HoodieWrapperFileSystem.java", "diffHunk": "@@ -65,15 +66,54 @@\n \n   public static final String HOODIE_SCHEME_PREFIX = \"hoodie-\";\n \n-  private enum MetricName {\n-    create, rename, delete, listStatus, mkdirs, getFileStatus, globStatus, listFiles\n+  protected enum MetricName {\n+    create, rename, delete, listStatus, mkdirs, getFileStatus, globStatus, listFiles, read, write\n   }\n \n   private ConcurrentMap<String, SizeAwareFSDataOutputStream> openStreams = new ConcurrentHashMap<>();\n   private FileSystem fileSystem;\n   private URI uri;\n   private ConsistencyGuard consistencyGuard = new NoOpConsistencyGuard();\n-  private Registry metricsRegistry = Registry.getRegistry(this.getClass().getSimpleName());\n+  private static Registry metricsRegistry;\n+  private static Registry metricsRegistryMetaFolder;\n+\n+  @FunctionalInterface\n+  public interface CheckedFunction<R> {\n+    R get() throws IOException;\n+  }\n+\n+  private static Registry getMetricRegistryForPath(Path p) {\n+    return ((p != null) && (p.toString().contains(HoodieTableMetaClient.METAFOLDER_NAME)))\n+        ? metricsRegistryMetaFolder : metricsRegistry;\n+  }\n+\n+  protected static <R> R executeFuncWithTimeMetrics(String metricName, Path p, CheckedFunction<R> func) throws IOException {\n+    long t1 = System.currentTimeMillis();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0e5957eb930e9450bed2fda90218fc638257685"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwOTk3NTk1OnYy", "diffSide": "RIGHT", "path": "hudi-common/src/main/java/org/apache/hudi/common/fs/HoodieWrapperFileSystem.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMzozNDowOVrOHomL4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMzozNDowOVrOHomL4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMzMDcyMg==", "bodyText": "rename: is", "url": "https://github.com/apache/hudi/pull/2189#discussion_r512330722", "createdAt": "2020-10-26T23:34:09Z", "author": {"login": "vinothchandar"}, "path": "hudi-common/src/main/java/org/apache/hudi/common/fs/HoodieWrapperFileSystem.java", "diffHunk": "@@ -164,79 +205,99 @@ private FSDataOutputStream wrapOutputStream(final Path path, FSDataOutputStream\n     return os;\n   }\n \n+  private FSDataInputStream wrapInputStream(final Path path, FSDataInputStream fsDataInputStream) throws IOException {\n+    if (fsDataInputStream instanceof SizeAwareFSDataInputStream) {\n+      return fsDataInputStream;\n+    }\n+\n+    SizeAwareFSDataInputStream os = new SizeAwareFSDataInputStream(path, fsDataInputStream);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0e5957eb930e9450bed2fda90218fc638257685"}, "originalPosition": 98}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwOTk4MzQ3OnYy", "diffSide": "RIGHT", "path": "hudi-common/src/main/java/org/apache/hudi/common/fs/SizeAwareFSDataInputStream.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMzozNzozOFrOHomQFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMzozNzozOFrOHomQFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMzMTc5OA==", "bodyText": "this is an input stream. fix the docs?", "url": "https://github.com/apache/hudi/pull/2189#discussion_r512331798", "createdAt": "2020-10-26T23:37:38Z", "author": {"login": "vinothchandar"}, "path": "hudi-common/src/main/java/org/apache/hudi/common/fs/SizeAwareFSDataInputStream.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.common.fs;\n+\n+import org.apache.hadoop.fs.FSDataInputStream;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.fs.ReadOption;\n+import org.apache.hadoop.io.ByteBufferPool;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.EnumSet;\n+\n+/**\n+ * Wrapper over <code>FSDataInputStream</code> to keep track of the size of the written bytes.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0e5957eb930e9450bed2fda90218fc638257685"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwOTk4NTQ2OnYy", "diffSide": "RIGHT", "path": "hudi-common/src/main/java/org/apache/hudi/common/fs/SizeAwareFSDataInputStream.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMzozODo0OFrOHomRRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMzozODo0OFrOHomRRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMzMjEwMg==", "bodyText": "Please name this something like TimedFSDataInputStream. This is not tracking size at all", "url": "https://github.com/apache/hudi/pull/2189#discussion_r512332102", "createdAt": "2020-10-26T23:38:48Z", "author": {"login": "vinothchandar"}, "path": "hudi-common/src/main/java/org/apache/hudi/common/fs/SizeAwareFSDataInputStream.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.common.fs;\n+\n+import org.apache.hadoop.fs.FSDataInputStream;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.fs.ReadOption;\n+import org.apache.hadoop.io.ByteBufferPool;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.EnumSet;\n+\n+/**\n+ * Wrapper over <code>FSDataInputStream</code> to keep track of the size of the written bytes.\n+ */\n+public class SizeAwareFSDataInputStream extends FSDataInputStream {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0e5957eb930e9450bed2fda90218fc638257685"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwOTk4NzIwOnYy", "diffSide": "RIGHT", "path": "hudi-common/src/main/java/org/apache/hudi/common/metrics/LocalRegistry.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMzozOTozMVrOHomSKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMzozOTozMVrOHomSKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMzMjMzMA==", "bodyText": "fix docs", "url": "https://github.com/apache/hudi/pull/2189#discussion_r512332330", "createdAt": "2020-10-26T23:39:31Z", "author": {"login": "vinothchandar"}, "path": "hudi-common/src/main/java/org/apache/hudi/common/metrics/LocalRegistry.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.common.metrics;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.concurrent.ConcurrentHashMap;\n+\n+/**\n+ * Lightweight Metrics Registry to track Hudi events.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0e5957eb930e9450bed2fda90218fc638257685"}, "originalPosition": 26}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4106, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}