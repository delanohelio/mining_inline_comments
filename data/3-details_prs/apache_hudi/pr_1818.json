{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ3NzE3NTY5", "number": 1818, "title": "[HUDI-994] Split TestHBaseIndex to unit tests ", "bodyText": "Refactor and improve TestHBaseIndex for performance\nMove HBaseIndex unit tests to different test classes\n\nCommitter checklist\n\n\n Has a corresponding JIRA in PR title & commit\n\n\n Commit message is descriptive of the change\n\n\n CI is green\n\n\n Necessary doc changes done or have another open PR\n\n\n For large changes, please consider breaking it into sub-tasks under an umbrella JIRA.", "createdAt": "2020-07-11T04:32:26Z", "url": "https://github.com/apache/hudi/pull/1818", "merged": true, "mergeCommit": {"oid": "f5dc8ca733014d15a6d7966a5b6ae4308868adfa"}, "closed": true, "closedAt": "2020-07-14T03:32:02Z", "author": {"login": "xushiyan"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABczwon1AFqTQ0Njc3NzI5MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc0tgrfAFqTQ0Nzc2MDE0Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2Nzc3Mjkw", "url": "https://github.com/apache/hudi/pull/1818#pullrequestreview-446777290", "createdAt": "2020-07-11T04:33:23Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwNDozMzoyM1rOGwKVgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwNDozNDowOFrOGwKVrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE1NDE3Nw==", "bodyText": "moved to a separate unit test class", "url": "https://github.com/apache/hudi/pull/1818#discussion_r453154177", "createdAt": "2020-07-11T04:33:23Z", "author": {"login": "xushiyan"}, "path": "hudi-client/src/test/java/org/apache/hudi/index/hbase/TestHBaseIndex.java", "diffHunk": "@@ -313,53 +303,17 @@ public void testTotalPutsBatching() throws Exception {\n     // Get all the files generated\n     int numberOfDataFileIds = (int) writeStatues.map(status -> status.getFileId()).distinct().count();\n \n-    index.updateLocation(writeStatues, jsc, hoodieTable);\n+    index.updateLocation(writeStatues, jsc(), hoodieTable);\n     // 3 batches should be executed given batchSize = 100 and <=numberOfDataFileIds getting updated,\n     // so each fileId ideally gets updates\n     verify(table, atMost(numberOfDataFileIds)).put((List<Put>) any());\n   }\n \n-  @Test\n-  public void testPutBatchSizeCalculation() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 294}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE1NDIwMw==", "bodyText": "duplicate test case in org.apache.hudi.index.hbase.TestHBaseQPSResourceAllocator", "url": "https://github.com/apache/hudi/pull/1818#discussion_r453154203", "createdAt": "2020-07-11T04:33:50Z", "author": {"login": "xushiyan"}, "path": "hudi-client/src/test/java/org/apache/hudi/index/hbase/TestHBaseIndex.java", "diffHunk": "@@ -383,22 +337,12 @@ public void testsHBasePutAccessParallelismWithNoInserts() {\n     assertEquals(0, hbaseNumPuts);\n   }\n \n-  @Test\n-  public void testsHBaseIndexDefaultQPSResourceAllocator() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 352}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE1NDIyMw==", "bodyText": "moved to a separate unit test class", "url": "https://github.com/apache/hudi/pull/1818#discussion_r453154223", "createdAt": "2020-07-11T04:34:08Z", "author": {"login": "xushiyan"}, "path": "hudi-client/src/test/java/org/apache/hudi/index/hbase/TestHBaseIndex.java", "diffHunk": "@@ -460,47 +404,34 @@ public void testDelete() throws Exception {\n       // Now tagLocation for these records, hbaseIndex should tag them correctly\n       metaClient = HoodieTableMetaClient.reload(metaClient);\n       hoodieTable = HoodieTable.create(metaClient, config, hadoopConf);\n-      javaRDD = index.tagLocation(writeRecords, jsc, hoodieTable);\n-      assertEquals(10, javaRDD.filter(record -> record.isCurrentLocationKnown()).collect().size());\n-      assertEquals(10, javaRDD.map(record -> record.getKey().getRecordKey()).distinct().count());\n-      assertEquals(10, javaRDD.filter(record -> (record.getCurrentLocation() != null\n+      List<HoodieRecord> records2 = index.tagLocation(writeRecords, jsc(), hoodieTable).collect();\n+      assertEquals(numRecords, records2.stream().filter(record -> record.isCurrentLocationKnown()).count());\n+      assertEquals(numRecords, records2.stream().map(record -> record.getKey().getRecordKey()).distinct().count());\n+      assertEquals(numRecords, records2.stream().filter(record -> (record.getCurrentLocation() != null\n           && record.getCurrentLocation().getInstantTime().equals(newCommitTime))).distinct().count());\n \n       // Delete all records. This has to be done directly as deleting index entries\n       // is not implemented via HoodieWriteClient\n-      Option recordMetadata = Option.empty();\n       JavaRDD<WriteStatus> deleteWriteStatues = writeStatues.map(w -> {\n         WriteStatus newWriteStatus = new WriteStatus(true, 1.0);\n-        w.getWrittenRecords().forEach(r -> newWriteStatus.markSuccess(new HoodieRecord(r.getKey(), null), recordMetadata));\n+        w.getWrittenRecords().forEach(r -> newWriteStatus.markSuccess(new HoodieRecord(r.getKey(), null), Option.empty()));\n         assertEquals(w.getTotalRecords(), newWriteStatus.getTotalRecords());\n         newWriteStatus.setStat(new HoodieWriteStat());\n         return newWriteStatus;\n       });\n-      JavaRDD<WriteStatus> deleteStatus = index.updateLocation(deleteWriteStatues, jsc, hoodieTable);\n+      JavaRDD<WriteStatus> deleteStatus = index.updateLocation(deleteWriteStatues, jsc(), hoodieTable);\n       assertEquals(deleteStatus.count(), deleteWriteStatues.count());\n       assertNoWriteErrors(deleteStatus.collect());\n \n       // Ensure no records can be tagged\n-      javaRDD = index.tagLocation(writeRecords, jsc, hoodieTable);\n-      assertEquals(0, javaRDD.filter(record -> record.isCurrentLocationKnown()).collect().size());\n-      assertEquals(10, javaRDD.map(record -> record.getKey().getRecordKey()).distinct().count());\n-      assertEquals(0, javaRDD.filter(record -> (record.getCurrentLocation() != null\n+      List<HoodieRecord> records3 = index.tagLocation(writeRecords, jsc(), hoodieTable).collect();\n+      assertEquals(0, records3.stream().filter(record -> record.isCurrentLocationKnown()).count());\n+      assertEquals(numRecords, records3.stream().map(record -> record.getKey().getRecordKey()).distinct().count());\n+      assertEquals(0, records3.stream().filter(record -> (record.getCurrentLocation() != null\n           && record.getCurrentLocation().getInstantTime().equals(newCommitTime))).distinct().count());\n     }\n   }\n \n-  @Test\n-  public void testFeatureSupport() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 479}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2OTI2Njk2", "url": "https://github.com/apache/hudi/pull/1818#pullrequestreview-446926696", "createdAt": "2020-07-13T00:44:10Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2OTMzMTY3", "url": "https://github.com/apache/hudi/pull/1818#pullrequestreview-446933167", "createdAt": "2020-07-13T01:24:57Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QwMToyNDo1N1rOGwYzUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QwMToyNDo1N1rOGwYzUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM5MTE4Nw==", "bodyText": "its not very clear what a sub path stands for? rename to make it clearer?", "url": "https://github.com/apache/hudi/pull/1818#discussion_r453391187", "createdAt": "2020-07-13T01:24:57Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/src/test/java/org/apache/hudi/testutils/providers/DFSProvider.java", "diffHunk": "@@ -31,4 +33,6 @@\n \n   Path dfsBasePath();\n \n+  Path dfsSubPath() throws IOException;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2OTMzNDU2", "url": "https://github.com/apache/hudi/pull/1818#pullrequestreview-446933456", "createdAt": "2020-07-13T01:26:30Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "6352eef7a8691e67e34635e204969dcdb82dbbba", "author": {"user": {"login": "xushiyan", "name": "Raymond Xu"}}, "url": "https://github.com/apache/hudi/commit/6352eef7a8691e67e34635e204969dcdb82dbbba", "committedDate": "2020-07-13T23:52:09Z", "message": "[HUDI-994] Split TestHBaseIndex to unit tests\n\n- Refactor and improve TestHBaseIndex for performance\n- Move HBaseIndex unit tests to different test classes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "6352eef7a8691e67e34635e204969dcdb82dbbba", "author": {"user": {"login": "xushiyan", "name": "Raymond Xu"}}, "url": "https://github.com/apache/hudi/commit/6352eef7a8691e67e34635e204969dcdb82dbbba", "committedDate": "2020-07-13T23:52:09Z", "message": "[HUDI-994] Split TestHBaseIndex to unit tests\n\n- Refactor and improve TestHBaseIndex for performance\n- Move HBaseIndex unit tests to different test classes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "907ddc2014462b2bb3f1416c10266939a2a8c0d0", "author": {"user": {"login": "xushiyan", "name": "Raymond Xu"}}, "url": "https://github.com/apache/hudi/commit/907ddc2014462b2bb3f1416c10266939a2a8c0d0", "committedDate": "2020-07-14T02:02:37Z", "message": "Trigger"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3NzYwMTQz", "url": "https://github.com/apache/hudi/pull/1818#pullrequestreview-447760143", "createdAt": "2020-07-14T03:31:34Z", "commit": {"oid": "907ddc2014462b2bb3f1416c10266939a2a8c0d0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2938, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}