{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAwNzA5NTEx", "number": 2161, "title": "[HUDI-1328] Introduce HoodieFlinkEngineContext to hudi-flink-client", "bodyText": "Tips\n\nThank you very much for contributing to Apache Hudi.\nPlease review https://hudi.apache.org/contributing.html before opening a pull request.\n\nWhat is the purpose of the pull request\nIntroduce HoodieFlinkEngineContext to hudi-flink-client\nBrief change log\n(for example:)\n\nModify AnnotationLocation checkstyle rule in checkstyle.xml\n\nVerify this pull request\nThis pull request is already covered by existing tests, such as TestHoodieFlinkEngineContext.\nCommitter checklist\n\n\n Has a corresponding JIRA in PR title & commit\n\n\n Commit message is descriptive of the change\n\n\n CI is green\n\n\n Necessary doc changes done or have another open PR\n\n\n For large changes, please consider breaking it into sub-tasks under an umbrella JIRA.", "createdAt": "2020-10-09T16:49:07Z", "url": "https://github.com/apache/hudi/pull/2161", "merged": true, "mergeCommit": {"oid": "c7d962efffa9440746d54dd2bcba73a9df8b354a"}, "closed": true, "closedAt": "2020-10-14T01:30:50Z", "author": {"login": "wangxianghu"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdRAlnXAFqTUwNjA1Mjk0NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSDO_vAFqTUwNzEzMDc2NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MDUyOTQ1", "url": "https://github.com/apache/hudi/pull/2161#pullrequestreview-506052945", "createdAt": "2020-10-10T01:35:02Z", "commit": {"oid": "5b82c40f0ad533d0b1d4730e91ad4d0133b49c1d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMFQwMTozNTowMlrOHfcJMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMFQwMTozNTowMlrOHfcJMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjcyOTAxMQ==", "bodyText": "use HoodieException?", "url": "https://github.com/apache/hudi/pull/2161#discussion_r502729011", "createdAt": "2020-10-10T01:35:02Z", "author": {"login": "leesf"}, "path": "hudi-client/hudi-flink-client/src/main/java/org/apache/hudi/client/common/function/FunctionWrapper.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.client.common.function;\n+\n+import scala.Tuple2;\n+\n+import java.util.function.Consumer;\n+import java.util.function.Function;\n+import java.util.stream.Stream;\n+\n+/**\n+ * Function wrapper util class, which catches the exception thrown by input function and return a similar function\n+ * with no exception thrown.\n+ */\n+public class FunctionWrapper {\n+\n+  public static <I, O> Function<I, O> throwingMapWrapper(SerializableFunction<I, O> throwingMapFunction) {\n+    return v1 -> {\n+      try {\n+        return throwingMapFunction.apply(v1);\n+      } catch (Exception e) {\n+        throw new RuntimeException(e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b82c40f0ad533d0b1d4730e91ad4d0133b49c1d"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MDUzNjEw", "url": "https://github.com/apache/hudi/pull/2161#pullrequestreview-506053610", "createdAt": "2020-10-10T01:41:48Z", "commit": {"oid": "5b82c40f0ad533d0b1d4730e91ad4d0133b49c1d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMFQwMTo0MTo0OFrOHfcMTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMFQwMTo0MTo0OFrOHfcMTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjcyOTgwNQ==", "bodyText": "maybe we would move the methods to super class as default implementation after finishing the flink integration.", "url": "https://github.com/apache/hudi/pull/2161#discussion_r502729805", "createdAt": "2020-10-10T01:41:48Z", "author": {"login": "leesf"}, "path": "hudi-client/hudi-flink-client/src/main/java/org/apache/hudi/client/common/HoodieFlinkEngineContext.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.client.common;\n+\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hudi.client.common.function.SerializableConsumer;\n+import org.apache.hudi.client.common.function.SerializableFunction;\n+import org.apache.hudi.client.common.function.SerializablePairFunction;\n+import org.apache.hudi.common.config.SerializableConfiguration;\n+import org.apache.hudi.common.util.Option;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import static org.apache.hudi.client.common.function.FunctionWrapper.throwingFlatMapWrapper;\n+import static org.apache.hudi.client.common.function.FunctionWrapper.throwingForeachWrapper;\n+import static org.apache.hudi.client.common.function.FunctionWrapper.throwingMapToPairWrapper;\n+import static org.apache.hudi.client.common.function.FunctionWrapper.throwingMapWrapper;\n+\n+/**\n+ * A flink engine implementation of HoodieEngineContext.\n+ */\n+public class HoodieFlinkEngineContext extends HoodieEngineContext {\n+\n+  public HoodieFlinkEngineContext(TaskContextSupplier taskContextSupplier) {\n+    this(new SerializableConfiguration(new Configuration()), taskContextSupplier);\n+  }\n+\n+  public HoodieFlinkEngineContext(SerializableConfiguration hadoopConf, TaskContextSupplier taskContextSupplier) {\n+    super(hadoopConf, taskContextSupplier);\n+  }\n+\n+  @Override\n+  public <I, O> List<O> map(List<I> data, SerializableFunction<I, O> func, int parallelism) {\n+    return data.stream().parallel().map(throwingMapWrapper(func)).collect(Collectors.toList());\n+  }\n+\n+  @Override\n+  public <I, O> List<O> flatMap(List<I> data, SerializableFunction<I, Stream<O>> func, int parallelism) {\n+    return data.stream().parallel().flatMap(throwingFlatMapWrapper(func)).collect(Collectors.toList());\n+  }\n+\n+  @Override\n+  public <I> void foreach(List<I> data, SerializableConsumer<I> consumer, int parallelism) {\n+    data.forEach(throwingForeachWrapper(consumer));\n+  }\n+\n+  @Override\n+  public <I, K, V> Map<K, V> mapToPair(List<I> data, SerializablePairFunction<I, K, V> func, Integer parallelism) {\n+    Map<K, V> map = new HashMap<>();\n+    data.stream().map(throwingMapToPairWrapper(func)).forEach(x -> map.put(x._1, x._2));\n+    return map;\n+  }\n+\n+  @Override\n+  public void setProperty(EngineProperty key, String value) {\n+    // no operation for now\n+  }\n+\n+  @Override\n+  public Option<String> getProperty(EngineProperty key) {\n+    // no operation for now\n+    return Option.empty();\n+  }\n+\n+  @Override\n+  public void setJobStatus(String activeModule, String activityDescription) {\n+    // no operation for now\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b82c40f0ad533d0b1d4730e91ad4d0133b49c1d"}, "originalPosition": 88}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MDU0MDU4", "url": "https://github.com/apache/hudi/pull/2161#pullrequestreview-506054058", "createdAt": "2020-10-10T01:46:05Z", "commit": {"oid": "5b82c40f0ad533d0b1d4730e91ad4d0133b49c1d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMFQwMTo0NjowNVrOHfcOYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMFQwMTo0NjowNVrOHfcOYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjczMDMzNg==", "bodyText": "here would always get spark instead of flink?", "url": "https://github.com/apache/hudi/pull/2161#discussion_r502730336", "createdAt": "2020-10-10T01:46:05Z", "author": {"login": "leesf"}, "path": "hudi-client/hudi-flink-client/src/test/java/org/apache/hudi/client/common/TestHoodieFlinkEngineContext.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.client.common;\n+\n+import org.apache.hudi.common.util.Option;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import scala.Tuple2;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.function.Supplier;\n+\n+/**\n+ * Unit test against HoodieFlinkEngineContext.\n+ */\n+public class TestHoodieFlinkEngineContext {\n+  private HoodieFlinkEngineContext context;\n+\n+  @BeforeEach\n+  public void init() {\n+    context = new HoodieFlinkEngineContext(new DummyTaskContextSupplier());\n+  }\n+\n+  @Test\n+  public void testMap() {\n+    List<Integer> mapList = Arrays.asList(1, 2, 3, 4, 5, 6, 7, 8, 9, 10);\n+    List<Integer> result = context.map(mapList, x -> x + 1, 2);\n+    result.removeAll(mapList);\n+\n+    Assertions.assertEquals(1, result.size());\n+    Assertions.assertEquals(11, result.get(0));\n+  }\n+\n+  @Test\n+  public void testFlatMap() {\n+    List<String> list1 = Arrays.asList(\"a\", \"b\", \"c\");\n+    List<String> list2 = Arrays.asList(\"d\", \"e\", \"f\");\n+    List<String> list3 = Arrays.asList(\"g\", \"h\", \"i\");\n+\n+    List<List<String>> inputList = new ArrayList<>();\n+    inputList.add(list1);\n+    inputList.add(list2);\n+    inputList.add(list3);\n+\n+    List<String> result = context.flatMap(inputList, Collection::stream, 2);\n+\n+    Assertions.assertEquals(9, result.size());\n+  }\n+\n+  @Test\n+  public void testForeach() {\n+    List<Integer> mapList = Arrays.asList(1, 2, 3, 4, 5, 6, 7, 8, 9, 10);\n+    List<Integer> result = new ArrayList<>(10);\n+    context.foreach(mapList, result::add, 2);\n+\n+    Assertions.assertEquals(result.size(), mapList.size());\n+    Assertions.assertTrue(result.containsAll(mapList));\n+  }\n+\n+  @Test\n+  public void testMapToPair() {\n+    List<String> mapList = Arrays.asList(\"hudi_flink\", \"hudi_spark\");\n+\n+    Map<String, String> resultMap = context.mapToPair(mapList, x -> {\n+      String[] splits = x.split(\"_\");\n+      return Tuple2.apply(splits[0], splits[1]);\n+    }, 2);\n+\n+    Assertions.assertEquals(\"spark\", resultMap.get(\"hudi\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b82c40f0ad533d0b1d4730e91ad4d0133b49c1d"}, "originalPosition": 90}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be70afdbbc55bb9a0870a8d3d0cff66ae12a441f", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/be70afdbbc55bb9a0870a8d3d0cff66ae12a441f", "committedDate": "2020-10-10T01:56:21Z", "message": "[HUDI-1328] Introduce HoodieFlinkEngineContext to hudi-flink-client"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9a244afb0d0133c21788d1c72ebde2db897f8c60", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/9a244afb0d0133c21788d1c72ebde2db897f8c60", "committedDate": "2020-10-10T01:43:41Z", "message": "replace RunTimeException with HoodieException"}, "afterCommit": {"oid": "be70afdbbc55bb9a0870a8d3d0cff66ae12a441f", "author": {"user": {"login": "wangxianghu", "name": "wangxianghu"}}, "url": "https://github.com/apache/hudi/commit/be70afdbbc55bb9a0870a8d3d0cff66ae12a441f", "committedDate": "2020-10-10T01:56:21Z", "message": "[HUDI-1328] Introduce HoodieFlinkEngineContext to hudi-flink-client"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MjUxMjg5", "url": "https://github.com/apache/hudi/pull/2161#pullrequestreview-506251289", "createdAt": "2020-10-12T02:04:28Z", "commit": {"oid": "be70afdbbc55bb9a0870a8d3d0cff66ae12a441f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3MTMwNzY1", "url": "https://github.com/apache/hudi/pull/2161#pullrequestreview-507130765", "createdAt": "2020-10-13T07:13:58Z", "commit": {"oid": "be70afdbbc55bb9a0870a8d3d0cff66ae12a441f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4139, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}