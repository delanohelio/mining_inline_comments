{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ3NzE3NTY5", "number": 1818, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwNDozMzoyM1rOENd7yA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QwMToyNDo1N1rOENp37g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNTU3Mzg0OnYy", "diffSide": "LEFT", "path": "hudi-client/src/test/java/org/apache/hudi/index/hbase/TestHBaseIndex.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwNDozMzoyM1rOGwKVgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwNDozMzoyM1rOGwKVgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE1NDE3Nw==", "bodyText": "moved to a separate unit test class", "url": "https://github.com/apache/hudi/pull/1818#discussion_r453154177", "createdAt": "2020-07-11T04:33:23Z", "author": {"login": "xushiyan"}, "path": "hudi-client/src/test/java/org/apache/hudi/index/hbase/TestHBaseIndex.java", "diffHunk": "@@ -313,53 +303,17 @@ public void testTotalPutsBatching() throws Exception {\n     // Get all the files generated\n     int numberOfDataFileIds = (int) writeStatues.map(status -> status.getFileId()).distinct().count();\n \n-    index.updateLocation(writeStatues, jsc, hoodieTable);\n+    index.updateLocation(writeStatues, jsc(), hoodieTable);\n     // 3 batches should be executed given batchSize = 100 and <=numberOfDataFileIds getting updated,\n     // so each fileId ideally gets updates\n     verify(table, atMost(numberOfDataFileIds)).put((List<Put>) any());\n   }\n \n-  @Test\n-  public void testPutBatchSizeCalculation() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 294}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNTU3NDA2OnYy", "diffSide": "LEFT", "path": "hudi-client/src/test/java/org/apache/hudi/index/hbase/TestHBaseIndex.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwNDozMzo1MFrOGwKVmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwNDozMzo1MFrOGwKVmw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE1NDIwMw==", "bodyText": "duplicate test case in org.apache.hudi.index.hbase.TestHBaseQPSResourceAllocator", "url": "https://github.com/apache/hudi/pull/1818#discussion_r453154203", "createdAt": "2020-07-11T04:33:50Z", "author": {"login": "xushiyan"}, "path": "hudi-client/src/test/java/org/apache/hudi/index/hbase/TestHBaseIndex.java", "diffHunk": "@@ -383,22 +337,12 @@ public void testsHBasePutAccessParallelismWithNoInserts() {\n     assertEquals(0, hbaseNumPuts);\n   }\n \n-  @Test\n-  public void testsHBaseIndexDefaultQPSResourceAllocator() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 352}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNTU3NDIxOnYy", "diffSide": "LEFT", "path": "hudi-client/src/test/java/org/apache/hudi/index/hbase/TestHBaseIndex.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwNDozNDowOFrOGwKVrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQwNDozNDowOFrOGwKVrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE1NDIyMw==", "bodyText": "moved to a separate unit test class", "url": "https://github.com/apache/hudi/pull/1818#discussion_r453154223", "createdAt": "2020-07-11T04:34:08Z", "author": {"login": "xushiyan"}, "path": "hudi-client/src/test/java/org/apache/hudi/index/hbase/TestHBaseIndex.java", "diffHunk": "@@ -460,47 +404,34 @@ public void testDelete() throws Exception {\n       // Now tagLocation for these records, hbaseIndex should tag them correctly\n       metaClient = HoodieTableMetaClient.reload(metaClient);\n       hoodieTable = HoodieTable.create(metaClient, config, hadoopConf);\n-      javaRDD = index.tagLocation(writeRecords, jsc, hoodieTable);\n-      assertEquals(10, javaRDD.filter(record -> record.isCurrentLocationKnown()).collect().size());\n-      assertEquals(10, javaRDD.map(record -> record.getKey().getRecordKey()).distinct().count());\n-      assertEquals(10, javaRDD.filter(record -> (record.getCurrentLocation() != null\n+      List<HoodieRecord> records2 = index.tagLocation(writeRecords, jsc(), hoodieTable).collect();\n+      assertEquals(numRecords, records2.stream().filter(record -> record.isCurrentLocationKnown()).count());\n+      assertEquals(numRecords, records2.stream().map(record -> record.getKey().getRecordKey()).distinct().count());\n+      assertEquals(numRecords, records2.stream().filter(record -> (record.getCurrentLocation() != null\n           && record.getCurrentLocation().getInstantTime().equals(newCommitTime))).distinct().count());\n \n       // Delete all records. This has to be done directly as deleting index entries\n       // is not implemented via HoodieWriteClient\n-      Option recordMetadata = Option.empty();\n       JavaRDD<WriteStatus> deleteWriteStatues = writeStatues.map(w -> {\n         WriteStatus newWriteStatus = new WriteStatus(true, 1.0);\n-        w.getWrittenRecords().forEach(r -> newWriteStatus.markSuccess(new HoodieRecord(r.getKey(), null), recordMetadata));\n+        w.getWrittenRecords().forEach(r -> newWriteStatus.markSuccess(new HoodieRecord(r.getKey(), null), Option.empty()));\n         assertEquals(w.getTotalRecords(), newWriteStatus.getTotalRecords());\n         newWriteStatus.setStat(new HoodieWriteStat());\n         return newWriteStatus;\n       });\n-      JavaRDD<WriteStatus> deleteStatus = index.updateLocation(deleteWriteStatues, jsc, hoodieTable);\n+      JavaRDD<WriteStatus> deleteStatus = index.updateLocation(deleteWriteStatues, jsc(), hoodieTable);\n       assertEquals(deleteStatus.count(), deleteWriteStatues.count());\n       assertNoWriteErrors(deleteStatus.collect());\n \n       // Ensure no records can be tagged\n-      javaRDD = index.tagLocation(writeRecords, jsc, hoodieTable);\n-      assertEquals(0, javaRDD.filter(record -> record.isCurrentLocationKnown()).collect().size());\n-      assertEquals(10, javaRDD.map(record -> record.getKey().getRecordKey()).distinct().count());\n-      assertEquals(0, javaRDD.filter(record -> (record.getCurrentLocation() != null\n+      List<HoodieRecord> records3 = index.tagLocation(writeRecords, jsc(), hoodieTable).collect();\n+      assertEquals(0, records3.stream().filter(record -> record.isCurrentLocationKnown()).count());\n+      assertEquals(numRecords, records3.stream().map(record -> record.getKey().getRecordKey()).distinct().count());\n+      assertEquals(0, records3.stream().filter(record -> (record.getCurrentLocation() != null\n           && record.getCurrentLocation().getInstantTime().equals(newCommitTime))).distinct().count());\n     }\n   }\n \n-  @Test\n-  public void testFeatureSupport() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 479}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNzUzMDA2OnYy", "diffSide": "RIGHT", "path": "hudi-client/src/test/java/org/apache/hudi/testutils/providers/DFSProvider.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QwMToyNDo1N1rOGwYzUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QwODozMDowN1rOGweRAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM5MTE4Nw==", "bodyText": "its not very clear what a sub path stands for? rename to make it clearer?", "url": "https://github.com/apache/hudi/pull/1818#discussion_r453391187", "createdAt": "2020-07-13T01:24:57Z", "author": {"login": "vinothchandar"}, "path": "hudi-client/src/test/java/org/apache/hudi/testutils/providers/DFSProvider.java", "diffHunk": "@@ -31,4 +33,6 @@\n \n   Path dfsBasePath();\n \n+  Path dfsSubPath() throws IOException;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ4MDcwNg==", "bodyText": "ok remove this api.. not used at the moment.", "url": "https://github.com/apache/hudi/pull/1818#discussion_r453480706", "createdAt": "2020-07-13T08:30:07Z", "author": {"login": "xushiyan"}, "path": "hudi-client/src/test/java/org/apache/hudi/testutils/providers/DFSProvider.java", "diffHunk": "@@ -31,4 +33,6 @@\n \n   Path dfsBasePath();\n \n+  Path dfsSubPath() throws IOException;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM5MTE4Nw=="}, "originalCommit": null, "originalPosition": 20}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4550, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}