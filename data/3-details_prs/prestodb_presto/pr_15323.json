{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA1MTI4MjMz", "number": 15323, "title": "Add peak node total memory to statistics", "bodyText": "Unit tested, also deployed and checked to see that the statistics appears in downstream consumers.\n== RELEASE NOTES ==\n\nGeneral Changes\n* Add `peak_node_total_memory` to statistics to allow monitoring the peak sum of memory used across tasks at any node by a query", "createdAt": "2020-10-16T22:19:25Z", "url": "https://github.com/prestodb/presto/pull/15323", "merged": true, "mergeCommit": {"oid": "94a3e0ac3544c8afb16751cb9d5e216cd2d69ce2"}, "closed": true, "closedAt": "2020-10-28T19:14:53Z", "author": {"login": "aweisberg"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdUzWpegBqjM5MDU4MTc4NzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdWw6z7gBqjM5Mjg1NTg5MTA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6404fd56ca9265f0726433e7b7e8ceee2fbece3e", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/6404fd56ca9265f0726433e7b7e8ceee2fbece3e", "committedDate": "2020-10-16T22:18:11Z", "message": "Add peak node total memory to statistics"}, "afterCommit": {"oid": "7423fe40dbebcb8a9ecc9d1da9530f3c6a338198", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/7423fe40dbebcb8a9ecc9d1da9530f3c6a338198", "committedDate": "2020-10-21T20:25:24Z", "message": "Add peak node total memory to statistics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b293c79a176424fcf1580bc371811b0853a76bc", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/0b293c79a176424fcf1580bc371811b0853a76bc", "committedDate": "2020-10-27T15:05:50Z", "message": "Only fetch memory reservation when needed"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7423fe40dbebcb8a9ecc9d1da9530f3c6a338198", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/7423fe40dbebcb8a9ecc9d1da9530f3c6a338198", "committedDate": "2020-10-21T20:25:24Z", "message": "Add peak node total memory to statistics"}, "afterCommit": {"oid": "3c62eb9fbd80875a665140a2b777b3a7db322c87", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/3c62eb9fbd80875a665140a2b777b3a7db322c87", "committedDate": "2020-10-27T15:05:50Z", "message": "Add peak node total memory to statistics"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3c62eb9fbd80875a665140a2b777b3a7db322c87", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/3c62eb9fbd80875a665140a2b777b3a7db322c87", "committedDate": "2020-10-27T15:05:50Z", "message": "Add peak node total memory to statistics"}, "afterCommit": {"oid": "9032d0f6ee4504bc53adfdcc76d0196ac8ee3d66", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/9032d0f6ee4504bc53adfdcc76d0196ac8ee3d66", "committedDate": "2020-10-27T15:11:29Z", "message": "Add peak node total memory to statistics"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3ODU2NzMz", "url": "https://github.com/prestodb/presto/pull/15323#pullrequestreview-517856733", "createdAt": "2020-10-27T15:45:05Z", "commit": {"oid": "9032d0f6ee4504bc53adfdcc76d0196ac8ee3d66"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3ODU3MzEy", "url": "https://github.com/prestodb/presto/pull/15323#pullrequestreview-517857312", "createdAt": "2020-10-27T15:45:36Z", "commit": {"oid": "9032d0f6ee4504bc53adfdcc76d0196ac8ee3d66"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxNTo0NTozNlrOHpDPZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxNTo0OToxNFrOHpDcnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjgwNjc1OA==", "bodyText": "what's this?", "url": "https://github.com/prestodb/presto/pull/15323#discussion_r512806758", "createdAt": "2020-10-27T15:45:36Z", "author": {"login": "wenleix"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/QueryStateMachine.java", "diffHunk": "@@ -111,6 +111,8 @@\n \n     private final AtomicLong peakTaskUserMemory = new AtomicLong();\n     private final AtomicLong peakTaskTotalMemory = new AtomicLong();\n+    // TODO populate this value", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9032d0f6ee4504bc53adfdcc76d0196ac8ee3d66"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjgwNzEzMg==", "bodyText": "nit: one parameter per line", "url": "https://github.com/prestodb/presto/pull/15323#discussion_r512807132", "createdAt": "2020-10-27T15:46:01Z", "author": {"login": "wenleix"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/QueryStateMachine.java", "diffHunk": "@@ -302,14 +309,15 @@ public WarningCollector getWarningCollector()\n         return warningCollector;\n     }\n \n-    public void updateMemoryUsage(long deltaUserMemoryInBytes, long deltaTotalMemoryInBytes, long taskUserMemoryInBytes, long taskTotalMemoryInBytes)\n+    public void updateMemoryUsage(long deltaUserMemoryInBytes, long deltaTotalMemoryInBytes, long taskUserMemoryInBytes, long taskTotalMemoryInBytes, long peakNodeTotalMemoryInBytes)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9032d0f6ee4504bc53adfdcc76d0196ac8ee3d66"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjgwOTU1Nw==", "bodyText": "nit: what about using totalMemory  as variable name and also use it in line 424?", "url": "https://github.com/prestodb/presto/pull/15323#discussion_r512809557", "createdAt": "2020-10-27T15:48:42Z", "author": {"login": "wenleix"}, "path": "presto-main/src/main/java/com/facebook/presto/memory/QueryContext.java", "diffHunk": "@@ -413,9 +420,11 @@ private void enforceUserMemoryLimit(long allocated, long delta, long maxMemory)\n     @GuardedBy(\"this\")\n     private void enforceTotalMemoryLimit(long allocated, long delta, long maxMemory)\n     {\n+        long newTotal = allocated + delta;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9032d0f6ee4504bc53adfdcc76d0196ac8ee3d66"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjgxMDE0Mw==", "bodyText": "Wondering if this could be done before line 424? -- no strong opinion.", "url": "https://github.com/prestodb/presto/pull/15323#discussion_r512810143", "createdAt": "2020-10-27T15:49:14Z", "author": {"login": "wenleix"}, "path": "presto-main/src/main/java/com/facebook/presto/memory/QueryContext.java", "diffHunk": "@@ -413,9 +420,11 @@ private void enforceUserMemoryLimit(long allocated, long delta, long maxMemory)\n     @GuardedBy(\"this\")\n     private void enforceTotalMemoryLimit(long allocated, long delta, long maxMemory)\n     {\n+        long newTotal = allocated + delta;\n         if (allocated + delta > maxMemory) {\n             throw exceededLocalTotalMemoryLimit(succinctBytes(maxMemory), getAdditionalFailureInfo(allocated, delta));\n         }\n+        peakNodeTotalMemory = Math.max(newTotal, peakNodeTotalMemory);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9032d0f6ee4504bc53adfdcc76d0196ac8ee3d66"}, "originalPosition": 29}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9032d0f6ee4504bc53adfdcc76d0196ac8ee3d66", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/9032d0f6ee4504bc53adfdcc76d0196ac8ee3d66", "committedDate": "2020-10-27T15:11:29Z", "message": "Add peak node total memory to statistics"}, "afterCommit": {"oid": "a3bb95df0a2aa94488b85236b15c9ec283e4bfe7", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/a3bb95df0a2aa94488b85236b15c9ec283e4bfe7", "committedDate": "2020-10-27T16:02:48Z", "message": "Add peak node total memory to statistics"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a3bb95df0a2aa94488b85236b15c9ec283e4bfe7", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/a3bb95df0a2aa94488b85236b15c9ec283e4bfe7", "committedDate": "2020-10-27T16:02:48Z", "message": "Add peak node total memory to statistics"}, "afterCommit": {"oid": "f69ddd32a01bc6e6fd9668a2314236149e935fef", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/f69ddd32a01bc6e6fd9668a2314236149e935fef", "committedDate": "2020-10-27T17:01:09Z", "message": "Add peak node total memory to statistics"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f69ddd32a01bc6e6fd9668a2314236149e935fef", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/f69ddd32a01bc6e6fd9668a2314236149e935fef", "committedDate": "2020-10-27T17:01:09Z", "message": "Add peak node total memory to statistics"}, "afterCommit": {"oid": "37a1da6c3540f82f4d888c9d2bf81b799befee08", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/37a1da6c3540f82f4d888c9d2bf81b799befee08", "committedDate": "2020-10-27T17:58:26Z", "message": "Add peak node total memory to statistics"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "37a1da6c3540f82f4d888c9d2bf81b799befee08", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/37a1da6c3540f82f4d888c9d2bf81b799befee08", "committedDate": "2020-10-27T17:58:26Z", "message": "Add peak node total memory to statistics"}, "afterCommit": {"oid": "f10011116af0a99ae1615f99ee5bf8cb133e12a8", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/f10011116af0a99ae1615f99ee5bf8cb133e12a8", "committedDate": "2020-10-27T21:12:18Z", "message": "Add peak node total memory to statistics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b496ada6b4cdf1a92a7cff134f49be8a99becf1", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/8b496ada6b4cdf1a92a7cff134f49be8a99becf1", "committedDate": "2020-10-27T22:43:02Z", "message": "Add peak node total memory to statistics"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f10011116af0a99ae1615f99ee5bf8cb133e12a8", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/f10011116af0a99ae1615f99ee5bf8cb133e12a8", "committedDate": "2020-10-27T21:12:18Z", "message": "Add peak node total memory to statistics"}, "afterCommit": {"oid": "8b496ada6b4cdf1a92a7cff134f49be8a99becf1", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/8b496ada6b4cdf1a92a7cff134f49be8a99becf1", "committedDate": "2020-10-27T22:43:02Z", "message": "Add peak node total memory to statistics"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4928, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}