{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk1MjQ1NTA4", "number": 15250, "title": "Do not ignore table bucketing when query uses bucket column", "bodyText": "Test plan -\nIntegration test added. Table bucketing for table that uses $bucket column is not ignored.\n== NO RELEASE NOTE ==", "createdAt": "2020-09-30T04:37:17Z", "url": "https://github.com/prestodb/presto/pull/15250", "merged": true, "mergeCommit": {"oid": "00e61e4ff38bb9ec0782f57db11f81156a689f7b"}, "closed": true, "closedAt": "2020-09-30T22:05:46Z", "author": {"login": "viczhang861"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdN2prhgH2gAyNDk1MjQ1NTA4Ojk5OTBkNzgwZGZhZDA0YjVjYjkwZjU5Y2IwMjIxY2E3ZjI5NzU0ODk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdOEMCygFqTQ5OTg0NTIwOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9990d780dfad04b5cb90f59cb0221ca7f2975489", "author": {"user": {"login": "viczhang861", "name": "Vic Zhang"}}, "url": "https://github.com/prestodb/presto/commit/9990d780dfad04b5cb90f59cb0221ca7f2975489", "committedDate": "2020-09-30T06:18:39Z", "message": "Do not ignore table bucketing when query uses bucket column"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cf1a514aafa70af1a6f99e0a927c3961eaad6cd0", "author": {"user": {"login": "viczhang861", "name": "Vic Zhang"}}, "url": "https://github.com/prestodb/presto/commit/cf1a514aafa70af1a6f99e0a927c3961eaad6cd0", "committedDate": "2020-09-30T01:19:40Z", "message": "Do not ignore table bucketing when query uses bucket column"}, "afterCommit": {"oid": "9990d780dfad04b5cb90f59cb0221ca7f2975489", "author": {"user": {"login": "viczhang861", "name": "Vic Zhang"}}, "url": "https://github.com/prestodb/presto/commit/9990d780dfad04b5cb90f59cb0221ca7f2975489", "committedDate": "2020-09-30T06:18:39Z", "message": "Do not ignore table bucketing when query uses bucket column"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5NTI0Nzkw", "url": "https://github.com/prestodb/presto/pull/15250#pullrequestreview-499524790", "createdAt": "2020-09-30T14:58:39Z", "commit": {"oid": "9990d780dfad04b5cb90f59cb0221ca7f2975489"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5NTgxNDU2", "url": "https://github.com/prestodb/presto/pull/15250#pullrequestreview-499581456", "createdAt": "2020-09-30T15:55:53Z", "commit": {"oid": "9990d780dfad04b5cb90f59cb0221ca7f2975489"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxNTo1NTo1M1rOHakcGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxNTo1NTo1M1rOHakcGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzYyMjA0MA==", "bodyText": "wouldn't this still return Optional.empty() if shouldIgnoreTableBucketing is true, since that condition is checked first?", "url": "https://github.com/prestodb/presto/pull/15250#discussion_r497622040", "createdAt": "2020-09-30T15:55:53Z", "author": {"login": "rschlussel"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePartitionManager.java", "diffHunk": "@@ -246,24 +246,31 @@ public HivePartitionResult getPartitions(SemiTransactionalHiveMetastore metastor\n                 bucketFilter);\n     }\n \n-    private Optional<HiveBucketHandle> getBucketHandle(Table table, ConnectorSession session)\n+    private Optional<HiveBucketHandle> getBucketHandle(\n+            Table table,\n+            ConnectorSession session,\n+            TupleDomain<ColumnHandle> effectivePredicate)\n     {\n         // never ignore table bucketing for temporary tables as those are created such explicitly by the engine request\n         if (table.getTableType().equals(TEMPORARY_TABLE)) {\n             return getHiveBucketHandle(table);\n         }\n \n         Optional<HiveBucketHandle> hiveBucketHandle = getHiveBucketHandle(table);\n-        if (!hiveBucketHandle.isPresent()) {\n+        if (!hiveBucketHandle.isPresent() || shouldIgnoreTableBucketing(session)) {\n             return Optional.empty();\n         }\n \n+        if (queryUsesHiveBucketColumn(effectivePredicate)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9990d780dfad04b5cb90f59cb0221ca7f2975489"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5ODQ1MjA4", "url": "https://github.com/prestodb/presto/pull/15250#pullrequestreview-499845208", "createdAt": "2020-09-30T22:04:57Z", "commit": {"oid": "9990d780dfad04b5cb90f59cb0221ca7f2975489"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4811, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}