{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYzMDg1NzQ4", "number": 14958, "title": "Support skipping control in Verifier", "bodyText": "== RELEASE NOTES ==\n\nVerifier Changes\n* Add support to skip running control queries and comparing results. This can be enabled by configuration property ``skip-control``.", "createdAt": "2020-08-05T01:04:20Z", "url": "https://github.com/prestodb/presto/pull/14958", "merged": true, "mergeCommit": {"oid": "c406344b34646fceda8f0ab537b1fea8ce6ed24b"}, "closed": true, "closedAt": "2020-08-05T21:03:41Z", "author": {"login": "caithagoras"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc7woPwgBqjM2MjI1NzI1NTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc8APg4gBqjM2MjYwOTcxNzE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ad4bdcc4465dbd66422cf455cb8adc9642d6fc92", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/ad4bdcc4465dbd66422cf455cb8adc9642d6fc92", "committedDate": "2020-08-04T19:00:51Z", "message": "Support skipping control in Verifier"}, "afterCommit": {"oid": "f9909702f3ba09ad3928a8c5861223f84ad7c722", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/f9909702f3ba09ad3928a8c5861223f84ad7c722", "committedDate": "2020-08-05T01:06:50Z", "message": "Support skipping control in Verifier"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f9909702f3ba09ad3928a8c5861223f84ad7c722", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/f9909702f3ba09ad3928a8c5861223f84ad7c722", "committedDate": "2020-08-05T01:06:50Z", "message": "Support skipping control in Verifier"}, "afterCommit": {"oid": "a63ef21c730b45f3d30a3811f8a424b01485e75a", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/a63ef21c730b45f3d30a3811f8a424b01485e75a", "committedDate": "2020-08-05T01:20:22Z", "message": "Support skipping control in Verifier"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a63ef21c730b45f3d30a3811f8a424b01485e75a", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/a63ef21c730b45f3d30a3811f8a424b01485e75a", "committedDate": "2020-08-05T01:20:22Z", "message": "Support skipping control in Verifier"}, "afterCommit": {"oid": "2bfac9a2c5635536a4990bdecb2ff771ba128956", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/2bfac9a2c5635536a4990bdecb2ff771ba128956", "committedDate": "2020-08-05T01:40:09Z", "message": "Support skipping control in Verifier"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMzI5Njcw", "url": "https://github.com/prestodb/presto/pull/14958#pullrequestreview-461329670", "createdAt": "2020-08-05T04:23:25Z", "commit": {"oid": "2bfac9a2c5635536a4990bdecb2ff771ba128956"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQwNDoyMzoyNVrOG75pPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQwNDozMjoxMlrOG75x1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ2MzYxMg==", "bodyText": "nit: is the indentation suggested by Intellij?", "url": "https://github.com/prestodb/presto/pull/14958#discussion_r465463612", "createdAt": "2020-08-05T04:23:25Z", "author": {"login": "wenleix"}, "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/event/VerifierQueryEvent.java", "diffHunk": "@@ -113,10 +114,12 @@ public static VerifierQueryEvent skipped(\n                 Optional.empty(),\n                 Optional.empty(),\n                 Optional.empty(),\n-                new QueryInfo(\n+                skipControl\n+                        ? Optional.empty()\n+                        : Optional.of(new QueryInfo(\n                         sourceQuery.getControlConfiguration().getCatalog(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bfac9a2c5635536a4990bdecb2ff771ba128956"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ2Mzg0Nw==", "bodyText": "nit: unnecessary line break?", "url": "https://github.com/prestodb/presto/pull/14958#discussion_r465463847", "createdAt": "2020-08-05T04:24:22Z", "author": {"login": "wenleix"}, "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/framework/AbstractVerification.java", "diffHunk": "@@ -176,22 +185,25 @@ public VerificationResult run()\n             testQueryContext.setState(QueryState.SUCCEEDED);\n \n             // Verify results\n-            matchResult = Optional.of(verify(controlQueryBundle, test.get(), controlChecksumQueryContext, testChecksumQueryContext));\n+            if (!skipControl) {\n+                matchResult = Optional.of(verify(control.get(), test.get(), controlChecksumQueryContext, testChecksumQueryContext));\n \n-            // Determinism analysis\n-            if (matchResult.get().isMismatchPossiblyCausedByNonDeterminism()) {\n-                determinismAnalysis = Optional.of(determinismAnalyzer.analyze(controlQueryBundle, matchResult.get().getControlChecksum(), determinismAnalysisDetails));\n+                // Determinism analysis\n+                if (matchResult.get().isMismatchPossiblyCausedByNonDeterminism()) {\n+                    determinismAnalysis = Optional.of(determinismAnalyzer.analyze(control.get(), matchResult.get().getControlChecksum(), determinismAnalysisDetails));\n+                }\n             }\n \n-            partialResult = Optional.of(concludeVerificationPartial(control, test, controlQueryContext, matchResult, determinismAnalysis, Optional.empty()));\n+            partialResult = Optional.of(concludeVerificationPartial(control, test, controlQueryContext, testQueryContext, matchResult, determinismAnalysis, Optional.empty()));\n         }\n-        catch (Throwable t) {\n+        catch (\n+                Throwable t) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bfac9a2c5635536a4990bdecb2ff771ba128956"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ2NDI0MA==", "bodyText": "nit: unnecessary empty line?", "url": "https://github.com/prestodb/presto/pull/14958#discussion_r465464240", "createdAt": "2020-08-05T04:25:51Z", "author": {"login": "wenleix"}, "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/framework/AbstractVerification.java", "diffHunk": "@@ -204,18 +216,21 @@ public VerificationResult run()\n             }\n         }\n \n-        return concludeVerification(\n-                partialResult.get(),\n-                control,\n-                test,\n-                controlQueryContext,\n-                testQueryContext,\n-                matchResult,\n-                determinismAnalysis,\n-                controlChecksumQueryContext,\n-                testChecksumQueryContext,\n-                determinismAnalysisDetails.build(),\n-                throwable);\n+        return\n+\n+                concludeVerification(\n+                        partialResult.get(),\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bfac9a2c5635536a4990bdecb2ff771ba128956"}, "originalPosition": 117}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ2NTgxMw==", "bodyText": "nit: the indentation is not easy to read now...One idea is\n: Optional.of(\n      buildQueryInfo(\n            sourceQuery.getControlConfiguration(),\n............\nBut that's just my personal way. Feel free to keep the current approach if you see fit.", "url": "https://github.com/prestodb/presto/pull/14958#discussion_r465465813", "createdAt": "2020-08-05T04:32:12Z", "author": {"login": "wenleix"}, "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/framework/AbstractVerification.java", "diffHunk": "@@ -301,12 +319,14 @@ private VerificationResult concludeVerification(\n                         Optional.of(determinismAnalysisDetails) :\n                         Optional.empty(),\n                 partialResult.getResolveMessage(),\n-                buildQueryInfo(\n+                skipControl\n+                        ? Optional.empty()\n+                        : Optional.of(buildQueryInfo(\n                         sourceQuery.getControlConfiguration(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bfac9a2c5635536a4990bdecb2ff771ba128956"}, "originalPosition": 175}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2bfac9a2c5635536a4990bdecb2ff771ba128956", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/2bfac9a2c5635536a4990bdecb2ff771ba128956", "committedDate": "2020-08-05T01:40:09Z", "message": "Support skipping control in Verifier"}, "afterCommit": {"oid": "f8b66e440f7da2fe97e1ecb65d54effceb976563", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/f8b66e440f7da2fe97e1ecb65d54effceb976563", "committedDate": "2020-08-05T19:16:46Z", "message": "Support skipping control in Verifiert :"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ff84df4f158963e49b606254d10b71a1a2998e5", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/8ff84df4f158963e49b606254d10b71a1a2998e5", "committedDate": "2020-08-05T19:18:19Z", "message": "Support skipping control in Verifier"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f8b66e440f7da2fe97e1ecb65d54effceb976563", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/f8b66e440f7da2fe97e1ecb65d54effceb976563", "committedDate": "2020-08-05T19:16:46Z", "message": "Support skipping control in Verifiert :"}, "afterCommit": {"oid": "8ff84df4f158963e49b606254d10b71a1a2998e5", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/8ff84df4f158963e49b606254d10b71a1a2998e5", "committedDate": "2020-08-05T19:18:19Z", "message": "Support skipping control in Verifier"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 427, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}