{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkxOTEwNjEy", "number": 15214, "title": "Fix order of dwrf encryption group stats", "bodyText": "Test plan - Added unit test for this case and added stats verification for all decryption tests\n== RELEASE NOTES ==\nHive Changes\n* Fix a bug where non-Presto readers could not read encrypted DWRF files written by Presto if the encryption group listed columns out of order.", "createdAt": "2020-09-23T16:48:04Z", "url": "https://github.com/prestodb/presto/pull/15214", "merged": true, "mergeCommit": {"oid": "c857741afb79f656e0ec21d5b1cb1d7366fc439e"}, "closed": true, "closedAt": "2020-09-23T21:34:55Z", "author": {"login": "rschlussel"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLvfKtgFqTQ5NDg1NzgxOA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLyQnKAFqTQ5NTAwNjIyNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0ODU3ODE4", "url": "https://github.com/prestodb/presto/pull/15214#pullrequestreview-494857818", "createdAt": "2020-09-23T16:49:59Z", "commit": {"oid": "b1f1f0301fa55f5d4feadbaeee3c4abf1090ae4e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b1f1f0301fa55f5d4feadbaeee3c4abf1090ae4e", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/b1f1f0301fa55f5d4feadbaeee3c4abf1090ae4e", "committedDate": "2020-09-23T16:46:47Z", "message": "Fix order of dwrf encryption group stats\n\nStats list should store encrypted stats in the order that nodes are\nlisted in the encryption group."}, "afterCommit": {"oid": "63cc58eb2080307edacee2be46107cddcaa83577", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/63cc58eb2080307edacee2be46107cddcaa83577", "committedDate": "2020-09-23T17:30:03Z", "message": "Fix order of dwrf encryption group stats\n\nStats list should store encrypted stats in the order that nodes are\nlisted in the encryption group."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0OTI4MjEy", "url": "https://github.com/prestodb/presto/pull/15214#pullrequestreview-494928212", "createdAt": "2020-09-23T18:21:25Z", "commit": {"oid": "63cc58eb2080307edacee2be46107cddcaa83577"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxODoyMToyNVrOHW7AGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxODoyNTo1MlrOHW7KWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc5NzQwMQ==", "bodyText": "You can optimize this piece a bit by extracting and moving encryptedStats.get(groupId) outside to line 621.", "url": "https://github.com/prestodb/presto/pull/15214#discussion_r493797401", "createdAt": "2020-09-23T18:21:25Z", "author": {"login": "sdruzkin"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/OrcWriter.java", "diffHunk": "@@ -610,19 +610,22 @@ public void close()\n                 .collect(Collectors.toMap(Entry::getKey, entry -> utf8Slice(entry.getValue())));\n \n         List<ColumnStatistics> unencryptedStats = new ArrayList<>();\n-        Map<Integer, List<Slice>> encryptedStats = new HashMap<>();\n+        Map<Integer, Map<Integer, Slice>> encryptedStats = new HashMap<>();\n         addStatsRecursive(fileStats, 0, new HashMap<>(), unencryptedStats, encryptedStats);\n         Optional<DwrfEncryption> dwrfEncryption;\n         if (dwrfWriterEncryption.isPresent()) {\n             ImmutableList.Builder<EncryptionGroup> encryptionGroupBuilder = ImmutableList.builder();\n             List<WriterEncryptionGroup> writerEncryptionGroups = dwrfWriterEncryption.get().getWriterEncryptionGroups();\n             for (int i = 0; i < writerEncryptionGroups.size(); i++) {\n                 WriterEncryptionGroup group = writerEncryptionGroups.get(i);\n+                int groupId = i;\n                 encryptionGroupBuilder.add(\n                         new EncryptionGroup(\n                                 group.getNodes(),\n                                 Optional.empty(), // reader will just use key metadata from the stripe\n-                                encryptedStats.get(i)));\n+                                group.getNodes().stream()\n+                                        .map(nodeId -> encryptedStats.get(groupId).get(nodeId))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63cc58eb2080307edacee2be46107cddcaa83577"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzgwMDAyNQ==", "bodyText": "Can we also add the same test but with the direct order? I briefly looked through other test cases, they all seems to have the same type for all columns.", "url": "https://github.com/prestodb/presto/pull/15214#discussion_r493800025", "createdAt": "2020-09-23T18:25:52Z", "author": {"login": "sdruzkin"}, "path": "presto-orc/src/test/java/com/facebook/presto/orc/TestDecryption.java", "diffHunk": "@@ -311,6 +312,39 @@ public void testSingleEncryptionGroupRowType()\n                 outputColumns);\n     }\n \n+    @Test\n+    public void testEncryptionGroupWithReversedOrderNodes()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63cc58eb2080307edacee2be46107cddcaa83577"}, "originalPosition": 13}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "63cc58eb2080307edacee2be46107cddcaa83577", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/63cc58eb2080307edacee2be46107cddcaa83577", "committedDate": "2020-09-23T17:30:03Z", "message": "Fix order of dwrf encryption group stats\n\nStats list should store encrypted stats in the order that nodes are\nlisted in the encryption group."}, "afterCommit": {"oid": "04049b85bedc2ff75bcca6f9c5950f008cdb4f5b", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/04049b85bedc2ff75bcca6f9c5950f008cdb4f5b", "committedDate": "2020-09-23T18:36:09Z", "message": "Fix order of dwrf encryption group stats\n\nStats list should store encrypted stats in the order that nodes are\nlisted in the encryption group."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0OTQ4NTI3", "url": "https://github.com/prestodb/presto/pull/15214#pullrequestreview-494948527", "createdAt": "2020-09-23T18:41:41Z", "commit": {"oid": "04049b85bedc2ff75bcca6f9c5950f008cdb4f5b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0OTUwODgz", "url": "https://github.com/prestodb/presto/pull/15214#pullrequestreview-494950883", "createdAt": "2020-09-23T18:45:05Z", "commit": {"oid": "04049b85bedc2ff75bcca6f9c5950f008cdb4f5b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8b4101c4132c65a0f050942c45a72458b229010", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/f8b4101c4132c65a0f050942c45a72458b229010", "committedDate": "2020-09-23T19:59:57Z", "message": "Fix order of dwrf encryption group stats\n\nStats list should store encrypted stats in the order that nodes are\nlisted in the encryption group."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "04049b85bedc2ff75bcca6f9c5950f008cdb4f5b", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/04049b85bedc2ff75bcca6f9c5950f008cdb4f5b", "committedDate": "2020-09-23T18:36:09Z", "message": "Fix order of dwrf encryption group stats\n\nStats list should store encrypted stats in the order that nodes are\nlisted in the encryption group."}, "afterCommit": {"oid": "f8b4101c4132c65a0f050942c45a72458b229010", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/f8b4101c4132c65a0f050942c45a72458b229010", "committedDate": "2020-09-23T19:59:57Z", "message": "Fix order of dwrf encryption group stats\n\nStats list should store encrypted stats in the order that nodes are\nlisted in the encryption group."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MDA2MjI3", "url": "https://github.com/prestodb/presto/pull/15214#pullrequestreview-495006227", "createdAt": "2020-09-23T20:03:48Z", "commit": {"oid": "f8b4101c4132c65a0f050942c45a72458b229010"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 204, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}