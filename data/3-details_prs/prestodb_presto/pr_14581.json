{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIzNTM1OTI1", "number": 14581, "title": "Support all types for temporary hive table", "bodyText": "Unit test will fail before the code change.\nUnit test will fail if temporary_table_storage_format is not PAGEFILE\n\n== NO RELEASE NOTE ==", "createdAt": "2020-05-27T00:37:11Z", "url": "https://github.com/prestodb/presto/pull/14581", "merged": true, "mergeCommit": {"oid": "c877d105629a52f76c00f5b30d2f79692fec7915"}, "closed": true, "closedAt": "2020-06-02T20:02:10Z", "author": {"login": "viczhang861"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABclalyQgFqTQxOTMxMDg1OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcnHkbNgBqjMzOTUwMzU2OTU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5MzEwODU4", "url": "https://github.com/prestodb/presto/pull/14581#pullrequestreview-419310858", "createdAt": "2020-05-27T14:59:07Z", "commit": {"oid": "6f9e0ddc0d0c868c60502509ef6a54f9075f3713"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxNDo1OTowN1rOGbOwGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxNDo1OTozNlrOGbOyMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTIwNjQyNw==", "bodyText": "I would simply change the signature of the first method to Optional<TypeInfo> tryTranslate(Type type)", "url": "https://github.com/prestodb/presto/pull/14581#discussion_r431206427", "createdAt": "2020-05-27T14:59:07Z", "author": {"login": "arhimondr"}, "path": "presto-hive-metastore/src/main/java/com/facebook/presto/hive/TypeTranslator.java", "diffHunk": "@@ -16,7 +16,11 @@\n import com.facebook.presto.common.type.Type;\n import org.apache.hadoop.hive.serde2.typeinfo.TypeInfo;\n \n+import java.util.Optional;\n+\n public interface TypeTranslator\n {\n     TypeInfo translate(Type type);\n+\n+    TypeInfo translate(Type type, Optional<HiveType> defaultHiveType);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f9e0ddc0d0c868c60502509ef6a54f9075f3713"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTIwNjk2Mw==", "bodyText": "Let's do this only for temporary table", "url": "https://github.com/prestodb/presto/pull/14581#discussion_r431206963", "createdAt": "2020-05-27T14:59:36Z", "author": {"login": "arhimondr"}, "path": "presto-hive-metastore/src/main/java/com/facebook/presto/hive/HiveType.java", "diffHunk": "@@ -199,11 +200,27 @@ private static HiveType toHiveType(TypeInfo typeInfo)\n         return new HiveType(typeInfo);\n     }\n \n-    public static HiveType toHiveType(TypeTranslator typeTranslator, Type type)\n+    public static HiveType toHiveType(\n+            TypeTranslator typeTranslator,\n+            Type type)\n+    {\n+        return toHiveType(typeTranslator, type, Optional.empty());\n+    }\n+\n+    public static HiveType toHiveType(\n+            TypeTranslator typeTranslator,\n+            Type type,\n+            Optional<HiveType> defaultHiveType)\n     {\n         requireNonNull(typeTranslator, \"typeTranslator is null\");\n         requireNonNull(type, \"type is null\");\n-        return new HiveType(typeTranslator.translate(type));\n+        requireNonNull(defaultHiveType, \"defaultHiveType is null\");\n+        return new HiveType(typeTranslator.translate(type, defaultHiveType));\n+    }\n+\n+    public static Optional<HiveType> getDefaultHiveType(HiveStorageFormat storageFormat)\n+    {\n+        return storageFormat == PAGEFILE ? Optional.of(HIVE_BINARY) : Optional.empty();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f9e0ddc0d0c868c60502509ef6a54f9075f3713"}, "originalPosition": 34}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6f9e0ddc0d0c868c60502509ef6a54f9075f3713", "author": {"user": {"login": "viczhang861", "name": "Vic Zhang"}}, "url": "https://github.com/prestodb/presto/commit/6f9e0ddc0d0c868c60502509ef6a54f9075f3713", "committedDate": "2020-05-27T00:28:28Z", "message": "Support all types for temporary hive table\n\nConvert unsupported hive type to binary in PageFile format."}, "afterCommit": {"oid": "d18ea7528b6b27521f5f055dbe1286ed5bc9d929", "author": {"user": {"login": "viczhang861", "name": "Vic Zhang"}}, "url": "https://github.com/prestodb/presto/commit/d18ea7528b6b27521f5f055dbe1286ed5bc9d929", "committedDate": "2020-05-27T17:49:08Z", "message": "Support all types for temporary hive table\n\nConvert unsupported hive type to binary in PageFile format."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxMTQ5MDQ0", "url": "https://github.com/prestodb/presto/pull/14581#pullrequestreview-421149044", "createdAt": "2020-05-29T17:27:01Z", "commit": {"oid": "d18ea7528b6b27521f5f055dbe1286ed5bc9d929"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxNzoyNzowMVrOGclxfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxNzozMDozNFrOGcl5fg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjYzMjE4OQ==", "bodyText": "Let this thing fail for now. Ideally the HivePartitioningHandle  shouldn't contain the hive types if the partition handle is for materialized exchange.", "url": "https://github.com/prestodb/presto/pull/14581#discussion_r432632189", "createdAt": "2020-05-29T17:27:01Z", "author": {"login": "arhimondr"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -2213,7 +2215,10 @@ public ConnectorPartitioningHandle getPartitioningHandleForExchange(ConnectorSes\n         return new HivePartitioningHandle(\n                 partitionCount,\n                 partitionTypes.stream()\n-                        .map(type -> toHiveType(typeTranslator, translateHiveUnsupportedTypeForTemporaryTable(type, typeManager)))\n+                        .map(type -> toHiveType(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d18ea7528b6b27521f5f055dbe1286ed5bc9d929"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjYzMjMxNA==", "bodyText": "Let's inline the getDefaultHiveTypeForTemporaryTable", "url": "https://github.com/prestodb/presto/pull/14581#discussion_r432632314", "createdAt": "2020-05-29T17:27:13Z", "author": {"login": "arhimondr"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -867,7 +868,8 @@ public ConnectorTableHandle createTemporaryTable(ConnectorSession session, List<\n                 // type to the boolean type that is binary compatible\n                 translateHiveUnsupportedTypesForTemporaryTable(columns, typeManager),\n                 ImmutableSet.of(),\n-                typeTranslator);\n+                typeTranslator,\n+                getDefaultHiveTypeForTemporaryTable(storageFormat));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d18ea7528b6b27521f5f055dbe1286ed5bc9d929"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjYzMjYzMA==", "bodyText": "I'm slow. You are right, the method is recursive.", "url": "https://github.com/prestodb/presto/pull/14581#discussion_r432632630", "createdAt": "2020-05-29T17:27:45Z", "author": {"login": "arhimondr"}, "path": "presto-hive-metastore/src/main/java/com/facebook/presto/hive/TypeTranslator.java", "diffHunk": "@@ -16,7 +16,11 @@\n import com.facebook.presto.common.type.Type;\n import org.apache.hadoop.hive.serde2.typeinfo.TypeInfo;\n \n+import java.util.Optional;\n+\n public interface TypeTranslator\n {\n     TypeInfo translate(Type type);\n+\n+    TypeInfo translate(Type type, Optional<HiveType> defaultHiveType);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTIwNjQyNw=="}, "originalCommit": {"oid": "6f9e0ddc0d0c868c60502509ef6a54f9075f3713"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjYzMjg4OQ==", "bodyText": "Let's set a default implementation here that calls  translate(type, Optional.empty())", "url": "https://github.com/prestodb/presto/pull/14581#discussion_r432632889", "createdAt": "2020-05-29T17:28:09Z", "author": {"login": "arhimondr"}, "path": "presto-hive-metastore/src/main/java/com/facebook/presto/hive/TypeTranslator.java", "diffHunk": "@@ -16,7 +16,11 @@\n import com.facebook.presto.common.type.Type;\n import org.apache.hadoop.hive.serde2.typeinfo.TypeInfo;\n \n+import java.util.Optional;\n+\n public interface TypeTranslator\n {\n     TypeInfo translate(Type type);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d18ea7528b6b27521f5f055dbe1286ed5bc9d929"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjYzMzEwNw==", "bodyText": "Let's move this implementation as a default implementation in the interface", "url": "https://github.com/prestodb/presto/pull/14581#discussion_r432633107", "createdAt": "2020-05-29T17:28:33Z", "author": {"login": "arhimondr"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveTypeTranslator.java", "diffHunk": "@@ -64,6 +66,12 @@\n {\n     @Override\n     public TypeInfo translate(Type type)\n+    {\n+        return translate(type, Optional.empty());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d18ea7528b6b27521f5f055dbe1286ed5bc9d929"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjYzMzUyMg==", "bodyText": "nit: let's wrap it\nreturn defaultHiveType\n  .orElseThrow(() -> new PrestoException(NOT_SUPPORTED, format(\"Unsupported Hive type: %s\", type)))\n  .getTypeInfo();", "url": "https://github.com/prestodb/presto/pull/14581#discussion_r432633522", "createdAt": "2020-05-29T17:29:20Z", "author": {"login": "arhimondr"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveTypeTranslator.java", "diffHunk": "@@ -146,9 +154,9 @@ else if (varcharLength == VarcharType.UNBOUNDED_LENGTH) {\n             return getStructTypeInfo(\n                     fieldNames.build(),\n                     type.getTypeParameters().stream()\n-                            .map(this::translate)\n+                            .map(t -> translate(t, defaultHiveType))\n                             .collect(toList()));\n         }\n-        throw new PrestoException(NOT_SUPPORTED, format(\"Unsupported Hive type: %s\", type));\n+        return defaultHiveType.orElseThrow(() -> new PrestoException(NOT_SUPPORTED, format(\"Unsupported Hive type: %s\", type))).getTypeInfo();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d18ea7528b6b27521f5f055dbe1286ed5bc9d929"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjYzNDIzOA==", "bodyText": "Maybe add some comment explaining what is going on. The defaultHiveType might be really confusing.", "url": "https://github.com/prestodb/presto/pull/14581#discussion_r432634238", "createdAt": "2020-05-29T17:30:34Z", "author": {"login": "arhimondr"}, "path": "presto-hive-metastore/src/main/java/com/facebook/presto/hive/TypeTranslator.java", "diffHunk": "@@ -16,7 +16,11 @@\n import com.facebook.presto.common.type.Type;\n import org.apache.hadoop.hive.serde2.typeinfo.TypeInfo;\n \n+import java.util.Optional;\n+\n public interface TypeTranslator\n {\n     TypeInfo translate(Type type);\n+\n+    TypeInfo translate(Type type, Optional<HiveType> defaultHiveType);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTIwNjQyNw=="}, "originalCommit": {"oid": "6f9e0ddc0d0c868c60502509ef6a54f9075f3713"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "abcd63a02630e18221b8d2bd2019bf724a97c3f4", "author": {"user": {"login": "viczhang861", "name": "Vic Zhang"}}, "url": "https://github.com/prestodb/presto/commit/abcd63a02630e18221b8d2bd2019bf724a97c3f4", "committedDate": "2020-06-01T21:57:04Z", "message": "Support all types for temporary hive table\n\nContext\n - Hive connector translates PrestoType to corresponding HiveType in\n   Hive type system, for example, HiveType for VARCHAR in Presto\n   is STRING in Hive.\n - Temporary hive table is used to store intermediate data for\n   materialized exchanges. It reuses data structure in Hive connector\n   such as ColumnHandle, TableHandle. Therefore, type translation\n   is required for temporary table to initialize conventional\n   Hive file format readers/writers, etc.\n\nProblem\n - PrestoType that fails to be translated to HiveType cannot be stored\n   in temporary table.\n - With PageFile format, all column types can be supported since the\n   column type metadata is not needed for encoding/decoding. As a\n   result, type translation is not needed for PageFile format.\n\nSolution\n Translate unsupported hive type to HIVE_BINARY.\n - Pros\n   - Reuse existing code and easy to implement.\n - Cons\n   - Complete translation by translating to a never used HiveType is\n     unintuitive.\n\nOther Solutions\n Extract temporary table related code into a separate connector\n - Pros\n   - Support all column types in temporary table by definition without\n     dependency on existing requirements.\n - Cons\n   - Only PageFile format benefits from this change.\n   - For non PageFile format, type translation is still required in\n     readers/writer.\n   - Create a lot duplicated code.\n\n Factor out HiveType from Hive connector, do the translation later when\n actual encoding/decoding or communication with the Metastore happens\n - Pros\n  - Make Hive connector flexible for both temporary and permanent table.\n - Cons\n  - Only PageFile format benefits from this change.\n  - Implementation is complicated as too many components are affected.\n  - Type translation could be delayed but type check is still useful\n    for the purpose of fail early."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d18ea7528b6b27521f5f055dbe1286ed5bc9d929", "author": {"user": {"login": "viczhang861", "name": "Vic Zhang"}}, "url": "https://github.com/prestodb/presto/commit/d18ea7528b6b27521f5f055dbe1286ed5bc9d929", "committedDate": "2020-05-27T17:49:08Z", "message": "Support all types for temporary hive table\n\nConvert unsupported hive type to binary in PageFile format."}, "afterCommit": {"oid": "abcd63a02630e18221b8d2bd2019bf724a97c3f4", "author": {"user": {"login": "viczhang861", "name": "Vic Zhang"}}, "url": "https://github.com/prestodb/presto/commit/abcd63a02630e18221b8d2bd2019bf724a97c3f4", "committedDate": "2020-06-01T21:57:04Z", "message": "Support all types for temporary hive table\n\nContext\n - Hive connector translates PrestoType to corresponding HiveType in\n   Hive type system, for example, HiveType for VARCHAR in Presto\n   is STRING in Hive.\n - Temporary hive table is used to store intermediate data for\n   materialized exchanges. It reuses data structure in Hive connector\n   such as ColumnHandle, TableHandle. Therefore, type translation\n   is required for temporary table to initialize conventional\n   Hive file format readers/writers, etc.\n\nProblem\n - PrestoType that fails to be translated to HiveType cannot be stored\n   in temporary table.\n - With PageFile format, all column types can be supported since the\n   column type metadata is not needed for encoding/decoding. As a\n   result, type translation is not needed for PageFile format.\n\nSolution\n Translate unsupported hive type to HIVE_BINARY.\n - Pros\n   - Reuse existing code and easy to implement.\n - Cons\n   - Complete translation by translating to a never used HiveType is\n     unintuitive.\n\nOther Solutions\n Extract temporary table related code into a separate connector\n - Pros\n   - Support all column types in temporary table by definition without\n     dependency on existing requirements.\n - Cons\n   - Only PageFile format benefits from this change.\n   - For non PageFile format, type translation is still required in\n     readers/writer.\n   - Create a lot duplicated code.\n\n Factor out HiveType from Hive connector, do the translation later when\n actual encoding/decoding or communication with the Metastore happens\n - Pros\n  - Make Hive connector flexible for both temporary and permanent table.\n - Cons\n  - Only PageFile format benefits from this change.\n  - Implementation is complicated as too many components are affected.\n  - Type translation could be delayed but type check is still useful\n    for the purpose of fail early."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1705, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}