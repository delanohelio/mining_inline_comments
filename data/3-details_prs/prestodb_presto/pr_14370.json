{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAxMzU3NDc0", "number": 14370, "title": "Eagerly dereference resources", "bodyText": "== NO RELEASE NOTE ==\n\nThese changes will speed up the GC process for these variables.", "createdAt": "2020-04-09T11:01:38Z", "url": "https://github.com/prestodb/presto/pull/14370", "merged": true, "mergeCommit": {"oid": "ab52a1a58763575a713b240a407a3d7b52a3b944"}, "closed": true, "closedAt": "2020-04-14T04:30:43Z", "author": {"login": "bhhari"}, "timelineItems": {"totalCount": 29, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcWUnbZgBqjMyMjI1NTIxNzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcXbz8lgFqTM5MjU5NTk2Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7a07d7039334c9bdf67527ec2152f2efcce8cb4d", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/7a07d7039334c9bdf67527ec2152f2efcce8cb4d", "committedDate": "2020-04-09T08:15:46Z", "message": "work1"}, "afterCommit": {"oid": "93df3fb51be2e8ab163e593b04a840ab6a089c40", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/93df3fb51be2e8ab163e593b04a840ab6a089c40", "committedDate": "2020-04-10T17:32:46Z", "message": "Clean up OrcReader memebers after close"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "93df3fb51be2e8ab163e593b04a840ab6a089c40", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/93df3fb51be2e8ab163e593b04a840ab6a089c40", "committedDate": "2020-04-10T17:32:46Z", "message": "Clean up OrcReader memebers after close"}, "afterCommit": {"oid": "e5313c0eb6cdea52354249aeb179830d1581f5b1", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/e5313c0eb6cdea52354249aeb179830d1581f5b1", "committedDate": "2020-04-10T17:37:36Z", "message": "Clean up OrcReader memebers after close"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e5313c0eb6cdea52354249aeb179830d1581f5b1", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/e5313c0eb6cdea52354249aeb179830d1581f5b1", "committedDate": "2020-04-10T17:37:36Z", "message": "Clean up OrcReader memebers after close"}, "afterCommit": {"oid": "fd2919ba2924987a96642ce8def3ac810da9b725", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/fd2919ba2924987a96642ce8def3ac810da9b725", "committedDate": "2020-04-10T17:38:28Z", "message": "Clean up OrcReader memebers after close"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fd2919ba2924987a96642ce8def3ac810da9b725", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/fd2919ba2924987a96642ce8def3ac810da9b725", "committedDate": "2020-04-10T17:38:28Z", "message": "Clean up OrcReader memebers after close"}, "afterCommit": {"oid": "5cdedb44af76446692cf652f48e80e760154f6e3", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/5cdedb44af76446692cf652f48e80e760154f6e3", "committedDate": "2020-04-10T17:49:36Z", "message": "Clean up OrcReader memebers after close"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNTc1ODU5", "url": "https://github.com/prestodb/presto/pull/14370#pullrequestreview-391575859", "createdAt": "2020-04-10T17:53:29Z", "commit": {"oid": "5cdedb44af76446692cf652f48e80e760154f6e3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxNzo1MzoyOVrOGEBZWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxNzo1MzoyOVrOGEBZWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg3MDM2MA==", "bodyText": "this is handled in super.close()", "url": "https://github.com/prestodb/presto/pull/14370#discussion_r406870360", "createdAt": "2020-04-10T17:53:29Z", "author": {"login": "bhhari"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/OrcSelectiveRecordReader.java", "diffHunk": "@@ -849,14 +849,6 @@ private void initializeOutputPositions(int positionCount)\n     public void close()\n             throws IOException\n     {\n-        try (Closer closer = Closer.create()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cdedb44af76446692cf652f48e80e760154f6e3"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5cdedb44af76446692cf652f48e80e760154f6e3", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/5cdedb44af76446692cf652f48e80e760154f6e3", "committedDate": "2020-04-10T17:49:36Z", "message": "Clean up OrcReader memebers after close"}, "afterCommit": {"oid": "affb72dcb462d6d111480ec5797a7d068a8473dc", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/affb72dcb462d6d111480ec5797a7d068a8473dc", "committedDate": "2020-04-10T18:09:28Z", "message": "Clean up OrcReader memebers after close"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "affb72dcb462d6d111480ec5797a7d068a8473dc", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/affb72dcb462d6d111480ec5797a7d068a8473dc", "committedDate": "2020-04-10T18:09:28Z", "message": "Clean up OrcReader memebers after close"}, "afterCommit": {"oid": "6998b6c9581ff8402fb2f6de9af3a61ecc8e116d", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/6998b6c9581ff8402fb2f6de9af3a61ecc8e116d", "committedDate": "2020-04-10T22:02:27Z", "message": "Clean up OrcReader memebers after close"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6998b6c9581ff8402fb2f6de9af3a61ecc8e116d", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/6998b6c9581ff8402fb2f6de9af3a61ecc8e116d", "committedDate": "2020-04-10T22:02:27Z", "message": "Clean up OrcReader memebers after close"}, "afterCommit": {"oid": "6c369c963de09b32888fe85df4791c054388b452", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/6c369c963de09b32888fe85df4791c054388b452", "committedDate": "2020-04-10T22:31:46Z", "message": "Clean up OrcReader memebers after close"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6c369c963de09b32888fe85df4791c054388b452", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/6c369c963de09b32888fe85df4791c054388b452", "committedDate": "2020-04-10T22:31:46Z", "message": "Clean up OrcReader memebers after close"}, "afterCommit": {"oid": "9b63e79603548a8817ed4a173df5b6adb3f2fdfc", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/9b63e79603548a8817ed4a173df5b6adb3f2fdfc", "committedDate": "2020-04-10T22:43:10Z", "message": "Clean up OrcReader memebers after close"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9b63e79603548a8817ed4a173df5b6adb3f2fdfc", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/9b63e79603548a8817ed4a173df5b6adb3f2fdfc", "committedDate": "2020-04-10T22:43:10Z", "message": "Clean up OrcReader memebers after close"}, "afterCommit": {"oid": "343b63fa2c90d04e648a068ec6f85526f2f632af", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/343b63fa2c90d04e648a068ec6f85526f2f632af", "committedDate": "2020-04-11T01:57:56Z", "message": "Clean up OrcReader memebers after close"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "343b63fa2c90d04e648a068ec6f85526f2f632af", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/343b63fa2c90d04e648a068ec6f85526f2f632af", "committedDate": "2020-04-11T01:57:56Z", "message": "Clean up OrcReader memebers after close"}, "afterCommit": {"oid": "9045e288034c8b2e66c97a4abdce50ff68d9ba7e", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/9045e288034c8b2e66c97a4abdce50ff68d9ba7e", "committedDate": "2020-04-12T01:05:57Z", "message": "Clean up OrcReader memebers after close"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyMTY3OTYy", "url": "https://github.com/prestodb/presto/pull/14370#pullrequestreview-392167962", "createdAt": "2020-04-13T14:11:11Z", "commit": {"oid": "f064faa000a6c4cbfd8c04c149542dbc32ea8eb4"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxNDoxMToxMVrOGEnsRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxNDoxNDozMlrOGEnyWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ5Nzc5OA==", "bodyText": "This change doesn't seem right and is not part of nulling member variables in close.", "url": "https://github.com/prestodb/presto/pull/14370#discussion_r407497798", "createdAt": "2020-04-13T14:11:11Z", "author": {"login": "mbasmanova"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/reader/LongDictionarySelectiveStreamReader.java", "diffHunk": "@@ -278,13 +278,14 @@ private void openRowGroup()\n         if (!dictionaryOpen && dictionarySize > 0) {\n             if (dictionary.length < dictionarySize) {\n                 dictionary = new long[dictionarySize];\n+                systemMemoryContext.setBytes(sizeOf(dictionary));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f064faa000a6c4cbfd8c04c149542dbc32ea8eb4"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ5ODAyOA==", "bodyText": "What's the reason for this change? Perhaps, move it into a separate commit and explain it in commit messase.", "url": "https://github.com/prestodb/presto/pull/14370#discussion_r407498028", "createdAt": "2020-04-13T14:11:45Z", "author": {"login": "mbasmanova"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/reader/LongDictionarySelectiveStreamReader.java", "diffHunk": "@@ -278,13 +278,14 @@ private void openRowGroup()\n         if (!dictionaryOpen && dictionarySize > 0) {\n             if (dictionary.length < dictionarySize) {\n                 dictionary = new long[dictionarySize];\n+                systemMemoryContext.setBytes(sizeOf(dictionary));\n             }\n \n             LongInputStream dictionaryStream = dictionaryDataStreamSource.openStream();\n             if (dictionaryStream == null) {\n                 throw new OrcCorruptionException(streamDescriptor.getOrcDataSourceId(), \"Dictionary is not empty but data stream is not present\");\n             }\n-            dictionaryStream.nextLongVector(dictionarySize, dictionary);\n+            dictionaryStream.next(dictionary, dictionarySize);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f064faa000a6c4cbfd8c04c149542dbc32ea8eb4"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ5OTM1NA==", "bodyText": "This change is problematic. The lease doesn't own the block and the same block can be used to create multiple leases.", "url": "https://github.com/prestodb/presto/pull/14370#discussion_r407499354", "createdAt": "2020-04-13T14:14:32Z", "author": {"login": "mbasmanova"}, "path": "presto-spi/src/main/java/com/facebook/presto/spi/block/ClosingBlockLease.java", "diffHunk": "@@ -65,6 +65,7 @@ public void close()\n             return;\n         }\n         closed = true;\n+        block = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9045e288034c8b2e66c97a4abdce50ff68d9ba7e"}, "originalPosition": 13}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9045e288034c8b2e66c97a4abdce50ff68d9ba7e", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/9045e288034c8b2e66c97a4abdce50ff68d9ba7e", "committedDate": "2020-04-12T01:05:57Z", "message": "Clean up OrcReader memebers after close"}, "afterCommit": {"oid": "61b27141edc3786794df0e21f360e10116abe713", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/61b27141edc3786794df0e21f360e10116abe713", "committedDate": "2020-04-13T16:13:49Z", "message": "Speed up GC of OrcReader by clearing member variables in close()"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyMjk2ODg1", "url": "https://github.com/prestodb/presto/pull/14370#pullrequestreview-392296885", "createdAt": "2020-04-13T17:27:27Z", "commit": {"oid": "61b27141edc3786794df0e21f360e10116abe713"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyMjk3NzI1", "url": "https://github.com/prestodb/presto/pull/14370#pullrequestreview-392297725", "createdAt": "2020-04-13T17:28:42Z", "commit": {"oid": "ad8d61cf3a46ec612592aedb94daa3dc4b9891c5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxNzoyODo0M1rOGEuKnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxNzoyODo0M1rOGEuKnQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYwMzg2OQ==", "bodyText": "@bhhari do you need to add keyReader = null;? same for valueReader", "url": "https://github.com/prestodb/presto/pull/14370#discussion_r407603869", "createdAt": "2020-04-13T17:28:43Z", "author": {"login": "mbasmanova"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/reader/MapDirectSelectiveStreamReader.java", "diffHunk": "@@ -658,6 +658,26 @@ public String toString()\n     @Override\n     public void close()\n     {\n+        if (keyReader != null) {\n+            keyReader.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad8d61cf3a46ec612592aedb94daa3dc4b9891c5"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c436df31779429c102f925a53885b91d1ba4db9e", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/c436df31779429c102f925a53885b91d1ba4db9e", "committedDate": "2020-04-13T17:59:16Z", "message": "Speed up GC of SliceSelectiveReader by clearing member variables in close()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3494e72e4b67f0cdc554784148762ccb4400653c", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/3494e72e4b67f0cdc554784148762ccb4400653c", "committedDate": "2020-04-13T17:59:17Z", "message": "Speed up GC of LongSelectiveReaders by clearing member variables in close()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f55f09a53a368b36fcb90a59346ae3cb5dbccbb1", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/f55f09a53a368b36fcb90a59346ae3cb5dbccbb1", "committedDate": "2020-04-13T17:59:17Z", "message": "Speed up GC of MapSelectiveReader by clearing member variables in close()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "468ece8e238238d1f028767152f293e5fdc135b4", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/468ece8e238238d1f028767152f293e5fdc135b4", "committedDate": "2020-04-13T17:59:17Z", "message": "Speed up GC of OrcReader by clearing member variables in close()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cdd0212f748ce044f38e0a751e5642cf3286de43", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/cdd0212f748ce044f38e0a751e5642cf3286de43", "committedDate": "2020-04-13T18:22:34Z", "message": "Speed up GC of ByteSelectiveReader by clearing member variables in close()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b64f17102b16f27c1556b685831074267554daf", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/1b64f17102b16f27c1556b685831074267554daf", "committedDate": "2020-04-13T19:40:22Z", "message": "Speed up GC of BooleanSelectiveReader by clearing member variables in close()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fce5871a5267ec8bc71e595cf3e49f6314f624ac", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/fce5871a5267ec8bc71e595cf3e49f6314f624ac", "committedDate": "2020-04-13T19:42:04Z", "message": "Speed up GC of FloatSelectiveReader by clearing member variables in close()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1bf9afc72883dfdfaaf00e092dc83f677bfe695", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/f1bf9afc72883dfdfaaf00e092dc83f677bfe695", "committedDate": "2020-04-13T19:43:59Z", "message": "Speed up GC of DoubleSelectiveReader by clearing member variables in close()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "653c08a1d3fd2c561305b91cb75dd5d0aa944813", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/653c08a1d3fd2c561305b91cb75dd5d0aa944813", "committedDate": "2020-04-13T23:28:15Z", "message": "Speed up GC of TimestampSelectiveReader by clearing member variables in close()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3afb1de5f0f1a62ac6c75dc01937eaf7e6585df", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/d3afb1de5f0f1a62ac6c75dc01937eaf7e6585df", "committedDate": "2020-04-13T23:32:49Z", "message": "Speed up GC of ListStreamReader by clearing member variables in close()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5a9d33dedb562f9030d4e473608dba98c1a8e3b", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/f5a9d33dedb562f9030d4e473608dba98c1a8e3b", "committedDate": "2020-04-13T23:49:34Z", "message": "Speed up GC of StructStreamReader by clearing member variables in close()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd7760f13f94a9f0170014e1386b2e020fd07297", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/fd7760f13f94a9f0170014e1386b2e020fd07297", "committedDate": "2020-04-13T23:52:32Z", "message": "Speed up GC of DecimalStreamReader by clearing member variables in close()"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "61b27141edc3786794df0e21f360e10116abe713", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/61b27141edc3786794df0e21f360e10116abe713", "committedDate": "2020-04-13T16:13:49Z", "message": "Speed up GC of OrcReader by clearing member variables in close()"}, "afterCommit": {"oid": "fd7760f13f94a9f0170014e1386b2e020fd07297", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/fd7760f13f94a9f0170014e1386b2e020fd07297", "committedDate": "2020-04-13T23:52:32Z", "message": "Speed up GC of DecimalStreamReader by clearing member variables in close()"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyNTk1OTYy", "url": "https://github.com/prestodb/presto/pull/14370#pullrequestreview-392595962", "createdAt": "2020-04-14T04:30:31Z", "commit": {"oid": "fd7760f13f94a9f0170014e1386b2e020fd07297"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1825, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}