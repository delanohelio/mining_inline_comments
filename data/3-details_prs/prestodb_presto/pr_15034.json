{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY4MjIyNzQ5", "number": 15034, "title": "Make request tracker infrastructure generic", "bodyText": "Test plan - Local runs and unit tests\nThere's not much that's specific to tasks in this code, and it could be useful to reuse this code for other sorts of request tracking in general.\nRelated to #15071\n== NO RELEASE NOTE ==", "createdAt": "2020-08-14T23:34:41Z", "url": "https://github.com/prestodb/presto/pull/15034", "merged": true, "mergeCommit": {"oid": "eed4ae1a6ff52257ac7adf8f25ceadb10913d64a"}, "closed": true, "closedAt": "2020-09-02T19:12:34Z", "author": {"login": "tdcmeehan"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdBkhOdAFqTQ3Mjk3NDA2Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdFAEcxgFqTQ4MTEzNjIzOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyOTc0MDY3", "url": "https://github.com/prestodb/presto/pull/15034#pullrequestreview-472974067", "createdAt": "2020-08-23T02:24:01Z", "commit": {"oid": "03e4ba25484976522f11060b6a85b8264330d85a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yM1QwMjoyNDowMlrOHFJeyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yM1QwMjoyNDowMlrOHFJeyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTE2MDI2Ng==", "bodyText": "should these counters be marked as volatile as well? Wondering if these are thread safe.", "url": "https://github.com/prestodb/presto/pull/15034#discussion_r475160266", "createdAt": "2020-08-23T02:24:02Z", "author": {"login": "ajaygeorge"}, "path": "presto-main/src/main/java/com/facebook/presto/server/SimpleHttpResponseHandlerStats.java", "diffHunk": "@@ -0,0 +1,84 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.server;\n+\n+import org.weakref.jmx.Managed;\n+\n+import javax.annotation.concurrent.GuardedBy;\n+import javax.annotation.concurrent.ThreadSafe;\n+\n+public class SimpleHttpResponseHandlerStats\n+{\n+    private final IncrementalAverage responseSizeBytes = new IncrementalAverage();\n+    private long requestSuccess;\n+    private long requestFailure;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03e4ba25484976522f11060b6a85b8264330d85a"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyOTc0MTY5", "url": "https://github.com/prestodb/presto/pull/15034#pullrequestreview-472974169", "createdAt": "2020-08-23T02:27:26Z", "commit": {"oid": "03e4ba25484976522f11060b6a85b8264330d85a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yM1QwMjoyNzoyNlrOHFJfyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yM1QwMjoyNzoyNlrOHFJfyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTE2MDUyMA==", "bodyText": "Since this a generic class now, wondering if this should be still private.\nIf I want to track errors in some other area other than tasks, I won't be able to get access to this class unless I write another utility method.", "url": "https://github.com/prestodb/presto/pull/15034#discussion_r475160520", "createdAt": "2020-08-23T02:27:26Z", "author": {"login": "ajaygeorge"}, "path": "presto-main/src/main/java/com/facebook/presto/server/RequestErrorTracker.java", "diffHunk": "@@ -47,27 +48,36 @@\n import static java.util.concurrent.TimeUnit.SECONDS;\n \n @ThreadSafe\n-class RequestErrorTracker\n+public class RequestErrorTracker\n {\n     private static final Logger log = Logger.get(RequestErrorTracker.class);\n \n-    private final TaskId taskId;\n-    private final URI taskUri;\n+    private final Object id;\n+    private final URI uri;\n+    private ErrorCodeSupplier errorCode;\n+    private String nodeErrorMessage;\n     private final ScheduledExecutorService scheduledExecutor;\n     private final String jobDescription;\n     private final Backoff backoff;\n \n     private final Queue<Throwable> errorsSinceLastSuccess = new ConcurrentLinkedQueue<>();\n \n-    public RequestErrorTracker(TaskId taskId, URI taskUri, Duration maxErrorDuration, ScheduledExecutorService scheduledExecutor, String jobDescription)\n+    private RequestErrorTracker(Object id, URI uri, ErrorCodeSupplier errorCode, String nodeErrorMessage, Duration maxErrorDuration, ScheduledExecutorService scheduledExecutor, String jobDescription)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03e4ba25484976522f11060b6a85b8264330d85a"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyOTc0Mjc1", "url": "https://github.com/prestodb/presto/pull/15034#pullrequestreview-472974275", "createdAt": "2020-08-23T02:31:06Z", "commit": {"oid": "03e4ba25484976522f11060b6a85b8264330d85a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yM1QwMjozMTowNlrOHFJgxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yM1QwMjozMTowNlrOHFJgxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTE2MDc3Mg==", "bodyText": "maybe rename this as a simpler HttpResponseStats ?", "url": "https://github.com/prestodb/presto/pull/15034#discussion_r475160772", "createdAt": "2020-08-23T02:31:06Z", "author": {"login": "ajaygeorge"}, "path": "presto-main/src/main/java/com/facebook/presto/server/SimpleHttpResponseHandlerStats.java", "diffHunk": "@@ -0,0 +1,84 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.server;\n+\n+import org.weakref.jmx.Managed;\n+\n+import javax.annotation.concurrent.GuardedBy;\n+import javax.annotation.concurrent.ThreadSafe;\n+\n+public class SimpleHttpResponseHandlerStats", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03e4ba25484976522f11060b6a85b8264330d85a"}, "originalPosition": 21}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "03e4ba25484976522f11060b6a85b8264330d85a", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/03e4ba25484976522f11060b6a85b8264330d85a", "committedDate": "2020-08-14T20:17:49Z", "message": "Make SimpleHttpResponseHandler generic"}, "afterCommit": {"oid": "dfeef74640041c48c6c35f530a1d0e644f66b0a5", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/dfeef74640041c48c6c35f530a1d0e644f66b0a5", "committedDate": "2020-08-24T18:35:46Z", "message": "Make SimpleHttpResponseHandler generic"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4OTMyMTE5", "url": "https://github.com/prestodb/presto/pull/15034#pullrequestreview-478932119", "createdAt": "2020-08-31T20:30:06Z", "commit": {"oid": "dfeef74640041c48c6c35f530a1d0e644f66b0a5"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMDozMDowNlrOHKIKng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMDozMDowNlrOHKIKng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDM4MTU5OA==", "bodyText": "Should we use @Flatten instead of @Nested ? That would ensure that the metrics exported remain in the same format.", "url": "https://github.com/prestodb/presto/pull/15034#discussion_r480381598", "createdAt": "2020-08-31T20:30:06Z", "author": {"login": "mayankgarg1990"}, "path": "presto-main/src/main/java/com/facebook/presto/server/remotetask/RemoteTaskStats.java", "diffHunk": "@@ -72,9 +55,10 @@ public void updateWithoutPlanSize(long bytes)\n     }\n \n     @Managed\n-    public double getResponseSizeBytes()\n+    @Nested", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dfeef74640041c48c6c35f530a1d0e644f66b0a5"}, "originalPosition": 54}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff19508aa0622f6424156319d3f25049391558a4", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/ff19508aa0622f6424156319d3f25049391558a4", "committedDate": "2020-08-31T23:46:11Z", "message": "Make RequestErrorTracker generic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d30657779b3c8436c8d2e6c97ed99d30db05c21", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/6d30657779b3c8436c8d2e6c97ed99d30db05c21", "committedDate": "2020-08-31T23:48:06Z", "message": "Make SimpleHttpResponseHandler generic"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dfeef74640041c48c6c35f530a1d0e644f66b0a5", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/dfeef74640041c48c6c35f530a1d0e644f66b0a5", "committedDate": "2020-08-24T18:35:46Z", "message": "Make SimpleHttpResponseHandler generic"}, "afterCommit": {"oid": "6d30657779b3c8436c8d2e6c97ed99d30db05c21", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/6d30657779b3c8436c8d2e6c97ed99d30db05c21", "committedDate": "2020-08-31T23:48:06Z", "message": "Make SimpleHttpResponseHandler generic"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxMTI3NzU0", "url": "https://github.com/prestodb/presto/pull/15034#pullrequestreview-481127754", "createdAt": "2020-09-02T18:07:49Z", "commit": {"oid": "ff19508aa0622f6424156319d3f25049391558a4"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxODowNzo0OVrOHL7N_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxODowODoxNVrOHL7O1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjI2NjYyMw==", "bodyText": "curious if the motivation of moving taskId to a more general id can be explained a bit in PR?", "url": "https://github.com/prestodb/presto/pull/15034#discussion_r482266623", "createdAt": "2020-09-02T18:07:49Z", "author": {"login": "wenleix"}, "path": "presto-main/src/main/java/com/facebook/presto/server/RequestErrorTracker.java", "diffHunk": "@@ -47,27 +48,36 @@\n import static java.util.concurrent.TimeUnit.SECONDS;\n \n @ThreadSafe\n-class RequestErrorTracker\n+public class RequestErrorTracker\n {\n     private static final Logger log = Logger.get(RequestErrorTracker.class);\n \n-    private final TaskId taskId;\n-    private final URI taskUri;\n+    private final Object id;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff19508aa0622f6424156319d3f25049391558a4"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjI2NjgzNg==", "bodyText": "curious: why need to use ErrorCodeSupplier instead of ErrorCode?", "url": "https://github.com/prestodb/presto/pull/15034#discussion_r482266836", "createdAt": "2020-09-02T18:08:15Z", "author": {"login": "wenleix"}, "path": "presto-main/src/main/java/com/facebook/presto/server/RequestErrorTracker.java", "diffHunk": "@@ -47,27 +48,36 @@\n import static java.util.concurrent.TimeUnit.SECONDS;\n \n @ThreadSafe\n-class RequestErrorTracker\n+public class RequestErrorTracker\n {\n     private static final Logger log = Logger.get(RequestErrorTracker.class);\n \n-    private final TaskId taskId;\n-    private final URI taskUri;\n+    private final Object id;\n+    private final URI uri;\n+    private ErrorCodeSupplier errorCode;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff19508aa0622f6424156319d3f25049391558a4"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxMTM2MjM5", "url": "https://github.com/prestodb/presto/pull/15034#pullrequestreview-481136239", "createdAt": "2020-09-02T18:11:43Z", "commit": {"oid": "6d30657779b3c8436c8d2e6c97ed99d30db05c21"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 256, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}