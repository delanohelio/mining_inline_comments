{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEwMDc5MzQ5", "number": 15356, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNDo0NTo0MFrOEx72ww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwMTozMTowOFrOEyJepA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwNzk2MzU1OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/com/facebook/presto/operator/aggregation/GenericAccumulatorFactory.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNDo0NTo0MFrOHoS_Xw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNDo0NzozNlrOHoTFcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAxNjIyMw==", "bodyText": "@highker probably isn't necessary to count blockBuilders in as much detail as I have done so in this PR (since it created during evaluateIntermediate at which point we are already spilling). I have included some logic to do this but we can strip it out if you see fit. I figured we should report this memory correctly just to avoid the scenario in which another operator overallocates.", "url": "https://github.com/prestodb/presto/pull/15356#discussion_r512016223", "createdAt": "2020-10-26T14:45:40Z", "author": {"login": "sachdevs"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/aggregation/GenericAccumulatorFactory.java", "diffHunk": "@@ -589,6 +589,8 @@ public void prepareFinal()\n \n         private ObjectBigArray<GroupIdPage> rawInputs = new ObjectBigArray<>();\n         private ObjectBigArray<RowBlockBuilder> blockBuilders;\n+        private long rawInputsSizeInBytes;\n+        private long blockBuildersSizeInBytes;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be5e8f1af78ca1beb6ccbb0871b4168fc27b2ba6"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAxNzc3Ng==", "bodyText": "Also I'm all for removing this since  rowBlockBuilder.getRetainedSizeInBytes() is a pretty slow call (it needs to loop over all the fields and call getRetainedSize() on all of them) and it is called in a loop during blockBuilders creation.", "url": "https://github.com/prestodb/presto/pull/15356#discussion_r512017776", "createdAt": "2020-10-26T14:47:36Z", "author": {"login": "sachdevs"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/aggregation/GenericAccumulatorFactory.java", "diffHunk": "@@ -589,6 +589,8 @@ public void prepareFinal()\n \n         private ObjectBigArray<GroupIdPage> rawInputs = new ObjectBigArray<>();\n         private ObjectBigArray<RowBlockBuilder> blockBuilders;\n+        private long rawInputsSizeInBytes;\n+        private long blockBuildersSizeInBytes;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAxNjIyMw=="}, "originalCommit": {"oid": "be5e8f1af78ca1beb6ccbb0871b4168fc27b2ba6"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwOTE0ODAxOnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/com/facebook/presto/operator/aggregation/GenericAccumulatorFactory.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxOTowOTo1MFrOHoed-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxOTowOTo1MFrOHoed-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjIwNDI4Mw==", "bodyText": "also add the INSTANCE_SIZE for GroupIdPage itself: ClassLayout.parseClass(GroupIdPage.class).instanceSize();", "url": "https://github.com/prestodb/presto/pull/15356#discussion_r512204283", "createdAt": "2020-10-26T19:09:50Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/aggregation/GenericAccumulatorFactory.java", "diffHunk": "@@ -748,6 +762,11 @@ public GroupByIdBlock getGroupByIdBlock()\n             {\n                 return groupByIdBlock;\n             }\n+\n+            public long getRetainedSizeInBytes()\n+            {\n+                return groupByIdBlock.getRetainedSizeInBytes() + page.getRetainedSizeInBytes();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be5e8f1af78ca1beb6ccbb0871b4168fc27b2ba6"}, "originalPosition": 86}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxMDE5NTU2OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/com/facebook/presto/operator/aggregation/GenericAccumulatorFactory.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwMTozMTowOFrOHooK0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxOTowMTo1NlrOHpMKMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM2MzIxOA==", "bodyText": "This should be GroupIdPage.class", "url": "https://github.com/prestodb/presto/pull/15356#discussion_r512363218", "createdAt": "2020-10-27T01:31:08Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/aggregation/GenericAccumulatorFactory.java", "diffHunk": "@@ -724,12 +737,15 @@ public void prepareFinal()\n             }\n \n             rawInputs = null;\n+            rawInputsSizeInBytes = 0;\n             rawInputsLength = 0;\n             delegate.prepareFinal();\n         }\n \n         private static class GroupIdPage\n         {\n+            private static final int INSTANCE_SIZE = ClassLayout.parseClass(SpillableFinalOnlyGroupedAccumulator.class).instanceSize();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a8bbaf51876139969d1845cd001505e577a72d30"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk1Mjg4Mw==", "bodyText": "Nice catch", "url": "https://github.com/prestodb/presto/pull/15356#discussion_r512952883", "createdAt": "2020-10-27T19:01:56Z", "author": {"login": "sachdevs"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/aggregation/GenericAccumulatorFactory.java", "diffHunk": "@@ -724,12 +737,15 @@ public void prepareFinal()\n             }\n \n             rawInputs = null;\n+            rawInputsSizeInBytes = 0;\n             rawInputsLength = 0;\n             delegate.prepareFinal();\n         }\n \n         private static class GroupIdPage\n         {\n+            private static final int INSTANCE_SIZE = ClassLayout.parseClass(SpillableFinalOnlyGroupedAccumulator.class).instanceSize();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM2MzIxOA=="}, "originalCommit": {"oid": "a8bbaf51876139969d1845cd001505e577a72d30"}, "originalPosition": 82}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3334, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}