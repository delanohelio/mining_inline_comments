{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY5ODI5MDcw", "number": 14039, "title": "Account for page header in ORC output buffer", "bodyText": "== RELEASE NOTES ==\n\nHive Changes\n* Add page header size accounting to ORC output buffer to avoid possible overflow.", "createdAt": "2020-02-01T00:50:04Z", "url": "https://github.com/prestodb/presto/pull/14039", "merged": true, "mergeCommit": {"oid": "10893a67c817ea0f9d169719c7f7e39d16f8a1c8"}, "closed": true, "closedAt": "2020-02-04T22:57:11Z", "author": {"login": "islamismailov"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb_74yXgFqTM1MTg2NDQzMA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcBIBorAFqTM1MzI5NzgxMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxODY0NDMw", "url": "https://github.com/prestodb/presto/pull/14039#pullrequestreview-351864430", "createdAt": "2020-02-01T04:18:35Z", "commit": {"oid": "1be881982e762b4287f39c79baf8cd374b95e694"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1be881982e762b4287f39c79baf8cd374b95e694", "author": {"user": {"login": "islamismailov", "name": "Islam Ismailov"}}, "url": "https://github.com/prestodb/presto/commit/1be881982e762b4287f39c79baf8cd374b95e694", "committedDate": "2020-02-01T00:48:10Z", "message": "Account for page header in ORC output buffer"}, "afterCommit": {"oid": "4996ade82fb1112d9bc9140ba09330d1daf6a164", "author": {"user": {"login": "islamismailov", "name": "Islam Ismailov"}}, "url": "https://github.com/prestodb/presto/commit/4996ade82fb1112d9bc9140ba09330d1daf6a164", "committedDate": "2020-02-03T19:54:56Z", "message": "Account for page header in ORC output buffer"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyNjAyNjYx", "url": "https://github.com/prestodb/presto/pull/14039#pullrequestreview-352602661", "createdAt": "2020-02-03T22:16:22Z", "commit": {"oid": "4996ade82fb1112d9bc9140ba09330d1daf6a164"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QyMjoxNjoyMlrOFlB5Lg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QyMjozNDoyOFrOFlCXZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM3MjY1NA==", "bodyText": "The assert should be always on the length <= maxBufferSize. Checking on compressed size is incorrect as compressed size will always be less than length. maxBufferSize already accounts for PAGE_HEADER_SIZE and using that in addition to length will result in incorrect assertions.", "url": "https://github.com/prestodb/presto/pull/14039#discussion_r374372654", "createdAt": "2020-02-03T22:16:22Z", "author": {"login": "arunthirupathi"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/OrcOutputBuffer.java", "diffHunk": "@@ -444,13 +450,15 @@ private void writeChunkToOutputStream(byte[] chunk, int offset, int length)\n \n         int compressedSize = compressor.compress(chunk, offset, length, compressionBuffer, 0, compressionBuffer.length);\n         if (compressedSize < length) {\n+            assert PAGE_HEADER_SIZE + compressedSize <= maxBufferSize;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4996ade82fb1112d9bc9140ba09330d1daf6a164"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM3OTA4OA==", "bodyText": "In my opinion this assert should be minWritableBytes <= maxBufferSize . sliceLength <= maxBufferSize will be verified in writeChunkToOutputStream.", "url": "https://github.com/prestodb/presto/pull/14039#discussion_r374379088", "createdAt": "2020-02-03T22:31:26Z", "author": {"login": "arunthirupathi"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/OrcOutputBuffer.java", "diffHunk": "@@ -386,12 +388,14 @@ public String toString()\n \n     private void ensureWritableBytes(int minWritableBytes)\n     {\n+        assert slice.length() <= maxBufferSize;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4996ade82fb1112d9bc9140ba09330d1daf6a164"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM4MDM4OA==", "bodyText": "as defensive coding, this should be still >= and let the assert inside writeChunkToOutputStream fire.", "url": "https://github.com/prestodb/presto/pull/14039#discussion_r374380388", "createdAt": "2020-02-03T22:34:28Z", "author": {"login": "arunthirupathi"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/OrcOutputBuffer.java", "diffHunk": "@@ -386,12 +388,14 @@ public String toString()\n \n     private void ensureWritableBytes(int minWritableBytes)\n     {\n+        assert slice.length() <= maxBufferSize;\n+\n         int neededBufferSize = bufferPosition + minWritableBytes;\n         if (neededBufferSize <= slice.length()) {\n             return;\n         }\n \n-        if (slice.length() >= maxBufferSize) {\n+        if (slice.length() == maxBufferSize) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4996ade82fb1112d9bc9140ba09330d1daf6a164"}, "originalPosition": 40}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4996ade82fb1112d9bc9140ba09330d1daf6a164", "author": {"user": {"login": "islamismailov", "name": "Islam Ismailov"}}, "url": "https://github.com/prestodb/presto/commit/4996ade82fb1112d9bc9140ba09330d1daf6a164", "committedDate": "2020-02-03T19:54:56Z", "message": "Account for page header in ORC output buffer"}, "afterCommit": {"oid": "0ee80c8185b161334f9ddce94426b8ae74e37ed4", "author": {"user": {"login": "islamismailov", "name": "Islam Ismailov"}}, "url": "https://github.com/prestodb/presto/commit/0ee80c8185b161334f9ddce94426b8ae74e37ed4", "committedDate": "2020-02-04T00:15:37Z", "message": "Account for page header in ORC output buffer"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyNjUzMjY4", "url": "https://github.com/prestodb/presto/pull/14039#pullrequestreview-352653268", "createdAt": "2020-02-04T00:19:28Z", "commit": {"oid": "0ee80c8185b161334f9ddce94426b8ae74e37ed4"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0ee80c8185b161334f9ddce94426b8ae74e37ed4", "author": {"user": {"login": "islamismailov", "name": "Islam Ismailov"}}, "url": "https://github.com/prestodb/presto/commit/0ee80c8185b161334f9ddce94426b8ae74e37ed4", "committedDate": "2020-02-04T00:15:37Z", "message": "Account for page header in ORC output buffer"}, "afterCommit": {"oid": "e97acad84158d26aea68dedb1ec84a3d3a7e0d2c", "author": {"user": {"login": "islamismailov", "name": "Islam Ismailov"}}, "url": "https://github.com/prestodb/presto/commit/e97acad84158d26aea68dedb1ec84a3d3a7e0d2c", "committedDate": "2020-02-04T00:23:13Z", "message": "Account for page header in ORC output buffer"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyNjU1MjQy", "url": "https://github.com/prestodb/presto/pull/14039#pullrequestreview-352655242", "createdAt": "2020-02-04T00:25:14Z", "commit": {"oid": "e97acad84158d26aea68dedb1ec84a3d3a7e0d2c"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwMDoyNToxNFrOFlEkrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwMDoyNzoxN1rOFlEmzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQxNjU1OQ==", "bodyText": "We don't use assert in the codebase. Replace it with checkState(...) or verify(...) for state check or assertion. We also use  checkArgument to check arguments.", "url": "https://github.com/prestodb/presto/pull/14039#discussion_r374416559", "createdAt": "2020-02-04T00:25:14Z", "author": {"login": "highker"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/OrcOutputBuffer.java", "diffHunk": "@@ -386,12 +387,14 @@ public String toString()\n \n     private void ensureWritableBytes(int minWritableBytes)\n     {\n+        assert minWritableBytes <= maxBufferSize;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e97acad84158d26aea68dedb1ec84a3d3a7e0d2c"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQxNzEwMg==", "bodyText": "Is this number 3 coming from the 3-bit header from ORC spec? If yes, could you add a comment?", "url": "https://github.com/prestodb/presto/pull/14039#discussion_r374417102", "createdAt": "2020-02-04T00:27:17Z", "author": {"login": "highker"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/OrcOutputBuffer.java", "diffHunk": "@@ -49,6 +49,7 @@\n         extends SliceOutput\n {\n     private static final int INSTANCE_SIZE = ClassLayout.parseClass(OrcOutputBuffer.class).instanceSize();\n+    private static final int PAGE_HEADER_SIZE = 3;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e97acad84158d26aea68dedb1ec84a3d3a7e0d2c"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e97acad84158d26aea68dedb1ec84a3d3a7e0d2c", "author": {"user": {"login": "islamismailov", "name": "Islam Ismailov"}}, "url": "https://github.com/prestodb/presto/commit/e97acad84158d26aea68dedb1ec84a3d3a7e0d2c", "committedDate": "2020-02-04T00:23:13Z", "message": "Account for page header in ORC output buffer"}, "afterCommit": {"oid": "c928c7cafd9ff461fd6f0b41546228efb20c321c", "author": {"user": {"login": "islamismailov", "name": "Islam Ismailov"}}, "url": "https://github.com/prestodb/presto/commit/c928c7cafd9ff461fd6f0b41546228efb20c321c", "committedDate": "2020-02-04T01:23:50Z", "message": "Account for page header in ORC output buffer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e73771d971e98f699a7ae0a3d78260b2ed90a974", "author": {"user": {"login": "islamismailov", "name": "Islam Ismailov"}}, "url": "https://github.com/prestodb/presto/commit/e73771d971e98f699a7ae0a3d78260b2ed90a974", "committedDate": "2020-02-04T20:02:54Z", "message": "Account for page header in ORC output buffer"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c928c7cafd9ff461fd6f0b41546228efb20c321c", "author": {"user": {"login": "islamismailov", "name": "Islam Ismailov"}}, "url": "https://github.com/prestodb/presto/commit/c928c7cafd9ff461fd6f0b41546228efb20c321c", "committedDate": "2020-02-04T01:23:50Z", "message": "Account for page header in ORC output buffer"}, "afterCommit": {"oid": "e73771d971e98f699a7ae0a3d78260b2ed90a974", "author": {"user": {"login": "islamismailov", "name": "Islam Ismailov"}}, "url": "https://github.com/prestodb/presto/commit/e73771d971e98f699a7ae0a3d78260b2ed90a974", "committedDate": "2020-02-04T20:02:54Z", "message": "Account for page header in ORC output buffer"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzMjk3ODEz", "url": "https://github.com/prestodb/presto/pull/14039#pullrequestreview-353297813", "createdAt": "2020-02-04T21:01:02Z", "commit": {"oid": "e73771d971e98f699a7ae0a3d78260b2ed90a974"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2529, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}