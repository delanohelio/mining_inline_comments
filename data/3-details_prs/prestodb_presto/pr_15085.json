{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDczNjE3Mzcy", "number": 15085, "title": "Improve logging of queued queries", "bodyText": "Test plan - Local reproduction of race condition, unit tests\n== NO RELEASE NOTE ==", "createdAt": "2020-08-26T03:17:38Z", "url": "https://github.com/prestodb/presto/pull/15085", "merged": true, "mergeCommit": {"oid": "738bb9cca9804a94649bfb856f1733769a6d4628"}, "closed": true, "closedAt": "2020-08-27T00:40:56Z", "author": {"login": "tdcmeehan"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdCjkYdABqjM2OTI4MTMyNTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCy2qzgBqjM2OTY3MTcwNzY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "12c18d8ee31c4d897cdb51ad373036ed1cb5c664", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/12c18d8ee31c4d897cdb51ad373036ed1cb5c664", "committedDate": "2020-08-26T03:17:01Z", "message": "Fix race when logging query completion event"}, "afterCommit": {"oid": "8e6e170c6af8d09ea0ff0477f940df7cb2965d7d", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/8e6e170c6af8d09ea0ff0477f940df7cb2965d7d", "committedDate": "2020-08-26T03:51:21Z", "message": "Fix race when logging query completion event"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8e6e170c6af8d09ea0ff0477f940df7cb2965d7d", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/8e6e170c6af8d09ea0ff0477f940df7cb2965d7d", "committedDate": "2020-08-26T03:51:21Z", "message": "Fix race when logging query completion event"}, "afterCommit": {"oid": "86190b640d67d60a4b6595507e76ff612964bb0f", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/86190b640d67d60a4b6595507e76ff612964bb0f", "committedDate": "2020-08-26T05:43:43Z", "message": "Fix race when logging query completion event"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "86190b640d67d60a4b6595507e76ff612964bb0f", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/86190b640d67d60a4b6595507e76ff612964bb0f", "committedDate": "2020-08-26T05:43:43Z", "message": "Fix race when logging query completion event"}, "afterCommit": {"oid": "075e22b178c1dafd57bc600824ffefa8e2dd51bd", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/075e22b178c1dafd57bc600824ffefa8e2dd51bd", "committedDate": "2020-08-26T07:48:46Z", "message": "Fix race when logging query completion event"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "075e22b178c1dafd57bc600824ffefa8e2dd51bd", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/075e22b178c1dafd57bc600824ffefa8e2dd51bd", "committedDate": "2020-08-26T07:48:46Z", "message": "Fix race when logging query completion event"}, "afterCommit": {"oid": "f4bd739bc402828a28c0b797f5c021b795e56b83", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/f4bd739bc402828a28c0b797f5c021b795e56b83", "committedDate": "2020-08-26T18:18:18Z", "message": "Fix race when logging query completion event"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f4bd739bc402828a28c0b797f5c021b795e56b83", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/f4bd739bc402828a28c0b797f5c021b795e56b83", "committedDate": "2020-08-26T18:18:18Z", "message": "Fix race when logging query completion event"}, "afterCommit": {"oid": "bacc02b5b05b5e6910d401fbf0e93785af1d7770", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/bacc02b5b05b5e6910d401fbf0e93785af1d7770", "committedDate": "2020-08-26T18:21:36Z", "message": "Fix race when logging query completion event"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bacc02b5b05b5e6910d401fbf0e93785af1d7770", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/bacc02b5b05b5e6910d401fbf0e93785af1d7770", "committedDate": "2020-08-26T18:21:36Z", "message": "Fix race when logging query completion event"}, "afterCommit": {"oid": "b61c26381edc1ea342ecdff0e96ced2323d1dd65", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/b61c26381edc1ea342ecdff0e96ced2323d1dd65", "committedDate": "2020-08-26T18:58:38Z", "message": "Fix race when logging query completion event"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1Nzg1MzI0", "url": "https://github.com/prestodb/presto/pull/15085#pullrequestreview-475785324", "createdAt": "2020-08-26T19:14:24Z", "commit": {"oid": "b61c26381edc1ea342ecdff0e96ced2323d1dd65"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b61c26381edc1ea342ecdff0e96ced2323d1dd65", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/b61c26381edc1ea342ecdff0e96ced2323d1dd65", "committedDate": "2020-08-26T18:58:38Z", "message": "Fix race when logging query completion event"}, "afterCommit": {"oid": "8f15a59dc06ad8f1d229e811beb072f890c20416", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/8f15a59dc06ad8f1d229e811beb072f890c20416", "committedDate": "2020-08-26T19:34:45Z", "message": "Fix race when logging query completion event"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1ODAxMTgw", "url": "https://github.com/prestodb/presto/pull/15085#pullrequestreview-475801180", "createdAt": "2020-08-26T19:38:03Z", "commit": {"oid": "8f15a59dc06ad8f1d229e811beb072f890c20416"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxOTozODowM1rOHHa8Ew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxOTozODowM1rOHHa8Ew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU0MzQ0Mw==", "bodyText": "can this just invoke the fail function?", "url": "https://github.com/prestodb/presto/pull/15085#discussion_r477543443", "createdAt": "2020-08-26T19:38:03Z", "author": {"login": "mayankgarg1990"}, "path": "presto-main/src/main/java/com/facebook/presto/dispatcher/LocalDispatchQuery.java", "diffHunk": "@@ -71,14 +73,16 @@ public LocalDispatchQuery(\n             Consumer<QueryExecution> querySubmitter)\n     {\n         this.stateMachine = requireNonNull(stateMachine, \"stateMachine is null\");\n+        this.queryMonitor = requireNonNull(queryMonitor, \"queryMonitor is null\");\n         this.queryExecutionFuture = requireNonNull(queryExecutionFuture, \"queryExecutionFuture is null\");\n         this.clusterSizeMonitor = requireNonNull(clusterSizeMonitor, \"clusterSizeMonitor is null\");\n         this.queryExecutor = requireNonNull(queryExecutor, \"queryExecutor is null\");\n         this.querySubmitter = requireNonNull(querySubmitter, \"querySubmitter is null\");\n \n         addExceptionCallback(queryExecutionFuture, throwable -> {\n-            stateMachine.transitionToFailed(throwable);\n-            queryMonitor.queryImmediateFailureEvent(stateMachine.getBasicQueryInfo(Optional.empty()), toFailure(throwable));\n+            if (stateMachine.transitionToFailed(throwable)) {\n+                queryMonitor.queryImmediateFailureEvent(stateMachine.getBasicQueryInfo(Optional.empty()), toFailure(throwable));\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f15a59dc06ad8f1d229e811beb072f890c20416"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "518aeda038603b636570f3ed949a78de9118573b", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/518aeda038603b636570f3ed949a78de9118573b", "committedDate": "2020-08-26T21:39:50Z", "message": "Improve logging of queued queries"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8f15a59dc06ad8f1d229e811beb072f890c20416", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/8f15a59dc06ad8f1d229e811beb072f890c20416", "committedDate": "2020-08-26T19:34:45Z", "message": "Fix race when logging query completion event"}, "afterCommit": {"oid": "518aeda038603b636570f3ed949a78de9118573b", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/518aeda038603b636570f3ed949a78de9118573b", "committedDate": "2020-08-26T21:39:50Z", "message": "Improve logging of queued queries"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 14, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}