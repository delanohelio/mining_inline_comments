{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ1NTgxNTM4", "number": 14800, "title": "Partition filtering warning", "bodyText": "Add support for warning on queries that scan a partitioned table without filtering on at least one of a configured set of partition columns.\nThis is to warn on queries that may scan a very large table when they should have done at least some filtering on the partition columns.\n== RELEASE NOTES ==\n\nGeneral Changes\n* Add support for warning on unfiltered partition keys using `warn-on-no-table-layout-filter` system property. This property specifies a ',' separated list of column names that are assumed to be good for filtering on partitioned tables. If one or more of these columns are present in the partition key when reading from a partitioned table and none are filtered then a warning is emitted. The Hive connector is currently the only connector that supports emitting this warning.", "createdAt": "2020-07-07T18:30:46Z", "url": "https://github.com/prestodb/presto/pull/14800", "merged": true, "mergeCommit": {"oid": "19228af885c56372cf5f1de6e0b1dbac0136b185"}, "closed": true, "closedAt": "2020-07-15T17:31:39Z", "author": {"login": "aweisberg"}, "timelineItems": {"totalCount": 32, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcyq0ROABqjM1MjE4OTEwMjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc1EdCGAFqTQ0ODY1NjM4Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "de4d8ad675048b061d61697b9bdd1448a111b151", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/de4d8ad675048b061d61697b9bdd1448a111b151", "committedDate": "2020-07-07T18:14:01Z", "message": "Warn on configured unfiltered partitions"}, "afterCommit": {"oid": "1a491198eb49d201578eb2f19567e56ad10fbca3", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/1a491198eb49d201578eb2f19567e56ad10fbca3", "committedDate": "2020-07-07T18:47:27Z", "message": "Support for checking partition key filter coverage"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1a491198eb49d201578eb2f19567e56ad10fbca3", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/1a491198eb49d201578eb2f19567e56ad10fbca3", "committedDate": "2020-07-07T18:47:27Z", "message": "Support for checking partition key filter coverage"}, "afterCommit": {"oid": "ae670504c1eed352edff7fcc682d64e1b6745147", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/ae670504c1eed352edff7fcc682d64e1b6745147", "committedDate": "2020-07-07T18:39:48Z", "message": "Warn on configured unfiltered partitions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ae670504c1eed352edff7fcc682d64e1b6745147", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/ae670504c1eed352edff7fcc682d64e1b6745147", "committedDate": "2020-07-07T18:39:48Z", "message": "Warn on configured unfiltered partitions"}, "afterCommit": {"oid": "e81e1323387d468a4e425ea7b8744aa40527e1ca", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/e81e1323387d468a4e425ea7b8744aa40527e1ca", "committedDate": "2020-07-07T19:20:10Z", "message": "Warn on configured unfiltered partitions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e81e1323387d468a4e425ea7b8744aa40527e1ca", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/e81e1323387d468a4e425ea7b8744aa40527e1ca", "committedDate": "2020-07-07T19:20:10Z", "message": "Warn on configured unfiltered partitions"}, "afterCommit": {"oid": "2d278dfde7dc74e5f25ca9bc24701f5479c50b3e", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/2d278dfde7dc74e5f25ca9bc24701f5479c50b3e", "committedDate": "2020-07-07T19:26:47Z", "message": "Warn on configured unfiltered partitions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2d278dfde7dc74e5f25ca9bc24701f5479c50b3e", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/2d278dfde7dc74e5f25ca9bc24701f5479c50b3e", "committedDate": "2020-07-07T19:26:47Z", "message": "Warn on configured unfiltered partitions"}, "afterCommit": {"oid": "a5d5488ada1e63b173ee5fe1f6d44b4ddcad5214", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/a5d5488ada1e63b173ee5fe1f6d44b4ddcad5214", "committedDate": "2020-07-07T19:48:44Z", "message": "Warn on configured unfiltered partitions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a5d5488ada1e63b173ee5fe1f6d44b4ddcad5214", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/a5d5488ada1e63b173ee5fe1f6d44b4ddcad5214", "committedDate": "2020-07-07T19:48:44Z", "message": "Warn on configured unfiltered partitions"}, "afterCommit": {"oid": "cccbc1bcc8c56100218d4558fc32edbb19d37d78", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/cccbc1bcc8c56100218d4558fc32edbb19d37d78", "committedDate": "2020-07-07T19:50:27Z", "message": "Warn on configured unfiltered partitions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cccbc1bcc8c56100218d4558fc32edbb19d37d78", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/cccbc1bcc8c56100218d4558fc32edbb19d37d78", "committedDate": "2020-07-07T19:50:27Z", "message": "Warn on configured unfiltered partitions"}, "afterCommit": {"oid": "f6e38d299a9bdb3afe6ff6723d990fc2bc31ba1f", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/f6e38d299a9bdb3afe6ff6723d990fc2bc31ba1f", "committedDate": "2020-07-07T20:08:26Z", "message": "Warn on configured unfiltered partitions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f6e38d299a9bdb3afe6ff6723d990fc2bc31ba1f", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/f6e38d299a9bdb3afe6ff6723d990fc2bc31ba1f", "committedDate": "2020-07-07T20:08:26Z", "message": "Warn on configured unfiltered partitions"}, "afterCommit": {"oid": "94acd743b4954d20664e3d4709f30b9bb8c5df8e", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/94acd743b4954d20664e3d4709f30b9bb8c5df8e", "committedDate": "2020-07-07T21:50:52Z", "message": "Warn on configured unfiltered partitions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "94acd743b4954d20664e3d4709f30b9bb8c5df8e", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/94acd743b4954d20664e3d4709f30b9bb8c5df8e", "committedDate": "2020-07-07T21:50:52Z", "message": "Warn on configured unfiltered partitions"}, "afterCommit": {"oid": "e8c8ca7d2a63fd77df763657832dd643e36c3200", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/e8c8ca7d2a63fd77df763657832dd643e36c3200", "committedDate": "2020-07-07T22:08:19Z", "message": "Warn on configured unfiltered partitions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e8c8ca7d2a63fd77df763657832dd643e36c3200", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/e8c8ca7d2a63fd77df763657832dd643e36c3200", "committedDate": "2020-07-07T22:08:19Z", "message": "Warn on configured unfiltered partitions"}, "afterCommit": {"oid": "acbfd58226e01c4818417ae17c0d96aa941907ea", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/acbfd58226e01c4818417ae17c0d96aa941907ea", "committedDate": "2020-07-07T22:16:25Z", "message": "Warn on configured unfiltered partitions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "acbfd58226e01c4818417ae17c0d96aa941907ea", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/acbfd58226e01c4818417ae17c0d96aa941907ea", "committedDate": "2020-07-07T22:16:25Z", "message": "Warn on configured unfiltered partitions"}, "afterCommit": {"oid": "861301c5fe4ecc6d46e4ad6171fbe5080a17f630", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/861301c5fe4ecc6d46e4ad6171fbe5080a17f630", "committedDate": "2020-07-08T15:04:02Z", "message": "Warn on configured unfiltered partitions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1OTMxMjIw", "url": "https://github.com/prestodb/presto/pull/14800#pullrequestreview-445931220", "createdAt": "2020-07-09T20:06:31Z", "commit": {"oid": "861301c5fe4ecc6d46e4ad6171fbe5080a17f630"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1OTM0ODQx", "url": "https://github.com/prestodb/presto/pull/14800#pullrequestreview-445934841", "createdAt": "2020-07-09T20:12:15Z", "commit": {"oid": "861301c5fe4ecc6d46e4ad6171fbe5080a17f630"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQyMDoxMjoxNVrOGvgKaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQyMDoyNTo1NVrOGvgk9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ2MzIwOQ==", "bodyText": "We usually keep the type from getter method consistent to the setter method.\nWhat about return String here and do the JSON parse in WarnOnScanWithoutPartitionPredicate ?", "url": "https://github.com/prestodb/presto/pull/14800#discussion_r452463209", "createdAt": "2020-07-09T20:12:15Z", "author": {"login": "wenleix"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/analyzer/FeaturesConfig.java", "diffHunk": "@@ -1290,4 +1295,22 @@ public FeaturesConfig setOptimizeNullsInJoin(boolean optimizeNullsInJoin)\n         this.optimizeNullsInJoin = optimizeNullsInJoin;\n         return this;\n     }\n+\n+    public List<List<String>> getPartitionKeysToWarnOnNoFiltering()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "861301c5fe4ecc6d46e4ad6171fbe5080a17f630"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ3MDAwNw==", "bodyText": "Having a List<List<>> for configuration looks too complicated ..\nAs discussed offline, let's focus on simple use case. The semantic can be:\nHere is a list of common partitioned columns.  If the table is partitioned on any of these columns, \nwe expect the query need to have filter on at least one of those partitioned columns.\n\nAnd in most companies in Bay Area, this will just be set to [ds] .", "url": "https://github.com/prestodb/presto/pull/14800#discussion_r452470007", "createdAt": "2020-07-09T20:25:55Z", "author": {"login": "wenleix"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/analyzer/FeaturesConfig.java", "diffHunk": "@@ -1290,4 +1295,22 @@ public FeaturesConfig setOptimizeNullsInJoin(boolean optimizeNullsInJoin)\n         this.optimizeNullsInJoin = optimizeNullsInJoin;\n         return this;\n     }\n+\n+    public List<List<String>> getPartitionKeysToWarnOnNoFiltering()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ2MzIwOQ=="}, "originalCommit": {"oid": "861301c5fe4ecc6d46e4ad6171fbe5080a17f630"}, "originalPosition": 31}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "861301c5fe4ecc6d46e4ad6171fbe5080a17f630", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/861301c5fe4ecc6d46e4ad6171fbe5080a17f630", "committedDate": "2020-07-08T15:04:02Z", "message": "Warn on configured unfiltered partitions"}, "afterCommit": {"oid": "c0d439115d8a0b7e558101b78ea91aa3423de0f8", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/c0d439115d8a0b7e558101b78ea91aa3423de0f8", "committedDate": "2020-07-09T23:34:03Z", "message": "Warn on configured unfiltered partitions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c0d439115d8a0b7e558101b78ea91aa3423de0f8", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/c0d439115d8a0b7e558101b78ea91aa3423de0f8", "committedDate": "2020-07-09T23:34:03Z", "message": "Warn on configured unfiltered partitions"}, "afterCommit": {"oid": "a6ac0bc7679d8a66aad40491e90d83ae11f2f972", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/a6ac0bc7679d8a66aad40491e90d83ae11f2f972", "committedDate": "2020-07-10T00:13:24Z", "message": "Warn on configured unfiltered partitions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a6ac0bc7679d8a66aad40491e90d83ae11f2f972", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/a6ac0bc7679d8a66aad40491e90d83ae11f2f972", "committedDate": "2020-07-10T00:13:24Z", "message": "Warn on configured unfiltered partitions"}, "afterCommit": {"oid": "758bcb2786ce5017b28fcddcf4b0fd5f3b05f158", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/758bcb2786ce5017b28fcddcf4b0fd5f3b05f158", "committedDate": "2020-07-10T00:15:36Z", "message": "Warn on configured unfiltered partitions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2Njk0NTE0", "url": "https://github.com/prestodb/presto/pull/14800#pullrequestreview-446694514", "createdAt": "2020-07-10T20:53:20Z", "commit": {"oid": "7595fcbcb85d59dd6b1f73e9b29d177f532f12a7"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQyMDo1MzoyMFrOGwFUyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQyMDo1Nzo0NlrOGwFbvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA3MjA3Mw==", "bodyText": "nit: I think we usually do toImmutableList() and toImmutableSet() whenever feasible.\nAlso I personally prefer to put new lines for stream APIs, e.g.\n            List<String> partitionKey = tableHandle.getPartitionColumns().stream()\n                    .map(HiveColumnHandle::getName)\n                    .collect(toImmutableList());", "url": "https://github.com/prestodb/presto/pull/14800#discussion_r453072073", "createdAt": "2020-07-10T20:53:20Z", "author": {"login": "wenleix"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -3030,6 +3034,19 @@ public void commit()\n         metastore.commit();\n     }\n \n+    @Override\n+    public PartitioningFilterCoverage getPartitioningFilterCoverage(ConnectorTableLayoutHandle connectorTableLayoutHandle, Set<String> relevantPartitionColumns)\n+    {\n+        HiveTableLayoutHandle tableHandle = (HiveTableLayoutHandle) connectorTableLayoutHandle;\n+        List<String> partitionKey = tableHandle.getPartitionColumns().stream().map(HiveColumnHandle::getName).collect(toList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7595fcbcb85d59dd6b1f73e9b29d177f532f12a7"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA3MjEwNQ==", "bodyText": "ditto", "url": "https://github.com/prestodb/presto/pull/14800#discussion_r453072105", "createdAt": "2020-07-10T20:53:25Z", "author": {"login": "wenleix"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -3030,6 +3034,19 @@ public void commit()\n         metastore.commit();\n     }\n \n+    @Override\n+    public PartitioningFilterCoverage getPartitioningFilterCoverage(ConnectorTableLayoutHandle connectorTableLayoutHandle, Set<String> relevantPartitionColumns)\n+    {\n+        HiveTableLayoutHandle tableHandle = (HiveTableLayoutHandle) connectorTableLayoutHandle;\n+        List<String> partitionKey = tableHandle.getPartitionColumns().stream().map(HiveColumnHandle::getName).collect(toList());\n+        Set<String> relevantColumns = partitionKey.stream().filter(relevantPartitionColumns::contains).collect(toSet());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7595fcbcb85d59dd6b1f73e9b29d177f532f12a7"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA3MzQxMA==", "bodyText": "Note Hive partition is not a \"partitioning\" at engine level. Presto engine \"partitioning\" corresponds to Hive bucket.  Hive partition filter is modeled as table layout selection in Presto today :(\nWhat about TableLayoutFilterCoverage?  cc @rschlussel", "url": "https://github.com/prestodb/presto/pull/14800#discussion_r453073410", "createdAt": "2020-07-10T20:56:44Z", "author": {"login": "wenleix"}, "path": "presto-spi/src/main/java/com/facebook/presto/spi/PartitioningFilterCoverage.java", "diffHunk": "@@ -0,0 +1,28 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.spi;\n+\n+/**\n+ * Result indicating whether a set of filters on partition columns retricts the range of values\n+ * on the columns\n+ */\n+public enum PartitioningFilterCoverage", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7595fcbcb85d59dd6b1f73e9b29d177f532f12a7"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA3Mzg1NA==", "bodyText": "nit: PARTIAL is a bit vague. The purpose of this class is to provide Three-valued logic right? (True, False, Null). What about just put them as True, False and Unknown?", "url": "https://github.com/prestodb/presto/pull/14800#discussion_r453073854", "createdAt": "2020-07-10T20:57:46Z", "author": {"login": "wenleix"}, "path": "presto-spi/src/main/java/com/facebook/presto/spi/PartitioningFilterCoverage.java", "diffHunk": "@@ -0,0 +1,28 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.spi;\n+\n+/**\n+ * Result indicating whether a set of filters on partition columns retricts the range of values\n+ * on the columns\n+ */\n+public enum PartitioningFilterCoverage\n+{\n+    // No columns are restricted\n+    NONE,\n+    // Unknown, not checked, or inapplicable\n+    UNKNOWN,\n+    // At least some columns are restricted\n+    PARTIAL", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7595fcbcb85d59dd6b1f73e9b29d177f532f12a7"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2Njk3MzYz", "url": "https://github.com/prestodb/presto/pull/14800#pullrequestreview-446697363", "createdAt": "2020-07-10T20:58:50Z", "commit": {"oid": "758bcb2786ce5017b28fcddcf4b0fd5f3b05f158"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQyMDo1ODo1MVrOGwFdqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQyMTowMTo1MlrOGwFiXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA3NDM0NA==", "bodyText": "similarly, what about table-layout-filter-columns-to-warn-on-no-filtering? cc @rschlussel", "url": "https://github.com/prestodb/presto/pull/14800#discussion_r453074344", "createdAt": "2020-07-10T20:58:51Z", "author": {"login": "wenleix"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/analyzer/FeaturesConfig.java", "diffHunk": "@@ -1290,4 +1292,16 @@ public FeaturesConfig setOptimizeNullsInJoin(boolean optimizeNullsInJoin)\n         this.optimizeNullsInJoin = optimizeNullsInJoin;\n         return this;\n     }\n+\n+    public List<String> getPartitionColumnsToWarnOnNoFiltering()\n+    {\n+        return partitionColumnsToWarnOnNoFiltering;\n+    }\n+\n+    @Config(\"partition-columns-to-warn-on-no-filtering\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "758bcb2786ce5017b28fcddcf4b0fd5f3b05f158"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA3NDU0Mg==", "bodyText": "nit: I am not a big fan of Yoda conditions.", "url": "https://github.com/prestodb/presto/pull/14800#discussion_r453074542", "createdAt": "2020-07-10T20:59:21Z", "author": {"login": "wenleix"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/sanity/WarnOnScanWithoutPartitionPredicate.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.sql.planner.sanity;\n+\n+import com.facebook.presto.Session;\n+import com.facebook.presto.execution.warnings.WarningCollector;\n+import com.facebook.presto.metadata.Metadata;\n+import com.facebook.presto.spi.PartitioningFilterCoverage;\n+import com.facebook.presto.spi.PrestoWarning;\n+import com.facebook.presto.spi.TableHandle;\n+import com.facebook.presto.spi.plan.PlanNode;\n+import com.facebook.presto.spi.plan.TableScanNode;\n+import com.facebook.presto.sql.analyzer.FeaturesConfig;\n+import com.facebook.presto.sql.parser.SqlParser;\n+import com.facebook.presto.sql.planner.TypeProvider;\n+import com.google.common.collect.ImmutableSet;\n+\n+import java.util.Set;\n+\n+import static com.facebook.presto.spi.PartitioningFilterCoverage.NONE;\n+import static com.facebook.presto.spi.StandardWarningCode.PERFORMANCE_WARNING;\n+import static com.facebook.presto.sql.planner.optimizations.PlanNodeSearcher.searchFrom;\n+\n+public final class WarnOnScanWithoutPartitionPredicate\n+        implements PlanChecker.Checker\n+{\n+    private final Set<String> partitionKeysToWarnOnNoFiltering;\n+\n+    WarnOnScanWithoutPartitionPredicate(FeaturesConfig featuresConfig)\n+    {\n+        partitionKeysToWarnOnNoFiltering = ImmutableSet.copyOf(featuresConfig.getPartitionColumnsToWarnOnNoFiltering());\n+    }\n+\n+    @Override\n+    public void validate(PlanNode plan, Session session, Metadata metadata, SqlParser sqlParser, TypeProvider types, WarningCollector warningCollector)\n+    {\n+        for (TableScanNode scan : searchFrom(plan)\n+                .where(TableScanNode.class::isInstance)\n+                .<TableScanNode>findAll()) {\n+            TableHandle tableHandle = scan.getTable();\n+            PartitioningFilterCoverage partitioningFilterCoverage = metadata.getPartitioningFilterCoverage(session, tableHandle, partitionKeysToWarnOnNoFiltering);\n+            if (NONE == partitioningFilterCoverage) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "758bcb2786ce5017b28fcddcf4b0fd5f3b05f158"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA3NTU1MQ==", "bodyText": "Actually I think we don't need this partitionKey anymore (we can directly compute relevantColumns )", "url": "https://github.com/prestodb/presto/pull/14800#discussion_r453075551", "createdAt": "2020-07-10T21:01:52Z", "author": {"login": "wenleix"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -3030,6 +3034,19 @@ public void commit()\n         metastore.commit();\n     }\n \n+    @Override\n+    public PartitioningFilterCoverage getPartitioningFilterCoverage(ConnectorTableLayoutHandle connectorTableLayoutHandle, Set<String> relevantPartitionColumns)\n+    {\n+        HiveTableLayoutHandle tableHandle = (HiveTableLayoutHandle) connectorTableLayoutHandle;\n+        List<String> partitionKey = tableHandle.getPartitionColumns().stream().map(HiveColumnHandle::getName).collect(toList());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA3MjA3Mw=="}, "originalCommit": {"oid": "7595fcbcb85d59dd6b1f73e9b29d177f532f12a7"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2NzAxMzQ0", "url": "https://github.com/prestodb/presto/pull/14800#pullrequestreview-446701344", "createdAt": "2020-07-10T21:07:14Z", "commit": {"oid": "758bcb2786ce5017b28fcddcf4b0fd5f3b05f158"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQyMTowNzoxNFrOGwFqeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQyMToxNDozM1rOGwF0sQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA3NzYyNQ==", "bodyText": "I would call this: warn-on-no-table-layout-filter", "url": "https://github.com/prestodb/presto/pull/14800#discussion_r453077625", "createdAt": "2020-07-10T21:07:14Z", "author": {"login": "rschlussel"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/analyzer/FeaturesConfig.java", "diffHunk": "@@ -1290,4 +1292,16 @@ public FeaturesConfig setOptimizeNullsInJoin(boolean optimizeNullsInJoin)\n         this.optimizeNullsInJoin = optimizeNullsInJoin;\n         return this;\n     }\n+\n+    public List<String> getPartitionColumnsToWarnOnNoFiltering()\n+    {\n+        return partitionColumnsToWarnOnNoFiltering;\n+    }\n+\n+    @Config(\"partition-columns-to-warn-on-no-filtering\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA3NDM0NA=="}, "originalCommit": {"oid": "758bcb2786ce5017b28fcddcf4b0fd5f3b05f158"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA3ODE0Mw==", "bodyText": "nit: This line's getting long. it's probably about time to split this into one line per-argument.", "url": "https://github.com/prestodb/presto/pull/14800#discussion_r453078143", "createdAt": "2020-07-10T21:08:43Z", "author": {"login": "rschlussel"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/analyzer/QueryExplainer.java", "diffHunk": "@@ -188,7 +194,7 @@ public Plan getLogicalPlan(Session session, Statement statement, List<Expression\n         // analyze statement\n         Analysis analysis = analyze(session, statement, parameters, warningCollector);\n         // plan statement\n-        LogicalPlanner logicalPlanner = new LogicalPlanner(true, session, planOptimizers, idAllocator, metadata, sqlParser, statsCalculator, costCalculator, warningCollector);\n+        LogicalPlanner logicalPlanner = new LogicalPlanner(true, session, planOptimizers, idAllocator, metadata, sqlParser, statsCalculator, costCalculator, warningCollector, planChecker);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "758bcb2786ce5017b28fcddcf4b0fd5f3b05f158"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA4MDI0MQ==", "bodyText": "Yes, I prefer TableLayoutFilterCoverage", "url": "https://github.com/prestodb/presto/pull/14800#discussion_r453080241", "createdAt": "2020-07-10T21:14:33Z", "author": {"login": "rschlussel"}, "path": "presto-spi/src/main/java/com/facebook/presto/spi/PartitioningFilterCoverage.java", "diffHunk": "@@ -0,0 +1,28 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.spi;\n+\n+/**\n+ * Result indicating whether a set of filters on partition columns retricts the range of values\n+ * on the columns\n+ */\n+public enum PartitioningFilterCoverage", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA3MzQxMA=="}, "originalCommit": {"oid": "7595fcbcb85d59dd6b1f73e9b29d177f532f12a7"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2NzMzMjU5", "url": "https://github.com/prestodb/presto/pull/14800#pullrequestreview-446733259", "createdAt": "2020-07-10T22:29:23Z", "commit": {"oid": "7595fcbcb85d59dd6b1f73e9b29d177f532f12a7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQyMjoyOToyNFrOGwHWYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQyMjoyOToyNFrOGwHWYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzEwNTI0OQ==", "bodyText": "hmm... this basically says \"the table is not partitioned; or it's not partitioned on known columns (e.g. ds)\".\nReturning UNKNOWN for this is a bit weird. Because we know there is no violation / concern for sure. But I also don't have a good suggestions.\nSee if @rschlussel has any thought about how the enum values in PartitioningFilterCoverage should be . Otherwise, I am fine to keep it as is :)", "url": "https://github.com/prestodb/presto/pull/14800#discussion_r453105249", "createdAt": "2020-07-10T22:29:24Z", "author": {"login": "wenleix"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -3030,6 +3034,19 @@ public void commit()\n         metastore.commit();\n     }\n \n+    @Override\n+    public PartitioningFilterCoverage getPartitioningFilterCoverage(ConnectorTableLayoutHandle connectorTableLayoutHandle, Set<String> relevantPartitionColumns)\n+    {\n+        HiveTableLayoutHandle tableHandle = (HiveTableLayoutHandle) connectorTableLayoutHandle;\n+        List<String> partitionKey = tableHandle.getPartitionColumns().stream().map(HiveColumnHandle::getName).collect(toList());\n+        Set<String> relevantColumns = partitionKey.stream().filter(relevantPartitionColumns::contains).collect(toSet());\n+        if (relevantColumns.isEmpty()) {\n+            return UNKNOWN;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7595fcbcb85d59dd6b1f73e9b29d177f532f12a7"}, "originalPosition": 29}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "758bcb2786ce5017b28fcddcf4b0fd5f3b05f158", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/758bcb2786ce5017b28fcddcf4b0fd5f3b05f158", "committedDate": "2020-07-10T00:15:36Z", "message": "Warn on configured unfiltered partitions"}, "afterCommit": {"oid": "28ad7cd073e1e3bb4783420bc597548f163e9f01", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/28ad7cd073e1e3bb4783420bc597548f163e9f01", "committedDate": "2020-07-13T21:56:07Z", "message": "Warn on configured unfiltered partitions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "28ad7cd073e1e3bb4783420bc597548f163e9f01", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/28ad7cd073e1e3bb4783420bc597548f163e9f01", "committedDate": "2020-07-13T21:56:07Z", "message": "Warn on configured unfiltered partitions"}, "afterCommit": {"oid": "f920de5c7015f53c68b5ef0bbe8bcc8aec9678ba", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/f920de5c7015f53c68b5ef0bbe8bcc8aec9678ba", "committedDate": "2020-07-13T21:57:07Z", "message": "Warn on configured unfiltered partitions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f920de5c7015f53c68b5ef0bbe8bcc8aec9678ba", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/f920de5c7015f53c68b5ef0bbe8bcc8aec9678ba", "committedDate": "2020-07-13T21:57:07Z", "message": "Warn on configured unfiltered partitions"}, "afterCommit": {"oid": "5161f186527182bc88437422e55a1ed9cfa21d0f", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/5161f186527182bc88437422e55a1ed9cfa21d0f", "committedDate": "2020-07-14T15:11:02Z", "message": "Warn on configured unfiltered partitions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5161f186527182bc88437422e55a1ed9cfa21d0f", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/5161f186527182bc88437422e55a1ed9cfa21d0f", "committedDate": "2020-07-14T15:11:02Z", "message": "Warn on configured unfiltered partitions"}, "afterCommit": {"oid": "7e6856661548152d33183a7aaff2f1822e062f1d", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/7e6856661548152d33183a7aaff2f1822e062f1d", "committedDate": "2020-07-14T15:18:47Z", "message": "Warn on configured unfiltered partitions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7e6856661548152d33183a7aaff2f1822e062f1d", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/7e6856661548152d33183a7aaff2f1822e062f1d", "committedDate": "2020-07-14T15:18:47Z", "message": "Warn on configured unfiltered partitions"}, "afterCommit": {"oid": "770deb6d38e8e2c4c7eb7e70fbd47d0e2b12f3ad", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/770deb6d38e8e2c4c7eb7e70fbd47d0e2b12f3ad", "committedDate": "2020-07-14T15:21:06Z", "message": "Warn on configured unfiltered partitions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "770deb6d38e8e2c4c7eb7e70fbd47d0e2b12f3ad", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/770deb6d38e8e2c4c7eb7e70fbd47d0e2b12f3ad", "committedDate": "2020-07-14T15:21:06Z", "message": "Warn on configured unfiltered partitions"}, "afterCommit": {"oid": "31034ff866c4f25d107f16032b950914b58acf5d", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/31034ff866c4f25d107f16032b950914b58acf5d", "committedDate": "2020-07-14T17:52:14Z", "message": "Warn on configured unfiltered partitions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8094b011cc950ec039ab88d3f480b544076143a1", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/8094b011cc950ec039ab88d3f480b544076143a1", "committedDate": "2020-07-14T22:12:52Z", "message": "Rename PlanSanityChecker to PlanChecker"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c884480ccb04409e633c7d90bcb3f32ed3b312d", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/8c884480ccb04409e633c7d90bcb3f32ed3b312d", "committedDate": "2020-07-14T22:12:52Z", "message": "Support for checking partition key filter coverage"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "31034ff866c4f25d107f16032b950914b58acf5d", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/31034ff866c4f25d107f16032b950914b58acf5d", "committedDate": "2020-07-14T17:52:14Z", "message": "Warn on configured unfiltered partitions"}, "afterCommit": {"oid": "7c88cf1adff4406c923e147bcdc133c75c8b2e61", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/7c88cf1adff4406c923e147bcdc133c75c8b2e61", "committedDate": "2020-07-14T22:13:31Z", "message": "Warn on configured unfiltered partitions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f16789811512455552fecfdc338970daf083d327", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/f16789811512455552fecfdc338970daf083d327", "committedDate": "2020-07-14T22:43:03Z", "message": "Warn on configured unfiltered partitions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7c88cf1adff4406c923e147bcdc133c75c8b2e61", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/7c88cf1adff4406c923e147bcdc133c75c8b2e61", "committedDate": "2020-07-14T22:13:31Z", "message": "Warn on configured unfiltered partitions"}, "afterCommit": {"oid": "f16789811512455552fecfdc338970daf083d327", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/f16789811512455552fecfdc338970daf083d327", "committedDate": "2020-07-14T22:43:03Z", "message": "Warn on configured unfiltered partitions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NjU2Mzg2", "url": "https://github.com/prestodb/presto/pull/14800#pullrequestreview-448656386", "createdAt": "2020-07-15T06:15:24Z", "commit": {"oid": "f16789811512455552fecfdc338970daf083d327"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1223, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}