{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQxNTAyMzg4", "number": 15536, "title": "Fixes for file renaming and manifest features", "bodyText": "== NO RELEASE NOTE ==\n\ndepended by facebookexternal/presto-facebook#1363", "createdAt": "2020-12-16T23:34:59Z", "url": "https://github.com/prestodb/presto/pull/15536", "merged": true, "mergeCommit": {"oid": "cebe0c29aa14ce7c84d40c70684c3cc76bc990f9"}, "closed": true, "closedAt": "2021-01-04T06:29:48Z", "author": {"login": "NikhilCollooru"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdnHZa7gBqjQxMjYzNDc5OTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdswWJOAFqTU2MDgwMTcyMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "75656cb2b7e08b6d0f56dddc54a8478a52923433", "author": {"user": {"login": "NikhilCollooru", "name": "Nikhil Collooru"}}, "url": "https://github.com/prestodb/presto/commit/75656cb2b7e08b6d0f56dddc54a8478a52923433", "committedDate": "2020-12-16T23:22:24Z", "message": "Track compressed manifest size when file_renaming is enabled"}, "afterCommit": {"oid": "b886ccfb14659d837aa9b5364de362997923d16d", "author": {"user": {"login": "NikhilCollooru", "name": "Nikhil Collooru"}}, "url": "https://github.com/prestodb/presto/commit/b886ccfb14659d837aa9b5364de362997923d16d", "committedDate": "2020-12-17T17:56:50Z", "message": "Store manifest only when they are preferred and file renaming is enabled"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b886ccfb14659d837aa9b5364de362997923d16d", "author": {"user": {"login": "NikhilCollooru", "name": "Nikhil Collooru"}}, "url": "https://github.com/prestodb/presto/commit/b886ccfb14659d837aa9b5364de362997923d16d", "committedDate": "2020-12-17T17:56:50Z", "message": "Store manifest only when they are preferred and file renaming is enabled"}, "afterCommit": {"oid": "ee36cea20acd766b3362b29ccac87825b1e65847", "author": {"user": {"login": "NikhilCollooru", "name": "Nikhil Collooru"}}, "url": "https://github.com/prestodb/presto/commit/ee36cea20acd766b3362b29ccac87825b1e65847", "committedDate": "2020-12-17T18:10:08Z", "message": "Store manifest only when they are preferred and file renaming is enabled"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ee36cea20acd766b3362b29ccac87825b1e65847", "author": {"user": {"login": "NikhilCollooru", "name": "Nikhil Collooru"}}, "url": "https://github.com/prestodb/presto/commit/ee36cea20acd766b3362b29ccac87825b1e65847", "committedDate": "2020-12-17T18:10:08Z", "message": "Store manifest only when they are preferred and file renaming is enabled"}, "afterCommit": {"oid": "a07fe5c7023711bf055ab1b83838ce41246cef31", "author": {"user": {"login": "NikhilCollooru", "name": "Nikhil Collooru"}}, "url": "https://github.com/prestodb/presto/commit/a07fe5c7023711bf055ab1b83838ce41246cef31", "committedDate": "2020-12-18T23:07:31Z", "message": "Store manifest only when they are preferred and file renaming is enabled"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2NjY4NzQ2", "url": "https://github.com/prestodb/presto/pull/15536#pullrequestreview-556668746", "createdAt": "2020-12-21T21:16:52Z", "commit": {"oid": "47918eae68bd4b4a2970b2205d31d8c1ad4c7e2e"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQyMToxNjo1MlrOIJmLQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQyMTozMDoyMVrOIJmfoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjkzMzU3MQ==", "bodyText": "Without file renaming, how did we sort bucket file names before? Do we append 0s in front of file names?", "url": "https://github.com/prestodb/presto/pull/15536#discussion_r546933571", "createdAt": "2020-12-21T21:16:52Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/StoragePartitionLoader.java", "diffHunk": "@@ -346,8 +348,23 @@ private static boolean shouldUseFileSplitsFromInputFormat(InputFormat<?, ?> inpu\n                             partitionName));\n         }\n \n-        // Sort FileStatus objects (instead of, e.g., fileStatus.getPath().toString). This matches org.apache.hadoop.hive.ql.metadata.Table.getSortedPaths\n-        fileInfos.sort(null);\n+        if (fileInfos.get(0).getPath().getName().matches(\"\\\\d+\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47918eae68bd4b4a2970b2205d31d8c1ad4c7e2e"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjkzMzg2Nw==", "bodyText": "leave the first param to its own line", "url": "https://github.com/prestodb/presto/pull/15536#discussion_r546933867", "createdAt": "2020-12-21T21:17:37Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveManifestUtils.java", "diffHunk": "@@ -112,17 +112,36 @@ public static long getFileSize(Page statisticsPage, int position)\n         ImmutableMap.Builder<String, String> partitionMetadata = ImmutableMap.builder();\n         List<FileWriteInfo> fileWriteInfos = new ArrayList<>(partitionUpdate.getFileWriteInfos());\n \n+        if (!partitionUpdate.containsNumberedFileNames()) {\n+            // Filenames starting with \".tmp.presto\" will be renamed in TableFinishOperator. So it doesn't make sense to store the filenames in manifest\n+            return metadata;\n+        }\n+\n         // Sort the file infos based on fileName\n         fileWriteInfos.sort(Comparator.comparing(info -> Integer.valueOf(info.getWriteFileName())));\n \n+        List<String> fileNames = fileWriteInfos.stream().map(FileWriteInfo::getWriteFileName).collect(toImmutableList());\n+        List<Long> fileSizes = fileWriteInfos.stream().map(FileWriteInfo::getFileSize).filter(Optional::isPresent).map(Optional::get).collect(toImmutableList());\n+\n+        if (fileSizes.size() < fileNames.size()) {\n+            if (fileSizes.size() == 0) {\n+                // These files may not have been written by OrcFileWriter. So file sizes not available.\n+                return metadata;\n+            }\n+            throw new PrestoException(\n+                    MALFORMED_HIVE_FILE_STATISTICS,\n+                    format(\"During manifest creation for partition= %s, filename count= %s is not equal to filesizes count= %s\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2d199d6b88039219dfe55cc92a8c05f6aaba5a6"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjkzNDE3Mw==", "bodyText": "fileSizes.isEmpty()", "url": "https://github.com/prestodb/presto/pull/15536#discussion_r546934173", "createdAt": "2020-12-21T21:18:24Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveManifestUtils.java", "diffHunk": "@@ -112,17 +112,36 @@ public static long getFileSize(Page statisticsPage, int position)\n         ImmutableMap.Builder<String, String> partitionMetadata = ImmutableMap.builder();\n         List<FileWriteInfo> fileWriteInfos = new ArrayList<>(partitionUpdate.getFileWriteInfos());\n \n+        if (!partitionUpdate.containsNumberedFileNames()) {\n+            // Filenames starting with \".tmp.presto\" will be renamed in TableFinishOperator. So it doesn't make sense to store the filenames in manifest\n+            return metadata;\n+        }\n+\n         // Sort the file infos based on fileName\n         fileWriteInfos.sort(Comparator.comparing(info -> Integer.valueOf(info.getWriteFileName())));\n \n+        List<String> fileNames = fileWriteInfos.stream().map(FileWriteInfo::getWriteFileName).collect(toImmutableList());\n+        List<Long> fileSizes = fileWriteInfos.stream().map(FileWriteInfo::getFileSize).filter(Optional::isPresent).map(Optional::get).collect(toImmutableList());\n+\n+        if (fileSizes.size() < fileNames.size()) {\n+            if (fileSizes.size() == 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2d199d6b88039219dfe55cc92a8c05f6aaba5a6"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjkzNDk5Ng==", "bodyText": "why we need a new ArrayList?", "url": "https://github.com/prestodb/presto/pull/15536#discussion_r546934996", "createdAt": "2020-12-21T21:20:34Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveManifestUtils.java", "diffHunk": "@@ -148,6 +150,18 @@ public static long getFileSize(Page statisticsPage, int position)\n         return partitionMetadata.build();\n     }\n \n+    public static long getManifestSizeInBytes(ConnectorSession session, PartitionUpdate partitionUpdate)\n+    {\n+        if (isFileRenamingEnabled(session) && partitionUpdate.containsNumberedFileNames()) {\n+            List<FileWriteInfo> fileWriteInfos = new ArrayList<>(partitionUpdate.getFileWriteInfos());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfdb06a65b9502515f42bbb1ed3f4bda415e87da"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjkzODc4NQ==", "bodyText": "This is duplicated logic. We can directly get the size info from extraPartitionMetadata in HiveMetadata.finishInsert. No need to compute it again.", "url": "https://github.com/prestodb/presto/pull/15536#discussion_r546938785", "createdAt": "2020-12-21T21:30:21Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveManifestUtils.java", "diffHunk": "@@ -148,6 +150,18 @@ public static long getFileSize(Page statisticsPage, int position)\n         return partitionMetadata.build();\n     }\n \n+    public static long getManifestSizeInBytes(ConnectorSession session, PartitionUpdate partitionUpdate)\n+    {\n+        if (isFileRenamingEnabled(session) && partitionUpdate.containsNumberedFileNames()) {\n+            List<FileWriteInfo> fileWriteInfos = new ArrayList<>(partitionUpdate.getFileWriteInfos());\n+            return compressFileNames(fileWriteInfos.stream().map(FileWriteInfo::getWriteFileName).collect(toImmutableList())).length()\n+                    + compressFileSizes(fileWriteInfos.stream().map(FileWriteInfo::getFileSize).filter(Optional::isPresent).map(Optional::get).collect(toImmutableList())).length();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfdb06a65b9502515f42bbb1ed3f4bda415e87da"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "042b82c5546d367f4070ebccc7440df94a906294", "author": {"user": {"login": "NikhilCollooru", "name": "Nikhil Collooru"}}, "url": "https://github.com/prestodb/presto/commit/042b82c5546d367f4070ebccc7440df94a906294", "committedDate": "2020-12-21T23:59:24Z", "message": "Fix sorting file names for bucketed splits"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d11cb74a86c741d652391542c022e3bcec698332", "author": {"user": {"login": "NikhilCollooru", "name": "Nikhil Collooru"}}, "url": "https://github.com/prestodb/presto/commit/d11cb74a86c741d652391542c022e3bcec698332", "committedDate": "2020-12-21T23:59:24Z", "message": "Add containsNumberedFileNames to PartitionUpdate"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a07fe5c7023711bf055ab1b83838ce41246cef31", "author": {"user": {"login": "NikhilCollooru", "name": "Nikhil Collooru"}}, "url": "https://github.com/prestodb/presto/commit/a07fe5c7023711bf055ab1b83838ce41246cef31", "committedDate": "2020-12-18T23:07:31Z", "message": "Store manifest only when they are preferred and file renaming is enabled"}, "afterCommit": {"oid": "f66e653af7653552cbe9e9e2f4b5a52855364d52", "author": {"user": {"login": "NikhilCollooru", "name": "Nikhil Collooru"}}, "url": "https://github.com/prestodb/presto/commit/f66e653af7653552cbe9e9e2f4b5a52855364d52", "committedDate": "2020-12-21T23:59:24Z", "message": "Store manifest only when they are preferred and file renaming is enabled"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2Nzg5MjY3", "url": "https://github.com/prestodb/presto/pull/15536#pullrequestreview-556789267", "createdAt": "2020-12-22T03:02:27Z", "commit": {"oid": "f04e97e1cc48fb1f1bc2320277098f987958b6d1"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwMzowMjoyOFrOIJstqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwMzowNDozOVrOIJsvsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA0MDY4Mg==", "bodyText": "createPartitionManifest is actually not used anymore. I guess we can remove it", "url": "https://github.com/prestodb/presto/pull/15536#discussion_r547040682", "createdAt": "2020-12-22T03:02:28Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveManifestUtils.java", "diffHunk": "@@ -149,6 +151,21 @@ public static long getFileSize(Page statisticsPage, int position)\n         return partitionMetadata.build();\n     }\n \n+    public static long getManifestSizeInBytes(ConnectorSession session, PartitionUpdate partitionUpdate, Map<String, String> parameters)\n+    {\n+        if (isFileRenamingEnabled(session) && partitionUpdate.containsNumberedFileNames()) {\n+            if (parameters.containsKey(FILE_NAMES) && parameters.containsKey(FILE_SIZES)) {\n+                return parameters.get(FILE_NAMES).length() + parameters.get(FILE_SIZES).length();\n+            }\n+            List<FileWriteInfo> fileWriteInfos = partitionUpdate.getFileWriteInfos();\n+            return compressFileNames(fileWriteInfos.stream().map(FileWriteInfo::getWriteFileName).collect(toImmutableList())).length()\n+                    + compressFileSizes(fileWriteInfos.stream().map(FileWriteInfo::getFileSize).filter(Optional::isPresent).map(Optional::get).collect(toImmutableList())).length();\n+        }\n+\n+        Optional<Page> manifestBlob = createPartitionManifest(partitionUpdate);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f04e97e1cc48fb1f1bc2320277098f987958b6d1"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA0MDc3OQ==", "bodyText": "We don't need this part, this is duplication with updatePartitionMetadataWithFileNamesAndSizes", "url": "https://github.com/prestodb/presto/pull/15536#discussion_r547040779", "createdAt": "2020-12-22T03:02:55Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveManifestUtils.java", "diffHunk": "@@ -149,6 +151,21 @@ public static long getFileSize(Page statisticsPage, int position)\n         return partitionMetadata.build();\n     }\n \n+    public static long getManifestSizeInBytes(ConnectorSession session, PartitionUpdate partitionUpdate, Map<String, String> parameters)\n+    {\n+        if (isFileRenamingEnabled(session) && partitionUpdate.containsNumberedFileNames()) {\n+            if (parameters.containsKey(FILE_NAMES) && parameters.containsKey(FILE_SIZES)) {\n+                return parameters.get(FILE_NAMES).length() + parameters.get(FILE_SIZES).length();\n+            }\n+            List<FileWriteInfo> fileWriteInfos = partitionUpdate.getFileWriteInfos();\n+            return compressFileNames(fileWriteInfos.stream().map(FileWriteInfo::getWriteFileName).collect(toImmutableList())).length()\n+                    + compressFileSizes(fileWriteInfos.stream().map(FileWriteInfo::getFileSize).filter(Optional::isPresent).map(Optional::get).collect(toImmutableList())).length();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f04e97e1cc48fb1f1bc2320277098f987958b6d1"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA0MTEwMA==", "bodyText": "We just check if the extra params contains MANIFEST_VERSION. If yes, we sum up the values' lengths for FILE_NAMES and FILE_SIZES.", "url": "https://github.com/prestodb/presto/pull/15536#discussion_r547041100", "createdAt": "2020-12-22T03:04:16Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveManifestUtils.java", "diffHunk": "@@ -149,6 +151,21 @@ public static long getFileSize(Page statisticsPage, int position)\n         return partitionMetadata.build();\n     }\n \n+    public static long getManifestSizeInBytes(ConnectorSession session, PartitionUpdate partitionUpdate, Map<String, String> parameters)\n+    {\n+        if (isFileRenamingEnabled(session) && partitionUpdate.containsNumberedFileNames()) {\n+            if (parameters.containsKey(FILE_NAMES) && parameters.containsKey(FILE_SIZES)) {\n+                return parameters.get(FILE_NAMES).length() + parameters.get(FILE_SIZES).length();\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f04e97e1cc48fb1f1bc2320277098f987958b6d1"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA0MTEyNA==", "bodyText": "return optional long", "url": "https://github.com/prestodb/presto/pull/15536#discussion_r547041124", "createdAt": "2020-12-22T03:04:22Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveManifestUtils.java", "diffHunk": "@@ -149,6 +151,21 @@ public static long getFileSize(Page statisticsPage, int position)\n         return partitionMetadata.build();\n     }\n \n+    public static long getManifestSizeInBytes(ConnectorSession session, PartitionUpdate partitionUpdate, Map<String, String> parameters)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f04e97e1cc48fb1f1bc2320277098f987958b6d1"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA0MTIwMQ==", "bodyText": "Only add to the stats if it's not optional empty.", "url": "https://github.com/prestodb/presto/pull/15536#discussion_r547041201", "createdAt": "2020-12-22T03:04:39Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -1941,10 +1940,8 @@ else if (partitionUpdate.getUpdateMode() == NEW || partitionUpdate.getUpdateMode\n                     extraPartitionMetadata = updatePartitionMetadataWithFileNamesAndSizes(partitionUpdate, extraPartitionMetadata);\n                 }\n \n-                // TODO: Put the manifest blob in partition parameters\n                 // Track the manifest blob size\n-                Optional<Page> manifestBlob = createPartitionManifest(partitionUpdate);\n-                manifestBlob.ifPresent(manifest -> hivePartitionStats.addManifestSizeInBytes(manifest.getRetainedSizeInBytes()));\n+                hivePartitionStats.addManifestSizeInBytes(getManifestSizeInBytes(session, partitionUpdate, extraPartitionMetadata));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f04e97e1cc48fb1f1bc2320277098f987958b6d1"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a283052e94021706eaaab601d7883ae8e8e85115", "author": {"user": {"login": "NikhilCollooru", "name": "Nikhil Collooru"}}, "url": "https://github.com/prestodb/presto/commit/a283052e94021706eaaab601d7883ae8e8e85115", "committedDate": "2020-12-22T19:52:45Z", "message": "Track compressed manifest size when file_renaming is enabled"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fba161bac1073f6338fd2e2d9ebd1d756b7b539e", "author": {"user": {"login": "NikhilCollooru", "name": "Nikhil Collooru"}}, "url": "https://github.com/prestodb/presto/commit/fba161bac1073f6338fd2e2d9ebd1d756b7b539e", "committedDate": "2020-12-22T19:53:07Z", "message": "Store manifest only when they are preferred and file renaming is enabled"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f66e653af7653552cbe9e9e2f4b5a52855364d52", "author": {"user": {"login": "NikhilCollooru", "name": "Nikhil Collooru"}}, "url": "https://github.com/prestodb/presto/commit/f66e653af7653552cbe9e9e2f4b5a52855364d52", "committedDate": "2020-12-21T23:59:24Z", "message": "Store manifest only when they are preferred and file renaming is enabled"}, "afterCommit": {"oid": "fba161bac1073f6338fd2e2d9ebd1d756b7b539e", "author": {"user": {"login": "NikhilCollooru", "name": "Nikhil Collooru"}}, "url": "https://github.com/prestodb/presto/commit/fba161bac1073f6338fd2e2d9ebd1d756b7b539e", "committedDate": "2020-12-22T19:53:07Z", "message": "Store manifest only when they are preferred and file renaming is enabled"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYwODAxNzIx", "url": "https://github.com/prestodb/presto/pull/15536#pullrequestreview-560801721", "createdAt": "2021-01-04T06:29:32Z", "commit": {"oid": "fba161bac1073f6338fd2e2d9ebd1d756b7b539e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4575, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}