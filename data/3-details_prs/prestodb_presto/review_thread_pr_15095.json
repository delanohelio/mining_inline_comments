{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc1NTk4MDYz", "number": 15095, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNToxNzozMFrOEeWc4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxNzowMzo0M1rOEmshvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwMjYwNTc4OnYy", "diffSide": "RIGHT", "path": "presto-spark-base/src/test/java/com/facebook/presto/spark/PrestoSparkQueryRunner.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNToxNzozMFrOHJ9FyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxNzowMjowN1rOHW4GcQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDIwMDEzNg==", "bodyText": "Do you think at this point we can simply remove the prefer-distributed-union property? As it was added as a hack originally.\nCC: @wenleix", "url": "https://github.com/prestodb/presto/pull/15095#discussion_r480200136", "createdAt": "2020-08-31T15:17:30Z", "author": {"login": "arhimondr"}, "path": "presto-spark-base/src/test/java/com/facebook/presto/spark/PrestoSparkQueryRunner.java", "diffHunk": "@@ -204,7 +204,7 @@ public PrestoSparkQueryRunner(String defaultCatalog)\n                 ImmutableMap.of(\n                         \"presto.version\", \"testversion\",\n                         \"query.hash-partition-count\", Integer.toString(NODE_COUNT * 2),\n-                        \"prefer-distributed-union\", \"false\"),\n+                        \"prefer-distributed-union\", \"true\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "540dd0a6d5e93c36cace99a59929f3ba010219ca"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI3NDQ2OA==", "bodyText": "prefer-distributed-union can be removed. Let's do it later, because if this PR broke anything, we have an option to use single mode union", "url": "https://github.com/prestodb/presto/pull/15095#discussion_r480274468", "createdAt": "2020-08-31T17:21:57Z", "author": {"login": "viczhang861"}, "path": "presto-spark-base/src/test/java/com/facebook/presto/spark/PrestoSparkQueryRunner.java", "diffHunk": "@@ -204,7 +204,7 @@ public PrestoSparkQueryRunner(String defaultCatalog)\n                 ImmutableMap.of(\n                         \"presto.version\", \"testversion\",\n                         \"query.hash-partition-count\", Integer.toString(NODE_COUNT * 2),\n-                        \"prefer-distributed-union\", \"false\"),\n+                        \"prefer-distributed-union\", \"true\"),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDIwMDEzNg=="}, "originalCommit": {"oid": "540dd0a6d5e93c36cace99a59929f3ba010219ca"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDMwMzc5OQ==", "bodyText": "Let's at least enable the prefer-distributed-union by default here: https://github.com/prestodb/presto/blob/master/presto-spark-base/src/main/java/com/facebook/presto/spark/PrestoSparkSettingsRequirements.java#L98", "url": "https://github.com/prestodb/presto/pull/15095#discussion_r480303799", "createdAt": "2020-08-31T18:17:12Z", "author": {"login": "arhimondr"}, "path": "presto-spark-base/src/test/java/com/facebook/presto/spark/PrestoSparkQueryRunner.java", "diffHunk": "@@ -204,7 +204,7 @@ public PrestoSparkQueryRunner(String defaultCatalog)\n                 ImmutableMap.of(\n                         \"presto.version\", \"testversion\",\n                         \"query.hash-partition-count\", Integer.toString(NODE_COUNT * 2),\n-                        \"prefer-distributed-union\", \"false\"),\n+                        \"prefer-distributed-union\", \"true\"),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDIwMDEzNg=="}, "originalCommit": {"oid": "540dd0a6d5e93c36cace99a59929f3ba010219ca"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDMwNDA5Ng==", "bodyText": "Also remove the setting override in the integration tests: https://github.com/prestodb/presto/blob/master/presto-spark-testing/src/test/java/com/facebook/presto/spark/testing/TestPrestoSparkLauncherIntegrationSmokeTest.java#L151", "url": "https://github.com/prestodb/presto/pull/15095#discussion_r480304096", "createdAt": "2020-08-31T18:17:49Z", "author": {"login": "arhimondr"}, "path": "presto-spark-base/src/test/java/com/facebook/presto/spark/PrestoSparkQueryRunner.java", "diffHunk": "@@ -204,7 +204,7 @@ public PrestoSparkQueryRunner(String defaultCatalog)\n                 ImmutableMap.of(\n                         \"presto.version\", \"testversion\",\n                         \"query.hash-partition-count\", Integer.toString(NODE_COUNT * 2),\n-                        \"prefer-distributed-union\", \"false\"),\n+                        \"prefer-distributed-union\", \"true\"),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDIwMDEzNg=="}, "originalCommit": {"oid": "540dd0a6d5e93c36cace99a59929f3ba010219ca"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc0OTg3Mw==", "bodyText": "Yeah, sounds good to just remove it.", "url": "https://github.com/prestodb/presto/pull/15095#discussion_r493749873", "createdAt": "2020-09-23T17:02:07Z", "author": {"login": "wenleix"}, "path": "presto-spark-base/src/test/java/com/facebook/presto/spark/PrestoSparkQueryRunner.java", "diffHunk": "@@ -204,7 +204,7 @@ public PrestoSparkQueryRunner(String defaultCatalog)\n                 ImmutableMap.of(\n                         \"presto.version\", \"testversion\",\n                         \"query.hash-partition-count\", Integer.toString(NODE_COUNT * 2),\n-                        \"prefer-distributed-union\", \"false\"),\n+                        \"prefer-distributed-union\", \"true\"),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDIwMDEzNg=="}, "originalCommit": {"oid": "540dd0a6d5e93c36cace99a59929f3ba010219ca"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwMjYxMzI2OnYy", "diffSide": "RIGHT", "path": "presto-spark-base/src/main/java/com/facebook/presto/spark/execution/PrestoSparkRowOutputOperator.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNToxOToyNlrOHJ9KVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxODo1MDo1MlrOHKEiOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDIwMTMwMw==", "bodyText": "This looks a little bit like a hack. Should we set it to real number of the output partitions (hashPartitionCount)?", "url": "https://github.com/prestodb/presto/pull/15095#discussion_r480201303", "createdAt": "2020-08-31T15:19:26Z", "author": {"login": "arhimondr"}, "path": "presto-spark-base/src/main/java/com/facebook/presto/spark/execution/PrestoSparkRowOutputOperator.java", "diffHunk": "@@ -107,6 +123,31 @@ public int getPartition(Page page, int position)\n         }\n     }\n \n+    private static class PreDeterminedPartitionFunction\n+            implements PartitionFunction\n+    {\n+        private final int partitionId;\n+\n+        public PreDeterminedPartitionFunction(int partitionId)\n+        {\n+            this.partitionId = partitionId;\n+        }\n+\n+        @Override\n+        public int getPartitionCount()\n+        {\n+            // To be compatible with RowIndex in PrestoSparkRowBatchBuilder\n+            // where RowIndex requires an array size of at least partitionId + 1\n+            return partitionId + 1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "540dd0a6d5e93c36cace99a59929f3ba010219ca"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDMyMjEwNg==", "bodyText": "Yes, we can use hashPartitionCount, the performance overhead (create a large unnecessary array for a small partitionId like 1) should be negligible.", "url": "https://github.com/prestodb/presto/pull/15095#discussion_r480322106", "createdAt": "2020-08-31T18:50:52Z", "author": {"login": "viczhang861"}, "path": "presto-spark-base/src/main/java/com/facebook/presto/spark/execution/PrestoSparkRowOutputOperator.java", "diffHunk": "@@ -107,6 +123,31 @@ public int getPartition(Page page, int position)\n         }\n     }\n \n+    private static class PreDeterminedPartitionFunction\n+            implements PartitionFunction\n+    {\n+        private final int partitionId;\n+\n+        public PreDeterminedPartitionFunction(int partitionId)\n+        {\n+            this.partitionId = partitionId;\n+        }\n+\n+        @Override\n+        public int getPartitionCount()\n+        {\n+            // To be compatible with RowIndex in PrestoSparkRowBatchBuilder\n+            // where RowIndex requires an array size of at least partitionId + 1\n+            return partitionId + 1;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDIwMTMwMw=="}, "originalCommit": {"oid": "540dd0a6d5e93c36cace99a59929f3ba010219ca"}, "originalPosition": 59}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwMzk3NzI4OnYy", "diffSide": "RIGHT", "path": "presto-spark-testing/src/test/java/com/facebook/presto/spark/testing/TestPrestoSparkLauncherIntegrationSmokeTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMTozNjowNFrOHKKFHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMTozNjowNFrOHKKFHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQxMjk1OA==", "bodyText": "Let's simply remove this override", "url": "https://github.com/prestodb/presto/pull/15095#discussion_r480412958", "createdAt": "2020-08-31T21:36:04Z", "author": {"login": "arhimondr"}, "path": "presto-spark-testing/src/test/java/com/facebook/presto/spark/testing/TestPrestoSparkLauncherIntegrationSmokeTest.java", "diffHunk": "@@ -148,7 +148,7 @@ public void setUp()\n         configProperties = new File(tempDir, \"config.properties\");\n         storeProperties(configProperties, ImmutableMap.of(\n                 \"query.hash-partition-count\", \"10\",\n-                \"prefer-distributed-union\", \"false\"));\n+                \"prefer-distributed-union\", \"true\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "765b1e63cbf56ce73490c701cfd7cf71f2440b80"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwMzk3ODI5OnYy", "diffSide": "RIGHT", "path": "presto-spark-base/src/test/java/com/facebook/presto/spark/PrestoSparkQueryRunner.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMTozNjoyMVrOHKKFsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMTozNjoyMVrOHKKFsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQxMzEwNg==", "bodyText": "Let's simply remove this override (since it is default now)", "url": "https://github.com/prestodb/presto/pull/15095#discussion_r480413106", "createdAt": "2020-08-31T21:36:21Z", "author": {"login": "arhimondr"}, "path": "presto-spark-base/src/test/java/com/facebook/presto/spark/PrestoSparkQueryRunner.java", "diffHunk": "@@ -204,7 +204,7 @@ public PrestoSparkQueryRunner(String defaultCatalog)\n                 ImmutableMap.of(\n                         \"presto.version\", \"testversion\",\n                         \"query.hash-partition-count\", Integer.toString(NODE_COUNT * 2),\n-                        \"prefer-distributed-union\", \"false\"),\n+                        \"prefer-distributed-union\", \"true\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "765b1e63cbf56ce73490c701cfd7cf71f2440b80"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5MDEwODc4OnYy", "diffSide": "RIGHT", "path": "presto-spark-base/src/main/java/com/facebook/presto/spark/execution/PrestoSparkRowOutputOperator.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxNzowMzo0M1rOHW4KXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxNzowMzo0M1rOHW4KXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc1MDg3Nw==", "bodyText": "nit: maybe add a check state about partitionId < partitionCount?", "url": "https://github.com/prestodb/presto/pull/15095#discussion_r493750877", "createdAt": "2020-09-23T17:03:43Z", "author": {"login": "wenleix"}, "path": "presto-spark-base/src/main/java/com/facebook/presto/spark/execution/PrestoSparkRowOutputOperator.java", "diffHunk": "@@ -107,6 +113,31 @@ public int getPartition(Page page, int position)\n         }\n     }\n \n+    public static class PreDeterminedPartitionFunction\n+            implements PartitionFunction\n+    {\n+        private final int partitionId;\n+        private final int partitionCount;\n+\n+        public PreDeterminedPartitionFunction(int partitionId, int partitionCount)\n+        {\n+            this.partitionId = partitionId;\n+            this.partitionCount = partitionCount;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5867c3760d974645f9ec0076f2a933bad85a360a"}, "originalPosition": 43}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3595, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}