{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAxMzU3NDc0", "number": 14370, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxNzo1MzoyOVrODw0QLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxNzoyODo0M1rODxUY0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyNTE0MzUwOnYy", "diffSide": "LEFT", "path": "presto-orc/src/main/java/com/facebook/presto/orc/OrcSelectiveRecordReader.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxNzo1MzoyOVrOGEBZWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxNzo1MzoyOVrOGEBZWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg3MDM2MA==", "bodyText": "this is handled in super.close()", "url": "https://github.com/prestodb/presto/pull/14370#discussion_r406870360", "createdAt": "2020-04-10T17:53:29Z", "author": {"login": "bhhari"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/OrcSelectiveRecordReader.java", "diffHunk": "@@ -849,14 +849,6 @@ private void initializeOutputPositions(int positionCount)\n     public void close()\n             throws IOException\n     {\n-        try (Closer closer = Closer.create()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cdedb44af76446692cf652f48e80e760154f6e3"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyOTczMjEyOnYy", "diffSide": "RIGHT", "path": "presto-orc/src/main/java/com/facebook/presto/orc/reader/LongDictionarySelectiveStreamReader.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxNDoxMToxMVrOGEnsRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxNDoxMToxMVrOGEnsRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ5Nzc5OA==", "bodyText": "This change doesn't seem right and is not part of nulling member variables in close.", "url": "https://github.com/prestodb/presto/pull/14370#discussion_r407497798", "createdAt": "2020-04-13T14:11:11Z", "author": {"login": "mbasmanova"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/reader/LongDictionarySelectiveStreamReader.java", "diffHunk": "@@ -278,13 +278,14 @@ private void openRowGroup()\n         if (!dictionaryOpen && dictionarySize > 0) {\n             if (dictionary.length < dictionarySize) {\n                 dictionary = new long[dictionarySize];\n+                systemMemoryContext.setBytes(sizeOf(dictionary));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f064faa000a6c4cbfd8c04c149542dbc32ea8eb4"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyOTczMzU2OnYy", "diffSide": "RIGHT", "path": "presto-orc/src/main/java/com/facebook/presto/orc/reader/LongDictionarySelectiveStreamReader.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxNDoxMTo0NVrOGEntLA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxNDoxMTo0NVrOGEntLA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ5ODAyOA==", "bodyText": "What's the reason for this change? Perhaps, move it into a separate commit and explain it in commit messase.", "url": "https://github.com/prestodb/presto/pull/14370#discussion_r407498028", "createdAt": "2020-04-13T14:11:45Z", "author": {"login": "mbasmanova"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/reader/LongDictionarySelectiveStreamReader.java", "diffHunk": "@@ -278,13 +278,14 @@ private void openRowGroup()\n         if (!dictionaryOpen && dictionarySize > 0) {\n             if (dictionary.length < dictionarySize) {\n                 dictionary = new long[dictionarySize];\n+                systemMemoryContext.setBytes(sizeOf(dictionary));\n             }\n \n             LongInputStream dictionaryStream = dictionaryDataStreamSource.openStream();\n             if (dictionaryStream == null) {\n                 throw new OrcCorruptionException(streamDescriptor.getOrcDataSourceId(), \"Dictionary is not empty but data stream is not present\");\n             }\n-            dictionaryStream.nextLongVector(dictionarySize, dictionary);\n+            dictionaryStream.next(dictionary, dictionarySize);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f064faa000a6c4cbfd8c04c149542dbc32ea8eb4"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyOTc0MjMzOnYy", "diffSide": "RIGHT", "path": "presto-spi/src/main/java/com/facebook/presto/spi/block/ClosingBlockLease.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxNDoxNDozMlrOGEnyWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxNjo1NzowOFrOGEtHmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ5OTM1NA==", "bodyText": "This change is problematic. The lease doesn't own the block and the same block can be used to create multiple leases.", "url": "https://github.com/prestodb/presto/pull/14370#discussion_r407499354", "createdAt": "2020-04-13T14:14:32Z", "author": {"login": "mbasmanova"}, "path": "presto-spi/src/main/java/com/facebook/presto/spi/block/ClosingBlockLease.java", "diffHunk": "@@ -65,6 +65,7 @@ public void close()\n             return;\n         }\n         closed = true;\n+        block = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9045e288034c8b2e66c97a4abdce50ff68d9ba7e"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU0OTUxNQ==", "bodyText": "All the usage seems to create a new block everytime before getting the lease", "url": "https://github.com/prestodb/presto/pull/14370#discussion_r407549515", "createdAt": "2020-04-13T15:49:08Z", "author": {"login": "bhhari"}, "path": "presto-spi/src/main/java/com/facebook/presto/spi/block/ClosingBlockLease.java", "diffHunk": "@@ -65,6 +65,7 @@ public void close()\n             return;\n         }\n         closed = true;\n+        block = null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ5OTM1NA=="}, "originalCommit": {"oid": "9045e288034c8b2e66c97a4abdce50ff68d9ba7e"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU4NjcxNA==", "bodyText": "@bhhari Actually, I got confused. This is fine as lease can not be used after \"close()\".", "url": "https://github.com/prestodb/presto/pull/14370#discussion_r407586714", "createdAt": "2020-04-13T16:57:08Z", "author": {"login": "mbasmanova"}, "path": "presto-spi/src/main/java/com/facebook/presto/spi/block/ClosingBlockLease.java", "diffHunk": "@@ -65,6 +65,7 @@ public void close()\n             return;\n         }\n         closed = true;\n+        block = null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ5OTM1NA=="}, "originalCommit": {"oid": "9045e288034c8b2e66c97a4abdce50ff68d9ba7e"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzMDQwODUxOnYy", "diffSide": "RIGHT", "path": "presto-orc/src/main/java/com/facebook/presto/orc/reader/MapDirectSelectiveStreamReader.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxNzoyODo0M1rOGEuKnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxNzozNjowMlrOGEuaIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYwMzg2OQ==", "bodyText": "@bhhari do you need to add keyReader = null;? same for valueReader", "url": "https://github.com/prestodb/presto/pull/14370#discussion_r407603869", "createdAt": "2020-04-13T17:28:43Z", "author": {"login": "mbasmanova"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/reader/MapDirectSelectiveStreamReader.java", "diffHunk": "@@ -658,6 +658,26 @@ public String toString()\n     @Override\n     public void close()\n     {\n+        if (keyReader != null) {\n+            keyReader.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad8d61cf3a46ec612592aedb94daa3dc4b9891c5"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYwNzg0Mw==", "bodyText": "@mbasmanova  as of now this is not required, I have tested the current code and It does get better GC.\nI will have separate PR to assign the readers to null once close is called. Unfortunately as present there are some tests which are calling to into getRetainedSize() after close.", "url": "https://github.com/prestodb/presto/pull/14370#discussion_r407607843", "createdAt": "2020-04-13T17:36:02Z", "author": {"login": "bhhari"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/reader/MapDirectSelectiveStreamReader.java", "diffHunk": "@@ -658,6 +658,26 @@ public String toString()\n     @Override\n     public void close()\n     {\n+        if (keyReader != null) {\n+            keyReader.close();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYwMzg2OQ=="}, "originalCommit": {"oid": "ad8d61cf3a46ec612592aedb94daa3dc4b9891c5"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2771, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}