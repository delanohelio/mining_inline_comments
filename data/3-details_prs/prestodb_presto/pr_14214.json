{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg0MDM5NDc0", "number": 14214, "title": "Verifier fixes and improvements", "bodyText": "== RELEASE NOTES ==\n\nVerifier Changes\n* Fix an issue where resubmitted queries always fail.\n* Add support to output verification results for failures due to Verifier internal errors.\n* Add support to skip teardown queries in case control and test queries succeeds but\nverification fails. This can be enabled by configuration property ``smart-teardown``, which replaces ``run-teardown-on-result-mismatch``.", "createdAt": "2020-03-05T02:56:04Z", "url": "https://github.com/prestodb/presto/pull/14214", "merged": true, "mergeCommit": {"oid": "da2cc5620075d12abb19f3860a5459615f515cb4"}, "closed": true, "closedAt": "2020-03-31T19:19:11Z", "author": {"login": "caithagoras"}, "timelineItems": {"totalCount": 43, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKjjYhgBqjMwOTk1OTMwNDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTFCn3AFqTM4NDg2NDAyMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "48f8f077ccd1e7f26b92a4cd7d9d5046768f5faa", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/48f8f077ccd1e7f26b92a4cd7d9d5046768f5faa", "committedDate": "2020-03-05T02:44:19Z", "message": "Use VerificationContext in AbstractVerification"}, "afterCommit": {"oid": "e0702f85d6daf4b35971dc0eb884675c94dd130d", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/e0702f85d6daf4b35971dc0eb884675c94dd130d", "committedDate": "2020-03-05T04:10:31Z", "message": "Use VerificationContext in AbstractVerification"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e0702f85d6daf4b35971dc0eb884675c94dd130d", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/e0702f85d6daf4b35971dc0eb884675c94dd130d", "committedDate": "2020-03-05T04:10:31Z", "message": "Use VerificationContext in AbstractVerification"}, "afterCommit": {"oid": "632723d8600c07bd51579fec11550e89f4508d86", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/632723d8600c07bd51579fec11550e89f4508d86", "committedDate": "2020-03-05T04:10:42Z", "message": "Use VerificationContext in AbstractVerification"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "632723d8600c07bd51579fec11550e89f4508d86", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/632723d8600c07bd51579fec11550e89f4508d86", "committedDate": "2020-03-05T04:10:42Z", "message": "Use VerificationContext in AbstractVerification"}, "afterCommit": {"oid": "5834d4addd377c64a952428bfff1d1f38abdd36a", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/5834d4addd377c64a952428bfff1d1f38abdd36a", "committedDate": "2020-03-05T04:16:54Z", "message": "Use VerificationContext in AbstractVerification"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5834d4addd377c64a952428bfff1d1f38abdd36a", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/5834d4addd377c64a952428bfff1d1f38abdd36a", "committedDate": "2020-03-05T04:16:54Z", "message": "Use VerificationContext in AbstractVerification"}, "afterCommit": {"oid": "453d505cd52ee19367d6584a7e3e3873799572e1", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/453d505cd52ee19367d6584a7e3e3873799572e1", "committedDate": "2020-03-05T04:21:06Z", "message": "Use VerificationContext in AbstractVerification"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "453d505cd52ee19367d6584a7e3e3873799572e1", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/453d505cd52ee19367d6584a7e3e3873799572e1", "committedDate": "2020-03-05T04:21:06Z", "message": "Use VerificationContext in AbstractVerification"}, "afterCommit": {"oid": "fac8548e7479fbf8dcf2991e5b6584f3c88f169b", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/fac8548e7479fbf8dcf2991e5b6584f3c88f169b", "committedDate": "2020-03-05T04:27:03Z", "message": "Expose unexpected exceptions in Verifier"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fac8548e7479fbf8dcf2991e5b6584f3c88f169b", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/fac8548e7479fbf8dcf2991e5b6584f3c88f169b", "committedDate": "2020-03-05T04:27:03Z", "message": "Expose unexpected exceptions in Verifier"}, "afterCommit": {"oid": "a329cd118c2e8dfcd461e7c4a7cadef49c4c5ddb", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/a329cd118c2e8dfcd461e7c4a7cadef49c4c5ddb", "committedDate": "2020-03-05T04:33:40Z", "message": "Expose unexpected exceptions in Verifier"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dacb9806566337eff984a579b0a12e7d0ba53517", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/dacb9806566337eff984a579b0a12e7d0ba53517", "committedDate": "2020-03-05T06:09:16Z", "message": "Fix AbstractTestVerifierIntegrationSmokeTest"}, "afterCommit": {"oid": "e801490d82ca312b7030bdc5a9a5635824f2ff6b", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/e801490d82ca312b7030bdc5a9a5635824f2ff6b", "committedDate": "2020-03-05T06:11:02Z", "message": "Fix AbstractTestVerifierIntegrationSmokeTest"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e801490d82ca312b7030bdc5a9a5635824f2ff6b", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/e801490d82ca312b7030bdc5a9a5635824f2ff6b", "committedDate": "2020-03-05T06:11:02Z", "message": "Fix AbstractTestVerifierIntegrationSmokeTest"}, "afterCommit": {"oid": "1647fb837b92ea459c4ab03aff5f0ec539e35bcc", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/1647fb837b92ea459c4ab03aff5f0ec539e35bcc", "committedDate": "2020-03-05T06:26:06Z", "message": "Fix AbstractTestVerifierIntegrationSmokeTest"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1647fb837b92ea459c4ab03aff5f0ec539e35bcc", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/1647fb837b92ea459c4ab03aff5f0ec539e35bcc", "committedDate": "2020-03-05T06:26:06Z", "message": "Fix AbstractTestVerifierIntegrationSmokeTest"}, "afterCommit": {"oid": "23f3e7e551132967faa3fbf3fe9921620c330c4a", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/23f3e7e551132967faa3fbf3fe9921620c330c4a", "committedDate": "2020-03-05T06:36:10Z", "message": "Fix AbstractTestVerifierIntegrationSmokeTest\n\nThe test merely tests injection and continue to succeed even when\nthere are verification failures. Add assertions that the testing\nverification are succeded."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "23f3e7e551132967faa3fbf3fe9921620c330c4a", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/23f3e7e551132967faa3fbf3fe9921620c330c4a", "committedDate": "2020-03-05T06:36:10Z", "message": "Fix AbstractTestVerifierIntegrationSmokeTest\n\nThe test merely tests injection and continue to succeed even when\nthere are verification failures. Add assertions that the testing\nverification are succeded."}, "afterCommit": {"oid": "aefe0c539bb786d72364777b76aa181e90887b76", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/aefe0c539bb786d72364777b76aa181e90887b76", "committedDate": "2020-03-05T06:56:47Z", "message": "Fix AbstractTestVerifierIntegrationSmokeTest\n\nThe test merely tests injection and continue to succeed even when\nthere are verification failures. Add assertions that the testing\nverification are succeded."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "aefe0c539bb786d72364777b76aa181e90887b76", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/aefe0c539bb786d72364777b76aa181e90887b76", "committedDate": "2020-03-05T06:56:47Z", "message": "Fix AbstractTestVerifierIntegrationSmokeTest\n\nThe test merely tests injection and continue to succeed even when\nthere are verification failures. Add assertions that the testing\nverification are succeded."}, "afterCommit": {"oid": "515d93ed52c0779ce9c2f9499ae33a24797b01ad", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/515d93ed52c0779ce9c2f9499ae33a24797b01ad", "committedDate": "2020-03-05T09:00:36Z", "message": "Fix AbstractTestVerifierIntegrationSmokeTest\n\nThe test merely tests injection and continue to succeed even when\nthere are verification failures. Add assertions that the testing\nverification are succeded."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "515d93ed52c0779ce9c2f9499ae33a24797b01ad", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/515d93ed52c0779ce9c2f9499ae33a24797b01ad", "committedDate": "2020-03-05T09:00:36Z", "message": "Fix AbstractTestVerifierIntegrationSmokeTest\n\nThe test merely tests injection and continue to succeed even when\nthere are verification failures. Add assertions that the testing\nverification are succeded."}, "afterCommit": {"oid": "b4c534fa853e41ba08b13472a30f113f8bc675fe", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/b4c534fa853e41ba08b13472a30f113f8bc675fe", "committedDate": "2020-03-05T11:37:22Z", "message": "Fix AbstractTestVerifierIntegrationSmokeTest\n\nThe test merely tests injection and continue to succeed even when\nthere are verification failures. Add assertions that the testing\nverification are succeded."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b4c534fa853e41ba08b13472a30f113f8bc675fe", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/b4c534fa853e41ba08b13472a30f113f8bc675fe", "committedDate": "2020-03-05T11:37:22Z", "message": "Fix AbstractTestVerifierIntegrationSmokeTest\n\nThe test merely tests injection and continue to succeed even when\nthere are verification failures. Add assertions that the testing\nverification are succeded."}, "afterCommit": {"oid": "2a0a0f361ee4806b44411f855969fb439199a16f", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/2a0a0f361ee4806b44411f855969fb439199a16f", "committedDate": "2020-03-05T20:09:07Z", "message": "Fix AbstractTestVerifierIntegrationSmokeTest\n\nThe test merely tests injection and continue to succeed even when\nthere are verification failures. Add assertions that the testing\nverification are succeded."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2a0a0f361ee4806b44411f855969fb439199a16f", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/2a0a0f361ee4806b44411f855969fb439199a16f", "committedDate": "2020-03-05T20:09:07Z", "message": "Fix AbstractTestVerifierIntegrationSmokeTest\n\nThe test merely tests injection and continue to succeed even when\nthere are verification failures. Add assertions that the testing\nverification are succeded."}, "afterCommit": {"oid": "2066b443dbd3f91a546e2afa519464cbab1c331e", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/2066b443dbd3f91a546e2afa519464cbab1c331e", "committedDate": "2020-03-07T22:22:59Z", "message": "Fix AbstractTestVerifierIntegrationSmokeTest\n\nThe test merely tests injection and continue to succeed even when\nthere are verification failures. Add assertions that the testing\nverification are succeded."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2a6534ad09ce2914a19eed38f34ddd013ce0785c", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/2a6534ad09ce2914a19eed38f34ddd013ce0785c", "committedDate": "2020-03-10T07:24:06Z", "message": "Improve teardown skipping\n\nReplace run-teardown-on-result-mismatch with smart-teardown, which\nskips teardown in case control and test queries succeed but\nverification fails.\n\nThis allows result tables to be perserved in cases like checksum\nquery failures, to ease debugging and investigation."}, "afterCommit": {"oid": "4dabfd01dcbc3ca8b03da32ace9a64f787f0d2e2", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/4dabfd01dcbc3ca8b03da32ace9a64f787f0d2e2", "committedDate": "2020-03-10T07:27:40Z", "message": "Improve teardown skipping\n\nReplace run-teardown-on-result-mismatch with smart-teardown, which\nskips teardown in case control and test queries succeeds but\nverification fails.\n\nThis allows result tables to be perserved in cases like checksum\nquery failures, to ease debugging and investigation."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1f9c60715a6226f287c24085069d6da1fa30aff3", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/1f9c60715a6226f287c24085069d6da1fa30aff3", "committedDate": "2020-03-10T07:42:11Z", "message": "Improve resubmission"}, "afterCommit": {"oid": "6248e6962e526cf3a52657c94548579bf433fed6", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/6248e6962e526cf3a52657c94548579bf433fed6", "committedDate": "2020-03-10T07:48:39Z", "message": "Improve resubmission"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6248e6962e526cf3a52657c94548579bf433fed6", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/6248e6962e526cf3a52657c94548579bf433fed6", "committedDate": "2020-03-10T07:48:39Z", "message": "Improve resubmission"}, "afterCommit": {"oid": "9d46899d292895fa0d2e596a694dff3be7c9fe4a", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/9d46899d292895fa0d2e596a694dff3be7c9fe4a", "committedDate": "2020-03-10T07:49:44Z", "message": "Improve resubmission"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9d46899d292895fa0d2e596a694dff3be7c9fe4a", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/9d46899d292895fa0d2e596a694dff3be7c9fe4a", "committedDate": "2020-03-10T07:49:44Z", "message": "Improve resubmission"}, "afterCommit": {"oid": "f43b9af6841b908d265d75ebc876f4314172bac2", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/f43b9af6841b908d265d75ebc876f4314172bac2", "committedDate": "2020-03-10T19:09:38Z", "message": "Restart verification if checksum queries complain table alaready exists\n\nWe're seeing test setup query, which creates the target table to\ninset, fails but the table was still created. Therefore, in case\nchecksum queries fail due to table already exists error, we can\nresubmit the verification to mitigate the transient error."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f43b9af6841b908d265d75ebc876f4314172bac2", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/f43b9af6841b908d265d75ebc876f4314172bac2", "committedDate": "2020-03-10T19:09:38Z", "message": "Restart verification if checksum queries complain table alaready exists\n\nWe're seeing test setup query, which creates the target table to\ninset, fails but the table was still created. Therefore, in case\nchecksum queries fail due to table already exists error, we can\nresubmit the verification to mitigate the transient error."}, "afterCommit": {"oid": "b1d1d10798fa97ac39fd98504a9d89e5cb65161b", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/b1d1d10798fa97ac39fd98504a9d89e5cb65161b", "committedDate": "2020-03-18T20:33:06Z", "message": "Restart verification if checksum queries complain table already exists\n\nWe're seeing test setup query, which creates the target table to\ninset, fails but the table was still created. Therefore, in case\nchecksum queries fail due to table already exists error, we can\nresubmit the verification to mitigate the transient error."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3NzgxMDUx", "url": "https://github.com/prestodb/presto/pull/14214#pullrequestreview-377781051", "createdAt": "2020-03-19T14:36:57Z", "commit": {"oid": "b1d1d10798fa97ac39fd98504a9d89e5cb65161b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxNDozNjo1N1rOF4xaVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxNDozNjo1N1rOF4xaVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTA3NDEzMg==", "bodyText": "It's strange to me that this class is mutable and gets passed around and modified in several places.  Usually we try to limit the use of mutable objects in Presto, especially across different classes.  In my opinion the mutability here makes the lifecycle of each object confusing and makes the code more error prone (e.g. trying to update the same field 2x). The second commit seems like it's fixing a problem that's mostly caused by this being a mutable object.  And then later commits add even more things to this class, which I think just makes it more fragile. I think it would be better to break this class up into a few classes that can each be immutable.\nFor example, you can separate out an object for keeping the data verification info of control and test checksum queries and build that in DataVerfication.verify(), and then have another object that has all the determinism info that.gets built in the DeterminismAnalyzer and have the LimitDeterminismAnalysis also return the queryId, so that part can be immutable to.", "url": "https://github.com/prestodb/presto/pull/14214#discussion_r395074132", "createdAt": "2020-03-19T14:36:57Z", "author": {"login": "rschlussel"}, "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/framework/VerificationContext.java", "diffHunk": "@@ -13,110 +13,220 @@\n  */\n package com.facebook.presto.verifier.framework;\n \n-import com.facebook.presto.verifier.event.DeterminismAnalysisRun;\n+import com.facebook.presto.jdbc.QueryStats;\n+import com.facebook.presto.verifier.event.DeterminismAnalysisDetails;\n import com.facebook.presto.verifier.event.QueryFailure;\n-import com.google.common.collect.ImmutableList;\n-import com.google.common.collect.ImmutableSet;\n+import com.facebook.presto.verifier.event.VerifierQueryEvent;\n \n+import java.util.HashSet;\n import java.util.List;\n import java.util.Optional;\n+import java.util.Set;\n \n-import static com.facebook.presto.verifier.framework.LimitQueryDeterminismAnalysis.NOT_RUN;\n import static com.google.common.base.Preconditions.checkState;\n import static com.google.common.collect.ImmutableList.toImmutableList;\n import static java.util.Objects.requireNonNull;\n \n public class VerificationContext", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1d1d10798fa97ac39fd98504a9d89e5cb65161b"}, "originalPosition": 22}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b1d1d10798fa97ac39fd98504a9d89e5cb65161b", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/b1d1d10798fa97ac39fd98504a9d89e5cb65161b", "committedDate": "2020-03-18T20:33:06Z", "message": "Restart verification if checksum queries complain table already exists\n\nWe're seeing test setup query, which creates the target table to\ninset, fails but the table was still created. Therefore, in case\nchecksum queries fail due to table already exists error, we can\nresubmit the verification to mitigate the transient error."}, "afterCommit": {"oid": "ae2f0a9c94d81d8b089a25f2424dd003a098b3f1", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/ae2f0a9c94d81d8b089a25f2424dd003a098b3f1", "committedDate": "2020-03-22T02:27:48Z", "message": "Restart verification if checksum queries fail with table already exists\n\nSetup queries create the target tables for INSERT verification.\nWe're seeing setup queries failing but the table was still created.\nTherefore, in case checksum queries fail due to table already exists\nerror, we can resubmit the verification to mitigate the transient\nerror."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ae2f0a9c94d81d8b089a25f2424dd003a098b3f1", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/ae2f0a9c94d81d8b089a25f2424dd003a098b3f1", "committedDate": "2020-03-22T02:27:48Z", "message": "Restart verification if checksum queries fail with table already exists\n\nSetup queries create the target tables for INSERT verification.\nWe're seeing setup queries failing but the table was still created.\nTherefore, in case checksum queries fail due to table already exists\nerror, we can resubmit the verification to mitigate the transient\nerror."}, "afterCommit": {"oid": "1f6d6d65fa2ac485f320c45c9fec2664adad54cd", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/1f6d6d65fa2ac485f320c45c9fec2664adad54cd", "committedDate": "2020-03-22T02:33:03Z", "message": "Restart verification if checksum queries fail with table already exists\n\nSetup queries create the target tables for INSERT verification.\nWe're seeing setup queries failing but the table was still created.\nTherefore, in case checksum queries fail due to table already exists\nerror, we can resubmit the verification to mitigate the transient\nerror."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1f6d6d65fa2ac485f320c45c9fec2664adad54cd", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/1f6d6d65fa2ac485f320c45c9fec2664adad54cd", "committedDate": "2020-03-22T02:33:03Z", "message": "Restart verification if checksum queries fail with table already exists\n\nSetup queries create the target tables for INSERT verification.\nWe're seeing setup queries failing but the table was still created.\nTherefore, in case checksum queries fail due to table already exists\nerror, we can resubmit the verification to mitigate the transient\nerror."}, "afterCommit": {"oid": "6fa37f0a785095a8fb0ce0fc57869ffb3460ae25", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/6fa37f0a785095a8fb0ce0fc57869ffb3460ae25", "committedDate": "2020-03-22T02:38:04Z", "message": "Restart verification if checksum queries fail with table already exists\n\nSetup queries create the target tables for INSERT verification.\nWe're seeing setup queries failing but the table was still created.\nTherefore, in case checksum queries fail due to table already exists\nerror, we can resubmit the verification to mitigate the transient\nerror."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6fa37f0a785095a8fb0ce0fc57869ffb3460ae25", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/6fa37f0a785095a8fb0ce0fc57869ffb3460ae25", "committedDate": "2020-03-22T02:38:04Z", "message": "Restart verification if checksum queries fail with table already exists\n\nSetup queries create the target tables for INSERT verification.\nWe're seeing setup queries failing but the table was still created.\nTherefore, in case checksum queries fail due to table already exists\nerror, we can resubmit the verification to mitigate the transient\nerror."}, "afterCommit": {"oid": "e2b74165fda5e54506a4059e70ed7da0f86678b2", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/e2b74165fda5e54506a4059e70ed7da0f86678b2", "committedDate": "2020-03-22T02:40:40Z", "message": "Restart verification if checksum queries fail with table already exists\n\nSetup queries create the target tables for INSERT verification.\nWe're seeing setup queries failing but the table was still created.\nTherefore, in case checksum queries fail due to table already exists\nerror, we can resubmit the verification to mitigate the transient\nerror."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e2b74165fda5e54506a4059e70ed7da0f86678b2", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/e2b74165fda5e54506a4059e70ed7da0f86678b2", "committedDate": "2020-03-22T02:40:40Z", "message": "Restart verification if checksum queries fail with table already exists\n\nSetup queries create the target tables for INSERT verification.\nWe're seeing setup queries failing but the table was still created.\nTherefore, in case checksum queries fail due to table already exists\nerror, we can resubmit the verification to mitigate the transient\nerror."}, "afterCommit": {"oid": "53277ac8e7fdc1634e0cb982219ccc4739328cfb", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/53277ac8e7fdc1634e0cb982219ccc4739328cfb", "committedDate": "2020-03-22T02:57:12Z", "message": "Restart verification if checksum queries fail with table already exists\n\nSetup queries create the target tables for INSERT verification.\nWe're seeing setup queries failing but the table was still created.\nTherefore, in case checksum queries fail due to table already exists\nerror, we can resubmit the verification to mitigate the transient\nerror."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "53277ac8e7fdc1634e0cb982219ccc4739328cfb", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/53277ac8e7fdc1634e0cb982219ccc4739328cfb", "committedDate": "2020-03-22T02:57:12Z", "message": "Restart verification if checksum queries fail with table already exists\n\nSetup queries create the target tables for INSERT verification.\nWe're seeing setup queries failing but the table was still created.\nTherefore, in case checksum queries fail due to table already exists\nerror, we can resubmit the verification to mitigate the transient\nerror."}, "afterCommit": {"oid": "dfd3c4deab07aca88d4ab3c60e3d5da10202bc07", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/dfd3c4deab07aca88d4ab3c60e3d5da10202bc07", "committedDate": "2020-03-23T22:41:19Z", "message": "Restart verification if checksum queries fail with table already exists\n\nSetup queries create the target tables for INSERT verification.\nWe're seeing setup queries failing but the table was still created.\nTherefore, in case checksum queries fail due to table already exists\nerror, we can resubmit the verification to mitigate the transient\nerror."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5ODUyMDA1", "url": "https://github.com/prestodb/presto/pull/14214#pullrequestreview-379852005", "createdAt": "2020-03-23T21:56:21Z", "commit": {"oid": "d2bc2d5a4e0af661d202a09c04a8bba0379303fb"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QyMTo1NjoyMlrOF6ZkzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxODoxNTo0MlrOF69PAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njc4MDc0OQ==", "bodyText": "I don't feel the toOptional change helps with readability. Optional.of()/Optional.ofNullable() is already pretty succinct, used frequently throughout the code base, and it's obvious what they do.  The helper function is slightly shorter, but then I need to spend time figuring out if there's custom logic as part of toOptional.", "url": "https://github.com/prestodb/presto/pull/14214#discussion_r396780749", "createdAt": "2020-03-23T21:56:22Z", "author": {"login": "rschlussel"}, "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/framework/AbstractVerification.java", "diffHunk": "@@ -109,144 +119,138 @@ public VerificationContext getVerificationContext()\n     public VerificationResult run()\n     {\n         boolean resultMismatched = false;\n-        QueryBundle control = null;\n-        QueryBundle test = null;\n-        MatchResult matchResult = null;\n-        Optional<DeterminismAnalysis> determinismAnalysis = Optional.empty();\n-\n-        QueryStats controlQueryStats = null;\n-        QueryStats testQueryStats = null;\n \n+        AtomicReference<QueryBundle> control = new AtomicReference<>();\n+        AtomicReference<QueryBundle> test = new AtomicReference<>();\n+        AtomicReference<QueryStats> controlStats = new AtomicReference<>();\n+        AtomicReference<QueryStats> testStats = new AtomicReference<>();\n+        AtomicReference<QueryState> controlState = new AtomicReference<>(NOT_RUN);\n+        AtomicReference<QueryState> testState = new AtomicReference<>(NOT_RUN);\n         ChecksumQueryContext controlChecksumQueryContext = new ChecksumQueryContext();\n         ChecksumQueryContext testChecksumQueryContext = new ChecksumQueryContext();\n+        Optional<MatchResult> matchResult = Optional.empty();\n+        Optional<DeterminismAnalysis> determinismAnalysis = Optional.empty();\n         DeterminismAnalysisDetails.Builder determinismAnalysisDetails = DeterminismAnalysisDetails.builder();\n \n         try {\n-            control = queryRewriter.rewriteQuery(sourceQuery.getControlQuery(), CONTROL);\n-            test = queryRewriter.rewriteQuery(sourceQuery.getTestQuery(), TEST);\n-            controlQueryStats = DataVerificationUtil.setupAndRun(prestoAction, control, false);\n-            testQueryStats = DataVerificationUtil.setupAndRun(prestoAction, test, false);\n-            matchResult = verify(control, test, controlChecksumQueryContext, testChecksumQueryContext);\n-\n-            if (matchResult.isMismatchPossiblyCausedByNonDeterminism()) {\n-                determinismAnalysis = Optional.of(determinismAnalyzer.analyze(control, matchResult.getControlChecksum(), determinismAnalysisDetails));\n+            // Rewrite queries\n+            control.set(queryRewriter.rewriteQuery(sourceQuery.getControlQuery(), CONTROL));\n+            test.set(queryRewriter.rewriteQuery(sourceQuery.getTestQuery(), TEST));\n+\n+            // Run queries\n+            runAndConsume(\n+                    () -> setupAndRun(prestoAction, control.get(), false),\n+                    controlStats::set,\n+                    e -> controlState.set(getFailingQueryState(e)));\n+            controlState.set(QueryState.SUCCEEDED);\n+            runAndConsume(\n+                    () -> setupAndRun(prestoAction, test.get(), false),\n+                    testStats::set,\n+                    e -> testState.set(getFailingQueryState(e)));\n+            testState.set(QueryState.SUCCEEDED);\n+\n+            // Verify results\n+            matchResult = Optional.of(verify(control.get(), test.get(), controlChecksumQueryContext, testChecksumQueryContext));\n+\n+            // Determinism analysis\n+            if (matchResult.get().isMismatchPossiblyCausedByNonDeterminism()) {\n+                determinismAnalysis = Optional.of(determinismAnalyzer.analyze(control.get(), matchResult.get().getControlChecksum(), determinismAnalysisDetails));\n             }\n             boolean maybeDeterministic = !determinismAnalysis.isPresent() ||\n                     determinismAnalysis.get().isDeterministic() ||\n                     determinismAnalysis.get().isUnknown();\n-            resultMismatched = maybeDeterministic && !matchResult.isMatched();\n+            resultMismatched = maybeDeterministic && !matchResult.get().isMatched();\n \n             return concludeVerification(\n-                    Optional.of(control),\n-                    Optional.of(test),\n-                    Optional.ofNullable(controlQueryStats),\n-                    Optional.ofNullable(testQueryStats),\n-                    Optional.empty(),\n-                    Optional.of(matchResult),\n+                    toOptional(control),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2bc2d5a4e0af661d202a09c04a8bba0379303fb"}, "originalPosition": 111}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM1NTgwNw==", "bodyText": "What's the purpose of using AtomicReferences?", "url": "https://github.com/prestodb/presto/pull/14214#discussion_r397355807", "createdAt": "2020-03-24T18:00:45Z", "author": {"login": "rschlussel"}, "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/framework/AbstractVerification.java", "diffHunk": "@@ -109,144 +119,138 @@ public VerificationContext getVerificationContext()\n     public VerificationResult run()\n     {\n         boolean resultMismatched = false;\n-        QueryBundle control = null;\n-        QueryBundle test = null;\n-        MatchResult matchResult = null;\n-        Optional<DeterminismAnalysis> determinismAnalysis = Optional.empty();\n-\n-        QueryStats controlQueryStats = null;\n-        QueryStats testQueryStats = null;\n \n+        AtomicReference<QueryBundle> control = new AtomicReference<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f214145c10fd320421da86474a9027ad7f93e94d"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM2NDk5NQ==", "bodyText": "Does this test that covers the case that was failing before?  Or if not, is there a test that does?", "url": "https://github.com/prestodb/presto/pull/14214#discussion_r397364995", "createdAt": "2020-03-24T18:15:42Z", "author": {"login": "rschlussel"}, "path": "presto-verifier/src/test/java/com/facebook/presto/verifier/framework/TestVerificationManager.java", "diffHunk": "@@ -131,30 +131,23 @@ public void setup()\n     }\n \n     @Test\n-    public void testFailureRequeued()\n+    public void testFailureResubmitted()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ce164e93158d2316342c8372634cecfc535346d"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dfd3c4deab07aca88d4ab3c60e3d5da10202bc07", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/dfd3c4deab07aca88d4ab3c60e3d5da10202bc07", "committedDate": "2020-03-23T22:41:19Z", "message": "Restart verification if checksum queries fail with table already exists\n\nSetup queries create the target tables for INSERT verification.\nWe're seeing setup queries failing but the table was still created.\nTherefore, in case checksum queries fail due to table already exists\nerror, we can resubmit the verification to mitigate the transient\nerror."}, "afterCommit": {"oid": "62b8d2f7a2eb2015ac884bb9f2294e6a445a1a2f", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/62b8d2f7a2eb2015ac884bb9f2294e6a445a1a2f", "committedDate": "2020-03-24T23:38:37Z", "message": "Restart verification if checksum queries fail with table already exists\n\nSetup queries create the target tables for INSERT verification.\nWe're seeing setup queries failing but the table was still created.\nTherefore, in case checksum queries fail due to table already exists\nerror, we can resubmit the verification to mitigate the transient\nerror."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6698f35e4b5a63091c18c290796bd43520d0ae0b", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/6698f35e4b5a63091c18c290796bd43520d0ae0b", "committedDate": "2020-03-27T19:27:34Z", "message": "Improve VerificationContext\n\n- Remove determinismAnalysisDetails from VerificationContext. Use\n  the builder directly.\n- Move check query info to a separate class.\n- Use Optional fields instead of nullable fields.\n- Move getters and setters of DeterminismAnalysisDetails fields into\n  a builder."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "62b8d2f7a2eb2015ac884bb9f2294e6a445a1a2f", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/62b8d2f7a2eb2015ac884bb9f2294e6a445a1a2f", "committedDate": "2020-03-24T23:38:37Z", "message": "Restart verification if checksum queries fail with table already exists\n\nSetup queries create the target tables for INSERT verification.\nWe're seeing setup queries failing but the table was still created.\nTherefore, in case checksum queries fail due to table already exists\nerror, we can resubmit the verification to mitigate the transient\nerror."}, "afterCommit": {"oid": "eded1ecea12d3370d7ba97a4fbbeed84062c0a5c", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/eded1ecea12d3370d7ba97a4fbbeed84062c0a5c", "committedDate": "2020-03-27T19:27:34Z", "message": "Restart verification if checksum queries fail with table already exists\n\nSetup queries create the target tables for INSERT verification.\nWe're seeing setup queries failing but the table was still created.\nTherefore, in case checksum queries fail due to table already exists\nerror, we can resubmit the verification to mitigate the transient\nerror."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0670311df05b3e589e23999c042f55d33c476b0a", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/0670311df05b3e589e23999c042f55d33c476b0a", "committedDate": "2020-03-27T19:42:13Z", "message": "Fix verification resubmission\n\nVerificationContext contains fields that can be set only once. When\nverification is resubmitted, Verification#run method is called again\non the same object, and in turn, the setters will be called again\nin the new run and throws, potentially causing resubmission to fail.\n\nBreak the circular dependency between DataVerification and\nVerificationManager by performing the actual resubmission in\nVerificationManager.\n\nAdd resubmission count to VerificationContext, each Verification\nmaintains its resubmission count instead of requiring\nVerificationManager to keep track.\n\nAlso, export the resubmission count in the output event."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eded1ecea12d3370d7ba97a4fbbeed84062c0a5c", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/eded1ecea12d3370d7ba97a4fbbeed84062c0a5c", "committedDate": "2020-03-27T19:27:34Z", "message": "Restart verification if checksum queries fail with table already exists\n\nSetup queries create the target tables for INSERT verification.\nWe're seeing setup queries failing but the table was still created.\nTherefore, in case checksum queries fail due to table already exists\nerror, we can resubmit the verification to mitigate the transient\nerror."}, "afterCommit": {"oid": "65d8935c5b1ab20457a1e04c224106b4f5ae6be8", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/65d8935c5b1ab20457a1e04c224106b4f5ae6be8", "committedDate": "2020-03-27T19:42:14Z", "message": "Restart verification if checksum queries fail with table already exists\n\nSetup queries create the target tables for INSERT verification.\nWe're seeing setup queries failing but the table was still created.\nTherefore, in case checksum queries fail due to table already exists\nerror, we can resubmit the verification to mitigate the transient\nerror."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "65d8935c5b1ab20457a1e04c224106b4f5ae6be8", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/65d8935c5b1ab20457a1e04c224106b4f5ae6be8", "committedDate": "2020-03-27T19:42:14Z", "message": "Restart verification if checksum queries fail with table already exists\n\nSetup queries create the target tables for INSERT verification.\nWe're seeing setup queries failing but the table was still created.\nTherefore, in case checksum queries fail due to table already exists\nerror, we can resubmit the verification to mitigate the transient\nerror."}, "afterCommit": {"oid": "5b38d11194cedaccca109fc59a5b89c469412dce", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/5b38d11194cedaccca109fc59a5b89c469412dce", "committedDate": "2020-03-27T22:16:06Z", "message": "Restart verification if checksum queries fail with table already exists\n\nSetup queries create the target tables for INSERT verification.\nWe're seeing setup queries failing but the table was still created.\nTherefore, in case checksum queries fail due to table already exists\nerror, we can resubmit the verification to mitigate the transient\nerror."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5b38d11194cedaccca109fc59a5b89c469412dce", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/5b38d11194cedaccca109fc59a5b89c469412dce", "committedDate": "2020-03-27T22:16:06Z", "message": "Restart verification if checksum queries fail with table already exists\n\nSetup queries create the target tables for INSERT verification.\nWe're seeing setup queries failing but the table was still created.\nTherefore, in case checksum queries fail due to table already exists\nerror, we can resubmit the verification to mitigate the transient\nerror."}, "afterCommit": {"oid": "2d8d2ab95af3b4942b09c9874b3a9ebcbece434b", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/2d8d2ab95af3b4942b09c9874b3a9ebcbece434b", "committedDate": "2020-03-30T04:12:37Z", "message": "Restart verification if checksum queries fail with table already exist\n\nSetup queries create the target tables for INSERT verification.\nWe're seeing setup queries failing but the table was still created.\nTherefore, in case checksum queries fail due to table already exists\nerror, we can resubmit the verification to mitigate the transient\nerror."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2d8d2ab95af3b4942b09c9874b3a9ebcbece434b", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/2d8d2ab95af3b4942b09c9874b3a9ebcbece434b", "committedDate": "2020-03-30T04:12:37Z", "message": "Restart verification if checksum queries fail with table already exist\n\nSetup queries create the target tables for INSERT verification.\nWe're seeing setup queries failing but the table was still created.\nTherefore, in case checksum queries fail due to table already exists\nerror, we can resubmit the verification to mitigate the transient\nerror."}, "afterCommit": {"oid": "e8abba52fed701710e33dd6d81b1bd7c568f1e3f", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/e8abba52fed701710e33dd6d81b1bd7c568f1e3f", "committedDate": "2020-03-30T04:12:48Z", "message": "Restart verification if checksum queries fail with table already exists\n\nSetup queries create the target tables for INSERT verification.\nWe're seeing setup queries failing but the table was still created.\nTherefore, in case checksum queries fail due to table already exists\nerror, we can resubmit the verification to mitigate the transient\nerror."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5bf83b54549048403ae4468ab759914c1415ece9", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/5bf83b54549048403ae4468ab759914c1415ece9", "committedDate": "2020-03-30T23:13:04Z", "message": "Improve readability in AbstractVerification\n\nRemove the nullable variables.\nRemove FAILED_TO_TEARDOWN from QueryState since it is a impossible\nstate."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8963e88c1bfb819d095d35c963e12306501ed345", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/8963e88c1bfb819d095d35c963e12306501ed345", "committedDate": "2020-03-30T23:13:05Z", "message": "Expose unexpected exceptions in Verifier\n\nPreviously, Verifier silently ignores exceptions that are not\nQueryException, as they're only loggged but not VerifierQueryEvent\nis exported.\n\nHandle general exception properly so that they can be uncovered and\ninvestigated. Mark them as SKIPPED so that they do cause noise."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3276ae4c858af603bd5efdf9b00aca85ae8231b8", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/3276ae4c858af603bd5efdf9b00aca85ae8231b8", "committedDate": "2020-03-30T23:13:07Z", "message": "Fix AbstractTestVerifierIntegrationSmokeTest\n\nThe test merely tests injection and continue to succeed even when\nthere are verification failures. Add assertions that the testing\nverification are succeded.\n\nAlso, add missing configuration properties that caused verifications\nin the integration test to fail."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba96c132b76cb033616af727025b871130238741", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/ba96c132b76cb033616af727025b871130238741", "committedDate": "2020-03-30T23:13:08Z", "message": "Improve teardown skipping\n\nReplace run-teardown-on-result-mismatch with smart-teardown, which\nskips teardown in case control and test queries succeeds but\nverification fails.\n\nThis allows result tables to be perserved in cases like checksum\nquery failures, to ease debugging and investigation."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e8abba52fed701710e33dd6d81b1bd7c568f1e3f", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/e8abba52fed701710e33dd6d81b1bd7c568f1e3f", "committedDate": "2020-03-30T04:12:48Z", "message": "Restart verification if checksum queries fail with table already exists\n\nSetup queries create the target tables for INSERT verification.\nWe're seeing setup queries failing but the table was still created.\nTherefore, in case checksum queries fail due to table already exists\nerror, we can resubmit the verification to mitigate the transient\nerror."}, "afterCommit": {"oid": "09da0b57884f8e26407150cd65a13907c1143201", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/09da0b57884f8e26407150cd65a13907c1143201", "committedDate": "2020-03-30T23:13:09Z", "message": "Restart verification if checksum queries fail with table already exists\n\nSetup queries create the target tables for INSERT verification.\nWe're seeing setup queries failing but the table was still created.\nTherefore, in case checksum queries fail due to table already exists\nerror, we can resubmit the verification to mitigate the transient\nerror."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6001b129d26b6245436b1f0f5e271212b7273182", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/6001b129d26b6245436b1f0f5e271212b7273182", "committedDate": "2020-03-31T03:39:32Z", "message": "Restart verification if checksum queries fail with table already exists\n\nSetup queries create the target tables for INSERT verification.\nWe're seeing setup queries failing but the table was still created.\nTherefore, in case checksum queries fail due to the table already\nexists error, we can resubmit the verification to mitigate the\ntransient error."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "09da0b57884f8e26407150cd65a13907c1143201", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/09da0b57884f8e26407150cd65a13907c1143201", "committedDate": "2020-03-30T23:13:09Z", "message": "Restart verification if checksum queries fail with table already exists\n\nSetup queries create the target tables for INSERT verification.\nWe're seeing setup queries failing but the table was still created.\nTherefore, in case checksum queries fail due to table already exists\nerror, we can resubmit the verification to mitigate the transient\nerror."}, "afterCommit": {"oid": "6001b129d26b6245436b1f0f5e271212b7273182", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/6001b129d26b6245436b1f0f5e271212b7273182", "committedDate": "2020-03-31T03:39:32Z", "message": "Restart verification if checksum queries fail with table already exists\n\nSetup queries create the target tables for INSERT verification.\nWe're seeing setup queries failing but the table was still created.\nTherefore, in case checksum queries fail due to the table already\nexists error, we can resubmit the verification to mitigate the\ntransient error."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0ODY0MDIw", "url": "https://github.com/prestodb/presto/pull/14214#pullrequestreview-384864020", "createdAt": "2020-03-31T15:43:02Z", "commit": {"oid": "6001b129d26b6245436b1f0f5e271212b7273182"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1988, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}