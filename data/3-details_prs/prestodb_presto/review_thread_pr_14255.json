{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg5NDc2ODU5", "number": 14255, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQyMzowMToyN1rODoh2Gw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QyMDo1NTowN1rODvvO0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzODI0MTU1OnYy", "diffSide": "RIGHT", "path": "presto-function-namespace-managers/src/main/java/com/facebook/presto/functionNamespace/mysql/FunctionNamespaceDao.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQyMzowMToyN1rOF3Ik7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQyMzozNTo1MFrOF3JTmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM1NjUyNA==", "bodyText": "text are stored in separate pages form the table so moving this to text effectively adds an additional page load to each row. Overall text type is very inefficient. I think this is an overkill as a solution to support large parameters. Most of the functions would have a small parameter list. I suggest to use encoding rather than just dump everything blindly into a blob.", "url": "https://github.com/prestodb/presto/pull/14255#discussion_r393356524", "createdAt": "2020-03-16T23:01:27Z", "author": {"login": "rongrong"}, "path": "presto-function-namespace-managers/src/main/java/com/facebook/presto/functionNamespace/mysql/FunctionNamespaceDao.java", "diffHunk": "@@ -51,13 +51,14 @@\n \n     @SqlUpdate(\"CREATE TABLE IF NOT EXISTS <sql_functions_table> (\\n\" +\n             \"  id bigint(20) NOT NULL AUTO_INCREMENT,\\n\" +\n-            \"  function_id varchar(700) NOT NULL,\\n\" +\n+            \"  function_id_hash varchar(128) NOT NULL,\\n\" +\n+            \"  function_id text NOT NULL,\\n\" +\n             \"  version bigint(20) unsigned NOT NULL,\\n\" +\n             \"  catalog_name varchar(128) NOT NULL,\\n\" +\n             \"  schema_name varchar(128) NOT NULL,\\n\" +\n             \"  function_name varchar(256) NOT NULL,\\n\" +\n-            \"  parameters varchar(40000) NOT NULL,\\n\" +\n-            \"  return_type varchar(256) NOT NULL,\\n\" +\n+            \"  parameters mediumtext NOT NULL,\\n\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38f6b5f5190c7805138fe4e8ea2db4092a1af6e7"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM2NDY5Nw==", "bodyText": "Can you elaborate the encoding you are mentioning. What does it mean? Do you mean String compression, or a more efficient encoding such as binary?\nCurrently, we're already using \"encoding\" - JSON encoding. What are the other types of encoding that we can use to reduce the size of this field while avoid using text? Are there any standard out there? For example, I can think thrift binary encoding as an alternative, but that will require a schema IDL to be kept elsewhere, which is not convenient. Also, only applications will be able to read the data, making debugging and human inspection difficult.\nIt's unclear to me what encoding can be used and if there is guaranteed size shrink that can be achieved by using that. Also, please note that each MySQL table row has a max size of 65536 bytes. Potentially, if we avoid text by using large columns, say varchar(15000), that will limit the number of those large varchar column we can support.\nI would say that the performance increase in using text is very minimal since all of our queries are backed by index. Point reads are instantaneous and have minimal cost. The only feature that requires reading a lot of rows is listFunctions, in which reads will still be instantaneous when we have less than 10^5 records, which is still sufficient in the vast majority of the use cases.\nThere is always a limit for any systems, I would say MySQL-back Function Namespace Manager would not be a right tool to use, not just for this particular column, if we have more than, say 10^7 records.", "url": "https://github.com/prestodb/presto/pull/14255#discussion_r393364697", "createdAt": "2020-03-16T23:21:56Z", "author": {"login": "caithagoras"}, "path": "presto-function-namespace-managers/src/main/java/com/facebook/presto/functionNamespace/mysql/FunctionNamespaceDao.java", "diffHunk": "@@ -51,13 +51,14 @@\n \n     @SqlUpdate(\"CREATE TABLE IF NOT EXISTS <sql_functions_table> (\\n\" +\n             \"  id bigint(20) NOT NULL AUTO_INCREMENT,\\n\" +\n-            \"  function_id varchar(700) NOT NULL,\\n\" +\n+            \"  function_id_hash varchar(128) NOT NULL,\\n\" +\n+            \"  function_id text NOT NULL,\\n\" +\n             \"  version bigint(20) unsigned NOT NULL,\\n\" +\n             \"  catalog_name varchar(128) NOT NULL,\\n\" +\n             \"  schema_name varchar(128) NOT NULL,\\n\" +\n             \"  function_name varchar(256) NOT NULL,\\n\" +\n-            \"  parameters varchar(40000) NOT NULL,\\n\" +\n-            \"  return_type varchar(256) NOT NULL,\\n\" +\n+            \"  parameters mediumtext NOT NULL,\\n\" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM1NjUyNA=="}, "originalCommit": {"oid": "38f6b5f5190c7805138fe4e8ea2db4092a1af6e7"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM2ODQ3NA==", "bodyText": "It's not about encoding. It's more about InnoDB internals. Let's chat over VC. I can give you a 101 on Innodb. \ud83d\ude02", "url": "https://github.com/prestodb/presto/pull/14255#discussion_r393368474", "createdAt": "2020-03-16T23:35:50Z", "author": {"login": "rongrong"}, "path": "presto-function-namespace-managers/src/main/java/com/facebook/presto/functionNamespace/mysql/FunctionNamespaceDao.java", "diffHunk": "@@ -51,13 +51,14 @@\n \n     @SqlUpdate(\"CREATE TABLE IF NOT EXISTS <sql_functions_table> (\\n\" +\n             \"  id bigint(20) NOT NULL AUTO_INCREMENT,\\n\" +\n-            \"  function_id varchar(700) NOT NULL,\\n\" +\n+            \"  function_id_hash varchar(128) NOT NULL,\\n\" +\n+            \"  function_id text NOT NULL,\\n\" +\n             \"  version bigint(20) unsigned NOT NULL,\\n\" +\n             \"  catalog_name varchar(128) NOT NULL,\\n\" +\n             \"  schema_name varchar(128) NOT NULL,\\n\" +\n             \"  function_name varchar(256) NOT NULL,\\n\" +\n-            \"  parameters varchar(40000) NOT NULL,\\n\" +\n-            \"  return_type varchar(256) NOT NULL,\\n\" +\n+            \"  parameters mediumtext NOT NULL,\\n\" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM1NjUyNA=="}, "originalCommit": {"oid": "38f6b5f5190c7805138fe4e8ea2db4092a1af6e7"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzODI0NjA0OnYy", "diffSide": "RIGHT", "path": "presto-function-namespace-managers/src/main/java/com/facebook/presto/functionNamespace/mysql/FunctionNamespaceDao.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQyMzowMjozNlrOF3In5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQyMzozNDowOVrOF3JR1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM1NzI4NA==", "bodyText": "Since this is a hash, what if there's collision?", "url": "https://github.com/prestodb/presto/pull/14255#discussion_r393357284", "createdAt": "2020-03-16T23:02:36Z", "author": {"login": "rongrong"}, "path": "presto-function-namespace-managers/src/main/java/com/facebook/presto/functionNamespace/mysql/FunctionNamespaceDao.java", "diffHunk": "@@ -66,7 +67,7 @@\n             \"  create_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\\n\" +\n             \"  update_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\\n\" +\n             \"  PRIMARY KEY (id),\\n\" +\n-            \"  UNIQUE KEY function_id_version (function_id, version),\\n\" +\n+            \"  UNIQUE KEY function_id_hash_version (function_id_hash, version),\\n\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38f6b5f5190c7805138fe4e8ea2db4092a1af6e7"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM2ODAyMA==", "bodyText": "Writes would fail with a chance of 2^(-256), or 1e-77, which is just 0. User can modify any parts of the function (name, parameter name) to avoid collision.", "url": "https://github.com/prestodb/presto/pull/14255#discussion_r393368020", "createdAt": "2020-03-16T23:34:09Z", "author": {"login": "caithagoras"}, "path": "presto-function-namespace-managers/src/main/java/com/facebook/presto/functionNamespace/mysql/FunctionNamespaceDao.java", "diffHunk": "@@ -66,7 +67,7 @@\n             \"  create_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\\n\" +\n             \"  update_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\\n\" +\n             \"  PRIMARY KEY (id),\\n\" +\n-            \"  UNIQUE KEY function_id_version (function_id, version),\\n\" +\n+            \"  UNIQUE KEY function_id_hash_version (function_id_hash, version),\\n\" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM1NzI4NA=="}, "originalCommit": {"oid": "38f6b5f5190c7805138fe4e8ea2db4092a1af6e7"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzODM0NTYzOnYy", "diffSide": "RIGHT", "path": "presto-function-namespace-managers/src/main/java/com/facebook/presto/functionNamespace/mysql/MySqlFunctionNamespaceManager.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQyMzo1MToyOFrOF3JkiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQyMzo1ODoxNFrOF3Jr4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM3MjgwOQ==", "bodyText": "This is a potential security loophole. I can potentially modify other people's function if I manage to come up with a signature with the same hash right? There at least needs to be some verification that the function you get is the function you actually want to get?", "url": "https://github.com/prestodb/presto/pull/14255#discussion_r393372809", "createdAt": "2020-03-16T23:51:28Z", "author": {"login": "rongrong"}, "path": "presto-function-namespace-managers/src/main/java/com/facebook/presto/functionNamespace/mysql/MySqlFunctionNamespaceManager.java", "diffHunk": "@@ -149,7 +151,7 @@ public void createFunction(SqlInvokedFunction function, boolean replace)\n \n         jdbi.useTransaction(handle -> {\n             FunctionNamespaceDao transactionDao = handle.attach(FunctionNamespaceDao.class);\n-            Optional<SqlInvokedFunctionRecord> latestVersion = transactionDao.getLatestRecordForUpdate(function.getFunctionId());\n+            Optional<SqlInvokedFunctionRecord> latestVersion = transactionDao.getLatestRecordForUpdate(hash(function.getFunctionId()), function.getFunctionId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea2e41904aad945184b3d13779f1e7f1e1ccd9a5"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM3NDY5MA==", "bodyText": "Both the hash of a function id and the function id itself are passed in. The DAO query still require both function id hash and function id to match. You won't be able to modify that function even if you come up with a function id with the exact same hash.", "url": "https://github.com/prestodb/presto/pull/14255#discussion_r393374690", "createdAt": "2020-03-16T23:58:14Z", "author": {"login": "caithagoras"}, "path": "presto-function-namespace-managers/src/main/java/com/facebook/presto/functionNamespace/mysql/MySqlFunctionNamespaceManager.java", "diffHunk": "@@ -149,7 +151,7 @@ public void createFunction(SqlInvokedFunction function, boolean replace)\n \n         jdbi.useTransaction(handle -> {\n             FunctionNamespaceDao transactionDao = handle.attach(FunctionNamespaceDao.class);\n-            Optional<SqlInvokedFunctionRecord> latestVersion = transactionDao.getLatestRecordForUpdate(function.getFunctionId());\n+            Optional<SqlInvokedFunctionRecord> latestVersion = transactionDao.getLatestRecordForUpdate(hash(function.getFunctionId()), function.getFunctionId());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM3MjgwOQ=="}, "originalCommit": {"oid": "ea2e41904aad945184b3d13779f1e7f1e1ccd9a5"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2NDM3MjY4OnYy", "diffSide": "RIGHT", "path": "presto-function-namespace-managers/src/main/java/com/facebook/presto/functionNamespace/mysql/FunctionNamespaceDao.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwMDoyODozOFrOF7ICdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QyMDo1NDowOVrOGCVuow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU0MjAwNA==", "bodyText": "Why do we need this?", "url": "https://github.com/prestodb/presto/pull/14255#discussion_r397542004", "createdAt": "2020-03-25T00:28:38Z", "author": {"login": "rongrong"}, "path": "presto-function-namespace-managers/src/main/java/com/facebook/presto/functionNamespace/mysql/FunctionNamespaceDao.java", "diffHunk": "@@ -44,13 +44,15 @@\n public interface FunctionNamespaceDao\n {\n     @SqlUpdate(\"CREATE TABLE IF NOT EXISTS <function_namespaces_table> (\\n\" +\n+            \"   id int(11) unsigned NOT NULL AUTO_INCREMENT,\\n\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed0b70bc1e4af588aa29546da65a70698c83432b"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU2MDQzNQ==", "bodyText": "Removed", "url": "https://github.com/prestodb/presto/pull/14255#discussion_r397560435", "createdAt": "2020-03-25T01:34:38Z", "author": {"login": "caithagoras"}, "path": "presto-function-namespace-managers/src/main/java/com/facebook/presto/functionNamespace/mysql/FunctionNamespaceDao.java", "diffHunk": "@@ -44,13 +44,15 @@\n public interface FunctionNamespaceDao\n {\n     @SqlUpdate(\"CREATE TABLE IF NOT EXISTS <function_namespaces_table> (\\n\" +\n+            \"   id int(11) unsigned NOT NULL AUTO_INCREMENT,\\n\" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU0MjAwNA=="}, "originalCommit": {"oid": "ed0b70bc1e4af588aa29546da65a70698c83432b"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTEwNjMzOQ==", "bodyText": "If you remove this, please also remove the primary key.", "url": "https://github.com/prestodb/presto/pull/14255#discussion_r405106339", "createdAt": "2020-04-07T20:54:09Z", "author": {"login": "rongrong"}, "path": "presto-function-namespace-managers/src/main/java/com/facebook/presto/functionNamespace/mysql/FunctionNamespaceDao.java", "diffHunk": "@@ -44,13 +44,15 @@\n public interface FunctionNamespaceDao\n {\n     @SqlUpdate(\"CREATE TABLE IF NOT EXISTS <function_namespaces_table> (\\n\" +\n+            \"   id int(11) unsigned NOT NULL AUTO_INCREMENT,\\n\" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU0MjAwNA=="}, "originalCommit": {"oid": "ed0b70bc1e4af588aa29546da65a70698c83432b"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2NDM3NTUxOnYy", "diffSide": "RIGHT", "path": "presto-function-namespace-managers/src/main/java/com/facebook/presto/functionNamespace/mysql/FunctionNamespaceDao.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwMDozMDowNVrOF7IEFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwMTozMToxOFrOF7JGmw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU0MjQyMQ==", "bodyText": "Why not require these to be NOT NULL?", "url": "https://github.com/prestodb/presto/pull/14255#discussion_r397542421", "createdAt": "2020-03-25T00:30:05Z", "author": {"login": "rongrong"}, "path": "presto-function-namespace-managers/src/main/java/com/facebook/presto/functionNamespace/mysql/FunctionNamespaceDao.java", "diffHunk": "@@ -64,8 +66,8 @@\n             \"  description text,\\n\" +\n             \"  deleted boolean NOT NULL DEFAULT false,\\n\" +\n             \"  delete_time TIMESTAMP NULL DEFAULT NULL,\\n\" +\n-            \"  create_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\\n\" +\n-            \"  update_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\\n\" +\n+            \"  create_time TIMESTAMP NULL DEFAULT CURRENT_TIMESTAMP,\\n\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed0b70bc1e4af588aa29546da65a70698c83432b"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU1OTQ1MQ==", "bodyText": "Insert null to a non-null timestamp column is valid in MySQL, and MySQL stores 0000:00:00 00:00:00 into the column, which is a dangerous behavior and the MySQL team advices against that.", "url": "https://github.com/prestodb/presto/pull/14255#discussion_r397559451", "createdAt": "2020-03-25T01:31:18Z", "author": {"login": "caithagoras"}, "path": "presto-function-namespace-managers/src/main/java/com/facebook/presto/functionNamespace/mysql/FunctionNamespaceDao.java", "diffHunk": "@@ -64,8 +66,8 @@\n             \"  description text,\\n\" +\n             \"  deleted boolean NOT NULL DEFAULT false,\\n\" +\n             \"  delete_time TIMESTAMP NULL DEFAULT NULL,\\n\" +\n-            \"  create_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\\n\" +\n-            \"  update_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\\n\" +\n+            \"  create_time TIMESTAMP NULL DEFAULT CURRENT_TIMESTAMP,\\n\" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU0MjQyMQ=="}, "originalCommit": {"oid": "ed0b70bc1e4af588aa29546da65a70698c83432b"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2NDM4NDg2OnYy", "diffSide": "RIGHT", "path": "presto-function-namespace-managers/src/main/java/com/facebook/presto/functionNamespace/mysql/MySqlFunctionNamespaceManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwMDozNDo1OVrOF7IJfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMzo0ODowMFrOGBt9qg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU0MzgwNA==", "bodyText": "You can just use text rather than medium text if this is the upper limit?", "url": "https://github.com/prestodb/presto/pull/14255#discussion_r397543804", "createdAt": "2020-03-25T00:34:59Z", "author": {"login": "rongrong"}, "path": "presto-function-namespace-managers/src/main/java/com/facebook/presto/functionNamespace/mysql/MySqlFunctionNamespaceManager.java", "diffHunk": "@@ -57,8 +59,8 @@\n     private static final int MAX_CATALOG_NAME_LENGTH = 128;\n     private static final int MAX_SCHEMA_NAME_LENGTH = 128;\n     private static final int MAX_FUNCTION_NAME_LENGTH = 256;\n-    private static final int MAX_PARAMETER_TYPES_LENGTH = 500;\n-    private static final int MAX_RETURN_TYPE_LENGTH = 256;\n+    private static final int MAX_PARAMETER_TYPES_LENGTH = 20000;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8dfba0c0862912c2a1d836f2caeb60a285440d9b"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ1NDgyNg==", "bodyText": "The max length is for the parameter type list, while the mediumtext is for parameters, which has a greater length than the parameter type list.\nFor example, for a parameter type list int,varchar, the parameter may be:\n[ {\n  \"name\" : \"p1\",\n  \"type\" : \"int\"\n}, {\n  \"name\" : \"p2\",\n  \"type\" : \"varchar\"\n} ]\n\nThe 1) length of the parameter names, 2) the number of parameters, 3) the JSON-encoding characters may expand the total size.\nI think we should also place limits on the parameter name length and the parameter counts. That can help us maintain the total length of parameters within text, although only by a small margin.", "url": "https://github.com/prestodb/presto/pull/14255#discussion_r404454826", "createdAt": "2020-04-06T23:48:00Z", "author": {"login": "caithagoras"}, "path": "presto-function-namespace-managers/src/main/java/com/facebook/presto/functionNamespace/mysql/MySqlFunctionNamespaceManager.java", "diffHunk": "@@ -57,8 +59,8 @@\n     private static final int MAX_CATALOG_NAME_LENGTH = 128;\n     private static final int MAX_SCHEMA_NAME_LENGTH = 128;\n     private static final int MAX_FUNCTION_NAME_LENGTH = 256;\n-    private static final int MAX_PARAMETER_TYPES_LENGTH = 500;\n-    private static final int MAX_RETURN_TYPE_LENGTH = 256;\n+    private static final int MAX_PARAMETER_TYPES_LENGTH = 20000;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU0MzgwNA=="}, "originalCommit": {"oid": "8dfba0c0862912c2a1d836f2caeb60a285440d9b"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2NDM5MTE3OnYy", "diffSide": "RIGHT", "path": "presto-function-namespace-managers/src/main/java/com/facebook/presto/functionNamespace/mysql/FunctionNamespaceDao.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwMDozODoyNlrOF7INKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QyMjo1NzoyNVrOGCZGew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU0NDc0Ng==", "bodyText": "At this point i think if you store parameters as separate list of name and list of type you can remove function_id. This is just a waste of storage space. You can argue who cares about it it's not that much resource anyways. So I won't insist.", "url": "https://github.com/prestodb/presto/pull/14255#discussion_r397544746", "createdAt": "2020-03-25T00:38:26Z", "author": {"login": "rongrong"}, "path": "presto-function-namespace-managers/src/main/java/com/facebook/presto/functionNamespace/mysql/FunctionNamespaceDao.java", "diffHunk": "@@ -51,13 +51,14 @@\n \n     @SqlUpdate(\"CREATE TABLE IF NOT EXISTS <sql_functions_table> (\\n\" +\n             \"  id bigint(20) NOT NULL AUTO_INCREMENT,\\n\" +\n-            \"  function_id varchar(700) NOT NULL,\\n\" +\n+            \"  function_id_hash varchar(128) NOT NULL,\\n\" +\n+            \"  function_id text NOT NULL,\\n\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8dfba0c0862912c2a1d836f2caeb60a285440d9b"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ1MDI3NQ==", "bodyText": "Sure, I can do that separately. Let's work on merging this fix first. Thanks!", "url": "https://github.com/prestodb/presto/pull/14255#discussion_r404450275", "createdAt": "2020-04-06T23:33:59Z", "author": {"login": "caithagoras"}, "path": "presto-function-namespace-managers/src/main/java/com/facebook/presto/functionNamespace/mysql/FunctionNamespaceDao.java", "diffHunk": "@@ -51,13 +51,14 @@\n \n     @SqlUpdate(\"CREATE TABLE IF NOT EXISTS <sql_functions_table> (\\n\" +\n             \"  id bigint(20) NOT NULL AUTO_INCREMENT,\\n\" +\n-            \"  function_id varchar(700) NOT NULL,\\n\" +\n+            \"  function_id_hash varchar(128) NOT NULL,\\n\" +\n+            \"  function_id text NOT NULL,\\n\" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU0NDc0Ng=="}, "originalCommit": {"oid": "8dfba0c0862912c2a1d836f2caeb60a285440d9b"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTEwNTc1Mw==", "bodyText": "If you plan to do that, do it in this PR. We want to minimize schema changes across releases. This creates a lot of pain to early adopters.", "url": "https://github.com/prestodb/presto/pull/14255#discussion_r405105753", "createdAt": "2020-04-07T20:53:05Z", "author": {"login": "rongrong"}, "path": "presto-function-namespace-managers/src/main/java/com/facebook/presto/functionNamespace/mysql/FunctionNamespaceDao.java", "diffHunk": "@@ -51,13 +51,14 @@\n \n     @SqlUpdate(\"CREATE TABLE IF NOT EXISTS <sql_functions_table> (\\n\" +\n             \"  id bigint(20) NOT NULL AUTO_INCREMENT,\\n\" +\n-            \"  function_id varchar(700) NOT NULL,\\n\" +\n+            \"  function_id_hash varchar(128) NOT NULL,\\n\" +\n+            \"  function_id text NOT NULL,\\n\" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU0NDc0Ng=="}, "originalCommit": {"oid": "8dfba0c0862912c2a1d836f2caeb60a285440d9b"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE2MTU5NQ==", "bodyText": "So I made an attempt to this and come to think that this is not a worthwhile effort.\n\nA function_id is a (catalog_name, schema_name, function_name, parameter_types) tuple.\nWe already have separate columns for catalog_name, schema_name, and function_name, but we don't store parameter_types.\nIt's not removing function_id, it is essentially replacing function_id with a new column parameter_types (because it is never needed by itself, only needed for filtering, we can always use the parameters column).\nIf we store function_id, duplication is only catalog/schema/function, which are small, fixed length, and given we also have small amount of entries, this is tiny.\nDownside of this replacement 1 filter clause / 1 parameter to become 4 clause / 4 parameters everyone, which makes the code less readability. I don't think it's worthwhile to trade a few MB of table sizes with readability/maintainaility.", "url": "https://github.com/prestodb/presto/pull/14255#discussion_r405161595", "createdAt": "2020-04-07T22:57:25Z", "author": {"login": "caithagoras"}, "path": "presto-function-namespace-managers/src/main/java/com/facebook/presto/functionNamespace/mysql/FunctionNamespaceDao.java", "diffHunk": "@@ -51,13 +51,14 @@\n \n     @SqlUpdate(\"CREATE TABLE IF NOT EXISTS <sql_functions_table> (\\n\" +\n             \"  id bigint(20) NOT NULL AUTO_INCREMENT,\\n\" +\n-            \"  function_id varchar(700) NOT NULL,\\n\" +\n+            \"  function_id_hash varchar(128) NOT NULL,\\n\" +\n+            \"  function_id text NOT NULL,\\n\" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU0NDc0Ng=="}, "originalCommit": {"oid": "8dfba0c0862912c2a1d836f2caeb60a285440d9b"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMzgwMzk4OnYy", "diffSide": "RIGHT", "path": "presto-function-namespace-managers/src/main/java/com/facebook/presto/functionNamespace/mysql/FunctionNamespaceDao.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QyMDo0Njo0NVrOGCVeAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QyMjo1ODozMlrOGCZINQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTEwMjA4MQ==", "bodyText": "Where did id go?", "url": "https://github.com/prestodb/presto/pull/14255#discussion_r405102081", "createdAt": "2020-04-07T20:46:45Z", "author": {"login": "rongrong"}, "path": "presto-function-namespace-managers/src/main/java/com/facebook/presto/functionNamespace/mysql/FunctionNamespaceDao.java", "diffHunk": "@@ -50,23 +50,23 @@\n     void createFunctionNamespacesTableIfNotExists();\n \n     @SqlUpdate(\"CREATE TABLE IF NOT EXISTS <sql_functions_table> (\\n\" +\n-            \"  id bigint(20) NOT NULL AUTO_INCREMENT,\\n\" +\n-            \"  function_id varchar(700) NOT NULL,\\n\" +\n+            \"  function_id_hash varchar(128) NOT NULL,\\n\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a6f4c6dc994c019f23df2547dde2eda6db9e2257"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE2MjAzNw==", "bodyText": "With id column removed, this table will have no primary key, and mysql will automatically creates an inaccessible column to use as the primary key column, so why do we bother to remove it. \ud83d\ude02 Added it back.", "url": "https://github.com/prestodb/presto/pull/14255#discussion_r405162037", "createdAt": "2020-04-07T22:58:32Z", "author": {"login": "caithagoras"}, "path": "presto-function-namespace-managers/src/main/java/com/facebook/presto/functionNamespace/mysql/FunctionNamespaceDao.java", "diffHunk": "@@ -50,23 +50,23 @@\n     void createFunctionNamespacesTableIfNotExists();\n \n     @SqlUpdate(\"CREATE TABLE IF NOT EXISTS <sql_functions_table> (\\n\" +\n-            \"  id bigint(20) NOT NULL AUTO_INCREMENT,\\n\" +\n-            \"  function_id varchar(700) NOT NULL,\\n\" +\n+            \"  function_id_hash varchar(128) NOT NULL,\\n\" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTEwMjA4MQ=="}, "originalCommit": {"oid": "a6f4c6dc994c019f23df2547dde2eda6db9e2257"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMzgzNTA0OnYy", "diffSide": "RIGHT", "path": "presto-function-namespace-managers/src/main/java/com/facebook/presto/functionNamespace/mysql/FunctionNamespaceDao.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QyMDo1NTowN1rOGCVwug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QyMjo1ODo0NFrOGCZIiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTEwNjg3NA==", "bodyText": "Do we have test for this? We probably should?", "url": "https://github.com/prestodb/presto/pull/14255#discussion_r405106874", "createdAt": "2020-04-07T20:55:07Z", "author": {"login": "rongrong"}, "path": "presto-function-namespace-managers/src/main/java/com/facebook/presto/functionNamespace/mysql/FunctionNamespaceDao.java", "diffHunk": "@@ -50,23 +50,23 @@\n     void createFunctionNamespacesTableIfNotExists();\n \n     @SqlUpdate(\"CREATE TABLE IF NOT EXISTS <sql_functions_table> (\\n\" +\n-            \"  id bigint(20) NOT NULL AUTO_INCREMENT,\\n\" +\n-            \"  function_id varchar(700) NOT NULL,\\n\" +\n+            \"  function_id_hash varchar(128) NOT NULL,\\n\" +\n+            \"  function_id text NOT NULL,\\n\" +\n             \"  version bigint(20) unsigned NOT NULL,\\n\" +\n             \"  catalog_name varchar(128) NOT NULL,\\n\" +\n             \"  schema_name varchar(128) NOT NULL,\\n\" +\n             \"  function_name varchar(256) NOT NULL,\\n\" +\n-            \"  parameters varchar(40000) NOT NULL,\\n\" +\n-            \"  return_type varchar(256) NOT NULL,\\n\" +\n+            \"  parameters text NOT NULL,\\n\" +\n+            \"  return_type text NOT NULL,\\n\" +\n             \"  routine_characteristics text NOT NULL,\\n\" +\n             \"  body mediumtext,\\n\" +\n             \"  description text,\\n\" +\n             \"  deleted boolean NOT NULL DEFAULT false,\\n\" +\n             \"  delete_time TIMESTAMP NULL DEFAULT NULL,\\n\" +\n-            \"  create_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\\n\" +\n-            \"  update_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\\n\" +\n+            \"  create_time TIMESTAMP NULL DEFAULT CURRENT_TIMESTAMP,\\n\" +\n+            \"  update_time TIMESTAMP NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\\n\" +\n             \"  PRIMARY KEY (id),\\n\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a6f4c6dc994c019f23df2547dde2eda6db9e2257"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE2MjEyMA==", "bodyText": "Tests were failing.", "url": "https://github.com/prestodb/presto/pull/14255#discussion_r405162120", "createdAt": "2020-04-07T22:58:44Z", "author": {"login": "caithagoras"}, "path": "presto-function-namespace-managers/src/main/java/com/facebook/presto/functionNamespace/mysql/FunctionNamespaceDao.java", "diffHunk": "@@ -50,23 +50,23 @@\n     void createFunctionNamespacesTableIfNotExists();\n \n     @SqlUpdate(\"CREATE TABLE IF NOT EXISTS <sql_functions_table> (\\n\" +\n-            \"  id bigint(20) NOT NULL AUTO_INCREMENT,\\n\" +\n-            \"  function_id varchar(700) NOT NULL,\\n\" +\n+            \"  function_id_hash varchar(128) NOT NULL,\\n\" +\n+            \"  function_id text NOT NULL,\\n\" +\n             \"  version bigint(20) unsigned NOT NULL,\\n\" +\n             \"  catalog_name varchar(128) NOT NULL,\\n\" +\n             \"  schema_name varchar(128) NOT NULL,\\n\" +\n             \"  function_name varchar(256) NOT NULL,\\n\" +\n-            \"  parameters varchar(40000) NOT NULL,\\n\" +\n-            \"  return_type varchar(256) NOT NULL,\\n\" +\n+            \"  parameters text NOT NULL,\\n\" +\n+            \"  return_type text NOT NULL,\\n\" +\n             \"  routine_characteristics text NOT NULL,\\n\" +\n             \"  body mediumtext,\\n\" +\n             \"  description text,\\n\" +\n             \"  deleted boolean NOT NULL DEFAULT false,\\n\" +\n             \"  delete_time TIMESTAMP NULL DEFAULT NULL,\\n\" +\n-            \"  create_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\\n\" +\n-            \"  update_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\\n\" +\n+            \"  create_time TIMESTAMP NULL DEFAULT CURRENT_TIMESTAMP,\\n\" +\n+            \"  update_time TIMESTAMP NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\\n\" +\n             \"  PRIMARY KEY (id),\\n\" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTEwNjg3NA=="}, "originalCommit": {"oid": "a6f4c6dc994c019f23df2547dde2eda6db9e2257"}, "originalPosition": 25}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2913, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}