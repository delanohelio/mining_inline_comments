{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMyMTQwMjUw", "number": 15498, "title": "Handle nulls properly in flatmap reader", "bodyText": "In the case that a file has very sparse non-null flatmap, reader incorrectly calculates totalMapEntries if the entire batch only contains nulls. That causes exception when reading map values from the child readers.\nTest plan\nAdding a test file that contains all null flat maps except for the first row. This allows this particular edge case to be tested. Ie. the first batch returned contains 1024 rows, one of which is not null. The subsequent batches returned have only nulls.\n== NO RELEASE NOTE ==", "createdAt": "2020-12-03T21:50:00Z", "url": "https://github.com/prestodb/presto/pull/15498", "merged": true, "mergeCommit": {"oid": "bf7bec4438accdde7bd60ec94845de7a1696be4b"}, "closed": true, "closedAt": "2020-12-08T19:59:54Z", "author": {"login": "zzhao0"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdiruJbgFqTU0NDU0NTEwNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdkO0xKgFqTU0NzUzNTAwMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0NTQ1MTA0", "url": "https://github.com/prestodb/presto/pull/15498#pullrequestreview-544545104", "createdAt": "2020-12-03T23:25:30Z", "commit": {"oid": "7503d3c63001d2184e81055d742ec7ceeb4d155f"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMzoyNTozMFrOH-5yEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMzoyNTozMFrOH-5yEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTcyMDQ2NQ==", "bodyText": "Just for my understanding, I believe this is the real bug. But inMapVectors[i] is already null as it was just allocated in the top so this code is no-op,so this entire code is removed.", "url": "https://github.com/prestodb/presto/pull/15498#discussion_r535720465", "createdAt": "2020-12-03T23:25:30Z", "author": {"login": "arunthirupathi"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/reader/MapFlatBatchStreamReader.java", "diffHunk": "@@ -158,13 +158,7 @@ public Block readBlock()\n         else {\n             nullVector = new boolean[nextBatchSize];\n             int nullValues = presentStream.getUnsetBits(nextBatchSize, nullVector);\n-            if (nullValues == nextBatchSize) {\n-                for (int i = 0; i < inMapStreams.size(); i++) {\n-                    inMapVectors[i] = null;\n-                    totalMapEntries += nextBatchSize;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7503d3c63001d2184e81055d742ec7ceeb4d155f"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0NTU1NTY2", "url": "https://github.com/prestodb/presto/pull/15498#pullrequestreview-544555566", "createdAt": "2020-12-03T23:49:39Z", "commit": {"oid": "7503d3c63001d2184e81055d742ec7ceeb4d155f"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMzo0OTozOVrOH-6awA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMzo1MDowNFrOH-6bbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTczMDg4MA==", "bodyText": "typo: everyflat -> every flat", "url": "https://github.com/prestodb/presto/pull/15498#discussion_r535730880", "createdAt": "2020-12-03T23:49:39Z", "author": {"login": "mbasmanova"}, "path": "presto-orc/src/test/java/com/facebook/presto/orc/TestMapFlatBatchStreamReader.java", "diffHunk": "@@ -314,6 +315,17 @@ public void testWithAllNulls()\n                 ExpectedValuesBuilder.get(Function.identity()).setNullRowsFrequency(ALL));\n     }\n \n+    @Test\n+    public void testWithAllNullsExceptFirst()\n+            throws Exception\n+    {\n+        // A test case where everyflat map is null except the first one", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7503d3c63001d2184e81055d742ec7ceeb4d155f"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTczMTA1Mg==", "bodyText": "typo: everyflat -> every flat", "url": "https://github.com/prestodb/presto/pull/15498#discussion_r535731052", "createdAt": "2020-12-03T23:50:04Z", "author": {"login": "mbasmanova"}, "path": "presto-orc/src/test/java/com/facebook/presto/orc/TestMapFlatSelectiveStreamReader.java", "diffHunk": "@@ -313,6 +314,17 @@ public void testWithAllNulls()\n                 ExpectedValuesBuilder.get(Function.identity()).setNullRowsFrequency(ALL));\n     }\n \n+    @Test\n+    public void testWithAllNullsExceptFirst()\n+            throws Exception\n+    {\n+        // A test case where everyflat map is null except the first one", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7503d3c63001d2184e81055d742ec7ceeb4d155f"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ecd890135216a50ac738f1468421d7ebdc325c3", "author": {"user": {"login": "zzhao0", "name": "Zhenyuan Zhao"}}, "url": "https://github.com/prestodb/presto/commit/8ecd890135216a50ac738f1468421d7ebdc325c3", "committedDate": "2020-12-04T03:52:58Z", "message": "handle nulls properly in flatmap reader"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7503d3c63001d2184e81055d742ec7ceeb4d155f", "author": {"user": {"login": "zzhao0", "name": "Zhenyuan Zhao"}}, "url": "https://github.com/prestodb/presto/commit/7503d3c63001d2184e81055d742ec7ceeb4d155f", "committedDate": "2020-12-03T21:35:21Z", "message": "handle nulls properly in flatmap reader"}, "afterCommit": {"oid": "8ecd890135216a50ac738f1468421d7ebdc325c3", "author": {"user": {"login": "zzhao0", "name": "Zhenyuan Zhao"}}, "url": "https://github.com/prestodb/presto/commit/8ecd890135216a50ac738f1468421d7ebdc325c3", "committedDate": "2020-12-04T03:52:58Z", "message": "handle nulls properly in flatmap reader"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3NTM1MDAx", "url": "https://github.com/prestodb/presto/pull/15498#pullrequestreview-547535001", "createdAt": "2020-12-08T18:54:49Z", "commit": {"oid": "8ecd890135216a50ac738f1468421d7ebdc325c3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4508, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}