{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ0OTU1MDM0", "number": 14789, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxOToyNjoxN1rOEL0MUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwNDowODowMFrOEMu9Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgwODI0OTEzOnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/com/facebook/presto/operator/aggregation/builder/InMemoryHashAggregationBuilder.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxOToyNjoxN1rOGtkSYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxOToyNjoxN1rOGtkSYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQzMzYzMw==", "bodyText": "How is it possible that the block itself is null? Isn't that a bug?", "url": "https://github.com/prestodb/presto/pull/14789#discussion_r450433633", "createdAt": "2020-07-06T19:26:17Z", "author": {"login": "arhimondr"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/aggregation/builder/InMemoryHashAggregationBuilder.java", "diffHunk": "@@ -429,7 +430,10 @@ public void processPage(GroupByIdBlock groupIds, Page page)\n                 aggregation.addInput(groupIds, page);\n             }\n             else {\n-                aggregation.addIntermediate(groupIds, page.getBlock(intermediateChannel));\n+                Block block = page.getBlock(intermediateChannel);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d983fb2b3841465d06beca0114496ea88255d12"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxNzg3NDMzOnYy", "diffSide": "RIGHT", "path": "presto-main/src/test/java/com/facebook/presto/operator/aggregation/minmaxby/TestMinMaxByAggregation.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwNDowNjoxMlrOGvA8cQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwNDowNjoxMlrOGvA8cQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk1MTcyOQ==", "bodyText": "Inline this variable", "url": "https://github.com/prestodb/presto/pull/14789#discussion_r451951729", "createdAt": "2020-07-09T04:06:12Z", "author": {"login": "highker"}, "path": "presto-main/src/test/java/com/facebook/presto/operator/aggregation/minmaxby/TestMinMaxByAggregation.java", "diffHunk": "@@ -575,6 +584,32 @@ public void testMaxUnknownLongArray()\n                 createArrayBigintBlock(asList(null, null, null)));\n     }\n \n+    @Test\n+    public void testLongAndBlockPositionValueStateSerialization()\n+    {\n+        Type bigintType = BIGINT;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "858021a1d85cb72d8d1e06af9224b1a6c9adfa8d"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxNzg3NTY1OnYy", "diffSide": "RIGHT", "path": "presto-main/src/test/java/com/facebook/presto/operator/aggregation/minmaxby/TestMinMaxByAggregation.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwNDowNzoxMVrOGvA9Qw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwNDowNzoxMVrOGvA9Qw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk1MTkzOQ==", "bodyText": "mapType(VARCHAR, BOOLEAN) -> mapType", "url": "https://github.com/prestodb/presto/pull/14789#discussion_r451951939", "createdAt": "2020-07-09T04:07:11Z", "author": {"login": "highker"}, "path": "presto-main/src/test/java/com/facebook/presto/operator/aggregation/minmaxby/TestMinMaxByAggregation.java", "diffHunk": "@@ -575,6 +584,32 @@ public void testMaxUnknownLongArray()\n                 createArrayBigintBlock(asList(null, null, null)));\n     }\n \n+    @Test\n+    public void testLongAndBlockPositionValueStateSerialization()\n+    {\n+        Type bigintType = BIGINT;\n+        Type mapType = mapType(VARCHAR, BOOLEAN);\n+        Map<String, Type> fieldMap = ImmutableMap.of(\"Key\", bigintType, \"Value\", mapType);\n+        AccumulatorStateFactory<LongAndBlockPositionValueState> factory = StateCompiler.generateStateFactory(LongAndBlockPositionValueState.class, fieldMap, new DynamicClassLoader(LongAndBlockPositionValueState.class.getClassLoader()));\n+        KeyAndBlockPositionValueStateSerializer<LongAndBlockPositionValueState> serializer = new LongAndBlockPositionStateSerializer(BIGINT, mapType(VARCHAR, BOOLEAN));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "858021a1d85cb72d8d1e06af9224b1a6c9adfa8d"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxNzg3Njk5OnYy", "diffSide": "RIGHT", "path": "presto-main/src/test/java/com/facebook/presto/operator/aggregation/minmaxby/TestMinMaxByAggregation.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwNDowODowMFrOGvA-Aw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwNDowODowMFrOGvA-Aw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk1MjEzMQ==", "bodyText": "Inline this variable", "url": "https://github.com/prestodb/presto/pull/14789#discussion_r451952131", "createdAt": "2020-07-09T04:08:00Z", "author": {"login": "highker"}, "path": "presto-main/src/test/java/com/facebook/presto/operator/aggregation/minmaxby/TestMinMaxByAggregation.java", "diffHunk": "@@ -575,6 +584,32 @@ public void testMaxUnknownLongArray()\n                 createArrayBigintBlock(asList(null, null, null)));\n     }\n \n+    @Test\n+    public void testLongAndBlockPositionValueStateSerialization()\n+    {\n+        Type bigintType = BIGINT;\n+        Type mapType = mapType(VARCHAR, BOOLEAN);\n+        Map<String, Type> fieldMap = ImmutableMap.of(\"Key\", bigintType, \"Value\", mapType);\n+        AccumulatorStateFactory<LongAndBlockPositionValueState> factory = StateCompiler.generateStateFactory(LongAndBlockPositionValueState.class, fieldMap, new DynamicClassLoader(LongAndBlockPositionValueState.class.getClassLoader()));\n+        KeyAndBlockPositionValueStateSerializer<LongAndBlockPositionValueState> serializer = new LongAndBlockPositionStateSerializer(BIGINT, mapType(VARCHAR, BOOLEAN));\n+        LongAndBlockPositionValueState singleState = factory.createSingleState();\n+        LongAndBlockPositionValueState deserializedState = factory.createSingleState();\n+        singleState.setFirst(2020);\n+        singleState.setFirstNull(false);\n+\n+        BlockBuilder builder = RowType.anonymous(ImmutableList.of(BOOLEAN, BOOLEAN, BIGINT, mapType))\n+                .createBlockBuilder(null, 1);\n+        serializer.serialize(singleState, builder);\n+\n+        Block rowBlock = builder.build();\n+        int[] positions = new int[]{0};", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "858021a1d85cb72d8d1e06af9224b1a6c9adfa8d"}, "originalPosition": 58}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2319, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}