{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEyNDE2Nzk5", "number": 14468, "title": "Fix integer overflow when creating a BigIntValues Filter", "bodyText": "Fix Int overflow exception which is caused when calculating (max - min + 1 ) because of long wrap around.\nFixes #14469\n== NO RELEASE NOTE ==", "createdAt": "2020-05-02T08:14:43Z", "url": "https://github.com/prestodb/presto/pull/14468", "merged": true, "mergeCommit": {"oid": "5bd40c56a06b8bc48d7d0a361c506f456dc68e86"}, "closed": true, "closedAt": "2020-05-05T19:11:58Z", "author": {"login": "bhhari"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcd-Y3zAFqTQwNDkyODM1OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABceX7cGgFqTQwNjAyNTI5MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0OTI4MzU5", "url": "https://github.com/prestodb/presto/pull/14468#pullrequestreview-404928359", "createdAt": "2020-05-04T12:10:38Z", "commit": {"oid": "dcfcfa10ed4c1849c9de6f984b87e8e9d7f24019"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxMjoxMDozOFrOGP9f8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxMjoxMDozOFrOGP9f8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM4OTQyNg==", "bodyText": "Since max >= min, range must be > 0. Hence, range < Integer.MIN_VALUE check is not needed. Let's remove.", "url": "https://github.com/prestodb/presto/pull/14468#discussion_r419389426", "createdAt": "2020-05-04T12:10:38Z", "author": {"login": "mbasmanova"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/TupleDomainFilterUtils.java", "diffHunk": "@@ -347,7 +347,8 @@ public static TupleDomainFilter toBigintValues(long[] values, boolean nullAllowe\n         // slots in a hash table), e.g. up to 192 bits per value.\n         // Filter based on a bitmap uses (max - min) / num-values bits per value.\n         // Choose the filter that uses less bits per value.\n-        if ((max - min + 1) > Integer.MAX_VALUE || ((max - min + 1) / values.length) > 192) {\n+        long range = max - min + 1;\n+        if (range > Integer.MAX_VALUE || range < Integer.MIN_VALUE || (range / values.length) > 192) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dcfcfa10ed4c1849c9de6f984b87e8e9d7f24019"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1MjY5NjM5", "url": "https://github.com/prestodb/presto/pull/14468#pullrequestreview-405269639", "createdAt": "2020-05-04T19:10:18Z", "commit": {"oid": "dcfcfa10ed4c1849c9de6f984b87e8e9d7f24019"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dcfcfa10ed4c1849c9de6f984b87e8e9d7f24019", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/dcfcfa10ed4c1849c9de6f984b87e8e9d7f24019", "committedDate": "2020-05-02T08:13:54Z", "message": "Fix integer overflow when creating a BigIntValues Filter"}, "afterCommit": {"oid": "e14e13d2cb5a9eace4b38f6e01166b39b4daf0d9", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/e14e13d2cb5a9eace4b38f6e01166b39b4daf0d9", "committedDate": "2020-05-05T08:31:35Z", "message": "Fix integer overflow when creating a BigIntValues Filter"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e14e13d2cb5a9eace4b38f6e01166b39b4daf0d9", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/e14e13d2cb5a9eace4b38f6e01166b39b4daf0d9", "committedDate": "2020-05-05T08:31:35Z", "message": "Fix integer overflow when creating a BigIntValues Filter"}, "afterCommit": {"oid": "bf5b8cb6a1b297e966e8610ff1ef955b4b24c245", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/bf5b8cb6a1b297e966e8610ff1ef955b4b24c245", "committedDate": "2020-05-05T08:32:37Z", "message": "Fix integer overflow when creating a BigIntValues Filter"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bf5b8cb6a1b297e966e8610ff1ef955b4b24c245", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/bf5b8cb6a1b297e966e8610ff1ef955b4b24c245", "committedDate": "2020-05-05T08:32:37Z", "message": "Fix integer overflow when creating a BigIntValues Filter"}, "afterCommit": {"oid": "e1141dcfb14c7b65a7b48c7c2e77de25f280ad0c", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/e1141dcfb14c7b65a7b48c7c2e77de25f280ad0c", "committedDate": "2020-05-05T08:33:22Z", "message": "Fix integer overflow when creating a BigIntValues Filter"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1ODA4MDMz", "url": "https://github.com/prestodb/presto/pull/14468#pullrequestreview-405808033", "createdAt": "2020-05-05T13:51:21Z", "commit": {"oid": "e1141dcfb14c7b65a7b48c7c2e77de25f280ad0c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMzo1MToyMVrOGQqZXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMzo1MToyMVrOGQqZXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDEyNTAyMA==", "bodyText": "@bhhari nit: perhaps, put each statement on a separate line for readability and consider using intValueExact instead of longValue\n        BigInteger range = BigInteger.valueOf(max)\n                .subtract(BigInteger.valueOf(min))\n                .add(BigInteger.valueOf(1));\n       if (range.compareTo(BigInteger.valueOf(Integer.MAX_VALUE)) == 1 || (range.intValueExact() / values.length) > 192) {\n            return BigintValuesUsingHashTable.of(min, max, values, nullAllowed);\n        }", "url": "https://github.com/prestodb/presto/pull/14468#discussion_r420125020", "createdAt": "2020-05-05T13:51:21Z", "author": {"login": "mbasmanova"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/TupleDomainFilterUtils.java", "diffHunk": "@@ -347,7 +348,8 @@ public static TupleDomainFilter toBigintValues(long[] values, boolean nullAllowe\n         // slots in a hash table), e.g. up to 192 bits per value.\n         // Filter based on a bitmap uses (max - min) / num-values bits per value.\n         // Choose the filter that uses less bits per value.\n-        if ((max - min + 1) > Integer.MAX_VALUE || ((max - min + 1) / values.length) > 192) {\n+        BigInteger range = BigInteger.valueOf(max).subtract(BigInteger.valueOf(min)).add(BigInteger.valueOf(1));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e1141dcfb14c7b65a7b48c7c2e77de25f280ad0c"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "564f45ec1ffc647c511de40718b08e614a0fde9f", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/564f45ec1ffc647c511de40718b08e614a0fde9f", "committedDate": "2020-05-05T17:25:26Z", "message": "Fix integer overflow when creating a BigIntValues Filter"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e1141dcfb14c7b65a7b48c7c2e77de25f280ad0c", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/e1141dcfb14c7b65a7b48c7c2e77de25f280ad0c", "committedDate": "2020-05-05T08:33:22Z", "message": "Fix integer overflow when creating a BigIntValues Filter"}, "afterCommit": {"oid": "564f45ec1ffc647c511de40718b08e614a0fde9f", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/564f45ec1ffc647c511de40718b08e614a0fde9f", "committedDate": "2020-05-05T17:25:26Z", "message": "Fix integer overflow when creating a BigIntValues Filter"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2MDI1Mjkx", "url": "https://github.com/prestodb/presto/pull/14468#pullrequestreview-406025291", "createdAt": "2020-05-05T17:56:33Z", "commit": {"oid": "564f45ec1ffc647c511de40718b08e614a0fde9f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1554, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}