{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEyMzU3OTA2", "number": 14465, "title": "Partition projections by common subexpressions", "bodyText": "== NO RELEASE NOTE ==", "createdAt": "2020-05-01T23:49:31Z", "url": "https://github.com/prestodb/presto/pull/14465", "merged": true, "mergeCommit": {"oid": "5618ebd4f2d8579f8d31a0e13c20b70a1241981c"}, "closed": true, "closedAt": "2020-05-08T23:05:22Z", "author": {"login": "rongrong"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcdKlv1ABqjMyOTQ3NzE0MDU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcfYYdFABqjMzMTg0MzAyMjc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bc2a3e89fbf748201d5151bca3c536179d8d06d2", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/bc2a3e89fbf748201d5151bca3c536179d8d06d2", "committedDate": "2020-05-01T23:46:48Z", "message": "partition cse"}, "afterCommit": {"oid": "f91f424fcf3911df7f5a2702bedda46bd0922e8b", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/f91f424fcf3911df7f5a2702bedda46bd0922e8b", "committedDate": "2020-05-01T23:48:29Z", "message": "partition cse"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f91f424fcf3911df7f5a2702bedda46bd0922e8b", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/f91f424fcf3911df7f5a2702bedda46bd0922e8b", "committedDate": "2020-05-01T23:48:29Z", "message": "partition cse"}, "afterCommit": {"oid": "ee0c07f9f1fb9d0c2ad0ff5830b91b981296ec76", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/ee0c07f9f1fb9d0c2ad0ff5830b91b981296ec76", "committedDate": "2020-05-04T18:53:14Z", "message": "partition cse"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ee0c07f9f1fb9d0c2ad0ff5830b91b981296ec76", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/ee0c07f9f1fb9d0c2ad0ff5830b91b981296ec76", "committedDate": "2020-05-04T18:53:14Z", "message": "partition cse"}, "afterCommit": {"oid": "f9079904ed59eaee55e36391d16a8af329d65b89", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/f9079904ed59eaee55e36391d16a8af329d65b89", "committedDate": "2020-05-04T22:53:59Z", "message": "partition cse"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f9079904ed59eaee55e36391d16a8af329d65b89", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/f9079904ed59eaee55e36391d16a8af329d65b89", "committedDate": "2020-05-04T22:53:59Z", "message": "partition cse"}, "afterCommit": {"oid": "4bbecb82a7d2ee14372def8dc21813a90e2a3827", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/4bbecb82a7d2ee14372def8dc21813a90e2a3827", "committedDate": "2020-05-05T00:22:26Z", "message": "partition cse"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4bbecb82a7d2ee14372def8dc21813a90e2a3827", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/4bbecb82a7d2ee14372def8dc21813a90e2a3827", "committedDate": "2020-05-05T00:22:26Z", "message": "partition cse"}, "afterCommit": {"oid": "efd4a88c9b40c02081d6e90cc3ffb952f48f226e", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/efd4a88c9b40c02081d6e90cc3ffb952f48f226e", "committedDate": "2020-05-05T23:12:33Z", "message": "partition cse"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "efd4a88c9b40c02081d6e90cc3ffb952f48f226e", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/efd4a88c9b40c02081d6e90cc3ffb952f48f226e", "committedDate": "2020-05-05T23:12:33Z", "message": "partition cse"}, "afterCommit": {"oid": "395171333a5f17beccbe063a3c5506c551109655", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/395171333a5f17beccbe063a3c5506c551109655", "committedDate": "2020-05-06T21:42:35Z", "message": "partition cse"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "395171333a5f17beccbe063a3c5506c551109655", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/395171333a5f17beccbe063a3c5506c551109655", "committedDate": "2020-05-06T21:42:35Z", "message": "partition cse"}, "afterCommit": {"oid": "aa79acf636418ef12fb37fec51252c234d956a02", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/aa79acf636418ef12fb37fec51252c234d956a02", "committedDate": "2020-05-06T21:45:50Z", "message": "Partition projections into subsets that depend on same common sub-expressions\n\nIn queries with many projections, sometimes the projections can be partitioned into\ndisjoint sets that do not share common sub-expressions across sets. In this situation,\nit's more performant to compile them into separate PagePorjections rather than keep\nthen all in one. This also avoids corner cases where too many projections and common\nsub-expressions causing the generated class to trigger bytecode too large exception."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3MDUyMTE0", "url": "https://github.com/prestodb/presto/pull/14465#pullrequestreview-407052114", "createdAt": "2020-05-06T23:21:10Z", "commit": {"oid": "2660872e3dd872ce4dd79f533f5a31c522f3c18f"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQyMzoyMToxMFrOGRo1DQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQyMzoyMToxN1rOGRo1Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTE0NzkxNw==", "bodyText": "This could potentially hurt performance. Maybe guard it with log.isDebugEnabled()", "url": "https://github.com/prestodb/presto/pull/14465#discussion_r421147917", "createdAt": "2020-05-06T23:21:10Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/gen/PageFunctionCompiler.java", "diffHunk": "@@ -303,6 +307,9 @@ private ClassDefinition definePageProjectWorkClass(SqlFunctionProperties sqlFunc\n                         .flatMap(m -> m.entrySet().stream())\n                         .collect(toImmutableMap(Map.Entry::getKey, Map.Entry::getValue));\n                 projections = projections.stream().map(projection -> rewriteExpressionWithCSE(projection, commonSubExpressions)).collect(toImmutableList());\n+                log.debug(format(\"Extracted %d common sub-expressions\", commonSubExpressions.size()));\n+                commonSubExpressions.entrySet().forEach(entry -> log.debug(format(\"\\t%s = %s\", entry.getValue(), entry.getKey())));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2660872e3dd872ce4dd79f533f5a31c522f3c18f"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTE0Nzk1OA==", "bodyText": "same", "url": "https://github.com/prestodb/presto/pull/14465#discussion_r421147958", "createdAt": "2020-05-06T23:21:17Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/gen/PageFunctionCompiler.java", "diffHunk": "@@ -588,6 +595,9 @@ private ClassDefinition defineFilterClass(SqlFunctionProperties sqlFunctionPrope\n                         .flatMap(m -> m.entrySet().stream())\n                         .collect(toImmutableMap(Map.Entry::getKey, Map.Entry::getValue));\n                 filter = rewriteExpressionWithCSE(filter, commonSubExpressions);\n+                log.debug(format(\"Extracted %d common sub-expressions\", commonSubExpressions.size()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2660872e3dd872ce4dd79f533f5a31c522f3c18f"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dde55e3a7525cb159579364a0b6eac83af065b01", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/dde55e3a7525cb159579364a0b6eac83af065b01", "committedDate": "2020-05-08T21:01:52Z", "message": "Add extracted common sub-expression to debug level logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a61176b3f1b6b8ea5a38dedc8e4009605303c828", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/a61176b3f1b6b8ea5a38dedc8e4009605303c828", "committedDate": "2020-05-08T21:01:52Z", "message": "Partition projections into subsets that depend on same common sub-expressions\n\nIn queries with many projections, sometimes the projections can be partitioned into\ndisjoint sets that do not share common sub-expressions across sets. In this situation,\nit's more performant to compile them into separate PagePorjections rather than keep\nthen all in one. This also avoids corner cases where too many projections and common\nsub-expressions causing the generated class to trigger bytecode too large exception."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "aa79acf636418ef12fb37fec51252c234d956a02", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/aa79acf636418ef12fb37fec51252c234d956a02", "committedDate": "2020-05-06T21:45:50Z", "message": "Partition projections into subsets that depend on same common sub-expressions\n\nIn queries with many projections, sometimes the projections can be partitioned into\ndisjoint sets that do not share common sub-expressions across sets. In this situation,\nit's more performant to compile them into separate PagePorjections rather than keep\nthen all in one. This also avoids corner cases where too many projections and common\nsub-expressions causing the generated class to trigger bytecode too large exception."}, "afterCommit": {"oid": "a61176b3f1b6b8ea5a38dedc8e4009605303c828", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/a61176b3f1b6b8ea5a38dedc8e4009605303c828", "committedDate": "2020-05-08T21:01:52Z", "message": "Partition projections into subsets that depend on same common sub-expressions\n\nIn queries with many projections, sometimes the projections can be partitioned into\ndisjoint sets that do not share common sub-expressions across sets. In this situation,\nit's more performant to compile them into separate PagePorjections rather than keep\nthen all in one. This also avoids corner cases where too many projections and common\nsub-expressions causing the generated class to trigger bytecode too large exception."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1543, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}