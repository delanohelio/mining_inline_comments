{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU4NzgwMTk4", "number": 13916, "reviewThreads": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QxMjowMzo0OVrODVpPVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QyMjoyNDowMFrODVw49Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0MDIyMzU4OnYy", "diffSide": "RIGHT", "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/checksum/ArrayColumnValidator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QxMjowMzo0OVrOFZ-xHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QxOTowOTo0NlrOFaHNww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjc4NzEwMg==", "bodyText": "@ShenYi This cast may result in NullPointerException. When all arrays are null, sum(cardinality(a)) will be null and casting null into long will throw NPE. I'd drop this cast altogether.\nObject controlCardinalitySum = controlResult.getChecksum(cardinalityColumnAlias);\nObject testCardinalitySum = testResult.getChecksum(cardinalityColumnAlias);", "url": "https://github.com/prestodb/presto/pull/13916#discussion_r362787102", "createdAt": "2020-01-03T12:03:49Z", "author": {"login": "mbasmanova"}, "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/checksum/ArrayColumnValidator.java", "diffHunk": "@@ -49,33 +49,53 @@ public OrderableArrayColumnValidator()\n         checkArgument(column.getType() instanceof ArrayType, \"Expect ArrayType, found %s\", column.getType().getDisplayName());\n         Type elementType = ((ArrayType) column.getType()).getElementType();\n \n-        FunctionCall arraySort = new FunctionCall(QualifiedName.of(\"array_sort\"), ImmutableList.of(column.getIdentifier()));\n         Expression checksum;\n-        if (elementType instanceof ArrayType || elementType instanceof RowType) {\n-            checksum = new CoalesceExpression(\n-                    new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(new TryExpression(arraySort))),\n-                    new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier())));\n+        if (elementType.isOrderable()) {\n+            FunctionCall arraySort = new FunctionCall(QualifiedName.of(\"array_sort\"), ImmutableList.of(column.getIdentifier()));\n+            if (elementType instanceof ArrayType || elementType instanceof RowType) {\n+                checksum = new CoalesceExpression(\n+                        new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(new TryExpression(arraySort))),\n+                        new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier())));\n+            }\n+            else {\n+                checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(arraySort));\n+            }\n         }\n         else {\n-            checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(arraySort));\n+            checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier()));\n         }\n \n-        return ImmutableList.of(new SingleColumn(checksum, Optional.of(delimitedIdentifier(getChecksumColumnAlias(column)))));\n+        FunctionCall arrayCardinality = new FunctionCall(QualifiedName.of(\"sum\"),\n+                ImmutableList.of(new FunctionCall(QualifiedName.of(\"cardinality\"), ImmutableList.of(column.getIdentifier()))));\n+\n+        return ImmutableList.of(new SingleColumn(checksum, Optional.of(delimitedIdentifier(getChecksumColumnAlias(column)))),\n+                new SingleColumn(arrayCardinality, Optional.of(delimitedIdentifier(getCardinalityColumnAlias(column)))));\n     }\n \n     @Override\n     public ColumnMatchResult validate(Column column, ChecksumResult controlResult, ChecksumResult testResult)\n     {\n-        String sortedChecksumColumnAlias = getChecksumColumnAlias(column);\n-        Object controlSortedChecksum = controlResult.getChecksum(sortedChecksumColumnAlias);\n-        Object testSortedChecksum = testResult.getChecksum(sortedChecksumColumnAlias);\n+        String checksumColumnAlias = getChecksumColumnAlias(column);\n+        Object controlChecksum = controlResult.getChecksum(checksumColumnAlias);\n+        Object testChecksum = testResult.getChecksum(checksumColumnAlias);\n+\n+        String cardinalityColumnAlias = getCardinalityColumnAlias(column);\n+        long controlCardinalitySum = (long) controlResult.getChecksum(cardinalityColumnAlias);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "125e03c0cf426dc540348bfbae2a84fc1b19c2f5"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjkyNTUwNw==", "bodyText": "Nice catch. Fixed.", "url": "https://github.com/prestodb/presto/pull/13916#discussion_r362925507", "createdAt": "2020-01-03T19:09:46Z", "author": {"login": "ShenYi"}, "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/checksum/ArrayColumnValidator.java", "diffHunk": "@@ -49,33 +49,53 @@ public OrderableArrayColumnValidator()\n         checkArgument(column.getType() instanceof ArrayType, \"Expect ArrayType, found %s\", column.getType().getDisplayName());\n         Type elementType = ((ArrayType) column.getType()).getElementType();\n \n-        FunctionCall arraySort = new FunctionCall(QualifiedName.of(\"array_sort\"), ImmutableList.of(column.getIdentifier()));\n         Expression checksum;\n-        if (elementType instanceof ArrayType || elementType instanceof RowType) {\n-            checksum = new CoalesceExpression(\n-                    new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(new TryExpression(arraySort))),\n-                    new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier())));\n+        if (elementType.isOrderable()) {\n+            FunctionCall arraySort = new FunctionCall(QualifiedName.of(\"array_sort\"), ImmutableList.of(column.getIdentifier()));\n+            if (elementType instanceof ArrayType || elementType instanceof RowType) {\n+                checksum = new CoalesceExpression(\n+                        new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(new TryExpression(arraySort))),\n+                        new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier())));\n+            }\n+            else {\n+                checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(arraySort));\n+            }\n         }\n         else {\n-            checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(arraySort));\n+            checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier()));\n         }\n \n-        return ImmutableList.of(new SingleColumn(checksum, Optional.of(delimitedIdentifier(getChecksumColumnAlias(column)))));\n+        FunctionCall arrayCardinality = new FunctionCall(QualifiedName.of(\"sum\"),\n+                ImmutableList.of(new FunctionCall(QualifiedName.of(\"cardinality\"), ImmutableList.of(column.getIdentifier()))));\n+\n+        return ImmutableList.of(new SingleColumn(checksum, Optional.of(delimitedIdentifier(getChecksumColumnAlias(column)))),\n+                new SingleColumn(arrayCardinality, Optional.of(delimitedIdentifier(getCardinalityColumnAlias(column)))));\n     }\n \n     @Override\n     public ColumnMatchResult validate(Column column, ChecksumResult controlResult, ChecksumResult testResult)\n     {\n-        String sortedChecksumColumnAlias = getChecksumColumnAlias(column);\n-        Object controlSortedChecksum = controlResult.getChecksum(sortedChecksumColumnAlias);\n-        Object testSortedChecksum = testResult.getChecksum(sortedChecksumColumnAlias);\n+        String checksumColumnAlias = getChecksumColumnAlias(column);\n+        Object controlChecksum = controlResult.getChecksum(checksumColumnAlias);\n+        Object testChecksum = testResult.getChecksum(checksumColumnAlias);\n+\n+        String cardinalityColumnAlias = getCardinalityColumnAlias(column);\n+        long controlCardinalitySum = (long) controlResult.getChecksum(cardinalityColumnAlias);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjc4NzEwMg=="}, "originalCommit": {"oid": "125e03c0cf426dc540348bfbae2a84fc1b19c2f5"}, "originalPosition": 59}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0MTI1NDY1OnYy", "diffSide": "RIGHT", "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/checksum/ArrayColumnValidator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QyMDoxNjoxMlrOFaIgKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QyMDoxNjoxMlrOFaIgKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk0NjYwMQ==", "bodyText": "First parameter on a separate line", "url": "https://github.com/prestodb/presto/pull/13916#discussion_r362946601", "createdAt": "2020-01-03T20:16:12Z", "author": {"login": "caithagoras"}, "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/checksum/ArrayColumnValidator.java", "diffHunk": "@@ -49,33 +49,53 @@ public OrderableArrayColumnValidator()\n         checkArgument(column.getType() instanceof ArrayType, \"Expect ArrayType, found %s\", column.getType().getDisplayName());\n         Type elementType = ((ArrayType) column.getType()).getElementType();\n \n-        FunctionCall arraySort = new FunctionCall(QualifiedName.of(\"array_sort\"), ImmutableList.of(column.getIdentifier()));\n         Expression checksum;\n-        if (elementType instanceof ArrayType || elementType instanceof RowType) {\n-            checksum = new CoalesceExpression(\n-                    new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(new TryExpression(arraySort))),\n-                    new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier())));\n+        if (elementType.isOrderable()) {\n+            FunctionCall arraySort = new FunctionCall(QualifiedName.of(\"array_sort\"), ImmutableList.of(column.getIdentifier()));\n+            if (elementType instanceof ArrayType || elementType instanceof RowType) {\n+                checksum = new CoalesceExpression(\n+                        new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(new TryExpression(arraySort))),\n+                        new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier())));\n+            }\n+            else {\n+                checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(arraySort));\n+            }\n         }\n         else {\n-            checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(arraySort));\n+            checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier()));\n         }\n \n-        return ImmutableList.of(new SingleColumn(checksum, Optional.of(delimitedIdentifier(getChecksumColumnAlias(column)))));\n+        FunctionCall arrayCardinality = new FunctionCall(QualifiedName.of(\"sum\"),\n+                ImmutableList.of(new FunctionCall(QualifiedName.of(\"cardinality\"), ImmutableList.of(column.getIdentifier()))));\n+\n+        return ImmutableList.of(new SingleColumn(checksum, Optional.of(delimitedIdentifier(getChecksumColumnAlias(column)))),\n+                new SingleColumn(arrayCardinality, Optional.of(delimitedIdentifier(getCardinalityColumnAlias(column)))));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "787a6319ff6fcd40a3665d57e4e399c554fba610"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0MTI1NjA4OnYy", "diffSide": "RIGHT", "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/checksum/ArrayColumnValidator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QyMDoxNjo0OFrOFaIg_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QyMDoxNjo0OFrOFaIg_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk0NjgxNQ==", "bodyText": "getCardinalitySumColumnAlias", "url": "https://github.com/prestodb/presto/pull/13916#discussion_r362946815", "createdAt": "2020-01-03T20:16:48Z", "author": {"login": "caithagoras"}, "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/checksum/ArrayColumnValidator.java", "diffHunk": "@@ -49,33 +49,53 @@ public OrderableArrayColumnValidator()\n         checkArgument(column.getType() instanceof ArrayType, \"Expect ArrayType, found %s\", column.getType().getDisplayName());\n         Type elementType = ((ArrayType) column.getType()).getElementType();\n \n-        FunctionCall arraySort = new FunctionCall(QualifiedName.of(\"array_sort\"), ImmutableList.of(column.getIdentifier()));\n         Expression checksum;\n-        if (elementType instanceof ArrayType || elementType instanceof RowType) {\n-            checksum = new CoalesceExpression(\n-                    new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(new TryExpression(arraySort))),\n-                    new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier())));\n+        if (elementType.isOrderable()) {\n+            FunctionCall arraySort = new FunctionCall(QualifiedName.of(\"array_sort\"), ImmutableList.of(column.getIdentifier()));\n+            if (elementType instanceof ArrayType || elementType instanceof RowType) {\n+                checksum = new CoalesceExpression(\n+                        new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(new TryExpression(arraySort))),\n+                        new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier())));\n+            }\n+            else {\n+                checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(arraySort));\n+            }\n         }\n         else {\n-            checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(arraySort));\n+            checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier()));\n         }\n \n-        return ImmutableList.of(new SingleColumn(checksum, Optional.of(delimitedIdentifier(getChecksumColumnAlias(column)))));\n+        FunctionCall arrayCardinality = new FunctionCall(QualifiedName.of(\"sum\"),\n+                ImmutableList.of(new FunctionCall(QualifiedName.of(\"cardinality\"), ImmutableList.of(column.getIdentifier()))));\n+\n+        return ImmutableList.of(new SingleColumn(checksum, Optional.of(delimitedIdentifier(getChecksumColumnAlias(column)))),\n+                new SingleColumn(arrayCardinality, Optional.of(delimitedIdentifier(getCardinalityColumnAlias(column)))));\n     }\n \n     @Override\n     public ColumnMatchResult validate(Column column, ChecksumResult controlResult, ChecksumResult testResult)\n     {\n-        String sortedChecksumColumnAlias = getChecksumColumnAlias(column);\n-        Object controlSortedChecksum = controlResult.getChecksum(sortedChecksumColumnAlias);\n-        Object testSortedChecksum = testResult.getChecksum(sortedChecksumColumnAlias);\n+        String checksumColumnAlias = getChecksumColumnAlias(column);\n+        Object controlChecksum = controlResult.getChecksum(checksumColumnAlias);\n+        Object testChecksum = testResult.getChecksum(checksumColumnAlias);\n+\n+        String cardinalityColumnAlias = getCardinalityColumnAlias(column);\n+        Object controlCardinalitySum = controlResult.getChecksum(cardinalityColumnAlias);\n+        Object testCardinalitySum = testResult.getChecksum(cardinalityColumnAlias);\n+\n         return new ColumnMatchResult(\n-                Objects.equals(controlSortedChecksum, testSortedChecksum),\n-                format(\"control(checksum: %s) test(checksum: %s)\", controlSortedChecksum, testSortedChecksum));\n+                Objects.equals(controlChecksum, testChecksum) && Objects.equals(controlCardinalitySum, testCardinalitySum),\n+                format(\"control(checksum: %s, cardinality: %s) test(checksum: %s, cardinality: %s)\",\n+                        controlChecksum, controlCardinalitySum, testChecksum, testCardinalitySum));\n     }\n \n     private static String getChecksumColumnAlias(Column column)\n     {\n         return column.getName() + \"_checksum\";\n     }\n+\n+    private static String getCardinalityColumnAlias(Column column)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "787a6319ff6fcd40a3665d57e4e399c554fba610"}, "originalPosition": 75}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0MTI1NzIzOnYy", "diffSide": "RIGHT", "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/checksum/ArrayColumnValidator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QyMDoxNzoxNVrOFaIhrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QyMDoxNzoxNVrOFaIhrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk0Njk4OQ==", "bodyText": "I would call this cardinalitySumColumnAlias", "url": "https://github.com/prestodb/presto/pull/13916#discussion_r362946989", "createdAt": "2020-01-03T20:17:15Z", "author": {"login": "caithagoras"}, "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/checksum/ArrayColumnValidator.java", "diffHunk": "@@ -49,33 +49,53 @@ public OrderableArrayColumnValidator()\n         checkArgument(column.getType() instanceof ArrayType, \"Expect ArrayType, found %s\", column.getType().getDisplayName());\n         Type elementType = ((ArrayType) column.getType()).getElementType();\n \n-        FunctionCall arraySort = new FunctionCall(QualifiedName.of(\"array_sort\"), ImmutableList.of(column.getIdentifier()));\n         Expression checksum;\n-        if (elementType instanceof ArrayType || elementType instanceof RowType) {\n-            checksum = new CoalesceExpression(\n-                    new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(new TryExpression(arraySort))),\n-                    new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier())));\n+        if (elementType.isOrderable()) {\n+            FunctionCall arraySort = new FunctionCall(QualifiedName.of(\"array_sort\"), ImmutableList.of(column.getIdentifier()));\n+            if (elementType instanceof ArrayType || elementType instanceof RowType) {\n+                checksum = new CoalesceExpression(\n+                        new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(new TryExpression(arraySort))),\n+                        new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier())));\n+            }\n+            else {\n+                checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(arraySort));\n+            }\n         }\n         else {\n-            checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(arraySort));\n+            checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier()));\n         }\n \n-        return ImmutableList.of(new SingleColumn(checksum, Optional.of(delimitedIdentifier(getChecksumColumnAlias(column)))));\n+        FunctionCall arrayCardinality = new FunctionCall(QualifiedName.of(\"sum\"),\n+                ImmutableList.of(new FunctionCall(QualifiedName.of(\"cardinality\"), ImmutableList.of(column.getIdentifier()))));\n+\n+        return ImmutableList.of(new SingleColumn(checksum, Optional.of(delimitedIdentifier(getChecksumColumnAlias(column)))),\n+                new SingleColumn(arrayCardinality, Optional.of(delimitedIdentifier(getCardinalityColumnAlias(column)))));\n     }\n \n     @Override\n     public ColumnMatchResult validate(Column column, ChecksumResult controlResult, ChecksumResult testResult)\n     {\n-        String sortedChecksumColumnAlias = getChecksumColumnAlias(column);\n-        Object controlSortedChecksum = controlResult.getChecksum(sortedChecksumColumnAlias);\n-        Object testSortedChecksum = testResult.getChecksum(sortedChecksumColumnAlias);\n+        String checksumColumnAlias = getChecksumColumnAlias(column);\n+        Object controlChecksum = controlResult.getChecksum(checksumColumnAlias);\n+        Object testChecksum = testResult.getChecksum(checksumColumnAlias);\n+\n+        String cardinalityColumnAlias = getCardinalityColumnAlias(column);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "787a6319ff6fcd40a3665d57e4e399c554fba610"}, "originalPosition": 58}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0MTI1NzcyOnYy", "diffSide": "RIGHT", "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/checksum/ArrayColumnValidator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QyMDoxNzozMlrOFaIiBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QyMDoxNzozMlrOFaIiBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk0NzA3Nw==", "bodyText": "_cardinality_sum", "url": "https://github.com/prestodb/presto/pull/13916#discussion_r362947077", "createdAt": "2020-01-03T20:17:32Z", "author": {"login": "caithagoras"}, "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/checksum/ArrayColumnValidator.java", "diffHunk": "@@ -49,33 +49,53 @@ public OrderableArrayColumnValidator()\n         checkArgument(column.getType() instanceof ArrayType, \"Expect ArrayType, found %s\", column.getType().getDisplayName());\n         Type elementType = ((ArrayType) column.getType()).getElementType();\n \n-        FunctionCall arraySort = new FunctionCall(QualifiedName.of(\"array_sort\"), ImmutableList.of(column.getIdentifier()));\n         Expression checksum;\n-        if (elementType instanceof ArrayType || elementType instanceof RowType) {\n-            checksum = new CoalesceExpression(\n-                    new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(new TryExpression(arraySort))),\n-                    new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier())));\n+        if (elementType.isOrderable()) {\n+            FunctionCall arraySort = new FunctionCall(QualifiedName.of(\"array_sort\"), ImmutableList.of(column.getIdentifier()));\n+            if (elementType instanceof ArrayType || elementType instanceof RowType) {\n+                checksum = new CoalesceExpression(\n+                        new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(new TryExpression(arraySort))),\n+                        new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier())));\n+            }\n+            else {\n+                checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(arraySort));\n+            }\n         }\n         else {\n-            checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(arraySort));\n+            checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier()));\n         }\n \n-        return ImmutableList.of(new SingleColumn(checksum, Optional.of(delimitedIdentifier(getChecksumColumnAlias(column)))));\n+        FunctionCall arrayCardinality = new FunctionCall(QualifiedName.of(\"sum\"),\n+                ImmutableList.of(new FunctionCall(QualifiedName.of(\"cardinality\"), ImmutableList.of(column.getIdentifier()))));\n+\n+        return ImmutableList.of(new SingleColumn(checksum, Optional.of(delimitedIdentifier(getChecksumColumnAlias(column)))),\n+                new SingleColumn(arrayCardinality, Optional.of(delimitedIdentifier(getCardinalityColumnAlias(column)))));\n     }\n \n     @Override\n     public ColumnMatchResult validate(Column column, ChecksumResult controlResult, ChecksumResult testResult)\n     {\n-        String sortedChecksumColumnAlias = getChecksumColumnAlias(column);\n-        Object controlSortedChecksum = controlResult.getChecksum(sortedChecksumColumnAlias);\n-        Object testSortedChecksum = testResult.getChecksum(sortedChecksumColumnAlias);\n+        String checksumColumnAlias = getChecksumColumnAlias(column);\n+        Object controlChecksum = controlResult.getChecksum(checksumColumnAlias);\n+        Object testChecksum = testResult.getChecksum(checksumColumnAlias);\n+\n+        String cardinalityColumnAlias = getCardinalityColumnAlias(column);\n+        Object controlCardinalitySum = controlResult.getChecksum(cardinalityColumnAlias);\n+        Object testCardinalitySum = testResult.getChecksum(cardinalityColumnAlias);\n+\n         return new ColumnMatchResult(\n-                Objects.equals(controlSortedChecksum, testSortedChecksum),\n-                format(\"control(checksum: %s) test(checksum: %s)\", controlSortedChecksum, testSortedChecksum));\n+                Objects.equals(controlChecksum, testChecksum) && Objects.equals(controlCardinalitySum, testCardinalitySum),\n+                format(\"control(checksum: %s, cardinality: %s) test(checksum: %s, cardinality: %s)\",\n+                        controlChecksum, controlCardinalitySum, testChecksum, testCardinalitySum));\n     }\n \n     private static String getChecksumColumnAlias(Column column)\n     {\n         return column.getName() + \"_checksum\";\n     }\n+\n+    private static String getCardinalityColumnAlias(Column column)\n+    {\n+        return column.getName() + \"_cardinality\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "787a6319ff6fcd40a3665d57e4e399c554fba610"}, "originalPosition": 77}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0MTI1OTQyOnYy", "diffSide": "RIGHT", "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/checksum/ArrayColumnValidator.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QyMDoxODoxNVrOFaIi_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QyMjoxNjoyM1rOFaKgaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk0NzMyNg==", "bodyText": "First parameter on a separate line", "url": "https://github.com/prestodb/presto/pull/13916#discussion_r362947326", "createdAt": "2020-01-03T20:18:15Z", "author": {"login": "caithagoras"}, "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/checksum/ArrayColumnValidator.java", "diffHunk": "@@ -49,33 +49,53 @@ public OrderableArrayColumnValidator()\n         checkArgument(column.getType() instanceof ArrayType, \"Expect ArrayType, found %s\", column.getType().getDisplayName());\n         Type elementType = ((ArrayType) column.getType()).getElementType();\n \n-        FunctionCall arraySort = new FunctionCall(QualifiedName.of(\"array_sort\"), ImmutableList.of(column.getIdentifier()));\n         Expression checksum;\n-        if (elementType instanceof ArrayType || elementType instanceof RowType) {\n-            checksum = new CoalesceExpression(\n-                    new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(new TryExpression(arraySort))),\n-                    new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier())));\n+        if (elementType.isOrderable()) {\n+            FunctionCall arraySort = new FunctionCall(QualifiedName.of(\"array_sort\"), ImmutableList.of(column.getIdentifier()));\n+            if (elementType instanceof ArrayType || elementType instanceof RowType) {\n+                checksum = new CoalesceExpression(\n+                        new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(new TryExpression(arraySort))),\n+                        new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier())));\n+            }\n+            else {\n+                checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(arraySort));\n+            }\n         }\n         else {\n-            checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(arraySort));\n+            checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier()));\n         }\n \n-        return ImmutableList.of(new SingleColumn(checksum, Optional.of(delimitedIdentifier(getChecksumColumnAlias(column)))));\n+        FunctionCall arrayCardinality = new FunctionCall(QualifiedName.of(\"sum\"),\n+                ImmutableList.of(new FunctionCall(QualifiedName.of(\"cardinality\"), ImmutableList.of(column.getIdentifier()))));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "787a6319ff6fcd40a3665d57e4e399c554fba610"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk0OTQ3Mg==", "bodyText": "If all rows of the array column are null, array(cardinality(a)) will be null, so let's wrap it with a coalesce.\ncoalesce(array(cardinality(a)), 0) a_cardinality_sum", "url": "https://github.com/prestodb/presto/pull/13916#discussion_r362949472", "createdAt": "2020-01-03T20:24:27Z", "author": {"login": "caithagoras"}, "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/checksum/ArrayColumnValidator.java", "diffHunk": "@@ -49,33 +49,53 @@ public OrderableArrayColumnValidator()\n         checkArgument(column.getType() instanceof ArrayType, \"Expect ArrayType, found %s\", column.getType().getDisplayName());\n         Type elementType = ((ArrayType) column.getType()).getElementType();\n \n-        FunctionCall arraySort = new FunctionCall(QualifiedName.of(\"array_sort\"), ImmutableList.of(column.getIdentifier()));\n         Expression checksum;\n-        if (elementType instanceof ArrayType || elementType instanceof RowType) {\n-            checksum = new CoalesceExpression(\n-                    new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(new TryExpression(arraySort))),\n-                    new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier())));\n+        if (elementType.isOrderable()) {\n+            FunctionCall arraySort = new FunctionCall(QualifiedName.of(\"array_sort\"), ImmutableList.of(column.getIdentifier()));\n+            if (elementType instanceof ArrayType || elementType instanceof RowType) {\n+                checksum = new CoalesceExpression(\n+                        new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(new TryExpression(arraySort))),\n+                        new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier())));\n+            }\n+            else {\n+                checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(arraySort));\n+            }\n         }\n         else {\n-            checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(arraySort));\n+            checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier()));\n         }\n \n-        return ImmutableList.of(new SingleColumn(checksum, Optional.of(delimitedIdentifier(getChecksumColumnAlias(column)))));\n+        FunctionCall arrayCardinality = new FunctionCall(QualifiedName.of(\"sum\"),\n+                ImmutableList.of(new FunctionCall(QualifiedName.of(\"cardinality\"), ImmutableList.of(column.getIdentifier()))));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk0NzMyNg=="}, "originalCommit": {"oid": "787a6319ff6fcd40a3665d57e4e399c554fba610"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk2MDc4Nw==", "bodyText": "Do you mean?\ncoalesce(sum(cardinality(a)), 0)", "url": "https://github.com/prestodb/presto/pull/13916#discussion_r362960787", "createdAt": "2020-01-03T21:04:37Z", "author": {"login": "ShenYi"}, "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/checksum/ArrayColumnValidator.java", "diffHunk": "@@ -49,33 +49,53 @@ public OrderableArrayColumnValidator()\n         checkArgument(column.getType() instanceof ArrayType, \"Expect ArrayType, found %s\", column.getType().getDisplayName());\n         Type elementType = ((ArrayType) column.getType()).getElementType();\n \n-        FunctionCall arraySort = new FunctionCall(QualifiedName.of(\"array_sort\"), ImmutableList.of(column.getIdentifier()));\n         Expression checksum;\n-        if (elementType instanceof ArrayType || elementType instanceof RowType) {\n-            checksum = new CoalesceExpression(\n-                    new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(new TryExpression(arraySort))),\n-                    new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier())));\n+        if (elementType.isOrderable()) {\n+            FunctionCall arraySort = new FunctionCall(QualifiedName.of(\"array_sort\"), ImmutableList.of(column.getIdentifier()));\n+            if (elementType instanceof ArrayType || elementType instanceof RowType) {\n+                checksum = new CoalesceExpression(\n+                        new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(new TryExpression(arraySort))),\n+                        new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier())));\n+            }\n+            else {\n+                checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(arraySort));\n+            }\n         }\n         else {\n-            checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(arraySort));\n+            checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier()));\n         }\n \n-        return ImmutableList.of(new SingleColumn(checksum, Optional.of(delimitedIdentifier(getChecksumColumnAlias(column)))));\n+        FunctionCall arrayCardinality = new FunctionCall(QualifiedName.of(\"sum\"),\n+                ImmutableList.of(new FunctionCall(QualifiedName.of(\"cardinality\"), ImmutableList.of(column.getIdentifier()))));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk0NzMyNg=="}, "originalCommit": {"oid": "787a6319ff6fcd40a3665d57e4e399c554fba610"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk3OTQzNQ==", "bodyText": "Exactly. Sorry for the typo.", "url": "https://github.com/prestodb/presto/pull/13916#discussion_r362979435", "createdAt": "2020-01-03T22:16:23Z", "author": {"login": "caithagoras"}, "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/checksum/ArrayColumnValidator.java", "diffHunk": "@@ -49,33 +49,53 @@ public OrderableArrayColumnValidator()\n         checkArgument(column.getType() instanceof ArrayType, \"Expect ArrayType, found %s\", column.getType().getDisplayName());\n         Type elementType = ((ArrayType) column.getType()).getElementType();\n \n-        FunctionCall arraySort = new FunctionCall(QualifiedName.of(\"array_sort\"), ImmutableList.of(column.getIdentifier()));\n         Expression checksum;\n-        if (elementType instanceof ArrayType || elementType instanceof RowType) {\n-            checksum = new CoalesceExpression(\n-                    new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(new TryExpression(arraySort))),\n-                    new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier())));\n+        if (elementType.isOrderable()) {\n+            FunctionCall arraySort = new FunctionCall(QualifiedName.of(\"array_sort\"), ImmutableList.of(column.getIdentifier()));\n+            if (elementType instanceof ArrayType || elementType instanceof RowType) {\n+                checksum = new CoalesceExpression(\n+                        new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(new TryExpression(arraySort))),\n+                        new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier())));\n+            }\n+            else {\n+                checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(arraySort));\n+            }\n         }\n         else {\n-            checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(arraySort));\n+            checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier()));\n         }\n \n-        return ImmutableList.of(new SingleColumn(checksum, Optional.of(delimitedIdentifier(getChecksumColumnAlias(column)))));\n+        FunctionCall arrayCardinality = new FunctionCall(QualifiedName.of(\"sum\"),\n+                ImmutableList.of(new FunctionCall(QualifiedName.of(\"cardinality\"), ImmutableList.of(column.getIdentifier()))));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk0NzMyNg=="}, "originalCommit": {"oid": "787a6319ff6fcd40a3665d57e4e399c554fba610"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0MTQ2NTU3OnYy", "diffSide": "RIGHT", "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/checksum/ArrayColumnValidator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QyMjoxNzoxN1rOFaKhFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QyMjoxNzoxN1rOFaKhFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk3OTYwNA==", "bodyText": "Those 2 changes should belong to the 1st commit.", "url": "https://github.com/prestodb/presto/pull/13916#discussion_r362979604", "createdAt": "2020-01-03T22:17:17Z", "author": {"login": "caithagoras"}, "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/checksum/ArrayColumnValidator.java", "diffHunk": "@@ -67,22 +68,41 @@ public ArrayColumnValidator()\n             checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier()));\n         }\n \n-        return ImmutableList.of(new SingleColumn(checksum, Optional.of(delimitedIdentifier(getChecksumColumnAlias(column)))));\n+        Expression arrayCardinalitySum = new CoalesceExpression(\n+                new FunctionCall(\n+                        QualifiedName.of(\"sum\"),\n+                        ImmutableList.of(new FunctionCall(QualifiedName.of(\"cardinality\"), ImmutableList.of(column.getIdentifier())))),\n+                new LongLiteral(\"0\"));\n+\n+        return ImmutableList.of(\n+                new SingleColumn(checksum, Optional.of(delimitedIdentifier(getChecksumColumnAlias(column)))),\n+                new SingleColumn(arrayCardinalitySum, Optional.of(delimitedIdentifier(getCardinalitySumColumnAlias(column)))));\n     }\n \n     @Override\n     public ColumnMatchResult validate(Column column, ChecksumResult controlResult, ChecksumResult testResult)\n     {\n         String sortedChecksumColumnAlias = getChecksumColumnAlias(column);\n-        Object controlSortedChecksum = controlResult.getChecksum(sortedChecksumColumnAlias);\n-        Object testSortedChecksum = testResult.getChecksum(sortedChecksumColumnAlias);\n+        Object controlChecksum = controlResult.getChecksum(sortedChecksumColumnAlias);\n+        Object testChecksum = testResult.getChecksum(sortedChecksumColumnAlias);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca896b76bc8c6c0b7a71b759c7df116f1b2536b8"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0MTQ2ODAzOnYy", "diffSide": "RIGHT", "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/checksum/ArrayColumnValidator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QyMjoxODoyNVrOFaKiYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QyMjo0MTo1N1rOFaK2lg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk3OTkzNw==", "bodyText": "Merge line 95 and 96, or, one line per parameter:\nformat(\n    \"control(checksum: %s, cardinality_sum: %s) test(checksum: %s, cardinality_sum: %s)\",\n    controlChecksum,\n    controlCardinalitySum,\n    testChecksum,\n    testCardinalitySum));", "url": "https://github.com/prestodb/presto/pull/13916#discussion_r362979937", "createdAt": "2020-01-03T22:18:25Z", "author": {"login": "caithagoras"}, "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/checksum/ArrayColumnValidator.java", "diffHunk": "@@ -67,22 +68,41 @@ public ArrayColumnValidator()\n             checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier()));\n         }\n \n-        return ImmutableList.of(new SingleColumn(checksum, Optional.of(delimitedIdentifier(getChecksumColumnAlias(column)))));\n+        Expression arrayCardinalitySum = new CoalesceExpression(\n+                new FunctionCall(\n+                        QualifiedName.of(\"sum\"),\n+                        ImmutableList.of(new FunctionCall(QualifiedName.of(\"cardinality\"), ImmutableList.of(column.getIdentifier())))),\n+                new LongLiteral(\"0\"));\n+\n+        return ImmutableList.of(\n+                new SingleColumn(checksum, Optional.of(delimitedIdentifier(getChecksumColumnAlias(column)))),\n+                new SingleColumn(arrayCardinalitySum, Optional.of(delimitedIdentifier(getCardinalitySumColumnAlias(column)))));\n     }\n \n     @Override\n     public ColumnMatchResult validate(Column column, ChecksumResult controlResult, ChecksumResult testResult)\n     {\n         String sortedChecksumColumnAlias = getChecksumColumnAlias(column);\n-        Object controlSortedChecksum = controlResult.getChecksum(sortedChecksumColumnAlias);\n-        Object testSortedChecksum = testResult.getChecksum(sortedChecksumColumnAlias);\n+        Object controlChecksum = controlResult.getChecksum(sortedChecksumColumnAlias);\n+        Object testChecksum = testResult.getChecksum(sortedChecksumColumnAlias);\n+\n+        String cardinalitySumColumnAlias = getCardinalitySumColumnAlias(column);\n+        Object controlCardinalitySum = controlResult.getChecksum(cardinalitySumColumnAlias);\n+        Object testCardinalitySum = testResult.getChecksum(cardinalitySumColumnAlias);\n+\n         return new ColumnMatchResult(\n-                Objects.equals(controlSortedChecksum, testSortedChecksum),\n-                format(\"control(checksum: %s) test(checksum: %s)\", controlSortedChecksum, testSortedChecksum));\n+                Objects.equals(controlChecksum, testChecksum) && Objects.equals(controlCardinalitySum, testCardinalitySum),\n+                format(\"control(checksum: %s, cardinality_sum: %s) test(checksum: %s, cardinality_sum: %s)\",\n+                        controlChecksum, controlCardinalitySum, testChecksum, testCardinalitySum));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca896b76bc8c6c0b7a71b759c7df116f1b2536b8"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk4NTExMA==", "bodyText": "Airlift auto reformat results in a different indent as shown in the latest diff.", "url": "https://github.com/prestodb/presto/pull/13916#discussion_r362985110", "createdAt": "2020-01-03T22:41:57Z", "author": {"login": "ShenYi"}, "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/checksum/ArrayColumnValidator.java", "diffHunk": "@@ -67,22 +68,41 @@ public ArrayColumnValidator()\n             checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier()));\n         }\n \n-        return ImmutableList.of(new SingleColumn(checksum, Optional.of(delimitedIdentifier(getChecksumColumnAlias(column)))));\n+        Expression arrayCardinalitySum = new CoalesceExpression(\n+                new FunctionCall(\n+                        QualifiedName.of(\"sum\"),\n+                        ImmutableList.of(new FunctionCall(QualifiedName.of(\"cardinality\"), ImmutableList.of(column.getIdentifier())))),\n+                new LongLiteral(\"0\"));\n+\n+        return ImmutableList.of(\n+                new SingleColumn(checksum, Optional.of(delimitedIdentifier(getChecksumColumnAlias(column)))),\n+                new SingleColumn(arrayCardinalitySum, Optional.of(delimitedIdentifier(getCardinalitySumColumnAlias(column)))));\n     }\n \n     @Override\n     public ColumnMatchResult validate(Column column, ChecksumResult controlResult, ChecksumResult testResult)\n     {\n         String sortedChecksumColumnAlias = getChecksumColumnAlias(column);\n-        Object controlSortedChecksum = controlResult.getChecksum(sortedChecksumColumnAlias);\n-        Object testSortedChecksum = testResult.getChecksum(sortedChecksumColumnAlias);\n+        Object controlChecksum = controlResult.getChecksum(sortedChecksumColumnAlias);\n+        Object testChecksum = testResult.getChecksum(sortedChecksumColumnAlias);\n+\n+        String cardinalitySumColumnAlias = getCardinalitySumColumnAlias(column);\n+        Object controlCardinalitySum = controlResult.getChecksum(cardinalitySumColumnAlias);\n+        Object testCardinalitySum = testResult.getChecksum(cardinalitySumColumnAlias);\n+\n         return new ColumnMatchResult(\n-                Objects.equals(controlSortedChecksum, testSortedChecksum),\n-                format(\"control(checksum: %s) test(checksum: %s)\", controlSortedChecksum, testSortedChecksum));\n+                Objects.equals(controlChecksum, testChecksum) && Objects.equals(controlCardinalitySum, testCardinalitySum),\n+                format(\"control(checksum: %s, cardinality_sum: %s) test(checksum: %s, cardinality_sum: %s)\",\n+                        controlChecksum, controlCardinalitySum, testChecksum, testCardinalitySum));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk3OTkzNw=="}, "originalCommit": {"oid": "ca896b76bc8c6c0b7a71b759c7df116f1b2536b8"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0MTQ3MjQyOnYy", "diffSide": "RIGHT", "path": "presto-verifier/src/test/java/com/facebook/presto/verifier/checksum/TestChecksumValidator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QyMjoyMToxNlrOFaKk_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QyMjoyMToxNlrOFaKk_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk4MDYwNA==", "bodyText": "Line break is off:\n.put(\n    INT_ARRAY_COLUMN,\n    new ColumnMatchResult(false, \"control(checksum: 0a, cardinality_sum: 3) test(checksum: 1a, cardinality_sum: 2)\"))\n.put(\n    MAP_ARRAY_COLUMN,\n    new ColumnMatchResult(false, \"control(checksum: 0b, cardinality_sum: 7) test(checksum: 1b, cardinality_sum: 5)\"))", "url": "https://github.com/prestodb/presto/pull/13916#discussion_r362980604", "createdAt": "2020-01-03T22:21:16Z", "author": {"login": "caithagoras"}, "path": "presto-verifier/src/test/java/com/facebook/presto/verifier/checksum/TestChecksumValidator.java", "diffHunk": "@@ -285,24 +288,48 @@ public void testArray()\n                 5,\n                 ImmutableMap.<String, Object>builder()\n                         .put(\"int_array_checksum\", new SqlVarbinary(new byte[] {0xa}))\n+                        .put(\"int_array_cardinality_sum\", 3L)\n                         .put(\"map_array_checksum\", new SqlVarbinary(new byte[] {0xb}))\n+                        .put(\"map_array_cardinality_sum\", 7L)\n                         .build());\n \n         // Matched\n         assertTrue(checksumValidator.getMismatchedColumns(columns, controlChecksum, controlChecksum).isEmpty());\n \n-        // Mismatched\n+        // Mismatched different elements\n         ChecksumResult testChecksum = new ChecksumResult(\n                 5,\n                 ImmutableMap.<String, Object>builder()\n                         .put(\"int_array_checksum\", new SqlVarbinary(new byte[] {0x1a}))\n+                        .put(\"int_array_cardinality_sum\", 3L)\n+                        .put(\"map_array_checksum\", new SqlVarbinary(new byte[] {0x1b}))\n+                        .put(\"map_array_cardinality_sum\", 7L)\n+                        .build());\n+        assertEquals(\n+                checksumValidator.getMismatchedColumns(columns, controlChecksum, testChecksum),\n+                ImmutableMap.builder()\n+                        .put(INT_ARRAY_COLUMN, new ColumnMatchResult(false,\n+                                \"control(checksum: 0a, cardinality_sum: 3) test(checksum: 1a, cardinality_sum: 3)\"))\n+                        .put(MAP_ARRAY_COLUMN, new ColumnMatchResult(false,\n+                                \"control(checksum: 0b, cardinality_sum: 7) test(checksum: 1b, cardinality_sum: 7)\"))\n+                        .build());\n+\n+        // Mismatched different cardinality sum\n+        testChecksum = new ChecksumResult(\n+                5,\n+                ImmutableMap.<String, Object>builder()\n+                        .put(\"int_array_checksum\", new SqlVarbinary(new byte[] {0x1a}))\n+                        .put(\"int_array_cardinality_sum\", 2L)\n                         .put(\"map_array_checksum\", new SqlVarbinary(new byte[] {0x1b}))\n+                        .put(\"map_array_cardinality_sum\", 5L)\n                         .build());\n         assertEquals(\n                 checksumValidator.getMismatchedColumns(columns, controlChecksum, testChecksum),\n                 ImmutableMap.builder()\n-                        .put(INT_ARRAY_COLUMN, new ColumnMatchResult(false, \"control(checksum: 0a) test(checksum: 1a)\"))\n-                        .put(MAP_ARRAY_COLUMN, new ColumnMatchResult(false, \"control(checksum: 0b) test(checksum: 1b)\"))\n+                        .put(INT_ARRAY_COLUMN, new ColumnMatchResult(false,\n+                                \"control(checksum: 0a, cardinality_sum: 3) test(checksum: 1a, cardinality_sum: 2)\"))\n+                        .put(MAP_ARRAY_COLUMN, new ColumnMatchResult(false,\n+                                \"control(checksum: 0b, cardinality_sum: 7) test(checksum: 1b, cardinality_sum: 5)\"))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca896b76bc8c6c0b7a71b759c7df116f1b2536b8"}, "originalPosition": 60}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0MTQ3NzAxOnYy", "diffSide": "RIGHT", "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/checksum/ArrayColumnValidator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QyMjoyNDowMFrOFaKnnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QyMjoyNDowMFrOFaKnnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk4MTI3OQ==", "bodyText": "Also, rename this to checksumColumnAlias in the first commit.", "url": "https://github.com/prestodb/presto/pull/13916#discussion_r362981279", "createdAt": "2020-01-03T22:24:00Z", "author": {"login": "caithagoras"}, "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/checksum/ArrayColumnValidator.java", "diffHunk": "@@ -67,22 +68,41 @@ public ArrayColumnValidator()\n             checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier()));\n         }\n \n-        return ImmutableList.of(new SingleColumn(checksum, Optional.of(delimitedIdentifier(getChecksumColumnAlias(column)))));\n+        Expression arrayCardinalitySum = new CoalesceExpression(\n+                new FunctionCall(\n+                        QualifiedName.of(\"sum\"),\n+                        ImmutableList.of(new FunctionCall(QualifiedName.of(\"cardinality\"), ImmutableList.of(column.getIdentifier())))),\n+                new LongLiteral(\"0\"));\n+\n+        return ImmutableList.of(\n+                new SingleColumn(checksum, Optional.of(delimitedIdentifier(getChecksumColumnAlias(column)))),\n+                new SingleColumn(arrayCardinalitySum, Optional.of(delimitedIdentifier(getCardinalitySumColumnAlias(column)))));\n     }\n \n     @Override\n     public ColumnMatchResult validate(Column column, ChecksumResult controlResult, ChecksumResult testResult)\n     {\n         String sortedChecksumColumnAlias = getChecksumColumnAlias(column);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca896b76bc8c6c0b7a71b759c7df116f1b2536b8"}, "originalPosition": 27}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2127, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}