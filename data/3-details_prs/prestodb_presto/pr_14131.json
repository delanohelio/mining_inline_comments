{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4MDQzMzYy", "number": 14131, "title": "Use concurrent scheduler for timeout executor", "bodyText": "To avoid contention during task scheduling.\n== RELEASE NOTES ==\n\nGeneral Changes\n*  Add configuration ``task.http-timeout-concurrency`` to improve performance of task timeout executors", "createdAt": "2020-02-21T00:20:18Z", "url": "https://github.com/prestodb/presto/pull/14131", "merged": true, "mergeCommit": {"oid": "20aa3228be1317c74659be6a57003b79e738ae55"}, "closed": true, "closedAt": "2020-02-25T19:30:59Z", "author": {"login": "viczhang861"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcGjJ7cgFqTM2Mjc4OTU1MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcH1kzPgFqTM2NDMxNzE5NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyNzg5NTUw", "url": "https://github.com/prestodb/presto/pull/14131#pullrequestreview-362789550", "createdAt": "2020-02-21T17:21:06Z", "commit": {"oid": "d1594a0d9d091c373e840f2b26c04ef9f5c498a7"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxNzoyMTowNlrOFs-izA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxNzoyMTowNlrOFs-izA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjcwNjM4MA==", "bodyText": "Number of threads and concurrency is not totally clear because usually those are these same thing. What is the documentation update associated with this change? Can we make it clearer both in the code and in the docs how this config should be used?\nAlso the fact that division takes place here https://github.com/prestodb/airlift/blob/master/concurrent/src/main/java/com/facebook/airlift/concurrent/ConcurrentScheduledExecutor.java#L77 and you might get less threads than you asked for is not intuitive.\nIdeally the config would be # of executors and # of threads per executor. I am guessing we did it this way to maintain compatibility with existing configuration?", "url": "https://github.com/prestodb/presto/pull/14131#discussion_r382706380", "createdAt": "2020-02-21T17:21:06Z", "author": {"login": "aweisberg"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/TaskManagerConfig.java", "diffHunk": "@@ -455,6 +456,19 @@ public TaskManagerConfig setHttpTimeoutThreads(int httpTimeoutThreads)\n         return this;\n     }\n \n+    @Min(1)\n+    public int getHttpTimeoutConcurrency()\n+    {\n+        return httpTimeoutConcurrency;\n+    }\n+\n+    @Config(\"task.http-timeout-concurrency\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1594a0d9d091c373e840f2b26c04ef9f5c498a7"}, "originalPosition": 18}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d1594a0d9d091c373e840f2b26c04ef9f5c498a7", "author": {"user": {"login": "viczhang861", "name": "Vic Zhang"}}, "url": "https://github.com/prestodb/presto/commit/d1594a0d9d091c373e840f2b26c04ef9f5c498a7", "committedDate": "2020-02-21T00:16:04Z", "message": "Use concurrent scheduler for timeout executor\n\nTo avoid contention during task scheduling."}, "afterCommit": {"oid": "4935c278d1ac8fb7bb56afee86cfc8646202f693", "author": {"user": {"login": "viczhang861", "name": "Vic Zhang"}}, "url": "https://github.com/prestodb/presto/commit/4935c278d1ac8fb7bb56afee86cfc8646202f693", "committedDate": "2020-02-21T19:40:47Z", "message": "Use concurrent scheduler for timeout executor\n\nUse multiple thread pool (configured by task.http-timeout-concurrency)\nfor timeout thread and avoid contention during task scheduling."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMTY5Mzcy", "url": "https://github.com/prestodb/presto/pull/14131#pullrequestreview-363169372", "createdAt": "2020-02-24T04:53:35Z", "commit": {"oid": "4935c278d1ac8fb7bb56afee86cfc8646202f693"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzNDk2MzEz", "url": "https://github.com/prestodb/presto/pull/14131#pullrequestreview-363496313", "createdAt": "2020-02-24T15:54:41Z", "commit": {"oid": "4935c278d1ac8fb7bb56afee86cfc8646202f693"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxNTo1NDo0MVrOFtlzyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxNjowNjozM1rOFtmRuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM0OTcwNg==", "bodyText": "Total number of threads dedicated to run timeout handlers of http requests", "url": "https://github.com/prestodb/presto/pull/14131#discussion_r383349706", "createdAt": "2020-02-24T15:54:41Z", "author": {"login": "arhimondr"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/TaskManagerConfig.java", "diffHunk": "@@ -449,12 +450,27 @@ public int getHttpTimeoutThreads()\n     }\n \n     @Config(\"task.http-timeout-threads\")\n+    @ConfigDescription(\"Total number of timeout threads\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4935c278d1ac8fb7bb56afee86cfc8646202f693"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM1NTQ1OQ==", "bodyText": "Maybe\nThe estimated number of timeout handlers being attached concurrently? Or something similar?\nBasically in the description we should express that those two properties are different, and are used to configure different concurrency level.\n\ntask.http-timeout-threads - number of threads that are processing timeout handlers\ntask.http-timeout-concurrency - estimated number of threads (or estimated thread congestion) when attaching timeout handlers", "url": "https://github.com/prestodb/presto/pull/14131#discussion_r383355459", "createdAt": "2020-02-24T16:03:29Z", "author": {"login": "arhimondr"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/TaskManagerConfig.java", "diffHunk": "@@ -449,12 +450,27 @@ public int getHttpTimeoutThreads()\n     }\n \n     @Config(\"task.http-timeout-threads\")\n+    @ConfigDescription(\"Total number of timeout threads\")\n     public TaskManagerConfig setHttpTimeoutThreads(int httpTimeoutThreads)\n     {\n         this.httpTimeoutThreads = httpTimeoutThreads;\n         return this;\n     }\n \n+    @Min(1)\n+    public int getHttpTimeoutConcurrency()\n+    {\n+        return httpTimeoutConcurrency;\n+    }\n+\n+    @Config(\"task.http-timeout-concurrency\")\n+    @ConfigDescription(\"Number of thread pool to divide threads configured by property task.http-timeout-threads\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4935c278d1ac8fb7bb56afee86cfc8646202f693"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM1NzM2OA==", "bodyText": "The ScheduledExecutorService does not expose any JMX properties by itself. Instead some kind of ConcurrentScheduledExecutorMBean has to be implemented. The ConcurrentScheduledExecutorMBean should expose ConcurrentScheduledExecutor specific statistics, similar to how the ThreadPoolExecutorMBean exposes the stats for ThreadPoolExecutor.\nWe can do this as a follow up. As for now i would rather prefer the  timeoutExecutor to be completely removed. As since it is does not provide any MXBean stats keeping it here is only misleading.", "url": "https://github.com/prestodb/presto/pull/14131#discussion_r383357368", "createdAt": "2020-02-24T16:06:33Z", "author": {"login": "arhimondr"}, "path": "presto-main/src/main/java/com/facebook/presto/server/AsyncHttpExecutionMBean.java", "diffHunk": "@@ -28,15 +28,15 @@\n public class AsyncHttpExecutionMBean\n {\n     private final ThreadPoolExecutorMBean responseExecutor;\n-    private final ThreadPoolExecutorMBean timeoutExecutor;\n+    private final ScheduledExecutorService timeoutExecutor;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4935c278d1ac8fb7bb56afee86cfc8646202f693"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4935c278d1ac8fb7bb56afee86cfc8646202f693", "author": {"user": {"login": "viczhang861", "name": "Vic Zhang"}}, "url": "https://github.com/prestodb/presto/commit/4935c278d1ac8fb7bb56afee86cfc8646202f693", "committedDate": "2020-02-21T19:40:47Z", "message": "Use concurrent scheduler for timeout executor\n\nUse multiple thread pool (configured by task.http-timeout-concurrency)\nfor timeout thread and avoid contention during task scheduling."}, "afterCommit": {"oid": "21f228181067052a180d317fc10a3706cdad16ab", "author": {"user": {"login": "viczhang861", "name": "Vic Zhang"}}, "url": "https://github.com/prestodb/presto/commit/21f228181067052a180d317fc10a3706cdad16ab", "committedDate": "2020-02-25T00:13:43Z", "message": "Use concurrent scheduler for timeout executor\n\nUse multiple thread pool (configured by task.http-timeout-concurrency)\nfor timeout thread and avoid contention during task scheduling."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac0851299f1f03394aa51be7c01851f3245d4dd8", "author": {"user": {"login": "viczhang861", "name": "Vic Zhang"}}, "url": "https://github.com/prestodb/presto/commit/ac0851299f1f03394aa51be7c01851f3245d4dd8", "committedDate": "2020-02-25T00:19:23Z", "message": "Use concurrent scheduler for timeout executor\n\nUse multiple thread pool (configured by task.http-timeout-concurrency)\nfor timeout thread and avoid contention during task scheduling."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "21f228181067052a180d317fc10a3706cdad16ab", "author": {"user": {"login": "viczhang861", "name": "Vic Zhang"}}, "url": "https://github.com/prestodb/presto/commit/21f228181067052a180d317fc10a3706cdad16ab", "committedDate": "2020-02-25T00:13:43Z", "message": "Use concurrent scheduler for timeout executor\n\nUse multiple thread pool (configured by task.http-timeout-concurrency)\nfor timeout thread and avoid contention during task scheduling."}, "afterCommit": {"oid": "ac0851299f1f03394aa51be7c01851f3245d4dd8", "author": {"user": {"login": "viczhang861", "name": "Vic Zhang"}}, "url": "https://github.com/prestodb/presto/commit/ac0851299f1f03394aa51be7c01851f3245d4dd8", "committedDate": "2020-02-25T00:19:23Z", "message": "Use concurrent scheduler for timeout executor\n\nUse multiple thread pool (configured by task.http-timeout-concurrency)\nfor timeout thread and avoid contention during task scheduling."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0MTcyMjEz", "url": "https://github.com/prestodb/presto/pull/14131#pullrequestreview-364172213", "createdAt": "2020-02-25T14:15:49Z", "commit": {"oid": "ac0851299f1f03394aa51be7c01851f3245d4dd8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0MzE3MTk1", "url": "https://github.com/prestodb/presto/pull/14131#pullrequestreview-364317195", "createdAt": "2020-02-25T17:28:43Z", "commit": {"oid": "ac0851299f1f03394aa51be7c01851f3245d4dd8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2281, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}