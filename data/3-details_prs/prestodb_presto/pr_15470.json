{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI1NDMyNDI1", "number": 15470, "title": "Ensure nullable partitioning column is handled properly", "bodyText": "== RELEASE NOTE ==\n\nHive changes\n* Fix dynamic pruning failures for joining on null keys in hive partition", "createdAt": "2020-11-23T04:07:10Z", "url": "https://github.com/prestodb/presto/pull/15470", "merged": true, "mergeCommit": {"oid": "729554d3a5b83909322417703992f8cc5e764497"}, "closed": true, "closedAt": "2020-12-08T03:04:58Z", "author": {"login": "fgwang7w"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdgs0kLgFqTU0MDE1MDY2NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdj6F8LABqjQwODExMzI4MTg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwMTUwNjY0", "url": "https://github.com/prestodb/presto/pull/15470#pullrequestreview-540150664", "createdAt": "2020-11-27T19:36:03Z", "commit": {"oid": "7ec3b1eceec6e8b86282298c30206703a90e5908"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7ec3b1eceec6e8b86282298c30206703a90e5908", "author": {"user": {"login": "fgwang7w", "name": "countryman4687"}}, "url": "https://github.com/prestodb/presto/commit/7ec3b1eceec6e8b86282298c30206703a90e5908", "committedDate": "2020-11-23T04:03:21Z", "message": "add ut coverage"}, "afterCommit": {"oid": "104ea5ed0381f79ed2564cda7ed2e04311c3d5f7", "author": {"user": {"login": "fgwang7w", "name": "countryman4687"}}, "url": "https://github.com/prestodb/presto/commit/104ea5ed0381f79ed2564cda7ed2e04311c3d5f7", "committedDate": "2020-11-29T07:30:14Z", "message": "Ensure nullable partitioning column is handled properly"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "104ea5ed0381f79ed2564cda7ed2e04311c3d5f7", "author": {"user": {"login": "fgwang7w", "name": "countryman4687"}}, "url": "https://github.com/prestodb/presto/commit/104ea5ed0381f79ed2564cda7ed2e04311c3d5f7", "committedDate": "2020-11-29T07:30:14Z", "message": "Ensure nullable partitioning column is handled properly"}, "afterCommit": {"oid": "bf9252927ea07c36b02817e2bcd3e6876d9cf851", "author": {"user": {"login": "fgwang7w", "name": "countryman4687"}}, "url": "https://github.com/prestodb/presto/commit/bf9252927ea07c36b02817e2bcd3e6876d9cf851", "committedDate": "2020-12-01T19:56:40Z", "message": "Ensure nullable partitioning column is handled properly"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bf9252927ea07c36b02817e2bcd3e6876d9cf851", "author": {"user": {"login": "fgwang7w", "name": "countryman4687"}}, "url": "https://github.com/prestodb/presto/commit/bf9252927ea07c36b02817e2bcd3e6876d9cf851", "committedDate": "2020-12-01T19:56:40Z", "message": "Ensure nullable partitioning column is handled properly"}, "afterCommit": {"oid": "57e27f3a86a2fedbd117aca244077e5c6c54cede", "author": {"user": {"login": "fgwang7w", "name": "countryman4687"}}, "url": "https://github.com/prestodb/presto/commit/57e27f3a86a2fedbd117aca244077e5c6c54cede", "committedDate": "2020-12-03T05:26:02Z", "message": "Ensure nullable partitioning column is handled properly"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "57e27f3a86a2fedbd117aca244077e5c6c54cede", "author": {"user": {"login": "fgwang7w", "name": "countryman4687"}}, "url": "https://github.com/prestodb/presto/commit/57e27f3a86a2fedbd117aca244077e5c6c54cede", "committedDate": "2020-12-03T05:26:02Z", "message": "Ensure nullable partitioning column is handled properly"}, "afterCommit": {"oid": "3bce125070d85eb1150d5279ce646f31c5935627", "author": {"user": {"login": "fgwang7w", "name": "countryman4687"}}, "url": "https://github.com/prestodb/presto/commit/3bce125070d85eb1150d5279ce646f31c5935627", "committedDate": "2020-12-03T05:27:37Z", "message": "Ensure nullable partitioning column is handled properly"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1NzM1NTEx", "url": "https://github.com/prestodb/presto/pull/15470#pullrequestreview-545735511", "createdAt": "2020-12-06T18:33:31Z", "commit": {"oid": "3bce125070d85eb1150d5279ce646f31c5935627"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNlQxODozMzozMVrOIAN1Kg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNlQxODozMzozMVrOIAN1Kg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzA5NzUxNA==", "bodyText": "Let's merge these two lines", "url": "https://github.com/prestodb/presto/pull/15470#discussion_r537097514", "createdAt": "2020-12-06T18:33:31Z", "author": {"login": "kewang1024"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveUtil.java", "diffHunk": "@@ -524,8 +524,8 @@ private static boolean isValidPartitionType(Type type)\n     public static NullableValue parsePartitionValue(String partitionName, String value, Type type, DateTimeZone timeZone)\n     {\n         verifyPartitionTypeSupported(partitionName, type);\n-\n-        boolean isNull = HIVE_DEFAULT_DYNAMIC_PARTITION.equals(value);\n+        byte[] bytes = value.getBytes(UTF_8);\n+        boolean isNull = HIVE_DEFAULT_DYNAMIC_PARTITION.equals(value) || isHiveNull(bytes);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3bce125070d85eb1150d5279ce646f31c5935627"}, "originalPosition": 7}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3bce125070d85eb1150d5279ce646f31c5935627", "author": {"user": {"login": "fgwang7w", "name": "countryman4687"}}, "url": "https://github.com/prestodb/presto/commit/3bce125070d85eb1150d5279ce646f31c5935627", "committedDate": "2020-12-03T05:27:37Z", "message": "Ensure nullable partitioning column is handled properly"}, "afterCommit": {"oid": "ee684372eb6b6479837243c210b7cb90327b7f1d", "author": {"user": {"login": "fgwang7w", "name": "countryman4687"}}, "url": "https://github.com/prestodb/presto/commit/ee684372eb6b6479837243c210b7cb90327b7f1d", "committedDate": "2020-12-06T21:13:13Z", "message": "Fix dynamic pruning for null keys in hive partition"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1Nzg3ODky", "url": "https://github.com/prestodb/presto/pull/15470#pullrequestreview-545787892", "createdAt": "2020-12-07T02:10:22Z", "commit": {"oid": "ee684372eb6b6479837243c210b7cb90327b7f1d"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QwMjoxMDoyMlrOIATITg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QwMjoxMDozM1rOIATIcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzE4NDMzNA==", "bodyText": "containsValue", "url": "https://github.com/prestodb/presto/pull/15470#discussion_r537184334", "createdAt": "2020-12-07T02:10:22Z", "author": {"login": "highker"}, "path": "presto-hive/src/test/java/com/facebook/presto/hive/statistics/TestMetastoreHiveStatisticsProvider.java", "diffHunk": "@@ -116,6 +118,14 @@ public void testGetPartitionsSample()\n         assertEquals(getPartitionsSample(ImmutableList.of(p1, p2, p3, p4, p5), 3), ImmutableList.of(p1, p5, p4));\n     }\n \n+    @Test\n+    public void testNullablePartitionValue()\n+    {\n+        HivePartition part = partition(\"p1=name/p2=\\\\N\");\n+        NullableValue verify = new NullableValue(BIGINT, null);\n+        assertTrue(part.getKeys().values().contains(verify));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ee684372eb6b6479837243c210b7cb90327b7f1d"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzE4NDM3MQ==", "bodyText": "break a line after this", "url": "https://github.com/prestodb/presto/pull/15470#discussion_r537184371", "createdAt": "2020-12-07T02:10:33Z", "author": {"login": "highker"}, "path": "presto-hive/src/test/java/com/facebook/presto/hive/TestHiveDistributedJoinQueriesWithDynamicFiltering.java", "diffHunk": "@@ -110,6 +110,22 @@ public void testJoinDynamicFilteringMultiJoin()\n         assertQuery(session, query, \"SELECT 1, 1, 1\");\n     }\n \n+    @Test\n+    public void testJoinOnNullPartitioning()\n+    {\n+        assertUpdate(\"CREATE TABLE t3(c2 bigint, c1 bigint)\");\n+        assertUpdate(\"INSERT INTO t3 VALUES(null, 2)\", 1);\n+        assertUpdate(\"CREATE TABLE t4(c2 bigint, c1 bigint) with(partitioned_by=array['c1'])\");\n+        assertUpdate(\"INSERT INTO t4 VALUES(null, null), (2,2)\", 2);\n+\n+        String query = \"select * from t3, t4 where t3.c1=t4.c2\";\n+        Session session = Session.builder(getSession())\n+                .setSystemProperty(ENABLE_DYNAMIC_FILTERING, \"true\")\n+                .setSystemProperty(JOIN_DISTRIBUTION_TYPE, FeaturesConfig.JoinDistributionType.AUTOMATIC.name())\n+                .setSystemProperty(JOIN_REORDERING_STRATEGY, FeaturesConfig.JoinReorderingStrategy.AUTOMATIC.name())\n+                .build();\n+        assertQuery(session, query, \"SELECT null, 2, 2, 2\");\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ee684372eb6b6479837243c210b7cb90327b7f1d"}, "originalPosition": 19}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ee684372eb6b6479837243c210b7cb90327b7f1d", "author": {"user": {"login": "fgwang7w", "name": "countryman4687"}}, "url": "https://github.com/prestodb/presto/commit/ee684372eb6b6479837243c210b7cb90327b7f1d", "committedDate": "2020-12-06T21:13:13Z", "message": "Fix dynamic pruning for null keys in hive partition"}, "afterCommit": {"oid": "c9e8a5ccd77f05fb2314ec9864e0af8ac4c741da", "author": {"user": {"login": "fgwang7w", "name": "countryman4687"}}, "url": "https://github.com/prestodb/presto/commit/c9e8a5ccd77f05fb2314ec9864e0af8ac4c741da", "committedDate": "2020-12-07T03:56:54Z", "message": "Fix dynamic pruning for null keys in hive partition"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c9e8a5ccd77f05fb2314ec9864e0af8ac4c741da", "author": {"user": {"login": "fgwang7w", "name": "countryman4687"}}, "url": "https://github.com/prestodb/presto/commit/c9e8a5ccd77f05fb2314ec9864e0af8ac4c741da", "committedDate": "2020-12-07T03:56:54Z", "message": "Fix dynamic pruning for null keys in hive partition"}, "afterCommit": {"oid": "8cd223c66f4d8c2cdb347f8e33d03f7ad0bb5eaa", "author": {"user": {"login": "fgwang7w", "name": "countryman4687"}}, "url": "https://github.com/prestodb/presto/commit/8cd223c66f4d8c2cdb347f8e33d03f7ad0bb5eaa", "committedDate": "2020-12-07T05:58:54Z", "message": "Fix dynamic pruning for null keys in hive partition"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f19f988b2ddfa980e5bb332c77719a30de0e109", "author": {"user": {"login": "fgwang7w", "name": "countryman4687"}}, "url": "https://github.com/prestodb/presto/commit/8f19f988b2ddfa980e5bb332c77719a30de0e109", "committedDate": "2020-12-07T18:44:48Z", "message": "Fix dynamic pruning for null keys in hive partition"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8cd223c66f4d8c2cdb347f8e33d03f7ad0bb5eaa", "author": {"user": {"login": "fgwang7w", "name": "countryman4687"}}, "url": "https://github.com/prestodb/presto/commit/8cd223c66f4d8c2cdb347f8e33d03f7ad0bb5eaa", "committedDate": "2020-12-07T05:58:54Z", "message": "Fix dynamic pruning for null keys in hive partition"}, "afterCommit": {"oid": "8f19f988b2ddfa980e5bb332c77719a30de0e109", "author": {"user": {"login": "fgwang7w", "name": "countryman4687"}}, "url": "https://github.com/prestodb/presto/commit/8f19f988b2ddfa980e5bb332c77719a30de0e109", "committedDate": "2020-12-07T18:44:48Z", "message": "Fix dynamic pruning for null keys in hive partition"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4756, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}