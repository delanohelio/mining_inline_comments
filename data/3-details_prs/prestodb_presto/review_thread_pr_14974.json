{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYzNzM4MzAw", "number": 14974, "reviewThreads": {"totalCount": 63, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxODozNDoyNlrOEZLEFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwNDozNzozM1rOEpT6Vw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0ODMxMTI3OnYy", "diffSide": "RIGHT", "path": "presto-spi/src/main/java/com/facebook/presto/spi/connector/ConnectorPageSinkProvider.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxODozNDoyNlrOHB1z_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwNDo0ODo1M1rOHCDNcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY5MjI4NQ==", "bodyText": "I think we can directly inject ConnectorDistributedMetadataUpdater into the underlying page sink provider then passing through SPI? The design principle is to keep spi as simple as possible", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r471692285", "createdAt": "2020-08-17T18:34:26Z", "author": {"login": "highker"}, "path": "presto-spi/src/main/java/com/facebook/presto/spi/connector/ConnectorPageSinkProvider.java", "diffHunk": "@@ -19,9 +19,11 @@\n import com.facebook.presto.spi.ConnectorSession;\n import com.facebook.presto.spi.PageSinkProperties;\n \n+import java.util.Optional;\n+\n public interface ConnectorPageSinkProvider\n {\n-    ConnectorPageSink createPageSink(ConnectorTransactionHandle transactionHandle, ConnectorSession session, ConnectorOutputTableHandle outputTableHandle, PageSinkProperties pageSinkProperties);\n+    ConnectorPageSink createPageSink(ConnectorTransactionHandle transactionHandle, ConnectorSession session, ConnectorOutputTableHandle outputTableHandle, Optional<ConnectorDistributedMetadataUpdater> distributedMetadataUpdater, PageSinkProperties pageSinkProperties);\n \n-    ConnectorPageSink createPageSink(ConnectorTransactionHandle transactionHandle, ConnectorSession session, ConnectorInsertTableHandle insertTableHandle, PageSinkProperties pageSinkProperties);\n+    ConnectorPageSink createPageSink(ConnectorTransactionHandle transactionHandle, ConnectorSession session, ConnectorInsertTableHandle insertTableHandle, Optional<ConnectorDistributedMetadataUpdater> distributedMetadataUpdater, PageSinkProperties pageSinkProperties);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c89651f81df712cdb7f81a73d1f625a0c36d0c93"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTkxMTc5NA==", "bodyText": "Got it.", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r471911794", "createdAt": "2020-08-18T04:48:53Z", "author": {"login": "NikhilCollooru"}, "path": "presto-spi/src/main/java/com/facebook/presto/spi/connector/ConnectorPageSinkProvider.java", "diffHunk": "@@ -19,9 +19,11 @@\n import com.facebook.presto.spi.ConnectorSession;\n import com.facebook.presto.spi.PageSinkProperties;\n \n+import java.util.Optional;\n+\n public interface ConnectorPageSinkProvider\n {\n-    ConnectorPageSink createPageSink(ConnectorTransactionHandle transactionHandle, ConnectorSession session, ConnectorOutputTableHandle outputTableHandle, PageSinkProperties pageSinkProperties);\n+    ConnectorPageSink createPageSink(ConnectorTransactionHandle transactionHandle, ConnectorSession session, ConnectorOutputTableHandle outputTableHandle, Optional<ConnectorDistributedMetadataUpdater> distributedMetadataUpdater, PageSinkProperties pageSinkProperties);\n \n-    ConnectorPageSink createPageSink(ConnectorTransactionHandle transactionHandle, ConnectorSession session, ConnectorInsertTableHandle insertTableHandle, PageSinkProperties pageSinkProperties);\n+    ConnectorPageSink createPageSink(ConnectorTransactionHandle transactionHandle, ConnectorSession session, ConnectorInsertTableHandle insertTableHandle, Optional<ConnectorDistributedMetadataUpdater> distributedMetadataUpdater, PageSinkProperties pageSinkProperties);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY5MjI4NQ=="}, "originalCommit": {"oid": "c89651f81df712cdb7f81a73d1f625a0c36d0c93"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0ODQwMzIzOnYy", "diffSide": "RIGHT", "path": "presto-spi/src/main/java/com/facebook/presto/spi/connector/ConnectorMetadata.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxODo0OTozOFrOHB2zPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxODo0OTozOFrOHB2zPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTcwODQ3Nw==", "bodyText": "ConnectorMetadataUpdateHandle updateMetadata(ConnectorSession session, ConnectorMetadataUpdateHandle handle)\nLikely you can squeeze input and output into one object. But if not, feel free to create two handle interfaces", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r471708477", "createdAt": "2020-08-17T18:49:38Z", "author": {"login": "highker"}, "path": "presto-spi/src/main/java/com/facebook/presto/spi/connector/ConnectorMetadata.java", "diffHunk": "@@ -700,6 +702,14 @@ default void revokeTablePrivileges(ConnectorSession session, SchemaTableName tab\n         throw new PrestoException(NOT_SUPPORTED, \"This connector does not support page sink commit\");\n     }\n \n+    /**\n+     * Handles metadata update requests and sends the results back to worker\n+     */\n+    default List<MetadataUpdateResult> updateMetadata(List<MetadataUpdateRequest> metadataUpdateRequests, String queryId)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c89651f81df712cdb7f81a73d1f625a0c36d0c93"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0ODQwNjMwOnYy", "diffSide": "RIGHT", "path": "presto-spi/src/main/java/com/facebook/presto/spi/MetadataUpdateRequest.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxODo1MDoyNlrOHB20-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNjoyNDo0N1rOHCcT4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTcwODkyMg==", "bodyText": "ConnectorMetadataUpdateHandle. We don't need to define anything in the field. Check how other handle interfaces are defined.", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r471708922", "createdAt": "2020-08-17T18:50:26Z", "author": {"login": "highker"}, "path": "presto-spi/src/main/java/com/facebook/presto/spi/MetadataUpdateRequest.java", "diffHunk": "@@ -0,0 +1,21 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.spi;\n+\n+public interface MetadataUpdateRequest", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c89651f81df712cdb7f81a73d1f625a0c36d0c93"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTkxOTIwNg==", "bodyText": "We need to create update request object before sending to coordinator. To create that object we need ConnectorMetadataUpdateHandle to have basic interface functions right ?", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r471919206", "createdAt": "2020-08-18T05:16:32Z", "author": {"login": "NikhilCollooru"}, "path": "presto-spi/src/main/java/com/facebook/presto/spi/MetadataUpdateRequest.java", "diffHunk": "@@ -0,0 +1,21 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.spi;\n+\n+public interface MetadataUpdateRequest", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTcwODkyMg=="}, "originalCommit": {"oid": "c89651f81df712cdb7f81a73d1f625a0c36d0c93"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMyMzA0Mg==", "bodyText": "All these functions are called hive connector. We usually don't put anything in engine level. If we wanna delegate to underlying connectors, we do downcast within its connector.", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r472323042", "createdAt": "2020-08-18T16:24:47Z", "author": {"login": "highker"}, "path": "presto-spi/src/main/java/com/facebook/presto/spi/MetadataUpdateRequest.java", "diffHunk": "@@ -0,0 +1,21 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.spi;\n+\n+public interface MetadataUpdateRequest", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTcwODkyMg=="}, "originalCommit": {"oid": "c89651f81df712cdb7f81a73d1f625a0c36d0c93"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0ODQyMTczOnYy", "diffSide": "RIGHT", "path": "presto-spi/src/main/java/com/facebook/presto/spi/connector/ConnectorDistributedMetadataUpdater.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxODo1NToyMFrOHB2-nA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxODo1NToyMFrOHB2-nA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTcxMTM4OA==", "bodyText": "We only need to expose interfaces that are accessed at engine level. For all that are used by connectors only, we don't need to expose them.", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r471711388", "createdAt": "2020-08-17T18:55:20Z", "author": {"login": "highker"}, "path": "presto-spi/src/main/java/com/facebook/presto/spi/connector/ConnectorDistributedMetadataUpdater.java", "diffHunk": "@@ -0,0 +1,33 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.spi.connector;\n+\n+import com.facebook.presto.spi.MetadataUpdateRequest;\n+import com.facebook.presto.spi.MetadataUpdateResult;\n+\n+import java.util.List;\n+import java.util.concurrent.CompletableFuture;\n+\n+public interface ConnectorDistributedMetadataUpdater\n+{\n+    long addMetadataUpdateRequest(int count);\n+\n+    List<MetadataUpdateRequest> getPendingMetadataUpdateRequests();\n+\n+    void removeResultFuture(long requestId);\n+\n+    CompletableFuture<List<String>> getMetadataResult(long requestID);\n+\n+    void setMetadataUpdateResults(List<MetadataUpdateResult> results);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c89651f81df712cdb7f81a73d1f625a0c36d0c93"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0ODQyODI0OnYy", "diffSide": "RIGHT", "path": "presto-spi/src/main/java/com/facebook/presto/spi/MetadataUpdateResult.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxODo1NzowOFrOHB3ClA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxODo1NzowOFrOHB3ClA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTcxMjQwNA==", "bodyText": "same", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r471712404", "createdAt": "2020-08-17T18:57:08Z", "author": {"login": "highker"}, "path": "presto-spi/src/main/java/com/facebook/presto/spi/MetadataUpdateResult.java", "diffHunk": "@@ -0,0 +1,23 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.spi;\n+\n+import java.util.List;\n+\n+public interface MetadataUpdateResult\n+{\n+    long getRequestId();\n+\n+    List<String> getUpdates();\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c89651f81df712cdb7f81a73d1f625a0c36d0c93"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1MjQ1OTIxOnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveDistributedMetadataUpdater.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNjo0OTo1NlrOHCdSBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNjo0OTo1NlrOHCdSBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMzODk1MQ==", "bodyText": "Within a connector, we need to use the concrete implementation as much as possible. Just downcast", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r472338951", "createdAt": "2020-08-18T16:49:56Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveDistributedMetadataUpdater.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import com.facebook.airlift.concurrent.MoreFutures;\n+import com.facebook.presto.spi.ConnectorMetadataUpdateHandle;\n+import com.facebook.presto.spi.connector.ConnectorDistributedMetadataUpdater;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.util.concurrent.SettableFuture;\n+\n+import javax.inject.Inject;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.Queue;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ConcurrentLinkedQueue;\n+import java.util.concurrent.ConcurrentMap;\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+public class HiveDistributedMetadataUpdater\n+        implements ConnectorDistributedMetadataUpdater\n+{\n+    public static final Optional<ConnectorDistributedMetadataUpdater> DEFAULT_HIVE_METADATA_UPDATER = Optional.of(new HiveDistributedMetadataUpdater());\n+\n+    private final ConcurrentMap<Long, SettableFuture<List<String>>> requestResultFutureMap = new ConcurrentHashMap<>();\n+    private final Queue<HiveMetadataUpdate> metadataUpdateRequestQueue = new ConcurrentLinkedQueue<>();\n+    private final AtomicLong requestIdGenerator = new AtomicLong();\n+\n+    @Inject\n+    public HiveDistributedMetadataUpdater() {}\n+\n+    @Override\n+    public List<ConnectorMetadataUpdateHandle> getPendingMetadataUpdateRequests()\n+    {\n+        ImmutableList.Builder<ConnectorMetadataUpdateHandle> result = new ImmutableList.Builder<>();\n+        for (ConnectorMetadataUpdateHandle request : metadataUpdateRequestQueue) {\n+            result.add(request);\n+        }\n+        return result.build();\n+    }\n+\n+    @Override\n+    public void setMetadataUpdateResults(List<ConnectorMetadataUpdateHandle> results)\n+    {\n+        for (ConnectorMetadataUpdateHandle updateResult : results) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02a0ef734dc5159c630566ad477661b252e3fd3b"}, "originalPosition": 58}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1MjQ2NDY5OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveDistributedMetadataUpdater.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNjo1MToyMFrOHCdVaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNjo1MToyMFrOHCdVaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMzOTgxOQ==", "bodyText": "Map<...>\nI think the key should be a pair of QueryId and partition values", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r472339819", "createdAt": "2020-08-18T16:51:20Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveDistributedMetadataUpdater.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import com.facebook.airlift.concurrent.MoreFutures;\n+import com.facebook.presto.spi.ConnectorMetadataUpdateHandle;\n+import com.facebook.presto.spi.connector.ConnectorDistributedMetadataUpdater;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.util.concurrent.SettableFuture;\n+\n+import javax.inject.Inject;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.Queue;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ConcurrentLinkedQueue;\n+import java.util.concurrent.ConcurrentMap;\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+public class HiveDistributedMetadataUpdater\n+        implements ConnectorDistributedMetadataUpdater\n+{\n+    public static final Optional<ConnectorDistributedMetadataUpdater> DEFAULT_HIVE_METADATA_UPDATER = Optional.of(new HiveDistributedMetadataUpdater());\n+\n+    private final ConcurrentMap<Long, SettableFuture<List<String>>> requestResultFutureMap = new ConcurrentHashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02a0ef734dc5159c630566ad477661b252e3fd3b"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1MjQ2NDk4OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveDistributedMetadataUpdater.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNjo1MToyNlrOHCdVoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNjo1MToyNlrOHCdVoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMzOTg3Mw==", "bodyText": "not used", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r472339873", "createdAt": "2020-08-18T16:51:26Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveDistributedMetadataUpdater.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import com.facebook.airlift.concurrent.MoreFutures;\n+import com.facebook.presto.spi.ConnectorMetadataUpdateHandle;\n+import com.facebook.presto.spi.connector.ConnectorDistributedMetadataUpdater;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.util.concurrent.SettableFuture;\n+\n+import javax.inject.Inject;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.Queue;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ConcurrentLinkedQueue;\n+import java.util.concurrent.ConcurrentMap;\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+public class HiveDistributedMetadataUpdater\n+        implements ConnectorDistributedMetadataUpdater\n+{\n+    public static final Optional<ConnectorDistributedMetadataUpdater> DEFAULT_HIVE_METADATA_UPDATER = Optional.of(new HiveDistributedMetadataUpdater());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02a0ef734dc5159c630566ad477661b252e3fd3b"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1MjQ3OTI4OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveDistributedMetadataUpdater.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNjo1NToxM1rOHCde8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNjo1NToxM1rOHCde8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM0MjI1OQ==", "bodyText": "We might need to inject something light-weighted to track the lifecycle of a query. SqlTaskManager is the closest I can think of. But that is too heavy and not accessible through connectors. We may in the end hook callbacks from HivePageSink to remove dead queries.\nclean up hashmap by hooking it to HiveFileWriter::commit/rollback\nadd an assertion to any integration or smoke tests to assert we don't leak requests. Check 9f89256 as an example", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r472342259", "createdAt": "2020-08-18T16:55:13Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveDistributedMetadataUpdater.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import com.facebook.airlift.concurrent.MoreFutures;\n+import com.facebook.presto.spi.ConnectorMetadataUpdateHandle;\n+import com.facebook.presto.spi.connector.ConnectorDistributedMetadataUpdater;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.util.concurrent.SettableFuture;\n+\n+import javax.inject.Inject;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.Queue;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ConcurrentLinkedQueue;\n+import java.util.concurrent.ConcurrentMap;\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+public class HiveDistributedMetadataUpdater\n+        implements ConnectorDistributedMetadataUpdater\n+{\n+    public static final Optional<ConnectorDistributedMetadataUpdater> DEFAULT_HIVE_METADATA_UPDATER = Optional.of(new HiveDistributedMetadataUpdater());\n+\n+    private final ConcurrentMap<Long, SettableFuture<List<String>>> requestResultFutureMap = new ConcurrentHashMap<>();\n+    private final Queue<HiveMetadataUpdate> metadataUpdateRequestQueue = new ConcurrentLinkedQueue<>();\n+    private final AtomicLong requestIdGenerator = new AtomicLong();\n+\n+    @Inject\n+    public HiveDistributedMetadataUpdater() {}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02a0ef734dc5159c630566ad477661b252e3fd3b"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1Mjc3NjUwOnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveDistributedMetadataUpdater.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxODoxNToxMVrOHCgbDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxODoxNToxMVrOHCgbDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM5MDQxNA==", "bodyText": "use removeIf", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r472390414", "createdAt": "2020-08-18T18:15:11Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveDistributedMetadataUpdater.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import com.facebook.airlift.concurrent.MoreFutures;\n+import com.facebook.presto.spi.ConnectorMetadataUpdateHandle;\n+import com.facebook.presto.spi.connector.ConnectorDistributedMetadataUpdater;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.util.concurrent.SettableFuture;\n+\n+import javax.inject.Inject;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.Queue;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ConcurrentLinkedQueue;\n+import java.util.concurrent.ConcurrentMap;\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+public class HiveDistributedMetadataUpdater\n+        implements ConnectorDistributedMetadataUpdater\n+{\n+    public static final Optional<ConnectorDistributedMetadataUpdater> DEFAULT_HIVE_METADATA_UPDATER = Optional.of(new HiveDistributedMetadataUpdater());\n+\n+    private final ConcurrentMap<Long, SettableFuture<List<String>>> requestResultFutureMap = new ConcurrentHashMap<>();\n+    private final Queue<HiveMetadataUpdate> metadataUpdateRequestQueue = new ConcurrentLinkedQueue<>();\n+    private final AtomicLong requestIdGenerator = new AtomicLong();\n+\n+    @Inject\n+    public HiveDistributedMetadataUpdater() {}\n+\n+    @Override\n+    public List<ConnectorMetadataUpdateHandle> getPendingMetadataUpdateRequests()\n+    {\n+        ImmutableList.Builder<ConnectorMetadataUpdateHandle> result = new ImmutableList.Builder<>();\n+        for (ConnectorMetadataUpdateHandle request : metadataUpdateRequestQueue) {\n+            result.add(request);\n+        }\n+        return result.build();\n+    }\n+\n+    @Override\n+    public void setMetadataUpdateResults(List<ConnectorMetadataUpdateHandle> results)\n+    {\n+        for (ConnectorMetadataUpdateHandle updateResult : results) {\n+            long requestId = updateResult.getRequestId();\n+            List<String> updates = updateResult.getUpdates();\n+\n+            if (!requestResultFutureMap.containsKey(requestId)) {\n+                return;\n+            }\n+\n+            requestResultFutureMap.get(requestId).set(updates);\n+\n+            // remove the request from queue\n+            for (HiveMetadataUpdate request : metadataUpdateRequestQueue) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02a0ef734dc5159c630566ad477661b252e3fd3b"}, "originalPosition": 69}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1Mjc4Nzc5OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadataUpdate.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxODoxODoyMlrOHCgiWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxODoxODoyMlrOHCgiWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM5MjI4MQ==", "bodyText": "tabeName, partitionValues, fileName -> count", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r472392281", "createdAt": "2020-08-18T18:18:22Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadataUpdate.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import com.facebook.presto.spi.ConnectorMetadataUpdateHandle;\n+import com.google.common.collect.ImmutableList;\n+\n+import java.util.List;\n+\n+public class HiveMetadataUpdate\n+        implements ConnectorMetadataUpdateHandle\n+{\n+    private final long requestId;\n+    private final int count;\n+    private final List<String> updates;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02a0ef734dc5159c630566ad477661b252e3fd3b"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1Mjc5OTc4OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveDistributedMetadataUpdater.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxODoyMTozOVrOHCgpxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxODoyMTozOVrOHCgpxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM5NDE4Mg==", "bodyText": "addMetadataUpdateRequest((tableName, partitionValues)/Path, writerIndex)\nadd checkState to make sure the input is alway unique", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r472394182", "createdAt": "2020-08-18T18:21:39Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveDistributedMetadataUpdater.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import com.facebook.airlift.concurrent.MoreFutures;\n+import com.facebook.presto.spi.ConnectorMetadataUpdateHandle;\n+import com.facebook.presto.spi.connector.ConnectorDistributedMetadataUpdater;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.util.concurrent.SettableFuture;\n+\n+import javax.inject.Inject;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.Queue;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ConcurrentLinkedQueue;\n+import java.util.concurrent.ConcurrentMap;\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+public class HiveDistributedMetadataUpdater\n+        implements ConnectorDistributedMetadataUpdater\n+{\n+    public static final Optional<ConnectorDistributedMetadataUpdater> DEFAULT_HIVE_METADATA_UPDATER = Optional.of(new HiveDistributedMetadataUpdater());\n+\n+    private final ConcurrentMap<Long, SettableFuture<List<String>>> requestResultFutureMap = new ConcurrentHashMap<>();\n+    private final Queue<HiveMetadataUpdate> metadataUpdateRequestQueue = new ConcurrentLinkedQueue<>();\n+    private final AtomicLong requestIdGenerator = new AtomicLong();\n+\n+    @Inject\n+    public HiveDistributedMetadataUpdater() {}\n+\n+    @Override\n+    public List<ConnectorMetadataUpdateHandle> getPendingMetadataUpdateRequests()\n+    {\n+        ImmutableList.Builder<ConnectorMetadataUpdateHandle> result = new ImmutableList.Builder<>();\n+        for (ConnectorMetadataUpdateHandle request : metadataUpdateRequestQueue) {\n+            result.add(request);\n+        }\n+        return result.build();\n+    }\n+\n+    @Override\n+    public void setMetadataUpdateResults(List<ConnectorMetadataUpdateHandle> results)\n+    {\n+        for (ConnectorMetadataUpdateHandle updateResult : results) {\n+            long requestId = updateResult.getRequestId();\n+            List<String> updates = updateResult.getUpdates();\n+\n+            if (!requestResultFutureMap.containsKey(requestId)) {\n+                return;\n+            }\n+\n+            requestResultFutureMap.get(requestId).set(updates);\n+\n+            // remove the request from queue\n+            for (HiveMetadataUpdate request : metadataUpdateRequestQueue) {\n+                if (request.getRequestId() == requestId) {\n+                    metadataUpdateRequestQueue.remove(request);\n+                }\n+            }\n+        }\n+    }\n+\n+    public long addMetadataUpdateRequest(int count)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02a0ef734dc5159c630566ad477661b252e3fd3b"}, "originalPosition": 77}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1MjgxNDk3OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePageSink.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxODoyNjowNFrOHCgzPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxODoyNjowNFrOHCgzPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM5NjYwNw==", "bodyText": "in this function, when you create a new writer, add a new request\n// new writer -> table, partition, fileName?? 1:1 writer index", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r472396607", "createdAt": "2020-08-18T18:26:04Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePageSink.java", "diffHunk": "@@ -336,6 +372,37 @@ private void writePage(Page page)\n         }\n     }\n \n+    private void sendMetadataUpdateRequest()\n+    {\n+        if (!fileRenamingEnabled || bucketFunction != null) {\n+            return;\n+        }\n+        this.requestId = hiveDistributedMetadataUpdater.addMetadataUpdateRequest(writers.size());\n+        waitForFileRenaming = true;\n+    }\n+\n+    private void renameFiles(List<String> fileNames)\n+    {\n+        Iterator<String> fileNamesIterator = fileNames.iterator();\n+        HdfsContext context = new HdfsContext(session, schemaName, tableName);\n+        for (HiveWriter writer : writers) {\n+            PartitionUpdate partitionUpdate = writer.getPartitionUpdate();\n+            for (FileWriteInfo fileWriteInfo : partitionUpdate.getFileWriteInfos()) {\n+                Path fromPath = new Path(partitionUpdate.getWritePath(), fileWriteInfo.getWriteFileName());\n+                Path toPath = new Path(partitionUpdate.getWritePath(), fileNamesIterator.next());\n+                try {\n+                    ExtendedFileSystem fileSystem = hdfsEnvironment.getFileSystem(context, fromPath);\n+                    fileSystem.renameFileAsync(fromPath, toPath);\n+                }\n+                catch (IOException e) {\n+                    throw new PrestoException(HIVE_FILESYSTEM_ERROR, format(\"Error renaming file. fromPath: %s toPath: %s\", fromPath, toPath), e);\n+                }\n+            }\n+        }\n+        hiveDistributedMetadataUpdater.removeResultFuture(requestId);\n+        renamingFuture.set(null);\n+    }\n+\n     private int[] getWriterIndexes(Page page)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b9687fb488427964e4026d6b21f9b3d63e1d5341"}, "originalPosition": 160}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1Mjg0MTQ4OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveDistributedMetadataUpdater.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxODozNDoxMlrOHChEGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxODozNDoxMlrOHChEGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQwMDkyMw==", "bodyText": "Add jmx counters to track the sizes of the map and queue", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r472400923", "createdAt": "2020-08-18T18:34:12Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveDistributedMetadataUpdater.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import com.facebook.airlift.concurrent.MoreFutures;\n+import com.facebook.presto.spi.ConnectorMetadataUpdateHandle;\n+import com.facebook.presto.spi.connector.ConnectorDistributedMetadataUpdater;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.util.concurrent.SettableFuture;\n+\n+import javax.inject.Inject;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.Queue;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ConcurrentLinkedQueue;\n+import java.util.concurrent.ConcurrentMap;\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+public class HiveDistributedMetadataUpdater", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b9687fb488427964e4026d6b21f9b3d63e1d5341"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1Mjg1OTMyOnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveDistributedMetadataUpdater.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxODozOTo0OVrOHChPRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxODozOTo0OVrOHChPRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQwMzc4Mw==", "bodyText": "Ideally, renaming can happen here. But let's leave it for now and revisit this in the next iteration", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r472403783", "createdAt": "2020-08-18T18:39:49Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveDistributedMetadataUpdater.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import com.facebook.airlift.concurrent.MoreFutures;\n+import com.facebook.presto.spi.ConnectorMetadataUpdateHandle;\n+import com.facebook.presto.spi.connector.ConnectorDistributedMetadataUpdater;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.util.concurrent.SettableFuture;\n+\n+import javax.inject.Inject;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.Queue;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ConcurrentLinkedQueue;\n+import java.util.concurrent.ConcurrentMap;\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+public class HiveDistributedMetadataUpdater\n+        implements ConnectorDistributedMetadataUpdater\n+{\n+    public static final Optional<ConnectorDistributedMetadataUpdater> DEFAULT_HIVE_METADATA_UPDATER = Optional.of(new HiveDistributedMetadataUpdater());\n+\n+    private final ConcurrentMap<Long, SettableFuture<List<String>>> requestResultFutureMap = new ConcurrentHashMap<>();\n+    private final Queue<HiveMetadataUpdate> metadataUpdateRequestQueue = new ConcurrentLinkedQueue<>();\n+    private final AtomicLong requestIdGenerator = new AtomicLong();\n+\n+    @Inject\n+    public HiveDistributedMetadataUpdater() {}\n+\n+    @Override\n+    public List<ConnectorMetadataUpdateHandle> getPendingMetadataUpdateRequests()\n+    {\n+        ImmutableList.Builder<ConnectorMetadataUpdateHandle> result = new ImmutableList.Builder<>();\n+        for (ConnectorMetadataUpdateHandle request : metadataUpdateRequestQueue) {\n+            result.add(request);\n+        }\n+        return result.build();\n+    }\n+\n+    @Override\n+    public void setMetadataUpdateResults(List<ConnectorMetadataUpdateHandle> results)\n+    {\n+        for (ConnectorMetadataUpdateHandle updateResult : results) {\n+            long requestId = updateResult.getRequestId();\n+            List<String> updates = updateResult.getUpdates();\n+\n+            if (!requestResultFutureMap.containsKey(requestId)) {\n+                return;\n+            }\n+\n+            requestResultFutureMap.get(requestId).set(updates);\n+\n+            // remove the request from queue\n+            for (HiveMetadataUpdate request : metadataUpdateRequestQueue) {\n+                if (request.getRequestId() == requestId) {\n+                    metadataUpdateRequestQueue.remove(request);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b9687fb488427964e4026d6b21f9b3d63e1d5341"}, "originalPosition": 71}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwMDg1MTM1OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadataUpdate.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQwNjo1MzoxOVrOHJsrgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQwNjo1MzoxOVrOHJsrgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTkzMTI2Ng==", "bodyText": "HiveMetadataUpdateHandle", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r479931266", "createdAt": "2020-08-31T06:53:19Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadataUpdate.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import com.facebook.presto.spi.ConnectorMetadataUpdateHandle;\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+import javax.annotation.Nullable;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class HiveMetadataUpdate", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "682fa5cbd90db93b6eb676484f88af3d84c300dc"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwMDg1ODMwOnYy", "diffSide": "RIGHT", "path": "presto-spi/src/main/java/com/facebook/presto/spi/connector/ConnectorMetadataUpdaterProvider.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQwNjo1NTo0MFrOHJsvgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQwNjo1NTo0MFrOHJsvgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTkzMjI5MQ==", "bodyText": "getMetadataUpdater", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r479932291", "createdAt": "2020-08-31T06:55:40Z", "author": {"login": "highker"}, "path": "presto-spi/src/main/java/com/facebook/presto/spi/connector/ConnectorMetadataUpdaterProvider.java", "diffHunk": "@@ -0,0 +1,19 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.spi.connector;\n+\n+public interface ConnectorMetadataUpdaterProvider\n+{\n+    ConnectorMetadataUpdater createMetadataUpdater();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "682fa5cbd90db93b6eb676484f88af3d84c300dc"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwMDg1OTE3OnYy", "diffSide": "RIGHT", "path": "presto-spi/src/main/java/com/facebook/presto/spi/connector/ConnectorMetadataUpdaterProvider.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQwNjo1NTo1NlrOHJsv-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQwNjo1NTo1NlrOHJsv-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTkzMjQxMQ==", "bodyText": "We need good javadoc for this class", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r479932411", "createdAt": "2020-08-31T06:55:56Z", "author": {"login": "highker"}, "path": "presto-spi/src/main/java/com/facebook/presto/spi/connector/ConnectorMetadataUpdaterProvider.java", "diffHunk": "@@ -0,0 +1,19 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.spi.connector;\n+\n+public interface ConnectorMetadataUpdaterProvider", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "682fa5cbd90db93b6eb676484f88af3d84c300dc"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwMDg1OTQxOnYy", "diffSide": "RIGHT", "path": "presto-spi/src/main/java/com/facebook/presto/spi/connector/ConnectorMetadataUpdater.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQwNjo1NjowMFrOHJswIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQwNjo1NjowMFrOHJswIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTkzMjQ1MQ==", "bodyText": "We need good javadoc for this class", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r479932451", "createdAt": "2020-08-31T06:56:00Z", "author": {"login": "highker"}, "path": "presto-spi/src/main/java/com/facebook/presto/spi/connector/ConnectorMetadataUpdater.java", "diffHunk": "@@ -0,0 +1,25 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.spi.connector;\n+\n+import com.facebook.presto.spi.ConnectorMetadataUpdateHandle;\n+\n+import java.util.List;\n+\n+public interface ConnectorMetadataUpdater", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "682fa5cbd90db93b6eb676484f88af3d84c300dc"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwMDg2NTUzOnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/com/facebook/presto/execution/TaskMetadataContext.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQwNjo1ODoxMFrOHJszwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQwNjo1ODoxMFrOHJszwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTkzMzM3OA==", "bodyText": "final", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r479933378", "createdAt": "2020-08-31T06:58:10Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/TaskMetadataContext.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.execution;\n+\n+import com.facebook.presto.spi.ConnectorId;\n+import com.facebook.presto.spi.connector.ConnectorMetadataUpdater;\n+\n+import java.util.List;\n+import java.util.concurrent.CopyOnWriteArrayList;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+\n+public class TaskMetadataContext\n+{\n+    private ConnectorId connectorId;\n+    private List<ConnectorMetadataUpdater> metadataUpdaters;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "682fa5cbd90db93b6eb676484f88af3d84c300dc"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwMDg2OTE0OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/com/facebook/presto/execution/TaskMetadataContext.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQwNjo1OTozMVrOHJs12w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwMDoxMDo1OVrOHLMazg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTkzMzkxNQ==", "bodyText": "Not a big fan of making this thing mutable here. I think we could make it immutable wither in TableWriterOperatorFactory's constructor or somewhere even higher level.", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r479933915", "createdAt": "2020-08-31T06:59:31Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/TaskMetadataContext.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.execution;\n+\n+import com.facebook.presto.spi.ConnectorId;\n+import com.facebook.presto.spi.connector.ConnectorMetadataUpdater;\n+\n+import java.util.List;\n+import java.util.concurrent.CopyOnWriteArrayList;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+\n+public class TaskMetadataContext\n+{\n+    private ConnectorId connectorId;\n+    private List<ConnectorMetadataUpdater> metadataUpdaters;\n+\n+    public TaskMetadataContext()\n+    {\n+        this.metadataUpdaters = new CopyOnWriteArrayList<>();\n+    }\n+\n+    public void setConnectorId(ConnectorId id)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "682fa5cbd90db93b6eb676484f88af3d84c300dc"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ5OTg1NA==", "bodyText": "I made TaskMetadataContext an optional parameter in TaskContext and initiated it inside TableWriterOperatorFactory, as we can know the connectorId only when we reach there.", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r481499854", "createdAt": "2020-09-02T00:10:59Z", "author": {"login": "NikhilCollooru"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/TaskMetadataContext.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.execution;\n+\n+import com.facebook.presto.spi.ConnectorId;\n+import com.facebook.presto.spi.connector.ConnectorMetadataUpdater;\n+\n+import java.util.List;\n+import java.util.concurrent.CopyOnWriteArrayList;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+\n+public class TaskMetadataContext\n+{\n+    private ConnectorId connectorId;\n+    private List<ConnectorMetadataUpdater> metadataUpdaters;\n+\n+    public TaskMetadataContext()\n+    {\n+        this.metadataUpdaters = new CopyOnWriteArrayList<>();\n+    }\n+\n+    public void setConnectorId(ConnectorId id)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTkzMzkxNQ=="}, "originalCommit": {"oid": "682fa5cbd90db93b6eb676484f88af3d84c300dc"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAxNTE3NjkwOnYy", "diffSide": "RIGHT", "path": "presto-benchmark/src/main/java/com/facebook/presto/benchmark/AbstractOperatorBenchmark.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxNzowNzozOFrOHL45bg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxNzowNzozOFrOHL45bg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjIyODU5MA==", "bodyText": "one param per line for function compileProjection", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r482228590", "createdAt": "2020-09-02T17:07:38Z", "author": {"login": "highker"}, "path": "presto-benchmark/src/main/java/com/facebook/presto/benchmark/AbstractOperatorBenchmark.java", "diffHunk": "@@ -224,7 +224,8 @@ protected final OperatorFactory createHashProjectOperator(int operatorId, PlanNo\n         RowExpression translatedHashExpression = translate(hashExpression.get(), variableToInputMapping.build());\n \n         PageFunctionCompiler functionCompiler = new PageFunctionCompiler(localQueryRunner.getMetadata(), 0);\n-        projections.add(new PageProjectionWithOutputs(functionCompiler.compileProjection(session.getSqlFunctionProperties(), translatedHashExpression, Optional.empty()).get(), new int[] {types.size()}));\n+        projections.add(new PageProjectionWithOutputs(functionCompiler.compileProjection(session.getSqlFunctionProperties(), translatedHashExpression, Optional.empty()).get(), new int[] {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48884b358e204e41559b4ca6b71ae1535c65f360"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAxNTE4MzkxOnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveClientModule.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxNzowODo1MVrOHL4-fw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxNzowODo1MVrOHL4-fw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjIyOTg4Nw==", "bodyText": "I guess you don't need this as it has already been bound below.", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r482229887", "createdAt": "2020-09-02T17:08:51Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveClientModule.java", "diffHunk": "@@ -124,6 +125,8 @@ public void configure(Binder binder)\n         binder.bind(HiveWriterStats.class).in(Scopes.SINGLETON);\n         newExporter(binder).export(HiveWriterStats.class).as(generatedNameOf(HiveWriterStats.class, connectorId));\n \n+        binder.bind(HiveMetadataUpdaterProvider.class).in(Scopes.SINGLETON);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48884b358e204e41559b4ca6b71ae1535c65f360"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAxNTI1MzQ4OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadataUpdateHandle.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxNzoyNDo0NlrOHL5s1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxNzoyNDo0NlrOHL5s1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjI0MTc0OQ==", "bodyText": "Use SchemaTableName", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r482241749", "createdAt": "2020-09-02T17:24:46Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadataUpdateHandle.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import com.facebook.presto.spi.ConnectorMetadataUpdateHandle;\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+import javax.annotation.Nullable;\n+\n+import java.util.Objects;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class HiveMetadataUpdateHandle\n+        implements ConnectorMetadataUpdateHandle\n+{\n+    private final String requestId;\n+    private final String schemaName;\n+    private final String tableName;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48884b358e204e41559b4ca6b71ae1535c65f360"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAxNTI1Nzg2OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadataUpdateHandle.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxNzoyNTo1MFrOHL5vdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxNzoyNTo1MFrOHL5vdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjI0MjQyMA==", "bodyText": "Just use UUID maybe", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r482242420", "createdAt": "2020-09-02T17:25:50Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadataUpdateHandle.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import com.facebook.presto.spi.ConnectorMetadataUpdateHandle;\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+import javax.annotation.Nullable;\n+\n+import java.util.Objects;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class HiveMetadataUpdateHandle\n+        implements ConnectorMetadataUpdateHandle\n+{\n+    private final String requestId;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48884b358e204e41559b4ca6b71ae1535c65f360"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAxNTI2MjAzOnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadataUpdateHandle.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxNzoyNjo1OVrOHL5yDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxNzoyNjo1OVrOHL5yDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjI0MzA4Ng==", "bodyText": "Use Optional<String>; same for the one below", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r482243086", "createdAt": "2020-09-02T17:26:59Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadataUpdateHandle.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import com.facebook.presto.spi.ConnectorMetadataUpdateHandle;\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+import javax.annotation.Nullable;\n+\n+import java.util.Objects;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class HiveMetadataUpdateHandle\n+        implements ConnectorMetadataUpdateHandle\n+{\n+    private final String requestId;\n+    private final String schemaName;\n+    private final String tableName;\n+    private final String partitionName;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48884b358e204e41559b4ca6b71ae1535c65f360"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAxNTI2ODQ2OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadataUpdateHandle.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxNzoyODo1M1rOHL52Pw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxNzoyODo1M1rOHL52Pw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjI0NDE1OQ==", "bodyText": "fileName. Also add a comment to explain when it would be non-null", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r482244159", "createdAt": "2020-09-02T17:28:53Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadataUpdateHandle.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import com.facebook.presto.spi.ConnectorMetadataUpdateHandle;\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+import javax.annotation.Nullable;\n+\n+import java.util.Objects;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class HiveMetadataUpdateHandle\n+        implements ConnectorMetadataUpdateHandle\n+{\n+    private final String requestId;\n+    private final String schemaName;\n+    private final String tableName;\n+    private final String partitionName;\n+    private final String metadataUpdate;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48884b358e204e41559b4ca6b71ae1535c65f360"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAxNTI2OTg1OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadataUpdateHandle.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxNzoyOToxNVrOHL53Gw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxNzoyOToxNVrOHL53Gw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjI0NDM3OQ==", "bodyText": "public Optional<String> getMetadataUpdate()\n    {\n        return fileName;\n    }", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r482244379", "createdAt": "2020-09-02T17:29:15Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadataUpdateHandle.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import com.facebook.presto.spi.ConnectorMetadataUpdateHandle;\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+import javax.annotation.Nullable;\n+\n+import java.util.Objects;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class HiveMetadataUpdateHandle\n+        implements ConnectorMetadataUpdateHandle\n+{\n+    private final String requestId;\n+    private final String schemaName;\n+    private final String tableName;\n+    private final String partitionName;\n+    private final String metadataUpdate;\n+\n+    public HiveMetadataUpdateHandle(String requestId, String schemaName, String tableName, String partitionName)\n+    {\n+        this(requestId, schemaName, tableName, partitionName, null);\n+    }\n+\n+    @JsonCreator\n+    public HiveMetadataUpdateHandle(\n+            @JsonProperty(\"requestId\") String requestId,\n+            @JsonProperty(\"schemaName\") String schemaName,\n+            @JsonProperty(\"tableName\") String tableName,\n+            @JsonProperty(\"partitionName\") @Nullable String partitionName,\n+            @JsonProperty(\"metadataUpdate\") @Nullable String metadataUpdate)\n+    {\n+        this.requestId = requireNonNull(requestId, \"requestId is null\");\n+        this.schemaName = requireNonNull(schemaName, \"schemaName is null\");\n+        this.tableName = requireNonNull(tableName, \"tableName is null\");\n+        this.partitionName = partitionName;\n+        this.metadataUpdate = metadataUpdate;\n+    }\n+\n+    @JsonProperty\n+    public String getRequestId()\n+    {\n+        return requestId;\n+    }\n+\n+    @JsonProperty\n+    public String getSchemaName()\n+    {\n+        return schemaName;\n+    }\n+\n+    @JsonProperty\n+    public String getTableName()\n+    {\n+        return tableName;\n+    }\n+\n+    @JsonProperty\n+    public String getPartitionName()\n+    {\n+        return partitionName;\n+    }\n+\n+    @JsonProperty\n+    public String getMetadataUpdate()\n+    {\n+        return metadataUpdate;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48884b358e204e41559b4ca6b71ae1535c65f360"}, "originalPosition": 83}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAxNTI3MjA0OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadataUpdateHandle.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxNzoyOTo1MlrOHL54fw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxNzoyOTo1MlrOHL54fw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjI0NDczNQ==", "bodyText": "Seems missing a field here.", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r482244735", "createdAt": "2020-09-02T17:29:52Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadataUpdateHandle.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import com.facebook.presto.spi.ConnectorMetadataUpdateHandle;\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+import javax.annotation.Nullable;\n+\n+import java.util.Objects;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class HiveMetadataUpdateHandle\n+        implements ConnectorMetadataUpdateHandle\n+{\n+    private final String requestId;\n+    private final String schemaName;\n+    private final String tableName;\n+    private final String partitionName;\n+    private final String metadataUpdate;\n+\n+    public HiveMetadataUpdateHandle(String requestId, String schemaName, String tableName, String partitionName)\n+    {\n+        this(requestId, schemaName, tableName, partitionName, null);\n+    }\n+\n+    @JsonCreator\n+    public HiveMetadataUpdateHandle(\n+            @JsonProperty(\"requestId\") String requestId,\n+            @JsonProperty(\"schemaName\") String schemaName,\n+            @JsonProperty(\"tableName\") String tableName,\n+            @JsonProperty(\"partitionName\") @Nullable String partitionName,\n+            @JsonProperty(\"metadataUpdate\") @Nullable String metadataUpdate)\n+    {\n+        this.requestId = requireNonNull(requestId, \"requestId is null\");\n+        this.schemaName = requireNonNull(schemaName, \"schemaName is null\");\n+        this.tableName = requireNonNull(tableName, \"tableName is null\");\n+        this.partitionName = partitionName;\n+        this.metadataUpdate = metadataUpdate;\n+    }\n+\n+    @JsonProperty\n+    public String getRequestId()\n+    {\n+        return requestId;\n+    }\n+\n+    @JsonProperty\n+    public String getSchemaName()\n+    {\n+        return schemaName;\n+    }\n+\n+    @JsonProperty\n+    public String getTableName()\n+    {\n+        return tableName;\n+    }\n+\n+    @JsonProperty\n+    public String getPartitionName()\n+    {\n+        return partitionName;\n+    }\n+\n+    @JsonProperty\n+    public String getMetadataUpdate()\n+    {\n+        return metadataUpdate;\n+    }\n+\n+    @Override\n+    public boolean equals(Object obj)\n+    {\n+        if (this == obj) {\n+            return true;\n+        }\n+        if (obj == null || getClass() != obj.getClass()) {\n+            return false;\n+        }\n+        HiveMetadataUpdateHandle o = (HiveMetadataUpdateHandle) obj;\n+        return requestId.equals(o.requestId) &&\n+                schemaName.equals(o.schemaName) &&\n+                tableName.equals(o.tableName) &&\n+                Objects.equals(partitionName, o.partitionName);\n+    }\n+\n+    @Override\n+    public int hashCode()\n+    {\n+        return Objects.hash(requestId, schemaName, tableName, partitionName);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48884b358e204e41559b4ca6b71ae1535c65f360"}, "originalPosition": 105}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAxNTc2OTE3OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadataUpdater.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxOToxNTo0MFrOHL-0hw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxOToxNTo0MFrOHL-0hw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjMyNTYzOQ==", "bodyText": "redundant", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r482325639", "createdAt": "2020-09-02T19:15:40Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadataUpdater.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import com.facebook.airlift.concurrent.MoreFutures;\n+import com.facebook.presto.spi.ConnectorMetadataUpdateHandle;\n+import com.facebook.presto.spi.connector.ConnectorMetadataUpdater;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.util.concurrent.SettableFuture;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Queue;\n+import java.util.UUID;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ConcurrentLinkedQueue;\n+\n+public class HiveMetadataUpdater\n+        implements ConnectorMetadataUpdater\n+{\n+    private final Map<String, SettableFuture<String>> requestFutureMap = new ConcurrentHashMap<>();\n+    private final Map<Integer, String> writerRequestMap = new ConcurrentHashMap<>();\n+    private final Queue<HiveMetadataUpdateHandle> hiveMetadataRequestQueue = new ConcurrentLinkedQueue<>();\n+\n+    public HiveMetadataUpdater() {}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48884b358e204e41559b4ca6b71ae1535c65f360"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAxNTc4MDU4OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadataUpdater.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxOToxNzo0NVrOHL-8CQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxOToxNzo0NVrOHL-8CQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjMyNzU2MQ==", "bodyText": "... ImmutableList.builder<>();", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r482327561", "createdAt": "2020-09-02T19:17:45Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadataUpdater.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import com.facebook.airlift.concurrent.MoreFutures;\n+import com.facebook.presto.spi.ConnectorMetadataUpdateHandle;\n+import com.facebook.presto.spi.connector.ConnectorMetadataUpdater;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.util.concurrent.SettableFuture;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Queue;\n+import java.util.UUID;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ConcurrentLinkedQueue;\n+\n+public class HiveMetadataUpdater\n+        implements ConnectorMetadataUpdater\n+{\n+    private final Map<String, SettableFuture<String>> requestFutureMap = new ConcurrentHashMap<>();\n+    private final Map<Integer, String> writerRequestMap = new ConcurrentHashMap<>();\n+    private final Queue<HiveMetadataUpdateHandle> hiveMetadataRequestQueue = new ConcurrentLinkedQueue<>();\n+\n+    public HiveMetadataUpdater() {}\n+\n+    @Override\n+    public List<ConnectorMetadataUpdateHandle> getPendingMetadataUpdateRequests()\n+    {\n+        ImmutableList.Builder<ConnectorMetadataUpdateHandle> result = new ImmutableList.Builder<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48884b358e204e41559b4ca6b71ae1535c65f360"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAxNjExMTcyOnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadataUpdater.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQyMDowMzo0OVrOHMChaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQyMDowMzo0OVrOHMChaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjM4NjI4MQ==", "bodyText": "Is this thread-safe? Wonder what would happen if two threads set the same future. Might be fine, but worth digging and comment here.", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r482386281", "createdAt": "2020-09-02T20:03:49Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadataUpdater.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import com.facebook.airlift.concurrent.MoreFutures;\n+import com.facebook.presto.spi.ConnectorMetadataUpdateHandle;\n+import com.facebook.presto.spi.connector.ConnectorMetadataUpdater;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.util.concurrent.SettableFuture;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Queue;\n+import java.util.UUID;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ConcurrentLinkedQueue;\n+\n+public class HiveMetadataUpdater\n+        implements ConnectorMetadataUpdater\n+{\n+    private final Map<String, SettableFuture<String>> requestFutureMap = new ConcurrentHashMap<>();\n+    private final Map<Integer, String> writerRequestMap = new ConcurrentHashMap<>();\n+    private final Queue<HiveMetadataUpdateHandle> hiveMetadataRequestQueue = new ConcurrentLinkedQueue<>();\n+\n+    public HiveMetadataUpdater() {}\n+\n+    @Override\n+    public List<ConnectorMetadataUpdateHandle> getPendingMetadataUpdateRequests()\n+    {\n+        ImmutableList.Builder<ConnectorMetadataUpdateHandle> result = new ImmutableList.Builder<>();\n+        for (HiveMetadataUpdateHandle request : hiveMetadataRequestQueue) {\n+            result.add(request);\n+        }\n+        return result.build();\n+    }\n+\n+    @Override\n+    public void setMetadataUpdateResults(List<ConnectorMetadataUpdateHandle> results)\n+    {\n+        for (ConnectorMetadataUpdateHandle connectorMetadataUpdateHandle : results) {\n+            HiveMetadataUpdateHandle updateResult = (HiveMetadataUpdateHandle) connectorMetadataUpdateHandle;\n+            String requestId = updateResult.getRequestId();\n+\n+            if (!requestFutureMap.containsKey(requestId)) {\n+                continue;\n+            }\n+\n+            requestFutureMap.get(requestId).set(updateResult.getMetadataUpdate());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48884b358e204e41559b4ca6b71ae1535c65f360"}, "originalPosition": 60}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAxNjE1MDYwOnYy", "diffSide": "RIGHT", "path": "presto-hive/src/test/java/com/facebook/presto/hive/TestHiveMetadataUpdater.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQyMDowODo1MVrOHMC7kQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwNjo1NTo1MlrOHXMNrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjM5Mjk3Nw==", "bodyText": "Shall we have more multi-threading tests for this class?", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r482392977", "createdAt": "2020-09-02T20:08:51Z", "author": {"login": "highker"}, "path": "presto-hive/src/test/java/com/facebook/presto/hive/TestHiveMetadataUpdater.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import com.facebook.presto.spi.ConnectorMetadataUpdateHandle;\n+import com.google.common.collect.ImmutableList;\n+import org.testng.annotations.Test;\n+\n+import java.util.List;\n+\n+import static com.facebook.presto.hive.TestHiveMetadataUpdateHandle.TEST_PARTITION_NAME;\n+import static com.facebook.presto.hive.TestHiveMetadataUpdateHandle.TEST_SCHEMA;\n+import static com.facebook.presto.hive.TestHiveMetadataUpdateHandle.TEST_TABLE;\n+import static org.testng.Assert.assertEquals;\n+\n+public class TestHiveMetadataUpdater", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48884b358e204e41559b4ca6b71ae1535c65f360"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDA3OTQwNw==", "bodyText": "As per our new design , we have one HiveMetadataUpdater instance per each task. On other hand we need multi-threaded tests for HiveFileRenamer as we have a singleton on coordinator for all tasks. So added multi-threaded tests for HiveFileRenamer", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r494079407", "createdAt": "2020-09-24T06:55:52Z", "author": {"login": "NikhilCollooru"}, "path": "presto-hive/src/test/java/com/facebook/presto/hive/TestHiveMetadataUpdater.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import com.facebook.presto.spi.ConnectorMetadataUpdateHandle;\n+import com.google.common.collect.ImmutableList;\n+import org.testng.annotations.Test;\n+\n+import java.util.List;\n+\n+import static com.facebook.presto.hive.TestHiveMetadataUpdateHandle.TEST_PARTITION_NAME;\n+import static com.facebook.presto.hive.TestHiveMetadataUpdateHandle.TEST_SCHEMA;\n+import static com.facebook.presto.hive.TestHiveMetadataUpdateHandle.TEST_TABLE;\n+import static org.testng.Assert.assertEquals;\n+\n+public class TestHiveMetadataUpdater", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjM5Mjk3Nw=="}, "originalCommit": {"oid": "48884b358e204e41559b4ca6b71ae1535c65f360"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAxNjE2NDgwOnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadataUpdater.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQyMDoxMDozMVrOHMDE5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQyMDoxMDozMVrOHMDE5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjM5NTM2Nw==", "bodyText": "Let's put some comments to the data structures. BTW, seems we don't need a Queue type for hiveMetadataRequestQueue because there is no order. But let's keep that because we might come back to getPendingMetadataUpdateRequests and optimize it. The current impl for getPendingMetadataUpdateRequests is a bit brute force.", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r482395367", "createdAt": "2020-09-02T20:10:31Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadataUpdater.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import com.facebook.airlift.concurrent.MoreFutures;\n+import com.facebook.presto.spi.ConnectorMetadataUpdateHandle;\n+import com.facebook.presto.spi.connector.ConnectorMetadataUpdater;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.util.concurrent.SettableFuture;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Queue;\n+import java.util.UUID;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ConcurrentLinkedQueue;\n+\n+public class HiveMetadataUpdater\n+        implements ConnectorMetadataUpdater\n+{\n+    private final Map<String, SettableFuture<String>> requestFutureMap = new ConcurrentHashMap<>();\n+    private final Map<Integer, String> writerRequestMap = new ConcurrentHashMap<>();\n+    private final Queue<HiveMetadataUpdateHandle> hiveMetadataRequestQueue = new ConcurrentLinkedQueue<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48884b358e204e41559b4ca6b71ae1535c65f360"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAxNjIyMzQ0OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadataUpdater.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQyMDoxODozMlrOHMDtlw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQyMDoxODozMlrOHMDtlw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjQwNTc4Mw==", "bodyText": "This looks like an expensive call directly executed from HTTP thread (from TaskResource.updateMetadataResults). Potentially, this will exhaust jetty threads. A good way is to make it async and move it to a CPU thread.", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r482405783", "createdAt": "2020-09-02T20:18:32Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadataUpdater.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import com.facebook.airlift.concurrent.MoreFutures;\n+import com.facebook.presto.spi.ConnectorMetadataUpdateHandle;\n+import com.facebook.presto.spi.connector.ConnectorMetadataUpdater;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.util.concurrent.SettableFuture;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Queue;\n+import java.util.UUID;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ConcurrentLinkedQueue;\n+\n+public class HiveMetadataUpdater\n+        implements ConnectorMetadataUpdater\n+{\n+    private final Map<String, SettableFuture<String>> requestFutureMap = new ConcurrentHashMap<>();\n+    private final Map<Integer, String> writerRequestMap = new ConcurrentHashMap<>();\n+    private final Queue<HiveMetadataUpdateHandle> hiveMetadataRequestQueue = new ConcurrentLinkedQueue<>();\n+\n+    public HiveMetadataUpdater() {}\n+\n+    @Override\n+    public List<ConnectorMetadataUpdateHandle> getPendingMetadataUpdateRequests()\n+    {\n+        ImmutableList.Builder<ConnectorMetadataUpdateHandle> result = new ImmutableList.Builder<>();\n+        for (HiveMetadataUpdateHandle request : hiveMetadataRequestQueue) {\n+            result.add(request);\n+        }\n+        return result.build();\n+    }\n+\n+    @Override\n+    public void setMetadataUpdateResults(List<ConnectorMetadataUpdateHandle> results)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48884b358e204e41559b4ca6b71ae1535c65f360"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAxNjIzNTk4OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePageSinkProvider.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQyMDoyMDoxMlrOHMD2RQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQyMDoyMDoxMlrOHMD2RQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjQwODAwNQ==", "bodyText": "use isPresent rather than making it null", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r482408005", "createdAt": "2020-09-02T20:20:12Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePageSinkProvider.java", "diffHunk": "@@ -113,17 +114,21 @@ public HivePageSinkProvider(\n     public ConnectorPageSink createPageSink(ConnectorTransactionHandle transaction, ConnectorSession session, ConnectorOutputTableHandle tableHandle, PageSinkContext pageSinkProperties)\n     {\n         HiveWritableTableHandle handle = (HiveOutputTableHandle) tableHandle;\n-        return createPageSink(handle, true, session, pageSinkProperties.isCommitRequired());\n+        HiveMetadataUpdater hiveMetadataUpdater = (HiveMetadataUpdater) pageSinkProperties.getMetadataUpdater().orElse(null);\n+        checkArgument(hiveMetadataUpdater != null, \"Metadata Updater for HivePageSink is null\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48884b358e204e41559b4ca6b71ae1535c65f360"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAxNjI0NDU1OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePageSinkProvider.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQyMDoyMToyMlrOHMD8Sw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQyMDoyMToyMlrOHMD8Sw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjQwOTU0Nw==", "bodyText": "PageSinkContext pageSinkProperties: seems you forgot to change the param names from the type renaming", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r482409547", "createdAt": "2020-09-02T20:21:22Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePageSinkProvider.java", "diffHunk": "@@ -113,17 +114,21 @@ public HivePageSinkProvider(\n     public ConnectorPageSink createPageSink(ConnectorTransactionHandle transaction, ConnectorSession session, ConnectorOutputTableHandle tableHandle, PageSinkContext pageSinkProperties)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48884b358e204e41559b4ca6b71ae1535c65f360"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAxNjI2NjU4OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadataUpdaterProvider.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQyMDoyNDoyMVrOHMELtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQyMDoyNDoyMVrOHMELtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjQxMzQ5Mw==", "bodyText": "Remove this. Put @Inject at class definition", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r482413493", "createdAt": "2020-09-02T20:24:21Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadataUpdaterProvider.java", "diffHunk": "@@ -0,0 +1,32 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import com.facebook.presto.spi.connector.ConnectorMetadataUpdater;\n+import com.facebook.presto.spi.connector.ConnectorMetadataUpdaterProvider;\n+\n+import javax.inject.Inject;\n+\n+public class HiveMetadataUpdaterProvider\n+        implements ConnectorMetadataUpdaterProvider\n+{\n+    @Inject\n+    public HiveMetadataUpdaterProvider() {}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48884b358e204e41559b4ca6b71ae1535c65f360"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5ODc5NzkwOnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePageSink.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNjoyODozM1rOHYKj4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNjoyODozM1rOHYKj4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTEwMDg5Nw==", "bodyText": "add a comment to this if", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r495100897", "createdAt": "2020-09-25T16:28:33Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePageSink.java", "diffHunk": "@@ -339,6 +347,14 @@ private void writePage(Page page)\n         }\n     }\n \n+    private void sendMetadataUpdateRequest(Optional<String> partitionName, int writerIndex)\n+    {\n+        if (bucketFunction != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7cb8ba99dcbc8d524d4ff16dc518770b54084787"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5ODgwMjc3OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/com/facebook/presto/execution/SqlTask.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNjoyOTo1M1rOHYKm-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNjoyOTo1M1rOHYKm-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTEwMTY5MA==", "bodyText": "private", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r495101690", "createdAt": "2020-09-25T16:29:53Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/SqlTask.java", "diffHunk": "@@ -313,6 +318,24 @@ private TaskStats getTaskStats(TaskHolder taskHolder)\n         return new TaskStats(taskStateMachine.getCreatedTime(), endTime);\n     }\n \n+    public MetadataUpdates getMetadataUpdateRequests(TaskHolder taskHolder)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7cb8ba99dcbc8d524d4ff16dc518770b54084787"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5ODgwMzkzOnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/com/facebook/presto/execution/SqlTask.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNjozMDoxOFrOHYKnvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNjozMDoxOFrOHYKnvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTEwMTg4Ng==", "bodyText": "Use list builder", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r495101886", "createdAt": "2020-09-25T16:30:18Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/SqlTask.java", "diffHunk": "@@ -313,6 +318,24 @@ private TaskStats getTaskStats(TaskHolder taskHolder)\n         return new TaskStats(taskStateMachine.getCreatedTime(), endTime);\n     }\n \n+    public MetadataUpdates getMetadataUpdateRequests(TaskHolder taskHolder)\n+    {\n+        ConnectorId connectorId = null;\n+        List<ConnectorMetadataUpdateHandle> connectorMetadataUpdates = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7cb8ba99dcbc8d524d4ff16dc518770b54084787"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5ODgwODU3OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/com/facebook/presto/metadata/MetadataUpdates.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNjozMTo0M1rOHYKqvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNjozMTo0M1rOHYKqvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTEwMjY1NA==", "bodyText": "both are final", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r495102654", "createdAt": "2020-09-25T16:31:43Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/metadata/MetadataUpdates.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.metadata;\n+\n+import com.facebook.presto.spi.ConnectorId;\n+import com.facebook.presto.spi.ConnectorMetadataUpdateHandle;\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.google.common.collect.ImmutableList;\n+\n+import javax.annotation.Nullable;\n+\n+import java.util.List;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class MetadataUpdates\n+{\n+    public static final MetadataUpdates DEFAULT_METADATA_UPDATES = new MetadataUpdates(ImmutableList.of());\n+\n+    private ConnectorId connectorId;\n+    private List<ConnectorMetadataUpdateHandle> metadataUpdates;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7cb8ba99dcbc8d524d4ff16dc518770b54084787"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5ODkwMjMwOnYy", "diffSide": "RIGHT", "path": "presto-hive-common/src/main/java/com/facebook/presto/hive/filesystem/ExtendedFileSystem.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNjo1OTo1NVrOHYLkCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNjo1OTo1NVrOHYLkCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTExNzMyMg==", "bodyText": "Make this interface async: ListenableFuture<Void> renameFileAsync", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r495117322", "createdAt": "2020-09-25T16:59:55Z", "author": {"login": "highker"}, "path": "presto-hive-common/src/main/java/com/facebook/presto/hive/filesystem/ExtendedFileSystem.java", "diffHunk": "@@ -43,4 +43,10 @@ public FSDataInputStream openFile(Path path, HiveFileContext hiveFileContext)\n     {\n         throw new UnsupportedOperationException();\n     }\n+\n+    public boolean renameFile(Path source, Path destination)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1dc330649d8e828968c6f5e85a6161ee87e448c9"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5ODkxMDQ5OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePageSink.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNzowMjoyNFrOHYLpLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQyMDowMTozNFrOHYQ4uw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTExODYzOA==", "bodyText": "this assignment looks unnecessary", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r495118638", "createdAt": "2020-09-25T17:02:24Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePageSink.java", "diffHunk": "@@ -228,6 +238,19 @@ public long getValidationCpuNanos()\n                 .mapToLong(HiveWriter::getValidationCpuNanos)\n                 .sum();\n \n+        if (waitForFileRenaming && verificationTasks.isEmpty()) {\n+            ImmutableList.Builder<Slice> partitionUpdatesWithRenamedFileNames = ImmutableList.builder();\n+            List<ListenableFuture<?>> futures = new ArrayList<>();\n+            for (int i = 0; i < writers.size(); i++) {\n+                ListenableFuture<?> fileNameFuture = toListenableFuture(hiveMetadataUpdater.getMetadataResult(i));\n+                SettableFuture renamingFuture = SettableFuture.create();\n+                futures.add(renamingFuture);\n+                int writerIndex = i;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32a2a616909a6e6f6f94f42c4d857334f70ad170"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIwNDUzOQ==", "bodyText": "If i use i as input param to lambda function then i am getting syntax error Variable used in lambda expression should be final or effectivelyfinal. Hence added this line.", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r495204539", "createdAt": "2020-09-25T20:01:34Z", "author": {"login": "NikhilCollooru"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePageSink.java", "diffHunk": "@@ -228,6 +238,19 @@ public long getValidationCpuNanos()\n                 .mapToLong(HiveWriter::getValidationCpuNanos)\n                 .sum();\n \n+        if (waitForFileRenaming && verificationTasks.isEmpty()) {\n+            ImmutableList.Builder<Slice> partitionUpdatesWithRenamedFileNames = ImmutableList.builder();\n+            List<ListenableFuture<?>> futures = new ArrayList<>();\n+            for (int i = 0; i < writers.size(); i++) {\n+                ListenableFuture<?> fileNameFuture = toListenableFuture(hiveMetadataUpdater.getMetadataResult(i));\n+                SettableFuture renamingFuture = SettableFuture.create();\n+                futures.add(renamingFuture);\n+                int writerIndex = i;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTExODYzOA=="}, "originalCommit": {"oid": "32a2a616909a6e6f6f94f42c4d857334f70ad170"}, "originalPosition": 58}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5ODkxMTQwOnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePageSink.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNzowMjozOVrOHYLpwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwMToxNDozOFrOHa1zxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTExODc4NA==", "bodyText": "s/i/writerIndex", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r495118784", "createdAt": "2020-09-25T17:02:39Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePageSink.java", "diffHunk": "@@ -228,6 +238,19 @@ public long getValidationCpuNanos()\n                 .mapToLong(HiveWriter::getValidationCpuNanos)\n                 .sum();\n \n+        if (waitForFileRenaming && verificationTasks.isEmpty()) {\n+            ImmutableList.Builder<Slice> partitionUpdatesWithRenamedFileNames = ImmutableList.builder();\n+            List<ListenableFuture<?>> futures = new ArrayList<>();\n+            for (int i = 0; i < writers.size(); i++) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32a2a616909a6e6f6f94f42c4d857334f70ad170"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzIyODgxOQ==", "bodyText": "Comment not addressed? i -> writerIndex", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r497228819", "createdAt": "2020-09-30T03:55:31Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePageSink.java", "diffHunk": "@@ -228,6 +238,19 @@ public long getValidationCpuNanos()\n                 .mapToLong(HiveWriter::getValidationCpuNanos)\n                 .sum();\n \n+        if (waitForFileRenaming && verificationTasks.isEmpty()) {\n+            ImmutableList.Builder<Slice> partitionUpdatesWithRenamedFileNames = ImmutableList.builder();\n+            List<ListenableFuture<?>> futures = new ArrayList<>();\n+            for (int i = 0; i < writers.size(); i++) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTExODc4NA=="}, "originalCommit": {"oid": "32a2a616909a6e6f6f94f42c4d857334f70ad170"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzkwNjYyOQ==", "bodyText": "Like i said above. If i use i as input param to lambda function then i am getting syntax error Variable used in lambda expression should be final or effectivelyfinal. Hence used i here and assigned it a new int variable writerIndex below.", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r497906629", "createdAt": "2020-10-01T01:14:38Z", "author": {"login": "NikhilCollooru"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePageSink.java", "diffHunk": "@@ -228,6 +238,19 @@ public long getValidationCpuNanos()\n                 .mapToLong(HiveWriter::getValidationCpuNanos)\n                 .sum();\n \n+        if (waitForFileRenaming && verificationTasks.isEmpty()) {\n+            ImmutableList.Builder<Slice> partitionUpdatesWithRenamedFileNames = ImmutableList.builder();\n+            List<ListenableFuture<?>> futures = new ArrayList<>();\n+            for (int i = 0; i < writers.size(); i++) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTExODc4NA=="}, "originalCommit": {"oid": "32a2a616909a6e6f6f94f42c4d857334f70ad170"}, "originalPosition": 54}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5ODkyNzM2OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePageSink.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNzowNjo1OVrOHYLzJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNzowNjo1OVrOHYLzJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTEyMTE4OA==", "bodyText": "assert list size is one", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r495121188", "createdAt": "2020-09-25T17:06:59Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePageSink.java", "diffHunk": "@@ -353,6 +376,41 @@ private void sendMetadataUpdateRequest(Optional<String> partitionName, int write\n             return;\n         }\n         hiveMetadataUpdater.addMetadataUpdateRequest(schemaName, tableName, partitionName, writerIndex);\n+        waitForFileRenaming = true;\n+    }\n+\n+    private void renameFiles(String fileName, int writerIndex, SettableFuture<?> renamingFuture, ImmutableList.Builder<Slice> partitionUpdatesWithRenamedFileNames)\n+    {\n+        HdfsContext context = new HdfsContext(session, schemaName, tableName);\n+        HiveWriter writer = writers.get(writerIndex);\n+        PartitionUpdate partitionUpdate = writer.getPartitionUpdate();\n+\n+        // Only one file is written by a writer\n+        FileWriteInfo fileWriteInfo = partitionUpdate.getFileWriteInfos().get(0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32a2a616909a6e6f6f94f42c4d857334f70ad170"}, "originalPosition": 81}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEwMTY1ODE4OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QwMzoxMTo0OVrOHYkNfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QwMzoxMTo0OVrOHYkNfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUyMTE1MQ==", "bodyText": "Use QueryId as the type for the second param", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r495521151", "createdAt": "2020-09-27T03:11:49Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -2879,6 +2883,12 @@ public void revokeTablePrivileges(ConnectorSession session, SchemaTableName sche\n         return toCompletableFuture(stagingFileCommitter.commitFiles(session, handle.getSchemaName(), handle.getTableName(), getPartitionUpdates(fragments)));\n     }\n \n+    @Override\n+    public List<ConnectorMetadataUpdateHandle> getMetadataUpdateResults(List<ConnectorMetadataUpdateHandle> metadataUpdateRequests, String queryId)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16eab906bf207049fd524cd1ad55c91488a457cf"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEwMTY2NTE2OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveFileRenamer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QwMzoyMjoyMVrOHYkQuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QxODo1MDo0OFrOHYpNBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUyMTk3Nw==", "bodyText": "We should use a concurrent hash map or something like to to remember everything. We purged finished queries by adding a callback to QueryManager.addStateChangeListener. Note that the callback itself could unfortunately introduce another interface in connector metadata. Let me know if you might come up with better solution than that.", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r495521977", "createdAt": "2020-09-27T03:22:21Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveFileRenamer.java", "diffHunk": "@@ -0,0 +1,123 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import com.facebook.presto.spi.ConnectorMetadataUpdateHandle;\n+import com.facebook.presto.spi.SchemaTableName;\n+import com.google.common.cache.CacheBuilder;\n+import com.google.common.cache.CacheLoader;\n+import com.google.common.cache.LoadingCache;\n+import org.weakref.jmx.Managed;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+public class HiveFileRenamer\n+{\n+    private final LoadingCache<HiveMetadataUpdateKey, AtomicLong> partitionFileCounterCache;\n+    private final LoadingCache<HiveMetadataUpdateHandle, String> hiveMetadataResultCache;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16eab906bf207049fd524cd1ad55c91488a457cf"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTYwMjk1MA==", "bodyText": "How about we inject QueryManager directly into HiveFileRenamer because this is to help purges entries in HiveFileRenamer specifically. WDYT ?", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r495602950", "createdAt": "2020-09-27T18:50:48Z", "author": {"login": "NikhilCollooru"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveFileRenamer.java", "diffHunk": "@@ -0,0 +1,123 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import com.facebook.presto.spi.ConnectorMetadataUpdateHandle;\n+import com.facebook.presto.spi.SchemaTableName;\n+import com.google.common.cache.CacheBuilder;\n+import com.google.common.cache.CacheLoader;\n+import com.google.common.cache.LoadingCache;\n+import org.weakref.jmx.Managed;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+public class HiveFileRenamer\n+{\n+    private final LoadingCache<HiveMetadataUpdateKey, AtomicLong> partitionFileCounterCache;\n+    private final LoadingCache<HiveMetadataUpdateHandle, String> hiveMetadataResultCache;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUyMTk3Nw=="}, "originalCommit": {"oid": "16eab906bf207049fd524cd1ad55c91488a457cf"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEwMTY2NzgyOnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveClientConfig.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QwMzoyNjoyOFrOHYkR4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QwMzoyNjoyOFrOHYkR4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUyMjI3NQ==", "bodyText": "We don't need this if we have good way to purge queries", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r495522275", "createdAt": "2020-09-27T03:26:28Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveClientConfig.java", "diffHunk": "@@ -181,6 +181,10 @@\n     private boolean isPartialAggregationPushdownEnabled;\n     private boolean isPartialAggregationPushdownForVariableLengthDatatypesEnabled;\n \n+    private boolean fileRenamingEnabled;\n+    private long fileRenamerCacheSize = 1000000;\n+    private Duration fileRenamerCacheTtl = new Duration(15, TimeUnit.MINUTES);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2213f94daaa54e31f11b2485c6b9c9f016bf2f84"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExMjgwNzE5OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePageSink.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQwMzo1Nzo1M1rOHaMeLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQwMzo1Nzo1M1rOHaMeLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzIyOTM1OQ==", "bodyText": "we need to handle the future. Ideally, we can have the processing after file renaming into a callback.", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r497229359", "createdAt": "2020-09-30T03:57:53Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePageSink.java", "diffHunk": "@@ -354,6 +378,43 @@ private void sendMetadataUpdateRequest(Optional<String> partitionName, int write\n             return;\n         }\n         hiveMetadataUpdater.addMetadataUpdateRequest(schemaName, tableName, partitionName, writerIndex);\n+        waitForFileRenaming = true;\n+    }\n+\n+    private void renameFiles(String fileName, int writerIndex, SettableFuture<?> renamingFuture, ImmutableList.Builder<Slice> partitionUpdatesWithRenamedFileNames)\n+    {\n+        HdfsContext context = new HdfsContext(session, schemaName, tableName);\n+        HiveWriter writer = writers.get(writerIndex);\n+        PartitionUpdate partitionUpdate = writer.getPartitionUpdate();\n+\n+        // Check that only one file is written by a writer\n+        checkArgument(partitionUpdate.getFileWriteInfos().size() == 1, \"HiveWriter wrote data to more than one file\");\n+\n+        FileWriteInfo fileWriteInfo = partitionUpdate.getFileWriteInfos().get(0);\n+        Path fromPath = new Path(partitionUpdate.getWritePath(), fileWriteInfo.getWriteFileName());\n+        Path toPath = new Path(partitionUpdate.getWritePath(), fileName);\n+        try {\n+            ExtendedFileSystem fileSystem = hdfsEnvironment.getFileSystem(context, fromPath);\n+            fileSystem.renameFileAsync(fromPath, toPath);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "205ac4d15a6488255a2a8f12c913b5db14098f74"}, "originalPosition": 89}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExMjgxMzg4OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveFileRenamer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQwNDowMjoxOFrOHaMiAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQwNDowMjoxOFrOHaMiAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzIzMDMzOA==", "bodyText": "Map<...>", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r497230338", "createdAt": "2020-09-30T04:02:18Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveFileRenamer.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import com.facebook.presto.spi.ConnectorMetadataUpdateHandle;\n+import com.facebook.presto.spi.QueryId;\n+import com.facebook.presto.spi.SchemaTableName;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ConcurrentMap;\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+public class HiveFileRenamer\n+{\n+    private final ConcurrentMap<QueryId, Map<HiveMetadataUpdateKey, AtomicLong>> queryPartitionFileCounterMap = new ConcurrentHashMap<>();\n+    private final ConcurrentMap<QueryId, Map<HiveMetadataUpdateHandle, String>> queryHiveMetadataResultMap = new ConcurrentHashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08755ed300c8bb8ffc8f50cca06704b97e8ffe65"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExMjgxNjExOnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveFileRenamer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQwNDowMzo1NFrOHaMjYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQwNDowMzo1NFrOHaMjYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzIzMDY5MA==", "bodyText": "use immutable list builder", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r497230690", "createdAt": "2020-09-30T04:03:54Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveFileRenamer.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import com.facebook.presto.spi.ConnectorMetadataUpdateHandle;\n+import com.facebook.presto.spi.QueryId;\n+import com.facebook.presto.spi.SchemaTableName;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ConcurrentMap;\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+public class HiveFileRenamer\n+{\n+    private final ConcurrentMap<QueryId, Map<HiveMetadataUpdateKey, AtomicLong>> queryPartitionFileCounterMap = new ConcurrentHashMap<>();\n+    private final ConcurrentMap<QueryId, Map<HiveMetadataUpdateHandle, String>> queryHiveMetadataResultMap = new ConcurrentHashMap<>();\n+\n+    public List<ConnectorMetadataUpdateHandle> getMetadataUpdateResults(List<ConnectorMetadataUpdateHandle> metadataUpdateRequests, QueryId queryId)\n+    {\n+        List<ConnectorMetadataUpdateHandle> metadataUpdateResults = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08755ed300c8bb8ffc8f50cca06704b97e8ffe65"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExMjgyODY3OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveFileRenamer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQwNDoxMTo0NFrOHaMqXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQwNDoxMTo0NFrOHaMqXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzIzMjQ3OQ==", "bodyText": "Let's add a test to TestHiveDistributedQueries or any other integration tests to make sure after test ends, there is no dangling queries in the map. #14784 is an example.", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r497232479", "createdAt": "2020-09-30T04:11:44Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveFileRenamer.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import com.facebook.presto.spi.ConnectorMetadataUpdateHandle;\n+import com.facebook.presto.spi.QueryId;\n+import com.facebook.presto.spi.SchemaTableName;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ConcurrentMap;\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+public class HiveFileRenamer", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08755ed300c8bb8ffc8f50cca06704b97e8ffe65"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExMjgyOTI2OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveFileRenamer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQwNDoxMjowN1rOHaMqrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQwNDoxMjowN1rOHaMqrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzIzMjU1OQ==", "bodyText": "static", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r497232559", "createdAt": "2020-09-30T04:12:07Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveFileRenamer.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import com.facebook.presto.spi.ConnectorMetadataUpdateHandle;\n+import com.facebook.presto.spi.QueryId;\n+import com.facebook.presto.spi.SchemaTableName;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ConcurrentMap;\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+public class HiveFileRenamer\n+{\n+    private final ConcurrentMap<QueryId, Map<HiveMetadataUpdateKey, AtomicLong>> queryPartitionFileCounterMap = new ConcurrentHashMap<>();\n+    private final ConcurrentMap<QueryId, Map<HiveMetadataUpdateHandle, String>> queryHiveMetadataResultMap = new ConcurrentHashMap<>();\n+\n+    public List<ConnectorMetadataUpdateHandle> getMetadataUpdateResults(List<ConnectorMetadataUpdateHandle> metadataUpdateRequests, QueryId queryId)\n+    {\n+        List<ConnectorMetadataUpdateHandle> metadataUpdateResults = new ArrayList<>();\n+\n+        for (ConnectorMetadataUpdateHandle connectorMetadataUpdateHandle : metadataUpdateRequests) {\n+            HiveMetadataUpdateHandle request = (HiveMetadataUpdateHandle) connectorMetadataUpdateHandle;\n+            String fileName = getFileName(request, queryId);\n+            metadataUpdateResults.add(new HiveMetadataUpdateHandle(request.getRequestId(), request.getSchemaTableName(), request.getPartitionName(), Optional.of(fileName)));\n+        }\n+        return metadataUpdateResults;\n+    }\n+\n+    public void cleanup(QueryId queryId)\n+    {\n+        queryPartitionFileCounterMap.remove(queryId);\n+        queryHiveMetadataResultMap.remove(queryId);\n+    }\n+\n+    private String getFileName(HiveMetadataUpdateHandle request, QueryId queryId)\n+    {\n+        if (!queryPartitionFileCounterMap.containsKey(queryId) || !queryHiveMetadataResultMap.containsKey(queryId)) {\n+            queryPartitionFileCounterMap.putIfAbsent(queryId, new ConcurrentHashMap<>());\n+            queryHiveMetadataResultMap.putIfAbsent(queryId, new ConcurrentHashMap<>());\n+        }\n+\n+        // To keep track of the file counter per query per partition\n+        Map<HiveMetadataUpdateKey, AtomicLong> partitionFileCounterMap = queryPartitionFileCounterMap.get(queryId);\n+\n+        // To keep track of the file name result per query per request\n+        // This is to make sure that request - fileName mapping is 1:1\n+        Map<HiveMetadataUpdateHandle, String> hiveMetadataResultMap = queryHiveMetadataResultMap.get(queryId);\n+\n+        // If we have seen this request before then directly return the result.\n+        if (hiveMetadataResultMap.containsKey(request)) {\n+            // We come here if for some reason the worker did not receive the fileName and it retried the request.\n+            return hiveMetadataResultMap.get(request);\n+        }\n+\n+        HiveMetadataUpdateKey key = new HiveMetadataUpdateKey(request);\n+        partitionFileCounterMap.putIfAbsent(key, new AtomicLong());\n+\n+        AtomicLong fileCount = partitionFileCounterMap.get(key);\n+        String fileName = Long.valueOf(fileCount.incrementAndGet()).toString();\n+\n+        // Store the request - fileName mapping\n+        hiveMetadataResultMap.put(request, fileName);\n+\n+        return fileName;\n+    }\n+\n+    private class HiveMetadataUpdateKey", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08755ed300c8bb8ffc8f50cca06704b97e8ffe65"}, "originalPosition": 84}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExMjgzNTkyOnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveFileRenamer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQwNDoxNjoyNVrOHaMuWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwMToxNDozMFrOHa1zgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzIzMzQ5OA==", "bodyText": "Do we wanna start with new AtomicLong(1)? Actually, check the bucketed case. If bucketed file name started with 1 then we can use AtomicLong(1); otherwise AtomicLong(0).", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r497233498", "createdAt": "2020-09-30T04:16:25Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveFileRenamer.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import com.facebook.presto.spi.ConnectorMetadataUpdateHandle;\n+import com.facebook.presto.spi.QueryId;\n+import com.facebook.presto.spi.SchemaTableName;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ConcurrentMap;\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+public class HiveFileRenamer\n+{\n+    private final ConcurrentMap<QueryId, Map<HiveMetadataUpdateKey, AtomicLong>> queryPartitionFileCounterMap = new ConcurrentHashMap<>();\n+    private final ConcurrentMap<QueryId, Map<HiveMetadataUpdateHandle, String>> queryHiveMetadataResultMap = new ConcurrentHashMap<>();\n+\n+    public List<ConnectorMetadataUpdateHandle> getMetadataUpdateResults(List<ConnectorMetadataUpdateHandle> metadataUpdateRequests, QueryId queryId)\n+    {\n+        List<ConnectorMetadataUpdateHandle> metadataUpdateResults = new ArrayList<>();\n+\n+        for (ConnectorMetadataUpdateHandle connectorMetadataUpdateHandle : metadataUpdateRequests) {\n+            HiveMetadataUpdateHandle request = (HiveMetadataUpdateHandle) connectorMetadataUpdateHandle;\n+            String fileName = getFileName(request, queryId);\n+            metadataUpdateResults.add(new HiveMetadataUpdateHandle(request.getRequestId(), request.getSchemaTableName(), request.getPartitionName(), Optional.of(fileName)));\n+        }\n+        return metadataUpdateResults;\n+    }\n+\n+    public void cleanup(QueryId queryId)\n+    {\n+        queryPartitionFileCounterMap.remove(queryId);\n+        queryHiveMetadataResultMap.remove(queryId);\n+    }\n+\n+    private String getFileName(HiveMetadataUpdateHandle request, QueryId queryId)\n+    {\n+        if (!queryPartitionFileCounterMap.containsKey(queryId) || !queryHiveMetadataResultMap.containsKey(queryId)) {\n+            queryPartitionFileCounterMap.putIfAbsent(queryId, new ConcurrentHashMap<>());\n+            queryHiveMetadataResultMap.putIfAbsent(queryId, new ConcurrentHashMap<>());\n+        }\n+\n+        // To keep track of the file counter per query per partition\n+        Map<HiveMetadataUpdateKey, AtomicLong> partitionFileCounterMap = queryPartitionFileCounterMap.get(queryId);\n+\n+        // To keep track of the file name result per query per request\n+        // This is to make sure that request - fileName mapping is 1:1\n+        Map<HiveMetadataUpdateHandle, String> hiveMetadataResultMap = queryHiveMetadataResultMap.get(queryId);\n+\n+        // If we have seen this request before then directly return the result.\n+        if (hiveMetadataResultMap.containsKey(request)) {\n+            // We come here if for some reason the worker did not receive the fileName and it retried the request.\n+            return hiveMetadataResultMap.get(request);\n+        }\n+\n+        HiveMetadataUpdateKey key = new HiveMetadataUpdateKey(request);\n+        partitionFileCounterMap.putIfAbsent(key, new AtomicLong());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08755ed300c8bb8ffc8f50cca06704b97e8ffe65"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzkwNjU2Mg==", "bodyText": "In bucketed case the file name starts with 0. AtomicLong() is same as AtomicLong(0) . But will change it to AtomicLong(0) as suggested, to be on safe side.", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r497906562", "createdAt": "2020-10-01T01:14:30Z", "author": {"login": "NikhilCollooru"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveFileRenamer.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import com.facebook.presto.spi.ConnectorMetadataUpdateHandle;\n+import com.facebook.presto.spi.QueryId;\n+import com.facebook.presto.spi.SchemaTableName;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ConcurrentMap;\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+public class HiveFileRenamer\n+{\n+    private final ConcurrentMap<QueryId, Map<HiveMetadataUpdateKey, AtomicLong>> queryPartitionFileCounterMap = new ConcurrentHashMap<>();\n+    private final ConcurrentMap<QueryId, Map<HiveMetadataUpdateHandle, String>> queryHiveMetadataResultMap = new ConcurrentHashMap<>();\n+\n+    public List<ConnectorMetadataUpdateHandle> getMetadataUpdateResults(List<ConnectorMetadataUpdateHandle> metadataUpdateRequests, QueryId queryId)\n+    {\n+        List<ConnectorMetadataUpdateHandle> metadataUpdateResults = new ArrayList<>();\n+\n+        for (ConnectorMetadataUpdateHandle connectorMetadataUpdateHandle : metadataUpdateRequests) {\n+            HiveMetadataUpdateHandle request = (HiveMetadataUpdateHandle) connectorMetadataUpdateHandle;\n+            String fileName = getFileName(request, queryId);\n+            metadataUpdateResults.add(new HiveMetadataUpdateHandle(request.getRequestId(), request.getSchemaTableName(), request.getPartitionName(), Optional.of(fileName)));\n+        }\n+        return metadataUpdateResults;\n+    }\n+\n+    public void cleanup(QueryId queryId)\n+    {\n+        queryPartitionFileCounterMap.remove(queryId);\n+        queryHiveMetadataResultMap.remove(queryId);\n+    }\n+\n+    private String getFileName(HiveMetadataUpdateHandle request, QueryId queryId)\n+    {\n+        if (!queryPartitionFileCounterMap.containsKey(queryId) || !queryHiveMetadataResultMap.containsKey(queryId)) {\n+            queryPartitionFileCounterMap.putIfAbsent(queryId, new ConcurrentHashMap<>());\n+            queryHiveMetadataResultMap.putIfAbsent(queryId, new ConcurrentHashMap<>());\n+        }\n+\n+        // To keep track of the file counter per query per partition\n+        Map<HiveMetadataUpdateKey, AtomicLong> partitionFileCounterMap = queryPartitionFileCounterMap.get(queryId);\n+\n+        // To keep track of the file name result per query per request\n+        // This is to make sure that request - fileName mapping is 1:1\n+        Map<HiveMetadataUpdateHandle, String> hiveMetadataResultMap = queryHiveMetadataResultMap.get(queryId);\n+\n+        // If we have seen this request before then directly return the result.\n+        if (hiveMetadataResultMap.containsKey(request)) {\n+            // We come here if for some reason the worker did not receive the fileName and it retried the request.\n+            return hiveMetadataResultMap.get(request);\n+        }\n+\n+        HiveMetadataUpdateKey key = new HiveMetadataUpdateKey(request);\n+        partitionFileCounterMap.putIfAbsent(key, new AtomicLong());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzIzMzQ5OA=="}, "originalCommit": {"oid": "08755ed300c8bb8ffc8f50cca06704b97e8ffe65"}, "originalPosition": 73}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExMjgzNzczOnYy", "diffSide": "RIGHT", "path": "presto-hive/src/test/java/com/facebook/presto/hive/TestHiveFileRenamer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQwNDoxNzozOVrOHaMvZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQwNDoxNzozOVrOHaMvZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzIzMzc2NQ==", "bodyText": "TEST_QUERY_ID", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r497233765", "createdAt": "2020-09-30T04:17:39Z", "author": {"login": "highker"}, "path": "presto-hive/src/test/java/com/facebook/presto/hive/TestHiveFileRenamer.java", "diffHunk": "@@ -0,0 +1,226 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import com.facebook.presto.spi.ConnectorMetadataUpdateHandle;\n+import com.facebook.presto.spi.QueryId;\n+import com.facebook.presto.spi.SchemaTableName;\n+import com.google.common.collect.ImmutableList;\n+import org.testng.annotations.Test;\n+\n+import java.util.ArrayList;\n+import java.util.Comparator;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.UUID;\n+import java.util.concurrent.CopyOnWriteArrayList;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.stream.Collectors;\n+\n+import static com.facebook.presto.hive.TestHiveMetadataUpdateHandle.TEST_HIVE_METADATA_UPDATE_REQUEST;\n+import static com.facebook.presto.hive.TestHiveMetadataUpdateHandle.TEST_PARTITION_NAME;\n+import static com.facebook.presto.hive.TestHiveMetadataUpdateHandle.TEST_REQUEST_ID;\n+import static com.facebook.presto.hive.TestHiveMetadataUpdateHandle.TEST_SCHEMA_NAME;\n+import static com.facebook.presto.hive.TestHiveMetadataUpdateHandle.TEST_SCHEMA_TABLE_NAME;\n+import static com.facebook.presto.hive.TestHiveMetadataUpdateHandle.TEST_TABLE_NAME;\n+import static org.testng.Assert.assertEquals;\n+import static org.testng.Assert.assertTrue;\n+\n+@Test\n+public class TestHiveFileRenamer\n+{\n+    private static final QueryId TEST_QUERYID = new QueryId(\"test\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08755ed300c8bb8ffc8f50cca06704b97e8ffe65"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExMjgzODY1OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/test/java/com/facebook/presto/hive/TestHiveFileRenamer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQwNDoxODoyNFrOHaMwAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQwNDoxODoyNFrOHaMwAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzIzMzkyMw==", "bodyText": "List<String> aggregatedFileNames = new ArrayList<>(fileNames);", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r497233923", "createdAt": "2020-09-30T04:18:24Z", "author": {"login": "highker"}, "path": "presto-hive/src/test/java/com/facebook/presto/hive/TestHiveFileRenamer.java", "diffHunk": "@@ -0,0 +1,226 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import com.facebook.presto.spi.ConnectorMetadataUpdateHandle;\n+import com.facebook.presto.spi.QueryId;\n+import com.facebook.presto.spi.SchemaTableName;\n+import com.google.common.collect.ImmutableList;\n+import org.testng.annotations.Test;\n+\n+import java.util.ArrayList;\n+import java.util.Comparator;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.UUID;\n+import java.util.concurrent.CopyOnWriteArrayList;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.stream.Collectors;\n+\n+import static com.facebook.presto.hive.TestHiveMetadataUpdateHandle.TEST_HIVE_METADATA_UPDATE_REQUEST;\n+import static com.facebook.presto.hive.TestHiveMetadataUpdateHandle.TEST_PARTITION_NAME;\n+import static com.facebook.presto.hive.TestHiveMetadataUpdateHandle.TEST_REQUEST_ID;\n+import static com.facebook.presto.hive.TestHiveMetadataUpdateHandle.TEST_SCHEMA_NAME;\n+import static com.facebook.presto.hive.TestHiveMetadataUpdateHandle.TEST_SCHEMA_TABLE_NAME;\n+import static com.facebook.presto.hive.TestHiveMetadataUpdateHandle.TEST_TABLE_NAME;\n+import static org.testng.Assert.assertEquals;\n+import static org.testng.Assert.assertTrue;\n+\n+@Test\n+public class TestHiveFileRenamer\n+{\n+    private static final QueryId TEST_QUERYID = new QueryId(\"test\");\n+    private static final int REQUEST_COUNT = 10;\n+    private static final int PARTITION_COUNT = 10;\n+    private static final int TABLE_COUNT = 10;\n+    private static final int THREAD_COUNT = 100;\n+    private static final int THREAD_POOL_SIZE = 10;\n+\n+    @Test\n+    public void testHiveFileRenamer()\n+    {\n+        HiveFileRenamer hiveFileRenamer = new HiveFileRenamer();\n+        List<ConnectorMetadataUpdateHandle> requests = ImmutableList.of(TEST_HIVE_METADATA_UPDATE_REQUEST);\n+        List<ConnectorMetadataUpdateHandle> results = hiveFileRenamer.getMetadataUpdateResults(requests, TEST_QUERYID);\n+\n+        // Assert # of requests is equal to # of results\n+        assertEquals(requests.size(), results.size());\n+\n+        HiveMetadataUpdateHandle result = (HiveMetadataUpdateHandle) results.get(0);\n+\n+        assertEquals(result.getRequestId(), TEST_REQUEST_ID);\n+        assertEquals(result.getSchemaTableName(), TEST_SCHEMA_TABLE_NAME);\n+        assertEquals(result.getPartitionName(), Optional.of(TEST_PARTITION_NAME));\n+\n+        // Assert file name returned is \"1\"\n+        assertEquals(result.getMetadataUpdate(), Optional.of(\"1\"));\n+    }\n+\n+    @Test\n+    public void testFileNamesForSinglePartition()\n+    {\n+        HiveFileRenamer hiveFileRenamer = new HiveFileRenamer();\n+        List<String> aggregatedFileNames = new ArrayList<>();\n+        List<ConnectorMetadataUpdateHandle> requests = createHiveMetadataUpdateRequests(TEST_SCHEMA_NAME, TEST_TABLE_NAME, TEST_PARTITION_NAME);\n+        List<String> fileNames = getFileNames(hiveFileRenamer, requests);\n+        aggregatedFileNames.addAll(fileNames);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08755ed300c8bb8ffc8f50cca06704b97e8ffe65"}, "originalPosition": 79}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExMjg0MzYyOnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/com/facebook/presto/metadata/MetadataManager.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQwNDoyMTo0M1rOHaMy9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQwNDo0MToyMlrOHaNEgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzIzNDY3Nw==", "bodyText": "Do we actually need this?", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r497234677", "createdAt": "2020-09-30T04:21:43Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/metadata/MetadataManager.java", "diffHunk": "@@ -138,6 +141,7 @@\n     private final TransactionManager transactionManager;\n \n     private final ConcurrentMap<String, Collection<ConnectorMetadata>> catalogsByQueryId = new ConcurrentHashMap<>();\n+    private final Set<QueryId> queriesWithRegisteredCallbacks = new HashSet<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08755ed300c8bb8ffc8f50cca06704b97e8ffe65"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzIzOTE2OA==", "bodyText": "This is to make sure that we add only 1 callback for a query.", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r497239168", "createdAt": "2020-09-30T04:41:22Z", "author": {"login": "NikhilCollooru"}, "path": "presto-main/src/main/java/com/facebook/presto/metadata/MetadataManager.java", "diffHunk": "@@ -138,6 +141,7 @@\n     private final TransactionManager transactionManager;\n \n     private final ConcurrentMap<String, Collection<ConnectorMetadata>> catalogsByQueryId = new ConcurrentHashMap<>();\n+    private final Set<QueryId> queriesWithRegisteredCallbacks = new HashSet<>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzIzNDY3Nw=="}, "originalCommit": {"oid": "08755ed300c8bb8ffc8f50cca06704b97e8ffe65"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExMjg0NDM5OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/com/facebook/presto/metadata/MetadataManager.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQwNDoyMjowNVrOHaMzYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQwNDo0MjowM1rOHaNFMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzIzNDc4NA==", "bodyText": "It's ok to remove multiple times as long as we can make sure they are cleaned up", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r497234784", "createdAt": "2020-09-30T04:22:05Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/metadata/MetadataManager.java", "diffHunk": "@@ -1210,6 +1214,28 @@ public void revokeTablePrivileges(Session session, QualifiedObjectName tableName\n         return toListenableFuture(metadata.commitPageSinkAsync(connectorSession, tableHandle.getConnectorHandle(), fragments));\n     }\n \n+    @Override\n+    public MetadataUpdates getMetadataUpdateResults(Session session, QueryManager queryManager, MetadataUpdates metadataUpdateRequests, QueryId queryId)\n+    {\n+        ConnectorId connectorId = metadataUpdateRequests.getConnectorId();\n+        ConnectorMetadata metadata = getCatalogMetadata(session, connectorId).getMetadata();\n+\n+        if (queryManager != null && !queriesWithRegisteredCallbacks.contains(queryId)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08755ed300c8bb8ffc8f50cca06704b97e8ffe65"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzIzOTM0NA==", "bodyText": "We want to add only 1 callback for a given queryId. If we don't check, we will end up adding callback everytime we call getMetadataUpdateResults. That might result is adding 10's of callbacks just for 1 query.", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r497239344", "createdAt": "2020-09-30T04:42:03Z", "author": {"login": "NikhilCollooru"}, "path": "presto-main/src/main/java/com/facebook/presto/metadata/MetadataManager.java", "diffHunk": "@@ -1210,6 +1214,28 @@ public void revokeTablePrivileges(Session session, QualifiedObjectName tableName\n         return toListenableFuture(metadata.commitPageSinkAsync(connectorSession, tableHandle.getConnectorHandle(), fragments));\n     }\n \n+    @Override\n+    public MetadataUpdates getMetadataUpdateResults(Session session, QueryManager queryManager, MetadataUpdates metadataUpdateRequests, QueryId queryId)\n+    {\n+        ConnectorId connectorId = metadataUpdateRequests.getConnectorId();\n+        ConnectorMetadata metadata = getCatalogMetadata(session, connectorId).getMetadata();\n+\n+        if (queryManager != null && !queriesWithRegisteredCallbacks.contains(queryId)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzIzNDc4NA=="}, "originalCommit": {"oid": "08755ed300c8bb8ffc8f50cca06704b97e8ffe65"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExMjg0NzE3OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/com/facebook/presto/server/remotetask/TaskInfoFetcher.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQwNDoyMzo0MVrOHaM07A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQwNDoyMzo0MVrOHaM07A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzIzNTE4MA==", "bodyText": "if (!metadataUpdateRequests.getMetadataUpdates().isEmpty())", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r497235180", "createdAt": "2020-09-30T04:23:41Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/server/remotetask/TaskInfoFetcher.java", "diffHunk": "@@ -225,6 +250,11 @@ private synchronized void sendNextRequest()\n             return;\n         }\n \n+        MetadataUpdates metadataUpdateRequests = taskInfo.getMetadataUpdates();\n+        if (metadataUpdateRequests.getMetadataUpdates().size() > 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08755ed300c8bb8ffc8f50cca06704b97e8ffe65"}, "originalPosition": 103}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExNzUwOTU1OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/com/facebook/presto/execution/SqlTask.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwNDoyMToyNFrOHa6A6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwNDoyMToyNFrOHa6A6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzk3NTUzMQ==", "bodyText": "!taskMetadataContext.getMetadataUpdaters().isEmpty()", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r497975531", "createdAt": "2020-10-01T04:21:24Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/SqlTask.java", "diffHunk": "@@ -313,6 +317,24 @@ private TaskStats getTaskStats(TaskHolder taskHolder)\n         return new TaskStats(taskStateMachine.getCreatedTime(), endTime);\n     }\n \n+    private MetadataUpdates getMetadataUpdateRequests(TaskHolder taskHolder)\n+    {\n+        ConnectorId connectorId = null;\n+        ImmutableList.Builder<ConnectorMetadataUpdateHandle> connectorMetadataUpdatesBuilder = ImmutableList.builder();\n+\n+        if (taskHolder.getTaskExecution() != null) {\n+            TaskMetadataContext taskMetadataContext = taskHolder.getTaskExecution().getTaskContext().getTaskMetadataContext();\n+            if (taskMetadataContext.getMetadataUpdaters().size() > 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88dc3c3d0e51037e93ed4d70ca7e74ef8c7fdfaf"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExNzUxNDM5OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/com/facebook/presto/execution/TaskManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwNDoyNDozNFrOHa6Dqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwNDoyNDozNFrOHa6Dqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzk3NjIzNQ==", "bodyText": "remove default; throw exception for all other implementations.", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r497976235", "createdAt": "2020-10-01T04:24:34Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/TaskManager.java", "diffHunk": "@@ -142,4 +143,11 @@ TaskInfo updateTask(\n      * from {@code remoteSourceTaskId} will be ignored.\n      */\n     void removeRemoteSource(TaskId taskId, TaskId remoteSourceTaskId);\n+\n+    /**\n+     * Update the results of metadata requests sent\n+     */\n+    default void updateMetadataResults(TaskId taskId, MetadataUpdates metadataUpdates)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "489fe81d5cb1ab91a096f91faf15751f747fda46"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExNzUzMzAzOnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/com/facebook/presto/metadata/MetadataManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwNDozNzozM1rOHa6OZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwNDozNzozM1rOHa6OZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzk3ODk4Mw==", "bodyText": "ConcurrentHashMap.newKeySet();", "url": "https://github.com/prestodb/presto/pull/14974#discussion_r497978983", "createdAt": "2020-10-01T04:37:33Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/metadata/MetadataManager.java", "diffHunk": "@@ -138,6 +141,7 @@\n     private final TransactionManager transactionManager;\n \n     private final ConcurrentMap<String, Collection<ConnectorMetadata>> catalogsByQueryId = new ConcurrentHashMap<>();\n+    private final Set<QueryId> queriesWithRegisteredCallbacks = new HashSet<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9818eed3128df866247529ace986988308a15abb"}, "originalPosition": 25}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2261, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}