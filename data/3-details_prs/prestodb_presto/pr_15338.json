{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA2NTAyNDEw", "number": 15338, "title": "Change warning to ignore unreadable partitions to be a digest", "bodyText": "This PR is for issue #15285\nHiveSplitManager creates a PrestoWarning for each unreadable partition within a partitionBatch:\nTable <table name> partition <partition name> is not readable: <reason>\nTable <table name> partition <partition name> is not readable: <reason>\nTable <table name> partition <partition name> is not readable: <reason>\n\nThis is excessive and can result in memory/readability issues for a large number of unreadable partitions. With the changes in this PR,\n1 PrestoWarning is added to the warningCollector for each partitionBatch. The warning message for the PrestoWarning follows this general format:\nTable <table name> has <number of unreadable partitions> out of <total partitions> partitions unreadable: \n<reason_a>: <partition name> <partition name>  <\"...\" if more than 2 unreadable partitions have this error>\n<reason_b>: <partition name> <partition name>  <\"...\" if more than 2 unreadable partitions have this error>\n<\"...\" if more than 2 types of errors>\n\nA partition can be unreadable for more than one reason (in theory). If there is only 1 reason, a maximum of 2 partitions will be displayed, and if there are 2 reasons, a maximum of 4 partitions will be displayed. If there are more than 2 partitions that are unreadable for the same reason, <partition name> <partition name> ...\nIn practice, the PrestoWarning message will likely follow:\nTable <table name> has <number of unreadable partitions> out of <total partitions> partitions unreadable: \n<reason>: <partition name> <partition name> ...\n\n(I think..)\nOther changes: Strings partName and partitionNotReadable changed to partitionName and reason to be more descriptive. MetastoreUtil.makePartName() should also be modified. Tests added in TestHiveClientFileMetastore to validate the new format of the PrestoWarning message.", "createdAt": "2020-10-20T06:09:47Z", "url": "https://github.com/prestodb/presto/pull/15338", "merged": true, "mergeCommit": {"oid": "355aec9cb932afc3196812cf81e1b0ab91c014b7"}, "closed": true, "closedAt": "2020-10-28T04:03:11Z", "author": {"login": "Moe82"}, "timelineItems": {"totalCount": 32, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdUb7t1gFqTUxMjkxOTU0Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdW1fhVAFqTUxODMwODg1MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyOTE5NTQ2", "url": "https://github.com/prestodb/presto/pull/15338#pullrequestreview-512919546", "createdAt": "2020-10-20T16:26:54Z", "commit": {"oid": "8a6e899be8bfc0d29a44bd2c94ad436750c83709"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxNjoyNjo1NFrOHlGz-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxNzowNjo0NVrOHlIYyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY3MDk3MQ==", "bodyText": "Could you help to change partName to partitionName?", "url": "https://github.com/prestodb/presto/pull/15338#discussion_r508670971", "createdAt": "2020-10-20T16:26:54Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -397,9 +401,7 @@ public CounterStat getHighMemorySplitSource()\n                         if (!shouldIgnoreUnreadablePartition(session) || !partition.isEligibleToIgnore()) {\n                             throw new HiveNotReadableException(tableName, Optional.of(partName), partitionNotReadable);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a6e899be8bfc0d29a44bd2c94ad436750c83709"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY5MTg5OQ==", "bodyText": "Could you help to change partitionNotReadable to reason?", "url": "https://github.com/prestodb/presto/pull/15338#discussion_r508691899", "createdAt": "2020-10-20T16:59:07Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -397,9 +401,7 @@ public CounterStat getHighMemorySplitSource()\n                         if (!shouldIgnoreUnreadablePartition(session) || !partition.isEligibleToIgnore()) {\n                             throw new HiveNotReadableException(tableName, Optional.of(partName), partitionNotReadable);\n                         }\n-                        warningCollector.add(new PrestoWarning(\n-                                PARTITION_NOT_READABLE,\n-                                format(\"Table '%s' partition '%s' is not readable: %s\", tableName, partName, partitionNotReadable)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a6e899be8bfc0d29a44bd2c94ad436750c83709"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY5NDk3MQ==", "bodyText": "// put unreadable partitions with a limit of 2 in order not to be too verbose\nif (partitionsNotReadable.size() < 2) {\n    partitionsNotReadable.putIfAbsent(partitionNotReadable, new HashSet<>(ImmutableSet.of(partName)));\n    // limit per-reason partitions to be 2 as well\n    if (partitionsNotReadable.get(partitionNotReadable).size() < 2) {\n        partitionsNotReadable.get(partitionNotReadable).add(partName);\n    }\n}", "url": "https://github.com/prestodb/presto/pull/15338#discussion_r508694971", "createdAt": "2020-10-20T17:03:58Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -397,9 +401,7 @@ public CounterStat getHighMemorySplitSource()\n                         if (!shouldIgnoreUnreadablePartition(session) || !partition.isEligibleToIgnore()) {\n                             throw new HiveNotReadableException(tableName, Optional.of(partName), partitionNotReadable);\n                         }\n-                        warningCollector.add(new PrestoWarning(\n-                                PARTITION_NOT_READABLE,\n-                                format(\"Table '%s' partition '%s' is not readable: %s\", tableName, partName, partitionNotReadable)));\n+                        partitionsNotReadable.put(partName, partitionNotReadable);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a6e899be8bfc0d29a44bd2c94ad436750c83709"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY5NTQzMw==", "bodyText": "We wanna make it to be concise; so likely use a mutable hash map.\nMap<String, Set<String>> partitionsNotReadable = new HashMap<>();", "url": "https://github.com/prestodb/presto/pull/15338#discussion_r508695433", "createdAt": "2020-10-20T17:04:41Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -379,6 +382,7 @@ public CounterStat getHighMemorySplitSource()\n                     partitions);\n \n             ImmutableList.Builder<HivePartitionMetadata> results = ImmutableList.builder();\n+            ImmutableMap.Builder<String, String> partitionsNotReadable = ImmutableMap.builder();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a6e899be8bfc0d29a44bd2c94ad436750c83709"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY5NTcwMg==", "bodyText": "Also add a counter to check how many unreadable partitions are skipped", "url": "https://github.com/prestodb/presto/pull/15338#discussion_r508695702", "createdAt": "2020-10-20T17:05:06Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -379,6 +382,7 @@ public CounterStat getHighMemorySplitSource()\n                     partitions);\n \n             ImmutableList.Builder<HivePartitionMetadata> results = ImmutableList.builder();\n+            ImmutableMap.Builder<String, String> partitionsNotReadable = ImmutableMap.builder();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a6e899be8bfc0d29a44bd2c94ad436750c83709"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY5NjU3NQ==", "bodyText": "Directly use the hash map", "url": "https://github.com/prestodb/presto/pull/15338#discussion_r508696575", "createdAt": "2020-10-20T17:06:24Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -475,7 +477,16 @@ public CounterStat getHighMemorySplitSource()\n \n                 results.add(new HivePartitionMetadata(hivePartition, Optional.of(partition), partitionSchemaDifference.build(), encryptionInformation));\n             }\n-\n+            Map<String, String> map = partitionsNotReadable.build();\n+            Multimap<String, String> multiMap = HashMultimap.create();\n+            for (java.util.Map.Entry<String, String> entry : map.entrySet()) {\n+                multiMap.put(entry.getValue(), entry.getKey());\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a6e899be8bfc0d29a44bd2c94ad436750c83709"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY5Njc3Nw==", "bodyText": "Just put into one warning", "url": "https://github.com/prestodb/presto/pull/15338#discussion_r508696777", "createdAt": "2020-10-20T17:06:45Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -475,7 +477,16 @@ public CounterStat getHighMemorySplitSource()\n \n                 results.add(new HivePartitionMetadata(hivePartition, Optional.of(partition), partitionSchemaDifference.build(), encryptionInformation));\n             }\n-\n+            Map<String, String> map = partitionsNotReadable.build();\n+            Multimap<String, String> multiMap = HashMultimap.create();\n+            for (java.util.Map.Entry<String, String> entry : map.entrySet()) {\n+                multiMap.put(entry.getValue(), entry.getKey());\n+            }\n+            for (java.util.Map.Entry<String, Collection<String>> entry : multiMap.asMap().entrySet()) {\n+                warningCollector.add(new PrestoWarning(\n+                        PARTITION_NOT_READABLE,\n+                        format(\"Table '%s' has '%s' out of '%s' partitions: '%s' not readable: %s\", tableName, entry.getValue().size(), partitionBatch.size(), entry.getValue(), entry.getKey())));\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a6e899be8bfc0d29a44bd2c94ad436750c83709"}, "originalPosition": 55}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0MjE2NjIw", "url": "https://github.com/prestodb/presto/pull/15338#pullrequestreview-514216620", "createdAt": "2020-10-21T21:58:17Z", "commit": {"oid": "5404a67af7d2884e11488f12bdc6e0301046949c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQyMTo1ODoxOFrOHmH13g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQyMTo1ODoxOFrOHmH13g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTczNjQxNA==", "bodyText": "output:\nTable <table name> has <number of unreadable partitions> out of <total partitions> partitions unreadable: \n<error>: < partitions> <\"...\" if more than 2 unreadable partitions have this error>\n<error>: < partitions> <\"...\" if more than 2 unreadable partitions have this error>\n<\"...\" if more than 2 types of errors>", "url": "https://github.com/prestodb/presto/pull/15338#discussion_r509736414", "createdAt": "2020-10-21T21:58:18Z", "author": {"login": "Moe82"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -477,16 +489,15 @@ public CounterStat getHighMemorySplitSource()\n \n                 results.add(new HivePartitionMetadata(hivePartition, Optional.of(partition), partitionSchemaDifference.build(), encryptionInformation));\n             }\n-            Map<String, String> map = partitionsNotReadable.build();\n-            Multimap<String, String> multiMap = HashMultimap.create();\n-            for (java.util.Map.Entry<String, String> entry : map.entrySet()) {\n-                multiMap.put(entry.getValue(), entry.getKey());\n-            }\n-            for (java.util.Map.Entry<String, Collection<String>> entry : multiMap.asMap().entrySet()) {\n-                warningCollector.add(new PrestoWarning(\n-                        PARTITION_NOT_READABLE,\n-                        format(\"Table '%s' has '%s' out of '%s' partitions: '%s' not readable: %s\", tableName, entry.getValue().size(), partitionBatch.size(), entry.getValue(), entry.getKey())));\n+            String prestoWarningMessage = format(\"Table '%s' has '%s' out of '%s' partitions unreadable: \", tableName, partitionsNotReadable.values().stream().mapToInt(Set::size).sum(), partitionBatch.size());\n+            for (Entry<String, Set<String>> entry : partitionsNotReadable.entrySet()) {\n+                if (entry.getValue().size() > 2)\n+                    prestoWarningMessage += \"\\n\" + entry.getKey().toString() + \": \" + entry.getValue().iterator().next() + \", \" + entry.getValue().iterator().next() + \" ...\";\n+                else prestoWarningMessage += \"\\n\" + entry.getKey().toString() + \": \" + entry.getValue().toString();\n             }\n+            if (reasonsSkipped > 3)\n+                prestoWarningMessage += \"\\n...\";\n+            warningCollector.add(new PrestoWarning(PARTITION_NOT_READABLE, prestoWarningMessage));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5404a67af7d2884e11488f12bdc6e0301046949c"}, "originalPosition": 95}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "50b7ac626b6193c23b61e826e1ae896f67dfee8d", "author": {"user": {"login": "Moe82", "name": "Mohamed Shafee"}}, "url": "https://github.com/prestodb/presto/commit/50b7ac626b6193c23b61e826e1ae896f67dfee8d", "committedDate": "2020-10-21T21:34:02Z", "message": "Fixed style issues"}, "afterCommit": {"oid": "d3c10a6bb2c0a90c704b3ddf5ba2535b00f2b768", "author": {"user": {"login": "Moe82", "name": "Mohamed Shafee"}}, "url": "https://github.com/prestodb/presto/commit/d3c10a6bb2c0a90c704b3ddf5ba2535b00f2b768", "committedDate": "2020-10-21T22:28:02Z", "message": "squashed commits"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d3c10a6bb2c0a90c704b3ddf5ba2535b00f2b768", "author": {"user": {"login": "Moe82", "name": "Mohamed Shafee"}}, "url": "https://github.com/prestodb/presto/commit/d3c10a6bb2c0a90c704b3ddf5ba2535b00f2b768", "committedDate": "2020-10-21T22:28:02Z", "message": "squashed commits"}, "afterCommit": {"oid": "0dec341c3632f67a8934bebfc5e7be3e7126f801", "author": {"user": {"login": "Moe82", "name": "Mohamed Shafee"}}, "url": "https://github.com/prestodb/presto/commit/0dec341c3632f67a8934bebfc5e7be3e7126f801", "committedDate": "2020-10-22T00:49:34Z", "message": "squashed commits"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0dec341c3632f67a8934bebfc5e7be3e7126f801", "author": {"user": {"login": "Moe82", "name": "Mohamed Shafee"}}, "url": "https://github.com/prestodb/presto/commit/0dec341c3632f67a8934bebfc5e7be3e7126f801", "committedDate": "2020-10-22T00:49:34Z", "message": "squashed commits"}, "afterCommit": {"oid": "a470486030e5c2a6a5e3bb68d6de110ee773ec2c", "author": {"user": {"login": "Moe82", "name": "Mohamed Shafee"}}, "url": "https://github.com/prestodb/presto/commit/a470486030e5c2a6a5e3bb68d6de110ee773ec2c", "committedDate": "2020-10-22T17:14:41Z", "message": "change warning to ignore unreadable partitions to be a digest"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "807da750d77fa4213396cb75bcfc0f079830e919", "author": {"user": {"login": "Moe82", "name": "Mohamed Shafee"}}, "url": "https://github.com/prestodb/presto/commit/807da750d77fa4213396cb75bcfc0f079830e919", "committedDate": "2020-10-22T17:48:08Z", "message": "modified HiveSplitManager.java"}, "afterCommit": {"oid": "26af7843ce64e9cbb0e10206d7c7721185730ec3", "author": {"user": {"login": "Moe82", "name": "Mohamed Shafee"}}, "url": "https://github.com/prestodb/presto/commit/26af7843ce64e9cbb0e10206d7c7721185730ec3", "committedDate": "2020-10-22T17:51:42Z", "message": "change warning to ignore unreadable partitions to be a digest"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c3ac5d72939dc053ac81e5360282cfb51aa2bbf0", "author": {"user": {"login": "Moe82", "name": "Mohamed Shafee"}}, "url": "https://github.com/prestodb/presto/commit/c3ac5d72939dc053ac81e5360282cfb51aa2bbf0", "committedDate": "2020-10-22T18:49:46Z", "message": "modified HiveSplitManager.java"}, "afterCommit": {"oid": "b08bcc485df7ac67f754bb2fa92a597534906db6", "author": {"user": {"login": "Moe82", "name": "Mohamed Shafee"}}, "url": "https://github.com/prestodb/presto/commit/b08bcc485df7ac67f754bb2fa92a597534906db6", "committedDate": "2020-10-22T18:50:58Z", "message": "change warning to ignore unreadable partitions to be a digest"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "72fe39bf665b0029deef49bc19b7f7135d882740", "author": {"user": {"login": "Moe82", "name": "Mohamed Shafee"}}, "url": "https://github.com/prestodb/presto/commit/72fe39bf665b0029deef49bc19b7f7135d882740", "committedDate": "2020-10-22T18:53:17Z", "message": "modified HiveSplitManager.java"}, "afterCommit": {"oid": "c6001b68f403655f235e07ed9a384b69b2542d39", "author": {"user": {"login": "Moe82", "name": "Mohamed Shafee"}}, "url": "https://github.com/prestodb/presto/commit/c6001b68f403655f235e07ed9a384b69b2542d39", "committedDate": "2020-10-22T18:53:46Z", "message": "change warning to ignore unreadable partitions to be a digest"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c6001b68f403655f235e07ed9a384b69b2542d39", "author": {"user": {"login": "Moe82", "name": "Mohamed Shafee"}}, "url": "https://github.com/prestodb/presto/commit/c6001b68f403655f235e07ed9a384b69b2542d39", "committedDate": "2020-10-22T18:53:46Z", "message": "change warning to ignore unreadable partitions to be a digest"}, "afterCommit": {"oid": "4541964184c36f4bb464a91515b0cd3d11dd1713", "author": {"user": {"login": "Moe82", "name": "Mohamed Shafee"}}, "url": "https://github.com/prestodb/presto/commit/4541964184c36f4bb464a91515b0cd3d11dd1713", "committedDate": "2020-10-22T22:20:40Z", "message": "change warning to ignore unreadable partitions to be a digest"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1OTQ1NTg5", "url": "https://github.com/prestodb/presto/pull/15338#pullrequestreview-515945589", "createdAt": "2020-10-23T19:23:11Z", "commit": {"oid": "4541964184c36f4bb464a91515b0cd3d11dd1713"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxOToyMzoxMVrOHnbM6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxOToyNDowNlrOHnbP1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEwMjE4NA==", "bodyText": "We should move unreadablePartitionsSkipped++; before this if", "url": "https://github.com/prestodb/presto/pull/15338#discussion_r511102184", "createdAt": "2020-10-23T19:23:11Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -379,27 +382,40 @@ public CounterStat getHighMemorySplitSource()\n                     partitions);\n \n             ImmutableList.Builder<HivePartitionMetadata> results = ImmutableList.builder();\n+            Map<String, Set<String>> partitionsNotReadable = new HashMap<>();\n+            int unreadablePartitionsSkipped = 0;\n+            int reasonsSkipped = 0;\n             for (HivePartition hivePartition : partitionBatch) {\n                 Partition partition = partitions.get(hivePartition.getPartitionId());\n                 if (partition == null) {\n                     throw new PrestoException(GENERIC_INTERNAL_ERROR, \"Partition not loaded: \" + hivePartition);\n                 }\n-                String partName = makePartName(table.getPartitionColumns(), partition.getValues());\n+                String partitionName = makePartName(table.getPartitionColumns(), partition.getValues());\n                 Optional<EncryptionInformation> encryptionInformation = encryptionInformationForPartitions.map(metadata -> metadata.get(hivePartition.getPartitionId()));\n \n                 if (!isOfflineDataDebugModeEnabled(session)) {\n                     // verify partition is online\n-                    verifyOnline(tableName, Optional.of(partName), getProtectMode(partition), partition.getParameters());\n+                    verifyOnline(tableName, Optional.of(partitionName), getProtectMode(partition), partition.getParameters());\n \n                     // verify partition is not marked as non-readable\n-                    String partitionNotReadable = partition.getParameters().get(OBJECT_NOT_READABLE);\n-                    if (!isNullOrEmpty(partitionNotReadable)) {\n+                    String reason = partition.getParameters().get(OBJECT_NOT_READABLE);\n+                    if (!isNullOrEmpty(reason)) {\n                         if (!shouldIgnoreUnreadablePartition(session) || !partition.isEligibleToIgnore()) {\n-                            throw new HiveNotReadableException(tableName, Optional.of(partName), partitionNotReadable);\n+                            throw new HiveNotReadableException(tableName, Optional.of(partitionName), reason);\n+                        }\n+                        if (partitionsNotReadable.size() < 3) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4541964184c36f4bb464a91515b0cd3d11dd1713"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEwMjMxMg==", "bodyText": "remove this", "url": "https://github.com/prestodb/presto/pull/15338#discussion_r511102312", "createdAt": "2020-10-23T19:23:20Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -379,27 +382,40 @@ public CounterStat getHighMemorySplitSource()\n                     partitions);\n \n             ImmutableList.Builder<HivePartitionMetadata> results = ImmutableList.builder();\n+            Map<String, Set<String>> partitionsNotReadable = new HashMap<>();\n+            int unreadablePartitionsSkipped = 0;\n+            int reasonsSkipped = 0;\n             for (HivePartition hivePartition : partitionBatch) {\n                 Partition partition = partitions.get(hivePartition.getPartitionId());\n                 if (partition == null) {\n                     throw new PrestoException(GENERIC_INTERNAL_ERROR, \"Partition not loaded: \" + hivePartition);\n                 }\n-                String partName = makePartName(table.getPartitionColumns(), partition.getValues());\n+                String partitionName = makePartName(table.getPartitionColumns(), partition.getValues());\n                 Optional<EncryptionInformation> encryptionInformation = encryptionInformationForPartitions.map(metadata -> metadata.get(hivePartition.getPartitionId()));\n \n                 if (!isOfflineDataDebugModeEnabled(session)) {\n                     // verify partition is online\n-                    verifyOnline(tableName, Optional.of(partName), getProtectMode(partition), partition.getParameters());\n+                    verifyOnline(tableName, Optional.of(partitionName), getProtectMode(partition), partition.getParameters());\n \n                     // verify partition is not marked as non-readable\n-                    String partitionNotReadable = partition.getParameters().get(OBJECT_NOT_READABLE);\n-                    if (!isNullOrEmpty(partitionNotReadable)) {\n+                    String reason = partition.getParameters().get(OBJECT_NOT_READABLE);\n+                    if (!isNullOrEmpty(reason)) {\n                         if (!shouldIgnoreUnreadablePartition(session) || !partition.isEligibleToIgnore()) {\n-                            throw new HiveNotReadableException(tableName, Optional.of(partName), partitionNotReadable);\n+                            throw new HiveNotReadableException(tableName, Optional.of(partitionName), reason);\n+                        }\n+                        if (partitionsNotReadable.size() < 3) {\n+                            partitionsNotReadable.putIfAbsent(reason, new HashSet<>(ImmutableSet.of(partitionName)));\n+                            if (partitionsNotReadable.get(reason).size() < 3) {\n+                                partitionsNotReadable.get(reason).add(partitionName);\n+                            }\n+                            else {\n+                                unreadablePartitionsSkipped++;\n+                            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4541964184c36f4bb464a91515b0cd3d11dd1713"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEwMjQzOQ==", "bodyText": "remove this", "url": "https://github.com/prestodb/presto/pull/15338#discussion_r511102439", "createdAt": "2020-10-23T19:23:28Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -379,27 +382,40 @@ public CounterStat getHighMemorySplitSource()\n                     partitions);\n \n             ImmutableList.Builder<HivePartitionMetadata> results = ImmutableList.builder();\n+            Map<String, Set<String>> partitionsNotReadable = new HashMap<>();\n+            int unreadablePartitionsSkipped = 0;\n+            int reasonsSkipped = 0;\n             for (HivePartition hivePartition : partitionBatch) {\n                 Partition partition = partitions.get(hivePartition.getPartitionId());\n                 if (partition == null) {\n                     throw new PrestoException(GENERIC_INTERNAL_ERROR, \"Partition not loaded: \" + hivePartition);\n                 }\n-                String partName = makePartName(table.getPartitionColumns(), partition.getValues());\n+                String partitionName = makePartName(table.getPartitionColumns(), partition.getValues());\n                 Optional<EncryptionInformation> encryptionInformation = encryptionInformationForPartitions.map(metadata -> metadata.get(hivePartition.getPartitionId()));\n \n                 if (!isOfflineDataDebugModeEnabled(session)) {\n                     // verify partition is online\n-                    verifyOnline(tableName, Optional.of(partName), getProtectMode(partition), partition.getParameters());\n+                    verifyOnline(tableName, Optional.of(partitionName), getProtectMode(partition), partition.getParameters());\n \n                     // verify partition is not marked as non-readable\n-                    String partitionNotReadable = partition.getParameters().get(OBJECT_NOT_READABLE);\n-                    if (!isNullOrEmpty(partitionNotReadable)) {\n+                    String reason = partition.getParameters().get(OBJECT_NOT_READABLE);\n+                    if (!isNullOrEmpty(reason)) {\n                         if (!shouldIgnoreUnreadablePartition(session) || !partition.isEligibleToIgnore()) {\n-                            throw new HiveNotReadableException(tableName, Optional.of(partName), partitionNotReadable);\n+                            throw new HiveNotReadableException(tableName, Optional.of(partitionName), reason);\n+                        }\n+                        if (partitionsNotReadable.size() < 3) {\n+                            partitionsNotReadable.putIfAbsent(reason, new HashSet<>(ImmutableSet.of(partitionName)));\n+                            if (partitionsNotReadable.get(reason).size() < 3) {\n+                                partitionsNotReadable.get(reason).add(partitionName);\n+                            }\n+                            else {\n+                                unreadablePartitionsSkipped++;\n+                            }\n+                        }\n+                        else {\n+                            unreadablePartitionsSkipped++;\n+                            reasonsSkipped++;\n                         }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4541964184c36f4bb464a91515b0cd3d11dd1713"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEwMjkzNQ==", "bodyText": "partitionsNotReadable.values().stream().mapToInt(Set::size).sum() should be replaced by unreadablePartitionsSkipped\njust name warningMessage", "url": "https://github.com/prestodb/presto/pull/15338#discussion_r511102935", "createdAt": "2020-10-23T19:24:06Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -475,7 +491,19 @@ public CounterStat getHighMemorySplitSource()\n \n                 results.add(new HivePartitionMetadata(hivePartition, Optional.of(partition), partitionSchemaDifference.build(), encryptionInformation));\n             }\n-\n+            String prestoWarningMessage = format(\"Table '%s' has '%s' out of '%s' partitions unreadable: \", tableName, partitionsNotReadable.values().stream().mapToInt(Set::size).sum(), partitionBatch.size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4541964184c36f4bb464a91515b0cd3d11dd1713"}, "originalPosition": 85}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dcf208ebd26f1699064128f67f4977f2a467e308", "author": {"user": {"login": "Moe82", "name": "Mohamed Shafee"}}, "url": "https://github.com/prestodb/presto/commit/dcf208ebd26f1699064128f67f4977f2a467e308", "committedDate": "2020-10-24T18:54:00Z", "message": "change warning to ignore unreadable partitions to be a digest"}, "afterCommit": {"oid": "8990b6abc31d63ba5a1db52879fcfd220cf6d0ed", "author": {"user": {"login": "Moe82", "name": "Mohamed Shafee"}}, "url": "https://github.com/prestodb/presto/commit/8990b6abc31d63ba5a1db52879fcfd220cf6d0ed", "committedDate": "2020-10-24T18:55:02Z", "message": "change warning to ignore unreadable partitions to be a digest"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4be5ac750c2f91f79266fadfa5ea33247bd05f97", "author": {"user": {"login": "Moe82", "name": "Mohamed Shafee"}}, "url": "https://github.com/prestodb/presto/commit/4be5ac750c2f91f79266fadfa5ea33247bd05f97", "committedDate": "2020-10-24T19:16:11Z", "message": "change warning to ignore unreadable partitions to be a digest"}, "afterCommit": {"oid": "02f4deab72a040a7b32d8afebc976d2fc7718841", "author": {"user": {"login": "Moe82", "name": "Mohamed Shafee"}}, "url": "https://github.com/prestodb/presto/commit/02f4deab72a040a7b32d8afebc976d2fc7718841", "committedDate": "2020-10-24T19:16:34Z", "message": "change warning to ignore unreadable partitions to be a digest"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d0a41e18f607a61d97d8d88ccc63505a17624c79", "author": {"user": {"login": "Moe82", "name": "Mohamed Shafee"}}, "url": "https://github.com/prestodb/presto/commit/d0a41e18f607a61d97d8d88ccc63505a17624c79", "committedDate": "2020-10-24T21:43:46Z", "message": "change warning to ignore unreadable partitions to be a digest"}, "afterCommit": {"oid": "56616a6e3f128ffc391676c0e8e3ed19799d56ec", "author": {"user": {"login": "Moe82", "name": "Mohamed Shafee"}}, "url": "https://github.com/prestodb/presto/commit/56616a6e3f128ffc391676c0e8e3ed19799d56ec", "committedDate": "2020-10-24T21:44:38Z", "message": "change warning to ignore unreadable partitions to be a digest"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2MzA3OTMy", "url": "https://github.com/prestodb/presto/pull/15338#pullrequestreview-516307932", "createdAt": "2020-10-24T21:19:10Z", "commit": {"oid": "02f4deab72a040a7b32d8afebc976d2fc7718841"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNFQyMToxOToxMFrOHn0bcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNFQyMTo0NjoxMlrOHn0kAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTUxNTUwNg==", "bodyText": "To be consistent with the following > 2, these two should be <= 2 right?", "url": "https://github.com/prestodb/presto/pull/15338#discussion_r511515506", "createdAt": "2020-10-24T21:19:10Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -379,27 +382,32 @@ public CounterStat getHighMemorySplitSource()\n                     partitions);\n \n             ImmutableList.Builder<HivePartitionMetadata> results = ImmutableList.builder();\n+            Map<String, Set<String>> partitionsNotReadable = new HashMap<>();\n+            int unreadablePartitionsSkipped = 0;\n             for (HivePartition hivePartition : partitionBatch) {\n                 Partition partition = partitions.get(hivePartition.getPartitionId());\n                 if (partition == null) {\n                     throw new PrestoException(GENERIC_INTERNAL_ERROR, \"Partition not loaded: \" + hivePartition);\n                 }\n-                String partName = makePartName(table.getPartitionColumns(), partition.getValues());\n+                String partitionName = makePartName(table.getPartitionColumns(), partition.getValues());\n                 Optional<EncryptionInformation> encryptionInformation = encryptionInformationForPartitions.map(metadata -> metadata.get(hivePartition.getPartitionId()));\n \n                 if (!isOfflineDataDebugModeEnabled(session)) {\n                     // verify partition is online\n-                    verifyOnline(tableName, Optional.of(partName), getProtectMode(partition), partition.getParameters());\n+                    verifyOnline(tableName, Optional.of(partitionName), getProtectMode(partition), partition.getParameters());\n \n                     // verify partition is not marked as non-readable\n-                    String partitionNotReadable = partition.getParameters().get(OBJECT_NOT_READABLE);\n-                    if (!isNullOrEmpty(partitionNotReadable)) {\n+                    String reason = partition.getParameters().get(OBJECT_NOT_READABLE);\n+                    if (!isNullOrEmpty(reason)) {\n                         if (!shouldIgnoreUnreadablePartition(session) || !partition.isEligibleToIgnore()) {\n-                            throw new HiveNotReadableException(tableName, Optional.of(partName), partitionNotReadable);\n+                            throw new HiveNotReadableException(tableName, Optional.of(partitionName), reason);\n+                        }\n+                        if (partitionsNotReadable.size() < 4) {\n+                            partitionsNotReadable.putIfAbsent(reason, new HashSet<>(ImmutableSet.of(partitionName)));\n+                            if (partitionsNotReadable.get(reason).size() < 4) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02f4deab72a040a7b32d8afebc976d2fc7718841"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTUxNTU1Ng==", "bodyText": "You should update unreadablePartitionsSkipped in the for loop body", "url": "https://github.com/prestodb/presto/pull/15338#discussion_r511515556", "createdAt": "2020-10-24T21:19:54Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -379,27 +382,32 @@ public CounterStat getHighMemorySplitSource()\n                     partitions);\n \n             ImmutableList.Builder<HivePartitionMetadata> results = ImmutableList.builder();\n+            Map<String, Set<String>> partitionsNotReadable = new HashMap<>();\n+            int unreadablePartitionsSkipped = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02f4deab72a040a7b32d8afebc976d2fc7718841"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTUxNTczNA==", "bodyText": "In test testPartitionNotReadable, right below assertEquals(SPLIT_SCHEDULING_CONTEXT.getWarningCollector().getWarnings().size(), 1);,  assert the error message popped out is the one you would expect.", "url": "https://github.com/prestodb/presto/pull/15338#discussion_r511515734", "createdAt": "2020-10-24T21:22:07Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -475,7 +483,20 @@ public CounterStat getHighMemorySplitSource()\n \n                 results.add(new HivePartitionMetadata(hivePartition, Optional.of(partition), partitionSchemaDifference.build(), encryptionInformation));\n             }\n-\n+            String warningMessage = format(\"Table '%s' has '%s' out of '%s' partitions unreadable: \", tableName, unreadablePartitionsSkipped, partitionBatch.size());\n+            for (Entry<String, Set<String>> entry : partitionsNotReadable.entrySet()) {\n+                if (entry.getValue().size() > 2) {\n+                    Iterator it = entry.getValue().iterator();\n+                    warningMessage += \"\\n\" + entry.getKey().toString() + \": \" + it.next() + \", \" + it.next() + \" ...\";\n+                }\n+                else {\n+                    warningMessage += \"\\n\" + entry.getKey().toString() + \": \" + entry.getValue().toString();\n+                }\n+            }\n+            if (partitionsNotReadable.entrySet().size() > 2) {\n+                warningMessage += \"\\n...\";\n+            }\n+            warningCollector.add(new PrestoWarning(PARTITION_NOT_READABLE, warningMessage));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02f4deab72a040a7b32d8afebc976d2fc7718841"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTUxNzY5OQ==", "bodyText": "In test testPartitionNotReadable, right below assertEquals(SPLIT_SCHEDULING_CONTEXT.getWarningCollector().getWarnings().size(), 1);, assert the warning you have is the one you expect", "url": "https://github.com/prestodb/presto/pull/15338#discussion_r511517699", "createdAt": "2020-10-24T21:46:12Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -475,7 +483,23 @@ public CounterStat getHighMemorySplitSource()\n \n                 results.add(new HivePartitionMetadata(hivePartition, Optional.of(partition), partitionSchemaDifference.build(), encryptionInformation));\n             }\n-\n+            StringBuilder warningMessage = new StringBuilder(format(\"Table '%s' has '%s' out of '%s' partitions unreadable: \", tableName, unreadablePartitionsSkipped, partitionBatch.size()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56616a6e3f128ffc391676c0e8e3ed19799d56ec"}, "originalPosition": 77}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2860d3ba04511b58d24a14d31c73c0b03cb88f35", "author": {"user": {"login": "Moe82", "name": "Mohamed Shafee"}}, "url": "https://github.com/prestodb/presto/commit/2860d3ba04511b58d24a14d31c73c0b03cb88f35", "committedDate": "2020-10-24T22:28:13Z", "message": "change warning to ignore unreadable partitions to be a digest"}, "afterCommit": {"oid": "092c8898b5e082124ed4848c6b5cd411544e7c05", "author": {"user": {"login": "Moe82", "name": "Mohamed Shafee"}}, "url": "https://github.com/prestodb/presto/commit/092c8898b5e082124ed4848c6b5cd411544e7c05", "committedDate": "2020-10-24T22:28:50Z", "message": "change warning to ignore unreadable partitions to be a digest"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "27dcb7eef7ff54f254526901de7eb4ea26c73491", "author": {"user": {"login": "Moe82", "name": "Mohamed Shafee"}}, "url": "https://github.com/prestodb/presto/commit/27dcb7eef7ff54f254526901de7eb4ea26c73491", "committedDate": "2020-10-27T03:30:53Z", "message": "added tests to validate the new format of the PrestoWarning message"}, "afterCommit": {"oid": "a6bafa004d6f9436463aa001df16ba6f79f51c01", "author": {"user": {"login": "Moe82", "name": "Mohamed Shafee"}}, "url": "https://github.com/prestodb/presto/commit/a6bafa004d6f9436463aa001df16ba6f79f51c01", "committedDate": "2020-10-27T04:03:45Z", "message": "add tests to validate the new format of the PrestoWarning message generated in HiveSplitManager.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3MzM3MjU0", "url": "https://github.com/prestodb/presto/pull/15338#pullrequestreview-517337254", "createdAt": "2020-10-27T04:17:42Z", "commit": {"oid": "092c8898b5e082124ed4848c6b5cd411544e7c05"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwNDoxNzo0MlrOHoq3TQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwNDoxNzo0MlrOHoq3TQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQwNzM3Mw==", "bodyText": "prior to this if statement, max of 3 reasons in the warningMessage. If 3, delete the last one and append \"...\"\nHacky, but I wanted to avoid the possibility of the code adding 3 reasons plus \"...\" when there is exactly three reasons of unreadability in partitionsNotReadable.", "url": "https://github.com/prestodb/presto/pull/15338#discussion_r512407373", "createdAt": "2020-10-27T04:17:42Z", "author": {"login": "Moe82"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -475,7 +484,23 @@ public CounterStat getHighMemorySplitSource()\n \n                 results.add(new HivePartitionMetadata(hivePartition, Optional.of(partition), partitionSchemaDifference.build(), encryptionInformation));\n             }\n-\n+            StringBuilder warningMessage = new StringBuilder(format(\"Table '%s' has '%s' out of '%s' partitions unreadable: \", tableName, unreadablePartitionsSkipped, partitionBatch.size()));\n+            for (Entry<String, Set<String>> entry : partitionsNotReadable.entrySet()) {\n+                if (entry.getValue().size() > 2) {\n+                    Iterator it = entry.getValue().iterator();\n+                    warningMessage.append(\"\\n\" + entry.getKey().toString() + \": \" + it.next() + \", \" + it.next() + \" ...\");\n+                }\n+                else {\n+                    warningMessage.append(\"\\n\" + entry.getKey().toString() + \": \" + entry.getValue().toString());\n+                }\n+            }\n+            if (partitionsNotReadable.entrySet().size() > 2) {\n+                if (warningMessage.lastIndexOf(\"\\n\") >= 0) {\n+                    warningMessage.delete(warningMessage.lastIndexOf(\"\\n\"), warningMessage.length());\n+                    warningMessage.append(\"\\n...\");\n+                }\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "092c8898b5e082124ed4848c6b5cd411544e7c05"}, "originalPosition": 93}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "06fbe028c296adf82f37416ad6abad2deafa10e6", "author": {"user": {"login": "Moe82", "name": "Mohamed Shafee"}}, "url": "https://github.com/prestodb/presto/commit/06fbe028c296adf82f37416ad6abad2deafa10e6", "committedDate": "2020-10-27T06:39:47Z", "message": "added tests to validate the new format of the PrestoWarning message"}, "afterCommit": {"oid": "cf8fe2eba5be164bbfacb124b270a642274cd174", "author": {"user": {"login": "Moe82", "name": "Mohamed Shafee"}}, "url": "https://github.com/prestodb/presto/commit/cf8fe2eba5be164bbfacb124b270a642274cd174", "committedDate": "2020-10-27T06:46:38Z", "message": "add test to validate new format for PrestoWarning message in HiveSplitManager.java"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cf8fe2eba5be164bbfacb124b270a642274cd174", "author": {"user": {"login": "Moe82", "name": "Mohamed Shafee"}}, "url": "https://github.com/prestodb/presto/commit/cf8fe2eba5be164bbfacb124b270a642274cd174", "committedDate": "2020-10-27T06:46:38Z", "message": "add test to validate new format for PrestoWarning message in HiveSplitManager.java"}, "afterCommit": {"oid": "cb456e9ced79dc759f4fa0a1f87aaae5bb9d015d", "author": {"user": {"login": "Moe82", "name": "Mohamed Shafee"}}, "url": "https://github.com/prestodb/presto/commit/cb456e9ced79dc759f4fa0a1f87aaae5bb9d015d", "committedDate": "2020-10-27T06:49:17Z", "message": "add test to validate new format for PrestoWarning message in HiveSplitManager.java"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6281dca73113327351b82d931cd54c7591e71f7f", "author": {"user": {"login": "Moe82", "name": "Mohamed Shafee"}}, "url": "https://github.com/prestodb/presto/commit/6281dca73113327351b82d931cd54c7591e71f7f", "committedDate": "2020-10-27T06:52:44Z", "message": "add test to validate new format for PrestoWarning message in HiveSplitManager.java"}, "afterCommit": {"oid": "9a0047f9eec5aa71da69526810bcb7b211247c3a", "author": {"user": {"login": "Moe82", "name": "Mohamed Shafee"}}, "url": "https://github.com/prestodb/presto/commit/9a0047f9eec5aa71da69526810bcb7b211247c3a", "committedDate": "2020-10-27T06:53:11Z", "message": "add test to validate new format for PrestoWarning message in HiveSplitManager.java"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fd022e4a4d7422deaf3710c9d8cf4a5f131ca360", "author": {"user": {"login": "Moe82", "name": "Mohamed Shafee"}}, "url": "https://github.com/prestodb/presto/commit/fd022e4a4d7422deaf3710c9d8cf4a5f131ca360", "committedDate": "2020-10-27T15:10:15Z", "message": "update TestHiveClientFileMetastore.java"}, "afterCommit": {"oid": "1a676069f089c5b4773ed49de7e5f0e227f67d20", "author": {"user": {"login": "Moe82", "name": "Mohamed Shafee"}}, "url": "https://github.com/prestodb/presto/commit/1a676069f089c5b4773ed49de7e5f0e227f67d20", "committedDate": "2020-10-27T15:10:40Z", "message": "update TestHiveClientFileMetastore.java"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "81cc17e19c57f1df6d518f31b7200de0d3c793c8", "author": {"user": {"login": "Moe82", "name": "Mohamed Shafee"}}, "url": "https://github.com/prestodb/presto/commit/81cc17e19c57f1df6d518f31b7200de0d3c793c8", "committedDate": "2020-10-27T15:39:16Z", "message": "update TestHiveClientFileMetastore.java"}, "afterCommit": {"oid": "f1943435f8981c9749a32ca41230ebd9ca3cab46", "author": {"user": {"login": "Moe82", "name": "Mohamed Shafee"}}, "url": "https://github.com/prestodb/presto/commit/f1943435f8981c9749a32ca41230ebd9ca3cab46", "committedDate": "2020-10-27T15:39:47Z", "message": "add test to validate new format for PrestoWarning message in HiveSplitManager.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3ODU2Njk1", "url": "https://github.com/prestodb/presto/pull/15338#pullrequestreview-517856695", "createdAt": "2020-10-27T15:45:04Z", "commit": {"oid": "f1943435f8981c9749a32ca41230ebd9ca3cab46"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxNTo0NTowNFrOHpDNpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxNTo0NTowNFrOHpDNpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjgwNjMxMA==", "bodyText": "@highker , how do I get the table name?\ntableName.getTableName() returns:\ntest.tmp_presto_test_temptable_becbe4b8516d4eedbc8f2ec61b9cf4c7\nbut the expected table name is:\ntmp_presto_test_temptable_becbe4b8516d4eedbc8f2ec61b9cf4c7\nI tried to trace, but I'm really not sure where 'test' is dropped.\nedit: Sorry, I see now that I can't access it inside the method. I'll squash the 2 commits for this file if it needs to be merged.\nedit: Is it ok if I modify createDummyPartitionedTable()? I just want to make sure that the case for 3 unreadable partitions is what I expect it to be. Probably is, but I figured it would be good to make sure.", "url": "https://github.com/prestodb/presto/pull/15338#discussion_r512806310", "createdAt": "2020-10-27T15:45:04Z", "author": {"login": "Moe82"}, "path": "presto-hive/src/test/java/com/facebook/presto/hive/TestHiveClientFileMetastore.java", "diffHunk": "@@ -152,6 +152,8 @@ public void testPartitionNotReadable()\n                 splitManager.getSplits(transaction.getTransactionHandle(), session, tableLayout.getHandle(), SPLIT_SCHEDULING_CONTEXT);\n                 assertNotNull(SPLIT_SCHEDULING_CONTEXT.getWarningCollector());\n                 assertEquals(SPLIT_SCHEDULING_CONTEXT.getWarningCollector().getWarnings().size(), 1);\n+                assertEquals(SPLIT_SCHEDULING_CONTEXT.getWarningCollector().getWarnings().get(0).getMessage(), String.format(\"Table '%s' has '1' out of '3' partitions unreadable:\\nTesting Unreadable Partition: [ds=2020-01-03]\", tableName.getTableName()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f1943435f8981c9749a32ca41230ebd9ca3cab46"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "22d025daf5c015efb57523319017742966b53a13", "author": {"user": {"login": "Moe82", "name": "Mohamed Shafee"}}, "url": "https://github.com/prestodb/presto/commit/22d025daf5c015efb57523319017742966b53a13", "committedDate": "2020-10-27T17:33:52Z", "message": "update TestHiveClientFileMetastore.java"}, "afterCommit": {"oid": "64a4910ff5df51fbe813fb5875935cd1cd8842ad", "author": {"user": {"login": "Moe82", "name": "Mohamed Shafee"}}, "url": "https://github.com/prestodb/presto/commit/64a4910ff5df51fbe813fb5875935cd1cd8842ad", "committedDate": "2020-10-27T17:51:15Z", "message": "add test to validate new format for PrestoWarning message in HiveSplitManager.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4MDgyMzM4", "url": "https://github.com/prestodb/presto/pull/15338#pullrequestreview-518082338", "createdAt": "2020-10-27T19:43:11Z", "commit": {"oid": "64a4910ff5df51fbe813fb5875935cd1cd8842ad"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxOTo0MzoxMVrOHpN2pQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxOTo0NDoxM1rOHpN5Qg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk4MDY0NQ==", "bodyText": "We really don't need to be such complicated. Also, there are many bugs in this code block like (1) this should be guarded by an if, (2) .toString() is redundant, (3) entry.getValue().toString() is going to get you the memory pointer, etc. Let's simplify this logic:\nif (unreadablePartitionsSkipped > 0) {\n    StringBuilder warningMessage = new StringBuilder(format(\"Table '%s' has '%s' out of '%s' partitions unreadable: \", tableName, unreadablePartitionsSkipped, partitionBatch.size()));\n    for (Entry<String, Set<String>> entry : partitionsNotReadable.entrySet()) {\n        warningMessage.append(join(\", \", entry.getValue()))\n                .append(\"... are due to \")\n                .append(entry.getKey())\n                .append(\". \");\n    }\n    warningCollector.add(new PrestoWarning(PARTITION_NOT_READABLE, warningMessage.toString()));\n}", "url": "https://github.com/prestodb/presto/pull/15338#discussion_r512980645", "createdAt": "2020-10-27T19:43:11Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -475,7 +484,23 @@ public CounterStat getHighMemorySplitSource()\n \n                 results.add(new HivePartitionMetadata(hivePartition, Optional.of(partition), partitionSchemaDifference.build(), encryptionInformation));\n             }\n-\n+            StringBuilder warningMessage = new StringBuilder(format(\"Table '%s' has '%s' out of '%s' partitions unreadable: \", tableName, unreadablePartitionsSkipped, partitionBatch.size()));\n+            for (Entry<String, Set<String>> entry : partitionsNotReadable.entrySet()) {\n+                if (entry.getValue().size() > 2) {\n+                    Iterator it = entry.getValue().iterator();\n+                    warningMessage.append(\"\\n\" + entry.getKey().toString() + \": \" + it.next() + \", \" + it.next() + \" ...\");\n+                }\n+                else {\n+                    warningMessage.append(\"\\n\" + entry.getKey().toString() + \": \" + entry.getValue().toString());\n+                }\n+            }\n+            if (partitionsNotReadable.entrySet().size() > 2) {\n+                if (warningMessage.lastIndexOf(\"\\n\") >= 0) {\n+                    warningMessage.delete(warningMessage.lastIndexOf(\"\\n\"), warningMessage.length());\n+                    warningMessage.append(\"\\n...\");\n+                }\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "64a4910ff5df51fbe813fb5875935cd1cd8842ad"}, "originalPosition": 93}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk4MTMxNA==", "bodyText": "Some single quotes are not needed:\n\"Table '%s' has %s out of %s partitions unreadable: \"", "url": "https://github.com/prestodb/presto/pull/15338#discussion_r512981314", "createdAt": "2020-10-27T19:44:13Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitManager.java", "diffHunk": "@@ -475,7 +484,23 @@ public CounterStat getHighMemorySplitSource()\n \n                 results.add(new HivePartitionMetadata(hivePartition, Optional.of(partition), partitionSchemaDifference.build(), encryptionInformation));\n             }\n-\n+            StringBuilder warningMessage = new StringBuilder(format(\"Table '%s' has '%s' out of '%s' partitions unreadable: \", tableName, unreadablePartitionsSkipped, partitionBatch.size()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "64a4910ff5df51fbe813fb5875935cd1cd8842ad"}, "originalPosition": 78}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2bb92c49b189fcf6ee8c12b5e8b5e3dad0841c7f", "author": {"user": {"login": "Moe82", "name": "Mohamed Shafee"}}, "url": "https://github.com/prestodb/presto/commit/2bb92c49b189fcf6ee8c12b5e8b5e3dad0841c7f", "committedDate": "2020-10-27T19:44:02Z", "message": "update TestHiveClientFileMetastore.java"}, "afterCommit": {"oid": "4a1f2abae3f009ba825d1be7e9f2faa7e7b5b6df", "author": {"user": {"login": "Moe82", "name": "Mohamed Shafee"}}, "url": "https://github.com/prestodb/presto/commit/4a1f2abae3f009ba825d1be7e9f2faa7e7b5b6df", "committedDate": "2020-10-27T19:44:28Z", "message": "update TestHiveClientFileMetastore.java"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c3bed98077239967ae261de0ba81339028f19a3f", "author": {"user": {"login": "Moe82", "name": "Mohamed Shafee"}}, "url": "https://github.com/prestodb/presto/commit/c3bed98077239967ae261de0ba81339028f19a3f", "committedDate": "2020-10-27T20:51:04Z", "message": "change warning to ignore unreadable partitions to be a digest"}, "afterCommit": {"oid": "18b4d705df6ca0295a4de068fdb18521d905b851", "author": {"user": {"login": "Moe82", "name": "Mohamed Shafee"}}, "url": "https://github.com/prestodb/presto/commit/18b4d705df6ca0295a4de068fdb18521d905b851", "committedDate": "2020-10-27T20:51:45Z", "message": "change warning to ignore unreadable partitions to be a digest"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dfdaff5b7322cbd9a9132bd2b5d1debb346fdbfa", "author": {"user": {"login": "Moe82", "name": "Mohamed Shafee"}}, "url": "https://github.com/prestodb/presto/commit/dfdaff5b7322cbd9a9132bd2b5d1debb346fdbfa", "committedDate": "2020-10-27T21:28:35Z", "message": "update TestHiveClientFileMetastore.java"}, "afterCommit": {"oid": "c6cc792499a5a7c2c99486156fc7db723e840554", "author": {"user": {"login": "Moe82", "name": "Mohamed Shafee"}}, "url": "https://github.com/prestodb/presto/commit/c6cc792499a5a7c2c99486156fc7db723e840554", "committedDate": "2020-10-27T21:28:59Z", "message": "change warning to ignore unreadable partitions to be a digest"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "200daaa40a67730d7bb5a25ac814716ff6bfde05", "author": {"user": {"login": "Moe82", "name": "Mohamed Shafee"}}, "url": "https://github.com/prestodb/presto/commit/200daaa40a67730d7bb5a25ac814716ff6bfde05", "committedDate": "2020-10-27T21:47:06Z", "message": "change warning to ignore unreadable partitions to be a digest"}, "afterCommit": {"oid": "187cda3368af9ca3dfd2d570a2cb748e483a23c9", "author": {"user": {"login": "Moe82", "name": "Mohamed Shafee"}}, "url": "https://github.com/prestodb/presto/commit/187cda3368af9ca3dfd2d570a2cb748e483a23c9", "committedDate": "2020-10-27T21:47:27Z", "message": "change warning to ignore unreadable partitions to be a digest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ac5f42e8654bbc52da0f8c1abd7fad348419c7e", "author": {"user": {"login": "Moe82", "name": "Mohamed Shafee"}}, "url": "https://github.com/prestodb/presto/commit/5ac5f42e8654bbc52da0f8c1abd7fad348419c7e", "committedDate": "2020-10-28T01:26:33Z", "message": "change warning to ignore unreadable partitions to be a digest"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "187cda3368af9ca3dfd2d570a2cb748e483a23c9", "author": {"user": {"login": "Moe82", "name": "Mohamed Shafee"}}, "url": "https://github.com/prestodb/presto/commit/187cda3368af9ca3dfd2d570a2cb748e483a23c9", "committedDate": "2020-10-27T21:47:27Z", "message": "change warning to ignore unreadable partitions to be a digest"}, "afterCommit": {"oid": "5ac5f42e8654bbc52da0f8c1abd7fad348419c7e", "author": {"user": {"login": "Moe82", "name": "Mohamed Shafee"}}, "url": "https://github.com/prestodb/presto/commit/5ac5f42e8654bbc52da0f8c1abd7fad348419c7e", "committedDate": "2020-10-28T01:26:33Z", "message": "change warning to ignore unreadable partitions to be a digest"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4MzA4ODUw", "url": "https://github.com/prestodb/presto/pull/15338#pullrequestreview-518308850", "createdAt": "2020-10-28T04:02:58Z", "commit": {"oid": "5ac5f42e8654bbc52da0f8c1abd7fad348419c7e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4974, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}