{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk4OTY3NTc1", "number": 14341, "reviewThreads": {"totalCount": 28, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwMDozMjozOFrODvylPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwNzo0NzowN1rODwStwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNDM4Mzk5OnYy", "diffSide": "RIGHT", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPushdownUtils.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwMDozMjozOFrOGCa8Ug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwMDo1NzowOFrOGCbV6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5MTc2Mg==", "bodyText": "Will this message show the agg mask too or reflect that we have a distinct operation ?", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405191762", "createdAt": "2020-04-08T00:32:38Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPushdownUtils.java", "diffHunk": "@@ -147,10 +154,25 @@ public ExpressionType getExpressionType()\n             if (agg != null) {\n                 if (agg.getFilter().isPresent()\n                         || agg.isDistinct()\n-                        || agg.getOrderBy().isPresent()\n-                        || agg.getMask().isPresent()) {\n+                        || agg.getOrderBy().isPresent()) {\n+                    throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), \"Unsupported aggregation node \" + aggregationNode);\n+                }\n+                if (agg.getMask().isPresent()) {\n+                    /**\n+                     * This if-block handles the case of pushing down distinct count as one of the aggregation expression along with other aggregation functions.\n+                     * E.g. `SELECT count(distinct COL_A), sum(COL_B) FROM (SELECT COL_A, COL_B FROM myTable)` to Pinot as `SELECT distinctCount(COL_A), sum(COL_B) FROM myTable`\n+                     *\n+                     */\n+                    if (agg.getCall().getDisplayName().equalsIgnoreCase(COUNT_FUNCTION_NAME) && agg.getMask().get().getName().equalsIgnoreCase(agg.getArguments().get(0) + DISTINCT_MASK)) {\n+                        nodeBuilder.add(new AggregationFunctionColumnNode(outputColumn, new CallExpression(DISTINCT_COUNT_FUNCTION_NAME, agg.getCall().getFunctionHandle(), agg.getCall().getType(), agg.getCall().getArguments())));\n+                        continue;\n+                    }\n+                    // Pinot doesn't support push down aggregation functions other than count on top of distinct function.\n                     throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), \"Unsupported aggregation node \" + aggregationNode);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05770437addd3244f49dc7061848cdf19b886459"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5ODMxNQ==", "bodyText": "Both. We only handle distinct mask + count function, which means it will throw exception on  sum(distinct a) or count with other masks", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405198315", "createdAt": "2020-04-08T00:57:08Z", "author": {"login": "xiangfu0"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPushdownUtils.java", "diffHunk": "@@ -147,10 +154,25 @@ public ExpressionType getExpressionType()\n             if (agg != null) {\n                 if (agg.getFilter().isPresent()\n                         || agg.isDistinct()\n-                        || agg.getOrderBy().isPresent()\n-                        || agg.getMask().isPresent()) {\n+                        || agg.getOrderBy().isPresent()) {\n+                    throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), \"Unsupported aggregation node \" + aggregationNode);\n+                }\n+                if (agg.getMask().isPresent()) {\n+                    /**\n+                     * This if-block handles the case of pushing down distinct count as one of the aggregation expression along with other aggregation functions.\n+                     * E.g. `SELECT count(distinct COL_A), sum(COL_B) FROM (SELECT COL_A, COL_B FROM myTable)` to Pinot as `SELECT distinctCount(COL_A), sum(COL_B) FROM myTable`\n+                     *\n+                     */\n+                    if (agg.getCall().getDisplayName().equalsIgnoreCase(COUNT_FUNCTION_NAME) && agg.getMask().get().getName().equalsIgnoreCase(agg.getArguments().get(0) + DISTINCT_MASK)) {\n+                        nodeBuilder.add(new AggregationFunctionColumnNode(outputColumn, new CallExpression(DISTINCT_COUNT_FUNCTION_NAME, agg.getCall().getFunctionHandle(), agg.getCall().getType(), agg.getCall().getArguments())));\n+                        continue;\n+                    }\n+                    // Pinot doesn't support push down aggregation functions other than count on top of distinct function.\n                     throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), \"Unsupported aggregation node \" + aggregationNode);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5MTc2Mg=="}, "originalCommit": {"oid": "05770437addd3244f49dc7061848cdf19b886459"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNDM4NzE1OnYy", "diffSide": "RIGHT", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPushdownUtils.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwMDozNDoxNFrOGCa-Hw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwMDo1ODowMFrOGCbW4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5MjIyMw==", "bodyText": "I am wondering if this comment can be simplified to saying that: This block handles the case when a distinct aggregation is present in addition to another aggregation function. And the example need not contain a subquery ?", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405192223", "createdAt": "2020-04-08T00:34:14Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPushdownUtils.java", "diffHunk": "@@ -147,10 +154,25 @@ public ExpressionType getExpressionType()\n             if (agg != null) {\n                 if (agg.getFilter().isPresent()\n                         || agg.isDistinct()\n-                        || agg.getOrderBy().isPresent()\n-                        || agg.getMask().isPresent()) {\n+                        || agg.getOrderBy().isPresent()) {\n+                    throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), \"Unsupported aggregation node \" + aggregationNode);\n+                }\n+                if (agg.getMask().isPresent()) {\n+                    /**", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05770437addd3244f49dc7061848cdf19b886459"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5ODU2MQ==", "bodyText": "will do", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405198561", "createdAt": "2020-04-08T00:58:00Z", "author": {"login": "xiangfu0"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPushdownUtils.java", "diffHunk": "@@ -147,10 +154,25 @@ public ExpressionType getExpressionType()\n             if (agg != null) {\n                 if (agg.getFilter().isPresent()\n                         || agg.isDistinct()\n-                        || agg.getOrderBy().isPresent()\n-                        || agg.getMask().isPresent()) {\n+                        || agg.getOrderBy().isPresent()) {\n+                    throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), \"Unsupported aggregation node \" + aggregationNode);\n+                }\n+                if (agg.getMask().isPresent()) {\n+                    /**", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5MjIyMw=="}, "originalCommit": {"oid": "05770437addd3244f49dc7061848cdf19b886459"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNDM5MDAyOnYy", "diffSide": "RIGHT", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPushdownUtils.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwMDozNjowOFrOGCa_1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwMDo1Nzo1M1rOGCbWzA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5MjY2Mw==", "bodyText": "remove commented code ?", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405192663", "createdAt": "2020-04-08T00:36:08Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPushdownUtils.java", "diffHunk": "@@ -163,6 +185,56 @@ public ExpressionType getExpressionType()\n         return nodeBuilder.build();\n     }\n \n+    /**\n+     * Try to push down query like: `SELECT count(distinct $COLUMN) FROM myTable` to Pinot as `SELECT distinctCount($COLUMN) FROM myTable`.\n+     * This function only handles the case of an AggregationNode (COUNT on $COLUMN) on top of an AggregationNode(of non-aggregate on $COLUMN).\n+     *\n+     * @param nodeBuilder\n+     * @param aggregationNode\n+     * @param outputColumn\n+     * @param aggregation\n+     * @return true if push down successfully otherwise false.\n+     */\n+    private static boolean handlePushDownSingleDistinctCount(ImmutableList.Builder<AggregationColumnNode> nodeBuilder, AggregationNode aggregationNode, VariableReferenceExpression outputColumn, AggregationNode.Aggregation aggregation)\n+    {\n+        if (aggregation.getCall().getDisplayName().equalsIgnoreCase(COUNT_FUNCTION_NAME)) {\n+            List<RowExpression> arguments = aggregation.getCall().getArguments();\n+            if (arguments.size() == 1) {\n+                RowExpression aggregationArgument = arguments.get(0);\n+                // Handle the case of Count Aggregation on top of a Non-Agg GroupBy Aggregation.\n+                if (aggregationNode.getSource() instanceof AggregationNode) {\n+                    AggregationNode sourceAggregationNode = (AggregationNode) aggregationNode.getSource();\n+                    Set<String> sourceAggregationGroupSet = getGroupKeys(sourceAggregationNode.getGroupingKeys());\n+                    Set<String> aggregationGroupSet = getGroupKeys(aggregationNode.getGroupingKeys());\n+                    aggregationGroupSet.add(aggregationArgument.toString());\n+                    if (sourceAggregationGroupSet.containsAll(aggregationGroupSet) && aggregationGroupSet.containsAll(sourceAggregationGroupSet)) {\n+                        //(sourceAggregationNode.getGroupingKeys().containsAll(aggregationNode.getGroupingKeys()))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05770437addd3244f49dc7061848cdf19b886459"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5ODU0MA==", "bodyText": "will do", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405198540", "createdAt": "2020-04-08T00:57:53Z", "author": {"login": "xiangfu0"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPushdownUtils.java", "diffHunk": "@@ -163,6 +185,56 @@ public ExpressionType getExpressionType()\n         return nodeBuilder.build();\n     }\n \n+    /**\n+     * Try to push down query like: `SELECT count(distinct $COLUMN) FROM myTable` to Pinot as `SELECT distinctCount($COLUMN) FROM myTable`.\n+     * This function only handles the case of an AggregationNode (COUNT on $COLUMN) on top of an AggregationNode(of non-aggregate on $COLUMN).\n+     *\n+     * @param nodeBuilder\n+     * @param aggregationNode\n+     * @param outputColumn\n+     * @param aggregation\n+     * @return true if push down successfully otherwise false.\n+     */\n+    private static boolean handlePushDownSingleDistinctCount(ImmutableList.Builder<AggregationColumnNode> nodeBuilder, AggregationNode aggregationNode, VariableReferenceExpression outputColumn, AggregationNode.Aggregation aggregation)\n+    {\n+        if (aggregation.getCall().getDisplayName().equalsIgnoreCase(COUNT_FUNCTION_NAME)) {\n+            List<RowExpression> arguments = aggregation.getCall().getArguments();\n+            if (arguments.size() == 1) {\n+                RowExpression aggregationArgument = arguments.get(0);\n+                // Handle the case of Count Aggregation on top of a Non-Agg GroupBy Aggregation.\n+                if (aggregationNode.getSource() instanceof AggregationNode) {\n+                    AggregationNode sourceAggregationNode = (AggregationNode) aggregationNode.getSource();\n+                    Set<String> sourceAggregationGroupSet = getGroupKeys(sourceAggregationNode.getGroupingKeys());\n+                    Set<String> aggregationGroupSet = getGroupKeys(aggregationNode.getGroupingKeys());\n+                    aggregationGroupSet.add(aggregationArgument.toString());\n+                    if (sourceAggregationGroupSet.containsAll(aggregationGroupSet) && aggregationGroupSet.containsAll(sourceAggregationGroupSet)) {\n+                        //(sourceAggregationNode.getGroupingKeys().containsAll(aggregationNode.getGroupingKeys()))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5MjY2Mw=="}, "originalCommit": {"oid": "05770437addd3244f49dc7061848cdf19b886459"}, "originalPosition": 86}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNDM5MTIwOnYy", "diffSide": "RIGHT", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPushdownUtils.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwMDozNjo1MlrOGCbAjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwMToyNzo0MFrOGCb1bA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5Mjg0NQ==", "bodyText": "Why is the return type unconditionally a BIGINT ?", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405192845", "createdAt": "2020-04-08T00:36:52Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPushdownUtils.java", "diffHunk": "@@ -163,6 +185,56 @@ public ExpressionType getExpressionType()\n         return nodeBuilder.build();\n     }\n \n+    /**\n+     * Try to push down query like: `SELECT count(distinct $COLUMN) FROM myTable` to Pinot as `SELECT distinctCount($COLUMN) FROM myTable`.\n+     * This function only handles the case of an AggregationNode (COUNT on $COLUMN) on top of an AggregationNode(of non-aggregate on $COLUMN).\n+     *\n+     * @param nodeBuilder\n+     * @param aggregationNode\n+     * @param outputColumn\n+     * @param aggregation\n+     * @return true if push down successfully otherwise false.\n+     */\n+    private static boolean handlePushDownSingleDistinctCount(ImmutableList.Builder<AggregationColumnNode> nodeBuilder, AggregationNode aggregationNode, VariableReferenceExpression outputColumn, AggregationNode.Aggregation aggregation)\n+    {\n+        if (aggregation.getCall().getDisplayName().equalsIgnoreCase(COUNT_FUNCTION_NAME)) {\n+            List<RowExpression> arguments = aggregation.getCall().getArguments();\n+            if (arguments.size() == 1) {\n+                RowExpression aggregationArgument = arguments.get(0);\n+                // Handle the case of Count Aggregation on top of a Non-Agg GroupBy Aggregation.\n+                if (aggregationNode.getSource() instanceof AggregationNode) {\n+                    AggregationNode sourceAggregationNode = (AggregationNode) aggregationNode.getSource();\n+                    Set<String> sourceAggregationGroupSet = getGroupKeys(sourceAggregationNode.getGroupingKeys());\n+                    Set<String> aggregationGroupSet = getGroupKeys(aggregationNode.getGroupingKeys());\n+                    aggregationGroupSet.add(aggregationArgument.toString());\n+                    if (sourceAggregationGroupSet.containsAll(aggregationGroupSet) && aggregationGroupSet.containsAll(sourceAggregationGroupSet)) {\n+                        //(sourceAggregationNode.getGroupingKeys().containsAll(aggregationNode.getGroupingKeys()))\n+                        //aggregationArgument.equalsIgnoreCase(sourceAggregationNode.getGroupingKeys().get(0).getName()))\n+                        nodeBuilder.add(\n+                                new AggregationFunctionColumnNode(\n+                                        outputColumn,\n+                                        new CallExpression(\n+                                                DISTINCT_COUNT_FUNCTION_NAME,\n+                                                aggregation.getFunctionHandle(),\n+                                                BigintType.BIGINT,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05770437addd3244f49dc7061848cdf19b886459"}, "originalPosition": 94}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5ODY0NQ==", "bodyText": "cause Pinot always returns a LONG value for this", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405198645", "createdAt": "2020-04-08T00:58:23Z", "author": {"login": "xiangfu0"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPushdownUtils.java", "diffHunk": "@@ -163,6 +185,56 @@ public ExpressionType getExpressionType()\n         return nodeBuilder.build();\n     }\n \n+    /**\n+     * Try to push down query like: `SELECT count(distinct $COLUMN) FROM myTable` to Pinot as `SELECT distinctCount($COLUMN) FROM myTable`.\n+     * This function only handles the case of an AggregationNode (COUNT on $COLUMN) on top of an AggregationNode(of non-aggregate on $COLUMN).\n+     *\n+     * @param nodeBuilder\n+     * @param aggregationNode\n+     * @param outputColumn\n+     * @param aggregation\n+     * @return true if push down successfully otherwise false.\n+     */\n+    private static boolean handlePushDownSingleDistinctCount(ImmutableList.Builder<AggregationColumnNode> nodeBuilder, AggregationNode aggregationNode, VariableReferenceExpression outputColumn, AggregationNode.Aggregation aggregation)\n+    {\n+        if (aggregation.getCall().getDisplayName().equalsIgnoreCase(COUNT_FUNCTION_NAME)) {\n+            List<RowExpression> arguments = aggregation.getCall().getArguments();\n+            if (arguments.size() == 1) {\n+                RowExpression aggregationArgument = arguments.get(0);\n+                // Handle the case of Count Aggregation on top of a Non-Agg GroupBy Aggregation.\n+                if (aggregationNode.getSource() instanceof AggregationNode) {\n+                    AggregationNode sourceAggregationNode = (AggregationNode) aggregationNode.getSource();\n+                    Set<String> sourceAggregationGroupSet = getGroupKeys(sourceAggregationNode.getGroupingKeys());\n+                    Set<String> aggregationGroupSet = getGroupKeys(aggregationNode.getGroupingKeys());\n+                    aggregationGroupSet.add(aggregationArgument.toString());\n+                    if (sourceAggregationGroupSet.containsAll(aggregationGroupSet) && aggregationGroupSet.containsAll(sourceAggregationGroupSet)) {\n+                        //(sourceAggregationNode.getGroupingKeys().containsAll(aggregationNode.getGroupingKeys()))\n+                        //aggregationArgument.equalsIgnoreCase(sourceAggregationNode.getGroupingKeys().get(0).getName()))\n+                        nodeBuilder.add(\n+                                new AggregationFunctionColumnNode(\n+                                        outputColumn,\n+                                        new CallExpression(\n+                                                DISTINCT_COUNT_FUNCTION_NAME,\n+                                                aggregation.getFunctionHandle(),\n+                                                BigintType.BIGINT,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5Mjg0NQ=="}, "originalCommit": {"oid": "05770437addd3244f49dc7061848cdf19b886459"}, "originalPosition": 94}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIwMDQwMQ==", "bodyText": "Hmm. I wonder if the return type should match the return type expected in the presto plan ? Perhaps we should only push down if the return type is a long ?\nI can't think of count-distinct returning anything other than a Long in presto, but just in case.", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405200401", "createdAt": "2020-04-08T01:04:59Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPushdownUtils.java", "diffHunk": "@@ -163,6 +185,56 @@ public ExpressionType getExpressionType()\n         return nodeBuilder.build();\n     }\n \n+    /**\n+     * Try to push down query like: `SELECT count(distinct $COLUMN) FROM myTable` to Pinot as `SELECT distinctCount($COLUMN) FROM myTable`.\n+     * This function only handles the case of an AggregationNode (COUNT on $COLUMN) on top of an AggregationNode(of non-aggregate on $COLUMN).\n+     *\n+     * @param nodeBuilder\n+     * @param aggregationNode\n+     * @param outputColumn\n+     * @param aggregation\n+     * @return true if push down successfully otherwise false.\n+     */\n+    private static boolean handlePushDownSingleDistinctCount(ImmutableList.Builder<AggregationColumnNode> nodeBuilder, AggregationNode aggregationNode, VariableReferenceExpression outputColumn, AggregationNode.Aggregation aggregation)\n+    {\n+        if (aggregation.getCall().getDisplayName().equalsIgnoreCase(COUNT_FUNCTION_NAME)) {\n+            List<RowExpression> arguments = aggregation.getCall().getArguments();\n+            if (arguments.size() == 1) {\n+                RowExpression aggregationArgument = arguments.get(0);\n+                // Handle the case of Count Aggregation on top of a Non-Agg GroupBy Aggregation.\n+                if (aggregationNode.getSource() instanceof AggregationNode) {\n+                    AggregationNode sourceAggregationNode = (AggregationNode) aggregationNode.getSource();\n+                    Set<String> sourceAggregationGroupSet = getGroupKeys(sourceAggregationNode.getGroupingKeys());\n+                    Set<String> aggregationGroupSet = getGroupKeys(aggregationNode.getGroupingKeys());\n+                    aggregationGroupSet.add(aggregationArgument.toString());\n+                    if (sourceAggregationGroupSet.containsAll(aggregationGroupSet) && aggregationGroupSet.containsAll(sourceAggregationGroupSet)) {\n+                        //(sourceAggregationNode.getGroupingKeys().containsAll(aggregationNode.getGroupingKeys()))\n+                        //aggregationArgument.equalsIgnoreCase(sourceAggregationNode.getGroupingKeys().get(0).getName()))\n+                        nodeBuilder.add(\n+                                new AggregationFunctionColumnNode(\n+                                        outputColumn,\n+                                        new CallExpression(\n+                                                DISTINCT_COUNT_FUNCTION_NAME,\n+                                                aggregation.getFunctionHandle(),\n+                                                BigintType.BIGINT,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5Mjg0NQ=="}, "originalCommit": {"oid": "05770437addd3244f49dc7061848cdf19b886459"}, "originalPosition": 94}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIwNDM0OQ==", "bodyText": "will add the check.", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405204349", "createdAt": "2020-04-08T01:20:04Z", "author": {"login": "xiangfu0"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPushdownUtils.java", "diffHunk": "@@ -163,6 +185,56 @@ public ExpressionType getExpressionType()\n         return nodeBuilder.build();\n     }\n \n+    /**\n+     * Try to push down query like: `SELECT count(distinct $COLUMN) FROM myTable` to Pinot as `SELECT distinctCount($COLUMN) FROM myTable`.\n+     * This function only handles the case of an AggregationNode (COUNT on $COLUMN) on top of an AggregationNode(of non-aggregate on $COLUMN).\n+     *\n+     * @param nodeBuilder\n+     * @param aggregationNode\n+     * @param outputColumn\n+     * @param aggregation\n+     * @return true if push down successfully otherwise false.\n+     */\n+    private static boolean handlePushDownSingleDistinctCount(ImmutableList.Builder<AggregationColumnNode> nodeBuilder, AggregationNode aggregationNode, VariableReferenceExpression outputColumn, AggregationNode.Aggregation aggregation)\n+    {\n+        if (aggregation.getCall().getDisplayName().equalsIgnoreCase(COUNT_FUNCTION_NAME)) {\n+            List<RowExpression> arguments = aggregation.getCall().getArguments();\n+            if (arguments.size() == 1) {\n+                RowExpression aggregationArgument = arguments.get(0);\n+                // Handle the case of Count Aggregation on top of a Non-Agg GroupBy Aggregation.\n+                if (aggregationNode.getSource() instanceof AggregationNode) {\n+                    AggregationNode sourceAggregationNode = (AggregationNode) aggregationNode.getSource();\n+                    Set<String> sourceAggregationGroupSet = getGroupKeys(sourceAggregationNode.getGroupingKeys());\n+                    Set<String> aggregationGroupSet = getGroupKeys(aggregationNode.getGroupingKeys());\n+                    aggregationGroupSet.add(aggregationArgument.toString());\n+                    if (sourceAggregationGroupSet.containsAll(aggregationGroupSet) && aggregationGroupSet.containsAll(sourceAggregationGroupSet)) {\n+                        //(sourceAggregationNode.getGroupingKeys().containsAll(aggregationNode.getGroupingKeys()))\n+                        //aggregationArgument.equalsIgnoreCase(sourceAggregationNode.getGroupingKeys().get(0).getName()))\n+                        nodeBuilder.add(\n+                                new AggregationFunctionColumnNode(\n+                                        outputColumn,\n+                                        new CallExpression(\n+                                                DISTINCT_COUNT_FUNCTION_NAME,\n+                                                aggregation.getFunctionHandle(),\n+                                                BigintType.BIGINT,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5Mjg0NQ=="}, "originalCommit": {"oid": "05770437addd3244f49dc7061848cdf19b886459"}, "originalPosition": 94}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIwNjM4MA==", "bodyText": "I will passing the original type from the aggregation call and let PlanType to translate the return value.", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405206380", "createdAt": "2020-04-08T01:27:40Z", "author": {"login": "xiangfu0"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPushdownUtils.java", "diffHunk": "@@ -163,6 +185,56 @@ public ExpressionType getExpressionType()\n         return nodeBuilder.build();\n     }\n \n+    /**\n+     * Try to push down query like: `SELECT count(distinct $COLUMN) FROM myTable` to Pinot as `SELECT distinctCount($COLUMN) FROM myTable`.\n+     * This function only handles the case of an AggregationNode (COUNT on $COLUMN) on top of an AggregationNode(of non-aggregate on $COLUMN).\n+     *\n+     * @param nodeBuilder\n+     * @param aggregationNode\n+     * @param outputColumn\n+     * @param aggregation\n+     * @return true if push down successfully otherwise false.\n+     */\n+    private static boolean handlePushDownSingleDistinctCount(ImmutableList.Builder<AggregationColumnNode> nodeBuilder, AggregationNode aggregationNode, VariableReferenceExpression outputColumn, AggregationNode.Aggregation aggregation)\n+    {\n+        if (aggregation.getCall().getDisplayName().equalsIgnoreCase(COUNT_FUNCTION_NAME)) {\n+            List<RowExpression> arguments = aggregation.getCall().getArguments();\n+            if (arguments.size() == 1) {\n+                RowExpression aggregationArgument = arguments.get(0);\n+                // Handle the case of Count Aggregation on top of a Non-Agg GroupBy Aggregation.\n+                if (aggregationNode.getSource() instanceof AggregationNode) {\n+                    AggregationNode sourceAggregationNode = (AggregationNode) aggregationNode.getSource();\n+                    Set<String> sourceAggregationGroupSet = getGroupKeys(sourceAggregationNode.getGroupingKeys());\n+                    Set<String> aggregationGroupSet = getGroupKeys(aggregationNode.getGroupingKeys());\n+                    aggregationGroupSet.add(aggregationArgument.toString());\n+                    if (sourceAggregationGroupSet.containsAll(aggregationGroupSet) && aggregationGroupSet.containsAll(sourceAggregationGroupSet)) {\n+                        //(sourceAggregationNode.getGroupingKeys().containsAll(aggregationNode.getGroupingKeys()))\n+                        //aggregationArgument.equalsIgnoreCase(sourceAggregationNode.getGroupingKeys().get(0).getName()))\n+                        nodeBuilder.add(\n+                                new AggregationFunctionColumnNode(\n+                                        outputColumn,\n+                                        new CallExpression(\n+                                                DISTINCT_COUNT_FUNCTION_NAME,\n+                                                aggregation.getFunctionHandle(),\n+                                                BigintType.BIGINT,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5Mjg0NQ=="}, "originalCommit": {"oid": "05770437addd3244f49dc7061848cdf19b886459"}, "originalPosition": 94}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNDM5MjQ0OnYy", "diffSide": "RIGHT", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPushdownUtils.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwMDozNzo0MlrOGCbBZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwMTowMDo1MFrOGCbZ1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5MzA2MA==", "bodyText": "Seems like a helpful helper function. Can it be used elsewhere too ?", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405193060", "createdAt": "2020-04-08T00:37:42Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPushdownUtils.java", "diffHunk": "@@ -163,6 +185,56 @@ public ExpressionType getExpressionType()\n         return nodeBuilder.build();\n     }\n \n+    /**\n+     * Try to push down query like: `SELECT count(distinct $COLUMN) FROM myTable` to Pinot as `SELECT distinctCount($COLUMN) FROM myTable`.\n+     * This function only handles the case of an AggregationNode (COUNT on $COLUMN) on top of an AggregationNode(of non-aggregate on $COLUMN).\n+     *\n+     * @param nodeBuilder\n+     * @param aggregationNode\n+     * @param outputColumn\n+     * @param aggregation\n+     * @return true if push down successfully otherwise false.\n+     */\n+    private static boolean handlePushDownSingleDistinctCount(ImmutableList.Builder<AggregationColumnNode> nodeBuilder, AggregationNode aggregationNode, VariableReferenceExpression outputColumn, AggregationNode.Aggregation aggregation)\n+    {\n+        if (aggregation.getCall().getDisplayName().equalsIgnoreCase(COUNT_FUNCTION_NAME)) {\n+            List<RowExpression> arguments = aggregation.getCall().getArguments();\n+            if (arguments.size() == 1) {\n+                RowExpression aggregationArgument = arguments.get(0);\n+                // Handle the case of Count Aggregation on top of a Non-Agg GroupBy Aggregation.\n+                if (aggregationNode.getSource() instanceof AggregationNode) {\n+                    AggregationNode sourceAggregationNode = (AggregationNode) aggregationNode.getSource();\n+                    Set<String> sourceAggregationGroupSet = getGroupKeys(sourceAggregationNode.getGroupingKeys());\n+                    Set<String> aggregationGroupSet = getGroupKeys(aggregationNode.getGroupingKeys());\n+                    aggregationGroupSet.add(aggregationArgument.toString());\n+                    if (sourceAggregationGroupSet.containsAll(aggregationGroupSet) && aggregationGroupSet.containsAll(sourceAggregationGroupSet)) {\n+                        //(sourceAggregationNode.getGroupingKeys().containsAll(aggregationNode.getGroupingKeys()))\n+                        //aggregationArgument.equalsIgnoreCase(sourceAggregationNode.getGroupingKeys().get(0).getName()))\n+                        nodeBuilder.add(\n+                                new AggregationFunctionColumnNode(\n+                                        outputColumn,\n+                                        new CallExpression(\n+                                                DISTINCT_COUNT_FUNCTION_NAME,\n+                                                aggregation.getFunctionHandle(),\n+                                                BigintType.BIGINT,\n+                                                ImmutableList.of(aggregationArgument))));\n+                        return true;\n+                    }\n+                }\n+            }\n+        }\n+        return false;\n+    }\n+\n+    private static Set<String> getGroupKeys(List<VariableReferenceExpression> groupingKeys)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05770437addd3244f49dc7061848cdf19b886459"}, "originalPosition": 104}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5OTMxOA==", "bodyText": "I will make it public then, will see if other place could use it also.", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405199318", "createdAt": "2020-04-08T01:00:50Z", "author": {"login": "xiangfu0"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPushdownUtils.java", "diffHunk": "@@ -163,6 +185,56 @@ public ExpressionType getExpressionType()\n         return nodeBuilder.build();\n     }\n \n+    /**\n+     * Try to push down query like: `SELECT count(distinct $COLUMN) FROM myTable` to Pinot as `SELECT distinctCount($COLUMN) FROM myTable`.\n+     * This function only handles the case of an AggregationNode (COUNT on $COLUMN) on top of an AggregationNode(of non-aggregate on $COLUMN).\n+     *\n+     * @param nodeBuilder\n+     * @param aggregationNode\n+     * @param outputColumn\n+     * @param aggregation\n+     * @return true if push down successfully otherwise false.\n+     */\n+    private static boolean handlePushDownSingleDistinctCount(ImmutableList.Builder<AggregationColumnNode> nodeBuilder, AggregationNode aggregationNode, VariableReferenceExpression outputColumn, AggregationNode.Aggregation aggregation)\n+    {\n+        if (aggregation.getCall().getDisplayName().equalsIgnoreCase(COUNT_FUNCTION_NAME)) {\n+            List<RowExpression> arguments = aggregation.getCall().getArguments();\n+            if (arguments.size() == 1) {\n+                RowExpression aggregationArgument = arguments.get(0);\n+                // Handle the case of Count Aggregation on top of a Non-Agg GroupBy Aggregation.\n+                if (aggregationNode.getSource() instanceof AggregationNode) {\n+                    AggregationNode sourceAggregationNode = (AggregationNode) aggregationNode.getSource();\n+                    Set<String> sourceAggregationGroupSet = getGroupKeys(sourceAggregationNode.getGroupingKeys());\n+                    Set<String> aggregationGroupSet = getGroupKeys(aggregationNode.getGroupingKeys());\n+                    aggregationGroupSet.add(aggregationArgument.toString());\n+                    if (sourceAggregationGroupSet.containsAll(aggregationGroupSet) && aggregationGroupSet.containsAll(sourceAggregationGroupSet)) {\n+                        //(sourceAggregationNode.getGroupingKeys().containsAll(aggregationNode.getGroupingKeys()))\n+                        //aggregationArgument.equalsIgnoreCase(sourceAggregationNode.getGroupingKeys().get(0).getName()))\n+                        nodeBuilder.add(\n+                                new AggregationFunctionColumnNode(\n+                                        outputColumn,\n+                                        new CallExpression(\n+                                                DISTINCT_COUNT_FUNCTION_NAME,\n+                                                aggregation.getFunctionHandle(),\n+                                                BigintType.BIGINT,\n+                                                ImmutableList.of(aggregationArgument))));\n+                        return true;\n+                    }\n+                }\n+            }\n+        }\n+        return false;\n+    }\n+\n+    private static Set<String> getGroupKeys(List<VariableReferenceExpression> groupingKeys)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5MzA2MA=="}, "originalCommit": {"oid": "05770437addd3244f49dc7061848cdf19b886459"}, "originalPosition": 104}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNDM5MzMyOnYy", "diffSide": "RIGHT", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGeneratorContext.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwMDozODowOFrOGCbB2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwMTowMToyNFrOGCbaXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5MzE3Nw==", "bodyText": "Commented code", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405193177", "createdAt": "2020-04-08T00:38:08Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGeneratorContext.java", "diffHunk": "@@ -151,7 +154,19 @@ public PinotQueryGeneratorContext withAggregation(\n             Set<VariableReferenceExpression> hiddenColumnSet)\n     {\n         // there is only one aggregation supported.\n-        checkSupported(!hasAggregation(), \"Pinot doesn't support aggregation on top of the aggregated data\");\n+        // checkSupported(!hasAggregation(), \"Pinot doesn't support aggregation on top of the aggregated data\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05770437addd3244f49dc7061848cdf19b886459"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5OTQ1NQ==", "bodyText": "will remove", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405199455", "createdAt": "2020-04-08T01:01:24Z", "author": {"login": "xiangfu0"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGeneratorContext.java", "diffHunk": "@@ -151,7 +154,19 @@ public PinotQueryGeneratorContext withAggregation(\n             Set<VariableReferenceExpression> hiddenColumnSet)\n     {\n         // there is only one aggregation supported.\n-        checkSupported(!hasAggregation(), \"Pinot doesn't support aggregation on top of the aggregated data\");\n+        // checkSupported(!hasAggregation(), \"Pinot doesn't support aggregation on top of the aggregated data\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5MzE3Nw=="}, "originalCommit": {"oid": "05770437addd3244f49dc7061848cdf19b886459"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNDM5Njk4OnYy", "diffSide": "RIGHT", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGeneratorContext.java", "isResolved": true, "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwMDozOTo1N1rOGCbD4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwNzowMToxM1rOGChigA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5MzY5Nw==", "bodyText": "I didn't understand fully the need to change hiddenColumnSet here ?\nAlso, can this loop be written using some java8 streams way ?", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405193697", "createdAt": "2020-04-08T00:39:57Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGeneratorContext.java", "diffHunk": "@@ -151,7 +154,19 @@ public PinotQueryGeneratorContext withAggregation(\n             Set<VariableReferenceExpression> hiddenColumnSet)\n     {\n         // there is only one aggregation supported.\n-        checkSupported(!hasAggregation(), \"Pinot doesn't support aggregation on top of the aggregated data\");\n+        // checkSupported(!hasAggregation(), \"Pinot doesn't support aggregation on top of the aggregated data\");\n+        // there is only one aggregation supported unless distinct is used.\n+        Iterator<Selection> selectionIterator = newSelections.values().iterator();\n+        boolean passed = false;\n+        while (selectionIterator.hasNext()) {\n+            if (selectionIterator.next().getDefinition().startsWith(DISTINCT_COUNT_FUNCTION_NAME.toUpperCase(Locale.ENGLISH))) {\n+                hiddenColumnSet = Collections.emptySet();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05770437addd3244f49dc7061848cdf19b886459"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIwMDY2Ng==", "bodyText": "Current code will translate the underlying non-agg groupby query select A from myTable group by A to   select A, count(*) from myTable group by A and count(*) is hidden column.\nSo the upper level distinctCount shouldn't inherited this hiddenColumnSet.", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405200666", "createdAt": "2020-04-08T01:06:04Z", "author": {"login": "xiangfu0"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGeneratorContext.java", "diffHunk": "@@ -151,7 +154,19 @@ public PinotQueryGeneratorContext withAggregation(\n             Set<VariableReferenceExpression> hiddenColumnSet)\n     {\n         // there is only one aggregation supported.\n-        checkSupported(!hasAggregation(), \"Pinot doesn't support aggregation on top of the aggregated data\");\n+        // checkSupported(!hasAggregation(), \"Pinot doesn't support aggregation on top of the aggregated data\");\n+        // there is only one aggregation supported unless distinct is used.\n+        Iterator<Selection> selectionIterator = newSelections.values().iterator();\n+        boolean passed = false;\n+        while (selectionIterator.hasNext()) {\n+            if (selectionIterator.next().getDefinition().startsWith(DISTINCT_COUNT_FUNCTION_NAME.toUpperCase(Locale.ENGLISH))) {\n+                hiddenColumnSet = Collections.emptySet();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5MzY5Nw=="}, "originalCommit": {"oid": "05770437addd3244f49dc7061848cdf19b886459"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI2MTk2OA==", "bodyText": "I didn't fully understand this. What distinct query is leading to a hiddenColumnSet being populated?\nPerhaps you mean that a \"select count(distinct a) from T\", is going to show up here are as \"select a from T group by T\" with an additional distinct added on top?\nIs it possible for a query like: \"select b, count(distinct a) from T group by b\" to end up here ? ie, would we support grouped count-distinct in this PR? If not, then its okay to clear the hiddenColumnSet. I would suggest adding this comment in the code.\nIn any case, this whole hiddenColumnSet stuff is a sad hack and I am sorry you are having to deal with it :-(.", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405261968", "createdAt": "2020-04-08T05:12:38Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGeneratorContext.java", "diffHunk": "@@ -151,7 +154,19 @@ public PinotQueryGeneratorContext withAggregation(\n             Set<VariableReferenceExpression> hiddenColumnSet)\n     {\n         // there is only one aggregation supported.\n-        checkSupported(!hasAggregation(), \"Pinot doesn't support aggregation on top of the aggregated data\");\n+        // checkSupported(!hasAggregation(), \"Pinot doesn't support aggregation on top of the aggregated data\");\n+        // there is only one aggregation supported unless distinct is used.\n+        Iterator<Selection> selectionIterator = newSelections.values().iterator();\n+        boolean passed = false;\n+        while (selectionIterator.hasNext()) {\n+            if (selectionIterator.next().getDefinition().startsWith(DISTINCT_COUNT_FUNCTION_NAME.toUpperCase(Locale.ENGLISH))) {\n+                hiddenColumnSet = Collections.emptySet();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5MzY5Nw=="}, "originalCommit": {"oid": "05770437addd3244f49dc7061848cdf19b886459"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI2NzAxOA==", "bodyText": "Yes, this only works for single distinctCount with/without groupby.\nThe query plan is different, there is no markDistinctNode for single count distinct query.\nFor select count(distinct origin), dest from airlineStats group by dest;\nBelow is the query plan:\n\nExpended:\n\nFrom top to bottom,\nAggregationNode@14771 is a non-agg groupby dest, origin\nAggregationNode@14754 is a count(origin) group by dest.\nIn PinotQueryGenerator, it will first visit AggregationNode@14771 and generate a hidden column count(*), as it's a non-agg groupby.\nThen comes to AggregationNode@14754, we check if this is a distinctCount function, then we will discard the hidden column and only keep group by dest", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405267018", "createdAt": "2020-04-08T05:32:05Z", "author": {"login": "xiangfu0"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGeneratorContext.java", "diffHunk": "@@ -151,7 +154,19 @@ public PinotQueryGeneratorContext withAggregation(\n             Set<VariableReferenceExpression> hiddenColumnSet)\n     {\n         // there is only one aggregation supported.\n-        checkSupported(!hasAggregation(), \"Pinot doesn't support aggregation on top of the aggregated data\");\n+        // checkSupported(!hasAggregation(), \"Pinot doesn't support aggregation on top of the aggregated data\");\n+        // there is only one aggregation supported unless distinct is used.\n+        Iterator<Selection> selectionIterator = newSelections.values().iterator();\n+        boolean passed = false;\n+        while (selectionIterator.hasNext()) {\n+            if (selectionIterator.next().getDefinition().startsWith(DISTINCT_COUNT_FUNCTION_NAME.toUpperCase(Locale.ENGLISH))) {\n+                hiddenColumnSet = Collections.emptySet();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5MzY5Nw=="}, "originalCommit": {"oid": "05770437addd3244f49dc7061848cdf19b886459"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI5MzkzOQ==", "bodyText": "Got it. So is there a way to only discard the hiddenColumnSet iff this is a case of an aggregation atop an aggregation (as will be generated in this example query)", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405293939", "createdAt": "2020-04-08T06:47:44Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGeneratorContext.java", "diffHunk": "@@ -151,7 +154,19 @@ public PinotQueryGeneratorContext withAggregation(\n             Set<VariableReferenceExpression> hiddenColumnSet)\n     {\n         // there is only one aggregation supported.\n-        checkSupported(!hasAggregation(), \"Pinot doesn't support aggregation on top of the aggregated data\");\n+        // checkSupported(!hasAggregation(), \"Pinot doesn't support aggregation on top of the aggregated data\");\n+        // there is only one aggregation supported unless distinct is used.\n+        Iterator<Selection> selectionIterator = newSelections.values().iterator();\n+        boolean passed = false;\n+        while (selectionIterator.hasNext()) {\n+            if (selectionIterator.next().getDefinition().startsWith(DISTINCT_COUNT_FUNCTION_NAME.toUpperCase(Locale.ENGLISH))) {\n+                hiddenColumnSet = Collections.emptySet();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5MzY5Nw=="}, "originalCommit": {"oid": "05770437addd3244f49dc7061848cdf19b886459"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI5ODg1MA==", "bodyText": "so this plan is common for count distinct and count distinct group by query, and we only discard hidden column under this circumstance.", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405298850", "createdAt": "2020-04-08T06:58:52Z", "author": {"login": "xiangfu0"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGeneratorContext.java", "diffHunk": "@@ -151,7 +154,19 @@ public PinotQueryGeneratorContext withAggregation(\n             Set<VariableReferenceExpression> hiddenColumnSet)\n     {\n         // there is only one aggregation supported.\n-        checkSupported(!hasAggregation(), \"Pinot doesn't support aggregation on top of the aggregated data\");\n+        // checkSupported(!hasAggregation(), \"Pinot doesn't support aggregation on top of the aggregated data\");\n+        // there is only one aggregation supported unless distinct is used.\n+        Iterator<Selection> selectionIterator = newSelections.values().iterator();\n+        boolean passed = false;\n+        while (selectionIterator.hasNext()) {\n+            if (selectionIterator.next().getDefinition().startsWith(DISTINCT_COUNT_FUNCTION_NAME.toUpperCase(Locale.ENGLISH))) {\n+                hiddenColumnSet = Collections.emptySet();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5MzY5Nw=="}, "originalCommit": {"oid": "05770437addd3244f49dc7061848cdf19b886459"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI5OTg0MA==", "bodyText": "Thank you. So its safe to discard then ! :-). This is certainly worth documenting more clearly in the code.", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405299840", "createdAt": "2020-04-08T07:01:13Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGeneratorContext.java", "diffHunk": "@@ -151,7 +154,19 @@ public PinotQueryGeneratorContext withAggregation(\n             Set<VariableReferenceExpression> hiddenColumnSet)\n     {\n         // there is only one aggregation supported.\n-        checkSupported(!hasAggregation(), \"Pinot doesn't support aggregation on top of the aggregated data\");\n+        // checkSupported(!hasAggregation(), \"Pinot doesn't support aggregation on top of the aggregated data\");\n+        // there is only one aggregation supported unless distinct is used.\n+        Iterator<Selection> selectionIterator = newSelections.values().iterator();\n+        boolean passed = false;\n+        while (selectionIterator.hasNext()) {\n+            if (selectionIterator.next().getDefinition().startsWith(DISTINCT_COUNT_FUNCTION_NAME.toUpperCase(Locale.ENGLISH))) {\n+                hiddenColumnSet = Collections.emptySet();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5MzY5Nw=="}, "originalCommit": {"oid": "05770437addd3244f49dc7061848cdf19b886459"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNDM5ODEzOnYy", "diffSide": "RIGHT", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGeneratorContext.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwMDo0MDo0MFrOGCbEkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwMTowODoyMFrOGCbhOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5Mzg3NQ==", "bodyText": "Is this used anywhere ?", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405193875", "createdAt": "2020-04-08T00:40:40Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGeneratorContext.java", "diffHunk": "@@ -242,6 +257,20 @@ private boolean hasOrderBy()\n         return !topNColumnOrderingMap.isEmpty();\n     }\n \n+    public boolean isNonAggregateGroupBy()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05770437addd3244f49dc7061848cdf19b886459"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIwMTIxMA==", "bodyText": "no, will remove it.", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405201210", "createdAt": "2020-04-08T01:08:20Z", "author": {"login": "xiangfu0"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGeneratorContext.java", "diffHunk": "@@ -242,6 +257,20 @@ private boolean hasOrderBy()\n         return !topNColumnOrderingMap.isEmpty();\n     }\n \n+    public boolean isNonAggregateGroupBy()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5Mzg3NQ=="}, "originalCommit": {"oid": "05770437addd3244f49dc7061848cdf19b886459"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNDQwMTQ2OnYy", "diffSide": "RIGHT", "path": "presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/query/TestPinotQueryGenerator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwMDo0MjoyNVrOGCbGdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwMTowOTo1MFrOGCbi2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5NDM1Nw==", "bodyText": "Should we be spelling out __expressions__ here and above ?", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405194357", "createdAt": "2020-04-08T00:42:25Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/query/TestPinotQueryGenerator.java", "diffHunk": "@@ -131,6 +132,52 @@ public void testCountStar()\n         testUnaryAggregationHelper((planBuilder, aggregationBuilder) -> aggregationBuilder.addAggregation(planBuilder.variable(\"agg\"), getRowExpression(\"count(*)\", defaultSessionHolder)), \"count(*)\");\n     }\n \n+    @Test\n+    public void testDistinctCountPushdown()\n+    {\n+        PlanNode justScan = buildPlan(planBuilder -> tableScan(planBuilder, pinotTable, regionId, secondsSinceEpoch, city, fare));\n+        PlanNode distinctAggregation = buildPlan(planBuilder -> planBuilder.aggregation(aggBuilder -> aggBuilder.source(justScan).singleGroupingSet(v(\"regionid\"))));\n+        testPQL(planBuilder -> planBuilder.aggregation(aggBuilder -> aggBuilder.source(distinctAggregation).globalGrouping().addAggregation(v(\"count_regionid\"), getRowExpression(\"count(regionid)\", defaultSessionHolder))),\n+                \"SELECT DISTINCTCOUNT(regionId) FROM realtimeOnly\");\n+    }\n+\n+    @Test\n+    public void testDistinctCountGroupByPushdown()\n+    {\n+        PlanNode justScan = buildPlan(planBuilder -> tableScan(planBuilder, pinotTable, regionId, secondsSinceEpoch, city, fare));\n+        PlanNode distinctAggregation = buildPlan(planBuilder -> planBuilder.aggregation(aggBuilder -> aggBuilder.source(justScan).singleGroupingSet(v(\"city\"), v(\"regionid\"))));\n+        testPQL(planBuilder -> planBuilder.aggregation(aggBuilder -> aggBuilder.source(distinctAggregation).singleGroupingSet(v(\"city\")).addAggregation(v(\"count_regionid\"), getRowExpression(\"count(regionid)\", defaultSessionHolder))),\n+                \"SELECT DISTINCTCOUNT(regionId) FROM realtimeOnly GROUP BY city TOP 10000\");\n+    }\n+\n+    @Test\n+    public void testDistinctCountWithOtherAggregationPushdown()\n+    {\n+        Map<String, String> outputVariables = ImmutableMap.of(\"agg\", \"count(*)\", \"count(regionid)\", \"DISTINCTCOUNT(regionId)\");\n+        PlanNode justScan = buildPlan(planBuilder -> tableScan(planBuilder, pinotTable, regionId, secondsSinceEpoch, city, fare));\n+        PlanNode markDistinct = buildPlan(planBuilder -> markDistinct(planBuilder, v(\"regionid$distinct\"), ImmutableList.of(v(\"regionid\")), justScan));\n+        testPQL(\n+                new PinotConfig().setAllowMultipleAggregations(true),\n+                planBuilder -> planBuilder.aggregation(aggBuilder -> aggBuilder.source(markDistinct).addAggregation(planBuilder.variable(\"agg\"), getRowExpression(\"count(*)\", defaultSessionHolder)).addAggregation(planBuilder.variable(\"count(regionid)\"), getRowExpression(\"count(regionid)\", defaultSessionHolder), Optional.empty(), Optional.empty(), false, Optional.of(v(\"regionid$distinct\"))).globalGrouping()),\n+                \"SELECT __expressions__ FROM realtimeOnly\",\n+                defaultSessionHolder,\n+                outputVariables);\n+    }\n+\n+    @Test\n+    public void testDistinctCountWithOtherAggregationGroupByPushdown()\n+    {\n+        Map<String, String> outputVariables = ImmutableMap.of(\"agg\", \"count(*)\", \"count(regionid)\", \"DISTINCTCOUNT(regionId)\");\n+        PlanNode justScan = buildPlan(planBuilder -> tableScan(planBuilder, pinotTable, regionId, secondsSinceEpoch, city, fare));\n+        PlanNode markDistinct = buildPlan(planBuilder -> markDistinct(planBuilder, v(\"regionid$distinct\"), ImmutableList.of(v(\"regionid\")), justScan));\n+        testPQL(\n+                new PinotConfig().setAllowMultipleAggregations(true),\n+                planBuilder -> planBuilder.aggregation(aggBuilder -> aggBuilder.source(markDistinct).singleGroupingSet(v(\"city\")).addAggregation(planBuilder.variable(\"agg\"), getRowExpression(\"count(*)\", defaultSessionHolder)).addAggregation(planBuilder.variable(\"count(regionid)\"), getRowExpression(\"count(regionid)\", defaultSessionHolder), Optional.empty(), Optional.empty(), false, Optional.of(v(\"regionid$distinct\")))),\n+                \"SELECT __expressions__ FROM realtimeOnly GROUP BY city TOP 10000\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05770437addd3244f49dc7061848cdf19b886459"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIwMTYyNA==", "bodyText": "will do", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405201624", "createdAt": "2020-04-08T01:09:50Z", "author": {"login": "xiangfu0"}, "path": "presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/query/TestPinotQueryGenerator.java", "diffHunk": "@@ -131,6 +132,52 @@ public void testCountStar()\n         testUnaryAggregationHelper((planBuilder, aggregationBuilder) -> aggregationBuilder.addAggregation(planBuilder.variable(\"agg\"), getRowExpression(\"count(*)\", defaultSessionHolder)), \"count(*)\");\n     }\n \n+    @Test\n+    public void testDistinctCountPushdown()\n+    {\n+        PlanNode justScan = buildPlan(planBuilder -> tableScan(planBuilder, pinotTable, regionId, secondsSinceEpoch, city, fare));\n+        PlanNode distinctAggregation = buildPlan(planBuilder -> planBuilder.aggregation(aggBuilder -> aggBuilder.source(justScan).singleGroupingSet(v(\"regionid\"))));\n+        testPQL(planBuilder -> planBuilder.aggregation(aggBuilder -> aggBuilder.source(distinctAggregation).globalGrouping().addAggregation(v(\"count_regionid\"), getRowExpression(\"count(regionid)\", defaultSessionHolder))),\n+                \"SELECT DISTINCTCOUNT(regionId) FROM realtimeOnly\");\n+    }\n+\n+    @Test\n+    public void testDistinctCountGroupByPushdown()\n+    {\n+        PlanNode justScan = buildPlan(planBuilder -> tableScan(planBuilder, pinotTable, regionId, secondsSinceEpoch, city, fare));\n+        PlanNode distinctAggregation = buildPlan(planBuilder -> planBuilder.aggregation(aggBuilder -> aggBuilder.source(justScan).singleGroupingSet(v(\"city\"), v(\"regionid\"))));\n+        testPQL(planBuilder -> planBuilder.aggregation(aggBuilder -> aggBuilder.source(distinctAggregation).singleGroupingSet(v(\"city\")).addAggregation(v(\"count_regionid\"), getRowExpression(\"count(regionid)\", defaultSessionHolder))),\n+                \"SELECT DISTINCTCOUNT(regionId) FROM realtimeOnly GROUP BY city TOP 10000\");\n+    }\n+\n+    @Test\n+    public void testDistinctCountWithOtherAggregationPushdown()\n+    {\n+        Map<String, String> outputVariables = ImmutableMap.of(\"agg\", \"count(*)\", \"count(regionid)\", \"DISTINCTCOUNT(regionId)\");\n+        PlanNode justScan = buildPlan(planBuilder -> tableScan(planBuilder, pinotTable, regionId, secondsSinceEpoch, city, fare));\n+        PlanNode markDistinct = buildPlan(planBuilder -> markDistinct(planBuilder, v(\"regionid$distinct\"), ImmutableList.of(v(\"regionid\")), justScan));\n+        testPQL(\n+                new PinotConfig().setAllowMultipleAggregations(true),\n+                planBuilder -> planBuilder.aggregation(aggBuilder -> aggBuilder.source(markDistinct).addAggregation(planBuilder.variable(\"agg\"), getRowExpression(\"count(*)\", defaultSessionHolder)).addAggregation(planBuilder.variable(\"count(regionid)\"), getRowExpression(\"count(regionid)\", defaultSessionHolder), Optional.empty(), Optional.empty(), false, Optional.of(v(\"regionid$distinct\"))).globalGrouping()),\n+                \"SELECT __expressions__ FROM realtimeOnly\",\n+                defaultSessionHolder,\n+                outputVariables);\n+    }\n+\n+    @Test\n+    public void testDistinctCountWithOtherAggregationGroupByPushdown()\n+    {\n+        Map<String, String> outputVariables = ImmutableMap.of(\"agg\", \"count(*)\", \"count(regionid)\", \"DISTINCTCOUNT(regionId)\");\n+        PlanNode justScan = buildPlan(planBuilder -> tableScan(planBuilder, pinotTable, regionId, secondsSinceEpoch, city, fare));\n+        PlanNode markDistinct = buildPlan(planBuilder -> markDistinct(planBuilder, v(\"regionid$distinct\"), ImmutableList.of(v(\"regionid\")), justScan));\n+        testPQL(\n+                new PinotConfig().setAllowMultipleAggregations(true),\n+                planBuilder -> planBuilder.aggregation(aggBuilder -> aggBuilder.source(markDistinct).singleGroupingSet(v(\"city\")).addAggregation(planBuilder.variable(\"agg\"), getRowExpression(\"count(*)\", defaultSessionHolder)).addAggregation(planBuilder.variable(\"count(regionid)\"), getRowExpression(\"count(regionid)\", defaultSessionHolder), Optional.empty(), Optional.empty(), false, Optional.of(v(\"regionid$distinct\")))),\n+                \"SELECT __expressions__ FROM realtimeOnly GROUP BY city TOP 10000\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5NDM1Nw=="}, "originalCommit": {"oid": "05770437addd3244f49dc7061848cdf19b886459"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNzU2NjkwOnYy", "diffSide": "RIGHT", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGeneratorContext.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxNzozMToxOFrOGC5n4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxOToxODoyM1rOGC9amQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY5NDQzNQ==", "bodyText": "Can you use a more descriptive name than passed, please?", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405694435", "createdAt": "2020-04-08T17:31:18Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGeneratorContext.java", "diffHunk": "@@ -150,8 +154,18 @@ public PinotQueryGeneratorContext withAggregation(\n             int aggregations,\n             Set<VariableReferenceExpression> hiddenColumnSet)\n     {\n-        // there is only one aggregation supported.\n-        checkSupported(!hasAggregation(), \"Pinot doesn't support aggregation on top of the aggregated data\");\n+        // there is only one aggregation supported unless distinct is used.\n+        boolean passed = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "92208bf69c95f178fabebe74d416261e94fe893c"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc1NjU2OQ==", "bodyText": "will do", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405756569", "createdAt": "2020-04-08T19:18:23Z", "author": {"login": "xiangfu0"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGeneratorContext.java", "diffHunk": "@@ -150,8 +154,18 @@ public PinotQueryGeneratorContext withAggregation(\n             int aggregations,\n             Set<VariableReferenceExpression> hiddenColumnSet)\n     {\n-        // there is only one aggregation supported.\n-        checkSupported(!hasAggregation(), \"Pinot doesn't support aggregation on top of the aggregated data\");\n+        // there is only one aggregation supported unless distinct is used.\n+        boolean passed = false;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY5NDQzNQ=="}, "originalCommit": {"oid": "92208bf69c95f178fabebe74d416261e94fe893c"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNzU4NDkyOnYy", "diffSide": "RIGHT", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGeneratorContext.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxNzozNjoyOFrOGC5zYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMDoyODowN1rOGC_tuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY5NzM3OQ==", "bodyText": "The hiddenColumnSet should be changed here, such that the loop above becomes read-only.\nAlso, would this check make sense to guard the overwriting of hiddenColumnSet:\nif (!passed) { checkSupported(!hashAggregation(), \"....\"); } else if (hasAggregation()) { hiddenColumnSet = ImmutableSet.of(); } \nAlso, please use either ImmutableSet.of() if the intention is for hiddenColumnSet to be never added to again for the life of this context. Or use a new HashSet<> if you want to allow future additions. Presto does not encourage Collections.emptySet.\nI wonder if it is possible to have another aggregation on top of a distinct ? Like can we have three aggregations stacked together ? What should we do in that case ? The safest thing would be to detect and back out.", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405697379", "createdAt": "2020-04-08T17:36:28Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGeneratorContext.java", "diffHunk": "@@ -150,8 +154,18 @@ public PinotQueryGeneratorContext withAggregation(\n             int aggregations,\n             Set<VariableReferenceExpression> hiddenColumnSet)\n     {\n-        // there is only one aggregation supported.\n-        checkSupported(!hasAggregation(), \"Pinot doesn't support aggregation on top of the aggregated data\");\n+        // there is only one aggregation supported unless distinct is used.\n+        boolean passed = false;\n+        Collection<Selection> selections = newSelections.values();\n+        for (Selection selection : selections) {\n+            if (selection.getDefinition().startsWith(DISTINCT_COUNT_FUNCTION_NAME.toUpperCase(Locale.ENGLISH))) {\n+                hiddenColumnSet = Collections.emptySet();\n+                passed = true;\n+            }\n+        }\n+        if (!passed) {\n+            checkSupported(!hasAggregation(), \"Pinot doesn't support aggregation on top of the aggregated data\");\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "92208bf69c95f178fabebe74d416261e94fe893c"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc1NjUwNQ==", "bodyText": "Agreed.\nIf it's triple aggregation, then the most outer layer will check and found out there is an aggregation on top of an aggregation, then fail.", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405756505", "createdAt": "2020-04-08T19:18:15Z", "author": {"login": "xiangfu0"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGeneratorContext.java", "diffHunk": "@@ -150,8 +154,18 @@ public PinotQueryGeneratorContext withAggregation(\n             int aggregations,\n             Set<VariableReferenceExpression> hiddenColumnSet)\n     {\n-        // there is only one aggregation supported.\n-        checkSupported(!hasAggregation(), \"Pinot doesn't support aggregation on top of the aggregated data\");\n+        // there is only one aggregation supported unless distinct is used.\n+        boolean passed = false;\n+        Collection<Selection> selections = newSelections.values();\n+        for (Selection selection : selections) {\n+            if (selection.getDefinition().startsWith(DISTINCT_COUNT_FUNCTION_NAME.toUpperCase(Locale.ENGLISH))) {\n+                hiddenColumnSet = Collections.emptySet();\n+                passed = true;\n+            }\n+        }\n+        if (!passed) {\n+            checkSupported(!hasAggregation(), \"Pinot doesn't support aggregation on top of the aggregated data\");\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY5NzM3OQ=="}, "originalCommit": {"oid": "92208bf69c95f178fabebe74d416261e94fe893c"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc5MDgxNQ==", "bodyText": "Refined this logic.", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405790815", "createdAt": "2020-04-08T20:21:58Z", "author": {"login": "xiangfu0"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGeneratorContext.java", "diffHunk": "@@ -150,8 +154,18 @@ public PinotQueryGeneratorContext withAggregation(\n             int aggregations,\n             Set<VariableReferenceExpression> hiddenColumnSet)\n     {\n-        // there is only one aggregation supported.\n-        checkSupported(!hasAggregation(), \"Pinot doesn't support aggregation on top of the aggregated data\");\n+        // there is only one aggregation supported unless distinct is used.\n+        boolean passed = false;\n+        Collection<Selection> selections = newSelections.values();\n+        for (Selection selection : selections) {\n+            if (selection.getDefinition().startsWith(DISTINCT_COUNT_FUNCTION_NAME.toUpperCase(Locale.ENGLISH))) {\n+                hiddenColumnSet = Collections.emptySet();\n+                passed = true;\n+            }\n+        }\n+        if (!passed) {\n+            checkSupported(!hasAggregation(), \"Pinot doesn't support aggregation on top of the aggregated data\");\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY5NzM3OQ=="}, "originalCommit": {"oid": "92208bf69c95f178fabebe74d416261e94fe893c"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc5NDIzMw==", "bodyText": "Thanks !. Reads better now :-)", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405794233", "createdAt": "2020-04-08T20:28:07Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGeneratorContext.java", "diffHunk": "@@ -150,8 +154,18 @@ public PinotQueryGeneratorContext withAggregation(\n             int aggregations,\n             Set<VariableReferenceExpression> hiddenColumnSet)\n     {\n-        // there is only one aggregation supported.\n-        checkSupported(!hasAggregation(), \"Pinot doesn't support aggregation on top of the aggregated data\");\n+        // there is only one aggregation supported unless distinct is used.\n+        boolean passed = false;\n+        Collection<Selection> selections = newSelections.values();\n+        for (Selection selection : selections) {\n+            if (selection.getDefinition().startsWith(DISTINCT_COUNT_FUNCTION_NAME.toUpperCase(Locale.ENGLISH))) {\n+                hiddenColumnSet = Collections.emptySet();\n+                passed = true;\n+            }\n+        }\n+        if (!passed) {\n+            checkSupported(!hasAggregation(), \"Pinot doesn't support aggregation on top of the aggregated data\");\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY5NzM3OQ=="}, "originalCommit": {"oid": "92208bf69c95f178fabebe74d416261e94fe893c"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxOTA5MTQ1OnYy", "diffSide": "RIGHT", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGenerator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwMzoxMzo1OFrOGDIIyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwNDo1MToyN1rOGDJg8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzMjIzNQ==", "bodyText": "ImmutableMap.<String, String>builder()", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405932235", "createdAt": "2020-04-09T03:13:58Z", "author": {"login": "highker"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGenerator.java", "diffHunk": "@@ -74,12 +75,15 @@\n public class PinotQueryGenerator\n {\n     private static final Logger log = Logger.get(PinotQueryGenerator.class);\n-    private static final Map<String, String> UNARY_AGGREGATION_MAP = ImmutableMap.of(\n-            \"min\", \"min\",\n-            \"max\", \"max\",\n-            \"avg\", \"avg\",\n-            \"sum\", \"sum\",\n-            \"approx_distinct\", \"DISTINCTCOUNTHLL\");\n+    private static final Map<String, String> UNARY_AGGREGATION_MAP =\n+            new ImmutableMap.Builder<String, String>()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7ea11c5bfbed5e7db3f1e9e85437782140437c0"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk1NDgwMQ==", "bodyText": "done", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405954801", "createdAt": "2020-04-09T04:51:27Z", "author": {"login": "xiangfu0"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGenerator.java", "diffHunk": "@@ -74,12 +75,15 @@\n public class PinotQueryGenerator\n {\n     private static final Logger log = Logger.get(PinotQueryGenerator.class);\n-    private static final Map<String, String> UNARY_AGGREGATION_MAP = ImmutableMap.of(\n-            \"min\", \"min\",\n-            \"max\", \"max\",\n-            \"avg\", \"avg\",\n-            \"sum\", \"sum\",\n-            \"approx_distinct\", \"DISTINCTCOUNTHLL\");\n+    private static final Map<String, String> UNARY_AGGREGATION_MAP =\n+            new ImmutableMap.Builder<String, String>()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzMjIzNQ=="}, "originalCommit": {"oid": "b7ea11c5bfbed5e7db3f1e9e85437782140437c0"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxOTA5MzYxOnYy", "diffSide": "RIGHT", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGenerator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwMzoxNToxNFrOGDIKEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwNDo1Mjo1MVrOGDJiNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzMjU2Mw==", "bodyText": "put this to the first line.", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405932563", "createdAt": "2020-04-09T03:15:14Z", "author": {"login": "highker"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGenerator.java", "diffHunk": "@@ -244,6 +248,14 @@ protected VariableReferenceExpression getVariableReference(RowExpression express\n             throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), \"Expected a variable reference but got \" + expression);\n         }\n \n+        @Override\n+        public PinotQueryGeneratorContext visitMarkDistinct(MarkDistinctNode node, PinotQueryGeneratorContext context)\n+        {\n+            context = node.getSource().accept(this, context);\n+            requireNonNull(context, \"context is null\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7ea11c5bfbed5e7db3f1e9e85437782140437c0"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk1NTEyNg==", "bodyText": "done.", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405955126", "createdAt": "2020-04-09T04:52:51Z", "author": {"login": "xiangfu0"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGenerator.java", "diffHunk": "@@ -244,6 +248,14 @@ protected VariableReferenceExpression getVariableReference(RowExpression express\n             throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), \"Expected a variable reference but got \" + expression);\n         }\n \n+        @Override\n+        public PinotQueryGeneratorContext visitMarkDistinct(MarkDistinctNode node, PinotQueryGeneratorContext context)\n+        {\n+            context = node.getSource().accept(this, context);\n+            requireNonNull(context, \"context is null\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzMjU2Mw=="}, "originalCommit": {"oid": "b7ea11c5bfbed5e7db3f1e9e85437782140437c0"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxOTA5Mzk5OnYy", "diffSide": "RIGHT", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGenerator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwMzoxNToyOFrOGDIKTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwNDo1Mjo1N1rOGDJiTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzMjYyMg==", "bodyText": "return node.getSource().accept(this, context);", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405932622", "createdAt": "2020-04-09T03:15:28Z", "author": {"login": "highker"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGenerator.java", "diffHunk": "@@ -244,6 +248,14 @@ protected VariableReferenceExpression getVariableReference(RowExpression express\n             throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), \"Expected a variable reference but got \" + expression);\n         }\n \n+        @Override\n+        public PinotQueryGeneratorContext visitMarkDistinct(MarkDistinctNode node, PinotQueryGeneratorContext context)\n+        {\n+            context = node.getSource().accept(this, context);\n+            requireNonNull(context, \"context is null\");\n+            return context;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7ea11c5bfbed5e7db3f1e9e85437782140437c0"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk1NTE0OQ==", "bodyText": "done.", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405955149", "createdAt": "2020-04-09T04:52:57Z", "author": {"login": "xiangfu0"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGenerator.java", "diffHunk": "@@ -244,6 +248,14 @@ protected VariableReferenceExpression getVariableReference(RowExpression express\n             throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), \"Expected a variable reference but got \" + expression);\n         }\n \n+        @Override\n+        public PinotQueryGeneratorContext visitMarkDistinct(MarkDistinctNode node, PinotQueryGeneratorContext context)\n+        {\n+            context = node.getSource().accept(this, context);\n+            requireNonNull(context, \"context is null\");\n+            return context;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzMjYyMg=="}, "originalCommit": {"oid": "b7ea11c5bfbed5e7db3f1e9e85437782140437c0"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxOTA5NzE3OnYy", "diffSide": "RIGHT", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPushdownUtils.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwMzoxNzoyM1rOGDIMDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwNjoxMjo0NFrOGDK22g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzMzA3MA==", "bodyText": "where do we have this function?", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405933070", "createdAt": "2020-04-09T03:17:23Z", "author": {"login": "highker"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPushdownUtils.java", "diffHunk": "@@ -48,6 +51,10 @@\n \n public class PinotPushdownUtils\n {\n+    public static final String DISTINCT_COUNT_FUNCTION_NAME = \"distinctCount\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7ea11c5bfbed5e7db3f1e9e85437782140437c0"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk1MzU2Mg==", "bodyText": "This function is defined in Pinot , please refer to here", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405953562", "createdAt": "2020-04-09T04:46:22Z", "author": {"login": "xiangfu0"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPushdownUtils.java", "diffHunk": "@@ -48,6 +51,10 @@\n \n public class PinotPushdownUtils\n {\n+    public static final String DISTINCT_COUNT_FUNCTION_NAME = \"distinctCount\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzMzA3MA=="}, "originalCommit": {"oid": "b7ea11c5bfbed5e7db3f1e9e85437782140437c0"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk1OTQyNQ==", "bodyText": "Let's put PINOT_ for these consts to denote they are Pinot functions. Also break an empty between public and private consts.", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405959425", "createdAt": "2020-04-09T05:10:13Z", "author": {"login": "highker"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPushdownUtils.java", "diffHunk": "@@ -48,6 +51,10 @@\n \n public class PinotPushdownUtils\n {\n+    public static final String DISTINCT_COUNT_FUNCTION_NAME = \"distinctCount\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzMzA3MA=="}, "originalCommit": {"oid": "b7ea11c5bfbed5e7db3f1e9e85437782140437c0"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk3Njc5NA==", "bodyText": "Done. Thanks!", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405976794", "createdAt": "2020-04-09T06:12:44Z", "author": {"login": "xiangfu0"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPushdownUtils.java", "diffHunk": "@@ -48,6 +51,10 @@\n \n public class PinotPushdownUtils\n {\n+    public static final String DISTINCT_COUNT_FUNCTION_NAME = \"distinctCount\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzMzA3MA=="}, "originalCommit": {"oid": "b7ea11c5bfbed5e7db3f1e9e85437782140437c0"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxOTA5ODY2OnYy", "diffSide": "RIGHT", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPushdownUtils.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwMzoxODowNFrOGDIM2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwNDo1MDoyNVrOGDJgHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzMzI3NQ==", "bodyText": "rename this to aggregation", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405933275", "createdAt": "2020-04-09T03:18:04Z", "author": {"login": "highker"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPushdownUtils.java", "diffHunk": "@@ -147,10 +154,25 @@ public ExpressionType getExpressionType()\n             if (agg != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7ea11c5bfbed5e7db3f1e9e85437782140437c0"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk1NDU4OA==", "bodyText": "done", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405954588", "createdAt": "2020-04-09T04:50:25Z", "author": {"login": "xiangfu0"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPushdownUtils.java", "diffHunk": "@@ -147,10 +154,25 @@ public ExpressionType getExpressionType()\n             if (agg != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzMzI3NQ=="}, "originalCommit": {"oid": "b7ea11c5bfbed5e7db3f1e9e85437782140437c0"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxOTA5OTU3OnYy", "diffSide": "RIGHT", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPushdownUtils.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwMzoxODo0NFrOGDINaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwNDo1MDoyMVrOGDJgCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzMzQxNw==", "bodyText": "We don't use javadoc in the body of a function use comments instead\n// ...\n// ...\n// ...", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405933417", "createdAt": "2020-04-09T03:18:44Z", "author": {"login": "highker"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPushdownUtils.java", "diffHunk": "@@ -147,10 +154,25 @@ public ExpressionType getExpressionType()\n             if (agg != null) {\n                 if (agg.getFilter().isPresent()\n                         || agg.isDistinct()\n-                        || agg.getOrderBy().isPresent()\n-                        || agg.getMask().isPresent()) {\n+                        || agg.getOrderBy().isPresent()) {\n                     throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), \"Unsupported aggregation node \" + aggregationNode);\n                 }\n+                if (agg.getMask().isPresent()) {\n+                    /**", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7ea11c5bfbed5e7db3f1e9e85437782140437c0"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk1NDU2OA==", "bodyText": "done", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405954568", "createdAt": "2020-04-09T04:50:21Z", "author": {"login": "xiangfu0"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPushdownUtils.java", "diffHunk": "@@ -147,10 +154,25 @@ public ExpressionType getExpressionType()\n             if (agg != null) {\n                 if (agg.getFilter().isPresent()\n                         || agg.isDistinct()\n-                        || agg.getOrderBy().isPresent()\n-                        || agg.getMask().isPresent()) {\n+                        || agg.getOrderBy().isPresent()) {\n                     throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), \"Unsupported aggregation node \" + aggregationNode);\n                 }\n+                if (agg.getMask().isPresent()) {\n+                    /**", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzMzQxNw=="}, "originalCommit": {"oid": "b7ea11c5bfbed5e7db3f1e9e85437782140437c0"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxOTEwMTQ1OnYy", "diffSide": "RIGHT", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPushdownUtils.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwMzoxOTo0OVrOGDIOfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwNDo1MDoxM1rOGDJf7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzMzY5Mg==", "bodyText": "Can we return early in this function for most of the ifs; so we don't have to deal with all these braces\nif (!aggregation.getCall().getDisplayName().equalsIgnoreCase(COUNT_FUNCTION_NAME)) {\n    return false;\n}\n\n...", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405933692", "createdAt": "2020-04-09T03:19:49Z", "author": {"login": "highker"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPushdownUtils.java", "diffHunk": "@@ -163,6 +185,52 @@ public ExpressionType getExpressionType()\n         return nodeBuilder.build();\n     }\n \n+    /**\n+     * Try to push down query like: `SELECT count(distinct $COLUMN) FROM myTable` to Pinot as `SELECT distinctCount($COLUMN) FROM myTable`.\n+     * This function only handles the case of an AggregationNode (COUNT on $COLUMN) on top of an AggregationNode(of non-aggregate on $COLUMN).\n+     *\n+     * @param nodeBuilder\n+     * @param aggregationNode\n+     * @param outputColumn\n+     * @param aggregation\n+     * @return true if push down successfully otherwise false.\n+     */\n+    private static boolean handlePushDownSingleDistinctCount(ImmutableList.Builder<AggregationColumnNode> nodeBuilder, AggregationNode aggregationNode, VariableReferenceExpression outputColumn, AggregationNode.Aggregation aggregation)\n+    {\n+        if (aggregation.getCall().getDisplayName().equalsIgnoreCase(COUNT_FUNCTION_NAME)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7ea11c5bfbed5e7db3f1e9e85437782140437c0"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk1NDU0Mg==", "bodyText": "done.", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405954542", "createdAt": "2020-04-09T04:50:13Z", "author": {"login": "xiangfu0"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPushdownUtils.java", "diffHunk": "@@ -163,6 +185,52 @@ public ExpressionType getExpressionType()\n         return nodeBuilder.build();\n     }\n \n+    /**\n+     * Try to push down query like: `SELECT count(distinct $COLUMN) FROM myTable` to Pinot as `SELECT distinctCount($COLUMN) FROM myTable`.\n+     * This function only handles the case of an AggregationNode (COUNT on $COLUMN) on top of an AggregationNode(of non-aggregate on $COLUMN).\n+     *\n+     * @param nodeBuilder\n+     * @param aggregationNode\n+     * @param outputColumn\n+     * @param aggregation\n+     * @return true if push down successfully otherwise false.\n+     */\n+    private static boolean handlePushDownSingleDistinctCount(ImmutableList.Builder<AggregationColumnNode> nodeBuilder, AggregationNode aggregationNode, VariableReferenceExpression outputColumn, AggregationNode.Aggregation aggregation)\n+    {\n+        if (aggregation.getCall().getDisplayName().equalsIgnoreCase(COUNT_FUNCTION_NAME)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzMzY5Mg=="}, "originalCommit": {"oid": "b7ea11c5bfbed5e7db3f1e9e85437782140437c0"}, "originalPosition": 75}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxOTEwMjI0OnYy", "diffSide": "RIGHT", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGeneratorContext.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwMzoyMDoxOFrOGDIO8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwNDo1MzozMlrOGDJi6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzMzgxMQ==", "bodyText": "no javadoc", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405933811", "createdAt": "2020-04-09T03:20:18Z", "author": {"login": "highker"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGeneratorContext.java", "diffHunk": "@@ -150,8 +154,22 @@ public PinotQueryGeneratorContext withAggregation(\n             int aggregations,\n             Set<VariableReferenceExpression> hiddenColumnSet)\n     {\n-        // there is only one aggregation supported.\n-        checkSupported(!hasAggregation(), \"Pinot doesn't support aggregation on top of the aggregated data\");\n+        // there is only one aggregation supported unless distinct is used.\n+        AtomicBoolean pushDownDistinctCount = new AtomicBoolean(false);\n+        newSelections.values().forEach(selection -> {\n+            if (selection.getDefinition().startsWith(DISTINCT_COUNT_FUNCTION_NAME.toUpperCase(Locale.ENGLISH))) {\n+                pushDownDistinctCount.set(true);\n+            }\n+        });\n+        if (pushDownDistinctCount.get()) {\n+            /**", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7ea11c5bfbed5e7db3f1e9e85437782140437c0"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk1NTMwNw==", "bodyText": "done", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405955307", "createdAt": "2020-04-09T04:53:32Z", "author": {"login": "xiangfu0"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGeneratorContext.java", "diffHunk": "@@ -150,8 +154,22 @@ public PinotQueryGeneratorContext withAggregation(\n             int aggregations,\n             Set<VariableReferenceExpression> hiddenColumnSet)\n     {\n-        // there is only one aggregation supported.\n-        checkSupported(!hasAggregation(), \"Pinot doesn't support aggregation on top of the aggregated data\");\n+        // there is only one aggregation supported unless distinct is used.\n+        AtomicBoolean pushDownDistinctCount = new AtomicBoolean(false);\n+        newSelections.values().forEach(selection -> {\n+            if (selection.getDefinition().startsWith(DISTINCT_COUNT_FUNCTION_NAME.toUpperCase(Locale.ENGLISH))) {\n+                pushDownDistinctCount.set(true);\n+            }\n+        });\n+        if (pushDownDistinctCount.get()) {\n+            /**", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzMzgxMQ=="}, "originalCommit": {"oid": "b7ea11c5bfbed5e7db3f1e9e85437782140437c0"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxOTEwMzU1OnYy", "diffSide": "RIGHT", "path": "presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/TestPinotQueryBase.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwMzoyMToxNFrOGDIPxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwNDo1NDoyMVrOGDJj2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzNDAyMA==", "bodyText": "ImmutableMap.<.., ..>builder()", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405934020", "createdAt": "2020-04-09T03:21:14Z", "author": {"login": "highker"}, "path": "presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/TestPinotQueryBase.java", "diffHunk": "@@ -98,12 +99,16 @@\n \n     protected final PinotConfig pinotConfig = new PinotConfig();\n \n-    protected static final Map<VariableReferenceExpression, PinotQueryGeneratorContext.Selection> testInput = ImmutableMap.of(\n-            new VariableReferenceExpression(\"regionid\", BIGINT), new PinotQueryGeneratorContext.Selection(\"regionId\", TABLE_COLUMN), // direct column reference\n-            new VariableReferenceExpression(\"city\", VARCHAR), new PinotQueryGeneratorContext.Selection(\"city\", TABLE_COLUMN), // direct column reference\n-            new VariableReferenceExpression(\"fare\", DOUBLE), new PinotQueryGeneratorContext.Selection(\"fare\", TABLE_COLUMN), // direct column reference\n-            new VariableReferenceExpression(\"totalfare\", DOUBLE), new PinotQueryGeneratorContext.Selection(\"(fare + trip)\", DERIVED), // derived column\n-            new VariableReferenceExpression(\"secondssinceepoch\", BIGINT), new PinotQueryGeneratorContext.Selection(\"secondsSinceEpoch\", TABLE_COLUMN)); // column for datetime functions\n+    protected static final Map<VariableReferenceExpression, PinotQueryGeneratorContext.Selection> testInput =\n+            new ImmutableMap.Builder()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7ea11c5bfbed5e7db3f1e9e85437782140437c0"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk1NTU0NA==", "bodyText": "done", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r405955544", "createdAt": "2020-04-09T04:54:21Z", "author": {"login": "xiangfu0"}, "path": "presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/TestPinotQueryBase.java", "diffHunk": "@@ -98,12 +99,16 @@\n \n     protected final PinotConfig pinotConfig = new PinotConfig();\n \n-    protected static final Map<VariableReferenceExpression, PinotQueryGeneratorContext.Selection> testInput = ImmutableMap.of(\n-            new VariableReferenceExpression(\"regionid\", BIGINT), new PinotQueryGeneratorContext.Selection(\"regionId\", TABLE_COLUMN), // direct column reference\n-            new VariableReferenceExpression(\"city\", VARCHAR), new PinotQueryGeneratorContext.Selection(\"city\", TABLE_COLUMN), // direct column reference\n-            new VariableReferenceExpression(\"fare\", DOUBLE), new PinotQueryGeneratorContext.Selection(\"fare\", TABLE_COLUMN), // direct column reference\n-            new VariableReferenceExpression(\"totalfare\", DOUBLE), new PinotQueryGeneratorContext.Selection(\"(fare + trip)\", DERIVED), // derived column\n-            new VariableReferenceExpression(\"secondssinceepoch\", BIGINT), new PinotQueryGeneratorContext.Selection(\"secondsSinceEpoch\", TABLE_COLUMN)); // column for datetime functions\n+    protected static final Map<VariableReferenceExpression, PinotQueryGeneratorContext.Selection> testInput =\n+            new ImmutableMap.Builder()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzNDAyMA=="}, "originalCommit": {"oid": "b7ea11c5bfbed5e7db3f1e9e85437782140437c0"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxOTYzNTY1OnYy", "diffSide": "RIGHT", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPushdownUtils.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwNzo0MzowNlrOGDNNDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwNzo0MzowNlrOGDNNDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjAxNTI0NA==", "bodyText": "break a line after this", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r406015244", "createdAt": "2020-04-09T07:43:06Z", "author": {"login": "highker"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPushdownUtils.java", "diffHunk": "@@ -163,6 +183,55 @@ public ExpressionType getExpressionType()\n         return nodeBuilder.build();\n     }\n \n+    /**\n+     * Try to push down query like: `SELECT count(distinct $COLUMN) FROM myTable` to Pinot as `SELECT distinctCount($COLUMN) FROM myTable`.\n+     * This function only handles the case of an AggregationNode (COUNT on $COLUMN) on top of an AggregationNode(of non-aggregate on $COLUMN).\n+     *\n+     * @param nodeBuilder\n+     * @param aggregationNode\n+     * @param outputColumn\n+     * @param aggregation\n+     * @return true if push down successfully otherwise false.\n+     */\n+    private static boolean handlePushDownSingleDistinctCount(ImmutableList.Builder<AggregationColumnNode> nodeBuilder, AggregationNode aggregationNode, VariableReferenceExpression outputColumn, AggregationNode.Aggregation aggregation)\n+    {\n+        if (!aggregation.getCall().getDisplayName().equalsIgnoreCase(COUNT_FUNCTION_NAME)) {\n+            return false;\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62fc19899ebb26212e1649ca5b6968ac5e04297c"}, "originalPosition": 86}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxOTYzNTg2OnYy", "diffSide": "RIGHT", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPushdownUtils.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwNzo0MzoxMFrOGDNNMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwNzo0MzoxMFrOGDNNMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjAxNTI4MQ==", "bodyText": "break a line after this", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r406015281", "createdAt": "2020-04-09T07:43:10Z", "author": {"login": "highker"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPushdownUtils.java", "diffHunk": "@@ -163,6 +183,55 @@ public ExpressionType getExpressionType()\n         return nodeBuilder.build();\n     }\n \n+    /**\n+     * Try to push down query like: `SELECT count(distinct $COLUMN) FROM myTable` to Pinot as `SELECT distinctCount($COLUMN) FROM myTable`.\n+     * This function only handles the case of an AggregationNode (COUNT on $COLUMN) on top of an AggregationNode(of non-aggregate on $COLUMN).\n+     *\n+     * @param nodeBuilder\n+     * @param aggregationNode\n+     * @param outputColumn\n+     * @param aggregation\n+     * @return true if push down successfully otherwise false.\n+     */\n+    private static boolean handlePushDownSingleDistinctCount(ImmutableList.Builder<AggregationColumnNode> nodeBuilder, AggregationNode aggregationNode, VariableReferenceExpression outputColumn, AggregationNode.Aggregation aggregation)\n+    {\n+        if (!aggregation.getCall().getDisplayName().equalsIgnoreCase(COUNT_FUNCTION_NAME)) {\n+            return false;\n+        }\n+        List<RowExpression> arguments = aggregation.getCall().getArguments();\n+        if (arguments.size() != 1) {\n+            return false;\n+        }\n+        RowExpression aggregationArgument = arguments.get(0);\n+        // Handle the case of Count Aggregation on top of a Non-Agg GroupBy Aggregation.\n+        if (!(aggregationNode.getSource() instanceof AggregationNode)) {\n+            return false;\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62fc19899ebb26212e1649ca5b6968ac5e04297c"}, "originalPosition": 95}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxOTYzNTk0OnYy", "diffSide": "RIGHT", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPushdownUtils.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwNzo0MzoxMlrOGDNNQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwNzo0MzoxMlrOGDNNQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjAxNTI5OQ==", "bodyText": "break a line after this", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r406015299", "createdAt": "2020-04-09T07:43:12Z", "author": {"login": "highker"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPushdownUtils.java", "diffHunk": "@@ -163,6 +183,55 @@ public ExpressionType getExpressionType()\n         return nodeBuilder.build();\n     }\n \n+    /**\n+     * Try to push down query like: `SELECT count(distinct $COLUMN) FROM myTable` to Pinot as `SELECT distinctCount($COLUMN) FROM myTable`.\n+     * This function only handles the case of an AggregationNode (COUNT on $COLUMN) on top of an AggregationNode(of non-aggregate on $COLUMN).\n+     *\n+     * @param nodeBuilder\n+     * @param aggregationNode\n+     * @param outputColumn\n+     * @param aggregation\n+     * @return true if push down successfully otherwise false.\n+     */\n+    private static boolean handlePushDownSingleDistinctCount(ImmutableList.Builder<AggregationColumnNode> nodeBuilder, AggregationNode aggregationNode, VariableReferenceExpression outputColumn, AggregationNode.Aggregation aggregation)\n+    {\n+        if (!aggregation.getCall().getDisplayName().equalsIgnoreCase(COUNT_FUNCTION_NAME)) {\n+            return false;\n+        }\n+        List<RowExpression> arguments = aggregation.getCall().getArguments();\n+        if (arguments.size() != 1) {\n+            return false;\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62fc19899ebb26212e1649ca5b6968ac5e04297c"}, "originalPosition": 90}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxOTYzNjMxOnYy", "diffSide": "RIGHT", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPushdownUtils.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwNzo0MzoxNlrOGDNNdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwNzo0MzoxNlrOGDNNdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjAxNTM1MA==", "bodyText": "break a line after this", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r406015350", "createdAt": "2020-04-09T07:43:16Z", "author": {"login": "highker"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPushdownUtils.java", "diffHunk": "@@ -163,6 +183,55 @@ public ExpressionType getExpressionType()\n         return nodeBuilder.build();\n     }\n \n+    /**\n+     * Try to push down query like: `SELECT count(distinct $COLUMN) FROM myTable` to Pinot as `SELECT distinctCount($COLUMN) FROM myTable`.\n+     * This function only handles the case of an AggregationNode (COUNT on $COLUMN) on top of an AggregationNode(of non-aggregate on $COLUMN).\n+     *\n+     * @param nodeBuilder\n+     * @param aggregationNode\n+     * @param outputColumn\n+     * @param aggregation\n+     * @return true if push down successfully otherwise false.\n+     */\n+    private static boolean handlePushDownSingleDistinctCount(ImmutableList.Builder<AggregationColumnNode> nodeBuilder, AggregationNode aggregationNode, VariableReferenceExpression outputColumn, AggregationNode.Aggregation aggregation)\n+    {\n+        if (!aggregation.getCall().getDisplayName().equalsIgnoreCase(COUNT_FUNCTION_NAME)) {\n+            return false;\n+        }\n+        List<RowExpression> arguments = aggregation.getCall().getArguments();\n+        if (arguments.size() != 1) {\n+            return false;\n+        }\n+        RowExpression aggregationArgument = arguments.get(0);\n+        // Handle the case of Count Aggregation on top of a Non-Agg GroupBy Aggregation.\n+        if (!(aggregationNode.getSource() instanceof AggregationNode)) {\n+            return false;\n+        }\n+        AggregationNode sourceAggregationNode = (AggregationNode) aggregationNode.getSource();\n+        Set<String> sourceAggregationGroupSet = getGroupKeys(sourceAggregationNode.getGroupingKeys());\n+        Set<String> aggregationGroupSet = getGroupKeys(aggregationNode.getGroupingKeys());\n+        aggregationGroupSet.add(aggregationArgument.toString());\n+        if (!sourceAggregationGroupSet.containsAll(aggregationGroupSet) && aggregationGroupSet.containsAll(sourceAggregationGroupSet)) {\n+            return false;\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62fc19899ebb26212e1649ca5b6968ac5e04297c"}, "originalPosition": 102}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxOTYzNzg4OnYy", "diffSide": "RIGHT", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPushdownUtils.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwNzo0Mzo0NVrOGDNOYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwNzo0Mzo0NVrOGDNOYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjAxNTU4NQ==", "bodyText": "private", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r406015585", "createdAt": "2020-04-09T07:43:45Z", "author": {"login": "highker"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPushdownUtils.java", "diffHunk": "@@ -163,6 +183,55 @@ public ExpressionType getExpressionType()\n         return nodeBuilder.build();\n     }\n \n+    /**\n+     * Try to push down query like: `SELECT count(distinct $COLUMN) FROM myTable` to Pinot as `SELECT distinctCount($COLUMN) FROM myTable`.\n+     * This function only handles the case of an AggregationNode (COUNT on $COLUMN) on top of an AggregationNode(of non-aggregate on $COLUMN).\n+     *\n+     * @param nodeBuilder\n+     * @param aggregationNode\n+     * @param outputColumn\n+     * @param aggregation\n+     * @return true if push down successfully otherwise false.\n+     */\n+    private static boolean handlePushDownSingleDistinctCount(ImmutableList.Builder<AggregationColumnNode> nodeBuilder, AggregationNode aggregationNode, VariableReferenceExpression outputColumn, AggregationNode.Aggregation aggregation)\n+    {\n+        if (!aggregation.getCall().getDisplayName().equalsIgnoreCase(COUNT_FUNCTION_NAME)) {\n+            return false;\n+        }\n+        List<RowExpression> arguments = aggregation.getCall().getArguments();\n+        if (arguments.size() != 1) {\n+            return false;\n+        }\n+        RowExpression aggregationArgument = arguments.get(0);\n+        // Handle the case of Count Aggregation on top of a Non-Agg GroupBy Aggregation.\n+        if (!(aggregationNode.getSource() instanceof AggregationNode)) {\n+            return false;\n+        }\n+        AggregationNode sourceAggregationNode = (AggregationNode) aggregationNode.getSource();\n+        Set<String> sourceAggregationGroupSet = getGroupKeys(sourceAggregationNode.getGroupingKeys());\n+        Set<String> aggregationGroupSet = getGroupKeys(aggregationNode.getGroupingKeys());\n+        aggregationGroupSet.add(aggregationArgument.toString());\n+        if (!sourceAggregationGroupSet.containsAll(aggregationGroupSet) && aggregationGroupSet.containsAll(sourceAggregationGroupSet)) {\n+            return false;\n+        }\n+        nodeBuilder.add(\n+                new AggregationFunctionColumnNode(\n+                        outputColumn,\n+                        new CallExpression(\n+                                PINOT_DISTINCT_COUNT_FUNCTION_NAME,\n+                                aggregation.getFunctionHandle(),\n+                                aggregation.getCall().getType(),\n+                                ImmutableList.of(aggregationArgument))));\n+        return true;\n+    }\n+\n+    public static Set<String> getGroupKeys(List<VariableReferenceExpression> groupingKeys)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62fc19899ebb26212e1649ca5b6968ac5e04297c"}, "originalPosition": 114}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxOTY0NjQ0OnYy", "diffSide": "RIGHT", "path": "presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/query/TestPinotQueryGenerator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwNzo0NjoyN1rOGDNTng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwNzo0NjoyN1rOGDNTng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjAxNjkyNg==", "bodyText": "rename function v to variable....", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r406016926", "createdAt": "2020-04-09T07:46:27Z", "author": {"login": "highker"}, "path": "presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/query/TestPinotQueryGenerator.java", "diffHunk": "@@ -131,6 +142,56 @@ public void testCountStar()\n         testUnaryAggregationHelper((planBuilder, aggregationBuilder) -> aggregationBuilder.addAggregation(planBuilder.variable(\"agg\"), getRowExpression(\"count(*)\", defaultSessionHolder)), \"count(*)\");\n     }\n \n+    @Test\n+    public void testDistinctCountPushdown()\n+    {\n+        PlanNode justScan = buildPlan(planBuilder -> tableScan(planBuilder, pinotTable, regionId, secondsSinceEpoch, city, fare));\n+        PlanNode distinctAggregation = buildPlan(planBuilder -> planBuilder.aggregation(aggBuilder -> aggBuilder.source(justScan).singleGroupingSet(v(\"regionid\"))));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62fc19899ebb26212e1649ca5b6968ac5e04297c"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxOTY0ODQ4OnYy", "diffSide": "RIGHT", "path": "presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/query/TestPinotQueryGenerator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwNzo0NzowM1rOGDNUzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwNzo0NzowM1rOGDNUzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjAxNzIyOQ==", "bodyText": "put one param per line and the first line without any param", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r406017229", "createdAt": "2020-04-09T07:47:03Z", "author": {"login": "highker"}, "path": "presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/query/TestPinotQueryGenerator.java", "diffHunk": "@@ -131,6 +142,56 @@ public void testCountStar()\n         testUnaryAggregationHelper((planBuilder, aggregationBuilder) -> aggregationBuilder.addAggregation(planBuilder.variable(\"agg\"), getRowExpression(\"count(*)\", defaultSessionHolder)), \"count(*)\");\n     }\n \n+    @Test\n+    public void testDistinctCountPushdown()\n+    {\n+        PlanNode justScan = buildPlan(planBuilder -> tableScan(planBuilder, pinotTable, regionId, secondsSinceEpoch, city, fare));\n+        PlanNode distinctAggregation = buildPlan(planBuilder -> planBuilder.aggregation(aggBuilder -> aggBuilder.source(justScan).singleGroupingSet(v(\"regionid\"))));\n+        testPQL(planBuilder -> planBuilder.aggregation(aggBuilder -> aggBuilder.source(distinctAggregation).globalGrouping().addAggregation(v(\"count_regionid\"), getRowExpression(\"count(regionid)\", defaultSessionHolder))),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62fc19899ebb26212e1649ca5b6968ac5e04297c"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxOTY0ODY2OnYy", "diffSide": "RIGHT", "path": "presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/query/TestPinotQueryGenerator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwNzo0NzowN1rOGDNU6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwNzo0NzowN1rOGDNU6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjAxNzI1OA==", "bodyText": "put one param per line and the first line without any param", "url": "https://github.com/prestodb/presto/pull/14341#discussion_r406017258", "createdAt": "2020-04-09T07:47:07Z", "author": {"login": "highker"}, "path": "presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/query/TestPinotQueryGenerator.java", "diffHunk": "@@ -131,6 +142,56 @@ public void testCountStar()\n         testUnaryAggregationHelper((planBuilder, aggregationBuilder) -> aggregationBuilder.addAggregation(planBuilder.variable(\"agg\"), getRowExpression(\"count(*)\", defaultSessionHolder)), \"count(*)\");\n     }\n \n+    @Test\n+    public void testDistinctCountPushdown()\n+    {\n+        PlanNode justScan = buildPlan(planBuilder -> tableScan(planBuilder, pinotTable, regionId, secondsSinceEpoch, city, fare));\n+        PlanNode distinctAggregation = buildPlan(planBuilder -> planBuilder.aggregation(aggBuilder -> aggBuilder.source(justScan).singleGroupingSet(v(\"regionid\"))));\n+        testPQL(planBuilder -> planBuilder.aggregation(aggBuilder -> aggBuilder.source(distinctAggregation).globalGrouping().addAggregation(v(\"count_regionid\"), getRowExpression(\"count(regionid)\", defaultSessionHolder))),\n+                \"SELECT DISTINCTCOUNT(regionId) FROM realtimeOnly\");\n+    }\n+\n+    @Test\n+    public void testDistinctCountGroupByPushdown()\n+    {\n+        PlanNode justScan = buildPlan(planBuilder -> tableScan(planBuilder, pinotTable, regionId, secondsSinceEpoch, city, fare));\n+        PlanNode distinctAggregation = buildPlan(planBuilder -> planBuilder.aggregation(aggBuilder -> aggBuilder.source(justScan).singleGroupingSet(v(\"city\"), v(\"regionid\"))));\n+        testPQL(planBuilder -> planBuilder.aggregation(aggBuilder -> aggBuilder.source(distinctAggregation).singleGroupingSet(v(\"city\")).addAggregation(v(\"count_regionid\"), getRowExpression(\"count(regionid)\", defaultSessionHolder))),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62fc19899ebb26212e1649ca5b6968ac5e04297c"}, "originalPosition": 43}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2748, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}