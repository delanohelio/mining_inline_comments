{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU1OTAzMTUy", "number": 14879, "title": "Fix infinite loop in non-legacy SqlQueryScheduler", "bodyText": "Queries that don't have table scan inputs could enter an infinite loop inthe scheduler if they hit the queryStateMachine.isDone() check and had any sections ready for execution. If the query is done (e.g. canceled or abandoned at this point), we abort the section.  Since \"aborted\" is a failed state, the section would continue to be considered \"ready for execution\"  in our next time through, and the loop would continue indefinitely. We need to explicitly exit the scheduling loop if the query is finished.\nQueries with inputs didn't have this issue because the split scheduler would be closed when the query finished, so the scheduler would hit an error when it tried to create the scheduler for the scan stages.\nI don't have a test because I was only able to reproduce the issue by explicitly calling queryStateMachine.transitionToFailed() here so we would enter the if statement.  Recommendations about how to test this are appreciated.\n== RELEASE NOTES ==\nGeneral Changes\n* Fix potential infinite loop when the setting ``use_legacy_scheduler`` is set to false.", "createdAt": "2020-07-23T19:13:22Z", "url": "https://github.com/prestodb/presto/pull/14879", "merged": true, "mergeCommit": {"oid": "23082e899e62049d09e51a5e80b67cba221444f4"}, "closed": true, "closedAt": "2020-07-27T13:59:47Z", "author": {"login": "rschlussel"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3z6OEAH2gAyNDU1OTAzMTUyOjZhZTEwNTI0ZTIyNTM2NjVkMDlkMzA3ZTkwMjJiZGRmMTgwNGNmMjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc344B6AFqTQ1NDU3ODE2OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6ae10524e2253665d09d307e9022bddf1804cf27", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/6ae10524e2253665d09d307e9022bddf1804cf27", "committedDate": "2020-07-23T18:40:40Z", "message": "Remove extra new line"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2004eda98d4186cdf40b7405a1f26b4f08aa9f39", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/2004eda98d4186cdf40b7405a1f26b4f08aa9f39", "committedDate": "2020-07-23T18:58:49Z", "message": "Fix infinite loop in scheduler for finished query\n\nQueries that don't have table scan inputs could enter an infinite loop in\nthe scheduler if they hit the queryStateMachine.isDone() check and had any\nsections ready for execution. If the query is done (e.g. canceled or\nabandoned at this point), we abort the section.  Since \"aborted\" is\na failed state, the section would continue to be considered \"ready for\nexecution\"  in our next time through, and the loop would continue indefitely.\nWe need to explicitly exit the scheduling loop if the query is finished.\n\nQueries with inputs didn't have this issue because the split scheduler\nwould be closed when the query finished, so the scheduler would hit an\nerror when it tried to create the scheduler for the scan stages."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0NTc4MTEy", "url": "https://github.com/prestodb/presto/pull/14879#pullrequestreview-454578112", "createdAt": "2020-07-24T00:27:36Z", "commit": {"oid": "2004eda98d4186cdf40b7405a1f26b4f08aa9f39"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwMDoyNzozNlrOG2f5Dg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwMDoyNzozNlrOG2f5Dg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc5ODc5OA==", "bodyText": "I assume if we clean up executionSchedules list here, we should also be able to break the loop via the condition form 276-278? :)", "url": "https://github.com/prestodb/presto/pull/14879#discussion_r459798798", "createdAt": "2020-07-24T00:27:36Z", "author": {"login": "wenleix"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/scheduler/SqlQueryScheduler.java", "diffHunk": "@@ -284,6 +283,7 @@ private void schedule()\n                         .collect(toImmutableList()));\n                 if (queryStateMachine.isDone()) {\n                     sectionExecutions.forEach(SectionExecution::abort);\n+                    break;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2004eda98d4186cdf40b7405a1f26b4f08aa9f39"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0NTc4MTY5", "url": "https://github.com/prestodb/presto/pull/14879#pullrequestreview-454578169", "createdAt": "2020-07-24T00:27:48Z", "commit": {"oid": "2004eda98d4186cdf40b7405a1f26b4f08aa9f39"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 308, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}