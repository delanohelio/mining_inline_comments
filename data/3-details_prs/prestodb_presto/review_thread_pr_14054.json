{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcwNTM3NjU0", "number": 14054, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QyMjoyMTo0OFrODcy9Lw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwNDowMzozNlrODfaSKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxNTIxNTgzOnYy", "diffSide": "RIGHT", "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/checksum/MapColumnValidator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QyMjoyMTo0OFrOFlCCiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QyMjoyMTo0OFrOFlCCiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM3NTA1MQ==", "bodyText": "This doesn't seem right. I think we need to have multiple columns here, e.g. checksum(m), checksum(array_sort(map_keys(m))) and checksum(array_sort(map_values(m)))", "url": "https://github.com/prestodb/presto/pull/14054#discussion_r374375051", "createdAt": "2020-02-03T22:21:48Z", "author": {"login": "mbasmanova"}, "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/checksum/MapColumnValidator.java", "diffHunk": "@@ -0,0 +1,108 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.verifier.checksum;\n+\n+import com.facebook.presto.spi.type.MapType;\n+import com.facebook.presto.spi.type.Type;\n+import com.facebook.presto.sql.tree.CoalesceExpression;\n+import com.facebook.presto.sql.tree.Expression;\n+import com.facebook.presto.sql.tree.FunctionCall;\n+import com.facebook.presto.sql.tree.LongLiteral;\n+import com.facebook.presto.sql.tree.QualifiedName;\n+import com.facebook.presto.sql.tree.SingleColumn;\n+import com.facebook.presto.verifier.framework.Column;\n+import com.google.common.collect.ImmutableList;\n+\n+import javax.inject.Inject;\n+\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.verifier.framework.VerifierUtil.delimitedIdentifier;\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.lang.String.format;\n+\n+public class MapColumnValidator\n+        implements ColumnValidator\n+{\n+    @Inject\n+    public MapColumnValidator()\n+    {\n+    }\n+\n+    @Override\n+    public List<SingleColumn> generateChecksumColumns(Column column)\n+    {\n+        checkArgument(column.getType() instanceof MapType, \"Expect MapType, found %s\", column.getType().getDisplayName());\n+        Type keyType = ((MapType) column.getType()).getKeyType();\n+        Type valueType = ((MapType) column.getType()).getValueType();\n+\n+        ImmutableList.Builder<Expression> checksums = ImmutableList.builder();\n+        checksums.add(new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier())));\n+\n+        Expression mapCardinalitySum = new CoalesceExpression(\n+                new FunctionCall(\n+                        QualifiedName.of(\"sum\"),\n+                        ImmutableList.of(new FunctionCall(QualifiedName.of(\"cardinality\"), ImmutableList.of(column.getIdentifier())))),\n+                new LongLiteral(\"0\"));\n+\n+        if (keyType.isOrderable()) {\n+            FunctionCall mapKeys = new FunctionCall(QualifiedName.of(\"map_keys\"), ImmutableList.of(column.getIdentifier()));\n+            FunctionCall sortKeys = new FunctionCall(QualifiedName.of(\"array_sort\"), ImmutableList.of(mapKeys));\n+            checksums.add(new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(sortKeys)));\n+        }\n+\n+        if (valueType.isOrderable()) {\n+            FunctionCall mapValues = new FunctionCall(QualifiedName.of(\"map_values\"), ImmutableList.of(column.getIdentifier()));\n+            FunctionCall sortValues = new FunctionCall(QualifiedName.of(\"array_sort\"), ImmutableList.of(mapValues));\n+            checksums.add(new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(sortValues)));\n+        }\n+\n+        return ImmutableList.of(\n+                new SingleColumn(new CoalesceExpression(checksums.build()), Optional.of(delimitedIdentifier(getChecksumColumnAlias(column)))),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a80129143eb365ef0d5c8a8111dd625d629927a0"}, "originalPosition": 74}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxNTIxNjc1OnYy", "diffSide": "RIGHT", "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/checksum/MapColumnValidator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QyMjoyMjoxMlrOFlCDJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QyMjoyMjoxMlrOFlCDJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM3NTIwNA==", "bodyText": "Shouldn't there be separate checksums for keys and values?", "url": "https://github.com/prestodb/presto/pull/14054#discussion_r374375204", "createdAt": "2020-02-03T22:22:12Z", "author": {"login": "mbasmanova"}, "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/checksum/MapColumnValidator.java", "diffHunk": "@@ -0,0 +1,108 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.verifier.checksum;\n+\n+import com.facebook.presto.spi.type.MapType;\n+import com.facebook.presto.spi.type.Type;\n+import com.facebook.presto.sql.tree.CoalesceExpression;\n+import com.facebook.presto.sql.tree.Expression;\n+import com.facebook.presto.sql.tree.FunctionCall;\n+import com.facebook.presto.sql.tree.LongLiteral;\n+import com.facebook.presto.sql.tree.QualifiedName;\n+import com.facebook.presto.sql.tree.SingleColumn;\n+import com.facebook.presto.verifier.framework.Column;\n+import com.google.common.collect.ImmutableList;\n+\n+import javax.inject.Inject;\n+\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.verifier.framework.VerifierUtil.delimitedIdentifier;\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.lang.String.format;\n+\n+public class MapColumnValidator\n+        implements ColumnValidator\n+{\n+    @Inject\n+    public MapColumnValidator()\n+    {\n+    }\n+\n+    @Override\n+    public List<SingleColumn> generateChecksumColumns(Column column)\n+    {\n+        checkArgument(column.getType() instanceof MapType, \"Expect MapType, found %s\", column.getType().getDisplayName());\n+        Type keyType = ((MapType) column.getType()).getKeyType();\n+        Type valueType = ((MapType) column.getType()).getValueType();\n+\n+        ImmutableList.Builder<Expression> checksums = ImmutableList.builder();\n+        checksums.add(new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier())));\n+\n+        Expression mapCardinalitySum = new CoalesceExpression(\n+                new FunctionCall(\n+                        QualifiedName.of(\"sum\"),\n+                        ImmutableList.of(new FunctionCall(QualifiedName.of(\"cardinality\"), ImmutableList.of(column.getIdentifier())))),\n+                new LongLiteral(\"0\"));\n+\n+        if (keyType.isOrderable()) {\n+            FunctionCall mapKeys = new FunctionCall(QualifiedName.of(\"map_keys\"), ImmutableList.of(column.getIdentifier()));\n+            FunctionCall sortKeys = new FunctionCall(QualifiedName.of(\"array_sort\"), ImmutableList.of(mapKeys));\n+            checksums.add(new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(sortKeys)));\n+        }\n+\n+        if (valueType.isOrderable()) {\n+            FunctionCall mapValues = new FunctionCall(QualifiedName.of(\"map_values\"), ImmutableList.of(column.getIdentifier()));\n+            FunctionCall sortValues = new FunctionCall(QualifiedName.of(\"array_sort\"), ImmutableList.of(mapValues));\n+            checksums.add(new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(sortValues)));\n+        }\n+\n+        return ImmutableList.of(\n+                new SingleColumn(new CoalesceExpression(checksums.build()), Optional.of(delimitedIdentifier(getChecksumColumnAlias(column)))),\n+                new SingleColumn(mapCardinalitySum, Optional.of(delimitedIdentifier(getCardinalitySumColumnAlias(column)))));\n+    }\n+\n+    @Override\n+    public ColumnMatchResult validate(Column column, ChecksumResult controlResult, ChecksumResult testResult)\n+    {\n+        String checksumColumnAlias = getChecksumColumnAlias(column);\n+        Object controlChecksum = controlResult.getChecksum(checksumColumnAlias);\n+        Object testChecksum = testResult.getChecksum(checksumColumnAlias);\n+\n+        String cardinalitySumColumnAlias = getCardinalitySumColumnAlias(column);\n+        Object controlCardinalitySum = controlResult.getChecksum(cardinalitySumColumnAlias);\n+        Object testCardinalitySum = testResult.getChecksum(cardinalitySumColumnAlias);\n+\n+        return new ColumnMatchResult(\n+                Objects.equals(controlChecksum, testChecksum) && Objects.equals(controlCardinalitySum, testCardinalitySum),\n+                format(\n+                        \"control(checksum: %s, cardinality_sum: %s) test(checksum: %s, cardinality_sum: %s)\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a80129143eb365ef0d5c8a8111dd625d629927a0"}, "originalPosition": 92}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMyMjIyOTYzOnYy", "diffSide": "RIGHT", "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/checksum/MapColumnValidator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQyMDowNToyMVrOFmFecA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQyMDowNToyMVrOFmFecA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQ3OTkyMA==", "bodyText": "typo: value", "url": "https://github.com/prestodb/presto/pull/14054#discussion_r375479920", "createdAt": "2020-02-05T20:05:21Z", "author": {"login": "caithagoras"}, "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/checksum/MapColumnValidator.java", "diffHunk": "@@ -0,0 +1,140 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.verifier.checksum;\n+\n+import com.facebook.presto.spi.type.MapType;\n+import com.facebook.presto.spi.type.Type;\n+import com.facebook.presto.sql.tree.CoalesceExpression;\n+import com.facebook.presto.sql.tree.Expression;\n+import com.facebook.presto.sql.tree.FunctionCall;\n+import com.facebook.presto.sql.tree.LongLiteral;\n+import com.facebook.presto.sql.tree.QualifiedName;\n+import com.facebook.presto.sql.tree.SingleColumn;\n+import com.facebook.presto.verifier.framework.Column;\n+import com.google.common.collect.ImmutableList;\n+\n+import javax.inject.Inject;\n+\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.verifier.framework.VerifierUtil.delimitedIdentifier;\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.lang.String.format;\n+\n+public class MapColumnValidator\n+        implements ColumnValidator\n+{\n+    @Inject\n+    public MapColumnValidator()\n+    {\n+    }\n+\n+    @Override\n+    public List<SingleColumn> generateChecksumColumns(Column column)\n+    {\n+        checkArgument(column.getType() instanceof MapType, \"Expect MapType, found %s\", column.getType().getDisplayName());\n+        Type keyType = ((MapType) column.getType()).getKeyType();\n+        Type valueType = ((MapType) column.getType()).getValueType();\n+\n+        Expression checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier()));\n+\n+        Expression keysChecksum;\n+        FunctionCall mapKeys = new FunctionCall(QualifiedName.of(\"map_keys\"), ImmutableList.of(column.getIdentifier()));\n+        if (keyType.isOrderable()) {\n+            FunctionCall sortKeys = new FunctionCall(QualifiedName.of(\"array_sort\"), ImmutableList.of(mapKeys));\n+            keysChecksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(sortKeys));\n+        }\n+        else {\n+            keysChecksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(mapKeys));\n+        }\n+\n+        Expression valuesChecksum;\n+        FunctionCall mapValues = new FunctionCall(QualifiedName.of(\"map_values\"), ImmutableList.of(column.getIdentifier()));\n+        if (valueType.isOrderable()) {\n+            FunctionCall sortValues = new FunctionCall(QualifiedName.of(\"array_sort\"), ImmutableList.of(mapValues));\n+            valuesChecksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(sortValues));\n+        }\n+        else {\n+            valuesChecksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(mapValues));\n+        }\n+\n+        Expression mapCardinalitySum = new CoalesceExpression(\n+                new FunctionCall(\n+                        QualifiedName.of(\"sum\"),\n+                        ImmutableList.of(new FunctionCall(QualifiedName.of(\"cardinality\"), ImmutableList.of(column.getIdentifier())))),\n+                new LongLiteral(\"0\"));\n+\n+        return ImmutableList.of(\n+                new SingleColumn(checksum, Optional.of(delimitedIdentifier(getChecksumColumnAlias(column)))),\n+                new SingleColumn(keysChecksum, Optional.of(delimitedIdentifier(getKeysChecksumColumnAlias(column)))),\n+                new SingleColumn(valuesChecksum, Optional.of(delimitedIdentifier(getValuesChecksumColumnAlias(column)))),\n+                new SingleColumn(mapCardinalitySum, Optional.of(delimitedIdentifier(getCardinalitySumColumnAlias(column)))));\n+    }\n+\n+    @Override\n+    public ColumnMatchResult validate(Column column, ChecksumResult controlResult, ChecksumResult testResult)\n+    {\n+        String checksumColumnAlias = getChecksumColumnAlias(column);\n+        Object controlChecksum = controlResult.getChecksum(checksumColumnAlias);\n+        Object testChecksum = testResult.getChecksum(checksumColumnAlias);\n+\n+        String keysChecksumColumnAlias = getKeysChecksumColumnAlias(column);\n+        Object controlKeysChecksum = controlResult.getChecksum(keysChecksumColumnAlias);\n+        Object testKeysChecksum = testResult.getChecksum(keysChecksumColumnAlias);\n+\n+        String valuesChecksumColumnAlias = getValuesChecksumColumnAlias(column);\n+        Object controlValuesChecksum = controlResult.getChecksum(valuesChecksumColumnAlias);\n+        Object testValuesChecksum = testResult.getChecksum(valuesChecksumColumnAlias);\n+\n+        String cardinalitySumColumnAlias = getCardinalitySumColumnAlias(column);\n+        Object controlCardinalitySum = controlResult.getChecksum(cardinalitySumColumnAlias);\n+        Object testCardinalitySum = testResult.getChecksum(cardinalitySumColumnAlias);\n+\n+        return new ColumnMatchResult(\n+                Objects.equals(controlChecksum, testChecksum) && Objects.equals(controlCardinalitySum, testCardinalitySum),\n+                format(\n+                        \"control(checksum: %s, keys_checksum: %s, alues_checksum: %s, cardinality_sum: %s) \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7a519d9f9153feb5349e185b8e73524ff8ec56b"}, "originalPosition": 109}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMyMjIzODU1OnYy", "diffSide": "RIGHT", "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/checksum/MapColumnValidator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQyMDowODozOFrOFmFkEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQyMDowODozOFrOFmFkEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQ4MTM2Mw==", "bodyText": "Can be simplified as, as below\nFunctionCall keys = ...\nif (keyType.isOrderable()) {\n   keys = ...\n}\nExpression keysChecksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(keys));", "url": "https://github.com/prestodb/presto/pull/14054#discussion_r375481363", "createdAt": "2020-02-05T20:08:38Z", "author": {"login": "caithagoras"}, "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/checksum/MapColumnValidator.java", "diffHunk": "@@ -0,0 +1,140 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.verifier.checksum;\n+\n+import com.facebook.presto.spi.type.MapType;\n+import com.facebook.presto.spi.type.Type;\n+import com.facebook.presto.sql.tree.CoalesceExpression;\n+import com.facebook.presto.sql.tree.Expression;\n+import com.facebook.presto.sql.tree.FunctionCall;\n+import com.facebook.presto.sql.tree.LongLiteral;\n+import com.facebook.presto.sql.tree.QualifiedName;\n+import com.facebook.presto.sql.tree.SingleColumn;\n+import com.facebook.presto.verifier.framework.Column;\n+import com.google.common.collect.ImmutableList;\n+\n+import javax.inject.Inject;\n+\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.verifier.framework.VerifierUtil.delimitedIdentifier;\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.lang.String.format;\n+\n+public class MapColumnValidator\n+        implements ColumnValidator\n+{\n+    @Inject\n+    public MapColumnValidator()\n+    {\n+    }\n+\n+    @Override\n+    public List<SingleColumn> generateChecksumColumns(Column column)\n+    {\n+        checkArgument(column.getType() instanceof MapType, \"Expect MapType, found %s\", column.getType().getDisplayName());\n+        Type keyType = ((MapType) column.getType()).getKeyType();\n+        Type valueType = ((MapType) column.getType()).getValueType();\n+\n+        Expression checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier()));\n+\n+        Expression keysChecksum;\n+        FunctionCall mapKeys = new FunctionCall(QualifiedName.of(\"map_keys\"), ImmutableList.of(column.getIdentifier()));\n+        if (keyType.isOrderable()) {\n+            FunctionCall sortKeys = new FunctionCall(QualifiedName.of(\"array_sort\"), ImmutableList.of(mapKeys));\n+            keysChecksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(sortKeys));\n+        }\n+        else {\n+            keysChecksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(mapKeys));\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7a519d9f9153feb5349e185b8e73524ff8ec56b"}, "originalPosition": 62}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMyMjI0OTExOnYy", "diffSide": "RIGHT", "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/checksum/MapColumnValidator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQyMDoxMjowOFrOFmFqWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQyMDoxMjowOFrOFmFqWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQ4Mjk3MA==", "bodyText": "Also make sure key checksum matches and and value checksum matches.\nnit: one condition per line for long line:\nObject.equals(...)\n    && Object.equals(...)\n    && Object.equals(...)\n    && Object.equals(...)", "url": "https://github.com/prestodb/presto/pull/14054#discussion_r375482970", "createdAt": "2020-02-05T20:12:08Z", "author": {"login": "caithagoras"}, "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/checksum/MapColumnValidator.java", "diffHunk": "@@ -0,0 +1,140 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.verifier.checksum;\n+\n+import com.facebook.presto.spi.type.MapType;\n+import com.facebook.presto.spi.type.Type;\n+import com.facebook.presto.sql.tree.CoalesceExpression;\n+import com.facebook.presto.sql.tree.Expression;\n+import com.facebook.presto.sql.tree.FunctionCall;\n+import com.facebook.presto.sql.tree.LongLiteral;\n+import com.facebook.presto.sql.tree.QualifiedName;\n+import com.facebook.presto.sql.tree.SingleColumn;\n+import com.facebook.presto.verifier.framework.Column;\n+import com.google.common.collect.ImmutableList;\n+\n+import javax.inject.Inject;\n+\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.verifier.framework.VerifierUtil.delimitedIdentifier;\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.lang.String.format;\n+\n+public class MapColumnValidator\n+        implements ColumnValidator\n+{\n+    @Inject\n+    public MapColumnValidator()\n+    {\n+    }\n+\n+    @Override\n+    public List<SingleColumn> generateChecksumColumns(Column column)\n+    {\n+        checkArgument(column.getType() instanceof MapType, \"Expect MapType, found %s\", column.getType().getDisplayName());\n+        Type keyType = ((MapType) column.getType()).getKeyType();\n+        Type valueType = ((MapType) column.getType()).getValueType();\n+\n+        Expression checksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(column.getIdentifier()));\n+\n+        Expression keysChecksum;\n+        FunctionCall mapKeys = new FunctionCall(QualifiedName.of(\"map_keys\"), ImmutableList.of(column.getIdentifier()));\n+        if (keyType.isOrderable()) {\n+            FunctionCall sortKeys = new FunctionCall(QualifiedName.of(\"array_sort\"), ImmutableList.of(mapKeys));\n+            keysChecksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(sortKeys));\n+        }\n+        else {\n+            keysChecksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(mapKeys));\n+        }\n+\n+        Expression valuesChecksum;\n+        FunctionCall mapValues = new FunctionCall(QualifiedName.of(\"map_values\"), ImmutableList.of(column.getIdentifier()));\n+        if (valueType.isOrderable()) {\n+            FunctionCall sortValues = new FunctionCall(QualifiedName.of(\"array_sort\"), ImmutableList.of(mapValues));\n+            valuesChecksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(sortValues));\n+        }\n+        else {\n+            valuesChecksum = new FunctionCall(QualifiedName.of(\"checksum\"), ImmutableList.of(mapValues));\n+        }\n+\n+        Expression mapCardinalitySum = new CoalesceExpression(\n+                new FunctionCall(\n+                        QualifiedName.of(\"sum\"),\n+                        ImmutableList.of(new FunctionCall(QualifiedName.of(\"cardinality\"), ImmutableList.of(column.getIdentifier())))),\n+                new LongLiteral(\"0\"));\n+\n+        return ImmutableList.of(\n+                new SingleColumn(checksum, Optional.of(delimitedIdentifier(getChecksumColumnAlias(column)))),\n+                new SingleColumn(keysChecksum, Optional.of(delimitedIdentifier(getKeysChecksumColumnAlias(column)))),\n+                new SingleColumn(valuesChecksum, Optional.of(delimitedIdentifier(getValuesChecksumColumnAlias(column)))),\n+                new SingleColumn(mapCardinalitySum, Optional.of(delimitedIdentifier(getCardinalitySumColumnAlias(column)))));\n+    }\n+\n+    @Override\n+    public ColumnMatchResult validate(Column column, ChecksumResult controlResult, ChecksumResult testResult)\n+    {\n+        String checksumColumnAlias = getChecksumColumnAlias(column);\n+        Object controlChecksum = controlResult.getChecksum(checksumColumnAlias);\n+        Object testChecksum = testResult.getChecksum(checksumColumnAlias);\n+\n+        String keysChecksumColumnAlias = getKeysChecksumColumnAlias(column);\n+        Object controlKeysChecksum = controlResult.getChecksum(keysChecksumColumnAlias);\n+        Object testKeysChecksum = testResult.getChecksum(keysChecksumColumnAlias);\n+\n+        String valuesChecksumColumnAlias = getValuesChecksumColumnAlias(column);\n+        Object controlValuesChecksum = controlResult.getChecksum(valuesChecksumColumnAlias);\n+        Object testValuesChecksum = testResult.getChecksum(valuesChecksumColumnAlias);\n+\n+        String cardinalitySumColumnAlias = getCardinalitySumColumnAlias(column);\n+        Object controlCardinalitySum = controlResult.getChecksum(cardinalitySumColumnAlias);\n+        Object testCardinalitySum = testResult.getChecksum(cardinalitySumColumnAlias);\n+\n+        return new ColumnMatchResult(\n+                Objects.equals(controlChecksum, testChecksum) && Objects.equals(controlCardinalitySum, testCardinalitySum),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7a519d9f9153feb5349e185b8e73524ff8ec56b"}, "originalPosition": 107}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMyMjY0NDAyOnYy", "diffSide": "RIGHT", "path": "presto-verifier/src/test/java/com/facebook/presto/verifier/checksum/TestChecksumValidator.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQyMjozMTozOFrOFmJdwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQyMjozMTozOFrOFmJdwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU0NTI4Mg==", "bodyText": "Your formatting is off. Please follow 7e and 7f  in https://our.internmc.facebook.com/intern/wiki/DataInfra/Presto/Source/\nto install Airlift code style, and then format the file with (option + cmd + L).", "url": "https://github.com/prestodb/presto/pull/14054#discussion_r375545282", "createdAt": "2020-02-05T22:31:38Z", "author": {"login": "caithagoras"}, "path": "presto-verifier/src/test/java/com/facebook/presto/verifier/checksum/TestChecksumValidator.java", "diffHunk": "@@ -297,9 +304,9 @@ public void testArray()\n         ChecksumResult controlChecksum = new ChecksumResult(\n                 5,\n                 ImmutableMap.<String, Object>builder()\n-                        .put(\"int_array_checksum\", new SqlVarbinary(new byte[] {0xa}))\n+                        .put(\"int_array_checksum\", new SqlVarbinary(new byte[]{0xa}))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3dfe36c5e4b016c2b0ac1877e41ab82f04d46550"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMyMjY1NDEwOnYy", "diffSide": "RIGHT", "path": "presto-verifier/src/test/java/com/facebook/presto/verifier/checksum/TestChecksumValidator.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQyMjozNTo1NFrOFmJkAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQyMjozNTo1NFrOFmJkAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU0Njg4Mw==", "bodyText": "nit: all arguments on the same line, or one argument per line. Same below.", "url": "https://github.com/prestodb/presto/pull/14054#discussion_r375546883", "createdAt": "2020-02-05T22:35:54Z", "author": {"login": "caithagoras"}, "path": "presto-verifier/src/test/java/com/facebook/presto/verifier/checksum/TestChecksumValidator.java", "diffHunk": "@@ -387,4 +394,70 @@ public void testRow()\n                         .put(ROW_COLUMN, new ColumnMatchResult(false, \"control(row_checksum: 0a, row$$col3_checksum: 0d) test(row_checksum: 1a, row$$col3_checksum: 1d)\"))\n                         .build());\n     }\n+\n+    @Test\n+    public void testMap()\n+    {\n+        List<Column> columns = ImmutableList.of(MAP_COLUMN);\n+\n+        ChecksumResult controlChecksum = new ChecksumResult(\n+                5,\n+                ImmutableMap.<String, Object>builder()\n+                        .put(\"map_checksum\", new SqlVarbinary(new byte[] {0xa}))\n+                        .put(\"map_keys_checksum\", new SqlVarbinary(new byte[] {0xb}))\n+                        .put(\"map_values_checksum\", new SqlVarbinary(new byte[] {0xc}))\n+                        .put(\"map_cardinality_sum\", 3L)\n+                        .build());\n+\n+        // Matched\n+        assertTrue(checksumValidator.getMismatchedColumns(columns, controlChecksum, controlChecksum).isEmpty());\n+\n+        // Mismatched map checksum\n+        ChecksumResult testChecksum = new ChecksumResult(\n+                5,\n+                ImmutableMap.<String, Object>builder()\n+                        .put(\"map_checksum\", new SqlVarbinary(new byte[]{0x1a}))\n+                        .put(\"map_keys_checksum\", new SqlVarbinary(new byte[]{0x0b}))\n+                        .put(\"map_values_checksum\", new SqlVarbinary(new byte[]{0x0c}))\n+                        .put(\"map_cardinality_sum\", 3L)\n+                        .build());\n+        assertEquals(\n+                checksumValidator.getMismatchedColumns(columns, controlChecksum, testChecksum),\n+                ImmutableMap.builder()\n+                        .put(MAP_COLUMN, new ColumnMatchResult(false, \"control(checksum: 0a, keys_checksum: 0b, values_checksum: 0c, cardinality_sum: 3) \" +\n+                                \"test(checksum: 1a, keys_checksum: 0b, values_checksum: 0c, cardinality_sum: 3)\"))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3dfe36c5e4b016c2b0ac1877e41ab82f04d46550"}, "originalPosition": 106}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM0MjYyOTczOnYy", "diffSide": "RIGHT", "path": "presto-verifier/src/test/java/com/facebook/presto/verifier/checksum/TestChecksumValidator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwNDowMjo1NVrOFpGaBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwNDowMjo1NVrOFpGaBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODY0MDkwMw==", "bodyText": "You can combine those mismatched cases into one.\nAlso, add a test case where the key/value are not orderable and hence the array_sort function call is not used.", "url": "https://github.com/prestodb/presto/pull/14054#discussion_r378640903", "createdAt": "2020-02-13T04:02:55Z", "author": {"login": "caithagoras"}, "path": "presto-verifier/src/test/java/com/facebook/presto/verifier/checksum/TestChecksumValidator.java", "diffHunk": "@@ -387,6 +393,78 @@ public void testRow()\n                         .build());\n     }\n \n+    @Test\n+    public void testMap()\n+    {\n+        List<Column> columns = ImmutableList.of(MAP_COLUMN);\n+\n+        ChecksumResult controlChecksum = new ChecksumResult(\n+                5,\n+                ImmutableMap.<String, Object>builder()\n+                        .put(\"map_checksum\", new SqlVarbinary(new byte[] {0xa}))\n+                        .put(\"map_keys_checksum\", new SqlVarbinary(new byte[] {0xb}))\n+                        .put(\"map_values_checksum\", new SqlVarbinary(new byte[] {0xc}))\n+                        .put(\"map_cardinality_sum\", 3L)\n+                        .build());\n+\n+        // Matched\n+        assertTrue(checksumValidator.getMismatchedColumns(columns, controlChecksum, controlChecksum).isEmpty());\n+\n+        // Mismatched map checksum\n+        ChecksumResult testChecksum = new ChecksumResult(\n+                5,\n+                ImmutableMap.<String, Object>builder()\n+                        .put(\"map_checksum\", new SqlVarbinary(new byte[] {0x1a}))\n+                        .put(\"map_keys_checksum\", new SqlVarbinary(new byte[] {0x0b}))\n+                        .put(\"map_values_checksum\", new SqlVarbinary(new byte[] {0x0c}))\n+                        .put(\"map_cardinality_sum\", 3L)\n+                        .build());\n+\n+        String expectedOutput = \"control(checksum: 0a, keys_checksum: 0b, values_checksum: 0c, cardinality_sum: 3) \" +\n+                \"test(checksum: 1a, keys_checksum: 0b, values_checksum: 0c, cardinality_sum: 3)\";\n+        assertEquals(\n+                checksumValidator.getMismatchedColumns(columns, controlChecksum, testChecksum),\n+                ImmutableMap.builder()\n+                        .put(MAP_COLUMN, new ColumnMatchResult(false, MAP_COLUMN, expectedOutput))\n+                        .build());\n+\n+        // Mismatched map keys & values checksum\n+        testChecksum = new ChecksumResult(\n+                5,\n+                ImmutableMap.<String, Object>builder()\n+                        .put(\"map_checksum\", new SqlVarbinary(new byte[] {0x0a}))\n+                        .put(\"map_keys_checksum\", new SqlVarbinary(new byte[] {0x1b}))\n+                        .put(\"map_values_checksum\", new SqlVarbinary(new byte[] {0x1c}))\n+                        .put(\"map_cardinality_sum\", 3L)\n+                        .build());\n+\n+        expectedOutput = \"control(checksum: 0a, keys_checksum: 0b, values_checksum: 0c, cardinality_sum: 3) \" +\n+                \"test(checksum: 0a, keys_checksum: 1b, values_checksum: 1c, cardinality_sum: 3)\";\n+        assertEquals(\n+                checksumValidator.getMismatchedColumns(columns, controlChecksum, testChecksum),\n+                ImmutableMap.builder()\n+                        .put(MAP_COLUMN, new ColumnMatchResult(false, MAP_COLUMN, expectedOutput))\n+                        .build());\n+\n+        // Mismatched map cardinality sum\n+        testChecksum = new ChecksumResult(\n+                5,\n+                ImmutableMap.<String, Object>builder()\n+                        .put(\"map_checksum\", new SqlVarbinary(new byte[] {0x0a}))\n+                        .put(\"map_keys_checksum\", new SqlVarbinary(new byte[] {0x0b}))\n+                        .put(\"map_values_checksum\", new SqlVarbinary(new byte[] {0x0c}))\n+                        .put(\"map_cardinality_sum\", 4L)\n+                        .build());\n+\n+        expectedOutput = \"control(checksum: 0a, keys_checksum: 0b, values_checksum: 0c, cardinality_sum: 3) \" +\n+                \"test(checksum: 0a, keys_checksum: 0b, values_checksum: 0c, cardinality_sum: 4)\";\n+        assertEquals(\n+                checksumValidator.getMismatchedColumns(columns, controlChecksum, testChecksum),\n+                ImmutableMap.builder()\n+                        .put(MAP_COLUMN, new ColumnMatchResult(false, MAP_COLUMN, expectedOutput))\n+                        .build());\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a8a94472ea4c9d0964faac46082c829a94a2c2a2"}, "originalPosition": 101}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM0MjYzMDgyOnYy", "diffSide": "RIGHT", "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/checksum/MapColumnValidator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwNDowMzozNlrOFpGaqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwNDowMzozNlrOFpGaqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODY0MTA2Ng==", "bodyText": "Usually, one line for empty constructor:\npublic MapColumnValidator() {}", "url": "https://github.com/prestodb/presto/pull/14054#discussion_r378641066", "createdAt": "2020-02-13T04:03:36Z", "author": {"login": "caithagoras"}, "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/checksum/MapColumnValidator.java", "diffHunk": "@@ -0,0 +1,133 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.verifier.checksum;\n+\n+import com.facebook.presto.spi.type.MapType;\n+import com.facebook.presto.spi.type.Type;\n+import com.facebook.presto.sql.tree.CoalesceExpression;\n+import com.facebook.presto.sql.tree.Expression;\n+import com.facebook.presto.sql.tree.LongLiteral;\n+import com.facebook.presto.sql.tree.SingleColumn;\n+import com.facebook.presto.verifier.framework.Column;\n+import com.google.common.collect.ImmutableList;\n+\n+import javax.inject.Inject;\n+\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.sql.QueryUtil.functionCall;\n+import static com.facebook.presto.verifier.framework.VerifierUtil.delimitedIdentifier;\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.lang.String.format;\n+\n+public class MapColumnValidator\n+        implements ColumnValidator\n+{\n+    @Inject\n+    public MapColumnValidator()\n+    {\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a8a94472ea4c9d0964faac46082c829a94a2c2a2"}, "originalPosition": 42}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3231, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}