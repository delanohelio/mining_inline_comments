{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkxODczOTgx", "number": 15213, "title": "Improve nested loop operator performance", "bodyText": "Adaptation of comparable changes in trinodb/trino#5276\nImprovements:\n\nModifies NestedLoopJoinPagesBuilder to combine empty pages (aka: positionCount only pages) when the build side of the nested loop join is empty\nHandles the case where either probe or build side outputs are empty and position counts are fewer by emitting the same page repeatedly, avoiding unnecessary per-iteration allocations\nReduces the amount of block array copies made in the standard case by reusing a block buffer to build each page and letting the Page constructor clone it (ie: 1/2 as many allocations)\nNullifies the output iterator as well as the probe page when finished iterating through it to make the referenced pages elligible for GC. Also nullifies more fields when the operator is closed for the same reason.\nAdds a constructor Page(int positionCount) that avoids per-invocation empty varargs array creation and copies.\n\n== RELEASE NOTES ==\n\nGeneral Changes\n* Improve performance of NestedLoopJoinOperator", "createdAt": "2020-09-23T15:44:16Z", "url": "https://github.com/prestodb/presto/pull/15213", "merged": true, "mergeCommit": {"oid": "f117ceb9d6a3e8c257968310cc4b3d877206ac96"}, "closed": true, "closedAt": "2020-11-05T17:04:01Z", "author": {"login": "pettyjamesm"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLwIzwABqjM3OTkyODQ1ODM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZaNugAFqTUyMzkwOTE2NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8cdbb3dad17fbe2f4e2b91b87b3fcb993fe24d55", "author": {"user": {"login": "pettyjamesm", "name": "James Petty"}}, "url": "https://github.com/prestodb/presto/commit/8cdbb3dad17fbe2f4e2b91b87b3fcb993fe24d55", "committedDate": "2020-09-23T15:36:32Z", "message": "Improve NestedLoopJoinOperator performance\n\nAvoids unnecessary block array creations and extra work copying\nblocks from the \"larger\" page per iteration of the nested loop."}, "afterCommit": {"oid": "2fbd3ee323eb9d5baf1912e37c2988c5eb71aa50", "author": {"user": {"login": "pettyjamesm", "name": "James Petty"}}, "url": "https://github.com/prestodb/presto/commit/2fbd3ee323eb9d5baf1912e37c2988c5eb71aa50", "committedDate": "2020-09-23T17:34:26Z", "message": "Improve NestedLoopJoinOperator performance\n\nAvoids unnecessary block array creations and extra work copying\nblocks from the \"larger\" page per iteration of the nested loop."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2fbd3ee323eb9d5baf1912e37c2988c5eb71aa50", "author": {"user": {"login": "pettyjamesm", "name": "James Petty"}}, "url": "https://github.com/prestodb/presto/commit/2fbd3ee323eb9d5baf1912e37c2988c5eb71aa50", "committedDate": "2020-09-23T17:34:26Z", "message": "Improve NestedLoopJoinOperator performance\n\nAvoids unnecessary block array creations and extra work copying\nblocks from the \"larger\" page per iteration of the nested loop."}, "afterCommit": {"oid": "c0a86a2e0eeef9c3bbd3f2729bf87c0d7eccc565", "author": {"user": {"login": "pettyjamesm", "name": "James Petty"}}, "url": "https://github.com/prestodb/presto/commit/c0a86a2e0eeef9c3bbd3f2729bf87c0d7eccc565", "committedDate": "2020-09-23T22:44:03Z", "message": "Improve NestedLoopJoinOperator performance\n\nAvoids unnecessary block array creations and extra work copying\nblocks from the \"larger\" page per iteration of the nested loop."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c0a86a2e0eeef9c3bbd3f2729bf87c0d7eccc565", "author": {"user": {"login": "pettyjamesm", "name": "James Petty"}}, "url": "https://github.com/prestodb/presto/commit/c0a86a2e0eeef9c3bbd3f2729bf87c0d7eccc565", "committedDate": "2020-09-23T22:44:03Z", "message": "Improve NestedLoopJoinOperator performance\n\nAvoids unnecessary block array creations and extra work copying\nblocks from the \"larger\" page per iteration of the nested loop."}, "afterCommit": {"oid": "a914ed9723fd0fcc25231f659b0b2417ffa13503", "author": {"user": {"login": "pettyjamesm", "name": "James Petty"}}, "url": "https://github.com/prestodb/presto/commit/a914ed9723fd0fcc25231f659b0b2417ffa13503", "committedDate": "2020-10-08T14:09:19Z", "message": "Improve NestedLoopJoinOperator performance\n\n- Modifies NestedLoopJoinPagesBuilder to combine empty pages (aka:\npositionCount only pages) when the build side of the nested loop\njoin is empty\n- Handles the case where either probe or build side outputs are empty\nand position counts are fewer by emitting the same page repeatedly,\navoiding unnecessary per-iteration allocations\n- Reduces the amount of block array copies made in the standard case\nby reusing a block buffer to build each page and letting the Page\nconstructor clone it (ie: 1/2 as many allocations)\n- Nullifies the output iterator as well as the probe page when finished\niterating through it to make the referenced pages elligible for GC. Also\nnullifies more fields when the operator is closed for the same reason."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxMTIyODkz", "url": "https://github.com/prestodb/presto/pull/15213#pullrequestreview-521122893", "createdAt": "2020-10-31T08:33:35Z", "commit": {"oid": "a914ed9723fd0fcc25231f659b0b2417ffa13503"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMVQwODozMzozNVrOHrl98g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMVQwOToxMjowMFrOHrmKfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQ3Mjg4Mg==", "bodyText": "nit: Remove this. for line 333- 336", "url": "https://github.com/prestodb/presto/pull/15213#discussion_r515472882", "createdAt": "2020-10-31T08:33:35Z", "author": {"login": "yingsu00"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/NestedLoopJoinOperator.java", "diffHunk": "@@ -217,59 +224,120 @@ public void close()\n         afterClose.run();\n     }\n \n+    @VisibleForTesting\n+    static NestedLoopOutputIterator createNestedLoopOutputIterator(Page probePage, Page buildPage)\n+    {\n+        if (probePage.getChannelCount() == 0 && buildPage.getChannelCount() == 0) {\n+            int probePositions = probePage.getPositionCount();\n+            int buildPositions = buildPage.getPositionCount();\n+            try {\n+                // positionCount is an int. Make sure the product can still fit in an int.\n+                int outputPositions = multiplyExact(probePositions, buildPositions);\n+                if (outputPositions <= PageProcessor.MAX_BATCH_SIZE) {\n+                    return new PageRepeatingIterator(new Page(outputPositions), 1);\n+                }\n+            }\n+            catch (ArithmeticException overflow) {\n+            }\n+            // Repeat larger position count a smaller position count number of times\n+            Page outputPage = new Page(max(probePositions, buildPositions));\n+            return new PageRepeatingIterator(outputPage, min(probePositions, buildPositions));\n+        }\n+        else if (probePage.getChannelCount() == 0 && probePage.getPositionCount() <= buildPage.getPositionCount()) {\n+            return new PageRepeatingIterator(buildPage, probePage.getPositionCount());\n+        }\n+        else if (buildPage.getChannelCount() == 0 && buildPage.getPositionCount() <= probePage.getPositionCount()) {\n+            return new PageRepeatingIterator(probePage, buildPage.getPositionCount());\n+        }\n+        else {\n+            return new NestedLoopPageBuilder(probePage, buildPage);\n+        }\n+    }\n+\n+    // bi-morphic parent class for the two implementations allowed. Adding a third implementation will make getOutput megamorphic and\n+    // should be avoided\n+    @VisibleForTesting\n+    abstract static class NestedLoopOutputIterator\n+    {\n+        public abstract boolean hasNext();\n+\n+        public abstract Page next();\n+    }\n+\n+    private static final class PageRepeatingIterator\n+            extends NestedLoopOutputIterator\n+    {\n+        private final Page page;\n+        private int remainingCount;\n+\n+        private PageRepeatingIterator(Page page, int repetitions)\n+        {\n+            this.page = requireNonNull(page, \"page is null\");\n+            this.remainingCount = repetitions;\n+        }\n+\n+        @Override\n+        public boolean hasNext()\n+        {\n+            return remainingCount > 0;\n+        }\n+\n+        @Override\n+        public Page next()\n+        {\n+            if (!hasNext()) {\n+                throw new NoSuchElementException();\n+            }\n+            remainingCount--;\n+            return page;\n+        }\n+    }\n+\n     /**\n      * This class takes one probe page(p rows) and one build page(b rows) and\n      * build n pages with m rows in each page, where n = min(p, b) and m = max(p, b)\n      */\n-    @VisibleForTesting\n-    static class NestedLoopPageBuilder\n-            implements Iterator<Page>\n+    private static final class NestedLoopPageBuilder\n+            extends NestedLoopOutputIterator\n     {\n-        private final int numberOfProbeColumns;\n-        private final int numberOfBuildColumns;\n-        private final boolean buildPageLarger;\n-        private final Page largePage;\n+        //  Avoids allocation a new block array per iteration\n+        private final Block[] resultBlockBuffer;\n         private final Page smallPage;\n+        private final int indexForRleBlocks;\n+        private final int largePagePositionCount;\n         private final int maxRowIndex; // number of rows - 1\n \n-        private int rowIndex; // Iterator on the rows in the page with less rows.\n-        private final int noColumnShortcutResult; // Only used if select count(*) from cross join.\n+        private int rowIndex = -1; // Iterator on the rows in the page with less rows.\n \n         NestedLoopPageBuilder(Page probePage, Page buildPage)\n         {\n             requireNonNull(probePage, \"probePage is null\");\n             checkArgument(probePage.getPositionCount() > 0, \"probePage has no rows\");\n             requireNonNull(buildPage, \"buildPage is null\");\n             checkArgument(buildPage.getPositionCount() > 0, \"buildPage has no rows\");\n-            this.numberOfProbeColumns = probePage.getChannelCount();\n-            this.numberOfBuildColumns = buildPage.getChannelCount();\n \n-            // We will loop through all rows in the page with less rows.\n-            this.rowIndex = -1;\n-            this.buildPageLarger = buildPage.getPositionCount() > probePage.getPositionCount();\n-            this.maxRowIndex = Math.min(buildPage.getPositionCount(), probePage.getPositionCount()) - 1;\n-            this.largePage = buildPageLarger ? buildPage : probePage;\n-            this.smallPage = buildPageLarger ? probePage : buildPage;\n-\n-            this.noColumnShortcutResult = calculateUseNoColumnShortcut(numberOfProbeColumns, numberOfBuildColumns, probePage.getPositionCount(), buildPage.getPositionCount());\n-        }\n+            Page largePage;\n+            int indexForPageBlocks;\n+            if (buildPage.getPositionCount() > probePage.getPositionCount()) {\n+                largePage = buildPage;\n+                smallPage = probePage;\n+                indexForPageBlocks = probePage.getChannelCount();\n+                this.indexForRleBlocks = 0;\n+            }\n+            else {\n+                largePage = probePage;\n+                smallPage = buildPage;\n+                indexForPageBlocks = 0;\n+                this.indexForRleBlocks = probePage.getChannelCount();\n+            }\n+            this.largePagePositionCount = largePage.getPositionCount();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a914ed9723fd0fcc25231f659b0b2417ffa13503"}, "originalPosition": 180}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQ3NDA3Mw==", "bodyText": "rename this variable to nestedLoopOutputIterator", "url": "https://github.com/prestodb/presto/pull/15213#discussion_r515474073", "createdAt": "2020-10-31T08:48:23Z", "author": {"login": "yingsu00"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/NestedLoopJoinOperator.java", "diffHunk": "@@ -112,7 +115,7 @@ public OperatorFactory duplicate()\n     private List<Page> buildPages;\n     private Page probePage;\n     private Iterator<Page> buildPageIterator;\n-    private NestedLoopPageBuilder nestedLoopPageBuilder;\n+    private NestedLoopOutputIterator nestedLoopPageBuilder;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a914ed9723fd0fcc25231f659b0b2417ffa13503"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQ3NTIwOQ==", "bodyText": "I think it's better to be an interface than an abstract static class since it's just describing what the implementors should do but do not share functional code.", "url": "https://github.com/prestodb/presto/pull/15213#discussion_r515475209", "createdAt": "2020-10-31T09:02:06Z", "author": {"login": "yingsu00"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/NestedLoopJoinOperator.java", "diffHunk": "@@ -217,59 +224,120 @@ public void close()\n         afterClose.run();\n     }\n \n+    @VisibleForTesting\n+    static NestedLoopOutputIterator createNestedLoopOutputIterator(Page probePage, Page buildPage)\n+    {\n+        if (probePage.getChannelCount() == 0 && buildPage.getChannelCount() == 0) {\n+            int probePositions = probePage.getPositionCount();\n+            int buildPositions = buildPage.getPositionCount();\n+            try {\n+                // positionCount is an int. Make sure the product can still fit in an int.\n+                int outputPositions = multiplyExact(probePositions, buildPositions);\n+                if (outputPositions <= PageProcessor.MAX_BATCH_SIZE) {\n+                    return new PageRepeatingIterator(new Page(outputPositions), 1);\n+                }\n+            }\n+            catch (ArithmeticException overflow) {\n+            }\n+            // Repeat larger position count a smaller position count number of times\n+            Page outputPage = new Page(max(probePositions, buildPositions));\n+            return new PageRepeatingIterator(outputPage, min(probePositions, buildPositions));\n+        }\n+        else if (probePage.getChannelCount() == 0 && probePage.getPositionCount() <= buildPage.getPositionCount()) {\n+            return new PageRepeatingIterator(buildPage, probePage.getPositionCount());\n+        }\n+        else if (buildPage.getChannelCount() == 0 && buildPage.getPositionCount() <= probePage.getPositionCount()) {\n+            return new PageRepeatingIterator(probePage, buildPage.getPositionCount());\n+        }\n+        else {\n+            return new NestedLoopPageBuilder(probePage, buildPage);\n+        }\n+    }\n+\n+    // bi-morphic parent class for the two implementations allowed. Adding a third implementation will make getOutput megamorphic and\n+    // should be avoided\n+    @VisibleForTesting\n+    abstract static class NestedLoopOutputIterator", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a914ed9723fd0fcc25231f659b0b2417ffa13503"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQ3NjA5Mg==", "bodyText": "This PR might be structurally cleaner to put this change (the new PageRepeatingIterator and PageRepeatingIterator logic) in a separate commit other than the change within NestedLoopPageBuilder class. Maybe put different things in different commits in the future PRs? It'll be easier to review.", "url": "https://github.com/prestodb/presto/pull/15213#discussion_r515476092", "createdAt": "2020-10-31T09:12:00Z", "author": {"login": "yingsu00"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/NestedLoopJoinOperator.java", "diffHunk": "@@ -217,59 +224,120 @@ public void close()\n         afterClose.run();\n     }\n \n+    @VisibleForTesting\n+    static NestedLoopOutputIterator createNestedLoopOutputIterator(Page probePage, Page buildPage)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a914ed9723fd0fcc25231f659b0b2417ffa13503"}, "originalPosition": 55}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a261743c800240839644c30aabf415c016e1e822", "author": {"user": {"login": "pettyjamesm", "name": "James Petty"}}, "url": "https://github.com/prestodb/presto/commit/a261743c800240839644c30aabf415c016e1e822", "committedDate": "2020-11-02T14:24:34Z", "message": "Add Page constructor for empty blocks case\n\nAvoids varargs empty array creation per call for these usage sites"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e16b125e067f07e8d736ad1273a7ba8b9d896ec4", "author": {"user": {"login": "pettyjamesm", "name": "James Petty"}}, "url": "https://github.com/prestodb/presto/commit/e16b125e067f07e8d736ad1273a7ba8b9d896ec4", "committedDate": "2020-11-02T15:07:20Z", "message": "Improve NestedLoopJoinOperator performance\n\n- Modifies NestedLoopJoinPagesBuilder to combine empty pages (aka:\npositionCount only pages) when the build side of the nested loop\njoin is empty\n- Handles the case where either probe or build side outputs are empty\nand position counts are fewer by emitting the same page repeatedly,\navoiding unnecessary per-iteration allocations\n- Reduces the amount of block array copies made in the standard case\nby reusing a block buffer to build each page and letting the Page\nconstructor clone it (ie: 1/2 as many allocations)\n- Nullifies the output iterator as well as the probe page when finished\niterating through it to make the referenced pages elligible for GC. Also\nnullifies more fields when the operator is closed for the same reason."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a914ed9723fd0fcc25231f659b0b2417ffa13503", "author": {"user": {"login": "pettyjamesm", "name": "James Petty"}}, "url": "https://github.com/prestodb/presto/commit/a914ed9723fd0fcc25231f659b0b2417ffa13503", "committedDate": "2020-10-08T14:09:19Z", "message": "Improve NestedLoopJoinOperator performance\n\n- Modifies NestedLoopJoinPagesBuilder to combine empty pages (aka:\npositionCount only pages) when the build side of the nested loop\njoin is empty\n- Handles the case where either probe or build side outputs are empty\nand position counts are fewer by emitting the same page repeatedly,\navoiding unnecessary per-iteration allocations\n- Reduces the amount of block array copies made in the standard case\nby reusing a block buffer to build each page and letting the Page\nconstructor clone it (ie: 1/2 as many allocations)\n- Nullifies the output iterator as well as the probe page when finished\niterating through it to make the referenced pages elligible for GC. Also\nnullifies more fields when the operator is closed for the same reason."}, "afterCommit": {"oid": "e16b125e067f07e8d736ad1273a7ba8b9d896ec4", "author": {"user": {"login": "pettyjamesm", "name": "James Petty"}}, "url": "https://github.com/prestodb/presto/commit/e16b125e067f07e8d736ad1273a7ba8b9d896ec4", "committedDate": "2020-11-02T15:07:20Z", "message": "Improve NestedLoopJoinOperator performance\n\n- Modifies NestedLoopJoinPagesBuilder to combine empty pages (aka:\npositionCount only pages) when the build side of the nested loop\njoin is empty\n- Handles the case where either probe or build side outputs are empty\nand position counts are fewer by emitting the same page repeatedly,\navoiding unnecessary per-iteration allocations\n- Reduces the amount of block array copies made in the standard case\nby reusing a block buffer to build each page and letting the Page\nconstructor clone it (ie: 1/2 as many allocations)\n- Nullifies the output iterator as well as the probe page when finished\niterating through it to make the referenced pages elligible for GC. Also\nnullifies more fields when the operator is closed for the same reason."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzOTA5MTY1", "url": "https://github.com/prestodb/presto/pull/15213#pullrequestreview-523909165", "createdAt": "2020-11-05T03:57:47Z", "commit": {"oid": "e16b125e067f07e8d736ad1273a7ba8b9d896ec4"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwMzo1Nzo0N1rOHtythA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwMzo1Nzo0N1rOHtythA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzc3ODgyMA==", "bodyText": "@pettyjamesm Thank you for letting me know the test results. JMH doesn't need any set up and can directly run in IntelliJ. Furthermore it can collect CPU profiles and GC profiles easily. I'll approve it for now but it'll be helpful to include JMH benchmark results for future performance improvement PRs. Thank you!\n@mbasmanova Do you want to take another look at this PR?", "url": "https://github.com/prestodb/presto/pull/15213#discussion_r517778820", "createdAt": "2020-11-05T03:57:47Z", "author": {"login": "yingsu00"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/NestedLoopJoinOperator.java", "diffHunk": "@@ -217,59 +224,120 @@ public void close()\n         afterClose.run();\n     }\n \n+    @VisibleForTesting\n+    static NestedLoopOutputIterator createNestedLoopOutputIterator(Page probePage, Page buildPage)\n+    {\n+        if (probePage.getChannelCount() == 0 && buildPage.getChannelCount() == 0) {\n+            int probePositions = probePage.getPositionCount();\n+            int buildPositions = buildPage.getPositionCount();\n+            try {\n+                // positionCount is an int. Make sure the product can still fit in an int.\n+                int outputPositions = multiplyExact(probePositions, buildPositions);\n+                if (outputPositions <= PageProcessor.MAX_BATCH_SIZE) {\n+                    return new PageRepeatingIterator(new Page(outputPositions), 1);\n+                }\n+            }\n+            catch (ArithmeticException overflow) {\n+            }\n+            // Repeat larger position count a smaller position count number of times\n+            Page outputPage = new Page(max(probePositions, buildPositions));\n+            return new PageRepeatingIterator(outputPage, min(probePositions, buildPositions));\n+        }\n+        else if (probePage.getChannelCount() == 0 && probePage.getPositionCount() <= buildPage.getPositionCount()) {\n+            return new PageRepeatingIterator(buildPage, probePage.getPositionCount());\n+        }\n+        else if (buildPage.getChannelCount() == 0 && buildPage.getPositionCount() <= probePage.getPositionCount()) {\n+            return new PageRepeatingIterator(probePage, buildPage.getPositionCount());\n+        }\n+        else {\n+            return new NestedLoopPageBuilder(probePage, buildPage);\n+        }\n+    }\n+\n+    // bi-morphic parent class for the two implementations allowed. Adding a third implementation will make getOutput megamorphic and\n+    // should be avoided\n+    @VisibleForTesting\n+    abstract static class NestedLoopOutputIterator", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQ3NTIwOQ=="}, "originalCommit": {"oid": "a914ed9723fd0fcc25231f659b0b2417ffa13503"}, "originalPosition": 87}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 200, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}