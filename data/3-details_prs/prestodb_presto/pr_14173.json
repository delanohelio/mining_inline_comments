{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgwNzA5MjA3", "number": 14173, "title": "Optimize initial batch size for scan", "bodyText": "When all columns are of fixed width types, we can accurately estimate the\nsize of each row and calculate maximum number of rows that fit under\nhive.orc.max-read-block-size. This allows scan to produce full size pages\nfrom the start and avoids inefficiencies associated with processing small\npages.\n== NO RELEASE NOTE ==", "createdAt": "2020-02-27T08:44:04Z", "url": "https://github.com/prestodb/presto/pull/14173", "merged": true, "mergeCommit": {"oid": "8d5283d7ab6e4ed0cc5bd303fc1497bfcface81c"}, "closed": true, "closedAt": "2020-03-11T13:07:28Z", "author": {"login": "mbasmanova"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcIXRvMABqjMwNzY5MTQzMTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMjgAygFqTM3MjU4MjM0Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cbd5df7821aab578d6fbbfdc321029abdcf60b1b", "author": {"user": {"login": "mbasmanova", "name": "Maria Basmanova"}}, "url": "https://github.com/prestodb/presto/commit/cbd5df7821aab578d6fbbfdc321029abdcf60b1b", "committedDate": "2020-02-27T08:29:03Z", "message": "Optimize initial batch size for scan\n\nWhen all columns are of fixed width types, we can accurately estimate the\nsize of each row and calculate maximum number of rows that fit under\nhive.orc.max-read-block-size. This allows scan to produce full size pages\nfrom the start and avoids inefficiences associated with processing small\npages."}, "afterCommit": {"oid": "89c6e85e2456df944a89671d064365392440d66a", "author": {"user": {"login": "mbasmanova", "name": "Maria Basmanova"}}, "url": "https://github.com/prestodb/presto/commit/89c6e85e2456df944a89671d064365392440d66a", "committedDate": "2020-02-27T08:44:22Z", "message": "Optimize initial batch size for scan\n\nWhen all columns are of fixed width types, we can accurately estimate the\nsize of each row and calculate maximum number of rows that fit under\nhive.orc.max-read-block-size. This allows scan to produce full size pages\nfrom the start and avoids inefficiencies associated with processing small\npages."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "89c6e85e2456df944a89671d064365392440d66a", "author": {"user": {"login": "mbasmanova", "name": "Maria Basmanova"}}, "url": "https://github.com/prestodb/presto/commit/89c6e85e2456df944a89671d064365392440d66a", "committedDate": "2020-02-27T08:44:22Z", "message": "Optimize initial batch size for scan\n\nWhen all columns are of fixed width types, we can accurately estimate the\nsize of each row and calculate maximum number of rows that fit under\nhive.orc.max-read-block-size. This allows scan to produce full size pages\nfrom the start and avoids inefficiencies associated with processing small\npages."}, "afterCommit": {"oid": "6652e62df958ed175ef733011c1048381d06a6ee", "author": {"user": {"login": "mbasmanova", "name": "Maria Basmanova"}}, "url": "https://github.com/prestodb/presto/commit/6652e62df958ed175ef733011c1048381d06a6ee", "committedDate": "2020-02-27T14:59:11Z", "message": "Optimize initial batch size for scan\n\nWhen all columns are of fixed width types, we can accurately estimate the\nsize of each row and calculate maximum number of rows that fit under\nhive.orc.max-read-block-size. This allows scan to produce full size pages\nfrom the start and avoids inefficiencies associated with processing small\npages."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxNDQxNTM1", "url": "https://github.com/prestodb/presto/pull/14173#pullrequestreview-371441535", "createdAt": "2020-03-09T18:49:19Z", "commit": {"oid": "6652e62df958ed175ef733011c1048381d06a6ee"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxODo0OToyMFrOFz1HGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxODo1NToyM1rOFz1T8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg5MTg2Nw==", "bodyText": "Shall we add a new static helper for protected void adjustMaxBatchSize(long averageRowBytes) so we can reuse the code?", "url": "https://github.com/prestodb/presto/pull/14173#discussion_r389891867", "createdAt": "2020-03-09T18:49:20Z", "author": {"login": "highker"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/AbstractOrcRecordReader.java", "diffHunk": "@@ -237,7 +247,17 @@ public AbstractOrcRecordReader(\n \n         maxBytesPerCell = new long[streamReaders.length];\n \n-        nextBatchSize = initialBatchSize;\n+        if (onlyFixedWidthColumns) {\n+            if (totalFixedWidth == 0) {\n+                nextBatchSize = MAX_BATCH_SIZE;\n+            }\n+            else {\n+                nextBatchSize = toIntExact(min(MAX_BATCH_SIZE, max(1, maxBlockBytes / totalFixedWidth)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6652e62df958ed175ef733011c1048381d06a6ee"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg5NTE1Mg==", "bodyText": "Shall we move this logic out of this loop and move it closer to where it is used? Given it's in the constructor, having two for loops shouldn't be a performance concern. It will be clearer to separate the logic. Or, it could be even better to move the logic into another help like adjustMaxBatchSizeBasedOnTypes (something like this name).", "url": "https://github.com/prestodb/presto/pull/14173#discussion_r389895152", "createdAt": "2020-03-09T18:55:23Z", "author": {"login": "highker"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/AbstractOrcRecordReader.java", "diffHunk": "@@ -154,14 +155,23 @@ public AbstractOrcRecordReader(\n \n         // reduce the included columns to the set that is also present\n         ImmutableSet.Builder<Integer> presentColumns = ImmutableSet.builder();\n-        ImmutableMap.Builder<Integer, Type> presentColumnsAndTypes = ImmutableMap.builder();\n         OrcType root = types.get(0);\n+        boolean onlyFixedWidthColumns = true;\n+        int totalFixedWidth = 0;\n         for (Map.Entry<Integer, Type> entry : includedColumns.entrySet()) {\n             // an old file can have less columns since columns can be added\n             // after the file was written\n             if (entry.getKey() >= 0 && entry.getKey() < root.getFieldCount()) {\n                 presentColumns.add(entry.getKey());\n-                presentColumnsAndTypes.put(entry.getKey(), entry.getValue());\n+\n+                Type type = entry.getValue();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6652e62df958ed175ef733011c1048381d06a6ee"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "712a3bee5913b8c4ab403afc22877f143fad813b", "author": {"user": {"login": "mbasmanova", "name": "Maria Basmanova"}}, "url": "https://github.com/prestodb/presto/commit/712a3bee5913b8c4ab403afc22877f143fad813b", "committedDate": "2020-03-10T10:54:20Z", "message": "Optimize initial batch size for scan\n\nWhen all columns are of fixed width types, we can accurately estimate the\nsize of each row and calculate maximum number of rows that fit under\nhive.orc.max-read-block-size. This allows scan to produce full size pages\nfrom the start and avoids inefficiencies associated with processing small\npages."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6652e62df958ed175ef733011c1048381d06a6ee", "author": {"user": {"login": "mbasmanova", "name": "Maria Basmanova"}}, "url": "https://github.com/prestodb/presto/commit/6652e62df958ed175ef733011c1048381d06a6ee", "committedDate": "2020-02-27T14:59:11Z", "message": "Optimize initial batch size for scan\n\nWhen all columns are of fixed width types, we can accurately estimate the\nsize of each row and calculate maximum number of rows that fit under\nhive.orc.max-read-block-size. This allows scan to produce full size pages\nfrom the start and avoids inefficiencies associated with processing small\npages."}, "afterCommit": {"oid": "712a3bee5913b8c4ab403afc22877f143fad813b", "author": {"user": {"login": "mbasmanova", "name": "Maria Basmanova"}}, "url": "https://github.com/prestodb/presto/commit/712a3bee5913b8c4ab403afc22877f143fad813b", "committedDate": "2020-03-10T10:54:20Z", "message": "Optimize initial batch size for scan\n\nWhen all columns are of fixed width types, we can accurately estimate the\nsize of each row and calculate maximum number of rows that fit under\nhive.orc.max-read-block-size. This allows scan to produce full size pages\nfrom the start and avoids inefficiencies associated with processing small\npages."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyNDM4OTAy", "url": "https://github.com/prestodb/presto/pull/14173#pullrequestreview-372438902", "createdAt": "2020-03-11T02:25:32Z", "commit": {"oid": "712a3bee5913b8c4ab403afc22877f143fad813b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyNTgyMzQ3", "url": "https://github.com/prestodb/presto/pull/14173#pullrequestreview-372582347", "createdAt": "2020-03-11T09:14:50Z", "commit": {"oid": "712a3bee5913b8c4ab403afc22877f143fad813b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2351, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}