{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgwMDUwOTMw", "number": 15125, "title": "Remove getFileStatus on openFile with Alluxio Cache", "bodyText": "Depended by facebookexternal/presto-facebook#1158\n== NO RELEASE NOTE ==", "createdAt": "2020-09-04T20:14:30Z", "url": "https://github.com/prestodb/presto/pull/15125", "merged": true, "mergeCommit": {"oid": "ae0bdf8126b277ebadfa02b0aca65c7ad10e775e"}, "closed": true, "closedAt": "2020-09-05T02:45:30Z", "author": {"login": "apc999"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdFrHFpgFqTQ4MjkxODcyNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdFuv98gFqTQ4MzAxNTg0MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyOTE4NzI0", "url": "https://github.com/prestodb/presto/pull/15125#pullrequestreview-482918724", "createdAt": "2020-09-04T20:16:54Z", "commit": {"oid": "6fdd35c3a065344bf3a0c932e76fb689614af3a2"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQyMDoxNjo1NVrOHNafHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQyMDoxOTo1NVrOHNaiug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzgyNzQ4NA==", "bodyText": "Move fileSize after extraFileInfo\nMake the type OptionalLong rather than -1 to denote unknown", "url": "https://github.com/prestodb/presto/pull/15125#discussion_r483827484", "createdAt": "2020-09-04T20:16:55Z", "author": {"login": "highker"}, "path": "presto-hive-common/src/main/java/com/facebook/presto/hive/HiveFileContext.java", "diffHunk": "@@ -20,17 +20,20 @@\n \n public class HiveFileContext\n {\n-    public static final HiveFileContext DEFAULT_HIVE_FILE_CONTEXT = new HiveFileContext(true, NO_CACHE_CONSTRAINTS, Optional.empty());\n+    public static final long UNKNOWN_LENGTH = -1;\n+    public static final HiveFileContext DEFAULT_HIVE_FILE_CONTEXT = new HiveFileContext(true, NO_CACHE_CONSTRAINTS, Optional.empty(), UNKNOWN_LENGTH);\n \n     private final boolean cacheable;\n     private final CacheQuota cacheQuota;\n+    private final long fileSize;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6fdd35c3a065344bf3a0c932e76fb689614af3a2"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzgyNzc5Mg==", "bodyText": "remove", "url": "https://github.com/prestodb/presto/pull/15125#discussion_r483827792", "createdAt": "2020-09-04T20:17:49Z", "author": {"login": "highker"}, "path": "presto-hive-common/src/main/java/com/facebook/presto/hive/HiveFileContext.java", "diffHunk": "@@ -20,17 +20,20 @@\n \n public class HiveFileContext\n {\n-    public static final HiveFileContext DEFAULT_HIVE_FILE_CONTEXT = new HiveFileContext(true, NO_CACHE_CONSTRAINTS, Optional.empty());\n+    public static final long UNKNOWN_LENGTH = -1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6fdd35c3a065344bf3a0c932e76fb689614af3a2"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzgyNzgzNQ==", "bodyText": "remove", "url": "https://github.com/prestodb/presto/pull/15125#discussion_r483827835", "createdAt": "2020-09-04T20:17:57Z", "author": {"login": "highker"}, "path": "presto-hive-common/src/main/java/com/facebook/presto/hive/HiveFileContext.java", "diffHunk": "@@ -54,6 +57,14 @@ public CacheQuota getCacheQuota()\n         return extraFileInfo;\n     }\n \n+    /**\n+     * file length in bytes or -1 if it is unknown\n+     */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6fdd35c3a065344bf3a0c932e76fb689614af3a2"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzgyODQxMA==", "bodyText": "FileInfo info = new FileInfo().setFileIdentifier(md5().hashString(path.toString(), UTF_8).toString())\n                    .setPath(path.toString())\n                    .setFolder(false)\n                    .setLength(hiveFileContext.getFileSize());", "url": "https://github.com/prestodb/presto/pull/15125#discussion_r483828410", "createdAt": "2020-09-04T20:19:55Z", "author": {"login": "highker"}, "path": "presto-cache/src/main/java/com/facebook/presto/cache/alluxio/AlluxioCachingFileSystem.java", "diffHunk": "@@ -56,9 +59,16 @@ public FSDataInputStream openFile(Path path, HiveFileContext hiveFileContext)\n             throws Exception\n     {\n         if (hiveFileContext.isCacheable()) {\n-            FileStatus fileStatus = dataTier.getFileStatus(path);\n+            // FilePath is a unique identifier for a file, however it can be a long string\n+            // hence using md5 hash of the file path as the identifier in the cache.\n+            // We don't set fileId because fileId is Alluxio specific\n+            FileInfo info = new FileInfo();\n+            info.setFileIdentifier(md5().hashString(path.toString(), UTF_8).toString())\n+                    .setPath(path.toString())\n+                    .setFolder(false)\n+                    .setLength(hiveFileContext.getFileSize());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6fdd35c3a065344bf3a0c932e76fb689614af3a2"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyOTIzNTc2", "url": "https://github.com/prestodb/presto/pull/15125#pullrequestreview-482923576", "createdAt": "2020-09-04T20:28:21Z", "commit": {"oid": "6fdd35c3a065344bf3a0c932e76fb689614af3a2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6fdd35c3a065344bf3a0c932e76fb689614af3a2", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/prestodb/presto/commit/6fdd35c3a065344bf3a0c932e76fb689614af3a2", "committedDate": "2020-09-04T20:09:41Z", "message": "Remove getFileStatus on openFile with Alluxio Cache"}, "afterCommit": {"oid": "5d7cdc10200a1ea276462b11f25c10ee10746f1f", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/prestodb/presto/commit/5d7cdc10200a1ea276462b11f25c10ee10746f1f", "committedDate": "2020-09-04T20:46:48Z", "message": "Remove getFileStatus on openFile with Alluxio Cache"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5d7cdc10200a1ea276462b11f25c10ee10746f1f", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/prestodb/presto/commit/5d7cdc10200a1ea276462b11f25c10ee10746f1f", "committedDate": "2020-09-04T20:46:48Z", "message": "Remove getFileStatus on openFile with Alluxio Cache"}, "afterCommit": {"oid": "163b5c56f02064aa3a9aedfdce54f13ed99749e9", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/prestodb/presto/commit/163b5c56f02064aa3a9aedfdce54f13ed99749e9", "committedDate": "2020-09-04T20:47:31Z", "message": "Remove getFileStatus on openFile with Alluxio Cache"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyOTM0NTUw", "url": "https://github.com/prestodb/presto/pull/15125#pullrequestreview-482934550", "createdAt": "2020-09-04T20:55:14Z", "commit": {"oid": "163b5c56f02064aa3a9aedfdce54f13ed99749e9"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e64aae70c18ef1ead90844fbe26f3417c9eeb73", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/prestodb/presto/commit/4e64aae70c18ef1ead90844fbe26f3417c9eeb73", "committedDate": "2020-09-05T00:30:46Z", "message": "Remove getFileStatus on openFile with Alluxio Cache"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "163b5c56f02064aa3a9aedfdce54f13ed99749e9", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/prestodb/presto/commit/163b5c56f02064aa3a9aedfdce54f13ed99749e9", "committedDate": "2020-09-04T20:47:31Z", "message": "Remove getFileStatus on openFile with Alluxio Cache"}, "afterCommit": {"oid": "4e64aae70c18ef1ead90844fbe26f3417c9eeb73", "author": {"user": {"login": "apc999", "name": "Bin Fan"}}, "url": "https://github.com/prestodb/presto/commit/4e64aae70c18ef1ead90844fbe26f3417c9eeb73", "committedDate": "2020-09-05T00:30:46Z", "message": "Remove getFileStatus on openFile with Alluxio Cache"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzMDE1ODQw", "url": "https://github.com/prestodb/presto/pull/15125#pullrequestreview-483015840", "createdAt": "2020-09-05T00:34:53Z", "commit": {"oid": "4e64aae70c18ef1ead90844fbe26f3417c9eeb73"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 72, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}