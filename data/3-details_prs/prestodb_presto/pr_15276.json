{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk4ODczOTY2", "number": 15276, "title": "Add local cache for Parquet Metadata", "bodyText": "Test plan - TravisCI and unit tests in AbstractTestParquetReader\nFixes #13921\n== RELEASE NOTES ==\n\nHive Changes\n* Add caching module for Parquet metadata", "createdAt": "2020-10-06T22:41:02Z", "url": "https://github.com/prestodb/presto/pull/15276", "merged": true, "mergeCommit": {"oid": "213660bceff1f5f1b16c89a71406b7c9d6538d5b"}, "closed": true, "closedAt": "2020-10-14T00:55:23Z", "author": {"login": "ClarenceThreepwood"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQVT2tgBqjM4NTI4NDUxODY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSPKzhgBqjM4NzM1NjUzNDE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ceea070f339a2ec6d845aa8a183010ce71b19a9f", "author": {"user": {"login": "ClarenceThreepwood", "name": "Vivek"}}, "url": "https://github.com/prestodb/presto/commit/ceea070f339a2ec6d845aa8a183010ce71b19a9f", "committedDate": "2020-10-07T23:08:44Z", "message": "undo unrelated change"}, "afterCommit": {"oid": "c9949d50756a6b152d41a00aa9a3cc4d8f55ac52", "author": {"user": {"login": "ClarenceThreepwood", "name": "Vivek"}}, "url": "https://github.com/prestodb/presto/commit/c9949d50756a6b152d41a00aa9a3cc4d8f55ac52", "committedDate": "2020-10-07T23:09:29Z", "message": "Add local cache for Parquet Metadata"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c9949d50756a6b152d41a00aa9a3cc4d8f55ac52", "author": {"user": {"login": "ClarenceThreepwood", "name": "Vivek"}}, "url": "https://github.com/prestodb/presto/commit/c9949d50756a6b152d41a00aa9a3cc4d8f55ac52", "committedDate": "2020-10-07T23:09:29Z", "message": "Add local cache for Parquet Metadata"}, "afterCommit": {"oid": "8aa1f04f883227213964b004010a67f8dd97224f", "author": {"user": {"login": "ClarenceThreepwood", "name": "Vivek"}}, "url": "https://github.com/prestodb/presto/commit/8aa1f04f883227213964b004010a67f8dd97224f", "committedDate": "2020-10-08T18:39:02Z", "message": "Add local cache for Parquet Metadata"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1ODQ2NTE0", "url": "https://github.com/prestodb/presto/pull/15276#pullrequestreview-505846514", "createdAt": "2020-10-09T17:00:06Z", "commit": {"oid": "8aa1f04f883227213964b004010a67f8dd97224f"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxNzowMDowNlrOHfR2og==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxNzoxMDoyNFrOHfSLFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU2MDQxOA==", "bodyText": "nit: isMetadataCacheEnabled()", "url": "https://github.com/prestodb/presto/pull/15276#discussion_r502560418", "createdAt": "2020-10-09T17:00:06Z", "author": {"login": "shixuan-fan"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveClientModule.java", "diffHunk": "@@ -293,4 +299,23 @@ public StripeMetadataSource createStripeMetadataSource(OrcCacheConfig orcCacheCo\n         }\n         return stripeMetadataSource;\n     }\n+\n+    @Singleton\n+    @Provides\n+    public ParquetMetadataSource createParquetMetadataSource(ParquetCacheConfig parquetCacheConfig, MBeanExporter exporter)\n+    {\n+        ParquetMetadataSource parquetMetadataSource = new MetadataReader();\n+        if (parquetCacheConfig.ismetadataCacheEnabled()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8aa1f04f883227213964b004010a67f8dd97224f"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU2MDYwMg==", "bodyText": "nit: getMetadataCacheSize()", "url": "https://github.com/prestodb/presto/pull/15276#discussion_r502560602", "createdAt": "2020-10-09T17:00:25Z", "author": {"login": "shixuan-fan"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveClientModule.java", "diffHunk": "@@ -293,4 +299,23 @@ public StripeMetadataSource createStripeMetadataSource(OrcCacheConfig orcCacheCo\n         }\n         return stripeMetadataSource;\n     }\n+\n+    @Singleton\n+    @Provides\n+    public ParquetMetadataSource createParquetMetadataSource(ParquetCacheConfig parquetCacheConfig, MBeanExporter exporter)\n+    {\n+        ParquetMetadataSource parquetMetadataSource = new MetadataReader();\n+        if (parquetCacheConfig.ismetadataCacheEnabled()) {\n+            Cache<ParquetDataSourceId, ParquetFileMetadata> cache = CacheBuilder.newBuilder()\n+                    .maximumWeight(parquetCacheConfig.getmetadataCacheSize().toBytes())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8aa1f04f883227213964b004010a67f8dd97224f"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU2MjIwNQ==", "bodyText": "nit: getMetadataCacheTtlSinceLastAccess", "url": "https://github.com/prestodb/presto/pull/15276#discussion_r502562205", "createdAt": "2020-10-09T17:03:30Z", "author": {"login": "shixuan-fan"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveClientModule.java", "diffHunk": "@@ -293,4 +299,23 @@ public StripeMetadataSource createStripeMetadataSource(OrcCacheConfig orcCacheCo\n         }\n         return stripeMetadataSource;\n     }\n+\n+    @Singleton\n+    @Provides\n+    public ParquetMetadataSource createParquetMetadataSource(ParquetCacheConfig parquetCacheConfig, MBeanExporter exporter)\n+    {\n+        ParquetMetadataSource parquetMetadataSource = new MetadataReader();\n+        if (parquetCacheConfig.ismetadataCacheEnabled()) {\n+            Cache<ParquetDataSourceId, ParquetFileMetadata> cache = CacheBuilder.newBuilder()\n+                    .maximumWeight(parquetCacheConfig.getmetadataCacheSize().toBytes())\n+                    .weigher((id, metadata) -> ((ParquetFileMetadata) metadata).getMetadataSize())\n+                    .expireAfterAccess(parquetCacheConfig.getmetadataCacheTtlSinceLastAccess().toMillis(), TimeUnit.MILLISECONDS)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8aa1f04f883227213964b004010a67f8dd97224f"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU2NTY1Mw==", "bodyText": "nit: Capitalize the first letter after get and set in this class", "url": "https://github.com/prestodb/presto/pull/15276#discussion_r502565653", "createdAt": "2020-10-09T17:10:24Z", "author": {"login": "shixuan-fan"}, "path": "presto-parquet/src/main/java/com/facebook/presto/parquet/cache/ParquetCacheConfig.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.parquet.cache;\n+\n+import com.facebook.airlift.configuration.Config;\n+import com.facebook.airlift.configuration.ConfigDescription;\n+import io.airlift.units.DataSize;\n+import io.airlift.units.Duration;\n+import io.airlift.units.MinDataSize;\n+import io.airlift.units.MinDuration;\n+\n+import static io.airlift.units.DataSize.Unit.BYTE;\n+import static java.util.concurrent.TimeUnit.SECONDS;\n+\n+public class ParquetCacheConfig\n+{\n+    private boolean metadataCacheEnabled;\n+    private DataSize metadataCacheSize = new DataSize(0, BYTE);\n+    private Duration metadataCacheTtlSinceLastAccess = new Duration(0, SECONDS);\n+\n+    public boolean ismetadataCacheEnabled()\n+    {\n+        return metadataCacheEnabled;\n+    }\n+\n+    @Config(\"parquet.metadata-cache-enabled\")\n+    @ConfigDescription(\"Enable cache for parquet metadata\")\n+    public ParquetCacheConfig setmetadataCacheEnabled(boolean metadataCacheEnabled)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8aa1f04f883227213964b004010a67f8dd97224f"}, "originalPosition": 39}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MDEwODgw", "url": "https://github.com/prestodb/presto/pull/15276#pullrequestreview-506010880", "createdAt": "2020-10-09T22:04:19Z", "commit": {"oid": "8aa1f04f883227213964b004010a67f8dd97224f"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQyMjowNDoyMFrOHfZpow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQyMjowNDoyMFrOHfZpow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY4ODE2Mw==", "bodyText": "static import MILLISECONDS", "url": "https://github.com/prestodb/presto/pull/15276#discussion_r502688163", "createdAt": "2020-10-09T22:04:20Z", "author": {"login": "zhenxiao"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveClientModule.java", "diffHunk": "@@ -293,4 +299,23 @@ public StripeMetadataSource createStripeMetadataSource(OrcCacheConfig orcCacheCo\n         }\n         return stripeMetadataSource;\n     }\n+\n+    @Singleton\n+    @Provides\n+    public ParquetMetadataSource createParquetMetadataSource(ParquetCacheConfig parquetCacheConfig, MBeanExporter exporter)\n+    {\n+        ParquetMetadataSource parquetMetadataSource = new MetadataReader();\n+        if (parquetCacheConfig.ismetadataCacheEnabled()) {\n+            Cache<ParquetDataSourceId, ParquetFileMetadata> cache = CacheBuilder.newBuilder()\n+                    .maximumWeight(parquetCacheConfig.getmetadataCacheSize().toBytes())\n+                    .weigher((id, metadata) -> ((ParquetFileMetadata) metadata).getMetadataSize())\n+                    .expireAfterAccess(parquetCacheConfig.getmetadataCacheTtlSinceLastAccess().toMillis(), TimeUnit.MILLISECONDS)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU2MjIwNQ=="}, "originalCommit": {"oid": "8aa1f04f883227213964b004010a67f8dd97224f"}, "originalPosition": 43}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8aa1f04f883227213964b004010a67f8dd97224f", "author": {"user": {"login": "ClarenceThreepwood", "name": "Vivek"}}, "url": "https://github.com/prestodb/presto/commit/8aa1f04f883227213964b004010a67f8dd97224f", "committedDate": "2020-10-08T18:39:02Z", "message": "Add local cache for Parquet Metadata"}, "afterCommit": {"oid": "fb6d69a195908f38612750d163a93da0fc5a2eb3", "author": {"user": {"login": "ClarenceThreepwood", "name": "Vivek"}}, "url": "https://github.com/prestodb/presto/commit/fb6d69a195908f38612750d163a93da0fc5a2eb3", "committedDate": "2020-10-09T23:00:32Z", "message": "Add local cache for Parquet Metadata"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fb6d69a195908f38612750d163a93da0fc5a2eb3", "author": {"user": {"login": "ClarenceThreepwood", "name": "Vivek"}}, "url": "https://github.com/prestodb/presto/commit/fb6d69a195908f38612750d163a93da0fc5a2eb3", "committedDate": "2020-10-09T23:00:32Z", "message": "Add local cache for Parquet Metadata"}, "afterCommit": {"oid": "36876ac30fbd4bdb9f1f8e8ddc4418aa5e29f836", "author": {"user": {"login": "ClarenceThreepwood", "name": "Vivek"}}, "url": "https://github.com/prestodb/presto/commit/36876ac30fbd4bdb9f1f8e8ddc4418aa5e29f836", "committedDate": "2020-10-09T23:07:26Z", "message": "Add local cache for Parquet Metadata"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MDM1ODQ3", "url": "https://github.com/prestodb/presto/pull/15276#pullrequestreview-506035847", "createdAt": "2020-10-09T23:27:12Z", "commit": {"oid": "36876ac30fbd4bdb9f1f8e8ddc4418aa5e29f836"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQyMzoyNzoxMlrOHfbCxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQyMzoyNzoxMlrOHfbCxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjcxMDk4Mg==", "bodyText": "duplicate line?", "url": "https://github.com/prestodb/presto/pull/15276#discussion_r502710982", "createdAt": "2020-10-09T23:27:12Z", "author": {"login": "zhenxiao"}, "path": "presto-hive/src/test/java/com/facebook/presto/hive/parquet/AbstractTestParquetReader.java", "diffHunk": "@@ -1517,6 +1532,7 @@ private void setParquetLogging()\n     {\n         Logger.getLogger(ParquetOutputFormat.class.getName()).setLevel(Level.WARNING);\n         Logger.getLogger(CodecConfig.class.getName()).setLevel(Level.WARNING);\n+        Logger.getLogger(CodecConfig.class.getName()).setLevel(Level.WARNING);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36876ac30fbd4bdb9f1f8e8ddc4418aa5e29f836"}, "originalPosition": 58}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MTMyOTk2", "url": "https://github.com/prestodb/presto/pull/15276#pullrequestreview-506132996", "createdAt": "2020-10-10T23:44:30Z", "commit": {"oid": "36876ac30fbd4bdb9f1f8e8ddc4418aa5e29f836"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "36876ac30fbd4bdb9f1f8e8ddc4418aa5e29f836", "author": {"user": {"login": "ClarenceThreepwood", "name": "Vivek"}}, "url": "https://github.com/prestodb/presto/commit/36876ac30fbd4bdb9f1f8e8ddc4418aa5e29f836", "committedDate": "2020-10-09T23:07:26Z", "message": "Add local cache for Parquet Metadata"}, "afterCommit": {"oid": "6d862516ff850646dd98fabebbd2921851f36741", "author": {"user": {"login": "ClarenceThreepwood", "name": "Vivek"}}, "url": "https://github.com/prestodb/presto/commit/6d862516ff850646dd98fabebbd2921851f36741", "committedDate": "2020-10-12T17:22:36Z", "message": "Add local cache for Parquet Metadata"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6d862516ff850646dd98fabebbd2921851f36741", "author": {"user": {"login": "ClarenceThreepwood", "name": "Vivek"}}, "url": "https://github.com/prestodb/presto/commit/6d862516ff850646dd98fabebbd2921851f36741", "committedDate": "2020-10-12T17:22:36Z", "message": "Add local cache for Parquet Metadata"}, "afterCommit": {"oid": "90443df4c160ecc57d5b3590adca05d9ae4947c0", "author": {"user": {"login": "ClarenceThreepwood", "name": "Vivek"}}, "url": "https://github.com/prestodb/presto/commit/90443df4c160ecc57d5b3590adca05d9ae4947c0", "committedDate": "2020-10-12T19:38:33Z", "message": "Add local cache for Parquet Metadata"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2OTY3OTA1", "url": "https://github.com/prestodb/presto/pull/15276#pullrequestreview-506967905", "createdAt": "2020-10-12T23:06:38Z", "commit": {"oid": "90443df4c160ecc57d5b3590adca05d9ae4947c0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "90443df4c160ecc57d5b3590adca05d9ae4947c0", "author": {"user": {"login": "ClarenceThreepwood", "name": "Vivek"}}, "url": "https://github.com/prestodb/presto/commit/90443df4c160ecc57d5b3590adca05d9ae4947c0", "committedDate": "2020-10-12T19:38:33Z", "message": "Add local cache for Parquet Metadata"}, "afterCommit": {"oid": "b26a4543e1c571adaa3aefa9296d2a6381db36c6", "author": {"user": {"login": "ClarenceThreepwood", "name": "Vivek"}}, "url": "https://github.com/prestodb/presto/commit/b26a4543e1c571adaa3aefa9296d2a6381db36c6", "committedDate": "2020-10-13T19:11:57Z", "message": "Add local cache for Parquet Metadata"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8958a3dd7920575b3350cb1ddbcac805a6ad1f5", "author": {"user": {"login": "ClarenceThreepwood", "name": "Vivek"}}, "url": "https://github.com/prestodb/presto/commit/b8958a3dd7920575b3350cb1ddbcac805a6ad1f5", "committedDate": "2020-10-13T21:08:02Z", "message": "Add local cache for Parquet Metadata"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b26a4543e1c571adaa3aefa9296d2a6381db36c6", "author": {"user": {"login": "ClarenceThreepwood", "name": "Vivek"}}, "url": "https://github.com/prestodb/presto/commit/b26a4543e1c571adaa3aefa9296d2a6381db36c6", "committedDate": "2020-10-13T19:11:57Z", "message": "Add local cache for Parquet Metadata"}, "afterCommit": {"oid": "b8958a3dd7920575b3350cb1ddbcac805a6ad1f5", "author": {"user": {"login": "ClarenceThreepwood", "name": "Vivek"}}, "url": "https://github.com/prestodb/presto/commit/b8958a3dd7920575b3350cb1ddbcac805a6ad1f5", "committedDate": "2020-10-13T21:08:02Z", "message": "Add local cache for Parquet Metadata"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4859, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}