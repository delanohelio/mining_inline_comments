{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwNTE2Mzgw", "number": 15199, "title": "Fix encrypt large value", "bodyText": "Test plan - new unit test in AbstractTestOrcReader\n== RELEASE NOTES ==\nHive Changes\n* Fix a bug where DWRF encryption would fail for large uncompressed column values", "createdAt": "2020-09-21T19:38:29Z", "url": "https://github.com/prestodb/presto/pull/15199", "merged": true, "mergeCommit": {"oid": "6bb12b633eec281d0619b84d2851219511cbc018"}, "closed": true, "closedAt": "2020-09-23T14:23:38Z", "author": {"login": "rschlussel"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLIuaKABqjM3OTAyNzkxMTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLcvRvgBqjM3OTQ3Mzg2NTM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a7fe457960e8ca0454b2cec306dab2a3346b9944", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/a7fe457960e8ca0454b2cec306dab2a3346b9944", "committedDate": "2020-09-21T19:35:44Z", "message": "Fix dwrf encryption for large column valuess\n\nWe were using the incorrect offsets for the datat we were encrypting and\nfor the output buffer"}, "afterCommit": {"oid": "ccca0457a599fd036ea3521763759d13ef84d125", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/ccca0457a599fd036ea3521763759d13ef84d125", "committedDate": "2020-09-21T19:40:04Z", "message": "Fix dwrf encryption for large column valuess\n\nWe were using the incorrect offsets for the datat we were encrypting and\nfor the output buffer"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyOTI1MzAx", "url": "https://github.com/prestodb/presto/pull/15199#pullrequestreview-492925301", "createdAt": "2020-09-21T19:42:21Z", "commit": {"oid": "ccca0457a599fd036ea3521763759d13ef84d125"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxOTo0MjoyMlrOHVfzfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxOTo0MjoyMlrOHVfzfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjMwMzIzMA==", "bodyText": "this test doesn't use testRoundTrip() because there is some bug with the hive reader reading the list value test (unrelated to encryption)", "url": "https://github.com/prestodb/presto/pull/15199#discussion_r492303230", "createdAt": "2020-09-21T19:42:22Z", "author": {"login": "rschlussel"}, "path": "presto-orc/src/test/java/com/facebook/presto/orc/AbstractTestOrcReader.java", "diffHunk": "@@ -493,6 +494,19 @@ public void testDwrfInvalidCheckpointsForStripeDictionary()\n                         .collect(toList()));\n     }\n \n+    @Test\n+    public void testExtraLargeColumnValue()\n+            throws Exception\n+    {\n+\n+        Random rnd = new Random(0);\n+        String val = rnd.doubles(50_000).mapToObj(Double::toString).collect(Collectors.joining(\",\"));\n+        tester.assertRoundTrip(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccca0457a599fd036ea3521763759d13ef84d125"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyOTMxMjg3", "url": "https://github.com/prestodb/presto/pull/15199#pullrequestreview-492931287", "createdAt": "2020-09-21T19:51:40Z", "commit": {"oid": "ccca0457a599fd036ea3521763759d13ef84d125"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxOTo1MTo0MFrOHVgGTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxOTo1MTo0MFrOHVgGTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjMwODA0NA==", "bodyText": "The message has two %s placeholders, it should either have two length arguments or not have the last %s.", "url": "https://github.com/prestodb/presto/pull/15199#discussion_r492308044", "createdAt": "2020-09-21T19:51:40Z", "author": {"login": "sdruzkin"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/OrcOutputBuffer.java", "diffHunk": "@@ -446,35 +446,31 @@ private void writeChunkToOutputStream(byte[] chunk, int offset, int length)\n \n         checkArgument(length <= buffer.length, \"Write chunk length must be less than compression buffer size\");\n \n+        boolean isCompressed = false;\n         if (compressor != null) {\n             int minCompressionBufferSize = compressor.maxCompressedLength(length);\n             if (compressionBuffer.length < minCompressionBufferSize) {\n                 compressionBuffer = new byte[minCompressionBufferSize];\n             }\n             int compressedSize = compressor.compress(chunk, offset, length, compressionBuffer, 0, compressionBuffer.length);\n             if (compressedSize < length) {\n-                if (dwrfEncryptor.isPresent()) {\n-                    compressionBuffer = dwrfEncryptor.get().encrypt(compressionBuffer, 0, compressedSize);\n-                    compressedSize = compressionBuffer.length;\n-                    // size after encryption should not exceed what the 3 byte header can hold (2^23)\n-                    if (compressedSize > 8388608) {\n-                        throw new OrcEncryptionException(\"Encrypted data size %s exceeds limit of 2^23 %s\", compressedSize);\n-                    }\n-                }\n-                int chunkHeader = (compressedSize << 1);\n-                writeChunkedOutput(compressionBuffer, 0, compressedSize, chunkHeader);\n-                return;\n+                isCompressed = true;\n+                chunk = compressionBuffer;\n+                length = compressedSize;\n+                offset = 0;\n             }\n         }\n         if (dwrfEncryptor.isPresent()) {\n-            chunk = dwrfEncryptor.get().encrypt(chunk, 0, length);\n+            chunk = dwrfEncryptor.get().encrypt(chunk, offset, length);\n             length = chunk.length;\n+            offset = 0;\n             // size after encryption should not exceed what the 3 byte header can hold (2^23)\n             if (length > 8388608) {\n                 throw new OrcEncryptionException(\"Encrypted data size %s exceeds limit of 2^23 %s\", length);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccca0457a599fd036ea3521763759d13ef84d125"}, "originalPosition": 36}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f83e4b68344cfab4049f23903cbe58cb213892a5", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/f83e4b68344cfab4049f23903cbe58cb213892a5", "committedDate": "2020-09-21T20:16:11Z", "message": "Fix error message formatting"}, "afterCommit": {"oid": "30228870aa3d20293f2c92f1db579d9aaf0b79b3", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/30228870aa3d20293f2c92f1db579d9aaf0b79b3", "committedDate": "2020-09-21T20:19:06Z", "message": "Fix error message formatting"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNzUwODA5", "url": "https://github.com/prestodb/presto/pull/15199#pullrequestreview-493750809", "createdAt": "2020-09-22T18:47:30Z", "commit": {"oid": "30228870aa3d20293f2c92f1db579d9aaf0b79b3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNzUxMDMy", "url": "https://github.com/prestodb/presto/pull/15199#pullrequestreview-493751032", "createdAt": "2020-09-22T18:47:48Z", "commit": {"oid": "30228870aa3d20293f2c92f1db579d9aaf0b79b3"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "353ba0a129e044d6075dd7797f6f3fa8ae68639a", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/353ba0a129e044d6075dd7797f6f3fa8ae68639a", "committedDate": "2020-09-22T18:59:01Z", "message": "Fix dwrf encryption for large column values\n\nWe were using the incorrect offsets for the data we were encrypting and\nfor the output buffer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "217e24b9245dd479963086af5247bb791cc31737", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/217e24b9245dd479963086af5247bb791cc31737", "committedDate": "2020-09-22T18:59:01Z", "message": "Fix error message formatting"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "30228870aa3d20293f2c92f1db579d9aaf0b79b3", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/30228870aa3d20293f2c92f1db579d9aaf0b79b3", "committedDate": "2020-09-21T20:19:06Z", "message": "Fix error message formatting"}, "afterCommit": {"oid": "217e24b9245dd479963086af5247bb791cc31737", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/217e24b9245dd479963086af5247bb791cc31737", "committedDate": "2020-09-22T18:59:01Z", "message": "Fix error message formatting"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 178, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}