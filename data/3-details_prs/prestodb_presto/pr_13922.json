{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU5MDg0OTEz", "number": 13922, "title": "Improve error handling for geometry deserialization edge cases", "bodyText": "Certain geometries could be constructed (via GeometryFromText), but\ncould not be deserialized: it raised non-PrestoException exceptions that\nbubbled up as non-catchable GenericInternalExceptions.  This is a bad\nuser experience!  This change catches those and raise catchable\nPrestoExceptions.\n== RELEASE NOTES ==\n\nGeneral Changes\n* Improve error handling for geometry deserialization edge cases.", "createdAt": "2020-01-03T18:49:19Z", "url": "https://github.com/prestodb/presto/pull/13922", "merged": true, "mergeCommit": {"oid": "fbb9e987f12a2d3b6ff2c0d041dbd6cf2f6fcca9"}, "closed": true, "closedAt": "2020-01-10T18:39:41Z", "author": {"login": "jagill"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb4YCMEABqjI5MzE5MDUyNDU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb5BbtZgFqTM0MTI5MDEyNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a4d8a11807225378818c351cc951d3df1c1a60d2", "author": {"user": {"login": "jagill", "name": "James Gill"}}, "url": "https://github.com/prestodb/presto/commit/a4d8a11807225378818c351cc951d3df1c1a60d2", "committedDate": "2020-01-03T18:44:21Z", "message": "Capture geometry deserialization failures\n\nCertain geometries could be constructed (via GeometryFromText), but\ncould not be deserialized: it raised non-PrestoException exceptions that\nbubbled up as non-catchable GenericInternalExceptions.  This is a bad\nuser experience!  This change catches those and raise catchable\nPrestoExceptions."}, "afterCommit": {"oid": "58d5d39cb936a03430db4a97319838b8b431ad29", "author": {"user": {"login": "jagill", "name": "James Gill"}}, "url": "https://github.com/prestodb/presto/commit/58d5d39cb936a03430db4a97319838b8b431ad29", "committedDate": "2020-01-08T16:34:37Z", "message": "Capture geometry deserialization failures\n\nCertain geometries could be constructed (via GeometryFromText), but\ncould not be deserialized: it raised non-PrestoException exceptions that\nbubbled up as non-catchable GenericInternalExceptions.  This is a bad\nuser experience!  This change catches those and raise catchable\nPrestoExceptions."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwMDc3MTM1", "url": "https://github.com/prestodb/presto/pull/13922#pullrequestreview-340077135", "createdAt": "2020-01-08T19:03:01Z", "commit": {"oid": "58d5d39cb936a03430db4a97319838b8b431ad29"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQxOTowMzowMVrOFbgwKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQxOToyNDo0MFrOFbhV0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDM5MjQ5MQ==", "bodyText": "Is this error path tested exercised by any test? Looks like deserialize catches the GeometryException and wraps it so is this necessary?", "url": "https://github.com/prestodb/presto/pull/13922#discussion_r364392491", "createdAt": "2020-01-08T19:03:01Z", "author": {"login": "aweisberg"}, "path": "presto-geospatial/src/main/java/com/facebook/presto/plugin/geospatial/GeometryType.java", "diffHunk": "@@ -83,6 +86,11 @@ public Object getObjectValue(ConnectorSession session, Block block, int position\n             return null;\n         }\n         Slice slice = block.getSlice(position, 0, block.getSliceLength(position));\n-        return deserialize(slice).asText();\n+        try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58d5d39cb936a03430db4a97319838b8b431ad29"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQwMjEyOA==", "bodyText": "When I ran TestGeometrySerialization I didn't see this exercised in the debugger.", "url": "https://github.com/prestodb/presto/pull/13922#discussion_r364402128", "createdAt": "2020-01-08T19:24:40Z", "author": {"login": "aweisberg"}, "path": "presto-geospatial-toolkit/src/main/java/com/facebook/presto/geospatial/serde/EsriGeometrySerde.java", "diffHunk": "@@ -171,7 +174,12 @@ public static OGCGeometry deserialize(Slice shape)\n         verify(input.available() > 0);\n         int length = input.available() - 1;\n         GeometrySerializationType type = GeometrySerializationType.getForCode(input.readByte());\n-        return readGeometry(input, shape, type, length);\n+        try {\n+            return readGeometry(input, shape, type, length);\n+        }\n+        catch (GeometryException e) {\n+            throw new PrestoException(INVALID_FUNCTION_ARGUMENT, e.getMessage(), e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58d5d39cb936a03430db4a97319838b8b431ad29"}, "originalPosition": 33}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "58d5d39cb936a03430db4a97319838b8b431ad29", "author": {"user": {"login": "jagill", "name": "James Gill"}}, "url": "https://github.com/prestodb/presto/commit/58d5d39cb936a03430db4a97319838b8b431ad29", "committedDate": "2020-01-08T16:34:37Z", "message": "Capture geometry deserialization failures\n\nCertain geometries could be constructed (via GeometryFromText), but\ncould not be deserialized: it raised non-PrestoException exceptions that\nbubbled up as non-catchable GenericInternalExceptions.  This is a bad\nuser experience!  This change catches those and raise catchable\nPrestoExceptions."}, "afterCommit": {"oid": "7ba109f08540567edccd7111368adb5484a7bb37", "author": {"user": {"login": "jagill", "name": "James Gill"}}, "url": "https://github.com/prestodb/presto/commit/7ba109f08540567edccd7111368adb5484a7bb37", "committedDate": "2020-01-08T20:21:12Z", "message": "Capture geometry deserialization failures\n\nCertain geometries could be constructed (via GeometryFromText), but\ncould not be deserialized: it raised non-PrestoException exceptions that\nbubbled up as non-catchable GenericInternalExceptions.  This is a bad\nuser experience!  This change catches those and raise catchable\nPrestoExceptions."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7ba109f08540567edccd7111368adb5484a7bb37", "author": {"user": {"login": "jagill", "name": "James Gill"}}, "url": "https://github.com/prestodb/presto/commit/7ba109f08540567edccd7111368adb5484a7bb37", "committedDate": "2020-01-08T20:21:12Z", "message": "Capture geometry deserialization failures\n\nCertain geometries could be constructed (via GeometryFromText), but\ncould not be deserialized: it raised non-PrestoException exceptions that\nbubbled up as non-catchable GenericInternalExceptions.  This is a bad\nuser experience!  This change catches those and raise catchable\nPrestoExceptions."}, "afterCommit": {"oid": "58d5d39cb936a03430db4a97319838b8b431ad29", "author": {"user": {"login": "jagill", "name": "James Gill"}}, "url": "https://github.com/prestodb/presto/commit/58d5d39cb936a03430db4a97319838b8b431ad29", "committedDate": "2020-01-08T16:34:37Z", "message": "Capture geometry deserialization failures\n\nCertain geometries could be constructed (via GeometryFromText), but\ncould not be deserialized: it raised non-PrestoException exceptions that\nbubbled up as non-catchable GenericInternalExceptions.  This is a bad\nuser experience!  This change catches those and raise catchable\nPrestoExceptions."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "155871f93e34f0f06a46729e441f3d5076e4b122", "author": {"user": {"login": "jagill", "name": "James Gill"}}, "url": "https://github.com/prestodb/presto/commit/155871f93e34f0f06a46729e441f3d5076e4b122", "committedDate": "2020-01-09T21:30:34Z", "message": "Use helper method jtsGeometryFromWkt"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28b3d8eba67952e70244c66ec9fd006a6a68bb69", "author": {"user": {"login": "jagill", "name": "James Gill"}}, "url": "https://github.com/prestodb/presto/commit/28b3d8eba67952e70244c66ec9fd006a6a68bb69", "committedDate": "2020-01-09T21:30:34Z", "message": "Capture geometry deserialization failures\n\nCertain geometries could be constructed (via GeometryFromText), but\ncould not be deserialized: it raised non-PrestoException exceptions that\nbubbled up as non-catchable GenericInternalExceptions.  This is a bad\nuser experience!  This change catches those and raise catchable\nPrestoExceptions."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "58d5d39cb936a03430db4a97319838b8b431ad29", "author": {"user": {"login": "jagill", "name": "James Gill"}}, "url": "https://github.com/prestodb/presto/commit/58d5d39cb936a03430db4a97319838b8b431ad29", "committedDate": "2020-01-08T16:34:37Z", "message": "Capture geometry deserialization failures\n\nCertain geometries could be constructed (via GeometryFromText), but\ncould not be deserialized: it raised non-PrestoException exceptions that\nbubbled up as non-catchable GenericInternalExceptions.  This is a bad\nuser experience!  This change catches those and raise catchable\nPrestoExceptions."}, "afterCommit": {"oid": "28b3d8eba67952e70244c66ec9fd006a6a68bb69", "author": {"user": {"login": "jagill", "name": "James Gill"}}, "url": "https://github.com/prestodb/presto/commit/28b3d8eba67952e70244c66ec9fd006a6a68bb69", "committedDate": "2020-01-09T21:30:34Z", "message": "Capture geometry deserialization failures\n\nCertain geometries could be constructed (via GeometryFromText), but\ncould not be deserialized: it raised non-PrestoException exceptions that\nbubbled up as non-catchable GenericInternalExceptions.  This is a bad\nuser experience!  This change catches those and raise catchable\nPrestoExceptions."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwODM4ODIw", "url": "https://github.com/prestodb/presto/pull/13922#pullrequestreview-340838820", "createdAt": "2020-01-09T21:53:47Z", "commit": {"oid": "28b3d8eba67952e70244c66ec9fd006a6a68bb69"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxMjkwMTI3", "url": "https://github.com/prestodb/presto/pull/13922#pullrequestreview-341290127", "createdAt": "2020-01-10T16:48:47Z", "commit": {"oid": "28b3d8eba67952e70244c66ec9fd006a6a68bb69"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4444, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}