{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI0OTM2Nzc5", "number": 14589, "title": "Do not return MapBlock's hashtables in Optional", "bodyText": "In recent production workload we observed large amount of memory\nallocation on the Optional objects when getting a MapBlock's hashtables,\nand it resulted in high GC activities that could lead to reliability\nissues. This commit directly returns the hashtables in raw int array\nwithout wrapping it up with Optional.\n== NO RELEASE NOTE ==", "createdAt": "2020-05-29T07:32:25Z", "url": "https://github.com/prestodb/presto/pull/14589", "merged": true, "mergeCommit": {"oid": "78922f8a4a8cd797e1f7bbff8177bd7d98bc6126"}, "closed": true, "closedAt": "2020-06-03T13:29:45Z", "author": {"login": "yingsu00"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcl_SFRgBqjMzODY0NTA2Njg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcnNOBygBqjMzOTU4MDU3NTI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4da487ef55d2d6ff3b0aa8c179f53885dfe1c1a6", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/4da487ef55d2d6ff3b0aa8c179f53885dfe1c1a6", "committedDate": "2020-05-29T07:28:12Z", "message": "Do not return MapBlock's hashtables in Optional\n\nIn recent production workload we observed large amount of memory\nallocation on the Optional objects when getting a MapBlock's hashtables.\nThis commit directly return the hashtables in raw int array without\nwrapping it up with Optional."}, "afterCommit": {"oid": "90db029e63c770082352a5ed5c0a5381dd8a4b4b", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/90db029e63c770082352a5ed5c0a5381dd8a4b4b", "committedDate": "2020-05-29T09:44:38Z", "message": "Do not return MapBlock's hashtables in Optional\n\nIn recent production workload we observed large amount of memory\nallocation on the Optional objects when getting a MapBlock's hashtables.\nThis commit directly returns the hashtables in raw int array without\nwrapping it up with Optional."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxODgxMTE5", "url": "https://github.com/prestodb/presto/pull/14589#pullrequestreview-421881119", "createdAt": "2020-06-01T14:17:15Z", "commit": {"oid": "90db029e63c770082352a5ed5c0a5381dd8a4b4b"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxNDoxNzoxNVrOGdMJ_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxNDoxNzo0M1rOGdMLEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzI2MTA1Mg==", "bodyText": "nit: add @nullable here as well?", "url": "https://github.com/prestodb/presto/pull/14589#discussion_r433261052", "createdAt": "2020-06-01T14:17:15Z", "author": {"login": "mbasmanova"}, "path": "presto-common/src/main/java/com/facebook/presto/common/block/ColumnarMap.java", "diffHunk": "@@ -217,9 +217,9 @@ public Type getKeyType()\n         return keyType;\n     }\n \n-    public Optional<int[]> getHashTables()\n+    public int[] getHashTables()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "90db029e63c770082352a5ed5c0a5381dd8a4b4b"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzI2MTMzMA==", "bodyText": "nit: empty -> null here and in other places", "url": "https://github.com/prestodb/presto/pull/14589#discussion_r433261330", "createdAt": "2020-06-01T14:17:43Z", "author": {"login": "mbasmanova"}, "path": "presto-common/src/main/java/com/facebook/presto/common/block/MapBlockBuilder.java", "diffHunk": "@@ -203,14 +203,14 @@ public BlockBuilder closeEntry()\n         int previousAggregatedEntryCount = offsets[positionCount - 1];\n         int aggregatedEntryCount = offsets[positionCount];\n         int entryCount = aggregatedEntryCount - previousAggregatedEntryCount;\n-        Optional<int[]> rawHashTables = hashTables.get();\n-        verify(rawHashTables.isPresent(), \"rawHashTables is empty\");\n+        int[] rawHashTables = hashTables.get();\n+        verify(rawHashTables != null, \"rawHashTables is empty\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "90db029e63c770082352a5ed5c0a5381dd8a4b4b"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4bfcb89abf611471930ede17a1a701dde0c8e3a4", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/4bfcb89abf611471930ede17a1a701dde0c8e3a4", "committedDate": "2020-06-02T04:29:41Z", "message": "Do not return MapBlock's hashtables in Optional\n\nIn recent production workload we observed large amount of memory\nallocation on the Optional objects when getting a MapBlock's hashtables,\nand it resulted in high GC activities that could lead to reliability\nissues. This commit directly returns the hashtables in raw int array\nwithout wrapping it up with Optional."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "90db029e63c770082352a5ed5c0a5381dd8a4b4b", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/90db029e63c770082352a5ed5c0a5381dd8a4b4b", "committedDate": "2020-05-29T09:44:38Z", "message": "Do not return MapBlock's hashtables in Optional\n\nIn recent production workload we observed large amount of memory\nallocation on the Optional objects when getting a MapBlock's hashtables.\nThis commit directly returns the hashtables in raw int array without\nwrapping it up with Optional."}, "afterCommit": {"oid": "4bfcb89abf611471930ede17a1a701dde0c8e3a4", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/4bfcb89abf611471930ede17a1a701dde0c8e3a4", "committedDate": "2020-06-02T04:29:41Z", "message": "Do not return MapBlock's hashtables in Optional\n\nIn recent production workload we observed large amount of memory\nallocation on the Optional objects when getting a MapBlock's hashtables,\nand it resulted in high GC activities that could lead to reliability\nissues. This commit directly returns the hashtables in raw int array\nwithout wrapping it up with Optional."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1722, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}