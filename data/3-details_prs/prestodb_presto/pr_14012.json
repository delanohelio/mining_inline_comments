{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY2OTYzNjky", "number": 14012, "title": "Remote plan execution", "bodyText": "Resolves #14053\ndepended by facebookexternal/presto-facebook#1149", "createdAt": "2020-01-24T18:37:24Z", "url": "https://github.com/prestodb/presto/pull/14012", "merged": true, "mergeCommit": {"oid": "aaeff3f8360a09c1f64c8feb05354e1ca527d37d"}, "closed": true, "closedAt": "2020-09-15T19:38:56Z", "author": {"login": "rongrong"}, "timelineItems": {"totalCount": 40, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb-kDSAABqjI5ODM1NTc3MzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJNGjwgBqjM3NzAwMDQ4NTk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "81eed203959bf2e54d276b88fac2f0c9a095be44", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/81eed203959bf2e54d276b88fac2f0c9a095be44", "committedDate": "2020-01-24T03:15:30Z", "message": "Execute thrift remote functions"}, "afterCommit": {"oid": "934c0d187effec8593a28a5aeeaf3149c17006f6", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/934c0d187effec8593a28a5aeeaf3149c17006f6", "committedDate": "2020-01-27T21:57:54Z", "message": "Execute thrift remote functions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "934c0d187effec8593a28a5aeeaf3149c17006f6", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/934c0d187effec8593a28a5aeeaf3149c17006f6", "committedDate": "2020-01-27T21:57:54Z", "message": "Execute thrift remote functions"}, "afterCommit": {"oid": "0c66a28b7594f3515a64db1ab2a1e601db10fac6", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/0c66a28b7594f3515a64db1ab2a1e601db10fac6", "committedDate": "2020-01-27T22:29:41Z", "message": "Execute thrift remote functions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0c66a28b7594f3515a64db1ab2a1e601db10fac6", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/0c66a28b7594f3515a64db1ab2a1e601db10fac6", "committedDate": "2020-01-27T22:29:41Z", "message": "Execute thrift remote functions"}, "afterCommit": {"oid": "324372bf80df64dbd000e99b45fdba269c87d1f5", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/324372bf80df64dbd000e99b45fdba269c87d1f5", "committedDate": "2020-01-28T00:20:30Z", "message": "Execute thrift remote functions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "324372bf80df64dbd000e99b45fdba269c87d1f5", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/324372bf80df64dbd000e99b45fdba269c87d1f5", "committedDate": "2020-01-28T00:20:30Z", "message": "Execute thrift remote functions"}, "afterCommit": {"oid": "8796b287d62e90b90ff021769b4dd29b2008b0d4", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/8796b287d62e90b90ff021769b4dd29b2008b0d4", "committedDate": "2020-01-28T01:05:02Z", "message": "Execute thrift remote functions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8796b287d62e90b90ff021769b4dd29b2008b0d4", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/8796b287d62e90b90ff021769b4dd29b2008b0d4", "committedDate": "2020-01-28T01:05:02Z", "message": "Execute thrift remote functions"}, "afterCommit": {"oid": "e58a5a7d8029e7a6f44a3bccf8449388451ecee7", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/e58a5a7d8029e7a6f44a3bccf8449388451ecee7", "committedDate": "2020-02-04T04:36:29Z", "message": "Do not push predicate with remote function"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e58a5a7d8029e7a6f44a3bccf8449388451ecee7", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/e58a5a7d8029e7a6f44a3bccf8449388451ecee7", "committedDate": "2020-02-04T04:36:29Z", "message": "Do not push predicate with remote function"}, "afterCommit": {"oid": "3df2ad49af64f35f2a795c5dd75f6033cf5ae316", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/3df2ad49af64f35f2a795c5dd75f6033cf5ae316", "committedDate": "2020-03-04T21:57:34Z", "message": "Execute thrift remote functions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3df2ad49af64f35f2a795c5dd75f6033cf5ae316", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/3df2ad49af64f35f2a795c5dd75f6033cf5ae316", "committedDate": "2020-03-04T21:57:34Z", "message": "Execute thrift remote functions"}, "afterCommit": {"oid": "e2f5ad88af920a70fcf167afd2b136ebeb1c1196", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/e2f5ad88af920a70fcf167afd2b136ebeb1c1196", "committedDate": "2020-03-11T22:38:33Z", "message": "Execute thrift remote functions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e2f5ad88af920a70fcf167afd2b136ebeb1c1196", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/e2f5ad88af920a70fcf167afd2b136ebeb1c1196", "committedDate": "2020-03-11T22:38:33Z", "message": "Execute thrift remote functions"}, "afterCommit": {"oid": "e46e379c681783f5783e17d0c38925d0477d3912", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/e46e379c681783f5783e17d0c38925d0477d3912", "committedDate": "2020-03-12T00:58:17Z", "message": "Execute thrift remote functions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e46e379c681783f5783e17d0c38925d0477d3912", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/e46e379c681783f5783e17d0c38925d0477d3912", "committedDate": "2020-03-12T00:58:17Z", "message": "Execute thrift remote functions"}, "afterCommit": {"oid": "f893ce805afab2ae824f507350ef65865e5d28ab", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/f893ce805afab2ae824f507350ef65865e5d28ab", "committedDate": "2020-03-18T21:51:22Z", "message": "Execute thrift remote functions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f893ce805afab2ae824f507350ef65865e5d28ab", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/f893ce805afab2ae824f507350ef65865e5d28ab", "committedDate": "2020-03-18T21:51:22Z", "message": "Execute thrift remote functions"}, "afterCommit": {"oid": "8192db1b76b6c8e9984ee6d306ec92cf02f8a1e2", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/8192db1b76b6c8e9984ee6d306ec92cf02f8a1e2", "committedDate": "2020-06-10T21:52:10Z", "message": "Execute thrift remote functions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8192db1b76b6c8e9984ee6d306ec92cf02f8a1e2", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/8192db1b76b6c8e9984ee6d306ec92cf02f8a1e2", "committedDate": "2020-06-10T21:52:10Z", "message": "Execute thrift remote functions"}, "afterCommit": {"oid": "f1c3623aae7ba3fdc6d7751d52b54be3ef4eecde", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/f1c3623aae7ba3fdc6d7751d52b54be3ef4eecde", "committedDate": "2020-06-11T22:37:32Z", "message": "Explicitly not supporting external functions in lambda and join filter\n\nWe check the filter predicate in JOIN in PlanSanityChecker so we can cover\ncorrelated IN and lateral join that are converted to JOIN with filter predicate."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fec2649e9b836e009fd0c0e2c76e8f39057ba208", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/fec2649e9b836e009fd0c0e2c76e8f39057ba208", "committedDate": "2020-06-12T01:41:23Z", "message": "Execute thrift remote functions"}, "afterCommit": {"oid": "805d998a9e2fa3a15fbe6c82d1a982a400ea5029", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/805d998a9e2fa3a15fbe6c82d1a982a400ea5029", "committedDate": "2020-06-12T19:16:16Z", "message": "Execute thrift remote functions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "805d998a9e2fa3a15fbe6c82d1a982a400ea5029", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/805d998a9e2fa3a15fbe6c82d1a982a400ea5029", "committedDate": "2020-06-12T19:16:16Z", "message": "Execute thrift remote functions"}, "afterCommit": {"oid": "b49c01e64950a707e971b569eb9ad1abfbe4c512", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/b49c01e64950a707e971b569eb9ad1abfbe4c512", "committedDate": "2020-06-12T19:35:48Z", "message": "Execute thrift remote functions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b49c01e64950a707e971b569eb9ad1abfbe4c512", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/b49c01e64950a707e971b569eb9ad1abfbe4c512", "committedDate": "2020-06-12T19:35:48Z", "message": "Execute thrift remote functions"}, "afterCommit": {"oid": "a4595397216365d999da2ac20557aee8343f96b5", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/a4595397216365d999da2ac20557aee8343f96b5", "committedDate": "2020-06-12T20:18:51Z", "message": "Execute thrift remote functions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a4595397216365d999da2ac20557aee8343f96b5", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/a4595397216365d999da2ac20557aee8343f96b5", "committedDate": "2020-06-12T20:18:51Z", "message": "Execute thrift remote functions"}, "afterCommit": {"oid": "d27084d255000e69f1fd8bac49d7cee4d179adf6", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/d27084d255000e69f1fd8bac49d7cee4d179adf6", "committedDate": "2020-06-12T21:59:46Z", "message": "Execute thrift remote functions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d27084d255000e69f1fd8bac49d7cee4d179adf6", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/d27084d255000e69f1fd8bac49d7cee4d179adf6", "committedDate": "2020-06-12T21:59:46Z", "message": "Execute thrift remote functions"}, "afterCommit": {"oid": "a46b880dd980d26fd85243c65121f5fcf5444add", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/a46b880dd980d26fd85243c65121f5fcf5444add", "committedDate": "2020-09-01T18:51:48Z", "message": "Support Remote function execution"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwMjAyMzc2", "url": "https://github.com/prestodb/presto/pull/14012#pullrequestreview-480202376", "createdAt": "2020-09-02T00:20:09Z", "commit": {"oid": "8e3641cb677d538d6034ac8d12b9f0c6d1f901db"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwMDoyMDowOVrOHLMl3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwMDoyMDowOVrOHLMl3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTUwMjY4NQ==", "bodyText": "We now have a nested config represented by JSON, and those config are actually defined to be passed in as part of drift SimpleAddressSelectorConfig. I think we can improve how the configuration are specified here.\nFor each language there will be a single required config implementationType. e.g.\nsql.implementation-type=build-in\njava.implementation-type=thrift\n\nThen depending on the value of the implementation type, we bind additional config in the module. e.g.\njava.thrift.address=....\njava.thrift.retry-same-address=...\n\nThis would make the config more readable.", "url": "https://github.com/prestodb/presto/pull/14012#discussion_r481502685", "createdAt": "2020-09-02T00:20:09Z", "author": {"login": "caithagoras"}, "path": "presto-function-namespace-managers/src/main/java/com/facebook/presto/functionNamespace/execution/SimpleAddressSqlFunctionLanguageConfigSpec.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.functionNamespace.execution;\n+\n+import com.facebook.presto.spi.function.FunctionImplementationType;\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+import java.util.Objects;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.spi.function.FunctionImplementationType.SQL;\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.lang.String.format;\n+import static java.util.Objects.requireNonNull;\n+\n+public class SimpleAddressSqlFunctionLanguageConfigSpec\n+{\n+    private final FunctionImplementationType implementationType;\n+    private final Optional<String> addresses;\n+    private final boolean retrySameAddress;\n+\n+    @JsonCreator\n+    public SimpleAddressSqlFunctionLanguageConfigSpec(\n+            @JsonProperty(\"implementation-type\") FunctionImplementationType implementationType,\n+            @JsonProperty(\"addresses\") Optional<String> addresses,\n+            @JsonProperty(\"retry-same-address\") boolean retrySameAddress)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e3641cb677d538d6034ac8d12b9f0c6d1f901db"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwMjk0NTE1", "url": "https://github.com/prestodb/presto/pull/14012#pullrequestreview-480294515", "createdAt": "2020-09-02T01:27:10Z", "commit": {"oid": "a46b880dd980d26fd85243c65121f5fcf5444add"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwMToyNzoxMFrOHLODvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwMTozMzozNlrOHLOT1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTUyNjcxNg==", "bodyText": "See the comment in the constructor, and you don't need this check.", "url": "https://github.com/prestodb/presto/pull/14012#discussion_r481526716", "createdAt": "2020-09-02T01:27:10Z", "author": {"login": "caithagoras"}, "path": "presto-function-namespace-managers/src/main/java/com/facebook/presto/functionNamespace/execution/thrift/ThriftSqlFunctionExecutor.java", "diffHunk": "@@ -0,0 +1,81 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.functionNamespace.execution.thrift;\n+\n+import com.facebook.drift.TException;\n+import com.facebook.drift.client.DriftClient;\n+import com.facebook.presto.common.NotSupportedException;\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.common.block.Block;\n+import com.facebook.presto.common.type.Type;\n+import com.facebook.presto.common.type.TypeSignature;\n+import com.facebook.presto.spi.PrestoException;\n+import com.facebook.presto.spi.function.SqlFunctionHandle;\n+import com.facebook.presto.spi.function.SqlFunctionId;\n+import com.facebook.presto.spi.function.ThriftScalarFunctionImplementation;\n+import com.facebook.presto.thrift.api.datatypes.PrestoThriftBlock;\n+import com.facebook.presto.thrift.api.udf.ThriftFunctionHandle;\n+import com.facebook.presto.thrift.api.udf.ThriftUdfService;\n+import com.facebook.presto.thrift.api.udf.ThriftUdfServiceException;\n+import com.google.common.collect.ImmutableList;\n+import com.google.inject.Inject;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.concurrent.CompletableFuture;\n+\n+import static com.facebook.airlift.concurrent.MoreFutures.toCompletableFuture;\n+import static com.facebook.presto.spi.StandardErrorCode.GENERIC_INTERNAL_ERROR;\n+import static com.facebook.presto.thrift.api.udf.ThriftUdfPage.thriftPage;\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+\n+public class ThriftSqlFunctionExecutor\n+{\n+    private final DriftClient<ThriftUdfService> thriftUdfClient;\n+\n+    @Inject\n+    public ThriftSqlFunctionExecutor(DriftClient<ThriftUdfService> thriftUdfClient)\n+    {\n+        this.thriftUdfClient = thriftUdfClient;\n+    }\n+\n+    public CompletableFuture<Block> executeFunction(ThriftScalarFunctionImplementation functionImplementation, Page input, List<Integer> channels, List<Type> argumentTypes, Type returnType)\n+    {\n+        if (thriftUdfClient == null) {\n+            throw new NotSupportedException(\"Thrift Function not supported\");\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a46b880dd980d26fd85243c65121f5fcf5444add"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTUyODI5MQ==", "bodyText": "Add requireNonNull.\n\nGuice usually doesn't inject nulls. If binding does not exists, it simply throws.\nBecause you're binding this DriftClient and this ThriftSqlFunctionExecutor at the same time in SimpleAddressThriftSqlFunctionExecutionModule, DriftClient always exists.", "url": "https://github.com/prestodb/presto/pull/14012#discussion_r481528291", "createdAt": "2020-09-02T01:29:43Z", "author": {"login": "caithagoras"}, "path": "presto-function-namespace-managers/src/main/java/com/facebook/presto/functionNamespace/execution/thrift/ThriftSqlFunctionExecutor.java", "diffHunk": "@@ -0,0 +1,81 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.functionNamespace.execution.thrift;\n+\n+import com.facebook.drift.TException;\n+import com.facebook.drift.client.DriftClient;\n+import com.facebook.presto.common.NotSupportedException;\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.common.block.Block;\n+import com.facebook.presto.common.type.Type;\n+import com.facebook.presto.common.type.TypeSignature;\n+import com.facebook.presto.spi.PrestoException;\n+import com.facebook.presto.spi.function.SqlFunctionHandle;\n+import com.facebook.presto.spi.function.SqlFunctionId;\n+import com.facebook.presto.spi.function.ThriftScalarFunctionImplementation;\n+import com.facebook.presto.thrift.api.datatypes.PrestoThriftBlock;\n+import com.facebook.presto.thrift.api.udf.ThriftFunctionHandle;\n+import com.facebook.presto.thrift.api.udf.ThriftUdfService;\n+import com.facebook.presto.thrift.api.udf.ThriftUdfServiceException;\n+import com.google.common.collect.ImmutableList;\n+import com.google.inject.Inject;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.concurrent.CompletableFuture;\n+\n+import static com.facebook.airlift.concurrent.MoreFutures.toCompletableFuture;\n+import static com.facebook.presto.spi.StandardErrorCode.GENERIC_INTERNAL_ERROR;\n+import static com.facebook.presto.thrift.api.udf.ThriftUdfPage.thriftPage;\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+\n+public class ThriftSqlFunctionExecutor\n+{\n+    private final DriftClient<ThriftUdfService> thriftUdfClient;\n+\n+    @Inject\n+    public ThriftSqlFunctionExecutor(DriftClient<ThriftUdfService> thriftUdfClient)\n+    {\n+        this.thriftUdfClient = thriftUdfClient;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a46b880dd980d26fd85243c65121f5fcf5444add"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTUzMDgzNw==", "bodyText": "Can we expose a method ScalarFunctionImplementation.getImplemenrationType() and another method SqlFunctionExecutors.getExecutor(ImplementationType)? That way, we can avoid the check and avoid mentioning anything about thrift in this method.", "url": "https://github.com/prestodb/presto/pull/14012#discussion_r481530837", "createdAt": "2020-09-02T01:33:36Z", "author": {"login": "caithagoras"}, "path": "presto-function-namespace-managers/src/main/java/com/facebook/presto/functionNamespace/AbstractSqlInvokedFunctionNamespaceManager.java", "diffHunk": "@@ -174,6 +179,21 @@ public final ScalarFunctionImplementation getScalarFunctionImplementation(Functi\n         return implementationByHandle.getUnchecked((SqlFunctionHandle) functionHandle);\n     }\n \n+    @Override\n+    public CompletableFuture<Block> executeFunction(FunctionHandle functionHandle, Page input, List<Integer> channels, TypeManager typeManager)\n+    {\n+        checkArgument(functionHandle instanceof SqlFunctionHandle, format(\"Expect SqlFunctionHandle, got %s\", functionHandle.getClass()));\n+        FunctionMetadata functionMetadata = getFunctionMetadata(functionHandle);\n+        ScalarFunctionImplementation functionImplementation = getScalarFunctionImplementation(functionHandle);\n+        checkArgument(functionImplementation instanceof ThriftScalarFunctionImplementation, \"Remote function execution currently only supports Thrift.\");\n+        return sqlFunctionExecutors.getThriftExecutor().executeFunction(\n+                (ThriftScalarFunctionImplementation) functionImplementation,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a46b880dd980d26fd85243c65121f5fcf5444add"}, "originalPosition": 69}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a46b880dd980d26fd85243c65121f5fcf5444add", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/a46b880dd980d26fd85243c65121f5fcf5444add", "committedDate": "2020-09-01T18:51:48Z", "message": "Support Remote function execution"}, "afterCommit": {"oid": "699e725c1d7078f296fadf2c529385505a9eb703", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/699e725c1d7078f296fadf2c529385505a9eb703", "committedDate": "2020-09-02T22:35:47Z", "message": "Support Remote function execution"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "699e725c1d7078f296fadf2c529385505a9eb703", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/699e725c1d7078f296fadf2c529385505a9eb703", "committedDate": "2020-09-02T22:35:47Z", "message": "Support Remote function execution"}, "afterCommit": {"oid": "18d06668341664ebccf4286c0e933870fb170148", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/18d06668341664ebccf4286c0e933870fb170148", "committedDate": "2020-09-02T22:47:27Z", "message": "Support Remote function execution"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "18d06668341664ebccf4286c0e933870fb170148", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/18d06668341664ebccf4286c0e933870fb170148", "committedDate": "2020-09-02T22:47:27Z", "message": "Support Remote function execution"}, "afterCommit": {"oid": "a4114682681d084b346fec3552ca2b214710c67a", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/a4114682681d084b346fec3552ca2b214710c67a", "committedDate": "2020-09-03T18:25:14Z", "message": "Support Remote function execution"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a4114682681d084b346fec3552ca2b214710c67a", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/a4114682681d084b346fec3552ca2b214710c67a", "committedDate": "2020-09-03T18:25:14Z", "message": "Support Remote function execution"}, "afterCommit": {"oid": "30149a8fdff5b9980a9634514a8a7b74a9519d9f", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/30149a8fdff5b9980a9634514a8a7b74a9519d9f", "committedDate": "2020-09-03T23:30:39Z", "message": "Support Remote function execution"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "30149a8fdff5b9980a9634514a8a7b74a9519d9f", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/30149a8fdff5b9980a9634514a8a7b74a9519d9f", "committedDate": "2020-09-03T23:30:39Z", "message": "Support Remote function execution"}, "afterCommit": {"oid": "23c0ccf8542202371a0d35223d50fb078d986e19", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/23c0ccf8542202371a0d35223d50fb078d986e19", "committedDate": "2020-09-04T07:48:06Z", "message": "Support Remote function execution"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "23c0ccf8542202371a0d35223d50fb078d986e19", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/23c0ccf8542202371a0d35223d50fb078d986e19", "committedDate": "2020-09-04T07:48:06Z", "message": "Support Remote function execution"}, "afterCommit": {"oid": "42d1dd6ecf5db5f9be36e506220036b64c574a5d", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/42d1dd6ecf5db5f9be36e506220036b64c574a5d", "committedDate": "2020-09-04T19:52:10Z", "message": "Support Remote function execution"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "42d1dd6ecf5db5f9be36e506220036b64c574a5d", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/42d1dd6ecf5db5f9be36e506220036b64c574a5d", "committedDate": "2020-09-04T19:52:10Z", "message": "Support Remote function execution"}, "afterCommit": {"oid": "c3f471714cc7ea654d292bf954b1d783b4f3f1af", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/c3f471714cc7ea654d292bf954b1d783b4f3f1af", "committedDate": "2020-09-08T22:17:28Z", "message": "Support Remote function execution"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c3f471714cc7ea654d292bf954b1d783b4f3f1af", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/c3f471714cc7ea654d292bf954b1d783b4f3f1af", "committedDate": "2020-09-08T22:17:28Z", "message": "Support Remote function execution"}, "afterCommit": {"oid": "2a80bce8e12243aa650a719adbdaceb418acc468", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/2a80bce8e12243aa650a719adbdaceb418acc468", "committedDate": "2020-09-10T00:51:32Z", "message": "Support Remote function execution"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2MzAwNTYw", "url": "https://github.com/prestodb/presto/pull/14012#pullrequestreview-486300560", "createdAt": "2020-09-10T20:51:07Z", "commit": {"oid": "a617e9b036211d0403f1c6c07e11634e928d92b8"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMDo1MTowOFrOHQFSRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMTowMTo0M1rOHQFnGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYyNTg2Mw==", "bodyText": "Could you expand the commit message to explain what is wrong before the change, why we didn't see it before and why the other commits in the PR are triggering this?", "url": "https://github.com/prestodb/presto/pull/14012#discussion_r486625863", "createdAt": "2020-09-10T20:51:08Z", "author": {"login": "caithagoras"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/PlanFragmenter.java", "diffHunk": "@@ -716,7 +717,7 @@ private TableFinishNode createTemporaryTableWrite(\n                             Assignments.Builder assignments = Assignments.builder();\n                             source.getOutputVariables().forEach(variable -> assignments.put(variable, new VariableReferenceExpression(variable.getName(), variable.getType())));\n                             constantVariables.forEach(variable -> assignments.put(variable, constantExpressions.get(variable)));\n-                            return new ProjectNode(idAllocator.getNextId(), source, assignments.build());\n+                            return new ProjectNode(idAllocator.getNextId(), source, assignments.build(), Locality.LOCAL);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a617e9b036211d0403f1c6c07e11634e928d92b8"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYyNzkzNQ==", "bodyText": "This field does not have a getter, are we not using it?", "url": "https://github.com/prestodb/presto/pull/14012#discussion_r486627935", "createdAt": "2020-09-10T20:55:18Z", "author": {"login": "caithagoras"}, "path": "presto-function-namespace-managers/src/main/java/com/facebook/presto/functionNamespace/execution/SqlFunctionExecutors.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.functionNamespace.execution;\n+\n+import com.facebook.presto.functionNamespace.execution.thrift.ThriftSqlFunctionExecutor;\n+import com.facebook.presto.spi.function.FunctionImplementationType;\n+import com.facebook.presto.spi.function.RoutineCharacteristics.Language;\n+import com.google.inject.Inject;\n+\n+import java.util.Map;\n+import java.util.Set;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class SqlFunctionExecutors\n+{\n+    private final Map<Language, FunctionImplementationType> supportedLanguages;\n+    private final ThriftSqlFunctionExecutor thriftSqlFunctionExecutor;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7ca9021c009adb4f99c7c836fc9d4fbd88ca340"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYyODc4MQ==", "bodyText": "Maybe we can make it a bit flexible by allow lower case\n.valueOf(implementationType.toUpperCase())", "url": "https://github.com/prestodb/presto/pull/14012#discussion_r486628781", "createdAt": "2020-09-10T20:56:51Z", "author": {"login": "caithagoras"}, "path": "presto-function-namespace-managers/src/main/java/com/facebook/presto/functionNamespace/execution/SqlFunctionLanguageConfig.java", "diffHunk": "@@ -0,0 +1,36 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.functionNamespace.execution;\n+\n+import com.facebook.airlift.configuration.Config;\n+import com.facebook.presto.spi.function.FunctionImplementationType;\n+\n+import static com.facebook.presto.spi.function.FunctionImplementationType.SQL;\n+\n+public class SqlFunctionLanguageConfig\n+{\n+    private FunctionImplementationType functionImplementationType = SQL;\n+\n+    @Config(\"function-implementation-type\")\n+    public SqlFunctionLanguageConfig setFunctionImplementationType(String implementationType)\n+    {\n+        this.functionImplementationType = FunctionImplementationType.valueOf(implementationType);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7ca9021c009adb4f99c7c836fc9d4fbd88ca340"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYyOTg5OQ==", "bodyText": "nit: Usually comma-separate do not contains space. We can still support space, but maybe remove space here in the test example.", "url": "https://github.com/prestodb/presto/pull/14012#discussion_r486629899", "createdAt": "2020-09-10T20:59:06Z", "author": {"login": "caithagoras"}, "path": "presto-tests/src/test/java/com/facebook/presto/tests/TestSqlFunctions.java", "diffHunk": "@@ -50,7 +50,12 @@ private static QueryRunner createQueryRunner()\n             DistributedQueryRunner queryRunner = DistributedQueryRunner.builder(session)\n                     .setCoordinatorProperties(ImmutableMap.of(\"list-built-in-functions-only\", \"false\"))\n                     .build();\n-            queryRunner.enableTestFunctionNamespaces(ImmutableList.of(\"testing\", \"example\"), ImmutableMap.of(\"supported-function-languages\", \"{\\\"sql\\\": \\\"SQL\\\", \\\"java\\\": \\\"THRIFT\\\"}\"));\n+            queryRunner.enableTestFunctionNamespaces(\n+                    ImmutableList.of(\"testing\", \"example\"),\n+                    ImmutableMap.of(\n+                            \"supported-function-languages\", \"sql, java\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7ca9021c009adb4f99c7c836fc9d4fbd88ca340"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYzMTE5NA==", "bodyText": "Since the method name is called sqlInvokedFunctionToImplementation, a better error message could be something like\nSqlInvokedfunction xx cannot be BUILTIN\nSqlInvokedfunction xx cannot have BUILTIN implementation type", "url": "https://github.com/prestodb/presto/pull/14012#discussion_r486631194", "createdAt": "2020-09-10T21:01:43Z", "author": {"login": "caithagoras"}, "path": "presto-function-namespace-managers/src/main/java/com/facebook/presto/functionNamespace/AbstractSqlInvokedFunctionNamespaceManager.java", "diffHunk": "@@ -240,8 +258,17 @@ protected FunctionImplementationType getFunctionImplementationType(SqlInvokedFun\n     protected ScalarFunctionImplementation sqlInvokedFunctionToImplementation(SqlInvokedFunction function)\n     {\n         FunctionImplementationType implementationType = getFunctionImplementationType(function);\n-        checkArgument(implementationType.equals(SQL));\n-        return new SqlInvokedScalarFunctionImplementation(function.getBody());\n+        switch (implementationType) {\n+            case SQL:\n+                return new SqlInvokedScalarFunctionImplementation(function.getBody());\n+            case THRIFT:\n+                checkArgument(function.getFunctionHandle().isPresent(), \"Need functionHandle to get function implementation\");\n+                return new ThriftScalarFunctionImplementation(function.getFunctionHandle().get(), function.getRoutineCharacteristics().getLanguage());\n+            case BUILTIN:\n+                throw new IllegalStateException(format(\"%s cannot manage BUILTIN functions\", this.getClass()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a80bce8e12243aa650a719adbdaceb418acc468"}, "originalPosition": 68}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2a80bce8e12243aa650a719adbdaceb418acc468", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/2a80bce8e12243aa650a719adbdaceb418acc468", "committedDate": "2020-09-10T00:51:32Z", "message": "Support Remote function execution"}, "afterCommit": {"oid": "c08821c7c6461d5ee44afa8b65c9c31364686831", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/c08821c7c6461d5ee44afa8b65c9c31364686831", "committedDate": "2020-09-10T21:49:56Z", "message": "Support Remote function execution"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MDg3MDEx", "url": "https://github.com/prestodb/presto/pull/14012#pullrequestreview-487087011", "createdAt": "2020-09-11T19:58:02Z", "commit": {"oid": "c08821c7c6461d5ee44afa8b65c9c31364686831"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxOTo1ODowMlrOHQsEOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQyMDo0Nzo0NFrOHQtagA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI2MTI0MQ==", "bodyText": "nit : intellij thinks this variable is unused.", "url": "https://github.com/prestodb/presto/pull/14012#discussion_r487261241", "createdAt": "2020-09-11T19:58:02Z", "author": {"login": "wenleix"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/RemoteProjectOperator.java", "diffHunk": "@@ -0,0 +1,196 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.operator;\n+\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.common.block.Block;\n+import com.facebook.presto.common.type.Type;\n+import com.facebook.presto.metadata.FunctionManager;\n+import com.facebook.presto.spi.plan.PlanNodeId;\n+import com.facebook.presto.spi.relation.CallExpression;\n+import com.facebook.presto.spi.relation.ConstantExpression;\n+import com.facebook.presto.spi.relation.InputReferenceExpression;\n+import com.facebook.presto.spi.relation.RowExpression;\n+import com.google.common.collect.ImmutableList;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ExecutionException;\n+\n+import static com.google.common.base.Preconditions.checkState;\n+import static com.google.common.base.Throwables.throwIfUnchecked;\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static java.lang.String.format;\n+import static java.lang.Thread.currentThread;\n+import static java.util.Objects.requireNonNull;\n+import static java.util.concurrent.CompletableFuture.completedFuture;\n+\n+public class RemoteProjectOperator\n+        implements Operator\n+{\n+    private final OperatorContext operatorContext;\n+    private final FunctionManager functionManager;\n+    private final List<RowExpression> projections;\n+\n+    private final CompletableFuture<Block>[] result;\n+\n+    private boolean finishing;\n+\n+    private RemoteProjectOperator(OperatorContext operatorContext, FunctionManager functionManager, List<RowExpression> projections)\n+    {\n+        this.operatorContext = requireNonNull(operatorContext, \"operatorContext is null\");\n+        this.functionManager = requireNonNull(functionManager, \"functionManager is null\");\n+        this.projections = ImmutableList.copyOf(requireNonNull(projections, \"projections is null\"));\n+        this.result = new CompletableFuture[projections.size()];\n+    }\n+\n+    @Override\n+    public OperatorContext getOperatorContext()\n+    {\n+        return operatorContext;\n+    }\n+\n+    @Override\n+    public boolean needsInput()\n+    {\n+        return !finishing && !processingPage();\n+    }\n+\n+    @Override\n+    public void addInput(Page page)\n+    {\n+        checkState(!finishing, \"Operator is already finishing\");\n+        checkState(!processingPage(), \"Still processing previous input\");\n+        requireNonNull(page, \"page is null\");\n+        for (int channel = 0; channel < projections.size(); channel++) {\n+            RowExpression projection = projections.get(channel);\n+            Type type = projection.getType();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c08821c7c6461d5ee44afa8b65c9c31364686831"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI3MDYxMA==", "bodyText": "If I understand correctly, if result array contains non-null element, it means addInput was called after last getOutput: this is because in getOutput, result array will be filled with null (line 110).\nIf that's the case, does it make sense to just have a AtomicBoolean for this flag, say something like inputsAdded ? For two reason:\n\nMore efficient (probably not really important)\nI was originally looking into the difference between resultReady, and wondering why we don't need to check result[i].isDone()", "url": "https://github.com/prestodb/presto/pull/14012#discussion_r487270610", "createdAt": "2020-09-11T20:19:18Z", "author": {"login": "wenleix"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/RemoteProjectOperator.java", "diffHunk": "@@ -0,0 +1,196 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.operator;\n+\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.common.block.Block;\n+import com.facebook.presto.common.type.Type;\n+import com.facebook.presto.metadata.FunctionManager;\n+import com.facebook.presto.spi.plan.PlanNodeId;\n+import com.facebook.presto.spi.relation.CallExpression;\n+import com.facebook.presto.spi.relation.ConstantExpression;\n+import com.facebook.presto.spi.relation.InputReferenceExpression;\n+import com.facebook.presto.spi.relation.RowExpression;\n+import com.google.common.collect.ImmutableList;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ExecutionException;\n+\n+import static com.google.common.base.Preconditions.checkState;\n+import static com.google.common.base.Throwables.throwIfUnchecked;\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static java.lang.String.format;\n+import static java.lang.Thread.currentThread;\n+import static java.util.Objects.requireNonNull;\n+import static java.util.concurrent.CompletableFuture.completedFuture;\n+\n+public class RemoteProjectOperator\n+        implements Operator\n+{\n+    private final OperatorContext operatorContext;\n+    private final FunctionManager functionManager;\n+    private final List<RowExpression> projections;\n+\n+    private final CompletableFuture<Block>[] result;\n+\n+    private boolean finishing;\n+\n+    private RemoteProjectOperator(OperatorContext operatorContext, FunctionManager functionManager, List<RowExpression> projections)\n+    {\n+        this.operatorContext = requireNonNull(operatorContext, \"operatorContext is null\");\n+        this.functionManager = requireNonNull(functionManager, \"functionManager is null\");\n+        this.projections = ImmutableList.copyOf(requireNonNull(projections, \"projections is null\"));\n+        this.result = new CompletableFuture[projections.size()];\n+    }\n+\n+    @Override\n+    public OperatorContext getOperatorContext()\n+    {\n+        return operatorContext;\n+    }\n+\n+    @Override\n+    public boolean needsInput()\n+    {\n+        return !finishing && !processingPage();\n+    }\n+\n+    @Override\n+    public void addInput(Page page)\n+    {\n+        checkState(!finishing, \"Operator is already finishing\");\n+        checkState(!processingPage(), \"Still processing previous input\");\n+        requireNonNull(page, \"page is null\");\n+        for (int channel = 0; channel < projections.size(); channel++) {\n+            RowExpression projection = projections.get(channel);\n+            Type type = projection.getType();\n+            if (projection instanceof InputReferenceExpression) {\n+                result[channel] = completedFuture(page.getBlock(((InputReferenceExpression) projection).getField()));\n+            }\n+            else if (projection instanceof CallExpression) {\n+                CallExpression remoteCall = (CallExpression) projection;\n+                result[channel] = functionManager.executeFunction(\n+                        remoteCall.getFunctionHandle(),\n+                        page,\n+                        remoteCall.getArguments().stream()\n+                                .map(InputReferenceExpression.class::cast)\n+                                .map(InputReferenceExpression::getField)\n+                                .collect(toImmutableList()));\n+            }\n+            else {\n+                checkState(projection instanceof ConstantExpression, format(\"Does not expect expression type %s\", projection.getClass()));\n+            }\n+        }\n+    }\n+\n+    @Override\n+    public Page getOutput()\n+    {\n+        if (resultReady()) {\n+            Block[] blocks = new Block[result.length];\n+            Page output;\n+            try {\n+                for (int i = 0; i < blocks.length; i++) {\n+                    blocks[i] = result[i].get();\n+                }\n+                output = new Page(blocks);\n+                Arrays.fill(result, null);\n+                return output;\n+            }\n+            catch (InterruptedException ie) {\n+                currentThread().interrupt();\n+            }\n+            catch (ExecutionException e) {\n+                Throwable cause = e.getCause();\n+                if (cause != null) {\n+                    throwIfUnchecked(cause);\n+                    throw new RuntimeException(cause);\n+                }\n+                throw new RuntimeException(e);\n+            }\n+        }\n+        return null;\n+    }\n+\n+    @Override\n+    public void finish()\n+    {\n+        finishing = true;\n+    }\n+\n+    @Override\n+    public boolean isFinished()\n+    {\n+        return finishing && !processingPage();\n+    }\n+\n+    private boolean processingPage()\n+    {\n+        for (int i = 0; i < result.length; i++) {\n+            if (result[i] != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c08821c7c6461d5ee44afa8b65c9c31364686831"}, "originalPosition": 143}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI3NjQzMQ==", "bodyText": "do we want to throw RuntimeException wrap this ie ?", "url": "https://github.com/prestodb/presto/pull/14012#discussion_r487276431", "createdAt": "2020-09-11T20:32:13Z", "author": {"login": "wenleix"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/RemoteProjectOperator.java", "diffHunk": "@@ -0,0 +1,196 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.operator;\n+\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.common.block.Block;\n+import com.facebook.presto.common.type.Type;\n+import com.facebook.presto.metadata.FunctionManager;\n+import com.facebook.presto.spi.plan.PlanNodeId;\n+import com.facebook.presto.spi.relation.CallExpression;\n+import com.facebook.presto.spi.relation.ConstantExpression;\n+import com.facebook.presto.spi.relation.InputReferenceExpression;\n+import com.facebook.presto.spi.relation.RowExpression;\n+import com.google.common.collect.ImmutableList;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ExecutionException;\n+\n+import static com.google.common.base.Preconditions.checkState;\n+import static com.google.common.base.Throwables.throwIfUnchecked;\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static java.lang.String.format;\n+import static java.lang.Thread.currentThread;\n+import static java.util.Objects.requireNonNull;\n+import static java.util.concurrent.CompletableFuture.completedFuture;\n+\n+public class RemoteProjectOperator\n+        implements Operator\n+{\n+    private final OperatorContext operatorContext;\n+    private final FunctionManager functionManager;\n+    private final List<RowExpression> projections;\n+\n+    private final CompletableFuture<Block>[] result;\n+\n+    private boolean finishing;\n+\n+    private RemoteProjectOperator(OperatorContext operatorContext, FunctionManager functionManager, List<RowExpression> projections)\n+    {\n+        this.operatorContext = requireNonNull(operatorContext, \"operatorContext is null\");\n+        this.functionManager = requireNonNull(functionManager, \"functionManager is null\");\n+        this.projections = ImmutableList.copyOf(requireNonNull(projections, \"projections is null\"));\n+        this.result = new CompletableFuture[projections.size()];\n+    }\n+\n+    @Override\n+    public OperatorContext getOperatorContext()\n+    {\n+        return operatorContext;\n+    }\n+\n+    @Override\n+    public boolean needsInput()\n+    {\n+        return !finishing && !processingPage();\n+    }\n+\n+    @Override\n+    public void addInput(Page page)\n+    {\n+        checkState(!finishing, \"Operator is already finishing\");\n+        checkState(!processingPage(), \"Still processing previous input\");\n+        requireNonNull(page, \"page is null\");\n+        for (int channel = 0; channel < projections.size(); channel++) {\n+            RowExpression projection = projections.get(channel);\n+            Type type = projection.getType();\n+            if (projection instanceof InputReferenceExpression) {\n+                result[channel] = completedFuture(page.getBlock(((InputReferenceExpression) projection).getField()));\n+            }\n+            else if (projection instanceof CallExpression) {\n+                CallExpression remoteCall = (CallExpression) projection;\n+                result[channel] = functionManager.executeFunction(\n+                        remoteCall.getFunctionHandle(),\n+                        page,\n+                        remoteCall.getArguments().stream()\n+                                .map(InputReferenceExpression.class::cast)\n+                                .map(InputReferenceExpression::getField)\n+                                .collect(toImmutableList()));\n+            }\n+            else {\n+                checkState(projection instanceof ConstantExpression, format(\"Does not expect expression type %s\", projection.getClass()));\n+            }\n+        }\n+    }\n+\n+    @Override\n+    public Page getOutput()\n+    {\n+        if (resultReady()) {\n+            Block[] blocks = new Block[result.length];\n+            Page output;\n+            try {\n+                for (int i = 0; i < blocks.length; i++) {\n+                    blocks[i] = result[i].get();\n+                }\n+                output = new Page(blocks);\n+                Arrays.fill(result, null);\n+                return output;\n+            }\n+            catch (InterruptedException ie) {\n+                currentThread().interrupt();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c08821c7c6461d5ee44afa8b65c9c31364686831"}, "originalPosition": 114}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI4MzMyOA==", "bodyText": "does it make sense to check it's a remote function call ?", "url": "https://github.com/prestodb/presto/pull/14012#discussion_r487283328", "createdAt": "2020-09-11T20:47:44Z", "author": {"login": "wenleix"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/RemoteProjectOperator.java", "diffHunk": "@@ -0,0 +1,196 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.operator;\n+\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.common.block.Block;\n+import com.facebook.presto.common.type.Type;\n+import com.facebook.presto.metadata.FunctionManager;\n+import com.facebook.presto.spi.plan.PlanNodeId;\n+import com.facebook.presto.spi.relation.CallExpression;\n+import com.facebook.presto.spi.relation.ConstantExpression;\n+import com.facebook.presto.spi.relation.InputReferenceExpression;\n+import com.facebook.presto.spi.relation.RowExpression;\n+import com.google.common.collect.ImmutableList;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ExecutionException;\n+\n+import static com.google.common.base.Preconditions.checkState;\n+import static com.google.common.base.Throwables.throwIfUnchecked;\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static java.lang.String.format;\n+import static java.lang.Thread.currentThread;\n+import static java.util.Objects.requireNonNull;\n+import static java.util.concurrent.CompletableFuture.completedFuture;\n+\n+public class RemoteProjectOperator\n+        implements Operator\n+{\n+    private final OperatorContext operatorContext;\n+    private final FunctionManager functionManager;\n+    private final List<RowExpression> projections;\n+\n+    private final CompletableFuture<Block>[] result;\n+\n+    private boolean finishing;\n+\n+    private RemoteProjectOperator(OperatorContext operatorContext, FunctionManager functionManager, List<RowExpression> projections)\n+    {\n+        this.operatorContext = requireNonNull(operatorContext, \"operatorContext is null\");\n+        this.functionManager = requireNonNull(functionManager, \"functionManager is null\");\n+        this.projections = ImmutableList.copyOf(requireNonNull(projections, \"projections is null\"));\n+        this.result = new CompletableFuture[projections.size()];\n+    }\n+\n+    @Override\n+    public OperatorContext getOperatorContext()\n+    {\n+        return operatorContext;\n+    }\n+\n+    @Override\n+    public boolean needsInput()\n+    {\n+        return !finishing && !processingPage();\n+    }\n+\n+    @Override\n+    public void addInput(Page page)\n+    {\n+        checkState(!finishing, \"Operator is already finishing\");\n+        checkState(!processingPage(), \"Still processing previous input\");\n+        requireNonNull(page, \"page is null\");\n+        for (int channel = 0; channel < projections.size(); channel++) {\n+            RowExpression projection = projections.get(channel);\n+            Type type = projection.getType();\n+            if (projection instanceof InputReferenceExpression) {\n+                result[channel] = completedFuture(page.getBlock(((InputReferenceExpression) projection).getField()));\n+            }\n+            else if (projection instanceof CallExpression) {\n+                CallExpression remoteCall = (CallExpression) projection;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c08821c7c6461d5ee44afa8b65c9c31364686831"}, "originalPosition": 84}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c08821c7c6461d5ee44afa8b65c9c31364686831", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/c08821c7c6461d5ee44afa8b65c9c31364686831", "committedDate": "2020-09-10T21:49:56Z", "message": "Support Remote function execution"}, "afterCommit": {"oid": "ef1163ccbdd6376928acf69f1b73487ad8dd96b1", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/ef1163ccbdd6376928acf69f1b73487ad8dd96b1", "committedDate": "2020-09-12T00:39:37Z", "message": "Support Remote function execution"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MzMyNzI1", "url": "https://github.com/prestodb/presto/pull/14012#pullrequestreview-487332725", "createdAt": "2020-09-13T19:16:48Z", "commit": {"oid": "16190cfa02d155bfb54e2d54cf43e22edf58d74f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xM1QxOToxNjo0OFrOHQ-siA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xM1QxOToxNjo0OFrOHQ-siA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU2NjQ3Mg==", "bodyText": "curious: why this is called SqlFunctionExecutors instead of SqlFunctionExecutor? Looks like there is just one ThriftSqlFunctionExecutor inside ? \ud83d\ude02", "url": "https://github.com/prestodb/presto/pull/14012#discussion_r487566472", "createdAt": "2020-09-13T19:16:48Z", "author": {"login": "wenleix"}, "path": "presto-function-namespace-managers/src/main/java/com/facebook/presto/functionNamespace/execution/SqlFunctionExecutors.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.functionNamespace.execution;\n+\n+import com.facebook.presto.functionNamespace.execution.thrift.ThriftSqlFunctionExecutor;\n+import com.facebook.presto.spi.function.FunctionImplementationType;\n+import com.facebook.presto.spi.function.RoutineCharacteristics.Language;\n+import com.google.inject.Inject;\n+\n+import java.util.Map;\n+import java.util.Set;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class SqlFunctionExecutors", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16190cfa02d155bfb54e2d54cf43e22edf58d74f"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MzMzNzk5", "url": "https://github.com/prestodb/presto/pull/14012#pullrequestreview-487333799", "createdAt": "2020-09-13T19:33:14Z", "commit": {"oid": "16190cfa02d155bfb54e2d54cf43e22edf58d74f"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xM1QxOTozMzoxNFrOHQ-y8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQwNDozMTo1M1rOHRDihQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU2ODExMw==", "bodyText": "curious: why not just return ListenableFuture? I see guava library is included in presto-function-namepsaces-manager?", "url": "https://github.com/prestodb/presto/pull/14012#discussion_r487568113", "createdAt": "2020-09-13T19:33:14Z", "author": {"login": "wenleix"}, "path": "presto-function-namespace-managers/src/main/java/com/facebook/presto/functionNamespace/execution/thrift/ThriftSqlFunctionExecutor.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.functionNamespace.execution.thrift;\n+\n+import com.facebook.drift.TException;\n+import com.facebook.drift.client.DriftClient;\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.common.block.Block;\n+import com.facebook.presto.common.type.Type;\n+import com.facebook.presto.common.type.TypeSignature;\n+import com.facebook.presto.spi.PrestoException;\n+import com.facebook.presto.spi.function.SqlFunctionHandle;\n+import com.facebook.presto.spi.function.SqlFunctionId;\n+import com.facebook.presto.spi.function.ThriftScalarFunctionImplementation;\n+import com.facebook.presto.thrift.api.datatypes.PrestoThriftBlock;\n+import com.facebook.presto.thrift.api.udf.ThriftFunctionHandle;\n+import com.facebook.presto.thrift.api.udf.ThriftUdfService;\n+import com.facebook.presto.thrift.api.udf.ThriftUdfServiceException;\n+import com.google.common.collect.ImmutableList;\n+import com.google.inject.Inject;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.concurrent.CompletableFuture;\n+\n+import static com.facebook.airlift.concurrent.MoreFutures.toCompletableFuture;\n+import static com.facebook.presto.spi.StandardErrorCode.GENERIC_INTERNAL_ERROR;\n+import static com.facebook.presto.thrift.api.udf.ThriftUdfPage.thriftPage;\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+\n+public class ThriftSqlFunctionExecutor\n+{\n+    private final DriftClient<ThriftUdfService> thriftUdfClient;\n+\n+    @Inject\n+    public ThriftSqlFunctionExecutor(DriftClient<ThriftUdfService> thriftUdfClient)\n+    {\n+        this.thriftUdfClient = thriftUdfClient;\n+    }\n+\n+    public CompletableFuture<Block> executeFunction(ThriftScalarFunctionImplementation functionImplementation, Page input, List<Integer> channels, List<Type> argumentTypes, Type returnType)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16190cfa02d155bfb54e2d54cf43e22edf58d74f"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU2ODczNg==", "bodyText": "nit: what about\ngetOnlyElement(result.getResult().getThriftBlocks()).toBlock(returnType)\n?", "url": "https://github.com/prestodb/presto/pull/14012#discussion_r487568736", "createdAt": "2020-09-13T19:38:46Z", "author": {"login": "wenleix"}, "path": "presto-function-namespace-managers/src/main/java/com/facebook/presto/functionNamespace/execution/thrift/ThriftSqlFunctionExecutor.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.functionNamespace.execution.thrift;\n+\n+import com.facebook.drift.TException;\n+import com.facebook.drift.client.DriftClient;\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.common.block.Block;\n+import com.facebook.presto.common.type.Type;\n+import com.facebook.presto.common.type.TypeSignature;\n+import com.facebook.presto.spi.PrestoException;\n+import com.facebook.presto.spi.function.SqlFunctionHandle;\n+import com.facebook.presto.spi.function.SqlFunctionId;\n+import com.facebook.presto.spi.function.ThriftScalarFunctionImplementation;\n+import com.facebook.presto.thrift.api.datatypes.PrestoThriftBlock;\n+import com.facebook.presto.thrift.api.udf.ThriftFunctionHandle;\n+import com.facebook.presto.thrift.api.udf.ThriftUdfService;\n+import com.facebook.presto.thrift.api.udf.ThriftUdfServiceException;\n+import com.google.common.collect.ImmutableList;\n+import com.google.inject.Inject;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.concurrent.CompletableFuture;\n+\n+import static com.facebook.airlift.concurrent.MoreFutures.toCompletableFuture;\n+import static com.facebook.presto.spi.StandardErrorCode.GENERIC_INTERNAL_ERROR;\n+import static com.facebook.presto.thrift.api.udf.ThriftUdfPage.thriftPage;\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+\n+public class ThriftSqlFunctionExecutor\n+{\n+    private final DriftClient<ThriftUdfService> thriftUdfClient;\n+\n+    @Inject\n+    public ThriftSqlFunctionExecutor(DriftClient<ThriftUdfService> thriftUdfClient)\n+    {\n+        this.thriftUdfClient = thriftUdfClient;\n+    }\n+\n+    public CompletableFuture<Block> executeFunction(ThriftScalarFunctionImplementation functionImplementation, Page input, List<Integer> channels, List<Type> argumentTypes, Type returnType)\n+    {\n+        if (thriftUdfClient == null) {\n+            throw new UnsupportedOperationException(\"Thrift function execution is not supported\");\n+        }\n+        ImmutableList.Builder<PrestoThriftBlock> blocks = ImmutableList.builder();\n+        for (int i = 0; i < channels.size(); i++) {\n+            Block block = input.getBlock(channels.get(i));\n+            blocks.add(PrestoThriftBlock.fromBlock(block, argumentTypes.get(i)));\n+        }\n+        SqlFunctionHandle functionHandle = functionImplementation.getFunctionHandle();\n+        SqlFunctionId functionId = functionImplementation.getFunctionHandle().getFunctionId();\n+        try {\n+            return toCompletableFuture(thriftUdfClient.get(Optional.of(functionImplementation.getLanguage().getLanguage())).invokeUdf(\n+                    new ThriftFunctionHandle(\n+                            functionId.getFunctionName().toString(),\n+                            functionId.getArgumentTypes().stream()\n+                                    .map(TypeSignature::toString)\n+                                    .collect(toImmutableList()),\n+                            returnType.toString(),\n+                            functionHandle.getVersion()),\n+                    thriftPage(blocks.build())))\n+                    .thenApply(result -> result.getResult().getThriftBlocks().get(0).toBlock(returnType));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16190cfa02d155bfb54e2d54cf43e22edf58d74f"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY0NTIxNg==", "bodyText": "nit: note you can do functionHandle.getFunctionId().", "url": "https://github.com/prestodb/presto/pull/14012#discussion_r487645216", "createdAt": "2020-09-14T04:29:08Z", "author": {"login": "wenleix"}, "path": "presto-function-namespace-managers/src/main/java/com/facebook/presto/functionNamespace/execution/thrift/ThriftSqlFunctionExecutor.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.functionNamespace.execution.thrift;\n+\n+import com.facebook.drift.TException;\n+import com.facebook.drift.client.DriftClient;\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.common.block.Block;\n+import com.facebook.presto.common.type.Type;\n+import com.facebook.presto.common.type.TypeSignature;\n+import com.facebook.presto.spi.PrestoException;\n+import com.facebook.presto.spi.function.SqlFunctionHandle;\n+import com.facebook.presto.spi.function.SqlFunctionId;\n+import com.facebook.presto.spi.function.ThriftScalarFunctionImplementation;\n+import com.facebook.presto.thrift.api.datatypes.PrestoThriftBlock;\n+import com.facebook.presto.thrift.api.udf.ThriftFunctionHandle;\n+import com.facebook.presto.thrift.api.udf.ThriftUdfService;\n+import com.facebook.presto.thrift.api.udf.ThriftUdfServiceException;\n+import com.google.common.collect.ImmutableList;\n+import com.google.inject.Inject;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.concurrent.CompletableFuture;\n+\n+import static com.facebook.airlift.concurrent.MoreFutures.toCompletableFuture;\n+import static com.facebook.presto.spi.StandardErrorCode.GENERIC_INTERNAL_ERROR;\n+import static com.facebook.presto.thrift.api.udf.ThriftUdfPage.thriftPage;\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+\n+public class ThriftSqlFunctionExecutor\n+{\n+    private final DriftClient<ThriftUdfService> thriftUdfClient;\n+\n+    @Inject\n+    public ThriftSqlFunctionExecutor(DriftClient<ThriftUdfService> thriftUdfClient)\n+    {\n+        this.thriftUdfClient = thriftUdfClient;\n+    }\n+\n+    public CompletableFuture<Block> executeFunction(ThriftScalarFunctionImplementation functionImplementation, Page input, List<Integer> channels, List<Type> argumentTypes, Type returnType)\n+    {\n+        if (thriftUdfClient == null) {\n+            throw new UnsupportedOperationException(\"Thrift function execution is not supported\");\n+        }\n+        ImmutableList.Builder<PrestoThriftBlock> blocks = ImmutableList.builder();\n+        for (int i = 0; i < channels.size(); i++) {\n+            Block block = input.getBlock(channels.get(i));\n+            blocks.add(PrestoThriftBlock.fromBlock(block, argumentTypes.get(i)));\n+        }\n+        SqlFunctionHandle functionHandle = functionImplementation.getFunctionHandle();\n+        SqlFunctionId functionId = functionImplementation.getFunctionHandle().getFunctionId();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16190cfa02d155bfb54e2d54cf43e22edf58d74f"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY0NTgyOQ==", "bodyText": "This comment doesn't request any change. Just purely a comment:  at first glance seeing \"argument types\" contained in FunctionId looks weird \ud83d\ude03\nI can totally imagine how does this happen. -- We are running out of words such as FunctionSigature, etc. ... So FunctionId becomes the best word. \ud83d\ude02", "url": "https://github.com/prestodb/presto/pull/14012#discussion_r487645829", "createdAt": "2020-09-14T04:31:53Z", "author": {"login": "wenleix"}, "path": "presto-function-namespace-managers/src/main/java/com/facebook/presto/functionNamespace/execution/thrift/ThriftSqlFunctionExecutor.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.functionNamespace.execution.thrift;\n+\n+import com.facebook.drift.TException;\n+import com.facebook.drift.client.DriftClient;\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.common.block.Block;\n+import com.facebook.presto.common.type.Type;\n+import com.facebook.presto.common.type.TypeSignature;\n+import com.facebook.presto.spi.PrestoException;\n+import com.facebook.presto.spi.function.SqlFunctionHandle;\n+import com.facebook.presto.spi.function.SqlFunctionId;\n+import com.facebook.presto.spi.function.ThriftScalarFunctionImplementation;\n+import com.facebook.presto.thrift.api.datatypes.PrestoThriftBlock;\n+import com.facebook.presto.thrift.api.udf.ThriftFunctionHandle;\n+import com.facebook.presto.thrift.api.udf.ThriftUdfService;\n+import com.facebook.presto.thrift.api.udf.ThriftUdfServiceException;\n+import com.google.common.collect.ImmutableList;\n+import com.google.inject.Inject;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.concurrent.CompletableFuture;\n+\n+import static com.facebook.airlift.concurrent.MoreFutures.toCompletableFuture;\n+import static com.facebook.presto.spi.StandardErrorCode.GENERIC_INTERNAL_ERROR;\n+import static com.facebook.presto.thrift.api.udf.ThriftUdfPage.thriftPage;\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+\n+public class ThriftSqlFunctionExecutor\n+{\n+    private final DriftClient<ThriftUdfService> thriftUdfClient;\n+\n+    @Inject\n+    public ThriftSqlFunctionExecutor(DriftClient<ThriftUdfService> thriftUdfClient)\n+    {\n+        this.thriftUdfClient = thriftUdfClient;\n+    }\n+\n+    public CompletableFuture<Block> executeFunction(ThriftScalarFunctionImplementation functionImplementation, Page input, List<Integer> channels, List<Type> argumentTypes, Type returnType)\n+    {\n+        if (thriftUdfClient == null) {\n+            throw new UnsupportedOperationException(\"Thrift function execution is not supported\");\n+        }\n+        ImmutableList.Builder<PrestoThriftBlock> blocks = ImmutableList.builder();\n+        for (int i = 0; i < channels.size(); i++) {\n+            Block block = input.getBlock(channels.get(i));\n+            blocks.add(PrestoThriftBlock.fromBlock(block, argumentTypes.get(i)));\n+        }\n+        SqlFunctionHandle functionHandle = functionImplementation.getFunctionHandle();\n+        SqlFunctionId functionId = functionImplementation.getFunctionHandle().getFunctionId();\n+        try {\n+            return toCompletableFuture(thriftUdfClient.get(Optional.of(functionImplementation.getLanguage().getLanguage())).invokeUdf(\n+                    new ThriftFunctionHandle(\n+                            functionId.getFunctionName().toString(),\n+                            functionId.getArgumentTypes().stream()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16190cfa02d155bfb54e2d54cf43e22edf58d74f"}, "originalPosition": 68}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ef1163ccbdd6376928acf69f1b73487ad8dd96b1", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/ef1163ccbdd6376928acf69f1b73487ad8dd96b1", "committedDate": "2020-09-12T00:39:37Z", "message": "Support Remote function execution"}, "afterCommit": {"oid": "a54911cc73daffc944ffe6164f95d35f1e064b69", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/a54911cc73daffc944ffe6164f95d35f1e064b69", "committedDate": "2020-09-14T18:45:13Z", "message": "Support Remote function execution"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a54911cc73daffc944ffe6164f95d35f1e064b69", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/a54911cc73daffc944ffe6164f95d35f1e064b69", "committedDate": "2020-09-14T18:45:13Z", "message": "Support Remote function execution"}, "afterCommit": {"oid": "c7666be64729af4c7f149c632e637e8b8e915907", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/c7666be64729af4c7f149c632e637e8b8e915907", "committedDate": "2020-09-14T19:16:40Z", "message": "Support Remote function execution"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4MTg3MzY0", "url": "https://github.com/prestodb/presto/pull/14012#pullrequestreview-488187364", "createdAt": "2020-09-14T22:03:25Z", "commit": {"oid": "c7666be64729af4c7f149c632e637e8b8e915907"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c7666be64729af4c7f149c632e637e8b8e915907", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/c7666be64729af4c7f149c632e637e8b8e915907", "committedDate": "2020-09-14T19:16:40Z", "message": "Support Remote function execution"}, "afterCommit": {"oid": "55202101761124d43abf86bbf4a93342763d0730", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/55202101761124d43abf86bbf4a93342763d0730", "committedDate": "2020-09-15T00:58:19Z", "message": "Support Remote function execution"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1b5e8f276485d8faf73f3fe3abf5812a9e09b34", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/b1b5e8f276485d8faf73f3fe3abf5812a9e09b34", "committedDate": "2020-09-15T19:38:08Z", "message": "Fix ProjectNode locality in PlanFragmenter\n\nThe default Locality when not specified is UNKNOWN, which should be illegal\nafter planning. We have a plan sanity check rule to make sure no ProjectNode\nhas Locality UNKOWN. Unfortunately this code is added after plan sanity check\nso we didn't catch the error."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3825bdb0078665a12e2671468589f59e977fbdb8", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/3825bdb0078665a12e2671468589f59e977fbdb8", "committedDate": "2020-09-15T19:38:08Z", "message": "Remote function execution with thrift executor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aaeff3f8360a09c1f64c8feb05354e1ca527d37d", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/aaeff3f8360a09c1f64c8feb05354e1ca527d37d", "committedDate": "2020-09-15T19:38:08Z", "message": "Support Remote function execution"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "55202101761124d43abf86bbf4a93342763d0730", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/55202101761124d43abf86bbf4a93342763d0730", "committedDate": "2020-09-15T00:58:19Z", "message": "Support Remote function execution"}, "afterCommit": {"oid": "aaeff3f8360a09c1f64c8feb05354e1ca527d37d", "author": {"user": {"login": "rongrong", "name": "Rongrong Zhong"}}, "url": "https://github.com/prestodb/presto/commit/aaeff3f8360a09c1f64c8feb05354e1ca527d37d", "committedDate": "2020-09-15T19:38:08Z", "message": "Support Remote function execution"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2501, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}