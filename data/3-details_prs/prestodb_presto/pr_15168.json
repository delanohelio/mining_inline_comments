{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg2ODQzOTcy", "number": 15168, "title": "Automatically switch to PAGEFILE format for hive unsupported type", "bodyText": "When ORC is the default format for temporary table and there is unsupported column type, add an option to automatically use PAGEFILE format.\n== NO RELEASE NOTE ==", "createdAt": "2020-09-14T19:47:23Z", "url": "https://github.com/prestodb/presto/pull/15168", "merged": true, "mergeCommit": {"oid": "95bcfcda9b6d42de7233f2f9a779813f463b4202"}, "closed": true, "closedAt": "2020-09-18T18:27:21Z", "author": {"login": "viczhang861"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdI6KCMgBqjM3NjU0MjY5MDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJ9yAbgFqTQ5MTE0MTMwMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e250ebf02b02ee3b7516879ab28ffee59ffc7b5a", "author": {"user": {"login": "viczhang861", "name": "Vic Zhang"}}, "url": "https://github.com/prestodb/presto/commit/e250ebf02b02ee3b7516879ab28ffee59ffc7b5a", "committedDate": "2020-09-14T19:38:11Z", "message": "Use PAGEFILE format for hive unsupported type"}, "afterCommit": {"oid": "ec7b1df7b4636d0675c0674ff8896ba1c63eaa3d", "author": {"user": {"login": "viczhang861", "name": "Vic Zhang"}}, "url": "https://github.com/prestodb/presto/commit/ec7b1df7b4636d0675c0674ff8896ba1c63eaa3d", "committedDate": "2020-09-14T21:32:52Z", "message": "Use PAGEFILE format for hive unsupported type"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ec7b1df7b4636d0675c0674ff8896ba1c63eaa3d", "author": {"user": {"login": "viczhang861", "name": "Vic Zhang"}}, "url": "https://github.com/prestodb/presto/commit/ec7b1df7b4636d0675c0674ff8896ba1c63eaa3d", "committedDate": "2020-09-14T21:32:52Z", "message": "Use PAGEFILE format for hive unsupported type"}, "afterCommit": {"oid": "04d1ea87139447c4e5918d81e93b348657276ed2", "author": {"user": {"login": "viczhang861", "name": "Vic Zhang"}}, "url": "https://github.com/prestodb/presto/commit/04d1ea87139447c4e5918d81e93b348657276ed2", "committedDate": "2020-09-15T01:09:11Z", "message": "Use PAGEFILE format for hive unsupported type"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4OTM3Njkx", "url": "https://github.com/prestodb/presto/pull/15168#pullrequestreview-488937691", "createdAt": "2020-09-15T18:06:44Z", "commit": {"oid": "04d1ea87139447c4e5918d81e93b348657276ed2"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxODowNjo0NFrOHSN9Xw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxODowODo1NFrOHSOByA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg2NTExOQ==", "bodyText": "in general we don't want to rely normal execution path to rely on Exception and the message. What about using a separate method isSupportedHiveType, and switch to PageFile if some column is not supported by Hive?", "url": "https://github.com/prestodb/presto/pull/15168#discussion_r488865119", "createdAt": "2020-09-15T18:06:44Z", "author": {"login": "wenleix"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -962,17 +963,43 @@ public ConnectorTableHandle createTemporaryTable(ConnectorSession session, List<\n         // choose HIVE_BINARY as a default hive type to make it compatible with Hive connector\n         Optional<HiveType> defaultHiveType = storageFormat == PAGEFILE ? Optional.of(HIVE_BINARY) : Optional.empty();\n \n-        List<HiveColumnHandle> columnHandles = getColumnHandles(\n-                // Hive doesn't support anonymous rows and unknown type\n-                // Since this method doesn't create a real table, it is fine\n-                // to assign dummy field names to the anonymous rows and translate unknown\n-                // type to the boolean type that is binary compatible\n-                translateHiveUnsupportedTypesForTemporaryTable(columns, typeManager),\n-                ImmutableSet.of(),\n-                typeTranslator,\n-                defaultHiveType);\n+        List<HiveColumnHandle> columnHandles;\n+        try {\n+            columnHandles = getColumnHandles(\n+                    // Hive doesn't support anonymous rows and unknown type\n+                    // Since this method doesn't create a real table, it is fine\n+                    // to assign dummy field names to the anonymous rows and translate unknown\n+                    // type to the boolean type that is binary compatible\n+                    translateHiveUnsupportedTypesForTemporaryTable(columns, typeManager),\n+                    ImmutableSet.of(),\n+                    typeTranslator,\n+                    defaultHiveType);\n+        }\n+        catch (Exception e) {\n+            if (isUsePageFileForHiveUnsupportedType(session) &&\n+                    e instanceof PrestoException &&\n+                    ((PrestoException) e).getErrorCode().equals(NOT_SUPPORTED.toErrorCode()) &&\n+                    e.getMessage().contains(\"No default Hive type provided for unsupported Hive type\") &&", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "04d1ea87139447c4e5918d81e93b348657276ed2"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg2NjI0OA==", "bodyText": "just double check: if the automatic switch happened, we should be able to tell from the plan right?", "url": "https://github.com/prestodb/presto/pull/15168#discussion_r488866248", "createdAt": "2020-09-15T18:08:54Z", "author": {"login": "wenleix"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -982,7 +1009,7 @@ public ConnectorTableHandle createTemporaryTable(ConnectorSession session, List<\n                         .map(handle -> new Column(handle.getName(), handle.getHiveType(), handle.getComment()))\n                         .collect(toImmutableList()))\n                 .withStorage(storage -> storage\n-                        .setStorageFormat(fromHiveStorageFormat(storageFormat))\n+                        .setStorageFormat(fromHiveStorageFormat(finalStorageFormat))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "04d1ea87139447c4e5918d81e93b348657276ed2"}, "originalPosition": 66}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwNjYyOTg5", "url": "https://github.com/prestodb/presto/pull/15168#pullrequestreview-490662989", "createdAt": "2020-09-17T14:31:22Z", "commit": {"oid": "04d1ea87139447c4e5918d81e93b348657276ed2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxNDozMToyM1rOHTlMcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxNDo0MToyOFrOHTlxCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI5NDM4NQ==", "bodyText": "Should this also test the failure cases, IOWs to validate that the test will fail if these things don't work also test with ORC and false.", "url": "https://github.com/prestodb/presto/pull/15168#discussion_r490294385", "createdAt": "2020-09-17T14:31:23Z", "author": {"login": "aweisberg"}, "path": "presto-hive/src/test/java/com/facebook/presto/hive/TestHiveDistributedQueriesWithExchangeMaterialization.java", "diffHunk": "@@ -42,9 +44,18 @@ public void testMaterializedExchangesEnabled()\n \n     @Test\n     public void testMaterializeHiveUnsupportedTypeForTemporaryTable()\n+    {\n+        testMaterializeHiveUnsupportedTypeForTemporaryTable(ORC, true);\n+        testMaterializeHiveUnsupportedTypeForTemporaryTable(PAGEFILE, false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "04d1ea87139447c4e5918d81e93b348657276ed2"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDMwMzc1Mg==", "bodyText": "Help text could give info on when and why you would enable this option.\nLike Automatically switch to PAGEFILE format for materialized exchange when encountering unsupported types", "url": "https://github.com/prestodb/presto/pull/15168#discussion_r490303752", "createdAt": "2020-09-17T14:41:28Z", "author": {"login": "aweisberg"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSessionProperties.java", "diffHunk": "@@ -415,6 +416,11 @@ public HiveSessionProperties(HiveClientConfig hiveClientConfig, OrcFileWriterCon\n                         false,\n                         value -> HiveCompressionCodec.valueOf(((String) value).toUpperCase()),\n                         HiveCompressionCodec::name),\n+                booleanProperty(\n+                        USE_PAGEFILE_FOR_HIVE_UNSUPPORTED_TYPE,\n+                        \"use PAGEFILE format for hive unsupported type\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "04d1ea87139447c4e5918d81e93b348657276ed2"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e6e1757102b8c3d4cc5a2f79a7e97bcc1ba7e95", "author": {"user": {"login": "viczhang861", "name": "Vic Zhang"}}, "url": "https://github.com/prestodb/presto/commit/4e6e1757102b8c3d4cc5a2f79a7e97bcc1ba7e95", "committedDate": "2020-09-17T22:23:38Z", "message": "Add session property to automatically use PAGEFILE"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b62aeb3955679177fe72ae53a290512fa76092f1", "author": {"user": {"login": "viczhang861", "name": "Vic Zhang"}}, "url": "https://github.com/prestodb/presto/commit/b62aeb3955679177fe72ae53a290512fa76092f1", "committedDate": "2020-09-17T22:23:43Z", "message": "Use PAGEFILE format for hive unsupported type"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2adbd80332ebefdf4777ae22324e0dd18cc3d6d9", "author": {"user": {"login": "viczhang861", "name": "Vic Zhang"}}, "url": "https://github.com/prestodb/presto/commit/2adbd80332ebefdf4777ae22324e0dd18cc3d6d9", "committedDate": "2020-09-17T22:23:43Z", "message": "Include storage format name to temporary table name"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "04d1ea87139447c4e5918d81e93b348657276ed2", "author": {"user": {"login": "viczhang861", "name": "Vic Zhang"}}, "url": "https://github.com/prestodb/presto/commit/04d1ea87139447c4e5918d81e93b348657276ed2", "committedDate": "2020-09-15T01:09:11Z", "message": "Use PAGEFILE format for hive unsupported type"}, "afterCommit": {"oid": "2adbd80332ebefdf4777ae22324e0dd18cc3d6d9", "author": {"user": {"login": "viczhang861", "name": "Vic Zhang"}}, "url": "https://github.com/prestodb/presto/commit/2adbd80332ebefdf4777ae22324e0dd18cc3d6d9", "committedDate": "2020-09-17T22:23:43Z", "message": "Include storage format name to temporary table name"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxMDMxOTkw", "url": "https://github.com/prestodb/presto/pull/15168#pullrequestreview-491031990", "createdAt": "2020-09-17T22:29:16Z", "commit": {"oid": "2adbd80332ebefdf4777ae22324e0dd18cc3d6d9"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QyMjoyOToxNlrOHT3qvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QyMjozNTo1NFrOHT30vw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU5NzA1Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static boolean isUsePageFileForHiveUnsupportedType(ConnectorSession session)\n          \n          \n            \n                public static boolean shouldUsePageFileForHiveUnsupportedType(ConnectorSession session)\n          \n      \n    \n    \n  \n\nor\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static boolean isUsePageFileForHiveUnsupportedType(ConnectorSession session)\n          \n          \n            \n                public static boolean usePageFileForHiveUnsupportedType(ConnectorSession session)", "url": "https://github.com/prestodb/presto/pull/15168#discussion_r490597053", "createdAt": "2020-09-17T22:29:16Z", "author": {"login": "aweisberg"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSessionProperties.java", "diffHunk": "@@ -783,6 +789,11 @@ public static HiveCompressionCodec getTemporaryTableCompressionCodec(ConnectorSe\n         return session.getProperty(TEMPORARY_TABLE_COMPRESSION_CODEC, HiveCompressionCodec.class);\n     }\n \n+    public static boolean isUsePageFileForHiveUnsupportedType(ConnectorSession session)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2adbd80332ebefdf4777ae22324e0dd18cc3d6d9"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU5OTYxNQ==", "bodyText": "Heh in some ways this duplication of logic with translate is also unfortunate.\nI like pushing the nastiness into this utility function, but @wenleix  would you rather not duplicate it and keep the exception handling?", "url": "https://github.com/prestodb/presto/pull/15168#discussion_r490599615", "createdAt": "2020-09-17T22:35:54Z", "author": {"login": "aweisberg"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveTypeTranslator.java", "diffHunk": "@@ -152,7 +152,62 @@ else if (varcharLength == VarcharType.UNBOUNDED_LENGTH) {\n                             .collect(toList()));\n         }\n         return defaultHiveType\n-                .orElseThrow(() -> new PrestoException(NOT_SUPPORTED, format(\"Unsupported Hive type: %s\", type)))\n+                .orElseThrow(() -> new PrestoException(NOT_SUPPORTED, format(\"No default Hive type provided for unsupported Hive type: %s\", type)))\n                 .getTypeInfo();\n     }\n+\n+    public static boolean isSupportedHiveType(Type type)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2adbd80332ebefdf4777ae22324e0dd18cc3d6d9"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxMTQxMzAw", "url": "https://github.com/prestodb/presto/pull/15168#pullrequestreview-491141300", "createdAt": "2020-09-18T04:21:23Z", "commit": {"oid": "2adbd80332ebefdf4777ae22324e0dd18cc3d6d9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 126, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}