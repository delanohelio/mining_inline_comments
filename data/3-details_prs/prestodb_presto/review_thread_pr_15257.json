{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk1ODcyNTEx", "number": 15257, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNjo1ODo0M1rOEp4kpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQyMDoxMToyMFrOEp75VQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMzUzOTU4OnYy", "diffSide": "RIGHT", "path": "presto-cache/src/test/java/com/facebook/presto/cache/alluxio/TestAlluxioCachingFileSystem.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNjo1ODo0M1rOHb045w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNzoxMjoxMVrOHb1SQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk0MDEzNQ==", "bodyText": "cacheDirectory", "url": "https://github.com/prestodb/presto/pull/15257#discussion_r498940135", "createdAt": "2020-10-02T16:58:43Z", "author": {"login": "highker"}, "path": "presto-cache/src/test/java/com/facebook/presto/cache/alluxio/TestAlluxioCachingFileSystem.java", "diffHunk": "@@ -186,9 +191,29 @@ public void testStress()\n         });\n     }\n \n-    // This test must go first or the LocalCacheManager singleton will be created by other tests\n-    @Test(timeOut = 30_000, expectedExceptions = {IOException.class}, priority = -1)\n-    public void testCreationFailure()\n+    @Test(timeOut = 30_000, expectedExceptions = {IOException.class})\n+    public void testSyncRestoreFailure()\n+            throws Exception\n+    {\n+        URI badCacheDirectory = createTempDirectory(\"alluxio_cache_bad\").toUri();\n+        File cacheDir = new File(badCacheDirectory.getPath());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74b2665c21d5f58234decabdb480e62da181c680"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk0NjYyNw==", "bodyText": "done", "url": "https://github.com/prestodb/presto/pull/15257#discussion_r498946627", "createdAt": "2020-10-02T17:12:11Z", "author": {"login": "apc999"}, "path": "presto-cache/src/test/java/com/facebook/presto/cache/alluxio/TestAlluxioCachingFileSystem.java", "diffHunk": "@@ -186,9 +191,29 @@ public void testStress()\n         });\n     }\n \n-    // This test must go first or the LocalCacheManager singleton will be created by other tests\n-    @Test(timeOut = 30_000, expectedExceptions = {IOException.class}, priority = -1)\n-    public void testCreationFailure()\n+    @Test(timeOut = 30_000, expectedExceptions = {IOException.class})\n+    public void testSyncRestoreFailure()\n+            throws Exception\n+    {\n+        URI badCacheDirectory = createTempDirectory(\"alluxio_cache_bad\").toUri();\n+        File cacheDir = new File(badCacheDirectory.getPath());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk0MDEzNQ=="}, "originalCommit": {"oid": "74b2665c21d5f58234decabdb480e62da181c680"}, "originalPosition": 59}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMzU0MDgyOnYy", "diffSide": "RIGHT", "path": "presto-cache/src/test/java/com/facebook/presto/cache/alluxio/TestAlluxioCachingFileSystem.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNjo1OToxMVrOHb05uA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNzoxNDo0OVrOHb1XKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk0MDM0NA==", "bodyText": "merge into one line", "url": "https://github.com/prestodb/presto/pull/15257#discussion_r498940344", "createdAt": "2020-10-02T16:59:11Z", "author": {"login": "highker"}, "path": "presto-cache/src/test/java/com/facebook/presto/cache/alluxio/TestAlluxioCachingFileSystem.java", "diffHunk": "@@ -199,8 +224,66 @@ public void testCreationFailure()\n                 .setBaseDirectory(cacheDirectory);\n         AlluxioCacheConfig alluxioCacheConfig = new AlluxioCacheConfig();\n         Configuration configuration = getHdfsConfiguration(cacheConfig, alluxioCacheConfig);\n+        configuration.set(\"alluxio.user.client.cache.async.restore.enabled\", String.valueOf(true));\n         try {\n-            cachingFileSystem(configuration);\n+            AlluxioCachingFileSystem fileSystem = cachingFileSystem(configuration);\n+            long state = MetricsSystem.counter(MetricKey.CLIENT_CACHE_STATE.getName()).getCount();\n+            assertTrue(state == CacheManager.State.READ_ONLY.getValue()\n+                    || state == CacheManager.State.NOT_IN_USE.getValue());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74b2665c21d5f58234decabdb480e62da181c680"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk0Nzg4Mg==", "bodyText": "done", "url": "https://github.com/prestodb/presto/pull/15257#discussion_r498947882", "createdAt": "2020-10-02T17:14:49Z", "author": {"login": "apc999"}, "path": "presto-cache/src/test/java/com/facebook/presto/cache/alluxio/TestAlluxioCachingFileSystem.java", "diffHunk": "@@ -199,8 +224,66 @@ public void testCreationFailure()\n                 .setBaseDirectory(cacheDirectory);\n         AlluxioCacheConfig alluxioCacheConfig = new AlluxioCacheConfig();\n         Configuration configuration = getHdfsConfiguration(cacheConfig, alluxioCacheConfig);\n+        configuration.set(\"alluxio.user.client.cache.async.restore.enabled\", String.valueOf(true));\n         try {\n-            cachingFileSystem(configuration);\n+            AlluxioCachingFileSystem fileSystem = cachingFileSystem(configuration);\n+            long state = MetricsSystem.counter(MetricKey.CLIENT_CACHE_STATE.getName()).getCount();\n+            assertTrue(state == CacheManager.State.READ_ONLY.getValue()\n+                    || state == CacheManager.State.NOT_IN_USE.getValue());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk0MDM0NA=="}, "originalCommit": {"oid": "74b2665c21d5f58234decabdb480e62da181c680"}, "originalPosition": 90}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMzU0OTgwOnYy", "diffSide": "RIGHT", "path": "presto-cache/src/test/java/com/facebook/presto/cache/alluxio/TestAlluxioCachingFileSystem.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNzowMjoyNFrOHb0_gg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNzoxODoyMFrOHb1dlw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk0MTgyNg==", "bodyText": "same", "url": "https://github.com/prestodb/presto/pull/15257#discussion_r498941826", "createdAt": "2020-10-02T17:02:24Z", "author": {"login": "highker"}, "path": "presto-cache/src/test/java/com/facebook/presto/cache/alluxio/TestAlluxioCachingFileSystem.java", "diffHunk": "@@ -199,8 +224,66 @@ public void testCreationFailure()\n                 .setBaseDirectory(cacheDirectory);\n         AlluxioCacheConfig alluxioCacheConfig = new AlluxioCacheConfig();\n         Configuration configuration = getHdfsConfiguration(cacheConfig, alluxioCacheConfig);\n+        configuration.set(\"alluxio.user.client.cache.async.restore.enabled\", String.valueOf(true));\n         try {\n-            cachingFileSystem(configuration);\n+            AlluxioCachingFileSystem fileSystem = cachingFileSystem(configuration);\n+            long state = MetricsSystem.counter(MetricKey.CLIENT_CACHE_STATE.getName()).getCount();\n+            assertTrue(state == CacheManager.State.READ_ONLY.getValue()\n+                    || state == CacheManager.State.NOT_IN_USE.getValue());\n+            // different cases of read can still proceed even cache is read-only or not-in-use\n+            byte[] buffer = new byte[PAGE_SIZE * 2];\n+            int pageOffset = PAGE_SIZE;\n+            // new read\n+            resetBaseline();\n+            assertEquals(readFully(fileSystem, pageOffset + 10, buffer, 0, 100), 100);\n+            checkMetrics(MetricKey.CLIENT_CACHE_BYTES_READ_CACHE, 0);\n+            checkMetrics(MetricKey.CLIENT_CACHE_BYTES_REQUESTED_EXTERNAL, 100);\n+            checkMetrics(MetricKey.CLIENT_CACHE_BYTES_READ_EXTERNAL, PAGE_SIZE);\n+            validateBuffer(data, pageOffset + 10, buffer, 0, 100);\n+\n+            // read within the cached page\n+            resetBaseline();\n+            assertEquals(readFully(fileSystem, pageOffset + 20, buffer, 0, 90), 90);\n+            checkMetrics(MetricKey.CLIENT_CACHE_BYTES_READ_CACHE, 0);\n+            checkMetrics(MetricKey.CLIENT_CACHE_BYTES_REQUESTED_EXTERNAL, 90);\n+            checkMetrics(MetricKey.CLIENT_CACHE_BYTES_READ_EXTERNAL, PAGE_SIZE);\n+            validateBuffer(data, pageOffset + 20, buffer, 0, 90);\n+\n+            // read partially after the range of the cache\n+            resetBaseline();\n+            assertEquals(readFully(fileSystem, pageOffset + PAGE_SIZE - 10, buffer, 0, 100), 100);\n+            checkMetrics(MetricKey.CLIENT_CACHE_BYTES_READ_CACHE, 0);\n+            checkMetrics(MetricKey.CLIENT_CACHE_BYTES_REQUESTED_EXTERNAL, 100);\n+            checkMetrics(MetricKey.CLIENT_CACHE_BYTES_READ_EXTERNAL, 2 * PAGE_SIZE);\n+            validateBuffer(data, pageOffset + PAGE_SIZE - 10, buffer, 0, 100);\n+\n+            // read partially before the range of the cache\n+            resetBaseline();\n+            assertEquals(readFully(fileSystem, pageOffset - 10, buffer, 10, 50), 50);\n+            checkMetrics(MetricKey.CLIENT_CACHE_BYTES_READ_CACHE, 0);\n+            checkMetrics(MetricKey.CLIENT_CACHE_BYTES_REQUESTED_EXTERNAL, 50);\n+            checkMetrics(MetricKey.CLIENT_CACHE_BYTES_READ_EXTERNAL, 2 * PAGE_SIZE);\n+            validateBuffer(data, pageOffset - 10, buffer, 10, 50);\n+\n+            // skip one page\n+            resetBaseline();\n+            assertEquals(readFully(fileSystem, pageOffset + PAGE_SIZE * 3, buffer, 40, 50), 50);\n+            checkMetrics(MetricKey.CLIENT_CACHE_BYTES_READ_CACHE, 0);\n+            checkMetrics(MetricKey.CLIENT_CACHE_BYTES_REQUESTED_EXTERNAL, 50);\n+            checkMetrics(MetricKey.CLIENT_CACHE_BYTES_READ_EXTERNAL, PAGE_SIZE);\n+            validateBuffer(data, pageOffset + PAGE_SIZE * 3, buffer, 40, 50);\n+\n+            // read between cached pages\n+            resetBaseline();\n+            assertEquals(readFully(fileSystem, pageOffset + PAGE_SIZE * 2 - 10, buffer, 400, PAGE_SIZE + 20), PAGE_SIZE + 20);\n+            checkMetrics(MetricKey.CLIENT_CACHE_BYTES_READ_CACHE, 0);\n+            checkMetrics(MetricKey.CLIENT_CACHE_BYTES_REQUESTED_EXTERNAL, PAGE_SIZE + 20);\n+            checkMetrics(MetricKey.CLIENT_CACHE_BYTES_READ_EXTERNAL, 3 * PAGE_SIZE);\n+            validateBuffer(data, pageOffset + PAGE_SIZE * 2 - 10, buffer, 400, PAGE_SIZE + 20);\n+\n+            state = MetricsSystem.counter(MetricKey.CLIENT_CACHE_STATE.getName()).getCount();\n+            assertTrue(state == CacheManager.State.READ_ONLY.getValue()\n+                    || state == CacheManager.State.NOT_IN_USE.getValue());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74b2665c21d5f58234decabdb480e62da181c680"}, "originalPosition": 144}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk0OTUyNw==", "bodyText": "done. Is there any documented java style guideline for the codebase?", "url": "https://github.com/prestodb/presto/pull/15257#discussion_r498949527", "createdAt": "2020-10-02T17:18:20Z", "author": {"login": "apc999"}, "path": "presto-cache/src/test/java/com/facebook/presto/cache/alluxio/TestAlluxioCachingFileSystem.java", "diffHunk": "@@ -199,8 +224,66 @@ public void testCreationFailure()\n                 .setBaseDirectory(cacheDirectory);\n         AlluxioCacheConfig alluxioCacheConfig = new AlluxioCacheConfig();\n         Configuration configuration = getHdfsConfiguration(cacheConfig, alluxioCacheConfig);\n+        configuration.set(\"alluxio.user.client.cache.async.restore.enabled\", String.valueOf(true));\n         try {\n-            cachingFileSystem(configuration);\n+            AlluxioCachingFileSystem fileSystem = cachingFileSystem(configuration);\n+            long state = MetricsSystem.counter(MetricKey.CLIENT_CACHE_STATE.getName()).getCount();\n+            assertTrue(state == CacheManager.State.READ_ONLY.getValue()\n+                    || state == CacheManager.State.NOT_IN_USE.getValue());\n+            // different cases of read can still proceed even cache is read-only or not-in-use\n+            byte[] buffer = new byte[PAGE_SIZE * 2];\n+            int pageOffset = PAGE_SIZE;\n+            // new read\n+            resetBaseline();\n+            assertEquals(readFully(fileSystem, pageOffset + 10, buffer, 0, 100), 100);\n+            checkMetrics(MetricKey.CLIENT_CACHE_BYTES_READ_CACHE, 0);\n+            checkMetrics(MetricKey.CLIENT_CACHE_BYTES_REQUESTED_EXTERNAL, 100);\n+            checkMetrics(MetricKey.CLIENT_CACHE_BYTES_READ_EXTERNAL, PAGE_SIZE);\n+            validateBuffer(data, pageOffset + 10, buffer, 0, 100);\n+\n+            // read within the cached page\n+            resetBaseline();\n+            assertEquals(readFully(fileSystem, pageOffset + 20, buffer, 0, 90), 90);\n+            checkMetrics(MetricKey.CLIENT_CACHE_BYTES_READ_CACHE, 0);\n+            checkMetrics(MetricKey.CLIENT_CACHE_BYTES_REQUESTED_EXTERNAL, 90);\n+            checkMetrics(MetricKey.CLIENT_CACHE_BYTES_READ_EXTERNAL, PAGE_SIZE);\n+            validateBuffer(data, pageOffset + 20, buffer, 0, 90);\n+\n+            // read partially after the range of the cache\n+            resetBaseline();\n+            assertEquals(readFully(fileSystem, pageOffset + PAGE_SIZE - 10, buffer, 0, 100), 100);\n+            checkMetrics(MetricKey.CLIENT_CACHE_BYTES_READ_CACHE, 0);\n+            checkMetrics(MetricKey.CLIENT_CACHE_BYTES_REQUESTED_EXTERNAL, 100);\n+            checkMetrics(MetricKey.CLIENT_CACHE_BYTES_READ_EXTERNAL, 2 * PAGE_SIZE);\n+            validateBuffer(data, pageOffset + PAGE_SIZE - 10, buffer, 0, 100);\n+\n+            // read partially before the range of the cache\n+            resetBaseline();\n+            assertEquals(readFully(fileSystem, pageOffset - 10, buffer, 10, 50), 50);\n+            checkMetrics(MetricKey.CLIENT_CACHE_BYTES_READ_CACHE, 0);\n+            checkMetrics(MetricKey.CLIENT_CACHE_BYTES_REQUESTED_EXTERNAL, 50);\n+            checkMetrics(MetricKey.CLIENT_CACHE_BYTES_READ_EXTERNAL, 2 * PAGE_SIZE);\n+            validateBuffer(data, pageOffset - 10, buffer, 10, 50);\n+\n+            // skip one page\n+            resetBaseline();\n+            assertEquals(readFully(fileSystem, pageOffset + PAGE_SIZE * 3, buffer, 40, 50), 50);\n+            checkMetrics(MetricKey.CLIENT_CACHE_BYTES_READ_CACHE, 0);\n+            checkMetrics(MetricKey.CLIENT_CACHE_BYTES_REQUESTED_EXTERNAL, 50);\n+            checkMetrics(MetricKey.CLIENT_CACHE_BYTES_READ_EXTERNAL, PAGE_SIZE);\n+            validateBuffer(data, pageOffset + PAGE_SIZE * 3, buffer, 40, 50);\n+\n+            // read between cached pages\n+            resetBaseline();\n+            assertEquals(readFully(fileSystem, pageOffset + PAGE_SIZE * 2 - 10, buffer, 400, PAGE_SIZE + 20), PAGE_SIZE + 20);\n+            checkMetrics(MetricKey.CLIENT_CACHE_BYTES_READ_CACHE, 0);\n+            checkMetrics(MetricKey.CLIENT_CACHE_BYTES_REQUESTED_EXTERNAL, PAGE_SIZE + 20);\n+            checkMetrics(MetricKey.CLIENT_CACHE_BYTES_READ_EXTERNAL, 3 * PAGE_SIZE);\n+            validateBuffer(data, pageOffset + PAGE_SIZE * 2 - 10, buffer, 400, PAGE_SIZE + 20);\n+\n+            state = MetricsSystem.counter(MetricKey.CLIENT_CACHE_STATE.getName()).getCount();\n+            assertTrue(state == CacheManager.State.READ_ONLY.getValue()\n+                    || state == CacheManager.State.NOT_IN_USE.getValue());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk0MTgyNg=="}, "originalCommit": {"oid": "74b2665c21d5f58234decabdb480e62da181c680"}, "originalPosition": 144}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMzU1MTE4OnYy", "diffSide": "RIGHT", "path": "presto-cache/src/test/java/com/facebook/presto/cache/alluxio/TestAlluxioCachingFileSystem.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNzowMjo0OFrOHb1AUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNzoxMjozNVrOHb1S_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk0MjAzMg==", "bodyText": "cacheDirectory", "url": "https://github.com/prestodb/presto/pull/15257#discussion_r498942032", "createdAt": "2020-10-02T17:02:48Z", "author": {"login": "highker"}, "path": "presto-cache/src/test/java/com/facebook/presto/cache/alluxio/TestAlluxioCachingFileSystem.java", "diffHunk": "@@ -186,9 +191,29 @@ public void testStress()\n         });\n     }\n \n-    // This test must go first or the LocalCacheManager singleton will be created by other tests\n-    @Test(timeOut = 30_000, expectedExceptions = {IOException.class}, priority = -1)\n-    public void testCreationFailure()\n+    @Test(timeOut = 30_000, expectedExceptions = {IOException.class})\n+    public void testSyncRestoreFailure()\n+            throws Exception\n+    {\n+        URI badCacheDirectory = createTempDirectory(\"alluxio_cache_bad\").toUri();\n+        File cacheDir = new File(badCacheDirectory.getPath());\n+        cacheDir.setWritable(false);\n+        CacheConfig cacheConfig = new CacheConfig()\n+                .setCacheType(ALLUXIO)\n+                .setCachingEnabled(true)\n+                .setBaseDirectory(badCacheDirectory);\n+        AlluxioCacheConfig alluxioCacheConfig = new AlluxioCacheConfig();\n+        Configuration configuration = getHdfsConfiguration(cacheConfig, alluxioCacheConfig);\n+        try {\n+            cachingFileSystem(configuration);\n+        }\n+        finally {\n+            cacheDir.setWritable(true);\n+        }\n+    }\n+\n+    @Test(timeOut = 30_000)\n+    public void testBasicReadWithAsyncRestoreFailure()\n             throws Exception\n     {\n         File cacheDir = new File(cacheDirectory.getPath());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74b2665c21d5f58234decabdb480e62da181c680"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk0NjgxMw==", "bodyText": "done", "url": "https://github.com/prestodb/presto/pull/15257#discussion_r498946813", "createdAt": "2020-10-02T17:12:35Z", "author": {"login": "apc999"}, "path": "presto-cache/src/test/java/com/facebook/presto/cache/alluxio/TestAlluxioCachingFileSystem.java", "diffHunk": "@@ -186,9 +191,29 @@ public void testStress()\n         });\n     }\n \n-    // This test must go first or the LocalCacheManager singleton will be created by other tests\n-    @Test(timeOut = 30_000, expectedExceptions = {IOException.class}, priority = -1)\n-    public void testCreationFailure()\n+    @Test(timeOut = 30_000, expectedExceptions = {IOException.class})\n+    public void testSyncRestoreFailure()\n+            throws Exception\n+    {\n+        URI badCacheDirectory = createTempDirectory(\"alluxio_cache_bad\").toUri();\n+        File cacheDir = new File(badCacheDirectory.getPath());\n+        cacheDir.setWritable(false);\n+        CacheConfig cacheConfig = new CacheConfig()\n+                .setCacheType(ALLUXIO)\n+                .setCachingEnabled(true)\n+                .setBaseDirectory(badCacheDirectory);\n+        AlluxioCacheConfig alluxioCacheConfig = new AlluxioCacheConfig();\n+        Configuration configuration = getHdfsConfiguration(cacheConfig, alluxioCacheConfig);\n+        try {\n+            cachingFileSystem(configuration);\n+        }\n+        finally {\n+            cacheDir.setWritable(true);\n+        }\n+    }\n+\n+    @Test(timeOut = 30_000)\n+    public void testBasicReadWithAsyncRestoreFailure()\n             throws Exception\n     {\n         File cacheDir = new File(cacheDirectory.getPath());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk0MjAzMg=="}, "originalCommit": {"oid": "74b2665c21d5f58234decabdb480e62da181c680"}, "originalPosition": 79}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyNDA3OTU4OnYy", "diffSide": "RIGHT", "path": "presto-cache/src/test/java/com/facebook/presto/cache/alluxio/TestAlluxioCachingFileSystem.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQyMDowOTo1N1rOHb6Q1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQyMDowOTo1N1rOHb6Q1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAyODE4MA==", "bodyText": "nit: may be just se literal directly?", "url": "https://github.com/prestodb/presto/pull/15257#discussion_r499028180", "createdAt": "2020-10-02T20:09:57Z", "author": {"login": "jainxrohit"}, "path": "presto-cache/src/test/java/com/facebook/presto/cache/alluxio/TestAlluxioCachingFileSystem.java", "diffHunk": "@@ -186,24 +191,100 @@ public void testStress()\n         });\n     }\n \n-    // This test must go first or the LocalCacheManager singleton will be created by other tests\n-    @Test(timeOut = 30_000, expectedExceptions = {IOException.class}, priority = -1)\n-    public void testCreationFailure()\n+    @Test(timeOut = 30_000, expectedExceptions = {IOException.class})\n+    public void testSyncRestoreFailure()\n             throws Exception\n     {\n-        File cacheDir = new File(cacheDirectory.getPath());\n-        cacheDir.setWritable(false);\n+        URI badCacheDirectory = createTempDirectory(\"alluxio_cache_bad\").toUri();\n+        File cacheDirectory = new File(badCacheDirectory.getPath());\n+        cacheDirectory.setWritable(false);\n         CacheConfig cacheConfig = new CacheConfig()\n                 .setCacheType(ALLUXIO)\n                 .setCachingEnabled(true)\n-                .setBaseDirectory(cacheDirectory);\n+                .setBaseDirectory(badCacheDirectory);\n         AlluxioCacheConfig alluxioCacheConfig = new AlluxioCacheConfig();\n         Configuration configuration = getHdfsConfiguration(cacheConfig, alluxioCacheConfig);\n         try {\n             cachingFileSystem(configuration);\n         }\n         finally {\n-            cacheDir.setWritable(true);\n+            cacheDirectory.setWritable(true);\n+        }\n+    }\n+\n+    @Test(timeOut = 30_000)\n+    public void testBasicReadWithAsyncRestoreFailure()\n+            throws Exception\n+    {\n+        File cacheDirectory = new File(this.cacheDirectory.getPath());\n+        cacheDirectory.setWritable(false);\n+        CacheConfig cacheConfig = new CacheConfig()\n+                .setCacheType(ALLUXIO)\n+                .setCachingEnabled(true)\n+                .setBaseDirectory(this.cacheDirectory);\n+        AlluxioCacheConfig alluxioCacheConfig = new AlluxioCacheConfig();\n+        Configuration configuration = getHdfsConfiguration(cacheConfig, alluxioCacheConfig);\n+        configuration.set(\"alluxio.user.client.cache.async.restore.enabled\", String.valueOf(true));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5efe135fa2c8a060586d6b6fe4eefcdc15d0ca1d"}, "originalPosition": 91}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyNDA4NDA1OnYy", "diffSide": "RIGHT", "path": "presto-cache/src/test/java/com/facebook/presto/cache/alluxio/TestAlluxioCachingFileSystem.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQyMDoxMToyMFrOHb6Tig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQyMDozNjowM1rOHb65cg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAyODg3NA==", "bodyText": "I understand that this would be made accessible in later versions?", "url": "https://github.com/prestodb/presto/pull/15257#discussion_r499028874", "createdAt": "2020-10-02T20:11:20Z", "author": {"login": "jainxrohit"}, "path": "presto-cache/src/test/java/com/facebook/presto/cache/alluxio/TestAlluxioCachingFileSystem.java", "diffHunk": "@@ -234,6 +315,21 @@ public void testInitialization()\n         assertEquals(metricsDomain, conf.get(\"sink.jmx.domain\", \"bad result\"));\n     }\n \n+    // TODO: update unit tests after CacheManager.reset() is available to avoid using reflection to modify singleton\n+    private void resetCacheManager()\n+            throws Exception\n+    {\n+        Field field = CacheManager.Factory.class.getDeclaredField(\"CACHE_MANAGER\");\n+        field.setAccessible(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5efe135fa2c8a060586d6b6fe4eefcdc15d0ca1d"}, "originalPosition": 164}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAzODU3OA==", "bodyText": "Correct, i already submitted Alluxio/alluxio#12169 to expose this as an API", "url": "https://github.com/prestodb/presto/pull/15257#discussion_r499038578", "createdAt": "2020-10-02T20:36:03Z", "author": {"login": "apc999"}, "path": "presto-cache/src/test/java/com/facebook/presto/cache/alluxio/TestAlluxioCachingFileSystem.java", "diffHunk": "@@ -234,6 +315,21 @@ public void testInitialization()\n         assertEquals(metricsDomain, conf.get(\"sink.jmx.domain\", \"bad result\"));\n     }\n \n+    // TODO: update unit tests after CacheManager.reset() is available to avoid using reflection to modify singleton\n+    private void resetCacheManager()\n+            throws Exception\n+    {\n+        Field field = CacheManager.Factory.class.getDeclaredField(\"CACHE_MANAGER\");\n+        field.setAccessible(true);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAyODg3NA=="}, "originalCommit": {"oid": "5efe135fa2c8a060586d6b6fe4eefcdc15d0ca1d"}, "originalPosition": 164}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3465, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}