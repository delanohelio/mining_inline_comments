{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA0NjMzMDc1", "number": 15319, "title": "Pinot streaming connector", "bodyText": "Pinot recently added support of gRpc based streaming query endpoint at Pinot server level, which allows user to pull data in a streaming fashion. (apache/pinot#5599, apache/pinot#6027 )\nThis is extremely good for the use cases which requires large data scan and try to retrieve a lot of data from Pinot.\nComparing to the non-streaming way, Presto segment level query requires pinot server to process the query on the entire data segment and all the results have to be in memory and serialized then send back to client. In the streaming fashion, client side can specify a block size and only call next to fetch the given size of results to process then call next to fetch the next block. Pinot server side only advance and process the data  processing when client calls next. In this way, Pinot server side cpu and memory pressure is much less.\nTest plan - (Please fill in how you tested your changes)\nTested locally with Pinot 0.6.0 with Streaming server supported.\n== RELEASE NOTES ==\n\nPinot Changes\n* Support query Pinot server with streaming API (Requires Pinot Version >= 0.6.0.)\n* Enabled it by setting `pinot.use-streaming-for-segment-queries=true`", "createdAt": "2020-10-16T06:54:27Z", "url": "https://github.com/prestodb/presto/pull/15319", "merged": true, "mergeCommit": {"oid": "780dc894b56da7db0da56aa20750499699a5eb26"}, "closed": true, "closedAt": "2020-11-03T19:29:10Z", "author": {"login": "xiangfu0"}, "timelineItems": {"totalCount": 26, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdTlENggFqTUxMTAyMzc2Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdY-VZPAFqTUyMjgxMjMwNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExMDIzNzY2", "url": "https://github.com/prestodb/presto/pull/15319#pullrequestreview-511023766", "createdAt": "2020-10-18T00:25:30Z", "commit": {"oid": "6cb486b66992b1b46c04c06b602ce996b0b5d71f"}, "state": "COMMENTED", "comments": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOFQwMDoyNTozMFrOHjgwtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOFQwMToxMDoxOFrOHjg8fw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk5ODk2NQ==", "bodyText": "I am curious why is this cached ? What happens if an instance restarts etc and comes up with a different port ? Or atleast should the cache expiry interval be minimized ?", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r506998965", "createdAt": "2020-10-18T00:25:30Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java", "diffHunk": "@@ -110,6 +116,9 @@ public PinotClusterInfoFetcher(\n         this.brokersForTableCache = CacheBuilder.newBuilder()\n                 .expireAfterWrite(cacheExpiryMs, TimeUnit.MILLISECONDS)\n                 .build((CacheLoader.from(this::getAllBrokersForTable)));\n+        this.instanceConfigCache = CacheBuilder.newBuilder()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6cb486b66992b1b46c04c06b602ce996b0b5d71f"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk5OTAyMQ==", "bodyText": "Perhaps you can also add some color to the PR description about when is it a good idea to use streaming for segment query path ? I would imagine, always if available ?", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r506999021", "createdAt": "2020-10-18T00:26:24Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotConfig.java", "diffHunk": "@@ -490,4 +495,40 @@ public PinotConfig setPushdownTopNBrokerQueries(boolean pushdownTopNBrokerQuerie\n         this.pushdownTopNBrokerQueries = pushdownTopNBrokerQueries;\n         return this;\n     }\n+\n+    public boolean isUseStreamingForSegmentQueries()\n+    {\n+        return useStreamingForSegmentQueries;\n+    }\n+\n+    @Config(\"pinot.use-streaming-for-segment-queries\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6cb486b66992b1b46c04c06b602ce996b0b5d71f"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk5OTEzNw==", "bodyText": "Perhaps PinotStreamingSegmentPageSource or PinotSegmentStreamingPageSource ?\n`Coz I think that GRPC is an implementation detail and shouldn't be exposed via the class name.", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r506999137", "createdAt": "2020-10-18T00:28:07Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPageSourceProvider.java", "diffHunk": "@@ -81,12 +90,22 @@ public ConnectorPageSource createPageSource(\n \n         switch (pinotSplit.getSplitType()) {\n             case SEGMENT:\n-                return new PinotSegmentPageSource(\n+                if (this.pinotConfig.isUseStreamingForSegmentQueries()) {\n+                    return new PinotSegmentPageSourceForGrpc(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6cb486b66992b1b46c04c06b602ce996b0b5d71f"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk5OTI5Ng==", "bodyText": "fetchNextPage ?", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r506999296", "createdAt": "2020-10-18T00:30:27Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSource.java", "diffHunk": "@@ -172,6 +175,11 @@ public Page getNextPage()\n         }\n         currentDataTable = dataTableList.pop();\n \n+        return fillPage();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6cb486b66992b1b46c04c06b602ce996b0b5d71f"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwMDE3OQ==", "bodyText": "PinotStreamingSegmentPageSource ?", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r507000179", "createdAt": "2020-10-18T00:44:11Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSourceForGrpc.java", "diffHunk": "@@ -0,0 +1,142 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.pinot;\n+\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.pinot.grpc.Constants;\n+import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n+import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n+import com.facebook.presto.pinot.grpc.ServerResponseWrapper;\n+import com.facebook.presto.spi.ConnectorSession;\n+import org.apache.pinot.common.utils.DataTable;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_DATA_FETCH_EXCEPTION;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_INVALID_PQL_GENERATED;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_UNEXPECTED_RESPONSE;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * This class retrieves Pinot data from a Pinot client, and re-constructs the data into Presto Pages.\n+ */\n+\n+public class PinotSegmentPageSourceForGrpc", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6cb486b66992b1b46c04c06b602ce996b0b5d71f"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwMDIzNw==", "bodyText": "I didn't follow why this is not: !serverResponseIterator.hasNext()", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r507000237", "createdAt": "2020-10-18T00:45:01Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSourceForGrpc.java", "diffHunk": "@@ -0,0 +1,142 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.pinot;\n+\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.pinot.grpc.Constants;\n+import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n+import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n+import com.facebook.presto.pinot.grpc.ServerResponseWrapper;\n+import com.facebook.presto.spi.ConnectorSession;\n+import org.apache.pinot.common.utils.DataTable;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_DATA_FETCH_EXCEPTION;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_INVALID_PQL_GENERATED;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_UNEXPECTED_RESPONSE;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * This class retrieves Pinot data from a Pinot client, and re-constructs the data into Presto Pages.\n+ */\n+\n+public class PinotSegmentPageSourceForGrpc\n+        extends PinotSegmentPageSource\n+{\n+    private final PinotStreamingQueryClient pinotStreamingQueryClient;\n+    private Iterator<ServerResponseWrapper> serverResponseIterator;\n+    private long completedPositions;\n+\n+    public PinotSegmentPageSourceForGrpc(\n+            ConnectorSession session,\n+            PinotConfig pinotConfig,\n+            PinotStreamingQueryClient pinotStreamingQueryClient,\n+            PinotSplit split,\n+            List<PinotColumnHandle> columnHandles)\n+    {\n+        super(session, pinotConfig, null, split, columnHandles);\n+        this.pinotStreamingQueryClient = requireNonNull(pinotStreamingQueryClient, \"pinotStreamingQueryClient is null\");\n+    }\n+\n+    @Override\n+    public boolean isFinished()\n+    {\n+        return closed;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6cb486b66992b1b46c04c06b602ce996b0b5d71f"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwMDMwMQ==", "bodyText": "This is a bit confusing: Because if you inline this, it reads as:\nif (closed) {\n  close();\n  return null;\n}", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r507000301", "createdAt": "2020-10-18T00:45:40Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSourceForGrpc.java", "diffHunk": "@@ -0,0 +1,142 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.pinot;\n+\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.pinot.grpc.Constants;\n+import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n+import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n+import com.facebook.presto.pinot.grpc.ServerResponseWrapper;\n+import com.facebook.presto.spi.ConnectorSession;\n+import org.apache.pinot.common.utils.DataTable;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_DATA_FETCH_EXCEPTION;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_INVALID_PQL_GENERATED;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_UNEXPECTED_RESPONSE;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * This class retrieves Pinot data from a Pinot client, and re-constructs the data into Presto Pages.\n+ */\n+\n+public class PinotSegmentPageSourceForGrpc\n+        extends PinotSegmentPageSource\n+{\n+    private final PinotStreamingQueryClient pinotStreamingQueryClient;\n+    private Iterator<ServerResponseWrapper> serverResponseIterator;\n+    private long completedPositions;\n+\n+    public PinotSegmentPageSourceForGrpc(\n+            ConnectorSession session,\n+            PinotConfig pinotConfig,\n+            PinotStreamingQueryClient pinotStreamingQueryClient,\n+            PinotSplit split,\n+            List<PinotColumnHandle> columnHandles)\n+    {\n+        super(session, pinotConfig, null, split, columnHandles);\n+        this.pinotStreamingQueryClient = requireNonNull(pinotStreamingQueryClient, \"pinotStreamingQueryClient is null\");\n+    }\n+\n+    @Override\n+    public boolean isFinished()\n+    {\n+        return closed;\n+    }\n+\n+    /**\n+     * @return constructed page for pinot data.\n+     */\n+    @Override\n+    public Page getNextPage()\n+    {\n+        if (isFinished()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6cb486b66992b1b46c04c06b602ce996b0b5d71f"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwMDQ2NQ==", "bodyText": "I think the exception e needs to be chained to the new PinotException and not String.format", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r507000465", "createdAt": "2020-10-18T00:48:15Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSourceForGrpc.java", "diffHunk": "@@ -0,0 +1,142 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.pinot;\n+\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.pinot.grpc.Constants;\n+import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n+import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n+import com.facebook.presto.pinot.grpc.ServerResponseWrapper;\n+import com.facebook.presto.spi.ConnectorSession;\n+import org.apache.pinot.common.utils.DataTable;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_DATA_FETCH_EXCEPTION;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_INVALID_PQL_GENERATED;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_UNEXPECTED_RESPONSE;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * This class retrieves Pinot data from a Pinot client, and re-constructs the data into Presto Pages.\n+ */\n+\n+public class PinotSegmentPageSourceForGrpc\n+        extends PinotSegmentPageSource\n+{\n+    private final PinotStreamingQueryClient pinotStreamingQueryClient;\n+    private Iterator<ServerResponseWrapper> serverResponseIterator;\n+    private long completedPositions;\n+\n+    public PinotSegmentPageSourceForGrpc(\n+            ConnectorSession session,\n+            PinotConfig pinotConfig,\n+            PinotStreamingQueryClient pinotStreamingQueryClient,\n+            PinotSplit split,\n+            List<PinotColumnHandle> columnHandles)\n+    {\n+        super(session, pinotConfig, null, split, columnHandles);\n+        this.pinotStreamingQueryClient = requireNonNull(pinotStreamingQueryClient, \"pinotStreamingQueryClient is null\");\n+    }\n+\n+    @Override\n+    public boolean isFinished()\n+    {\n+        return closed;\n+    }\n+\n+    /**\n+     * @return constructed page for pinot data.\n+     */\n+    @Override\n+    public Page getNextPage()\n+    {\n+        if (isFinished()) {\n+            close();\n+            return null;\n+        }\n+        if (serverResponseIterator == null) {\n+            serverResponseIterator = queryPinot(split);\n+        }\n+        ByteBuffer byteBuffer = null;\n+        if (serverResponseIterator.hasNext()) {\n+            long startTimeNanos = System.nanoTime();\n+            ServerResponseWrapper serverResponse = serverResponseIterator.next();\n+            readTimeNanos += System.nanoTime() - startTimeNanos;\n+            switch (serverResponse.getResponseType()) {\n+                case Constants.Response.ResponseType.DATA:\n+                    estimatedMemoryUsageInBytes = serverResponse.getSerializedSize();\n+                    // Store each dataTable which will later be constructed into Pages.\n+                    try {\n+                        byteBuffer = serverResponse.getPayloadReadOnlyByteBuffer();\n+                        DataTable dataTable = serverResponse.getDataTable(byteBuffer);\n+                        checkExceptions(dataTable, split, PinotSessionProperties.isMarkDataFetchExceptionsAsRetriable(session));\n+                        currentDataTable = new PinotSegmentPageSource.PinotDataTableWithSize(dataTable, serverResponse.getSerializedSize());\n+                    }\n+                    catch (IOException e) {\n+                        throw new PinotException(\n+                            PINOT_DATA_FETCH_EXCEPTION,\n+                            split.getSegmentPql(),\n+                            String.format(\"Encountered Pinot exceptions when fetching data table from %s: %s\", split, e));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6cb486b66992b1b46c04c06b602ce996b0b5d71f"}, "originalPosition": 95}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwMDY2MA==", "bodyText": "When does this case occur ? It seems odd to me to have a global GRPC port defined in the config ... is this an error or does this case happen in certain upgrade situations ?", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r507000660", "createdAt": "2020-10-18T00:50:53Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSourceForGrpc.java", "diffHunk": "@@ -0,0 +1,142 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.pinot;\n+\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.pinot.grpc.Constants;\n+import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n+import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n+import com.facebook.presto.pinot.grpc.ServerResponseWrapper;\n+import com.facebook.presto.spi.ConnectorSession;\n+import org.apache.pinot.common.utils.DataTable;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_DATA_FETCH_EXCEPTION;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_INVALID_PQL_GENERATED;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_UNEXPECTED_RESPONSE;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * This class retrieves Pinot data from a Pinot client, and re-constructs the data into Presto Pages.\n+ */\n+\n+public class PinotSegmentPageSourceForGrpc\n+        extends PinotSegmentPageSource\n+{\n+    private final PinotStreamingQueryClient pinotStreamingQueryClient;\n+    private Iterator<ServerResponseWrapper> serverResponseIterator;\n+    private long completedPositions;\n+\n+    public PinotSegmentPageSourceForGrpc(\n+            ConnectorSession session,\n+            PinotConfig pinotConfig,\n+            PinotStreamingQueryClient pinotStreamingQueryClient,\n+            PinotSplit split,\n+            List<PinotColumnHandle> columnHandles)\n+    {\n+        super(session, pinotConfig, null, split, columnHandles);\n+        this.pinotStreamingQueryClient = requireNonNull(pinotStreamingQueryClient, \"pinotStreamingQueryClient is null\");\n+    }\n+\n+    @Override\n+    public boolean isFinished()\n+    {\n+        return closed;\n+    }\n+\n+    /**\n+     * @return constructed page for pinot data.\n+     */\n+    @Override\n+    public Page getNextPage()\n+    {\n+        if (isFinished()) {\n+            close();\n+            return null;\n+        }\n+        if (serverResponseIterator == null) {\n+            serverResponseIterator = queryPinot(split);\n+        }\n+        ByteBuffer byteBuffer = null;\n+        if (serverResponseIterator.hasNext()) {\n+            long startTimeNanos = System.nanoTime();\n+            ServerResponseWrapper serverResponse = serverResponseIterator.next();\n+            readTimeNanos += System.nanoTime() - startTimeNanos;\n+            switch (serverResponse.getResponseType()) {\n+                case Constants.Response.ResponseType.DATA:\n+                    estimatedMemoryUsageInBytes = serverResponse.getSerializedSize();\n+                    // Store each dataTable which will later be constructed into Pages.\n+                    try {\n+                        byteBuffer = serverResponse.getPayloadReadOnlyByteBuffer();\n+                        DataTable dataTable = serverResponse.getDataTable(byteBuffer);\n+                        checkExceptions(dataTable, split, PinotSessionProperties.isMarkDataFetchExceptionsAsRetriable(session));\n+                        currentDataTable = new PinotSegmentPageSource.PinotDataTableWithSize(dataTable, serverResponse.getSerializedSize());\n+                    }\n+                    catch (IOException e) {\n+                        throw new PinotException(\n+                            PINOT_DATA_FETCH_EXCEPTION,\n+                            split.getSegmentPql(),\n+                            String.format(\"Encountered Pinot exceptions when fetching data table from %s: %s\", split, e));\n+                    }\n+                    break;\n+                case Constants.Response.ResponseType.METADATA:\n+                    // The last part of the response is Metadata\n+                    currentDataTable = null;\n+                    serverResponseIterator = null;\n+                    close();\n+                    return null;\n+                default:\n+                    throw new PinotException(\n+                        PINOT_UNEXPECTED_RESPONSE,\n+                        split.getSegmentPql(),\n+                        String.format(\"Encountered Pinot exceptions, unknown response type - %s\", serverResponse.getResponseType()));\n+            }\n+        }\n+        Page page = fillPage();\n+        completedPositions += currentDataTable.getDataTable().getNumberOfRows();\n+        if (byteBuffer != null) {\n+            byteBuffer.clear();\n+        }\n+        return page;\n+    }\n+\n+    private Iterator<ServerResponseWrapper> queryPinot(PinotSplit split)\n+    {\n+        String sql = split.getSegmentPql().orElseThrow(() -> new PinotException(PINOT_INVALID_PQL_GENERATED, Optional.empty(), \"Expected the segment split to contain the pql\"));\n+        String host = split.getSegmentHost().orElseThrow(() -> new PinotException(PINOT_INVALID_PQL_GENERATED, Optional.empty(), \"Expected the segment split to contain the host\"));\n+        String[] hostSplits = host.split(\"_\");\n+        String grpcHost = (hostSplits.length > 1) ? hostSplits[hostSplits.length - 2] : host;\n+        int grpcPort = split.getGrpcPort().isPresent() ? split.getGrpcPort().get() : 0;\n+        // Fallback to default grpc port set by Pinot config.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6cb486b66992b1b46c04c06b602ce996b0b5d71f"}, "originalPosition": 126}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwMTAyNw==", "bodyText": "I didn't follow the need for these changes around the extra arguments to addTime ? Is this required by prestodb/presto-pinot-driver#5 ?", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r507001027", "createdAt": "2020-10-18T00:56:24Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/TestPinotColumnMetadata.java", "diffHunk": "@@ -63,7 +63,7 @@ public void testParsePinotSchemaToPinotColumns()\n                 .addMetric(\"floatMetric\", FieldSpec.DataType.FLOAT)\n                 .addMetric(\"doubleMetric\", FieldSpec.DataType.DOUBLE)\n                 .addMetric(\"bytesMetric\", FieldSpec.DataType.BYTES)\n-                .addTime(new TimeGranularitySpec(FieldSpec.DataType.INT, TimeUnit.DAYS, \"daysSinceEpoch\"))\n+                .addTime(new TimeGranularitySpec(FieldSpec.DataType.INT, TimeUnit.DAYS, \"daysSinceEpoch\"), new TimeGranularitySpec(FieldSpec.DataType.INT, TimeUnit.DAYS, \"daysSinceEpoch\"))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6cb486b66992b1b46c04c06b602ce996b0b5d71f"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwMTE2MA==", "bodyText": "Is this PQL or SQL ? the variable name says SQL, but I think the pinot server only speaks PQL ?", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r507001160", "createdAt": "2020-10-18T00:58:13Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSourceForGrpc.java", "diffHunk": "@@ -0,0 +1,142 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.pinot;\n+\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.pinot.grpc.Constants;\n+import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n+import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n+import com.facebook.presto.pinot.grpc.ServerResponseWrapper;\n+import com.facebook.presto.spi.ConnectorSession;\n+import org.apache.pinot.common.utils.DataTable;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_DATA_FETCH_EXCEPTION;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_INVALID_PQL_GENERATED;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_UNEXPECTED_RESPONSE;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * This class retrieves Pinot data from a Pinot client, and re-constructs the data into Presto Pages.\n+ */\n+\n+public class PinotSegmentPageSourceForGrpc\n+        extends PinotSegmentPageSource\n+{\n+    private final PinotStreamingQueryClient pinotStreamingQueryClient;\n+    private Iterator<ServerResponseWrapper> serverResponseIterator;\n+    private long completedPositions;\n+\n+    public PinotSegmentPageSourceForGrpc(\n+            ConnectorSession session,\n+            PinotConfig pinotConfig,\n+            PinotStreamingQueryClient pinotStreamingQueryClient,\n+            PinotSplit split,\n+            List<PinotColumnHandle> columnHandles)\n+    {\n+        super(session, pinotConfig, null, split, columnHandles);\n+        this.pinotStreamingQueryClient = requireNonNull(pinotStreamingQueryClient, \"pinotStreamingQueryClient is null\");\n+    }\n+\n+    @Override\n+    public boolean isFinished()\n+    {\n+        return closed;\n+    }\n+\n+    /**\n+     * @return constructed page for pinot data.\n+     */\n+    @Override\n+    public Page getNextPage()\n+    {\n+        if (isFinished()) {\n+            close();\n+            return null;\n+        }\n+        if (serverResponseIterator == null) {\n+            serverResponseIterator = queryPinot(split);\n+        }\n+        ByteBuffer byteBuffer = null;\n+        if (serverResponseIterator.hasNext()) {\n+            long startTimeNanos = System.nanoTime();\n+            ServerResponseWrapper serverResponse = serverResponseIterator.next();\n+            readTimeNanos += System.nanoTime() - startTimeNanos;\n+            switch (serverResponse.getResponseType()) {\n+                case Constants.Response.ResponseType.DATA:\n+                    estimatedMemoryUsageInBytes = serverResponse.getSerializedSize();\n+                    // Store each dataTable which will later be constructed into Pages.\n+                    try {\n+                        byteBuffer = serverResponse.getPayloadReadOnlyByteBuffer();\n+                        DataTable dataTable = serverResponse.getDataTable(byteBuffer);\n+                        checkExceptions(dataTable, split, PinotSessionProperties.isMarkDataFetchExceptionsAsRetriable(session));\n+                        currentDataTable = new PinotSegmentPageSource.PinotDataTableWithSize(dataTable, serverResponse.getSerializedSize());\n+                    }\n+                    catch (IOException e) {\n+                        throw new PinotException(\n+                            PINOT_DATA_FETCH_EXCEPTION,\n+                            split.getSegmentPql(),\n+                            String.format(\"Encountered Pinot exceptions when fetching data table from %s: %s\", split, e));\n+                    }\n+                    break;\n+                case Constants.Response.ResponseType.METADATA:\n+                    // The last part of the response is Metadata\n+                    currentDataTable = null;\n+                    serverResponseIterator = null;\n+                    close();\n+                    return null;\n+                default:\n+                    throw new PinotException(\n+                        PINOT_UNEXPECTED_RESPONSE,\n+                        split.getSegmentPql(),\n+                        String.format(\"Encountered Pinot exceptions, unknown response type - %s\", serverResponse.getResponseType()));\n+            }\n+        }\n+        Page page = fillPage();\n+        completedPositions += currentDataTable.getDataTable().getNumberOfRows();\n+        if (byteBuffer != null) {\n+            byteBuffer.clear();\n+        }\n+        return page;\n+    }\n+\n+    private Iterator<ServerResponseWrapper> queryPinot(PinotSplit split)\n+    {\n+        String sql = split.getSegmentPql().orElseThrow(() -> new PinotException(PINOT_INVALID_PQL_GENERATED, Optional.empty(), \"Expected the segment split to contain the pql\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6cb486b66992b1b46c04c06b602ce996b0b5d71f"}, "originalPosition": 121}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwMTE3OA==", "bodyText": "PINOT_INVALID_PQL_GENERATED seems like a wrong enum here.", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r507001178", "createdAt": "2020-10-18T00:58:36Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSourceForGrpc.java", "diffHunk": "@@ -0,0 +1,142 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.pinot;\n+\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.pinot.grpc.Constants;\n+import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n+import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n+import com.facebook.presto.pinot.grpc.ServerResponseWrapper;\n+import com.facebook.presto.spi.ConnectorSession;\n+import org.apache.pinot.common.utils.DataTable;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_DATA_FETCH_EXCEPTION;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_INVALID_PQL_GENERATED;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_UNEXPECTED_RESPONSE;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * This class retrieves Pinot data from a Pinot client, and re-constructs the data into Presto Pages.\n+ */\n+\n+public class PinotSegmentPageSourceForGrpc\n+        extends PinotSegmentPageSource\n+{\n+    private final PinotStreamingQueryClient pinotStreamingQueryClient;\n+    private Iterator<ServerResponseWrapper> serverResponseIterator;\n+    private long completedPositions;\n+\n+    public PinotSegmentPageSourceForGrpc(\n+            ConnectorSession session,\n+            PinotConfig pinotConfig,\n+            PinotStreamingQueryClient pinotStreamingQueryClient,\n+            PinotSplit split,\n+            List<PinotColumnHandle> columnHandles)\n+    {\n+        super(session, pinotConfig, null, split, columnHandles);\n+        this.pinotStreamingQueryClient = requireNonNull(pinotStreamingQueryClient, \"pinotStreamingQueryClient is null\");\n+    }\n+\n+    @Override\n+    public boolean isFinished()\n+    {\n+        return closed;\n+    }\n+\n+    /**\n+     * @return constructed page for pinot data.\n+     */\n+    @Override\n+    public Page getNextPage()\n+    {\n+        if (isFinished()) {\n+            close();\n+            return null;\n+        }\n+        if (serverResponseIterator == null) {\n+            serverResponseIterator = queryPinot(split);\n+        }\n+        ByteBuffer byteBuffer = null;\n+        if (serverResponseIterator.hasNext()) {\n+            long startTimeNanos = System.nanoTime();\n+            ServerResponseWrapper serverResponse = serverResponseIterator.next();\n+            readTimeNanos += System.nanoTime() - startTimeNanos;\n+            switch (serverResponse.getResponseType()) {\n+                case Constants.Response.ResponseType.DATA:\n+                    estimatedMemoryUsageInBytes = serverResponse.getSerializedSize();\n+                    // Store each dataTable which will later be constructed into Pages.\n+                    try {\n+                        byteBuffer = serverResponse.getPayloadReadOnlyByteBuffer();\n+                        DataTable dataTable = serverResponse.getDataTable(byteBuffer);\n+                        checkExceptions(dataTable, split, PinotSessionProperties.isMarkDataFetchExceptionsAsRetriable(session));\n+                        currentDataTable = new PinotSegmentPageSource.PinotDataTableWithSize(dataTable, serverResponse.getSerializedSize());\n+                    }\n+                    catch (IOException e) {\n+                        throw new PinotException(\n+                            PINOT_DATA_FETCH_EXCEPTION,\n+                            split.getSegmentPql(),\n+                            String.format(\"Encountered Pinot exceptions when fetching data table from %s: %s\", split, e));\n+                    }\n+                    break;\n+                case Constants.Response.ResponseType.METADATA:\n+                    // The last part of the response is Metadata\n+                    currentDataTable = null;\n+                    serverResponseIterator = null;\n+                    close();\n+                    return null;\n+                default:\n+                    throw new PinotException(\n+                        PINOT_UNEXPECTED_RESPONSE,\n+                        split.getSegmentPql(),\n+                        String.format(\"Encountered Pinot exceptions, unknown response type - %s\", serverResponse.getResponseType()));\n+            }\n+        }\n+        Page page = fillPage();\n+        completedPositions += currentDataTable.getDataTable().getNumberOfRows();\n+        if (byteBuffer != null) {\n+            byteBuffer.clear();\n+        }\n+        return page;\n+    }\n+\n+    private Iterator<ServerResponseWrapper> queryPinot(PinotSplit split)\n+    {\n+        String sql = split.getSegmentPql().orElseThrow(() -> new PinotException(PINOT_INVALID_PQL_GENERATED, Optional.empty(), \"Expected the segment split to contain the pql\"));\n+        String host = split.getSegmentHost().orElseThrow(() -> new PinotException(PINOT_INVALID_PQL_GENERATED, Optional.empty(), \"Expected the segment split to contain the host\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6cb486b66992b1b46c04c06b602ce996b0b5d71f"}, "originalPosition": 122}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwMTM5Ng==", "bodyText": "I didn't follow this part: Does the host in the split now contain two hostnames ? The GRPC one and the regular one ? An example of the response returned by the server would be helpful in the code comments.\nCan this stuff be done by the split manager when creating the splits ? Ideally you want the splits to be very definitive about what behavior will happen at execution time.", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r507001396", "createdAt": "2020-10-18T01:01:35Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSourceForGrpc.java", "diffHunk": "@@ -0,0 +1,142 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.pinot;\n+\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.pinot.grpc.Constants;\n+import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n+import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n+import com.facebook.presto.pinot.grpc.ServerResponseWrapper;\n+import com.facebook.presto.spi.ConnectorSession;\n+import org.apache.pinot.common.utils.DataTable;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_DATA_FETCH_EXCEPTION;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_INVALID_PQL_GENERATED;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_UNEXPECTED_RESPONSE;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * This class retrieves Pinot data from a Pinot client, and re-constructs the data into Presto Pages.\n+ */\n+\n+public class PinotSegmentPageSourceForGrpc\n+        extends PinotSegmentPageSource\n+{\n+    private final PinotStreamingQueryClient pinotStreamingQueryClient;\n+    private Iterator<ServerResponseWrapper> serverResponseIterator;\n+    private long completedPositions;\n+\n+    public PinotSegmentPageSourceForGrpc(\n+            ConnectorSession session,\n+            PinotConfig pinotConfig,\n+            PinotStreamingQueryClient pinotStreamingQueryClient,\n+            PinotSplit split,\n+            List<PinotColumnHandle> columnHandles)\n+    {\n+        super(session, pinotConfig, null, split, columnHandles);\n+        this.pinotStreamingQueryClient = requireNonNull(pinotStreamingQueryClient, \"pinotStreamingQueryClient is null\");\n+    }\n+\n+    @Override\n+    public boolean isFinished()\n+    {\n+        return closed;\n+    }\n+\n+    /**\n+     * @return constructed page for pinot data.\n+     */\n+    @Override\n+    public Page getNextPage()\n+    {\n+        if (isFinished()) {\n+            close();\n+            return null;\n+        }\n+        if (serverResponseIterator == null) {\n+            serverResponseIterator = queryPinot(split);\n+        }\n+        ByteBuffer byteBuffer = null;\n+        if (serverResponseIterator.hasNext()) {\n+            long startTimeNanos = System.nanoTime();\n+            ServerResponseWrapper serverResponse = serverResponseIterator.next();\n+            readTimeNanos += System.nanoTime() - startTimeNanos;\n+            switch (serverResponse.getResponseType()) {\n+                case Constants.Response.ResponseType.DATA:\n+                    estimatedMemoryUsageInBytes = serverResponse.getSerializedSize();\n+                    // Store each dataTable which will later be constructed into Pages.\n+                    try {\n+                        byteBuffer = serverResponse.getPayloadReadOnlyByteBuffer();\n+                        DataTable dataTable = serverResponse.getDataTable(byteBuffer);\n+                        checkExceptions(dataTable, split, PinotSessionProperties.isMarkDataFetchExceptionsAsRetriable(session));\n+                        currentDataTable = new PinotSegmentPageSource.PinotDataTableWithSize(dataTable, serverResponse.getSerializedSize());\n+                    }\n+                    catch (IOException e) {\n+                        throw new PinotException(\n+                            PINOT_DATA_FETCH_EXCEPTION,\n+                            split.getSegmentPql(),\n+                            String.format(\"Encountered Pinot exceptions when fetching data table from %s: %s\", split, e));\n+                    }\n+                    break;\n+                case Constants.Response.ResponseType.METADATA:\n+                    // The last part of the response is Metadata\n+                    currentDataTable = null;\n+                    serverResponseIterator = null;\n+                    close();\n+                    return null;\n+                default:\n+                    throw new PinotException(\n+                        PINOT_UNEXPECTED_RESPONSE,\n+                        split.getSegmentPql(),\n+                        String.format(\"Encountered Pinot exceptions, unknown response type - %s\", serverResponse.getResponseType()));\n+            }\n+        }\n+        Page page = fillPage();\n+        completedPositions += currentDataTable.getDataTable().getNumberOfRows();\n+        if (byteBuffer != null) {\n+            byteBuffer.clear();\n+        }\n+        return page;\n+    }\n+\n+    private Iterator<ServerResponseWrapper> queryPinot(PinotSplit split)\n+    {\n+        String sql = split.getSegmentPql().orElseThrow(() -> new PinotException(PINOT_INVALID_PQL_GENERATED, Optional.empty(), \"Expected the segment split to contain the pql\"));\n+        String host = split.getSegmentHost().orElseThrow(() -> new PinotException(PINOT_INVALID_PQL_GENERATED, Optional.empty(), \"Expected the segment split to contain the host\"));\n+        String[] hostSplits = host.split(\"_\");\n+        String grpcHost = (hostSplits.length > 1) ? hostSplits[hostSplits.length - 2] : host;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6cb486b66992b1b46c04c06b602ce996b0b5d71f"}, "originalPosition": 124}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwMTUyOA==", "bodyText": "Same comment as in PinogSegmentPageSourceForGrpc below", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r507001528", "createdAt": "2020-10-18T01:03:50Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java", "diffHunk": "@@ -486,4 +496,101 @@ public TimeBoundary getTimeBoundaryForTable(String table)\n             throw e;\n         }\n     }\n+\n+    public static class Instance\n+    {\n+        private final String instanceName;\n+        private final String hostName;\n+        private final boolean enabled;\n+        private final int port;\n+        private final int grpcPort;\n+        private final List<String> tags;\n+        private final List<String> pools;\n+\n+        @JsonCreator\n+        public Instance(\n+                @JsonProperty String instanceName,\n+                @JsonProperty String hostName,\n+                @JsonProperty boolean enabled,\n+                @JsonProperty int port,\n+                @JsonProperty int grpcPort,\n+                @JsonProperty List<String> tags,\n+                @JsonProperty List<String> pools)\n+        {\n+            this.instanceName = instanceName;\n+            this.hostName = hostName;\n+            this.enabled = enabled;\n+            this.port = port;\n+            this.grpcPort = grpcPort;\n+            this.tags = tags;\n+            this.pools = pools;\n+        }\n+\n+        public String getInstanceName()\n+        {\n+            return instanceName;\n+        }\n+\n+        public String getHostName()\n+        {\n+            return hostName;\n+        }\n+\n+        public boolean isEnabled()\n+        {\n+            return enabled;\n+        }\n+\n+        public int getPort()\n+        {\n+            return port;\n+        }\n+\n+        public int getGrpcPort()\n+        {\n+            return grpcPort;\n+        }\n+\n+        public List<String> getTags()\n+        {\n+            return tags;\n+        }\n+\n+        public List<String> getPools()\n+        {\n+            return pools;\n+        }\n+    }\n+\n+    public Instance getInstance(String instanceName)\n+    {\n+        try {\n+            String responseBody = sendHttpGetToController(String.format(INSTANCE_API_TEMPLATE, instanceName));\n+            return instanceJsonCodec.fromJson(responseBody);\n+        }\n+        catch (Exception throwable) {\n+            throw new PinotException(PINOT_UNABLE_TO_FIND_INSTANCE, Optional.empty(), \"Error when fetching instance configs for \" + instanceName, throwable);\n+        }\n+    }\n+\n+    public int getGrpcPort(String serverInstance)\n+    {\n+        try {\n+            int grpcPort = instanceConfigCache.get(serverInstance).getGrpcPort();\n+            if (grpcPort <= 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6cb486b66992b1b46c04c06b602ce996b0b5d71f"}, "originalPosition": 165}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwMTYyMw==", "bodyText": "nit: Change throwable to cause", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r507001623", "createdAt": "2020-10-18T01:05:07Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java", "diffHunk": "@@ -486,4 +496,101 @@ public TimeBoundary getTimeBoundaryForTable(String table)\n             throw e;\n         }\n     }\n+\n+    public static class Instance\n+    {\n+        private final String instanceName;\n+        private final String hostName;\n+        private final boolean enabled;\n+        private final int port;\n+        private final int grpcPort;\n+        private final List<String> tags;\n+        private final List<String> pools;\n+\n+        @JsonCreator\n+        public Instance(\n+                @JsonProperty String instanceName,\n+                @JsonProperty String hostName,\n+                @JsonProperty boolean enabled,\n+                @JsonProperty int port,\n+                @JsonProperty int grpcPort,\n+                @JsonProperty List<String> tags,\n+                @JsonProperty List<String> pools)\n+        {\n+            this.instanceName = instanceName;\n+            this.hostName = hostName;\n+            this.enabled = enabled;\n+            this.port = port;\n+            this.grpcPort = grpcPort;\n+            this.tags = tags;\n+            this.pools = pools;\n+        }\n+\n+        public String getInstanceName()\n+        {\n+            return instanceName;\n+        }\n+\n+        public String getHostName()\n+        {\n+            return hostName;\n+        }\n+\n+        public boolean isEnabled()\n+        {\n+            return enabled;\n+        }\n+\n+        public int getPort()\n+        {\n+            return port;\n+        }\n+\n+        public int getGrpcPort()\n+        {\n+            return grpcPort;\n+        }\n+\n+        public List<String> getTags()\n+        {\n+            return tags;\n+        }\n+\n+        public List<String> getPools()\n+        {\n+            return pools;\n+        }\n+    }\n+\n+    public Instance getInstance(String instanceName)\n+    {\n+        try {\n+            String responseBody = sendHttpGetToController(String.format(INSTANCE_API_TEMPLATE, instanceName));\n+            return instanceJsonCodec.fromJson(responseBody);\n+        }\n+        catch (Exception throwable) {\n+            throw new PinotException(PINOT_UNABLE_TO_FIND_INSTANCE, Optional.empty(), \"Error when fetching instance configs for \" + instanceName, throwable);\n+        }\n+    }\n+\n+    public int getGrpcPort(String serverInstance)\n+    {\n+        try {\n+            int grpcPort = instanceConfigCache.get(serverInstance).getGrpcPort();\n+            if (grpcPort <= 0) {\n+                grpcPort = pinotConfig.getServerGrpcPort();\n+            }\n+            return grpcPort;\n+        }\n+        catch (ExecutionException e) {\n+            Throwable throwable = e.getCause();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6cb486b66992b1b46c04c06b602ce996b0b5d71f"}, "originalPosition": 171}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwMTk4Mw==", "bodyText": "If I am reading this line correctly, it means that we will always be using the GRPC mode if the server supports it. Is that intentional ? If so, what does the PinotConfig.isUseStreamingForSegmentQueries imply ?\nPerhaps don't provide the GRPC port if !isUseStreamingForSegmentQueries ?", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r507001983", "createdAt": "2020-10-18T01:10:18Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSplitManager.java", "diffHunk": "@@ -123,11 +123,16 @@ protected void generateSegmentSplits(\n                 // segments is already shuffled\n                 Iterables.partition(segments, numSegmentsInThisSplit).forEach(\n                         segmentsForThisSplit -> splits.add(\n-                                createSegmentSplit(connectorId, pql, expectedColumnHandles, segmentsForThisSplit, host)));\n+                                createSegmentSplit(connectorId, pql, expectedColumnHandles, segmentsForThisSplit, host, getGrpcPort(host))));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6cb486b66992b1b46c04c06b602ce996b0b5d71f"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6cb486b66992b1b46c04c06b602ce996b0b5d71f", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/6cb486b66992b1b46c04c06b602ce996b0b5d71f", "committedDate": "2020-10-16T06:48:17Z", "message": "Support Pinot Streaming connector for Segment query"}, "afterCommit": {"oid": "1478bd635b9f974e46b2031f1378a132a3e50d6e", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/1478bd635b9f974e46b2031f1378a132a3e50d6e", "committedDate": "2020-10-21T00:39:11Z", "message": "Support Pinot Streaming connector for Segment query"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1478bd635b9f974e46b2031f1378a132a3e50d6e", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/1478bd635b9f974e46b2031f1378a132a3e50d6e", "committedDate": "2020-10-21T00:39:11Z", "message": "Support Pinot Streaming connector for Segment query"}, "afterCommit": {"oid": "fb8bb690e7246b33c675e51b27aebfd2a9e3cd2b", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/fb8bb690e7246b33c675e51b27aebfd2a9e3cd2b", "committedDate": "2020-10-21T01:17:20Z", "message": "Support Pinot Streaming connector for Segment query"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fb8bb690e7246b33c675e51b27aebfd2a9e3cd2b", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/fb8bb690e7246b33c675e51b27aebfd2a9e3cd2b", "committedDate": "2020-10-21T01:17:20Z", "message": "Support Pinot Streaming connector for Segment query"}, "afterCommit": {"oid": "e3790b42bed22467c5646f9f6b57e27fb6de028e", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/e3790b42bed22467c5646f9f6b57e27fb6de028e", "committedDate": "2020-10-21T05:33:50Z", "message": "Support Pinot Streaming connector for Segment query"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e3790b42bed22467c5646f9f6b57e27fb6de028e", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/e3790b42bed22467c5646f9f6b57e27fb6de028e", "committedDate": "2020-10-21T05:33:50Z", "message": "Support Pinot Streaming connector for Segment query"}, "afterCommit": {"oid": "7114de3793f7870777de068d4aba36b99fdb7810", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/7114de3793f7870777de068d4aba36b99fdb7810", "committedDate": "2020-10-22T21:53:10Z", "message": "Support Pinot Streaming connector for Segment query"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MTY2NzQ2", "url": "https://github.com/prestodb/presto/pull/15319#pullrequestreview-515166746", "createdAt": "2020-10-22T22:35:34Z", "commit": {"oid": "7114de3793f7870777de068d4aba36b99fdb7810"}, "state": "COMMENTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMjozNTozNFrOHm2OHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMjo1MDo0MlrOHm2hqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ5NjI4Ng==", "bodyText": "Just curious about if there are any automated tests around ensuring what all do we need to exclude ? Like would anything fail if we exclude less or more ?", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r510496286", "createdAt": "2020-10-22T22:35:34Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/pom.xml", "diffHunk": "@@ -22,6 +22,60 @@\n         <dependency>\n             <groupId>com.facebook.presto.pinot</groupId>\n             <artifactId>pinot-driver</artifactId>\n+            <exclusions>\n+                <exclusion>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7114de3793f7870777de068d4aba36b99fdb7810"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ5NjM0Ng==", "bodyText": "Lacks newline at end.", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r510496346", "createdAt": "2020-10-22T22:35:43Z", "author": {"login": "agrawaldevesh"}, "path": "presto-main/etc/catalog/pinot.properties", "diffHunk": "@@ -2,3 +2,4 @@ connector.name=pinot\n \n # Pinot controller endpoint\n pinot.controller-urls=localhost:9000\n+pinot.use-streaming-for-segment-queries=true", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7114de3793f7870777de068d4aba36b99fdb7810"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ5NjgxMQ==", "bodyText": "Hmm. Why ? At the very least, I would expect to be making one call per server to get that server's GRPC port. Why is it per split ? I see that the cache is working in lieu of a batched API at the controller.", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r510496811", "createdAt": "2020-10-22T22:37:11Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java", "diffHunk": "@@ -110,6 +116,9 @@ public PinotClusterInfoFetcher(\n         this.brokersForTableCache = CacheBuilder.newBuilder()\n                 .expireAfterWrite(cacheExpiryMs, TimeUnit.MILLISECONDS)\n                 .build((CacheLoader.from(this::getAllBrokersForTable)));\n+        this.instanceConfigCache = CacheBuilder.newBuilder()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk5ODk2NQ=="}, "originalCommit": {"oid": "6cb486b66992b1b46c04c06b602ce996b0b5d71f"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ5NzQ3Nw==", "bodyText": "Can you push this logic of choosing the global rpc port to when the instance config cache is populated ? Either the controller provides you the rpc port, or you choose the global one. I feel it belongs better at \"population\" time than at \"read time\".", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r510497477", "createdAt": "2020-10-22T22:39:15Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java", "diffHunk": "@@ -486,4 +496,101 @@ public TimeBoundary getTimeBoundaryForTable(String table)\n             throw e;\n         }\n     }\n+\n+    public static class Instance\n+    {\n+        private final String instanceName;\n+        private final String hostName;\n+        private final boolean enabled;\n+        private final int port;\n+        private final int grpcPort;\n+        private final List<String> tags;\n+        private final List<String> pools;\n+\n+        @JsonCreator\n+        public Instance(\n+                @JsonProperty String instanceName,\n+                @JsonProperty String hostName,\n+                @JsonProperty boolean enabled,\n+                @JsonProperty int port,\n+                @JsonProperty int grpcPort,\n+                @JsonProperty List<String> tags,\n+                @JsonProperty List<String> pools)\n+        {\n+            this.instanceName = instanceName;\n+            this.hostName = hostName;\n+            this.enabled = enabled;\n+            this.port = port;\n+            this.grpcPort = grpcPort;\n+            this.tags = tags;\n+            this.pools = pools;\n+        }\n+\n+        public String getInstanceName()\n+        {\n+            return instanceName;\n+        }\n+\n+        public String getHostName()\n+        {\n+            return hostName;\n+        }\n+\n+        public boolean isEnabled()\n+        {\n+            return enabled;\n+        }\n+\n+        public int getPort()\n+        {\n+            return port;\n+        }\n+\n+        public int getGrpcPort()\n+        {\n+            return grpcPort;\n+        }\n+\n+        public List<String> getTags()\n+        {\n+            return tags;\n+        }\n+\n+        public List<String> getPools()\n+        {\n+            return pools;\n+        }\n+    }\n+\n+    public Instance getInstance(String instanceName)\n+    {\n+        try {\n+            String responseBody = sendHttpGetToController(String.format(INSTANCE_API_TEMPLATE, instanceName));\n+            return instanceJsonCodec.fromJson(responseBody);\n+        }\n+        catch (Exception throwable) {\n+            throw new PinotException(PINOT_UNABLE_TO_FIND_INSTANCE, Optional.empty(), \"Error when fetching instance configs for \" + instanceName, throwable);\n+        }\n+    }\n+\n+    public int getGrpcPort(String serverInstance)\n+    {\n+        try {\n+            int grpcPort = instanceConfigCache.get(serverInstance).getGrpcPort();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7114de3793f7870777de068d4aba36b99fdb7810"}, "originalPosition": 164}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ5ODE4MA==", "bodyText": "Please add a comment here, that this is only used as a fallback if the controller does not provide a per server grpc port (if a pinot version older than XX) is running.\nAlso, should the default be something like -1 ... to denote that an RPC port fall back is not set ? I think 8090 encodes some pinot information here that ideally belongs in some config file.", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r510498180", "createdAt": "2020-10-22T22:41:22Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotConfig.java", "diffHunk": "@@ -86,6 +87,11 @@\n \n     // Requires Pinot version >= 0.4.0.\n     private boolean usePinotSqlForBrokerQueries = true;\n+    // Requires Pinot version >= 0.5.0.\n+    private boolean useStreamingForSegmentQueries;\n+    private boolean usePlainTextForStreamingServer = true;\n+    private int serverGrpcPort = 8090;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7114de3793f7870777de068d4aba36b99fdb7810"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ5ODg2Nw==", "bodyText": "converted into pages ?\nor deconstructed into pages ?", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r510498867", "createdAt": "2020-10-22T22:43:35Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.pinot;\n+\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.pinot.grpc.Constants;\n+import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n+import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n+import com.facebook.presto.pinot.grpc.ServerResponse;\n+import com.facebook.presto.spi.ConnectorSession;\n+import org.apache.pinot.common.utils.DataTable;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_DATA_FETCH_EXCEPTION;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_INVALID_SEGMENT_QUERY_GENERATED;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_UNEXPECTED_RESPONSE;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * This class retrieves Pinot data from a Pinot client, and re-constructs the data into Presto Pages.\n+ */\n+\n+public class PinotSegmentStreamingPageSource\n+        extends PinotSegmentPageSource\n+{\n+    private final PinotStreamingQueryClient pinotStreamingQueryClient;\n+    private Iterator<ServerResponse> serverResponseIterator;\n+    private long completedPositions;\n+\n+    public PinotSegmentStreamingPageSource(\n+            ConnectorSession session,\n+            PinotConfig pinotConfig,\n+            PinotStreamingQueryClient pinotStreamingQueryClient,\n+            PinotSplit split,\n+            List<PinotColumnHandle> columnHandles)\n+    {\n+        super(session, pinotConfig, null, split, columnHandles);\n+        this.pinotStreamingQueryClient = requireNonNull(pinotStreamingQueryClient, \"pinotStreamingQueryClient is null\");\n+    }\n+\n+    @Override\n+    public boolean isFinished()\n+    {\n+        return closed;\n+    }\n+\n+    /**\n+     * @return constructed page for pinot data.\n+     */\n+    @Override\n+    public Page getNextPage()\n+    {\n+        if (closed) {\n+            return null;\n+        }\n+        if (serverResponseIterator == null) {\n+            serverResponseIterator = queryPinot(split);\n+        }\n+        ByteBuffer byteBuffer = null;\n+        if (serverResponseIterator.hasNext()) {\n+            long startTimeNanos = System.nanoTime();\n+            ServerResponse serverResponse = serverResponseIterator.next();\n+            readTimeNanos += System.nanoTime() - startTimeNanos;\n+            switch (serverResponse.getResponseType()) {\n+                case Constants.Response.ResponseType.DATA:\n+                    estimatedMemoryUsageInBytes = serverResponse.getSerializedSize();\n+                    // Store each dataTable which will later be constructed into Pages.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7114de3793f7870777de068d4aba36b99fdb7810"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ5OTEzNw==", "bodyText": "Can you add a small comment here that we expect to see a sequence of Data followed by Metadata ?", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r510499137", "createdAt": "2020-10-22T22:44:26Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.pinot;\n+\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.pinot.grpc.Constants;\n+import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n+import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n+import com.facebook.presto.pinot.grpc.ServerResponse;\n+import com.facebook.presto.spi.ConnectorSession;\n+import org.apache.pinot.common.utils.DataTable;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_DATA_FETCH_EXCEPTION;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_INVALID_SEGMENT_QUERY_GENERATED;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_UNEXPECTED_RESPONSE;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * This class retrieves Pinot data from a Pinot client, and re-constructs the data into Presto Pages.\n+ */\n+\n+public class PinotSegmentStreamingPageSource\n+        extends PinotSegmentPageSource\n+{\n+    private final PinotStreamingQueryClient pinotStreamingQueryClient;\n+    private Iterator<ServerResponse> serverResponseIterator;\n+    private long completedPositions;\n+\n+    public PinotSegmentStreamingPageSource(\n+            ConnectorSession session,\n+            PinotConfig pinotConfig,\n+            PinotStreamingQueryClient pinotStreamingQueryClient,\n+            PinotSplit split,\n+            List<PinotColumnHandle> columnHandles)\n+    {\n+        super(session, pinotConfig, null, split, columnHandles);\n+        this.pinotStreamingQueryClient = requireNonNull(pinotStreamingQueryClient, \"pinotStreamingQueryClient is null\");\n+    }\n+\n+    @Override\n+    public boolean isFinished()\n+    {\n+        return closed;\n+    }\n+\n+    /**\n+     * @return constructed page for pinot data.\n+     */\n+    @Override\n+    public Page getNextPage()\n+    {\n+        if (closed) {\n+            return null;\n+        }\n+        if (serverResponseIterator == null) {\n+            serverResponseIterator = queryPinot(split);\n+        }\n+        ByteBuffer byteBuffer = null;\n+        if (serverResponseIterator.hasNext()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7114de3793f7870777de068d4aba36b99fdb7810"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ5OTc1NA==", "bodyText": "Will anything be leaked if we throw here ? I am not sure if the byte buffer is native or on heap ? Should we free the byteBuffer after this loop using a try-finally ?", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r510499754", "createdAt": "2020-10-22T22:46:17Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.pinot;\n+\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.pinot.grpc.Constants;\n+import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n+import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n+import com.facebook.presto.pinot.grpc.ServerResponse;\n+import com.facebook.presto.spi.ConnectorSession;\n+import org.apache.pinot.common.utils.DataTable;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_DATA_FETCH_EXCEPTION;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_INVALID_SEGMENT_QUERY_GENERATED;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_UNEXPECTED_RESPONSE;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * This class retrieves Pinot data from a Pinot client, and re-constructs the data into Presto Pages.\n+ */\n+\n+public class PinotSegmentStreamingPageSource\n+        extends PinotSegmentPageSource\n+{\n+    private final PinotStreamingQueryClient pinotStreamingQueryClient;\n+    private Iterator<ServerResponse> serverResponseIterator;\n+    private long completedPositions;\n+\n+    public PinotSegmentStreamingPageSource(\n+            ConnectorSession session,\n+            PinotConfig pinotConfig,\n+            PinotStreamingQueryClient pinotStreamingQueryClient,\n+            PinotSplit split,\n+            List<PinotColumnHandle> columnHandles)\n+    {\n+        super(session, pinotConfig, null, split, columnHandles);\n+        this.pinotStreamingQueryClient = requireNonNull(pinotStreamingQueryClient, \"pinotStreamingQueryClient is null\");\n+    }\n+\n+    @Override\n+    public boolean isFinished()\n+    {\n+        return closed;\n+    }\n+\n+    /**\n+     * @return constructed page for pinot data.\n+     */\n+    @Override\n+    public Page getNextPage()\n+    {\n+        if (closed) {\n+            return null;\n+        }\n+        if (serverResponseIterator == null) {\n+            serverResponseIterator = queryPinot(split);\n+        }\n+        ByteBuffer byteBuffer = null;\n+        if (serverResponseIterator.hasNext()) {\n+            long startTimeNanos = System.nanoTime();\n+            ServerResponse serverResponse = serverResponseIterator.next();\n+            readTimeNanos += System.nanoTime() - startTimeNanos;\n+            switch (serverResponse.getResponseType()) {\n+                case Constants.Response.ResponseType.DATA:\n+                    estimatedMemoryUsageInBytes = serverResponse.getSerializedSize();\n+                    // Store each dataTable which will later be constructed into Pages.\n+                    try {\n+                        byteBuffer = serverResponse.getPayloadReadOnlyByteBuffer();\n+                        DataTable dataTable = serverResponse.getDataTable(byteBuffer);\n+                        checkExceptions(dataTable, split, PinotSessionProperties.isMarkDataFetchExceptionsAsRetriable(session));\n+                        currentDataTable = new PinotSegmentPageSource.PinotDataTableWithSize(dataTable, serverResponse.getSerializedSize());\n+                    }\n+                    catch (IOException e) {\n+                        throw new PinotException(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7114de3793f7870777de068d4aba36b99fdb7810"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ5OTk5Ng==", "bodyText": "Is getGrpcPort guaranteed to be valid ... > 0 ?", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r510499996", "createdAt": "2020-10-22T22:47:01Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.pinot;\n+\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.pinot.grpc.Constants;\n+import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n+import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n+import com.facebook.presto.pinot.grpc.ServerResponse;\n+import com.facebook.presto.spi.ConnectorSession;\n+import org.apache.pinot.common.utils.DataTable;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_DATA_FETCH_EXCEPTION;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_INVALID_SEGMENT_QUERY_GENERATED;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_UNEXPECTED_RESPONSE;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * This class retrieves Pinot data from a Pinot client, and re-constructs the data into Presto Pages.\n+ */\n+\n+public class PinotSegmentStreamingPageSource\n+        extends PinotSegmentPageSource\n+{\n+    private final PinotStreamingQueryClient pinotStreamingQueryClient;\n+    private Iterator<ServerResponse> serverResponseIterator;\n+    private long completedPositions;\n+\n+    public PinotSegmentStreamingPageSource(\n+            ConnectorSession session,\n+            PinotConfig pinotConfig,\n+            PinotStreamingQueryClient pinotStreamingQueryClient,\n+            PinotSplit split,\n+            List<PinotColumnHandle> columnHandles)\n+    {\n+        super(session, pinotConfig, null, split, columnHandles);\n+        this.pinotStreamingQueryClient = requireNonNull(pinotStreamingQueryClient, \"pinotStreamingQueryClient is null\");\n+    }\n+\n+    @Override\n+    public boolean isFinished()\n+    {\n+        return closed;\n+    }\n+\n+    /**\n+     * @return constructed page for pinot data.\n+     */\n+    @Override\n+    public Page getNextPage()\n+    {\n+        if (closed) {\n+            return null;\n+        }\n+        if (serverResponseIterator == null) {\n+            serverResponseIterator = queryPinot(split);\n+        }\n+        ByteBuffer byteBuffer = null;\n+        if (serverResponseIterator.hasNext()) {\n+            long startTimeNanos = System.nanoTime();\n+            ServerResponse serverResponse = serverResponseIterator.next();\n+            readTimeNanos += System.nanoTime() - startTimeNanos;\n+            switch (serverResponse.getResponseType()) {\n+                case Constants.Response.ResponseType.DATA:\n+                    estimatedMemoryUsageInBytes = serverResponse.getSerializedSize();\n+                    // Store each dataTable which will later be constructed into Pages.\n+                    try {\n+                        byteBuffer = serverResponse.getPayloadReadOnlyByteBuffer();\n+                        DataTable dataTable = serverResponse.getDataTable(byteBuffer);\n+                        checkExceptions(dataTable, split, PinotSessionProperties.isMarkDataFetchExceptionsAsRetriable(session));\n+                        currentDataTable = new PinotSegmentPageSource.PinotDataTableWithSize(dataTable, serverResponse.getSerializedSize());\n+                    }\n+                    catch (IOException e) {\n+                        throw new PinotException(\n+                            PINOT_DATA_FETCH_EXCEPTION,\n+                            split.getSegmentPinotQuery(),\n+                            String.format(\"Encountered Pinot exceptions when fetching data table from Split: < %s >\", split), e);\n+                    }\n+                    break;\n+                case Constants.Response.ResponseType.METADATA:\n+                    // The last part of the response is Metadata\n+                    currentDataTable = null;\n+                    serverResponseIterator = null;\n+                    close();\n+                    return null;\n+                default:\n+                    throw new PinotException(\n+                        PINOT_UNEXPECTED_RESPONSE,\n+                        split.getSegmentPinotQuery(),\n+                        String.format(\"Encountered Pinot exceptions, unknown response type - %s\", serverResponse.getResponseType()));\n+            }\n+        }\n+        Page page = fillNextPage();\n+        completedPositions += currentDataTable.getDataTable().getNumberOfRows();\n+        if (byteBuffer != null) {\n+            byteBuffer.clear();\n+        }\n+        return page;\n+    }\n+\n+    private Iterator<ServerResponse> queryPinot(PinotSplit split)\n+    {\n+        String sql = split.getSegmentPinotQuery().orElseThrow(() -> new PinotException(PINOT_INVALID_SEGMENT_QUERY_GENERATED, Optional.empty(), \"Expected the segment split to contain the pinot query\"));\n+        String grpcHost = split.getGrpcHost().orElseThrow(() -> new PinotException(PINOT_INVALID_SEGMENT_QUERY_GENERATED, Optional.empty(), \"Expected the segment split to contain the grpc host\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7114de3793f7870777de068d4aba36b99fdb7810"}, "originalPosition": 121}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUwMDg3Mw==", "bodyText": "Can you add a comment explaining this logic here. Should the GRPC host be saved as an immutable field in the split, instead of recomputing here ?\nCan you use Optional.map instead of the if condition below ...", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r510500873", "createdAt": "2020-10-22T22:49:30Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSplit.java", "diffHunk": "@@ -133,14 +138,29 @@ public SplitType getSplitType()\n         return segments;\n     }\n \n+    public Optional<String> getGrpcHost()\n+    {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7114de3793f7870777de068d4aba36b99fdb7810"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUwMTI5MQ==", "bodyText": "Got it.\nI think we should initialize the global GPRC port to be -1 then ... just to make sure we don't by mistake talk to port 8090 even when PinotConfig.isUseStreamingForSegmentQueries = false", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r510501291", "createdAt": "2020-10-22T22:50:42Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSplitManager.java", "diffHunk": "@@ -123,11 +123,16 @@ protected void generateSegmentSplits(\n                 // segments is already shuffled\n                 Iterables.partition(segments, numSegmentsInThisSplit).forEach(\n                         segmentsForThisSplit -> splits.add(\n-                                createSegmentSplit(connectorId, pql, expectedColumnHandles, segmentsForThisSplit, host)));\n+                                createSegmentSplit(connectorId, pql, expectedColumnHandles, segmentsForThisSplit, host, getGrpcPort(host))));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwMTk4Mw=="}, "originalCommit": {"oid": "6cb486b66992b1b46c04c06b602ce996b0b5d71f"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7114de3793f7870777de068d4aba36b99fdb7810", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/7114de3793f7870777de068d4aba36b99fdb7810", "committedDate": "2020-10-22T21:53:10Z", "message": "Support Pinot Streaming connector for Segment query"}, "afterCommit": {"oid": "73c38b078b56dca67081fbb4b00950859ca0d30f", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/73c38b078b56dca67081fbb4b00950859ca0d30f", "committedDate": "2020-10-23T23:43:59Z", "message": "Support Pinot Streaming connector for Segment query"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "73c38b078b56dca67081fbb4b00950859ca0d30f", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/73c38b078b56dca67081fbb4b00950859ca0d30f", "committedDate": "2020-10-23T23:43:59Z", "message": "Support Pinot Streaming connector for Segment query"}, "afterCommit": {"oid": "3b4198abd41b16dfea38c8199ec23d313102031d", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/3b4198abd41b16dfea38c8199ec23d313102031d", "committedDate": "2020-10-24T03:24:55Z", "message": "Support Pinot Streaming connector for Segment query"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2MTU5NzYx", "url": "https://github.com/prestodb/presto/pull/15319#pullrequestreview-516159761", "createdAt": "2020-10-24T05:03:11Z", "commit": {"oid": "3b4198abd41b16dfea38c8199ec23d313102031d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNFQwNTowMzoxMlrOHnojpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNFQwNTowMzoxMlrOHnojpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTMyMDk5Nw==", "bodyText": "Should we add a comment here that this would only work with versions of Pinot more than X ?", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r511320997", "createdAt": "2020-10-24T05:03:12Z", "author": {"login": "agrawaldevesh"}, "path": "presto-main/etc/catalog/pinot.properties", "diffHunk": "@@ -2,3 +2,4 @@ connector.name=pinot\n \n # Pinot controller endpoint\n pinot.controller-urls=localhost:9000\n+pinot.use-streaming-for-segment-queries=true", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3b4198abd41b16dfea38c8199ec23d313102031d"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3b4198abd41b16dfea38c8199ec23d313102031d", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/3b4198abd41b16dfea38c8199ec23d313102031d", "committedDate": "2020-10-24T03:24:55Z", "message": "Support Pinot Streaming connector for Segment query"}, "afterCommit": {"oid": "ab821abc728c11cb3ebbb8128f25750a73bd4017", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/ab821abc728c11cb3ebbb8128f25750a73bd4017", "committedDate": "2020-10-24T05:08:50Z", "message": "Support Pinot Streaming connector for Segment query"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2MTU5OTIx", "url": "https://github.com/prestodb/presto/pull/15319#pullrequestreview-516159921", "createdAt": "2020-10-24T05:06:18Z", "commit": {"oid": "3b4198abd41b16dfea38c8199ec23d313102031d"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNFQwNTowNjoxOFrOHnoknQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNFQwNToxNTowNlrOHnonlg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTMyMTI0NQ==", "bodyText": "When will this exception be hit ? My understanding is that when the controller does not have the per instance grpc port, it will simply return -1 for that and we will go through the regular if condition on line 119. I don't know whether we should fall back in case of an exception. Are you thinking of cases like where the controller is down or such ?\nCan we catch a more specific exception ?", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r511321245", "createdAt": "2020-10-24T05:06:18Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotConnection.java", "diffHunk": "@@ -110,4 +110,19 @@ public TimeBoundary getTimeBoundary(String tableName)\n     {\n         return pinotClusterInfoFetcher.getTimeBoundaryForTable(tableName);\n     }\n+\n+    public int getGrpcPort(String serverInstance)\n+    {\n+        int grpcPort;\n+        try {\n+            grpcPort = pinotClusterInfoFetcher.getGrpcPort(serverInstance);\n+            if (grpcPort <= 0) {\n+                grpcPort = pinotConfig.getServerGrpcPort();\n+            }\n+        }\n+        catch (Exception e) {\n+            grpcPort = pinotConfig.getServerGrpcPort();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3b4198abd41b16dfea38c8199ec23d313102031d"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTMyMTMzNw==", "bodyText": "nit: pinotSplit.getGrpcPort().orElse(-1) > 0", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r511321337", "createdAt": "2020-10-24T05:07:26Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPageSourceProvider.java", "diffHunk": "@@ -81,12 +86,24 @@ public ConnectorPageSource createPageSource(\n \n         switch (pinotSplit.getSplitType()) {\n             case SEGMENT:\n-                return new PinotSegmentPageSource(\n+                if (this.pinotConfig.isUseStreamingForSegmentQueries() &&\n+                        pinotSplit.getGrpcPort().isPresent() &&\n+                        pinotSplit.getGrpcPort().get() > 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3b4198abd41b16dfea38c8199ec23d313102031d"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTMyMTQ4OA==", "bodyText": "nit: What's a truck ?", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r511321488", "createdAt": "2020-10-24T05:09:31Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java", "diffHunk": "@@ -0,0 +1,143 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.pinot;\n+\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.pinot.grpc.Constants;\n+import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n+import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n+import com.facebook.presto.pinot.grpc.ServerResponse;\n+import com.facebook.presto.spi.ConnectorSession;\n+import org.apache.pinot.common.utils.DataTable;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_DATA_FETCH_EXCEPTION;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_INVALID_SEGMENT_QUERY_GENERATED;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_UNEXPECTED_RESPONSE;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * This class retrieves Pinot data from a Pinot client, and re-constructs the data into Presto Pages.\n+ */\n+\n+public class PinotSegmentStreamingPageSource\n+        extends PinotSegmentPageSource\n+{\n+    private final PinotStreamingQueryClient pinotStreamingQueryClient;\n+    private Iterator<ServerResponse> serverResponseIterator;\n+    private long completedPositions;\n+\n+    public PinotSegmentStreamingPageSource(\n+            ConnectorSession session,\n+            PinotConfig pinotConfig,\n+            PinotStreamingQueryClient pinotStreamingQueryClient,\n+            PinotSplit split,\n+            List<PinotColumnHandle> columnHandles)\n+    {\n+        super(session, pinotConfig, null, split, columnHandles);\n+        this.pinotStreamingQueryClient = requireNonNull(pinotStreamingQueryClient, \"pinotStreamingQueryClient is null\");\n+    }\n+\n+    @Override\n+    public boolean isFinished()\n+    {\n+        return closed;\n+    }\n+\n+    /**\n+     * @return constructed page for pinot data.\n+     */\n+    @Override\n+    public Page getNextPage()\n+    {\n+        if (closed) {\n+            return null;\n+        }\n+        if (serverResponseIterator == null) {\n+            serverResponseIterator = queryPinot(split);\n+        }\n+        ByteBuffer byteBuffer = null;\n+        try {\n+            // Pinot gRPC server response iterator returns:\n+            //   - n data trucks;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab821abc728c11cb3ebbb8128f25750a73bd4017"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTMyMTc0Ng==", "bodyText": "nit: More descriptive name than i", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r511321746", "createdAt": "2020-10-24T05:12:29Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/TestPinotStreamingSegmentPageSource.java", "diffHunk": "@@ -0,0 +1,229 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.pinot;\n+\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.common.block.Block;\n+import com.facebook.presto.common.block.VariableWidthBlock;\n+import com.facebook.presto.common.type.ArrayType;\n+import com.facebook.presto.common.type.IntegerType;\n+import com.facebook.presto.common.type.Type;\n+import com.facebook.presto.common.type.VariableWidthType;\n+import com.facebook.presto.pinot.grpc.Constants;\n+import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n+import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n+import com.facebook.presto.pinot.grpc.ServerResponse;\n+import com.facebook.presto.spi.ConnectorSession;\n+import com.facebook.presto.testing.TestingConnectorSession;\n+import com.facebook.presto.testing.assertions.Assert;\n+import com.google.common.collect.ImmutableList;\n+import org.apache.pinot.common.proto.Server;\n+import org.apache.pinot.common.utils.DataSchema;\n+import org.apache.pinot.common.utils.DataTable;\n+import org.testng.annotations.Test;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.stream.IntStream;\n+\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static java.util.Objects.requireNonNull;\n+\n+public class TestPinotStreamingSegmentPageSource\n+        extends TestPinotSegmentPageSource\n+{\n+    private static final class MockServerResponse\n+            extends ServerResponse\n+    {\n+        private DataTable dataTable;\n+\n+        public MockServerResponse(Server.ServerResponse serverResponse)\n+        {\n+            super(serverResponse);\n+        }\n+\n+        public MockServerResponse(DataTable dataTable)\n+        {\n+            super(null);\n+            this.dataTable = dataTable;\n+        }\n+\n+        public String getResponseType()\n+        {\n+            return Constants.Response.ResponseType.DATA;\n+        }\n+\n+        public int getSerializedSize()\n+        {\n+            return 0;\n+        }\n+\n+        public ByteBuffer getPayloadReadOnlyByteBuffer()\n+        {\n+            try {\n+                return ByteBuffer.wrap(dataTable.toBytes());\n+            }\n+            catch (IOException e) {\n+                throw new RuntimeException(e);\n+            }\n+        }\n+\n+        public DataTable getDataTable(ByteBuffer byteBuffer) throws IOException\n+        {\n+            return SimpleDataTable.fromBytes(byteBuffer);\n+        }\n+    }\n+\n+    private static final class MockPinotStreamingQueryClient\n+            extends PinotStreamingQueryClient\n+    {\n+        private final ImmutableList<DataTable> dataTables;\n+\n+        MockPinotStreamingQueryClient(PinotStreamingQueryClient.Config pinotConfig, List<DataTable> dataTables)\n+        {\n+            super(pinotConfig);\n+            this.dataTables = ImmutableList.copyOf(dataTables);\n+        }\n+\n+        @Override\n+        public Iterator<ServerResponse> submit(String host, int port, GrpcRequestBuilder requestBuilder)\n+        {\n+            return new Iterator<ServerResponse>()\n+            {\n+                int i;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab821abc728c11cb3ebbb8128f25750a73bd4017"}, "originalPosition": 107}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTMyMTg0OA==", "bodyText": "sigh, so much test code duplication :-(", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r511321848", "createdAt": "2020-10-24T05:14:16Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/TestPinotStreamingSegmentPageSource.java", "diffHunk": "@@ -0,0 +1,229 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.pinot;\n+\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.common.block.Block;\n+import com.facebook.presto.common.block.VariableWidthBlock;\n+import com.facebook.presto.common.type.ArrayType;\n+import com.facebook.presto.common.type.IntegerType;\n+import com.facebook.presto.common.type.Type;\n+import com.facebook.presto.common.type.VariableWidthType;\n+import com.facebook.presto.pinot.grpc.Constants;\n+import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n+import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n+import com.facebook.presto.pinot.grpc.ServerResponse;\n+import com.facebook.presto.spi.ConnectorSession;\n+import com.facebook.presto.testing.TestingConnectorSession;\n+import com.facebook.presto.testing.assertions.Assert;\n+import com.google.common.collect.ImmutableList;\n+import org.apache.pinot.common.proto.Server;\n+import org.apache.pinot.common.utils.DataSchema;\n+import org.apache.pinot.common.utils.DataTable;\n+import org.testng.annotations.Test;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.stream.IntStream;\n+\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static java.util.Objects.requireNonNull;\n+\n+public class TestPinotStreamingSegmentPageSource\n+        extends TestPinotSegmentPageSource\n+{\n+    private static final class MockServerResponse\n+            extends ServerResponse\n+    {\n+        private DataTable dataTable;\n+\n+        public MockServerResponse(Server.ServerResponse serverResponse)\n+        {\n+            super(serverResponse);\n+        }\n+\n+        public MockServerResponse(DataTable dataTable)\n+        {\n+            super(null);\n+            this.dataTable = dataTable;\n+        }\n+\n+        public String getResponseType()\n+        {\n+            return Constants.Response.ResponseType.DATA;\n+        }\n+\n+        public int getSerializedSize()\n+        {\n+            return 0;\n+        }\n+\n+        public ByteBuffer getPayloadReadOnlyByteBuffer()\n+        {\n+            try {\n+                return ByteBuffer.wrap(dataTable.toBytes());\n+            }\n+            catch (IOException e) {\n+                throw new RuntimeException(e);\n+            }\n+        }\n+\n+        public DataTable getDataTable(ByteBuffer byteBuffer) throws IOException\n+        {\n+            return SimpleDataTable.fromBytes(byteBuffer);\n+        }\n+    }\n+\n+    private static final class MockPinotStreamingQueryClient\n+            extends PinotStreamingQueryClient\n+    {\n+        private final ImmutableList<DataTable> dataTables;\n+\n+        MockPinotStreamingQueryClient(PinotStreamingQueryClient.Config pinotConfig, List<DataTable> dataTables)\n+        {\n+            super(pinotConfig);\n+            this.dataTables = ImmutableList.copyOf(dataTables);\n+        }\n+\n+        @Override\n+        public Iterator<ServerResponse> submit(String host, int port, GrpcRequestBuilder requestBuilder)\n+        {\n+            return new Iterator<ServerResponse>()\n+            {\n+                int i;\n+\n+                @Override\n+                public boolean hasNext()\n+                {\n+                    return i < dataTables.size();\n+                }\n+\n+                @Override\n+                public ServerResponse next()\n+                {\n+                    return new MockServerResponse(dataTables.get(i++));\n+                }\n+            };\n+        }\n+    }\n+\n+    @Test", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab821abc728c11cb3ebbb8128f25750a73bd4017"}, "originalPosition": 124}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTMyMjAwNg==", "bodyText": "Should we also check that the splits return a valid GRPC host ?", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r511322006", "createdAt": "2020-10-24T05:15:06Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/TestPinotSplitManager.java", "diffHunk": "@@ -125,10 +125,13 @@ private void assertSplits(List<PinotSplit> splits, int numSplitsExpected, PinotS\n     private void assertSegmentSplitWellFormed(PinotSplit split, boolean expectFilter)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab821abc728c11cb3ebbb8128f25750a73bd4017"}, "originalPosition": 1}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ab821abc728c11cb3ebbb8128f25750a73bd4017", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/ab821abc728c11cb3ebbb8128f25750a73bd4017", "committedDate": "2020-10-24T05:08:50Z", "message": "Support Pinot Streaming connector for Segment query"}, "afterCommit": {"oid": "5d506fab6dedb37ee09ff1846ca6c9548e055192", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/5d506fab6dedb37ee09ff1846ca6c9548e055192", "committedDate": "2020-10-24T06:03:07Z", "message": "Support Pinot Streaming connector for Segment query"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5d506fab6dedb37ee09ff1846ca6c9548e055192", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/5d506fab6dedb37ee09ff1846ca6c9548e055192", "committedDate": "2020-10-24T06:03:07Z", "message": "Support Pinot Streaming connector for Segment query"}, "afterCommit": {"oid": "a007c6a85f21747f774b1c6560dc98096dde7345", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/a007c6a85f21747f774b1c6560dc98096dde7345", "committedDate": "2020-10-24T06:23:51Z", "message": "Support Pinot Streaming connector for Segment query\n\nPinot recently added support of gRpc based streaming query endpoint at Pinot server level, which allows user to pull data in a streaming fashion. (apache/incubator-pinot#5599, apache/incubator-pinot#6027 )\n\nThis is extremely good for the use cases which requires large data scan and try to retrieve a lot of data from Pinot.\n\nComparing to the non-streaming way, Presto segment level query requires pinot server to process the query on the entire data segment and all the results have to be in memory and serialized then send back to client. In the streaming fashion, client side can specify a block size and only call next to fetch the given size of results to process then call next to fetch the next block. Pinot server side only advance and process the data processing when client calls next. In this way, Pinot server side cpu and memory pressure is much less."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a007c6a85f21747f774b1c6560dc98096dde7345", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/a007c6a85f21747f774b1c6560dc98096dde7345", "committedDate": "2020-10-24T06:23:51Z", "message": "Support Pinot Streaming connector for Segment query\n\nPinot recently added support of gRpc based streaming query endpoint at Pinot server level, which allows user to pull data in a streaming fashion. (apache/incubator-pinot#5599, apache/incubator-pinot#6027 )\n\nThis is extremely good for the use cases which requires large data scan and try to retrieve a lot of data from Pinot.\n\nComparing to the non-streaming way, Presto segment level query requires pinot server to process the query on the entire data segment and all the results have to be in memory and serialized then send back to client. In the streaming fashion, client side can specify a block size and only call next to fetch the given size of results to process then call next to fetch the next block. Pinot server side only advance and process the data processing when client calls next. In this way, Pinot server side cpu and memory pressure is much less."}, "afterCommit": {"oid": "8e702c2df403c51024596c8b23be7264d6c43a6c", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/8e702c2df403c51024596c8b23be7264d6c43a6c", "committedDate": "2020-10-24T06:35:26Z", "message": "Support Pinot Streaming connector for Segment query\n\nPinot recently added support of gRpc based streaming query endpoint at Pinot server level, which allows user to pull data in a streaming fashion. (apache/incubator-pinot#5599, apache/incubator-pinot#6027 )\n\nThis is extremely good for the use cases which requires large data scan and try to retrieve a lot of data from Pinot.\n\nComparing to the non-streaming way, Presto segment level query requires pinot server to process the query on the entire data segment and all the results have to be in memory and serialized then send back to client. In the streaming fashion, client side can specify a block size and only call next to fetch the given size of results to process then call next to fetch the next block. Pinot server side only advance and process the data processing when client calls next. In this way, Pinot server side cpu and memory pressure is much less."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8e702c2df403c51024596c8b23be7264d6c43a6c", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/8e702c2df403c51024596c8b23be7264d6c43a6c", "committedDate": "2020-10-24T06:35:26Z", "message": "Support Pinot Streaming connector for Segment query\n\nPinot recently added support of gRpc based streaming query endpoint at Pinot server level, which allows user to pull data in a streaming fashion. (apache/incubator-pinot#5599, apache/incubator-pinot#6027 )\n\nThis is extremely good for the use cases which requires large data scan and try to retrieve a lot of data from Pinot.\n\nComparing to the non-streaming way, Presto segment level query requires pinot server to process the query on the entire data segment and all the results have to be in memory and serialized then send back to client. In the streaming fashion, client side can specify a block size and only call next to fetch the given size of results to process then call next to fetch the next block. Pinot server side only advance and process the data processing when client calls next. In this way, Pinot server side cpu and memory pressure is much less."}, "afterCommit": {"oid": "3a2b32fbd40552b512e0120e749cd9872702c06d", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/3a2b32fbd40552b512e0120e749cd9872702c06d", "committedDate": "2020-10-24T08:28:29Z", "message": "Support Pinot Streaming connector for Segment query\n\nPinot recently added support of gRpc based streaming query endpoint at Pinot server level, which allows user to pull data in a streaming fashion. (apache/incubator-pinot#5599, apache/incubator-pinot#6027 )\n\nThis is extremely good for the use cases which requires large data scan and try to retrieve a lot of data from Pinot.\n\nComparing to the non-streaming way, Presto segment level query requires pinot server to process the query on the entire data segment and all the results have to be in memory and serialized then send back to client. In the streaming fashion, client side can specify a block size and only call next to fetch the given size of results to process then call next to fetch the next block. Pinot server side only advance and process the data processing when client calls next. In this way, Pinot server side cpu and memory pressure is much less."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2MjkyMzUy", "url": "https://github.com/prestodb/presto/pull/15319#pullrequestreview-516292352", "createdAt": "2020-10-24T17:08:03Z", "commit": {"oid": "3a2b32fbd40552b512e0120e749cd9872702c06d"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNFQxNzowODowM1rOHnzDwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNFQxNzowOToyM1rOHnzERQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ5MzA1Nw==", "bodyText": "I could be wrong, but I think that the rest of the code is also susceptible to failing when the controller fails. So it may be okay to just propagate the exception, since it is not like you are adding a new vulnerability.\nWhere is the Pinot Server's GRPC port specified in the Pinot configuration (ie on the Pinot cluster side): If there too, the port is fixed (how does that work for k8s then, which does not like fixed ports), then I can see why having a fall back port specified in the pinot config makes sense.\nI don't have a strong feeling here, and I am totally fine with having this config. It just seems weird to me to use some pre-configured port value when we couldn't get the real thing :-). Either way the query will fail.", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r511493057", "createdAt": "2020-10-24T17:08:03Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotConnection.java", "diffHunk": "@@ -110,4 +110,19 @@ public TimeBoundary getTimeBoundary(String tableName)\n     {\n         return pinotClusterInfoFetcher.getTimeBoundaryForTable(tableName);\n     }\n+\n+    public int getGrpcPort(String serverInstance)\n+    {\n+        int grpcPort;\n+        try {\n+            grpcPort = pinotClusterInfoFetcher.getGrpcPort(serverInstance);\n+            if (grpcPort <= 0) {\n+                grpcPort = pinotConfig.getServerGrpcPort();\n+            }\n+        }\n+        catch (Exception e) {\n+            grpcPort = pinotConfig.getServerGrpcPort();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTMyMTI0NQ=="}, "originalCommit": {"oid": "3b4198abd41b16dfea38c8199ec23d313102031d"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ5MzE4OQ==", "bodyText": "nit: Extra newline ?", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r511493189", "createdAt": "2020-10-24T17:09:23Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java", "diffHunk": "@@ -0,0 +1,143 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.pinot;\n+\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.pinot.grpc.Constants;\n+import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n+import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n+import com.facebook.presto.pinot.grpc.ServerResponse;\n+import com.facebook.presto.spi.ConnectorSession;\n+import org.apache.pinot.common.utils.DataTable;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_DATA_FETCH_EXCEPTION;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_INVALID_SEGMENT_QUERY_GENERATED;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_UNEXPECTED_RESPONSE;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * This class retrieves Pinot data from a Pinot client, and re-constructs the data into Presto Pages.\n+ */\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a2b32fbd40552b512e0120e749cd9872702c06d"}, "originalPosition": 38}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3a2b32fbd40552b512e0120e749cd9872702c06d", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/3a2b32fbd40552b512e0120e749cd9872702c06d", "committedDate": "2020-10-24T08:28:29Z", "message": "Support Pinot Streaming connector for Segment query\n\nPinot recently added support of gRpc based streaming query endpoint at Pinot server level, which allows user to pull data in a streaming fashion. (apache/incubator-pinot#5599, apache/incubator-pinot#6027 )\n\nThis is extremely good for the use cases which requires large data scan and try to retrieve a lot of data from Pinot.\n\nComparing to the non-streaming way, Presto segment level query requires pinot server to process the query on the entire data segment and all the results have to be in memory and serialized then send back to client. In the streaming fashion, client side can specify a block size and only call next to fetch the given size of results to process then call next to fetch the next block. Pinot server side only advance and process the data processing when client calls next. In this way, Pinot server side cpu and memory pressure is much less."}, "afterCommit": {"oid": "5c832b73c735381e71e68f66e355cf78060e048d", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/5c832b73c735381e71e68f66e355cf78060e048d", "committedDate": "2020-10-24T18:37:14Z", "message": "Support Pinot Streaming connector for Segment query\n\nPinot recently added support of gRpc based streaming query endpoint at Pinot server level, which allows user to pull data in a streaming fashion. (apache/incubator-pinot#5599, apache/incubator-pinot#6027 )\n\nThis is extremely good for the use cases which requires large data scan and try to retrieve a lot of data from Pinot.\n\nComparing to the non-streaming way, Presto segment level query requires pinot server to process the query on the entire data segment and all the results have to be in memory and serialized then send back to client. In the streaming fashion, client side can specify a block size and only call next to fetch the given size of results to process then call next to fetch the next block. Pinot server side only advance and process the data processing when client calls next. In this way, Pinot server side cpu and memory pressure is much less."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5c832b73c735381e71e68f66e355cf78060e048d", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/5c832b73c735381e71e68f66e355cf78060e048d", "committedDate": "2020-10-24T18:37:14Z", "message": "Support Pinot Streaming connector for Segment query\n\nPinot recently added support of gRpc based streaming query endpoint at Pinot server level, which allows user to pull data in a streaming fashion. (apache/incubator-pinot#5599, apache/incubator-pinot#6027 )\n\nThis is extremely good for the use cases which requires large data scan and try to retrieve a lot of data from Pinot.\n\nComparing to the non-streaming way, Presto segment level query requires pinot server to process the query on the entire data segment and all the results have to be in memory and serialized then send back to client. In the streaming fashion, client side can specify a block size and only call next to fetch the given size of results to process then call next to fetch the next block. Pinot server side only advance and process the data processing when client calls next. In this way, Pinot server side cpu and memory pressure is much less."}, "afterCommit": {"oid": "e2740568a46aade69e8eafec4097abf74d42e530", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/e2740568a46aade69e8eafec4097abf74d42e530", "committedDate": "2020-10-24T19:38:27Z", "message": "Support Pinot Streaming connector for Segment query\n\nPinot recently added support of gRpc based streaming query endpoint at Pinot server level, which allows user to pull data in a streaming fashion. (apache/incubator-pinot#5599, apache/incubator-pinot#6027 )\n\nThis is extremely good for the use cases which requires large data scan and try to retrieve a lot of data from Pinot.\n\nComparing to the non-streaming way, Presto segment level query requires pinot server to process the query on the entire data segment and all the results have to be in memory and serialized then send back to client. In the streaming fashion, client side can specify a block size and only call next to fetch the given size of results to process then call next to fetch the next block. Pinot server side only advance and process the data processing when client calls next. In this way, Pinot server side cpu and memory pressure is much less."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2MzA2ODI3", "url": "https://github.com/prestodb/presto/pull/15319#pullrequestreview-516306827", "createdAt": "2020-10-24T20:59:11Z", "commit": {"oid": "e2740568a46aade69e8eafec4097abf74d42e530"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNFQyMDo1OToxMlrOHn0UiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNFQyMDo1OToxMlrOHn0UiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTUxMzczNw==", "bodyText": "This is a stale comment now.", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r511513737", "createdAt": "2020-10-24T20:59:12Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java", "diffHunk": "@@ -486,4 +504,100 @@ public TimeBoundary getTimeBoundaryForTable(String table)\n             throw e;\n         }\n     }\n+\n+    public static class Instance\n+    {\n+        private final String instanceName;\n+        private final String hostName;\n+        private final boolean enabled;\n+        private final int port;\n+        private final int grpcPort;\n+        private final List<String> tags;\n+        private final List<String> pools;\n+\n+        @JsonCreator\n+        public Instance(\n+                @JsonProperty String instanceName,\n+                @JsonProperty String hostName,\n+                @JsonProperty boolean enabled,\n+                @JsonProperty int port,\n+                @JsonProperty int grpcPort,\n+                @JsonProperty List<String> tags,\n+                @JsonProperty List<String> pools)\n+        {\n+            this.instanceName = instanceName;\n+            this.hostName = hostName;\n+            this.enabled = enabled;\n+            this.port = port;\n+            this.grpcPort = grpcPort;\n+            this.tags = tags;\n+            this.pools = pools;\n+        }\n+\n+        public String getInstanceName()\n+        {\n+            return instanceName;\n+        }\n+\n+        public String getHostName()\n+        {\n+            return hostName;\n+        }\n+\n+        public boolean isEnabled()\n+        {\n+            return enabled;\n+        }\n+\n+        public int getPort()\n+        {\n+            return port;\n+        }\n+\n+        public int getGrpcPort()\n+        {\n+            return grpcPort;\n+        }\n+\n+        public List<String> getTags()\n+        {\n+            return tags;\n+        }\n+\n+        public List<String> getPools()\n+        {\n+            return pools;\n+        }\n+    }\n+\n+    public Instance getInstance(String instanceName)\n+    {\n+        try {\n+            String responseBody = sendHttpGetToController(String.format(INSTANCE_API_TEMPLATE, instanceName));\n+            return instanceJsonCodec.fromJson(responseBody);\n+        }\n+        catch (Exception throwable) {\n+            throw new PinotException(PINOT_UNABLE_TO_FIND_INSTANCE, Optional.empty(), \"Error when fetching instance configs for \" + instanceName, throwable);\n+        }\n+    }\n+\n+    // Fetch grpc port based on below policy:\n+    //   1. Extract grpc port from Pinot instance config\n+    //   2. If gRpc port < 0 then return fallback server grpc port setting by config: `pinot.server-grpc-port`.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2740568a46aade69e8eafec4097abf74d42e530"}, "originalPosition": 170}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e2740568a46aade69e8eafec4097abf74d42e530", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/e2740568a46aade69e8eafec4097abf74d42e530", "committedDate": "2020-10-24T19:38:27Z", "message": "Support Pinot Streaming connector for Segment query\n\nPinot recently added support of gRpc based streaming query endpoint at Pinot server level, which allows user to pull data in a streaming fashion. (apache/incubator-pinot#5599, apache/incubator-pinot#6027 )\n\nThis is extremely good for the use cases which requires large data scan and try to retrieve a lot of data from Pinot.\n\nComparing to the non-streaming way, Presto segment level query requires pinot server to process the query on the entire data segment and all the results have to be in memory and serialized then send back to client. In the streaming fashion, client side can specify a block size and only call next to fetch the given size of results to process then call next to fetch the next block. Pinot server side only advance and process the data processing when client calls next. In this way, Pinot server side cpu and memory pressure is much less."}, "afterCommit": {"oid": "bd152cb1d424358fe7db9e1c92747138e83f9361", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/bd152cb1d424358fe7db9e1c92747138e83f9361", "committedDate": "2020-10-24T22:44:55Z", "message": "Support Pinot Streaming connector for Segment query\n\nPinot recently added support of gRpc based streaming query endpoint at Pinot server level, which allows user to pull data in a streaming fashion. (apache/incubator-pinot#5599, apache/incubator-pinot#6027 )\n\nThis is extremely good for the use cases which requires large data scan and try to retrieve a lot of data from Pinot.\n\nComparing to the non-streaming way, Presto segment level query requires pinot server to process the query on the entire data segment and all the results have to be in memory and serialized then send back to client. In the streaming fashion, client side can specify a block size and only call next to fetch the given size of results to process then call next to fetch the next block. Pinot server side only advance and process the data processing when client calls next. In this way, Pinot server side cpu and memory pressure is much less."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bd152cb1d424358fe7db9e1c92747138e83f9361", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/bd152cb1d424358fe7db9e1c92747138e83f9361", "committedDate": "2020-10-24T22:44:55Z", "message": "Support Pinot Streaming connector for Segment query\n\nPinot recently added support of gRpc based streaming query endpoint at Pinot server level, which allows user to pull data in a streaming fashion. (apache/incubator-pinot#5599, apache/incubator-pinot#6027 )\n\nThis is extremely good for the use cases which requires large data scan and try to retrieve a lot of data from Pinot.\n\nComparing to the non-streaming way, Presto segment level query requires pinot server to process the query on the entire data segment and all the results have to be in memory and serialized then send back to client. In the streaming fashion, client side can specify a block size and only call next to fetch the given size of results to process then call next to fetch the next block. Pinot server side only advance and process the data processing when client calls next. In this way, Pinot server side cpu and memory pressure is much less."}, "afterCommit": {"oid": "2bff425cf680a314456e8d69c68c2eb69472c3f1", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/2bff425cf680a314456e8d69c68c2eb69472c3f1", "committedDate": "2020-10-28T21:11:46Z", "message": "Support Pinot Streaming connector for Segment query\n\nPinot recently added support of gRpc based streaming query endpoint at Pinot server level, which allows user to pull data in a streaming fashion. (apache/incubator-pinot#5599, apache/incubator-pinot#6027 )\n\nThis is extremely good for the use cases which requires large data scan and try to retrieve a lot of data from Pinot.\n\nComparing to the non-streaming way, Presto segment level query requires pinot server to process the query on the entire data segment and all the results have to be in memory and serialized then send back to client. In the streaming fashion, client side can specify a block size and only call next to fetch the given size of results to process then call next to fetch the next block. Pinot server side only advance and process the data processing when client calls next. In this way, Pinot server side cpu and memory pressure is much less."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxMzM2OTc0", "url": "https://github.com/prestodb/presto/pull/15319#pullrequestreview-521336974", "createdAt": "2020-11-02T05:20:09Z", "commit": {"oid": "2bff425cf680a314456e8d69c68c2eb69472c3f1"}, "state": "COMMENTED", "comments": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQwNToyMDowOVrOHr2kbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQwNTo0MDoyNlrOHr22bA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc0NDg3Nw==", "bodyText": "keep tihs", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r515744877", "createdAt": "2020-11-02T05:20:09Z", "author": {"login": "highker"}, "path": "presto-pinot/pom.xml", "diffHunk": "@@ -22,13 +22,22 @@\n         <dependency>\n             <groupId>com.facebook.presto</groupId>\n             <artifactId>presto-pinot-toolkit</artifactId>\n+            <exclusions>\n+                <exclusion>\n+                    <groupId>com.google.protobuf</groupId>\n+                    <artifactId>protobuf-java</artifactId>\n+                </exclusion>\n+                <exclusion>\n+                    <groupId>com.google.errorprone</groupId>\n+                    <artifactId>error_prone_annotations</artifactId>\n+                </exclusion>\n+            </exclusions>\n         </dependency>\n \n         <dependency>\n             <groupId>com.google.guava</groupId>\n             <artifactId>guava</artifactId>\n         </dependency>\n-", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bff425cf680a314456e8d69c68c2eb69472c3f1"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc0NTUwOQ==", "bodyText": "one param per line", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r515745509", "createdAt": "2020-11-02T05:23:20Z", "author": {"login": "highker"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java", "diffHunk": "@@ -486,4 +504,98 @@ public TimeBoundary getTimeBoundaryForTable(String table)\n             throw e;\n         }\n     }\n+\n+    public static class Instance\n+    {\n+        private final String instanceName;\n+        private final String hostName;\n+        private final boolean enabled;\n+        private final int port;\n+        private final int grpcPort;\n+        private final List<String> tags;\n+        private final List<String> pools;\n+\n+        @JsonCreator\n+        public Instance(\n+                @JsonProperty String instanceName,\n+                @JsonProperty String hostName,\n+                @JsonProperty boolean enabled,\n+                @JsonProperty int port,\n+                @JsonProperty int grpcPort,\n+                @JsonProperty List<String> tags,\n+                @JsonProperty List<String> pools)\n+        {\n+            this.instanceName = instanceName;\n+            this.hostName = hostName;\n+            this.enabled = enabled;\n+            this.port = port;\n+            this.grpcPort = grpcPort;\n+            this.tags = tags;\n+            this.pools = pools;\n+        }\n+\n+        public String getInstanceName()\n+        {\n+            return instanceName;\n+        }\n+\n+        public String getHostName()\n+        {\n+            return hostName;\n+        }\n+\n+        public boolean isEnabled()\n+        {\n+            return enabled;\n+        }\n+\n+        public int getPort()\n+        {\n+            return port;\n+        }\n+\n+        public int getGrpcPort()\n+        {\n+            return grpcPort;\n+        }\n+\n+        public List<String> getTags()\n+        {\n+            return tags;\n+        }\n+\n+        public List<String> getPools()\n+        {\n+            return pools;\n+        }\n+    }\n+\n+    public Instance getInstance(String instanceName)\n+    {\n+        try {\n+            String responseBody = sendHttpGetToController(String.format(INSTANCE_API_TEMPLATE, instanceName));\n+            return instanceJsonCodec.fromJson(responseBody);\n+        }\n+        catch (Exception throwable) {\n+            throw new PinotException(PINOT_UNABLE_TO_FIND_INSTANCE, Optional.empty(), \"Error when fetching instance configs for \" + instanceName, throwable);\n+        }\n+    }\n+\n+    // Fetch grpc port from Pinot instance config.\n+    public int getGrpcPort(String serverInstance)\n+    {\n+        try {\n+            return instanceConfigCache.get(serverInstance).getGrpcPort();\n+        }\n+        catch (ExecutionException e) {\n+            Throwable cause = e.getCause();\n+            if (cause instanceof PinotException) {\n+                throw (PinotException) cause;\n+            }\n+            else {\n+                throw new PinotException(PINOT_UNABLE_TO_FIND_INSTANCE, Optional.empty(),\n+                    \"Error when getting instance config for \" + serverInstance, cause);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bff425cf680a314456e8d69c68c2eb69472c3f1"}, "originalPosition": 181}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc0NTUyMg==", "bodyText": "remove else", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r515745522", "createdAt": "2020-11-02T05:23:25Z", "author": {"login": "highker"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java", "diffHunk": "@@ -486,4 +504,98 @@ public TimeBoundary getTimeBoundaryForTable(String table)\n             throw e;\n         }\n     }\n+\n+    public static class Instance\n+    {\n+        private final String instanceName;\n+        private final String hostName;\n+        private final boolean enabled;\n+        private final int port;\n+        private final int grpcPort;\n+        private final List<String> tags;\n+        private final List<String> pools;\n+\n+        @JsonCreator\n+        public Instance(\n+                @JsonProperty String instanceName,\n+                @JsonProperty String hostName,\n+                @JsonProperty boolean enabled,\n+                @JsonProperty int port,\n+                @JsonProperty int grpcPort,\n+                @JsonProperty List<String> tags,\n+                @JsonProperty List<String> pools)\n+        {\n+            this.instanceName = instanceName;\n+            this.hostName = hostName;\n+            this.enabled = enabled;\n+            this.port = port;\n+            this.grpcPort = grpcPort;\n+            this.tags = tags;\n+            this.pools = pools;\n+        }\n+\n+        public String getInstanceName()\n+        {\n+            return instanceName;\n+        }\n+\n+        public String getHostName()\n+        {\n+            return hostName;\n+        }\n+\n+        public boolean isEnabled()\n+        {\n+            return enabled;\n+        }\n+\n+        public int getPort()\n+        {\n+            return port;\n+        }\n+\n+        public int getGrpcPort()\n+        {\n+            return grpcPort;\n+        }\n+\n+        public List<String> getTags()\n+        {\n+            return tags;\n+        }\n+\n+        public List<String> getPools()\n+        {\n+            return pools;\n+        }\n+    }\n+\n+    public Instance getInstance(String instanceName)\n+    {\n+        try {\n+            String responseBody = sendHttpGetToController(String.format(INSTANCE_API_TEMPLATE, instanceName));\n+            return instanceJsonCodec.fromJson(responseBody);\n+        }\n+        catch (Exception throwable) {\n+            throw new PinotException(PINOT_UNABLE_TO_FIND_INSTANCE, Optional.empty(), \"Error when fetching instance configs for \" + instanceName, throwable);\n+        }\n+    }\n+\n+    // Fetch grpc port from Pinot instance config.\n+    public int getGrpcPort(String serverInstance)\n+    {\n+        try {\n+            return instanceConfigCache.get(serverInstance).getGrpcPort();\n+        }\n+        catch (ExecutionException e) {\n+            Throwable cause = e.getCause();\n+            if (cause instanceof PinotException) {\n+                throw (PinotException) cause;\n+            }\n+            else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bff425cf680a314456e8d69c68c2eb69472c3f1"}, "originalPosition": 179}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc0NTgzMQ==", "bodyText": "Is this class json serializable? If it is, let's annotate each getter with @JsonProperty.", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r515745831", "createdAt": "2020-11-02T05:24:40Z", "author": {"login": "highker"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java", "diffHunk": "@@ -486,4 +504,98 @@ public TimeBoundary getTimeBoundaryForTable(String table)\n             throw e;\n         }\n     }\n+\n+    public static class Instance\n+    {\n+        private final String instanceName;\n+        private final String hostName;\n+        private final boolean enabled;\n+        private final int port;\n+        private final int grpcPort;\n+        private final List<String> tags;\n+        private final List<String> pools;\n+\n+        @JsonCreator\n+        public Instance(\n+                @JsonProperty String instanceName,\n+                @JsonProperty String hostName,\n+                @JsonProperty boolean enabled,\n+                @JsonProperty int port,\n+                @JsonProperty int grpcPort,\n+                @JsonProperty List<String> tags,\n+                @JsonProperty List<String> pools)\n+        {\n+            this.instanceName = instanceName;\n+            this.hostName = hostName;\n+            this.enabled = enabled;\n+            this.port = port;\n+            this.grpcPort = grpcPort;\n+            this.tags = tags;\n+            this.pools = pools;\n+        }\n+\n+        public String getInstanceName()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bff425cf680a314456e8d69c68c2eb69472c3f1"}, "originalPosition": 121}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc0NjA5Nw==", "bodyText": "put this to the end to be the same order as the ones on stack and constructor parameters.", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r515746097", "createdAt": "2020-11-02T05:25:40Z", "author": {"login": "highker"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java", "diffHunk": "@@ -95,12 +107,14 @@ public PinotClusterInfoFetcher(\n             JsonCodec<BrokersForTable> brokersForTableJsonCodec,\n             JsonCodec<RoutingTables> routingTablesJsonCodec,\n             JsonCodec<RoutingTablesV2> routingTablesV2JsonCodec,\n-            JsonCodec<TimeBoundary> timeBoundaryJsonCodec)\n+            JsonCodec<TimeBoundary> timeBoundaryJsonCodec,\n+            JsonCodec<Instance> instanceJsonCodec)\n     {\n         this.brokersForTableJsonCodec = requireNonNull(brokersForTableJsonCodec, \"brokers for table json codec is null\");\n         this.routingTablesJsonCodec = requireNonNull(routingTablesJsonCodec, \"routing tables json codec is null\");\n         this.routingTablesV2JsonCodec = requireNonNull(routingTablesV2JsonCodec, \"routing tables v2 json codec is null\");\n         this.timeBoundaryJsonCodec = requireNonNull(timeBoundaryJsonCodec, \"time boundary json codec is null\");\n+        this.instanceJsonCodec = requireNonNull(instanceJsonCodec, \"instance json codec is null\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bff425cf680a314456e8d69c68c2eb69472c3f1"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc0NjM2Ng==", "bodyText": "private\nwe should keep DataType static imported rather than having FieldSpec.DataType here", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r515746366", "createdAt": "2020-11-02T05:26:58Z", "author": {"login": "highker"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotColumnUtils.java", "diffHunk": "@@ -112,7 +111,7 @@ public static Type getPrestoTypeFromPinotType(FieldSpec field, boolean inferDate\n         return new ArrayType(getPrestoTypeFromPinotType(field.getDataType()));\n     }\n \n-    public static Type getPrestoTypeFromPinotType(DataType dataType)\n+    public static Type getPrestoTypeFromPinotType(FieldSpec.DataType dataType)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bff425cf680a314456e8d69c68c2eb69472c3f1"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc0Njc0Mg==", "bodyText": "_SIZE -> _BYTES\nEither 128 * 1024 * 1024 -> new DataSize(128, MEGABYTE).toBytes() or just make the type to be DataSize. We support DataSize from config", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r515746742", "createdAt": "2020-11-02T05:28:46Z", "author": {"login": "highker"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotConfig.java", "diffHunk": "@@ -38,6 +38,7 @@\n     public static final int DEFAULT_MIN_CONNECTIONS_PER_SERVER = 10;\n     public static final int DEFAULT_THREAD_POOL_SIZE = 30;\n     public static final int DEFAULT_NON_AGGREGATE_LIMIT_FOR_BROKER_QUERIES = 25_000;\n+    public static final int DEFAULT_STREAMING_SERVER_GRPC_MAX_INBOUND_MESSAGE_SIZE = 128 * 1024 * 1024;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bff425cf680a314456e8d69c68c2eb69472c3f1"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc0NzE0Mg==", "bodyText": "this seems to be unused", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r515747142", "createdAt": "2020-11-02T05:30:27Z", "author": {"login": "highker"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotErrorCode.java", "diffHunk": "@@ -37,6 +37,9 @@\n     PINOT_INVALID_CONFIGURATION(10, INTERNAL_ERROR),\n     PINOT_DATA_FETCH_EXCEPTION(11, EXTERNAL, true),\n     PINOT_REQUEST_GENERATOR_FAILURE(12, INTERNAL_ERROR),\n+    PINOT_UNABLE_TO_FIND_INSTANCE(13, EXTERNAL),\n+    PINOT_GRPC_EXCEPTION(14, EXTERNAL),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bff425cf680a314456e8d69c68c2eb69472c3f1"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc0NzM2MA==", "bodyText": "remove else", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r515747360", "createdAt": "2020-11-02T05:31:26Z", "author": {"login": "highker"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPageSourceProvider.java", "diffHunk": "@@ -81,12 +86,23 @@ public ConnectorPageSource createPageSource(\n \n         switch (pinotSplit.getSplitType()) {\n             case SEGMENT:\n-                return new PinotSegmentPageSource(\n+                if (this.pinotConfig.isUseStreamingForSegmentQueries() &&\n+                        pinotSplit.getGrpcPort().orElse(-1) > 0) {\n+                    return new PinotSegmentStreamingPageSource(\n+                        session,\n+                        this.pinotConfig,\n+                        this.pinotStreamingQueryClient,\n+                        pinotSplit,\n+                        handles);\n+                }\n+                else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bff425cf680a314456e8d69c68c2eb69472c3f1"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc0NzQ2MQ==", "bodyText": "remove this\nput these two conditions into one line", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r515747461", "createdAt": "2020-11-02T05:31:49Z", "author": {"login": "highker"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotPageSourceProvider.java", "diffHunk": "@@ -81,12 +86,23 @@ public ConnectorPageSource createPageSource(\n \n         switch (pinotSplit.getSplitType()) {\n             case SEGMENT:\n-                return new PinotSegmentPageSource(\n+                if (this.pinotConfig.isUseStreamingForSegmentQueries() &&\n+                        pinotSplit.getGrpcPort().orElse(-1) > 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bff425cf680a314456e8d69c68c2eb69472c3f1"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc0NzU5NQ==", "bodyText": "make this final", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r515747595", "createdAt": "2020-11-02T05:32:23Z", "author": {"login": "highker"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSource.java", "diffHunk": "@@ -64,20 +62,20 @@\n             ErrorCode.PINOT_INSUFFICIENT_SERVER_RESPONSE, PINOT_INSUFFICIENT_SERVER_RESPONSE,\n             ErrorCode.PINOT_INVALID_PQL_GENERATED, PINOT_INVALID_PQL_GENERATED);\n \n-    private final List<PinotColumnHandle> columnHandles;\n-    private final List<Type> columnTypes;\n-    private final PinotConfig pinotConfig;\n-    private final PinotSplit split;\n+    protected final List<PinotColumnHandle> columnHandles;\n+    protected final List<Type> columnTypes;\n+    protected final PinotConfig pinotConfig;\n+    protected final PinotSplit split;\n     private final PinotScatterGatherQueryClient pinotQueryClient;\n-    private final ConnectorSession session;\n+    protected final ConnectorSession session;\n \n     // dataTableList stores the dataTable returned from each server. Each dataTable is constructed to a Page, and then destroyed to save memory.\n     private LinkedList<PinotDataTableWithSize> dataTableList = new LinkedList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bff425cf680a314456e8d69c68c2eb69472c3f1"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc0ODExNA==", "bodyText": "break a line after this", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r515748114", "createdAt": "2020-11-02T05:34:42Z", "author": {"login": "highker"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java", "diffHunk": "@@ -0,0 +1,142 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.pinot;\n+\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.pinot.grpc.Constants;\n+import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n+import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n+import com.facebook.presto.pinot.grpc.ServerResponse;\n+import com.facebook.presto.spi.ConnectorSession;\n+import org.apache.pinot.common.utils.DataTable;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_DATA_FETCH_EXCEPTION;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_INVALID_SEGMENT_QUERY_GENERATED;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_UNEXPECTED_RESPONSE;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * This class retrieves Pinot data from a Pinot client, and re-constructs the data into Presto Pages.\n+ */\n+public class PinotSegmentStreamingPageSource\n+        extends PinotSegmentPageSource\n+{\n+    private final PinotStreamingQueryClient pinotStreamingQueryClient;\n+    private Iterator<ServerResponse> serverResponseIterator;\n+    private long completedPositions;\n+\n+    public PinotSegmentStreamingPageSource(\n+            ConnectorSession session,\n+            PinotConfig pinotConfig,\n+            PinotStreamingQueryClient pinotStreamingQueryClient,\n+            PinotSplit split,\n+            List<PinotColumnHandle> columnHandles)\n+    {\n+        super(session, pinotConfig, null, split, columnHandles);\n+        this.pinotStreamingQueryClient = requireNonNull(pinotStreamingQueryClient, \"pinotStreamingQueryClient is null\");\n+    }\n+\n+    @Override\n+    public boolean isFinished()\n+    {\n+        return closed;\n+    }\n+\n+    /**\n+     * @return constructed page for pinot data.\n+     */\n+    @Override\n+    public Page getNextPage()\n+    {\n+        if (closed) {\n+            return null;\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bff425cf680a314456e8d69c68c2eb69472c3f1"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc0ODI1MQ==", "bodyText": "one param per line", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r515748251", "createdAt": "2020-11-02T05:35:11Z", "author": {"login": "highker"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java", "diffHunk": "@@ -0,0 +1,142 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.pinot;\n+\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.pinot.grpc.Constants;\n+import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n+import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n+import com.facebook.presto.pinot.grpc.ServerResponse;\n+import com.facebook.presto.spi.ConnectorSession;\n+import org.apache.pinot.common.utils.DataTable;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_DATA_FETCH_EXCEPTION;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_INVALID_SEGMENT_QUERY_GENERATED;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_UNEXPECTED_RESPONSE;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * This class retrieves Pinot data from a Pinot client, and re-constructs the data into Presto Pages.\n+ */\n+public class PinotSegmentStreamingPageSource\n+        extends PinotSegmentPageSource\n+{\n+    private final PinotStreamingQueryClient pinotStreamingQueryClient;\n+    private Iterator<ServerResponse> serverResponseIterator;\n+    private long completedPositions;\n+\n+    public PinotSegmentStreamingPageSource(\n+            ConnectorSession session,\n+            PinotConfig pinotConfig,\n+            PinotStreamingQueryClient pinotStreamingQueryClient,\n+            PinotSplit split,\n+            List<PinotColumnHandle> columnHandles)\n+    {\n+        super(session, pinotConfig, null, split, columnHandles);\n+        this.pinotStreamingQueryClient = requireNonNull(pinotStreamingQueryClient, \"pinotStreamingQueryClient is null\");\n+    }\n+\n+    @Override\n+    public boolean isFinished()\n+    {\n+        return closed;\n+    }\n+\n+    /**\n+     * @return constructed page for pinot data.\n+     */\n+    @Override\n+    public Page getNextPage()\n+    {\n+        if (closed) {\n+            return null;\n+        }\n+        if (serverResponseIterator == null) {\n+            serverResponseIterator = queryPinot(split);\n+        }\n+        ByteBuffer byteBuffer = null;\n+        try {\n+            // Pinot gRPC server response iterator returns:\n+            //   - n data blocks based on inbound message size;\n+            //   - 1 metadata of the query results.\n+            // So we need to check ResponseType of each ServerResponse.\n+            if (serverResponseIterator.hasNext()) {\n+                long startTimeNanos = System.nanoTime();\n+                ServerResponse serverResponse = serverResponseIterator.next();\n+                readTimeNanos += System.nanoTime() - startTimeNanos;\n+                switch (serverResponse.getResponseType()) {\n+                    case Constants.Response.ResponseType.DATA:\n+                        estimatedMemoryUsageInBytes = serverResponse.getSerializedSize();\n+                        // Store each dataTable which will later be constructed into Pages.\n+                        try {\n+                            byteBuffer = serverResponse.getPayloadReadOnlyByteBuffer();\n+                            DataTable dataTable = serverResponse.getDataTable(byteBuffer);\n+                            checkExceptions(dataTable, split, PinotSessionProperties.isMarkDataFetchExceptionsAsRetriable(session));\n+                            currentDataTable = new PinotSegmentPageSource.PinotDataTableWithSize(dataTable,\n+                                serverResponse.getSerializedSize());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bff425cf680a314456e8d69c68c2eb69472c3f1"}, "originalPosition": 93}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc0ODMwMg==", "bodyText": "one param per line", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r515748302", "createdAt": "2020-11-02T05:35:25Z", "author": {"login": "highker"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java", "diffHunk": "@@ -0,0 +1,142 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.pinot;\n+\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.pinot.grpc.Constants;\n+import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n+import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n+import com.facebook.presto.pinot.grpc.ServerResponse;\n+import com.facebook.presto.spi.ConnectorSession;\n+import org.apache.pinot.common.utils.DataTable;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_DATA_FETCH_EXCEPTION;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_INVALID_SEGMENT_QUERY_GENERATED;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_UNEXPECTED_RESPONSE;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * This class retrieves Pinot data from a Pinot client, and re-constructs the data into Presto Pages.\n+ */\n+public class PinotSegmentStreamingPageSource\n+        extends PinotSegmentPageSource\n+{\n+    private final PinotStreamingQueryClient pinotStreamingQueryClient;\n+    private Iterator<ServerResponse> serverResponseIterator;\n+    private long completedPositions;\n+\n+    public PinotSegmentStreamingPageSource(\n+            ConnectorSession session,\n+            PinotConfig pinotConfig,\n+            PinotStreamingQueryClient pinotStreamingQueryClient,\n+            PinotSplit split,\n+            List<PinotColumnHandle> columnHandles)\n+    {\n+        super(session, pinotConfig, null, split, columnHandles);\n+        this.pinotStreamingQueryClient = requireNonNull(pinotStreamingQueryClient, \"pinotStreamingQueryClient is null\");\n+    }\n+\n+    @Override\n+    public boolean isFinished()\n+    {\n+        return closed;\n+    }\n+\n+    /**\n+     * @return constructed page for pinot data.\n+     */\n+    @Override\n+    public Page getNextPage()\n+    {\n+        if (closed) {\n+            return null;\n+        }\n+        if (serverResponseIterator == null) {\n+            serverResponseIterator = queryPinot(split);\n+        }\n+        ByteBuffer byteBuffer = null;\n+        try {\n+            // Pinot gRPC server response iterator returns:\n+            //   - n data blocks based on inbound message size;\n+            //   - 1 metadata of the query results.\n+            // So we need to check ResponseType of each ServerResponse.\n+            if (serverResponseIterator.hasNext()) {\n+                long startTimeNanos = System.nanoTime();\n+                ServerResponse serverResponse = serverResponseIterator.next();\n+                readTimeNanos += System.nanoTime() - startTimeNanos;\n+                switch (serverResponse.getResponseType()) {\n+                    case Constants.Response.ResponseType.DATA:\n+                        estimatedMemoryUsageInBytes = serverResponse.getSerializedSize();\n+                        // Store each dataTable which will later be constructed into Pages.\n+                        try {\n+                            byteBuffer = serverResponse.getPayloadReadOnlyByteBuffer();\n+                            DataTable dataTable = serverResponse.getDataTable(byteBuffer);\n+                            checkExceptions(dataTable, split, PinotSessionProperties.isMarkDataFetchExceptionsAsRetriable(session));\n+                            currentDataTable = new PinotSegmentPageSource.PinotDataTableWithSize(dataTable,\n+                                serverResponse.getSerializedSize());\n+                        }\n+                        catch (IOException e) {\n+                            throw new PinotException(PINOT_DATA_FETCH_EXCEPTION, split.getSegmentPinotQuery(), String.format(\"Encountered Pinot exceptions when fetching data table from Split: < %s >\",\n+                                split), e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bff425cf680a314456e8d69c68c2eb69472c3f1"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc0ODQxNw==", "bodyText": "one param per line", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r515748417", "createdAt": "2020-11-02T05:36:00Z", "author": {"login": "highker"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java", "diffHunk": "@@ -0,0 +1,142 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.pinot;\n+\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.pinot.grpc.Constants;\n+import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n+import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n+import com.facebook.presto.pinot.grpc.ServerResponse;\n+import com.facebook.presto.spi.ConnectorSession;\n+import org.apache.pinot.common.utils.DataTable;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_DATA_FETCH_EXCEPTION;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_INVALID_SEGMENT_QUERY_GENERATED;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_UNEXPECTED_RESPONSE;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * This class retrieves Pinot data from a Pinot client, and re-constructs the data into Presto Pages.\n+ */\n+public class PinotSegmentStreamingPageSource\n+        extends PinotSegmentPageSource\n+{\n+    private final PinotStreamingQueryClient pinotStreamingQueryClient;\n+    private Iterator<ServerResponse> serverResponseIterator;\n+    private long completedPositions;\n+\n+    public PinotSegmentStreamingPageSource(\n+            ConnectorSession session,\n+            PinotConfig pinotConfig,\n+            PinotStreamingQueryClient pinotStreamingQueryClient,\n+            PinotSplit split,\n+            List<PinotColumnHandle> columnHandles)\n+    {\n+        super(session, pinotConfig, null, split, columnHandles);\n+        this.pinotStreamingQueryClient = requireNonNull(pinotStreamingQueryClient, \"pinotStreamingQueryClient is null\");\n+    }\n+\n+    @Override\n+    public boolean isFinished()\n+    {\n+        return closed;\n+    }\n+\n+    /**\n+     * @return constructed page for pinot data.\n+     */\n+    @Override\n+    public Page getNextPage()\n+    {\n+        if (closed) {\n+            return null;\n+        }\n+        if (serverResponseIterator == null) {\n+            serverResponseIterator = queryPinot(split);\n+        }\n+        ByteBuffer byteBuffer = null;\n+        try {\n+            // Pinot gRPC server response iterator returns:\n+            //   - n data blocks based on inbound message size;\n+            //   - 1 metadata of the query results.\n+            // So we need to check ResponseType of each ServerResponse.\n+            if (serverResponseIterator.hasNext()) {\n+                long startTimeNanos = System.nanoTime();\n+                ServerResponse serverResponse = serverResponseIterator.next();\n+                readTimeNanos += System.nanoTime() - startTimeNanos;\n+                switch (serverResponse.getResponseType()) {\n+                    case Constants.Response.ResponseType.DATA:\n+                        estimatedMemoryUsageInBytes = serverResponse.getSerializedSize();\n+                        // Store each dataTable which will later be constructed into Pages.\n+                        try {\n+                            byteBuffer = serverResponse.getPayloadReadOnlyByteBuffer();\n+                            DataTable dataTable = serverResponse.getDataTable(byteBuffer);\n+                            checkExceptions(dataTable, split, PinotSessionProperties.isMarkDataFetchExceptionsAsRetriable(session));\n+                            currentDataTable = new PinotSegmentPageSource.PinotDataTableWithSize(dataTable,\n+                                serverResponse.getSerializedSize());\n+                        }\n+                        catch (IOException e) {\n+                            throw new PinotException(PINOT_DATA_FETCH_EXCEPTION, split.getSegmentPinotQuery(), String.format(\"Encountered Pinot exceptions when fetching data table from Split: < %s >\",\n+                                split), e);\n+                        }\n+                        break;\n+                    case Constants.Response.ResponseType.METADATA:\n+                        // The last part of the response is Metadata\n+                        currentDataTable = null;\n+                        serverResponseIterator = null;\n+                        close();\n+                        return null;\n+                    default:\n+                        throw new PinotException(PINOT_UNEXPECTED_RESPONSE, split.getSegmentPinotQuery(),\n+                            String.format(\"Encountered Pinot exceptions, unknown response type - %s\", serverResponse.getResponseType()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bff425cf680a314456e8d69c68c2eb69472c3f1"}, "originalPosition": 108}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc0ODk2Mg==", "bodyText": "miss a throw", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r515748962", "createdAt": "2020-11-02T05:38:28Z", "author": {"login": "highker"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentStreamingPageSource.java", "diffHunk": "@@ -0,0 +1,142 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.pinot;\n+\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.pinot.grpc.Constants;\n+import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n+import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n+import com.facebook.presto.pinot.grpc.ServerResponse;\n+import com.facebook.presto.spi.ConnectorSession;\n+import org.apache.pinot.common.utils.DataTable;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_DATA_FETCH_EXCEPTION;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_INVALID_SEGMENT_QUERY_GENERATED;\n+import static com.facebook.presto.pinot.PinotErrorCode.PINOT_UNEXPECTED_RESPONSE;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * This class retrieves Pinot data from a Pinot client, and re-constructs the data into Presto Pages.\n+ */\n+public class PinotSegmentStreamingPageSource\n+        extends PinotSegmentPageSource\n+{\n+    private final PinotStreamingQueryClient pinotStreamingQueryClient;\n+    private Iterator<ServerResponse> serverResponseIterator;\n+    private long completedPositions;\n+\n+    public PinotSegmentStreamingPageSource(\n+            ConnectorSession session,\n+            PinotConfig pinotConfig,\n+            PinotStreamingQueryClient pinotStreamingQueryClient,\n+            PinotSplit split,\n+            List<PinotColumnHandle> columnHandles)\n+    {\n+        super(session, pinotConfig, null, split, columnHandles);\n+        this.pinotStreamingQueryClient = requireNonNull(pinotStreamingQueryClient, \"pinotStreamingQueryClient is null\");\n+    }\n+\n+    @Override\n+    public boolean isFinished()\n+    {\n+        return closed;\n+    }\n+\n+    /**\n+     * @return constructed page for pinot data.\n+     */\n+    @Override\n+    public Page getNextPage()\n+    {\n+        if (closed) {\n+            return null;\n+        }\n+        if (serverResponseIterator == null) {\n+            serverResponseIterator = queryPinot(split);\n+        }\n+        ByteBuffer byteBuffer = null;\n+        try {\n+            // Pinot gRPC server response iterator returns:\n+            //   - n data blocks based on inbound message size;\n+            //   - 1 metadata of the query results.\n+            // So we need to check ResponseType of each ServerResponse.\n+            if (serverResponseIterator.hasNext()) {\n+                long startTimeNanos = System.nanoTime();\n+                ServerResponse serverResponse = serverResponseIterator.next();\n+                readTimeNanos += System.nanoTime() - startTimeNanos;\n+                switch (serverResponse.getResponseType()) {\n+                    case Constants.Response.ResponseType.DATA:\n+                        estimatedMemoryUsageInBytes = serverResponse.getSerializedSize();\n+                        // Store each dataTable which will later be constructed into Pages.\n+                        try {\n+                            byteBuffer = serverResponse.getPayloadReadOnlyByteBuffer();\n+                            DataTable dataTable = serverResponse.getDataTable(byteBuffer);\n+                            checkExceptions(dataTable, split, PinotSessionProperties.isMarkDataFetchExceptionsAsRetriable(session));\n+                            currentDataTable = new PinotSegmentPageSource.PinotDataTableWithSize(dataTable,\n+                                serverResponse.getSerializedSize());\n+                        }\n+                        catch (IOException e) {\n+                            throw new PinotException(PINOT_DATA_FETCH_EXCEPTION, split.getSegmentPinotQuery(), String.format(\"Encountered Pinot exceptions when fetching data table from Split: < %s >\",\n+                                split), e);\n+                        }\n+                        break;\n+                    case Constants.Response.ResponseType.METADATA:\n+                        // The last part of the response is Metadata\n+                        currentDataTable = null;\n+                        serverResponseIterator = null;\n+                        close();\n+                        return null;\n+                    default:\n+                        throw new PinotException(PINOT_UNEXPECTED_RESPONSE, split.getSegmentPinotQuery(),\n+                            String.format(\"Encountered Pinot exceptions, unknown response type - %s\", serverResponse.getResponseType()));\n+                }\n+            }\n+            Page page = fillNextPage();\n+            completedPositions += currentDataTable.getDataTable().getNumberOfRows();\n+            return page;\n+        }\n+        finally {\n+            if (byteBuffer != null) {\n+                byteBuffer.clear();\n+            }\n+        }\n+    }\n+\n+    private Iterator<ServerResponse> queryPinot(PinotSplit split)\n+    {\n+        String sql = split.getSegmentPinotQuery().orElseThrow(() -> new PinotException(PINOT_INVALID_SEGMENT_QUERY_GENERATED, Optional.empty(), \"Expected the segment split to contain the pinot query\"));\n+        String grpcHost = split.getGrpcHost().orElseThrow(() -> new PinotException(PINOT_INVALID_SEGMENT_QUERY_GENERATED, Optional.empty(), \"Expected the segment split to contain the grpc host\"));\n+        int grpcPort = split.getGrpcPort().orElseThrow(() -> new PinotException(PINOT_INVALID_SEGMENT_QUERY_GENERATED, Optional.empty(), \"Expected the segment split to contain the grpc port\"));\n+        if (grpcPort <= 0) {\n+            new PinotException(PINOT_INVALID_SEGMENT_QUERY_GENERATED, Optional.empty(), \"Expected the grpc port > 0 always\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bff425cf680a314456e8d69c68c2eb69472c3f1"}, "originalPosition": 128}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc0OTQ4NA==", "bodyText": "directly return new Pinot...", "url": "https://github.com/prestodb/presto/pull/15319#discussion_r515749484", "createdAt": "2020-11-02T05:40:26Z", "author": {"login": "highker"}, "path": "presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/TestPinotSegmentStreamingPageSource.java", "diffHunk": "@@ -0,0 +1,128 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.pinot;\n+\n+import com.facebook.presto.pinot.grpc.Constants;\n+import com.facebook.presto.pinot.grpc.GrpcRequestBuilder;\n+import com.facebook.presto.pinot.grpc.PinotStreamingQueryClient;\n+import com.facebook.presto.pinot.grpc.ServerResponse;\n+import com.facebook.presto.spi.ConnectorSession;\n+import com.google.common.collect.ImmutableList;\n+import org.apache.pinot.common.proto.Server;\n+import org.apache.pinot.common.utils.DataTable;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.pinot.MockPinotClusterInfoFetcher.DEFAULT_GRPC_PORT;\n+\n+public class TestPinotSegmentStreamingPageSource\n+        extends TestPinotSegmentPageSource\n+{\n+    private static final class MockServerResponse\n+            extends ServerResponse\n+    {\n+        private DataTable dataTable;\n+\n+        public MockServerResponse(Server.ServerResponse serverResponse)\n+        {\n+            super(serverResponse);\n+        }\n+\n+        public MockServerResponse(DataTable dataTable)\n+        {\n+            super(null);\n+            this.dataTable = dataTable;\n+        }\n+\n+        public String getResponseType()\n+        {\n+            return Constants.Response.ResponseType.DATA;\n+        }\n+\n+        public int getSerializedSize()\n+        {\n+            return 0;\n+        }\n+\n+        public ByteBuffer getPayloadReadOnlyByteBuffer()\n+        {\n+            try {\n+                return ByteBuffer.wrap(dataTable.toBytes());\n+            }\n+            catch (IOException e) {\n+                throw new RuntimeException(e);\n+            }\n+        }\n+\n+        public DataTable getDataTable(ByteBuffer byteBuffer) throws IOException\n+        {\n+            return SimpleDataTable.fromBytes(byteBuffer);\n+        }\n+    }\n+\n+    private static final class MockPinotStreamingQueryClient\n+            extends PinotStreamingQueryClient\n+    {\n+        private final ImmutableList<DataTable> dataTables;\n+\n+        MockPinotStreamingQueryClient(PinotStreamingQueryClient.Config pinotConfig, List<DataTable> dataTables)\n+        {\n+            super(pinotConfig);\n+            this.dataTables = ImmutableList.copyOf(dataTables);\n+        }\n+\n+        @Override\n+        public Iterator<ServerResponse> submit(String host, int port, GrpcRequestBuilder requestBuilder)\n+        {\n+            return new Iterator<ServerResponse>()\n+            {\n+                int index;\n+\n+                @Override\n+                public boolean hasNext()\n+                {\n+                    return index < dataTables.size();\n+                }\n+\n+                @Override\n+                public ServerResponse next()\n+                {\n+                    return new MockServerResponse(dataTables.get(index++));\n+                }\n+            };\n+        }\n+    }\n+\n+    @Override\n+    PinotSegmentPageSource getPinotSegmentPageSource(\n+            ConnectorSession session,\n+            List<DataTable> dataTables,\n+            PinotSplit mockPinotSplit,\n+            List<PinotColumnHandle> handlesSurviving)\n+    {\n+        MockPinotStreamingQueryClient mockPinotQueryClient = new MockPinotStreamingQueryClient(new PinotStreamingQueryClient.Config(pinotConfig.getStreamingServerGrpcMaxInboundMessageSize(), true), dataTables);\n+        PinotSegmentPageSource pinotSegmentPageSource = new PinotSegmentStreamingPageSource(session, pinotConfig, mockPinotQueryClient, mockPinotSplit, handlesSurviving);\n+        return pinotSegmentPageSource;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bff425cf680a314456e8d69c68c2eb69472c3f1"}, "originalPosition": 120}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2bff425cf680a314456e8d69c68c2eb69472c3f1", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/2bff425cf680a314456e8d69c68c2eb69472c3f1", "committedDate": "2020-10-28T21:11:46Z", "message": "Support Pinot Streaming connector for Segment query\n\nPinot recently added support of gRpc based streaming query endpoint at Pinot server level, which allows user to pull data in a streaming fashion. (apache/incubator-pinot#5599, apache/incubator-pinot#6027 )\n\nThis is extremely good for the use cases which requires large data scan and try to retrieve a lot of data from Pinot.\n\nComparing to the non-streaming way, Presto segment level query requires pinot server to process the query on the entire data segment and all the results have to be in memory and serialized then send back to client. In the streaming fashion, client side can specify a block size and only call next to fetch the given size of results to process then call next to fetch the next block. Pinot server side only advance and process the data processing when client calls next. In this way, Pinot server side cpu and memory pressure is much less."}, "afterCommit": {"oid": "f72c8797b8b84b70fc60f1334f0a376db02c937d", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/f72c8797b8b84b70fc60f1334f0a376db02c937d", "committedDate": "2020-11-02T20:27:47Z", "message": "Support Pinot Streaming connector for Segment query\n\nPinot recently added support of gRpc based streaming query endpoint at Pinot server level, which allows user to pull data in a streaming fashion. (apache/incubator-pinot#5599, apache/incubator-pinot#6027 )\n\nThis is extremely good for the use cases which requires large data scan and try to retrieve a lot of data from Pinot.\n\nComparing to the non-streaming way, Presto segment level query requires pinot server to process the query on the entire data segment and all the results have to be in memory and serialized then send back to client. In the streaming fashion, client side can specify a block size and only call next to fetch the given size of results to process then call next to fetch the next block. Pinot server side only advance and process the data processing when client calls next. In this way, Pinot server side cpu and memory pressure is much less."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e0c1e081863bb06937a9c712793bae7dbd6cce4", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/6e0c1e081863bb06937a9c712793bae7dbd6cce4", "committedDate": "2020-11-02T22:02:03Z", "message": "Support Pinot Streaming connector for Segment query\n\nPinot recently added support of gRpc based streaming query endpoint at Pinot server level, which allows user to pull data in a streaming fashion. (apache/incubator-pinot#5599, apache/incubator-pinot#6027 )\n\nThis is extremely good for the use cases which requires large data scan and try to retrieve a lot of data from Pinot.\n\nComparing to the non-streaming way, Presto segment level query requires pinot server to process the query on the entire data segment and all the results have to be in memory and serialized then send back to client. In the streaming fashion, client side can specify a block size and only call next to fetch the given size of results to process then call next to fetch the next block. Pinot server side only advance and process the data processing when client calls next. In this way, Pinot server side cpu and memory pressure is much less."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f72c8797b8b84b70fc60f1334f0a376db02c937d", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/f72c8797b8b84b70fc60f1334f0a376db02c937d", "committedDate": "2020-11-02T20:27:47Z", "message": "Support Pinot Streaming connector for Segment query\n\nPinot recently added support of gRpc based streaming query endpoint at Pinot server level, which allows user to pull data in a streaming fashion. (apache/incubator-pinot#5599, apache/incubator-pinot#6027 )\n\nThis is extremely good for the use cases which requires large data scan and try to retrieve a lot of data from Pinot.\n\nComparing to the non-streaming way, Presto segment level query requires pinot server to process the query on the entire data segment and all the results have to be in memory and serialized then send back to client. In the streaming fashion, client side can specify a block size and only call next to fetch the given size of results to process then call next to fetch the next block. Pinot server side only advance and process the data processing when client calls next. In this way, Pinot server side cpu and memory pressure is much less."}, "afterCommit": {"oid": "6e0c1e081863bb06937a9c712793bae7dbd6cce4", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/6e0c1e081863bb06937a9c712793bae7dbd6cce4", "committedDate": "2020-11-02T22:02:03Z", "message": "Support Pinot Streaming connector for Segment query\n\nPinot recently added support of gRpc based streaming query endpoint at Pinot server level, which allows user to pull data in a streaming fashion. (apache/incubator-pinot#5599, apache/incubator-pinot#6027 )\n\nThis is extremely good for the use cases which requires large data scan and try to retrieve a lot of data from Pinot.\n\nComparing to the non-streaming way, Presto segment level query requires pinot server to process the query on the entire data segment and all the results have to be in memory and serialized then send back to client. In the streaming fashion, client side can specify a block size and only call next to fetch the given size of results to process then call next to fetch the next block. Pinot server side only advance and process the data processing when client calls next. In this way, Pinot server side cpu and memory pressure is much less."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyODEyMzA3", "url": "https://github.com/prestodb/presto/pull/15319#pullrequestreview-522812307", "createdAt": "2020-11-03T19:28:54Z", "commit": {"oid": "6e0c1e081863bb06937a9c712793bae7dbd6cce4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4918, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}