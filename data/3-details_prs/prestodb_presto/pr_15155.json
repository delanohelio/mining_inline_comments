{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgzMjQ4MzQ5", "number": 15155, "title": "Support fragment result caching", "bodyText": "Test plan - Multiple unit test for CanonicalPlanGenerator, FileFragmentResultCacheManager and Driver. Ran shadow test for internal queries. Ran verifier test for internal queries.\n== RELEASE NOTES ==\n\nGeneral Changes\n* Add support for fragment result caching. When enabled, if the same plan fragment and same connector split hit the same worker, engine would directly fetch result from cache and skip computation. Currently only partial aggregation is supported. Cache could be enabled by setting ``fragment-result-cache.enabled`` to ``true`` and tuned by other configs started with ``fragment-result-cache``. \n Query could use fragment result cache by setting config ``experimental.fragment-result-caching-enabled`` or session property ``fragment_result_caching_enabled`` to ``true``.\n\nSPI changes\n* Add ``getSplitIdentifier`` to ``ConnectorSplit``. Split identifier is used in fragment result caching to identify if splits are identical.\n* Add ``getIdentifier`` to ``ConnectorTableLayoutHandle``. Layout identifier is used in fragment result caching to construct canonical plan.", "createdAt": "2020-09-10T01:05:08Z", "url": "https://github.com/prestodb/presto/pull/15155", "merged": true, "mergeCommit": {"oid": "9eaa655ac8f7719898abd5fea6923dc3d408f0d6"}, "closed": true, "closedAt": "2020-10-01T16:41:05Z", "author": {"login": "shixuan-fan"}, "timelineItems": {"totalCount": 46, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdHlm00ABqjM3NTI2NzkyNzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZwM9AAFqTUyNDg2NzcyNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "07aeb6fc02d1d1329ba72cf0077e47ebc8c6c772", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/07aeb6fc02d1d1329ba72cf0077e47ebc8c6c772", "committedDate": "2020-09-10T01:01:34Z", "message": "Support fragment result caching"}, "afterCommit": {"oid": "096f70197ebf6dfa915049b647c74c4b7aa398f7", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/096f70197ebf6dfa915049b647c74c4b7aa398f7", "committedDate": "2020-09-10T19:03:22Z", "message": "Support fragment result caching"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "096f70197ebf6dfa915049b647c74c4b7aa398f7", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/096f70197ebf6dfa915049b647c74c4b7aa398f7", "committedDate": "2020-09-10T19:03:22Z", "message": "Support fragment result caching"}, "afterCommit": {"oid": "e6fd95be91c302c93139d028ce5e29cb8ecafa82", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/e6fd95be91c302c93139d028ce5e29cb8ecafa82", "committedDate": "2020-09-10T22:27:20Z", "message": "Support fragment result caching"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2OTY0ODM0", "url": "https://github.com/prestodb/presto/pull/15155#pullrequestreview-486964834", "createdAt": "2020-09-11T16:47:26Z", "commit": {"oid": "e6fd95be91c302c93139d028ce5e29cb8ecafa82"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxNjo0NzoyN1rOHQmQ9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxNjo0NzoyN1rOHQmQ9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE2NjE5Nw==", "bodyText": "put FragmentResultCacheManager & fragmentResultCachingEnabled in dirverContext?", "url": "https://github.com/prestodb/presto/pull/15155#discussion_r487166197", "createdAt": "2020-09-11T16:47:27Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/Driver.java", "diffHunk": "@@ -90,22 +95,27 @@\n \n     private final AtomicReference<SettableFuture<?>> driverBlockedFuture = new AtomicReference<>();\n \n+    private final AtomicReference<Optional<Iterator<Page>>> cachedResult = new AtomicReference<>(Optional.empty());\n+    private final AtomicReference<Split> split = new AtomicReference<>();\n+    private final List<Page> outputPages = new ArrayList<>();\n+\n     private enum State\n     {\n         ALIVE, NEED_DESTRUCTION, DESTROYED\n     }\n \n-    public static Driver createDriver(DriverContext driverContext, List<Operator> operators)\n+    public static Driver createDriver(DriverContext driverContext, FragmentResultCacheManager fragmentResultCacheManager, boolean fragmentResultCachingEnabled, List<Operator> operators)\n     {\n         requireNonNull(driverContext, \"driverContext is null\");\n+        requireNonNull(fragmentResultCacheManager, \"fragmentResultCacheManager is null\");\n         requireNonNull(operators, \"operators is null\");\n-        Driver driver = new Driver(driverContext, operators);\n+        Driver driver = new Driver(driverContext, fragmentResultCacheManager, fragmentResultCachingEnabled, operators);\n         driver.initialize();\n         return driver;\n     }\n \n     @VisibleForTesting\n-    public static Driver createDriver(DriverContext driverContext, Operator firstOperator, Operator... otherOperators)\n+    public static Driver createDriver(DriverContext driverContext, FragmentResultCacheManager fragmentResultCacheManager, boolean fragmentResultCachingEnabled, Operator firstOperator, Operator... otherOperators)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6fd95be91c302c93139d028ce5e29cb8ecafa82"}, "originalPosition": 53}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e6fd95be91c302c93139d028ce5e29cb8ecafa82", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/e6fd95be91c302c93139d028ce5e29cb8ecafa82", "committedDate": "2020-09-10T22:27:20Z", "message": "Support fragment result caching"}, "afterCommit": {"oid": "803fa1b002cc40bcfae25db8592cce492ecfe2cb", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/803fa1b002cc40bcfae25db8592cce492ecfe2cb", "committedDate": "2020-09-12T00:47:22Z", "message": "Support fragment result caching"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "803fa1b002cc40bcfae25db8592cce492ecfe2cb", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/803fa1b002cc40bcfae25db8592cce492ecfe2cb", "committedDate": "2020-09-12T00:47:22Z", "message": "Support fragment result caching"}, "afterCommit": {"oid": "85bb0de782aea7272b46d2248e4b825e0f165885", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/85bb0de782aea7272b46d2248e4b825e0f165885", "committedDate": "2020-09-13T18:29:02Z", "message": "Support fragment result caching"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3NDM1MTA4", "url": "https://github.com/prestodb/presto/pull/15155#pullrequestreview-487435108", "createdAt": "2020-09-14T05:59:20Z", "commit": {"oid": "85bb0de782aea7272b46d2248e4b825e0f165885"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQwNTo1OToyMFrOHRE42Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQwNTo1OToyMFrOHRE42Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY2NzkyOQ==", "bodyText": "Since this cache is on the driver's side, is there any sanity check in protection from oom? just curious if this cache size can be stored for monitoring so caching on the driver is in a controlled manner.", "url": "https://github.com/prestodb/presto/pull/15155#discussion_r487667929", "createdAt": "2020-09-14T05:59:20Z", "author": {"login": "fgwang7w"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/Driver.java", "diffHunk": "@@ -412,6 +449,12 @@ private OperationTimer createTimer()\n                         throwIfUnchecked(throwable);\n                         throw new RuntimeException(throwable);\n                     }\n+\n+                    if (fragmentResultCachingEnabled) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85bb0de782aea7272b46d2248e4b825e0f165885"}, "originalPosition": 176}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "85bb0de782aea7272b46d2248e4b825e0f165885", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/85bb0de782aea7272b46d2248e4b825e0f165885", "committedDate": "2020-09-13T18:29:02Z", "message": "Support fragment result caching"}, "afterCommit": {"oid": "18879b8a88edd6f11150a18d5be9f26d01fd1163", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/18879b8a88edd6f11150a18d5be9f26d01fd1163", "committedDate": "2020-09-14T20:18:29Z", "message": "Support fragment result caching"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "18879b8a88edd6f11150a18d5be9f26d01fd1163", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/18879b8a88edd6f11150a18d5be9f26d01fd1163", "committedDate": "2020-09-14T20:18:29Z", "message": "Support fragment result caching"}, "afterCommit": {"oid": "a822f821af4cc07456e0d84664799397b0d693ae", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/a822f821af4cc07456e0d84664799397b0d693ae", "committedDate": "2020-09-15T16:38:22Z", "message": "Support fragment result caching"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a822f821af4cc07456e0d84664799397b0d693ae", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/a822f821af4cc07456e0d84664799397b0d693ae", "committedDate": "2020-09-15T16:38:22Z", "message": "Support fragment result caching"}, "afterCommit": {"oid": "7c0b178aaccda80c8e77784c09ca663f36fa4164", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/7c0b178aaccda80c8e77784c09ca663f36fa4164", "committedDate": "2020-09-15T19:18:38Z", "message": "Support fragment result caching"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7c0b178aaccda80c8e77784c09ca663f36fa4164", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/7c0b178aaccda80c8e77784c09ca663f36fa4164", "committedDate": "2020-09-15T19:18:38Z", "message": "Support fragment result caching"}, "afterCommit": {"oid": "f169fc72f8aa6d3e78735cffc396514d638163be", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/f169fc72f8aa6d3e78735cffc396514d638163be", "committedDate": "2020-09-15T21:59:46Z", "message": "Support fragment result caching"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f169fc72f8aa6d3e78735cffc396514d638163be", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/f169fc72f8aa6d3e78735cffc396514d638163be", "committedDate": "2020-09-15T21:59:46Z", "message": "Support fragment result caching"}, "afterCommit": {"oid": "d2be4dd601033a507b2253f7b965d8547194bae1", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/d2be4dd601033a507b2253f7b965d8547194bae1", "committedDate": "2020-09-15T22:03:38Z", "message": "Support fragment result caching"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d2be4dd601033a507b2253f7b965d8547194bae1", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/d2be4dd601033a507b2253f7b965d8547194bae1", "committedDate": "2020-09-15T22:03:38Z", "message": "Support fragment result caching"}, "afterCommit": {"oid": "2faaa48816e0672dda0dc32a17704ce3d7cac166", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/2faaa48816e0672dda0dc32a17704ce3d7cac166", "committedDate": "2020-09-15T23:45:54Z", "message": "Support fragment result caching"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2faaa48816e0672dda0dc32a17704ce3d7cac166", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/2faaa48816e0672dda0dc32a17704ce3d7cac166", "committedDate": "2020-09-15T23:45:54Z", "message": "Support fragment result caching"}, "afterCommit": {"oid": "bb9fb05544ad129cacf3240091bb213a8f3ed5f3", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/bb9fb05544ad129cacf3240091bb213a8f3ed5f3", "committedDate": "2020-09-19T00:28:16Z", "message": "Support fragment result caching"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bb9fb05544ad129cacf3240091bb213a8f3ed5f3", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/bb9fb05544ad129cacf3240091bb213a8f3ed5f3", "committedDate": "2020-09-19T00:28:16Z", "message": "Support fragment result caching"}, "afterCommit": {"oid": "1ee7806051b458fb0dfa12469d8acbbc5e28519a", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/1ee7806051b458fb0dfa12469d8acbbc5e28519a", "committedDate": "2020-09-19T05:50:05Z", "message": "Support fragment result caching"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1ee7806051b458fb0dfa12469d8acbbc5e28519a", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/1ee7806051b458fb0dfa12469d8acbbc5e28519a", "committedDate": "2020-09-19T05:50:05Z", "message": "Support fragment result caching"}, "afterCommit": {"oid": "001db72b9950d93fddcdcfbaca97dfee738ad6f6", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/001db72b9950d93fddcdcfbaca97dfee738ad6f6", "committedDate": "2020-09-19T17:02:20Z", "message": "Support fragment result caching"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "001db72b9950d93fddcdcfbaca97dfee738ad6f6", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/001db72b9950d93fddcdcfbaca97dfee738ad6f6", "committedDate": "2020-09-19T17:02:20Z", "message": "Support fragment result caching"}, "afterCommit": {"oid": "e88f3186f1a934d2ad8abf4b50d8bc1f819097e6", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/e88f3186f1a934d2ad8abf4b50d8bc1f819097e6", "committedDate": "2020-09-22T01:18:29Z", "message": "Support fragment result caching"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e88f3186f1a934d2ad8abf4b50d8bc1f819097e6", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/e88f3186f1a934d2ad8abf4b50d8bc1f819097e6", "committedDate": "2020-09-22T01:18:29Z", "message": "Support fragment result caching"}, "afterCommit": {"oid": "3eaad3df45e8bcefeffe9682993a23b34e09dd83", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/3eaad3df45e8bcefeffe9682993a23b34e09dd83", "committedDate": "2020-09-22T17:34:40Z", "message": "Support fragment result caching"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3eaad3df45e8bcefeffe9682993a23b34e09dd83", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/3eaad3df45e8bcefeffe9682993a23b34e09dd83", "committedDate": "2020-09-22T17:34:40Z", "message": "Support fragment result caching"}, "afterCommit": {"oid": "062015e423ab4eecb99e471e38067cfd54607545", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/062015e423ab4eecb99e471e38067cfd54607545", "committedDate": "2020-09-22T17:37:27Z", "message": "Support fragment result caching"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "062015e423ab4eecb99e471e38067cfd54607545", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/062015e423ab4eecb99e471e38067cfd54607545", "committedDate": "2020-09-22T17:37:27Z", "message": "Support fragment result caching"}, "afterCommit": {"oid": "081135681db5acd9829826e3082832a3523794f6", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/081135681db5acd9829826e3082832a3523794f6", "committedDate": "2020-09-22T22:18:36Z", "message": "Support fragment result caching"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "081135681db5acd9829826e3082832a3523794f6", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/081135681db5acd9829826e3082832a3523794f6", "committedDate": "2020-09-22T22:18:36Z", "message": "Support fragment result caching"}, "afterCommit": {"oid": "38f21ff7081566fa62d38ba83046a680e955407a", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/38f21ff7081566fa62d38ba83046a680e955407a", "committedDate": "2020-09-23T01:26:57Z", "message": "Support fragment result caching"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "38f21ff7081566fa62d38ba83046a680e955407a", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/38f21ff7081566fa62d38ba83046a680e955407a", "committedDate": "2020-09-23T01:26:57Z", "message": "Support fragment result caching"}, "afterCommit": {"oid": "efa9c3deac9fa58dd7e1780a90585020c22eb2a7", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/efa9c3deac9fa58dd7e1780a90585020c22eb2a7", "committedDate": "2020-09-23T05:51:10Z", "message": "Support fragment result caching"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "efa9c3deac9fa58dd7e1780a90585020c22eb2a7", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/efa9c3deac9fa58dd7e1780a90585020c22eb2a7", "committedDate": "2020-09-23T05:51:10Z", "message": "Support fragment result caching"}, "afterCommit": {"oid": "f97b5698df0542079affe0d4c39f8803d0bdb85b", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/f97b5698df0542079affe0d4c39f8803d0bdb85b", "committedDate": "2020-09-23T22:09:50Z", "message": "Support fragment result caching"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f97b5698df0542079affe0d4c39f8803d0bdb85b", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/f97b5698df0542079affe0d4c39f8803d0bdb85b", "committedDate": "2020-09-23T22:09:50Z", "message": "Support fragment result caching"}, "afterCommit": {"oid": "22c01b69fa5123909bcffba7247bdded7345789e", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/22c01b69fa5123909bcffba7247bdded7345789e", "committedDate": "2020-09-23T22:13:27Z", "message": "Support fragment result caching"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "22c01b69fa5123909bcffba7247bdded7345789e", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/22c01b69fa5123909bcffba7247bdded7345789e", "committedDate": "2020-09-23T22:13:27Z", "message": "Support fragment result caching"}, "afterCommit": {"oid": "a421eb99586f6d7d0296de4129786436659ed344", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/a421eb99586f6d7d0296de4129786436659ed344", "committedDate": "2020-09-23T22:31:27Z", "message": "Support fragment result caching"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3MDQ4MDgz", "url": "https://github.com/prestodb/presto/pull/15155#pullrequestreview-497048083", "createdAt": "2020-09-27T03:43:34Z", "commit": {"oid": "a85ad67e9ea3c025e9110bf266263110c199d3e5"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QwMzo0MzozNFrOHYkW8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QwNDo1MDo1OFrOHYkqIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUyMzU2OQ==", "bodyText": "Maybe add a comment to explain we don't we need the whole stack of variables", "url": "https://github.com/prestodb/presto/pull/15155#discussion_r495523569", "createdAt": "2020-09-27T03:43:34Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveTableLayoutHandle.java", "diffHunk": "@@ -226,4 +226,15 @@ public boolean isPartialAggregationsPushedDown()\n     {\n         return partialAggregationsPushedDown;\n     }\n+\n+    @Override\n+    public Object getIdentifier()\n+    {\n+        return ImmutableMap.builder()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a85ad67e9ea3c025e9110bf266263110c199d3e5"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUyODQ4Mg==", "bodyText": "We have a lot of CanonicalXXX counter part in this commit. Shall we add some tests to make sure the canonical part is in sync with the original class? Meaning that if the original class changes, we should fail some tests or automatically fix the CanonicalXXX", "url": "https://github.com/prestodb/presto/pull/15155#discussion_r495528482", "createdAt": "2020-09-27T04:50:58Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/CanonicalPartitioningScheme.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.sql.planner;\n+\n+import com.facebook.presto.spi.ConnectorId;\n+import com.facebook.presto.spi.connector.ConnectorPartitioningHandle;\n+import com.facebook.presto.spi.relation.RowExpression;\n+import com.facebook.presto.spi.relation.VariableReferenceExpression;\n+import com.google.common.collect.ImmutableList;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.sql.planner.RowExpressionVariableInliner.inlineVariables;\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static java.util.Objects.requireNonNull;\n+\n+public class CanonicalPartitioningScheme", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a85ad67e9ea3c025e9110bf266263110c199d3e5"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3MDUxMDI3", "url": "https://github.com/prestodb/presto/pull/15155#pullrequestreview-497051027", "createdAt": "2020-09-27T04:51:43Z", "commit": {"oid": "a421eb99586f6d7d0296de4129786436659ed344"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3MDUxMDcx", "url": "https://github.com/prestodb/presto/pull/15155#pullrequestreview-497051071", "createdAt": "2020-09-27T04:53:01Z", "commit": {"oid": "71e2e413bd9ad233e842f20d5a6d39680cf1954c"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QwNDo1MzowMVrOHYkqlg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QwNTowMDoxN1rOHYksZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUyODU5OA==", "bodyText": "This collides with the one in presto-cache. Maybe call it FragmentCacheStats or just merge with existing class", "url": "https://github.com/prestodb/presto/pull/15155#discussion_r495528598", "createdAt": "2020-09-27T04:53:01Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/CacheStats.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.operator;\n+\n+import org.weakref.jmx.Managed;\n+\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+public class CacheStats", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71e2e413bd9ad233e842f20d5a6d39680cf1954c"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUyOTA2MA==", "bodyText": "put it into finally incase tryDeleteFile directly throws", "url": "https://github.com/prestodb/presto/pull/15155#discussion_r495529060", "createdAt": "2020-09-27T05:00:17Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/FileFragmentResultCacheManager.java", "diffHunk": "@@ -0,0 +1,255 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.operator;\n+\n+import com.facebook.airlift.log.Logger;\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.common.block.BlockEncodingSerde;\n+import com.facebook.presto.execution.buffer.PagesSerdeFactory;\n+import com.facebook.presto.metadata.Split;\n+import com.facebook.presto.metadata.Split.SplitIdentifier;\n+import com.facebook.presto.spi.PrestoException;\n+import com.facebook.presto.spi.page.PagesSerde;\n+import com.facebook.presto.sql.planner.CanonicalPlanFragment;\n+import com.google.common.cache.Cache;\n+import com.google.common.cache.CacheBuilder;\n+import com.google.common.cache.RemovalListener;\n+import com.google.common.cache.RemovalNotification;\n+import io.airlift.slice.InputStreamSliceInput;\n+import io.airlift.slice.OutputStreamSliceOutput;\n+import io.airlift.slice.SliceOutput;\n+\n+import javax.inject.Inject;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.UncheckedIOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Arrays;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Future;\n+\n+import static com.facebook.presto.spi.StandardErrorCode.GENERIC_INTERNAL_ERROR;\n+import static com.facebook.presto.spi.page.PagesSerdeUtil.readPages;\n+import static com.facebook.presto.spi.page.PagesSerdeUtil.writePages;\n+import static com.google.common.util.concurrent.Futures.immediateFuture;\n+import static java.nio.file.Files.newInputStream;\n+import static java.nio.file.Files.newOutputStream;\n+import static java.nio.file.StandardOpenOption.APPEND;\n+import static java.util.Objects.requireNonNull;\n+import static java.util.UUID.randomUUID;\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+\n+public class FileFragmentResultCacheManager\n+        implements FragmentResultCacheManager\n+{\n+    private static final Logger log = Logger.get(FileFragmentResultCacheManager.class);\n+\n+    private final Path baseDirectory;\n+    private final long maxInFlightBytes;\n+    private final PagesSerde pagesSerde;\n+    private final CacheStats cacheStats;\n+    private final ExecutorService flushExecutor;\n+    private final ExecutorService removalExecutor;\n+\n+    private final Cache<CacheKey, Path> cache;\n+\n+    // TODO: Decouple CacheKey by encoding PlanNode and SplitIdentifier separately so we don't have to keep too many objects in memory\n+    @Inject\n+    public FileFragmentResultCacheManager(\n+            FileFragmentResultCacheConfig cacheConfig,\n+            BlockEncodingSerde blockEncodingSerde,\n+            CacheStats cacheStats,\n+            ExecutorService flushExecutor,\n+            ExecutorService removalExecutor)\n+    {\n+        requireNonNull(cacheConfig, \"cacheConfig is null\");\n+        requireNonNull(blockEncodingSerde, \"blockEncodingSerde is null\");\n+\n+        this.baseDirectory = Paths.get(cacheConfig.getBaseDirectory());\n+        this.maxInFlightBytes = cacheConfig.getMaxInFlightSize().toBytes();\n+        this.pagesSerde = new PagesSerdeFactory(blockEncodingSerde, cacheConfig.isBlockEncodingCompressionEnabled()).createPagesSerde();\n+        this.cacheStats = requireNonNull(cacheStats, \"cacheStats is null\");\n+        this.flushExecutor = requireNonNull(flushExecutor, \"flushExecutor is null\");\n+        this.removalExecutor = requireNonNull(removalExecutor, \"removalExecutor is null\");\n+        this.cache = CacheBuilder.newBuilder()\n+                .maximumSize(cacheConfig.getMaxCachedEntries())\n+                .expireAfterAccess(cacheConfig.getCacheTtl().toMillis(), MILLISECONDS)\n+                .removalListener(new CacheRemovalListener())\n+                .recordStats()\n+                .build();\n+\n+        File target = new File(baseDirectory.toUri());\n+        if (!target.exists()) {\n+            try {\n+                Files.createDirectories(target.toPath());\n+            }\n+            catch (IOException e) {\n+                throw new PrestoException(GENERIC_INTERNAL_ERROR, \"cannot create cache directory \" + target, e);\n+            }\n+        }\n+        else {\n+            File[] files = target.listFiles();\n+            if (files == null) {\n+                return;\n+            }\n+\n+            this.removalExecutor.submit(() -> Arrays.stream(files).forEach(file -> {\n+                try {\n+                    Files.delete(file.toPath());\n+                }\n+                catch (IOException e) {\n+                    // ignore\n+                }\n+            }));\n+        }\n+    }\n+\n+    @Override\n+    public Future<?> put(CanonicalPlanFragment plan, Split split, List<Page> result)\n+    {\n+        CacheKey key = new CacheKey(plan, split.getSplitIdentifier());\n+        long resultSize = getPagesSize(result);\n+        if (cacheStats.getInFlightBytes() + resultSize > maxInFlightBytes || cache.getIfPresent(key) != null) {\n+            return immediateFuture(null);\n+        }\n+\n+        cacheStats.addInFlightBytes(resultSize);\n+        Path path = baseDirectory.resolve(randomUUID().toString().replaceAll(\"-\", \"_\"));\n+        return flushExecutor.submit(() -> cachePages(key, path, result));\n+    }\n+\n+    private static long getPagesSize(List<Page> pages)\n+    {\n+        return pages.stream()\n+                .mapToLong(Page::getSizeInBytes)\n+                .sum();\n+    }\n+\n+    private void cachePages(CacheKey key, Path path, List<Page> pages)\n+    {\n+        // TODO: To support both memory and disk limit, we should check cache size before putting to cache and use written bytes as weight for cache\n+        try {\n+            Files.createFile(path);\n+            try (SliceOutput output = new OutputStreamSliceOutput(newOutputStream(path, APPEND))) {\n+                writePages(pagesSerde, output, pages.iterator());\n+                cache.put(key, path);\n+            }\n+            catch (UncheckedIOException | IOException e) {\n+                log.warn(e, \"%s encountered an error while writing to path %s\", Thread.currentThread().getName(), path);\n+                tryDeleteFile(path);\n+            }\n+        }\n+        catch (UncheckedIOException | IOException e) {\n+            log.warn(e, \"%s encountered an error while writing to path %s\", Thread.currentThread().getName(), path);\n+            tryDeleteFile(path);\n+        }\n+        cacheStats.addInFlightBytes(-getPagesSize(pages));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71e2e413bd9ad233e842f20d5a6d39680cf1954c"}, "originalPosition": 165}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3MDUxMzkz", "url": "https://github.com/prestodb/presto/pull/15155#pullrequestreview-497051393", "createdAt": "2020-09-27T05:01:38Z", "commit": {"oid": "a421eb99586f6d7d0296de4129786436659ed344"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3MDUxNDQy", "url": "https://github.com/prestodb/presto/pull/15155#pullrequestreview-497051442", "createdAt": "2020-09-27T05:02:48Z", "commit": {"oid": "a421eb99586f6d7d0296de4129786436659ed344"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QwNTowMjo0OFrOHYktIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QwNTowMjo0OFrOHYktIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUyOTI0OA==", "bodyText": "No AggregationNode?\nSet<Class<? extends PlanNode>>", "url": "https://github.com/prestodb/presto/pull/15155#discussion_r495529248", "createdAt": "2020-09-27T05:02:48Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/FragmentResultCacheContext.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.execution;\n+\n+import com.facebook.presto.Session;\n+import com.facebook.presto.SystemSessionProperties;\n+import com.facebook.presto.operator.FragmentResultCacheManager;\n+import com.facebook.presto.spi.plan.AggregationNode;\n+import com.facebook.presto.spi.plan.FilterNode;\n+import com.facebook.presto.spi.plan.PlanNode;\n+import com.facebook.presto.spi.plan.ProjectNode;\n+import com.facebook.presto.spi.plan.TableScanNode;\n+import com.facebook.presto.sql.planner.CanonicalPlanFragment;\n+import com.facebook.presto.sql.planner.PartitioningScheme;\n+import com.facebook.presto.sql.planner.plan.GroupIdNode;\n+import com.google.common.collect.ImmutableSet;\n+\n+import java.util.Optional;\n+import java.util.Set;\n+\n+import static com.facebook.presto.spi.plan.AggregationNode.Step.PARTIAL;\n+import static com.facebook.presto.sql.planner.CanonicalPlanGenerator.generateCanonicalPlan;\n+import static java.util.Objects.requireNonNull;\n+\n+public class FragmentResultCacheContext\n+{\n+    private static final Set<Class> ALLOWED_NODES = ImmutableSet.of(TableScanNode.class, FilterNode.class, ProjectNode.class, GroupIdNode.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a421eb99586f6d7d0296de4129786436659ed344"}, "originalPosition": 38}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a421eb99586f6d7d0296de4129786436659ed344", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/a421eb99586f6d7d0296de4129786436659ed344", "committedDate": "2020-09-23T22:31:27Z", "message": "Support fragment result caching"}, "afterCommit": {"oid": "9583de36693b07f02abaa8a685897de2ee6d386a", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/9583de36693b07f02abaa8a685897de2ee6d386a", "committedDate": "2020-09-29T00:44:54Z", "message": "Support fragment result caching"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9583de36693b07f02abaa8a685897de2ee6d386a", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/9583de36693b07f02abaa8a685897de2ee6d386a", "committedDate": "2020-09-29T00:44:54Z", "message": "Support fragment result caching"}, "afterCommit": {"oid": "3e1b7b1ed192c8673c2c9e00bb1a004920c67bc3", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/3e1b7b1ed192c8673c2c9e00bb1a004920c67bc3", "committedDate": "2020-09-29T23:14:16Z", "message": "Support fragment result caching"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3e1b7b1ed192c8673c2c9e00bb1a004920c67bc3", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/3e1b7b1ed192c8673c2c9e00bb1a004920c67bc3", "committedDate": "2020-09-29T23:14:16Z", "message": "Support fragment result caching"}, "afterCommit": {"oid": "ef934e38d95ad7222505ef98e6e0b1d1f9a79b80", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/ef934e38d95ad7222505ef98e6e0b1d1f9a79b80", "committedDate": "2020-09-29T23:16:26Z", "message": "Support fragment result caching"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ef934e38d95ad7222505ef98e6e0b1d1f9a79b80", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/ef934e38d95ad7222505ef98e6e0b1d1f9a79b80", "committedDate": "2020-09-29T23:16:26Z", "message": "Support fragment result caching"}, "afterCommit": {"oid": "f9fdb934292f7928c660ed66fe444db5743651c6", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/f9fdb934292f7928c660ed66fe444db5743651c6", "committedDate": "2020-09-29T23:34:26Z", "message": "Support fragment result caching"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f9fdb934292f7928c660ed66fe444db5743651c6", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/f9fdb934292f7928c660ed66fe444db5743651c6", "committedDate": "2020-09-29T23:34:26Z", "message": "Support fragment result caching"}, "afterCommit": {"oid": "dcbc0dd39bacafbecd371bb1bfecb50714a9f0d0", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/dcbc0dd39bacafbecd371bb1bfecb50714a9f0d0", "committedDate": "2020-09-29T23:56:09Z", "message": "Support fragment result caching"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dcbc0dd39bacafbecd371bb1bfecb50714a9f0d0", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/dcbc0dd39bacafbecd371bb1bfecb50714a9f0d0", "committedDate": "2020-09-29T23:56:09Z", "message": "Support fragment result caching"}, "afterCommit": {"oid": "cb9c8b7c2218a00a6b051af58ea6e87122e233eb", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/cb9c8b7c2218a00a6b051af58ea6e87122e233eb", "committedDate": "2020-10-01T03:53:59Z", "message": "Support fragment result caching"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cb9c8b7c2218a00a6b051af58ea6e87122e233eb", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/cb9c8b7c2218a00a6b051af58ea6e87122e233eb", "committedDate": "2020-10-01T03:53:59Z", "message": "Support fragment result caching"}, "afterCommit": {"oid": "353aea4527dfe5684e746d9b1cb0620b6da19e28", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/353aea4527dfe5684e746d9b1cb0620b6da19e28", "committedDate": "2020-10-01T04:34:41Z", "message": "Support fragment result caching"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "353aea4527dfe5684e746d9b1cb0620b6da19e28", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/353aea4527dfe5684e746d9b1cb0620b6da19e28", "committedDate": "2020-10-01T04:34:41Z", "message": "Support fragment result caching"}, "afterCommit": {"oid": "3d9b1e4de425bb2db252628830e560817702b63e", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/3d9b1e4de425bb2db252628830e560817702b63e", "committedDate": "2020-10-01T04:36:55Z", "message": "Support fragment result caching"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57ceea465eb574f3c9307619a6c544dfb63b3268", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/57ceea465eb574f3c9307619a6c544dfb63b3268", "committedDate": "2020-10-01T05:43:39Z", "message": "Introduce CanonicalPlanGenerator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3cb64593058bf432b9dfab5c522caf75111f0a6", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/a3cb64593058bf432b9dfab5c522caf75111f0a6", "committedDate": "2020-10-01T05:43:42Z", "message": "Introduce split identifier"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3d9b1e4de425bb2db252628830e560817702b63e", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/3d9b1e4de425bb2db252628830e560817702b63e", "committedDate": "2020-10-01T04:36:55Z", "message": "Support fragment result caching"}, "afterCommit": {"oid": "3ef8f7c8051b573271723e640a910e1e35bb6e58", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/3ef8f7c8051b573271723e640a910e1e35bb6e58", "committedDate": "2020-10-01T05:43:42Z", "message": "Support fragment result caching"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwMDM2NjEw", "url": "https://github.com/prestodb/presto/pull/15155#pullrequestreview-500036610", "createdAt": "2020-10-01T06:21:02Z", "commit": {"oid": "3ef8f7c8051b573271723e640a910e1e35bb6e58"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f1ef09c90ee10f6ae23cb1f0a238d887fa8e328", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/3f1ef09c90ee10f6ae23cb1f0a238d887fa8e328", "committedDate": "2020-10-01T07:07:04Z", "message": "Introduce fragment result cache manager"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e776d9a5ff5227c3f28991418d70c04cd153129", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/5e776d9a5ff5227c3f28991418d70c04cd153129", "committedDate": "2020-10-01T07:07:08Z", "message": "Use static import and lambda in TestDriver"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d96609bdaf783e8b904da8112bd75d109f0f68e", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/9d96609bdaf783e8b904da8112bd75d109f0f68e", "committedDate": "2020-10-01T07:07:08Z", "message": "Support fragment result caching"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3ef8f7c8051b573271723e640a910e1e35bb6e58", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/3ef8f7c8051b573271723e640a910e1e35bb6e58", "committedDate": "2020-10-01T05:43:42Z", "message": "Support fragment result caching"}, "afterCommit": {"oid": "9d96609bdaf783e8b904da8112bd75d109f0f68e", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/9d96609bdaf783e8b904da8112bd75d109f0f68e", "committedDate": "2020-10-01T07:07:08Z", "message": "Support fragment result caching"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0ODY3NzI0", "url": "https://github.com/prestodb/presto/pull/15155#pullrequestreview-524867724", "createdAt": "2020-11-06T05:34:55Z", "commit": {"oid": "3f1ef09c90ee10f6ae23cb1f0a238d887fa8e328"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQwNTozNDo1NVrOHuguZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQwNTozNDo1NVrOHuguZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODUzMjcxMA==", "bodyText": "this part of code looks so similar to FileSingleStreamSpiller lol.", "url": "https://github.com/prestodb/presto/pull/15155#discussion_r518532710", "createdAt": "2020-11-06T05:34:55Z", "author": {"login": "wenleix"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/FileFragmentResultCacheManager.java", "diffHunk": "@@ -0,0 +1,283 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.operator;\n+\n+import com.facebook.airlift.log.Logger;\n+import com.facebook.presto.common.Page;\n+import com.facebook.presto.common.block.BlockEncodingSerde;\n+import com.facebook.presto.execution.buffer.PagesSerdeFactory;\n+import com.facebook.presto.metadata.Split;\n+import com.facebook.presto.metadata.Split.SplitIdentifier;\n+import com.facebook.presto.spi.PrestoException;\n+import com.facebook.presto.spi.page.PagesSerde;\n+import com.facebook.presto.sql.planner.CanonicalPlanFragment;\n+import com.google.common.cache.Cache;\n+import com.google.common.cache.CacheBuilder;\n+import com.google.common.cache.RemovalListener;\n+import com.google.common.cache.RemovalNotification;\n+import com.google.common.collect.AbstractIterator;\n+import io.airlift.slice.InputStreamSliceInput;\n+import io.airlift.slice.OutputStreamSliceOutput;\n+import io.airlift.slice.SliceOutput;\n+\n+import javax.inject.Inject;\n+\n+import java.io.Closeable;\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.UncheckedIOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Arrays;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Future;\n+\n+import static com.facebook.presto.spi.StandardErrorCode.GENERIC_INTERNAL_ERROR;\n+import static com.facebook.presto.spi.page.PagesSerdeUtil.readPages;\n+import static com.facebook.presto.spi.page.PagesSerdeUtil.writePages;\n+import static com.google.common.util.concurrent.Futures.immediateFuture;\n+import static java.nio.file.Files.newInputStream;\n+import static java.nio.file.Files.newOutputStream;\n+import static java.nio.file.StandardOpenOption.APPEND;\n+import static java.util.Objects.requireNonNull;\n+import static java.util.UUID.randomUUID;\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+\n+public class FileFragmentResultCacheManager\n+        implements FragmentResultCacheManager\n+{\n+    private static final Logger log = Logger.get(FileFragmentResultCacheManager.class);\n+\n+    private final Path baseDirectory;\n+    private final long maxInFlightBytes;\n+    private final PagesSerde pagesSerde;\n+    private final FragmentCacheStats fragmentCacheStats;\n+    private final ExecutorService flushExecutor;\n+    private final ExecutorService removalExecutor;\n+\n+    private final Cache<CacheKey, Path> cache;\n+\n+    // TODO: Decouple CacheKey by encoding PlanNode and SplitIdentifier separately so we don't have to keep too many objects in memory\n+    @Inject\n+    public FileFragmentResultCacheManager(\n+            FileFragmentResultCacheConfig cacheConfig,\n+            BlockEncodingSerde blockEncodingSerde,\n+            FragmentCacheStats fragmentCacheStats,\n+            ExecutorService flushExecutor,\n+            ExecutorService removalExecutor)\n+    {\n+        requireNonNull(cacheConfig, \"cacheConfig is null\");\n+        requireNonNull(blockEncodingSerde, \"blockEncodingSerde is null\");\n+\n+        this.baseDirectory = Paths.get(cacheConfig.getBaseDirectory());\n+        this.maxInFlightBytes = cacheConfig.getMaxInFlightSize().toBytes();\n+        this.pagesSerde = new PagesSerdeFactory(blockEncodingSerde, cacheConfig.isBlockEncodingCompressionEnabled()).createPagesSerde();\n+        this.fragmentCacheStats = requireNonNull(fragmentCacheStats, \"fragmentCacheStats is null\");\n+        this.flushExecutor = requireNonNull(flushExecutor, \"flushExecutor is null\");\n+        this.removalExecutor = requireNonNull(removalExecutor, \"removalExecutor is null\");\n+        this.cache = CacheBuilder.newBuilder()\n+                .maximumSize(cacheConfig.getMaxCachedEntries())\n+                .expireAfterAccess(cacheConfig.getCacheTtl().toMillis(), MILLISECONDS)\n+                .removalListener(new CacheRemovalListener())\n+                .recordStats()\n+                .build();\n+\n+        File target = new File(baseDirectory.toUri());\n+        if (!target.exists()) {\n+            try {\n+                Files.createDirectories(target.toPath());\n+            }\n+            catch (IOException e) {\n+                throw new PrestoException(GENERIC_INTERNAL_ERROR, \"cannot create cache directory \" + target, e);\n+            }\n+        }\n+        else {\n+            File[] files = target.listFiles();\n+            if (files == null) {\n+                return;\n+            }\n+\n+            this.removalExecutor.submit(() -> Arrays.stream(files).forEach(file -> {\n+                try {\n+                    Files.delete(file.toPath());\n+                }\n+                catch (IOException e) {\n+                    // ignore\n+                }\n+            }));\n+        }\n+    }\n+\n+    @Override\n+    public Future<?> put(CanonicalPlanFragment plan, Split split, List<Page> result)\n+    {\n+        CacheKey key = new CacheKey(plan, split.getSplitIdentifier());\n+        long resultSize = getPagesSize(result);\n+        if (fragmentCacheStats.getInFlightBytes() + resultSize > maxInFlightBytes || cache.getIfPresent(key) != null) {\n+            return immediateFuture(null);\n+        }\n+\n+        fragmentCacheStats.addInFlightBytes(resultSize);\n+        Path path = baseDirectory.resolve(randomUUID().toString().replaceAll(\"-\", \"_\"));\n+        return flushExecutor.submit(() -> cachePages(key, path, result));\n+    }\n+\n+    private static long getPagesSize(List<Page> pages)\n+    {\n+        return pages.stream()\n+                .mapToLong(Page::getSizeInBytes)\n+                .sum();\n+    }\n+\n+    private void cachePages(CacheKey key, Path path, List<Page> pages)\n+    {\n+        // TODO: To support both memory and disk limit, we should check cache size before putting to cache and use written bytes as weight for cache\n+        try {\n+            Files.createFile(path);\n+            try (SliceOutput output = new OutputStreamSliceOutput(newOutputStream(path, APPEND))) {\n+                writePages(pagesSerde, output, pages.iterator());\n+                cache.put(key, path);\n+            }\n+            catch (UncheckedIOException | IOException e) {\n+                log.warn(e, \"%s encountered an error while writing to path %s\", Thread.currentThread().getName(), path);\n+                tryDeleteFile(path);\n+            }\n+        }\n+        catch (UncheckedIOException | IOException e) {\n+            log.warn(e, \"%s encountered an error while writing to path %s\", Thread.currentThread().getName(), path);\n+            tryDeleteFile(path);\n+        }\n+        finally {\n+            fragmentCacheStats.addInFlightBytes(-getPagesSize(pages));\n+        }\n+    }\n+\n+    private static void tryDeleteFile(Path path)\n+    {\n+        try {\n+            File file = new File(path.toUri());\n+            if (file.exists()) {\n+                Files.delete(file.toPath());\n+            }\n+        }\n+        catch (IOException e) {\n+            // ignore\n+        }\n+    }\n+\n+    @Override\n+    public Optional<Iterator<Page>> get(CanonicalPlanFragment plan, Split split)\n+    {\n+        CacheKey key = new CacheKey(plan, split.getSplitIdentifier());\n+        Path path = cache.getIfPresent(key);\n+        if (path == null) {\n+            fragmentCacheStats.incrementCacheMiss();\n+            return Optional.empty();\n+        }\n+\n+        try {\n+            InputStream inputStream = newInputStream(path);\n+            Iterator<Page> result = readPages(pagesSerde, new InputStreamSliceInput(inputStream));\n+            fragmentCacheStats.incrementCacheHit();\n+            return Optional.of(closeWhenExhausted(result, inputStream));\n+        }\n+        catch (UncheckedIOException | IOException e) {\n+            // there might be a chance the file has been deleted. We would return cache miss in this case.\n+            fragmentCacheStats.incrementCacheMiss();\n+            return Optional.empty();\n+        }\n+    }\n+\n+    private static <T> Iterator<T> closeWhenExhausted(Iterator<T> iterator, Closeable resource)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f1ef09c90ee10f6ae23cb1f0a238d887fa8e328"}, "originalPosition": 208}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 106, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}