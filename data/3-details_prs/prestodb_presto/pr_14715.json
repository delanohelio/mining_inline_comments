{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM5MjUyNTUx", "number": 14715, "title": "Add session property to ignore table bucketing", "bodyText": "When table bucket count is not large enough, using such table count\nwon't achieve expected partitioning performance.\nIgnoring table bucketing makes it possible to use a larger bucket\ncount when needed, e.g., exchange materialization.\n\n== NO RELEASE NOTE ==", "createdAt": "2020-06-24T14:39:39Z", "url": "https://github.com/prestodb/presto/pull/14715", "merged": true, "mergeCommit": {"oid": "b89db16de87fed22b4413196c0ab78c16a1652fe"}, "closed": true, "closedAt": "2020-06-25T22:04:14Z", "author": {"login": "viczhang861"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcudgF_AFqTQzNjg1OTA1Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcuf0qxgBqjM0NzkxNjE0NjA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2ODU5MDU2", "url": "https://github.com/prestodb/presto/pull/14715#pullrequestreview-436859056", "createdAt": "2020-06-24T17:28:54Z", "commit": {"oid": "041e197572a908951aba2116d1ec7f0ee31916af"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2ODgxNTI3", "url": "https://github.com/prestodb/presto/pull/14715#pullrequestreview-436881527", "createdAt": "2020-06-24T17:59:24Z", "commit": {"oid": "041e197572a908951aba2116d1ec7f0ee31916af"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2OTA3MjM4", "url": "https://github.com/prestodb/presto/pull/14715#pullrequestreview-436907238", "createdAt": "2020-06-24T18:36:00Z", "commit": {"oid": "041e197572a908951aba2116d1ec7f0ee31916af"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQxODozNjowMFrOGoeWdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQxODo0MjoxNVrOGoejqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA5MzQ5NA==", "bodyText": "nit: Ignore table bucketing when the number of buckets is less than the value specified", "url": "https://github.com/prestodb/presto/pull/14715#discussion_r445093494", "createdAt": "2020-06-24T18:36:00Z", "author": {"login": "arhimondr"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSessionProperties.java", "diffHunk": "@@ -133,6 +134,11 @@ public HiveSessionProperties(HiveClientConfig hiveClientConfig, OrcFileWriterCon\n                         \"Ignore table bucketing to enable reading from unbucketed partitions\",\n                         hiveClientConfig.isIgnoreTableBucketing(),\n                         false),\n+                integerProperty(\n+                        MIN_BUCKET_COUNT_TO_NOT_IGNORE_TABLE_BUCKETING,\n+                        \"Ignore table bucketing when table bucket count is less than this session property\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "041e197572a908951aba2116d1ec7f0ee31916af"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA5NDAyMw==", "bodyText": "I think this description is extra", "url": "https://github.com/prestodb/presto/pull/14715#discussion_r445094023", "createdAt": "2020-06-24T18:36:56Z", "author": {"login": "arhimondr"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveClientConfig.java", "diffHunk": "@@ -1083,7 +1084,8 @@ public HiveClientConfig setSortedWritingEnabled(boolean sortedWritingEnabled)\n     }\n \n     @Config(\"hive.ignore-table-bucketing\")\n-    @ConfigDescription(\"Ignore table bucketing to allow reading from unbucketed partitions\")\n+    @ConfigDescription(\"Ignore table bucketing to allow reading from unbucketed partitions \" +\n+            \"only if table bucket count is not less than hive.min-bucket-count-to-not-ignore-table-bucketing\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "041e197572a908951aba2116d1ec7f0ee31916af"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA5NDYzMw==", "bodyText": "nit: Ignore table bucketing when the number of buckets is less than the value specified", "url": "https://github.com/prestodb/presto/pull/14715#discussion_r445094633", "createdAt": "2020-06-24T18:38:06Z", "author": {"login": "arhimondr"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveClientConfig.java", "diffHunk": "@@ -1095,6 +1097,20 @@ public boolean isIgnoreTableBucketing()\n         return ignoreTableBucketing;\n     }\n \n+    @Config(\"hive.min-bucket-count-to-not-ignore-table-bucketing\")\n+    @ConfigDescription(\"If table bucket count is less than this value, table bucketing is always ignored. \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "041e197572a908951aba2116d1ec7f0ee31916af"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA5NTMzMw==", "bodyText": "nit: How about minNumberOfBucketsForBucketedExecution\nCC: @aweisberg ?", "url": "https://github.com/prestodb/presto/pull/14715#discussion_r445095333", "createdAt": "2020-06-24T18:39:28Z", "author": {"login": "arhimondr"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveClientConfig.java", "diffHunk": "@@ -131,6 +131,7 @@\n     private boolean bucketExecutionEnabled = true;\n     private boolean sortedWritingEnabled = true;\n     private boolean ignoreTableBucketing;\n+    private int minBucketCountToNotIgnoreTableBucketing;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "041e197572a908951aba2116d1ec7f0ee31916af"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA5NTY2NA==", "bodyText": "This is not used", "url": "https://github.com/prestodb/presto/pull/14715#discussion_r445095664", "createdAt": "2020-06-24T18:40:06Z", "author": {"login": "arhimondr"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePartitionManager.java", "diffHunk": "@@ -74,6 +75,7 @@\n     private final TypeManager typeManager;\n     private final int maxPartitionsPerScan;\n     private final int domainCompactionThreshold;\n+    private final int minBucketCountToNotIgnoreTableBucketing;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "041e197572a908951aba2116d1ec7f0ee31916af"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA5NjY3Nw==", "bodyText": "nit: how about simply getBucketHandle?", "url": "https://github.com/prestodb/presto/pull/14715#discussion_r445096677", "createdAt": "2020-06-24T18:41:55Z", "author": {"login": "arhimondr"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePartitionManager.java", "diffHunk": "@@ -247,6 +250,26 @@ public HivePartitionResult getPartitions(SemiTransactionalHiveMetastore metastor\n                 bucketFilter);\n     }\n \n+    private Optional<HiveBucketHandle> getBucketHandleIfNotIgnoreTableBucketing(Table table, ConnectorSession session)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "041e197572a908951aba2116d1ec7f0ee31916af"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA5Njg3Mg==", "bodyText": "You can use Optional.map", "url": "https://github.com/prestodb/presto/pull/14715#discussion_r445096872", "createdAt": "2020-06-24T18:42:15Z", "author": {"login": "arhimondr"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePartitionManager.java", "diffHunk": "@@ -192,10 +197,8 @@ public HivePartitionResult getPartitions(SemiTransactionalHiveMetastore metastor\n \n         List<HivePartition> partitions = getPartitionsAsList(getPartitionsIterator(metastore, tableHandle, constraint, session).iterator());\n \n-        // never ignore table bucketing for temporary tables as those are created such explicitly by the engine request\n-        boolean shouldIgnoreTableBucketing = !table.getTableType().equals(TEMPORARY_TABLE) && shouldIgnoreTableBucketing(session);\n-        Optional<HiveBucketHandle> hiveBucketHandle = shouldIgnoreTableBucketing ? Optional.empty() : getHiveBucketHandle(table);\n-        Optional<HiveBucketFilter> bucketFilter = shouldIgnoreTableBucketing ? Optional.empty() : getHiveBucketFilter(table, effectivePredicate);\n+        Optional<HiveBucketHandle> hiveBucketHandle = getBucketHandleIfNotIgnoreTableBucketing(table, session);\n+        Optional<HiveBucketFilter> bucketFilter = hiveBucketHandle.isPresent() ? getHiveBucketFilter(table, effectivePredicate) : Optional.empty();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "041e197572a908951aba2116d1ec7f0ee31916af"}, "originalPosition": 53}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d43fb6a1e3e296fdc18cbf5f39f04e0113afdca3", "author": {"user": {"login": "viczhang861", "name": "Vic Zhang"}}, "url": "https://github.com/prestodb/presto/commit/d43fb6a1e3e296fdc18cbf5f39f04e0113afdca3", "committedDate": "2020-06-24T20:05:13Z", "message": "Add session property to ignore table bucketing\n\n - When table bucket count is not large enough, using such table count\n   won't achieve expected partitioning performance.\n - Ignoring table bucketing makes it possible to use a larger bucket\n   count when needed, e.g., exchange materialization."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "041e197572a908951aba2116d1ec7f0ee31916af", "author": {"user": {"login": "viczhang861", "name": "Vic Zhang"}}, "url": "https://github.com/prestodb/presto/commit/041e197572a908951aba2116d1ec7f0ee31916af", "committedDate": "2020-06-24T14:36:28Z", "message": "Add session property to ignore table bucketing\n\n - When table bucket count is not large enough, using such table count\n   won't achieve expected partitioning performance.\n - Ignoring table bucketing makes it possible to use a larger bucket\n   count when needed, e.g., exchange materialization."}, "afterCommit": {"oid": "d43fb6a1e3e296fdc18cbf5f39f04e0113afdca3", "author": {"user": {"login": "viczhang861", "name": "Vic Zhang"}}, "url": "https://github.com/prestodb/presto/commit/d43fb6a1e3e296fdc18cbf5f39f04e0113afdca3", "committedDate": "2020-06-24T20:05:13Z", "message": "Add session property to ignore table bucketing\n\n - When table bucket count is not large enough, using such table count\n   won't achieve expected partitioning performance.\n - Ignoring table bucketing makes it possible to use a larger bucket\n   count when needed, e.g., exchange materialization."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1475, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}