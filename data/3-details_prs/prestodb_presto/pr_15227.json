{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkzNDY1NDUz", "number": 15227, "title": "Optimize MetadataQueryOptimizer with filter pushdown enabled", "bodyText": "Test plan - Unit test + verifier run on internal queries\n== RELEASE NOTES ==\n\nHive Changes\n* Optimize metadata query optimizer so that it does not fetch all partitions from metastore when hive filter pushdown is enabled.", "createdAt": "2020-09-26T01:37:33Z", "url": "https://github.com/prestodb/presto/pull/15227", "merged": true, "mergeCommit": {"oid": "4de1f4d1a6c34aafa7d6fe0b6197d0e7c3e9364a"}, "closed": true, "closedAt": "2020-10-09T00:51:25Z", "author": {"login": "shixuan-fan"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdMivgHgBqjM4MTAxMDE4NjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdQnF7oABqjM4NTcxMjA1OTY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8f25a195f87a404190cf60dc2d98c3fb53f6069f", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/8f25a195f87a404190cf60dc2d98c3fb53f6069f", "committedDate": "2020-09-26T01:37:06Z", "message": "Move metadata query optimizer after connector optimizers"}, "afterCommit": {"oid": "07a5b997a3a08786a0beea3b1b02715291503820", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/07a5b997a3a08786a0beea3b1b02715291503820", "committedDate": "2020-09-26T04:32:50Z", "message": "Move metadata query optimizer after connector optimizers"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "07a5b997a3a08786a0beea3b1b02715291503820", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/07a5b997a3a08786a0beea3b1b02715291503820", "committedDate": "2020-09-26T04:32:50Z", "message": "Move metadata query optimizer after connector optimizers"}, "afterCommit": {"oid": "c1d9a7a5c43f02cd070d37742ebd80475363c745", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/c1d9a7a5c43f02cd070d37742ebd80475363c745", "committedDate": "2020-09-26T04:38:16Z", "message": "Move metadata query optimizer after connector optimizers"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c1d9a7a5c43f02cd070d37742ebd80475363c745", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/c1d9a7a5c43f02cd070d37742ebd80475363c745", "committedDate": "2020-09-26T04:38:16Z", "message": "Move metadata query optimizer after connector optimizers"}, "afterCommit": {"oid": "fcb363fd2bc9168899481397868bfc737bc02acb", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/fcb363fd2bc9168899481397868bfc737bc02acb", "committedDate": "2020-09-28T18:35:32Z", "message": "Move metadata query optimizer after connector optimizers"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fcb363fd2bc9168899481397868bfc737bc02acb", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/fcb363fd2bc9168899481397868bfc737bc02acb", "committedDate": "2020-09-28T18:35:32Z", "message": "Move metadata query optimizer after connector optimizers"}, "afterCommit": {"oid": "9409b48893f1e133f36af8d595cf407e807c000a", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/9409b48893f1e133f36af8d595cf407e807c000a", "committedDate": "2020-09-28T20:53:59Z", "message": "Move metadata query optimizer after connector optimizers"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9409b48893f1e133f36af8d595cf407e807c000a", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/9409b48893f1e133f36af8d595cf407e807c000a", "committedDate": "2020-09-28T20:53:59Z", "message": "Move metadata query optimizer after connector optimizers"}, "afterCommit": {"oid": "86a3ceacfb013eea3027f89ecc3018c1a3b0bc0d", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/86a3ceacfb013eea3027f89ecc3018c1a3b0bc0d", "committedDate": "2020-09-29T21:34:10Z", "message": "Move metadata query optimizer after connector optimizers"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "86a3ceacfb013eea3027f89ecc3018c1a3b0bc0d", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/86a3ceacfb013eea3027f89ecc3018c1a3b0bc0d", "committedDate": "2020-09-29T21:34:10Z", "message": "Move metadata query optimizer after connector optimizers"}, "afterCommit": {"oid": "c7d1e1b9e0f54241655930e20a4c3fb0c98af439", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/c7d1e1b9e0f54241655930e20a4c3fb0c98af439", "committedDate": "2020-10-06T01:15:45Z", "message": "Fix metadata query optimizer with filter pushdown"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c7d1e1b9e0f54241655930e20a4c3fb0c98af439", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/c7d1e1b9e0f54241655930e20a4c3fb0c98af439", "committedDate": "2020-10-06T01:15:45Z", "message": "Fix metadata query optimizer with filter pushdown"}, "afterCommit": {"oid": "a321291922d8937bd5ccc7bf663f291d86288721", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/a321291922d8937bd5ccc7bf663f291d86288721", "committedDate": "2020-10-06T01:16:36Z", "message": "Optimize MetadataQueryOptimizer with filter pushdown enabled\n\nWhen hive.pushdown_filter_enabled is true, TableScanNode would\nnot be aware of table layout until connector plan optimizer finished\none pass. This would lead to inefficiency in MetadataQueryOptimizer\nas it would try to get all the partitions of the table.\n\nTo optimize it, we moved MetadataQueryOptimizer after first connector\nquery optimizer run, and fixed the optimizer so it could adapt to\nthe layout after filter pushdown."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyNTcwMzk5", "url": "https://github.com/prestodb/presto/pull/15227#pullrequestreview-502570399", "createdAt": "2020-10-06T04:11:39Z", "commit": {"oid": "a321291922d8937bd5ccc7bf663f291d86288721"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyNjIxNzA3", "url": "https://github.com/prestodb/presto/pull/15227#pullrequestreview-502621707", "createdAt": "2020-10-06T06:37:20Z", "commit": {"oid": "a321291922d8937bd5ccc7bf663f291d86288721"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a321291922d8937bd5ccc7bf663f291d86288721", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/a321291922d8937bd5ccc7bf663f291d86288721", "committedDate": "2020-10-06T01:16:36Z", "message": "Optimize MetadataQueryOptimizer with filter pushdown enabled\n\nWhen hive.pushdown_filter_enabled is true, TableScanNode would\nnot be aware of table layout until connector plan optimizer finished\none pass. This would lead to inefficiency in MetadataQueryOptimizer\nas it would try to get all the partitions of the table.\n\nTo optimize it, we moved MetadataQueryOptimizer after first connector\nquery optimizer run, and fixed the optimizer so it could adapt to\nthe layout after filter pushdown."}, "afterCommit": {"oid": "64b68873c3d4e4d7dd2c9ba51af181d2451a418f", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/64b68873c3d4e4d7dd2c9ba51af181d2451a418f", "committedDate": "2020-10-06T19:00:47Z", "message": "Optimize MetadataQueryOptimizer with filter pushdown enabled\n\nWhen hive.pushdown_filter_enabled is true, TableScanNode would\nnot be aware of table layout until connector plan optimizer finished\none pass. This would lead to inefficiency in MetadataQueryOptimizer\nas it would try to get all the partitions of the table.\n\nTo optimize it, we moved MetadataQueryOptimizer after first connector\nquery optimizer run, and fixed the optimizer so it could adapt to\nthe layout after filter pushdown."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "64b68873c3d4e4d7dd2c9ba51af181d2451a418f", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/64b68873c3d4e4d7dd2c9ba51af181d2451a418f", "committedDate": "2020-10-06T19:00:47Z", "message": "Optimize MetadataQueryOptimizer with filter pushdown enabled\n\nWhen hive.pushdown_filter_enabled is true, TableScanNode would\nnot be aware of table layout until connector plan optimizer finished\none pass. This would lead to inefficiency in MetadataQueryOptimizer\nas it would try to get all the partitions of the table.\n\nTo optimize it, we moved MetadataQueryOptimizer after first connector\nquery optimizer run, and fixed the optimizer so it could adapt to\nthe layout after filter pushdown."}, "afterCommit": {"oid": "bb10720302b9e07d9fa53adab8c3489763a9097d", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/bb10720302b9e07d9fa53adab8c3489763a9097d", "committedDate": "2020-10-06T22:57:04Z", "message": "Optimize MetadataQueryOptimizer with filter pushdown enabled\n\nWhen hive.pushdown_filter_enabled is true, TableScanNode would\nnot be aware of table layout until connector plan optimizer finished\none pass. This would lead to inefficiency in MetadataQueryOptimizer\nas it would try to get all the partitions of the table.\n\nTo optimize it, we moved MetadataQueryOptimizer after first connector\nquery optimizer run, and fixed the optimizer so it could adapt to\nthe layout after filter pushdown."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0MzU5ODQy", "url": "https://github.com/prestodb/presto/pull/15227#pullrequestreview-504359842", "createdAt": "2020-10-08T00:46:11Z", "commit": {"oid": "bd0111e3bb27f3ac6404c812461fea80790b4fe0"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwMDo0NjoxMVrOHeKTpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwMDo0NjoxMVrOHeKTpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM4ODE5OA==", "bodyText": "actually, why not toStringUtf8?", "url": "https://github.com/prestodb/presto/pull/15227#discussion_r501388198", "createdAt": "2020-10-08T00:46:11Z", "author": {"login": "highker"}, "path": "presto-main/src/test/java/com/facebook/presto/sql/planner/assertions/ValuesMatcher.java", "diffHunk": "@@ -91,12 +94,12 @@ public MatchResult detailMatches(PlanNode node, StatsProvider stats, Session ses\n                                 return new DoubleLiteral(String.valueOf(expression.getValue()));\n                             }\n                             if (expression.getType().getJavaType() == Slice.class) {\n-                                return new StringLiteral(String.valueOf(expression.getValue()));\n+                                return new StringLiteral(((Slice) expression.getValue()).toStringAscii());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd0111e3bb27f3ac6404c812461fea80790b4fe0"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "052d1bf1343c45cae37379c847079b9711ca40f8", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/052d1bf1343c45cae37379c847079b9711ca40f8", "committedDate": "2020-10-08T17:31:18Z", "message": "Fix ValuesMatcher\n\n- Fix StringLiteral generation by creating string instead of using\ntoString value of Slice, which only includes base/address/length.\n- Use Set instead of List for expected rows. The row sequence does not\nimpact correctness."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bb10720302b9e07d9fa53adab8c3489763a9097d", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/bb10720302b9e07d9fa53adab8c3489763a9097d", "committedDate": "2020-10-06T22:57:04Z", "message": "Optimize MetadataQueryOptimizer with filter pushdown enabled\n\nWhen hive.pushdown_filter_enabled is true, TableScanNode would\nnot be aware of table layout until connector plan optimizer finished\none pass. This would lead to inefficiency in MetadataQueryOptimizer\nas it would try to get all the partitions of the table.\n\nTo optimize it, we moved MetadataQueryOptimizer after first connector\nquery optimizer run, and fixed the optimizer so it could adapt to\nthe layout after filter pushdown."}, "afterCommit": {"oid": "ba9e9def467e5adf9ea1feafedbcc5cc9baf6a59", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/ba9e9def467e5adf9ea1feafedbcc5cc9baf6a59", "committedDate": "2020-10-08T17:31:22Z", "message": "Optimize MetadataQueryOptimizer with filter pushdown enabled\n\nWhen hive.pushdown_filter_enabled is true, TableScanNode would\nnot be aware of table layout until connector plan optimizer finished\none pass. This would lead to inefficiency in MetadataQueryOptimizer\nas it would try to get all the partitions of the table.\n\nTo optimize it, we moved MetadataQueryOptimizer after first connector\nquery optimizer run, and fixed the optimizer so it could adapt to\nthe layout after filter pushdown."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e7cd7c099c1207fdda2150ba45303f175e703a6", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/7e7cd7c099c1207fdda2150ba45303f175e703a6", "committedDate": "2020-10-08T19:52:40Z", "message": "Optimize MetadataQueryOptimizer with filter pushdown enabled\n\nWhen hive.pushdown_filter_enabled is true, TableScanNode would\nnot be aware of table layout until connector plan optimizer finished\none pass. This would lead to inefficiency in MetadataQueryOptimizer\nas it would try to get all the partitions of the table.\n\nTo optimize it, we moved MetadataQueryOptimizer after first connector\nquery optimizer run, and fixed the optimizer so it could adapt to\nthe layout after filter pushdown."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ba9e9def467e5adf9ea1feafedbcc5cc9baf6a59", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/ba9e9def467e5adf9ea1feafedbcc5cc9baf6a59", "committedDate": "2020-10-08T17:31:22Z", "message": "Optimize MetadataQueryOptimizer with filter pushdown enabled\n\nWhen hive.pushdown_filter_enabled is true, TableScanNode would\nnot be aware of table layout until connector plan optimizer finished\none pass. This would lead to inefficiency in MetadataQueryOptimizer\nas it would try to get all the partitions of the table.\n\nTo optimize it, we moved MetadataQueryOptimizer after first connector\nquery optimizer run, and fixed the optimizer so it could adapt to\nthe layout after filter pushdown."}, "afterCommit": {"oid": "7e7cd7c099c1207fdda2150ba45303f175e703a6", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/7e7cd7c099c1207fdda2150ba45303f175e703a6", "committedDate": "2020-10-08T19:52:40Z", "message": "Optimize MetadataQueryOptimizer with filter pushdown enabled\n\nWhen hive.pushdown_filter_enabled is true, TableScanNode would\nnot be aware of table layout until connector plan optimizer finished\none pass. This would lead to inefficiency in MetadataQueryOptimizer\nas it would try to get all the partitions of the table.\n\nTo optimize it, we moved MetadataQueryOptimizer after first connector\nquery optimizer run, and fixed the optimizer so it could adapt to\nthe layout after filter pushdown."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4798, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}