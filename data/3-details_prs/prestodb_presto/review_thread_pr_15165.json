{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg1OTc2MDIz", "number": 15165, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxOTozNTowOFrOEkNk4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOVQwNDoxODowMlrOElKwrA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2NDA2NjI2OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePageSourceProvider.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxOTozNTowOFrOHTBY5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwNzo0NzoyMlrOHUB3yQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcwNzc0OQ==", "bodyText": "get confuse here. if hiveColumns only have one AGGREGATED column, is it valid?", "url": "https://github.com/prestodb/presto/pull/15165#discussion_r489707749", "createdAt": "2020-09-16T19:35:08Z", "author": {"login": "zhenxiao"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePageSourceProvider.java", "diffHunk": "@@ -422,6 +422,10 @@ protected static CacheQuota generateCacheQuota(HiveSplit hiveSplit)\n             }\n         }\n \n+        if (!hiveColumns.isEmpty() && hiveColumns.get(0).getColumnType() == AGGREGATED) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c8600e19b9a8f2ea15dcd1e29185fa977380c8b4"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU5Njk0NA==", "bodyText": "Either all columns are aggregate or none is. So we just check the first", "url": "https://github.com/prestodb/presto/pull/15165#discussion_r490596944", "createdAt": "2020-09-17T22:28:59Z", "author": {"login": "ClarenceThreepwood"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePageSourceProvider.java", "diffHunk": "@@ -422,6 +422,10 @@ protected static CacheQuota generateCacheQuota(HiveSplit hiveSplit)\n             }\n         }\n \n+        if (!hiveColumns.isEmpty() && hiveColumns.get(0).getColumnType() == AGGREGATED) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcwNzc0OQ=="}, "originalCommit": {"oid": "c8600e19b9a8f2ea15dcd1e29185fa977380c8b4"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY3MDQ5Mw==", "bodyText": "get it. shall we use allMatch to make sure all are AGGREGATED?\nI think we also need to update the message", "url": "https://github.com/prestodb/presto/pull/15165#discussion_r490670493", "createdAt": "2020-09-18T02:52:11Z", "author": {"login": "zhenxiao"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePageSourceProvider.java", "diffHunk": "@@ -422,6 +422,10 @@ protected static CacheQuota generateCacheQuota(HiveSplit hiveSplit)\n             }\n         }\n \n+        if (!hiveColumns.isEmpty() && hiveColumns.get(0).getColumnType() == AGGREGATED) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcwNzc0OQ=="}, "originalCommit": {"oid": "c8600e19b9a8f2ea15dcd1e29185fa977380c8b4"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc2NDIzMw==", "bodyText": "Converted to allMatch. What is your suggestion for error message? It reads ok to me", "url": "https://github.com/prestodb/presto/pull/15165#discussion_r490764233", "createdAt": "2020-09-18T07:47:22Z", "author": {"login": "ClarenceThreepwood"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePageSourceProvider.java", "diffHunk": "@@ -422,6 +422,10 @@ protected static CacheQuota generateCacheQuota(HiveSplit hiveSplit)\n             }\n         }\n \n+        if (!hiveColumns.isEmpty() && hiveColumns.get(0).getColumnType() == AGGREGATED) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcwNzc0OQ=="}, "originalCommit": {"oid": "c8600e19b9a8f2ea15dcd1e29185fa977380c8b4"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2NDA2NzcyOnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePartialAggregationPushdown.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxOTozNTozNlrOHTBZ1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxOTozNTozNlrOHTBZ1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcwNzk4OA==", "bodyText": "static import ORC and PARQUET", "url": "https://github.com/prestodb/presto/pull/15165#discussion_r489707988", "createdAt": "2020-09-16T19:35:36Z", "author": {"login": "zhenxiao"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePartialAggregationPushdown.java", "diffHunk": "@@ -125,8 +122,31 @@ public Visitor(VariableAllocator variableAllocator, ConnectorSession session, Pl\n             this.variableAllocator = variableAllocator;\n         }\n \n-        private boolean isAggregationPushdownSupported(AggregationNode partialAggregationNode, HiveStorageFormat hiveStorageFormat)\n+        private boolean isAggregationPushdownSupported(AggregationNode partialAggregationNode)\n         {\n+            if (partialAggregationNode.hasNonEmptyGroupingSet()) {\n+                return false;\n+            }\n+\n+            TableScanNode tableScanNode = (TableScanNode) partialAggregationNode.getSource();\n+            ConnectorTableMetadata connectorTableMetadata = metadataFactory.get().getTableMetadata(session, tableScanNode.getTable().getConnectorHandle());\n+            Optional<Object> rawFormat = Optional.ofNullable(connectorTableMetadata.getProperties().get(HiveTableProperties.STORAGE_FORMAT_PROPERTY));\n+            if (!rawFormat.isPresent()) {\n+                return false;\n+            }\n+\n+            final HiveStorageFormat hiveStorageFormat = HiveStorageFormat.valueOf(rawFormat.get().toString());\n+            if (hiveStorageFormat != HiveStorageFormat.ORC && hiveStorageFormat != HiveStorageFormat.PARQUET) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c8600e19b9a8f2ea15dcd1e29185fa977380c8b4"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2NDA3MjQ2OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/orc/AggregatedOrcPageSource.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxOTozNjo1OVrOHTBc4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxOTozNjo1OVrOHTBc4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcwODc3MQ==", "bodyText": "s/noMinMaxMessage/OrcNoMinMaxMessage/g", "url": "https://github.com/prestodb/presto/pull/15165#discussion_r489708771", "createdAt": "2020-09-16T19:36:59Z", "author": {"login": "zhenxiao"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/orc/AggregatedOrcPageSource.java", "diffHunk": "@@ -138,13 +138,14 @@ private void writeMinMax(int columnIndex, Type type, HiveType hiveType, BlockBui\n             completedBytes += ((FixedWidthType) type).getFixedSize();\n         }\n \n+        String noMinMaxMessage = \"No min/max found for orc file. Set session property hive.pushdown_partial_aggregations_into_scan=false and execute query again\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c8600e19b9a8f2ea15dcd1e29185fa977380c8b4"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2NDA4MDg2OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/test/java/com/facebook/presto/hive/TestHivePushdownFilterQueries.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxOTozOTozMlrOHTBiTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwMjo1Mzo0NFrOHT8LAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcxMDE1Ng==", "bodyText": "test_file_format_orc is Orc table, right? why partial aggregation pushdown now supported?", "url": "https://github.com/prestodb/presto/pull/15165#discussion_r489710156", "createdAt": "2020-09-16T19:39:32Z", "author": {"login": "zhenxiao"}, "path": "presto-hive/src/test/java/com/facebook/presto/hive/TestHivePushdownFilterQueries.java", "diffHunk": "@@ -1034,7 +1039,8 @@ private void assertFileFormat(HiveStorageFormat storageFormat)\n             // no filter\n             assertQueryUsingH2Cte(\"SELECT * FROM test_file_format_orc\", cte);\n             assertQueryUsingH2Cte(\"SELECT comment FROM test_file_format_orc\", cte);\n-            assertQueryUsingH2Cte(\"SELECT COUNT(*) FROM test_file_format_orc\", cte);\n+            assertQueryFails(\"SELECT COUNT(*) FROM test_file_format_orc\", \"Partial aggregation pushdown only supported for ORC/Parquet files. Set session property hive.pushdown_partial_aggregations_into_scan=false and execute query again\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c8600e19b9a8f2ea15dcd1e29185fa977380c8b4"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU5ODEyMw==", "bodyText": "The table is defined as orc - but the files are in RC or text. Surprisingly Presto supports this use case - but we cannot perform partial agg pushdown on all formats so we throw an error here", "url": "https://github.com/prestodb/presto/pull/15165#discussion_r490598123", "createdAt": "2020-09-17T22:31:58Z", "author": {"login": "ClarenceThreepwood"}, "path": "presto-hive/src/test/java/com/facebook/presto/hive/TestHivePushdownFilterQueries.java", "diffHunk": "@@ -1034,7 +1039,8 @@ private void assertFileFormat(HiveStorageFormat storageFormat)\n             // no filter\n             assertQueryUsingH2Cte(\"SELECT * FROM test_file_format_orc\", cte);\n             assertQueryUsingH2Cte(\"SELECT comment FROM test_file_format_orc\", cte);\n-            assertQueryUsingH2Cte(\"SELECT COUNT(*) FROM test_file_format_orc\", cte);\n+            assertQueryFails(\"SELECT COUNT(*) FROM test_file_format_orc\", \"Partial aggregation pushdown only supported for ORC/Parquet files. Set session property hive.pushdown_partial_aggregations_into_scan=false and execute query again\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcxMDE1Ng=="}, "originalCommit": {"oid": "c8600e19b9a8f2ea15dcd1e29185fa977380c8b4"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY3MDg0OA==", "bodyText": "ah... maybe add a comment, describe the case?", "url": "https://github.com/prestodb/presto/pull/15165#discussion_r490670848", "createdAt": "2020-09-18T02:53:44Z", "author": {"login": "zhenxiao"}, "path": "presto-hive/src/test/java/com/facebook/presto/hive/TestHivePushdownFilterQueries.java", "diffHunk": "@@ -1034,7 +1039,8 @@ private void assertFileFormat(HiveStorageFormat storageFormat)\n             // no filter\n             assertQueryUsingH2Cte(\"SELECT * FROM test_file_format_orc\", cte);\n             assertQueryUsingH2Cte(\"SELECT comment FROM test_file_format_orc\", cte);\n-            assertQueryUsingH2Cte(\"SELECT COUNT(*) FROM test_file_format_orc\", cte);\n+            assertQueryFails(\"SELECT COUNT(*) FROM test_file_format_orc\", \"Partial aggregation pushdown only supported for ORC/Parquet files. Set session property hive.pushdown_partial_aggregations_into_scan=false and execute query again\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcxMDE1Ng=="}, "originalCommit": {"oid": "c8600e19b9a8f2ea15dcd1e29185fa977380c8b4"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3MDE3Nzc3OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/rcfile/RcFilePageSourceFactory.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwMjo1Mjo0N1rOHT8KJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwMjo1Mjo0N1rOHT8KJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY3MDYyOQ==", "bodyText": "same", "url": "https://github.com/prestodb/presto/pull/15165#discussion_r490670629", "createdAt": "2020-09-18T02:52:47Z", "author": {"login": "zhenxiao"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/rcfile/RcFilePageSourceFactory.java", "diffHunk": "@@ -110,6 +111,10 @@ public RcFilePageSourceFactory(TypeManager typeManager, HdfsEnvironment hdfsEnvi\n             HiveFileContext hiveFileContext,\n             Optional<EncryptionInformation> encryptionInformation)\n     {\n+        if (!columns.isEmpty() && columns.get(0).getColumnType() == AGGREGATED) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eaf291752fff567c9a7a8c5ef5c4e113103903cd"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3NDA5MDY4OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePageSourceProvider.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOVQwNDoxODowMlrOHUgi0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMFQwMzozMzozNlrOHU3xEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTI2Njc3MA==", "bodyText": "if all column handles are AGGREGATED, we should not enter HivePageSourceProvider, right?\nHow about use checkState, with error message like:\nInvalid processing state. Partial aggregation should be processed in AggregatedParquetPageSource or AggregatedOrcPageSource", "url": "https://github.com/prestodb/presto/pull/15165#discussion_r491266770", "createdAt": "2020-09-19T04:18:02Z", "author": {"login": "zhenxiao"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePageSourceProvider.java", "diffHunk": "@@ -422,6 +422,10 @@ protected static CacheQuota generateCacheQuota(HiveSplit hiveSplit)\n             }\n         }\n \n+        if (!hiveColumns.isEmpty() && hiveColumns.stream().allMatch(hiveColumnHandle -> hiveColumnHandle.getColumnType() == AGGREGATED)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17f6ca0015bf541385a2bbf31fbdb2ecc5c23b5e"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTQ4MTY5MA==", "bodyText": "Right - this error can happen when the metadata defines the table as orc/parquet, but there is at least one file that is in text/rc format. This is potentially a user-facing error message and I wouldn't expect a user to know about AggregatedParquetPageSource or AggregatedOrcPageSource. IMO it makes more sense to point out that the file format here is not supported and suggest one way to work around this. Let me know if you disagree", "url": "https://github.com/prestodb/presto/pull/15165#discussion_r491481690", "createdAt": "2020-09-19T18:40:16Z", "author": {"login": "ClarenceThreepwood"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePageSourceProvider.java", "diffHunk": "@@ -422,6 +422,10 @@ protected static CacheQuota generateCacheQuota(HiveSplit hiveSplit)\n             }\n         }\n \n+        if (!hiveColumns.isEmpty() && hiveColumns.stream().allMatch(hiveColumnHandle -> hiveColumnHandle.getColumnType() == AGGREGATED)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTI2Njc3MA=="}, "originalCommit": {"oid": "17f6ca0015bf541385a2bbf31fbdb2ecc5c23b5e"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTY0NzI1MA==", "bodyText": "get it. how about some error message like:\ntable $table input format is: $inputformat, but this file is: $filetype", "url": "https://github.com/prestodb/presto/pull/15165#discussion_r491647250", "createdAt": "2020-09-20T03:33:36Z", "author": {"login": "zhenxiao"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePageSourceProvider.java", "diffHunk": "@@ -422,6 +422,10 @@ protected static CacheQuota generateCacheQuota(HiveSplit hiveSplit)\n             }\n         }\n \n+        if (!hiveColumns.isEmpty() && hiveColumns.stream().allMatch(hiveColumnHandle -> hiveColumnHandle.getColumnType() == AGGREGATED)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTI2Njc3MA=="}, "originalCommit": {"oid": "17f6ca0015bf541385a2bbf31fbdb2ecc5c23b5e"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3656, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}