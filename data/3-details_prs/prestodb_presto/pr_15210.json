{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkxMjA1MTYx", "number": 15210, "title": "Report peak task memory in Presto-on-Spark", "bodyText": "The peak memory stats in TaskContext only get updated when\nTaskContext::getTaskStats(). Presto-on-Spark doesn't pull task stats\nactively so it needs to be updated explicitly.\n\n\nTest plan - Unit test. Also do production query test.\n\nNote in the Presto-on-Spark context, \"peak total memory\" really mean \"sum of peak task memory\"\n== NO RELEASE NOTE ==", "createdAt": "2020-09-22T21:28:30Z", "url": "https://github.com/prestodb/presto/pull/15210", "merged": true, "mergeCommit": {"oid": "6b97e58656d7c102dce0649eb41128bad7634562"}, "closed": true, "closedAt": "2020-09-25T21:11:55Z", "author": {"login": "wenleix"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLgUqaABqjM3OTU1MTU5NTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdMO6E9ABqjM4MDYwNjE4NzI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e777daa3a58b853c34f2a45c79d702fb59058e01", "author": {"user": {"login": "wenleix", "name": "Wenlei Xie"}}, "url": "https://github.com/prestodb/presto/commit/e777daa3a58b853c34f2a45c79d702fb59058e01", "committedDate": "2020-09-22T19:42:26Z", "message": "Update peak memory in TaskContext for Presto-on-Spark task\n\nThe peak memory stats in TaskContext only get updated when\nTaskContext::getTaskStats(). Presto-on-Spark doesn't pull task stats\nactively so it needs to be updated explicitly."}, "afterCommit": {"oid": "d0d38fd312a7f5fc7714bc89514b094fcffd1aa6", "author": {"user": {"login": "wenleix", "name": "Wenlei Xie"}}, "url": "https://github.com/prestodb/presto/commit/d0d38fd312a7f5fc7714bc89514b094fcffd1aa6", "committedDate": "2020-09-22T23:09:37Z", "message": "Update peak memory in TaskContext for Presto-on-Spark task\n\nThe peak memory stats in TaskContext only get updated when\nTaskContext::getTaskStats(). Presto-on-Spark doesn't pull task stats\nactively so it needs to be updated explicitly."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d0d38fd312a7f5fc7714bc89514b094fcffd1aa6", "author": {"user": {"login": "wenleix", "name": "Wenlei Xie"}}, "url": "https://github.com/prestodb/presto/commit/d0d38fd312a7f5fc7714bc89514b094fcffd1aa6", "committedDate": "2020-09-22T23:09:37Z", "message": "Update peak memory in TaskContext for Presto-on-Spark task\n\nThe peak memory stats in TaskContext only get updated when\nTaskContext::getTaskStats(). Presto-on-Spark doesn't pull task stats\nactively so it needs to be updated explicitly."}, "afterCommit": {"oid": "112306ba775cffefaa516e49e7487d5a490bde3d", "author": {"user": {"login": "wenleix", "name": "Wenlei Xie"}}, "url": "https://github.com/prestodb/presto/commit/112306ba775cffefaa516e49e7487d5a490bde3d", "committedDate": "2020-09-22T23:12:21Z", "message": "Update peak memory in TaskContext for Presto-on-Spark task\n\nThe peak memory stats in TaskContext only get updated when\nTaskContext::getTaskStats(). Presto-on-Spark doesn't pull task stats\nactively so it needs to be updated explicitly."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MDIyMDU0", "url": "https://github.com/prestodb/presto/pull/15210#pullrequestreview-495022054", "createdAt": "2020-09-23T20:27:07Z", "commit": {"oid": "112306ba775cffefaa516e49e7487d5a490bde3d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QyMDoyNzowN1rOHW_tLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QyMDoyNzowN1rOHW_tLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg3NDQ3OA==", "bodyText": "We can also make taskContext itself to refresh the peak memory usage periodically. What do you think? @arhimondr , @tdcmeehan ?", "url": "https://github.com/prestodb/presto/pull/15210#discussion_r493874478", "createdAt": "2020-09-23T20:27:07Z", "author": {"login": "wenleix"}, "path": "presto-spark-base/src/main/java/com/facebook/presto/spark/execution/PrestoSparkTaskExecution.java", "diffHunk": "@@ -138,6 +141,9 @@ public PrestoSparkTaskExecution(\n                 \"Fragment is partitioned, but not all partitioned drivers were found\");\n \n         taskHandle = createTaskHandle(taskStateMachine, taskContext, localExecutionPlan, taskExecutor);\n+\n+        requireNonNull(memoryUpdateExecutor, \"memoryUpdateExecutorService is null\");\n+        memoryUpdateExecutor.schedule(taskContext::updatePeakMemory, 5, SECONDS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "112306ba775cffefaa516e49e7487d5a490bde3d"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1NjE5MTU1", "url": "https://github.com/prestodb/presto/pull/15210#pullrequestreview-495619155", "createdAt": "2020-09-24T14:14:30Z", "commit": {"oid": "112306ba775cffefaa516e49e7487d5a490bde3d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1NzQ5Nzkx", "url": "https://github.com/prestodb/presto/pull/15210#pullrequestreview-495749791", "createdAt": "2020-09-24T16:29:25Z", "commit": {"oid": "112306ba775cffefaa516e49e7487d5a490bde3d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1OTUyNjIw", "url": "https://github.com/prestodb/presto/pull/15210#pullrequestreview-495952620", "createdAt": "2020-09-24T21:08:58Z", "commit": {"oid": "112306ba775cffefaa516e49e7487d5a490bde3d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5fd635befaf579009083082e5c414d765f915231", "author": {"user": {"login": "wenleix", "name": "Wenlei Xie"}}, "url": "https://github.com/prestodb/presto/commit/5fd635befaf579009083082e5c414d765f915231", "committedDate": "2020-09-24T23:28:28Z", "message": "Add comment to SerializedTaskInfo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "881b48fae16edf05188fe77f6af4ee312294529a", "author": {"user": {"login": "wenleix", "name": "Wenlei Xie"}}, "url": "https://github.com/prestodb/presto/commit/881b48fae16edf05188fe77f6af4ee312294529a", "committedDate": "2020-09-24T23:28:28Z", "message": "Add peak task user memory to TaskStats"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8aa803f2f7e0870415b0f1d1b789539d95063b4e", "author": {"user": {"login": "wenleix", "name": "Wenlei Xie"}}, "url": "https://github.com/prestodb/presto/commit/8aa803f2f7e0870415b0f1d1b789539d95063b4e", "committedDate": "2020-09-24T23:28:28Z", "message": "Minor tweak in Presto-on-Spark peak task user memory report"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9d444e7909622749a9015b2efcc5039eaf8c136", "author": {"user": {"login": "wenleix", "name": "Wenlei Xie"}}, "url": "https://github.com/prestodb/presto/commit/a9d444e7909622749a9015b2efcc5039eaf8c136", "committedDate": "2020-09-25T05:26:15Z", "message": "Update peak memory in TaskContext for Presto-on-Spark task\n\nThe peak memory stats in TaskContext only get updated when\nTaskContext::getTaskStats(). Presto-on-Spark doesn't pull task stats\nactively so it needs to be updated explicitly."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "112306ba775cffefaa516e49e7487d5a490bde3d", "author": {"user": {"login": "wenleix", "name": "Wenlei Xie"}}, "url": "https://github.com/prestodb/presto/commit/112306ba775cffefaa516e49e7487d5a490bde3d", "committedDate": "2020-09-22T23:12:21Z", "message": "Update peak memory in TaskContext for Presto-on-Spark task\n\nThe peak memory stats in TaskContext only get updated when\nTaskContext::getTaskStats(). Presto-on-Spark doesn't pull task stats\nactively so it needs to be updated explicitly."}, "afterCommit": {"oid": "a9d444e7909622749a9015b2efcc5039eaf8c136", "author": {"user": {"login": "wenleix", "name": "Wenlei Xie"}}, "url": "https://github.com/prestodb/presto/commit/a9d444e7909622749a9015b2efcc5039eaf8c136", "committedDate": "2020-09-25T05:26:15Z", "message": "Update peak memory in TaskContext for Presto-on-Spark task\n\nThe peak memory stats in TaskContext only get updated when\nTaskContext::getTaskStats(). Presto-on-Spark doesn't pull task stats\nactively so it needs to be updated explicitly."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 193, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}