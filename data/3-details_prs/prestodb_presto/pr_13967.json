{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYyOTA2NzU0", "number": 13967, "title": "Properly handle optimizable filter expressions", "bodyText": "A SelectiveStreamReader should be created only if the column is in output or required in a filter function evaluation. In this case we get the columns to be read from unoptimized expression, but column mappings are created from optimized expression which will ignore this column if the expression resolves to \"null\", which will result in creating a SelectiveReader which is not required and hence throws an exception. The fix is to ignore the interim column if the optimized expression discards it.\nFixes #13992\n== NO RELEASE NOTE ==", "createdAt": "2020-01-15T00:52:22Z", "url": "https://github.com/prestodb/presto/pull/13967", "merged": true, "mergeCommit": {"oid": "b34278e2c47569bdb0dafa7c41732bf27438df22"}, "closed": true, "closedAt": "2020-01-22T13:09:41Z", "author": {"login": "bhhari"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb6bxO-gFqTM0Mjk1MTgwOA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb8wxE7ABqjI5Njg5ODEyNjY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyOTUxODA4", "url": "https://github.com/prestodb/presto/pull/13967#pullrequestreview-342951808", "createdAt": "2020-01-15T02:03:44Z", "commit": {"oid": "4350626cb69399a8163f04ab44cb629c99b224ef"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQwMjowMzo0NFrOFdrdDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQwMjowMzo0NFrOFdrdDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjY2NDk3Mg==", "bodyText": "@bhhari Filter expressions that get optimized into null should be eliminated at the query planning phase. Why is this not happening? CC: @highker", "url": "https://github.com/prestodb/presto/pull/13967#discussion_r366664972", "createdAt": "2020-01-15T02:03:44Z", "author": {"login": "mbasmanova"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePageSourceProvider.java", "diffHunk": "@@ -177,8 +178,15 @@ public ConnectorPageSource createPageSource(ConnectorTransactionHandle transacti\n             TypeManager typeManager,\n             LoadingCache<RowExpressionCacheKey, RowExpression> rowExpressionCache)\n     {\n-        Set<HiveColumnHandle> interimColumns = ImmutableSet.<HiveColumnHandle>builder()\n-                .addAll(layout.getPredicateColumns().values())\n+        RowExpression optimizedRemainingPredicate = rowExpressionCache.getUnchecked(new RowExpressionCacheKey(layout.getRemainingPredicate(), session));\n+\n+        ImmutableSet.Builder<HiveColumnHandle> interimColumnsBuilder = ImmutableSet.builder();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4350626cb69399a8163f04ab44cb629c99b224ef"}, "originalPosition": 16}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4350626cb69399a8163f04ab44cb629c99b224ef", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/4350626cb69399a8163f04ab44cb629c99b224ef", "committedDate": "2020-01-15T00:46:23Z", "message": "Ignore columns dropped by filter function optimization"}, "afterCommit": {"oid": "c3bcbe703327b1e3035294cb5809e1654be6c942", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/c3bcbe703327b1e3035294cb5809e1654be6c942", "committedDate": "2020-01-16T01:58:55Z", "message": "Optimize remaining expression and return empty result if its null/false\n\nA SelectiveStreamReader should be created only if the column is in output\nor is required in a filter function evaluation. We get the columns\nto be read from unoptimized expression, but column mappings are created from\noptimized expression which will result in error if optimization results in discarding\nany column. The fix is addressing the case where the whole expression is\noptimized to null or false and return empty. If there are 2 columns and the optimization\nresults in removing 1 then we still have an issue."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzNjM4MjAy", "url": "https://github.com/prestodb/presto/pull/13967#pullrequestreview-343638202", "createdAt": "2020-01-16T02:13:25Z", "commit": {"oid": "c3bcbe703327b1e3035294cb5809e1654be6c942"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQwMjoxMzoyNlrOFeMKVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQwMjoxMzoyNlrOFeMKVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzIwMDg1NQ==", "bodyText": "@bhhari Looks like there is some redundancy here. The expression is being split into tuple domain and remaining predicate and these parts are being checked for \"always-false\" separately. Let's just optimize the whole expression and check the result.\nLooks like translatedExpression.getRemainingExpression(), can be replaced by expression and logic using translatedExpression can be removed.\n        // optimize rowExpression and return ValuesNode if false. e.g. 0=1 => false, 1>2 => false, (a = 1 and a = 2) => false\n        RowExpression optimizedRemainingExpression = new RowExpressionOptimizer(metadata).optimize(expression, OPTIMIZED, session.toConnectorSession());\n        if (optimizedRemainingExpression instanceof ConstantExpression) {\n            ConstantExpression constantExpression = (ConstantExpression) optimizedRemainingExpression;\n            if (FALSE_CONSTANT.equals(constantExpression) || constantExpression.getValue() == null) {\n                return new ValuesNode(idAllocator.getNextId(), node.getOutputVariables(), ImmutableList.of());\n            }\n        }\n\nThere is still a question about the case when optimized expression is not always-false, but rather uses fewer columns when original expression. This will generate an error, right?", "url": "https://github.com/prestodb/presto/pull/13967#discussion_r367200855", "createdAt": "2020-01-16T02:13:26Z", "author": {"login": "mbasmanova"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/iterative/rule/PickTableLayout.java", "diffHunk": "@@ -329,6 +333,14 @@ public static PlanNode pushPredicateIntoTableScan(\n             return new ValuesNode(idAllocator.getNextId(), node.getOutputVariables(), ImmutableList.of());\n         }\n \n+        RowExpression optimizedRemainingExpression = new RowExpressionOptimizer(metadata).optimize(translatedExpression.getRemainingExpression(), OPTIMIZED, session.toConnectorSession());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3bcbe703327b1e3035294cb5809e1654be6c942"}, "originalPosition": 35}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c3bcbe703327b1e3035294cb5809e1654be6c942", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/c3bcbe703327b1e3035294cb5809e1654be6c942", "committedDate": "2020-01-16T01:58:55Z", "message": "Optimize remaining expression and return empty result if its null/false\n\nA SelectiveStreamReader should be created only if the column is in output\nor is required in a filter function evaluation. We get the columns\nto be read from unoptimized expression, but column mappings are created from\noptimized expression which will result in error if optimization results in discarding\nany column. The fix is addressing the case where the whole expression is\noptimized to null or false and return empty. If there are 2 columns and the optimization\nresults in removing 1 then we still have an issue."}, "afterCommit": {"oid": "02aedacfb0e16e7369b701a77e39b68765d0cee9", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/02aedacfb0e16e7369b701a77e39b68765d0cee9", "committedDate": "2020-01-16T03:00:40Z", "message": "Optimize remaining expression and return empty result if its null/false\n\nA SelectiveStreamReader should be created only if the column is in output\nor is required in a filter function evaluation. We get the columns\nto be read from unoptimized expression, but column mappings are created from\noptimized expression which will result in error if optimization results in discarding\nany column. The fix is addressing the case where the whole expression is\noptimized to null or false and return empty. If there are 2 columns and the optimization\nresults in removing 1 then we only add the remaining column in pushdown"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzNjUyMzU4", "url": "https://github.com/prestodb/presto/pull/13967#pullrequestreview-343652358", "createdAt": "2020-01-16T03:13:14Z", "commit": {"oid": "02aedacfb0e16e7369b701a77e39b68765d0cee9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQwMzoxMzoxNFrOFeM4GA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQwMzoxMzoxNFrOFeM4GA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzIxMjU2OA==", "bodyText": "Let's add a test case for expression over multiple columns being optimized into an expression over fewer columns.", "url": "https://github.com/prestodb/presto/pull/13967#discussion_r367212568", "createdAt": "2020-01-16T03:13:14Z", "author": {"login": "mbasmanova"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -1911,7 +1911,9 @@ public ConnectorPushdownFilterResult pushdownFilter(ConnectorSession session, Co\n         domainPredicate.getDomains().get().keySet().stream()\n                 .map(Subfield::getRootName)\n                 .forEach(predicateColumnNames::add);\n-        extractAll(decomposedFilter.getRemainingExpression()).stream()\n+        // optimize the remaining expression before adding to predicateColumns", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02aedacfb0e16e7369b701a77e39b68765d0cee9"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzNjUyNzE1", "url": "https://github.com/prestodb/presto/pull/13967#pullrequestreview-343652715", "createdAt": "2020-01-16T03:14:58Z", "commit": {"oid": "02aedacfb0e16e7369b701a77e39b68765d0cee9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQwMzoxNDo1OVrOFeM5QA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQwMzoxNDo1OVrOFeM5QA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzIxMjg2NA==", "bodyText": "I'm seeing the following test case failing. It used to work because PickTableLayout extracted tuple domain and checked for isNone. I don't think that's a proper way though. It seems like HiveMetadata.pushdownFilter needs to check decomposedFilter.getTupleDomain() for isNone.\n        assertPlan(pushdownFilterEnabled(), \"SELECT linenumber FROM lineitem WHERE linenumber > 10 AND linenumber < 0\",\n                output(values(\"linenumber\")));", "url": "https://github.com/prestodb/presto/pull/13967#discussion_r367212864", "createdAt": "2020-01-16T03:14:59Z", "author": {"login": "mbasmanova"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -1911,7 +1911,9 @@ public ConnectorPushdownFilterResult pushdownFilter(ConnectorSession session, Co\n         domainPredicate.getDomains().get().keySet().stream()\n                 .map(Subfield::getRootName)\n                 .forEach(predicateColumnNames::add);\n-        extractAll(decomposedFilter.getRemainingExpression()).stream()\n+        // optimize the remaining expression before adding to predicateColumns\n+        RowExpression optimizedRemainingExpression = rowExpressionService.getExpressionOptimizer().optimize(decomposedFilter.getRemainingExpression(), OPTIMIZED, session);\n+        extractAll(optimizedRemainingExpression).stream()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02aedacfb0e16e7369b701a77e39b68765d0cee9"}, "originalPosition": 7}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "02aedacfb0e16e7369b701a77e39b68765d0cee9", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/02aedacfb0e16e7369b701a77e39b68765d0cee9", "committedDate": "2020-01-16T03:00:40Z", "message": "Optimize remaining expression and return empty result if its null/false\n\nA SelectiveStreamReader should be created only if the column is in output\nor is required in a filter function evaluation. We get the columns\nto be read from unoptimized expression, but column mappings are created from\noptimized expression which will result in error if optimization results in discarding\nany column. The fix is addressing the case where the whole expression is\noptimized to null or false and return empty. If there are 2 columns and the optimization\nresults in removing 1 then we only add the remaining column in pushdown"}, "afterCommit": {"oid": "53970e35c030cf98cea1ff5f145f0cc4c20abdce", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/53970e35c030cf98cea1ff5f145f0cc4c20abdce", "committedDate": "2020-01-16T09:04:59Z", "message": "Optimize remaining expression and return empty result if its null/false\n\nA SelectiveStreamReader should be created only if the column is in output\nor is required in a filter function evaluation. We get the columns\nto be read from unoptimized expression, but column mappings are created from\noptimized expression which will result in error if optimization results in discarding\nany column. The fix is addressing the case where the whole expression is\noptimized to null or false and return empty. If there are 2 columns and the optimization\nresults in removing 1 then we only add the remaining column in pushdown"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "53970e35c030cf98cea1ff5f145f0cc4c20abdce", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/53970e35c030cf98cea1ff5f145f0cc4c20abdce", "committedDate": "2020-01-16T09:04:59Z", "message": "Optimize remaining expression and return empty result if its null/false\n\nA SelectiveStreamReader should be created only if the column is in output\nor is required in a filter function evaluation. We get the columns\nto be read from unoptimized expression, but column mappings are created from\noptimized expression which will result in error if optimization results in discarding\nany column. The fix is addressing the case where the whole expression is\noptimized to null or false and return empty. If there are 2 columns and the optimization\nresults in removing 1 then we only add the remaining column in pushdown"}, "afterCommit": {"oid": "215d673daece59f0ac056bd15958149d6ec8bffc", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/215d673daece59f0ac056bd15958149d6ec8bffc", "committedDate": "2020-01-16T09:10:06Z", "message": "Optimize remaining expression and return empty result if its null/false\n\nA SelectiveStreamReader should be created only if the column is in output\nor is required in a filter function evaluation. We get the columns\nto be read from unoptimized expression, but column mappings are created from\noptimized expression which will result in error if optimization results in discarding\nany column. The fix is addressing the case where the whole expression is\noptimized to null or false and return empty. If there are 2 columns and the optimization\nresults in removing 1 then we only add the remaining column in pushdown"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "215d673daece59f0ac056bd15958149d6ec8bffc", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/215d673daece59f0ac056bd15958149d6ec8bffc", "committedDate": "2020-01-16T09:10:06Z", "message": "Optimize remaining expression and return empty result if its null/false\n\nA SelectiveStreamReader should be created only if the column is in output\nor is required in a filter function evaluation. We get the columns\nto be read from unoptimized expression, but column mappings are created from\noptimized expression which will result in error if optimization results in discarding\nany column. The fix is addressing the case where the whole expression is\noptimized to null or false and return empty. If there are 2 columns and the optimization\nresults in removing 1 then we only add the remaining column in pushdown"}, "afterCommit": {"oid": "2f531d3eac42e1d013c0c924ae0f5802fbf66dc8", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/2f531d3eac42e1d013c0c924ae0f5802fbf66dc8", "committedDate": "2020-01-17T23:12:46Z", "message": "Optimize remaining expression and return empty result if its null/false\n\nA SelectiveStreamReader should be created only if the column is in output\nor is required in a filter function evaluation. We get the columns\nto be read from unoptimized expression, but column mappings are created from\noptimized expression which will result in error if optimization results in discarding\nany column. The fix is addressing the case where the whole expression is\noptimized to null or false and return empty. If there are 2 columns and the optimization\nresults in removing 1 then we only add the remaining column in pushdown"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "65aef11f889f2374001f50fc481039b9b98d8769", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/65aef11f889f2374001f50fc481039b9b98d8769", "committedDate": "2020-01-17T23:21:55Z", "message": "mend"}, "afterCommit": {"oid": "76ebb8e532132c466544cef147263b26ce703f1c", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/76ebb8e532132c466544cef147263b26ce703f1c", "committedDate": "2020-01-17T23:48:49Z", "message": "Optimize remaining expression and return empty result if its null/false\n\nA SelectiveStreamReader should be created only if the column is in output\nor is required in a filter function evaluation. We get the columns\nto be read from unoptimized expression, but column mappings are created from\noptimized expression which will result in error if optimization results in discarding\nany column. The fix is addressing the case where the whole expression is\noptimized to null or false and return empty. If there are 2 columns and the optimization\nresults in removing 1 then we only add the remaining column in pushdown"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "76ebb8e532132c466544cef147263b26ce703f1c", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/76ebb8e532132c466544cef147263b26ce703f1c", "committedDate": "2020-01-17T23:48:49Z", "message": "Optimize remaining expression and return empty result if its null/false\n\nA SelectiveStreamReader should be created only if the column is in output\nor is required in a filter function evaluation. We get the columns\nto be read from unoptimized expression, but column mappings are created from\noptimized expression which will result in error if optimization results in discarding\nany column. The fix is addressing the case where the whole expression is\noptimized to null or false and return empty. If there are 2 columns and the optimization\nresults in removing 1 then we only add the remaining column in pushdown"}, "afterCommit": {"oid": "2cfd14e0d63451c8a03c775685b147e63fa21872", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/2cfd14e0d63451c8a03c775685b147e63fa21872", "committedDate": "2020-01-17T23:53:59Z", "message": "Optimize remaining expression and return empty result if its null/false\n\nA SelectiveStreamReader should be created only if the column is in output\nor is required in a filter function evaluation. We get the columns\nto be read from unoptimized expression, but column mappings are created from\noptimized expression which will result in error if optimization results in discarding\nany column. The fix is addressing the case where the whole expression is\noptimized to null or false and return empty. If there are 2 columns and the optimization\nresults in removing 1 then we only add the remaining column in pushdown"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1Nzc2Njcw", "url": "https://github.com/prestodb/presto/pull/13967#pullrequestreview-345776670", "createdAt": "2020-01-21T10:34:10Z", "commit": {"oid": "2cfd14e0d63451c8a03c775685b147e63fa21872"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxMDozNDoxMVrOFf1ScA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxMjoxMTo1M1rOFf32qA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODkyMzI0OA==", "bodyText": "I think it would be clearer to make an empty layout and run this check earlier in this method\nI would also update PickTableLayout to remove the logic of extracting TupleDomain and checking for none.\n\nprivate static final ConnectorTableLayout EMPTY_TABLE_LAYOUT = new ConnectorTableLayout(new ConnectorTableLayoutHandle() {}) {};\n\n        ExtractionResult<Subfield> decomposedFilter = rowExpressionService.getDomainTranslator()\n                .fromPredicate(session, filter, new SubfieldExtractor(functionResolution, rowExpressionService.getExpressionOptimizer(), session).toColumnExtractor());\n        if (currentLayoutHandle.isPresent()) {\n            HiveTableLayoutHandle currentHiveLayout = (HiveTableLayoutHandle) currentLayoutHandle.get();\n            decomposedFilter = intersectExtractionResult(decomposedFilter, new ExtractionResult(currentHiveLayout.getDomainPredicate(), currentHiveLayout.getRemainingPredicate()));\n        }\n\n        if (decomposedFilter.getTupleDomain().isNone()) {\n            return new ConnectorPushdownFilterResult(EMPTY_TABLE_LAYOUT, FALSE_CONSTANT);\n        }\n\n        RowExpression optimizedRemainingExpression = rowExpressionService.getExpressionOptimizer().optimize(decomposedFilter.getRemainingExpression(), OPTIMIZED, session);\n        if (optimizedRemainingExpression instanceof ConstantExpression) {\n            ConstantExpression constantExpression = (ConstantExpression) optimizedRemainingExpression;\n            if (FALSE_CONSTANT.equals(constantExpression) || constantExpression.getValue() == null) {\n                return new ConnectorPushdownFilterResult(EMPTY_TABLE_LAYOUT, FALSE_CONSTANT);\n            }\n        }", "url": "https://github.com/prestodb/presto/pull/13967#discussion_r368923248", "createdAt": "2020-01-21T10:34:11Z", "author": {"login": "mbasmanova"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -1894,8 +1895,25 @@ public ConnectorPushdownFilterResult pushdownFilter(ConnectorSession session, Co\n             }\n         }\n \n+        SchemaTableName tableName = ((HiveTableHandle) tableHandle).getSchemaTableName();\n         HivePartitionResult hivePartitionResult = partitionManager.getPartitions(metastore, tableHandle, constraint, session);\n \n+        //if TupleDomain isNone or optmized remaningExpression is false return ConnectorPushdownFilterResult with TupleDomain.none() layout\n+        if (decomposedFilter.getTupleDomain().isNone()) {\n+            return new ConnectorPushdownFilterResult(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2cfd14e0d63451c8a03c775685b147e63fa21872"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODkyNTkwMg==", "bodyText": "This logic relies on the execution to optimize the expression before evaluation. Let's add a comment to highlight this requirement.\n        // Include only columns referenced in the optimized expression. Although the expression is sent to the worker node \n        // unoptimized, the worker is expected to optimize the expression before executing.\n        extractAll(optimizedRemainingExpression).stream()\n                .map(VariableReferenceExpression::getName)\n                .forEach(predicateColumnNames::add);", "url": "https://github.com/prestodb/presto/pull/13967#discussion_r368925902", "createdAt": "2020-01-21T10:39:51Z", "author": {"login": "mbasmanova"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -1911,37 +1929,42 @@ public ConnectorPushdownFilterResult pushdownFilter(ConnectorSession session, Co\n         domainPredicate.getDomains().get().keySet().stream()\n                 .map(Subfield::getRootName)\n                 .forEach(predicateColumnNames::add);\n-        extractAll(decomposedFilter.getRemainingExpression()).stream()\n+        extractAll(optimizedRemainingExpression).stream()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2cfd14e0d63451c8a03c775685b147e63fa21872"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODkyODgyNg==", "bodyText": "Let's also add test cases where both tuple domain and remaining predicate are present, but one of them is always-false.\nLet's update comments for consistency, e.g. use \"remaining predicate\" or \"filter function\" but not both\nnit: capitalize SQL keywords in the queries: orderkey = 1 AND orderkey = 2\nLet's add a test case for always-false tuple domain on subfield; I'd put this into testPushdownFilterOnSubfields method\n\n        // Remaining predicate is NULL\n        assertPlan(pushdownFilterEnabled, \"SELECT linenumber FROM lineitem WHERE cardinality(NULL) > 0\",\n                output(values(\"linenumber\")));\n\n        assertPlan(pushdownFilterEnabled, \"SELECT linenumber FROM lineitem WHERE orderkey > 10 AND cardinality(NULL) > 0\",\n                output(values(\"linenumber\")));\n\n        // Remaining predicate is always FALSE\n        assertPlan(pushdownFilterEnabled, \"SELECT linenumber FROM lineitem WHERE cardinality(ARRAY[1]) > 1\",\n                output(values(\"linenumber\")));\n\n        assertPlan(pushdownFilterEnabled, \"SELECT linenumber FROM lineitem WHERE orderkey > 10 AND cardinality(ARRAY[1]) > 1\",\n                output(values(\"linenumber\")));\n\n        // TupleDomain predicate is always FALSE\n        assertPlan(pushdownFilterEnabled, \"SELECT linenumber FROM lineitem WHERE orderkey = 1 AND orderkey = 2\",\n                output(values(\"linenumber\")));\n\n        assertPlan(pushdownFilterEnabled, \"SELECT linenumber FROM lineitem WHERE orderkey = 1 AND orderkey = 2 AND linenumber % 2 = 1\",\n                output(values(\"linenumber\")));\n\n-- testPushdownFilterOnSubfields\n\n        // TupleDomain predicate is always FALSE\n        assertPlan(pushdownFilterEnabled(), \"SELECT id FROM test_pushdown_filter_on_subfields WHERE c.a = 1 AND c.a = 2\",\n                output(values(\"id\")));", "url": "https://github.com/prestodb/presto/pull/13967#discussion_r368928826", "createdAt": "2020-01-21T10:45:59Z", "author": {"login": "mbasmanova"}, "path": "presto-hive/src/test/java/com/facebook/presto/hive/TestHiveLogicalPlanner.java", "diffHunk": "@@ -181,6 +182,17 @@ public void testPushdownFilter()\n                 output(exchange(project(\n                         filter(\"mod(orderkey, 2) = 1\",\n                                 strictTableScan(\"lineitem\", identityMap(\"linenumber\", \"orderkey\")))))));\n+        // Null remaining predicate", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2cfd14e0d63451c8a03c775685b147e63fa21872"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODkyOTQ3OA==", "bodyText": "use assertQueryReturnsEmptyResult here", "url": "https://github.com/prestodb/presto/pull/13967#discussion_r368929478", "createdAt": "2020-01-21T10:47:22Z", "author": {"login": "mbasmanova"}, "path": "presto-hive/src/test/java/com/facebook/presto/hive/TestHivePushdownFilterQueries.java", "diffHunk": "@@ -644,6 +644,7 @@ public void testStructs()\n         // filter-only struct\n         assertQueryUsingH2Cte(\"SELECT orderkey FROM lineitem_ex WHERE info IS NOT NULL\");\n         assertQueryUsingH2Cte(\"SELECT orderkey FROM lineitem_ex WHERE info IS NOT NULL AND info.orderkey = 16515\", rewriter);\n+        assertQueryUsingH2Cte(\"SELECT orderkey FROM lineitem_ex WHERE info IS NOT NULL AND info.orderkey = 16515 and info.orderkye = 16516\", rewriter);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2cfd14e0d63451c8a03c775685b147e63fa21872"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODk2NTI4OA==", "bodyText": "This query is a bit difficult to understand. Consider a simpler one:\nSELECT partkey FROM lineitem WHERE orderkey > 10 OR if(json_extract(json_parse('{}'), '$.a') IS NOT NULL, quantity * discount) > 0\n\nThe results of that query can be verified and the verification could double-serve as documentation:\n        assertQuery(\"SELECT partkey FROM lineitem WHERE orderkey > 10 OR if(json_extract(json_parse('{}'), '$.a') IS NOT NULL, quantity * discount) > 0\",\n                \"SELECT partkey FROM lineitem WHERE orderkey > 10\");\n\nIt would be nice to add this test to TestHiveLogicalPlanner where we can verify explicitly the list of columns in layout.predicateColumns.", "url": "https://github.com/prestodb/presto/pull/13967#discussion_r368965288", "createdAt": "2020-01-21T12:11:53Z", "author": {"login": "mbasmanova"}, "path": "presto-hive/src/test/java/com/facebook/presto/hive/TestHivePushdownFilterQueries.java", "diffHunk": "@@ -1033,6 +1034,15 @@ public void testNans()\n         }\n     }\n \n+    @Test\n+    public void testFilterFunctionsWithOptimization()\n+    {\n+        // the RowExpressionOptimizer optimizes the second part of the 2nd cardinality function to null hence not pushing down the linenumber as required predicate column\n+        assertQuerySucceeds(getSession(), \"SELECT partkey FROM lineitem WHERE \" +\n+                \"cardinality(ARRAY_INTERSECT(ARRAY[orderkey], map_values(CAST(json_extract(json_parse('{\\\"a\\\": {\\\"a1\\\": {\\\"0\\\": 1}}}'),concat(concat('$.', 'a'), '[\\\"a1\\\"]')) AS MAP(VARCHAR, BIGINT))))) > 0 \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2cfd14e0d63451c8a03c775685b147e63fa21872"}, "originalPosition": 17}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2cfd14e0d63451c8a03c775685b147e63fa21872", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/2cfd14e0d63451c8a03c775685b147e63fa21872", "committedDate": "2020-01-17T23:53:59Z", "message": "Optimize remaining expression and return empty result if its null/false\n\nA SelectiveStreamReader should be created only if the column is in output\nor is required in a filter function evaluation. We get the columns\nto be read from unoptimized expression, but column mappings are created from\noptimized expression which will result in error if optimization results in discarding\nany column. The fix is addressing the case where the whole expression is\noptimized to null or false and return empty. If there are 2 columns and the optimization\nresults in removing 1 then we only add the remaining column in pushdown"}, "afterCommit": {"oid": "d5906f94ff6fae44618a95d31be4edef5dd2342b", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/d5906f94ff6fae44618a95d31be4edef5dd2342b", "committedDate": "2020-01-21T21:12:09Z", "message": "Optimize remaining expression and return empty result if its null/false\n\nA SelectiveStreamReader should be created only if the column is in output\nor is required in a filter function evaluation. We get the columns\nto be read from unoptimized expression, but column mappings are created from\noptimized expression which will result in error if optimization results in discarding\nany column. The fix is addressing the case where the whole expression is\noptimized to null or false and return empty. If there are 2 columns and the optimization\nresults in removing 1 then we only add the remaining column in pushdown"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d5906f94ff6fae44618a95d31be4edef5dd2342b", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/d5906f94ff6fae44618a95d31be4edef5dd2342b", "committedDate": "2020-01-21T21:12:09Z", "message": "Optimize remaining expression and return empty result if its null/false\n\nA SelectiveStreamReader should be created only if the column is in output\nor is required in a filter function evaluation. We get the columns\nto be read from unoptimized expression, but column mappings are created from\noptimized expression which will result in error if optimization results in discarding\nany column. The fix is addressing the case where the whole expression is\noptimized to null or false and return empty. If there are 2 columns and the optimization\nresults in removing 1 then we only add the remaining column in pushdown"}, "afterCommit": {"oid": "cb5c0607a585b0677949ee4c145dffe65bd1e7e5", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/cb5c0607a585b0677949ee4c145dffe65bd1e7e5", "committedDate": "2020-01-21T21:25:37Z", "message": "Optimize remaining expression and return empty result if its null/false\n\nA SelectiveStreamReader should be created only if the column is in output\nor is required in a filter function evaluation. We get the columns\nto be read from unoptimized expression, but column mappings are created from\noptimized expression which will result in error if optimization results in discarding\nany column. The fix is addressing the case where the whole expression is\noptimized to null or false and return empty. If there are 2 columns and the optimization\nresults in removing 1 then we only add the remaining column in pushdown"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cb5c0607a585b0677949ee4c145dffe65bd1e7e5", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/cb5c0607a585b0677949ee4c145dffe65bd1e7e5", "committedDate": "2020-01-21T21:25:37Z", "message": "Optimize remaining expression and return empty result if its null/false\n\nA SelectiveStreamReader should be created only if the column is in output\nor is required in a filter function evaluation. We get the columns\nto be read from unoptimized expression, but column mappings are created from\noptimized expression which will result in error if optimization results in discarding\nany column. The fix is addressing the case where the whole expression is\noptimized to null or false and return empty. If there are 2 columns and the optimization\nresults in removing 1 then we only add the remaining column in pushdown"}, "afterCommit": {"oid": "9947665b8b038257b8beeab09c7f60138edd8748", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/9947665b8b038257b8beeab09c7f60138edd8748", "committedDate": "2020-01-21T21:53:14Z", "message": "Optimize remaining expression and return empty result if its null/false\n\nA SelectiveStreamReader should be created only if the column is in output\nor is required in a filter function evaluation. We get the columns\nto be read from unoptimized expression, but column mappings are created from\noptimized expression which will result in error if optimization results in discarding\nany column. The fix is addressing the case where the whole expression is\noptimized to null or false and return empty. If there are 2 columns and the optimization\nresults in removing 1 then we only add the remaining column in pushdown"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2MzAwMDI1", "url": "https://github.com/prestodb/presto/pull/13967#pullrequestreview-346300025", "createdAt": "2020-01-22T01:31:18Z", "commit": {"oid": "9947665b8b038257b8beeab09c7f60138edd8748"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQwMTozMToxOFrOFgOMeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQwMTozMjoxNVrOFgONVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMzMTMyMA==", "bodyText": "This comment is too low level for this high-level test. Consider removing.", "url": "https://github.com/prestodb/presto/pull/13967#discussion_r369331320", "createdAt": "2020-01-22T01:31:18Z", "author": {"login": "mbasmanova"}, "path": "presto-hive/src/test/java/com/facebook/presto/hive/TestHivePushdownFilterQueries.java", "diffHunk": "@@ -1033,6 +1034,14 @@ public void testNans()\n         }\n     }\n \n+    @Test\n+    public void testFilterFunctionsWithOptimization()\n+    {\n+        // the RowExpressionOptimizer optimizes the second part of the 2nd cardinality function to null hence not pushing down the linenumber as required predicate column", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9947665b8b038257b8beeab09c7f60138edd8748"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMzMTU0Mw==", "bodyText": "typos: replaceExpression() may further optimize the expression; if the resulting expression is always false, then return empty Values node", "url": "https://github.com/prestodb/presto/pull/13967#discussion_r369331543", "createdAt": "2020-01-22T01:32:15Z", "author": {"login": "mbasmanova"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/iterative/rule/PickTableLayout.java", "diffHunk": "@@ -323,17 +324,17 @@ public static PlanNode pushPredicateIntoTableScan(\n             expression = predicate;\n         }\n \n-        // optimize rowExpression and return ValuesNode if false. e.g. 0=1 => false, 1>2 => false, (a = 1 and a = 2) => false\n-        DomainTranslator.ExtractionResult<VariableReferenceExpression> translatedExpression = translator.fromPredicate(session.toConnectorSession(), expression, BASIC_COLUMN_EXTRACTOR);\n-        if (translatedExpression.getTupleDomain().isNone()) {\n-            return new ValuesNode(idAllocator.getNextId(), node.getOutputVariables(), ImmutableList.of());\n-        }\n-\n         BiMap<VariableReferenceExpression, VariableReferenceExpression> symbolToColumnMapping = node.getAssignments().entrySet().stream()\n                 .collect(toImmutableBiMap(\n                         Map.Entry::getKey,\n                         entry -> new VariableReferenceExpression(getColumnName(session, metadata, node.getTable(), entry.getValue()), entry.getKey().getType())));\n-        PushdownFilterResult pushdownFilterResult = metadata.pushdownFilter(session, node.getTable(), replaceExpression(expression, symbolToColumnMapping));\n+\n+        RowExpression replacedExpression = replaceExpression(expression, symbolToColumnMapping);\n+        // replaceExpression() may further optimize the expression, if the resulting expression is false and return an empty result", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9947665b8b038257b8beeab09c7f60138edd8748"}, "originalPosition": 25}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9947665b8b038257b8beeab09c7f60138edd8748", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/9947665b8b038257b8beeab09c7f60138edd8748", "committedDate": "2020-01-21T21:53:14Z", "message": "Optimize remaining expression and return empty result if its null/false\n\nA SelectiveStreamReader should be created only if the column is in output\nor is required in a filter function evaluation. We get the columns\nto be read from unoptimized expression, but column mappings are created from\noptimized expression which will result in error if optimization results in discarding\nany column. The fix is addressing the case where the whole expression is\noptimized to null or false and return empty. If there are 2 columns and the optimization\nresults in removing 1 then we only add the remaining column in pushdown"}, "afterCommit": {"oid": "66da21130687492af996e2f5f1f3e3580cfa0a7f", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/66da21130687492af996e2f5f1f3e3580cfa0a7f", "committedDate": "2020-01-22T04:35:01Z", "message": "Properly handle optimizable filter expressions\n\nFilter expression can be optimized to a constant value (true, false or null) or to a\nsimpler expression that uses fewer inputs (columns). Make sure to read only\ncolumns that are references from the optimized expression and replace table\nscan node with empty values node if filter expression can be optimized to false or null."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf9a4b1e63d360ebcd261c5623dfcebd28ff5858", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/bf9a4b1e63d360ebcd261c5623dfcebd28ff5858", "committedDate": "2020-01-22T07:39:11Z", "message": "Properly handle optimizable filter expressions\n\nFilter expression can be optimized to a constant value (true, false or null) or\nto a simpler expression that uses fewer inputs (columns). Make sure to read only\ncolumns that are references from the optimized expression and replace table\nscan node with empty values node if filter expression can be optimized to false or null."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "66da21130687492af996e2f5f1f3e3580cfa0a7f", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/66da21130687492af996e2f5f1f3e3580cfa0a7f", "committedDate": "2020-01-22T04:35:01Z", "message": "Properly handle optimizable filter expressions\n\nFilter expression can be optimized to a constant value (true, false or null) or to a\nsimpler expression that uses fewer inputs (columns). Make sure to read only\ncolumns that are references from the optimized expression and replace table\nscan node with empty values node if filter expression can be optimized to false or null."}, "afterCommit": {"oid": "bf9a4b1e63d360ebcd261c5623dfcebd28ff5858", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/bf9a4b1e63d360ebcd261c5623dfcebd28ff5858", "committedDate": "2020-01-22T07:39:11Z", "message": "Properly handle optimizable filter expressions\n\nFilter expression can be optimized to a constant value (true, false or null) or\nto a simpler expression that uses fewer inputs (columns). Make sure to read only\ncolumns that are references from the optimized expression and replace table\nscan node with empty values node if filter expression can be optimized to false or null."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2396, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}