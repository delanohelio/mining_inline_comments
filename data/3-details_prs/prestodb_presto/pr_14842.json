{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ5NjM3NjAz", "number": 14842, "title": "Add aggregation function SET_UNION", "bodyText": "== RELEASE NOTES ==\n\nGeneral Changes\n* Add aggregation function SET_UNION", "createdAt": "2020-07-15T17:48:39Z", "url": "https://github.com/prestodb/presto/pull/14842", "merged": true, "mergeCommit": {"oid": "4c2b8c224f7633c2672b02ec145849524c06e373"}, "closed": true, "closedAt": "2020-07-24T18:04:22Z", "author": {"login": "prithvip"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc1QHFKgFqTQ0OTI4MDA1Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc34qwTABqjM1ODIxNTE3NjQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5MjgwMDUy", "url": "https://github.com/prestodb/presto/pull/14842#pullrequestreview-449280052", "createdAt": "2020-07-15T19:50:17Z", "commit": {"oid": "8b6d04b79adcdc73006b57c3a6e64c01a77ba3af"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxOTo1MDoxN1rOGyNcNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxOTo1MDoxN1rOGyNcNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTMwMjE5OA==", "bodyText": "static import", "url": "https://github.com/prestodb/presto/pull/14842#discussion_r455302198", "createdAt": "2020-07-15T19:50:17Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/metadata/BuiltInFunctionNamespaceManager.java", "diffHunk": "@@ -649,6 +650,7 @@ public BuiltInFunctionNamespaceManager(\n                 .function(ARRAY_CONCAT_FUNCTION)\n                 .functions(ARRAY_CONSTRUCTOR, ARRAY_SUBSCRIPT, ARRAY_TO_JSON, JSON_TO_ARRAY, JSON_STRING_TO_ARRAY)\n                 .function(SET_AGG)\n+                .function(SetUnionFunction.SET_UNION)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b6d04b79adcdc73006b57c3a6e64c01a77ba3af"}, "originalPosition": 12}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8b6d04b79adcdc73006b57c3a6e64c01a77ba3af", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/8b6d04b79adcdc73006b57c3a6e64c01a77ba3af", "committedDate": "2020-07-15T17:45:57Z", "message": "[WIP] Add new function set_union"}, "afterCommit": {"oid": "84b093e8ac21351e520e80c1bd08740ec74df803", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/84b093e8ac21351e520e80c1bd08740ec74df803", "committedDate": "2020-07-15T22:52:55Z", "message": "[WIP] Add new function set_union"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "84b093e8ac21351e520e80c1bd08740ec74df803", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/84b093e8ac21351e520e80c1bd08740ec74df803", "committedDate": "2020-07-15T22:52:55Z", "message": "[WIP] Add new function set_union"}, "afterCommit": {"oid": "9996396314207985fbedbec3a33417ad2f6fd2f3", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/9996396314207985fbedbec3a33417ad2f6fd2f3", "committedDate": "2020-07-21T18:13:39Z", "message": "Implement new function SET_UNION\n\nSET_UNION is a more efficient alternative to the common pattern of\nARRAY_DISTINCT(FLATTEN(ARRAY_AGG(x)))"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyNzI3ODU4", "url": "https://github.com/prestodb/presto/pull/14842#pullrequestreview-452727858", "createdAt": "2020-07-21T18:35:24Z", "commit": {"oid": "9996396314207985fbedbec3a33417ad2f6fd2f3"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9996396314207985fbedbec3a33417ad2f6fd2f3", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/9996396314207985fbedbec3a33417ad2f6fd2f3", "committedDate": "2020-07-21T18:13:39Z", "message": "Implement new function SET_UNION\n\nSET_UNION is a more efficient alternative to the common pattern of\nARRAY_DISTINCT(FLATTEN(ARRAY_AGG(x)))"}, "afterCommit": {"oid": "a019e3a84235ebb8313ba733ebbc51ce0680bcab", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/a019e3a84235ebb8313ba733ebbc51ce0680bcab", "committedDate": "2020-07-21T21:23:39Z", "message": "Implement new function SET_UNION\n\nSET_UNION is a more efficient alternative to the common pattern of\nARRAY_DISTINCT(FLATTEN(ARRAY_AGG(x)))"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a019e3a84235ebb8313ba733ebbc51ce0680bcab", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/a019e3a84235ebb8313ba733ebbc51ce0680bcab", "committedDate": "2020-07-21T21:23:39Z", "message": "Implement new function SET_UNION\n\nSET_UNION is a more efficient alternative to the common pattern of\nARRAY_DISTINCT(FLATTEN(ARRAY_AGG(x)))"}, "afterCommit": {"oid": "d8d96e2d0d18540019822c3531171fe5d2ae1865", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/d8d96e2d0d18540019822c3531171fe5d2ae1865", "committedDate": "2020-07-21T21:44:15Z", "message": "Implement new function SET_UNION\n\nSET_UNION is a more efficient alternative to the common pattern of\nARRAY_DISTINCT(FLATTEN(ARRAY_AGG(x)))"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyOTU5OTA0", "url": "https://github.com/prestodb/presto/pull/14842#pullrequestreview-452959904", "createdAt": "2020-07-22T02:54:17Z", "commit": {"oid": "d8d96e2d0d18540019822c3531171fe5d2ae1865"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzNjc5MjQ5", "url": "https://github.com/prestodb/presto/pull/14842#pullrequestreview-453679249", "createdAt": "2020-07-22T20:57:20Z", "commit": {"oid": "d8d96e2d0d18540019822c3531171fe5d2ae1865"}, "state": "COMMENTED", "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQyMDo1NzoyMFrOG1z7bw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQyMToxOTozNVrOG10n-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA3ODUxMQ==", "bodyText": "We normally use upper case character to represent type, and we use \"()\" rather than \"<>\", so maybe change it to array(T) instead.", "url": "https://github.com/prestodb/presto/pull/14842#discussion_r459078511", "createdAt": "2020-07-22T20:57:20Z", "author": {"login": "rongrong"}, "path": "presto-docs/src/main/sphinx/functions/aggregate.rst", "diffHunk": "@@ -147,6 +147,10 @@ General Aggregate Functions\n \n         Returns an array created from the distinct input ``x`` elements.\n \n+.. function:: set_union(array<x>) -> array<x>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8d96e2d0d18540019822c3531171fe5d2ae1865"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA3OTExMQ==", "bodyText": "Maybe add an example to make it clearer.", "url": "https://github.com/prestodb/presto/pull/14842#discussion_r459079111", "createdAt": "2020-07-22T20:58:24Z", "author": {"login": "rongrong"}, "path": "presto-docs/src/main/sphinx/functions/aggregate.rst", "diffHunk": "@@ -147,6 +147,10 @@ General Aggregate Functions\n \n         Returns an array created from the distinct input ``x`` elements.\n \n+.. function:: set_union(array<x>) -> array<x>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA3ODUxMQ=="}, "originalCommit": {"oid": "d8d96e2d0d18540019822c3531171fe5d2ae1865"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA3OTcxMg==", "bodyText": "Add an empty line between public static final and static static final variables.", "url": "https://github.com/prestodb/presto/pull/14842#discussion_r459079712", "createdAt": "2020-07-22T20:59:33Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/aggregation/arrayagg/SetUnionFunction.java", "diffHunk": "@@ -0,0 +1,162 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.operator.aggregation.arrayagg;\n+\n+import com.facebook.presto.bytecode.DynamicClassLoader;\n+import com.facebook.presto.common.block.Block;\n+import com.facebook.presto.common.block.BlockBuilder;\n+import com.facebook.presto.common.type.ArrayType;\n+import com.facebook.presto.common.type.StandardTypes;\n+import com.facebook.presto.common.type.Type;\n+import com.facebook.presto.common.type.TypeManager;\n+import com.facebook.presto.common.type.TypeSignatureParameter;\n+import com.facebook.presto.metadata.BoundVariables;\n+import com.facebook.presto.metadata.FunctionManager;\n+import com.facebook.presto.metadata.SqlAggregationFunction;\n+import com.facebook.presto.operator.aggregation.AccumulatorCompiler;\n+import com.facebook.presto.operator.aggregation.AggregationMetadata;\n+import com.facebook.presto.operator.aggregation.AggregationMetadata.AccumulatorStateDescriptor;\n+import com.facebook.presto.operator.aggregation.AggregationMetadata.ParameterMetadata;\n+import com.facebook.presto.operator.aggregation.AggregationUtils;\n+import com.facebook.presto.operator.aggregation.GenericAccumulatorFactoryBinder;\n+import com.facebook.presto.operator.aggregation.InternalAggregationFunction;\n+import com.facebook.presto.operator.aggregation.SetOfValues;\n+import com.facebook.presto.operator.aggregation.state.SetAggregationState;\n+import com.facebook.presto.operator.aggregation.state.SetAggregationStateFactory;\n+import com.facebook.presto.spi.function.AccumulatorState;\n+import com.facebook.presto.spi.function.AccumulatorStateFactory;\n+import com.facebook.presto.spi.function.AccumulatorStateSerializer;\n+import com.google.common.collect.ImmutableList;\n+\n+import java.lang.invoke.MethodHandle;\n+import java.util.List;\n+\n+import static com.facebook.presto.common.type.TypeSignature.parseTypeSignature;\n+import static com.facebook.presto.operator.aggregation.AggregationMetadata.ParameterMetadata.ParameterType.BLOCK_INDEX;\n+import static com.facebook.presto.operator.aggregation.AggregationMetadata.ParameterMetadata.ParameterType.NULLABLE_BLOCK_INPUT_CHANNEL;\n+import static com.facebook.presto.operator.aggregation.AggregationMetadata.ParameterMetadata.ParameterType.STATE;\n+import static com.facebook.presto.spi.function.Signature.typeVariable;\n+import static com.facebook.presto.util.Reflection.methodHandle;\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+\n+public class SetUnionFunction\n+        extends SqlAggregationFunction\n+{\n+    public static final SetUnionFunction SET_UNION = new SetUnionFunction();\n+    private static final String NAME = \"set_union\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8d96e2d0d18540019822c3531171fe5d2ae1865"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA4MTU2NA==", "bodyText": "Can we be a little more specific? This function definitely behaves differently from set_agg so they probably should not have exactly the same description?", "url": "https://github.com/prestodb/presto/pull/14842#discussion_r459081564", "createdAt": "2020-07-22T21:03:07Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/aggregation/arrayagg/SetUnionFunction.java", "diffHunk": "@@ -0,0 +1,162 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.operator.aggregation.arrayagg;\n+\n+import com.facebook.presto.bytecode.DynamicClassLoader;\n+import com.facebook.presto.common.block.Block;\n+import com.facebook.presto.common.block.BlockBuilder;\n+import com.facebook.presto.common.type.ArrayType;\n+import com.facebook.presto.common.type.StandardTypes;\n+import com.facebook.presto.common.type.Type;\n+import com.facebook.presto.common.type.TypeManager;\n+import com.facebook.presto.common.type.TypeSignatureParameter;\n+import com.facebook.presto.metadata.BoundVariables;\n+import com.facebook.presto.metadata.FunctionManager;\n+import com.facebook.presto.metadata.SqlAggregationFunction;\n+import com.facebook.presto.operator.aggregation.AccumulatorCompiler;\n+import com.facebook.presto.operator.aggregation.AggregationMetadata;\n+import com.facebook.presto.operator.aggregation.AggregationMetadata.AccumulatorStateDescriptor;\n+import com.facebook.presto.operator.aggregation.AggregationMetadata.ParameterMetadata;\n+import com.facebook.presto.operator.aggregation.AggregationUtils;\n+import com.facebook.presto.operator.aggregation.GenericAccumulatorFactoryBinder;\n+import com.facebook.presto.operator.aggregation.InternalAggregationFunction;\n+import com.facebook.presto.operator.aggregation.SetOfValues;\n+import com.facebook.presto.operator.aggregation.state.SetAggregationState;\n+import com.facebook.presto.operator.aggregation.state.SetAggregationStateFactory;\n+import com.facebook.presto.spi.function.AccumulatorState;\n+import com.facebook.presto.spi.function.AccumulatorStateFactory;\n+import com.facebook.presto.spi.function.AccumulatorStateSerializer;\n+import com.google.common.collect.ImmutableList;\n+\n+import java.lang.invoke.MethodHandle;\n+import java.util.List;\n+\n+import static com.facebook.presto.common.type.TypeSignature.parseTypeSignature;\n+import static com.facebook.presto.operator.aggregation.AggregationMetadata.ParameterMetadata.ParameterType.BLOCK_INDEX;\n+import static com.facebook.presto.operator.aggregation.AggregationMetadata.ParameterMetadata.ParameterType.NULLABLE_BLOCK_INPUT_CHANNEL;\n+import static com.facebook.presto.operator.aggregation.AggregationMetadata.ParameterMetadata.ParameterType.STATE;\n+import static com.facebook.presto.spi.function.Signature.typeVariable;\n+import static com.facebook.presto.util.Reflection.methodHandle;\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+\n+public class SetUnionFunction\n+        extends SqlAggregationFunction\n+{\n+    public static final SetUnionFunction SET_UNION = new SetUnionFunction();\n+    private static final String NAME = \"set_union\";\n+    private static final MethodHandle INPUT_FUNCTION = methodHandle(SetUnionFunction.class, \"input\", Type.class, Type.class, SetAggregationState.class, Block.class, int.class);\n+    private static final MethodHandle COMBINE_FUNCTION = methodHandle(SetUnionFunction.class, \"combine\", SetAggregationState.class, SetAggregationState.class);\n+    private static final MethodHandle OUTPUT_FUNCTION = methodHandle(SetUnionFunction.class, \"output\", SetAggregationState.class, BlockBuilder.class);\n+\n+    public SetUnionFunction()\n+    {\n+        super(NAME,\n+                ImmutableList.of(typeVariable(\"T\")),\n+                ImmutableList.of(),\n+                parseTypeSignature(\"array(T)\"),\n+                ImmutableList.of(parseTypeSignature(\"array(T)\")));\n+    }\n+\n+    @Override\n+    public String getDescription()\n+    {\n+        return \"return an array of unique values\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8d96e2d0d18540019822c3531171fe5d2ae1865"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA4NTI1NQ==", "bodyText": "While the types are correct, the names are misleading. The function input type is array<T> not T. T is the element type and array<T> is both the input type and output type.", "url": "https://github.com/prestodb/presto/pull/14842#discussion_r459085255", "createdAt": "2020-07-22T21:10:19Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/aggregation/arrayagg/SetUnionFunction.java", "diffHunk": "@@ -0,0 +1,162 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.operator.aggregation.arrayagg;\n+\n+import com.facebook.presto.bytecode.DynamicClassLoader;\n+import com.facebook.presto.common.block.Block;\n+import com.facebook.presto.common.block.BlockBuilder;\n+import com.facebook.presto.common.type.ArrayType;\n+import com.facebook.presto.common.type.StandardTypes;\n+import com.facebook.presto.common.type.Type;\n+import com.facebook.presto.common.type.TypeManager;\n+import com.facebook.presto.common.type.TypeSignatureParameter;\n+import com.facebook.presto.metadata.BoundVariables;\n+import com.facebook.presto.metadata.FunctionManager;\n+import com.facebook.presto.metadata.SqlAggregationFunction;\n+import com.facebook.presto.operator.aggregation.AccumulatorCompiler;\n+import com.facebook.presto.operator.aggregation.AggregationMetadata;\n+import com.facebook.presto.operator.aggregation.AggregationMetadata.AccumulatorStateDescriptor;\n+import com.facebook.presto.operator.aggregation.AggregationMetadata.ParameterMetadata;\n+import com.facebook.presto.operator.aggregation.AggregationUtils;\n+import com.facebook.presto.operator.aggregation.GenericAccumulatorFactoryBinder;\n+import com.facebook.presto.operator.aggregation.InternalAggregationFunction;\n+import com.facebook.presto.operator.aggregation.SetOfValues;\n+import com.facebook.presto.operator.aggregation.state.SetAggregationState;\n+import com.facebook.presto.operator.aggregation.state.SetAggregationStateFactory;\n+import com.facebook.presto.spi.function.AccumulatorState;\n+import com.facebook.presto.spi.function.AccumulatorStateFactory;\n+import com.facebook.presto.spi.function.AccumulatorStateSerializer;\n+import com.google.common.collect.ImmutableList;\n+\n+import java.lang.invoke.MethodHandle;\n+import java.util.List;\n+\n+import static com.facebook.presto.common.type.TypeSignature.parseTypeSignature;\n+import static com.facebook.presto.operator.aggregation.AggregationMetadata.ParameterMetadata.ParameterType.BLOCK_INDEX;\n+import static com.facebook.presto.operator.aggregation.AggregationMetadata.ParameterMetadata.ParameterType.NULLABLE_BLOCK_INPUT_CHANNEL;\n+import static com.facebook.presto.operator.aggregation.AggregationMetadata.ParameterMetadata.ParameterType.STATE;\n+import static com.facebook.presto.spi.function.Signature.typeVariable;\n+import static com.facebook.presto.util.Reflection.methodHandle;\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+\n+public class SetUnionFunction\n+        extends SqlAggregationFunction\n+{\n+    public static final SetUnionFunction SET_UNION = new SetUnionFunction();\n+    private static final String NAME = \"set_union\";\n+    private static final MethodHandle INPUT_FUNCTION = methodHandle(SetUnionFunction.class, \"input\", Type.class, Type.class, SetAggregationState.class, Block.class, int.class);\n+    private static final MethodHandle COMBINE_FUNCTION = methodHandle(SetUnionFunction.class, \"combine\", SetAggregationState.class, SetAggregationState.class);\n+    private static final MethodHandle OUTPUT_FUNCTION = methodHandle(SetUnionFunction.class, \"output\", SetAggregationState.class, BlockBuilder.class);\n+\n+    public SetUnionFunction()\n+    {\n+        super(NAME,\n+                ImmutableList.of(typeVariable(\"T\")),\n+                ImmutableList.of(),\n+                parseTypeSignature(\"array(T)\"),\n+                ImmutableList.of(parseTypeSignature(\"array(T)\")));\n+    }\n+\n+    @Override\n+    public String getDescription()\n+    {\n+        return \"return an array of unique values\";\n+    }\n+\n+    @Override\n+    public InternalAggregationFunction specialize(BoundVariables boundVariables, int arity, TypeManager typeManager, FunctionManager functionManager)\n+    {\n+        Type type = boundVariables.getTypeVariable(\"T\");\n+        ArrayType outputType = (ArrayType) typeManager.getParameterizedType(StandardTypes.ARRAY, ImmutableList.of(\n+                TypeSignatureParameter.of(type.getTypeSignature())));\n+        return generateAggregation(type, outputType);\n+    }\n+\n+    private static InternalAggregationFunction generateAggregation(Type type, ArrayType outputType)\n+    {\n+        DynamicClassLoader classLoader = new DynamicClassLoader(SetUnionFunction.class.getClassLoader());\n+\n+        List<Type> inputTypes = ImmutableList.of(type);\n+        AccumulatorStateSerializer<?> stateSerializer = new SetAggregationStateSerializer(outputType);\n+        AccumulatorStateFactory<?> stateFactory = new SetAggregationStateFactory(type);\n+\n+        Type intermediateType = stateSerializer.getSerializedType();\n+        List<ParameterMetadata> inputParameterMetadata = createInputParameterMetadata(type);\n+        Class<? extends AccumulatorState> stateInterface = SetAggregationState.class;\n+        AggregationMetadata metadata = new AggregationMetadata(\n+                AggregationUtils.generateAggregationName(NAME, outputType.getTypeSignature(), inputTypes.stream().map(Type::getTypeSignature).collect(toImmutableList())),\n+                inputParameterMetadata,\n+                INPUT_FUNCTION.bindTo(type).bindTo(outputType),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8d96e2d0d18540019822c3531171fe5d2ae1865"}, "originalPosition": 100}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA4NjA4OQ==", "bodyText": "It's probably more efficient to just do ImmutableList.of(type.getTypeSignature()) here rather than creating an ImmutableList of one element and iterate through it.", "url": "https://github.com/prestodb/presto/pull/14842#discussion_r459086089", "createdAt": "2020-07-22T21:12:01Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/aggregation/arrayagg/SetUnionFunction.java", "diffHunk": "@@ -0,0 +1,162 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.operator.aggregation.arrayagg;\n+\n+import com.facebook.presto.bytecode.DynamicClassLoader;\n+import com.facebook.presto.common.block.Block;\n+import com.facebook.presto.common.block.BlockBuilder;\n+import com.facebook.presto.common.type.ArrayType;\n+import com.facebook.presto.common.type.StandardTypes;\n+import com.facebook.presto.common.type.Type;\n+import com.facebook.presto.common.type.TypeManager;\n+import com.facebook.presto.common.type.TypeSignatureParameter;\n+import com.facebook.presto.metadata.BoundVariables;\n+import com.facebook.presto.metadata.FunctionManager;\n+import com.facebook.presto.metadata.SqlAggregationFunction;\n+import com.facebook.presto.operator.aggregation.AccumulatorCompiler;\n+import com.facebook.presto.operator.aggregation.AggregationMetadata;\n+import com.facebook.presto.operator.aggregation.AggregationMetadata.AccumulatorStateDescriptor;\n+import com.facebook.presto.operator.aggregation.AggregationMetadata.ParameterMetadata;\n+import com.facebook.presto.operator.aggregation.AggregationUtils;\n+import com.facebook.presto.operator.aggregation.GenericAccumulatorFactoryBinder;\n+import com.facebook.presto.operator.aggregation.InternalAggregationFunction;\n+import com.facebook.presto.operator.aggregation.SetOfValues;\n+import com.facebook.presto.operator.aggregation.state.SetAggregationState;\n+import com.facebook.presto.operator.aggregation.state.SetAggregationStateFactory;\n+import com.facebook.presto.spi.function.AccumulatorState;\n+import com.facebook.presto.spi.function.AccumulatorStateFactory;\n+import com.facebook.presto.spi.function.AccumulatorStateSerializer;\n+import com.google.common.collect.ImmutableList;\n+\n+import java.lang.invoke.MethodHandle;\n+import java.util.List;\n+\n+import static com.facebook.presto.common.type.TypeSignature.parseTypeSignature;\n+import static com.facebook.presto.operator.aggregation.AggregationMetadata.ParameterMetadata.ParameterType.BLOCK_INDEX;\n+import static com.facebook.presto.operator.aggregation.AggregationMetadata.ParameterMetadata.ParameterType.NULLABLE_BLOCK_INPUT_CHANNEL;\n+import static com.facebook.presto.operator.aggregation.AggregationMetadata.ParameterMetadata.ParameterType.STATE;\n+import static com.facebook.presto.spi.function.Signature.typeVariable;\n+import static com.facebook.presto.util.Reflection.methodHandle;\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+\n+public class SetUnionFunction\n+        extends SqlAggregationFunction\n+{\n+    public static final SetUnionFunction SET_UNION = new SetUnionFunction();\n+    private static final String NAME = \"set_union\";\n+    private static final MethodHandle INPUT_FUNCTION = methodHandle(SetUnionFunction.class, \"input\", Type.class, Type.class, SetAggregationState.class, Block.class, int.class);\n+    private static final MethodHandle COMBINE_FUNCTION = methodHandle(SetUnionFunction.class, \"combine\", SetAggregationState.class, SetAggregationState.class);\n+    private static final MethodHandle OUTPUT_FUNCTION = methodHandle(SetUnionFunction.class, \"output\", SetAggregationState.class, BlockBuilder.class);\n+\n+    public SetUnionFunction()\n+    {\n+        super(NAME,\n+                ImmutableList.of(typeVariable(\"T\")),\n+                ImmutableList.of(),\n+                parseTypeSignature(\"array(T)\"),\n+                ImmutableList.of(parseTypeSignature(\"array(T)\")));\n+    }\n+\n+    @Override\n+    public String getDescription()\n+    {\n+        return \"return an array of unique values\";\n+    }\n+\n+    @Override\n+    public InternalAggregationFunction specialize(BoundVariables boundVariables, int arity, TypeManager typeManager, FunctionManager functionManager)\n+    {\n+        Type type = boundVariables.getTypeVariable(\"T\");\n+        ArrayType outputType = (ArrayType) typeManager.getParameterizedType(StandardTypes.ARRAY, ImmutableList.of(\n+                TypeSignatureParameter.of(type.getTypeSignature())));\n+        return generateAggregation(type, outputType);\n+    }\n+\n+    private static InternalAggregationFunction generateAggregation(Type type, ArrayType outputType)\n+    {\n+        DynamicClassLoader classLoader = new DynamicClassLoader(SetUnionFunction.class.getClassLoader());\n+\n+        List<Type> inputTypes = ImmutableList.of(type);\n+        AccumulatorStateSerializer<?> stateSerializer = new SetAggregationStateSerializer(outputType);\n+        AccumulatorStateFactory<?> stateFactory = new SetAggregationStateFactory(type);\n+\n+        Type intermediateType = stateSerializer.getSerializedType();\n+        List<ParameterMetadata> inputParameterMetadata = createInputParameterMetadata(type);\n+        Class<? extends AccumulatorState> stateInterface = SetAggregationState.class;\n+        AggregationMetadata metadata = new AggregationMetadata(\n+                AggregationUtils.generateAggregationName(NAME, outputType.getTypeSignature(), inputTypes.stream().map(Type::getTypeSignature).collect(toImmutableList())),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8d96e2d0d18540019822c3531171fe5d2ae1865"}, "originalPosition": 98}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA4Njk4Mw==", "bodyText": "You can probably inline the function.", "url": "https://github.com/prestodb/presto/pull/14842#discussion_r459086983", "createdAt": "2020-07-22T21:13:51Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/aggregation/arrayagg/SetUnionFunction.java", "diffHunk": "@@ -0,0 +1,162 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.operator.aggregation.arrayagg;\n+\n+import com.facebook.presto.bytecode.DynamicClassLoader;\n+import com.facebook.presto.common.block.Block;\n+import com.facebook.presto.common.block.BlockBuilder;\n+import com.facebook.presto.common.type.ArrayType;\n+import com.facebook.presto.common.type.StandardTypes;\n+import com.facebook.presto.common.type.Type;\n+import com.facebook.presto.common.type.TypeManager;\n+import com.facebook.presto.common.type.TypeSignatureParameter;\n+import com.facebook.presto.metadata.BoundVariables;\n+import com.facebook.presto.metadata.FunctionManager;\n+import com.facebook.presto.metadata.SqlAggregationFunction;\n+import com.facebook.presto.operator.aggregation.AccumulatorCompiler;\n+import com.facebook.presto.operator.aggregation.AggregationMetadata;\n+import com.facebook.presto.operator.aggregation.AggregationMetadata.AccumulatorStateDescriptor;\n+import com.facebook.presto.operator.aggregation.AggregationMetadata.ParameterMetadata;\n+import com.facebook.presto.operator.aggregation.AggregationUtils;\n+import com.facebook.presto.operator.aggregation.GenericAccumulatorFactoryBinder;\n+import com.facebook.presto.operator.aggregation.InternalAggregationFunction;\n+import com.facebook.presto.operator.aggregation.SetOfValues;\n+import com.facebook.presto.operator.aggregation.state.SetAggregationState;\n+import com.facebook.presto.operator.aggregation.state.SetAggregationStateFactory;\n+import com.facebook.presto.spi.function.AccumulatorState;\n+import com.facebook.presto.spi.function.AccumulatorStateFactory;\n+import com.facebook.presto.spi.function.AccumulatorStateSerializer;\n+import com.google.common.collect.ImmutableList;\n+\n+import java.lang.invoke.MethodHandle;\n+import java.util.List;\n+\n+import static com.facebook.presto.common.type.TypeSignature.parseTypeSignature;\n+import static com.facebook.presto.operator.aggregation.AggregationMetadata.ParameterMetadata.ParameterType.BLOCK_INDEX;\n+import static com.facebook.presto.operator.aggregation.AggregationMetadata.ParameterMetadata.ParameterType.NULLABLE_BLOCK_INPUT_CHANNEL;\n+import static com.facebook.presto.operator.aggregation.AggregationMetadata.ParameterMetadata.ParameterType.STATE;\n+import static com.facebook.presto.spi.function.Signature.typeVariable;\n+import static com.facebook.presto.util.Reflection.methodHandle;\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+\n+public class SetUnionFunction\n+        extends SqlAggregationFunction\n+{\n+    public static final SetUnionFunction SET_UNION = new SetUnionFunction();\n+    private static final String NAME = \"set_union\";\n+    private static final MethodHandle INPUT_FUNCTION = methodHandle(SetUnionFunction.class, \"input\", Type.class, Type.class, SetAggregationState.class, Block.class, int.class);\n+    private static final MethodHandle COMBINE_FUNCTION = methodHandle(SetUnionFunction.class, \"combine\", SetAggregationState.class, SetAggregationState.class);\n+    private static final MethodHandle OUTPUT_FUNCTION = methodHandle(SetUnionFunction.class, \"output\", SetAggregationState.class, BlockBuilder.class);\n+\n+    public SetUnionFunction()\n+    {\n+        super(NAME,\n+                ImmutableList.of(typeVariable(\"T\")),\n+                ImmutableList.of(),\n+                parseTypeSignature(\"array(T)\"),\n+                ImmutableList.of(parseTypeSignature(\"array(T)\")));\n+    }\n+\n+    @Override\n+    public String getDescription()\n+    {\n+        return \"return an array of unique values\";\n+    }\n+\n+    @Override\n+    public InternalAggregationFunction specialize(BoundVariables boundVariables, int arity, TypeManager typeManager, FunctionManager functionManager)\n+    {\n+        Type type = boundVariables.getTypeVariable(\"T\");\n+        ArrayType outputType = (ArrayType) typeManager.getParameterizedType(StandardTypes.ARRAY, ImmutableList.of(\n+                TypeSignatureParameter.of(type.getTypeSignature())));\n+        return generateAggregation(type, outputType);\n+    }\n+\n+    private static InternalAggregationFunction generateAggregation(Type type, ArrayType outputType)\n+    {\n+        DynamicClassLoader classLoader = new DynamicClassLoader(SetUnionFunction.class.getClassLoader());\n+\n+        List<Type> inputTypes = ImmutableList.of(type);\n+        AccumulatorStateSerializer<?> stateSerializer = new SetAggregationStateSerializer(outputType);\n+        AccumulatorStateFactory<?> stateFactory = new SetAggregationStateFactory(type);\n+\n+        Type intermediateType = stateSerializer.getSerializedType();\n+        List<ParameterMetadata> inputParameterMetadata = createInputParameterMetadata(type);\n+        Class<? extends AccumulatorState> stateInterface = SetAggregationState.class;\n+        AggregationMetadata metadata = new AggregationMetadata(\n+                AggregationUtils.generateAggregationName(NAME, outputType.getTypeSignature(), inputTypes.stream().map(Type::getTypeSignature).collect(toImmutableList())),\n+                inputParameterMetadata,\n+                INPUT_FUNCTION.bindTo(type).bindTo(outputType),\n+                COMBINE_FUNCTION,\n+                OUTPUT_FUNCTION,\n+                ImmutableList.of(new AccumulatorStateDescriptor(\n+                        stateInterface,\n+                        stateSerializer,\n+                        stateFactory)),\n+                outputType);\n+\n+        GenericAccumulatorFactoryBinder factory = AccumulatorCompiler.generateAccumulatorFactoryBinder(metadata, classLoader);\n+        return new InternalAggregationFunction(NAME, inputTypes, ImmutableList.of(intermediateType), outputType, true, true, factory);\n+    }\n+\n+    private static List<ParameterMetadata> createInputParameterMetadata(Type value)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8d96e2d0d18540019822c3531171fe5d2ae1865"}, "originalPosition": 113}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA4ODk3Mg==", "bodyText": "The type of arrayType should be ArrayType. Make it specific so the cast in line 127 is safe.", "url": "https://github.com/prestodb/presto/pull/14842#discussion_r459088972", "createdAt": "2020-07-22T21:17:40Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/aggregation/arrayagg/SetUnionFunction.java", "diffHunk": "@@ -0,0 +1,162 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.operator.aggregation.arrayagg;\n+\n+import com.facebook.presto.bytecode.DynamicClassLoader;\n+import com.facebook.presto.common.block.Block;\n+import com.facebook.presto.common.block.BlockBuilder;\n+import com.facebook.presto.common.type.ArrayType;\n+import com.facebook.presto.common.type.StandardTypes;\n+import com.facebook.presto.common.type.Type;\n+import com.facebook.presto.common.type.TypeManager;\n+import com.facebook.presto.common.type.TypeSignatureParameter;\n+import com.facebook.presto.metadata.BoundVariables;\n+import com.facebook.presto.metadata.FunctionManager;\n+import com.facebook.presto.metadata.SqlAggregationFunction;\n+import com.facebook.presto.operator.aggregation.AccumulatorCompiler;\n+import com.facebook.presto.operator.aggregation.AggregationMetadata;\n+import com.facebook.presto.operator.aggregation.AggregationMetadata.AccumulatorStateDescriptor;\n+import com.facebook.presto.operator.aggregation.AggregationMetadata.ParameterMetadata;\n+import com.facebook.presto.operator.aggregation.AggregationUtils;\n+import com.facebook.presto.operator.aggregation.GenericAccumulatorFactoryBinder;\n+import com.facebook.presto.operator.aggregation.InternalAggregationFunction;\n+import com.facebook.presto.operator.aggregation.SetOfValues;\n+import com.facebook.presto.operator.aggregation.state.SetAggregationState;\n+import com.facebook.presto.operator.aggregation.state.SetAggregationStateFactory;\n+import com.facebook.presto.spi.function.AccumulatorState;\n+import com.facebook.presto.spi.function.AccumulatorStateFactory;\n+import com.facebook.presto.spi.function.AccumulatorStateSerializer;\n+import com.google.common.collect.ImmutableList;\n+\n+import java.lang.invoke.MethodHandle;\n+import java.util.List;\n+\n+import static com.facebook.presto.common.type.TypeSignature.parseTypeSignature;\n+import static com.facebook.presto.operator.aggregation.AggregationMetadata.ParameterMetadata.ParameterType.BLOCK_INDEX;\n+import static com.facebook.presto.operator.aggregation.AggregationMetadata.ParameterMetadata.ParameterType.NULLABLE_BLOCK_INPUT_CHANNEL;\n+import static com.facebook.presto.operator.aggregation.AggregationMetadata.ParameterMetadata.ParameterType.STATE;\n+import static com.facebook.presto.spi.function.Signature.typeVariable;\n+import static com.facebook.presto.util.Reflection.methodHandle;\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+\n+public class SetUnionFunction\n+        extends SqlAggregationFunction\n+{\n+    public static final SetUnionFunction SET_UNION = new SetUnionFunction();\n+    private static final String NAME = \"set_union\";\n+    private static final MethodHandle INPUT_FUNCTION = methodHandle(SetUnionFunction.class, \"input\", Type.class, Type.class, SetAggregationState.class, Block.class, int.class);\n+    private static final MethodHandle COMBINE_FUNCTION = methodHandle(SetUnionFunction.class, \"combine\", SetAggregationState.class, SetAggregationState.class);\n+    private static final MethodHandle OUTPUT_FUNCTION = methodHandle(SetUnionFunction.class, \"output\", SetAggregationState.class, BlockBuilder.class);\n+\n+    public SetUnionFunction()\n+    {\n+        super(NAME,\n+                ImmutableList.of(typeVariable(\"T\")),\n+                ImmutableList.of(),\n+                parseTypeSignature(\"array(T)\"),\n+                ImmutableList.of(parseTypeSignature(\"array(T)\")));\n+    }\n+\n+    @Override\n+    public String getDescription()\n+    {\n+        return \"return an array of unique values\";\n+    }\n+\n+    @Override\n+    public InternalAggregationFunction specialize(BoundVariables boundVariables, int arity, TypeManager typeManager, FunctionManager functionManager)\n+    {\n+        Type type = boundVariables.getTypeVariable(\"T\");\n+        ArrayType outputType = (ArrayType) typeManager.getParameterizedType(StandardTypes.ARRAY, ImmutableList.of(\n+                TypeSignatureParameter.of(type.getTypeSignature())));\n+        return generateAggregation(type, outputType);\n+    }\n+\n+    private static InternalAggregationFunction generateAggregation(Type type, ArrayType outputType)\n+    {\n+        DynamicClassLoader classLoader = new DynamicClassLoader(SetUnionFunction.class.getClassLoader());\n+\n+        List<Type> inputTypes = ImmutableList.of(type);\n+        AccumulatorStateSerializer<?> stateSerializer = new SetAggregationStateSerializer(outputType);\n+        AccumulatorStateFactory<?> stateFactory = new SetAggregationStateFactory(type);\n+\n+        Type intermediateType = stateSerializer.getSerializedType();\n+        List<ParameterMetadata> inputParameterMetadata = createInputParameterMetadata(type);\n+        Class<? extends AccumulatorState> stateInterface = SetAggregationState.class;\n+        AggregationMetadata metadata = new AggregationMetadata(\n+                AggregationUtils.generateAggregationName(NAME, outputType.getTypeSignature(), inputTypes.stream().map(Type::getTypeSignature).collect(toImmutableList())),\n+                inputParameterMetadata,\n+                INPUT_FUNCTION.bindTo(type).bindTo(outputType),\n+                COMBINE_FUNCTION,\n+                OUTPUT_FUNCTION,\n+                ImmutableList.of(new AccumulatorStateDescriptor(\n+                        stateInterface,\n+                        stateSerializer,\n+                        stateFactory)),\n+                outputType);\n+\n+        GenericAccumulatorFactoryBinder factory = AccumulatorCompiler.generateAccumulatorFactoryBinder(metadata, classLoader);\n+        return new InternalAggregationFunction(NAME, inputTypes, ImmutableList.of(intermediateType), outputType, true, true, factory);\n+    }\n+\n+    private static List<ParameterMetadata> createInputParameterMetadata(Type value)\n+    {\n+        return ImmutableList.of(new ParameterMetadata(STATE), new ParameterMetadata(NULLABLE_BLOCK_INPUT_CHANNEL, value), new ParameterMetadata(BLOCK_INDEX));\n+    }\n+\n+    public static void input(Type type, Type arrayType, SetAggregationState state, Block inputBlock, int position)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8d96e2d0d18540019822c3531171fe5d2ae1865"}, "originalPosition": 118}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA4OTkxMw==", "bodyText": "Can we add some tests with group bys  as well?", "url": "https://github.com/prestodb/presto/pull/14842#discussion_r459089913", "createdAt": "2020-07-22T21:19:35Z", "author": {"login": "rongrong"}, "path": "presto-tests/src/main/java/com/facebook/presto/tests/AbstractTestQueries.java", "diffHunk": "@@ -8512,6 +8512,34 @@ public void testComparisonWithLike()\n                 \"ON t1.orderkey=t2.orderkey\");\n     }\n \n+    @Test\n+    public void testSetUnion()\n+    {\n+        // sanity\n+        assertQuery(\n+                \"select set_union(x) from (values array[1, 2], array[3, 4], array[5, 6]) as t(x)\",\n+                \"select array[1, 2, 3, 4, 5, 6]\");\n+        assertQuery(\n+                \"select set_union(x) from (values array[1, 2, 3], array[2, 3, 4], array[7, 8]) as t(x)\",\n+                \"select array[1, 2, 3, 4, 7, 8]\");\n+        // all nulls should return empty array to match behavior of array_distinct(flatten(array_agg(x)))\n+        assertQuery(\n+                \"select set_union(x) from (values null, null, null) as t(x)\",\n+                \"select array[]\");\n+        // nulls inside arrays should be captured while pure nulls should be ignored\n+        assertQuery(\n+                \"select set_union(x) from (values null, array[null], null) as t(x)\",\n+                \"select array[null]\");\n+        // null inside arrays should be captured\n+        assertQuery(\n+                \"select set_union(x) from (values array[1, 2, 3], array[null], null) as t(x)\",\n+                \"select array[1, 2, 3, null]\");\n+        // return null for empty rows\n+        assertQuery(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8d96e2d0d18540019822c3531171fe5d2ae1865"}, "originalPosition": 27}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d8d96e2d0d18540019822c3531171fe5d2ae1865", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/d8d96e2d0d18540019822c3531171fe5d2ae1865", "committedDate": "2020-07-21T21:44:15Z", "message": "Implement new function SET_UNION\n\nSET_UNION is a more efficient alternative to the common pattern of\nARRAY_DISTINCT(FLATTEN(ARRAY_AGG(x)))"}, "afterCommit": {"oid": "782e041eba2168195467581b40629d4c0427112f", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/782e041eba2168195467581b40629d4c0427112f", "committedDate": "2020-07-23T18:49:02Z", "message": "Implement new function SET_UNION\n\nSET_UNION is a more efficient alternative to the common pattern of\nARRAY_DISTINCT(FLATTEN(ARRAY_AGG(x)))"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "782e041eba2168195467581b40629d4c0427112f", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/782e041eba2168195467581b40629d4c0427112f", "committedDate": "2020-07-23T18:49:02Z", "message": "Implement new function SET_UNION\n\nSET_UNION is a more efficient alternative to the common pattern of\nARRAY_DISTINCT(FLATTEN(ARRAY_AGG(x)))"}, "afterCommit": {"oid": "419d267c59408768e9008d40cff0da33037abc43", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/419d267c59408768e9008d40cff0da33037abc43", "committedDate": "2020-07-23T18:58:48Z", "message": "Implement new function SET_UNION\n\nSET_UNION is a more efficient alternative to the common pattern of\nARRAY_DISTINCT(FLATTEN(ARRAY_AGG(x)))"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "419d267c59408768e9008d40cff0da33037abc43", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/419d267c59408768e9008d40cff0da33037abc43", "committedDate": "2020-07-23T18:58:48Z", "message": "Implement new function SET_UNION\n\nSET_UNION is a more efficient alternative to the common pattern of\nARRAY_DISTINCT(FLATTEN(ARRAY_AGG(x)))"}, "afterCommit": {"oid": "cc4e2922767b3becdbe0c3b36e813a659bc01b38", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/cc4e2922767b3becdbe0c3b36e813a659bc01b38", "committedDate": "2020-07-23T18:59:20Z", "message": "Implement new function SET_UNION\n\nSET_UNION is a more efficient alternative to the common pattern of\nARRAY_DISTINCT(FLATTEN(ARRAY_AGG(x)))"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0NDEyNTI4", "url": "https://github.com/prestodb/presto/pull/14842#pullrequestreview-454412528", "createdAt": "2020-07-23T18:58:05Z", "commit": {"oid": "782e041eba2168195467581b40629d4c0427112f"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxODo1ODowNVrOG2Xk7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxODo1OTo1NFrOG2XolA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY2MjU3NA==", "bodyText": "I think it's cleaner to move this line to generateAggregation so generateAggregation only takes elementType as input. But I don't have strong opinions.", "url": "https://github.com/prestodb/presto/pull/14842#discussion_r459662574", "createdAt": "2020-07-23T18:58:05Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/aggregation/arrayagg/SetUnionFunction.java", "diffHunk": "@@ -0,0 +1,160 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.operator.aggregation.arrayagg;\n+\n+import com.facebook.presto.bytecode.DynamicClassLoader;\n+import com.facebook.presto.common.block.Block;\n+import com.facebook.presto.common.block.BlockBuilder;\n+import com.facebook.presto.common.type.ArrayType;\n+import com.facebook.presto.common.type.StandardTypes;\n+import com.facebook.presto.common.type.Type;\n+import com.facebook.presto.common.type.TypeManager;\n+import com.facebook.presto.common.type.TypeSignatureParameter;\n+import com.facebook.presto.metadata.BoundVariables;\n+import com.facebook.presto.metadata.FunctionManager;\n+import com.facebook.presto.metadata.SqlAggregationFunction;\n+import com.facebook.presto.operator.aggregation.AccumulatorCompiler;\n+import com.facebook.presto.operator.aggregation.AggregationMetadata;\n+import com.facebook.presto.operator.aggregation.AggregationMetadata.AccumulatorStateDescriptor;\n+import com.facebook.presto.operator.aggregation.AggregationMetadata.ParameterMetadata;\n+import com.facebook.presto.operator.aggregation.AggregationUtils;\n+import com.facebook.presto.operator.aggregation.GenericAccumulatorFactoryBinder;\n+import com.facebook.presto.operator.aggregation.InternalAggregationFunction;\n+import com.facebook.presto.operator.aggregation.SetOfValues;\n+import com.facebook.presto.operator.aggregation.state.SetAggregationState;\n+import com.facebook.presto.operator.aggregation.state.SetAggregationStateFactory;\n+import com.facebook.presto.spi.function.AccumulatorState;\n+import com.facebook.presto.spi.function.AccumulatorStateFactory;\n+import com.facebook.presto.spi.function.AccumulatorStateSerializer;\n+import com.google.common.collect.ImmutableList;\n+\n+import java.lang.invoke.MethodHandle;\n+import java.util.List;\n+\n+import static com.facebook.presto.common.type.TypeSignature.parseTypeSignature;\n+import static com.facebook.presto.operator.aggregation.AggregationMetadata.ParameterMetadata.ParameterType.BLOCK_INDEX;\n+import static com.facebook.presto.operator.aggregation.AggregationMetadata.ParameterMetadata.ParameterType.NULLABLE_BLOCK_INPUT_CHANNEL;\n+import static com.facebook.presto.operator.aggregation.AggregationMetadata.ParameterMetadata.ParameterType.STATE;\n+import static com.facebook.presto.spi.function.Signature.typeVariable;\n+import static com.facebook.presto.util.Reflection.methodHandle;\n+\n+public class SetUnionFunction\n+        extends SqlAggregationFunction\n+{\n+    public static final SetUnionFunction SET_UNION = new SetUnionFunction();\n+\n+    private static final String NAME = \"set_union\";\n+    private static final MethodHandle INPUT_FUNCTION = methodHandle(SetUnionFunction.class, \"input\", Type.class, ArrayType.class, SetAggregationState.class, Block.class, int.class);\n+    private static final MethodHandle COMBINE_FUNCTION = methodHandle(SetUnionFunction.class, \"combine\", SetAggregationState.class, SetAggregationState.class);\n+    private static final MethodHandle OUTPUT_FUNCTION = methodHandle(SetUnionFunction.class, \"output\", SetAggregationState.class, BlockBuilder.class);\n+\n+    public SetUnionFunction()\n+    {\n+        super(NAME,\n+                ImmutableList.of(typeVariable(\"T\")),\n+                ImmutableList.of(),\n+                parseTypeSignature(\"array(T)\"),\n+                ImmutableList.of(parseTypeSignature(\"array(T)\")));\n+    }\n+\n+    @Override\n+    public String getDescription()\n+    {\n+        return \"Given a column of array type, return an array of all the unique values contained in each of the arrays in the column\";\n+    }\n+\n+    @Override\n+    public InternalAggregationFunction specialize(BoundVariables boundVariables, int arity, TypeManager typeManager, FunctionManager functionManager)\n+    {\n+        Type elementType = boundVariables.getTypeVariable(\"T\");\n+        ArrayType arrayType = (ArrayType) typeManager.getParameterizedType(StandardTypes.ARRAY, ImmutableList.of(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "782e041eba2168195467581b40629d4c0427112f"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY2MzUwOA==", "bodyText": "You can inline this and remove the variable.", "url": "https://github.com/prestodb/presto/pull/14842#discussion_r459663508", "createdAt": "2020-07-23T18:59:54Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/aggregation/arrayagg/SetUnionFunction.java", "diffHunk": "@@ -0,0 +1,160 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.operator.aggregation.arrayagg;\n+\n+import com.facebook.presto.bytecode.DynamicClassLoader;\n+import com.facebook.presto.common.block.Block;\n+import com.facebook.presto.common.block.BlockBuilder;\n+import com.facebook.presto.common.type.ArrayType;\n+import com.facebook.presto.common.type.StandardTypes;\n+import com.facebook.presto.common.type.Type;\n+import com.facebook.presto.common.type.TypeManager;\n+import com.facebook.presto.common.type.TypeSignatureParameter;\n+import com.facebook.presto.metadata.BoundVariables;\n+import com.facebook.presto.metadata.FunctionManager;\n+import com.facebook.presto.metadata.SqlAggregationFunction;\n+import com.facebook.presto.operator.aggregation.AccumulatorCompiler;\n+import com.facebook.presto.operator.aggregation.AggregationMetadata;\n+import com.facebook.presto.operator.aggregation.AggregationMetadata.AccumulatorStateDescriptor;\n+import com.facebook.presto.operator.aggregation.AggregationMetadata.ParameterMetadata;\n+import com.facebook.presto.operator.aggregation.AggregationUtils;\n+import com.facebook.presto.operator.aggregation.GenericAccumulatorFactoryBinder;\n+import com.facebook.presto.operator.aggregation.InternalAggregationFunction;\n+import com.facebook.presto.operator.aggregation.SetOfValues;\n+import com.facebook.presto.operator.aggregation.state.SetAggregationState;\n+import com.facebook.presto.operator.aggregation.state.SetAggregationStateFactory;\n+import com.facebook.presto.spi.function.AccumulatorState;\n+import com.facebook.presto.spi.function.AccumulatorStateFactory;\n+import com.facebook.presto.spi.function.AccumulatorStateSerializer;\n+import com.google.common.collect.ImmutableList;\n+\n+import java.lang.invoke.MethodHandle;\n+import java.util.List;\n+\n+import static com.facebook.presto.common.type.TypeSignature.parseTypeSignature;\n+import static com.facebook.presto.operator.aggregation.AggregationMetadata.ParameterMetadata.ParameterType.BLOCK_INDEX;\n+import static com.facebook.presto.operator.aggregation.AggregationMetadata.ParameterMetadata.ParameterType.NULLABLE_BLOCK_INPUT_CHANNEL;\n+import static com.facebook.presto.operator.aggregation.AggregationMetadata.ParameterMetadata.ParameterType.STATE;\n+import static com.facebook.presto.spi.function.Signature.typeVariable;\n+import static com.facebook.presto.util.Reflection.methodHandle;\n+\n+public class SetUnionFunction\n+        extends SqlAggregationFunction\n+{\n+    public static final SetUnionFunction SET_UNION = new SetUnionFunction();\n+\n+    private static final String NAME = \"set_union\";\n+    private static final MethodHandle INPUT_FUNCTION = methodHandle(SetUnionFunction.class, \"input\", Type.class, ArrayType.class, SetAggregationState.class, Block.class, int.class);\n+    private static final MethodHandle COMBINE_FUNCTION = methodHandle(SetUnionFunction.class, \"combine\", SetAggregationState.class, SetAggregationState.class);\n+    private static final MethodHandle OUTPUT_FUNCTION = methodHandle(SetUnionFunction.class, \"output\", SetAggregationState.class, BlockBuilder.class);\n+\n+    public SetUnionFunction()\n+    {\n+        super(NAME,\n+                ImmutableList.of(typeVariable(\"T\")),\n+                ImmutableList.of(),\n+                parseTypeSignature(\"array(T)\"),\n+                ImmutableList.of(parseTypeSignature(\"array(T)\")));\n+    }\n+\n+    @Override\n+    public String getDescription()\n+    {\n+        return \"Given a column of array type, return an array of all the unique values contained in each of the arrays in the column\";\n+    }\n+\n+    @Override\n+    public InternalAggregationFunction specialize(BoundVariables boundVariables, int arity, TypeManager typeManager, FunctionManager functionManager)\n+    {\n+        Type elementType = boundVariables.getTypeVariable(\"T\");\n+        ArrayType arrayType = (ArrayType) typeManager.getParameterizedType(StandardTypes.ARRAY, ImmutableList.of(\n+                TypeSignatureParameter.of(elementType.getTypeSignature())));\n+        return generateAggregation(elementType, arrayType);\n+    }\n+\n+    private static InternalAggregationFunction generateAggregation(Type elementType, ArrayType arrayType)\n+    {\n+        DynamicClassLoader classLoader = new DynamicClassLoader(SetUnionFunction.class.getClassLoader());\n+\n+        List<Type> inputTypes = ImmutableList.of(elementType);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc4e2922767b3becdbe0c3b36e813a659bc01b38"}, "originalPosition": 90}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cc4e2922767b3becdbe0c3b36e813a659bc01b38", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/cc4e2922767b3becdbe0c3b36e813a659bc01b38", "committedDate": "2020-07-23T18:59:20Z", "message": "Implement new function SET_UNION\n\nSET_UNION is a more efficient alternative to the common pattern of\nARRAY_DISTINCT(FLATTEN(ARRAY_AGG(x)))"}, "afterCommit": {"oid": "aadc907aee4b8e24c2779c5d6c4e19f0863f3a29", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/aadc907aee4b8e24c2779c5d6c4e19f0863f3a29", "committedDate": "2020-07-23T19:20:28Z", "message": "Add aggregation function SET_UNION\n\nSET_UNION is a more efficient alternative to the common pattern of\nARRAY_DISTINCT(FLATTEN(ARRAY_AGG(x)))"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9527f9fdcd70444b2dd1a9a2c04762949164b08", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/e9527f9fdcd70444b2dd1a9a2c04762949164b08", "committedDate": "2020-07-24T00:13:03Z", "message": "Add aggregation function SET_UNION\n\nSET_UNION is a more efficient alternative to the common pattern of\nARRAY_DISTINCT(FLATTEN(ARRAY_AGG(x)))"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "aadc907aee4b8e24c2779c5d6c4e19f0863f3a29", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/aadc907aee4b8e24c2779c5d6c4e19f0863f3a29", "committedDate": "2020-07-23T19:20:28Z", "message": "Add aggregation function SET_UNION\n\nSET_UNION is a more efficient alternative to the common pattern of\nARRAY_DISTINCT(FLATTEN(ARRAY_AGG(x)))"}, "afterCommit": {"oid": "e9527f9fdcd70444b2dd1a9a2c04762949164b08", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/e9527f9fdcd70444b2dd1a9a2c04762949164b08", "committedDate": "2020-07-24T00:13:03Z", "message": "Add aggregation function SET_UNION\n\nSET_UNION is a more efficient alternative to the common pattern of\nARRAY_DISTINCT(FLATTEN(ARRAY_AGG(x)))"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1270, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}