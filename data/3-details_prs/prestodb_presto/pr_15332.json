{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA2MTEwNDM3", "number": 15332, "title": "Fix druid reading issue", "bodyText": "This PR solves the problem of reading from druid caused by using the ARRAY_LINES result format. When applying any unsupported transformation(expression) to one of the selected columns and filtering on other columns, this will cause the dql to be build and sent to druid with all the columns in select and filter statements, leading to a larger number of columns returned to be processed, hence, parsing the wrong column if we are depending on the column indices (since columnHandles size differ from the returned data array size).\nTest plan:\nApplying the following query on wikipedia test dataset provided by druid, before and after the change:\nselect if(cityname = '', 'hi', cityname), count\nfrom druid.wikipedia\nwhere __time > timestamp '2016-06-27 13:00:00';\n\n== RELEASE NOTES ==\n\nDruid Changes\n* Fix druid reading issue", "createdAt": "2020-10-19T16:26:40Z", "url": "https://github.com/prestodb/presto/pull/15332", "merged": true, "mergeCommit": {"oid": "8c620762c3e199743300d24c78b6c1cb886a4f8f"}, "closed": true, "closedAt": "2020-10-26T16:42:04Z", "author": {"login": "adlymousa"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdUGd0JgH2gAyNTA2MTEwNDM3OjhkYTI4ZTAxMDVmYjgxMjMwMTFmYTdkYzJiYzE5MGU2MjYzMmRmODU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdWXJrAgFqTUxNjk3MDAxMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8da28e0105fb8123011fa7dc2bc190e62632df85", "author": {"user": {"login": "adlymousa", "name": null}}, "url": "https://github.com/prestodb/presto/commit/8da28e0105fb8123011fa7dc2bc190e62632df85", "committedDate": "2020-10-19T16:07:43Z", "message": "Fix druid reading issue"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzMDE0Mjcy", "url": "https://github.com/prestodb/presto/pull/15332#pullrequestreview-513014272", "createdAt": "2020-10-20T18:23:49Z", "commit": {"oid": "8da28e0105fb8123011fa7dc2bc190e62632df85"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxODoyMzo0OVrOHlLTfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxODoyMzo0OVrOHlLTfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc0NDU3NQ==", "bodyText": "Sometimes the error message might be helpful.  But looks like each row is an json object now, we cannot use the if condition 'rootNode instanceof ObjectNode',  can we somehow keep the logic of extracting the error message?", "url": "https://github.com/prestodb/presto/pull/15332#discussion_r508744575", "createdAt": "2020-10-20T18:23:49Z", "author": {"login": "beinan"}, "path": "presto-druid/src/main/java/com/facebook/presto/druid/DruidBrokerPageSource.java", "diffHunk": "@@ -123,17 +121,10 @@ public Page getNextPage()\n                 }\n                 else {\n                     JsonNode rootNode = OBJECT_MAPPER.readTree(readLine);\n-                    if (!(rootNode instanceof ArrayNode)) {\n-                        if (rootNode instanceof ObjectNode) {\n-                            throw new PrestoException(DRUID_BROKER_RESULT_ERROR, ((ObjectNode) rootNode).findValue(\"errorMessage\").asText());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8da28e0105fb8123011fa7dc2bc190e62632df85"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzMDg3NDM1", "url": "https://github.com/prestodb/presto/pull/15332#pullrequestreview-513087435", "createdAt": "2020-10-20T20:02:06Z", "commit": {"oid": "8da28e0105fb8123011fa7dc2bc190e62632df85"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQyMDowMjowNlrOHlO4ig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQyMDowMjowNlrOHlO4ig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgwMzIxMA==", "bodyText": "I have similar feeling with @beinan could we extract error message?", "url": "https://github.com/prestodb/presto/pull/15332#discussion_r508803210", "createdAt": "2020-10-20T20:02:06Z", "author": {"login": "zhenxiao"}, "path": "presto-druid/src/main/java/com/facebook/presto/druid/DruidBrokerPageSource.java", "diffHunk": "@@ -123,17 +121,10 @@ public Page getNextPage()\n                 }\n                 else {\n                     JsonNode rootNode = OBJECT_MAPPER.readTree(readLine);\n-                    if (!(rootNode instanceof ArrayNode)) {\n-                        if (rootNode instanceof ObjectNode) {\n-                            throw new PrestoException(DRUID_BROKER_RESULT_ERROR, ((ObjectNode) rootNode).findValue(\"errorMessage\").asText());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc0NDU3NQ=="}, "originalCommit": {"oid": "8da28e0105fb8123011fa7dc2bc190e62632df85"}, "originalPosition": 15}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "09a883bfb8c0aeaa036fb7a5c2663b6d4c48638b", "author": {"user": {"login": "adlymousa", "name": null}}, "url": "https://github.com/prestodb/presto/commit/09a883bfb8c0aeaa036fb7a5c2663b6d4c48638b", "committedDate": "2020-10-24T21:02:22Z", "message": "raise exception if returned from druid"}, "afterCommit": {"oid": "8da28e0105fb8123011fa7dc2bc190e62632df85", "author": {"user": {"login": "adlymousa", "name": null}}, "url": "https://github.com/prestodb/presto/commit/8da28e0105fb8123011fa7dc2bc190e62632df85", "committedDate": "2020-10-19T16:07:43Z", "message": "Fix druid reading issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4390e42bbea338d3cbdf606ba65f255afc549916", "author": {"user": {"login": "adlymousa", "name": null}}, "url": "https://github.com/prestodb/presto/commit/4390e42bbea338d3cbdf606ba65f255afc549916", "committedDate": "2020-10-24T21:07:36Z", "message": "raise exception if returned from druid"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2MzkzODQ0", "url": "https://github.com/prestodb/presto/pull/15332#pullrequestreview-516393844", "createdAt": "2020-10-25T20:22:18Z", "commit": {"oid": "4390e42bbea338d3cbdf606ba65f255afc549916"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNVQyMDoyMjoxOFrOHn8Qpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNVQyMDoyMjo0NlrOHn8Qxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTY0MzgxNQ==", "bodyText": "do we need to keep columnHandlesHasErrorMessageField? how about we inline it in getNextPage()", "url": "https://github.com/prestodb/presto/pull/15332#discussion_r511643815", "createdAt": "2020-10-25T20:22:18Z", "author": {"login": "zhenxiao"}, "path": "presto-druid/src/main/java/com/facebook/presto/druid/DruidBrokerPageSource.java", "diffHunk": "@@ -79,6 +78,8 @@ public DruidBrokerPageSource(\n                 .map(DruidColumnHandle::getColumnType)\n                 .collect(toImmutableList());\n         this.pageBuilder = new PageBuilder(this.columnTypes);\n+        this.columnHandlesHasErrorMessageField = columnHandles.stream().anyMatch(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4390e42bbea338d3cbdf606ba65f255afc549916"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTY0Mzg0Nw==", "bodyText": "inline columnHandlesHasErrorMessageField, instead of keeping a private member.", "url": "https://github.com/prestodb/presto/pull/15332#discussion_r511643847", "createdAt": "2020-10-25T20:22:46Z", "author": {"login": "zhenxiao"}, "path": "presto-druid/src/main/java/com/facebook/presto/druid/DruidBrokerPageSource.java", "diffHunk": "@@ -123,17 +124,13 @@ public Page getNextPage()\n                 }\n                 else {\n                     JsonNode rootNode = OBJECT_MAPPER.readTree(readLine);\n-                    if (!(rootNode instanceof ArrayNode)) {\n-                        if (rootNode instanceof ObjectNode) {\n-                            throw new PrestoException(DRUID_BROKER_RESULT_ERROR, ((ObjectNode) rootNode).findValue(\"errorMessage\").asText());\n-                        }\n-                        throw new PrestoException(DRUID_BROKER_RESULT_ERROR, rootNode.toString());\n+                    if (rootNode.has(\"errorMessage\") && !columnHandlesHasErrorMessageField) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4390e42bbea338d3cbdf606ba65f255afc549916"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ab3b8b08f571199dd9391329877f1b2350dc917", "author": {"user": {"login": "adlymousa", "name": null}}, "url": "https://github.com/prestodb/presto/commit/9ab3b8b08f571199dd9391329877f1b2350dc917", "committedDate": "2020-10-25T22:34:29Z", "message": "inline columnHandlesHasErrorMessageField"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2OTcwMDEz", "url": "https://github.com/prestodb/presto/pull/15332#pullrequestreview-516970013", "createdAt": "2020-10-26T16:41:57Z", "commit": {"oid": "9ab3b8b08f571199dd9391329877f1b2350dc917"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4956, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}