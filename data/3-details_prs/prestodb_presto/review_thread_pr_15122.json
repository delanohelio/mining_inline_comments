{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc5MjA3NDA1", "number": 15122, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwODowODoxNlrOEgSSbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQyMTo1MjozNlrOEgiFCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAyMjg5NTE2OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadataUpdateHandle.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwODowODoxNlrOHND85A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQxNzowMzoyNVrOHNVvGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ1ODI3Ng==", "bodyText": "What I meant was to use SchemaTableName type from SPI", "url": "https://github.com/prestodb/presto/pull/15122#discussion_r483458276", "createdAt": "2020-09-04T08:08:16Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadataUpdateHandle.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import com.facebook.presto.spi.ConnectorMetadataUpdateHandle;\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.UUID;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class HiveMetadataUpdateHandle\n+        implements ConnectorMetadataUpdateHandle\n+{\n+    private final UUID requestId;\n+    private final String schemaName;\n+    private final String schemaTableName;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6bfedf135757649a7d24caa6cfabe1b9a006b5f0"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc0OTY1OQ==", "bodyText": "oops...didnt know it existed. Made the suggested change.", "url": "https://github.com/prestodb/presto/pull/15122#discussion_r483749659", "createdAt": "2020-09-04T17:03:25Z", "author": {"login": "NikhilCollooru"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadataUpdateHandle.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import com.facebook.presto.spi.ConnectorMetadataUpdateHandle;\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.UUID;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class HiveMetadataUpdateHandle\n+        implements ConnectorMetadataUpdateHandle\n+{\n+    private final UUID requestId;\n+    private final String schemaName;\n+    private final String schemaTableName;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ1ODI3Ng=="}, "originalCommit": {"oid": "6bfedf135757649a7d24caa6cfabe1b9a006b5f0"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAyNTQzMTgxOnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadataUpdater.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQyMTozMjo1MVrOHNb-yw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQyMTozMjo1MVrOHNb-yw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg1MTk3OQ==", "bodyText": "Add to TODO: this class requires visit to make it more robust", "url": "https://github.com/prestodb/presto/pull/15122#discussion_r483851979", "createdAt": "2020-09-04T21:32:51Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadataUpdater.java", "diffHunk": "@@ -0,0 +1,113 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import com.facebook.airlift.concurrent.MoreFutures;\n+import com.facebook.presto.spi.ConnectorMetadataUpdateHandle;\n+import com.facebook.presto.spi.SchemaTableName;\n+import com.facebook.presto.spi.connector.ConnectorMetadataUpdater;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.util.concurrent.SettableFuture;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Queue;\n+import java.util.UUID;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ConcurrentLinkedQueue;\n+import java.util.concurrent.Executor;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class HiveMetadataUpdater", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "895a14ccb3a2754e44915956f1eb3fa5d38d2220"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAyNTQzOTcxOnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/com/facebook/presto/operator/TableWriterOperator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQyMTozNjozOVrOHNcDUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQyMTozNjozOVrOHNcDUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg1MzEzOA==", "bodyText": "static", "url": "https://github.com/prestodb/presto/pull/15122#discussion_r483853138", "createdAt": "2020-09-04T21:36:39Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/TableWriterOperator.java", "diffHunk": "@@ -136,6 +162,19 @@ private ConnectorPageSink createPageSink()\n             throw new UnsupportedOperationException(\"Unhandled target type: \" + target.getClass().getName());\n         }\n \n+        private ConnectorId getConnectorId(ExecutionWriterTarget handle)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "895a14ccb3a2754e44915956f1eb3fa5d38d2220"}, "originalPosition": 82}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAyNTQ4MjM1OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/com/facebook/presto/operator/TableWriterOperator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQyMTo1MjozNlrOHNcb_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQyMzozNDo1N1rOHNdwGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg1OTQ1NQ==", "bodyText": "Not a big fan of having setter and getter here. If we have to have something mutable, I would say make metadataContext in taskContext immutable and connectorId in metadataContext mutable. That will make this cleaner.", "url": "https://github.com/prestodb/presto/pull/15122#discussion_r483859455", "createdAt": "2020-09-04T21:52:36Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/TableWriterOperator.java", "diffHunk": "@@ -124,9 +135,24 @@ public Operator createOperator(DriverContext driverContext)\n \n         private ConnectorPageSink createPageSink()\n         {\n+            ConnectorId connectorId = getConnectorId(target);\n+            TaskMetadataContext metadataContext;\n+            Optional<ConnectorMetadataUpdater> metadataUpdater = metadataUpdaterManager.getMetadataUpdater(connectorId);\n+            if (metadataUpdater.isPresent()) {\n+                if (!taskContext.getTaskMetadataContext().isPresent()) {\n+                    metadataContext = new TaskMetadataContext(connectorId);\n+                    taskContext.setTaskMetadataContext(metadataContext);\n+                }\n+\n+                metadataContext = taskContext.getTaskMetadataContext().get();\n+                metadataContext.addMetadataUpdater(metadataUpdater.get());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "895a14ccb3a2754e44915956f1eb3fa5d38d2220"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg4MDk4NQ==", "bodyText": "Done. Made the ConnectorId in TaskMetadataContext mutable", "url": "https://github.com/prestodb/presto/pull/15122#discussion_r483880985", "createdAt": "2020-09-04T23:34:57Z", "author": {"login": "NikhilCollooru"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/TableWriterOperator.java", "diffHunk": "@@ -124,9 +135,24 @@ public Operator createOperator(DriverContext driverContext)\n \n         private ConnectorPageSink createPageSink()\n         {\n+            ConnectorId connectorId = getConnectorId(target);\n+            TaskMetadataContext metadataContext;\n+            Optional<ConnectorMetadataUpdater> metadataUpdater = metadataUpdaterManager.getMetadataUpdater(connectorId);\n+            if (metadataUpdater.isPresent()) {\n+                if (!taskContext.getTaskMetadataContext().isPresent()) {\n+                    metadataContext = new TaskMetadataContext(connectorId);\n+                    taskContext.setTaskMetadataContext(metadataContext);\n+                }\n+\n+                metadataContext = taskContext.getTaskMetadataContext().get();\n+                metadataContext.addMetadataUpdater(metadataUpdater.get());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg1OTQ1NQ=="}, "originalCommit": {"oid": "895a14ccb3a2754e44915956f1eb3fa5d38d2220"}, "originalPosition": 67}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3618, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}