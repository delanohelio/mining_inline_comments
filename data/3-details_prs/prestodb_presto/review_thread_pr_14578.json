{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIyOTQ3ODc2", "number": 14578, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQwMjowMjowOVrOD_gBQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQyMToxMzozOVrOEHu2Og==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3OTExNDg5OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/RelationPlanner.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQwMjowMjowOVrOGaMgEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwMTo0MjoyMlrOGa2poA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDEyMDk3OA==", "bodyText": "I tried to add this optimisation in PlanOptimizers where all the other optimizers live . ssaumitra@07ca92e\nThe problem was that, RelationPlanner converts equality join expressions to JoinNode.EquiJoinClause. So IsNotNullPredicate can no longer be constructed over there. If there is a way to make that work, please let me know.\nCC. @rschlussel", "url": "https://github.com/prestodb/presto/pull/14578#discussion_r430120978", "createdAt": "2020-05-26T02:02:09Z", "author": {"login": "ssaumitra"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/RelationPlanner.java", "diffHunk": "@@ -315,17 +316,21 @@ else if (firstDependencies.stream().allMatch(right::canResolve) && secondDepende\n             rightPlanBuilder = rightPlanBuilder.appendProjections(rightComparisonExpressions, variableAllocator, idAllocator);\n \n             for (int i = 0; i < leftComparisonExpressions.size(); i++) {\n+                Expression leftExpression = leftPlanBuilder.rewrite(leftComparisonExpressions.get(i));\n+                Expression rightExpression = rightPlanBuilder.rewrite(rightComparisonExpressions.get(i));\n                 if (joinConditionComparisonOperators.get(i) == ComparisonExpression.Operator.EQUAL) {\n                     VariableReferenceExpression leftVariable = leftPlanBuilder.translateToVariable(leftComparisonExpressions.get(i));\n                     VariableReferenceExpression righVariable = rightPlanBuilder.translateToVariable(rightComparisonExpressions.get(i));\n \n                     equiClauses.add(new JoinNode.EquiJoinClause(leftVariable, righVariable));\n                 }\n                 else {\n-                    Expression leftExpression = leftPlanBuilder.rewrite(leftComparisonExpressions.get(i));\n-                    Expression rightExpression = rightPlanBuilder.rewrite(rightComparisonExpressions.get(i));\n                     postInnerJoinConditions.add(new ComparisonExpression(joinConditionComparisonOperators.get(i), leftExpression, rightExpression));\n                 }\n+                if (node.getType() == INNER) {\n+                    postInnerJoinConditions.add(new IsNotNullPredicate(leftExpression));\n+                    postInnerJoinConditions.add(new IsNotNullPredicate(rightExpression));\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "46ddbe8099ccf247447e0af24a517325cc140c9a"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDU4NjY5Mg==", "bodyText": "Looks good.\nWhen you are at it, also add it to the inner table of an outer join - so right side of left join and left side of right join can use the same optimization", "url": "https://github.com/prestodb/presto/pull/14578#discussion_r430586692", "createdAt": "2020-05-26T17:32:44Z", "author": {"login": "kaikalur"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/RelationPlanner.java", "diffHunk": "@@ -315,17 +316,21 @@ else if (firstDependencies.stream().allMatch(right::canResolve) && secondDepende\n             rightPlanBuilder = rightPlanBuilder.appendProjections(rightComparisonExpressions, variableAllocator, idAllocator);\n \n             for (int i = 0; i < leftComparisonExpressions.size(); i++) {\n+                Expression leftExpression = leftPlanBuilder.rewrite(leftComparisonExpressions.get(i));\n+                Expression rightExpression = rightPlanBuilder.rewrite(rightComparisonExpressions.get(i));\n                 if (joinConditionComparisonOperators.get(i) == ComparisonExpression.Operator.EQUAL) {\n                     VariableReferenceExpression leftVariable = leftPlanBuilder.translateToVariable(leftComparisonExpressions.get(i));\n                     VariableReferenceExpression righVariable = rightPlanBuilder.translateToVariable(rightComparisonExpressions.get(i));\n \n                     equiClauses.add(new JoinNode.EquiJoinClause(leftVariable, righVariable));\n                 }\n                 else {\n-                    Expression leftExpression = leftPlanBuilder.rewrite(leftComparisonExpressions.get(i));\n-                    Expression rightExpression = rightPlanBuilder.rewrite(rightComparisonExpressions.get(i));\n                     postInnerJoinConditions.add(new ComparisonExpression(joinConditionComparisonOperators.get(i), leftExpression, rightExpression));\n                 }\n+                if (node.getType() == INNER) {\n+                    postInnerJoinConditions.add(new IsNotNullPredicate(leftExpression));\n+                    postInnerJoinConditions.add(new IsNotNullPredicate(rightExpression));\n+                }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDEyMDk3OA=="}, "originalCommit": {"oid": "46ddbe8099ccf247447e0af24a517325cc140c9a"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDgxMTU1Mg==", "bodyText": "Makes sense. I will add that.", "url": "https://github.com/prestodb/presto/pull/14578#discussion_r430811552", "createdAt": "2020-05-27T01:42:22Z", "author": {"login": "ssaumitra"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/RelationPlanner.java", "diffHunk": "@@ -315,17 +316,21 @@ else if (firstDependencies.stream().allMatch(right::canResolve) && secondDepende\n             rightPlanBuilder = rightPlanBuilder.appendProjections(rightComparisonExpressions, variableAllocator, idAllocator);\n \n             for (int i = 0; i < leftComparisonExpressions.size(); i++) {\n+                Expression leftExpression = leftPlanBuilder.rewrite(leftComparisonExpressions.get(i));\n+                Expression rightExpression = rightPlanBuilder.rewrite(rightComparisonExpressions.get(i));\n                 if (joinConditionComparisonOperators.get(i) == ComparisonExpression.Operator.EQUAL) {\n                     VariableReferenceExpression leftVariable = leftPlanBuilder.translateToVariable(leftComparisonExpressions.get(i));\n                     VariableReferenceExpression righVariable = rightPlanBuilder.translateToVariable(rightComparisonExpressions.get(i));\n \n                     equiClauses.add(new JoinNode.EquiJoinClause(leftVariable, righVariable));\n                 }\n                 else {\n-                    Expression leftExpression = leftPlanBuilder.rewrite(leftComparisonExpressions.get(i));\n-                    Expression rightExpression = rightPlanBuilder.rewrite(rightComparisonExpressions.get(i));\n                     postInnerJoinConditions.add(new ComparisonExpression(joinConditionComparisonOperators.get(i), leftExpression, rightExpression));\n                 }\n+                if (node.getType() == INNER) {\n+                    postInnerJoinConditions.add(new IsNotNullPredicate(leftExpression));\n+                    postInnerJoinConditions.add(new IsNotNullPredicate(rightExpression));\n+                }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDEyMDk3OA=="}, "originalCommit": {"oid": "46ddbe8099ccf247447e0af24a517325cc140c9a"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5MjI5NjI2OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/RelationPlanner.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQwNToxMDozNFrOGcO9wg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMjowNzo1M1rOGmBzng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjI1ODQ5OA==", "bodyText": "Are you sure these are just the keys not any other expressions?", "url": "https://github.com/prestodb/presto/pull/14578#discussion_r432258498", "createdAt": "2020-05-29T05:10:34Z", "author": {"login": "kaikalur"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/RelationPlanner.java", "diffHunk": "@@ -290,11 +291,13 @@ else if (conjunct instanceof ComparisonExpression) {\n                     if (firstDependencies.stream().allMatch(left::canResolve) && secondDependencies.stream().allMatch(right::canResolve)) {\n                         leftComparisonExpressions.add(firstExpression);\n                         rightComparisonExpressions.add(secondExpression);\n+                        addNullFilters(complexJoinExpressions, node.getType(), firstExpression, secondExpression);\n                         joinConditionComparisonOperators.add(comparisonOperator);\n                     }\n                     else if (firstDependencies.stream().allMatch(right::canResolve) && secondDependencies.stream().allMatch(left::canResolve)) {\n                         leftComparisonExpressions.add(secondExpression);\n                         rightComparisonExpressions.add(firstExpression);\n+                        addNullFilters(complexJoinExpressions, node.getType(), secondExpression, firstExpression);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "42b4c9f7dbddbc897a81702475d3b9be12fc6e54"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjcxOTQ0MA==", "bodyText": "@kaikalur These can be expressions as well, which can be completely resolved from left and right. For example, for the query\nSELECT DISTINCT a.orderkey FROM \n(SELECT CASE WHEN orderkey > 10 THEN orderkey END orderkey FROM orders WHERE orderkey < 100) a \nRIGHT OUTER JOIN \n(SELECT * FROM orders WHERE orderkey < 100) b ON a.orderkey = b.orderkey\n\nI am expecting optimised version as\nSELECT DISTINCT a.orderkey FROM \n(SELECT CASE WHEN orderkey > 10 THEN orderkey END orderkey FROM orders WHERE orderkey < 100) a \nRIGHT OUTER JOIN \n(SELECT * FROM orders WHERE orderkey < 100) b ON a.orderkey = b.orderkey\nWHERE CASE WHEN orderkey > 10 THEN orderkey END IS NOT NULL\n\nWhich is okay IMO, because CASE WHEN orderkey > 10 THEN orderkey END IS NOT NULL can get pushed down to scan operator for orders table.", "url": "https://github.com/prestodb/presto/pull/14578#discussion_r432719440", "createdAt": "2020-05-29T20:28:03Z", "author": {"login": "ssaumitra"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/RelationPlanner.java", "diffHunk": "@@ -290,11 +291,13 @@ else if (conjunct instanceof ComparisonExpression) {\n                     if (firstDependencies.stream().allMatch(left::canResolve) && secondDependencies.stream().allMatch(right::canResolve)) {\n                         leftComparisonExpressions.add(firstExpression);\n                         rightComparisonExpressions.add(secondExpression);\n+                        addNullFilters(complexJoinExpressions, node.getType(), firstExpression, secondExpression);\n                         joinConditionComparisonOperators.add(comparisonOperator);\n                     }\n                     else if (firstDependencies.stream().allMatch(right::canResolve) && secondDependencies.stream().allMatch(left::canResolve)) {\n                         leftComparisonExpressions.add(secondExpression);\n                         rightComparisonExpressions.add(firstExpression);\n+                        addNullFilters(complexJoinExpressions, node.getType(), secondExpression, firstExpression);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjI1ODQ5OA=="}, "originalCommit": {"oid": "42b4c9f7dbddbc897a81702475d3b9be12fc6e54"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjkwMjQ1OQ==", "bodyText": "This might end up introducing a regression, especially when NULLs are rare and/or expression is expensive. I think a better way to implement this is to do this in plan optimization (add an additional filter node after project to avoid recompute the expression). If nothing else, the default of this flag should be false. Maybe we should run some benchmarking first.", "url": "https://github.com/prestodb/presto/pull/14578#discussion_r436902459", "createdAt": "2020-06-08T18:17:22Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/RelationPlanner.java", "diffHunk": "@@ -290,11 +291,13 @@ else if (conjunct instanceof ComparisonExpression) {\n                     if (firstDependencies.stream().allMatch(left::canResolve) && secondDependencies.stream().allMatch(right::canResolve)) {\n                         leftComparisonExpressions.add(firstExpression);\n                         rightComparisonExpressions.add(secondExpression);\n+                        addNullFilters(complexJoinExpressions, node.getType(), firstExpression, secondExpression);\n                         joinConditionComparisonOperators.add(comparisonOperator);\n                     }\n                     else if (firstDependencies.stream().allMatch(right::canResolve) && secondDependencies.stream().allMatch(left::canResolve)) {\n                         leftComparisonExpressions.add(secondExpression);\n                         rightComparisonExpressions.add(firstExpression);\n+                        addNullFilters(complexJoinExpressions, node.getType(), secondExpression, firstExpression);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjI1ODQ5OA=="}, "originalCommit": {"oid": "42b4c9f7dbddbc897a81702475d3b9be12fc6e54"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjUyODY3MA==", "bodyText": "As discussed offline, we were thinking of doing performance testing. In the meantime, planned CSE changes will solve this problem.\nWe will roll out this optimisation in disabled state. And when CSE changes are released, we will re-enable this.", "url": "https://github.com/prestodb/presto/pull/14578#discussion_r442528670", "createdAt": "2020-06-18T22:07:53Z", "author": {"login": "ssaumitra"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/RelationPlanner.java", "diffHunk": "@@ -290,11 +291,13 @@ else if (conjunct instanceof ComparisonExpression) {\n                     if (firstDependencies.stream().allMatch(left::canResolve) && secondDependencies.stream().allMatch(right::canResolve)) {\n                         leftComparisonExpressions.add(firstExpression);\n                         rightComparisonExpressions.add(secondExpression);\n+                        addNullFilters(complexJoinExpressions, node.getType(), firstExpression, secondExpression);\n                         joinConditionComparisonOperators.add(comparisonOperator);\n                     }\n                     else if (firstDependencies.stream().allMatch(right::canResolve) && secondDependencies.stream().allMatch(left::canResolve)) {\n                         leftComparisonExpressions.add(secondExpression);\n                         rightComparisonExpressions.add(firstExpression);\n+                        addNullFilters(complexJoinExpressions, node.getType(), secondExpression, firstExpression);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjI1ODQ5OA=="}, "originalCommit": {"oid": "42b4c9f7dbddbc897a81702475d3b9be12fc6e54"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwMDg3NTQ5OnYy", "diffSide": "RIGHT", "path": "presto-tests/src/main/java/com/facebook/presto/tests/AbstractTestQueries.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQwMjo0MzoyNFrOGdgQ5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxOTozMzoxMFrOGeBGvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU5MDUwMg==", "bodyText": "Looks good. Just add one more test with some conditions like:\nWHERE a.x IS NULL\netc. so we can ensure that we did not push that down.", "url": "https://github.com/prestodb/presto/pull/14578#discussion_r433590502", "createdAt": "2020-06-02T02:43:24Z", "author": {"login": "kaikalur"}, "path": "presto-tests/src/main/java/com/facebook/presto/tests/AbstractTestQueries.java", "diffHunk": "@@ -8186,6 +8186,22 @@ public void testLateralJoin()\n                 \"line .*: LATERAL on other than the right side of CROSS JOIN is not supported\");\n     }\n \n+    @Test\n+    public void testJoinsWithNulls()\n+    {\n+        assertQuery(\"SELECT * FROM (VALUES 2, 3, null) a(x) INNER JOIN (VALUES 3, 4, null) b(x) ON a.x = b.x\",\n+                \"SELECT * FROM VALUES (3, 3)\");\n+\n+        assertQuery(\"SELECT * FROM (VALUES 2, 3, null) a(x) LEFT JOIN (VALUES 3, 4, null) b(x) ON a.x = b.x\",\n+                \"SELECT * FROM VALUES (3, 3), (2, NULL), (NULL, NULL)\");\n+\n+        assertQuery(\"SELECT * FROM (VALUES 2, 3, null) a(x) RIGHT JOIN (VALUES 3, 4, null) b(x) ON a.x = b.x\",\n+                \"SELECT * FROM VALUES (3, 3), (NULL, 4), (NULL, NULL)\");\n+\n+        assertQuery(\"SELECT * FROM (VALUES 2, 3, null) a(x) FULL OUTER JOIN (VALUES 3, 4, null) b(x) ON a.x = b.x\",\n+                \"SELECT * FROM VALUES (3, 3), (NULL, 4), (2, NULL), (NULL, NULL), (NULL, NULL)\");\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c509184874298c9c87adb2aad06cd861340a61ec"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk4NjMxMA==", "bodyText": "Added now. It's interesting to see how NULL filtering works in FULL OUTER JOIN.", "url": "https://github.com/prestodb/presto/pull/14578#discussion_r433986310", "createdAt": "2020-06-02T15:53:46Z", "author": {"login": "ssaumitra"}, "path": "presto-tests/src/main/java/com/facebook/presto/tests/AbstractTestQueries.java", "diffHunk": "@@ -8186,6 +8186,22 @@ public void testLateralJoin()\n                 \"line .*: LATERAL on other than the right side of CROSS JOIN is not supported\");\n     }\n \n+    @Test\n+    public void testJoinsWithNulls()\n+    {\n+        assertQuery(\"SELECT * FROM (VALUES 2, 3, null) a(x) INNER JOIN (VALUES 3, 4, null) b(x) ON a.x = b.x\",\n+                \"SELECT * FROM VALUES (3, 3)\");\n+\n+        assertQuery(\"SELECT * FROM (VALUES 2, 3, null) a(x) LEFT JOIN (VALUES 3, 4, null) b(x) ON a.x = b.x\",\n+                \"SELECT * FROM VALUES (3, 3), (2, NULL), (NULL, NULL)\");\n+\n+        assertQuery(\"SELECT * FROM (VALUES 2, 3, null) a(x) RIGHT JOIN (VALUES 3, 4, null) b(x) ON a.x = b.x\",\n+                \"SELECT * FROM VALUES (3, 3), (NULL, 4), (NULL, NULL)\");\n+\n+        assertQuery(\"SELECT * FROM (VALUES 2, 3, null) a(x) FULL OUTER JOIN (VALUES 3, 4, null) b(x) ON a.x = b.x\",\n+                \"SELECT * FROM VALUES (3, 3), (NULL, 4), (2, NULL), (NULL, NULL), (NULL, NULL)\");\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU5MDUwMg=="}, "originalCommit": {"oid": "c509184874298c9c87adb2aad06cd861340a61ec"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA0ODYyMA==", "bodyText": "I actually meant WHERE clauses not AND in ON clauses because we should not be pushing those down.", "url": "https://github.com/prestodb/presto/pull/14578#discussion_r434048620", "createdAt": "2020-06-02T17:27:33Z", "author": {"login": "kaikalur"}, "path": "presto-tests/src/main/java/com/facebook/presto/tests/AbstractTestQueries.java", "diffHunk": "@@ -8186,6 +8186,22 @@ public void testLateralJoin()\n                 \"line .*: LATERAL on other than the right side of CROSS JOIN is not supported\");\n     }\n \n+    @Test\n+    public void testJoinsWithNulls()\n+    {\n+        assertQuery(\"SELECT * FROM (VALUES 2, 3, null) a(x) INNER JOIN (VALUES 3, 4, null) b(x) ON a.x = b.x\",\n+                \"SELECT * FROM VALUES (3, 3)\");\n+\n+        assertQuery(\"SELECT * FROM (VALUES 2, 3, null) a(x) LEFT JOIN (VALUES 3, 4, null) b(x) ON a.x = b.x\",\n+                \"SELECT * FROM VALUES (3, 3), (2, NULL), (NULL, NULL)\");\n+\n+        assertQuery(\"SELECT * FROM (VALUES 2, 3, null) a(x) RIGHT JOIN (VALUES 3, 4, null) b(x) ON a.x = b.x\",\n+                \"SELECT * FROM VALUES (3, 3), (NULL, 4), (NULL, NULL)\");\n+\n+        assertQuery(\"SELECT * FROM (VALUES 2, 3, null) a(x) FULL OUTER JOIN (VALUES 3, 4, null) b(x) ON a.x = b.x\",\n+                \"SELECT * FROM VALUES (3, 3), (NULL, 4), (2, NULL), (NULL, NULL), (NULL, NULL)\");\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU5MDUwMg=="}, "originalCommit": {"oid": "c509184874298c9c87adb2aad06cd861340a61ec"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDEyODU3Mg==", "bodyText": "@kaikalur Sure. My code does not touch Predicate pushdown. So this should not change. Updating test just for completeness.", "url": "https://github.com/prestodb/presto/pull/14578#discussion_r434128572", "createdAt": "2020-06-02T19:33:10Z", "author": {"login": "ssaumitra"}, "path": "presto-tests/src/main/java/com/facebook/presto/tests/AbstractTestQueries.java", "diffHunk": "@@ -8186,6 +8186,22 @@ public void testLateralJoin()\n                 \"line .*: LATERAL on other than the right side of CROSS JOIN is not supported\");\n     }\n \n+    @Test\n+    public void testJoinsWithNulls()\n+    {\n+        assertQuery(\"SELECT * FROM (VALUES 2, 3, null) a(x) INNER JOIN (VALUES 3, 4, null) b(x) ON a.x = b.x\",\n+                \"SELECT * FROM VALUES (3, 3)\");\n+\n+        assertQuery(\"SELECT * FROM (VALUES 2, 3, null) a(x) LEFT JOIN (VALUES 3, 4, null) b(x) ON a.x = b.x\",\n+                \"SELECT * FROM VALUES (3, 3), (2, NULL), (NULL, NULL)\");\n+\n+        assertQuery(\"SELECT * FROM (VALUES 2, 3, null) a(x) RIGHT JOIN (VALUES 3, 4, null) b(x) ON a.x = b.x\",\n+                \"SELECT * FROM VALUES (3, 3), (NULL, 4), (NULL, NULL)\");\n+\n+        assertQuery(\"SELECT * FROM (VALUES 2, 3, null) a(x) FULL OUTER JOIN (VALUES 3, 4, null) b(x) ON a.x = b.x\",\n+                \"SELECT * FROM VALUES (3, 3), (NULL, 4), (2, NULL), (NULL, NULL), (NULL, NULL)\");\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU5MDUwMg=="}, "originalCommit": {"oid": "c509184874298c9c87adb2aad06cd861340a61ec"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyMTc4OTkxOnYy", "diffSide": "RIGHT", "path": "presto-main/src/test/java/com/facebook/presto/sql/planner/TestPredicatePushdown.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxODoyMDo0N1rOGgqhaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxODo1NDoyOVrOGgrpww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjkwNDI5Ng==", "bodyText": "Formatting seems off here.", "url": "https://github.com/prestodb/presto/pull/14578#discussion_r436904296", "createdAt": "2020-06-08T18:20:47Z", "author": {"login": "rongrong"}, "path": "presto-main/src/test/java/com/facebook/presto/sql/planner/TestPredicatePushdown.java", "diffHunk": "@@ -61,10 +60,12 @@ public void testNonStraddlingJoinExpression()\n         assertPlan(\"SELECT * FROM orders JOIN lineitem ON orders.orderkey = lineitem.orderkey AND cast(lineitem.linenumber AS varchar) = '2'\",\n                 anyTree(\n                         join(INNER, ImmutableList.of(equiJoinClause(\"ORDERS_OK\", \"LINEITEM_OK\")),\n-                                any(\n-                                        tableScan(\"orders\", ImmutableMap.of(\"ORDERS_OK\", \"orderkey\"))),\n                                 anyTree(\n-                                        filter(\"cast('2' as varchar) = cast(LINEITEM_LINENUMBER as varchar)\",\n+                                    filter(\"ORDERS_OK IS NOT NULL\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05fd272d7cd2be63611d47c5ac00c3b89a9f4f41"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjkyMjgxOQ==", "bodyText": "Corrected formatting.", "url": "https://github.com/prestodb/presto/pull/14578#discussion_r436922819", "createdAt": "2020-06-08T18:54:29Z", "author": {"login": "ssaumitra"}, "path": "presto-main/src/test/java/com/facebook/presto/sql/planner/TestPredicatePushdown.java", "diffHunk": "@@ -61,10 +60,12 @@ public void testNonStraddlingJoinExpression()\n         assertPlan(\"SELECT * FROM orders JOIN lineitem ON orders.orderkey = lineitem.orderkey AND cast(lineitem.linenumber AS varchar) = '2'\",\n                 anyTree(\n                         join(INNER, ImmutableList.of(equiJoinClause(\"ORDERS_OK\", \"LINEITEM_OK\")),\n-                                any(\n-                                        tableScan(\"orders\", ImmutableMap.of(\"ORDERS_OK\", \"orderkey\"))),\n                                 anyTree(\n-                                        filter(\"cast('2' as varchar) = cast(LINEITEM_LINENUMBER as varchar)\",\n+                                    filter(\"ORDERS_OK IS NOT NULL\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjkwNDI5Ng=="}, "originalCommit": {"oid": "05fd272d7cd2be63611d47c5ac00c3b89a9f4f41"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1OTg0OTI3OnYy", "diffSide": "RIGHT", "path": "presto-benchto-benchmarks/src/test/resources/sql/presto/tpch/q13.plan.txt", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxODoxMTo0MVrOGmdbvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMFQwMDozOToxNFrOGmjyOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk4MTMxMQ==", "bodyText": "Do we understand why this would change?", "url": "https://github.com/prestodb/presto/pull/14578#discussion_r442981311", "createdAt": "2020-06-19T18:11:41Z", "author": {"login": "rongrong"}, "path": "presto-benchto-benchmarks/src/test/resources/sql/presto/tpch/q13.plan.txt", "diffHunk": "@@ -8,9 +8,9 @@ remote exchange (GATHER, SINGLE, [])\n                             final aggregation over (custkey)\n                                 local exchange (GATHER, SINGLE, [])\n                                     partial aggregation over (custkey)\n-                                        join (LEFT, PARTITIONED):\n-                                            remote exchange (REPARTITION, HASH, [custkey])\n-                                                scan customer\n+                                        join (RIGHT, PARTITIONED):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f4de1920e1cd2970e66a4d11f54cafe9a79e69b"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk5ODM0OQ==", "bodyText": "This won't change actually. It's reverted it a while ago. These are the latest changes https://github.com/prestodb/presto/pull/14578/files", "url": "https://github.com/prestodb/presto/pull/14578#discussion_r442998349", "createdAt": "2020-06-19T18:55:17Z", "author": {"login": "ssaumitra"}, "path": "presto-benchto-benchmarks/src/test/resources/sql/presto/tpch/q13.plan.txt", "diffHunk": "@@ -8,9 +8,9 @@ remote exchange (GATHER, SINGLE, [])\n                             final aggregation over (custkey)\n                                 local exchange (GATHER, SINGLE, [])\n                                     partial aggregation over (custkey)\n-                                        join (LEFT, PARTITIONED):\n-                                            remote exchange (REPARTITION, HASH, [custkey])\n-                                                scan customer\n+                                        join (RIGHT, PARTITIONED):", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk4MTMxMQ=="}, "originalCommit": {"oid": "6f4de1920e1cd2970e66a4d11f54cafe9a79e69b"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAwNjMxMg==", "bodyText": "Please do not introduce change and revert in later commit. I think for this PR, you can merge the two commits into one. If you want to keep 2 separate commits, please keep each one as only introducing the feature mentioned (one for adding null filter, one for introducing the session) and nothing else. Thanks!", "url": "https://github.com/prestodb/presto/pull/14578#discussion_r443006312", "createdAt": "2020-06-19T19:16:51Z", "author": {"login": "rongrong"}, "path": "presto-benchto-benchmarks/src/test/resources/sql/presto/tpch/q13.plan.txt", "diffHunk": "@@ -8,9 +8,9 @@ remote exchange (GATHER, SINGLE, [])\n                             final aggregation over (custkey)\n                                 local exchange (GATHER, SINGLE, [])\n                                     partial aggregation over (custkey)\n-                                        join (LEFT, PARTITIONED):\n-                                            remote exchange (REPARTITION, HASH, [custkey])\n-                                                scan customer\n+                                        join (RIGHT, PARTITIONED):", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk4MTMxMQ=="}, "originalCommit": {"oid": "6f4de1920e1cd2970e66a4d11f54cafe9a79e69b"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA4NTM2OQ==", "bodyText": "@rongrong I understand. I have now squashed all the changes in a single commit.\nJust so I can avoid this in the future, what's the recommended workflow in Presto to review multi-commit PRs? For example, pandas advises to accommodate code review changes in separate commits (https://pandas.pydata.org/docs/development/contributing.html#updating-your-pull-request) Apache Flink advises to squash everything in single amended commit (https://flink.apache.org/contributing/improve-website.html#submit-your-contribution) . What's the recommended way for Presto?", "url": "https://github.com/prestodb/presto/pull/14578#discussion_r443085369", "createdAt": "2020-06-20T00:39:14Z", "author": {"login": "ssaumitra"}, "path": "presto-benchto-benchmarks/src/test/resources/sql/presto/tpch/q13.plan.txt", "diffHunk": "@@ -8,9 +8,9 @@ remote exchange (GATHER, SINGLE, [])\n                             final aggregation over (custkey)\n                                 local exchange (GATHER, SINGLE, [])\n                                     partial aggregation over (custkey)\n-                                        join (LEFT, PARTITIONED):\n-                                            remote exchange (REPARTITION, HASH, [custkey])\n-                                                scan customer\n+                                        join (RIGHT, PARTITIONED):", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk4MTMxMQ=="}, "originalCommit": {"oid": "6f4de1920e1cd2970e66a4d11f54cafe9a79e69b"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2NTQzMDM0OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/RelationPlanner.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQyMToxMzozOVrOGnROOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQyMTozMTo0MFrOGnRuYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzgyOTgxOQ==", "bodyText": "Why is the null filter added to complexJoinExpressions rather than leftComparisonExpressions or rightComparisonExpressions?", "url": "https://github.com/prestodb/presto/pull/14578#discussion_r443829819", "createdAt": "2020-06-22T21:13:39Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/RelationPlanner.java", "diffHunk": "@@ -290,11 +291,13 @@ else if (conjunct instanceof ComparisonExpression) {\n                     if (firstDependencies.stream().allMatch(left::canResolve) && secondDependencies.stream().allMatch(right::canResolve)) {\n                         leftComparisonExpressions.add(firstExpression);\n                         rightComparisonExpressions.add(secondExpression);\n+                        addNullFilters(complexJoinExpressions, node.getType(), firstExpression, secondExpression);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37e49683113dc0c916f758e98b76b4b63920a21d"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzgzODA0OA==", "bodyText": "@rongrong leftComparisonExpressions or rightComparisonExpressions have different meaning in this function. As of today, in current master branch (where  my changes are not added), if I run the query\nexplain SELECT * FROM customer a INNER JOIN orders b ON a.custkey = b.custkey and a.phone is not null;\n\nleftComparisonExpressions is a.custkey, rightComparisonExpressions is b.custkey and complexJoinExpressions is a.phone is not null.", "url": "https://github.com/prestodb/presto/pull/14578#discussion_r443838048", "createdAt": "2020-06-22T21:31:40Z", "author": {"login": "ssaumitra"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/RelationPlanner.java", "diffHunk": "@@ -290,11 +291,13 @@ else if (conjunct instanceof ComparisonExpression) {\n                     if (firstDependencies.stream().allMatch(left::canResolve) && secondDependencies.stream().allMatch(right::canResolve)) {\n                         leftComparisonExpressions.add(firstExpression);\n                         rightComparisonExpressions.add(secondExpression);\n+                        addNullFilters(complexJoinExpressions, node.getType(), firstExpression, secondExpression);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzgyOTgxOQ=="}, "originalCommit": {"oid": "37e49683113dc0c916f758e98b76b4b63920a21d"}, "originalPosition": 12}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2680, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}