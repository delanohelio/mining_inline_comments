{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk2Njg2ODY5", "number": 14320, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwMDoxMDoyNVrODtVMEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQwMzozODoyMVrODu9QIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4ODU5NjY3OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/com/facebook/presto/operator/repartition/OptimizedPartitionedOutputOperator.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwMDoxMDoyNVrOF-sgeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwMDoxMDoyNVrOF-sgeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI4NTI0MA==", "bodyText": "This number is highly dependent on the environment and won't work for all setups. Let's make this limit configurable.", "url": "https://github.com/prestodb/presto/pull/14320#discussion_r401285240", "createdAt": "2020-04-01T00:10:25Z", "author": {"login": "mbasmanova"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/repartition/OptimizedPartitionedOutputOperator.java", "diffHunk": "@@ -367,7 +367,8 @@ public OperatorFactory duplicate()\n         private final Closer blockLeaseCloser = Closer.create();\n \n         // The ArrayAllocator for the buffers used in repartitioning, e.g. PartitionBuffer#serializedRowSizes, BlockEncodingBuffer#mappedPositions.\n-        private final ArrayAllocator bufferAllocator = new SimpleArrayAllocator(10_000);\n+        // Assuming there are 1000 columns, and each of them uses 3 buffers, and the number of partitions is 333, then we need 1000 * 3 * 333 about 1M buffers.\n+        private final ArrayAllocator bufferAllocator = new SimpleArrayAllocator(1_000_000);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8fb84b36778346ef577752f3cd6a856763e08d8f"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5NTM1NzM2OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/com/facebook/presto/execution/TaskManagerConfig.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxNDoyMDo1NFrOF_tkTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxNDoyMDo1NFrOF_tkTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM1MTE4MQ==", "bodyText": "Integer -> int", "url": "https://github.com/prestodb/presto/pull/14320#discussion_r402351181", "createdAt": "2020-04-02T14:20:54Z", "author": {"login": "mbasmanova"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/TaskManagerConfig.java", "diffHunk": "@@ -60,6 +60,7 @@\n \n     private DataSize sinkMaxBufferSize = new DataSize(32, Unit.MEGABYTE);\n     private DataSize maxPagePartitioningBufferSize = new DataSize(32, Unit.MEGABYTE);\n+    private Integer maxPagePartitioningBufferCount = 1_000_000;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ead72224559f0395f4dcc0a655ca012cacd7c290"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5NTM1ODIzOnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/com/facebook/presto/execution/TaskManagerConfig.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxNDoyMTowNVrOF_tk6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxNDoyMTowNVrOF_tk6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM1MTMzNw==", "bodyText": "remove @NotNull\nInteger -> int", "url": "https://github.com/prestodb/presto/pull/14320#discussion_r402351337", "createdAt": "2020-04-02T14:21:05Z", "author": {"login": "mbasmanova"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/TaskManagerConfig.java", "diffHunk": "@@ -384,6 +385,19 @@ public TaskManagerConfig setMaxPagePartitioningBufferSize(DataSize size)\n         return this;\n     }\n \n+    @NotNull\n+    public Integer getMaxPagePartitioningBufferCount()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ead72224559f0395f4dcc0a655ca012cacd7c290"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5NTM1ODc3OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/com/facebook/presto/execution/TaskManagerConfig.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxNDoyMToxNFrOF_tlRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxNDoyMToxNFrOF_tlRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM1MTQzMQ==", "bodyText": "Integer -> int", "url": "https://github.com/prestodb/presto/pull/14320#discussion_r402351431", "createdAt": "2020-04-02T14:21:14Z", "author": {"login": "mbasmanova"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/TaskManagerConfig.java", "diffHunk": "@@ -384,6 +385,19 @@ public TaskManagerConfig setMaxPagePartitioningBufferSize(DataSize size)\n         return this;\n     }\n \n+    @NotNull\n+    public Integer getMaxPagePartitioningBufferCount()\n+    {\n+        return maxPagePartitioningBufferCount;\n+    }\n+\n+    @Config(\"driver.max-page-partitioning-buffer-count\")\n+    public TaskManagerConfig setMaxPagePartitioningBufferCount(Integer bufferCount)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ead72224559f0395f4dcc0a655ca012cacd7c290"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5NTM2MzE4OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/com/facebook/presto/execution/TaskManagerConfig.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxNDoyMjowOVrOF_toKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQyMzo1MToxMFrOGAAcBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM1MjE2OA==", "bodyText": "Add @ConfigDescription", "url": "https://github.com/prestodb/presto/pull/14320#discussion_r402352168", "createdAt": "2020-04-02T14:22:09Z", "author": {"login": "mbasmanova"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/TaskManagerConfig.java", "diffHunk": "@@ -384,6 +385,19 @@ public TaskManagerConfig setMaxPagePartitioningBufferSize(DataSize size)\n         return this;\n     }\n \n+    @NotNull\n+    public Integer getMaxPagePartitioningBufferCount()\n+    {\n+        return maxPagePartitioningBufferCount;\n+    }\n+\n+    @Config(\"driver.max-page-partitioning-buffer-count\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ead72224559f0395f4dcc0a655ca012cacd7c290"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY2MDM1OQ==", "bodyText": "Sure. Added @ConfigDescription(\"Maximum number of buffers used by repartitioning per driver\")", "url": "https://github.com/prestodb/presto/pull/14320#discussion_r402660359", "createdAt": "2020-04-02T23:51:10Z", "author": {"login": "yingsu00"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/TaskManagerConfig.java", "diffHunk": "@@ -384,6 +385,19 @@ public TaskManagerConfig setMaxPagePartitioningBufferSize(DataSize size)\n         return this;\n     }\n \n+    @NotNull\n+    public Integer getMaxPagePartitioningBufferCount()\n+    {\n+        return maxPagePartitioningBufferCount;\n+    }\n+\n+    @Config(\"driver.max-page-partitioning-buffer-count\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM1MjE2OA=="}, "originalCommit": {"oid": "ead72224559f0395f4dcc0a655ca012cacd7c290"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5NTM2Mzg3OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/LocalExecutionPlanner.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxNDoyMjoyMFrOF_torA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxNDoyMjoyMFrOF_torA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM1MjMwMA==", "bodyText": "Integer -> int", "url": "https://github.com/prestodb/presto/pull/14320#discussion_r402352300", "createdAt": "2020-04-02T14:22:20Z", "author": {"login": "mbasmanova"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/LocalExecutionPlanner.java", "diffHunk": "@@ -310,6 +310,7 @@\n     private final IndexJoinLookupStats indexJoinLookupStats;\n     private final DataSize maxPartialAggregationMemorySize;\n     private final DataSize maxPagePartitioningBufferSize;\n+    private final Integer maxPagePartitioningBufferCount;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ead72224559f0395f4dcc0a655ca012cacd7c290"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUwNTY0NjQwOnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/com/facebook/presto/execution/TaskManagerConfig.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQwMzozODoyMVrOGBG05g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQwNDo1Nzo0N1rOGBH0Xg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzgxMzYwNg==", "bodyText": "@Min(1)", "url": "https://github.com/prestodb/presto/pull/14320#discussion_r403813606", "createdAt": "2020-04-06T03:38:21Z", "author": {"login": "tdcmeehan"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/TaskManagerConfig.java", "diffHunk": "@@ -384,6 +385,19 @@ public TaskManagerConfig setMaxPagePartitioningBufferSize(DataSize size)\n         return this;\n     }\n \n+    public int getMaxPagePartitioningBufferCount()\n+    {\n+        return maxPagePartitioningBufferCount;\n+    }\n+\n+    @Config(\"driver.max-page-partitioning-buffer-count\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3777150419fd48c2402a996f34bf5c32e5cc56ac"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzgyOTg1NA==", "bodyText": "Thanks @tdcmeehan ! I updated the PR with the following\n    @Min(1)\n    public int getMaxPagePartitioningBufferCount()\n    {\n        return maxPagePartitioningBufferCount;\n    }", "url": "https://github.com/prestodb/presto/pull/14320#discussion_r403829854", "createdAt": "2020-04-06T04:57:47Z", "author": {"login": "yingsu00"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/TaskManagerConfig.java", "diffHunk": "@@ -384,6 +385,19 @@ public TaskManagerConfig setMaxPagePartitioningBufferSize(DataSize size)\n         return this;\n     }\n \n+    public int getMaxPagePartitioningBufferCount()\n+    {\n+        return maxPagePartitioningBufferCount;\n+    }\n+\n+    @Config(\"driver.max-page-partitioning-buffer-count\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzgxMzYwNg=="}, "originalCommit": {"oid": "3777150419fd48c2402a996f34bf5c32e5cc56ac"}, "originalPosition": 17}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2964, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}