{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE2MzcyNjUz", "number": 15403, "title": "Fix int overflow error when spilling large page", "bodyText": "Page serialization requires page size to fit in an integer, so larger\npages could hit an int overflow error.\nTest plan - Not sure how to write a test because if I create a page that big I run out of java heapspace.  I plan to verify with a production query that encountered this issue to check if it fixes it, but need to wait for other testing to finish on that cluster first.\n== RELEASE NOTES ==\n\nGeneral Changes\n* Fix an issue where queries could encounter an int overflow error during spilling", "createdAt": "2020-11-05T22:17:12Z", "url": "https://github.com/prestodb/presto/pull/15403", "merged": true, "mergeCommit": {"oid": "f61df1b6b5e12f8c722f64b7dd93e868f58be5fe"}, "closed": true, "closedAt": "2020-11-06T16:38:15Z", "author": {"login": "rschlussel"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZqEe1gFqTUyNDcyMTI5MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZ5YjcgFqTUyNTI5Nzk5Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0NzIxMjkx", "url": "https://github.com/prestodb/presto/pull/15403#pullrequestreview-524721291", "createdAt": "2020-11-05T22:26:15Z", "commit": {"oid": "3ae5faa58c78267e87bd1f9f413cf3470a835e94"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0NzM0NDIw", "url": "https://github.com/prestodb/presto/pull/15403#pullrequestreview-524734420", "createdAt": "2020-11-05T22:51:19Z", "commit": {"oid": "3ae5faa58c78267e87bd1f9f413cf3470a835e94"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQyMjo1MToyMFrOHuZvRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQyMjo1MToyMFrOHuZvRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQxODI0NQ==", "bodyText": "I think we can split with much moderate size? -- e.g. something like 8M?", "url": "https://github.com/prestodb/presto/pull/15403#discussion_r518418245", "createdAt": "2020-11-05T22:51:20Z", "author": {"login": "wenleix"}, "path": "presto-main/src/main/java/com/facebook/presto/spiller/FileSingleStreamSpiller.java", "diffHunk": "@@ -144,11 +144,15 @@ private void writePages(Iterator<Page> pageIterator)\n             while (pageIterator.hasNext()) {\n                 Page page = pageIterator.next();\n                 spilledPagesInMemorySize += page.getSizeInBytes();\n-                SerializedPage serializedPage = serde.serialize(page);\n-                long pageSize = serializedPage.getSizeInBytes();\n-                localSpillContext.updateBytes(pageSize);\n-                spillerStats.addToTotalSpilledBytes(pageSize);\n-                writeSerializedPage(output, serializedPage);\n+                // page serialization requires  page.getSizeInBytes() + Integer.BYTES to fit in an integer\n+                splitPage(page, Integer.MAX_VALUE - Integer.BYTES).stream()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ae5faa58c78267e87bd1f9f413cf3470a835e94"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e69e066cbfa9fa190bd42f7f2c00953eb80b8d50", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/e69e066cbfa9fa190bd42f7f2c00953eb80b8d50", "committedDate": "2020-11-05T23:25:06Z", "message": "Fix int overflow error when spilling large page\n\nPage serialization requires page size to fin in an integer, so larger\npages could hit an int overflow error."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3ae5faa58c78267e87bd1f9f413cf3470a835e94", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/3ae5faa58c78267e87bd1f9f413cf3470a835e94", "committedDate": "2020-11-05T16:55:08Z", "message": "Fix int overflow error when spilling large page\n\nPage serialization requires page size to fin in an integer, so larger\npages could hit an int overflow error."}, "afterCommit": {"oid": "e69e066cbfa9fa190bd42f7f2c00953eb80b8d50", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/e69e066cbfa9fa190bd42f7f2c00953eb80b8d50", "committedDate": "2020-11-05T23:25:06Z", "message": "Fix int overflow error when spilling large page\n\nPage serialization requires page size to fin in an integer, so larger\npages could hit an int overflow error."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0NzUzNzkz", "url": "https://github.com/prestodb/presto/pull/15403#pullrequestreview-524753793", "createdAt": "2020-11-05T23:32:06Z", "commit": {"oid": "e69e066cbfa9fa190bd42f7f2c00953eb80b8d50"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1Mjk3OTkz", "url": "https://github.com/prestodb/presto/pull/15403#pullrequestreview-525297993", "createdAt": "2020-11-06T16:16:26Z", "commit": {"oid": "e69e066cbfa9fa190bd42f7f2c00953eb80b8d50"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNjoxNjoyN1rOHu0baw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNjoxNjoyN1rOHu0baw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg1NTUzMQ==", "bodyText": "We should probably add a similar fix to the storage based spiller\nCC: @wenleix", "url": "https://github.com/prestodb/presto/pull/15403#discussion_r518855531", "createdAt": "2020-11-06T16:16:27Z", "author": {"login": "arhimondr"}, "path": "presto-main/src/main/java/com/facebook/presto/spiller/FileSingleStreamSpiller.java", "diffHunk": "@@ -144,11 +145,15 @@ private void writePages(Iterator<Page> pageIterator)\n             while (pageIterator.hasNext()) {\n                 Page page = pageIterator.next();\n                 spilledPagesInMemorySize += page.getSizeInBytes();\n-                SerializedPage serializedPage = serde.serialize(page);\n-                long pageSize = serializedPage.getSizeInBytes();\n-                localSpillContext.updateBytes(pageSize);\n-                spillerStats.addToTotalSpilledBytes(pageSize);\n-                writeSerializedPage(output, serializedPage);\n+                // page serialization requires  page.getSizeInBytes() + Integer.BYTES to fit in an integer\n+                splitPage(page, DEFAULT_MAX_PAGE_SIZE_IN_BYTES).stream()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e69e066cbfa9fa190bd42f7f2c00953eb80b8d50"}, "originalPosition": 27}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4682, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}