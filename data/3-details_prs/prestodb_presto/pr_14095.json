{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc0NzM5NDc3", "number": 14095, "title": "Add soft affinity in scheduling bucketed split for Hive Connector", "bodyText": "== RELEASE NOTES ==\n\nSPI Changes\n* Add parameter `NodeSelectionStrategy nodeSelectionStrategy` in method `createBucketNodeMap` in `ConnectorBucketNodeMap `, indicating which affinity strategy to use when we create bucket nodeMap.\n* Add parameter `List<Node> sortedNodes` in method `getBucketNodeMap` in `ConnectorNodePartitioningProvider `, providing a sorted node list for connector to choose from when doing affinity scheduling.\n\nGeneral Changes\n* Add soft affinity scheduling to bucketed split. It makes the best effort to fetch the same bucket data from the same worker. When using dynamic group scheduling, if the preferred workers are unavailable to handle the specific bucket splits, it will fallback to random workers.", "createdAt": "2020-02-13T08:45:08Z", "url": "https://github.com/prestodb/presto/pull/14095", "merged": true, "mergeCommit": {"oid": "2fb54ed0dc380791876810237c116f587efc2470"}, "closed": true, "closedAt": "2020-02-24T23:39:09Z", "author": {"login": "kewang1024"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcEGSAwgBqjMwMzcyNDY3OTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcHiEHOgBqjMwNjY1MzMzOTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0e07ab6656d74897df20f110cdae6c5f869975f4", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/0e07ab6656d74897df20f110cdae6c5f869975f4", "committedDate": "2020-02-13T08:41:25Z", "message": "Add SoftAffinityNodeSelection ability for bucketed splits"}, "afterCommit": {"oid": "7200e44e194304de3864d1315b273a846c95c788", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/7200e44e194304de3864d1315b273a846c95c788", "committedDate": "2020-02-14T02:39:56Z", "message": "Add SoftAffinityNodeSelection ability for bucketed splits"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4Njg0ODAy", "url": "https://github.com/prestodb/presto/pull/14095#pullrequestreview-358684802", "createdAt": "2020-02-14T02:49:28Z", "commit": {"oid": "7200e44e194304de3864d1315b273a846c95c788"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQwMjo0OToyOFrOFpqOZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQwMjo0OToyOFrOFpqOZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTIyNzc0OA==", "bodyText": "break a line", "url": "https://github.com/prestodb/presto/pull/14095#discussion_r379227748", "createdAt": "2020-02-14T02:49:28Z", "author": {"login": "highker"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotNodePartitioningProvider.java", "diffHunk": "@@ -32,7 +33,7 @@\n     public ConnectorBucketNodeMap getBucketNodeMap(\n             ConnectorTransactionHandle transactionHandle,\n             ConnectorSession session,\n-            ConnectorPartitioningHandle partitioningHandle)\n+            ConnectorPartitioningHandle partitioningHandle, List<Node> sortedNodes)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7200e44e194304de3864d1315b273a846c95c788"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5MTAwOTQx", "url": "https://github.com/prestodb/presto/pull/14095#pullrequestreview-359100941", "createdAt": "2020-02-14T17:26:30Z", "commit": {"oid": "7200e44e194304de3864d1315b273a846c95c788"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxNzoyNjozMVrOFp-Ffw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxNzoyNjozMVrOFp-Ffw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTU1MzE1MQ==", "bodyText": "Since we are already splitting this from the #13966 , let's make sure we don't create a FixedBucketNodeMap for SOFT_AFFINITY so it would play well with DynamicLifespanScheduler, and thus this pull request is self-consistent. Basically we need the functionality in DynamicBucketNodeMap to be able to accept a map as initial state and allow further updates to the map as scheduler sees fit.", "url": "https://github.com/prestodb/presto/pull/14095#discussion_r379553151", "createdAt": "2020-02-14T17:26:31Z", "author": {"login": "shixuan-fan"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/NodePartitioningManager.java", "diffHunk": "@@ -151,21 +165,30 @@ public NodePartitionMap getNodePartitioningMap(Session session, PartitioningHand\n \n     public BucketNodeMap getBucketNodeMap(Session session, PartitioningHandle partitioningHandle, boolean preferDynamic)\n     {\n-        ConnectorBucketNodeMap connectorBucketNodeMap = getConnectorBucketNodeMap(session, partitioningHandle);\n-\n-        if (connectorBucketNodeMap.hasFixedMapping()) {\n-            return new FixedBucketNodeMap(getSplitToBucket(session, partitioningHandle), getFixedMapping(connectorBucketNodeMap));\n-        }\n-\n-        if (preferDynamic) {\n-            return new DynamicBucketNodeMap(getSplitToBucket(session, partitioningHandle), connectorBucketNodeMap.getBucketCount());\n+        ConnectorId connectorId = partitioningHandle.getConnectorId()\n+                .orElseThrow(() -> new IllegalArgumentException(\"No connector ID for partitioning handle: \" + partitioningHandle));\n+        List<Node> sortedNodes = sortedNodes(connectorId);\n+\n+        ConnectorBucketNodeMap connectorBucketNodeMap = getConnectorBucketNodeMap(session, partitioningHandle, sortedNodes);\n+\n+        NodeSelectionStrategy nodeSelectionStrategy = connectorBucketNodeMap.getNodeSelectionStrategy();\n+        switch (nodeSelectionStrategy) {\n+            case HARD_AFFINITY:\n+            case SOFT_AFFINITY:\n+                // todo for soft affinity, we need to add logic if preferDynamic is true", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7200e44e194304de3864d1315b273a846c95c788"}, "originalPosition": 86}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7200e44e194304de3864d1315b273a846c95c788", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/7200e44e194304de3864d1315b273a846c95c788", "committedDate": "2020-02-14T02:39:56Z", "message": "Add SoftAffinityNodeSelection ability for bucketed splits"}, "afterCommit": {"oid": "6fc2e1734ef97a1966d6fb74a40dde2221b4d986", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/6fc2e1734ef97a1966d6fb74a40dde2221b4d986", "committedDate": "2020-02-18T07:12:59Z", "message": "Add dynamic schedule logic in soft affinity for bucketed splits"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6fc2e1734ef97a1966d6fb74a40dde2221b4d986", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/6fc2e1734ef97a1966d6fb74a40dde2221b4d986", "committedDate": "2020-02-18T07:12:59Z", "message": "Add dynamic schedule logic in soft affinity for bucketed splits"}, "afterCommit": {"oid": "586776b22c337a768e330278538b44907e48f018", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/586776b22c337a768e330278538b44907e48f018", "committedDate": "2020-02-18T20:48:54Z", "message": "Add dynamic schedule logic in soft affinity for bucketed splits"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNTg3MDcw", "url": "https://github.com/prestodb/presto/pull/14095#pullrequestreview-360587070", "createdAt": "2020-02-18T18:52:09Z", "commit": {"oid": "6fc2e1734ef97a1966d6fb74a40dde2221b4d986"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxODo1MjowOVrOFrOSbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxODo1ODoyNVrOFrOf8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg2NzE4Mg==", "bodyText": "nit: this.fixedMappingNodes = Optional.of(requireNonNull(fixedMappingNodes, \"fixedMappingNodes is null\"));", "url": "https://github.com/prestodb/presto/pull/14095#discussion_r380867182", "createdAt": "2020-02-18T18:52:09Z", "author": {"login": "shixuan-fan"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/scheduler/group/DynamicBucketNodeMap.java", "diffHunk": "@@ -30,12 +32,23 @@\n {\n     private final int bucketCount;\n     private final Int2ObjectMap<InternalNode> bucketToNode = new Int2ObjectOpenHashMap<>();\n+    private final Optional<List<InternalNode>> fixedMappingNodes;\n \n     public DynamicBucketNodeMap(ToIntFunction<Split> splitToBucket, int bucketCount)\n     {\n         super(splitToBucket);\n         checkArgument(bucketCount > 0, \"bucketCount must be positive\");\n         this.bucketCount = bucketCount;\n+        this.fixedMappingNodes = Optional.empty();\n+    }\n+\n+    public DynamicBucketNodeMap(ToIntFunction<Split> splitToBucket, int bucketCount, List<InternalNode> fixedMappingNodes)\n+    {\n+        super(splitToBucket);\n+        checkArgument(bucketCount > 0, \"bucketCount must be positive\");\n+        this.bucketCount = bucketCount;\n+        requireNonNull(fixedMappingNodes, \"fixedMappingNodes is null\");\n+        this.fixedMappingNodes = Optional.of(fixedMappingNodes);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6fc2e1734ef97a1966d6fb74a40dde2221b4d986"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg3MDY0Mg==", "bodyText": "I don't think this is correct because nodeByTaskId is mapped by task id, yet bucketToNode is mapped by buckets. In most cases one task would handle multiple buckets sequentially, at least in facebook's setup.\nThe expected changes should happen in scheduleInitial and schedule. Basically when try to assign a driverGroup (i.e. worker concept of hive bucket), try to first check bucketNodeMap to find a preferred node. If the task on that node failed, then just select a random node.", "url": "https://github.com/prestodb/presto/pull/14095#discussion_r380870642", "createdAt": "2020-02-18T18:58:25Z", "author": {"login": "shixuan-fan"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/scheduler/group/DynamicLifespanScheduler.java", "diffHunk": "@@ -73,7 +73,12 @@ public DynamicLifespanScheduler(\n             OptionalInt concurrentLifespansPerTask)\n     {\n         this.bucketNodeMap = requireNonNull(bucketNodeMap, \"bucketNodeMap is null\");\n-        this.nodeByTaskId = requireNonNull(nodeByTaskId, \"nodeByTaskId is null\");\n+        if (bucketNodeMap.isDynamic() && bucketNodeMap.getBucketToNode().size() != 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6fc2e1734ef97a1966d6fb74a40dde2221b4d986"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "586776b22c337a768e330278538b44907e48f018", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/586776b22c337a768e330278538b44907e48f018", "committedDate": "2020-02-18T20:48:54Z", "message": "Add dynamic schedule logic in soft affinity for bucketed splits"}, "afterCommit": {"oid": "8c07b2c397314df3a5cd76920934328d84b0c783", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/8c07b2c397314df3a5cd76920934328d84b0c783", "committedDate": "2020-02-18T20:48:54Z", "message": "Add SoftAffinity ability for bucketed splits on engine side"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "884f6f975aacbb7bd1d65b235f5840e78704a76f", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/884f6f975aacbb7bd1d65b235f5840e78704a76f", "committedDate": "2020-02-20T08:50:04Z", "message": "Add dynamic schedule logic in soft affinity for bucketed splits"}, "afterCommit": {"oid": "bf37435a828a645e2b4bf2b3fc1f9c5fc6c9084d", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/bf37435a828a645e2b4bf2b3fc1f9c5fc6c9084d", "committedDate": "2020-02-21T00:27:20Z", "message": "Add dynamic schedule logic in soft affinity for bucketed splits"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bf37435a828a645e2b4bf2b3fc1f9c5fc6c9084d", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/bf37435a828a645e2b4bf2b3fc1f9c5fc6c9084d", "committedDate": "2020-02-21T00:27:20Z", "message": "Add dynamic schedule logic in soft affinity for bucketed splits"}, "afterCommit": {"oid": "daa9c786e6fd3d0e3545d507797f90f8b69e5a6c", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/daa9c786e6fd3d0e3545d507797f90f8b69e5a6c", "committedDate": "2020-02-21T00:38:52Z", "message": "Add dynamic schedule logic in soft affinity for bucketed splits"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyODEzNzU1", "url": "https://github.com/prestodb/presto/pull/14095#pullrequestreview-362813755", "createdAt": "2020-02-21T18:02:41Z", "commit": {"oid": "daa9c786e6fd3d0e3545d507797f90f8b69e5a6c"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyODE1NTQ4", "url": "https://github.com/prestodb/presto/pull/14095#pullrequestreview-362815548", "createdAt": "2020-02-21T18:06:03Z", "commit": {"oid": "daa9c786e6fd3d0e3545d507797f90f8b69e5a6c"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyODE3NjUw", "url": "https://github.com/prestodb/presto/pull/14095#pullrequestreview-362817650", "createdAt": "2020-02-21T18:09:55Z", "commit": {"oid": "7b21cfc0c5234f9fc2ffe3bc6d74715b05b6ca0c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxODowOTo1NVrOFs_40Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxODowOTo1NVrOFs_40Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjcyODQwMQ==", "bodyText": "Consider removing TODO here assuming it is supported in the following commit?", "url": "https://github.com/prestodb/presto/pull/14095#discussion_r382728401", "createdAt": "2020-02-21T18:09:55Z", "author": {"login": "shixuan-fan"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/NodePartitioningManager.java", "diffHunk": "@@ -151,21 +165,30 @@ public NodePartitionMap getNodePartitioningMap(Session session, PartitioningHand\n \n     public BucketNodeMap getBucketNodeMap(Session session, PartitioningHandle partitioningHandle, boolean preferDynamic)\n     {\n-        ConnectorBucketNodeMap connectorBucketNodeMap = getConnectorBucketNodeMap(session, partitioningHandle);\n-\n-        if (connectorBucketNodeMap.hasFixedMapping()) {\n-            return new FixedBucketNodeMap(getSplitToBucket(session, partitioningHandle), getFixedMapping(connectorBucketNodeMap));\n-        }\n-\n-        if (preferDynamic) {\n-            return new DynamicBucketNodeMap(getSplitToBucket(session, partitioningHandle), connectorBucketNodeMap.getBucketCount());\n+        ConnectorId connectorId = partitioningHandle.getConnectorId()\n+                .orElseThrow(() -> new IllegalArgumentException(\"No connector ID for partitioning handle: \" + partitioningHandle));\n+        List<Node> sortedNodes = sortedNodes(connectorId);\n+\n+        ConnectorBucketNodeMap connectorBucketNodeMap = getConnectorBucketNodeMap(session, partitioningHandle, sortedNodes);\n+\n+        NodeSelectionStrategy nodeSelectionStrategy = connectorBucketNodeMap.getNodeSelectionStrategy();\n+        switch (nodeSelectionStrategy) {\n+            case HARD_AFFINITY:\n+            case SOFT_AFFINITY:\n+                // todo for soft affinity, we need to add logic if preferDynamic is true", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTU1MzE1MQ=="}, "originalCommit": {"oid": "7200e44e194304de3864d1315b273a846c95c788"}, "originalPosition": 86}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyODIzMzc2", "url": "https://github.com/prestodb/presto/pull/14095#pullrequestreview-362823376", "createdAt": "2020-02-21T18:19:41Z", "commit": {"oid": "daa9c786e6fd3d0e3545d507797f90f8b69e5a6c"}, "state": "COMMENTED", "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxODoxOTo0MVrOFtAKfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQyMDozMzo0NFrOFtDznA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjczMjkyNA==", "bodyText": "nit: bucketToNodeList is a bit ambiguous given we already have bucketToNode. How about BucketToPreferredNode?", "url": "https://github.com/prestodb/presto/pull/14095#discussion_r382732924", "createdAt": "2020-02-21T18:19:41Z", "author": {"login": "shixuan-fan"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/scheduler/group/DynamicBucketNodeMap.java", "diffHunk": "@@ -38,6 +39,17 @@ public DynamicBucketNodeMap(ToIntFunction<Split> splitToBucket, int bucketCount)\n         this.bucketCount = bucketCount;\n     }\n \n+    public DynamicBucketNodeMap(ToIntFunction<Split> splitToBucket, int bucketCount, List<InternalNode> bucketToNodeList)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "daa9c786e6fd3d0e3545d507797f90f8b69e5a6c"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjczNDA1Mg==", "bodyText": "Maybe this should be a local variable?", "url": "https://github.com/prestodb/presto/pull/14095#discussion_r382734052", "createdAt": "2020-02-21T18:22:03Z", "author": {"login": "shixuan-fan"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/scheduler/group/DynamicLifespanScheduler.java", "diffHunk": "@@ -45,12 +49,14 @@\n \n     private final BucketNodeMap bucketNodeMap;\n     private final List<InternalNode> nodeByTaskId;\n+    private final Set<InternalNode> nodeSet;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "daa9c786e6fd3d0e3545d507797f90f8b69e5a6c"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjczNDQ0Mw==", "bodyText": "How about nodeToPreferredDriverGroupQueue?", "url": "https://github.com/prestodb/presto/pull/14095#discussion_r382734443", "createdAt": "2020-02-21T18:22:59Z", "author": {"login": "shixuan-fan"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/scheduler/group/DynamicLifespanScheduler.java", "diffHunk": "@@ -45,12 +49,14 @@\n \n     private final BucketNodeMap bucketNodeMap;\n     private final List<InternalNode> nodeByTaskId;\n+    private final Set<InternalNode> nodeSet;\n     private final List<ConnectorPartitionHandle> partitionHandles;\n     private final OptionalInt concurrentLifespansPerTask;\n \n     private final IntSet[] runningDriverGroupIdsByTask;\n     private final int[] taskByDriverGroup;\n-    private final IntArrayFIFOQueue driverGroupQueue;\n+    private final IntArrayFIFOQueue driverGroupNoPreferenceQueue;\n+    private final Map<InternalNode, IntArrayFIFOQueue> driverGroupWithPreferenceMapQueue;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "daa9c786e6fd3d0e3545d507797f90f8b69e5a6c"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjczOTE1Mg==", "bodyText": "This seems to be a bit inefficient when there is no preferredNodes, which is the default setting. Could we instead iterate on nodes? We probably would need to have a reverse mapping (node -> buckets) in DynamicBucketNodeMap.", "url": "https://github.com/prestodb/presto/pull/14095#discussion_r382739152", "createdAt": "2020-02-21T18:33:04Z", "author": {"login": "shixuan-fan"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/scheduler/group/DynamicLifespanScheduler.java", "diffHunk": "@@ -87,11 +94,23 @@ public DynamicLifespanScheduler(\n             runningDriverGroupIdsByTask[i] = new IntOpenHashSet();\n         }\n         this.taskByDriverGroup = new int[bucketCount];\n-        this.driverGroupQueue = new IntArrayFIFOQueue(bucketCount);\n         for (int i = 0; i < bucketCount; i++) {\n             taskByDriverGroup[i] = NOT_ASSIGNED;\n-            driverGroupQueue.enqueue(i);\n         }\n+\n+        this.driverGroupNoPreferenceQueue = new IntArrayFIFOQueue();\n+        this.driverGroupWithPreferenceMapQueue = new HashMap<>();\n+        for (int driverGroup = 0; driverGroup < bucketCount; driverGroup++) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "daa9c786e6fd3d0e3545d507797f90f8b69e5a6c"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc0MDcwMg==", "bodyText": "Instead of magical -1, how about returning OptionalInt?", "url": "https://github.com/prestodb/presto/pull/14095#discussion_r382740702", "createdAt": "2020-02-21T18:36:34Z", "author": {"login": "shixuan-fan"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/scheduler/group/DynamicLifespanScheduler.java", "diffHunk": "@@ -102,14 +121,16 @@ public void scheduleInitial(SourceScheduler scheduler)\n \n         int driverGroupsScheduledPerTask = 0;\n         synchronized (this) {\n-            while (!driverGroupQueue.isEmpty()) {\n-                for (int i = 0; i < nodeByTaskId.size() && !driverGroupQueue.isEmpty(); i++) {\n-                    int driverGroupId = driverGroupQueue.dequeueInt();\n-                    checkState(!bucketNodeMap.getAssignedNode(driverGroupId).isPresent());\n-                    bucketNodeMap.assignOrUpdateBucketToNode(driverGroupId, nodeByTaskId.get(i));\n+            while (!driverGroupNoPreferenceQueue.isEmpty() || !driverGroupWithPreferenceMapQueue.isEmpty()) {\n+                for (int taskId = 0; taskId < nodeByTaskId.size() && (!driverGroupNoPreferenceQueue.isEmpty() || !driverGroupWithPreferenceMapQueue.isEmpty()); taskId++) {\n+                    InternalNode node = nodeByTaskId.get(taskId);\n+                    int driverGroupId = pickDriverGroupForNode(node);\n+                    if (driverGroupId == -1) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "daa9c786e6fd3d0e3545d507797f90f8b69e5a6c"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc0MzI0MQ==", "bodyText": "Let's write it in this way:\nif (nodeToPreferredDriverGroupQueue.containsKey(nodeByTaskId.get(taskId)) {\n  Queue<...> preferredDriverGroupQueue = nodeToPreferredDriverGroupQueue.get(...);\n  while (!preferredDriverGroupQueue.isEmpty()) {\n    driverGroupNoPreferenceQueue.enqueue(preferredDriverGroupQueue.deque());\n  }\n}\n\nAlso add a comment explaining what the purpose is for this piece of code :)", "url": "https://github.com/prestodb/presto/pull/14095#discussion_r382743241", "createdAt": "2020-02-21T18:42:13Z", "author": {"login": "shixuan-fan"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/scheduler/group/DynamicLifespanScheduler.java", "diffHunk": "@@ -151,8 +172,12 @@ public void onTaskFailed(int taskId, List<SourceScheduler> sourceSchedulers)\n                 for (SourceScheduler sourceScheduler : sourceSchedulers) {\n                     sourceScheduler.rewindLifespan(Lifespan.driverGroup(driverGroupId), partitionHandles.get(driverGroupId));\n                 }\n-                driverGroupQueue.enqueue(driverGroupId);\n+                driverGroupNoPreferenceQueue.enqueue(driverGroupId);\n+            }\n+            while (driverGroupWithPreferenceMapQueue.get(nodeByTaskId.get(taskId)) != null && !driverGroupWithPreferenceMapQueue.get(nodeByTaskId.get(taskId)).isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "daa9c786e6fd3d0e3545d507797f90f8b69e5a6c"}, "originalPosition": 101}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc4ODM2Nw==", "bodyText": "Let's make it clearer, for example:\nTODO: After initial scheduling, tasks would only be available after they finished at least one bucket. This is not necessarily the case if the initial scheduling covered all buckets and the available slots is not fully utilized (concurrentLifespansPerTask is large or infinite). In this case if a task failed, the recovered driver groups have to wait for tasks to be available again after finishing at least one bucket, even though by definition of concurrentLifespansPerTask they are already available.", "url": "https://github.com/prestodb/presto/pull/14095#discussion_r382788367", "createdAt": "2020-02-21T20:23:06Z", "author": {"login": "shixuan-fan"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/scheduler/group/DynamicLifespanScheduler.java", "diffHunk": "@@ -162,20 +187,23 @@ public SettableFuture schedule(SourceScheduler scheduler)\n     {\n         // Return a new future even if newDriverGroupReady has not finished.\n         // Returning the same SettableFuture instance could lead to ListenableFuture retaining too many listener objects.\n+        // todo resolve availableTasks being limited for unlimited execution", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "daa9c786e6fd3d0e3545d507797f90f8b69e5a6c"}, "originalPosition": 112}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc5MTAwMQ==", "bodyText": "How about naming this getNextDriverGroup?", "url": "https://github.com/prestodb/presto/pull/14095#discussion_r382791001", "createdAt": "2020-02-21T20:29:42Z", "author": {"login": "shixuan-fan"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/scheduler/group/DynamicLifespanScheduler.java", "diffHunk": "@@ -189,4 +217,23 @@ public synchronized boolean allLifespanExecutionFinished()\n     {\n         return totalLifespanExecutionFinished == partitionHandles.size();\n     }\n+\n+    private int pickDriverGroupForNode(InternalNode node)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "daa9c786e6fd3d0e3545d507797f90f8b69e5a6c"}, "originalPosition": 141}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc5MjYwNA==", "bodyText": "Let's just put test introduced here into TestDynamicLifespanScheduler.", "url": "https://github.com/prestodb/presto/pull/14095#discussion_r382792604", "createdAt": "2020-02-21T20:33:44Z", "author": {"login": "shixuan-fan"}, "path": "presto-main/src/test/java/com/facebook/presto/execution/scheduler/group/TestAffinityDynamicLifespanScheduler.java", "diffHunk": "@@ -0,0 +1,319 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.execution.scheduler.group;\n+\n+import com.facebook.presto.client.NodeVersion;\n+import com.facebook.presto.execution.Lifespan;\n+import com.facebook.presto.execution.scheduler.BucketNodeMap;\n+import com.facebook.presto.execution.scheduler.ScheduleResult;\n+import com.facebook.presto.execution.scheduler.SourceScheduler;\n+import com.facebook.presto.metadata.InternalNode;\n+import com.facebook.presto.spi.ConnectorSplit;\n+import com.facebook.presto.spi.HostAddress;\n+import com.facebook.presto.spi.connector.ConnectorPartitionHandle;\n+import com.facebook.presto.spi.plan.PlanNodeId;\n+import com.facebook.presto.spi.schedule.NodeSelectionStrategy;\n+import com.google.common.collect.ImmutableList;\n+import org.testng.annotations.Test;\n+\n+import java.net.URI;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.OptionalInt;\n+import java.util.stream.IntStream;\n+\n+import static com.facebook.presto.spi.schedule.NodeSelectionStrategy.SOFT_AFFINITY;\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static org.testng.Assert.assertEquals;\n+\n+public class TestAffinityDynamicLifespanScheduler", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "daa9c786e6fd3d0e3545d507797f90f8b69e5a6c"}, "originalPosition": 41}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "daa9c786e6fd3d0e3545d507797f90f8b69e5a6c", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/daa9c786e6fd3d0e3545d507797f90f8b69e5a6c", "committedDate": "2020-02-21T00:38:52Z", "message": "Add dynamic schedule logic in soft affinity for bucketed splits"}, "afterCommit": {"oid": "84ae8566d709c15f89d24a39ebc8a8a6360b027c", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/84ae8566d709c15f89d24a39ebc8a8a6360b027c", "committedDate": "2020-02-21T23:38:47Z", "message": "Support sort affinity in DynamicLifespanScheduler"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "84ae8566d709c15f89d24a39ebc8a8a6360b027c", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/84ae8566d709c15f89d24a39ebc8a8a6360b027c", "committedDate": "2020-02-21T23:38:47Z", "message": "Support sort affinity in DynamicLifespanScheduler"}, "afterCommit": {"oid": "be7ccae82d0674e4f3a7905d03959b804ffef355", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/be7ccae82d0674e4f3a7905d03959b804ffef355", "committedDate": "2020-02-21T23:43:30Z", "message": "Support sort affinity in DynamicLifespanScheduler"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d1908f0da88dd572989fb025281663e908d296e", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/6d1908f0da88dd572989fb025281663e908d296e", "committedDate": "2020-02-21T23:44:53Z", "message": "Support soft affinity for bucketed splits"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "be7ccae82d0674e4f3a7905d03959b804ffef355", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/be7ccae82d0674e4f3a7905d03959b804ffef355", "committedDate": "2020-02-21T23:43:30Z", "message": "Support sort affinity in DynamicLifespanScheduler"}, "afterCommit": {"oid": "4616b0f42e82132d66e96c17365e2dbbc1570a0c", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/4616b0f42e82132d66e96c17365e2dbbc1570a0c", "committedDate": "2020-02-21T23:45:43Z", "message": "Support sort affinity in DynamicLifespanScheduler"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzNjA0MTUx", "url": "https://github.com/prestodb/presto/pull/14095#pullrequestreview-363604151", "createdAt": "2020-02-24T18:27:58Z", "commit": {"oid": "4616b0f42e82132d66e96c17365e2dbbc1570a0c"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzNjA5MzEw", "url": "https://github.com/prestodb/presto/pull/14095#pullrequestreview-363609310", "createdAt": "2020-02-24T18:36:08Z", "commit": {"oid": "4616b0f42e82132d66e96c17365e2dbbc1570a0c"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxODozNjowOFrOFtrWaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxODozNjowOFrOFtrWaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQ0MDQ4OA==", "bodyText": "nit: Let's follow the other comments' pattern and capitalize the first character of the sentence :)", "url": "https://github.com/prestodb/presto/pull/14095#discussion_r383440488", "createdAt": "2020-02-24T18:36:08Z", "author": {"login": "shixuan-fan"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/scheduler/group/DynamicLifespanScheduler.java", "diffHunk": "@@ -151,8 +167,19 @@ public void onTaskFailed(int taskId, List<SourceScheduler> sourceSchedulers)\n                 for (SourceScheduler sourceScheduler : sourceSchedulers) {\n                     sourceScheduler.rewindLifespan(Lifespan.driverGroup(driverGroupId), partitionHandles.get(driverGroupId));\n                 }\n-                driverGroupQueue.enqueue(driverGroupId);\n+                noPreferenceDriverGroups.enqueue(driverGroupId);\n+            }\n+\n+            // when a task fails, all driverGroups that prefer this task/node would be not able to execute", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4616b0f42e82132d66e96c17365e2dbbc1570a0c"}, "originalPosition": 85}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9fcd9430a8c086bdc88d37ebd8cbbd83e3932bce", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/9fcd9430a8c086bdc88d37ebd8cbbd83e3932bce", "committedDate": "2020-02-24T18:44:35Z", "message": "Support soft affinity in DynamicLifespanScheduler"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4616b0f42e82132d66e96c17365e2dbbc1570a0c", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/4616b0f42e82132d66e96c17365e2dbbc1570a0c", "committedDate": "2020-02-21T23:45:43Z", "message": "Support sort affinity in DynamicLifespanScheduler"}, "afterCommit": {"oid": "9fcd9430a8c086bdc88d37ebd8cbbd83e3932bce", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/9fcd9430a8c086bdc88d37ebd8cbbd83e3932bce", "committedDate": "2020-02-24T18:44:35Z", "message": "Support soft affinity in DynamicLifespanScheduler"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2192, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}