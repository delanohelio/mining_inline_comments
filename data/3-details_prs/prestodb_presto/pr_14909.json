{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU3OTYzMTI2", "number": 14909, "title": "Implement Window Function Spilling", "bodyText": "Original PR: trinodb/trino#228\nBroken up into ORDER BY spilling (merged in #14836) and Window function spilling (this one)\nPart of #14935\nTODO\n\nRelease notes\nWindow function docs", "createdAt": "2020-07-28T17:57:53Z", "url": "https://github.com/prestodb/presto/pull/14909", "merged": true, "mergeCommit": {"oid": "28b60627a52edc25aee976c4d0da225fd32b2942"}, "closed": true, "closedAt": "2020-08-04T01:08:19Z", "author": {"login": "sachdevs"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5Y2p1gH2gAyNDU3OTYzMTI2OjdiNjRhZTdmNWE2YTJiOTA2MWZhNWJmYTA4MGRlMjcwZTgwMTc3YTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7aSyaAFqTQ2MDM5Mzc3Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7b64ae7f5a6a2b9061fa5bfa080de270e80177a3", "author": {"user": {"login": "sachdevs", "name": "Saksham"}}, "url": "https://github.com/prestodb/presto/commit/7b64ae7f5a6a2b9061fa5bfa080de270e80177a3", "committedDate": "2020-07-28T16:17:11Z", "message": "Port window operator to work processors\n\nCherry-pick of https://github.com/prestosql/presto/commit/17e3e09674972c6b627eb454f1e50628943af262\n\nCo-authored-by: Karol Sobczak <karol.sobczak@karolsobczak.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78bce8b6ee3e8debb1aca1d128818a50e2bdeb2b", "author": {"user": {"login": "sachdevs", "name": "Saksham"}}, "url": "https://github.com/prestodb/presto/commit/78bce8b6ee3e8debb1aca1d128818a50e2bdeb2b", "committedDate": "2020-07-28T16:17:34Z", "message": "Separate input PageSource work processor\nThis avoids calling `Page.getRegion` on the input page and separates\ninput management from index building.\n\nCherry-pick of https://github.com/prestosql/presto/commit/b164253c7ffe9c01513f97d627a9410bfb9ae691\n\nCo-authored-by: Karol Sobczak <karol.sobczak@karolsobczak.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c70a756973facf3a7b5d6e140f10e73266c70a98", "author": {"user": {"login": "sachdevs", "name": "Saksham"}}, "url": "https://github.com/prestodb/presto/commit/c70a756973facf3a7b5d6e140f10e73266c70a98", "committedDate": "2020-07-28T16:23:13Z", "message": "Introduce revocable aggregated memory context in OperatorContext\n\nCherry-pick of https://github.com/prestosql/presto/commit/7200a16fc16d74a6c783ea287b0055f5267316d3\n\nCo-authored-by: Atri Sharma <atri@linux.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22db7c2926a119eb8dff4147da0568ad82526e16", "author": {"user": {"login": "sachdevs", "name": "Saksham"}}, "url": "https://github.com/prestodb/presto/commit/22db7c2926a119eb8dff4147da0568ad82526e16", "committedDate": "2020-07-28T16:47:02Z", "message": "Implement spill to disk For WindowOperator\n\nCherry-pick of https://github.com/prestosql/presto/commit/d398d1c374a8d56e21a95ea3b6b84a4a5ff98268\n\nCo-authored-by: Karol Sobczak <karol.sobczak@karolsobczak.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4201ee8cdf31197dc3875ef364bf00cd1fbe409a", "author": {"user": {"login": "sachdevs", "name": "Saksham"}}, "url": "https://github.com/prestodb/presto/commit/4201ee8cdf31197dc3875ef364bf00cd1fbe409a", "committedDate": "2020-07-28T17:25:21Z", "message": "Use OrderingCompiler in WindowOperator spilling\n\nCherry-pick of https://github.com/prestosql/presto/commit/2b821e129712918fbc04fa58722633adcd4dd9f8\n\nCo-authored-by: Karol Sobczak <karol.sobczak@karolsobczak.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3943eab82865250ab304474b260c7fa3b73d0edd", "author": {"user": {"login": "sachdevs", "name": "Saksham"}}, "url": "https://github.com/prestodb/presto/commit/3943eab82865250ab304474b260c7fa3b73d0edd", "committedDate": "2020-07-28T17:49:56Z", "message": "Convert revocable memory to user memory on fully buffered group\n\nCherry-pick of https://github.com/prestosql/presto/commit/d76a830ae0c21e5689e55ec63374dd6257c71ab0\n\nCo-authored-by: Karol Sobczak <karol.sobczak@karolsobczak.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e95517d6569cf5523943608a4f4be56e4911e15e", "author": {"user": {"login": "sachdevs", "name": "Saksham"}}, "url": "https://github.com/prestodb/presto/commit/e95517d6569cf5523943608a4f4be56e4911e15e", "committedDate": "2020-07-28T17:50:32Z", "message": "Extract window queries tests to separate class\n\nCherry-pick of https://github.com/prestosql/presto/commit/fcc18ff1c5360efdc43ac40629ad2845065de97c\n\nCo-authored-by: Karol Sobczak <karol.sobczak@karolsobczak.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb5bfd9944ef61bfe52bef6fdd881187aa520a81", "author": {"user": {"login": "sachdevs", "name": "Saksham"}}, "url": "https://github.com/prestodb/presto/commit/cb5bfd9944ef61bfe52bef6fdd881187aa520a81", "committedDate": "2020-07-28T17:56:41Z", "message": "Close spiller in Operator#close() for window spilling"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4MDI5MjM3", "url": "https://github.com/prestodb/presto/pull/14909#pullrequestreview-458029237", "createdAt": "2020-07-30T02:27:46Z", "commit": {"oid": "cb5bfd9944ef61bfe52bef6fdd881187aa520a81"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4MDMxMzc4", "url": "https://github.com/prestodb/presto/pull/14909#pullrequestreview-458031378", "createdAt": "2020-07-30T02:34:43Z", "commit": {"oid": "cb5bfd9944ef61bfe52bef6fdd881187aa520a81"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4ODU2MTQ5", "url": "https://github.com/prestodb/presto/pull/14909#pullrequestreview-458856149", "createdAt": "2020-07-31T00:58:21Z", "commit": {"oid": "c70a756973facf3a7b5d6e140f10e73266c70a98"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwMDo1ODoyMVrOG54r1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwMDo1ODoyMVrOG54r1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM1MDc0Mw==", "bodyText": "This looks quite general, surprised not added before when adding aggregation spilling", "url": "https://github.com/prestodb/presto/pull/14909#discussion_r463350743", "createdAt": "2020-07-31T00:58:21Z", "author": {"login": "wenleix"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/OperatorContext.java", "diffHunk": "@@ -264,6 +264,12 @@ public AggregatedMemoryContext aggregateUserMemoryContext()\n         return new InternalAggregatedMemoryContext(operatorMemoryContext.aggregateUserMemoryContext(), memoryFuture, this::updatePeakMemoryReservations, false);\n     }\n \n+    // caller shouldn't close this context as it's managed by the OperatorContext\n+    public AggregatedMemoryContext aggregateRevocableMemoryContext()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c70a756973facf3a7b5d6e140f10e73266c70a98"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5NTQ4ODA0", "url": "https://github.com/prestodb/presto/pull/14909#pullrequestreview-459548804", "createdAt": "2020-08-01T03:27:05Z", "commit": {"oid": "cb5bfd9944ef61bfe52bef6fdd881187aa520a81"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5NzYxMTY5", "url": "https://github.com/prestodb/presto/pull/14909#pullrequestreview-459761169", "createdAt": "2020-08-03T05:47:38Z", "commit": {"oid": "cb5bfd9944ef61bfe52bef6fdd881187aa520a81"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5NzY0Njc5", "url": "https://github.com/prestodb/presto/pull/14909#pullrequestreview-459764679", "createdAt": "2020-08-03T05:59:04Z", "commit": {"oid": "cb5bfd9944ef61bfe52bef6fdd881187aa520a81"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwMzMxMTc1", "url": "https://github.com/prestodb/presto/pull/14909#pullrequestreview-460331175", "createdAt": "2020-08-03T20:49:20Z", "commit": {"oid": "3943eab82865250ab304474b260c7fa3b73d0edd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QyMDo0OToyMFrOG7IQrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QyMDo0OToyMFrOG7IQrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY1NDUxMQ==", "bodyText": "I assume \"us\" here means this window operator itself, especially SpillablePagesToPagesIndexes#process", "url": "https://github.com/prestodb/presto/pull/14909#discussion_r464654511", "createdAt": "2020-08-03T20:49:20Z", "author": {"login": "wenleix"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/WindowOperator.java", "diffHunk": "@@ -567,12 +567,14 @@ void updateMemoryUsage()\n         final SpillerFactory spillerFactory;\n         final PageWithPositionComparator pageWithPositionComparator;\n \n+        boolean spillingWhenConvertingRevocableMemory;\n         boolean resetPagesIndex;\n         int pendingInputPosition;\n \n         Optional<Page> currentSpillGroupRowPage;\n         Optional<Spiller> spiller;\n-        ListenableFuture<?> spillInProgress = immediateFuture(null);\n+        // Spill can be trigger by Driver, by us or both. `spillInProgress` is not empty when spill was triggered but not `finishMemoryRevoke()` yet", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3943eab82865250ab304474b260c7fa3b73d0edd"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwMzkzMzk0", "url": "https://github.com/prestodb/presto/pull/14909#pullrequestreview-460393394", "createdAt": "2020-08-03T23:04:34Z", "commit": {"oid": "cb5bfd9944ef61bfe52bef6fdd881187aa520a81"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwMzkzNzc2", "url": "https://github.com/prestodb/presto/pull/14909#pullrequestreview-460393776", "createdAt": "2020-08-03T23:05:40Z", "commit": {"oid": "cb5bfd9944ef61bfe52bef6fdd881187aa520a81"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 353, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}