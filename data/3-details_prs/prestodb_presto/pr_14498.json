{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE1MDI5NTUy", "number": 14498, "title": "Drop presto-orc's dependency on presto-spi", "bodyText": "== NO RELEASE NOTE ==", "createdAt": "2020-05-08T03:46:56Z", "url": "https://github.com/prestodb/presto/pull/14498", "merged": true, "mergeCommit": {"oid": "cc312861c9df16c95a693949f710712c36ed606b"}, "closed": true, "closedAt": "2020-05-08T21:19:25Z", "author": {"login": "NikhilCollooru"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcfKhgbgFqTQwNzk5MjE4MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc9uuQOgFqTQ2NDczMjgxNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3OTkyMTgx", "url": "https://github.com/prestodb/presto/pull/14498#pullrequestreview-407992181", "createdAt": "2020-05-08T04:44:22Z", "commit": {"oid": "dfc5e395266ba4248eb05d7d81334783643f370c"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQwNDo0NDoyM1rOGSY2zg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQwNDo1MzoyMFrOGSY-6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTkzNDc5OA==", "bodyText": "We should rethrow\n        catch (InvalidFunctionArgumentException e) {\n            closeWithSuppression(e);\n            throw new PrestoException(INVALID_.....);\n        }", "url": "https://github.com/prestodb/presto/pull/14498#discussion_r421934798", "createdAt": "2020-05-08T04:44:23Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/orc/OrcSelectivePageSource.java", "diffHunk": "@@ -87,7 +88,7 @@ public Page getNextPage()\n             }\n             return page;\n         }\n-        catch (PrestoException e) {\n+        catch (PrestoException | InvalidFunctionArgumentException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dfc5e395266ba4248eb05d7d81334783643f370c"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTkzNTE3OA==", "bodyText": "Same, rethrow", "url": "https://github.com/prestodb/presto/pull/14498#discussion_r421935178", "createdAt": "2020-05-08T04:46:01Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/orc/OrcSelectivePageSource.java", "diffHunk": "@@ -88,7 +89,7 @@ public Page getNextPage()\n             }\n             return page;\n         }\n-        catch (PrestoException | InvalidFunctionArgumentException e) {\n+        catch (PrestoException | InvalidFunctionArgumentException | NotSupportedException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17e10686d748e1456214d23fa228aad6d947177c"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTkzNjg3Mw==", "bodyText": "Seems NOT_SUPPORTED is only thrown by OrcWriter but not reader. Did I miss anything?", "url": "https://github.com/prestodb/presto/pull/14498#discussion_r421936873", "createdAt": "2020-05-08T04:53:20Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/orc/OrcSelectivePageSourceFactory.java", "diffHunk": "@@ -360,23 +362,29 @@ public static OrcSelectivePageSource createOrcPageSource(\n \n             List<FilterFunction> filterFunctions = toFilterFunctions(replaceExpression(remainingPredicate, variableToInput), bucketAdapter, session, rowExpressionService.getDeterminismEvaluator(), rowExpressionService.getPredicateCompiler());\n \n-            OrcSelectiveRecordReader recordReader = reader.createSelectiveRecordReader(\n-                    columnTypes,\n-                    outputIndices,\n-                    tupleDomainFilters,\n-                    filterFunctions,\n-                    inputs.inverse(),\n-                    requiredSubfields,\n-                    typedPrefilledValues,\n-                    Maps.transformValues(mappedCoercers, Function.class::cast),\n-                    orcPredicate,\n-                    start,\n-                    length,\n-                    hiveStorageTimeZone,\n-                    session.getSqlFunctionProperties().isLegacyMapSubscript(),\n-                    systemMemoryUsage,\n-                    Optional.empty(),\n-                    INITIAL_BATCH_SIZE);\n+            OrcSelectiveRecordReader recordReader;\n+            try {\n+                recordReader = reader.createSelectiveRecordReader(\n+                        columnTypes,\n+                        outputIndices,\n+                        tupleDomainFilters,\n+                        filterFunctions,\n+                        inputs.inverse(),\n+                        requiredSubfields,\n+                        typedPrefilledValues,\n+                        Maps.transformValues(mappedCoercers, Function.class::cast),\n+                        orcPredicate,\n+                        start,\n+                        length,\n+                        hiveStorageTimeZone,\n+                        session.getSqlFunctionProperties().isLegacyMapSubscript(),\n+                        systemMemoryUsage,\n+                        Optional.empty(),\n+                        INITIAL_BATCH_SIZE);\n+            }\n+            catch (NotSupportedException e) {\n+                throw new PrestoException(NOT_SUPPORTED, e.getMessage(), e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17e10686d748e1456214d23fa228aad6d947177c"}, "originalPosition": 58}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77f913c43c338713ecb4d46a95f846a7f117ad73", "author": {"user": {"login": "NikhilCollooru", "name": "Nikhil Collooru"}}, "url": "https://github.com/prestodb/presto/commit/77f913c43c338713ecb4d46a95f846a7f117ad73", "committedDate": "2020-05-08T06:26:46Z", "message": "Drop presto-orc usage of INVALID_FUNCTION_ARGUMENT PrestoException"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dcb894e027664f74b4a5f82ccd990cad9c7b1418", "author": {"user": {"login": "NikhilCollooru", "name": "Nikhil Collooru"}}, "url": "https://github.com/prestodb/presto/commit/dcb894e027664f74b4a5f82ccd990cad9c7b1418", "committedDate": "2020-05-08T06:27:02Z", "message": "Drop presto-orc usage of GENERIC_INTERNAL_ERROR PrestoException"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "17e10686d748e1456214d23fa228aad6d947177c", "author": {"user": {"login": "NikhilCollooru", "name": "Nikhil Collooru"}}, "url": "https://github.com/prestodb/presto/commit/17e10686d748e1456214d23fa228aad6d947177c", "committedDate": "2020-05-08T03:43:19Z", "message": "Drop presto-orc usage of NOT_SUPPORTED PrestoException"}, "afterCommit": {"oid": "d33eef3675f3185cb7a832e5cc977588746c2079", "author": {"user": {"login": "NikhilCollooru", "name": "Nikhil Collooru"}}, "url": "https://github.com/prestodb/presto/commit/d33eef3675f3185cb7a832e5cc977588746c2079", "committedDate": "2020-05-08T06:57:42Z", "message": "Drop presto-orc usage of NOT_SUPPORTED PrestoException"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4Mzg2MDEw", "url": "https://github.com/prestodb/presto/pull/14498#pullrequestreview-408386010", "createdAt": "2020-05-08T17:10:01Z", "commit": {"oid": "d33eef3675f3185cb7a832e5cc977588746c2079"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQxNzoxMDowMlrOGSszlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQxNzoxMDowMlrOGSszlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI2MTY1Mg==", "bodyText": "But checking the callsites, I think we need to catch NotSupportedException for getNextPage method in both OrcBatchPageSource and OrcSelectivePageSource. We also need to catch InvalidFunctionArgumentException for OrcBatchPageSource.getNextPage", "url": "https://github.com/prestodb/presto/pull/14498#discussion_r422261652", "createdAt": "2020-05-08T17:10:02Z", "author": {"login": "highker"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/metadata/ExceptionWrappingMetadataReader.java", "diffHunk": "@@ -114,7 +116,9 @@ public StripeFooter readStripeFooter(List<OrcType> types, InputStream inputStrea\n \n     private OrcCorruptionException propagate(Throwable throwable, String message)\n     {\n-        propagateIfPossible(throwable, PrestoException.class);\n+        propagateIfPossible(throwable, InvalidFunctionArgumentException.class);\n+        propagateIfPossible(throwable, NotSupportedException.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d33eef3675f3185cb7a832e5cc977588746c2079"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23d24058443f7bc60ddd96422384f43457b54c58", "author": {"user": {"login": "NikhilCollooru", "name": "Nikhil Collooru"}}, "url": "https://github.com/prestodb/presto/commit/23d24058443f7bc60ddd96422384f43457b54c58", "committedDate": "2020-05-08T20:16:17Z", "message": "Drop presto-orc usage of NOT_SUPPORTED PrestoException"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d33eef3675f3185cb7a832e5cc977588746c2079", "author": {"user": {"login": "NikhilCollooru", "name": "Nikhil Collooru"}}, "url": "https://github.com/prestodb/presto/commit/d33eef3675f3185cb7a832e5cc977588746c2079", "committedDate": "2020-05-08T06:57:42Z", "message": "Drop presto-orc usage of NOT_SUPPORTED PrestoException"}, "afterCommit": {"oid": "23d24058443f7bc60ddd96422384f43457b54c58", "author": {"user": {"login": "NikhilCollooru", "name": "Nikhil Collooru"}}, "url": "https://github.com/prestodb/presto/commit/23d24058443f7bc60ddd96422384f43457b54c58", "committedDate": "2020-05-08T20:16:17Z", "message": "Drop presto-orc usage of NOT_SUPPORTED PrestoException"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0NzMyODE3", "url": "https://github.com/prestodb/presto/pull/14498#pullrequestreview-464732817", "createdAt": "2020-08-11T04:01:36Z", "commit": {"oid": "23d24058443f7bc60ddd96422384f43457b54c58"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwNDowMTozNlrOG-nkIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwNDowMTozNlrOG-nkIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMxMzEyMQ==", "bodyText": "Why this line get removed as well? -- I have seen IOException (e.g. connection reset when reading from storage system) are now treated as HIVE_BAD_DATA  due to Presto thought it's OrcCorruptionException?\ncc @NikhilCollooru , @highker", "url": "https://github.com/prestodb/presto/pull/14498#discussion_r468313121", "createdAt": "2020-08-11T04:01:36Z", "author": {"login": "wenleix"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/metadata/ExceptionWrappingMetadataReader.java", "diffHunk": "@@ -114,7 +112,6 @@ public StripeFooter readStripeFooter(List<OrcType> types, InputStream inputStrea\n \n     private OrcCorruptionException propagate(Throwable throwable, String message)\n     {\n-        propagateIfPossible(throwable, PrestoException.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23d24058443f7bc60ddd96422384f43457b54c58"}, "originalPosition": 19}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1593, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}