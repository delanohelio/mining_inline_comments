{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU3NjA1MjI3", "number": 14904, "title": "Move TranslateExpressions above all PickTableLayouts", "bodyText": "== NO RELEASE NOTE ==", "createdAt": "2020-07-28T07:16:31Z", "url": "https://github.com/prestodb/presto/pull/14904", "merged": true, "mergeCommit": {"oid": "611d210fa73479a784c9dcba2505399cf69a6baa"}, "closed": true, "closedAt": "2020-07-29T02:45:15Z", "author": {"login": "highker"}, "timelineItems": {"totalCount": 25, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5SDA-gBqjM1OTMyMDU0MTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5huLIAFqTQ1NzE1NDY5OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "caf11dbc48ad19b0cdc12898c1fc07e06cb9044b", "author": {"user": {"login": "highker", "name": "James Sun"}}, "url": "https://github.com/prestodb/presto/commit/caf11dbc48ad19b0cdc12898c1fc07e06cb9044b", "committedDate": "2020-07-28T06:30:02Z", "message": "Remove unused functions in ExpressionUtils"}, "afterCommit": {"oid": "31f6cb401ead87f092e40d4e2baa180bbbe7db15", "author": {"user": {"login": "highker", "name": "James Sun"}}, "url": "https://github.com/prestodb/presto/commit/31f6cb401ead87f092e40d4e2baa180bbbe7db15", "committedDate": "2020-07-28T05:14:21Z", "message": "Move TranslateExpressions above IndexJoinOptimizer"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "31f6cb401ead87f092e40d4e2baa180bbbe7db15", "author": {"user": {"login": "highker", "name": "James Sun"}}, "url": "https://github.com/prestodb/presto/commit/31f6cb401ead87f092e40d4e2baa180bbbe7db15", "committedDate": "2020-07-28T05:14:21Z", "message": "Move TranslateExpressions above IndexJoinOptimizer"}, "afterCommit": {"oid": "3733f4f65d805effd94efe77f867e6a94aca0072", "author": {"user": {"login": "highker", "name": "James Sun"}}, "url": "https://github.com/prestodb/presto/commit/3733f4f65d805effd94efe77f867e6a94aca0072", "committedDate": "2020-07-28T09:02:24Z", "message": "Remove unused functions in ExpressionUtils"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33730b213fa7f97c9f3c29d2f366b43974ecdc36", "author": {"user": {"login": "highker", "name": "James Sun"}}, "url": "https://github.com/prestodb/presto/commit/33730b213fa7f97c9f3c29d2f366b43974ecdc36", "committedDate": "2020-07-28T18:38:49Z", "message": "Move TranslateExpressions below GatherAndMergeWindows"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e86d968a5d8f054b205576572e44dd4edb0a9fd", "author": {"user": {"login": "highker", "name": "James Sun"}}, "url": "https://github.com/prestodb/presto/commit/8e86d968a5d8f054b205576572e44dd4edb0a9fd", "committedDate": "2020-07-28T18:38:49Z", "message": "Move TranslateExpressions above GatherAndMergeWindows"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3733f4f65d805effd94efe77f867e6a94aca0072", "author": {"user": {"login": "highker", "name": "James Sun"}}, "url": "https://github.com/prestodb/presto/commit/3733f4f65d805effd94efe77f867e6a94aca0072", "committedDate": "2020-07-28T09:02:24Z", "message": "Remove unused functions in ExpressionUtils"}, "afterCommit": {"oid": "af123bb01e1df463dfaf9ca51a6a0db027ed2a95", "author": {"user": {"login": "highker", "name": "James Sun"}}, "url": "https://github.com/prestodb/presto/commit/af123bb01e1df463dfaf9ca51a6a0db027ed2a95", "committedDate": "2020-07-28T18:38:49Z", "message": "Remove unused functions in ExpressionUtils"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MDYzMTU4", "url": "https://github.com/prestodb/presto/pull/14904#pullrequestreview-457063158", "createdAt": "2020-07-28T22:07:57Z", "commit": {"oid": "af123bb01e1df463dfaf9ca51a6a0db027ed2a95"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MDY0Njg4", "url": "https://github.com/prestodb/presto/pull/14904#pullrequestreview-457064688", "createdAt": "2020-07-28T22:11:04Z", "commit": {"oid": "8e86d968a5d8f054b205576572e44dd4edb0a9fd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQyMjoxMTowNVrOG4hXVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQyMjoxMTowNVrOG4hXVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTkyMDA4Ng==", "bodyText": "This return statement is very hard to read...Though I understand it is a copy-paste, maybe consider using variable name to represent each disjunctions?", "url": "https://github.com/prestodb/presto/pull/14904#discussion_r461920086", "createdAt": "2020-07-28T22:11:05Z", "author": {"login": "shixuan-fan"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/iterative/rule/GatherAndMergeWindows.java", "diffHunk": "@@ -176,10 +170,21 @@ public Result apply(WindowNode parent, Captures captures, Context context)\n         }\n     }\n \n-    private static Set<VariableReferenceExpression> extractUnique(Assignments assignments, TypeProvider types)\n+    private static Set<VariableReferenceExpression> extractUnique(Assignments assignments)\n     {\n         Collection<RowExpression> expressions = assignments.getExpressions();\n-        return VariablesExtractor.extractUnique(expressions.stream().map(OriginalExpressionUtils::castToExpression).collect(toImmutableList()), types);\n+        return VariablesExtractor.extractUnique(expressions);\n+    }\n+\n+    private static boolean dependsOn(WindowNode parent, WindowNode child)\n+    {\n+        return parent.getPartitionBy().stream().anyMatch(child.getCreatedVariable()::contains)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e86d968a5d8f054b205576572e44dd4edb0a9fd"}, "originalPosition": 70}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MDY1NDM4", "url": "https://github.com/prestodb/presto/pull/14904#pullrequestreview-457065438", "createdAt": "2020-07-28T22:12:44Z", "commit": {"oid": "bc66f18da5e987304e0bd557293c71ed36edb21b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQyMjoxMjo0NFrOG4hcRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQyMjoxMjo0NFrOG4hcRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTkyMTM1MA==", "bodyText": "nit: static import?", "url": "https://github.com/prestodb/presto/pull/14904#discussion_r461921350", "createdAt": "2020-07-28T22:12:44Z", "author": {"login": "shixuan-fan"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/optimizations/WindowFilterPushDown.java", "diffHunk": "@@ -180,46 +183,46 @@ else if (source instanceof WindowNode && canOptimizeWindowFunction((WindowNode)\n \n         private PlanNode rewriteFilterSource(FilterNode filterNode, PlanNode source, VariableReferenceExpression rowNumberVariable, int upperBound)\n         {\n-            ExtractionResult extractionResult = fromPredicate(metadata, session, castToExpression(filterNode.getPredicate()), types);\n-            TupleDomain<String> tupleDomain = extractionResult.getTupleDomain();\n+            DomainTranslator.ExtractionResult<VariableReferenceExpression> extractionResult = domainTranslator.fromPredicate(session.toConnectorSession(), filterNode.getPredicate());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc66f18da5e987304e0bd557293c71ed36edb21b"}, "originalPosition": 111}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MDY2Nzgz", "url": "https://github.com/prestodb/presto/pull/14904#pullrequestreview-457066783", "createdAt": "2020-07-28T22:15:30Z", "commit": {"oid": "af123bb01e1df463dfaf9ca51a6a0db027ed2a95"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MDY4NDg0", "url": "https://github.com/prestodb/presto/pull/14904#pullrequestreview-457068484", "createdAt": "2020-07-28T22:19:03Z", "commit": {"oid": "af123bb01e1df463dfaf9ca51a6a0db027ed2a95"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MDY5NDE2", "url": "https://github.com/prestodb/presto/pull/14904#pullrequestreview-457069416", "createdAt": "2020-07-28T22:21:02Z", "commit": {"oid": "af123bb01e1df463dfaf9ca51a6a0db027ed2a95"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MDY5NjA4", "url": "https://github.com/prestodb/presto/pull/14904#pullrequestreview-457069608", "createdAt": "2020-07-28T22:21:25Z", "commit": {"oid": "af123bb01e1df463dfaf9ca51a6a0db027ed2a95"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MDcwMzAx", "url": "https://github.com/prestodb/presto/pull/14904#pullrequestreview-457070301", "createdAt": "2020-07-28T22:22:49Z", "commit": {"oid": "af123bb01e1df463dfaf9ca51a6a0db027ed2a95"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MDcwNzA5", "url": "https://github.com/prestodb/presto/pull/14904#pullrequestreview-457070709", "createdAt": "2020-07-28T22:23:39Z", "commit": {"oid": "af123bb01e1df463dfaf9ca51a6a0db027ed2a95"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MDcwOTQ3", "url": "https://github.com/prestodb/presto/pull/14904#pullrequestreview-457070947", "createdAt": "2020-07-28T22:24:13Z", "commit": {"oid": "af123bb01e1df463dfaf9ca51a6a0db027ed2a95"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5134aae5c57be99dbe75ce965eaff3322cb4f77c", "author": {"user": {"login": "hellium01", "name": "Yi He"}}, "url": "https://github.com/prestodb/presto/commit/5134aae5c57be99dbe75ce965eaff3322cb4f77c", "committedDate": "2020-07-29T00:22:15Z", "message": "Move TranslateExpressions above WindowFilterPushDown"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e12605f7ab695216f3b7cf46522c38434774836", "author": {"user": {"login": "highker", "name": "James Sun"}}, "url": "https://github.com/prestodb/presto/commit/0e12605f7ab695216f3b7cf46522c38434774836", "committedDate": "2020-07-29T00:22:15Z", "message": "Move TranslateExpressions above LimitPushDown"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1cf7becca420ca158f7e3f55a9db4958138f216", "author": {"user": {"login": "highker", "name": "James Sun"}}, "url": "https://github.com/prestodb/presto/commit/f1cf7becca420ca158f7e3f55a9db4958138f216", "committedDate": "2020-07-29T00:22:15Z", "message": "Move TranslateExpressions above SimplifyCountOverConstant"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6bb3f98d4da9135729ccab9abb0ddc5aa6be1072", "author": {"user": {"login": "highker", "name": "James Sun"}}, "url": "https://github.com/prestodb/presto/commit/6bb3f98d4da9135729ccab9abb0ddc5aa6be1072", "committedDate": "2020-07-29T00:32:27Z", "message": "Move TranslateExpressions above IndexJoinOptimizer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f042d9b3dde8a649e02a8f3ab25fbf773109d258", "author": {"user": {"login": "highker", "name": "James Sun"}}, "url": "https://github.com/prestodb/presto/commit/f042d9b3dde8a649e02a8f3ab25fbf773109d258", "committedDate": "2020-07-29T00:32:32Z", "message": "Move TranslateExpressions below PushAggregationThroughOuterJoin\n\nThe patch also alters the variable names in TestTpcdsCostBasedPlan as\nvariable allocator assign names to variables based on function name\nhints. This causes assignment variables have function name hints before\ngot inlined with projections."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8cc01f7d9c43fe6ea2d0338f936c8993b57fc66a", "author": {"user": {"login": "highker", "name": "James Sun"}}, "url": "https://github.com/prestodb/presto/commit/8cc01f7d9c43fe6ea2d0338f936c8993b57fc66a", "committedDate": "2020-07-29T00:32:32Z", "message": "Move TranslateExpressions above PushAggregationThroughOuterJoin"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85e880851d34068b1ab70ceb3ae4eee5c6a4b3c9", "author": {"user": {"login": "highker", "name": "James Sun"}}, "url": "https://github.com/prestodb/presto/commit/85e880851d34068b1ab70ceb3ae4eee5c6a4b3c9", "committedDate": "2020-07-29T00:32:32Z", "message": "Move TranslateExpressions above all PickTableLayouts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5cbcee43f97009adb147ee0f064bb8f68f1ccf0", "author": {"user": {"login": "highker", "name": "James Sun"}}, "url": "https://github.com/prestodb/presto/commit/c5cbcee43f97009adb147ee0f064bb8f68f1ccf0", "committedDate": "2020-07-29T00:32:32Z", "message": "Remove unused functions in ExpressionUtils"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "af123bb01e1df463dfaf9ca51a6a0db027ed2a95", "author": {"user": {"login": "highker", "name": "James Sun"}}, "url": "https://github.com/prestodb/presto/commit/af123bb01e1df463dfaf9ca51a6a0db027ed2a95", "committedDate": "2020-07-28T18:38:49Z", "message": "Remove unused functions in ExpressionUtils"}, "afterCommit": {"oid": "c5cbcee43f97009adb147ee0f064bb8f68f1ccf0", "author": {"user": {"login": "highker", "name": "James Sun"}}, "url": "https://github.com/prestodb/presto/commit/c5cbcee43f97009adb147ee0f064bb8f68f1ccf0", "committedDate": "2020-07-29T00:32:32Z", "message": "Remove unused functions in ExpressionUtils"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MTU0Njk4", "url": "https://github.com/prestodb/presto/pull/14904#pullrequestreview-457154698", "createdAt": "2020-07-29T02:36:20Z", "commit": {"oid": "c5cbcee43f97009adb147ee0f064bb8f68f1ccf0"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwMjozNjoyMFrOG4manA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwMjozNjoyMFrOG4manA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAwMjg0NA==", "bodyText": "Ya, a clearer way of writing it might be to extract all variables of parent into a collection, and then call anyMatch(child.getCreatedVariable()::contains) once. But I don't have strong opinions.", "url": "https://github.com/prestodb/presto/pull/14904#discussion_r462002844", "createdAt": "2020-07-29T02:36:20Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/iterative/rule/GatherAndMergeWindows.java", "diffHunk": "@@ -176,10 +170,21 @@ public Result apply(WindowNode parent, Captures captures, Context context)\n         }\n     }\n \n-    private static Set<VariableReferenceExpression> extractUnique(Assignments assignments, TypeProvider types)\n+    private static Set<VariableReferenceExpression> extractUnique(Assignments assignments)\n     {\n         Collection<RowExpression> expressions = assignments.getExpressions();\n-        return VariablesExtractor.extractUnique(expressions.stream().map(OriginalExpressionUtils::castToExpression).collect(toImmutableList()), types);\n+        return VariablesExtractor.extractUnique(expressions);\n+    }\n+\n+    private static boolean dependsOn(WindowNode parent, WindowNode child)\n+    {\n+        return parent.getPartitionBy().stream().anyMatch(child.getCreatedVariable()::contains)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTkyMDA4Ng=="}, "originalCommit": {"oid": "8e86d968a5d8f054b205576572e44dd4edb0a9fd"}, "originalPosition": 70}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 336, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}