{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg2OTU2NDAy", "number": 15170, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwMDo1Njo0OFrOEjYNwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yMVQyMzowNTo0N1rOGNGefA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1NTMyMzU0OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/com/facebook/presto/operator/scalar/ArrayPositionWithIndexFunction.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwMDo1Njo0OFrOHRsnyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwMDo1NjozNVrOHT6U6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMxODkyMA==", "bodyText": "We had 5 separate implementations so we can avoid boxing primitive types and avoid invoke dynamic. So Let's keep the 5 separate implementations. Performance is more important in this case.", "url": "https://github.com/prestodb/presto/pull/15170#discussion_r488318920", "createdAt": "2020-09-15T00:56:48Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/scalar/ArrayPositionWithIndexFunction.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.operator.scalar;\n+\n+import com.facebook.presto.common.block.Block;\n+import com.facebook.presto.common.type.StandardTypes;\n+import com.facebook.presto.common.type.Type;\n+import com.facebook.presto.spi.PrestoException;\n+import com.facebook.presto.spi.function.Description;\n+import com.facebook.presto.spi.function.OperatorDependency;\n+import com.facebook.presto.spi.function.ScalarFunction;\n+import com.facebook.presto.spi.function.SqlType;\n+import com.facebook.presto.spi.function.TypeParameter;\n+import io.airlift.slice.Slice;\n+\n+import java.lang.invoke.MethodHandle;\n+\n+import static com.facebook.presto.common.function.OperatorType.EQUAL;\n+import static com.facebook.presto.spi.StandardErrorCode.INVALID_FUNCTION_ARGUMENT;\n+import static com.facebook.presto.spi.StandardErrorCode.NOT_SUPPORTED;\n+import static com.facebook.presto.util.Failures.internalError;\n+\n+@Description(\"Returns the position of the Nth occurrence of the given value in array (or 0 if not found)\")\n+@ScalarFunction(\"array_position\")\n+public class ArrayPositionWithIndexFunction\n+{\n+    protected ArrayPositionWithIndexFunction() {}\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") boolean element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        return arrayPositionWithIndexInternal(type::getBoolean, equalMethodHandle, array, element, instance);\n+    }\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") long element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        return arrayPositionWithIndexInternal(type::getLong, equalMethodHandle, array, element, instance);\n+    }\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") double element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        return arrayPositionWithIndexInternal(type::getDouble, equalMethodHandle, array, element, instance);\n+    }\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") Slice element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        return arrayPositionWithIndexInternal(type::getSlice, equalMethodHandle, array, element, instance);\n+    }\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") Block element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        return arrayPositionWithIndexInternal(type::getObject, equalMethodHandle, array, element, instance);\n+    }\n+\n+    protected static long arrayPositionWithIndexInternal(TypeValueExtractor extractor, MethodHandle equalMethodHandle, Block array, Object element, long instance)\n+    {\n+        int size = array.getPositionCount();\n+        int instancesFound = 0;\n+\n+        if (instance == 0) {\n+            throw new PrestoException(INVALID_FUNCTION_ARGUMENT, \"array_position cannot take a 0-valued instance argument.\");\n+        }\n+\n+        int startIndex = instance > 0 ? 0 : size - 1;\n+        int stopIndex = instance > 0 ? size : -1;\n+        int stepSize = instance > 0 ? 1 : -1;\n+        instance = Math.abs(instance);\n+\n+        for (int i = startIndex; i != stopIndex; i += stepSize) {\n+            if (!array.isNull(i)) {\n+                try {\n+                    Object arrayValue = extractor.extract(array, i);\n+                    Boolean result = (Boolean) equalMethodHandle.invoke(arrayValue, element);\n+                    checkNotIndeterminate(result);\n+                    if (result) {\n+                        instancesFound++;\n+                        if (instancesFound == instance) {\n+                            return i + 1; // result is 1-based (instead of 0)\n+                        }\n+                    }\n+                }\n+                catch (Throwable t) {\n+                    throw internalError(t);\n+                }\n+            }\n+        }\n+        return 0;\n+    }\n+\n+    protected interface TypeValueExtractor\n+    {\n+        Object extract(Block array, int index);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d479587c76950b1754d2e9a3a8cd68681fcfc53e"}, "originalPosition": 137}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMyMDM1Ng==", "bodyText": "Okay. I will split this to five implementations.", "url": "https://github.com/prestodb/presto/pull/15170#discussion_r488320356", "createdAt": "2020-09-15T01:01:53Z", "author": {"login": "ssaumitra"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/scalar/ArrayPositionWithIndexFunction.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.operator.scalar;\n+\n+import com.facebook.presto.common.block.Block;\n+import com.facebook.presto.common.type.StandardTypes;\n+import com.facebook.presto.common.type.Type;\n+import com.facebook.presto.spi.PrestoException;\n+import com.facebook.presto.spi.function.Description;\n+import com.facebook.presto.spi.function.OperatorDependency;\n+import com.facebook.presto.spi.function.ScalarFunction;\n+import com.facebook.presto.spi.function.SqlType;\n+import com.facebook.presto.spi.function.TypeParameter;\n+import io.airlift.slice.Slice;\n+\n+import java.lang.invoke.MethodHandle;\n+\n+import static com.facebook.presto.common.function.OperatorType.EQUAL;\n+import static com.facebook.presto.spi.StandardErrorCode.INVALID_FUNCTION_ARGUMENT;\n+import static com.facebook.presto.spi.StandardErrorCode.NOT_SUPPORTED;\n+import static com.facebook.presto.util.Failures.internalError;\n+\n+@Description(\"Returns the position of the Nth occurrence of the given value in array (or 0 if not found)\")\n+@ScalarFunction(\"array_position\")\n+public class ArrayPositionWithIndexFunction\n+{\n+    protected ArrayPositionWithIndexFunction() {}\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") boolean element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        return arrayPositionWithIndexInternal(type::getBoolean, equalMethodHandle, array, element, instance);\n+    }\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") long element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        return arrayPositionWithIndexInternal(type::getLong, equalMethodHandle, array, element, instance);\n+    }\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") double element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        return arrayPositionWithIndexInternal(type::getDouble, equalMethodHandle, array, element, instance);\n+    }\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") Slice element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        return arrayPositionWithIndexInternal(type::getSlice, equalMethodHandle, array, element, instance);\n+    }\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") Block element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        return arrayPositionWithIndexInternal(type::getObject, equalMethodHandle, array, element, instance);\n+    }\n+\n+    protected static long arrayPositionWithIndexInternal(TypeValueExtractor extractor, MethodHandle equalMethodHandle, Block array, Object element, long instance)\n+    {\n+        int size = array.getPositionCount();\n+        int instancesFound = 0;\n+\n+        if (instance == 0) {\n+            throw new PrestoException(INVALID_FUNCTION_ARGUMENT, \"array_position cannot take a 0-valued instance argument.\");\n+        }\n+\n+        int startIndex = instance > 0 ? 0 : size - 1;\n+        int stopIndex = instance > 0 ? size : -1;\n+        int stepSize = instance > 0 ? 1 : -1;\n+        instance = Math.abs(instance);\n+\n+        for (int i = startIndex; i != stopIndex; i += stepSize) {\n+            if (!array.isNull(i)) {\n+                try {\n+                    Object arrayValue = extractor.extract(array, i);\n+                    Boolean result = (Boolean) equalMethodHandle.invoke(arrayValue, element);\n+                    checkNotIndeterminate(result);\n+                    if (result) {\n+                        instancesFound++;\n+                        if (instancesFound == instance) {\n+                            return i + 1; // result is 1-based (instead of 0)\n+                        }\n+                    }\n+                }\n+                catch (Throwable t) {\n+                    throw internalError(t);\n+                }\n+            }\n+        }\n+        return 0;\n+    }\n+\n+    protected interface TypeValueExtractor\n+    {\n+        Object extract(Block array, int index);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMxODkyMA=="}, "originalCommit": {"oid": "d479587c76950b1754d2e9a3a8cd68681fcfc53e"}, "originalPosition": 137}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTUxMzM5MQ==", "bodyText": "I'm not entirely sure about the 5 specializations. Those micro benchmarks may be misleading.", "url": "https://github.com/prestodb/presto/pull/15170#discussion_r489513391", "createdAt": "2020-09-16T15:08:37Z", "author": {"login": "kaikalur"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/scalar/ArrayPositionWithIndexFunction.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.operator.scalar;\n+\n+import com.facebook.presto.common.block.Block;\n+import com.facebook.presto.common.type.StandardTypes;\n+import com.facebook.presto.common.type.Type;\n+import com.facebook.presto.spi.PrestoException;\n+import com.facebook.presto.spi.function.Description;\n+import com.facebook.presto.spi.function.OperatorDependency;\n+import com.facebook.presto.spi.function.ScalarFunction;\n+import com.facebook.presto.spi.function.SqlType;\n+import com.facebook.presto.spi.function.TypeParameter;\n+import io.airlift.slice.Slice;\n+\n+import java.lang.invoke.MethodHandle;\n+\n+import static com.facebook.presto.common.function.OperatorType.EQUAL;\n+import static com.facebook.presto.spi.StandardErrorCode.INVALID_FUNCTION_ARGUMENT;\n+import static com.facebook.presto.spi.StandardErrorCode.NOT_SUPPORTED;\n+import static com.facebook.presto.util.Failures.internalError;\n+\n+@Description(\"Returns the position of the Nth occurrence of the given value in array (or 0 if not found)\")\n+@ScalarFunction(\"array_position\")\n+public class ArrayPositionWithIndexFunction\n+{\n+    protected ArrayPositionWithIndexFunction() {}\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") boolean element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        return arrayPositionWithIndexInternal(type::getBoolean, equalMethodHandle, array, element, instance);\n+    }\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") long element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        return arrayPositionWithIndexInternal(type::getLong, equalMethodHandle, array, element, instance);\n+    }\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") double element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        return arrayPositionWithIndexInternal(type::getDouble, equalMethodHandle, array, element, instance);\n+    }\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") Slice element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        return arrayPositionWithIndexInternal(type::getSlice, equalMethodHandle, array, element, instance);\n+    }\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") Block element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        return arrayPositionWithIndexInternal(type::getObject, equalMethodHandle, array, element, instance);\n+    }\n+\n+    protected static long arrayPositionWithIndexInternal(TypeValueExtractor extractor, MethodHandle equalMethodHandle, Block array, Object element, long instance)\n+    {\n+        int size = array.getPositionCount();\n+        int instancesFound = 0;\n+\n+        if (instance == 0) {\n+            throw new PrestoException(INVALID_FUNCTION_ARGUMENT, \"array_position cannot take a 0-valued instance argument.\");\n+        }\n+\n+        int startIndex = instance > 0 ? 0 : size - 1;\n+        int stopIndex = instance > 0 ? size : -1;\n+        int stepSize = instance > 0 ? 1 : -1;\n+        instance = Math.abs(instance);\n+\n+        for (int i = startIndex; i != stopIndex; i += stepSize) {\n+            if (!array.isNull(i)) {\n+                try {\n+                    Object arrayValue = extractor.extract(array, i);\n+                    Boolean result = (Boolean) equalMethodHandle.invoke(arrayValue, element);\n+                    checkNotIndeterminate(result);\n+                    if (result) {\n+                        instancesFound++;\n+                        if (instancesFound == instance) {\n+                            return i + 1; // result is 1-based (instead of 0)\n+                        }\n+                    }\n+                }\n+                catch (Throwable t) {\n+                    throw internalError(t);\n+                }\n+            }\n+        }\n+        return 0;\n+    }\n+\n+    protected interface TypeValueExtractor\n+    {\n+        Object extract(Block array, int index);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMxODkyMA=="}, "originalCommit": {"oid": "d479587c76950b1754d2e9a3a8cd68681fcfc53e"}, "originalPosition": 137}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTczNzUxNQ==", "bodyText": "If there's doubt about the necessity we can reconsider this in a separate PR. Whether the performance is acceptable without specialization is not in scope of this PR.", "url": "https://github.com/prestodb/presto/pull/15170#discussion_r489737515", "createdAt": "2020-09-16T20:33:20Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/scalar/ArrayPositionWithIndexFunction.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.operator.scalar;\n+\n+import com.facebook.presto.common.block.Block;\n+import com.facebook.presto.common.type.StandardTypes;\n+import com.facebook.presto.common.type.Type;\n+import com.facebook.presto.spi.PrestoException;\n+import com.facebook.presto.spi.function.Description;\n+import com.facebook.presto.spi.function.OperatorDependency;\n+import com.facebook.presto.spi.function.ScalarFunction;\n+import com.facebook.presto.spi.function.SqlType;\n+import com.facebook.presto.spi.function.TypeParameter;\n+import io.airlift.slice.Slice;\n+\n+import java.lang.invoke.MethodHandle;\n+\n+import static com.facebook.presto.common.function.OperatorType.EQUAL;\n+import static com.facebook.presto.spi.StandardErrorCode.INVALID_FUNCTION_ARGUMENT;\n+import static com.facebook.presto.spi.StandardErrorCode.NOT_SUPPORTED;\n+import static com.facebook.presto.util.Failures.internalError;\n+\n+@Description(\"Returns the position of the Nth occurrence of the given value in array (or 0 if not found)\")\n+@ScalarFunction(\"array_position\")\n+public class ArrayPositionWithIndexFunction\n+{\n+    protected ArrayPositionWithIndexFunction() {}\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") boolean element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        return arrayPositionWithIndexInternal(type::getBoolean, equalMethodHandle, array, element, instance);\n+    }\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") long element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        return arrayPositionWithIndexInternal(type::getLong, equalMethodHandle, array, element, instance);\n+    }\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") double element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        return arrayPositionWithIndexInternal(type::getDouble, equalMethodHandle, array, element, instance);\n+    }\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") Slice element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        return arrayPositionWithIndexInternal(type::getSlice, equalMethodHandle, array, element, instance);\n+    }\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") Block element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        return arrayPositionWithIndexInternal(type::getObject, equalMethodHandle, array, element, instance);\n+    }\n+\n+    protected static long arrayPositionWithIndexInternal(TypeValueExtractor extractor, MethodHandle equalMethodHandle, Block array, Object element, long instance)\n+    {\n+        int size = array.getPositionCount();\n+        int instancesFound = 0;\n+\n+        if (instance == 0) {\n+            throw new PrestoException(INVALID_FUNCTION_ARGUMENT, \"array_position cannot take a 0-valued instance argument.\");\n+        }\n+\n+        int startIndex = instance > 0 ? 0 : size - 1;\n+        int stopIndex = instance > 0 ? size : -1;\n+        int stepSize = instance > 0 ? 1 : -1;\n+        instance = Math.abs(instance);\n+\n+        for (int i = startIndex; i != stopIndex; i += stepSize) {\n+            if (!array.isNull(i)) {\n+                try {\n+                    Object arrayValue = extractor.extract(array, i);\n+                    Boolean result = (Boolean) equalMethodHandle.invoke(arrayValue, element);\n+                    checkNotIndeterminate(result);\n+                    if (result) {\n+                        instancesFound++;\n+                        if (instancesFound == instance) {\n+                            return i + 1; // result is 1-based (instead of 0)\n+                        }\n+                    }\n+                }\n+                catch (Throwable t) {\n+                    throw internalError(t);\n+                }\n+            }\n+        }\n+        return 0;\n+    }\n+\n+    protected interface TypeValueExtractor\n+    {\n+        Object extract(Block array, int index);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMxODkyMA=="}, "originalCommit": {"oid": "d479587c76950b1754d2e9a3a8cd68681fcfc53e"}, "originalPosition": 137}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY0MDYxOA==", "bodyText": "@rongrong Okay. I have now kept five implementations.", "url": "https://github.com/prestodb/presto/pull/15170#discussion_r490640618", "createdAt": "2020-09-18T00:56:35Z", "author": {"login": "ssaumitra"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/scalar/ArrayPositionWithIndexFunction.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.operator.scalar;\n+\n+import com.facebook.presto.common.block.Block;\n+import com.facebook.presto.common.type.StandardTypes;\n+import com.facebook.presto.common.type.Type;\n+import com.facebook.presto.spi.PrestoException;\n+import com.facebook.presto.spi.function.Description;\n+import com.facebook.presto.spi.function.OperatorDependency;\n+import com.facebook.presto.spi.function.ScalarFunction;\n+import com.facebook.presto.spi.function.SqlType;\n+import com.facebook.presto.spi.function.TypeParameter;\n+import io.airlift.slice.Slice;\n+\n+import java.lang.invoke.MethodHandle;\n+\n+import static com.facebook.presto.common.function.OperatorType.EQUAL;\n+import static com.facebook.presto.spi.StandardErrorCode.INVALID_FUNCTION_ARGUMENT;\n+import static com.facebook.presto.spi.StandardErrorCode.NOT_SUPPORTED;\n+import static com.facebook.presto.util.Failures.internalError;\n+\n+@Description(\"Returns the position of the Nth occurrence of the given value in array (or 0 if not found)\")\n+@ScalarFunction(\"array_position\")\n+public class ArrayPositionWithIndexFunction\n+{\n+    protected ArrayPositionWithIndexFunction() {}\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") boolean element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        return arrayPositionWithIndexInternal(type::getBoolean, equalMethodHandle, array, element, instance);\n+    }\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") long element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        return arrayPositionWithIndexInternal(type::getLong, equalMethodHandle, array, element, instance);\n+    }\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") double element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        return arrayPositionWithIndexInternal(type::getDouble, equalMethodHandle, array, element, instance);\n+    }\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") Slice element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        return arrayPositionWithIndexInternal(type::getSlice, equalMethodHandle, array, element, instance);\n+    }\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") Block element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        return arrayPositionWithIndexInternal(type::getObject, equalMethodHandle, array, element, instance);\n+    }\n+\n+    protected static long arrayPositionWithIndexInternal(TypeValueExtractor extractor, MethodHandle equalMethodHandle, Block array, Object element, long instance)\n+    {\n+        int size = array.getPositionCount();\n+        int instancesFound = 0;\n+\n+        if (instance == 0) {\n+            throw new PrestoException(INVALID_FUNCTION_ARGUMENT, \"array_position cannot take a 0-valued instance argument.\");\n+        }\n+\n+        int startIndex = instance > 0 ? 0 : size - 1;\n+        int stopIndex = instance > 0 ? size : -1;\n+        int stepSize = instance > 0 ? 1 : -1;\n+        instance = Math.abs(instance);\n+\n+        for (int i = startIndex; i != stopIndex; i += stepSize) {\n+            if (!array.isNull(i)) {\n+                try {\n+                    Object arrayValue = extractor.extract(array, i);\n+                    Boolean result = (Boolean) equalMethodHandle.invoke(arrayValue, element);\n+                    checkNotIndeterminate(result);\n+                    if (result) {\n+                        instancesFound++;\n+                        if (instancesFound == instance) {\n+                            return i + 1; // result is 1-based (instead of 0)\n+                        }\n+                    }\n+                }\n+                catch (Throwable t) {\n+                    throw internalError(t);\n+                }\n+            }\n+        }\n+        return 0;\n+    }\n+\n+    protected interface TypeValueExtractor\n+    {\n+        Object extract(Block array, int index);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMxODkyMA=="}, "originalCommit": {"oid": "d479587c76950b1754d2e9a3a8cd68681fcfc53e"}, "originalPosition": 137}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1NTMyNDU3OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/com/facebook/presto/operator/scalar/ArrayPositionWithIndexFunction.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwMDo1NzoyM1rOHRsoYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwMDo1ODoyMFrOHT6WYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMxOTA3NA==", "bodyText": "Do we need to have 2 separate classes? Can we put all functions in one? Just curious.", "url": "https://github.com/prestodb/presto/pull/15170#discussion_r488319074", "createdAt": "2020-09-15T00:57:23Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/scalar/ArrayPositionWithIndexFunction.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.operator.scalar;\n+\n+import com.facebook.presto.common.block.Block;\n+import com.facebook.presto.common.type.StandardTypes;\n+import com.facebook.presto.common.type.Type;\n+import com.facebook.presto.spi.PrestoException;\n+import com.facebook.presto.spi.function.Description;\n+import com.facebook.presto.spi.function.OperatorDependency;\n+import com.facebook.presto.spi.function.ScalarFunction;\n+import com.facebook.presto.spi.function.SqlType;\n+import com.facebook.presto.spi.function.TypeParameter;\n+import io.airlift.slice.Slice;\n+\n+import java.lang.invoke.MethodHandle;\n+\n+import static com.facebook.presto.common.function.OperatorType.EQUAL;\n+import static com.facebook.presto.spi.StandardErrorCode.INVALID_FUNCTION_ARGUMENT;\n+import static com.facebook.presto.spi.StandardErrorCode.NOT_SUPPORTED;\n+import static com.facebook.presto.util.Failures.internalError;\n+\n+@Description(\"Returns the position of the Nth occurrence of the given value in array (or 0 if not found)\")\n+@ScalarFunction(\"array_position\")\n+public class ArrayPositionWithIndexFunction", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d479587c76950b1754d2e9a3a8cd68681fcfc53e"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMyMTc3NA==", "bodyText": "I tried this earlier. FunctionsParserHelper.validateSignaturesCompatibility mandates signatures of functions from one class to be the same. That's why I split it.", "url": "https://github.com/prestodb/presto/pull/15170#discussion_r488321774", "createdAt": "2020-09-15T01:06:50Z", "author": {"login": "ssaumitra"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/scalar/ArrayPositionWithIndexFunction.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.operator.scalar;\n+\n+import com.facebook.presto.common.block.Block;\n+import com.facebook.presto.common.type.StandardTypes;\n+import com.facebook.presto.common.type.Type;\n+import com.facebook.presto.spi.PrestoException;\n+import com.facebook.presto.spi.function.Description;\n+import com.facebook.presto.spi.function.OperatorDependency;\n+import com.facebook.presto.spi.function.ScalarFunction;\n+import com.facebook.presto.spi.function.SqlType;\n+import com.facebook.presto.spi.function.TypeParameter;\n+import io.airlift.slice.Slice;\n+\n+import java.lang.invoke.MethodHandle;\n+\n+import static com.facebook.presto.common.function.OperatorType.EQUAL;\n+import static com.facebook.presto.spi.StandardErrorCode.INVALID_FUNCTION_ARGUMENT;\n+import static com.facebook.presto.spi.StandardErrorCode.NOT_SUPPORTED;\n+import static com.facebook.presto.util.Failures.internalError;\n+\n+@Description(\"Returns the position of the Nth occurrence of the given value in array (or 0 if not found)\")\n+@ScalarFunction(\"array_position\")\n+public class ArrayPositionWithIndexFunction", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMxOTA3NA=="}, "originalCommit": {"oid": "d479587c76950b1754d2e9a3a8cd68681fcfc53e"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMyMjIwNw==", "bodyText": "Hmm, ok, try move the @ScalarFunction annotation to each implementation maybe. But that doesn't look ideal either. Don't have strong opinions here. Thanks!", "url": "https://github.com/prestodb/presto/pull/15170#discussion_r488322207", "createdAt": "2020-09-15T01:08:28Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/scalar/ArrayPositionWithIndexFunction.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.operator.scalar;\n+\n+import com.facebook.presto.common.block.Block;\n+import com.facebook.presto.common.type.StandardTypes;\n+import com.facebook.presto.common.type.Type;\n+import com.facebook.presto.spi.PrestoException;\n+import com.facebook.presto.spi.function.Description;\n+import com.facebook.presto.spi.function.OperatorDependency;\n+import com.facebook.presto.spi.function.ScalarFunction;\n+import com.facebook.presto.spi.function.SqlType;\n+import com.facebook.presto.spi.function.TypeParameter;\n+import io.airlift.slice.Slice;\n+\n+import java.lang.invoke.MethodHandle;\n+\n+import static com.facebook.presto.common.function.OperatorType.EQUAL;\n+import static com.facebook.presto.spi.StandardErrorCode.INVALID_FUNCTION_ARGUMENT;\n+import static com.facebook.presto.spi.StandardErrorCode.NOT_SUPPORTED;\n+import static com.facebook.presto.util.Failures.internalError;\n+\n+@Description(\"Returns the position of the Nth occurrence of the given value in array (or 0 if not found)\")\n+@ScalarFunction(\"array_position\")\n+public class ArrayPositionWithIndexFunction", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMxOTA3NA=="}, "originalCommit": {"oid": "d479587c76950b1754d2e9a3a8cd68681fcfc53e"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTUxNTYzNQ==", "bodyText": "A better way would be to write a helper class and make both these classes call that one?", "url": "https://github.com/prestodb/presto/pull/15170#discussion_r489515635", "createdAt": "2020-09-16T15:11:37Z", "author": {"login": "kaikalur"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/scalar/ArrayPositionWithIndexFunction.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.operator.scalar;\n+\n+import com.facebook.presto.common.block.Block;\n+import com.facebook.presto.common.type.StandardTypes;\n+import com.facebook.presto.common.type.Type;\n+import com.facebook.presto.spi.PrestoException;\n+import com.facebook.presto.spi.function.Description;\n+import com.facebook.presto.spi.function.OperatorDependency;\n+import com.facebook.presto.spi.function.ScalarFunction;\n+import com.facebook.presto.spi.function.SqlType;\n+import com.facebook.presto.spi.function.TypeParameter;\n+import io.airlift.slice.Slice;\n+\n+import java.lang.invoke.MethodHandle;\n+\n+import static com.facebook.presto.common.function.OperatorType.EQUAL;\n+import static com.facebook.presto.spi.StandardErrorCode.INVALID_FUNCTION_ARGUMENT;\n+import static com.facebook.presto.spi.StandardErrorCode.NOT_SUPPORTED;\n+import static com.facebook.presto.util.Failures.internalError;\n+\n+@Description(\"Returns the position of the Nth occurrence of the given value in array (or 0 if not found)\")\n+@ScalarFunction(\"array_position\")\n+public class ArrayPositionWithIndexFunction", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMxOTA3NA=="}, "originalCommit": {"oid": "d479587c76950b1754d2e9a3a8cd68681fcfc53e"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY0MDk5NA==", "bodyText": "@rongrong I tried moving @ScalarFunction but that unfortunately did not help. Therefore keeping two classes.\n@kaikalur I am making only one of them as a source of truth and second just have one-liner function calls. This will hopefully keep it manageable.", "url": "https://github.com/prestodb/presto/pull/15170#discussion_r490640994", "createdAt": "2020-09-18T00:58:20Z", "author": {"login": "ssaumitra"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/scalar/ArrayPositionWithIndexFunction.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.operator.scalar;\n+\n+import com.facebook.presto.common.block.Block;\n+import com.facebook.presto.common.type.StandardTypes;\n+import com.facebook.presto.common.type.Type;\n+import com.facebook.presto.spi.PrestoException;\n+import com.facebook.presto.spi.function.Description;\n+import com.facebook.presto.spi.function.OperatorDependency;\n+import com.facebook.presto.spi.function.ScalarFunction;\n+import com.facebook.presto.spi.function.SqlType;\n+import com.facebook.presto.spi.function.TypeParameter;\n+import io.airlift.slice.Slice;\n+\n+import java.lang.invoke.MethodHandle;\n+\n+import static com.facebook.presto.common.function.OperatorType.EQUAL;\n+import static com.facebook.presto.spi.StandardErrorCode.INVALID_FUNCTION_ARGUMENT;\n+import static com.facebook.presto.spi.StandardErrorCode.NOT_SUPPORTED;\n+import static com.facebook.presto.util.Failures.internalError;\n+\n+@Description(\"Returns the position of the Nth occurrence of the given value in array (or 0 if not found)\")\n+@ScalarFunction(\"array_position\")\n+public class ArrayPositionWithIndexFunction", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMxOTA3NA=="}, "originalCommit": {"oid": "d479587c76950b1754d2e9a3a8cd68681fcfc53e"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2MjkwODE2OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/com/facebook/presto/operator/scalar/ArrayPositionWithIndexFunction.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxNToxMDoxN1rOHS1mpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0xOFQxMDoyMjowN1rOJwAdTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTUxNDY2MQ==", "bodyText": "Hmm - I think we can just return null. Consider this a short hand for an OR which will return null in that situation.", "url": "https://github.com/prestodb/presto/pull/15170#discussion_r489514661", "createdAt": "2020-09-16T15:10:17Z", "author": {"login": "kaikalur"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/scalar/ArrayPositionWithIndexFunction.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.operator.scalar;\n+\n+import com.facebook.presto.common.block.Block;\n+import com.facebook.presto.common.type.StandardTypes;\n+import com.facebook.presto.common.type.Type;\n+import com.facebook.presto.spi.PrestoException;\n+import com.facebook.presto.spi.function.Description;\n+import com.facebook.presto.spi.function.OperatorDependency;\n+import com.facebook.presto.spi.function.ScalarFunction;\n+import com.facebook.presto.spi.function.SqlType;\n+import com.facebook.presto.spi.function.TypeParameter;\n+import io.airlift.slice.Slice;\n+\n+import java.lang.invoke.MethodHandle;\n+\n+import static com.facebook.presto.common.function.OperatorType.EQUAL;\n+import static com.facebook.presto.spi.StandardErrorCode.INVALID_FUNCTION_ARGUMENT;\n+import static com.facebook.presto.spi.StandardErrorCode.NOT_SUPPORTED;\n+import static com.facebook.presto.util.Failures.internalError;\n+\n+@Description(\"Returns the position of the Nth occurrence of the given value in array (or 0 if not found)\")\n+@ScalarFunction(\"array_position\")\n+public class ArrayPositionWithIndexFunction\n+{\n+    protected ArrayPositionWithIndexFunction() {}\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") boolean element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        return arrayPositionWithIndexInternal(type::getBoolean, equalMethodHandle, array, element, instance);\n+    }\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") long element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        return arrayPositionWithIndexInternal(type::getLong, equalMethodHandle, array, element, instance);\n+    }\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") double element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        return arrayPositionWithIndexInternal(type::getDouble, equalMethodHandle, array, element, instance);\n+    }\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") Slice element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        return arrayPositionWithIndexInternal(type::getSlice, equalMethodHandle, array, element, instance);\n+    }\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") Block element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        return arrayPositionWithIndexInternal(type::getObject, equalMethodHandle, array, element, instance);\n+    }\n+\n+    protected static long arrayPositionWithIndexInternal(TypeValueExtractor extractor, MethodHandle equalMethodHandle, Block array, Object element, long instance)\n+    {\n+        int size = array.getPositionCount();\n+        int instancesFound = 0;\n+\n+        if (instance == 0) {\n+            throw new PrestoException(INVALID_FUNCTION_ARGUMENT, \"array_position cannot take a 0-valued instance argument.\");\n+        }\n+\n+        int startIndex = instance > 0 ? 0 : size - 1;\n+        int stopIndex = instance > 0 ? size : -1;\n+        int stepSize = instance > 0 ? 1 : -1;\n+        instance = Math.abs(instance);\n+\n+        for (int i = startIndex; i != stopIndex; i += stepSize) {\n+            if (!array.isNull(i)) {\n+                try {\n+                    Object arrayValue = extractor.extract(array, i);\n+                    Boolean result = (Boolean) equalMethodHandle.invoke(arrayValue, element);\n+                    checkNotIndeterminate(result);\n+                    if (result) {\n+                        instancesFound++;\n+                        if (instancesFound == instance) {\n+                            return i + 1; // result is 1-based (instead of 0)\n+                        }\n+                    }\n+                }\n+                catch (Throwable t) {\n+                    throw internalError(t);\n+                }\n+            }\n+        }\n+        return 0;\n+    }\n+\n+    protected interface TypeValueExtractor\n+    {\n+        Object extract(Block array, int index);\n+    }\n+\n+    private static void checkNotIndeterminate(Boolean equalsResult)\n+    {\n+        if (equalsResult == null) {\n+            throw new PrestoException(NOT_SUPPORTED, \"array_position does not support arrays with elements that are null or contain null\");\n+        }\n+    }\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d479587c76950b1754d2e9a3a8cd68681fcfc53e"}, "originalPosition": 146}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTczNzAzMg==", "bodyText": "Let's discuss changing function behavior separately from extending function APIs. What the function should do when array contains null is not in scope of this PR.", "url": "https://github.com/prestodb/presto/pull/15170#discussion_r489737032", "createdAt": "2020-09-16T20:32:23Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/scalar/ArrayPositionWithIndexFunction.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.operator.scalar;\n+\n+import com.facebook.presto.common.block.Block;\n+import com.facebook.presto.common.type.StandardTypes;\n+import com.facebook.presto.common.type.Type;\n+import com.facebook.presto.spi.PrestoException;\n+import com.facebook.presto.spi.function.Description;\n+import com.facebook.presto.spi.function.OperatorDependency;\n+import com.facebook.presto.spi.function.ScalarFunction;\n+import com.facebook.presto.spi.function.SqlType;\n+import com.facebook.presto.spi.function.TypeParameter;\n+import io.airlift.slice.Slice;\n+\n+import java.lang.invoke.MethodHandle;\n+\n+import static com.facebook.presto.common.function.OperatorType.EQUAL;\n+import static com.facebook.presto.spi.StandardErrorCode.INVALID_FUNCTION_ARGUMENT;\n+import static com.facebook.presto.spi.StandardErrorCode.NOT_SUPPORTED;\n+import static com.facebook.presto.util.Failures.internalError;\n+\n+@Description(\"Returns the position of the Nth occurrence of the given value in array (or 0 if not found)\")\n+@ScalarFunction(\"array_position\")\n+public class ArrayPositionWithIndexFunction\n+{\n+    protected ArrayPositionWithIndexFunction() {}\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") boolean element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        return arrayPositionWithIndexInternal(type::getBoolean, equalMethodHandle, array, element, instance);\n+    }\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") long element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        return arrayPositionWithIndexInternal(type::getLong, equalMethodHandle, array, element, instance);\n+    }\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") double element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        return arrayPositionWithIndexInternal(type::getDouble, equalMethodHandle, array, element, instance);\n+    }\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") Slice element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        return arrayPositionWithIndexInternal(type::getSlice, equalMethodHandle, array, element, instance);\n+    }\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") Block element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        return arrayPositionWithIndexInternal(type::getObject, equalMethodHandle, array, element, instance);\n+    }\n+\n+    protected static long arrayPositionWithIndexInternal(TypeValueExtractor extractor, MethodHandle equalMethodHandle, Block array, Object element, long instance)\n+    {\n+        int size = array.getPositionCount();\n+        int instancesFound = 0;\n+\n+        if (instance == 0) {\n+            throw new PrestoException(INVALID_FUNCTION_ARGUMENT, \"array_position cannot take a 0-valued instance argument.\");\n+        }\n+\n+        int startIndex = instance > 0 ? 0 : size - 1;\n+        int stopIndex = instance > 0 ? size : -1;\n+        int stepSize = instance > 0 ? 1 : -1;\n+        instance = Math.abs(instance);\n+\n+        for (int i = startIndex; i != stopIndex; i += stepSize) {\n+            if (!array.isNull(i)) {\n+                try {\n+                    Object arrayValue = extractor.extract(array, i);\n+                    Boolean result = (Boolean) equalMethodHandle.invoke(arrayValue, element);\n+                    checkNotIndeterminate(result);\n+                    if (result) {\n+                        instancesFound++;\n+                        if (instancesFound == instance) {\n+                            return i + 1; // result is 1-based (instead of 0)\n+                        }\n+                    }\n+                }\n+                catch (Throwable t) {\n+                    throw internalError(t);\n+                }\n+            }\n+        }\n+        return 0;\n+    }\n+\n+    protected interface TypeValueExtractor\n+    {\n+        Object extract(Block array, int index);\n+    }\n+\n+    private static void checkNotIndeterminate(Boolean equalsResult)\n+    {\n+        if (equalsResult == null) {\n+            throw new PrestoException(NOT_SUPPORTED, \"array_position does not support arrays with elements that are null or contain null\");\n+        }\n+    }\n+}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTUxNDY2MQ=="}, "originalCommit": {"oid": "d479587c76950b1754d2e9a3a8cd68681fcfc53e"}, "originalPosition": 146}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY0MTEyOA==", "bodyText": "Okay. Kept as-is for now.", "url": "https://github.com/prestodb/presto/pull/15170#discussion_r490641128", "createdAt": "2020-09-18T00:58:54Z", "author": {"login": "ssaumitra"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/scalar/ArrayPositionWithIndexFunction.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.operator.scalar;\n+\n+import com.facebook.presto.common.block.Block;\n+import com.facebook.presto.common.type.StandardTypes;\n+import com.facebook.presto.common.type.Type;\n+import com.facebook.presto.spi.PrestoException;\n+import com.facebook.presto.spi.function.Description;\n+import com.facebook.presto.spi.function.OperatorDependency;\n+import com.facebook.presto.spi.function.ScalarFunction;\n+import com.facebook.presto.spi.function.SqlType;\n+import com.facebook.presto.spi.function.TypeParameter;\n+import io.airlift.slice.Slice;\n+\n+import java.lang.invoke.MethodHandle;\n+\n+import static com.facebook.presto.common.function.OperatorType.EQUAL;\n+import static com.facebook.presto.spi.StandardErrorCode.INVALID_FUNCTION_ARGUMENT;\n+import static com.facebook.presto.spi.StandardErrorCode.NOT_SUPPORTED;\n+import static com.facebook.presto.util.Failures.internalError;\n+\n+@Description(\"Returns the position of the Nth occurrence of the given value in array (or 0 if not found)\")\n+@ScalarFunction(\"array_position\")\n+public class ArrayPositionWithIndexFunction\n+{\n+    protected ArrayPositionWithIndexFunction() {}\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") boolean element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        return arrayPositionWithIndexInternal(type::getBoolean, equalMethodHandle, array, element, instance);\n+    }\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") long element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        return arrayPositionWithIndexInternal(type::getLong, equalMethodHandle, array, element, instance);\n+    }\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") double element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        return arrayPositionWithIndexInternal(type::getDouble, equalMethodHandle, array, element, instance);\n+    }\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") Slice element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        return arrayPositionWithIndexInternal(type::getSlice, equalMethodHandle, array, element, instance);\n+    }\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") Block element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        return arrayPositionWithIndexInternal(type::getObject, equalMethodHandle, array, element, instance);\n+    }\n+\n+    protected static long arrayPositionWithIndexInternal(TypeValueExtractor extractor, MethodHandle equalMethodHandle, Block array, Object element, long instance)\n+    {\n+        int size = array.getPositionCount();\n+        int instancesFound = 0;\n+\n+        if (instance == 0) {\n+            throw new PrestoException(INVALID_FUNCTION_ARGUMENT, \"array_position cannot take a 0-valued instance argument.\");\n+        }\n+\n+        int startIndex = instance > 0 ? 0 : size - 1;\n+        int stopIndex = instance > 0 ? size : -1;\n+        int stepSize = instance > 0 ? 1 : -1;\n+        instance = Math.abs(instance);\n+\n+        for (int i = startIndex; i != stopIndex; i += stepSize) {\n+            if (!array.isNull(i)) {\n+                try {\n+                    Object arrayValue = extractor.extract(array, i);\n+                    Boolean result = (Boolean) equalMethodHandle.invoke(arrayValue, element);\n+                    checkNotIndeterminate(result);\n+                    if (result) {\n+                        instancesFound++;\n+                        if (instancesFound == instance) {\n+                            return i + 1; // result is 1-based (instead of 0)\n+                        }\n+                    }\n+                }\n+                catch (Throwable t) {\n+                    throw internalError(t);\n+                }\n+            }\n+        }\n+        return 0;\n+    }\n+\n+    protected interface TypeValueExtractor\n+    {\n+        Object extract(Block array, int index);\n+    }\n+\n+    private static void checkNotIndeterminate(Boolean equalsResult)\n+    {\n+        if (equalsResult == null) {\n+            throw new PrestoException(NOT_SUPPORTED, \"array_position does not support arrays with elements that are null or contain null\");\n+        }\n+    }\n+}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTUxNDY2MQ=="}, "originalCommit": {"oid": "d479587c76950b1754d2e9a3a8cd68681fcfc53e"}, "originalPosition": 146}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MDU4MTI5Mw==", "bodyText": "@rongrong / @kaikalur Are any further changes required on this?\nI have just rebased this diff on the latest master. Build failures look transient maven failures, so force-pushing and re-triggering the build.", "url": "https://github.com/prestodb/presto/pull/15170#discussion_r650581293", "createdAt": "2021-06-13T21:43:21Z", "author": {"login": "ssaumitra"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/scalar/ArrayPositionWithIndexFunction.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.operator.scalar;\n+\n+import com.facebook.presto.common.block.Block;\n+import com.facebook.presto.common.type.StandardTypes;\n+import com.facebook.presto.common.type.Type;\n+import com.facebook.presto.spi.PrestoException;\n+import com.facebook.presto.spi.function.Description;\n+import com.facebook.presto.spi.function.OperatorDependency;\n+import com.facebook.presto.spi.function.ScalarFunction;\n+import com.facebook.presto.spi.function.SqlType;\n+import com.facebook.presto.spi.function.TypeParameter;\n+import io.airlift.slice.Slice;\n+\n+import java.lang.invoke.MethodHandle;\n+\n+import static com.facebook.presto.common.function.OperatorType.EQUAL;\n+import static com.facebook.presto.spi.StandardErrorCode.INVALID_FUNCTION_ARGUMENT;\n+import static com.facebook.presto.spi.StandardErrorCode.NOT_SUPPORTED;\n+import static com.facebook.presto.util.Failures.internalError;\n+\n+@Description(\"Returns the position of the Nth occurrence of the given value in array (or 0 if not found)\")\n+@ScalarFunction(\"array_position\")\n+public class ArrayPositionWithIndexFunction\n+{\n+    protected ArrayPositionWithIndexFunction() {}\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") boolean element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        return arrayPositionWithIndexInternal(type::getBoolean, equalMethodHandle, array, element, instance);\n+    }\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") long element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        return arrayPositionWithIndexInternal(type::getLong, equalMethodHandle, array, element, instance);\n+    }\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") double element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        return arrayPositionWithIndexInternal(type::getDouble, equalMethodHandle, array, element, instance);\n+    }\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") Slice element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        return arrayPositionWithIndexInternal(type::getSlice, equalMethodHandle, array, element, instance);\n+    }\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") Block element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        return arrayPositionWithIndexInternal(type::getObject, equalMethodHandle, array, element, instance);\n+    }\n+\n+    protected static long arrayPositionWithIndexInternal(TypeValueExtractor extractor, MethodHandle equalMethodHandle, Block array, Object element, long instance)\n+    {\n+        int size = array.getPositionCount();\n+        int instancesFound = 0;\n+\n+        if (instance == 0) {\n+            throw new PrestoException(INVALID_FUNCTION_ARGUMENT, \"array_position cannot take a 0-valued instance argument.\");\n+        }\n+\n+        int startIndex = instance > 0 ? 0 : size - 1;\n+        int stopIndex = instance > 0 ? size : -1;\n+        int stepSize = instance > 0 ? 1 : -1;\n+        instance = Math.abs(instance);\n+\n+        for (int i = startIndex; i != stopIndex; i += stepSize) {\n+            if (!array.isNull(i)) {\n+                try {\n+                    Object arrayValue = extractor.extract(array, i);\n+                    Boolean result = (Boolean) equalMethodHandle.invoke(arrayValue, element);\n+                    checkNotIndeterminate(result);\n+                    if (result) {\n+                        instancesFound++;\n+                        if (instancesFound == instance) {\n+                            return i + 1; // result is 1-based (instead of 0)\n+                        }\n+                    }\n+                }\n+                catch (Throwable t) {\n+                    throw internalError(t);\n+                }\n+            }\n+        }\n+        return 0;\n+    }\n+\n+    protected interface TypeValueExtractor\n+    {\n+        Object extract(Block array, int index);\n+    }\n+\n+    private static void checkNotIndeterminate(Boolean equalsResult)\n+    {\n+        if (equalsResult == null) {\n+            throw new PrestoException(NOT_SUPPORTED, \"array_position does not support arrays with elements that are null or contain null\");\n+        }\n+    }\n+}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTUxNDY2MQ=="}, "originalCommit": {"oid": "d479587c76950b1754d2e9a3a8cd68681fcfc53e"}, "originalPosition": 146}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NDMxODkyNw==", "bodyText": "@rongrong / @kaikalur Gentle reminder. Is any further change required on this?", "url": "https://github.com/prestodb/presto/pull/15170#discussion_r654318927", "createdAt": "2021-06-18T10:22:07Z", "author": {"login": "ssaumitra"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/scalar/ArrayPositionWithIndexFunction.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.operator.scalar;\n+\n+import com.facebook.presto.common.block.Block;\n+import com.facebook.presto.common.type.StandardTypes;\n+import com.facebook.presto.common.type.Type;\n+import com.facebook.presto.spi.PrestoException;\n+import com.facebook.presto.spi.function.Description;\n+import com.facebook.presto.spi.function.OperatorDependency;\n+import com.facebook.presto.spi.function.ScalarFunction;\n+import com.facebook.presto.spi.function.SqlType;\n+import com.facebook.presto.spi.function.TypeParameter;\n+import io.airlift.slice.Slice;\n+\n+import java.lang.invoke.MethodHandle;\n+\n+import static com.facebook.presto.common.function.OperatorType.EQUAL;\n+import static com.facebook.presto.spi.StandardErrorCode.INVALID_FUNCTION_ARGUMENT;\n+import static com.facebook.presto.spi.StandardErrorCode.NOT_SUPPORTED;\n+import static com.facebook.presto.util.Failures.internalError;\n+\n+@Description(\"Returns the position of the Nth occurrence of the given value in array (or 0 if not found)\")\n+@ScalarFunction(\"array_position\")\n+public class ArrayPositionWithIndexFunction\n+{\n+    protected ArrayPositionWithIndexFunction() {}\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") boolean element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        return arrayPositionWithIndexInternal(type::getBoolean, equalMethodHandle, array, element, instance);\n+    }\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") long element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        return arrayPositionWithIndexInternal(type::getLong, equalMethodHandle, array, element, instance);\n+    }\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") double element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        return arrayPositionWithIndexInternal(type::getDouble, equalMethodHandle, array, element, instance);\n+    }\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") Slice element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        return arrayPositionWithIndexInternal(type::getSlice, equalMethodHandle, array, element, instance);\n+    }\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") Block element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        return arrayPositionWithIndexInternal(type::getObject, equalMethodHandle, array, element, instance);\n+    }\n+\n+    protected static long arrayPositionWithIndexInternal(TypeValueExtractor extractor, MethodHandle equalMethodHandle, Block array, Object element, long instance)\n+    {\n+        int size = array.getPositionCount();\n+        int instancesFound = 0;\n+\n+        if (instance == 0) {\n+            throw new PrestoException(INVALID_FUNCTION_ARGUMENT, \"array_position cannot take a 0-valued instance argument.\");\n+        }\n+\n+        int startIndex = instance > 0 ? 0 : size - 1;\n+        int stopIndex = instance > 0 ? size : -1;\n+        int stepSize = instance > 0 ? 1 : -1;\n+        instance = Math.abs(instance);\n+\n+        for (int i = startIndex; i != stopIndex; i += stepSize) {\n+            if (!array.isNull(i)) {\n+                try {\n+                    Object arrayValue = extractor.extract(array, i);\n+                    Boolean result = (Boolean) equalMethodHandle.invoke(arrayValue, element);\n+                    checkNotIndeterminate(result);\n+                    if (result) {\n+                        instancesFound++;\n+                        if (instancesFound == instance) {\n+                            return i + 1; // result is 1-based (instead of 0)\n+                        }\n+                    }\n+                }\n+                catch (Throwable t) {\n+                    throw internalError(t);\n+                }\n+            }\n+        }\n+        return 0;\n+    }\n+\n+    protected interface TypeValueExtractor\n+    {\n+        Object extract(Block array, int index);\n+    }\n+\n+    private static void checkNotIndeterminate(Boolean equalsResult)\n+    {\n+        if (equalsResult == null) {\n+            throw new PrestoException(NOT_SUPPORTED, \"array_position does not support arrays with elements that are null or contain null\");\n+        }\n+    }\n+}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTUxNDY2MQ=="}, "originalCommit": {"oid": "d479587c76950b1754d2e9a3a8cd68681fcfc53e"}, "originalPosition": 146}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkNDE2MzkwNzgwOnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/com/facebook/presto/operator/scalar/ArrayPositionWithIndexFunction.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yMVQyMzowNTo0N1rOJxYXaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yMVQyMzozNzo0OFrOJxZNSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NTc1OTIwOQ==", "bodyText": "Maybe just change the error message to something like 0 is an invalid instance number for array_position or something more obviously stating that 0 is invalid. \"cannot take\" sounds like \"not supported\", but I think here we actually mean it's not valid.", "url": "https://github.com/prestodb/presto/pull/15170#discussion_r655759209", "createdAt": "2021-06-21T23:05:47Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/scalar/ArrayPositionWithIndexFunction.java", "diffHunk": "@@ -0,0 +1,256 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.operator.scalar;\n+\n+import com.facebook.presto.common.block.Block;\n+import com.facebook.presto.common.type.StandardTypes;\n+import com.facebook.presto.common.type.Type;\n+import com.facebook.presto.spi.PrestoException;\n+import com.facebook.presto.spi.function.Description;\n+import com.facebook.presto.spi.function.OperatorDependency;\n+import com.facebook.presto.spi.function.ScalarFunction;\n+import com.facebook.presto.spi.function.SqlType;\n+import com.facebook.presto.spi.function.TypeParameter;\n+import io.airlift.slice.Slice;\n+\n+import java.lang.invoke.MethodHandle;\n+\n+import static com.facebook.presto.common.function.OperatorType.EQUAL;\n+import static com.facebook.presto.spi.StandardErrorCode.INVALID_FUNCTION_ARGUMENT;\n+import static com.facebook.presto.spi.StandardErrorCode.NOT_SUPPORTED;\n+import static com.facebook.presto.util.Failures.internalError;\n+\n+@Description(\"Returns the position of the first occurrence of the given value in array (or 0 if not found)\")\n+@ScalarFunction(\"array_position\")\n+public class ArrayPositionWithIndexFunction\n+{\n+    protected ArrayPositionWithIndexFunction() {}\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") boolean element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        int size = array.getPositionCount();\n+        int instancesFound = 0;\n+\n+        if (instance == 0) {\n+            throw new PrestoException(INVALID_FUNCTION_ARGUMENT, \"array_position cannot take a 0-valued instance argument.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ab7a46513c95bd5b4b71040e48f938e96f73cb8"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NTc3MzAwMQ==", "bodyText": "Okay. I have now edited the message, rebased and pushed.", "url": "https://github.com/prestodb/presto/pull/15170#discussion_r655773001", "createdAt": "2021-06-21T23:37:48Z", "author": {"login": "ssaumitra"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/scalar/ArrayPositionWithIndexFunction.java", "diffHunk": "@@ -0,0 +1,256 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.operator.scalar;\n+\n+import com.facebook.presto.common.block.Block;\n+import com.facebook.presto.common.type.StandardTypes;\n+import com.facebook.presto.common.type.Type;\n+import com.facebook.presto.spi.PrestoException;\n+import com.facebook.presto.spi.function.Description;\n+import com.facebook.presto.spi.function.OperatorDependency;\n+import com.facebook.presto.spi.function.ScalarFunction;\n+import com.facebook.presto.spi.function.SqlType;\n+import com.facebook.presto.spi.function.TypeParameter;\n+import io.airlift.slice.Slice;\n+\n+import java.lang.invoke.MethodHandle;\n+\n+import static com.facebook.presto.common.function.OperatorType.EQUAL;\n+import static com.facebook.presto.spi.StandardErrorCode.INVALID_FUNCTION_ARGUMENT;\n+import static com.facebook.presto.spi.StandardErrorCode.NOT_SUPPORTED;\n+import static com.facebook.presto.util.Failures.internalError;\n+\n+@Description(\"Returns the position of the first occurrence of the given value in array (or 0 if not found)\")\n+@ScalarFunction(\"array_position\")\n+public class ArrayPositionWithIndexFunction\n+{\n+    protected ArrayPositionWithIndexFunction() {}\n+\n+    @TypeParameter(\"T\")\n+    @SqlType(StandardTypes.BIGINT)\n+    public static long arrayPositionWithIndex(\n+            @TypeParameter(\"T\") Type type,\n+            @OperatorDependency(operator = EQUAL, argumentTypes = {\"T\", \"T\"}) MethodHandle equalMethodHandle,\n+            @SqlType(\"array(T)\") Block array,\n+            @SqlType(\"T\") boolean element,\n+            @SqlType(StandardTypes.BIGINT) long instance)\n+    {\n+        int size = array.getPositionCount();\n+        int instancesFound = 0;\n+\n+        if (instance == 0) {\n+            throw new PrestoException(INVALID_FUNCTION_ARGUMENT, \"array_position cannot take a 0-valued instance argument.\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NTc1OTIwOQ=="}, "originalCommit": {"oid": "4ab7a46513c95bd5b4b71040e48f938e96f73cb8"}, "originalPosition": 53}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3663, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}