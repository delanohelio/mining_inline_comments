{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA3ODU2MTQw", "number": 15342, "title": "[Verifier] Fix JDBC URL selection", "bodyText": "== RELEASE NOTES ==\n\nVerifier Changes\n* Fix an issue where queries are always directed to the first cluster when multiple control or test clusters are specified.", "createdAt": "2020-10-21T20:51:08Z", "url": "https://github.com/prestodb/presto/pull/15342", "merged": true, "mergeCommit": {"oid": "fb936e0c06afdbf1750d0fe3b7521aab042aed5b"}, "closed": true, "closedAt": "2020-10-22T18:31:29Z", "author": {"login": "caithagoras"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdU1HvwgBqjM5MDYyMTQwMDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdU1xbugFqTUxNDI1NDE4Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a7dae46e2b172bc250f8a00702fdb3d2608c5241", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/a7dae46e2b172bc250f8a00702fdb3d2608c5241", "committedDate": "2020-10-21T20:48:48Z", "message": "Synchronize JDBC URL iteration"}, "afterCommit": {"oid": "6a44308a8826e1b01bd3e04ee28deb01e2465519", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/6a44308a8826e1b01bd3e04ee28deb01e2465519", "committedDate": "2020-10-21T22:29:02Z", "message": "Synchronize JDBC URL iteration"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6a44308a8826e1b01bd3e04ee28deb01e2465519", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/6a44308a8826e1b01bd3e04ee28deb01e2465519", "committedDate": "2020-10-21T22:29:02Z", "message": "Synchronize JDBC URL iteration"}, "afterCommit": {"oid": "26ba2b957212635d824ea023035767bce4e71d0c", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/26ba2b957212635d824ea023035767bce4e71d0c", "committedDate": "2020-10-21T22:32:09Z", "message": "Fix JDBC URL selection\n\nPreviously, the JDBC URL iterator object is created in PrestoAction,\nwhich is an emphemeral object as we create new PrestoActions for\neach source query. This causes the first url to always be selected."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e76165137f8aacae201c0b04373204ee387437e", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/9e76165137f8aacae201c0b04373204ee387437e", "committedDate": "2020-10-21T22:59:36Z", "message": "Fix JDBC URL selection\n\nPreviously, the JDBC URL iterator object is created in PrestoAction,\nwhich is an emphemeral object as we create new PrestoActions for\neach source query. This causes the first url to always be selected."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "26ba2b957212635d824ea023035767bce4e71d0c", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/26ba2b957212635d824ea023035767bce4e71d0c", "committedDate": "2020-10-21T22:32:09Z", "message": "Fix JDBC URL selection\n\nPreviously, the JDBC URL iterator object is created in PrestoAction,\nwhich is an emphemeral object as we create new PrestoActions for\neach source query. This causes the first url to always be selected."}, "afterCommit": {"oid": "9e76165137f8aacae201c0b04373204ee387437e", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/9e76165137f8aacae201c0b04373204ee387437e", "committedDate": "2020-10-21T22:59:36Z", "message": "Fix JDBC URL selection\n\nPreviously, the JDBC URL iterator object is created in PrestoAction,\nwhich is an emphemeral object as we create new PrestoActions for\neach source query. This causes the first url to always be selected."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0MjU0MTg3", "url": "https://github.com/prestodb/presto/pull/15342#pullrequestreview-514254187", "createdAt": "2020-10-21T23:14:37Z", "commit": {"oid": "9e76165137f8aacae201c0b04373204ee387437e"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQyMzoxNDozN1rOHmK_dQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQyMzoxNDozN1rOHmK_dQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTc4ODAyMQ==", "bodyText": "Should we add a test to make sure that we actually cycle over the jdbc urls?", "url": "https://github.com/prestodb/presto/pull/15342#discussion_r509788021", "createdAt": "2020-10-21T23:14:37Z", "author": {"login": "sachdevs"}, "path": "presto-verifier/src/test/java/com/facebook/presto/verifier/rewrite/TestQueryRewriter.java", "diffHunk": "@@ -76,13 +77,15 @@ public void setup()\n     {\n         queryRunner = setupPresto();\n         queryRunner.execute(\"CREATE TABLE test_table (a bigint, b varchar)\");\n+        PrestoActionConfig prestoActionConfig = new PrestoActionConfig()\n+                .setHosts(queryRunner.getServer().getAddress().getHost())\n+                .setJdbcPort(queryRunner.getServer().getAddress().getPort());\n         prestoAction = new JdbcPrestoAction(\n                 PrestoExceptionClassifier.defaultBuilder().build(),\n                 CONFIGURATION,\n                 VerificationContext.create(SUITE, NAME),\n-                new PrestoActionConfig()\n-                        .setHosts(queryRunner.getServer().getAddress().getHost())\n-                        .setJdbcPort(queryRunner.getServer().getAddress().getPort()),\n+                new JdbcUrlSelector(prestoActionConfig.getJdbcUrls()),\n+                prestoActionConfig,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e76165137f8aacae201c0b04373204ee387437e"}, "originalPosition": 23}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4978, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}