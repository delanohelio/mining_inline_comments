{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIyMDYyNDE5", "number": 15444, "title": "Add UDF to map enum value to key", "bodyText": "Adds a UDF to get the enum key for an enum as a string value.\nThis is useful in the case of integer enums in particular, to inspect data via clients that do not support enum pretty-printing, and would just show the enum value as a number.\n== RELEASE NOTES ==\n\nGeneral Changes\n* Added a UDF to get the key corresponding to an enum value: `ENUM_KEY(EnumType) -> VARCHAR`", "createdAt": "2020-11-17T00:39:56Z", "url": "https://github.com/prestodb/presto/pull/15444", "merged": true, "mergeCommit": {"oid": "c0e24ec7b32d0361ef741d7430e255edfaf75ab9"}, "closed": true, "closedAt": "2020-11-20T18:57:09Z", "author": {"login": "daniel-ohayon"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABddOwHgAFqTUzMTk0MDc2NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdePXEOAFqTUzNTA1ODM0Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxOTQwNzY0", "url": "https://github.com/prestodb/presto/pull/15444#pullrequestreview-531940764", "createdAt": "2020-11-17T00:52:16Z", "commit": {"oid": "e6756915ae29cad7a0f1af1a18f51c466acbbb97"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e6756915ae29cad7a0f1af1a18f51c466acbbb97", "author": {"user": {"login": "daniel-ohayon", "name": "Daniel Ohayon"}}, "url": "https://github.com/prestodb/presto/commit/e6756915ae29cad7a0f1af1a18f51c466acbbb97", "committedDate": "2020-11-17T00:35:49Z", "message": "Add UDF to map enum value to key"}, "afterCommit": {"oid": "d5128f2e660d2ffdff9f6e221451b113d1f3f7b9", "author": {"user": {"login": "daniel-ohayon", "name": "Daniel Ohayon"}}, "url": "https://github.com/prestodb/presto/commit/d5128f2e660d2ffdff9f6e221451b113d1f3f7b9", "committedDate": "2020-11-17T17:02:09Z", "message": "Add UDF to map enum value to key"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzODcyODky", "url": "https://github.com/prestodb/presto/pull/15444#pullrequestreview-533872892", "createdAt": "2020-11-18T21:02:06Z", "commit": {"oid": "d5128f2e660d2ffdff9f6e221451b113d1f3f7b9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMTowMjowNlrOH2CAbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMTowMjowNlrOH2CAbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQxODAzMQ==", "bodyText": "If you want to further improve the performance, we can make this map lazily instantiated. Add an AtomicBoolean to mark whether the map is instantiated, and create it on first call of getKeyForValue. That way, if the query doesn't need it, you don't need to create this.", "url": "https://github.com/prestodb/presto/pull/15444#discussion_r526418031", "createdAt": "2020-11-18T21:02:06Z", "author": {"login": "rongrong"}, "path": "presto-common/src/main/java/com/facebook/presto/common/type/LongEnumType.java", "diffHunk": "@@ -72,12 +80,15 @@ public String getDisplayName()\n     public static class LongEnumMap\n     {\n         private final Map<String, Long> enumMap;\n+        private final Map<Long, String> flippedEnumMap;\n \n         @JsonCreator\n         public LongEnumMap(@JsonProperty(\"enumMap\") Map<String, Long> enumMap)\n         {\n             validateEnumMap(enumMap);\n             this.enumMap = normalizeEnumMap(enumMap);\n+            this.flippedEnumMap = this.enumMap.entrySet().stream()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5128f2e660d2ffdff9f6e221451b113d1f3f7b9"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a377190c7bf4193740ce6dfe448c5c7a0ded6d41", "author": {"user": {"login": "daniel-ohayon", "name": "Daniel Ohayon"}}, "url": "https://github.com/prestodb/presto/commit/a377190c7bf4193740ce6dfe448c5c7a0ded6d41", "committedDate": "2020-11-19T04:15:21Z", "message": "Add UDF to map enum value to key"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d5128f2e660d2ffdff9f6e221451b113d1f3f7b9", "author": {"user": {"login": "daniel-ohayon", "name": "Daniel Ohayon"}}, "url": "https://github.com/prestodb/presto/commit/d5128f2e660d2ffdff9f6e221451b113d1f3f7b9", "committedDate": "2020-11-17T17:02:09Z", "message": "Add UDF to map enum value to key"}, "afterCommit": {"oid": "a377190c7bf4193740ce6dfe448c5c7a0ded6d41", "author": {"user": {"login": "daniel-ohayon", "name": "Daniel Ohayon"}}, "url": "https://github.com/prestodb/presto/commit/a377190c7bf4193740ce6dfe448c5c7a0ded6d41", "committedDate": "2020-11-19T04:15:21Z", "message": "Add UDF to map enum value to key"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0Njg1NjI0", "url": "https://github.com/prestodb/presto/pull/15444#pullrequestreview-534685624", "createdAt": "2020-11-19T17:30:39Z", "commit": {"oid": "a377190c7bf4193740ce6dfe448c5c7a0ded6d41"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxNzozMDozOVrOH2pyiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxNzozMDozOVrOH2pyiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA2OTgzMw==", "bodyText": "You can simply use the existing guava feature.\nprivate Supplier<Map<Long, String>> flippedEnumMap = Supplier.memorize(this::getKeyForValue);\naccording to its Javadoc\n\nReturns a supplier which caches the instance retrieved during the first call to {@code get()} and returns that value on subsequent calls to {@code get()}", "url": "https://github.com/prestodb/presto/pull/15444#discussion_r527069833", "createdAt": "2020-11-19T17:30:39Z", "author": {"login": "caithagoras"}, "path": "presto-common/src/main/java/com/facebook/presto/common/type/LongEnumType.java", "diffHunk": "@@ -72,12 +81,15 @@ public String getDisplayName()\n     public static class LongEnumMap\n     {\n         private final Map<String, Long> enumMap;\n+        private Map<Long, String> flippedEnumMap;\n+        private final AtomicBoolean isFlippedEnumComputed = new AtomicBoolean();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a377190c7bf4193740ce6dfe448c5c7a0ded6d41"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0NjkwNTY2", "url": "https://github.com/prestodb/presto/pull/15444#pullrequestreview-534690566", "createdAt": "2020-11-19T17:36:26Z", "commit": {"oid": "a377190c7bf4193740ce6dfe448c5c7a0ded6d41"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxNzozNjoyNlrOH2qBPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxNzozNjoyNlrOH2qBPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA3MzU5Nw==", "bodyText": "Have we considered using a BiMap? e.g. ImmutableBiMap.", "url": "https://github.com/prestodb/presto/pull/15444#discussion_r527073597", "createdAt": "2020-11-19T17:36:26Z", "author": {"login": "caithagoras"}, "path": "presto-common/src/main/java/com/facebook/presto/common/type/LongEnumType.java", "diffHunk": "@@ -72,12 +81,15 @@ public String getDisplayName()\n     public static class LongEnumMap\n     {\n         private final Map<String, Long> enumMap;\n+        private Map<Long, String> flippedEnumMap;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a377190c7bf4193740ce6dfe448c5c7a0ded6d41"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0ODc4MzE0", "url": "https://github.com/prestodb/presto/pull/15444#pullrequestreview-534878314", "createdAt": "2020-11-19T21:41:25Z", "commit": {"oid": "a377190c7bf4193740ce6dfe448c5c7a0ded6d41"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1MDU4MzQ3", "url": "https://github.com/prestodb/presto/pull/15444#pullrequestreview-535058347", "createdAt": "2020-11-20T04:08:45Z", "commit": {"oid": "a377190c7bf4193740ce6dfe448c5c7a0ded6d41"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4726, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}