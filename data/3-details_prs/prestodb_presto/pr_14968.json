{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYzNDU0MjI1", "number": 14968, "title": "Added conversion functions between Geometry and GeoJSON format. ", "bodyText": "Test plan - Unit tests added in TestGeoFunctions for forward and backward conversion between JSON and Geometry format.\n== RELEASE NOTES ==\n\nGeneral Changes\n* Added :func:`geometry_from_geojson` and :func:`geometry_as_geojson` to convert geometries from and to GeoJSON format.", "createdAt": "2020-08-05T15:21:32Z", "url": "https://github.com/prestodb/presto/pull/14968", "merged": true, "mergeCommit": {"oid": "d9c1e8489e5cc890560f0a5fd57c94684116945f"}, "closed": true, "closedAt": "2020-08-10T23:25:23Z", "author": {"login": "walterddr"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc79UKpgFqTQ2MTc5NDI4OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc9niRwABqjM2NDAyMTEwMzQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxNzk0Mjg5", "url": "https://github.com/prestodb/presto/pull/14968#pullrequestreview-461794289", "createdAt": "2020-08-05T15:47:14Z", "commit": {"oid": "19ae1f3c96a45cd0e3cbf615acffb57513d4f3c6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxNTo0NzoxNFrOG8Ps-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxNTo1MDozNVrOG8P14g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTgyNTAxNw==", "bodyText": "In general, importing * is discouraged.  Make sure the imports are expanded.", "url": "https://github.com/prestodb/presto/pull/14968#discussion_r465825017", "createdAt": "2020-08-05T15:47:14Z", "author": {"login": "jagill"}, "path": "presto-geospatial/src/main/java/com/facebook/presto/plugin/geospatial/GeoFunctions.java", "diffHunk": "@@ -87,17 +87,7 @@\n import static com.facebook.presto.geospatial.GeometryType.MULTI_POLYGON;\n import static com.facebook.presto.geospatial.GeometryType.POINT;\n import static com.facebook.presto.geospatial.GeometryType.POLYGON;\n-import static com.facebook.presto.geospatial.GeometryUtils.createJtsEmptyLineString;\n-import static com.facebook.presto.geospatial.GeometryUtils.createJtsEmptyPoint;\n-import static com.facebook.presto.geospatial.GeometryUtils.createJtsEmptyPolygon;\n-import static com.facebook.presto.geospatial.GeometryUtils.createJtsLineString;\n-import static com.facebook.presto.geospatial.GeometryUtils.createJtsMultiPoint;\n-import static com.facebook.presto.geospatial.GeometryUtils.createJtsPoint;\n-import static com.facebook.presto.geospatial.GeometryUtils.flattenCollection;\n-import static com.facebook.presto.geospatial.GeometryUtils.getGeometryInvalidReason;\n-import static com.facebook.presto.geospatial.GeometryUtils.getPointCount;\n-import static com.facebook.presto.geospatial.GeometryUtils.jtsGeometryFromWkt;\n-import static com.facebook.presto.geospatial.GeometryUtils.wktFromJtsGeometry;\n+import static com.facebook.presto.geospatial.GeometryUtils.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19ae1f3c96a45cd0e3cbf615acffb57513d4f3c6"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTgyNTM2Mw==", "bodyText": "It's not a WKT, so the message should reference GeoJSON.", "url": "https://github.com/prestodb/presto/pull/14968#discussion_r465825363", "createdAt": "2020-08-05T15:47:43Z", "author": {"login": "jagill"}, "path": "presto-geospatial-toolkit/src/main/java/com/facebook/presto/geospatial/GeometryUtils.java", "diffHunk": "@@ -231,6 +233,21 @@ public static boolean isPointOrRectangle(OGCGeometry ogcGeometry, Envelope envel\n         return true;\n     }\n \n+    public static org.locationtech.jts.geom.Geometry jtsGeometryFromJson(String json)\n+    {\n+        try {\n+            return new GeoJsonReader().read(json);\n+        }\n+        catch (ParseException | IllegalArgumentException e) {\n+            throw new PrestoException(INVALID_FUNCTION_ARGUMENT, \"Invalid WKT: \" + e.getMessage(), e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19ae1f3c96a45cd0e3cbf615acffb57513d4f3c6"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTgyNzA3Ng==", "bodyText": "Please add tests for:\n\nEmpty Geometries (of all types)\nDeserializing valid GeoJSON strings\nDeserializing invalid GeoJSON strings", "url": "https://github.com/prestodb/presto/pull/14968#discussion_r465827076", "createdAt": "2020-08-05T15:50:14Z", "author": {"login": "jagill"}, "path": "presto-geospatial/src/test/java/com/facebook/presto/plugin/geospatial/TestGeoFunctions.java", "diffHunk": "@@ -1266,4 +1267,26 @@ private void assertGeomFromBinary(String wkt)\n     {\n         assertFunction(format(\"ST_AsText(ST_GeomFromBinary(ST_AsBinary(ST_GeometryFromText('%s'))))\", wkt), VARCHAR, wkt);\n     }\n+\n+    @Test\n+    public void testGeometryJsonConversion() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19ae1f3c96a45cd0e3cbf615acffb57513d4f3c6"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTgyNzI5OA==", "bodyText": "Also include a self-crossing LineString, like (0 0, 1 1, 1 0, 0 1).", "url": "https://github.com/prestodb/presto/pull/14968#discussion_r465827298", "createdAt": "2020-08-05T15:50:35Z", "author": {"login": "jagill"}, "path": "presto-geospatial/src/test/java/com/facebook/presto/plugin/geospatial/TestGeoFunctions.java", "diffHunk": "@@ -1266,4 +1267,26 @@ private void assertGeomFromBinary(String wkt)\n     {\n         assertFunction(format(\"ST_AsText(ST_GeomFromBinary(ST_AsBinary(ST_GeometryFromText('%s'))))\", wkt), VARCHAR, wkt);\n     }\n+\n+    @Test\n+    public void testGeometryJsonConversion() throws Exception {\n+        // valid nonempty geometries\n+        assertGeoFromJson(\"POINT (1 2)\");\n+        assertGeoFromJson(\"MULTIPOINT ((1 2), (3 4))\");\n+        assertGeoFromJson(\"LINESTRING (0 0, 1 2, 3 4)\");\n+        assertGeoFromJson(\"MULTILINESTRING ((1 1, 5 1), (2 4, 4 4))\");\n+        assertGeoFromJson(\"POLYGON ((0 0, 0 1, 1 1, 1 0, 0 0))\");\n+        assertGeoFromJson(\"POLYGON ((0 0, 0 3, 3 3, 3 0, 0 0), (1 1, 2 1, 2 2, 1 2, 1 1))\");\n+        assertGeoFromJson(\"MULTIPOLYGON (((1 1, 1 3, 3 3, 3 1, 1 1)), ((2 4, 2 6, 6 6, 6 4, 2 4)))\");\n+        assertGeoFromJson(\"GEOMETRYCOLLECTION (POINT (1 2), LINESTRING (0 0, 1 2, 3 4), POLYGON ((0 0, 0 1, 1 1, 1 0, 0 0)))\");\n+\n+        // invalid geometries\n+        assertGeoFromJson(\"MULTIPOINT ((0 0), (0 1), (1 1), (0 1))\");\n+        assertGeoFromJson(\"LINESTRING (0 0, 0 1, 0 1, 1 1, 1 0, 0 0)\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19ae1f3c96a45cd0e3cbf615acffb57513d4f3c6"}, "originalPosition": 27}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "360fc9ed42b0896a82da39954470f3a1a73ac721", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/360fc9ed42b0896a82da39954470f3a1a73ac721", "committedDate": "2020-08-05T15:15:30Z", "message": "fix build error"}, "afterCommit": {"oid": "32d7e54d6800cf0de53946944ac3c1d5ca180aab", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/32d7e54d6800cf0de53946944ac3c1d5ca180aab", "committedDate": "2020-08-05T21:51:46Z", "message": "Initial commit to support geometry to/from json"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyMDUzMDIz", "url": "https://github.com/prestodb/presto/pull/14968#pullrequestreview-462053023", "createdAt": "2020-08-05T21:58:11Z", "commit": {"oid": "32d7e54d6800cf0de53946944ac3c1d5ca180aab"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQyMTo1ODoxMVrOG8cFGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQyMTo1ODoxMVrOG8cFGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjAyNzgwMQ==", "bodyText": "This is going to be a problem. I will see if there's any quick fix or workarounds we can do.", "url": "https://github.com/prestodb/presto/pull/14968#discussion_r466027801", "createdAt": "2020-08-05T21:58:11Z", "author": {"login": "walterddr"}, "path": "presto-geospatial/src/test/java/com/facebook/presto/plugin/geospatial/TestGeoFunctions.java", "diffHunk": "@@ -1266,4 +1266,62 @@ private void assertGeomFromBinary(String wkt)\n     {\n         assertFunction(format(\"ST_AsText(ST_GeomFromBinary(ST_AsBinary(ST_GeometryFromText('%s'))))\", wkt), VARCHAR, wkt);\n     }\n+\n+    @Test\n+    public void testGeometryJsonConversion()\n+    {\n+        // empty geometries\n+        // JTS library has trouble creating correct JSON for empty, non-multi geometry,\n+        // see https://github.com/locationtech/jts/issues/411\n+        // the following tests has been commented out.\n+//        assertGeoFromJson(\"POINT EMPTY\");\n+//        assertGeoFromJson(\"LINESTRING EMPTY\");\n+//        assertGeoFromJson(\"POLYGON EMPTY\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32d7e54d6800cf0de53946944ac3c1d5ca180aab"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyMDUzNDg3", "url": "https://github.com/prestodb/presto/pull/14968#pullrequestreview-462053487", "createdAt": "2020-08-05T21:59:03Z", "commit": {"oid": "32d7e54d6800cf0de53946944ac3c1d5ca180aab"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "32d7e54d6800cf0de53946944ac3c1d5ca180aab", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/32d7e54d6800cf0de53946944ac3c1d5ca180aab", "committedDate": "2020-08-05T21:51:46Z", "message": "Initial commit to support geometry to/from json"}, "afterCommit": {"oid": "1ca4a3b144f7f2280e95cfe17e155a6473fdbf83", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/1ca4a3b144f7f2280e95cfe17e155a6473fdbf83", "committedDate": "2020-08-06T15:04:09Z", "message": "Support geometry to/from json"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1ca4a3b144f7f2280e95cfe17e155a6473fdbf83", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/1ca4a3b144f7f2280e95cfe17e155a6473fdbf83", "committedDate": "2020-08-06T15:04:09Z", "message": "Support geometry to/from json"}, "afterCommit": {"oid": "6a735b50e76264060d6a530309de41faf38e9c1d", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/6a735b50e76264060d6a530309de41faf38e9c1d", "committedDate": "2020-08-06T16:34:37Z", "message": "Support geometry to/from json"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6a735b50e76264060d6a530309de41faf38e9c1d", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/6a735b50e76264060d6a530309de41faf38e9c1d", "committedDate": "2020-08-06T16:34:37Z", "message": "Support geometry to/from json"}, "afterCommit": {"oid": "7031814a7d67984e047dce1b69f57b7c1a922a1d", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/7031814a7d67984e047dce1b69f57b7c1a922a1d", "committedDate": "2020-08-06T21:57:24Z", "message": "Support conversion between geometry and json.\n\nAdded Geometry functions: geometry_from_geojson and geometry_as_geojson."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzNDY0MjI3", "url": "https://github.com/prestodb/presto/pull/14968#pullrequestreview-463464227", "createdAt": "2020-08-07T16:58:18Z", "commit": {"oid": "7031814a7d67984e047dce1b69f57b7c1a922a1d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7031814a7d67984e047dce1b69f57b7c1a922a1d", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/7031814a7d67984e047dce1b69f57b7c1a922a1d", "committedDate": "2020-08-06T21:57:24Z", "message": "Support conversion between geometry and json.\n\nAdded Geometry functions: geometry_from_geojson and geometry_as_geojson."}, "afterCommit": {"oid": "ed81d1030126f998e6ab65a560818d4ca19647ab", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/ed81d1030126f998e6ab65a560818d4ca19647ab", "committedDate": "2020-08-10T19:19:56Z", "message": "Add conversion functions between Geometry and GeoJSON format\n\nAdded Geometry functions: geometry_from_geojson and geometry_as_geojson."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0NTE0MTg5", "url": "https://github.com/prestodb/presto/pull/14968#pullrequestreview-464514189", "createdAt": "2020-08-10T19:24:17Z", "commit": {"oid": "ed81d1030126f998e6ab65a560818d4ca19647ab"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ed81d1030126f998e6ab65a560818d4ca19647ab", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/ed81d1030126f998e6ab65a560818d4ca19647ab", "committedDate": "2020-08-10T19:19:56Z", "message": "Add conversion functions between Geometry and GeoJSON format\n\nAdded Geometry functions: geometry_from_geojson and geometry_as_geojson."}, "afterCommit": {"oid": "838403daf35234c2d21862c7fadfea72ca55c831", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/838403daf35234c2d21862c7fadfea72ca55c831", "committedDate": "2020-08-10T19:30:03Z", "message": "Add geo conversion functions: geometry_from_geojson and geometry_as_geojson."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "838403daf35234c2d21862c7fadfea72ca55c831", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/838403daf35234c2d21862c7fadfea72ca55c831", "committedDate": "2020-08-10T19:30:03Z", "message": "Add geo conversion functions: geometry_from_geojson and geometry_as_geojson."}, "afterCommit": {"oid": "9c2385808873eb4519a64a82b872723cd2974b37", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/9c2385808873eb4519a64a82b872723cd2974b37", "committedDate": "2020-08-10T19:31:04Z", "message": "Add functions: geometry_from_geojson and geometry_as_geojson."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d3334c0a80c97912347a643e564c041c812a565", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/5d3334c0a80c97912347a643e564c041c812a565", "committedDate": "2020-08-10T19:39:00Z", "message": "Add functions geometry_from_geojson and geometry_as_geojson"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9c2385808873eb4519a64a82b872723cd2974b37", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/9c2385808873eb4519a64a82b872723cd2974b37", "committedDate": "2020-08-10T19:31:04Z", "message": "Add functions: geometry_from_geojson and geometry_as_geojson."}, "afterCommit": {"oid": "5d3334c0a80c97912347a643e564c041c812a565", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/5d3334c0a80c97912347a643e564c041c812a565", "committedDate": "2020-08-10T19:39:00Z", "message": "Add functions geometry_from_geojson and geometry_as_geojson"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 438, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}