{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE5OTE3MTc4", "number": 14554, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNjoxNDowM1rOD93vUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxOTo1MjoxNlrOD-XoEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2MjAyOTYzOnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/com/facebook/presto/execution/resourceGroups/InternalResourceGroupManager.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNjoxNDowM1rOGXoDZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQyMjowNDo1NFrOGX0TPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQyNjY2MQ==", "bodyText": "Let's suppress this Exception per the docs: https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ScheduledExecutorService.html#scheduleWithFixedDelay-java.lang.Runnable-long-long-java.util.concurrent.TimeUnit-\nLogging should be sufficient.", "url": "https://github.com/prestodb/presto/pull/14554#discussion_r427426661", "createdAt": "2020-05-19T16:14:03Z", "author": {"login": "tdcmeehan"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/resourceGroups/InternalResourceGroupManager.java", "diffHunk": "@@ -191,7 +192,17 @@ public void destroy()\n     public void start()\n     {\n         if (started.compareAndSet(false, true)) {\n-            refreshExecutor.scheduleWithFixedDelay(this::refreshAndStartQueries, 1, 1, TimeUnit.MILLISECONDS);\n+            refreshExecutor.scheduleWithFixedDelay(() -> {\n+                try {\n+                    refreshAndStartQueries();\n+                }\n+                catch (Throwable t) {\n+                    log.error(t, \"Error while executing refreshAndStartQueries\");\n+                    throw t;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "959c047d1cb9c946b48f8d20086c1649e828f7af"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQzMzM0Mg==", "bodyText": "OR, what we could do is stash the returned ScheduledFuture from refreshExecutor.scheduleWithFixedDelay, and use it to see if this has completed or failed (failing queries if so).", "url": "https://github.com/prestodb/presto/pull/14554#discussion_r427433342", "createdAt": "2020-05-19T16:23:52Z", "author": {"login": "tdcmeehan"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/resourceGroups/InternalResourceGroupManager.java", "diffHunk": "@@ -191,7 +192,17 @@ public void destroy()\n     public void start()\n     {\n         if (started.compareAndSet(false, true)) {\n-            refreshExecutor.scheduleWithFixedDelay(this::refreshAndStartQueries, 1, 1, TimeUnit.MILLISECONDS);\n+            refreshExecutor.scheduleWithFixedDelay(() -> {\n+                try {\n+                    refreshAndStartQueries();\n+                }\n+                catch (Throwable t) {\n+                    log.error(t, \"Error while executing refreshAndStartQueries\");\n+                    throw t;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQyNjY2MQ=="}, "originalCommit": {"oid": "959c047d1cb9c946b48f8d20086c1649e828f7af"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYyNzMyNA==", "bodyText": "Are all queries stuck or only some queries? If some queries are still running, it may be other reasons.\nLogging is enough, just like other places we handle error from scheduleWithFixedDelay. You can throw error in custom build for verification purpose.", "url": "https://github.com/prestodb/presto/pull/14554#discussion_r427627324", "createdAt": "2020-05-19T22:04:54Z", "author": {"login": "viczhang861"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/resourceGroups/InternalResourceGroupManager.java", "diffHunk": "@@ -191,7 +192,17 @@ public void destroy()\n     public void start()\n     {\n         if (started.compareAndSet(false, true)) {\n-            refreshExecutor.scheduleWithFixedDelay(this::refreshAndStartQueries, 1, 1, TimeUnit.MILLISECONDS);\n+            refreshExecutor.scheduleWithFixedDelay(() -> {\n+                try {\n+                    refreshAndStartQueries();\n+                }\n+                catch (Throwable t) {\n+                    log.error(t, \"Error while executing refreshAndStartQueries\");\n+                    throw t;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQyNjY2MQ=="}, "originalCommit": {"oid": "959c047d1cb9c946b48f8d20086c1649e828f7af"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NzI1MzU4OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/com/facebook/presto/execution/resourceGroups/InternalResourceGroupManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxOTo1MjowOFrOGYbfnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxOTo1MjowOFrOGYbfnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI2OTQ2OA==", "bodyText": "nit: static import currentTimeMillis", "url": "https://github.com/prestodb/presto/pull/14554#discussion_r428269468", "createdAt": "2020-05-20T19:52:08Z", "author": {"login": "caithagoras"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/resourceGroups/InternalResourceGroupManager.java", "diffHunk": "@@ -283,6 +294,12 @@ public int getQueriesQueuedOnInternal()\n         return queriesQueuedInternal;\n     }\n \n+    @Managed\n+    public long getLastSchedulingCycleRuntimeDelayMs()\n+    {\n+        return System.currentTimeMillis() - lastSchedulingCycleRunTimeMs.get();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "959c047d1cb9c946b48f8d20086c1649e828f7af"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NzI1Mzk1OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/com/facebook/presto/execution/resourceGroups/InternalResourceGroupManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxOTo1MjoxNlrOGYbf3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxOTo1MjoxNlrOGYbf3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI2OTUzNQ==", "bodyText": "nit: static import MILLISECONDS", "url": "https://github.com/prestodb/presto/pull/14554#discussion_r428269535", "createdAt": "2020-05-20T19:52:16Z", "author": {"login": "caithagoras"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/resourceGroups/InternalResourceGroupManager.java", "diffHunk": "@@ -191,7 +192,17 @@ public void destroy()\n     public void start()\n     {\n         if (started.compareAndSet(false, true)) {\n-            refreshExecutor.scheduleWithFixedDelay(this::refreshAndStartQueries, 1, 1, TimeUnit.MILLISECONDS);\n+            refreshExecutor.scheduleWithFixedDelay(() -> {\n+                try {\n+                    refreshAndStartQueries();\n+                }\n+                catch (Throwable t) {\n+                    log.error(t, \"Error while executing refreshAndStartQueries\");\n+                    throw t;\n+                }\n+\n+                lastSchedulingCycleRunTimeMs.getAndSet(System.currentTimeMillis());\n+            }, 1, 1, TimeUnit.MILLISECONDS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "959c047d1cb9c946b48f8d20086c1649e828f7af"}, "originalPosition": 23}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2663, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}