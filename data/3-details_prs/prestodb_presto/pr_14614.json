{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI4MTU3NDM2", "number": 14614, "title": "Add session property to disable warnings, or treat warnings as errors", "bodyText": "== RELEASE NOTES ==\nGeneral Changes\n* Add new session property ``warning_handling `` to control how warnings are handled. The options are ``SUPPRESS``, ``NORMAL`` and ``AS_ERROR``. The default value is ``NORMAL``.", "createdAt": "2020-06-05T00:32:33Z", "url": "https://github.com/prestodb/presto/pull/14614", "merged": true, "mergeCommit": {"oid": "2cd47ca3fd47d526c572cfd301f41cfbab2c91a5"}, "closed": true, "closedAt": "2020-06-09T17:57:08Z", "author": {"login": "prithvip"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcoYGgigFqTQyNTU4MjU0OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcpaPW4gBqjM0MjI1NjEwOTM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1NTgyNTQ4", "url": "https://github.com/prestodb/presto/pull/14614#pullrequestreview-425582548", "createdAt": "2020-06-05T19:47:52Z", "commit": {"oid": "b546483fbf40cb0ecf9861eead57bb0dfd543934"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxOTo0Nzo1MlrOGf7OsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxOTo0Nzo1MlrOGf7OsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjEyOTQ1Nw==", "bodyText": "Hmm, here you want to wrap the warning in the PrestoException so you will get better context.", "url": "https://github.com/prestodb/presto/pull/14614#discussion_r436129457", "createdAt": "2020-06-05T19:47:52Z", "author": {"login": "kaikalur"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/warnings/DefaultWarningCollector.java", "diffHunk": "@@ -43,9 +45,18 @@ public DefaultWarningCollector(WarningCollectorConfig config)\n     public synchronized void add(PrestoWarning warning)\n     {\n         requireNonNull(warning, \"warning is null\");\n-        if (warnings.size() < config.getMaxWarnings()) {\n-            warnings.putIfAbsent(warning.getWarningCode(), warning);\n+        switch(config.getWarningHandlingLevel()) {\n+            case SUPPRESS:\n+                break;\n+            case NORMAL:\n+                if (warnings.size() < config.getMaxWarnings()) {\n+                    warnings.putIfAbsent(warning.getWarningCode(), warning);\n+                }\n+                break;\n+            case AS_ERROR:\n+                throw new PrestoException(StandardErrorCode.WARNING_AS_ERROR, warning.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b546483fbf40cb0ecf9861eead57bb0dfd543934"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1NTg0NDIy", "url": "https://github.com/prestodb/presto/pull/14614#pullrequestreview-425584422", "createdAt": "2020-06-05T19:49:35Z", "commit": {"oid": "b546483fbf40cb0ecf9861eead57bb0dfd543934"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b546483fbf40cb0ecf9861eead57bb0dfd543934", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/b546483fbf40cb0ecf9861eead57bb0dfd543934", "committedDate": "2020-06-05T00:27:14Z", "message": "Add session property to disable warnings, or treat warnings as errors"}, "afterCommit": {"oid": "29018f2123184ebd96552ecbc236f0a969f10e19", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/29018f2123184ebd96552ecbc236f0a969f10e19", "committedDate": "2020-06-08T19:08:28Z", "message": "Add session property to disable warnings, or treat warnings as errors"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2NTg2NzI0", "url": "https://github.com/prestodb/presto/pull/14614#pullrequestreview-426586724", "createdAt": "2020-06-08T20:16:27Z", "commit": {"oid": "29018f2123184ebd96552ecbc236f0a969f10e19"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQyMDoxNjoyOFrOGguynA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQyMDoyMDoyMlrOGgu6nQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk3NDIzNg==", "bodyText": "Static import.", "url": "https://github.com/prestodb/presto/pull/14614#discussion_r436974236", "createdAt": "2020-06-08T20:16:28Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/QueryPreparer.java", "diffHunk": "@@ -54,6 +60,12 @@ public PreparedQuery prepareQuery(Session session, String query, WarningCollecto\n             throws ParsingException, PrestoException, SemanticException\n     {\n         Statement wrappedStatement = sqlParser.createStatement(query, createParsingOptions(session, warningCollector));\n+        if (SystemSessionProperties.getWarningHandlingLevel(session) == WarningHandlingLevel.AS_ERROR) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29018f2123184ebd96552ecbc236f0a969f10e19"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk3NTYzOQ==", "bodyText": "Should you check whether there are warnings before throwing exception?", "url": "https://github.com/prestodb/presto/pull/14614#discussion_r436975639", "createdAt": "2020-06-08T20:19:12Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/QueryPreparer.java", "diffHunk": "@@ -54,6 +60,12 @@ public PreparedQuery prepareQuery(Session session, String query, WarningCollecto\n             throws ParsingException, PrestoException, SemanticException\n     {\n         Statement wrappedStatement = sqlParser.createStatement(query, createParsingOptions(session, warningCollector));\n+        if (SystemSessionProperties.getWarningHandlingLevel(session) == WarningHandlingLevel.AS_ERROR) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk3NDIzNg=="}, "originalCommit": {"oid": "29018f2123184ebd96552ecbc236f0a969f10e19"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk3NjI4NQ==", "bodyText": "I'll probably only keep the WarningHandlingLevel as member variable rather than the whole session.", "url": "https://github.com/prestodb/presto/pull/14614#discussion_r436976285", "createdAt": "2020-06-08T20:20:22Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/warnings/DefaultWarningCollector.java", "diffHunk": "@@ -33,18 +38,34 @@\n     @GuardedBy(\"this\")\n     private final Map<WarningCode, PrestoWarning> warnings = new LinkedHashMap<>();\n     private final WarningCollectorConfig config;\n+    private final Session session;\n \n-    public DefaultWarningCollector(WarningCollectorConfig config)\n+    public DefaultWarningCollector(WarningCollectorConfig config, Session session)\n     {\n         this.config = requireNonNull(config, \"config is null\");\n+        this.session = session;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29018f2123184ebd96552ecbc236f0a969f10e19"}, "originalPosition": 23}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "29018f2123184ebd96552ecbc236f0a969f10e19", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/29018f2123184ebd96552ecbc236f0a969f10e19", "committedDate": "2020-06-08T19:08:28Z", "message": "Add session property to disable warnings, or treat warnings as errors"}, "afterCommit": {"oid": "333cc2c9c2ad58c5448976fe918ba595eae7ae8a", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/333cc2c9c2ad58c5448976fe918ba595eae7ae8a", "committedDate": "2020-06-08T21:40:46Z", "message": "Add session property to disable warnings, or treat warnings as errors"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "333cc2c9c2ad58c5448976fe918ba595eae7ae8a", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/333cc2c9c2ad58c5448976fe918ba595eae7ae8a", "committedDate": "2020-06-08T21:40:46Z", "message": "Add session property to disable warnings, or treat warnings as errors"}, "afterCommit": {"oid": "25170b737c0ee901ff416c25f9393b89058e008a", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/25170b737c0ee901ff416c25f9393b89058e008a", "committedDate": "2020-06-08T21:45:16Z", "message": "Add session property to disable warnings, or treat warnings as errors"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2NjQ2MTc3", "url": "https://github.com/prestodb/presto/pull/14614#pullrequestreview-426646177", "createdAt": "2020-06-08T21:48:53Z", "commit": {"oid": "25170b737c0ee901ff416c25f9393b89058e008a"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQyMTo0ODo1M1rOGgxn6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQyMTo1MDowNFrOGgxp8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzAyMDY1MA==", "bodyText": "Static import here as well ;)", "url": "https://github.com/prestodb/presto/pull/14614#discussion_r437020650", "createdAt": "2020-06-08T21:48:53Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/dispatcher/DispatchManager.java", "diffHunk": "@@ -178,7 +179,7 @@ public QueryId createQueryId()\n             session = sessionSupplier.createSession(queryId, sessionContext);\n \n             // prepare query\n-            WarningCollector warningCollector = warningCollectorFactory.create();\n+            WarningCollector warningCollector = warningCollectorFactory.create(SystemSessionProperties.getWarningHandlingLevel(session));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25170b737c0ee901ff416c25f9393b89058e008a"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzAyMDk0Ng==", "bodyText": "Static import", "url": "https://github.com/prestodb/presto/pull/14614#discussion_r437020946", "createdAt": "2020-06-08T21:49:37Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/warnings/DefaultWarningCollector.java", "diffHunk": "@@ -33,18 +36,34 @@\n     @GuardedBy(\"this\")\n     private final Map<WarningCode, PrestoWarning> warnings = new LinkedHashMap<>();\n     private final WarningCollectorConfig config;\n+    private final WarningHandlingLevel warningHandlingLevel;\n \n-    public DefaultWarningCollector(WarningCollectorConfig config)\n+    public DefaultWarningCollector(WarningCollectorConfig config, WarningHandlingLevel warningHandlingLevel)\n     {\n         this.config = requireNonNull(config, \"config is null\");\n+        this.warningHandlingLevel = warningHandlingLevel;\n     }\n \n     @Override\n     public synchronized void add(PrestoWarning warning)\n     {\n         requireNonNull(warning, \"warning is null\");\n-        if (warnings.size() < config.getMaxWarnings()) {\n-            warnings.putIfAbsent(warning.getWarningCode(), warning);\n+        switch (warningHandlingLevel) {\n+            case SUPPRESS:\n+                break;\n+            case NORMAL:\n+                addWarningIfNumWarningsLessThanConfig(warning);\n+                break;\n+            case AS_ERROR:\n+                /* Parser warnings must be handled differently since we should not throw an exception when parsing.\n+                 * Warnings are collected and an exception with all warnings is thrown in {@link QueryPreparer#prepareQuery}\n+                 */\n+                if (warning.getWarningCode() == StandardWarningCode.PARSER_WARNING.toWarningCode()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25170b737c0ee901ff416c25f9393b89058e008a"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzAyMTA0OA==", "bodyText": "Same here.", "url": "https://github.com/prestodb/presto/pull/14614#discussion_r437021048", "createdAt": "2020-06-08T21:49:46Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/warnings/DefaultWarningCollector.java", "diffHunk": "@@ -33,18 +36,34 @@\n     @GuardedBy(\"this\")\n     private final Map<WarningCode, PrestoWarning> warnings = new LinkedHashMap<>();\n     private final WarningCollectorConfig config;\n+    private final WarningHandlingLevel warningHandlingLevel;\n \n-    public DefaultWarningCollector(WarningCollectorConfig config)\n+    public DefaultWarningCollector(WarningCollectorConfig config, WarningHandlingLevel warningHandlingLevel)\n     {\n         this.config = requireNonNull(config, \"config is null\");\n+        this.warningHandlingLevel = warningHandlingLevel;\n     }\n \n     @Override\n     public synchronized void add(PrestoWarning warning)\n     {\n         requireNonNull(warning, \"warning is null\");\n-        if (warnings.size() < config.getMaxWarnings()) {\n-            warnings.putIfAbsent(warning.getWarningCode(), warning);\n+        switch (warningHandlingLevel) {\n+            case SUPPRESS:\n+                break;\n+            case NORMAL:\n+                addWarningIfNumWarningsLessThanConfig(warning);\n+                break;\n+            case AS_ERROR:\n+                /* Parser warnings must be handled differently since we should not throw an exception when parsing.\n+                 * Warnings are collected and an exception with all warnings is thrown in {@link QueryPreparer#prepareQuery}\n+                 */\n+                if (warning.getWarningCode() == StandardWarningCode.PARSER_WARNING.toWarningCode()) {\n+                    addWarningIfNumWarningsLessThanConfig(warning);\n+                }\n+                else {\n+                    throw new PrestoException(StandardErrorCode.WARNING_AS_ERROR, warning.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25170b737c0ee901ff416c25f9393b89058e008a"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzAyMTE3MQ==", "bodyText": "Static import", "url": "https://github.com/prestodb/presto/pull/14614#discussion_r437021171", "createdAt": "2020-06-08T21:50:04Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/warnings/WarningCollectorConfig.java", "diffHunk": "@@ -20,6 +20,7 @@\n public class WarningCollectorConfig\n {\n     private int maxWarnings = Integer.MAX_VALUE;\n+    private WarningHandlingLevel warningHandlingLevel = WarningHandlingLevel.NORMAL;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25170b737c0ee901ff416c25f9393b89058e008a"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "25170b737c0ee901ff416c25f9393b89058e008a", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/25170b737c0ee901ff416c25f9393b89058e008a", "committedDate": "2020-06-08T21:45:16Z", "message": "Add session property to disable warnings, or treat warnings as errors"}, "afterCommit": {"oid": "0ada497c134136e419e66d304723d00dccf71b53", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/0ada497c134136e419e66d304723d00dccf71b53", "committedDate": "2020-06-08T22:02:17Z", "message": "Add session property to disable warnings, or treat warnings as errors"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2NjY0Mzk2", "url": "https://github.com/prestodb/presto/pull/14614#pullrequestreview-426664396", "createdAt": "2020-06-08T22:27:01Z", "commit": {"oid": "0ada497c134136e419e66d304723d00dccf71b53"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0ada497c134136e419e66d304723d00dccf71b53", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/0ada497c134136e419e66d304723d00dccf71b53", "committedDate": "2020-06-08T22:02:17Z", "message": "Add session property to disable warnings, or treat warnings as errors"}, "afterCommit": {"oid": "ad1c62e053918e69f2cb6216a6028aed6af9c57f", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/ad1c62e053918e69f2cb6216a6028aed6af9c57f", "committedDate": "2020-06-08T23:15:22Z", "message": "Add session property to disable warnings, or treat warnings as errors"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ad1c62e053918e69f2cb6216a6028aed6af9c57f", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/ad1c62e053918e69f2cb6216a6028aed6af9c57f", "committedDate": "2020-06-08T23:15:22Z", "message": "Add session property to disable warnings, or treat warnings as errors"}, "afterCommit": {"oid": "bd38273d6dbadb06e5110bb5b00fad90d7c6364f", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/bd38273d6dbadb06e5110bb5b00fad90d7c6364f", "committedDate": "2020-06-09T00:29:39Z", "message": "Add session property to disable warnings, or treat warnings as errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4bee6284555fa0e74423f58bdb3c0fe828e6f347", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/4bee6284555fa0e74423f58bdb3c0fe828e6f347", "committedDate": "2020-06-09T00:49:23Z", "message": "Add session property to disable warnings, or treat warnings as errors"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bd38273d6dbadb06e5110bb5b00fad90d7c6364f", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/bd38273d6dbadb06e5110bb5b00fad90d7c6364f", "committedDate": "2020-06-09T00:29:39Z", "message": "Add session property to disable warnings, or treat warnings as errors"}, "afterCommit": {"oid": "4bee6284555fa0e74423f58bdb3c0fe828e6f347", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/4bee6284555fa0e74423f58bdb3c0fe828e6f347", "committedDate": "2020-06-09T00:49:23Z", "message": "Add session property to disable warnings, or treat warnings as errors"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1769, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}