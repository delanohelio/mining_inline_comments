{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA2MTEwNDM3", "number": 15332, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxODoyMzo0OVrOEv620Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNVQyMDoyMjo0NlrOExsjOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4NjgyODMzOnYy", "diffSide": "LEFT", "path": "presto-druid/src/main/java/com/facebook/presto/druid/DruidBrokerPageSource.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxODoyMzo0OVrOHlLTfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxODozODowMFrOHnZaoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc0NDU3NQ==", "bodyText": "Sometimes the error message might be helpful.  But looks like each row is an json object now, we cannot use the if condition 'rootNode instanceof ObjectNode',  can we somehow keep the logic of extracting the error message?", "url": "https://github.com/prestodb/presto/pull/15332#discussion_r508744575", "createdAt": "2020-10-20T18:23:49Z", "author": {"login": "beinan"}, "path": "presto-druid/src/main/java/com/facebook/presto/druid/DruidBrokerPageSource.java", "diffHunk": "@@ -123,17 +121,10 @@ public Page getNextPage()\n                 }\n                 else {\n                     JsonNode rootNode = OBJECT_MAPPER.readTree(readLine);\n-                    if (!(rootNode instanceof ArrayNode)) {\n-                        if (rootNode instanceof ObjectNode) {\n-                            throw new PrestoException(DRUID_BROKER_RESULT_ERROR, ((ObjectNode) rootNode).findValue(\"errorMessage\").asText());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8da28e0105fb8123011fa7dc2bc190e62632df85"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgwMzIxMA==", "bodyText": "I have similar feeling with @beinan could we extract error message?", "url": "https://github.com/prestodb/presto/pull/15332#discussion_r508803210", "createdAt": "2020-10-20T20:02:06Z", "author": {"login": "zhenxiao"}, "path": "presto-druid/src/main/java/com/facebook/presto/druid/DruidBrokerPageSource.java", "diffHunk": "@@ -123,17 +121,10 @@ public Page getNextPage()\n                 }\n                 else {\n                     JsonNode rootNode = OBJECT_MAPPER.readTree(readLine);\n-                    if (!(rootNode instanceof ArrayNode)) {\n-                        if (rootNode instanceof ObjectNode) {\n-                            throw new PrestoException(DRUID_BROKER_RESULT_ERROR, ((ObjectNode) rootNode).findValue(\"errorMessage\").asText());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc0NDU3NQ=="}, "originalCommit": {"oid": "8da28e0105fb8123011fa7dc2bc190e62632df85"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTkyNDEwMA==", "bodyText": "@beinan @zhenxiao\nI agree, how about checking if the error rootNode has errorMessage filed and column handles doesn't contain the field at the same time. If so, we raise the exception with the errorMessage.", "url": "https://github.com/prestodb/presto/pull/15332#discussion_r509924100", "createdAt": "2020-10-22T07:01:56Z", "author": {"login": "adlymousa"}, "path": "presto-druid/src/main/java/com/facebook/presto/druid/DruidBrokerPageSource.java", "diffHunk": "@@ -123,17 +121,10 @@ public Page getNextPage()\n                 }\n                 else {\n                     JsonNode rootNode = OBJECT_MAPPER.readTree(readLine);\n-                    if (!(rootNode instanceof ArrayNode)) {\n-                        if (rootNode instanceof ObjectNode) {\n-                            throw new PrestoException(DRUID_BROKER_RESULT_ERROR, ((ObjectNode) rootNode).findValue(\"errorMessage\").asText());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc0NDU3NQ=="}, "originalCommit": {"oid": "8da28e0105fb8123011fa7dc2bc190e62632df85"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDM4MzI0Ng==", "bodyText": "sure. go ahead", "url": "https://github.com/prestodb/presto/pull/15332#discussion_r510383246", "createdAt": "2020-10-22T18:49:41Z", "author": {"login": "zhenxiao"}, "path": "presto-druid/src/main/java/com/facebook/presto/druid/DruidBrokerPageSource.java", "diffHunk": "@@ -123,17 +121,10 @@ public Page getNextPage()\n                 }\n                 else {\n                     JsonNode rootNode = OBJECT_MAPPER.readTree(readLine);\n-                    if (!(rootNode instanceof ArrayNode)) {\n-                        if (rootNode instanceof ObjectNode) {\n-                            throw new PrestoException(DRUID_BROKER_RESULT_ERROR, ((ObjectNode) rootNode).findValue(\"errorMessage\").asText());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc0NDU3NQ=="}, "originalCommit": {"oid": "8da28e0105fb8123011fa7dc2bc190e62632df85"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA3MjkyOQ==", "bodyText": "@beinan @zhenxiao\nI agree, how about checking if the error rootNode has errorMessage filed and column handles doesn't contain the field at the same time. If so, we raise the exception with the errorMessage.\n\nsounds good to me, it would be a good solution. Thanks!", "url": "https://github.com/prestodb/presto/pull/15332#discussion_r511072929", "createdAt": "2020-10-23T18:38:00Z", "author": {"login": "beinan"}, "path": "presto-druid/src/main/java/com/facebook/presto/druid/DruidBrokerPageSource.java", "diffHunk": "@@ -123,17 +121,10 @@ public Page getNextPage()\n                 }\n                 else {\n                     JsonNode rootNode = OBJECT_MAPPER.readTree(readLine);\n-                    if (!(rootNode instanceof ArrayNode)) {\n-                        if (rootNode instanceof ObjectNode) {\n-                            throw new PrestoException(DRUID_BROKER_RESULT_ERROR, ((ObjectNode) rootNode).findValue(\"errorMessage\").asText());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc0NDU3NQ=="}, "originalCommit": {"oid": "8da28e0105fb8123011fa7dc2bc190e62632df85"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwNTQ1NTczOnYy", "diffSide": "RIGHT", "path": "presto-druid/src/main/java/com/facebook/presto/druid/DruidBrokerPageSource.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNVQyMDoyMjoxOFrOHn8Qpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNVQyMDoyMjoxOFrOHn8Qpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTY0MzgxNQ==", "bodyText": "do we need to keep columnHandlesHasErrorMessageField? how about we inline it in getNextPage()", "url": "https://github.com/prestodb/presto/pull/15332#discussion_r511643815", "createdAt": "2020-10-25T20:22:18Z", "author": {"login": "zhenxiao"}, "path": "presto-druid/src/main/java/com/facebook/presto/druid/DruidBrokerPageSource.java", "diffHunk": "@@ -79,6 +78,8 @@ public DruidBrokerPageSource(\n                 .map(DruidColumnHandle::getColumnType)\n                 .collect(toImmutableList());\n         this.pageBuilder = new PageBuilder(this.columnTypes);\n+        this.columnHandlesHasErrorMessageField = columnHandles.stream().anyMatch(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4390e42bbea338d3cbdf606ba65f255afc549916"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwNTQ1NTkyOnYy", "diffSide": "RIGHT", "path": "presto-druid/src/main/java/com/facebook/presto/druid/DruidBrokerPageSource.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNVQyMDoyMjo0NlrOHn8Qxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNVQyMDoyMjo0NlrOHn8Qxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTY0Mzg0Nw==", "bodyText": "inline columnHandlesHasErrorMessageField, instead of keeping a private member.", "url": "https://github.com/prestodb/presto/pull/15332#discussion_r511643847", "createdAt": "2020-10-25T20:22:46Z", "author": {"login": "zhenxiao"}, "path": "presto-druid/src/main/java/com/facebook/presto/druid/DruidBrokerPageSource.java", "diffHunk": "@@ -123,17 +124,13 @@ public Page getNextPage()\n                 }\n                 else {\n                     JsonNode rootNode = OBJECT_MAPPER.readTree(readLine);\n-                    if (!(rootNode instanceof ArrayNode)) {\n-                        if (rootNode instanceof ObjectNode) {\n-                            throw new PrestoException(DRUID_BROKER_RESULT_ERROR, ((ObjectNode) rootNode).findValue(\"errorMessage\").asText());\n-                        }\n-                        throw new PrestoException(DRUID_BROKER_RESULT_ERROR, rootNode.toString());\n+                    if (rootNode.has(\"errorMessage\") && !columnHandlesHasErrorMessageField) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4390e42bbea338d3cbdf606ba65f255afc549916"}, "originalPosition": 35}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3542, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}