{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY3NTM4ODE2", "number": 14016, "title": "Add task memory related session properties ", "bodyText": "query_max_total_memory_per_node  is required for a specific memory constrained use cases. query_max_memory_per_node is added for completeness.\n== RELEASE NOTES ==\n\nGeneral Changes\n* Added query_max_total_memory_per_node and query_max_memory_per_node session properties", "createdAt": "2020-01-27T15:00:30Z", "url": "https://github.com/prestodb/presto/pull/14016", "merged": true, "mergeCommit": {"oid": "fc3d1ee6580ea2cffc495de0fdc357e966564001"}, "closed": true, "closedAt": "2020-01-30T14:48:42Z", "author": {"login": "aweisberg"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb-fMbeABqjI5ODI0NTUwMzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb_NSt1AFqTM1MDQ1NTcyOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a88b5085cc782b38e85e606b968509540e6a3c89", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/a88b5085cc782b38e85e606b968509540e6a3c89", "committedDate": "2020-01-27T14:57:07Z", "message": "Add query_max_task_memory and query_max_total_task_memory session properties"}, "afterCommit": {"oid": "fa0526cc86c1203038ae8f03ee47150a5bc92c8e", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/fa0526cc86c1203038ae8f03ee47150a5bc92c8e", "committedDate": "2020-01-27T16:18:34Z", "message": "Add query_max_task_memory and query_max_total_task_memory session properties"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fa0526cc86c1203038ae8f03ee47150a5bc92c8e", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/fa0526cc86c1203038ae8f03ee47150a5bc92c8e", "committedDate": "2020-01-27T16:18:34Z", "message": "Add query_max_task_memory and query_max_total_task_memory session properties"}, "afterCommit": {"oid": "67c3e9ae498c26c487fa1315ec8708b2f648fde0", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/67c3e9ae498c26c487fa1315ec8708b2f648fde0", "committedDate": "2020-01-27T20:04:42Z", "message": "Add query_max_task_memory and query_max_total_task_memory session properties"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "67c3e9ae498c26c487fa1315ec8708b2f648fde0", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/67c3e9ae498c26c487fa1315ec8708b2f648fde0", "committedDate": "2020-01-27T20:04:42Z", "message": "Add query_max_task_memory and query_max_total_task_memory session properties"}, "afterCommit": {"oid": "85c62da18851aab989dfc5b3687435fc3d734a4a", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/85c62da18851aab989dfc5b3687435fc3d734a4a", "committedDate": "2020-01-27T20:33:58Z", "message": "Add task memory related session properties\n\nAdd query_max_task_memory and query_max_total_task_memory session properties"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "85c62da18851aab989dfc5b3687435fc3d734a4a", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/85c62da18851aab989dfc5b3687435fc3d734a4a", "committedDate": "2020-01-27T20:33:58Z", "message": "Add task memory related session properties\n\nAdd query_max_task_memory and query_max_total_task_memory session properties"}, "afterCommit": {"oid": "9b4dc187f8b8d08ff26da74e45ef10619ab2516a", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/9b4dc187f8b8d08ff26da74e45ef10619ab2516a", "committedDate": "2020-01-27T20:38:29Z", "message": "Add task memory related session properties\n\nAdd query_max_task_memory and query_max_total_task_memory session\nproperties"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5NDM0MzY0", "url": "https://github.com/prestodb/presto/pull/14016#pullrequestreview-349434364", "createdAt": "2020-01-28T14:50:57Z", "commit": {"oid": "9b4dc187f8b8d08ff26da74e45ef10619ab2516a"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxNDo1MDo1OFrOFin1ig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxNTowNjo1MVrOFiod2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTg0ODU4Ng==", "bodyText": "static import both", "url": "https://github.com/prestodb/presto/pull/14016#discussion_r371848586", "createdAt": "2020-01-28T14:50:58Z", "author": {"login": "arhimondr"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/SqlTaskManager.java", "diffHunk": "@@ -377,6 +378,12 @@ public TaskInfo updateTask(\n             // TODO: This should have been done when the QueryContext was created. However, the session isn't available at that point.\n             queryContexts.getUnchecked(taskId.getQueryId()).setResourceOvercommit();\n         }\n+        else {\n+            queryContexts.getUnchecked(\n+                    taskId.getQueryId()).setMemoryLimits(\n+                    SystemSessionProperties.getQueryMaxTaskMemory(session),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b4dc187f8b8d08ff26da74e45ef10619ab2516a"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTg0OTU1Mg==", "bodyText": "Ideally the memory limits should be set when the QueryContext is created. Fundamentally it is never created when the session is not available. Setting it here is confusing, and potentially error prone, as the memory limits could be lost in a hypothetical situation when updateTask is never called.\nIt feels like the entire SqlTaskManager has to be refactored. The TaskContext / QueryContext should be aware of the session at the moment of creation.\nAdditionaly the ResourceOvercommit feature should probably be removed (CC: @nezihyigitbasi ?)", "url": "https://github.com/prestodb/presto/pull/14016#discussion_r371849552", "createdAt": "2020-01-28T14:52:26Z", "author": {"login": "arhimondr"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/SqlTaskManager.java", "diffHunk": "@@ -377,6 +378,12 @@ public TaskInfo updateTask(\n             // TODO: This should have been done when the QueryContext was created. However, the session isn't available at that point.\n             queryContexts.getUnchecked(taskId.getQueryId()).setResourceOvercommit();\n         }\n+        else {\n+            queryContexts.getUnchecked(\n+                    taskId.getQueryId()).setMemoryLimits(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b4dc187f8b8d08ff26da74e45ef10619ab2516a"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTg1ODkwNw==", "bodyText": "wrap new QueryManagerConfig().\nWe prefer either one of the style\ndoSomethign(parameter1, parameter2)\n\nor\ndoSomethign(\n  parameter1, \n  parameter2)\n\nWe are trying to avoid the\ndoSomethign(parameter1, \n  parameter2)\n\nstyle across the codebase", "url": "https://github.com/prestodb/presto/pull/14016#discussion_r371858907", "createdAt": "2020-01-28T15:06:51Z", "author": {"login": "arhimondr"}, "path": "presto-main/src/main/java/com/facebook/presto/testing/LocalQueryRunner.java", "diffHunk": "@@ -334,7 +335,11 @@ private LocalQueryRunner(Session defaultSession, FeaturesConfig featuresConfig,\n                 featuresConfig,\n                 typeRegistry,\n                 blockEncodingManager,\n-                new SessionPropertyManager(new SystemSessionProperties(new QueryManagerConfig(), new TaskManagerConfig(), new MemoryManagerConfig(), featuresConfig)),\n+                new SessionPropertyManager(new SystemSessionProperties(new QueryManagerConfig(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b4dc187f8b8d08ff26da74e45ef10619ab2516a"}, "originalPosition": 13}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9b4dc187f8b8d08ff26da74e45ef10619ab2516a", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/9b4dc187f8b8d08ff26da74e45ef10619ab2516a", "committedDate": "2020-01-27T20:38:29Z", "message": "Add task memory related session properties\n\nAdd query_max_task_memory and query_max_total_task_memory session\nproperties"}, "afterCommit": {"oid": "5e16e152821f037c23c7159ae640ed410d4913da", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/5e16e152821f037c23c7159ae640ed410d4913da", "committedDate": "2020-01-28T17:21:15Z", "message": "Add task memory related session properties\n\nAdd query_max_task_memory and query_max_total_task_memory session\nproperties"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5e16e152821f037c23c7159ae640ed410d4913da", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/5e16e152821f037c23c7159ae640ed410d4913da", "committedDate": "2020-01-28T17:21:15Z", "message": "Add task memory related session properties\n\nAdd query_max_task_memory and query_max_total_task_memory session\nproperties"}, "afterCommit": {"oid": "5b9d5deb4a6070936aaf2bd1e11a0e739ef67222", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/5b9d5deb4a6070936aaf2bd1e11a0e739ef67222", "committedDate": "2020-01-28T17:43:06Z", "message": "Add task memory related session properties\n\nAdd query_max_task_memory and query_max_total_task_memory session\nproperties"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5b9d5deb4a6070936aaf2bd1e11a0e739ef67222", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/5b9d5deb4a6070936aaf2bd1e11a0e739ef67222", "committedDate": "2020-01-28T17:43:06Z", "message": "Add task memory related session properties\n\nAdd query_max_task_memory and query_max_total_task_memory session\nproperties"}, "afterCommit": {"oid": "49288801db526dddc4b3f4d39b5a53c15018498a", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/49288801db526dddc4b3f4d39b5a53c15018498a", "committedDate": "2020-01-28T23:14:57Z", "message": "Add task memory related session properties\n\nAdd query_max_task_memory and query_max_total_task_memory session\nproperties"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5Nzg3MTMw", "url": "https://github.com/prestodb/presto/pull/14016#pullrequestreview-349787130", "createdAt": "2020-01-28T23:57:08Z", "commit": {"oid": "49288801db526dddc4b3f4d39b5a53c15018498a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQyMzo1NzowOVrOFi4t6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQyMzo1NzowOVrOFi4t6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjEyNTE2Mw==", "bodyText": "do we want to mention task here? or just\nMaximum amount of total (user + system) memory a query can use", "url": "https://github.com/prestodb/presto/pull/14016#discussion_r372125163", "createdAt": "2020-01-28T23:57:09Z", "author": {"login": "swapsmagic"}, "path": "presto-main/src/main/java/com/facebook/presto/SystemSessionProperties.java", "diffHunk": "@@ -352,6 +365,15 @@ public SystemSessionProperties(\n                         true,\n                         value -> DataSize.valueOf((String) value),\n                         DataSize::toString),\n+                new PropertyMetadata<>(\n+                        QUERY_MAX_TOTAL_MEMORY_PER_NODE,\n+                        \"Maximum amount of total (user + system) task memory a query can use\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49288801db526dddc4b3f4d39b5a53c15018498a"}, "originalPosition": 59}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwMzI0NTk3", "url": "https://github.com/prestodb/presto/pull/14016#pullrequestreview-350324597", "createdAt": "2020-01-29T18:21:52Z", "commit": {"oid": "49288801db526dddc4b3f4d39b5a53c15018498a"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwMzU5ODE5", "url": "https://github.com/prestodb/presto/pull/14016#pullrequestreview-350359819", "createdAt": "2020-01-29T19:17:18Z", "commit": {"oid": "49288801db526dddc4b3f4d39b5a53c15018498a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "49288801db526dddc4b3f4d39b5a53c15018498a", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/49288801db526dddc4b3f4d39b5a53c15018498a", "committedDate": "2020-01-28T23:14:57Z", "message": "Add task memory related session properties\n\nAdd query_max_task_memory and query_max_total_task_memory session\nproperties"}, "afterCommit": {"oid": "dc97d4d86b57d7e681a05a2fc1702a79bdaa6b12", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/dc97d4d86b57d7e681a05a2fc1702a79bdaa6b12", "committedDate": "2020-01-29T21:28:01Z", "message": "Add task memory related session properties\n\nAdd query_max_task_memory and query_max_total_task_memory session\nproperties"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd50167f321f1e89f1c928e4a14f235ec36d038b", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/cd50167f321f1e89f1c928e4a14f235ec36d038b", "committedDate": "2020-01-29T21:30:45Z", "message": "Add task memory related session properties\n\nAdd query_max_task_memory and query_max_total_task_memory session\nproperties"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dc97d4d86b57d7e681a05a2fc1702a79bdaa6b12", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/dc97d4d86b57d7e681a05a2fc1702a79bdaa6b12", "committedDate": "2020-01-29T21:28:01Z", "message": "Add task memory related session properties\n\nAdd query_max_task_memory and query_max_total_task_memory session\nproperties"}, "afterCommit": {"oid": "cd50167f321f1e89f1c928e4a14f235ec36d038b", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/cd50167f321f1e89f1c928e4a14f235ec36d038b", "committedDate": "2020-01-29T21:30:45Z", "message": "Add task memory related session properties\n\nAdd query_max_task_memory and query_max_total_task_memory session\nproperties"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwNDU1NzI4", "url": "https://github.com/prestodb/presto/pull/14016#pullrequestreview-350455728", "createdAt": "2020-01-29T22:01:22Z", "commit": {"oid": "cd50167f321f1e89f1c928e4a14f235ec36d038b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2510, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}