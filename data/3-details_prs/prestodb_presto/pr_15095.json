{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc1NTk4MDYz", "number": 15095, "title": "Implement pass through mode UNION ALL on Presto-on-Spark", "bodyText": "Extract pass through mode commit from #14999\n== NO RELEASE NOTE ==", "createdAt": "2020-08-28T19:16:43Z", "url": "https://github.com/prestodb/presto/pull/15095", "merged": true, "mergeCommit": {"oid": "d57bbfda5fcf839246e169a134c44947a768dbda"}, "closed": true, "closedAt": "2020-09-23T20:33:01Z", "author": {"login": "viczhang861"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdEUahQAFqTQ3ODcwNjYyMA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLxgfFABqjM3OTk2NTE2ODg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4NzA2NjIw", "url": "https://github.com/prestodb/presto/pull/15095#pullrequestreview-478706620", "createdAt": "2020-08-31T15:17:29Z", "commit": {"oid": "540dd0a6d5e93c36cace99a59929f3ba010219ca"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNToxNzozMFrOHJ9FyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNToxOToyNlrOHJ9KVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDIwMDEzNg==", "bodyText": "Do you think at this point we can simply remove the prefer-distributed-union property? As it was added as a hack originally.\nCC: @wenleix", "url": "https://github.com/prestodb/presto/pull/15095#discussion_r480200136", "createdAt": "2020-08-31T15:17:30Z", "author": {"login": "arhimondr"}, "path": "presto-spark-base/src/test/java/com/facebook/presto/spark/PrestoSparkQueryRunner.java", "diffHunk": "@@ -204,7 +204,7 @@ public PrestoSparkQueryRunner(String defaultCatalog)\n                 ImmutableMap.of(\n                         \"presto.version\", \"testversion\",\n                         \"query.hash-partition-count\", Integer.toString(NODE_COUNT * 2),\n-                        \"prefer-distributed-union\", \"false\"),\n+                        \"prefer-distributed-union\", \"true\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "540dd0a6d5e93c36cace99a59929f3ba010219ca"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDIwMTMwMw==", "bodyText": "This looks a little bit like a hack. Should we set it to real number of the output partitions (hashPartitionCount)?", "url": "https://github.com/prestodb/presto/pull/15095#discussion_r480201303", "createdAt": "2020-08-31T15:19:26Z", "author": {"login": "arhimondr"}, "path": "presto-spark-base/src/main/java/com/facebook/presto/spark/execution/PrestoSparkRowOutputOperator.java", "diffHunk": "@@ -107,6 +123,31 @@ public int getPartition(Page page, int position)\n         }\n     }\n \n+    private static class PreDeterminedPartitionFunction\n+            implements PartitionFunction\n+    {\n+        private final int partitionId;\n+\n+        public PreDeterminedPartitionFunction(int partitionId)\n+        {\n+            this.partitionId = partitionId;\n+        }\n+\n+        @Override\n+        public int getPartitionCount()\n+        {\n+            // To be compatible with RowIndex in PrestoSparkRowBatchBuilder\n+            // where RowIndex requires an array size of at least partitionId + 1\n+            return partitionId + 1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "540dd0a6d5e93c36cace99a59929f3ba010219ca"}, "originalPosition": 59}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "540dd0a6d5e93c36cace99a59929f3ba010219ca", "author": {"user": {"login": "viczhang861", "name": "Vic Zhang"}}, "url": "https://github.com/prestodb/presto/commit/540dd0a6d5e93c36cace99a59929f3ba010219ca", "committedDate": "2020-08-28T19:12:37Z", "message": "Implement pass through mode UNION ALL on Presto-on-Spark\n\nInstead of round robin shuffle at row level for UNION ALL, all rows on\nthe same partition are passed through current partition and sent to\nnext fragment where partition id is determined by a modular hash\nfunction."}, "afterCommit": {"oid": "f6dedf84e1fe0815f8059d2ac4ca2d1f7357f814", "author": {"user": {"login": "viczhang861", "name": "Vic Zhang"}}, "url": "https://github.com/prestodb/presto/commit/f6dedf84e1fe0815f8059d2ac4ca2d1f7357f814", "committedDate": "2020-08-31T19:26:25Z", "message": "Implement pass through mode UNION ALL on Presto-on-Spark\n\nInstead of round robin shuffle at row level for UNION ALL, all rows on\nthe same partition are passed through current partition and sent to\nnext fragment where partition id is determined by a modular hash\nfunction."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f6dedf84e1fe0815f8059d2ac4ca2d1f7357f814", "author": {"user": {"login": "viczhang861", "name": "Vic Zhang"}}, "url": "https://github.com/prestodb/presto/commit/f6dedf84e1fe0815f8059d2ac4ca2d1f7357f814", "committedDate": "2020-08-31T19:26:25Z", "message": "Implement pass through mode UNION ALL on Presto-on-Spark\n\nInstead of round robin shuffle at row level for UNION ALL, all rows on\nthe same partition are passed through current partition and sent to\nnext fragment where partition id is determined by a modular hash\nfunction."}, "afterCommit": {"oid": "765b1e63cbf56ce73490c701cfd7cf71f2440b80", "author": {"user": {"login": "viczhang861", "name": "Vic Zhang"}}, "url": "https://github.com/prestodb/presto/commit/765b1e63cbf56ce73490c701cfd7cf71f2440b80", "committedDate": "2020-08-31T21:13:38Z", "message": "Implement pass through mode UNION ALL on Presto-on-Spark\n\nInstead of round robin shuffle at row level for UNION ALL, all rows on\nthe same partition are passed through current partition and sent to\nnext fragment where partition id is determined by a modular hash\nfunction."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4OTcyMzEw", "url": "https://github.com/prestodb/presto/pull/15095#pullrequestreview-478972310", "createdAt": "2020-08-31T21:36:04Z", "commit": {"oid": "765b1e63cbf56ce73490c701cfd7cf71f2440b80"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMTozNjowNFrOHKKFHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMTozNjoyMVrOHKKFsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQxMjk1OA==", "bodyText": "Let's simply remove this override", "url": "https://github.com/prestodb/presto/pull/15095#discussion_r480412958", "createdAt": "2020-08-31T21:36:04Z", "author": {"login": "arhimondr"}, "path": "presto-spark-testing/src/test/java/com/facebook/presto/spark/testing/TestPrestoSparkLauncherIntegrationSmokeTest.java", "diffHunk": "@@ -148,7 +148,7 @@ public void setUp()\n         configProperties = new File(tempDir, \"config.properties\");\n         storeProperties(configProperties, ImmutableMap.of(\n                 \"query.hash-partition-count\", \"10\",\n-                \"prefer-distributed-union\", \"false\"));\n+                \"prefer-distributed-union\", \"true\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "765b1e63cbf56ce73490c701cfd7cf71f2440b80"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQxMzEwNg==", "bodyText": "Let's simply remove this override (since it is default now)", "url": "https://github.com/prestodb/presto/pull/15095#discussion_r480413106", "createdAt": "2020-08-31T21:36:21Z", "author": {"login": "arhimondr"}, "path": "presto-spark-base/src/test/java/com/facebook/presto/spark/PrestoSparkQueryRunner.java", "diffHunk": "@@ -204,7 +204,7 @@ public PrestoSparkQueryRunner(String defaultCatalog)\n                 ImmutableMap.of(\n                         \"presto.version\", \"testversion\",\n                         \"query.hash-partition-count\", Integer.toString(NODE_COUNT * 2),\n-                        \"prefer-distributed-union\", \"false\"),\n+                        \"prefer-distributed-union\", \"true\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "765b1e63cbf56ce73490c701cfd7cf71f2440b80"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "765b1e63cbf56ce73490c701cfd7cf71f2440b80", "author": {"user": {"login": "viczhang861", "name": "Vic Zhang"}}, "url": "https://github.com/prestodb/presto/commit/765b1e63cbf56ce73490c701cfd7cf71f2440b80", "committedDate": "2020-08-31T21:13:38Z", "message": "Implement pass through mode UNION ALL on Presto-on-Spark\n\nInstead of round robin shuffle at row level for UNION ALL, all rows on\nthe same partition are passed through current partition and sent to\nnext fragment where partition id is determined by a modular hash\nfunction."}, "afterCommit": {"oid": "5867c3760d974645f9ec0076f2a933bad85a360a", "author": {"user": {"login": "viczhang861", "name": "Vic Zhang"}}, "url": "https://github.com/prestodb/presto/commit/5867c3760d974645f9ec0076f2a933bad85a360a", "committedDate": "2020-08-31T21:39:33Z", "message": "Implement pass through mode UNION ALL on Presto-on-Spark\n\nInstead of round robin shuffle at row level for UNION ALL, all rows on\nthe same partition are passed through current partition and sent to\nnext fragment where partition id is determined by a modular hash\nfunction."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0ODY4ODkw", "url": "https://github.com/prestodb/presto/pull/15095#pullrequestreview-494868890", "createdAt": "2020-09-23T17:03:43Z", "commit": {"oid": "5867c3760d974645f9ec0076f2a933bad85a360a"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxNzowMzo0M1rOHW4KXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxNzowMzo0M1rOHW4KXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc1MDg3Nw==", "bodyText": "nit: maybe add a check state about partitionId < partitionCount?", "url": "https://github.com/prestodb/presto/pull/15095#discussion_r493750877", "createdAt": "2020-09-23T17:03:43Z", "author": {"login": "wenleix"}, "path": "presto-spark-base/src/main/java/com/facebook/presto/spark/execution/PrestoSparkRowOutputOperator.java", "diffHunk": "@@ -107,6 +113,31 @@ public int getPartition(Page page, int position)\n         }\n     }\n \n+    public static class PreDeterminedPartitionFunction\n+            implements PartitionFunction\n+    {\n+        private final int partitionId;\n+        private final int partitionCount;\n+\n+        public PreDeterminedPartitionFunction(int partitionId, int partitionCount)\n+        {\n+            this.partitionId = partitionId;\n+            this.partitionCount = partitionCount;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5867c3760d974645f9ec0076f2a933bad85a360a"}, "originalPosition": 43}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5867c3760d974645f9ec0076f2a933bad85a360a", "author": {"user": {"login": "viczhang861", "name": "Vic Zhang"}}, "url": "https://github.com/prestodb/presto/commit/5867c3760d974645f9ec0076f2a933bad85a360a", "committedDate": "2020-08-31T21:39:33Z", "message": "Implement pass through mode UNION ALL on Presto-on-Spark\n\nInstead of round robin shuffle at row level for UNION ALL, all rows on\nthe same partition are passed through current partition and sent to\nnext fragment where partition id is determined by a modular hash\nfunction."}, "afterCommit": {"oid": "e39525a3dc2c87d246744e899c39c179b42809b3", "author": {"user": {"login": "viczhang861", "name": "Vic Zhang"}}, "url": "https://github.com/prestodb/presto/commit/e39525a3dc2c87d246744e899c39c179b42809b3", "committedDate": "2020-09-23T18:54:49Z", "message": "Implement pass through mode UNION ALL on Presto-on-Spark\n\nInstead of round robin shuffle at row level for UNION ALL, all rows on\nthe same partition are passed through current partition and sent to\nnext fragment where partition id is determined by a modular hash\nfunction."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62b150a97c7f8cf5105a61acecae1589c6c76370", "author": {"user": {"login": "viczhang861", "name": "Vic Zhang"}}, "url": "https://github.com/prestodb/presto/commit/62b150a97c7f8cf5105a61acecae1589c6c76370", "committedDate": "2020-09-23T19:10:53Z", "message": "Implement pass through mode UNION ALL on Presto-on-Spark\n\nInstead of round robin shuffle at row level for UNION ALL, all rows on\nthe same partition are passed through current partition and sent to\nnext fragment where partition id is determined by a modular hash\nfunction."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e39525a3dc2c87d246744e899c39c179b42809b3", "author": {"user": {"login": "viczhang861", "name": "Vic Zhang"}}, "url": "https://github.com/prestodb/presto/commit/e39525a3dc2c87d246744e899c39c179b42809b3", "committedDate": "2020-09-23T18:54:49Z", "message": "Implement pass through mode UNION ALL on Presto-on-Spark\n\nInstead of round robin shuffle at row level for UNION ALL, all rows on\nthe same partition are passed through current partition and sent to\nnext fragment where partition id is determined by a modular hash\nfunction."}, "afterCommit": {"oid": "62b150a97c7f8cf5105a61acecae1589c6c76370", "author": {"user": {"login": "viczhang861", "name": "Vic Zhang"}}, "url": "https://github.com/prestodb/presto/commit/62b150a97c7f8cf5105a61acecae1589c6c76370", "committedDate": "2020-09-23T19:10:53Z", "message": "Implement pass through mode UNION ALL on Presto-on-Spark\n\nInstead of round robin shuffle at row level for UNION ALL, all rows on\nthe same partition are passed through current partition and sent to\nnext fragment where partition id is determined by a modular hash\nfunction."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 27, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}