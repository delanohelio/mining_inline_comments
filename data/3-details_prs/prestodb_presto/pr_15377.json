{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEyODQyNDQ2", "number": 15377, "title": "Use more efficient getApproximateLogicalSizeInBytes in OrcWriter", "bodyText": "OrcWriter.estimateAverageLogicalSizePerRow has the top memory allocation\nin some KDS pipeline. Since the original code was to estimate the page's\nlogical size and do not require accurate size to be calculated, this\ncommit changes the call of the expensive getLogicalSizeInBytes method to\na much faster and memory friendly method getApproximateLogicalSizeInBytes\nthat estimate the approximate logical size of a page.\n== NO RELEASE NOTE ==", "createdAt": "2020-10-30T08:37:51Z", "url": "https://github.com/prestodb/presto/pull/15377", "merged": true, "mergeCommit": {"oid": "6d665b4a1dea06946ffa8a5dd3cc1e7b53f2ea08"}, "closed": true, "closedAt": "2020-11-02T22:17:12Z", "author": {"login": "yingsu00"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXuCkeABqjM5NDMyNzI0OTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdYsFOigFqTUyMjA0MjU0MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "235e4d6a1460bfb41d3ba2c6651caae721ed1d91", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/235e4d6a1460bfb41d3ba2c6651caae721ed1d91", "committedDate": "2020-10-30T08:29:37Z", "message": "Use more efficient getApproximateLogicalSizeInBytes in OrcWriter\n\nOrcWriter.estimateAverageLogicalSizePerRow has the top memory allocation\nin some KDS pipeline. Since the original code was to estimate the page's\nlogical size and do not require accurate size to be calculated, this\ncommit changes the call of the expensive getLogicalSizeInBytes method to\na much faster and momory friendly method getApproximateLogicalSizeInBytes\nthat estimate the approximate logical size of a page."}, "afterCommit": {"oid": "12173d1d8ddd88821d3fb6aea1c998ef0e76db44", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/12173d1d8ddd88821d3fb6aea1c998ef0e76db44", "committedDate": "2020-10-30T21:54:57Z", "message": "Use more efficient getApproximateLogicalSizeInBytes in OrcWriter\n\nOrcWriter.estimateAverageLogicalSizePerRow has the top memory allocation\nin some KDS pipeline. Since the original code was to estimate the page's\nlogical size and do not require accurate size to be calculated, this\ncommit changes the call of the expensive getLogicalSizeInBytes method to\na much faster and momory friendly method getApproximateLogicalSizeInBytes\nthat estimate the approximate logical size of a page."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxMDczOTUz", "url": "https://github.com/prestodb/presto/pull/15377#pullrequestreview-521073953", "createdAt": "2020-10-30T22:46:10Z", "commit": {"oid": "12173d1d8ddd88821d3fb6aea1c998ef0e76db44"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQyMjo0NjoxMVrOHriV_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQyMjo0NjoxMVrOHriV_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQxMzUwMg==", "bodyText": "There are two changes here.\n\nCall approximate logical size, which is faster then getLogicalSizeInBytes()\nCalculate whole page, which may be slower\n\nHave you considered to not calculating the whole page by adding a function page.getApproximateRegionLogicalSizeInBytes(position = 0, length = 100) ? I am not sure how faster it would be, however it guarantees there will be no regression due to calculating the whole page.", "url": "https://github.com/prestodb/presto/pull/15377#discussion_r515413502", "createdAt": "2020-10-30T22:46:11Z", "author": {"login": "viczhang861"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/OrcWriter.java", "diffHunk": "@@ -309,8 +309,7 @@ public void write(Page page)\n         }\n \n         // avoid chunk with huge logical size\n-        int averageLogicalSizePerRow = estimateAverageLogicalSizePerRow(page);\n-        int maxChunkRowCount = max(1, chunkMaxLogicalBytes / max(1, averageLogicalSizePerRow));\n+        int maxChunkRowCount = toIntExact(max(1, chunkMaxLogicalBytes / max(1, page.getApproximateLogicalSizeInBytes() / page.getPositionCount())));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12173d1d8ddd88821d3fb6aea1c998ef0e76db44"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxMTAyMDAx", "url": "https://github.com/prestodb/presto/pull/15377#pullrequestreview-521102001", "createdAt": "2020-10-31T01:36:33Z", "commit": {"oid": "12173d1d8ddd88821d3fb6aea1c998ef0e76db44"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "12173d1d8ddd88821d3fb6aea1c998ef0e76db44", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/12173d1d8ddd88821d3fb6aea1c998ef0e76db44", "committedDate": "2020-10-30T21:54:57Z", "message": "Use more efficient getApproximateLogicalSizeInBytes in OrcWriter\n\nOrcWriter.estimateAverageLogicalSizePerRow has the top memory allocation\nin some KDS pipeline. Since the original code was to estimate the page's\nlogical size and do not require accurate size to be calculated, this\ncommit changes the call of the expensive getLogicalSizeInBytes method to\na much faster and momory friendly method getApproximateLogicalSizeInBytes\nthat estimate the approximate logical size of a page."}, "afterCommit": {"oid": "f06c5b76217ca66e0ef06c324551f52d796cfa16", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/f06c5b76217ca66e0ef06c324551f52d796cfa16", "committedDate": "2020-10-31T04:40:23Z", "message": "Use more efficient getApproximateLogicalSizeInBytes in OrcWriter\n\nOrcWriter.estimateAverageLogicalSizePerRow has the top memory allocation\nin some KDS pipeline. Since the original code was to estimate the page's\nlogical size and do not require accurate size to be calculated, this\ncommit changes the call of the expensive getLogicalSizeInBytes method to\na much faster and momory friendly method getApproximateLogicalSizeInBytes\nthat estimate the approximate logical size of a page."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a95f537327e5cbb7bef202c558d3fb010781826a", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/a95f537327e5cbb7bef202c558d3fb010781826a", "committedDate": "2020-10-31T07:06:20Z", "message": "Use more efficient getApproximateLogicalSizeInBytes in OrcWriter\n\nOrcWriter.estimateAverageLogicalSizePerRow has the top memory allocation\nin some KDS pipeline. Since the original code was to estimate the page's\nlogical size and do not require accurate size to be calculated, this\ncommit changes the call of the expensive getLogicalSizeInBytes method to\na much faster and momory friendly method getApproximateLogicalSizeInBytes\nthat estimate the approximate logical size of a page."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f06c5b76217ca66e0ef06c324551f52d796cfa16", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/f06c5b76217ca66e0ef06c324551f52d796cfa16", "committedDate": "2020-10-31T04:40:23Z", "message": "Use more efficient getApproximateLogicalSizeInBytes in OrcWriter\n\nOrcWriter.estimateAverageLogicalSizePerRow has the top memory allocation\nin some KDS pipeline. Since the original code was to estimate the page's\nlogical size and do not require accurate size to be calculated, this\ncommit changes the call of the expensive getLogicalSizeInBytes method to\na much faster and momory friendly method getApproximateLogicalSizeInBytes\nthat estimate the approximate logical size of a page."}, "afterCommit": {"oid": "a95f537327e5cbb7bef202c558d3fb010781826a", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/a95f537327e5cbb7bef202c558d3fb010781826a", "committedDate": "2020-10-31T07:06:20Z", "message": "Use more efficient getApproximateLogicalSizeInBytes in OrcWriter\n\nOrcWriter.estimateAverageLogicalSizePerRow has the top memory allocation\nin some KDS pipeline. Since the original code was to estimate the page's\nlogical size and do not require accurate size to be calculated, this\ncommit changes the call of the expensive getLogicalSizeInBytes method to\na much faster and momory friendly method getApproximateLogicalSizeInBytes\nthat estimate the approximate logical size of a page."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyMDQyNTQw", "url": "https://github.com/prestodb/presto/pull/15377#pullrequestreview-522042540", "createdAt": "2020-11-02T22:12:57Z", "commit": {"oid": "a95f537327e5cbb7bef202c558d3fb010781826a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4652, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}