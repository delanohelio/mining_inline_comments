{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg1OTc2MDIz", "number": 15165, "title": "Disallow partial aggregation pushdown in more cases", "bodyText": "Disallow partial aggregation pushdown when\n\nFilters are pushed into tableScan\nStorage format metadata is inconsistent with the file format\n\nAlso enable partial aggregation flags in more tests\nFixes #15157\n== NO RELEASE NOTE ==", "createdAt": "2020-09-12T17:59:14Z", "url": "https://github.com/prestodb/presto/pull/15165", "merged": true, "mergeCommit": {"oid": "c0b38fe9c9e9c1b5b194c359f3f63eeb13c671b8"}, "closed": true, "closedAt": "2020-09-21T06:41:28Z", "author": {"login": "ClarenceThreepwood"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdIZaf8ABqjM3NjAxODAwNDk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdK9EIcAFqTQ5MjI5NjIwMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2c9e33887af4c0b3bbd2d69777ff30d37dc3c0a7", "author": {"user": {"login": "ClarenceThreepwood", "name": "Vivek"}}, "url": "https://github.com/prestodb/presto/commit/2c9e33887af4c0b3bbd2d69777ff30d37dc3c0a7", "committedDate": "2020-09-12T20:06:14Z", "message": "Trigger build"}, "afterCommit": {"oid": "2e2794b86176e5a3ccef6c933ecdd9efcf33a6d5", "author": {"user": {"login": "ClarenceThreepwood", "name": "Vivek"}}, "url": "https://github.com/prestodb/presto/commit/2e2794b86176e5a3ccef6c933ecdd9efcf33a6d5", "committedDate": "2020-09-13T07:24:41Z", "message": "Disallow partial aggregation pushdown when\n1. Filters are pushed into tableScan\n2. Storage format metadata is inconsistent with the file format"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2e2794b86176e5a3ccef6c933ecdd9efcf33a6d5", "author": {"user": {"login": "ClarenceThreepwood", "name": "Vivek"}}, "url": "https://github.com/prestodb/presto/commit/2e2794b86176e5a3ccef6c933ecdd9efcf33a6d5", "committedDate": "2020-09-13T07:24:41Z", "message": "Disallow partial aggregation pushdown when\n1. Filters are pushed into tableScan\n2. Storage format metadata is inconsistent with the file format"}, "afterCommit": {"oid": "61331882a526b8a5e6184a88af07d41573b55280", "author": {"user": {"login": "ClarenceThreepwood", "name": "Vivek"}}, "url": "https://github.com/prestodb/presto/commit/61331882a526b8a5e6184a88af07d41573b55280", "committedDate": "2020-09-13T19:29:16Z", "message": "Disallow partial aggregation pushdown when\n1. Filters are pushed into tableScan\n2. Storage format metadata is inconsistent with the file format"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "61331882a526b8a5e6184a88af07d41573b55280", "author": {"user": {"login": "ClarenceThreepwood", "name": "Vivek"}}, "url": "https://github.com/prestodb/presto/commit/61331882a526b8a5e6184a88af07d41573b55280", "committedDate": "2020-09-13T19:29:16Z", "message": "Disallow partial aggregation pushdown when\n1. Filters are pushed into tableScan\n2. Storage format metadata is inconsistent with the file format"}, "afterCommit": {"oid": "252a16b2cca070972044d8a85e26844b1c3b3436", "author": {"user": {"login": "ClarenceThreepwood", "name": "Vivek"}}, "url": "https://github.com/prestodb/presto/commit/252a16b2cca070972044d8a85e26844b1c3b3436", "committedDate": "2020-09-13T19:32:30Z", "message": "Disallow partial aggregation pushdown when\n1. Filters are pushed into tableScan\n2. Storage format metadata is inconsistent with the file format"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "252a16b2cca070972044d8a85e26844b1c3b3436", "author": {"user": {"login": "ClarenceThreepwood", "name": "Vivek"}}, "url": "https://github.com/prestodb/presto/commit/252a16b2cca070972044d8a85e26844b1c3b3436", "committedDate": "2020-09-13T19:32:30Z", "message": "Disallow partial aggregation pushdown when\n1. Filters are pushed into tableScan\n2. Storage format metadata is inconsistent with the file format"}, "afterCommit": {"oid": "c8600e19b9a8f2ea15dcd1e29185fa977380c8b4", "author": {"user": {"login": "ClarenceThreepwood", "name": "Vivek"}}, "url": "https://github.com/prestodb/presto/commit/c8600e19b9a8f2ea15dcd1e29185fa977380c8b4", "committedDate": "2020-09-13T19:33:24Z", "message": "Disallow partial aggregation pushdown when\n1. Filters are pushed into tableScan\n2. Storage format metadata is inconsistent with the file format"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5OTYwNzkw", "url": "https://github.com/prestodb/presto/pull/15165#pullrequestreview-489960790", "createdAt": "2020-09-16T19:35:07Z", "commit": {"oid": "c8600e19b9a8f2ea15dcd1e29185fa977380c8b4"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxOTozNTowOFrOHTBY5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxOTozOTozMlrOHTBiTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcwNzc0OQ==", "bodyText": "get confuse here. if hiveColumns only have one AGGREGATED column, is it valid?", "url": "https://github.com/prestodb/presto/pull/15165#discussion_r489707749", "createdAt": "2020-09-16T19:35:08Z", "author": {"login": "zhenxiao"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePageSourceProvider.java", "diffHunk": "@@ -422,6 +422,10 @@ protected static CacheQuota generateCacheQuota(HiveSplit hiveSplit)\n             }\n         }\n \n+        if (!hiveColumns.isEmpty() && hiveColumns.get(0).getColumnType() == AGGREGATED) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c8600e19b9a8f2ea15dcd1e29185fa977380c8b4"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcwNzk4OA==", "bodyText": "static import ORC and PARQUET", "url": "https://github.com/prestodb/presto/pull/15165#discussion_r489707988", "createdAt": "2020-09-16T19:35:36Z", "author": {"login": "zhenxiao"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePartialAggregationPushdown.java", "diffHunk": "@@ -125,8 +122,31 @@ public Visitor(VariableAllocator variableAllocator, ConnectorSession session, Pl\n             this.variableAllocator = variableAllocator;\n         }\n \n-        private boolean isAggregationPushdownSupported(AggregationNode partialAggregationNode, HiveStorageFormat hiveStorageFormat)\n+        private boolean isAggregationPushdownSupported(AggregationNode partialAggregationNode)\n         {\n+            if (partialAggregationNode.hasNonEmptyGroupingSet()) {\n+                return false;\n+            }\n+\n+            TableScanNode tableScanNode = (TableScanNode) partialAggregationNode.getSource();\n+            ConnectorTableMetadata connectorTableMetadata = metadataFactory.get().getTableMetadata(session, tableScanNode.getTable().getConnectorHandle());\n+            Optional<Object> rawFormat = Optional.ofNullable(connectorTableMetadata.getProperties().get(HiveTableProperties.STORAGE_FORMAT_PROPERTY));\n+            if (!rawFormat.isPresent()) {\n+                return false;\n+            }\n+\n+            final HiveStorageFormat hiveStorageFormat = HiveStorageFormat.valueOf(rawFormat.get().toString());\n+            if (hiveStorageFormat != HiveStorageFormat.ORC && hiveStorageFormat != HiveStorageFormat.PARQUET) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c8600e19b9a8f2ea15dcd1e29185fa977380c8b4"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcwODc3MQ==", "bodyText": "s/noMinMaxMessage/OrcNoMinMaxMessage/g", "url": "https://github.com/prestodb/presto/pull/15165#discussion_r489708771", "createdAt": "2020-09-16T19:36:59Z", "author": {"login": "zhenxiao"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/orc/AggregatedOrcPageSource.java", "diffHunk": "@@ -138,13 +138,14 @@ private void writeMinMax(int columnIndex, Type type, HiveType hiveType, BlockBui\n             completedBytes += ((FixedWidthType) type).getFixedSize();\n         }\n \n+        String noMinMaxMessage = \"No min/max found for orc file. Set session property hive.pushdown_partial_aggregations_into_scan=false and execute query again\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c8600e19b9a8f2ea15dcd1e29185fa977380c8b4"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcxMDE1Ng==", "bodyText": "test_file_format_orc is Orc table, right? why partial aggregation pushdown now supported?", "url": "https://github.com/prestodb/presto/pull/15165#discussion_r489710156", "createdAt": "2020-09-16T19:39:32Z", "author": {"login": "zhenxiao"}, "path": "presto-hive/src/test/java/com/facebook/presto/hive/TestHivePushdownFilterQueries.java", "diffHunk": "@@ -1034,7 +1039,8 @@ private void assertFileFormat(HiveStorageFormat storageFormat)\n             // no filter\n             assertQueryUsingH2Cte(\"SELECT * FROM test_file_format_orc\", cte);\n             assertQueryUsingH2Cte(\"SELECT comment FROM test_file_format_orc\", cte);\n-            assertQueryUsingH2Cte(\"SELECT COUNT(*) FROM test_file_format_orc\", cte);\n+            assertQueryFails(\"SELECT COUNT(*) FROM test_file_format_orc\", \"Partial aggregation pushdown only supported for ORC/Parquet files. Set session property hive.pushdown_partial_aggregations_into_scan=false and execute query again\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c8600e19b9a8f2ea15dcd1e29185fa977380c8b4"}, "originalPosition": 29}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c8600e19b9a8f2ea15dcd1e29185fa977380c8b4", "author": {"user": {"login": "ClarenceThreepwood", "name": "Vivek"}}, "url": "https://github.com/prestodb/presto/commit/c8600e19b9a8f2ea15dcd1e29185fa977380c8b4", "committedDate": "2020-09-13T19:33:24Z", "message": "Disallow partial aggregation pushdown when\n1. Filters are pushed into tableScan\n2. Storage format metadata is inconsistent with the file format"}, "afterCommit": {"oid": "eaf291752fff567c9a7a8c5ef5c4e113103903cd", "author": {"user": {"login": "ClarenceThreepwood", "name": "Vivek"}}, "url": "https://github.com/prestodb/presto/commit/eaf291752fff567c9a7a8c5ef5c4e113103903cd", "committedDate": "2020-09-17T22:27:05Z", "message": "Disallow partial aggregation pushdown when\n1. Filters are pushed into tableScan\n2. Storage format metadata is inconsistent with the file format"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxMTE1MTk5", "url": "https://github.com/prestodb/presto/pull/15165#pullrequestreview-491115199", "createdAt": "2020-09-18T02:52:10Z", "commit": {"oid": "eaf291752fff567c9a7a8c5ef5c4e113103903cd"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwMjo1MjoxMVrOHT8JnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwMjo1Mzo0NFrOHT8LAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY3MDQ5Mw==", "bodyText": "get it. shall we use allMatch to make sure all are AGGREGATED?\nI think we also need to update the message", "url": "https://github.com/prestodb/presto/pull/15165#discussion_r490670493", "createdAt": "2020-09-18T02:52:11Z", "author": {"login": "zhenxiao"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePageSourceProvider.java", "diffHunk": "@@ -422,6 +422,10 @@ protected static CacheQuota generateCacheQuota(HiveSplit hiveSplit)\n             }\n         }\n \n+        if (!hiveColumns.isEmpty() && hiveColumns.get(0).getColumnType() == AGGREGATED) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcwNzc0OQ=="}, "originalCommit": {"oid": "c8600e19b9a8f2ea15dcd1e29185fa977380c8b4"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY3MDYyOQ==", "bodyText": "same", "url": "https://github.com/prestodb/presto/pull/15165#discussion_r490670629", "createdAt": "2020-09-18T02:52:47Z", "author": {"login": "zhenxiao"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/rcfile/RcFilePageSourceFactory.java", "diffHunk": "@@ -110,6 +111,10 @@ public RcFilePageSourceFactory(TypeManager typeManager, HdfsEnvironment hdfsEnvi\n             HiveFileContext hiveFileContext,\n             Optional<EncryptionInformation> encryptionInformation)\n     {\n+        if (!columns.isEmpty() && columns.get(0).getColumnType() == AGGREGATED) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eaf291752fff567c9a7a8c5ef5c4e113103903cd"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY3MDg0OA==", "bodyText": "ah... maybe add a comment, describe the case?", "url": "https://github.com/prestodb/presto/pull/15165#discussion_r490670848", "createdAt": "2020-09-18T02:53:44Z", "author": {"login": "zhenxiao"}, "path": "presto-hive/src/test/java/com/facebook/presto/hive/TestHivePushdownFilterQueries.java", "diffHunk": "@@ -1034,7 +1039,8 @@ private void assertFileFormat(HiveStorageFormat storageFormat)\n             // no filter\n             assertQueryUsingH2Cte(\"SELECT * FROM test_file_format_orc\", cte);\n             assertQueryUsingH2Cte(\"SELECT comment FROM test_file_format_orc\", cte);\n-            assertQueryUsingH2Cte(\"SELECT COUNT(*) FROM test_file_format_orc\", cte);\n+            assertQueryFails(\"SELECT COUNT(*) FROM test_file_format_orc\", \"Partial aggregation pushdown only supported for ORC/Parquet files. Set session property hive.pushdown_partial_aggregations_into_scan=false and execute query again\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcxMDE1Ng=="}, "originalCommit": {"oid": "c8600e19b9a8f2ea15dcd1e29185fa977380c8b4"}, "originalPosition": 29}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eaf291752fff567c9a7a8c5ef5c4e113103903cd", "author": {"user": {"login": "ClarenceThreepwood", "name": "Vivek"}}, "url": "https://github.com/prestodb/presto/commit/eaf291752fff567c9a7a8c5ef5c4e113103903cd", "committedDate": "2020-09-17T22:27:05Z", "message": "Disallow partial aggregation pushdown when\n1. Filters are pushed into tableScan\n2. Storage format metadata is inconsistent with the file format"}, "afterCommit": {"oid": "17f6ca0015bf541385a2bbf31fbdb2ecc5c23b5e", "author": {"user": {"login": "ClarenceThreepwood", "name": "Vivek"}}, "url": "https://github.com/prestodb/presto/commit/17f6ca0015bf541385a2bbf31fbdb2ecc5c23b5e", "committedDate": "2020-09-18T07:45:15Z", "message": "Disallow partial aggregation pushdown when\n1. Filters are pushed into tableScan\n2. Storage format metadata is inconsistent with the file format"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxOTA5ODg3", "url": "https://github.com/prestodb/presto/pull/15165#pullrequestreview-491909887", "createdAt": "2020-09-19T04:18:02Z", "commit": {"oid": "17f6ca0015bf541385a2bbf31fbdb2ecc5c23b5e"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOVQwNDoxODowMlrOHUgi0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOVQwNDoxODowMlrOHUgi0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTI2Njc3MA==", "bodyText": "if all column handles are AGGREGATED, we should not enter HivePageSourceProvider, right?\nHow about use checkState, with error message like:\nInvalid processing state. Partial aggregation should be processed in AggregatedParquetPageSource or AggregatedOrcPageSource", "url": "https://github.com/prestodb/presto/pull/15165#discussion_r491266770", "createdAt": "2020-09-19T04:18:02Z", "author": {"login": "zhenxiao"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePageSourceProvider.java", "diffHunk": "@@ -422,6 +422,10 @@ protected static CacheQuota generateCacheQuota(HiveSplit hiveSplit)\n             }\n         }\n \n+        if (!hiveColumns.isEmpty() && hiveColumns.stream().allMatch(hiveColumnHandle -> hiveColumnHandle.getColumnType() == AGGREGATED)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17f6ca0015bf541385a2bbf31fbdb2ecc5c23b5e"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "242f5de6aeaf0236181f31138743dca8eeeaab36", "author": {"user": {"login": "ClarenceThreepwood", "name": "Vivek"}}, "url": "https://github.com/prestodb/presto/commit/242f5de6aeaf0236181f31138743dca8eeeaab36", "committedDate": "2020-09-21T04:57:57Z", "message": "Disallow partial aggregation pushdown when\n1. Filters are pushed into tableScan\n2. Storage format metadata is inconsistent with the file format"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "17f6ca0015bf541385a2bbf31fbdb2ecc5c23b5e", "author": {"user": {"login": "ClarenceThreepwood", "name": "Vivek"}}, "url": "https://github.com/prestodb/presto/commit/17f6ca0015bf541385a2bbf31fbdb2ecc5c23b5e", "committedDate": "2020-09-18T07:45:15Z", "message": "Disallow partial aggregation pushdown when\n1. Filters are pushed into tableScan\n2. Storage format metadata is inconsistent with the file format"}, "afterCommit": {"oid": "242f5de6aeaf0236181f31138743dca8eeeaab36", "author": {"user": {"login": "ClarenceThreepwood", "name": "Vivek"}}, "url": "https://github.com/prestodb/presto/commit/242f5de6aeaf0236181f31138743dca8eeeaab36", "committedDate": "2020-09-21T04:57:57Z", "message": "Disallow partial aggregation pushdown when\n1. Filters are pushed into tableScan\n2. Storage format metadata is inconsistent with the file format"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyMjk2MjAy", "url": "https://github.com/prestodb/presto/pull/15165#pullrequestreview-492296202", "createdAt": "2020-09-21T06:05:12Z", "commit": {"oid": "242f5de6aeaf0236181f31138743dca8eeeaab36"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 122, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}