{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAxODg2MTg3", "number": 15304, "title": "Handle cases when flat map doesn't have dummy encoding for sequence 0", "bodyText": "Current reader assumes that the value node of a flat map always have dummy\nencoding metadata for sequence 0. However, that may not be true especially\ngiven that such metadata is not needed in the actual read process. Handle case\nwhen sequence 0 is missing.\nTest plan\n\nAdded unit tests that read against a file with missing sequence 0.\n\n== NO RELEASE NOTE ==", "createdAt": "2020-10-12T23:55:15Z", "url": "https://github.com/prestodb/presto/pull/15304", "merged": true, "mergeCommit": {"oid": "7a122bb50b63426c64551a02a3ce62e082e4f023"}, "closed": true, "closedAt": "2020-10-14T17:53:38Z", "author": {"login": "zzhao0"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSBTIAABqjM4NjkyNzg1NDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSfr16gFqTUwODUyMDYxMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f1c74cf1c2b85018f01aeb4154381c56d458a0de", "author": {"user": {"login": "zzhao0", "name": "Zhenyuan Zhao"}}, "url": "https://github.com/prestodb/presto/commit/f1c74cf1c2b85018f01aeb4154381c56d458a0de", "committedDate": "2020-10-13T02:45:46Z", "message": "make sure Optional.empty() is set for regular columns"}, "afterCommit": {"oid": "034a9baf752dafb7cfc6959f162392680c99d2ff", "author": {"user": {"login": "zzhao0", "name": "Zhenyuan Zhao"}}, "url": "https://github.com/prestodb/presto/commit/034a9baf752dafb7cfc6959f162392680c99d2ff", "committedDate": "2020-10-13T04:56:57Z", "message": "make sure Optional.empty() is set for regular columns"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3MTA4MDIw", "url": "https://github.com/prestodb/presto/pull/15304#pullrequestreview-507108020", "createdAt": "2020-10-13T06:36:08Z", "commit": {"oid": "034a9baf752dafb7cfc6959f162392680c99d2ff"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QwNjozNjowOFrOHgXVzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QwNjozNjowOFrOHgXVzA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzY5ODg5Mg==", "bodyText": "the columnEncoding sequence 0 if present, should be the first value, so the if check can be moved outside the for loop.\nsequence0 can be assigned to the one if one exists, or a dummy DWRF_DIRECT encoding can be created, so that the below code does not need to switch on sequence0 != null.", "url": "https://github.com/prestodb/presto/pull/15304#discussion_r503698892", "createdAt": "2020-10-13T06:36:08Z", "author": {"login": "arunthirupathi"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/metadata/DwrfMetadataReader.java", "diffHunk": "@@ -200,20 +200,29 @@ private static DwrfSequenceEncoding toSequenceEncoding(OrcType type, DwrfProto.C\n                         columnEncoding.getDictionarySize()));\n     }\n \n-    private static Optional<SortedMap<Integer, DwrfSequenceEncoding>> toAdditionalSequenceEncodings(List<DwrfProto.ColumnEncoding> columnEncodings, OrcType type)\n+    private static ColumnEncoding toColumnEncoding(OrcType type, List<DwrfProto.ColumnEncoding> columnEncodings)\n     {\n-        if (columnEncodings.size() == 1) {\n-            return Optional.empty();\n+        DwrfProto.ColumnEncoding sequence0 = null;\n+        ImmutableSortedMap.Builder<Integer, DwrfSequenceEncoding> builder = ImmutableSortedMap.naturalOrder();\n+        for (DwrfProto.ColumnEncoding columnEncoding : columnEncodings) {\n+            if (columnEncoding.getSequence() == 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "034a9baf752dafb7cfc6959f162392680c99d2ff"}, "originalPosition": 12}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "034a9baf752dafb7cfc6959f162392680c99d2ff", "author": {"user": {"login": "zzhao0", "name": "Zhenyuan Zhao"}}, "url": "https://github.com/prestodb/presto/commit/034a9baf752dafb7cfc6959f162392680c99d2ff", "committedDate": "2020-10-13T04:56:57Z", "message": "make sure Optional.empty() is set for regular columns"}, "afterCommit": {"oid": "246f5d286a39221f859bc267d9089b516824a731", "author": {"user": {"login": "zzhao0", "name": "Zhenyuan Zhao"}}, "url": "https://github.com/prestodb/presto/commit/246f5d286a39221f859bc267d9089b516824a731", "committedDate": "2020-10-13T18:07:37Z", "message": "Handle cases when flat map doesn't have dummy encoding for sequence 0"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4NDAzNjg5", "url": "https://github.com/prestodb/presto/pull/15304#pullrequestreview-508403689", "createdAt": "2020-10-14T14:24:19Z", "commit": {"oid": "246f5d286a39221f859bc267d9089b516824a731"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxNDoyNDoxOVrOHhVsNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxNDoyNDoxOVrOHhVsNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcyMDQzNg==", "bodyText": "additionalSequenceEncodings name is confusing; the value is just nonZeroSequences wrapped into an Optional; Is it important to use Optional.empty() when nonZeroSequences is empty? Why can't we always use Optional.of(nonZeroSequences)? If that's possible, then additionalSequenceEncodings variable can be removed and Optional.of(nonZeroSequences) can be used in its place.", "url": "https://github.com/prestodb/presto/pull/15304#discussion_r504720436", "createdAt": "2020-10-14T14:24:19Z", "author": {"login": "mbasmanova"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/metadata/DwrfMetadataReader.java", "diffHunk": "@@ -200,20 +200,29 @@ private static DwrfSequenceEncoding toSequenceEncoding(OrcType type, DwrfProto.C\n                         columnEncoding.getDictionarySize()));\n     }\n \n-    private static Optional<SortedMap<Integer, DwrfSequenceEncoding>> toAdditionalSequenceEncodings(List<DwrfProto.ColumnEncoding> columnEncodings, OrcType type)\n+    private static ColumnEncoding toColumnEncoding(OrcType type, List<DwrfProto.ColumnEncoding> columnEncodings)\n     {\n-        if (columnEncodings.size() == 1) {\n-            return Optional.empty();\n+        DwrfProto.ColumnEncoding sequence0 = null;\n+        ImmutableSortedMap.Builder<Integer, DwrfSequenceEncoding> builder = ImmutableSortedMap.naturalOrder();\n+        for (DwrfProto.ColumnEncoding columnEncoding : columnEncodings) {\n+            if (columnEncoding.getSequence() == 0) {\n+                sequence0 = columnEncoding;\n+            }\n+            else {\n+                builder.put(columnEncoding.getSequence(), toSequenceEncoding(type, columnEncoding));\n+            }\n         }\n \n-        ImmutableSortedMap.Builder<Integer, DwrfSequenceEncoding> additionalSequenceEncodings = ImmutableSortedMap.<Integer, DwrfSequenceEncoding>naturalOrder();\n-\n-        for (int i = 1; i < columnEncodings.size(); i++) {\n-            DwrfProto.ColumnEncoding columnEncoding = columnEncodings.get(i);\n-            additionalSequenceEncodings.put(columnEncoding.getSequence(), toSequenceEncoding(type, columnEncoding));\n+        SortedMap<Integer, DwrfSequenceEncoding> nonZeroSequences = builder.build();\n+        Optional<SortedMap<Integer, DwrfSequenceEncoding>> additionalSequenceEncodings =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "246f5d286a39221f859bc267d9089b516824a731"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d63e3eeb404880a4b6e6353a534b0a4aa687069", "author": {"user": {"login": "zzhao0", "name": "Zhenyuan Zhao"}}, "url": "https://github.com/prestodb/presto/commit/5d63e3eeb404880a4b6e6353a534b0a4aa687069", "committedDate": "2020-10-14T16:08:50Z", "message": "Handle cases when flat map doesn't have dummy encoding for sequence 0"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "246f5d286a39221f859bc267d9089b516824a731", "author": {"user": {"login": "zzhao0", "name": "Zhenyuan Zhao"}}, "url": "https://github.com/prestodb/presto/commit/246f5d286a39221f859bc267d9089b516824a731", "committedDate": "2020-10-13T18:07:37Z", "message": "Handle cases when flat map doesn't have dummy encoding for sequence 0"}, "afterCommit": {"oid": "5d63e3eeb404880a4b6e6353a534b0a4aa687069", "author": {"user": {"login": "zzhao0", "name": "Zhenyuan Zhao"}}, "url": "https://github.com/prestodb/presto/commit/5d63e3eeb404880a4b6e6353a534b0a4aa687069", "committedDate": "2020-10-14T16:08:50Z", "message": "Handle cases when flat map doesn't have dummy encoding for sequence 0"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4NTIwNjEx", "url": "https://github.com/prestodb/presto/pull/15304#pullrequestreview-508520611", "createdAt": "2020-10-14T16:22:49Z", "commit": {"oid": "5d63e3eeb404880a4b6e6353a534b0a4aa687069"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4888, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}