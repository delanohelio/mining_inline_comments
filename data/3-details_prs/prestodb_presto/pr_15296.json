{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAwNzQ5OTM3", "number": 15296, "title": "Minor improvements for partitioned output buffers and operator", "bodyText": "Comparable changes to trinodb/trino#5499\n\nAdds fast path for partitioning without constant arguments\nSimplify iterating through PartitionedOutputBuffer pages to one pass\nUse known-size builders where possible\n\n== NO RELEASE NOTE ==", "createdAt": "2020-10-09T18:18:39Z", "url": "https://github.com/prestodb/presto/pull/15296", "merged": true, "mergeCommit": {"oid": "0325c46479354b6557d7b60be054cedf34faa8f0"}, "closed": true, "closedAt": "2020-10-20T13:27:26Z", "author": {"login": "pettyjamesm"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQ6fR6gBqjM4NjEzMzk4OTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdULAuUAFqTUxMjE3MTI1Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a8ab705f657277ed021a537a852fed2a5ae3b47d", "author": {"user": {"login": "pettyjamesm", "name": "James Petty"}}, "url": "https://github.com/prestodb/presto/commit/a8ab705f657277ed021a537a852fed2a5ae3b47d", "committedDate": "2020-10-09T18:16:03Z", "message": "Minor improvements for partitioned output buffers and operator\n\n- Adds fast path for partitioning without constant arguments\n- Simplify iterating through PartitionedOutputBuffer pages to one\npass\n- Use known-size builders where possible"}, "afterCommit": {"oid": "2d22f2ff49f95451a3ffa0beb42cf00fffea98b5", "author": {"user": {"login": "pettyjamesm", "name": "James Petty"}}, "url": "https://github.com/prestodb/presto/commit/2d22f2ff49f95451a3ffa0beb42cf00fffea98b5", "committedDate": "2020-10-09T18:28:33Z", "message": "Minor improvements for partitioned output buffers and operator\n\n- Adds fast path for partitioning without constant arguments\n- Simplify iterating through PartitionedOutputBuffer pages to one\npass\n- Use known-size builders where possible"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2d22f2ff49f95451a3ffa0beb42cf00fffea98b5", "author": {"user": {"login": "pettyjamesm", "name": "James Petty"}}, "url": "https://github.com/prestodb/presto/commit/2d22f2ff49f95451a3ffa0beb42cf00fffea98b5", "committedDate": "2020-10-09T18:28:33Z", "message": "Minor improvements for partitioned output buffers and operator\n\n- Adds fast path for partitioning without constant arguments\n- Simplify iterating through PartitionedOutputBuffer pages to one\npass\n- Use known-size builders where possible"}, "afterCommit": {"oid": "4d51eea16fac26caf061e51674257855aa362687", "author": {"user": {"login": "pettyjamesm", "name": "James Petty"}}, "url": "https://github.com/prestodb/presto/commit/4d51eea16fac26caf061e51674257855aa362687", "committedDate": "2020-10-09T18:43:23Z", "message": "Minor improvements for partitioned output buffers and operator\n\n- Adds fast path for partitioning without constant arguments\n- Simplify iterating through PartitionedOutputBuffer pages to one\npass\n- Use known-size builders where possible"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4d51eea16fac26caf061e51674257855aa362687", "author": {"user": {"login": "pettyjamesm", "name": "James Petty"}}, "url": "https://github.com/prestodb/presto/commit/4d51eea16fac26caf061e51674257855aa362687", "committedDate": "2020-10-09T18:43:23Z", "message": "Minor improvements for partitioned output buffers and operator\n\n- Adds fast path for partitioning without constant arguments\n- Simplify iterating through PartitionedOutputBuffer pages to one\npass\n- Use known-size builders where possible"}, "afterCommit": {"oid": "7c6afb6d847f3b849cd0f0cb2e82f203db94d1a7", "author": {"user": {"login": "pettyjamesm", "name": "James Petty"}}, "url": "https://github.com/prestodb/presto/commit/7c6afb6d847f3b849cd0f0cb2e82f203db94d1a7", "committedDate": "2020-10-09T19:00:35Z", "message": "Minor improvements for partitioned output buffers and operator\n\n- Adds fast path for partitioning without constant arguments\n- Simplify iterating through PartitionedOutputBuffer pages to one\npass\n- Use known-size builders where possible"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5OTUyMjUw", "url": "https://github.com/prestodb/presto/pull/15296#pullrequestreview-509952250", "createdAt": "2020-10-16T01:24:48Z", "commit": {"oid": "7c6afb6d847f3b849cd0f0cb2e82f203db94d1a7"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQwMToyNDo0OFrOHihhIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQwMToyNToyMlrOHihiSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTk2Mjc4NA==", "bodyText": "Can we rename split to splittedPages? It's easy to get confused on the wordsplit with Presto splits", "url": "https://github.com/prestodb/presto/pull/15296#discussion_r505962784", "createdAt": "2020-10-16T01:24:48Z", "author": {"login": "yingsu00"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/repartition/PartitionedOutputOperator.java", "diffHunk": "@@ -419,15 +444,21 @@ public void flush(boolean force)\n \n                     operatorContext.recordOutput(pagePartition.getSizeInBytes(), pagePartition.getPositionCount());\n \n-                    List<SerializedPage> serializedPages = splitPage(pagePartition, DEFAULT_MAX_PAGE_SIZE_IN_BYTES).stream()\n-                            .map(serde::serialize)\n-                            .collect(toImmutableList());\n-\n-                    outputBuffer.enqueue(operatorContext.getDriverContext().getLifespan(), partition, serializedPages);\n+                    outputBuffer.enqueue(operatorContext.getDriverContext().getLifespan(), partition, splitAndSerializePage(pagePartition));\n                     pagesAdded.incrementAndGet();\n                     rowsAdded.addAndGet(pagePartition.getPositionCount());\n                 }\n             }\n         }\n+\n+        private List<SerializedPage> splitAndSerializePage(Page pagePartition)\n+        {\n+            List<Page> split = splitPage(pagePartition, DEFAULT_MAX_PAGE_SIZE_IN_BYTES);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c6afb6d847f3b849cd0f0cb2e82f203db94d1a7"}, "originalPosition": 116}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTk2MzA4MA==", "bodyText": "Wonder if you could add the same optimization to OptimizedPartitionedOutputOperator?", "url": "https://github.com/prestodb/presto/pull/15296#discussion_r505963080", "createdAt": "2020-10-16T01:25:22Z", "author": {"login": "yingsu00"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/repartition/PartitionedOutputOperator.java", "diffHunk": "@@ -385,14 +405,19 @@ public void partitionPage(Page page)\n \n         private Page getPartitionFunctionArguments(Page page)\n         {\n-            Block[] blocks = new Block[partitionChannels.size()];\n+            // Fast path for no constants\n+            if (partitionConstantBlocks == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c6afb6d847f3b849cd0f0cb2e82f203db94d1a7"}, "originalPosition": 79}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7c6afb6d847f3b849cd0f0cb2e82f203db94d1a7", "author": {"user": {"login": "pettyjamesm", "name": "James Petty"}}, "url": "https://github.com/prestodb/presto/commit/7c6afb6d847f3b849cd0f0cb2e82f203db94d1a7", "committedDate": "2020-10-09T19:00:35Z", "message": "Minor improvements for partitioned output buffers and operator\n\n- Adds fast path for partitioning without constant arguments\n- Simplify iterating through PartitionedOutputBuffer pages to one\npass\n- Use known-size builders where possible"}, "afterCommit": {"oid": "01196dbf7b4f3875f70bf03541764e9ebb5df580", "author": {"user": {"login": "pettyjamesm", "name": "James Petty"}}, "url": "https://github.com/prestodb/presto/commit/01196dbf7b4f3875f70bf03541764e9ebb5df580", "committedDate": "2020-10-16T11:16:09Z", "message": "Minor improvements for partitioned output buffers and operator\n\n- Adds fast path for partitioning without constant arguments\n- Simplify iterating through PartitionedOutputBuffer pages to one\npass\n- Use known-size builders where possible"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "460d6ce32dc20bbb5062107b6dc9d841ffa2886e", "author": {"user": {"login": "pettyjamesm", "name": "James Petty"}}, "url": "https://github.com/prestodb/presto/commit/460d6ce32dc20bbb5062107b6dc9d841ffa2886e", "committedDate": "2020-10-16T11:33:03Z", "message": "Minor improvements for partitioned output buffers and operator\n\n- Adds fast path for partitioning without constant arguments\n- Simplify iterating through PartitionedOutputBuffer pages to one\npass\n- Use known-size builders where possible"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "01196dbf7b4f3875f70bf03541764e9ebb5df580", "author": {"user": {"login": "pettyjamesm", "name": "James Petty"}}, "url": "https://github.com/prestodb/presto/commit/01196dbf7b4f3875f70bf03541764e9ebb5df580", "committedDate": "2020-10-16T11:16:09Z", "message": "Minor improvements for partitioned output buffers and operator\n\n- Adds fast path for partitioning without constant arguments\n- Simplify iterating through PartitionedOutputBuffer pages to one\npass\n- Use known-size builders where possible"}, "afterCommit": {"oid": "460d6ce32dc20bbb5062107b6dc9d841ffa2886e", "author": {"user": {"login": "pettyjamesm", "name": "James Petty"}}, "url": "https://github.com/prestodb/presto/commit/460d6ce32dc20bbb5062107b6dc9d841ffa2886e", "committedDate": "2020-10-16T11:33:03Z", "message": "Minor improvements for partitioned output buffers and operator\n\n- Adds fast path for partitioning without constant arguments\n- Simplify iterating through PartitionedOutputBuffer pages to one\npass\n- Use known-size builders where possible"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyMTcxMjUy", "url": "https://github.com/prestodb/presto/pull/15296#pullrequestreview-512171252", "createdAt": "2020-10-19T21:25:29Z", "commit": {"oid": "460d6ce32dc20bbb5062107b6dc9d841ffa2886e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4886, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}