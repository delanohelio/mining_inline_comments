{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM3MTY0ODI2", "number": 15517, "title": "Avoid costly resizes of the addresses dynamic array in PagesIndex", "bodyText": "On memory constraint environments resizing the valueAddresses can cause OOM. Also given the high expansion factor it may end up causing significant memory overhead.\nFor example if the current size of valueAddresses is ~2GB (260m elements) trying to expand it to 4GB can cause a premature OOM, as there might not be enough memory to accommodate 2 strongly reachable arrays (2GB + 4GB).\nAlso it is very likely to result in a significant memory waste if the expansion happens just to accommodate only a few overflowing elements.\nThis patch replaces a contiguous LongArrayList with the AdaptiveLongBigArray. AdaptiveLongBigArray allocates memory gradually. It is implemented by employing another level of indirection:\n[1,2,3,4,5] -> [block1 -> [1,2,3], block2->[4,5]] \n\nThis allows more gradual memory allocation, and eliminates the need of expensive array expansions.\nHowever everything comes at a price. Another indirection adds a cost of additional memory lookup. In theory that may negatively impact CPU cache locality and decrease performance.\nTo decrease the effects of the indirection the AdaptiveLongBigArray employs both techniques. It is expanding linear array (segment) up to 256MB, and only then adds another segment. With large segments the first table (array of long arrays) should be very small (~5 - 10 elements, 40 - 80 bytes)* and should easily fit into L1 CPU cache.\n== NO RELEASE NOTE ==", "createdAt": "2020-12-11T17:09:51Z", "url": "https://github.com/prestodb/presto/pull/15517", "merged": true, "mergeCommit": {"oid": "adc7a640faf6263033fce8ea083ae3799f39ddce"}, "closed": true, "closedAt": "2020-12-23T00:21:55Z", "author": {"login": "arhimondr"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdlNq8HAFqTU1MDU0MjI0NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdoz1EoABqjQxNDIxOTA4MDg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwNTQyMjQ1", "url": "https://github.com/prestodb/presto/pull/15517#pullrequestreview-550542245", "createdAt": "2020-12-11T20:08:06Z", "commit": {"oid": "d7d01e635f5a96718cb54c6d191a75591579671f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQyMDowODowNlrOIEKQMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQyMDowODowNlrOIEKQMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTIzMzIwMQ==", "bodyText": "Reorder to put it below other final members?", "url": "https://github.com/prestodb/presto/pull/15517#discussion_r541233201", "createdAt": "2020-12-11T20:08:06Z", "author": {"login": "viczhang861"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/PagesIndex.java", "diffHunk": "@@ -84,7 +84,7 @@\n     private final boolean groupByUsesEqualTo;\n \n     private final List<Type> types;\n-    private final LongArrayList valueAddresses;\n+    private LongBigArray valueAddresses;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7d01e635f5a96718cb54c6d191a75591579671f"}, "originalPosition": 21}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "08cd0883c631368c8e2f19e0f266d4ddc821d7d3", "author": {"user": {"login": "arhimondr", "name": "Andrii Rosa"}}, "url": "https://github.com/prestodb/presto/commit/08cd0883c631368c8e2f19e0f266d4ddc821d7d3", "committedDate": "2020-12-11T15:21:16Z", "message": "Improve LongBigArray\n\n- Make segment size configurable\n- Expand segments array exponentially\n\nThis optimization is needed to make sure the cost of idirection is minimized by making the\nindirection array as small as possible, so it fits nicely in the CPU caches"}, "afterCommit": {"oid": "9f4c7136df4d1b34198471e6a3fc3dab7c4ba94c", "author": {"user": {"login": "arhimondr", "name": "Andrii Rosa"}}, "url": "https://github.com/prestodb/presto/commit/9f4c7136df4d1b34198471e6a3fc3dab7c4ba94c", "committedDate": "2020-12-11T20:19:36Z", "message": "Improve LongBigArray\n\n- Make segment size configurable\n- Expand segments array exponentially\n\nThis optimization is needed to make sure the cost of idirection is minimized by making the\nindirection array as small as possible, so it fits nicely in the CPU caches"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwNTY3ODQ1", "url": "https://github.com/prestodb/presto/pull/15517#pullrequestreview-550567845", "createdAt": "2020-12-11T20:49:16Z", "commit": {"oid": "9f4c7136df4d1b34198471e6a3fc3dab7c4ba94c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQyMDo0OToxN1rOIEMv3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQyMDo0OToxN1rOIEMv3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTI3NDA3Nw==", "bodyText": "Typical array expanding is based on existing size Math.max(toIntExact(round(array.length * 1.5)), requiredSegments)", "url": "https://github.com/prestodb/presto/pull/15517#discussion_r541274077", "createdAt": "2020-12-11T20:49:17Z", "author": {"login": "viczhang861"}, "path": "presto-array/src/main/java/com/facebook/presto/array/LongBigArray.java", "diffHunk": "@@ -125,7 +147,7 @@ private void grow(long length)\n \n         // grow base array if necessary\n         if (array.length < requiredSegments) {\n-            array = Arrays.copyOf(array, requiredSegments);\n+            array = Arrays.copyOf(array, toIntExact(round(requiredSegments * 1.5)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f4c7136df4d1b34198471e6a3fc3dab7c4ba94c"}, "originalPosition": 71}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwNTY4OTQz", "url": "https://github.com/prestodb/presto/pull/15517#pullrequestreview-550568943", "createdAt": "2020-12-11T20:51:12Z", "commit": {"oid": "9f4c7136df4d1b34198471e6a3fc3dab7c4ba94c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQyMDo1MToxMlrOIEM2zA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQyMDo1MToxMlrOIEM2zA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTI3NTg1Mg==", "bodyText": "Wonder why 256K ?  valueAddresses.ensureCapacity(expectedPositions)", "url": "https://github.com/prestodb/presto/pull/15517#discussion_r541275852", "createdAt": "2020-12-11T20:51:12Z", "author": {"login": "viczhang861"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/PagesIndex.java", "diffHunk": "@@ -107,7 +107,9 @@ private PagesIndex(\n         this.functionAndTypeManager = requireNonNull(functionAndTypeManager, \"functionManager is null\");\n         this.groupByUsesEqualTo = groupByUsesEqualTo;\n         this.types = ImmutableList.copyOf(requireNonNull(types, \"types is null\"));\n-        this.valueAddresses = new LongBigArray();\n+        // Take the next closed power of 2 as the segment size\n+        int segmentSize = Integer.highestOneBit(expectedPositions) << 1;\n+        this.valueAddresses = new LongBigArray(0, segmentSize);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f4c7136df4d1b34198471e6a3fc3dab7c4ba94c"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwNTczMjg3", "url": "https://github.com/prestodb/presto/pull/15517#pullrequestreview-550573287", "createdAt": "2020-12-11T20:58:29Z", "commit": {"oid": "9f4c7136df4d1b34198471e6a3fc3dab7c4ba94c"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9f4c7136df4d1b34198471e6a3fc3dab7c4ba94c", "author": {"user": {"login": "arhimondr", "name": "Andrii Rosa"}}, "url": "https://github.com/prestodb/presto/commit/9f4c7136df4d1b34198471e6a3fc3dab7c4ba94c", "committedDate": "2020-12-11T20:19:36Z", "message": "Improve LongBigArray\n\n- Make segment size configurable\n- Expand segments array exponentially\n\nThis optimization is needed to make sure the cost of idirection is minimized by making the\nindirection array as small as possible, so it fits nicely in the CPU caches"}, "afterCommit": {"oid": "e06a68500404939b3de6084d17c77da164087409", "author": {"user": {"login": "arhimondr", "name": "Andrii Rosa"}}, "url": "https://github.com/prestodb/presto/commit/e06a68500404939b3de6084d17c77da164087409", "committedDate": "2020-12-12T03:21:03Z", "message": "Avoid costly resizes of the addresses dynamic array in PagesIndex"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxMDcwMTA1", "url": "https://github.com/prestodb/presto/pull/15517#pullrequestreview-551070105", "createdAt": "2020-12-14T06:18:09Z", "commit": {"oid": "e06a68500404939b3de6084d17c77da164087409"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQwNjoxODowOVrOIFBb4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQwNjoyMDo1MFrOIFBfKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjEzNzMxNA==", "bodyText": "convention: Rename to getRetainedSizeInBytes()?", "url": "https://github.com/prestodb/presto/pull/15517#discussion_r542137314", "createdAt": "2020-12-14T06:18:09Z", "author": {"login": "yingsu00"}, "path": "presto-array/src/main/java/com/facebook/presto/array/AdaptiveLongBigArray.java", "diffHunk": "@@ -0,0 +1,143 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.array;\n+\n+import io.airlift.slice.SizeOf;\n+import org.openjdk.jol.info.ClassLayout;\n+\n+import java.util.Arrays;\n+\n+import static io.airlift.slice.SizeOf.sizeOfLongArray;\n+import static java.lang.StrictMath.toIntExact;\n+\n+/**\n+ * This variation of BigArray is designed to expand segments up to some reasonable extend\n+ * and add more segments if the maximum segment capacity is reached\n+ * This implementation allows to keep the redirection table small so it does fit into L1 CPU cache\n+ */\n+public class AdaptiveLongBigArray\n+{\n+    // visible for testing\n+    static final int INSTANCE_SIZE = ClassLayout.parseClass(AdaptiveLongBigArray.class).instanceSize();\n+\n+    // settings are constants due to efficiency considerations\n+    static final int INITIAL_SEGMENT_LENGTH = 16 * 1024; // 128KB\n+    static final int MAX_SEGMENT_LENGTH = 32 * 1024 * 1024; // 256MB\n+    static final int MAX_SEGMENT_SIZE_IN_BYTES = toIntExact(sizeOfLongArray(MAX_SEGMENT_LENGTH));\n+    static final int INITIAL_SEGMENTS = 10;\n+    static final int SEGMENT_SHIFT = 25;\n+    static final int SEGMENT_MASK = MAX_SEGMENT_LENGTH - 1;\n+\n+    private long[][] array;\n+    private int segments;\n+    private int capacity;\n+\n+    public AdaptiveLongBigArray()\n+    {\n+        array = new long[INITIAL_SEGMENTS][];\n+    }\n+\n+    public long sizeOf()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e06a68500404939b3de6084d17c77da164087409"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjEzODE1Mw==", "bodyText": "static import sizeOf", "url": "https://github.com/prestodb/presto/pull/15517#discussion_r542138153", "createdAt": "2020-12-14T06:20:50Z", "author": {"login": "yingsu00"}, "path": "presto-array/src/main/java/com/facebook/presto/array/AdaptiveLongBigArray.java", "diffHunk": "@@ -0,0 +1,143 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.array;\n+\n+import io.airlift.slice.SizeOf;\n+import org.openjdk.jol.info.ClassLayout;\n+\n+import java.util.Arrays;\n+\n+import static io.airlift.slice.SizeOf.sizeOfLongArray;\n+import static java.lang.StrictMath.toIntExact;\n+\n+/**\n+ * This variation of BigArray is designed to expand segments up to some reasonable extend\n+ * and add more segments if the maximum segment capacity is reached\n+ * This implementation allows to keep the redirection table small so it does fit into L1 CPU cache\n+ */\n+public class AdaptiveLongBigArray\n+{\n+    // visible for testing\n+    static final int INSTANCE_SIZE = ClassLayout.parseClass(AdaptiveLongBigArray.class).instanceSize();\n+\n+    // settings are constants due to efficiency considerations\n+    static final int INITIAL_SEGMENT_LENGTH = 16 * 1024; // 128KB\n+    static final int MAX_SEGMENT_LENGTH = 32 * 1024 * 1024; // 256MB\n+    static final int MAX_SEGMENT_SIZE_IN_BYTES = toIntExact(sizeOfLongArray(MAX_SEGMENT_LENGTH));\n+    static final int INITIAL_SEGMENTS = 10;\n+    static final int SEGMENT_SHIFT = 25;\n+    static final int SEGMENT_MASK = MAX_SEGMENT_LENGTH - 1;\n+\n+    private long[][] array;\n+    private int segments;\n+    private int capacity;\n+\n+    public AdaptiveLongBigArray()\n+    {\n+        array = new long[INITIAL_SEGMENTS][];\n+    }\n+\n+    public long sizeOf()\n+    {\n+        long result = INSTANCE_SIZE + SizeOf.sizeOf(array);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e06a68500404939b3de6084d17c77da164087409"}, "originalPosition": 53}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e06a68500404939b3de6084d17c77da164087409", "author": {"user": {"login": "arhimondr", "name": "Andrii Rosa"}}, "url": "https://github.com/prestodb/presto/commit/e06a68500404939b3de6084d17c77da164087409", "committedDate": "2020-12-12T03:21:03Z", "message": "Avoid costly resizes of the addresses dynamic array in PagesIndex"}, "afterCommit": {"oid": "c9ae19fa632196646e91ff63ea63776f31b5e2b8", "author": {"user": {"login": "arhimondr", "name": "Andrii Rosa"}}, "url": "https://github.com/prestodb/presto/commit/c9ae19fa632196646e91ff63ea63776f31b5e2b8", "committedDate": "2020-12-22T00:55:12Z", "message": "Avoid costly resizes of the addresses dynamic array in PagesIndex"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c9ae19fa632196646e91ff63ea63776f31b5e2b8", "author": {"user": {"login": "arhimondr", "name": "Andrii Rosa"}}, "url": "https://github.com/prestodb/presto/commit/c9ae19fa632196646e91ff63ea63776f31b5e2b8", "committedDate": "2020-12-22T00:55:12Z", "message": "Avoid costly resizes of the addresses dynamic array in PagesIndex"}, "afterCommit": {"oid": "46bb00d9267e1e8d0965f23a13f5af77ecc9602b", "author": {"user": {"login": "arhimondr", "name": "Andrii Rosa"}}, "url": "https://github.com/prestodb/presto/commit/46bb00d9267e1e8d0965f23a13f5af77ecc9602b", "committedDate": "2020-12-22T01:17:53Z", "message": "Avoid costly resizes of the addresses dynamic array in PagesIndex"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2ODI3MjM3", "url": "https://github.com/prestodb/presto/pull/15517#pullrequestreview-556827237", "createdAt": "2020-12-22T05:27:41Z", "commit": {"oid": "46bb00d9267e1e8d0965f23a13f5af77ecc9602b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3NDIzMzc5", "url": "https://github.com/prestodb/presto/pull/15517#pullrequestreview-557423379", "createdAt": "2020-12-22T23:25:24Z", "commit": {"oid": "46bb00d9267e1e8d0965f23a13f5af77ecc9602b"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQyMzoyNToyNFrOIKMGYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQyMzo1NjozNVrOIKMnYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzU1NDkxNQ==", "bodyText": "It'll be nice to add some comments about the segments and capacity, e.g what's the unit of the capacity? And how the array is allocated.", "url": "https://github.com/prestodb/presto/pull/15517#discussion_r547554915", "createdAt": "2020-12-22T23:25:24Z", "author": {"login": "yingsu00"}, "path": "presto-array/src/main/java/com/facebook/presto/array/AdaptiveLongBigArray.java", "diffHunk": "@@ -0,0 +1,141 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.array;\n+\n+import org.openjdk.jol.info.ClassLayout;\n+\n+import java.util.Arrays;\n+\n+import static io.airlift.slice.SizeOf.sizeOf;\n+import static io.airlift.slice.SizeOf.sizeOfLongArray;\n+\n+/**\n+ * This variation of BigArray is designed to expand segments up to some reasonable extend\n+ * and add more segments if the maximum segment capacity is reached\n+ * This implementation allows to keep the redirection table small so it does fit into L1 CPU cache\n+ */\n+public class AdaptiveLongBigArray\n+{\n+    // visible for testing\n+    static final int INSTANCE_SIZE = ClassLayout.parseClass(AdaptiveLongBigArray.class).instanceSize();\n+\n+    // settings are constants due to efficiency considerations\n+    static final int INITIAL_SEGMENT_LENGTH = 16 * 1024; // 128KB\n+    static final int MAX_SEGMENT_LENGTH = 32 * 1024 * 1024; // 256MB\n+    static final long MAX_SEGMENT_SIZE_IN_BYTES = sizeOfLongArray(MAX_SEGMENT_LENGTH);\n+    static final int INITIAL_SEGMENTS = 10;\n+    static final int SEGMENT_SHIFT = 25;\n+    static final int SEGMENT_MASK = MAX_SEGMENT_LENGTH - 1;\n+\n+    private long[][] array;\n+    private int segments;\n+    private int capacity;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "46bb00d9267e1e8d0965f23a13f5af77ecc9602b"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzU2MzM2Mw==", "bodyText": "This can just be segmentLength *= 2; which is easier to understand. The compiler should be able to compile it to bit shifting.", "url": "https://github.com/prestodb/presto/pull/15517#discussion_r547563363", "createdAt": "2020-12-22T23:56:35Z", "author": {"login": "yingsu00"}, "path": "presto-array/src/main/java/com/facebook/presto/array/AdaptiveLongBigArray.java", "diffHunk": "@@ -0,0 +1,141 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.array;\n+\n+import org.openjdk.jol.info.ClassLayout;\n+\n+import java.util.Arrays;\n+\n+import static io.airlift.slice.SizeOf.sizeOf;\n+import static io.airlift.slice.SizeOf.sizeOfLongArray;\n+\n+/**\n+ * This variation of BigArray is designed to expand segments up to some reasonable extend\n+ * and add more segments if the maximum segment capacity is reached\n+ * This implementation allows to keep the redirection table small so it does fit into L1 CPU cache\n+ */\n+public class AdaptiveLongBigArray\n+{\n+    // visible for testing\n+    static final int INSTANCE_SIZE = ClassLayout.parseClass(AdaptiveLongBigArray.class).instanceSize();\n+\n+    // settings are constants due to efficiency considerations\n+    static final int INITIAL_SEGMENT_LENGTH = 16 * 1024; // 128KB\n+    static final int MAX_SEGMENT_LENGTH = 32 * 1024 * 1024; // 256MB\n+    static final long MAX_SEGMENT_SIZE_IN_BYTES = sizeOfLongArray(MAX_SEGMENT_LENGTH);\n+    static final int INITIAL_SEGMENTS = 10;\n+    static final int SEGMENT_SHIFT = 25;\n+    static final int SEGMENT_MASK = MAX_SEGMENT_LENGTH - 1;\n+\n+    private long[][] array;\n+    private int segments;\n+    private int capacity;\n+\n+    public AdaptiveLongBigArray()\n+    {\n+        array = new long[INITIAL_SEGMENTS][];\n+    }\n+\n+    public long getRetainedSizeInBytes()\n+    {\n+        long result = INSTANCE_SIZE + sizeOf(array);\n+        if (segments == 1) {\n+            result += sizeOfLongArray(array[0].length);\n+        }\n+        else if (segments > 1) {\n+            result += segments * MAX_SEGMENT_SIZE_IN_BYTES;\n+        }\n+        return result;\n+    }\n+\n+    public long get(int index)\n+    {\n+        return array[segment(index)][offset(index)];\n+    }\n+\n+    public void set(int index, long value)\n+    {\n+        array[segment(index)][offset(index)] = value;\n+    }\n+\n+    public void swap(int first, int second)\n+    {\n+        long[] firstSegment = array[segment(first)];\n+        int firstOffset = offset(first);\n+\n+        long[] secondSegment = array[segment(first)];\n+        int secondOffset = offset(second);\n+\n+        long tmp = firstSegment[firstOffset];\n+        firstSegment[firstOffset] = secondSegment[secondOffset];\n+        secondSegment[secondOffset] = tmp;\n+    }\n+\n+    public void ensureCapacity(int length)\n+    {\n+        if (capacity >= length) {\n+            return;\n+        }\n+\n+        int lastIndex = length - 1;\n+        int segment = segment(lastIndex);\n+        int offset = offset(lastIndex);\n+\n+        // expand segments array if needed\n+        if (segment >= array.length) {\n+            array = Arrays.copyOf(array, array.length * 2);\n+        }\n+\n+        if (segment == 0) {\n+            if (array[0] == null) {\n+                array[0] = new long[INITIAL_SEGMENT_LENGTH];\n+            }\n+            // expand segment if needed\n+            if (offset >= array[0].length) {\n+                int segmentLength = array[0].length;\n+                while (offset >= segmentLength) {\n+                    segmentLength <<= 1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "46bb00d9267e1e8d0965f23a13f5af77ecc9602b"}, "originalPosition": 108}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d07f43bee0330a0f81624bd3370977596260be0", "author": {"user": {"login": "arhimondr", "name": "Andrii Rosa"}}, "url": "https://github.com/prestodb/presto/commit/3d07f43bee0330a0f81624bd3370977596260be0", "committedDate": "2020-12-23T00:16:42Z", "message": "Avoid costly resizes of the addresses dynamic array in PagesIndex"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "46bb00d9267e1e8d0965f23a13f5af77ecc9602b", "author": {"user": {"login": "arhimondr", "name": "Andrii Rosa"}}, "url": "https://github.com/prestodb/presto/commit/46bb00d9267e1e8d0965f23a13f5af77ecc9602b", "committedDate": "2020-12-22T01:17:53Z", "message": "Avoid costly resizes of the addresses dynamic array in PagesIndex"}, "afterCommit": {"oid": "3d07f43bee0330a0f81624bd3370977596260be0", "author": {"user": {"login": "arhimondr", "name": "Andrii Rosa"}}, "url": "https://github.com/prestodb/presto/commit/3d07f43bee0330a0f81624bd3370977596260be0", "committedDate": "2020-12-23T00:16:42Z", "message": "Avoid costly resizes of the addresses dynamic array in PagesIndex"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4534, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}