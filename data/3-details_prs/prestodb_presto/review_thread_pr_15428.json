{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE5NTM1MjA1", "number": 15428, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwMzowMDo0MFrOE5QOag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwMzowMTo1OVrOE5QPSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4NDcwMTIyOnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/com/facebook/presto/execution/FragmentResultCacheContext.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwMzowMDo0MFrOHzm0Rg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxODoyMzo1M1rOH0Lwgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzg3NTM5OA==", "bodyText": "remove this method?", "url": "https://github.com/prestodb/presto/pull/15428#discussion_r523875398", "createdAt": "2020-11-16T03:00:40Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/FragmentResultCacheContext.java", "diffHunk": "@@ -85,4 +106,9 @@ public CanonicalPlanFragment getCanonicalPlanFragment()\n     {\n         return canonicalPlanFragment;\n     }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41f220984be794c0db5439b215a358655e06b0fe"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ4MDY0Mg==", "bodyText": "For the scope of this PR, we could remove canonicalPlanFragment and its getter method in this class. We probably would introduce them back when trying to support partition-stats based predicate stripping.", "url": "https://github.com/prestodb/presto/pull/15428#discussion_r524480642", "createdAt": "2020-11-16T18:23:53Z", "author": {"login": "shixuan-fan"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/FragmentResultCacheContext.java", "diffHunk": "@@ -85,4 +106,9 @@ public CanonicalPlanFragment getCanonicalPlanFragment()\n     {\n         return canonicalPlanFragment;\n     }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzg3NTM5OA=="}, "originalCommit": {"oid": "41f220984be794c0db5439b215a358655e06b0fe"}, "originalPosition": 80}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4NDcwMzQ3OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/com/facebook/presto/execution/FragmentResultCacheContext.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwMzowMTo1OVrOHzm1hw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwMzowMTo1OVrOHzm1hw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzg3NTcxOQ==", "bodyText": "if (!canonicalPlanFragment.isPresent()) {\n    return Optional.empty();\n}\n\ntry {\n...", "url": "https://github.com/prestodb/presto/pull/15428#discussion_r523875719", "createdAt": "2020-11-16T03:01:59Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/FragmentResultCacheContext.java", "diffHunk": "@@ -24,34 +25,53 @@\n import com.facebook.presto.sql.planner.CanonicalPlanFragment;\n import com.facebook.presto.sql.planner.PartitioningScheme;\n import com.facebook.presto.sql.planner.plan.GroupIdNode;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n import com.google.common.collect.ImmutableSet;\n \n import java.util.Optional;\n import java.util.Set;\n \n import static com.facebook.presto.spi.plan.AggregationNode.Step.PARTIAL;\n import static com.facebook.presto.sql.planner.CanonicalPlanGenerator.generateCanonicalPlan;\n+import static com.google.common.hash.Hashing.sha256;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n import static java.util.Objects.requireNonNull;\n \n public class FragmentResultCacheContext\n {\n+    private static final Logger log = Logger.get(FragmentResultCacheContext.class);\n     private static final Set<Class<? extends PlanNode>> ALLOWED_CHILDREN_NODES = ImmutableSet.of(TableScanNode.class, FilterNode.class, ProjectNode.class, GroupIdNode.class);\n \n     private final FragmentResultCacheManager fragmentResultCacheManager;\n     private final CanonicalPlanFragment canonicalPlanFragment;\n+    private final String hashedCanonicalPlanFragment;\n \n     public static Optional<FragmentResultCacheContext> createFragmentResultCacheContext(\n             FragmentResultCacheManager fragmentResultCacheManager,\n             PlanNode root,\n             PartitioningScheme partitioningScheme,\n-            Session session)\n+            Session session,\n+            ObjectMapper objectMapper)\n     {\n         if (!SystemSessionProperties.isFragmentResultCachingEnabled(session) || !isEligibleForFragmentResultCaching(root)) {\n             return Optional.empty();\n         }\n \n         Optional<CanonicalPlanFragment> canonicalPlanFragment = generateCanonicalPlan(root, partitioningScheme);\n-        return canonicalPlanFragment.map(fragment -> new FragmentResultCacheContext(fragmentResultCacheManager, fragment));\n+        if (canonicalPlanFragment.isPresent()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41f220984be794c0db5439b215a358655e06b0fe"}, "originalPosition": 48}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3379, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}