{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyNjg2NDI0", "number": 14758, "title": "Fixes for DWRF encryption", "bodyText": "== NO RELEASE NOTE ==", "createdAt": "2020-07-01T13:05:21Z", "url": "https://github.com/prestodb/presto/pull/14758", "merged": true, "mergeCommit": {"oid": "1bc3803755541582ddf1d290d428b9e960d0602b"}, "closed": true, "closedAt": "2020-07-01T16:10:19Z", "author": {"login": "rschlussel"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcwpv6IgH2gAyNDQyNjg2NDI0Ojk0ZTE5MTFlN2Q1YThhM2I1NzNlNjc1OWNiNDVhMzcxMTY5MzU2ZjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwsRouAFqTQ0MDk4ODE5Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "94e1911e7d5a8a3b573e6759cb45a371169356f1", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/94e1911e7d5a8a3b573e6759cb45a371169356f1", "committedDate": "2020-07-01T12:52:53Z", "message": "Generate DataEncryptionKeys in OrcWriter\n\nPreviously this was passed in in the writer encryption group, but they\nshould be generated by the encryption provider"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da0590f1c22fc87c90eb26a777f35bdf92f5b6a9", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/da0590f1c22fc87c90eb26a777f35bdf92f5b6a9", "committedDate": "2020-07-01T12:52:53Z", "message": "Decrypt separately from compression\n\nPreviously we were using an EncryptingCompressor and\nDecryptingDecompressor.  However, this was incorrect for uncompressed\ndata, which can happen when the compressed output would be larger then\nuncompressed.  In those cases we use the uncompressed data, but we still\nwant to encrypt/decrypt it"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74f0e743e77444eb652db262996e19ba7af9ab3a", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/74f0e743e77444eb652db262996e19ba7af9ab3a", "committedDate": "2020-07-01T12:52:53Z", "message": "Fix encryption/decryption of encrypted metadata\n\nencrypted file statistics and stripe encryption groups should be\nencrypted/decrypted similar to compressed data, with 3 byte headers for\neach chunk.  Previously we were directly encrypting/decrypting the\nserialized fields."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ca1a50368a64a1d6453d6e86bea9aaba08cb3b0", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/3ca1a50368a64a1d6453d6e86bea9aaba08cb3b0", "committedDate": "2020-07-01T12:52:54Z", "message": "Fix reading and writing of column encodings for DWRF\n\nPreviously we weren't setting the column value for DWRF column\nencodings.  This is a problem for encryption because we need the column\nvalue to get the right column encoding for a column since we can't rely\non the index order."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f01d222857749695eb4beba3f752388cecc9342", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/3f01d222857749695eb4beba3f752388cecc9342", "committedDate": "2020-07-01T12:52:54Z", "message": "Use byte[] instead of slice for EncryptionLibrary\n\nThere's no reason to keep wrapping things in slices and then converting\nthem back to byte arrays, just use byte arrays in the interface"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25fbb7dea70a1bbf5d7306981ad9f5c123284022", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/25fbb7dea70a1bbf5d7306981ad9f5c123284022", "committedDate": "2020-07-01T12:52:54Z", "message": "Remove unused methods"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwODU1Nzgz", "url": "https://github.com/prestodb/presto/pull/14758#pullrequestreview-440855783", "createdAt": "2020-07-01T13:12:58Z", "commit": {"oid": "25fbb7dea70a1bbf5d7306981ad9f5c123284022"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwOTg4MTkz", "url": "https://github.com/prestodb/presto/pull/14758#pullrequestreview-440988193", "createdAt": "2020-07-01T15:41:52Z", "commit": {"oid": "25fbb7dea70a1bbf5d7306981ad9f5c123284022"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxNTo0MTo1MlrOGrrXDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxNTo0Nzo1OVrOGrrmqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ1MjM2Nw==", "bodyText": "do we have unit tests for stats of nested types?", "url": "https://github.com/prestodb/presto/pull/14758#discussion_r448452367", "createdAt": "2020-07-01T15:41:52Z", "author": {"login": "zzhao0"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/OrcWriter.java", "diffHunk": "@@ -623,19 +629,19 @@ public void close()\n             List<WriterEncryptionGroup> writerEncryptionGroups = dwrfWriterEncryption.get().getWriterEncryptionGroups();\n             for (int i = 0; i < writerEncryptionGroups.size(); i++) {\n                 WriterEncryptionGroup group = writerEncryptionGroups.get(i);\n-                List<byte[]> columnStatistics = encryptedStats.get(i)\n-                        .stream()\n-                        .map(DwrfMetadataWriter::toColumnStatistics)\n-                        .map(AbstractMessageLite::toByteArray)\n-                        .collect(toImmutableList());\n-\n                 DwrfProto.FileStatistics fileStatistics = toFileStatistics(encryptedStats.get(i));\n-                byte[] serializedStats = fileStatistics.toByteArray();\n+                DwrfDataEncryptor dwrfDataEncryptor = dwrfEncryptionInfo.getEncryptorByGroupId(i);\n+                OrcOutputBuffer buffer = new OrcOutputBuffer(compression, Optional.of(dwrfDataEncryptor), maxCompressionBufferSize);\n+                fileStatistics.writeTo(buffer);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25fbb7dea70a1bbf5d7306981ad9f5c123284022"}, "originalPosition": 115}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ1NDA3Mw==", "bodyText": "It's unclear to me how you handle encrypted but uncompressed file. Would be good to throw in that case if not supported at the moment", "url": "https://github.com/prestodb/presto/pull/14758#discussion_r448454073", "createdAt": "2020-07-01T15:44:30Z", "author": {"login": "zzhao0"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/OrcOutputBuffer.java", "diffHunk": "@@ -461,13 +456,21 @@ private void writeChunkToOutputStream(byte[] chunk, int offset, int length)\n \n         int compressedSize = compressor.compress(chunk, offset, length, compressionBuffer, 0, compressionBuffer.length);\n         if (compressedSize < length) {\n+            if (dwrfEncryptor.isPresent()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25fbb7dea70a1bbf5d7306981ad9f5c123284022"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ1NjM2MA==", "bodyText": "This logic is correct for encrypted and compressed file (and a single chunk/page is uncompressed). We need to handle encrypted but uncompressed file.", "url": "https://github.com/prestodb/presto/pull/14758#discussion_r448456360", "createdAt": "2020-07-01T15:47:59Z", "author": {"login": "zzhao0"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/stream/OrcInputStream.java", "diffHunk": "@@ -462,11 +467,19 @@ private void advance()\n         if (isUncompressed) {\n             buffer = ensureCapacity(buffer, chunkLength);\n             length = compressedSliceInput.read(buffer, 0, chunkLength);\n+            if (dwrfDecryptor.isPresent()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25fbb7dea70a1bbf5d7306981ad9f5c123284022"}, "originalPosition": 42}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1149, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}