{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE1MzYwNjcx", "number": 14500, "title": "Improve presto-druid escaping special chars in column and table name ", "bodyText": "1 escaping special characters in the column name\n2 escaping special characters in the table name\n3 escaping special characters for the json request to druid server\n4 fix bugs for extra escaping when scan hdfs file.\n== NO RELEASE NOTE ==", "createdAt": "2020-05-08T18:10:33Z", "url": "https://github.com/prestodb/presto/pull/14500", "merged": true, "mergeCommit": {"oid": "86a6e586bdeff8f5723851814a7ca9389d855756"}, "closed": true, "closedAt": "2020-05-12T17:14:55Z", "author": {"login": "beinan"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcfcqJrgBqjMzMTg4OTEwMzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcgd6e1gFqTQwOTcyMDg1MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "da4512ff658f7ff9df4892f7e987ca76c7a0e90e", "author": {"user": {"login": "beinan", "name": "Beinan"}}, "url": "https://github.com/prestodb/presto/commit/da4512ff658f7ff9df4892f7e987ca76c7a0e90e", "committedDate": "2020-05-08T19:36:34Z", "message": "Escaping variable name and the column name inside distinct count.\nFix unit test"}, "afterCommit": {"oid": "6dfe89a20423c973d6e1a6338153474e041f36a4", "author": {"user": {"login": "beinan", "name": "Beinan"}}, "url": "https://github.com/prestodb/presto/commit/6dfe89a20423c973d6e1a6338153474e041f36a4", "committedDate": "2020-05-09T02:00:17Z", "message": "Escaping variable name and the column name inside distinct count.\nFix unit test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4NjIyMzA4", "url": "https://github.com/prestodb/presto/pull/14500#pullrequestreview-408622308", "createdAt": "2020-05-09T07:30:14Z", "commit": {"oid": "6dfe89a20423c973d6e1a6338153474e041f36a4"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQwNzozMDoxNFrOGS5KMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQwNzozNjo0M1rOGS5Mfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ2NDA0OQ==", "bodyText": "private?", "url": "https://github.com/prestodb/presto/pull/14500#discussion_r422464049", "createdAt": "2020-05-09T07:30:14Z", "author": {"login": "zhenxiao"}, "path": "presto-druid/src/main/java/com/facebook/presto/druid/DruidClient.java", "diffHunk": "@@ -183,4 +185,44 @@ public InputStream handle(Request request, com.facebook.airlift.http.client.Resp\n             }\n         }\n     }\n+    public static class DruidRequestBody", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6dfe89a20423c973d6e1a6338153474e041f36a4"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ2NDA2MA==", "bodyText": "add blank line below", "url": "https://github.com/prestodb/presto/pull/14500#discussion_r422464060", "createdAt": "2020-05-09T07:30:28Z", "author": {"login": "zhenxiao"}, "path": "presto-druid/src/main/java/com/facebook/presto/druid/DruidClient.java", "diffHunk": "@@ -183,4 +185,44 @@ public InputStream handle(Request request, com.facebook.airlift.http.client.Resp\n             }\n         }\n     }\n+    public static class DruidRequestBody\n+    {\n+        private String query;\n+        private String resultFormat;\n+        private boolean queryHeader;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6dfe89a20423c973d6e1a6338153474e041f36a4"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ2NDE1NQ==", "bodyText": "this.query = requireNonNull(query);", "url": "https://github.com/prestodb/presto/pull/14500#discussion_r422464155", "createdAt": "2020-05-09T07:31:20Z", "author": {"login": "zhenxiao"}, "path": "presto-druid/src/main/java/com/facebook/presto/druid/DruidClient.java", "diffHunk": "@@ -183,4 +185,44 @@ public InputStream handle(Request request, com.facebook.airlift.http.client.Resp\n             }\n         }\n     }\n+    public static class DruidRequestBody\n+    {\n+        private String query;\n+        private String resultFormat;\n+        private boolean queryHeader;\n+        @JsonCreator\n+        public DruidRequestBody(\n+                @JsonProperty(\"query\") String query,\n+                @JsonProperty(\"resultFormat\") String resultFormat,\n+                @JsonProperty(\"queryHeader\") boolean queryHeader)\n+        {\n+            requireNonNull(query);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6dfe89a20423c973d6e1a6338153474e041f36a4"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ2NDQwNA==", "bodyText": "this. resultFormat = requireNonNull(resultFormat);", "url": "https://github.com/prestodb/presto/pull/14500#discussion_r422464404", "createdAt": "2020-05-09T07:34:13Z", "author": {"login": "zhenxiao"}, "path": "presto-druid/src/main/java/com/facebook/presto/druid/DruidClient.java", "diffHunk": "@@ -183,4 +185,44 @@ public InputStream handle(Request request, com.facebook.airlift.http.client.Resp\n             }\n         }\n     }\n+    public static class DruidRequestBody\n+    {\n+        private String query;\n+        private String resultFormat;\n+        private boolean queryHeader;\n+        @JsonCreator\n+        public DruidRequestBody(\n+                @JsonProperty(\"query\") String query,\n+                @JsonProperty(\"resultFormat\") String resultFormat,\n+                @JsonProperty(\"queryHeader\") boolean queryHeader)\n+        {\n+            requireNonNull(query);\n+            this.query = query;\n+            this.resultFormat = resultFormat;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6dfe89a20423c973d6e1a6338153474e041f36a4"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ2NDYwMw==", "bodyText": "create a private function to add quotes to column names. could be used here and below", "url": "https://github.com/prestodb/presto/pull/14500#discussion_r422464603", "createdAt": "2020-05-09T07:36:15Z", "author": {"login": "zhenxiao"}, "path": "presto-druid/src/main/java/com/facebook/presto/druid/DruidQueryGeneratorContext.java", "diffHunk": "@@ -168,7 +168,7 @@ public DruidQueryGeneratorContext withAggregation(\n                     String definition = entry.getValue().getDefinition();\n                     int start = definition.indexOf(\"(\");\n                     int end = definition.indexOf(\")\");\n-                    String countDistinctClause = \"count ( distinct \" + definition.substring(start + 1, end) + \")\";\n+                    String countDistinctClause = \"count ( distinct \\\"\" + definition.substring(start + 1, end) + \"\\\")\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6dfe89a20423c973d6e1a6338153474e041f36a4"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ2NDYzOA==", "bodyText": "private function to add quotes to table or column names. could be used here", "url": "https://github.com/prestodb/presto/pull/14500#discussion_r422464638", "createdAt": "2020-05-09T07:36:43Z", "author": {"login": "zhenxiao"}, "path": "presto-druid/src/main/java/com/facebook/presto/druid/DruidQueryGeneratorContext.java", "diffHunk": "@@ -244,14 +244,14 @@ private boolean hasAggregation()\n         }\n \n         String expressions = selections.entrySet().stream()\n-                .map(s -> s.getValue().getDefinition())\n+                .map(s -> s.getValue().getEscapedDefinition())\n                 .collect(Collectors.joining(\", \"));\n         if (expressions.isEmpty()) {\n             throw new PrestoException(DRUID_QUERY_GENERATOR_FAILURE, \"Empty Druid query\");\n         }\n \n         String tableName = from.orElseThrow(() -> new PrestoException(DRUID_QUERY_GENERATOR_FAILURE, \"Table name missing in Druid query\"));\n-        String query = \"SELECT \" + expressions + \" FROM \" + tableName;\n+        String query = \"SELECT \" + expressions + \" FROM \\\"\" + tableName + \"\\\"\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6dfe89a20423c973d6e1a6338153474e041f36a4"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "050c7d4c0756521d69e93e0133b9425d239b0684", "author": {"user": {"login": "beinan", "name": "Beinan"}}, "url": "https://github.com/prestodb/presto/commit/050c7d4c0756521d69e93e0133b9425d239b0684", "committedDate": "2020-05-10T01:54:29Z", "message": "Fix json type deserialization issue on DruidSegmentInfo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "782d922b0abcbb0579781f6472044f7688722318", "author": {"user": {"login": "beinan", "name": "Beinan"}}, "url": "https://github.com/prestodb/presto/commit/782d922b0abcbb0579781f6472044f7688722318", "committedDate": "2020-05-10T01:54:29Z", "message": "Escaping special characters in druid table name and column name."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95e122477cf1e7e800eedf878b21770dffff9c85", "author": {"user": {"login": "beinan", "name": "Beinan"}}, "url": "https://github.com/prestodb/presto/commit/95e122477cf1e7e800eedf878b21770dffff9c85", "committedDate": "2020-05-10T01:54:30Z", "message": "Fix the exception of 'Internal file \\\"column_name\\\" doesn't exist'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00e665dcf8fcdcb892d2c7a7e18b639e681e2f90", "author": {"user": {"login": "beinan", "name": "Beinan"}}, "url": "https://github.com/prestodb/presto/commit/00e665dcf8fcdcb892d2c7a7e18b639e681e2f90", "committedDate": "2020-05-10T01:54:30Z", "message": "Improve JSON serialization for the http requests to Druid"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1551daa98ced40845277aafb2734f4e5aa3eed27", "author": {"user": {"login": "beinan", "name": "Beinan"}}, "url": "https://github.com/prestodb/presto/commit/1551daa98ced40845277aafb2734f4e5aa3eed27", "committedDate": "2020-05-10T01:54:30Z", "message": "Escaping variable name and the column name inside distinct count.\nFix unit test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e005afefda11543a7b20e36f98082ef116afd3cc", "author": {"user": {"login": "beinan", "name": "Beinan"}}, "url": "https://github.com/prestodb/presto/commit/e005afefda11543a7b20e36f98082ef116afd3cc", "committedDate": "2020-05-09T22:30:42Z", "message": "Refactoring and fix code reivew issue"}, "afterCommit": {"oid": "39cc7ccd729914324a4d3b22e67161f0ae51387f", "author": {"user": {"login": "beinan", "name": "Beinan"}}, "url": "https://github.com/prestodb/presto/commit/39cc7ccd729914324a4d3b22e67161f0ae51387f", "committedDate": "2020-05-10T01:54:31Z", "message": "Refactoring and fix code reivew issue"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4NzE0MTUx", "url": "https://github.com/prestodb/presto/pull/14500#pullrequestreview-408714151", "createdAt": "2020-05-10T07:12:24Z", "commit": {"oid": "39cc7ccd729914324a4d3b22e67161f0ae51387f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMFQwNzoxMjoyNFrOGTBdUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMFQwNzoxMjoyNFrOGTBdUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjYwMDAxNg==", "bodyText": "remove line 200?", "url": "https://github.com/prestodb/presto/pull/14500#discussion_r422600016", "createdAt": "2020-05-10T07:12:24Z", "author": {"login": "zhenxiao"}, "path": "presto-druid/src/main/java/com/facebook/presto/druid/DruidClient.java", "diffHunk": "@@ -183,4 +185,44 @@ public InputStream handle(Request request, com.facebook.airlift.http.client.Resp\n             }\n         }\n     }\n+    public static class DruidRequestBody\n+    {\n+        private String query;\n+        private String resultFormat;\n+        private boolean queryHeader;\n+        @JsonCreator\n+        public DruidRequestBody(\n+                @JsonProperty(\"query\") String query,\n+                @JsonProperty(\"resultFormat\") String resultFormat,\n+                @JsonProperty(\"queryHeader\") boolean queryHeader)\n+        {\n+            requireNonNull(query);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ2NDE1NQ=="}, "originalCommit": {"oid": "6dfe89a20423c973d6e1a6338153474e041f36a4"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "184ad6a3982085ba531bde378803f6cb5b97f9bf", "author": {"user": {"login": "beinan", "name": "Beinan"}}, "url": "https://github.com/prestodb/presto/commit/184ad6a3982085ba531bde378803f6cb5b97f9bf", "committedDate": "2020-05-12T05:34:23Z", "message": "Refactoring and fix code reivew issue"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "39cc7ccd729914324a4d3b22e67161f0ae51387f", "author": {"user": {"login": "beinan", "name": "Beinan"}}, "url": "https://github.com/prestodb/presto/commit/39cc7ccd729914324a4d3b22e67161f0ae51387f", "committedDate": "2020-05-10T01:54:31Z", "message": "Refactoring and fix code reivew issue"}, "afterCommit": {"oid": "184ad6a3982085ba531bde378803f6cb5b97f9bf", "author": {"user": {"login": "beinan", "name": "Beinan"}}, "url": "https://github.com/prestodb/presto/commit/184ad6a3982085ba531bde378803f6cb5b97f9bf", "committedDate": "2020-05-12T05:34:23Z", "message": "Refactoring and fix code reivew issue"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5NzIwODUw", "url": "https://github.com/prestodb/presto/pull/14500#pullrequestreview-409720850", "createdAt": "2020-05-12T06:02:47Z", "commit": {"oid": "184ad6a3982085ba531bde378803f6cb5b97f9bf"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1601, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}