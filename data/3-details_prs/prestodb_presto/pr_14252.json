{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg5MDYzOTk0", "number": 14252, "title": "Fix subscript expression optimization during subfield pushdown", "bodyText": "The latest code in the PushdownSubFields optimizes the subscript expression before creating the subfields. Therefore there are some cases where the optimization results in null in case of maps.\nSo when we try to extract the subfield with null it results in an NPE. Adding a null check to the index optimized expression resolves the issue.\n== NO RELEASE NOTE ==", "createdAt": "2020-03-16T08:21:39Z", "url": "https://github.com/prestodb/presto/pull/14252", "merged": true, "mergeCommit": {"oid": "0491783e950e2812b1c4b0a37b16553c050577f5"}, "closed": true, "closedAt": "2020-03-17T21:49:05Z", "author": {"login": "bhhari"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcOJz_GgBqjMxMzIwNzU5MTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcOoShFgFqTM3NjM2MDI1MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "09c474e2c3bb9992c286e61de612faa68447c7e3", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/09c474e2c3bb9992c286e61de612faa68447c7e3", "committedDate": "2020-03-16T08:17:31Z", "message": "Fix subscript expression optimization during subfield pushdown"}, "afterCommit": {"oid": "feb0f1a895dfdcfbc4e567196e1c9bb7561b0a61", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/feb0f1a895dfdcfbc4e567196e1c9bb7561b0a61", "committedDate": "2020-03-16T08:26:42Z", "message": "Fix subscript expression optimization during subfield pushdown"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "feb0f1a895dfdcfbc4e567196e1c9bb7561b0a61", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/feb0f1a895dfdcfbc4e567196e1c9bb7561b0a61", "committedDate": "2020-03-16T08:26:42Z", "message": "Fix subscript expression optimization during subfield pushdown"}, "afterCommit": {"oid": "0a7342b7347eeb1a4db1c2c0f059068e9a3ab08d", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/0a7342b7347eeb1a4db1c2c0f059068e9a3ab08d", "committedDate": "2020-03-16T08:41:35Z", "message": "Fix subscript expression optimization during subfield pushdown"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1MjkxMTQz", "url": "https://github.com/prestodb/presto/pull/14252#pullrequestreview-375291143", "createdAt": "2020-03-16T14:50:45Z", "commit": {"oid": "0a7342b7347eeb1a4db1c2c0f059068e9a3ab08d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxNDo1MDo0NlrOF233dA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxNDo1NDozNFrOF24CeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA4Mjc0MA==", "bodyText": "Do we need the same check at L501?", "url": "https://github.com/prestodb/presto/pull/14252#discussion_r393082740", "createdAt": "2020-03-16T14:50:46Z", "author": {"login": "mbasmanova"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/optimizations/PushdownSubfields.java", "diffHunk": "@@ -520,6 +520,9 @@ private static String getColumnName(Session session, Metadata metadata, TableHan\n \n                     if (indexExpression instanceof ConstantExpression) {\n                         Object index = ((ConstantExpression) indexExpression).getValue();\n+                        if (index == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a7342b7347eeb1a4db1c2c0f059068e9a3ab08d"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA4MzI5Ng==", "bodyText": "Planner tests better go to TestHiveLogicalPlanner", "url": "https://github.com/prestodb/presto/pull/14252#discussion_r393083296", "createdAt": "2020-03-16T14:51:27Z", "author": {"login": "mbasmanova"}, "path": "presto-hive/src/test/java/com/facebook/presto/hive/TestHivePushdownFilterQueries.java", "diffHunk": "@@ -877,6 +877,15 @@ public void testStructSchemaEvolution()\n         assertQuery(\"SELECT * FROM test_struct_add_column\", \"SELECT (1, 2, 3) UNION ALL SELECT (1, 2, null)\");\n     }\n \n+    @Test\n+    public void testOptimizedSubscriptExpression()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a7342b7347eeb1a4db1c2c0f059068e9a3ab08d"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA4NTU2MQ==", "bodyText": "We need to use unique table names to allow tests to run concurrently. To make sure table names don't repeat, we tend to use names that match the test name. Here, it would be test_optimized_subscript_expression.", "url": "https://github.com/prestodb/presto/pull/14252#discussion_r393085561", "createdAt": "2020-03-16T14:54:34Z", "author": {"login": "mbasmanova"}, "path": "presto-hive/src/test/java/com/facebook/presto/hive/TestHivePushdownFilterQueries.java", "diffHunk": "@@ -877,6 +877,15 @@ public void testStructSchemaEvolution()\n         assertQuery(\"SELECT * FROM test_struct_add_column\", \"SELECT (1, 2, 3) UNION ALL SELECT (1, 2, null)\");\n     }\n \n+    @Test\n+    public void testOptimizedSubscriptExpression()\n+    {\n+        getQueryRunner().execute(\"CREATE TABLE test_varchar_maps AS \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a7342b7347eeb1a4db1c2c0f059068e9a3ab08d"}, "originalPosition": 7}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0a7342b7347eeb1a4db1c2c0f059068e9a3ab08d", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/0a7342b7347eeb1a4db1c2c0f059068e9a3ab08d", "committedDate": "2020-03-16T08:41:35Z", "message": "Fix subscript expression optimization during subfield pushdown"}, "afterCommit": {"oid": "3d05bd2b93cafd1cabd5294440e4b1bae6a6e1ec", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/3d05bd2b93cafd1cabd5294440e4b1bae6a6e1ec", "committedDate": "2020-03-16T23:07:09Z", "message": "Fix subscript expression optimization during subfield pushdown"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e17490ba35754e5217003eb79281dc42836e691c", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/e17490ba35754e5217003eb79281dc42836e691c", "committedDate": "2020-03-17T19:55:24Z", "message": "Fix subscript expression optimization during subfield pushdown"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3d05bd2b93cafd1cabd5294440e4b1bae6a6e1ec", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/3d05bd2b93cafd1cabd5294440e4b1bae6a6e1ec", "committedDate": "2020-03-16T23:07:09Z", "message": "Fix subscript expression optimization during subfield pushdown"}, "afterCommit": {"oid": "e17490ba35754e5217003eb79281dc42836e691c", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/e17490ba35754e5217003eb79281dc42836e691c", "committedDate": "2020-03-17T19:55:24Z", "message": "Fix subscript expression optimization during subfield pushdown"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2MzYwMjUw", "url": "https://github.com/prestodb/presto/pull/14252#pullrequestreview-376360250", "createdAt": "2020-03-17T19:57:27Z", "commit": {"oid": "e17490ba35754e5217003eb79281dc42836e691c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2052, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}