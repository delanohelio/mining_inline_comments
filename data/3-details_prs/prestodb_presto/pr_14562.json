{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIwODcxOTg3", "number": 14562, "title": "Streamlined implementation of core control flow and logical operators", "bodyText": "Streamlined and simplified the control flow and logical operators to be flat if/goto/end pattern. In addition, flattened logical operators so the code generated is simpler and can be optimized better. Also for switch, we don't generate nested IF anymore. This also sets up for better/more efficient null-handling going forward.\n== NO RELEASE NOTES ==", "createdAt": "2020-05-20T16:33:41Z", "url": "https://github.com/prestodb/presto/pull/14562", "merged": true, "mergeCommit": {"oid": "6fea1e47c3971f525b4b87d6dfcdc4613c9b9bc2"}, "closed": true, "closedAt": "2020-06-02T21:16:39Z", "author": {"login": "kaikalur"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcjLxzRgBqjMzNTczMjY2MjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcnYxaGgBqjMzOTg4NDE0MjA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "07a03c6a9ecfeb76b5ea9181401b8b2953645229", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/07a03c6a9ecfeb76b5ea9181401b8b2953645229", "committedDate": "2020-05-20T16:24:26Z", "message": "Streamlined implementation of core control operators"}, "afterCommit": {"oid": "7f87c7927ffb093f0a12cb13ac745b7d4faac343", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/7f87c7927ffb093f0a12cb13ac745b7d4faac343", "committedDate": "2020-05-20T16:36:21Z", "message": "Streamlined implementation of core control operators"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7f87c7927ffb093f0a12cb13ac745b7d4faac343", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/7f87c7927ffb093f0a12cb13ac745b7d4faac343", "committedDate": "2020-05-20T16:36:21Z", "message": "Streamlined implementation of core control operators"}, "afterCommit": {"oid": "ed008a179e20381abad73be1957108ec5b18301c", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/ed008a179e20381abad73be1957108ec5b18301c", "committedDate": "2020-05-20T16:38:13Z", "message": "Streamlined implementation of core control operators"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ed008a179e20381abad73be1957108ec5b18301c", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/ed008a179e20381abad73be1957108ec5b18301c", "committedDate": "2020-05-20T16:38:13Z", "message": "Streamlined implementation of core control operators"}, "afterCommit": {"oid": "42f6c6d7835efeaa14e2878c7090333b83b3edc0", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/42f6c6d7835efeaa14e2878c7090333b83b3edc0", "committedDate": "2020-05-20T16:39:04Z", "message": "Streamlined implementation of core control operators"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "42f6c6d7835efeaa14e2878c7090333b83b3edc0", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/42f6c6d7835efeaa14e2878c7090333b83b3edc0", "committedDate": "2020-05-20T16:39:04Z", "message": "Streamlined implementation of core control operators"}, "afterCommit": {"oid": "05c93893fb6d75dcc6e020d3c3666863280c6070", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/05c93893fb6d75dcc6e020d3c3666863280c6070", "committedDate": "2020-05-20T16:40:03Z", "message": "Streamlined implementation of core control operators"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "05c93893fb6d75dcc6e020d3c3666863280c6070", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/05c93893fb6d75dcc6e020d3c3666863280c6070", "committedDate": "2020-05-20T16:40:03Z", "message": "Streamlined implementation of core control operators"}, "afterCommit": {"oid": "f738add47f311365f553f888eb24912848a6105c", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/f738add47f311365f553f888eb24912848a6105c", "committedDate": "2020-05-20T16:41:02Z", "message": "Streamlined implementation of core control operators"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4NTc0NTc2", "url": "https://github.com/prestodb/presto/pull/14562#pullrequestreview-418574576", "createdAt": "2020-05-26T18:39:43Z", "commit": {"oid": "f738add47f311365f553f888eb24912848a6105c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxODozOTo0M1rOGarYpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxODozOTo0M1rOGarYpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYyNjk4Mg==", "bodyText": "Maybe put this in .comment so people can see this in bytecode dump.", "url": "https://github.com/prestodb/presto/pull/14562#discussion_r430626982", "createdAt": "2020-05-26T18:39:43Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/gen/AndCodeGenerator.java", "diffHunk": "@@ -36,68 +38,74 @@ public BytecodeNode generateExpression(BytecodeGeneratorContext generator, Type\n     {\n         Preconditions.checkArgument(arguments.size() == 2);\n \n-        Variable wasNull = generator.wasNull();\n+        // We flatten the AND here.\n+        Stack<RowExpression> stack = new Stack<RowExpression>();\n+        stack.push(arguments.get(1));\n+        stack.push(arguments.get(0));\n+\n+        List<RowExpression> flattenedArgs = new ArrayList<RowExpression>();\n+        do {\n+            RowExpression operand = stack.pop();\n+            if (operand instanceof SpecialFormExpression &&\n+                    ((SpecialFormExpression) operand).getForm() == SpecialFormExpression.Form.AND) {\n+                stack.push(((SpecialFormExpression) operand).getArguments().get(1));\n+                stack.push(((SpecialFormExpression) operand).getArguments().get(0));\n+            }\n+            else {\n+                flattenedArgs.add(operand);\n+            }\n+        } while (!stack.empty());\n+\n         BytecodeBlock block = new BytecodeBlock()\n                 .comment(\"AND\")\n                 .setDescription(\"AND\");\n \n-        BytecodeNode left = generator.generate(arguments.get(0), Optional.empty());\n-        BytecodeNode right = generator.generate(arguments.get(1), Optional.empty());\n-\n-        block.append(left);\n-\n-        IfStatement ifLeftIsNull = new IfStatement(\"if left wasNull...\")\n-                .condition(wasNull);\n-\n-        LabelNode end = new LabelNode(\"end\");\n-        ifLeftIsNull.ifTrue()\n-                .comment(\"clear the null flag, pop left value off stack, and push left null flag on the stack (true)\")\n-                .append(wasNull.set(constantFalse()))\n-                .pop(arguments.get(0).getType().getJavaType()) // discard left value\n-                .push(true);\n+        LabelNode falseLabel = new LabelNode(\"false\");\n+        LabelNode endLabel = new LabelNode(\"end\");\n+        Variable wasNull = generator.wasNull();\n \n-        LabelNode leftIsTrue = new LabelNode(\"leftIsTrue\");\n-        ifLeftIsNull.ifFalse()\n-                .comment(\"if left is false, push false, and goto end\")\n-                .ifTrueGoto(leftIsTrue)\n-                .push(false)\n-                .gotoLabel(end)\n-                .comment(\"left was true; push left null flag on the stack (false)\")\n-                .visitLabel(leftIsTrue)\n+        // boolean hasNulls = false; do { eval arg; if (false) goto ret_false; if (wasNull) hasNulls = true; }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f738add47f311365f553f888eb24912848a6105c"}, "originalPosition": 69}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f738add47f311365f553f888eb24912848a6105c", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/f738add47f311365f553f888eb24912848a6105c", "committedDate": "2020-05-20T16:41:02Z", "message": "Streamlined implementation of core control operators"}, "afterCommit": {"oid": "bb3d4d6664b4272a7aeab98a6f2c302cc1f2d653", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/bb3d4d6664b4272a7aeab98a6f2c302cc1f2d653", "committedDate": "2020-05-26T20:56:26Z", "message": "Streamlined implementation of core control operators"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bb3d4d6664b4272a7aeab98a6f2c302cc1f2d653", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/bb3d4d6664b4272a7aeab98a6f2c302cc1f2d653", "committedDate": "2020-05-26T20:56:26Z", "message": "Streamlined implementation of core control operators"}, "afterCommit": {"oid": "ab69cf3ec00cb85daea2915cb009c5efa6635327", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/ab69cf3ec00cb85daea2915cb009c5efa6635327", "committedDate": "2020-05-27T00:37:40Z", "message": "Streamlined implementation of core control operators"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ab69cf3ec00cb85daea2915cb009c5efa6635327", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/ab69cf3ec00cb85daea2915cb009c5efa6635327", "committedDate": "2020-05-27T00:37:40Z", "message": "Streamlined implementation of core control operators"}, "afterCommit": {"oid": "e35877c3a1de89f812e3a71343dc6b3ececf08c9", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/e35877c3a1de89f812e3a71343dc6b3ececf08c9", "committedDate": "2020-05-27T03:57:06Z", "message": "Streamlined implementation of core control operators"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e35877c3a1de89f812e3a71343dc6b3ececf08c9", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/e35877c3a1de89f812e3a71343dc6b3ececf08c9", "committedDate": "2020-05-27T03:57:06Z", "message": "Streamlined implementation of core control operators"}, "afterCommit": {"oid": "813213baa1925479a9b0cd8daf2e1ccfb918816c", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/813213baa1925479a9b0cd8daf2e1ccfb918816c", "committedDate": "2020-05-27T14:27:23Z", "message": "Streamlined implementation of core control operators"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwNDY3Mzgz", "url": "https://github.com/prestodb/presto/pull/14562#pullrequestreview-420467383", "createdAt": "2020-05-28T20:28:49Z", "commit": {"oid": "813213baa1925479a9b0cd8daf2e1ccfb918816c"}, "state": "APPROVED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQyMDoyODo0OVrOGcFlcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxOToxMTo0NlrOGco5oQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjEwNDgxNg==", "bodyText": "It might worth putting the SQL AND eval logic in comment since it's not intuitive. Also please change the comment to be consistent with code do { eval arg; if (wasNull) hasNull = true; else if (false) goto ret_false; } (or change the code to be the same order with comment.", "url": "https://github.com/prestodb/presto/pull/14562#discussion_r432104816", "createdAt": "2020-05-28T20:28:49Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/gen/AndCodeGenerator.java", "diffHunk": "@@ -36,68 +38,74 @@ public BytecodeNode generateExpression(BytecodeGeneratorContext generator, Type\n     {\n         Preconditions.checkArgument(arguments.size() == 2);\n \n-        Variable wasNull = generator.wasNull();\n+        // We flatten the AND here.\n+        Stack<RowExpression> stack = new Stack<RowExpression>();\n+        stack.push(arguments.get(1));\n+        stack.push(arguments.get(0));\n+\n+        List<RowExpression> flattenedArgs = new ArrayList<RowExpression>();\n+        do {\n+            RowExpression operand = stack.pop();\n+            if (operand instanceof SpecialFormExpression &&\n+                    ((SpecialFormExpression) operand).getForm() == SpecialFormExpression.Form.AND) {\n+                stack.push(((SpecialFormExpression) operand).getArguments().get(1));\n+                stack.push(((SpecialFormExpression) operand).getArguments().get(0));\n+            }\n+            else {\n+                flattenedArgs.add(operand);\n+            }\n+        } while (!stack.empty());\n+\n         BytecodeBlock block = new BytecodeBlock()\n                 .comment(\"AND\")\n                 .setDescription(\"AND\");\n \n-        BytecodeNode left = generator.generate(arguments.get(0), Optional.empty());\n-        BytecodeNode right = generator.generate(arguments.get(1), Optional.empty());\n-\n-        block.append(left);\n-\n-        IfStatement ifLeftIsNull = new IfStatement(\"if left wasNull...\")\n-                .condition(wasNull);\n-\n-        LabelNode end = new LabelNode(\"end\");\n-        ifLeftIsNull.ifTrue()\n-                .comment(\"clear the null flag, pop left value off stack, and push left null flag on the stack (true)\")\n-                .append(wasNull.set(constantFalse()))\n-                .pop(arguments.get(0).getType().getJavaType()) // discard left value\n-                .push(true);\n+        LabelNode falseLabel = new LabelNode(\"false\");\n+        LabelNode endLabel = new LabelNode(\"end\");\n+        Variable wasNull = generator.wasNull();\n \n-        LabelNode leftIsTrue = new LabelNode(\"leftIsTrue\");\n-        ifLeftIsNull.ifFalse()\n-                .comment(\"if left is false, push false, and goto end\")\n-                .ifTrueGoto(leftIsTrue)\n-                .push(false)\n-                .gotoLabel(end)\n-                .comment(\"left was true; push left null flag on the stack (false)\")\n-                .visitLabel(leftIsTrue)\n+        // boolean hasNulls = false; do { eval arg; if (false) goto ret_false; if (wasNull) hasNulls = true; }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYyNjk4Mg=="}, "originalCommit": {"oid": "f738add47f311365f553f888eb24912848a6105c"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjEwOTk3OA==", "bodyText": "I found it more fluent to read when written in the format of\nblock.append(ifHasNulls)\n    .gotoLabel(endLabel)\n    .visitLabel(falseLabel)\n    .comment(...)\n    ...\n    .visitLabel(endLabel);\n\nIt's more obvious that this is the same code block.", "url": "https://github.com/prestodb/presto/pull/14562#discussion_r432109978", "createdAt": "2020-05-28T20:39:19Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/gen/AndCodeGenerator.java", "diffHunk": "@@ -36,68 +38,74 @@ public BytecodeNode generateExpression(BytecodeGeneratorContext generator, Type\n     {\n         Preconditions.checkArgument(arguments.size() == 2);\n \n-        Variable wasNull = generator.wasNull();\n+        // We flatten the AND here.\n+        Stack<RowExpression> stack = new Stack<RowExpression>();\n+        stack.push(arguments.get(1));\n+        stack.push(arguments.get(0));\n+\n+        List<RowExpression> flattenedArgs = new ArrayList<RowExpression>();\n+        do {\n+            RowExpression operand = stack.pop();\n+            if (operand instanceof SpecialFormExpression &&\n+                    ((SpecialFormExpression) operand).getForm() == SpecialFormExpression.Form.AND) {\n+                stack.push(((SpecialFormExpression) operand).getArguments().get(1));\n+                stack.push(((SpecialFormExpression) operand).getArguments().get(0));\n+            }\n+            else {\n+                flattenedArgs.add(operand);\n+            }\n+        } while (!stack.empty());\n+\n         BytecodeBlock block = new BytecodeBlock()\n                 .comment(\"AND\")\n                 .setDescription(\"AND\");\n \n-        BytecodeNode left = generator.generate(arguments.get(0), Optional.empty());\n-        BytecodeNode right = generator.generate(arguments.get(1), Optional.empty());\n-\n-        block.append(left);\n-\n-        IfStatement ifLeftIsNull = new IfStatement(\"if left wasNull...\")\n-                .condition(wasNull);\n-\n-        LabelNode end = new LabelNode(\"end\");\n-        ifLeftIsNull.ifTrue()\n-                .comment(\"clear the null flag, pop left value off stack, and push left null flag on the stack (true)\")\n-                .append(wasNull.set(constantFalse()))\n-                .pop(arguments.get(0).getType().getJavaType()) // discard left value\n-                .push(true);\n+        LabelNode falseLabel = new LabelNode(\"false\");\n+        LabelNode endLabel = new LabelNode(\"end\");\n+        Variable wasNull = generator.wasNull();\n \n-        LabelNode leftIsTrue = new LabelNode(\"leftIsTrue\");\n-        ifLeftIsNull.ifFalse()\n-                .comment(\"if left is false, push false, and goto end\")\n-                .ifTrueGoto(leftIsTrue)\n-                .push(false)\n-                .gotoLabel(end)\n-                .comment(\"left was true; push left null flag on the stack (false)\")\n-                .visitLabel(leftIsTrue)\n+        // boolean hasNulls = false; do { eval arg; if (false) goto ret_false; if (wasNull) hasNulls = true; }\n+        // if (hasNulls) return null\n+        // push true;\n+        // ret_false: push false;\n+        // end: store in output if needed\n+        Variable hasNulls = generator.getScope().createTempVariable(boolean.class);\n+        block.initializeVariable(hasNulls);\n+        for (int i = 0; i < flattenedArgs.size(); i++) {\n+            block.append(generator.generate(flattenedArgs.get(i), Optional.empty()));\n+            IfStatement ifOperandIsNull = new IfStatement(\"if left wasNulll...\")\n+                    .condition(wasNull);\n+            ifOperandIsNull.ifTrue()\n+                    .comment(\"clear the null flag and remember there was a null\")\n+                    .putVariable(hasNulls, true)\n+                    .putVariable(wasNull, false)\n+                    .pop(boolean.class);\n+\n+            ifOperandIsNull\n+                    .ifFalse()\n+                    .ifFalseGoto(falseLabel);\n+\n+            block.append(ifOperandIsNull);\n+        }\n+\n+        // We evaluated all operands. So check if any of them was null\n+        IfStatement ifHasNulls = new IfStatement(\"hasNulls is true\");\n+        ifHasNulls.condition().append(hasNulls);\n+        ifHasNulls.ifTrue()\n+                .comment(\"at least one of the arguments is null and none of them is false. So set wasNull to true\")\n+                .putVariable(wasNull, true)\n                 .push(false);\n+        ifHasNulls.ifFalse().push(true);\n \n-        block.append(ifLeftIsNull);\n-\n-        // At this point we know the left expression was either NULL or TRUE.  The stack contains a single boolean\n-        // value for this expression which indicates if the left value was NULL.\n-\n-        // eval right!\n-        block.append(right);\n+        block.append(ifHasNulls);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "813213baa1925479a9b0cd8daf2e1ccfb918816c"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjExMDk5Mg==", "bodyText": "I'd just merge the following into a single statement\nblock.append(ifStatement)\n    .visitLabel(...)\n    .append(...)\n    .visitLabel(...);", "url": "https://github.com/prestodb/presto/pull/14562#discussion_r432110992", "createdAt": "2020-05-28T20:41:31Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/gen/IfCodeGenerator.java", "diffHunk": "@@ -35,19 +35,29 @@ public BytecodeNode generateExpression(BytecodeGeneratorContext context, Type re\n         Preconditions.checkArgument(arguments.size() == 3);\n \n         Variable wasNull = context.wasNull();\n-        BytecodeBlock condition = new BytecodeBlock()\n-                .append(context.generate(arguments.get(0), Optional.empty()))\n-                .comment(\"... and condition value was not null\")\n-                .append(wasNull)\n-                .invokeStatic(CompilerOperations.class, \"not\", boolean.class, boolean.class)\n-                .invokeStatic(CompilerOperations.class, \"and\", boolean.class, boolean.class, boolean.class)\n-                .append(wasNull.set(constantFalse()));\n-\n+        LabelNode falseLabel = new LabelNode(\"false\");\n+        LabelNode endLabel = new LabelNode(\"end\");\n         BytecodeBlock block = new BytecodeBlock()\n-                .append(new IfStatement()\n-                        .condition(condition)\n-                        .ifTrue(context.generate(arguments.get(1), Optional.empty()))\n-                        .ifFalse(context.generate(arguments.get(2), Optional.empty())));\n+                .append(context.generate(arguments.get(0), Optional.empty()));\n+\n+        IfStatement ifStatement = new IfStatement(\"... and condition value was not null\")\n+                .condition(wasNull);\n+\n+        ifStatement.ifTrue()\n+                .putVariable(wasNull, false)\n+                .pop(boolean.class)\n+                .gotoLabel(falseLabel);\n+\n+        ifStatement.ifFalse()\n+                .ifFalseGoto(falseLabel)\n+                .append(context.generate(arguments.get(1), Optional.empty()))\n+                .gotoLabel(endLabel);\n+\n+        block.append(ifStatement);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "813213baa1925479a9b0cd8daf2e1ccfb918816c"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjExMTYyMA==", "bodyText": "Same as the AndCodeGenerator, maybe explain how OR works and update the comment to be consistent with code order.", "url": "https://github.com/prestodb/presto/pull/14562#discussion_r432111620", "createdAt": "2020-05-28T20:42:50Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/gen/OrCodeGenerator.java", "diffHunk": "@@ -36,67 +38,74 @@ public BytecodeNode generateExpression(BytecodeGeneratorContext generator, Type\n     {\n         Preconditions.checkArgument(arguments.size() == 2);\n \n-        Variable wasNull = generator.wasNull();\n+        // We flatten the AND here.\n+        Stack<RowExpression> stack = new Stack<RowExpression>();\n+        stack.push(arguments.get(1));\n+        stack.push(arguments.get(0));\n+\n+        List<RowExpression> flattenedArgs = new ArrayList<RowExpression>();\n+        do {\n+            RowExpression operand = stack.pop();\n+            if (operand instanceof SpecialFormExpression &&\n+                    ((SpecialFormExpression) operand).getForm() == SpecialFormExpression.Form.OR) {\n+                stack.push(((SpecialFormExpression) operand).getArguments().get(1));\n+                stack.push(((SpecialFormExpression) operand).getArguments().get(0));\n+            }\n+            else {\n+                flattenedArgs.add(operand);\n+            }\n+        } while (!stack.empty());\n+\n         BytecodeBlock block = new BytecodeBlock()\n                 .comment(\"OR\")\n                 .setDescription(\"OR\");\n \n-        BytecodeNode left = generator.generate(arguments.get(0), Optional.empty());\n-        BytecodeNode right = generator.generate(arguments.get(1), Optional.empty());\n-\n-        block.append(left);\n-\n-        IfStatement ifLeftIsNull = new IfStatement(\"if left wasNull...\")\n-                .condition(wasNull);\n-\n-        LabelNode end = new LabelNode(\"end\");\n-        ifLeftIsNull.ifTrue(new BytecodeBlock()\n-                .comment(\"clear the null flag, pop left value off stack, and push left null flag on the stack (true)\")\n-                .append(wasNull.set(constantFalse()))\n-                .pop(arguments.get(0).getType().getJavaType()) // discard left value\n-                .push(true));\n-\n-        LabelNode leftIsFalse = new LabelNode(\"leftIsFalse\");\n-        ifLeftIsNull.ifFalse(new BytecodeBlock()\n-                .comment(\"if left is true, push true, and goto end\")\n-                .ifFalseGoto(leftIsFalse)\n-                .push(true)\n-                .gotoLabel(end)\n-                .comment(\"left was false; push left null flag on the stack (false)\")\n-                .visitLabel(leftIsFalse)\n-                .push(false));\n-\n-        block.append(ifLeftIsNull);\n-\n-        // At this point we know the left expression was either NULL or FALSE.  The stack contains a single boolean\n-        // value for this expression which indicates if the left value was NULL.\n-\n-        // eval right!\n-        block.append(right);\n+        LabelNode trueLabel = new LabelNode(\"true\");\n+        LabelNode endLabel = new LabelNode(\"end\");\n+        Variable wasNull = generator.wasNull();\n \n-        IfStatement ifRightIsNull = new IfStatement(\"if right wasNull...\")\n-                .condition(wasNull);\n+        // boolean hasNulls = false; do { eval arg; if (false) goto ret_false; if (wasNull) hasNulls = true; }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "813213baa1925479a9b0cd8daf2e1ccfb918816c"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjExMjQ4MQ==", "bodyText": "Is this used?", "url": "https://github.com/prestodb/presto/pull/14562#discussion_r432112481", "createdAt": "2020-05-28T20:44:35Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/gen/SwitchCodeGenerator.java", "diffHunk": "@@ -41,47 +45,27 @@\n public class SwitchCodeGenerator\n         implements SpecialFormBytecodeGenerator\n {\n+    private static final String CASE_LABEL_PREFIX = \"_case_\";\n+    private static final String RESULT_LABEL_PREFIX = \"_result_\";\n+\n+    // TODO - move this to a RowExpressionUtil class\n+    private static boolean isEqualsExpression(RowExpression expression)\n+    {\n+        return expression instanceof CallExpression\n+                && ((CallExpression) expression).getDisplayName().equals(EQUAL.getFunctionName().getFunctionName())\n+                && ((CallExpression) expression).getArguments().size() == 2;\n+    }\n+\n     @Override\n     public BytecodeNode generateExpression(BytecodeGeneratorContext generatorContext, Type returnType, List<RowExpression> arguments, Optional<Variable> outputBlockVariable)\n     {\n-        // TODO: compile as\n-        /*\n-            hashCode = hashCode(<value>)\n-\n-            // all constant expressions before a non-constant\n-            switch (hashCode) {\n-                case ...:\n-                    if (<value> == <constant1>) {\n-                       ...\n-                    }\n-                    else if (<value> == <constant2>) {\n-                       ...\n-                    }\n-                    else if (...) {\n-                    }\n-                case ...:\n-                    ...\n-            }\n-\n-            if (<value> == <non-constant1>) {\n-                ...\n-            }\n-            else if (<value> == <non-constant2>) {\n-                ...\n-            }\n-            ...\n-\n-            // repeat with next sequence of constant expressions\n-         */\n-\n-        Scope scope = generatorContext.getScope();\n-\n         // process value, else, and all when clauses\n         RowExpression value = arguments.get(0);\n-        BytecodeNode valueBytecode = generatorContext.generate(value, Optional.empty());\n+        Scope scope = generatorContext.getScope();\n         BytecodeNode elseValue;\n-\n         List<RowExpression> whenClauses;\n+        RowExpressionDeterminismEvaluator rowExpressionDeterminismEvaluator = new RowExpressionDeterminismEvaluator(generatorContext.getFunctionManager());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "813213baa1925479a9b0cd8daf2e1ccfb918816c"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY4MDIzNg==", "bodyText": "Can we move the declaration of value here or move this up? It took me a while to find where value is defined \ud83d\ude02", "url": "https://github.com/prestodb/presto/pull/14562#discussion_r432680236", "createdAt": "2020-05-29T19:04:23Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/gen/SwitchCodeGenerator.java", "diffHunk": "@@ -97,49 +81,84 @@ else if (<value> == <non-constant2>) {\n         // determine the type of the value and result\n         Class<?> valueType = value.getType().getJavaType();\n \n+        // We generate SearchedCase as CASE TRUE WHEN p1 THEN v1 WHEN p2 THEN p2...\n+        boolean searchedCase = (value instanceof ConstantExpression && ((ConstantExpression) value).getType() == BOOLEAN &&", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "813213baa1925479a9b0cd8daf2e1ccfb918816c"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY4MTkxMw==", "bodyText": "We normally would use a Optional<BytecodeNode> in this situation rather than using null.", "url": "https://github.com/prestodb/presto/pull/14562#discussion_r432681913", "createdAt": "2020-05-29T19:08:11Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/gen/SwitchCodeGenerator.java", "diffHunk": "@@ -97,49 +81,84 @@ else if (<value> == <non-constant2>) {\n         // determine the type of the value and result\n         Class<?> valueType = value.getType().getJavaType();\n \n+        // We generate SearchedCase as CASE TRUE WHEN p1 THEN v1 WHEN p2 THEN p2...\n+        boolean searchedCase = (value instanceof ConstantExpression && ((ConstantExpression) value).getType() == BOOLEAN &&\n+                ((ConstantExpression) value).getValue() == Boolean.TRUE);\n+\n         // evaluate the value and store it in a variable\n-        LabelNode nullValue = new LabelNode(\"nullCondition\");\n-        Variable tempVariable = scope.createTempVariable(valueType);\n-        BytecodeBlock block = new BytecodeBlock()\n-                .append(valueBytecode)\n-                .append(BytecodeUtils.ifWasNullClearPopAndGoto(scope, nullValue, void.class, valueType))\n-                .putVariable(tempVariable);\n-\n-        BytecodeNode getTempVariableNode = VariableInstruction.loadVariable(tempVariable);\n-\n-        // build the statements\n-        elseValue = new BytecodeBlock().visitLabel(nullValue).append(elseValue);\n-        // reverse list because current if statement builder doesn't support if/else so we need to build the if statements bottom up\n-        for (RowExpression clause : Lists.reverse(whenClauses)) {\n+        LabelNode elseLabel = new LabelNode(\"else\");\n+        LabelNode endLabel = new LabelNode(\"end\");\n+\n+        BytecodeBlock block = new BytecodeBlock();\n+        BytecodeNode getTempVariableNode = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "813213baa1925479a9b0cd8daf2e1ccfb918816c"}, "originalPosition": 112}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY4MjU4NA==", "bodyText": "You can just do\n= new IfStatement()\n    .condition(...)\n....", "url": "https://github.com/prestodb/presto/pull/14562#discussion_r432682584", "createdAt": "2020-05-29T19:09:48Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/gen/SwitchCodeGenerator.java", "diffHunk": "@@ -97,49 +81,84 @@ else if (<value> == <non-constant2>) {\n         // determine the type of the value and result\n         Class<?> valueType = value.getType().getJavaType();\n \n+        // We generate SearchedCase as CASE TRUE WHEN p1 THEN v1 WHEN p2 THEN p2...\n+        boolean searchedCase = (value instanceof ConstantExpression && ((ConstantExpression) value).getType() == BOOLEAN &&\n+                ((ConstantExpression) value).getValue() == Boolean.TRUE);\n+\n         // evaluate the value and store it in a variable\n-        LabelNode nullValue = new LabelNode(\"nullCondition\");\n-        Variable tempVariable = scope.createTempVariable(valueType);\n-        BytecodeBlock block = new BytecodeBlock()\n-                .append(valueBytecode)\n-                .append(BytecodeUtils.ifWasNullClearPopAndGoto(scope, nullValue, void.class, valueType))\n-                .putVariable(tempVariable);\n-\n-        BytecodeNode getTempVariableNode = VariableInstruction.loadVariable(tempVariable);\n-\n-        // build the statements\n-        elseValue = new BytecodeBlock().visitLabel(nullValue).append(elseValue);\n-        // reverse list because current if statement builder doesn't support if/else so we need to build the if statements bottom up\n-        for (RowExpression clause : Lists.reverse(whenClauses)) {\n+        LabelNode elseLabel = new LabelNode(\"else\");\n+        LabelNode endLabel = new LabelNode(\"end\");\n+\n+        BytecodeBlock block = new BytecodeBlock();\n+        BytecodeNode getTempVariableNode = null;\n+        if (!searchedCase) {\n+            BytecodeNode valueBytecode = generatorContext.generate(value, Optional.empty());\n+            Variable tempVariable = scope.createTempVariable(valueType);\n+            block.append(valueBytecode)\n+                    .append(BytecodeUtils.ifWasNullClearPopAndGoto(scope, elseLabel, void.class, valueType))\n+                    .putVariable(tempVariable);\n+            getTempVariableNode = VariableInstruction.loadVariable(tempVariable);\n+        }\n+\n+        Variable wasNull = generatorContext.wasNull();\n+        block.putVariable(wasNull, false);\n+\n+        Map<RowExpression, LabelNode> resultLabels = new HashMap<RowExpression, LabelNode>();\n+        // We already know the P1 .. Pn are all boolean just call them and search for true (false/null don't matter).\n+        for (RowExpression clause : whenClauses) {\n             checkArgument(clause instanceof SpecialFormExpression && ((SpecialFormExpression) clause).getForm().equals(WHEN));\n \n             RowExpression operand = ((SpecialFormExpression) clause).getArguments().get(0);\n+            BytecodeNode operandBytecode;\n+\n+            if (searchedCase) {\n+                operandBytecode = generatorContext.generate(operand, Optional.empty());\n+            }\n+            else {\n+                // call equals(value, operandBytecode)\n+                FunctionHandle equalsFunction = generatorContext.getFunctionManager().resolveOperator(EQUAL, fromTypes(value.getType(), operand.getType()));\n+                operandBytecode = generatorContext.generateCall(\n+                        EQUAL.name(),\n+                        generatorContext.getFunctionManager().getBuiltInScalarFunctionImplementation(equalsFunction),\n+                        ImmutableList.of(\n+                                generatorContext.generate(operand,\n+                                Optional.empty()),\n+                                getTempVariableNode));\n+            }\n+\n+            block.append(operandBytecode);\n+\n+            IfStatement ifWasNull = new IfStatement();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "813213baa1925479a9b0cd8daf2e1ccfb918816c"}, "originalPosition": 150}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY4MzA4MQ==", "bodyText": "resultLabels.putIfAbsent(...)?", "url": "https://github.com/prestodb/presto/pull/14562#discussion_r432683081", "createdAt": "2020-05-29T19:10:59Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/gen/SwitchCodeGenerator.java", "diffHunk": "@@ -97,49 +81,84 @@ else if (<value> == <non-constant2>) {\n         // determine the type of the value and result\n         Class<?> valueType = value.getType().getJavaType();\n \n+        // We generate SearchedCase as CASE TRUE WHEN p1 THEN v1 WHEN p2 THEN p2...\n+        boolean searchedCase = (value instanceof ConstantExpression && ((ConstantExpression) value).getType() == BOOLEAN &&\n+                ((ConstantExpression) value).getValue() == Boolean.TRUE);\n+\n         // evaluate the value and store it in a variable\n-        LabelNode nullValue = new LabelNode(\"nullCondition\");\n-        Variable tempVariable = scope.createTempVariable(valueType);\n-        BytecodeBlock block = new BytecodeBlock()\n-                .append(valueBytecode)\n-                .append(BytecodeUtils.ifWasNullClearPopAndGoto(scope, nullValue, void.class, valueType))\n-                .putVariable(tempVariable);\n-\n-        BytecodeNode getTempVariableNode = VariableInstruction.loadVariable(tempVariable);\n-\n-        // build the statements\n-        elseValue = new BytecodeBlock().visitLabel(nullValue).append(elseValue);\n-        // reverse list because current if statement builder doesn't support if/else so we need to build the if statements bottom up\n-        for (RowExpression clause : Lists.reverse(whenClauses)) {\n+        LabelNode elseLabel = new LabelNode(\"else\");\n+        LabelNode endLabel = new LabelNode(\"end\");\n+\n+        BytecodeBlock block = new BytecodeBlock();\n+        BytecodeNode getTempVariableNode = null;\n+        if (!searchedCase) {\n+            BytecodeNode valueBytecode = generatorContext.generate(value, Optional.empty());\n+            Variable tempVariable = scope.createTempVariable(valueType);\n+            block.append(valueBytecode)\n+                    .append(BytecodeUtils.ifWasNullClearPopAndGoto(scope, elseLabel, void.class, valueType))\n+                    .putVariable(tempVariable);\n+            getTempVariableNode = VariableInstruction.loadVariable(tempVariable);\n+        }\n+\n+        Variable wasNull = generatorContext.wasNull();\n+        block.putVariable(wasNull, false);\n+\n+        Map<RowExpression, LabelNode> resultLabels = new HashMap<RowExpression, LabelNode>();\n+        // We already know the P1 .. Pn are all boolean just call them and search for true (false/null don't matter).\n+        for (RowExpression clause : whenClauses) {\n             checkArgument(clause instanceof SpecialFormExpression && ((SpecialFormExpression) clause).getForm().equals(WHEN));\n \n             RowExpression operand = ((SpecialFormExpression) clause).getArguments().get(0);\n+            BytecodeNode operandBytecode;\n+\n+            if (searchedCase) {\n+                operandBytecode = generatorContext.generate(operand, Optional.empty());\n+            }\n+            else {\n+                // call equals(value, operandBytecode)\n+                FunctionHandle equalsFunction = generatorContext.getFunctionManager().resolveOperator(EQUAL, fromTypes(value.getType(), operand.getType()));\n+                operandBytecode = generatorContext.generateCall(\n+                        EQUAL.name(),\n+                        generatorContext.getFunctionManager().getBuiltInScalarFunctionImplementation(equalsFunction),\n+                        ImmutableList.of(\n+                                generatorContext.generate(operand,\n+                                Optional.empty()),\n+                                getTempVariableNode));\n+            }\n+\n+            block.append(operandBytecode);\n+\n+            IfStatement ifWasNull = new IfStatement();\n+            ifWasNull.condition(wasNull)\n+                    .ifTrue()\n+                    .putVariable(wasNull, false)\n+                    .pop(Boolean.class); // pop the result of the predicate eval\n+\n+            // Here the TOS  is the result of the predicate.\n             RowExpression result = ((SpecialFormExpression) clause).getArguments().get(1);\n+            LabelNode target = resultLabels.get(result);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "813213baa1925479a9b0cd8daf2e1ccfb918816c"}, "originalPosition": 158}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY4MzM4Ng==", "bodyText": "Prefer chaining the calls.", "url": "https://github.com/prestodb/presto/pull/14562#discussion_r432683386", "createdAt": "2020-05-29T19:11:40Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/gen/SwitchCodeGenerator.java", "diffHunk": "@@ -97,49 +81,84 @@ else if (<value> == <non-constant2>) {\n         // determine the type of the value and result\n         Class<?> valueType = value.getType().getJavaType();\n \n+        // We generate SearchedCase as CASE TRUE WHEN p1 THEN v1 WHEN p2 THEN p2...\n+        boolean searchedCase = (value instanceof ConstantExpression && ((ConstantExpression) value).getType() == BOOLEAN &&\n+                ((ConstantExpression) value).getValue() == Boolean.TRUE);\n+\n         // evaluate the value and store it in a variable\n-        LabelNode nullValue = new LabelNode(\"nullCondition\");\n-        Variable tempVariable = scope.createTempVariable(valueType);\n-        BytecodeBlock block = new BytecodeBlock()\n-                .append(valueBytecode)\n-                .append(BytecodeUtils.ifWasNullClearPopAndGoto(scope, nullValue, void.class, valueType))\n-                .putVariable(tempVariable);\n-\n-        BytecodeNode getTempVariableNode = VariableInstruction.loadVariable(tempVariable);\n-\n-        // build the statements\n-        elseValue = new BytecodeBlock().visitLabel(nullValue).append(elseValue);\n-        // reverse list because current if statement builder doesn't support if/else so we need to build the if statements bottom up\n-        for (RowExpression clause : Lists.reverse(whenClauses)) {\n+        LabelNode elseLabel = new LabelNode(\"else\");\n+        LabelNode endLabel = new LabelNode(\"end\");\n+\n+        BytecodeBlock block = new BytecodeBlock();\n+        BytecodeNode getTempVariableNode = null;\n+        if (!searchedCase) {\n+            BytecodeNode valueBytecode = generatorContext.generate(value, Optional.empty());\n+            Variable tempVariable = scope.createTempVariable(valueType);\n+            block.append(valueBytecode)\n+                    .append(BytecodeUtils.ifWasNullClearPopAndGoto(scope, elseLabel, void.class, valueType))\n+                    .putVariable(tempVariable);\n+            getTempVariableNode = VariableInstruction.loadVariable(tempVariable);\n+        }\n+\n+        Variable wasNull = generatorContext.wasNull();\n+        block.putVariable(wasNull, false);\n+\n+        Map<RowExpression, LabelNode> resultLabels = new HashMap<RowExpression, LabelNode>();\n+        // We already know the P1 .. Pn are all boolean just call them and search for true (false/null don't matter).\n+        for (RowExpression clause : whenClauses) {\n             checkArgument(clause instanceof SpecialFormExpression && ((SpecialFormExpression) clause).getForm().equals(WHEN));\n \n             RowExpression operand = ((SpecialFormExpression) clause).getArguments().get(0);\n+            BytecodeNode operandBytecode;\n+\n+            if (searchedCase) {\n+                operandBytecode = generatorContext.generate(operand, Optional.empty());\n+            }\n+            else {\n+                // call equals(value, operandBytecode)\n+                FunctionHandle equalsFunction = generatorContext.getFunctionManager().resolveOperator(EQUAL, fromTypes(value.getType(), operand.getType()));\n+                operandBytecode = generatorContext.generateCall(\n+                        EQUAL.name(),\n+                        generatorContext.getFunctionManager().getBuiltInScalarFunctionImplementation(equalsFunction),\n+                        ImmutableList.of(\n+                                generatorContext.generate(operand,\n+                                Optional.empty()),\n+                                getTempVariableNode));\n+            }\n+\n+            block.append(operandBytecode);\n+\n+            IfStatement ifWasNull = new IfStatement();\n+            ifWasNull.condition(wasNull)\n+                    .ifTrue()\n+                    .putVariable(wasNull, false)\n+                    .pop(Boolean.class); // pop the result of the predicate eval\n+\n+            // Here the TOS  is the result of the predicate.\n             RowExpression result = ((SpecialFormExpression) clause).getArguments().get(1);\n+            LabelNode target = resultLabels.get(result);\n+            if (target == null) {\n+                target = new LabelNode(RESULT_LABEL_PREFIX + resultLabels.size());\n+                resultLabels.put(result, target);\n+            }\n \n-            // call equals(value, operand)\n-            FunctionHandle equalsFunction = generatorContext.getFunctionManager().resolveOperator(EQUAL, fromTypes(value.getType(), operand.getType()));\n-\n-            // TODO: what if operand is null? It seems that the call will return \"null\" (which is cleared below)\n-            // and the code only does the right thing because the value in the stack for that scenario is\n-            // Java's default for boolean == false\n-            // This code should probably be checking for wasNull after the call and \"failing\" the equality\n-            // check if wasNull is true\n-            BytecodeNode equalsCall = generatorContext.generateCall(\n-                    EQUAL.name(),\n-                    generatorContext.getFunctionManager().getBuiltInScalarFunctionImplementation(equalsFunction),\n-                    ImmutableList.of(generatorContext.generate(operand, Optional.empty()), getTempVariableNode));\n-\n-            BytecodeBlock condition = new BytecodeBlock()\n-                    .append(equalsCall)\n-                    .append(generatorContext.wasNull().set(constantFalse()));\n-\n-            elseValue = new IfStatement(\"when\")\n-                    .condition(condition)\n-                    .ifTrue(generatorContext.generate(result, Optional.empty()))\n-                    .ifFalse(elseValue);\n+            ifWasNull.ifFalse().ifTrueGoto(target);\n+            block.append(ifWasNull);\n         }\n \n+        // Here we evaluate the else result.\n+        block.visitLabel(elseLabel);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "813213baa1925479a9b0cd8daf2e1ccfb918816c"}, "originalPosition": 190}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY4MzQyNQ==", "bodyText": "Same here.", "url": "https://github.com/prestodb/presto/pull/14562#discussion_r432683425", "createdAt": "2020-05-29T19:11:46Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/gen/SwitchCodeGenerator.java", "diffHunk": "@@ -97,49 +81,84 @@ else if (<value> == <non-constant2>) {\n         // determine the type of the value and result\n         Class<?> valueType = value.getType().getJavaType();\n \n+        // We generate SearchedCase as CASE TRUE WHEN p1 THEN v1 WHEN p2 THEN p2...\n+        boolean searchedCase = (value instanceof ConstantExpression && ((ConstantExpression) value).getType() == BOOLEAN &&\n+                ((ConstantExpression) value).getValue() == Boolean.TRUE);\n+\n         // evaluate the value and store it in a variable\n-        LabelNode nullValue = new LabelNode(\"nullCondition\");\n-        Variable tempVariable = scope.createTempVariable(valueType);\n-        BytecodeBlock block = new BytecodeBlock()\n-                .append(valueBytecode)\n-                .append(BytecodeUtils.ifWasNullClearPopAndGoto(scope, nullValue, void.class, valueType))\n-                .putVariable(tempVariable);\n-\n-        BytecodeNode getTempVariableNode = VariableInstruction.loadVariable(tempVariable);\n-\n-        // build the statements\n-        elseValue = new BytecodeBlock().visitLabel(nullValue).append(elseValue);\n-        // reverse list because current if statement builder doesn't support if/else so we need to build the if statements bottom up\n-        for (RowExpression clause : Lists.reverse(whenClauses)) {\n+        LabelNode elseLabel = new LabelNode(\"else\");\n+        LabelNode endLabel = new LabelNode(\"end\");\n+\n+        BytecodeBlock block = new BytecodeBlock();\n+        BytecodeNode getTempVariableNode = null;\n+        if (!searchedCase) {\n+            BytecodeNode valueBytecode = generatorContext.generate(value, Optional.empty());\n+            Variable tempVariable = scope.createTempVariable(valueType);\n+            block.append(valueBytecode)\n+                    .append(BytecodeUtils.ifWasNullClearPopAndGoto(scope, elseLabel, void.class, valueType))\n+                    .putVariable(tempVariable);\n+            getTempVariableNode = VariableInstruction.loadVariable(tempVariable);\n+        }\n+\n+        Variable wasNull = generatorContext.wasNull();\n+        block.putVariable(wasNull, false);\n+\n+        Map<RowExpression, LabelNode> resultLabels = new HashMap<RowExpression, LabelNode>();\n+        // We already know the P1 .. Pn are all boolean just call them and search for true (false/null don't matter).\n+        for (RowExpression clause : whenClauses) {\n             checkArgument(clause instanceof SpecialFormExpression && ((SpecialFormExpression) clause).getForm().equals(WHEN));\n \n             RowExpression operand = ((SpecialFormExpression) clause).getArguments().get(0);\n+            BytecodeNode operandBytecode;\n+\n+            if (searchedCase) {\n+                operandBytecode = generatorContext.generate(operand, Optional.empty());\n+            }\n+            else {\n+                // call equals(value, operandBytecode)\n+                FunctionHandle equalsFunction = generatorContext.getFunctionManager().resolveOperator(EQUAL, fromTypes(value.getType(), operand.getType()));\n+                operandBytecode = generatorContext.generateCall(\n+                        EQUAL.name(),\n+                        generatorContext.getFunctionManager().getBuiltInScalarFunctionImplementation(equalsFunction),\n+                        ImmutableList.of(\n+                                generatorContext.generate(operand,\n+                                Optional.empty()),\n+                                getTempVariableNode));\n+            }\n+\n+            block.append(operandBytecode);\n+\n+            IfStatement ifWasNull = new IfStatement();\n+            ifWasNull.condition(wasNull)\n+                    .ifTrue()\n+                    .putVariable(wasNull, false)\n+                    .pop(Boolean.class); // pop the result of the predicate eval\n+\n+            // Here the TOS  is the result of the predicate.\n             RowExpression result = ((SpecialFormExpression) clause).getArguments().get(1);\n+            LabelNode target = resultLabels.get(result);\n+            if (target == null) {\n+                target = new LabelNode(RESULT_LABEL_PREFIX + resultLabels.size());\n+                resultLabels.put(result, target);\n+            }\n \n-            // call equals(value, operand)\n-            FunctionHandle equalsFunction = generatorContext.getFunctionManager().resolveOperator(EQUAL, fromTypes(value.getType(), operand.getType()));\n-\n-            // TODO: what if operand is null? It seems that the call will return \"null\" (which is cleared below)\n-            // and the code only does the right thing because the value in the stack for that scenario is\n-            // Java's default for boolean == false\n-            // This code should probably be checking for wasNull after the call and \"failing\" the equality\n-            // check if wasNull is true\n-            BytecodeNode equalsCall = generatorContext.generateCall(\n-                    EQUAL.name(),\n-                    generatorContext.getFunctionManager().getBuiltInScalarFunctionImplementation(equalsFunction),\n-                    ImmutableList.of(generatorContext.generate(operand, Optional.empty()), getTempVariableNode));\n-\n-            BytecodeBlock condition = new BytecodeBlock()\n-                    .append(equalsCall)\n-                    .append(generatorContext.wasNull().set(constantFalse()));\n-\n-            elseValue = new IfStatement(\"when\")\n-                    .condition(condition)\n-                    .ifTrue(generatorContext.generate(result, Optional.empty()))\n-                    .ifFalse(elseValue);\n+            ifWasNull.ifFalse().ifTrueGoto(target);\n+            block.append(ifWasNull);\n         }\n \n+        // Here we evaluate the else result.\n+        block.visitLabel(elseLabel);\n         block.append(elseValue);\n+        block.gotoLabel(endLabel);\n+\n+        // Now generate the result expression code.\n+        for (Map.Entry<RowExpression, LabelNode> resultLabel : resultLabels.entrySet()) {\n+            block.visitLabel(resultLabel.getValue());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "813213baa1925479a9b0cd8daf2e1ccfb918816c"}, "originalPosition": 196}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "813213baa1925479a9b0cd8daf2e1ccfb918816c", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/813213baa1925479a9b0cd8daf2e1ccfb918816c", "committedDate": "2020-05-27T14:27:23Z", "message": "Streamlined implementation of core control operators"}, "afterCommit": {"oid": "d45dd7ee8f3840fe8b5fc632d8947c445cccf98d", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/d45dd7ee8f3840fe8b5fc632d8947c445cccf98d", "committedDate": "2020-05-29T19:51:57Z", "message": "Streamlined implementation of core control operators"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxNDI0ODYw", "url": "https://github.com/prestodb/presto/pull/14562#pullrequestreview-421424860", "createdAt": "2020-05-30T16:10:37Z", "commit": {"oid": "d45dd7ee8f3840fe8b5fc632d8947c445cccf98d"}, "state": "COMMENTED", "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0zMFQxNjoxMDozN1rOGc0GBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0zMFQxNjoxOTo0N1rOGc0Iaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg2NjgyMg==", "bodyText": "Let's do not use Stack class. It is not recommended in Java docs. Use ArrayDeque for the impl.", "url": "https://github.com/prestodb/presto/pull/14562#discussion_r432866822", "createdAt": "2020-05-30T16:10:37Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/gen/AndCodeGenerator.java", "diffHunk": "@@ -20,12 +20,14 @@\n import com.facebook.presto.bytecode.instruction.LabelNode;\n import com.facebook.presto.common.type.Type;\n import com.facebook.presto.spi.relation.RowExpression;\n+import com.facebook.presto.spi.relation.SpecialFormExpression;\n import com.google.common.base.Preconditions;\n \n+import java.util.ArrayList;\n import java.util.List;\n import java.util.Optional;\n+import java.util.Stack;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d45dd7ee8f3840fe8b5fc632d8947c445cccf98d"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg2NjkyNw==", "bodyText": "flattenedArguments", "url": "https://github.com/prestodb/presto/pull/14562#discussion_r432866927", "createdAt": "2020-05-30T16:12:13Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/gen/AndCodeGenerator.java", "diffHunk": "@@ -36,68 +38,71 @@ public BytecodeNode generateExpression(BytecodeGeneratorContext generator, Type\n     {\n         Preconditions.checkArgument(arguments.size() == 2);\n \n-        Variable wasNull = generator.wasNull();\n+        // We flatten the AND here.\n+        Stack<RowExpression> stack = new Stack<RowExpression>();\n+        stack.push(arguments.get(1));\n+        stack.push(arguments.get(0));\n+\n+        List<RowExpression> flattenedArgs = new ArrayList<RowExpression>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d45dd7ee8f3840fe8b5fc632d8947c445cccf98d"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg2Njk3Nw==", "bodyText": "same line", "url": "https://github.com/prestodb/presto/pull/14562#discussion_r432866977", "createdAt": "2020-05-30T16:13:00Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/gen/AndCodeGenerator.java", "diffHunk": "@@ -36,68 +38,71 @@ public BytecodeNode generateExpression(BytecodeGeneratorContext generator, Type\n     {\n         Preconditions.checkArgument(arguments.size() == 2);\n \n-        Variable wasNull = generator.wasNull();\n+        // We flatten the AND here.\n+        Stack<RowExpression> stack = new Stack<RowExpression>();\n+        stack.push(arguments.get(1));\n+        stack.push(arguments.get(0));\n+\n+        List<RowExpression> flattenedArgs = new ArrayList<RowExpression>();\n+        do {\n+            RowExpression operand = stack.pop();\n+            if (operand instanceof SpecialFormExpression &&\n+                    ((SpecialFormExpression) operand).getForm() == SpecialFormExpression.Form.AND) {\n+                stack.push(((SpecialFormExpression) operand).getArguments().get(1));\n+                stack.push(((SpecialFormExpression) operand).getArguments().get(0));\n+            }\n+            else {\n+                flattenedArgs.add(operand);\n+            }\n+        } while (!stack.empty());\n+\n         BytecodeBlock block = new BytecodeBlock()\n                 .comment(\"AND\")\n                 .setDescription(\"AND\");\n \n-        BytecodeNode left = generator.generate(arguments.get(0), Optional.empty());\n-        BytecodeNode right = generator.generate(arguments.get(1), Optional.empty());\n-\n-        block.append(left);\n-\n-        IfStatement ifLeftIsNull = new IfStatement(\"if left wasNull...\")\n-                .condition(wasNull);\n-\n-        LabelNode end = new LabelNode(\"end\");\n-        ifLeftIsNull.ifTrue()\n-                .comment(\"clear the null flag, pop left value off stack, and push left null flag on the stack (true)\")\n-                .append(wasNull.set(constantFalse()))\n-                .pop(arguments.get(0).getType().getJavaType()) // discard left value\n-                .push(true);\n+        LabelNode falseLabel = new LabelNode(\"false\");\n+        LabelNode endLabel = new LabelNode(\"end\");\n+        Variable wasNull = generator.wasNull();\n \n-        LabelNode leftIsTrue = new LabelNode(\"leftIsTrue\");\n-        ifLeftIsNull.ifFalse()\n-                .comment(\"if left is false, push false, and goto end\")\n-                .ifTrueGoto(leftIsTrue)\n-                .push(false)\n-                .gotoLabel(end)\n-                .comment(\"left was true; push left null flag on the stack (false)\")\n-                .visitLabel(leftIsTrue)\n+        Variable hasNulls = generator.getScope().createTempVariable(boolean.class);\n+        block.initializeVariable(hasNulls);\n+        for (int i = 0; i < flattenedArgs.size(); i++) {\n+            block.comment(\"do { eval arg; if (wasNull) { hasNull = true; wasNull = false; } else if (false) goto ret_false; }\")\n+                    .append(generator.generate(flattenedArgs.get(i), Optional.empty()));\n+\n+            IfStatement ifOperandIsNull = new IfStatement(\"if left wasNulll...\")\n+                    .condition(wasNull);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d45dd7ee8f3840fe8b5fc632d8947c445cccf98d"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg2Njk5OQ==", "bodyText": "put .ifFalse() in the previous line", "url": "https://github.com/prestodb/presto/pull/14562#discussion_r432866999", "createdAt": "2020-05-30T16:13:17Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/gen/AndCodeGenerator.java", "diffHunk": "@@ -36,68 +38,71 @@ public BytecodeNode generateExpression(BytecodeGeneratorContext generator, Type\n     {\n         Preconditions.checkArgument(arguments.size() == 2);\n \n-        Variable wasNull = generator.wasNull();\n+        // We flatten the AND here.\n+        Stack<RowExpression> stack = new Stack<RowExpression>();\n+        stack.push(arguments.get(1));\n+        stack.push(arguments.get(0));\n+\n+        List<RowExpression> flattenedArgs = new ArrayList<RowExpression>();\n+        do {\n+            RowExpression operand = stack.pop();\n+            if (operand instanceof SpecialFormExpression &&\n+                    ((SpecialFormExpression) operand).getForm() == SpecialFormExpression.Form.AND) {\n+                stack.push(((SpecialFormExpression) operand).getArguments().get(1));\n+                stack.push(((SpecialFormExpression) operand).getArguments().get(0));\n+            }\n+            else {\n+                flattenedArgs.add(operand);\n+            }\n+        } while (!stack.empty());\n+\n         BytecodeBlock block = new BytecodeBlock()\n                 .comment(\"AND\")\n                 .setDescription(\"AND\");\n \n-        BytecodeNode left = generator.generate(arguments.get(0), Optional.empty());\n-        BytecodeNode right = generator.generate(arguments.get(1), Optional.empty());\n-\n-        block.append(left);\n-\n-        IfStatement ifLeftIsNull = new IfStatement(\"if left wasNull...\")\n-                .condition(wasNull);\n-\n-        LabelNode end = new LabelNode(\"end\");\n-        ifLeftIsNull.ifTrue()\n-                .comment(\"clear the null flag, pop left value off stack, and push left null flag on the stack (true)\")\n-                .append(wasNull.set(constantFalse()))\n-                .pop(arguments.get(0).getType().getJavaType()) // discard left value\n-                .push(true);\n+        LabelNode falseLabel = new LabelNode(\"false\");\n+        LabelNode endLabel = new LabelNode(\"end\");\n+        Variable wasNull = generator.wasNull();\n \n-        LabelNode leftIsTrue = new LabelNode(\"leftIsTrue\");\n-        ifLeftIsNull.ifFalse()\n-                .comment(\"if left is false, push false, and goto end\")\n-                .ifTrueGoto(leftIsTrue)\n-                .push(false)\n-                .gotoLabel(end)\n-                .comment(\"left was true; push left null flag on the stack (false)\")\n-                .visitLabel(leftIsTrue)\n+        Variable hasNulls = generator.getScope().createTempVariable(boolean.class);\n+        block.initializeVariable(hasNulls);\n+        for (int i = 0; i < flattenedArgs.size(); i++) {\n+            block.comment(\"do { eval arg; if (wasNull) { hasNull = true; wasNull = false; } else if (false) goto ret_false; }\")\n+                    .append(generator.generate(flattenedArgs.get(i), Optional.empty()));\n+\n+            IfStatement ifOperandIsNull = new IfStatement(\"if left wasNulll...\")\n+                    .condition(wasNull);\n+            ifOperandIsNull.ifTrue()\n+                    .comment(\"clear the null flag and remember there was a null\")\n+                    .putVariable(hasNulls, true)\n+                    .putVariable(wasNull, false)\n+                    .pop(boolean.class);\n+\n+            ifOperandIsNull\n+                    .ifFalse()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d45dd7ee8f3840fe8b5fc632d8947c445cccf98d"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg2NzA0NA==", "bodyText": "same", "url": "https://github.com/prestodb/presto/pull/14562#discussion_r432867044", "createdAt": "2020-05-30T16:14:03Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/gen/OrCodeGenerator.java", "diffHunk": "@@ -36,67 +38,70 @@ public BytecodeNode generateExpression(BytecodeGeneratorContext generator, Type\n     {\n         Preconditions.checkArgument(arguments.size() == 2);\n \n-        Variable wasNull = generator.wasNull();\n+        // We flatten the AND here.\n+        Stack<RowExpression> stack = new Stack<RowExpression>();\n+        stack.push(arguments.get(1));\n+        stack.push(arguments.get(0));\n+\n+        List<RowExpression> flattenedArgs = new ArrayList<RowExpression>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d45dd7ee8f3840fe8b5fc632d8947c445cccf98d"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg2NzA1NA==", "bodyText": "same", "url": "https://github.com/prestodb/presto/pull/14562#discussion_r432867054", "createdAt": "2020-05-30T16:14:16Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/gen/OrCodeGenerator.java", "diffHunk": "@@ -36,67 +38,70 @@ public BytecodeNode generateExpression(BytecodeGeneratorContext generator, Type\n     {\n         Preconditions.checkArgument(arguments.size() == 2);\n \n-        Variable wasNull = generator.wasNull();\n+        // We flatten the AND here.\n+        Stack<RowExpression> stack = new Stack<RowExpression>();\n+        stack.push(arguments.get(1));\n+        stack.push(arguments.get(0));\n+\n+        List<RowExpression> flattenedArgs = new ArrayList<RowExpression>();\n+        do {\n+            RowExpression operand = stack.pop();\n+            if (operand instanceof SpecialFormExpression &&\n+                    ((SpecialFormExpression) operand).getForm() == SpecialFormExpression.Form.OR) {\n+                stack.push(((SpecialFormExpression) operand).getArguments().get(1));\n+                stack.push(((SpecialFormExpression) operand).getArguments().get(0));\n+            }\n+            else {\n+                flattenedArgs.add(operand);\n+            }\n+        } while (!stack.empty());\n+\n         BytecodeBlock block = new BytecodeBlock()\n                 .comment(\"OR\")\n                 .setDescription(\"OR\");\n \n-        BytecodeNode left = generator.generate(arguments.get(0), Optional.empty());\n-        BytecodeNode right = generator.generate(arguments.get(1), Optional.empty());\n-\n-        block.append(left);\n-\n-        IfStatement ifLeftIsNull = new IfStatement(\"if left wasNull...\")\n-                .condition(wasNull);\n-\n-        LabelNode end = new LabelNode(\"end\");\n-        ifLeftIsNull.ifTrue(new BytecodeBlock()\n-                .comment(\"clear the null flag, pop left value off stack, and push left null flag on the stack (true)\")\n-                .append(wasNull.set(constantFalse()))\n-                .pop(arguments.get(0).getType().getJavaType()) // discard left value\n-                .push(true));\n-\n-        LabelNode leftIsFalse = new LabelNode(\"leftIsFalse\");\n-        ifLeftIsNull.ifFalse(new BytecodeBlock()\n-                .comment(\"if left is true, push true, and goto end\")\n-                .ifFalseGoto(leftIsFalse)\n-                .push(true)\n-                .gotoLabel(end)\n-                .comment(\"left was false; push left null flag on the stack (false)\")\n-                .visitLabel(leftIsFalse)\n-                .push(false));\n-\n-        block.append(ifLeftIsNull);\n-\n-        // At this point we know the left expression was either NULL or FALSE.  The stack contains a single boolean\n-        // value for this expression which indicates if the left value was NULL.\n-\n-        // eval right!\n-        block.append(right);\n+        LabelNode trueLabel = new LabelNode(\"true\");\n+        LabelNode endLabel = new LabelNode(\"end\");\n+        Variable wasNull = generator.wasNull();\n \n-        IfStatement ifRightIsNull = new IfStatement(\"if right wasNull...\")\n-                .condition(wasNull);\n+        Variable hasNulls = generator.getScope().createTempVariable(boolean.class);\n+        block.initializeVariable(hasNulls);\n+        for (int i = 0; i < flattenedArgs.size(); i++) {\n+            block.comment(\"do { eval arg; if (wasNull) { hasNull = true; wasNull = false; } else if (true) goto ret_true; }\")\n+                    .append(generator.generate(flattenedArgs.get(i), Optional.empty()));\n+            IfStatement ifOperandIsNull = new IfStatement(\"if left wasNulll...\")\n+                    .condition(wasNull);\n+            ifOperandIsNull.ifTrue()\n+                    .comment(\"clear the null flag and remember there was a null\")\n+                    .putVariable(hasNulls, true)\n+                    .putVariable(wasNull, false)\n+                    .pop(boolean.class);\n+\n+            ifOperandIsNull\n+                    .ifFalse()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d45dd7ee8f3840fe8b5fc632d8947c445cccf98d"}, "originalPosition": 95}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg2NzI0MA==", "bodyText": "move EQUAL.getOperator() to its own line", "url": "https://github.com/prestodb/presto/pull/14562#discussion_r432867240", "createdAt": "2020-05-30T16:16:55Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/relational/SqlToRowExpressionTranslator.java", "diffHunk": "@@ -653,12 +610,27 @@ protected RowExpression visitTryExpression(TryExpression node, Void context)\n             throw new UnsupportedOperationException(\"Must desugar TryExpression before translate it into RowExpression\");\n         }\n \n+        private RowExpression buildEquals(RowExpression lhs, RowExpression rhs)\n+        {\n+            return call(EQUAL.getOperator(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d45dd7ee8f3840fe8b5fc632d8947c445cccf98d"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg2NzI1NQ==", "bodyText": "lhs -> value", "url": "https://github.com/prestodb/presto/pull/14562#discussion_r432867255", "createdAt": "2020-05-30T16:17:10Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/relational/SqlToRowExpressionTranslator.java", "diffHunk": "@@ -653,12 +610,27 @@ protected RowExpression visitTryExpression(TryExpression node, Void context)\n             throw new UnsupportedOperationException(\"Must desugar TryExpression before translate it into RowExpression\");\n         }\n \n+        private RowExpression buildEquals(RowExpression lhs, RowExpression rhs)\n+        {\n+            return call(EQUAL.getOperator(),\n+                    functionResolution.comparisonFunction(ComparisonExpression.Operator.EQUAL, lhs.getType(), rhs.getType()),\n+                    BOOLEAN,\n+                    lhs,\n+                    rhs);\n+        }\n+\n         @Override\n         protected RowExpression visitInPredicate(InPredicate node, Void context)\n         {\n             ImmutableList.Builder<RowExpression> arguments = ImmutableList.builder();\n-            arguments.add(process(node.getValue(), context));\n+            RowExpression lhs = process(node.getValue(), context);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d45dd7ee8f3840fe8b5fc632d8947c445cccf98d"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg2NzQzNQ==", "bodyText": "Always keep the same line empty. The first arg should start with its own line.", "url": "https://github.com/prestodb/presto/pull/14562#discussion_r432867435", "createdAt": "2020-05-30T16:19:47Z", "author": {"login": "highker"}, "path": "presto-tests/src/main/java/com/facebook/presto/tests/AbstractTestQueries.java", "diffHunk": "@@ -8348,6 +8348,46 @@ public void testRowExpressionInterpreterStackOverflow()\n         assertQuery(stringBuilder.toString(), \"values -1\");\n     }\n \n+    @Test\n+    public void testSwitchOptimization()\n+    {\n+        assertQuery(\"select 1\", \"select 1\");\n+        assertQuery(\"SELECT CASE WHEN x = 1 THEN 1 WHEN x = 5 THEN 5 WHEN x = IF(RANDOM() >= 0, 3, 5) THEN 10 ELSE -1 END FROM (SELECT ORDERKEY x FROM orders where orderkey <= 10)\",\n+                \"SELECT CASE x WHEN 1 THEN 1 WHEN 5 THEN 5 WHEN 3 THEN 10 ELSE -1 END FROM (SELECT ORDERKEY x FROM orders where orderkey <= 10)\");\n+\n+        assertQuery(\"SELECT CASE x WHEN 1 THEN 1 WHEN 5 THEN 5 WHEN 3 THEN 10 ELSE -1 END FROM (SELECT ORDERKEY x FROM orders where orderkey <= 10)\",\n+                \"SELECT CASE x WHEN 1 THEN 1 WHEN 5 THEN 5 WHEN 3 THEN 10 ELSE -1 END FROM (SELECT ORDERKEY x FROM orders where orderkey <= 10)\");\n+    }\n+\n+    @Test\n+    public void testSwitchReturnsNull()\n+    {\n+        assertQuery(\"SELECT CASE true WHEN random() < 0 THEN true END\",\n+                \"SELECT CAST(NULL AS BOOLEAN)\");\n+\n+        assertQuery(\"SELECT TRUE AND CAST(NULL AS BOOLEAN) AND RANDOM() >= 0\",\n+                \"SELECT CAST(NULL AS BOOLEAN)\");\n+\n+        assertQuery(\"SELECT TRUE AND CAST(NULL AS BOOLEAN) AND RANDOM() < 0\",\n+                \"SELECT FALSE\");\n+\n+        assertQuery(\"SELECT TRUE AND CAST(NULL AS BOOLEAN) IS NULL AND RANDOM() >= 0\",\n+                \"SELECT TRUE\");\n+\n+        assertQuery(\"SELECT 1 = ALL (SELECT CAST(NULL AS INTEGER))\",\n+                \"SELECT CAST(NULL AS BOOLEAN)\");\n+    }\n+\n+    @Test\n+    public void testAndInFilter()\n+    {\n+        assertQuery(\"SELECT count() from (select * from orders where orderkey < random(10)) where ((orderkey > 100 and custkey > 100) or (orderkey > 200 and custkey < 200))\",\n+                \"values 0\");\n+\n+        assertQuery(\"SELECT ((orderkey > 100 and custkey > 100) or (orderkey > 200 and custkey < 200)) from (select * from orders where orderkey < random(10) limit 1)\",\n+                \"values false\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d45dd7ee8f3840fe8b5fc632d8947c445cccf98d"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxNDQyNzA4", "url": "https://github.com/prestodb/presto/pull/14562#pullrequestreview-421442708", "createdAt": "2020-05-30T20:47:36Z", "commit": {"oid": "d45dd7ee8f3840fe8b5fc632d8947c445cccf98d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0zMFQyMDo0NzozN1rOGc1Rfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0zMFQyMDo0NzozN1rOGc1Rfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg4NjE0Mg==", "bodyText": "Done", "url": "https://github.com/prestodb/presto/pull/14562#discussion_r432886142", "createdAt": "2020-05-30T20:47:37Z", "author": {"login": "kaikalur"}, "path": "presto-tests/src/main/java/com/facebook/presto/tests/AbstractTestQueries.java", "diffHunk": "@@ -8348,6 +8348,46 @@ public void testRowExpressionInterpreterStackOverflow()\n         assertQuery(stringBuilder.toString(), \"values -1\");\n     }\n \n+    @Test\n+    public void testSwitchOptimization()\n+    {\n+        assertQuery(\"select 1\", \"select 1\");\n+        assertQuery(\"SELECT CASE WHEN x = 1 THEN 1 WHEN x = 5 THEN 5 WHEN x = IF(RANDOM() >= 0, 3, 5) THEN 10 ELSE -1 END FROM (SELECT ORDERKEY x FROM orders where orderkey <= 10)\",\n+                \"SELECT CASE x WHEN 1 THEN 1 WHEN 5 THEN 5 WHEN 3 THEN 10 ELSE -1 END FROM (SELECT ORDERKEY x FROM orders where orderkey <= 10)\");\n+\n+        assertQuery(\"SELECT CASE x WHEN 1 THEN 1 WHEN 5 THEN 5 WHEN 3 THEN 10 ELSE -1 END FROM (SELECT ORDERKEY x FROM orders where orderkey <= 10)\",\n+                \"SELECT CASE x WHEN 1 THEN 1 WHEN 5 THEN 5 WHEN 3 THEN 10 ELSE -1 END FROM (SELECT ORDERKEY x FROM orders where orderkey <= 10)\");\n+    }\n+\n+    @Test\n+    public void testSwitchReturnsNull()\n+    {\n+        assertQuery(\"SELECT CASE true WHEN random() < 0 THEN true END\",\n+                \"SELECT CAST(NULL AS BOOLEAN)\");\n+\n+        assertQuery(\"SELECT TRUE AND CAST(NULL AS BOOLEAN) AND RANDOM() >= 0\",\n+                \"SELECT CAST(NULL AS BOOLEAN)\");\n+\n+        assertQuery(\"SELECT TRUE AND CAST(NULL AS BOOLEAN) AND RANDOM() < 0\",\n+                \"SELECT FALSE\");\n+\n+        assertQuery(\"SELECT TRUE AND CAST(NULL AS BOOLEAN) IS NULL AND RANDOM() >= 0\",\n+                \"SELECT TRUE\");\n+\n+        assertQuery(\"SELECT 1 = ALL (SELECT CAST(NULL AS INTEGER))\",\n+                \"SELECT CAST(NULL AS BOOLEAN)\");\n+    }\n+\n+    @Test\n+    public void testAndInFilter()\n+    {\n+        assertQuery(\"SELECT count() from (select * from orders where orderkey < random(10)) where ((orderkey > 100 and custkey > 100) or (orderkey > 200 and custkey < 200))\",\n+                \"values 0\");\n+\n+        assertQuery(\"SELECT ((orderkey > 100 and custkey > 100) or (orderkey > 200 and custkey < 200)) from (select * from orders where orderkey < random(10) limit 1)\",\n+                \"values false\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg2NzQzNQ=="}, "originalCommit": {"oid": "d45dd7ee8f3840fe8b5fc632d8947c445cccf98d"}, "originalPosition": 41}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d45dd7ee8f3840fe8b5fc632d8947c445cccf98d", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/d45dd7ee8f3840fe8b5fc632d8947c445cccf98d", "committedDate": "2020-05-29T19:51:57Z", "message": "Streamlined implementation of core control operators"}, "afterCommit": {"oid": "cafefe46aed37859c446416871e4d7757a582c46", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/cafefe46aed37859c446416871e4d7757a582c46", "committedDate": "2020-05-30T20:52:05Z", "message": "Streamlined implementation of core control operators"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyOTE4ODQ0", "url": "https://github.com/prestodb/presto/pull/14562#pullrequestreview-422918844", "createdAt": "2020-06-02T17:52:24Z", "commit": {"oid": "cafefe46aed37859c446416871e4d7757a582c46"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxNzo1MjoyNFrOGd9H_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxNzo1MjoyNFrOGd9H_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA2MzM1Ng==", "bodyText": "Deque<RowExpression> stack = new ArrayDeque<>();", "url": "https://github.com/prestodb/presto/pull/14562#discussion_r434063356", "createdAt": "2020-06-02T17:52:24Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/gen/AndCodeGenerator.java", "diffHunk": "@@ -36,68 +38,69 @@ public BytecodeNode generateExpression(BytecodeGeneratorContext generator, Type\n     {\n         Preconditions.checkArgument(arguments.size() == 2);\n \n-        Variable wasNull = generator.wasNull();\n+        // We flatten the AND here.\n+        ArrayDeque<RowExpression> stack = new ArrayDeque<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cafefe46aed37859c446416871e4d7757a582c46"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03b9eabe880af848e4d6846896f6288cc753d246", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/03b9eabe880af848e4d6846896f6288cc753d246", "committedDate": "2020-06-02T18:00:06Z", "message": "Streamlined implementation of core control operators"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cafefe46aed37859c446416871e4d7757a582c46", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/cafefe46aed37859c446416871e4d7757a582c46", "committedDate": "2020-05-30T20:52:05Z", "message": "Streamlined implementation of core control operators"}, "afterCommit": {"oid": "03b9eabe880af848e4d6846896f6288cc753d246", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/03b9eabe880af848e4d6846896f6288cc753d246", "committedDate": "2020-06-02T18:00:06Z", "message": "Streamlined implementation of core control operators"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1697, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}