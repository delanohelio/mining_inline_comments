{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk2NzQ5Mzg2", "number": 15260, "title": "Adding array functions pushdown to pinot", "bodyText": "Support pushing down Array functions to Pinot.\n\nArray functions(array_sum, array_min, array_max, array_average) inside aggregation functions or group by clause  to Pinot.\nBoolean functions in Predicate: contains\n\nE.g. For Presto query: SELECT sum(array_max(col)) FROM myTable WHERE contains(col, 1) , the pushdown pinot query is: SELECT sum(arrayMax(col)) FROM myTable WHERE col = 1\nTest plan:\nUnit tests and tested with local setup for array functions(array_sum, array_min, array_max, array_average, contains) pushdown to Pinot:\n== RELEASE NOTES ==\n\nPinot Changes\n* Support pushing down array functions `array_sum`, `array_min`, `array_max`, `array_average`, and `contains` to Pinot connector.", "createdAt": "2020-10-02T07:58:11Z", "url": "https://github.com/prestodb/presto/pull/15260", "merged": true, "mergeCommit": {"oid": "5c29aa2d06d2c9e2634b56611355226a7bc5b881"}, "closed": true, "closedAt": "2020-10-04T22:46:56Z", "author": {"login": "xiangfu0"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdOqb9yAFqTUwMTM2MTMyNg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdPUhZqgBqjM4Mzc4ODQ1NTk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxMzYxMzI2", "url": "https://github.com/prestodb/presto/pull/15260#pullrequestreview-501361326", "createdAt": "2020-10-02T18:33:18Z", "commit": {"oid": "492b7b6a593f6beaf38e5326ea5bb71c2cf53842"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxODozMzoxOFrOHb3vCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxODozNjo1NFrOHb315w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk4Njc2Mg==", "bodyText": "nit: PRESTO_TO_PINOT_ARRAY_AGGREGATIONS ?\nJust something verbose to state what is it a map of (ie, what is the key/value).", "url": "https://github.com/prestodb/presto/pull/15260#discussion_r498986762", "createdAt": "2020-10-02T18:33:18Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotAggregationProjectConverter.java", "diffHunk": "@@ -51,14 +51,28 @@\n             \"/\", \"DIV\");\n     private static final String FROM_UNIXTIME = \"from_unixtime\";\n \n+    private static final Map<String, String> ARRAY_AGGREGATION_ALLOWED_PUSHDOWN_MAP = ImmutableMap.<String, String>builder()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "492b7b6a593f6beaf38e5326ea5bb71c2cf53842"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk4NzcwNQ==", "bodyText": "Should we require that the .get does not return a null here ?", "url": "https://github.com/prestodb/presto/pull/15260#discussion_r498987705", "createdAt": "2020-10-02T18:35:07Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotAggregationProjectConverter.java", "diffHunk": "@@ -217,17 +231,45 @@ private PinotExpression handleFunction(\n             CallExpression function,\n             Map<VariableReferenceExpression, PinotQueryGeneratorContext.Selection> context)\n     {\n-        switch (function.getDisplayName().toLowerCase(ENGLISH)) {\n+        String functionName = function.getDisplayName().toLowerCase(ENGLISH);\n+        switch (functionName) {\n             case \"date_trunc\":\n                 boolean useDateTruncation = PinotSessionProperties.isUseDateTruncation(session);\n                 return useDateTruncation ?\n                         handleDateTruncationViaDateTruncation(function, context) :\n                         handleDateTruncationViaDateTimeConvert(function, context);\n+            case \"array_max\":\n+            case \"array_min\":\n+                return derived(String.format(\"%s(%s)\",\n+                        ARRAY_AGGREGATION_ALLOWED_PUSHDOWN_MAP.get(functionName),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "492b7b6a593f6beaf38e5326ea5bb71c2cf53842"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk4ODUxOQ==", "bodyText": "I feel we should do a stronger check here: Like that the split length should not be more than 3 perhaps ? Just vary of doing the wrong thing if say we get something weird like array_sum_1_3 :-P", "url": "https://github.com/prestodb/presto/pull/15260#discussion_r498988519", "createdAt": "2020-10-02T18:36:54Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotAggregationProjectConverter.java", "diffHunk": "@@ -217,17 +231,45 @@ private PinotExpression handleFunction(\n             CallExpression function,\n             Map<VariableReferenceExpression, PinotQueryGeneratorContext.Selection> context)\n     {\n-        switch (function.getDisplayName().toLowerCase(ENGLISH)) {\n+        String functionName = function.getDisplayName().toLowerCase(ENGLISH);\n+        switch (functionName) {\n             case \"date_trunc\":\n                 boolean useDateTruncation = PinotSessionProperties.isUseDateTruncation(session);\n                 return useDateTruncation ?\n                         handleDateTruncationViaDateTruncation(function, context) :\n                         handleDateTruncationViaDateTimeConvert(function, context);\n+            case \"array_max\":\n+            case \"array_min\":\n+                return derived(String.format(\"%s(%s)\",\n+                        ARRAY_AGGREGATION_ALLOWED_PUSHDOWN_MAP.get(functionName),\n+                        function.getArguments().get(0).accept(this, context).getDefinition()));\n+            // array_sum and array_reduce are translated to a reduce function with lambda functions, so we pass in\n+            // this arrayVariableHint to help determine which array function it is.\n+            case \"reduce\":\n+                if (arrayVariableHint != null) {\n+                    String arrayFunctionName = getArrayFunctionName(arrayVariableHint);\n+                    if (arrayFunctionName != null) {\n+                        String inputColumn = function.getArguments().get(0).accept(this, context).getDefinition();\n+                        return derived(String.format(\"%s(%s)\", arrayFunctionName, inputColumn));\n+                    }\n+                }\n             default:\n                 throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), format(\"function %s not supported yet\", function.getDisplayName()));\n         }\n     }\n \n+    // The array function variable names are in the format of `array_sum`, `array_average_0`, `array_sum_1`.\n+    // So we can parse the array function name based on variable name.\n+    private String getArrayFunctionName(VariableReferenceExpression variable)\n+    {\n+        String[] variableNameSplits = variable.getName().split(\"_\");\n+        if (variableNameSplits.length < 2) {\n+            return null;\n+        }\n+        String arrayFunctionName = String.format(\"%s_%s\", variableNameSplits[0], variableNameSplits[1]);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "492b7b6a593f6beaf38e5326ea5bb71c2cf53842"}, "originalPosition": 69}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "492b7b6a593f6beaf38e5326ea5bb71c2cf53842", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/492b7b6a593f6beaf38e5326ea5bb71c2cf53842", "committedDate": "2020-10-02T07:56:16Z", "message": "Adding array functions pushdown to pinot"}, "afterCommit": {"oid": "0301b8e60e9e541b9640268d8457d4bee8d5a6f1", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/0301b8e60e9e541b9640268d8457d4bee8d5a6f1", "committedDate": "2020-10-03T07:49:27Z", "message": "Adding array functions pushdown to pinot"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxNTU1NDU3", "url": "https://github.com/prestodb/presto/pull/15260#pullrequestreview-501555457", "createdAt": "2020-10-03T15:54:49Z", "commit": {"oid": "0301b8e60e9e541b9640268d8457d4bee8d5a6f1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wM1QxNTo1NDo0OVrOHcCQtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wM1QxNTo1NDo0OVrOHcCQtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTE1OTIyMQ==", "bodyText": "I could not see any unit tests for this reduce codepath. Are they indeed there ?", "url": "https://github.com/prestodb/presto/pull/15260#discussion_r499159221", "createdAt": "2020-10-03T15:54:49Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotAggregationProjectConverter.java", "diffHunk": "@@ -217,17 +231,46 @@ private PinotExpression handleFunction(\n             CallExpression function,\n             Map<VariableReferenceExpression, PinotQueryGeneratorContext.Selection> context)\n     {\n-        switch (function.getDisplayName().toLowerCase(ENGLISH)) {\n+        String functionName = function.getDisplayName().toLowerCase(ENGLISH);\n+        switch (functionName) {\n             case \"date_trunc\":\n                 boolean useDateTruncation = PinotSessionProperties.isUseDateTruncation(session);\n                 return useDateTruncation ?\n                         handleDateTruncationViaDateTruncation(function, context) :\n                         handleDateTruncationViaDateTimeConvert(function, context);\n+            case \"array_max\":\n+            case \"array_min\":\n+                String pinotArrayFunctionName = PRESTO_TO_PINOT_ARRAY_AGGREGATIONS.get(functionName);\n+                requireNonNull(pinotArrayFunctionName, \"Converted Pinot array function is null for - \" + functionName);\n+                return derived(String.format(\"%s(%s)\", pinotArrayFunctionName,\n+                        function.getArguments().get(0).accept(this, context).getDefinition()));\n+            // array_sum and array_reduce are translated to a reduce function with lambda functions, so we pass in\n+            // this arrayVariableHint to help determine which array function it is.\n+            case \"reduce\":", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0301b8e60e9e541b9640268d8457d4bee8d5a6f1"}, "originalPosition": 49}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0301b8e60e9e541b9640268d8457d4bee8d5a6f1", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/0301b8e60e9e541b9640268d8457d4bee8d5a6f1", "committedDate": "2020-10-03T07:49:27Z", "message": "Adding array functions pushdown to pinot"}, "afterCommit": {"oid": "10b39e857c5f01e81cabe651ca36ea47cb5407f7", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/10b39e857c5f01e81cabe651ca36ea47cb5407f7", "committedDate": "2020-10-03T21:25:08Z", "message": "Adding array functions pushdown to pinot"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxNTc3Njk5", "url": "https://github.com/prestodb/presto/pull/15260#pullrequestreview-501577699", "createdAt": "2020-10-03T22:24:33Z", "commit": {"oid": "10b39e857c5f01e81cabe651ca36ea47cb5407f7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "10b39e857c5f01e81cabe651ca36ea47cb5407f7", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/10b39e857c5f01e81cabe651ca36ea47cb5407f7", "committedDate": "2020-10-03T21:25:08Z", "message": "Adding array functions pushdown to pinot"}, "afterCommit": {"oid": "2fc2ef1810e33e83abc86620250891fcd880e411", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/2fc2ef1810e33e83abc86620250891fcd880e411", "committedDate": "2020-10-03T22:25:28Z", "message": "Adding array functions pushdown to pinot"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2fc2ef1810e33e83abc86620250891fcd880e411", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/2fc2ef1810e33e83abc86620250891fcd880e411", "committedDate": "2020-10-03T22:25:28Z", "message": "Adding array functions pushdown to pinot"}, "afterCommit": {"oid": "83f91eef61b60f3e6f9d435e94a89d798824ed73", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/83f91eef61b60f3e6f9d435e94a89d798824ed73", "committedDate": "2020-10-04T00:02:06Z", "message": "Adding array functions pushdown to pinot"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxNTgxODAy", "url": "https://github.com/prestodb/presto/pull/15260#pullrequestreview-501581802", "createdAt": "2020-10-04T00:17:00Z", "commit": {"oid": "83f91eef61b60f3e6f9d435e94a89d798824ed73"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQwMDoxNzowMFrOHcETiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQwMDoxNzozNlrOHcETpA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTE5MjcxMg==", "bodyText": "Should one side be a literal here ? What happens if I do a: array_col1 contains array_col2 ?\nWould presto ensure that array_col2 is a literal ?\nWhat happens when array_col2 is a non literal scalar ? Would that be supported by Pinot ?", "url": "https://github.com/prestodb/presto/pull/15260#discussion_r499192712", "createdAt": "2020-10-04T00:17:00Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotFilterExpressionConverter.java", "diffHunk": "@@ -201,6 +201,23 @@ else if (timeFieldExpression instanceof ConstantExpression) {\n         return Optional.of(timeValueString);\n     }\n \n+    private PinotExpression handleContains(\n+            CallExpression contains,\n+            Function<VariableReferenceExpression, Selection> context)\n+    {\n+        if (contains.getArguments().size() == 2) {\n+            RowExpression left = contains.getArguments().get(0);\n+            RowExpression right = contains.getArguments().get(1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "83f91eef61b60f3e6f9d435e94a89d798824ed73"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTE5Mjc0MA==", "bodyText": "Its a bit weird to have a single case switch.", "url": "https://github.com/prestodb/presto/pull/15260#discussion_r499192740", "createdAt": "2020-10-04T00:17:36Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotFilterExpressionConverter.java", "diffHunk": "@@ -294,6 +311,10 @@ public PinotExpression visitCall(CallExpression call, Function<VariableReference\n                 return handleLogicalBinary(operatorType.getOperator(), call, context);\n             }\n         }\n+        switch (functionMetadata.getName().getFunctionName()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "83f91eef61b60f3e6f9d435e94a89d798824ed73"}, "originalPosition": 28}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "83f91eef61b60f3e6f9d435e94a89d798824ed73", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/83f91eef61b60f3e6f9d435e94a89d798824ed73", "committedDate": "2020-10-04T00:02:06Z", "message": "Adding array functions pushdown to pinot"}, "afterCommit": {"oid": "462536ff326e86582ab23f93bfa6a92148774503", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/462536ff326e86582ab23f93bfa6a92148774503", "committedDate": "2020-10-04T00:58:31Z", "message": "Adding array functions pushdown to pinot"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "462536ff326e86582ab23f93bfa6a92148774503", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/462536ff326e86582ab23f93bfa6a92148774503", "committedDate": "2020-10-04T00:58:31Z", "message": "Adding array functions pushdown to pinot"}, "afterCommit": {"oid": "81ca2d2c6d850349ed552bd46fa93d4c4c8408ef", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/81ca2d2c6d850349ed552bd46fa93d4c4c8408ef", "committedDate": "2020-10-04T06:42:28Z", "message": "Adding array functions pushdown to pinot"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxNjMzNTc3", "url": "https://github.com/prestodb/presto/pull/15260#pullrequestreview-501633577", "createdAt": "2020-10-04T15:25:06Z", "commit": {"oid": "81ca2d2c6d850349ed552bd46fa93d4c4c8408ef"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQxNToyNTowNlrOHcITPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQxNToyNTowNlrOHcITPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI1ODE3Mg==", "bodyText": "How about a simple Pinot unsupported exception here ?\nOr is this a bug in presto ? Like does presto (over hive) allow a non literal here ? If it allows and we merely want to forbid pushdown then, Pinot connector should use unsupported exception here.", "url": "https://github.com/prestodb/presto/pull/15260#discussion_r499258172", "createdAt": "2020-10-04T15:25:06Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotFilterExpressionConverter.java", "diffHunk": "@@ -201,6 +202,24 @@ else if (timeFieldExpression instanceof ConstantExpression) {\n         return Optional.of(timeValueString);\n     }\n \n+    private PinotExpression handleContains(\n+            CallExpression contains,\n+            Function<VariableReferenceExpression, Selection> context)\n+    {\n+        if (contains.getArguments().size() == 2) {\n+            RowExpression left = contains.getArguments().get(0);\n+            RowExpression right = contains.getArguments().get(1);\n+            Preconditions.checkState(right instanceof ConstantExpression, format(\"Contains operator can not push down non-literal value: %s\", right));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "81ca2d2c6d850349ed552bd46fa93d4c4c8408ef"}, "originalPosition": 19}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "81ca2d2c6d850349ed552bd46fa93d4c4c8408ef", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/81ca2d2c6d850349ed552bd46fa93d4c4c8408ef", "committedDate": "2020-10-04T06:42:28Z", "message": "Adding array functions pushdown to pinot"}, "afterCommit": {"oid": "442e0bcf59ab6da0536801c7089fe426feaaf6ed", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/442e0bcf59ab6da0536801c7089fe426feaaf6ed", "committedDate": "2020-10-04T17:26:10Z", "message": "Adding array functions pushdown to pinot"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxNjQ3Njc5", "url": "https://github.com/prestodb/presto/pull/15260#pullrequestreview-501647679", "createdAt": "2020-10-04T18:28:48Z", "commit": {"oid": "442e0bcf59ab6da0536801c7089fe426feaaf6ed"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQxODoyODo0OFrOHcJUNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQxODozMDo0OFrOHcJU3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI3NDgwNA==", "bodyText": "if (contains.getArguments().size() != 2) {\n    throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), format(\"Contains operator not supported: %s\", contains));\n}\n\n...", "url": "https://github.com/prestodb/presto/pull/15260#discussion_r499274804", "createdAt": "2020-10-04T18:28:48Z", "author": {"login": "highker"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotFilterExpressionConverter.java", "diffHunk": "@@ -201,6 +201,26 @@ else if (timeFieldExpression instanceof ConstantExpression) {\n         return Optional.of(timeValueString);\n     }\n \n+    private PinotExpression handleContains(\n+            CallExpression contains,\n+            Function<VariableReferenceExpression, Selection> context)\n+    {\n+        if (contains.getArguments().size() == 2) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "442e0bcf59ab6da0536801c7089fe426feaaf6ed"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI3NDk3Mg==", "bodyText": "one param per line", "url": "https://github.com/prestodb/presto/pull/15260#discussion_r499274972", "createdAt": "2020-10-04T18:30:48Z", "author": {"login": "highker"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotAggregationProjectConverter.java", "diffHunk": "@@ -217,17 +231,46 @@ private PinotExpression handleFunction(\n             CallExpression function,\n             Map<VariableReferenceExpression, PinotQueryGeneratorContext.Selection> context)\n     {\n-        switch (function.getDisplayName().toLowerCase(ENGLISH)) {\n+        String functionName = function.getDisplayName().toLowerCase(ENGLISH);\n+        switch (functionName) {\n             case \"date_trunc\":\n                 boolean useDateTruncation = PinotSessionProperties.isUseDateTruncation(session);\n                 return useDateTruncation ?\n                         handleDateTruncationViaDateTruncation(function, context) :\n                         handleDateTruncationViaDateTimeConvert(function, context);\n+            case \"array_max\":\n+            case \"array_min\":\n+                String pinotArrayFunctionName = PRESTO_TO_PINOT_ARRAY_AGGREGATIONS.get(functionName);\n+                requireNonNull(pinotArrayFunctionName, \"Converted Pinot array function is null for - \" + functionName);\n+                return derived(String.format(\"%s(%s)\", pinotArrayFunctionName,\n+                        function.getArguments().get(0).accept(this, context).getDefinition()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "442e0bcf59ab6da0536801c7089fe426feaaf6ed"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52f19fb21710b5597d8d87993101ed996e675f5e", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/52f19fb21710b5597d8d87993101ed996e675f5e", "committedDate": "2020-10-04T19:40:31Z", "message": "Adding array functions pushdown to pinot"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "442e0bcf59ab6da0536801c7089fe426feaaf6ed", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/442e0bcf59ab6da0536801c7089fe426feaaf6ed", "committedDate": "2020-10-04T17:26:10Z", "message": "Adding array functions pushdown to pinot"}, "afterCommit": {"oid": "52f19fb21710b5597d8d87993101ed996e675f5e", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/52f19fb21710b5597d8d87993101ed996e675f5e", "committedDate": "2020-10-04T19:40:31Z", "message": "Adding array functions pushdown to pinot"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4831, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}