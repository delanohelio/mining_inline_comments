{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA4MzM1MzE0", "number": 14431, "title": "Fix query client timeout", "bodyText": "The queryPurger in QueuedStatementResource was inadvertently triggering a heartbeat when checking if the query was expired, preventing expiration.\n== NO RELEASE NOTE ==", "createdAt": "2020-04-24T05:16:32Z", "url": "https://github.com/prestodb/presto/pull/14431", "merged": true, "mergeCommit": {"oid": "0e6c5ffd1df775e5da562fa1f0a809ccdbf94939"}, "closed": true, "closedAt": "2020-04-27T18:54:58Z", "author": {"login": "tdcmeehan"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcaqfryABqjMyNjc4NzM1NjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcbyAfzAFqTQwMTEyOTg3OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0a3c7315c97f04d2c80876f37385852473458afc", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/0a3c7315c97f04d2c80876f37385852473458afc", "committedDate": "2020-04-24T05:16:08Z", "message": "Fix query client timeout"}, "afterCommit": {"oid": "f05292c4bab0687f78692bec82a42d7e26eaf2af", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/f05292c4bab0687f78692bec82a42d7e26eaf2af", "committedDate": "2020-04-24T05:18:29Z", "message": "Fix query client timeout"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f05292c4bab0687f78692bec82a42d7e26eaf2af", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/f05292c4bab0687f78692bec82a42d7e26eaf2af", "committedDate": "2020-04-24T05:18:29Z", "message": "Fix query client timeout"}, "afterCommit": {"oid": "0769cac3bb940fd02117222c08aa08a505c6486a", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/0769cac3bb940fd02117222c08aa08a505c6486a", "committedDate": "2020-04-24T05:22:22Z", "message": "Fix query client timeout"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwMTI5NjY1", "url": "https://github.com/prestodb/presto/pull/14431#pullrequestreview-400129665", "createdAt": "2020-04-24T17:15:56Z", "commit": {"oid": "0769cac3bb940fd02117222c08aa08a505c6486a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwMjA0Mzky", "url": "https://github.com/prestodb/presto/pull/14431#pullrequestreview-400204392", "createdAt": "2020-04-24T19:09:38Z", "commit": {"oid": "0769cac3bb940fd02117222c08aa08a505c6486a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwMTk3OTA2", "url": "https://github.com/prestodb/presto/pull/14431#pullrequestreview-400197906", "createdAt": "2020-04-24T18:59:07Z", "commit": {"oid": "0769cac3bb940fd02117222c08aa08a505c6486a"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxODo1OTowN1rOGLlKBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxOTowOTowMFrOGLlfWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc5NjI5Mg==", "bodyText": "Why do we need to recreate the server for each method? Starting and stopping a server is usually slow and prone to memory leaks", "url": "https://github.com/prestodb/presto/pull/14431#discussion_r414796292", "createdAt": "2020-04-24T18:59:07Z", "author": {"login": "arhimondr"}, "path": "presto-main/src/test/java/com/facebook/presto/server/TestQueryResource.java", "diffHunk": "@@ -44,48 +49,38 @@\n     private final HttpClient client = new JettyHttpClient();\n     private TestingPrestoServer server;\n \n-    public TestQueryResource()\n-            throws Exception\n-    {\n-        server = new TestingPrestoServer();\n-    }\n-\n-    @BeforeClass\n+    @BeforeMethod", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0769cac3bb940fd02117222c08aa08a505c6486a"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc5NjUzMw==", "bodyText": "We should initialize it in setup and close and nullify it in teardown to avoid memory leaks", "url": "https://github.com/prestodb/presto/pull/14431#discussion_r414796533", "createdAt": "2020-04-24T18:59:32Z", "author": {"login": "arhimondr"}, "path": "presto-main/src/test/java/com/facebook/presto/server/TestQueryResource.java", "diffHunk": "@@ -44,48 +49,38 @@\n     private final HttpClient client = new JettyHttpClient();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0769cac3bb940fd02117222c08aa08a505c6486a"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc5NzUxMQ==", "bodyText": "Can we have lover timeouts? e.g.: 10s / 20s?", "url": "https://github.com/prestodb/presto/pull/14431#discussion_r414797511", "createdAt": "2020-04-24T19:01:18Z", "author": {"login": "arhimondr"}, "path": "presto-main/src/test/java/com/facebook/presto/server/TestQueryResource.java", "diffHunk": "@@ -103,12 +98,64 @@ public void testGetQueryInfos()\n         assertStateCounts(infos, 0, 0, 0);\n     }\n \n+    @Test(timeOut = 60_000)\n+    public void testExpiredQueryInfo()\n+            throws Exception\n+    {\n+        runToQueued(\"SELECT 1\");\n+\n+        Thread.sleep(TimeUnit.SECONDS.toMillis(40));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0769cac3bb940fd02117222c08aa08a505c6486a"}, "originalPosition": 95}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgwMTc1NA==", "bodyText": "I see why is it needed. Basically you need to recreate the server to reset the counters.\nWhat do you think about simply moving the runToCompletion  statements to the test itself? Then you can simply add the runToQueued and adjust the counters.", "url": "https://github.com/prestodb/presto/pull/14431#discussion_r414801754", "createdAt": "2020-04-24T19:09:00Z", "author": {"login": "arhimondr"}, "path": "presto-main/src/test/java/com/facebook/presto/server/TestQueryResource.java", "diffHunk": "@@ -44,48 +49,38 @@\n     private final HttpClient client = new JettyHttpClient();\n     private TestingPrestoServer server;\n \n-    public TestQueryResource()\n-            throws Exception\n-    {\n-        server = new TestingPrestoServer();\n-    }\n-\n-    @BeforeClass\n+    @BeforeMethod", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc5NjI5Mg=="}, "originalCommit": {"oid": "0769cac3bb940fd02117222c08aa08a505c6486a"}, "originalPosition": 30}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0769cac3bb940fd02117222c08aa08a505c6486a", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/0769cac3bb940fd02117222c08aa08a505c6486a", "committedDate": "2020-04-24T05:22:22Z", "message": "Fix query client timeout"}, "afterCommit": {"oid": "12a0c5ebfbd95d115307e10c8f1c0679f90c9f5f", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/12a0c5ebfbd95d115307e10c8f1c0679f90c9f5f", "committedDate": "2020-04-24T20:03:50Z", "message": "Fix query client timeout"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "12a0c5ebfbd95d115307e10c8f1c0679f90c9f5f", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/12a0c5ebfbd95d115307e10c8f1c0679f90c9f5f", "committedDate": "2020-04-24T20:03:50Z", "message": "Fix query client timeout"}, "afterCommit": {"oid": "d377421aed3a65346cdb334cce06cef5c80c636c", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/d377421aed3a65346cdb334cce06cef5c80c636c", "committedDate": "2020-04-24T20:05:55Z", "message": "Fix query client timeout"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d377421aed3a65346cdb334cce06cef5c80c636c", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/d377421aed3a65346cdb334cce06cef5c80c636c", "committedDate": "2020-04-24T20:05:55Z", "message": "Fix query client timeout"}, "afterCommit": {"oid": "d393ac0c89af26e9d8a086befa163aa604311015", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/d393ac0c89af26e9d8a086befa163aa604311015", "committedDate": "2020-04-24T20:07:29Z", "message": "Fix query client timeout"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwMzI2NzQw", "url": "https://github.com/prestodb/presto/pull/14431#pullrequestreview-400326740", "createdAt": "2020-04-24T23:45:25Z", "commit": {"oid": "d393ac0c89af26e9d8a086befa163aa604311015"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7dda1b8f3964692e9e4d8f4c8f05b87792759fb", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/c7dda1b8f3964692e9e4d8f4c8f05b87792759fb", "committedDate": "2020-04-25T13:55:16Z", "message": "Fix query client timeout"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d393ac0c89af26e9d8a086befa163aa604311015", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/d393ac0c89af26e9d8a086befa163aa604311015", "committedDate": "2020-04-24T20:07:29Z", "message": "Fix query client timeout"}, "afterCommit": {"oid": "c7dda1b8f3964692e9e4d8f4c8f05b87792759fb", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/c7dda1b8f3964692e9e4d8f4c8f05b87792759fb", "committedDate": "2020-04-25T13:55:16Z", "message": "Fix query client timeout"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxMTI5ODc4", "url": "https://github.com/prestodb/presto/pull/14431#pullrequestreview-401129878", "createdAt": "2020-04-27T16:37:50Z", "commit": {"oid": "c7dda1b8f3964692e9e4d8f4c8f05b87792759fb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1893, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}