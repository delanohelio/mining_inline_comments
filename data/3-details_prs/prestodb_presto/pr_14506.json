{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE1NDgzMjg3", "number": 14506, "title": "Auto-resolve certain result mismatches", "bodyText": "The PR extends FailureResolver to not only be able to resolve query failures, but also result mismatches. Added 2 types of result mismatch resolvers.\nStructuredColumnMismatchResolver\nIf array element or map key/value contains floating point types,\ncolumn checksum is unlikely to match. Hence, we can allow Verifier\nto auto resolve those cases.\n\nFor an array column, resolve if the element type contains floating\npoint types and the cardinality matches.\nFor a map column, resolve if either key or value contains floating\npoint types, the cardinality sum matches, and the checksum of the\nkey or value that does not contains floating point type matches.\nResolve a test case only when all columns are resolved.\n\nIgnoredFunctionsMismatchResolver\nIn the case of a results mismatch, if the query uses a function in a\nspecified list, the test case is marked as resolved.\nThis is useful to mark certain FB functions that is known to produce\ndifferent results on Verifier.\n== RELEASE NOTES ==\n\nVerifier Changes\n* Add support to auto-resolve result mismatch for structured-type columns.\n* Add support to auto-resolve result mismatch in case the query uses functions to be ignored.", "createdAt": "2020-05-09T00:16:17Z", "url": "https://github.com/prestodb/presto/pull/14506", "merged": true, "mergeCommit": {"oid": "b6985d3a5da63710bf95732ffa526232f223d02d"}, "closed": true, "closedAt": "2020-05-19T13:55:01Z", "author": {"login": "caithagoras"}, "timelineItems": {"totalCount": 38, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcfbLi_gBqjMzMTg3OTM0Mjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcilaZxAFqTQxMzg5NjE4Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "68b046600b1a708f696cef9f1f9f20287b4c6992", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/68b046600b1a708f696cef9f1f9f20287b4c6992", "committedDate": "2020-05-09T00:14:54Z", "message": "Return checksum objects in column validator\n\nColumnMatchResult contains only a String message to display the\ncolumn checksum discrepancy between control and test.\n\nInstead, explicitly returns ColumnChecksum object so that they\ncan be programmatically accessed in Verifier."}, "afterCommit": {"oid": "1658774e55acbcd74b33f893e0b57cdec933b5ef", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/1658774e55acbcd74b33f893e0b57cdec933b5ef", "committedDate": "2020-05-09T00:16:50Z", "message": "Return checksum objects in column validator\n\nColumnMatchResult contains only a String message. It contains\ntext description about the discrepancy between control and test\ncolumn checksum.\n\nInstead, returns Java object ColumnChecksum object so that they\ncan be programmatically accessed in Verifier."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1658774e55acbcd74b33f893e0b57cdec933b5ef", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/1658774e55acbcd74b33f893e0b57cdec933b5ef", "committedDate": "2020-05-09T00:16:50Z", "message": "Return checksum objects in column validator\n\nColumnMatchResult contains only a String message. It contains\ntext description about the discrepancy between control and test\ncolumn checksum.\n\nInstead, returns Java object ColumnChecksum object so that they\ncan be programmatically accessed in Verifier."}, "afterCommit": {"oid": "0d3d585ddafbef517507f8270ccebd7097fa1e57", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/0d3d585ddafbef517507f8270ccebd7097fa1e57", "committedDate": "2020-05-09T00:19:41Z", "message": "Return checksum objects in column validator\n\nColumnMatchResult contains only a String message. It contains\ntext description about the discrepancy between control and test\ncolumn checksum.\n\nInstead, returns Java object ColumnChecksum object so that they\ncan be programmatically accessed in Verifier.\n\nAlso, MatchResult.mismatchedColumns does not need to be a map.\nChange it to a list."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "513e6782e03ea4ded5e1132fe3d64af1661df28a", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/513e6782e03ea4ded5e1132fe3d64af1661df28a", "committedDate": "2020-05-09T00:52:56Z", "message": "Auto-resolve mismatched strucutured-type columns\n\nIf array element or map key/value contains floating point types,\ncolumn checksum is unlikely to match. Hence, we can allow Verifier\nto auto resolve those cases.\n\n- For an array column, resolve if the element type contains floating\n  point type.\n- For a map column, resolve if either key or value contains floating\n  point type, the cardinality sum matches, and the key or value that\n  does not contains floating point type matches.\n\nWe check each mismatched column and resolve the test case only when\nall columns are resolved."}, "afterCommit": {"oid": "1457444a6543069e1f641988598e579f736cbf24", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/1457444a6543069e1f641988598e579f736cbf24", "committedDate": "2020-05-09T01:56:45Z", "message": "Auto-resolve mismatched strucutured-type columns\n\nIf array element or map key/value contains floating point types,\ncolumn checksum is unlikely to match. Hence, we can allow Verifier\nto auto resolve those cases.\n\n- For an array column, resolve if the element type contains floating\n  point type.\n- For a map column, resolve if either key or value contains floating\n  point type, the cardinality sum matches, and the key or value that\n  does not contains floating point type matches.\n\nWe check each mismatched column and resolve the test case only when\nall columns are resolved."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1457444a6543069e1f641988598e579f736cbf24", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/1457444a6543069e1f641988598e579f736cbf24", "committedDate": "2020-05-09T01:56:45Z", "message": "Auto-resolve mismatched strucutured-type columns\n\nIf array element or map key/value contains floating point types,\ncolumn checksum is unlikely to match. Hence, we can allow Verifier\nto auto resolve those cases.\n\n- For an array column, resolve if the element type contains floating\n  point type.\n- For a map column, resolve if either key or value contains floating\n  point type, the cardinality sum matches, and the key or value that\n  does not contains floating point type matches.\n\nWe check each mismatched column and resolve the test case only when\nall columns are resolved."}, "afterCommit": {"oid": "e998ed5ee44952acf102fd6159218c35dd0820d1", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/e998ed5ee44952acf102fd6159218c35dd0820d1", "committedDate": "2020-05-09T02:41:07Z", "message": "Auto-resolve mismatched strucutured-type columns\n\nIf array element or map key/value contains floating point types,\ncolumn checksum is unlikely to match. Hence, we can allow Verifier\nto auto resolve those cases.\n\n- For an array column, resolve if the element type contains floating\n  point type.\n- For a map column, resolve if either key or value contains floating\n  point type, the cardinality sum matches, and the key or value that\n  does not contains floating point type matches.\n\nWe check each mismatched column and resolve the test case only when\nall columns are resolved."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e998ed5ee44952acf102fd6159218c35dd0820d1", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/e998ed5ee44952acf102fd6159218c35dd0820d1", "committedDate": "2020-05-09T02:41:07Z", "message": "Auto-resolve mismatched strucutured-type columns\n\nIf array element or map key/value contains floating point types,\ncolumn checksum is unlikely to match. Hence, we can allow Verifier\nto auto resolve those cases.\n\n- For an array column, resolve if the element type contains floating\n  point type.\n- For a map column, resolve if either key or value contains floating\n  point type, the cardinality sum matches, and the key or value that\n  does not contains floating point type matches.\n\nWe check each mismatched column and resolve the test case only when\nall columns are resolved."}, "afterCommit": {"oid": "8481c716d2de2ad7d8e7f17766f0c32912956f71", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/8481c716d2de2ad7d8e7f17766f0c32912956f71", "committedDate": "2020-05-09T02:41:48Z", "message": "Auto-resolve mismatched strucutured-type columns\n\nIf array element or map key/value contains floating point types,\ncolumn checksum is unlikely to match. Hence, we can allow Verifier\nto auto resolve those cases.\n\n- For an array column, resolve if the element type contains floating\n  point type.\n- For a map column, resolve if either key or value contains floating\n  point type, the cardinality sum matches, and the key or value that\n  does not contains floating point type matches.\n\nWe check each mismatched column and resolve the test case only when\nall columns are resolved."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e86929db55b88e33390fcce2b637c461bb2a255e", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/e86929db55b88e33390fcce2b637c461bb2a255e", "committedDate": "2020-05-09T03:13:23Z", "message": "Auto-resolve queries referencing certain functions"}, "afterCommit": {"oid": "1087d8e8c5731df380797475c4364d6bd055f7b0", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/1087d8e8c5731df380797475c4364d6bd055f7b0", "committedDate": "2020-05-09T03:25:55Z", "message": "Auto-resolve queries referencing certain functions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1087d8e8c5731df380797475c4364d6bd055f7b0", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/1087d8e8c5731df380797475c4364d6bd055f7b0", "committedDate": "2020-05-09T03:25:55Z", "message": "Auto-resolve queries referencing certain functions"}, "afterCommit": {"oid": "d9e0c86a192aab2a96fde67e91d1748d838dd6e4", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/d9e0c86a192aab2a96fde67e91d1748d838dd6e4", "committedDate": "2020-05-09T03:40:34Z", "message": "Auto-resolve queries referencing certain functions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d9e0c86a192aab2a96fde67e91d1748d838dd6e4", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/d9e0c86a192aab2a96fde67e91d1748d838dd6e4", "committedDate": "2020-05-09T03:40:34Z", "message": "Auto-resolve queries referencing certain functions"}, "afterCommit": {"oid": "5f7a7e9a219e971228337e6db06e326696648900", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/5f7a7e9a219e971228337e6db06e326696648900", "committedDate": "2020-05-09T03:46:11Z", "message": "Auto-resolve queries referencing certain functions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5f7a7e9a219e971228337e6db06e326696648900", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/5f7a7e9a219e971228337e6db06e326696648900", "committedDate": "2020-05-09T03:46:11Z", "message": "Auto-resolve queries referencing certain functions"}, "afterCommit": {"oid": "efd1834864cb43ef74157fbb4d29cdf8a7b0a885", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/efd1834864cb43ef74157fbb4d29cdf8a7b0a885", "committedDate": "2020-05-09T03:46:35Z", "message": "Auto-resolve queries referencing certain functions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "efd1834864cb43ef74157fbb4d29cdf8a7b0a885", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/efd1834864cb43ef74157fbb4d29cdf8a7b0a885", "committedDate": "2020-05-09T03:46:35Z", "message": "Auto-resolve queries referencing certain functions"}, "afterCommit": {"oid": "f8f082702e8eae45e361d6bb17d830f8eee1374b", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/f8f082702e8eae45e361d6bb17d830f8eee1374b", "committedDate": "2020-05-09T03:47:22Z", "message": "Bind classes as singleton in FailureResolverModule"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f8f082702e8eae45e361d6bb17d830f8eee1374b", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/f8f082702e8eae45e361d6bb17d830f8eee1374b", "committedDate": "2020-05-09T03:47:22Z", "message": "Bind classes as singleton in FailureResolverModule"}, "afterCommit": {"oid": "ae81f3ef862238d60f81f78f3953c857c5f7a43f", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/ae81f3ef862238d60f81f78f3953c857c5f7a43f", "committedDate": "2020-05-09T03:59:29Z", "message": "Bind classes as singleton in FailureResolverModule"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ae81f3ef862238d60f81f78f3953c857c5f7a43f", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/ae81f3ef862238d60f81f78f3953c857c5f7a43f", "committedDate": "2020-05-09T03:59:29Z", "message": "Bind classes as singleton in FailureResolverModule"}, "afterCommit": {"oid": "b385f6ca3e28281660e6ec9a25c53c25fb63a3ca", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/b385f6ca3e28281660e6ec9a25c53c25fb63a3ca", "committedDate": "2020-05-09T04:10:02Z", "message": "Bind classes as singleton in FailureResolverModule"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b385f6ca3e28281660e6ec9a25c53c25fb63a3ca", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/b385f6ca3e28281660e6ec9a25c53c25fb63a3ca", "committedDate": "2020-05-09T04:10:02Z", "message": "Bind classes as singleton in FailureResolverModule"}, "afterCommit": {"oid": "3c035aec3127351bcacebbe50f3eb8121109341b", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/3c035aec3127351bcacebbe50f3eb8121109341b", "committedDate": "2020-05-09T04:16:22Z", "message": "Bind classes as singleton in FailureResolverModule"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3c035aec3127351bcacebbe50f3eb8121109341b", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/3c035aec3127351bcacebbe50f3eb8121109341b", "committedDate": "2020-05-09T04:16:22Z", "message": "Bind classes as singleton in FailureResolverModule"}, "afterCommit": {"oid": "7d559257b4bf6f4a615f0f7e5fd84aebf39ddbb3", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/7d559257b4bf6f4a615f0f7e5fd84aebf39ddbb3", "committedDate": "2020-05-09T04:17:38Z", "message": "Bind classes as singleton in FailureResolverModule"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5ODA1NDg0", "url": "https://github.com/prestodb/presto/pull/14506#pullrequestreview-409805484", "createdAt": "2020-05-12T08:17:49Z", "commit": {"oid": "0d3d585ddafbef517507f8270ccebd7097fa1e57"}, "state": "COMMENTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwODoxNzo0OVrOGT7U7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwOTo0MzowM1rOGT-sJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU0ODE0Mw==", "bodyText": "Is this the checksum of the array cardinalities, or the sum of array cardinalities? If it's the first, can we change it to cardinalityCheckSum? If it's the latter then it doesn't sound enough condition to auto-resolve.", "url": "https://github.com/prestodb/presto/pull/14506#discussion_r423548143", "createdAt": "2020-05-12T08:17:49Z", "author": {"login": "yingsu00"}, "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/checksum/ArrayColumnValidator.java", "diffHunk": "@@ -37,6 +39,57 @@\n public class ArrayColumnValidator\n         implements ColumnValidator\n {\n+    public static class ArrayColumnChecksum\n+            extends ColumnChecksum\n+    {\n+        private final Object checksum;\n+        private final Object cardinalitySum;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d3d585ddafbef517507f8270ccebd7097fa1e57"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU1MTM1NA==", "bodyText": "Just wonder why can't we make this a standalone class? It's used in both ArrayColumnValidator and StructuredColumnMismatchResolver. My understanding is that it's better to make it a nested class if it's only used by the container class. Note that ColumnChecksum is a standalone abstract class.", "url": "https://github.com/prestodb/presto/pull/14506#discussion_r423551354", "createdAt": "2020-05-12T08:22:52Z", "author": {"login": "yingsu00"}, "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/checksum/ArrayColumnValidator.java", "diffHunk": "@@ -37,6 +39,57 @@\n public class ArrayColumnValidator\n         implements ColumnValidator\n {\n+    public static class ArrayColumnChecksum", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d3d585ddafbef517507f8270ccebd7097fa1e57"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU1MTgxNA==", "bodyText": "All methods are abstract. Is it better to make it an Interface?", "url": "https://github.com/prestodb/presto/pull/14506#discussion_r423551814", "createdAt": "2020-05-12T08:23:34Z", "author": {"login": "yingsu00"}, "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/checksum/ColumnChecksum.java", "diffHunk": "@@ -0,0 +1,27 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.verifier.checksum;\n+\n+public abstract class ColumnChecksum", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d3d585ddafbef517507f8270ccebd7097fa1e57"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU4OTA0Mg==", "bodyText": "Should we move this private method to the private method section below?", "url": "https://github.com/prestodb/presto/pull/14506#discussion_r423589042", "createdAt": "2020-05-12T09:20:15Z", "author": {"login": "yingsu00"}, "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/checksum/ArrayColumnValidator.java", "diffHunk": "@@ -53,25 +106,19 @@\n     }\n \n     @Override\n-    public List<ColumnMatchResult> validate(Column column, ChecksumResult controlResult, ChecksumResult testResult)\n+    public List<ColumnMatchResult<ArrayColumnChecksum>> validate(Column column, ChecksumResult controlResult, ChecksumResult testResult)\n+    {\n+        ArrayColumnChecksum controlChecksum = toColumnChecksum(column, controlResult);\n+        ArrayColumnChecksum testChecksum = toColumnChecksum(column, testResult);\n+\n+        return ImmutableList.of(new ColumnMatchResult<>(Objects.equals(controlChecksum, testChecksum), column, controlChecksum, testChecksum));\n+    }\n+\n+    private static ArrayColumnChecksum toColumnChecksum(Column column, ChecksumResult checksumResult)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d3d585ddafbef517507f8270ccebd7097fa1e57"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU5Mzg4NQ==", "bodyText": "Nit: I'd move this to a separate commit, but it's up to you.", "url": "https://github.com/prestodb/presto/pull/14506#discussion_r423593885", "createdAt": "2020-05-12T09:28:08Z", "author": {"login": "yingsu00"}, "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/checksum/ChecksumValidator.java", "diffHunk": "@@ -55,14 +53,11 @@ public Query generateChecksumQuery(QualifiedName tableName, List<Column> columns\n         return simpleQuery(new Select(false, selectItems.build()), new Table(tableName));\n     }\n \n-    public Map<Column, ColumnMatchResult> getMismatchedColumns(List<Column> columns, ChecksumResult controlChecksum, ChecksumResult testChecksum)\n+    public List<ColumnMatchResult<?>> getMismatchedColumns(List<Column> columns, ChecksumResult controlChecksum, ChecksumResult testChecksum)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d3d585ddafbef517507f8270ccebd7097fa1e57"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU5NjA2OA==", "bodyText": "Is cardinality_sum really sum of the cardinalities?", "url": "https://github.com/prestodb/presto/pull/14506#discussion_r423596068", "createdAt": "2020-05-12T09:31:30Z", "author": {"login": "yingsu00"}, "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/checksum/ArrayColumnValidator.java", "diffHunk": "@@ -37,6 +39,57 @@\n public class ArrayColumnValidator\n         implements ColumnValidator\n {\n+    public static class ArrayColumnChecksum\n+            extends ColumnChecksum\n+    {\n+        private final Object checksum;\n+        private final Object cardinalitySum;\n+\n+        public ArrayColumnChecksum(@Nullable Object checksum, @Nullable Object cardinalitySum)\n+        {\n+            this.checksum = checksum;\n+            this.cardinalitySum = cardinalitySum;\n+        }\n+\n+        @Nullable\n+        public Object getChecksum()\n+        {\n+            return checksum;\n+        }\n+\n+        @Nullable\n+        public Object getCardinalitySum()\n+        {\n+            return cardinalitySum;\n+        }\n+\n+        @Override\n+        public boolean equals(Object obj)\n+        {\n+            if (this == obj) {\n+                return true;\n+            }\n+            if ((obj == null) || (getClass() != obj.getClass())) {\n+                return false;\n+            }\n+            ArrayColumnChecksum o = (ArrayColumnChecksum) obj;\n+            return Objects.equals(checksum, o.checksum) &&\n+                    Objects.equals(cardinalitySum, o.cardinalitySum);\n+        }\n+\n+        @Override\n+        public int hashCode()\n+        {\n+            return Objects.hash(checksum, cardinalitySum);\n+        }\n+\n+        @Override\n+        public String toString()\n+        {\n+            return format(\"checksum: %s, cardinality_sum: %s\", checksum, cardinalitySum);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d3d585ddafbef517507f8270ccebd7097fa1e57"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU5ODkzOQ==", "bodyText": "cardinality checksum?", "url": "https://github.com/prestodb/presto/pull/14506#discussion_r423598939", "createdAt": "2020-05-12T09:36:00Z", "author": {"login": "yingsu00"}, "path": "presto-docs/src/main/sphinx/admin/verifier.rst", "diffHunk": "@@ -168,6 +168,17 @@ query failures.\n * ``COMPILER_ERROR``: Resolves if checksum fails with this error. If a control query has too many\n   columns, generated checksum query might be too large in certain cases.\n \n+In cases of result mismatches, Verifier may be giving noisy signals, and we allow Verifier to\n+automatically resolve certain mismatches.\n+\n+* **Structured-typed Columns**: If array element or map key/value contains floating point types, column checksum is unlikely to match.\n+    * For an array column, resolve if the element type contains floating point types and the\n+      cardinality matches.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c578d8aaeb3a7209983c7b6a82c7fcbf1b7d95ba"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYwMzIzOQ==", "bodyText": "I feel this is a bit hard to understand. Can we say\nFor a map column, resolve the mismatch when both of the following conditions are true:\n - The cardinality checksum matches;\n - The checksum of the key or value that does not contains floating point type matches.", "url": "https://github.com/prestodb/presto/pull/14506#discussion_r423603239", "createdAt": "2020-05-12T09:43:03Z", "author": {"login": "yingsu00"}, "path": "presto-docs/src/main/sphinx/admin/verifier.rst", "diffHunk": "@@ -168,6 +168,17 @@ query failures.\n * ``COMPILER_ERROR``: Resolves if checksum fails with this error. If a control query has too many\n   columns, generated checksum query might be too large in certain cases.\n \n+In cases of result mismatches, Verifier may be giving noisy signals, and we allow Verifier to\n+automatically resolve certain mismatches.\n+\n+* **Structured-typed Columns**: If array element or map key/value contains floating point types, column checksum is unlikely to match.\n+    * For an array column, resolve if the element type contains floating point types and the\n+      cardinality matches.\n+    * For a map column, resolve if either key or value contains floating point types, the\n+      cardinality sum matches, and the checksum of the key or value that does not contains\n+      floating point type matches.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c578d8aaeb3a7209983c7b6a82c7fcbf1b7d95ba"}, "originalPosition": 12}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7d559257b4bf6f4a615f0f7e5fd84aebf39ddbb3", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/7d559257b4bf6f4a615f0f7e5fd84aebf39ddbb3", "committedDate": "2020-05-09T04:17:38Z", "message": "Bind classes as singleton in FailureResolverModule"}, "afterCommit": {"oid": "ef2527d0db149986b6bef7be9d893cdf5ae8f92c", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/ef2527d0db149986b6bef7be9d893cdf5ae8f92c", "committedDate": "2020-05-12T19:41:43Z", "message": "Bind classes as singleton in FailureResolverModule"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ef2527d0db149986b6bef7be9d893cdf5ae8f92c", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/ef2527d0db149986b6bef7be9d893cdf5ae8f92c", "committedDate": "2020-05-12T19:41:43Z", "message": "Bind classes as singleton in FailureResolverModule"}, "afterCommit": {"oid": "4da61b49f1551be4fe77f3cb50be4f282f024f1b", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/4da61b49f1551be4fe77f3cb50be4f282f024f1b", "committedDate": "2020-05-14T19:11:48Z", "message": "Bind classes as singleton in FailureResolverModule"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4da61b49f1551be4fe77f3cb50be4f282f024f1b", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/4da61b49f1551be4fe77f3cb50be4f282f024f1b", "committedDate": "2020-05-14T19:11:48Z", "message": "Bind classes as singleton in FailureResolverModule"}, "afterCommit": {"oid": "120d799bc95c2f09784e5b98aa5dcb45132bc0aa", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/120d799bc95c2f09784e5b98aa5dcb45132bc0aa", "committedDate": "2020-05-14T19:41:30Z", "message": "Bind classes as singleton in FailureResolverModule"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "120d799bc95c2f09784e5b98aa5dcb45132bc0aa", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/120d799bc95c2f09784e5b98aa5dcb45132bc0aa", "committedDate": "2020-05-14T19:41:30Z", "message": "Bind classes as singleton in FailureResolverModule"}, "afterCommit": {"oid": "118f043eb343cd229298e1bbcef9e72b8ebefe93", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/118f043eb343cd229298e1bbcef9e72b8ebefe93", "committedDate": "2020-05-14T19:42:10Z", "message": "Bind classes as singleton in FailureResolverModule"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb2c504f495a02daa627167fb70f2359d3f341d0", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/cb2c504f495a02daa627167fb70f2359d3f341d0", "committedDate": "2020-05-14T20:12:16Z", "message": "Remove unused class in VerifierLimitationFailureResolver"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "118f043eb343cd229298e1bbcef9e72b8ebefe93", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/118f043eb343cd229298e1bbcef9e72b8ebefe93", "committedDate": "2020-05-14T19:42:10Z", "message": "Bind classes as singleton in FailureResolverModule"}, "afterCommit": {"oid": "ba676cd5f4231b8edcf265e7a5a06395ca40b024", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/ba676cd5f4231b8edcf265e7a5a06395ca40b024", "committedDate": "2020-05-14T20:12:16Z", "message": "Bind classes as singleton in FailureResolverModule"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ba676cd5f4231b8edcf265e7a5a06395ca40b024", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/ba676cd5f4231b8edcf265e7a5a06395ca40b024", "committedDate": "2020-05-14T20:12:16Z", "message": "Bind classes as singleton in FailureResolverModule"}, "afterCommit": {"oid": "cc06bc49df5703d4aa694b6438498370547884ae", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/cc06bc49df5703d4aa694b6438498370547884ae", "committedDate": "2020-05-14T22:11:01Z", "message": "Bind classes as singleton in FailureResolverModule"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cc06bc49df5703d4aa694b6438498370547884ae", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/cc06bc49df5703d4aa694b6438498370547884ae", "committedDate": "2020-05-14T22:11:01Z", "message": "Bind classes as singleton in FailureResolverModule"}, "afterCommit": {"oid": "7abb31fdc08745a800e3e2996420a537ff634277", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/7abb31fdc08745a800e3e2996420a537ff634277", "committedDate": "2020-05-14T22:13:24Z", "message": "Bind classes as singleton in FailureResolverModule"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7abb31fdc08745a800e3e2996420a537ff634277", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/7abb31fdc08745a800e3e2996420a537ff634277", "committedDate": "2020-05-14T22:13:24Z", "message": "Bind classes as singleton in FailureResolverModule"}, "afterCommit": {"oid": "ffa81b6c49d8090dd3e963956a87a1e5a3700765", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/ffa81b6c49d8090dd3e963956a87a1e5a3700765", "committedDate": "2020-05-14T22:17:53Z", "message": "Bind classes as singleton in FailureResolverModule"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ffa81b6c49d8090dd3e963956a87a1e5a3700765", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/ffa81b6c49d8090dd3e963956a87a1e5a3700765", "committedDate": "2020-05-14T22:17:53Z", "message": "Bind classes as singleton in FailureResolverModule"}, "afterCommit": {"oid": "c78ee487b2e7ad14065c78d3af49091823923318", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/c78ee487b2e7ad14065c78d3af49091823923318", "committedDate": "2020-05-14T22:35:06Z", "message": "Bind classes as singleton in FailureResolverModule"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c78ee487b2e7ad14065c78d3af49091823923318", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/c78ee487b2e7ad14065c78d3af49091823923318", "committedDate": "2020-05-14T22:35:06Z", "message": "Bind classes as singleton in FailureResolverModule"}, "afterCommit": {"oid": "e0c62e36577c3e9ab8bb2e2bc9051e196fa430d5", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/e0c62e36577c3e9ab8bb2e2bc9051e196fa430d5", "committedDate": "2020-05-14T23:07:18Z", "message": "Bind classes as singleton in FailureResolverModule"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e0c62e36577c3e9ab8bb2e2bc9051e196fa430d5", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/e0c62e36577c3e9ab8bb2e2bc9051e196fa430d5", "committedDate": "2020-05-14T23:07:18Z", "message": "Bind classes as singleton in FailureResolverModule"}, "afterCommit": {"oid": "6103fca16165d52d8f206a0e7dad649b069a8179", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/6103fca16165d52d8f206a0e7dad649b069a8179", "committedDate": "2020-05-14T23:08:41Z", "message": "Bind classes as singleton in FailureResolverModule"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyMzYwNjQ3", "url": "https://github.com/prestodb/presto/pull/14506#pullrequestreview-412360647", "createdAt": "2020-05-15T05:41:31Z", "commit": {"oid": "79254abfc649009379d7e5e1a748fe54b13b979f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwNTo0MTozMVrOGV3LUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwNTo0MTozMVrOGV3LUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTU3NzI5Nw==", "bodyText": "Under what circumstance can cardinalityChecksum and cardinalitySum be null?", "url": "https://github.com/prestodb/presto/pull/14506#discussion_r425577297", "createdAt": "2020-05-15T05:41:31Z", "author": {"login": "yingsu00"}, "path": "presto-verifier/src/main/java/com/facebook/presto/verifier/checksum/ArrayColumnChecksum.java", "diffHunk": "@@ -23,11 +23,13 @@\n         extends StructureColumnChecksum\n {\n     private final Object checksum;\n+    private final Object cardinalityChecksum;\n     private final Object cardinalitySum;\n \n-    public ArrayColumnChecksum(@Nullable Object checksum, @Nullable Object cardinalitySum)\n+    public ArrayColumnChecksum(@Nullable Object checksum, @Nullable Object cardinalityChecksum, @Nullable Object cardinalitySum)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "79254abfc649009379d7e5e1a748fe54b13b979f"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c481036fb85f32fb7ff4c9fc0762f5df6389946", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/7c481036fb85f32fb7ff4c9fc0762f5df6389946", "committedDate": "2020-05-15T19:53:41Z", "message": "Return checksum objects in column validator\n\nColumnMatchResult contains only a String message. It contains\ntext description about the discrepancy between control and test\ncolumn checksum.\n\nInstead, returns Java object ColumnChecksum object so that they\ncan be programmatically accessed in Verifier."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f41b2340567678ee3286ed09007e948741b124e", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/6f41b2340567678ee3286ed09007e948741b124e", "committedDate": "2020-05-15T19:53:42Z", "message": "Convert MatchResult.mismatchedColumns to a list"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a83a5f2efb95940436828733a33f58ea913d064", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/5a83a5f2efb95940436828733a33f58ea913d064", "committedDate": "2020-05-15T19:56:46Z", "message": "Compute cardinality checksum for array and map columns"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44f43ca0a557892ae1da09fb9eaa3f27a1bca11d", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/44f43ca0a557892ae1da09fb9eaa3f27a1bca11d", "committedDate": "2020-05-15T19:56:46Z", "message": "Auto-resolve mismatched structured-type columns\n\nIf array element or map key/value contains floating point types, column\nchecksum is unlikely to match.\n* For an array column, resolve if the element type contains floating\n  point types and the cardinality checksum matches.\n* For a map column, resolve the mismatch when both of the following\n  conditions are true:\n  * The cardinality checksum matches.\n  * The checksum of the key or value that does not contains floating\n    point types matches.\n* Resolve a test case only when all columns are resolved."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6103fca16165d52d8f206a0e7dad649b069a8179", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/6103fca16165d52d8f206a0e7dad649b069a8179", "committedDate": "2020-05-14T23:08:41Z", "message": "Bind classes as singleton in FailureResolverModule"}, "afterCommit": {"oid": "bec7a3e09cb7343bb4d7e3605a819172bd53b63f", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/bec7a3e09cb7343bb4d7e3605a819172bd53b63f", "committedDate": "2020-05-15T19:56:46Z", "message": "Bind classes as singleton in FailureResolverModule"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ce6f9b27eabc8e55777e1a9ef7b710a37f5e9d2", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/9ce6f9b27eabc8e55777e1a9ef7b710a37f5e9d2", "committedDate": "2020-05-15T20:12:44Z", "message": "Auto-resolve queries referencing certain functions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8595774e344c50e915f42ca586c75d380be67fca", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/8595774e344c50e915f42ca586c75d380be67fca", "committedDate": "2020-05-15T20:12:52Z", "message": "Bind classes as singleton in FailureResolverModule"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bec7a3e09cb7343bb4d7e3605a819172bd53b63f", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/bec7a3e09cb7343bb4d7e3605a819172bd53b63f", "committedDate": "2020-05-15T19:56:46Z", "message": "Bind classes as singleton in FailureResolverModule"}, "afterCommit": {"oid": "8595774e344c50e915f42ca586c75d380be67fca", "author": {"user": {"login": "caithagoras", "name": "Leiqing Cai"}}, "url": "https://github.com/prestodb/presto/commit/8595774e344c50e915f42ca586c75d380be67fca", "committedDate": "2020-05-15T20:12:52Z", "message": "Bind classes as singleton in FailureResolverModule"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzODI1MjUw", "url": "https://github.com/prestodb/presto/pull/14506#pullrequestreview-413825250", "createdAt": "2020-05-18T18:09:24Z", "commit": {"oid": "8595774e344c50e915f42ca586c75d380be67fca"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzODk2MTgy", "url": "https://github.com/prestodb/presto/pull/14506#pullrequestreview-413896182", "createdAt": "2020-05-18T19:54:50Z", "commit": {"oid": "8595774e344c50e915f42ca586c75d380be67fca"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1612, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}