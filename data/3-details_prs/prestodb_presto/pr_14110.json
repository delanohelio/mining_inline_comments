{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc2NDI4MTU3", "number": 14110, "title": "Cache PlanFragment serialization", "bodyText": "== NO RELEASE NOTE ==", "createdAt": "2020-02-18T05:43:18Z", "url": "https://github.com/prestodb/presto/pull/14110", "merged": true, "mergeCommit": {"oid": "5f7e1871b9bc45e5570d4ccc3c11ea3e1f600d7a"}, "closed": true, "closedAt": "2020-02-26T22:20:37Z", "author": {"login": "tdcmeehan"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcFbhIsABqjMwNDU3ODkxNTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcH7EqxgBqjMwNzE1MTg0NzQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5e8294a5053bd5035b426455dd037cdc4e765976", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/5e8294a5053bd5035b426455dd037cdc4e765976", "committedDate": "2020-02-18T05:42:39Z", "message": "Cache PlanFragment serialization"}, "afterCommit": {"oid": "a3cc50fe7fe3f196c9a602f312c903c474c1c5c3", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/a3cc50fe7fe3f196c9a602f312c903c474c1c5c3", "committedDate": "2020-02-18T05:59:08Z", "message": "Cache PlanFragment serialization"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a3cc50fe7fe3f196c9a602f312c903c474c1c5c3", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/a3cc50fe7fe3f196c9a602f312c903c474c1c5c3", "committedDate": "2020-02-18T05:59:08Z", "message": "Cache PlanFragment serialization"}, "afterCommit": {"oid": "79057d5c6400616df1f7e04683453f235ef13ca4", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/79057d5c6400616df1f7e04683453f235ef13ca4", "committedDate": "2020-02-18T06:43:22Z", "message": "Cache PlanFragment serialization"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "79057d5c6400616df1f7e04683453f235ef13ca4", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/79057d5c6400616df1f7e04683453f235ef13ca4", "committedDate": "2020-02-18T06:43:22Z", "message": "Cache PlanFragment serialization"}, "afterCommit": {"oid": "f972fb7ed37f9aa586f416469c3902d068230fd5", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/f972fb7ed37f9aa586f416469c3902d068230fd5", "committedDate": "2020-02-18T21:48:23Z", "message": "Cache PlanFragment serialization"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f972fb7ed37f9aa586f416469c3902d068230fd5", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/f972fb7ed37f9aa586f416469c3902d068230fd5", "committedDate": "2020-02-18T21:48:23Z", "message": "Cache PlanFragment serialization"}, "afterCommit": {"oid": "1f294eaae4a2003a23a370ebe5c6d2d3cb9a21f2", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/1f294eaae4a2003a23a370ebe5c6d2d3cb9a21f2", "committedDate": "2020-02-18T23:16:49Z", "message": "Cache PlanFragment serialization"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxNDgzNTIw", "url": "https://github.com/prestodb/presto/pull/14110#pullrequestreview-361483520", "createdAt": "2020-02-19T22:24:07Z", "commit": {"oid": "1f294eaae4a2003a23a370ebe5c6d2d3cb9a21f2"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQyMjoyNDowN1rOFr54Ew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQyMjoyNjo1NlrOFr585g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTU4MTMzMQ==", "bodyText": "nit: maybe add a short comment (so only serialize once \ud83d\ude03 )", "url": "https://github.com/prestodb/presto/pull/14110#discussion_r381581331", "createdAt": "2020-02-19T22:24:07Z", "author": {"login": "wenleix"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/PlanFragment.java", "diffHunk": "@@ -54,6 +53,8 @@\n     private final StatsAndCosts statsAndCosts;\n     private final Optional<String> jsonRepresentation;\n \n+    private SerializedString cachedSerialization;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f294eaae4a2003a23a370ebe5c6d2d3cb9a21f2"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTU4MTU1Mw==", "bodyText": "benign data race ? \ud83d\ude03\nThe only question is if all the serialization request comes at similar time, would this cause we still serialize for every task?", "url": "https://github.com/prestodb/presto/pull/14110#discussion_r381581553", "createdAt": "2020-02-19T22:24:39Z", "author": {"login": "wenleix"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/PlanFragment.java", "diffHunk": "@@ -153,6 +154,16 @@ public StatsAndCosts getStatsAndCosts()\n         return jsonRepresentation;\n     }\n \n+    // Serialize this plan fragment with the provided codec, caching the results\n+    public SerializedString toBytes(Codec<PlanFragment> codec)\n+    {\n+        requireNonNull(codec, \"codec is null\");\n+        if (cachedSerialization == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f294eaae4a2003a23a370ebe5c6d2d3cb9a21f2"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTU4MjU2Ng==", "bodyText": "Add a comment this is only required on coordinator side when serializing PlanFragment, not provided on worker :)", "url": "https://github.com/prestodb/presto/pull/14110#discussion_r381582566", "createdAt": "2020-02-19T22:26:56Z", "author": {"login": "wenleix"}, "path": "presto-main/src/main/java/com/facebook/presto/server/TaskUpdateRequest.java", "diffHunk": "@@ -38,6 +43,7 @@\n     private final List<TaskSource> sources;\n     private final OutputBuffers outputIds;\n     private final Optional<TableWriteInfo> tableWriteInfo;\n+    private final Optional<Codec<PlanFragment>> fragmentCodec;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f294eaae4a2003a23a370ebe5c6d2d3cb9a21f2"}, "originalPosition": 25}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1f294eaae4a2003a23a370ebe5c6d2d3cb9a21f2", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/1f294eaae4a2003a23a370ebe5c6d2d3cb9a21f2", "committedDate": "2020-02-18T23:16:49Z", "message": "Cache PlanFragment serialization"}, "afterCommit": {"oid": "bd3d7302743053010f03f331cd9edd889ec8c09d", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/bd3d7302743053010f03f331cd9edd889ec8c09d", "committedDate": "2020-02-20T00:24:53Z", "message": "Cache PlanFragment serialization"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bd3d7302743053010f03f331cd9edd889ec8c09d", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/bd3d7302743053010f03f331cd9edd889ec8c09d", "committedDate": "2020-02-20T00:24:53Z", "message": "Cache PlanFragment serialization"}, "afterCommit": {"oid": "6b5757b8ed4fb19aee6c257aec17a21cd16c068f", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/6b5757b8ed4fb19aee6c257aec17a21cd16c068f", "committedDate": "2020-02-20T00:25:34Z", "message": "Cache PlanFragment serialization"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6b5757b8ed4fb19aee6c257aec17a21cd16c068f", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/6b5757b8ed4fb19aee6c257aec17a21cd16c068f", "committedDate": "2020-02-20T00:25:34Z", "message": "Cache PlanFragment serialization"}, "afterCommit": {"oid": "e70403ed7c21ca5e8206208db1b056d2f3137fca", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/e70403ed7c21ca5e8206208db1b056d2f3137fca", "committedDate": "2020-02-20T00:29:35Z", "message": "Cache PlanFragment serialization"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e70403ed7c21ca5e8206208db1b056d2f3137fca", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/e70403ed7c21ca5e8206208db1b056d2f3137fca", "committedDate": "2020-02-20T00:29:35Z", "message": "Cache PlanFragment serialization"}, "afterCommit": {"oid": "726b8c7a44c30ccbdbff34841611e2db1b2f82f7", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/726b8c7a44c30ccbdbff34841611e2db1b2f82f7", "committedDate": "2020-02-24T07:25:43Z", "message": "Cache PlanFragment serialization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6362af32fe4a3eee06782a19857220a540f6ef5e", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/6362af32fe4a3eee06782a19857220a540f6ef5e", "committedDate": "2020-02-24T19:53:18Z", "message": "Add fromBytes to Codec"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "726b8c7a44c30ccbdbff34841611e2db1b2f82f7", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/726b8c7a44c30ccbdbff34841611e2db1b2f82f7", "committedDate": "2020-02-24T07:25:43Z", "message": "Cache PlanFragment serialization"}, "afterCommit": {"oid": "2ec16ecb0208e8bac5cfcaf26703db7d3dcabc96", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/2ec16ecb0208e8bac5cfcaf26703db7d3dcabc96", "committedDate": "2020-02-24T19:53:19Z", "message": "Cache PlanFragment serialization"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzNzQ4OTA1", "url": "https://github.com/prestodb/presto/pull/14110#pullrequestreview-363748905", "createdAt": "2020-02-24T22:31:12Z", "commit": {"oid": "2ec16ecb0208e8bac5cfcaf26703db7d3dcabc96"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQyMjozMToxMlrOFtyRiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQyMjozMToxMlrOFtyRiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU1MzkyOA==", "bodyText": "nit: after going through the code, it is clear the Codec should not change during the lifecycle of a JVM. Lets just add a comment that clarifies this here. Because technically if someone passes a different codec in the second call, we will be returning the incorrect result. Better if we can add some variant for the same.", "url": "https://github.com/prestodb/presto/pull/14110#discussion_r383553928", "createdAt": "2020-02-24T22:31:12Z", "author": {"login": "mayankgarg1990"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/PlanFragment.java", "diffHunk": "@@ -153,6 +157,16 @@ public StatsAndCosts getStatsAndCosts()\n         return jsonRepresentation;\n     }\n \n+    // Serialize this plan fragment with the provided codec, caching the results\n+    public synchronized byte[] toBytes(Codec<PlanFragment> codec)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ec16ecb0208e8bac5cfcaf26703db7d3dcabc96"}, "originalPosition": 41}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2ec16ecb0208e8bac5cfcaf26703db7d3dcabc96", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/2ec16ecb0208e8bac5cfcaf26703db7d3dcabc96", "committedDate": "2020-02-24T19:53:19Z", "message": "Cache PlanFragment serialization"}, "afterCommit": {"oid": "e6104a27ea0c7af561f881d23c893e940e16b25f", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/e6104a27ea0c7af561f881d23c893e940e16b25f", "committedDate": "2020-02-24T22:56:29Z", "message": "Cache PlanFragment serialization"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzODg5MDg4", "url": "https://github.com/prestodb/presto/pull/14110#pullrequestreview-363889088", "createdAt": "2020-02-25T06:06:10Z", "commit": {"oid": "e6104a27ea0c7af561f881d23c893e940e16b25f"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQwNjowNjoxMFrOFt5pmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQwNjowNjo0NFrOFt5qKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzY3NDc3OA==", "bodyText": "This constructor is only used in HttpRemoteTask  right? Should we just inline it?", "url": "https://github.com/prestodb/presto/pull/14110#discussion_r383674778", "createdAt": "2020-02-25T06:06:10Z", "author": {"login": "wenleix"}, "path": "presto-main/src/main/java/com/facebook/presto/server/TaskUpdateRequest.java", "diffHunk": "@@ -63,6 +66,24 @@ public TaskUpdateRequest(\n         this.tableWriteInfo = tableWriteInfo;\n     }\n \n+    public TaskUpdateRequest(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6104a27ea0c7af561f881d23c893e940e16b25f"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzY3NDkyMg==", "bodyText": "How can this be non-absent? -- the later TaskUpdateRequest won't have plan fragment right? -- Am I missing anything? ;)", "url": "https://github.com/prestodb/presto/pull/14110#discussion_r383674922", "createdAt": "2020-02-25T06:06:44Z", "author": {"login": "wenleix"}, "path": "presto-main/src/main/java/com/facebook/presto/server/TaskUpdateRequest.java", "diffHunk": "@@ -75,8 +96,9 @@ public SessionRepresentation getSession()\n         return extraCredentials;\n     }\n \n+    @JsonInclude(NON_ABSENT)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6104a27ea0c7af561f881d23c893e940e16b25f"}, "originalPosition": 66}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e6104a27ea0c7af561f881d23c893e940e16b25f", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/e6104a27ea0c7af561f881d23c893e940e16b25f", "committedDate": "2020-02-24T22:56:29Z", "message": "Cache PlanFragment serialization"}, "afterCommit": {"oid": "530bc6f3f3680ac5d3bcc2c1da4c8d13d44a07b6", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/530bc6f3f3680ac5d3bcc2c1da4c8d13d44a07b6", "committedDate": "2020-02-25T23:51:31Z", "message": "Cache PlanFragment serialization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5dc71e0f1db4579a88fff8b7a1577b4b092fea34", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/5dc71e0f1db4579a88fff8b7a1577b4b092fea34", "committedDate": "2020-02-25T23:52:55Z", "message": "Cache PlanFragment serialization"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "530bc6f3f3680ac5d3bcc2c1da4c8d13d44a07b6", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/530bc6f3f3680ac5d3bcc2c1da4c8d13d44a07b6", "committedDate": "2020-02-25T23:51:31Z", "message": "Cache PlanFragment serialization"}, "afterCommit": {"oid": "5dc71e0f1db4579a88fff8b7a1577b4b092fea34", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/5dc71e0f1db4579a88fff8b7a1577b4b092fea34", "committedDate": "2020-02-25T23:52:55Z", "message": "Cache PlanFragment serialization"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2228, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}