{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk2Njg2ODY5", "number": 14320, "title": "Add max buffer count config property for optimized repartitioning", "bodyText": "== RELEASE NOTES ==\n\nGeneral Changes\n* Add config property driver.max-page-partitioning-buffer-count, to limit the total number of buffers per optimized repartitioning operator. The default value is 1,000,000.", "createdAt": "2020-04-01T00:08:30Z", "url": "https://github.com/prestodb/presto/pull/14320", "merged": true, "mergeCommit": {"oid": "726e18ae85e583b8493c39f97761e9f2976e2298"}, "closed": true, "closedAt": "2020-04-07T21:30:30Z", "author": {"login": "yingsu00"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcTMTNQgFqTM4NTE4NzE2MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcVM0A9ABqjMyMDgyOTU1MjU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1MTg3MTYx", "url": "https://github.com/prestodb/presto/pull/14320#pullrequestreview-385187161", "createdAt": "2020-04-01T00:10:25Z", "commit": {"oid": "8fb84b36778346ef577752f3cd6a856763e08d8f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwMDoxMDoyNVrOF-sgeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwMDoxMDoyNVrOF-sgeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI4NTI0MA==", "bodyText": "This number is highly dependent on the environment and won't work for all setups. Let's make this limit configurable.", "url": "https://github.com/prestodb/presto/pull/14320#discussion_r401285240", "createdAt": "2020-04-01T00:10:25Z", "author": {"login": "mbasmanova"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/repartition/OptimizedPartitionedOutputOperator.java", "diffHunk": "@@ -367,7 +367,8 @@ public OperatorFactory duplicate()\n         private final Closer blockLeaseCloser = Closer.create();\n \n         // The ArrayAllocator for the buffers used in repartitioning, e.g. PartitionBuffer#serializedRowSizes, BlockEncodingBuffer#mappedPositions.\n-        private final ArrayAllocator bufferAllocator = new SimpleArrayAllocator(10_000);\n+        // Assuming there are 1000 columns, and each of them uses 3 buffers, and the number of partitions is 333, then we need 1000 * 3 * 333 about 1M buffers.\n+        private final ArrayAllocator bufferAllocator = new SimpleArrayAllocator(1_000_000);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8fb84b36778346ef577752f3cd6a856763e08d8f"}, "originalPosition": 6}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8fb84b36778346ef577752f3cd6a856763e08d8f", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/8fb84b36778346ef577752f3cd6a856763e08d8f", "committedDate": "2020-04-01T00:07:49Z", "message": "Increase maxOutstandingArrays limit for bufferAllocator"}, "afterCommit": {"oid": "ead72224559f0395f4dcc0a655ca012cacd7c290", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/ead72224559f0395f4dcc0a655ca012cacd7c290", "committedDate": "2020-04-01T01:38:17Z", "message": "Add max buffer count config property for optimized repartitioning"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2NDc0NjQ1", "url": "https://github.com/prestodb/presto/pull/14320#pullrequestreview-386474645", "createdAt": "2020-04-02T14:20:54Z", "commit": {"oid": "ead72224559f0395f4dcc0a655ca012cacd7c290"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxNDoyMDo1NFrOF_tkTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxNDoyMjoyMFrOF_torA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM1MTE4MQ==", "bodyText": "Integer -> int", "url": "https://github.com/prestodb/presto/pull/14320#discussion_r402351181", "createdAt": "2020-04-02T14:20:54Z", "author": {"login": "mbasmanova"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/TaskManagerConfig.java", "diffHunk": "@@ -60,6 +60,7 @@\n \n     private DataSize sinkMaxBufferSize = new DataSize(32, Unit.MEGABYTE);\n     private DataSize maxPagePartitioningBufferSize = new DataSize(32, Unit.MEGABYTE);\n+    private Integer maxPagePartitioningBufferCount = 1_000_000;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ead72224559f0395f4dcc0a655ca012cacd7c290"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM1MTMzNw==", "bodyText": "remove @NotNull\nInteger -> int", "url": "https://github.com/prestodb/presto/pull/14320#discussion_r402351337", "createdAt": "2020-04-02T14:21:05Z", "author": {"login": "mbasmanova"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/TaskManagerConfig.java", "diffHunk": "@@ -384,6 +385,19 @@ public TaskManagerConfig setMaxPagePartitioningBufferSize(DataSize size)\n         return this;\n     }\n \n+    @NotNull\n+    public Integer getMaxPagePartitioningBufferCount()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ead72224559f0395f4dcc0a655ca012cacd7c290"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM1MTQzMQ==", "bodyText": "Integer -> int", "url": "https://github.com/prestodb/presto/pull/14320#discussion_r402351431", "createdAt": "2020-04-02T14:21:14Z", "author": {"login": "mbasmanova"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/TaskManagerConfig.java", "diffHunk": "@@ -384,6 +385,19 @@ public TaskManagerConfig setMaxPagePartitioningBufferSize(DataSize size)\n         return this;\n     }\n \n+    @NotNull\n+    public Integer getMaxPagePartitioningBufferCount()\n+    {\n+        return maxPagePartitioningBufferCount;\n+    }\n+\n+    @Config(\"driver.max-page-partitioning-buffer-count\")\n+    public TaskManagerConfig setMaxPagePartitioningBufferCount(Integer bufferCount)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ead72224559f0395f4dcc0a655ca012cacd7c290"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM1MjE2OA==", "bodyText": "Add @ConfigDescription", "url": "https://github.com/prestodb/presto/pull/14320#discussion_r402352168", "createdAt": "2020-04-02T14:22:09Z", "author": {"login": "mbasmanova"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/TaskManagerConfig.java", "diffHunk": "@@ -384,6 +385,19 @@ public TaskManagerConfig setMaxPagePartitioningBufferSize(DataSize size)\n         return this;\n     }\n \n+    @NotNull\n+    public Integer getMaxPagePartitioningBufferCount()\n+    {\n+        return maxPagePartitioningBufferCount;\n+    }\n+\n+    @Config(\"driver.max-page-partitioning-buffer-count\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ead72224559f0395f4dcc0a655ca012cacd7c290"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM1MjMwMA==", "bodyText": "Integer -> int", "url": "https://github.com/prestodb/presto/pull/14320#discussion_r402352300", "createdAt": "2020-04-02T14:22:20Z", "author": {"login": "mbasmanova"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/LocalExecutionPlanner.java", "diffHunk": "@@ -310,6 +310,7 @@\n     private final IndexJoinLookupStats indexJoinLookupStats;\n     private final DataSize maxPartialAggregationMemorySize;\n     private final DataSize maxPagePartitioningBufferSize;\n+    private final Integer maxPagePartitioningBufferCount;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ead72224559f0395f4dcc0a655ca012cacd7c290"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ead72224559f0395f4dcc0a655ca012cacd7c290", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/ead72224559f0395f4dcc0a655ca012cacd7c290", "committedDate": "2020-04-01T01:38:17Z", "message": "Add max buffer count config property for optimized repartitioning"}, "afterCommit": {"oid": "3777150419fd48c2402a996f34bf5c32e5cc56ac", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/3777150419fd48c2402a996f34bf5c32e5cc56ac", "committedDate": "2020-04-02T23:53:03Z", "message": "Add max buffer count config property for optimized repartitioning"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2OTQ0MzQ5", "url": "https://github.com/prestodb/presto/pull/14320#pullrequestreview-386944349", "createdAt": "2020-04-03T05:24:57Z", "commit": {"oid": "3777150419fd48c2402a996f34bf5c32e5cc56ac"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3OTE2NDM0", "url": "https://github.com/prestodb/presto/pull/14320#pullrequestreview-387916434", "createdAt": "2020-04-06T03:38:20Z", "commit": {"oid": "3777150419fd48c2402a996f34bf5c32e5cc56ac"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQwMzozODoyMVrOGBG05g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQwMzozODoyMVrOGBG05g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzgxMzYwNg==", "bodyText": "@Min(1)", "url": "https://github.com/prestodb/presto/pull/14320#discussion_r403813606", "createdAt": "2020-04-06T03:38:21Z", "author": {"login": "tdcmeehan"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/TaskManagerConfig.java", "diffHunk": "@@ -384,6 +385,19 @@ public TaskManagerConfig setMaxPagePartitioningBufferSize(DataSize size)\n         return this;\n     }\n \n+    public int getMaxPagePartitioningBufferCount()\n+    {\n+        return maxPagePartitioningBufferCount;\n+    }\n+\n+    @Config(\"driver.max-page-partitioning-buffer-count\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3777150419fd48c2402a996f34bf5c32e5cc56ac"}, "originalPosition": 17}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3777150419fd48c2402a996f34bf5c32e5cc56ac", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/3777150419fd48c2402a996f34bf5c32e5cc56ac", "committedDate": "2020-04-02T23:53:03Z", "message": "Add max buffer count config property for optimized repartitioning"}, "afterCommit": {"oid": "c1b01159f6dfc4ff15d7e2e6988d4619230d325d", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/c1b01159f6dfc4ff15d7e2e6988d4619230d325d", "committedDate": "2020-04-06T04:56:13Z", "message": "Add max buffer count config property for optimized repartitioning"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "21048465c750025d37b26566ba34d63b2ba57823", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/21048465c750025d37b26566ba34d63b2ba57823", "committedDate": "2020-04-07T05:53:31Z", "message": "Add max buffer count config property for optimized repartitioning"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c1b01159f6dfc4ff15d7e2e6988d4619230d325d", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/c1b01159f6dfc4ff15d7e2e6988d4619230d325d", "committedDate": "2020-04-06T04:56:13Z", "message": "Add max buffer count config property for optimized repartitioning"}, "afterCommit": {"oid": "21048465c750025d37b26566ba34d63b2ba57823", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/21048465c750025d37b26566ba34d63b2ba57823", "committedDate": "2020-04-07T05:53:31Z", "message": "Add max buffer count config property for optimized repartitioning"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2143, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}