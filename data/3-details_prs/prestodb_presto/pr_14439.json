{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA5MDAxMzcz", "number": 14439, "title": "Pre-calculate nested positions array size in BlockEncodingBuffer", "bodyText": "Resolves #14433\nThe positions array for nested BlockEncodingBuffer used to be grown on\nthe fly. This uses extra CPU and makes the positions array larger than\nrequired because the growth factor was 2.0. This commit pre-calculates\nthe nested positions array size, allocate the memory in one shot, then\npopulate the positions.\n== NO RELEASE NOTE ==", "createdAt": "2020-04-26T02:08:21Z", "url": "https://github.com/prestodb/presto/pull/14439", "merged": true, "mergeCommit": {"oid": "b13f60bd4d27395d059756dce944b86b6b419694"}, "closed": true, "closedAt": "2020-05-01T14:13:01Z", "author": {"login": "yingsu00"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcbxrTWgFqTQwMTExMDI2MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcc2bDVgBqjMyOTE4MjYwMTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxMTEwMjYw", "url": "https://github.com/prestodb/presto/pull/14439#pullrequestreview-401110260", "createdAt": "2020-04-27T16:14:41Z", "commit": {"oid": "3a8b6053f3d9d15965b28367d8a6236e47448a6b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxNjoxNDo0MVrOGMrsVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxNjoxNDo0MVrOGMrsVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTk1MTk1Ng==", "bodyText": "@yingsu00 perhaps, a cleaner design would be valuesBuffers.ensureCapacity(offsets[positionCount])", "url": "https://github.com/prestodb/presto/pull/14439#discussion_r415951956", "createdAt": "2020-04-27T16:14:41Z", "author": {"login": "mbasmanova"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/repartition/ArrayBlockEncodingBuffer.java", "diffHunk": "@@ -259,17 +259,13 @@ private void populateNestedPositions(ColumnarArray columnarArray)\n         int[] positions = getPositions();\n \n         for (int i = 0; i < positionCount; i++) {\n-            int position = positions[i];\n-            int beginOffset = columnarArray.getOffset(position);\n-            int endOffset = columnarArray.getOffset(position + 1);\n-            int length = endOffset - beginOffset;\n+            offsets[i + 1] = offsets[i] + columnarArray.getLength(positions[i]);\n+        }\n \n-            offsets[i + 1] = offsets[i] + length;\n+        valuesBuffers.setPositions(ensureCapacity(valuesBuffers.getPositions(), offsets[positionCount], SMALL, NONE, bufferAllocator));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a8b6053f3d9d15965b28367d8a6236e47448a6b"}, "originalPosition": 12}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3a8b6053f3d9d15965b28367d8a6236e47448a6b", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/3a8b6053f3d9d15965b28367d8a6236e47448a6b", "committedDate": "2020-04-26T01:59:07Z", "message": "Pre-calculate nested positions array size in BlockEncodingBuffer\n\nThe positions array for nested BlockEncodingBuffer used to be grown on\nthe fly. This uses extra CPU and makes the positions array larger than\nrequired because the growth factor was 2.0. This commit pre-calculates\nthe nested positions array size, allocate the memory in one shot, then\npopulate the positions."}, "afterCommit": {"oid": "a3190c01e38d3e9a131170b8f085e826a9289161", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/a3190c01e38d3e9a131170b8f085e826a9289161", "committedDate": "2020-04-29T02:54:34Z", "message": "Pre-calculate nested positions array size in BlockEncodingBuffer\n\nThe positions array for nested BlockEncodingBuffer used to be grown on\nthe fly. This uses extra CPU and makes the positions array larger than\nrequired because the growth factor was 2.0. This commit pre-calculates\nthe nested positions array size, allocate the memory in one shot, then\npopulate the positions."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyNjgxNzc5", "url": "https://github.com/prestodb/presto/pull/14439#pullrequestreview-402681779", "createdAt": "2020-04-29T13:46:27Z", "commit": {"oid": "a3190c01e38d3e9a131170b8f085e826a9289161"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9da85e9c80c32311ba25c34ff50d80d8a755b872", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/9da85e9c80c32311ba25c34ff50d80d8a755b872", "committedDate": "2020-05-01T00:20:10Z", "message": "Pre-calculate nested positions array size in BlockEncodingBuffer\n\nThe positions array for nested BlockEncodingBuffer used to be grown on\nthe fly. This uses extra CPU and makes the positions array larger than\nrequired because the growth factor was 2.0. This commit pre-calculates\nthe nested positions array size, allocate the memory in one shot, then\npopulate the positions."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a3190c01e38d3e9a131170b8f085e826a9289161", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/a3190c01e38d3e9a131170b8f085e826a9289161", "committedDate": "2020-04-29T02:54:34Z", "message": "Pre-calculate nested positions array size in BlockEncodingBuffer\n\nThe positions array for nested BlockEncodingBuffer used to be grown on\nthe fly. This uses extra CPU and makes the positions array larger than\nrequired because the growth factor was 2.0. This commit pre-calculates\nthe nested positions array size, allocate the memory in one shot, then\npopulate the positions."}, "afterCommit": {"oid": "9da85e9c80c32311ba25c34ff50d80d8a755b872", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/9da85e9c80c32311ba25c34ff50d80d8a755b872", "committedDate": "2020-05-01T00:20:10Z", "message": "Pre-calculate nested positions array size in BlockEncodingBuffer\n\nThe positions array for nested BlockEncodingBuffer used to be grown on\nthe fly. This uses extra CPU and makes the positions array larger than\nrequired because the growth factor was 2.0. This commit pre-calculates\nthe nested positions array size, allocate the memory in one shot, then\npopulate the positions."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1909, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}