{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgyNjY5NjA2", "number": 14193, "title": "Improve scale writer creation based on producer buffer", "bodyText": "We observe two cases in production cause current scale writer heuristics\nnot able to scale:\n\nWhen there is skew on the producer side and more than half of the\nproducer buffer is not overutilized.\nWhen grouped execution is enabled and each bucket doesn't make the\nbuffer to be overutilized.\n\nThis commit tries to improve the situation by considering overall\nproducer buffer utilization when deciding scale the writers.\n== RELEASE NOTES ==\n\nGeneral Changes\n* Improve the scale writer heuristics by considering overall producer buffer utilization. This can be enabled by using the session property `optimized_scale_writer_producer_buffer` and the configuration property `optimized-scale-writer-producer-buffer`.", "createdAt": "2020-03-02T23:56:24Z", "url": "https://github.com/prestodb/presto/pull/14193", "merged": true, "mergeCommit": {"oid": "2ab25438a2507b1438d60e7992714a261f9c9308"}, "closed": true, "closedAt": "2020-03-06T05:51:14Z", "author": {"login": "wenleix"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcJ4dETABqjMwOTAzNjIyMjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKzCp7gBqjMxMDMwOTcyODg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a7dcf2dd58d4b8d3227e74268e0d3956e8d39198", "author": {"user": {"login": "wenleix", "name": "Wenlei Xie"}}, "url": "https://github.com/prestodb/presto/commit/a7dcf2dd58d4b8d3227e74268e0d3956e8d39198", "committedDate": "2020-03-02T23:52:45Z", "message": "Improve scale writer creation based on producer buffer\n\nWe observe two cases in production cause current scale writer heuristics\nnot able to scale:\n\n1. When there is skew on the producer side and more than half of the\nproducer buffer is not overutilized.\n2. When grouped execution is enabled and each bucket doesn't make the\nbuffer to be overutilized.\n\nThis commit tries to improve the situation by considering overall\nproducer buffer utilization when deciding scale the writers."}, "afterCommit": {"oid": "71656d0f3dd76f1600bb28daee0b05428ea4f374", "author": {"user": {"login": "wenleix", "name": "Wenlei Xie"}}, "url": "https://github.com/prestodb/presto/commit/71656d0f3dd76f1600bb28daee0b05428ea4f374", "committedDate": "2020-03-03T01:57:40Z", "message": "Improve scale writer creation based on producer buffer\n\nWe observe two cases in production cause current scale writer heuristics\nnot able to scale:\n\n1. When there is skew on the producer side and more than half of the\nproducer buffer is not overutilized.\n2. When grouped execution is enabled and each bucket doesn't make the\nbuffer to be overutilized.\n\nThis commit tries to improve the situation by considering overall\nproducer buffer utilization when deciding scale the writers."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "71656d0f3dd76f1600bb28daee0b05428ea4f374", "author": {"user": {"login": "wenleix", "name": "Wenlei Xie"}}, "url": "https://github.com/prestodb/presto/commit/71656d0f3dd76f1600bb28daee0b05428ea4f374", "committedDate": "2020-03-03T01:57:40Z", "message": "Improve scale writer creation based on producer buffer\n\nWe observe two cases in production cause current scale writer heuristics\nnot able to scale:\n\n1. When there is skew on the producer side and more than half of the\nproducer buffer is not overutilized.\n2. When grouped execution is enabled and each bucket doesn't make the\nbuffer to be overutilized.\n\nThis commit tries to improve the situation by considering overall\nproducer buffer utilization when deciding scale the writers."}, "afterCommit": {"oid": "dd448d33bc7a229eca4b7a8554fae1e289e9d7db", "author": {"user": {"login": "wenleix", "name": "Wenlei Xie"}}, "url": "https://github.com/prestodb/presto/commit/dd448d33bc7a229eca4b7a8554fae1e289e9d7db", "committedDate": "2020-03-03T05:08:27Z", "message": "Improve scale writer creation based on producer buffer\n\nWe observe two cases in production cause current scale writer heuristics\nnot able to scale:\n\n1. When there is skew on the producer side and more than half of the\nproducer buffer is not overutilized.\n2. When grouped execution is enabled and each bucket doesn't make the\nbuffer to be overutilized.\n\nThis commit tries to improve the situation by considering overall\nproducer buffer utilization when deciding scale the writers."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dd448d33bc7a229eca4b7a8554fae1e289e9d7db", "author": {"user": {"login": "wenleix", "name": "Wenlei Xie"}}, "url": "https://github.com/prestodb/presto/commit/dd448d33bc7a229eca4b7a8554fae1e289e9d7db", "committedDate": "2020-03-03T05:08:27Z", "message": "Improve scale writer creation based on producer buffer\n\nWe observe two cases in production cause current scale writer heuristics\nnot able to scale:\n\n1. When there is skew on the producer side and more than half of the\nproducer buffer is not overutilized.\n2. When grouped execution is enabled and each bucket doesn't make the\nbuffer to be overutilized.\n\nThis commit tries to improve the situation by considering overall\nproducer buffer utilization when deciding scale the writers."}, "afterCommit": {"oid": "46691e3d9de6e5728d43f6d1779db9e69d4cc498", "author": {"user": {"login": "wenleix", "name": "Wenlei Xie"}}, "url": "https://github.com/prestodb/presto/commit/46691e3d9de6e5728d43f6d1779db9e69d4cc498", "committedDate": "2020-03-03T05:57:02Z", "message": "Improve scale writer creation based on producer buffer\n\nWe observe two cases in production cause current scale writer heuristics\nnot able to scale:\n\n1. When there is skew on the producer side and more than half of the\nproducer buffer is not overutilized.\n2. When grouped execution is enabled and each bucket doesn't make the\nbuffer to be overutilized.\n\nThis commit tries to improve the situation by considering overall\nproducer buffer utilization when deciding scale the writers."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "46691e3d9de6e5728d43f6d1779db9e69d4cc498", "author": {"user": {"login": "wenleix", "name": "Wenlei Xie"}}, "url": "https://github.com/prestodb/presto/commit/46691e3d9de6e5728d43f6d1779db9e69d4cc498", "committedDate": "2020-03-03T05:57:02Z", "message": "Improve scale writer creation based on producer buffer\n\nWe observe two cases in production cause current scale writer heuristics\nnot able to scale:\n\n1. When there is skew on the producer side and more than half of the\nproducer buffer is not overutilized.\n2. When grouped execution is enabled and each bucket doesn't make the\nbuffer to be overutilized.\n\nThis commit tries to improve the situation by considering overall\nproducer buffer utilization when deciding scale the writers."}, "afterCommit": {"oid": "fc453bbef90212cba976c7d22f10720867745567", "author": {"user": {"login": "wenleix", "name": "Wenlei Xie"}}, "url": "https://github.com/prestodb/presto/commit/fc453bbef90212cba976c7d22f10720867745567", "committedDate": "2020-03-03T06:38:08Z", "message": "Improve scale writer creation based on producer buffer\n\nWe observe two cases in production cause current scale writer heuristics\nnot able to scale:\n\n1. When there is skew on the producer side and more than half of the\nproducer buffer is not overutilized.\n2. When grouped execution is enabled and each bucket doesn't make the\nbuffer to be overutilized.\n\nThis commit tries to improve the situation by considering overall\nproducer buffer utilization when deciding scale the writers."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fc453bbef90212cba976c7d22f10720867745567", "author": {"user": {"login": "wenleix", "name": "Wenlei Xie"}}, "url": "https://github.com/prestodb/presto/commit/fc453bbef90212cba976c7d22f10720867745567", "committedDate": "2020-03-03T06:38:08Z", "message": "Improve scale writer creation based on producer buffer\n\nWe observe two cases in production cause current scale writer heuristics\nnot able to scale:\n\n1. When there is skew on the producer side and more than half of the\nproducer buffer is not overutilized.\n2. When grouped execution is enabled and each bucket doesn't make the\nbuffer to be overutilized.\n\nThis commit tries to improve the situation by considering overall\nproducer buffer utilization when deciding scale the writers."}, "afterCommit": {"oid": "b4b40869383a9d71aac7eea6cd169fade4587643", "author": {"user": {"login": "wenleix", "name": "Wenlei Xie"}}, "url": "https://github.com/prestodb/presto/commit/b4b40869383a9d71aac7eea6cd169fade4587643", "committedDate": "2020-03-04T19:44:21Z", "message": "Improve scale writer creation based on producer buffer\n\nWe observe two cases in production cause current scale writer heuristics\nnot able to scale:\n\n1. When there is skew on the producer side and more than half of the\nproducer buffer is not overutilized.\n2. When grouped execution is enabled and each bucket doesn't make the\nbuffer to be overutilized.\n\nThis commit tries to improve the situation by considering overall\nproducer buffer utilization when deciding scale the writers."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MDk5MTE0", "url": "https://github.com/prestodb/presto/pull/14193#pullrequestreview-369099114", "createdAt": "2020-03-04T20:29:20Z", "commit": {"oid": "b4b40869383a9d71aac7eea6cd169fade4587643"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMDoyOToyMVrOFx8h2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMDoyOToyMVrOFx8h2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkxNjI0OQ==", "bodyText": "I'm a little bit confused about this loging. I was thinking more about changing the condition to something like if 50% overutilized OR 90% non empty - add more writer. Thoughts?", "url": "https://github.com/prestodb/presto/pull/14193#discussion_r387916249", "createdAt": "2020-03-04T20:29:21Z", "author": {"login": "arhimondr"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/scheduler/ScaledWriterScheduler.java", "diffHunk": "@@ -105,15 +116,30 @@ private int getNewTaskCount()\n             return 1;\n         }\n \n+        if (optimizedScaleWriterProducerBuffer) {\n+            double totalProducerBufferUtilization = sourceTasksProvider.get().stream()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4b40869383a9d71aac7eea6cd169fade4587643"}, "originalPosition": 46}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b4b40869383a9d71aac7eea6cd169fade4587643", "author": {"user": {"login": "wenleix", "name": "Wenlei Xie"}}, "url": "https://github.com/prestodb/presto/commit/b4b40869383a9d71aac7eea6cd169fade4587643", "committedDate": "2020-03-04T19:44:21Z", "message": "Improve scale writer creation based on producer buffer\n\nWe observe two cases in production cause current scale writer heuristics\nnot able to scale:\n\n1. When there is skew on the producer side and more than half of the\nproducer buffer is not overutilized.\n2. When grouped execution is enabled and each bucket doesn't make the\nbuffer to be overutilized.\n\nThis commit tries to improve the situation by considering overall\nproducer buffer utilization when deciding scale the writers."}, "afterCommit": {"oid": "40fa3031e6f9d8f57efdac347891a23589bcc083", "author": {"user": {"login": "wenleix", "name": "Wenlei Xie"}}, "url": "https://github.com/prestodb/presto/commit/40fa3031e6f9d8f57efdac347891a23589bcc083", "committedDate": "2020-03-05T21:22:12Z", "message": "Improve scale writer creation based on producer buffer\n\nWe observe two cases in production cause current scale writer heuristics\nnot able to scale:\n\n1. When there is skew on the producer side and more than half of the\nproducer buffer is not overutilized.\n2. When grouped execution is enabled and each bucket doesn't make the\nbuffer to be overutilized.\n\nThis commit tries to improve the situation by considering overall\nproducer buffer utilization when deciding scale the writers."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5OTM4MzI4", "url": "https://github.com/prestodb/presto/pull/14193#pullrequestreview-369938328", "createdAt": "2020-03-05T21:46:17Z", "commit": {"oid": "40fa3031e6f9d8f57efdac347891a23589bcc083"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMTo0NjoxN1rOFylUtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMTo0NjoxN1rOFylUtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU4NDYyOQ==", "bodyText": "This is unused now", "url": "https://github.com/prestodb/presto/pull/14193#discussion_r388584629", "createdAt": "2020-03-05T21:46:17Z", "author": {"login": "arhimondr"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/scheduler/ScaledWriterScheduler.java", "diffHunk": "@@ -40,13 +40,19 @@\n public class ScaledWriterScheduler\n         implements StageScheduler\n {\n+    private static final int SCHEDULED_ROUND_REQUIRED_FOR_EQUILIBRIUM = 5;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40fa3031e6f9d8f57efdac347891a23589bcc083"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2124d5e3dae1229e724a0c8bfe92877db993cde1", "author": {"user": {"login": "wenleix", "name": "Wenlei Xie"}}, "url": "https://github.com/prestodb/presto/commit/2124d5e3dae1229e724a0c8bfe92877db993cde1", "committedDate": "2020-03-05T22:13:12Z", "message": "Improve scale writer creation based on producer buffer\n\nWe observe two cases in production cause current scale writer heuristics\nnot able to scale:\n\n1. When there is skew on the producer side and more than half of the\nproducer buffer is not overutilized.\n2. When grouped execution is enabled and each bucket doesn't make the\nbuffer to be overutilized.\n\nThis commit tries to improve the situation by considering overall\nproducer buffer utilization when deciding scale the writers."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "40fa3031e6f9d8f57efdac347891a23589bcc083", "author": {"user": {"login": "wenleix", "name": "Wenlei Xie"}}, "url": "https://github.com/prestodb/presto/commit/40fa3031e6f9d8f57efdac347891a23589bcc083", "committedDate": "2020-03-05T21:22:12Z", "message": "Improve scale writer creation based on producer buffer\n\nWe observe two cases in production cause current scale writer heuristics\nnot able to scale:\n\n1. When there is skew on the producer side and more than half of the\nproducer buffer is not overutilized.\n2. When grouped execution is enabled and each bucket doesn't make the\nbuffer to be overutilized.\n\nThis commit tries to improve the situation by considering overall\nproducer buffer utilization when deciding scale the writers."}, "afterCommit": {"oid": "2124d5e3dae1229e724a0c8bfe92877db993cde1", "author": {"user": {"login": "wenleix", "name": "Wenlei Xie"}}, "url": "https://github.com/prestodb/presto/commit/2124d5e3dae1229e724a0c8bfe92877db993cde1", "committedDate": "2020-03-05T22:13:12Z", "message": "Improve scale writer creation based on producer buffer\n\nWe observe two cases in production cause current scale writer heuristics\nnot able to scale:\n\n1. When there is skew on the producer side and more than half of the\nproducer buffer is not overutilized.\n2. When grouped execution is enabled and each bucket doesn't make the\nbuffer to be overutilized.\n\nThis commit tries to improve the situation by considering overall\nproducer buffer utilization when deciding scale the writers."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2378, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}