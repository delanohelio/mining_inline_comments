{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg0NDE3MDkz", "number": 14216, "title": "Allow forcing streaming exchange for Mark Distinct", "bodyText": "Mark distinct is enabled by default and introduces a stage per distinct column in a query in order to redistribute the tracking of distinct values across the entire cluster. With materialized exchange the cost of these additional exchanges is higher. Enabling streaming exchange if there is sufficient memory available to perform the distincting will reduce the cost of these additional stages while still reducing the memory used by other by non-Mark Distinct stages.\n== RELEASE NOTES ==\n\nGeneral Changes\n* Allow forcing streaming exchange for Mark Distinct using 'query.use-streaming-exchange-for-mark-distinct'", "createdAt": "2020-03-05T17:50:48Z", "url": "https://github.com/prestodb/presto/pull/14216", "merged": true, "mergeCommit": {"oid": "f9bf064946accbf7c66f9cba592c84af76a90b95"}, "closed": true, "closedAt": "2020-03-11T22:02:31Z", "author": {"login": "aweisberg"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKyLfqABqjMxMDI5Mjg5NDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMtGEmABqjMxMjAzOTA1OTU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "21d0ef031042903e2a90315a5b3a5243d9073b7a", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/21d0ef031042903e2a90315a5b3a5243d9073b7a", "committedDate": "2020-03-05T17:05:46Z", "message": "Add stream mark distinct with LBM session property"}, "afterCommit": {"oid": "74252001693488e9eb14fd2365369cd296d454c8", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/74252001693488e9eb14fd2365369cd296d454c8", "committedDate": "2020-03-05T21:12:58Z", "message": "Add stream mark distinct with LBM session property"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "74252001693488e9eb14fd2365369cd296d454c8", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/74252001693488e9eb14fd2365369cd296d454c8", "committedDate": "2020-03-05T21:12:58Z", "message": "Add stream mark distinct with LBM session property"}, "afterCommit": {"oid": "76c3ea221a14b4f84e213bd8c89ff222af0a9fc5", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/76c3ea221a14b4f84e213bd8c89ff222af0a9fc5", "committedDate": "2020-03-06T22:15:35Z", "message": "Add stream mark distinct with LBM session property"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxMzEyOTkx", "url": "https://github.com/prestodb/presto/pull/14216#pullrequestreview-371312991", "createdAt": "2020-03-09T16:01:08Z", "commit": {"oid": "76c3ea221a14b4f84e213bd8c89ff222af0a9fc5"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxMzE3OTU4", "url": "https://github.com/prestodb/presto/pull/14216#pullrequestreview-371317958", "createdAt": "2020-03-09T16:07:04Z", "commit": {"oid": "05ab259710959c12e465787a66378585ddd6b310"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxNjowNzowNVrOFzvFZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxNjowNzowNVrOFzvFZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTc5MzEyNA==", "bodyText": "Curious why it's called PARTITIONING_PRECISION_STRATEGY? -- didn't see discussion in #13354 ?\nSince when I see \"precision\", I am thinking whether the \"partitioning\" is accurate or not. However, in this case it's about whether we want to use ALL the columns required by join/aggregation, while any partitioning with SUBSET* of the columns would work.", "url": "https://github.com/prestodb/presto/pull/14216#discussion_r389793124", "createdAt": "2020-03-09T16:07:05Z", "author": {"login": "wenleix"}, "path": "presto-main/src/test/java/com/facebook/presto/sql/planner/optimizations/TestAddExchangesPlans.java", "diffHunk": "@@ -422,9 +422,7 @@ void assertExactDistributedPlan(String sql, PlanMatchPattern pattern)\n                 TestingSession.testSessionBuilder()\n                         .setCatalog(\"local\")\n                         .setSchema(\"tiny\")\n-                        .setSystemProperty(\n-                                SystemSessionProperties.PARTITIONING_PRECISION_STRATEGY,\n-                                FeaturesConfig.PartitioningPrecisionStrategy.PREFER_EXACT_PARTITIONING.toString())\n+                        .setSystemProperty(PARTITIONING_PRECISION_STRATEGY, PREFER_EXACT_PARTITIONING.toString())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05ab259710959c12e465787a66378585ddd6b310"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxNDE3ODE3", "url": "https://github.com/prestodb/presto/pull/14216#pullrequestreview-371417817", "createdAt": "2020-03-09T18:14:39Z", "commit": {"oid": "76c3ea221a14b4f84e213bd8c89ff222af0a9fc5"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxODoxNDozOVrOFzz9QA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxODoxNzoxOVrOFz0DPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg3Mjk2MA==", "bodyText": "nit: What about useStreamExchangeForMarkDistinct?", "url": "https://github.com/prestodb/presto/pull/14216#discussion_r389872960", "createdAt": "2020-03-09T18:14:39Z", "author": {"login": "wenleix"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/QueryManagerConfig.java", "diffHunk": "@@ -44,6 +44,7 @@\n     private int hashPartitionCount = 100;\n     private String partitioningProviderCatalog = GlobalSystemConnector.NAME;\n     private ExchangeMaterializationStrategy exchangeMaterializationStrategy = ExchangeMaterializationStrategy.NONE;\n+    private boolean streamMarkDistinctWithMaterializedExchange;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76c3ea221a14b4f84e213bd8c89ff222af0a9fc5"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg3MzIzMw==", "bodyText": "ditto, query.use-stream-exchange-for-mark-distinct", "url": "https://github.com/prestodb/presto/pull/14216#discussion_r389873233", "createdAt": "2020-03-09T18:15:08Z", "author": {"login": "wenleix"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/QueryManagerConfig.java", "diffHunk": "@@ -162,6 +163,20 @@ public ExchangeMaterializationStrategy getExchangeMaterializationStrategy()\n         return exchangeMaterializationStrategy;\n     }\n \n+    @Config(\"query.stream-mark-distinct-with-materialized-exchange\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76c3ea221a14b4f84e213bd8c89ff222af0a9fc5"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg3Mzg0Nw==", "bodyText": "nit: useStreamExchangeForMarkDitinct as variable name ? :)", "url": "https://github.com/prestodb/presto/pull/14216#discussion_r389873847", "createdAt": "2020-03-09T18:16:11Z", "author": {"login": "wenleix"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/optimizations/AddExchanges.java", "diffHunk": "@@ -1379,7 +1380,8 @@ private Partitioning createPartitioning(Collection<VariableReferenceExpression>\n         //   materialized exchange is supported for all nodes.\n         private Scope selectExchangeScopeForPartitionedRemoteExchange(PlanNode exchangeSource, boolean nullsAndAnyReplicated)\n         {\n-            if (nullsAndAnyReplicated || exchangeSource.getOutputVariables().isEmpty()) {\n+            boolean streamMarkDistinct = SystemSessionProperties.isStreamMarkDistinctWithMaterializedExchangeEnabled(session);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76c3ea221a14b4f84e213bd8c89ff222af0a9fc5"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg3NDQ5Mw==", "bodyText": "Will this make ALL exchange to be streaming when useStreamExchangeForMarkDistinct is set? -- I expect to see some condition based on plan node? :)", "url": "https://github.com/prestodb/presto/pull/14216#discussion_r389874493", "createdAt": "2020-03-09T18:17:19Z", "author": {"login": "wenleix"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/optimizations/AddExchanges.java", "diffHunk": "@@ -1379,7 +1380,8 @@ private Partitioning createPartitioning(Collection<VariableReferenceExpression>\n         //   materialized exchange is supported for all nodes.\n         private Scope selectExchangeScopeForPartitionedRemoteExchange(PlanNode exchangeSource, boolean nullsAndAnyReplicated)\n         {\n-            if (nullsAndAnyReplicated || exchangeSource.getOutputVariables().isEmpty()) {\n+            boolean streamMarkDistinct = SystemSessionProperties.isStreamMarkDistinctWithMaterializedExchangeEnabled(session);\n+            if (nullsAndAnyReplicated || exchangeSource.getOutputVariables().isEmpty() || streamMarkDistinct) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76c3ea221a14b4f84e213bd8c89ff222af0a9fc5"}, "originalPosition": 14}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "76c3ea221a14b4f84e213bd8c89ff222af0a9fc5", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/76c3ea221a14b4f84e213bd8c89ff222af0a9fc5", "committedDate": "2020-03-06T22:15:35Z", "message": "Add stream mark distinct with LBM session property"}, "afterCommit": {"oid": "35c8f4117cfa1ef28c604051f2240cbab11c4917", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/35c8f4117cfa1ef28c604051f2240cbab11c4917", "committedDate": "2020-03-10T15:08:12Z", "message": "Add stream mark distinct with LBM session property"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "35c8f4117cfa1ef28c604051f2240cbab11c4917", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/35c8f4117cfa1ef28c604051f2240cbab11c4917", "committedDate": "2020-03-10T15:08:12Z", "message": "Add stream mark distinct with LBM session property"}, "afterCommit": {"oid": "58bf6d00fc9d9d7b21d3c8ecef8ed47e2a4f6cf9", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/58bf6d00fc9d9d7b21d3c8ecef8ed47e2a4f6cf9", "committedDate": "2020-03-10T15:28:01Z", "message": "Add stream mark distinct with LBM session property"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyNDc5NjEz", "url": "https://github.com/prestodb/presto/pull/14216#pullrequestreview-372479613", "createdAt": "2020-03-11T05:12:48Z", "commit": {"oid": "58bf6d00fc9d9d7b21d3c8ecef8ed47e2a4f6cf9"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQwNToxMjo0OVrOF0pcrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQwNToxNDoxM1rOF0pd_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDc0OTM1OQ==", "bodyText": "nit: static import", "url": "https://github.com/prestodb/presto/pull/14216#discussion_r390749359", "createdAt": "2020-03-11T05:12:49Z", "author": {"login": "arhimondr"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/optimizations/AddExchanges.java", "diffHunk": "@@ -318,10 +319,15 @@ public PlanWithProperties visitMarkDistinct(MarkDistinctNode node, PreferredProp\n \n             if (child.getProperties().isSingleNode() ||\n                     !isStreamPartitionedOn(child.getProperties(), node.getDistinctVariables())) {\n+                boolean useStreamingExchangeWithMarkDistinct =\n+                        SystemSessionProperties.isStreamMarkDistinctWithMaterializedExchangeEnabled(session);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58bf6d00fc9d9d7b21d3c8ecef8ed47e2a4f6cf9"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDc0OTY5Mg==", "bodyText": "nit: It should be fine to inline it after the static import is applied", "url": "https://github.com/prestodb/presto/pull/14216#discussion_r390749692", "createdAt": "2020-03-11T05:14:13Z", "author": {"login": "arhimondr"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/optimizations/AddExchanges.java", "diffHunk": "@@ -318,10 +319,15 @@ public PlanWithProperties visitMarkDistinct(MarkDistinctNode node, PreferredProp\n \n             if (child.getProperties().isSingleNode() ||\n                     !isStreamPartitionedOn(child.getProperties(), node.getDistinctVariables())) {\n+                boolean useStreamingExchangeWithMarkDistinct =\n+                        SystemSessionProperties.isStreamMarkDistinctWithMaterializedExchangeEnabled(session);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDc0OTM1OQ=="}, "originalCommit": {"oid": "58bf6d00fc9d9d7b21d3c8ecef8ed47e2a4f6cf9"}, "originalPosition": 13}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "58bf6d00fc9d9d7b21d3c8ecef8ed47e2a4f6cf9", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/58bf6d00fc9d9d7b21d3c8ecef8ed47e2a4f6cf9", "committedDate": "2020-03-10T15:28:01Z", "message": "Add stream mark distinct with LBM session property"}, "afterCommit": {"oid": "412ad855b885b91204cd574348551564665c5d9a", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/412ad855b885b91204cd574348551564665c5d9a", "committedDate": "2020-03-11T17:18:51Z", "message": "Allow forcing streaming exchange for Mark Distinct\n\nWhen MarkDistinctOperator executes queries with distincted aggregation columns\nit requires an exchange per column, which is which is prohibitively\nexpensive for materialized exchange.\n\nAdd \"query.use-stream-exchange-for-mark-distinct\" to force streaming\nfor mark distinct even if materialized exchange is enabled."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "412ad855b885b91204cd574348551564665c5d9a", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/412ad855b885b91204cd574348551564665c5d9a", "committedDate": "2020-03-11T17:18:51Z", "message": "Allow forcing streaming exchange for Mark Distinct\n\nWhen MarkDistinctOperator executes queries with distincted aggregation columns\nit requires an exchange per column, which is which is prohibitively\nexpensive for materialized exchange.\n\nAdd \"query.use-stream-exchange-for-mark-distinct\" to force streaming\nfor mark distinct even if materialized exchange is enabled."}, "afterCommit": {"oid": "c7071fe749b11d668095e868cf02dc6ef2c5125b", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/c7071fe749b11d668095e868cf02dc6ef2c5125b", "committedDate": "2020-03-11T19:09:50Z", "message": "Allow forcing streaming exchange for Mark Distinct\n\nWhen MarkDistinctOperator executes queries with distincted aggregation columns\nit requires an exchange per column, which is which is prohibitively\nexpensive for materialized exchange.\n\nAdd \"query.use-stream-exchange-for-mark-distinct\" to force streaming\nfor mark distinct even if materialized exchange is enabled."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10bb97162169d44ad8269a3f5be3346736cb5468", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/10bb97162169d44ad8269a3f5be3346736cb5468", "committedDate": "2020-03-11T19:12:10Z", "message": "Use static imports in TestAddExchangePlans"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c7071fe749b11d668095e868cf02dc6ef2c5125b", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/c7071fe749b11d668095e868cf02dc6ef2c5125b", "committedDate": "2020-03-11T19:09:50Z", "message": "Allow forcing streaming exchange for Mark Distinct\n\nWhen MarkDistinctOperator executes queries with distincted aggregation columns\nit requires an exchange per column, which is which is prohibitively\nexpensive for materialized exchange.\n\nAdd \"query.use-stream-exchange-for-mark-distinct\" to force streaming\nfor mark distinct even if materialized exchange is enabled."}, "afterCommit": {"oid": "48aa36235070e40a42d889e7ce2c84780cc0f6b8", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/48aa36235070e40a42d889e7ce2c84780cc0f6b8", "committedDate": "2020-03-11T19:13:09Z", "message": "Allow forcing streaming exchange for Mark Distinct\n\nWhen MarkDistinctOperator executes queries with distincted aggregation columns\nit requires an exchange per column, which is which is prohibitively\nexpensive for materialized exchange.\n\nAdd \"query.use-stream-exchange-for-mark-distinct\" to force streaming\nfor mark distinct even if materialized exchange is enabled."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczMDYwNTY1", "url": "https://github.com/prestodb/presto/pull/14216#pullrequestreview-373060565", "createdAt": "2020-03-11T19:28:33Z", "commit": {"oid": "48aa36235070e40a42d889e7ce2c84780cc0f6b8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e124c4aa1de49345d33c8df382a089d7f5a710b", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/1e124c4aa1de49345d33c8df382a089d7f5a710b", "committedDate": "2020-03-11T20:25:14Z", "message": "Allow forcing streaming exchange for Mark Distinct\n\nWhen MarkDistinctOperator executes queries with distincted aggregation columns\nit requires an exchange per column, which is which is prohibitively\nexpensive for materialized exchange.\n\nAdd \"query.use-stream-exchange-for-mark-distinct\" to force streaming\nfor mark distinct even if materialized exchange is enabled."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "48aa36235070e40a42d889e7ce2c84780cc0f6b8", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/48aa36235070e40a42d889e7ce2c84780cc0f6b8", "committedDate": "2020-03-11T19:13:09Z", "message": "Allow forcing streaming exchange for Mark Distinct\n\nWhen MarkDistinctOperator executes queries with distincted aggregation columns\nit requires an exchange per column, which is which is prohibitively\nexpensive for materialized exchange.\n\nAdd \"query.use-stream-exchange-for-mark-distinct\" to force streaming\nfor mark distinct even if materialized exchange is enabled."}, "afterCommit": {"oid": "1e124c4aa1de49345d33c8df382a089d7f5a710b", "author": {"user": {"login": "aweisberg", "name": null}}, "url": "https://github.com/prestodb/presto/commit/1e124c4aa1de49345d33c8df382a089d7f5a710b", "committedDate": "2020-03-11T20:25:14Z", "message": "Allow forcing streaming exchange for Mark Distinct\n\nWhen MarkDistinctOperator executes queries with distincted aggregation columns\nit requires an exchange per column, which is which is prohibitively\nexpensive for materialized exchange.\n\nAdd \"query.use-stream-exchange-for-mark-distinct\" to force streaming\nfor mark distinct even if materialized exchange is enabled."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1996, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}