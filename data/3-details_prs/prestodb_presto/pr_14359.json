{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAwMTAyNDkw", "number": 14359, "title": "Fix NPE when reading structs with a newly added subfield", "bodyText": "If a nestedStream is missing for a field in the schema create a MissingFieldStreamReader\nFixes #14358\n== NO RELEASE NOTE ==", "createdAt": "2020-04-07T07:55:56Z", "url": "https://github.com/prestodb/presto/pull/14359", "merged": true, "mergeCommit": {"oid": "e3386889222438453aac2bf448777c943a507321"}, "closed": true, "closedAt": "2020-04-09T20:49:27Z", "author": {"login": "bhhari"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcVUo0tgFqTM4OTIwNjE2OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcWB1CRgBqjMyMTk3MDY5OTU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MjA2MTY5", "url": "https://github.com/prestodb/presto/pull/14359#pullrequestreview-389206169", "createdAt": "2020-04-07T15:01:10Z", "commit": {"oid": "31123f1efff06b18a6300c66ac9d1fc547308bc2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNTowMToxMFrOGCH5Og==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNTowMToxMFrOGCH5Og==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg3OTY3NA==", "bodyText": "@bhhari What happens if fieldOutputType is empty?", "url": "https://github.com/prestodb/presto/pull/14359#discussion_r404879674", "createdAt": "2020-04-07T15:01:10Z", "author": {"login": "mbasmanova"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/reader/StructSelectiveStreamReader.java", "diffHunk": "@@ -166,13 +166,16 @@ else if (outputRequired || !fieldsWithFilters.isEmpty()) {\n                 boolean requiredField = requiredFields.map(names -> names.containsKey(fieldName)).orElse(outputRequired);\n                 Optional<Type> fieldOutputType = Optional.ofNullable(nestedTypes.get(fieldName)).map(Field::getType);\n \n-                if (requiredField || fieldsWithFilters.contains(fieldName)) {\n-                    Map<Subfield, TupleDomainFilter> nestedFilters = filters.entrySet().stream()\n-                            .filter(entry -> entry.getKey().getPath().size() > 0)\n-                            .filter(entry -> ((Subfield.NestedField) entry.getKey().getPath().get(0)).getName().equalsIgnoreCase(fieldName))\n-                            .collect(toImmutableMap(entry -> entry.getKey().tail(fieldName), Map.Entry::getValue));\n-                    List<Subfield> nestedRequiredSubfields = requiredFields.map(names -> names.get(fieldName)).orElse(ImmutableList.of());\n-                    if (nestedStream != null) {\n+                if (nestedStream == null) {\n+                    nestedReaders.put(fieldName, new MissingFieldStreamReader(fieldOutputType.get()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31123f1efff06b18a6300c66ac9d1fc547308bc2"}, "originalPosition": 12}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "31123f1efff06b18a6300c66ac9d1fc547308bc2", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/31123f1efff06b18a6300c66ac9d1fc547308bc2", "committedDate": "2020-04-07T07:54:31Z", "message": "Handle schema evolution for Structs\nIf a nestedStream is missing for a field in the schema create a MissingFieldStreamReader"}, "afterCommit": {"oid": "b97debaf46637783fa68c96a32d35899c2db75e9", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/b97debaf46637783fa68c96a32d35899c2db75e9", "committedDate": "2020-04-07T20:35:16Z", "message": "Handle schema evolution for Structs\nIf a nestedStream is missing for a field in the schema create a MissingFieldStreamReader"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5NTIyMjE2", "url": "https://github.com/prestodb/presto/pull/14359#pullrequestreview-389522216", "createdAt": "2020-04-07T22:02:14Z", "commit": {"oid": "b97debaf46637783fa68c96a32d35899c2db75e9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QyMjowMjoxNFrOGCXxcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QyMjowMjoxNFrOGCXxcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTEzOTgyNw==", "bodyText": "@bhhari nit: extra space before \"FROM\"", "url": "https://github.com/prestodb/presto/pull/14359#discussion_r405139827", "createdAt": "2020-04-07T22:02:14Z", "author": {"login": "mbasmanova"}, "path": "presto-hive/src/test/java/com/facebook/presto/hive/TestHivePushdownFilterQueries.java", "diffHunk": "@@ -875,6 +875,8 @@ public void testStructSchemaEvolution()\n         Path newDirectoryPath = getOnlyPath(\"test_struct_add_column\").getParent();\n         Files.move(oldFilePath, Paths.get(newDirectoryPath.toString(), \"old_file\"), ATOMIC_MOVE);\n         assertQuery(\"SELECT * FROM test_struct_add_column\", \"SELECT (1, 2, 3) UNION ALL SELECT (1, 2, null)\");\n+        assertQuery(\"SELECT x.a FROM test_struct_add_column\", \"SELECT 1 UNION ALL SELECT 1\");\n+        assertQuery(\"SELECT count(*)  FROM test_struct_add_column where x.c = 1\", \"SELECT 0\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b97debaf46637783fa68c96a32d35899c2db75e9"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5NTIzMzk1", "url": "https://github.com/prestodb/presto/pull/14359#pullrequestreview-389523395", "createdAt": "2020-04-07T22:04:28Z", "commit": {"oid": "b97debaf46637783fa68c96a32d35899c2db75e9"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5NjU5MjE4", "url": "https://github.com/prestodb/presto/pull/14359#pullrequestreview-389659218", "createdAt": "2020-04-08T05:22:16Z", "commit": {"oid": "b97debaf46637783fa68c96a32d35899c2db75e9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b97debaf46637783fa68c96a32d35899c2db75e9", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/b97debaf46637783fa68c96a32d35899c2db75e9", "committedDate": "2020-04-07T20:35:16Z", "message": "Handle schema evolution for Structs\nIf a nestedStream is missing for a field in the schema create a MissingFieldStreamReader"}, "afterCommit": {"oid": "52757a421e837651119485f9e01caa1345b426e3", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/52757a421e837651119485f9e01caa1345b426e3", "committedDate": "2020-04-09T18:19:50Z", "message": "Fix NPE when reading structs with a newly added subfield"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMDMzNTUx", "url": "https://github.com/prestodb/presto/pull/14359#pullrequestreview-391033551", "createdAt": "2020-04-09T18:30:08Z", "commit": {"oid": "52757a421e837651119485f9e01caa1345b426e3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b25758bddd70474144a53a15abab24b40dbd065c", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/b25758bddd70474144a53a15abab24b40dbd065c", "committedDate": "2020-04-09T19:37:43Z", "message": "Fix NPE when reading structs with a newly added subfield"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "52757a421e837651119485f9e01caa1345b426e3", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/52757a421e837651119485f9e01caa1345b426e3", "committedDate": "2020-04-09T18:19:50Z", "message": "Fix NPE when reading structs with a newly added subfield"}, "afterCommit": {"oid": "0ebea7b5591c89eba04af6672dd67993782ce8ea", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/0ebea7b5591c89eba04af6672dd67993782ce8ea", "committedDate": "2020-04-09T19:38:06Z", "message": "force build"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0ebea7b5591c89eba04af6672dd67993782ce8ea", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/0ebea7b5591c89eba04af6672dd67993782ce8ea", "committedDate": "2020-04-09T19:38:06Z", "message": "force build"}, "afterCommit": {"oid": "b25758bddd70474144a53a15abab24b40dbd065c", "author": {"user": {"login": "bhhari", "name": null}}, "url": "https://github.com/prestodb/presto/commit/b25758bddd70474144a53a15abab24b40dbd065c", "committedDate": "2020-04-09T19:37:43Z", "message": "Fix NPE when reading structs with a newly added subfield"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1806, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}