{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk5NzcwMjAx", "number": 15288, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMDoyOToyMVrOErx1xA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxOTo1OToyMFrOEsLlGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0MzQwODA0OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/s3/PrestoS3FileSystem.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMDoyOToyMVrOHevQDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwODoyMjo1NlrOHe_-Pg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk5MzQ4Ng==", "bodyText": "s/this.s3IamRole/s3IamRole/g", "url": "https://github.com/prestodb/presto/pull/15288#discussion_r501993486", "createdAt": "2020-10-08T20:29:21Z", "author": {"login": "zhenxiao"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/s3/PrestoS3FileSystem.java", "diffHunk": "@@ -210,6 +213,9 @@ public void initialize(URI uri, Configuration conf)\n         this.isPathStyleAccess = conf.getBoolean(S3_PATH_STYLE_ACCESS, defaults.isS3PathStyleAccess());\n         this.useInstanceCredentials = conf.getBoolean(S3_USE_INSTANCE_CREDENTIALS, defaults.isS3UseInstanceCredentials());\n         this.pinS3ClientToCurrentRegion = conf.getBoolean(S3_PIN_CLIENT_TO_CURRENT_REGION, defaults.isPinS3ClientToCurrentRegion());\n+        this.s3IamRole = conf.get(S3_IAM_ROLE, defaults.getS3IamRole());\n+        verify(!(useInstanceCredentials && this.s3IamRole != null),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "add9947433037e8fd349e795da5cfea3d5c9967d"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI2NzQ1NA==", "bodyText": "addressed this.", "url": "https://github.com/prestodb/presto/pull/15288#discussion_r502267454", "createdAt": "2020-10-09T08:22:56Z", "author": {"login": "ashishtadose"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/s3/PrestoS3FileSystem.java", "diffHunk": "@@ -210,6 +213,9 @@ public void initialize(URI uri, Configuration conf)\n         this.isPathStyleAccess = conf.getBoolean(S3_PATH_STYLE_ACCESS, defaults.isS3PathStyleAccess());\n         this.useInstanceCredentials = conf.getBoolean(S3_USE_INSTANCE_CREDENTIALS, defaults.isS3UseInstanceCredentials());\n         this.pinS3ClientToCurrentRegion = conf.getBoolean(S3_PIN_CLIENT_TO_CURRENT_REGION, defaults.isPinS3ClientToCurrentRegion());\n+        this.s3IamRole = conf.get(S3_IAM_ROLE, defaults.getS3IamRole());\n+        verify(!(useInstanceCredentials && this.s3IamRole != null),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk5MzQ4Ng=="}, "originalCommit": {"oid": "add9947433037e8fd349e795da5cfea3d5c9967d"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0MzQxMTU2OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/s3/PrestoS3FileSystem.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMDozMDoyMlrOHevSPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwODoyNzoyNlrOHfAIPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk5NDA0Ng==", "bodyText": "same for this.s3IamRole\nshall we have a roleSessionName , instead of using presto-session?", "url": "https://github.com/prestodb/presto/pull/15288#discussion_r501994046", "createdAt": "2020-10-08T20:30:22Z", "author": {"login": "zhenxiao"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/s3/PrestoS3FileSystem.java", "diffHunk": "@@ -794,6 +800,10 @@ private AWSCredentialsProvider createAwsCredentialsProvider(URI uri, Configurati\n             return InstanceProfileCredentialsProvider.getInstance();\n         }\n \n+        if (s3IamRole != null) {\n+            return new STSAssumeRoleSessionCredentialsProvider.Builder(this.s3IamRole, \"presto-session\").build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "add9947433037e8fd349e795da5cfea3d5c9967d"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk5NjE1OA==", "bodyText": "following https://docs.aws.amazon.com/STS/latest/APIReference/API_AssumeRole.html\ndo you think it will be valuable to specify maybe something like \"presto - \" + uri as the roleSessionName here instead of presto-session to also have the accessed uri as part of the role name?", "url": "https://github.com/prestodb/presto/pull/15288#discussion_r501996158", "createdAt": "2020-10-08T20:34:35Z", "author": {"login": "zhenxiao"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/s3/PrestoS3FileSystem.java", "diffHunk": "@@ -794,6 +800,10 @@ private AWSCredentialsProvider createAwsCredentialsProvider(URI uri, Configurati\n             return InstanceProfileCredentialsProvider.getInstance();\n         }\n \n+        if (s3IamRole != null) {\n+            return new STSAssumeRoleSessionCredentialsProvider.Builder(this.s3IamRole, \"presto-session\").build();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk5NDA0Ng=="}, "originalCommit": {"oid": "add9947433037e8fd349e795da5cfea3d5c9967d"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI3MDAxNA==", "bodyText": "Agree.. would be good for audit. changed to \"presto-\" + uri", "url": "https://github.com/prestodb/presto/pull/15288#discussion_r502270014", "createdAt": "2020-10-09T08:27:26Z", "author": {"login": "ashishtadose"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/s3/PrestoS3FileSystem.java", "diffHunk": "@@ -794,6 +800,10 @@ private AWSCredentialsProvider createAwsCredentialsProvider(URI uri, Configurati\n             return InstanceProfileCredentialsProvider.getInstance();\n         }\n \n+        if (s3IamRole != null) {\n+            return new STSAssumeRoleSessionCredentialsProvider.Builder(this.s3IamRole, \"presto-session\").build();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk5NDA0Ng=="}, "originalCommit": {"oid": "add9947433037e8fd349e795da5cfea3d5c9967d"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0MzQxNzk1OnYy", "diffSide": "RIGHT", "path": "presto-hive-metastore/src/main/java/com/facebook/presto/hive/metastore/glue/GlueHiveMetastore.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMDozMjoxOFrOHevWFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwODoyNDo1MFrOHfACbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk5NTAzMA==", "bodyText": "shall we have a roleSessionName  instead of using presto-session?", "url": "https://github.com/prestodb/presto/pull/15288#discussion_r501995030", "createdAt": "2020-10-08T20:32:18Z", "author": {"login": "zhenxiao"}, "path": "presto-hive-metastore/src/main/java/com/facebook/presto/hive/metastore/glue/GlueHiveMetastore.java", "diffHunk": "@@ -191,6 +193,13 @@ else if (config.getPinGlueClientToCurrentRegion()) {\n             }\n         }\n \n+        if (config.getIamRole().isPresent()) {\n+            AWSCredentialsProvider credentialsProvider = new STSAssumeRoleSessionCredentialsProvider\n+                    .Builder(config.getIamRole().get(), \"presto-session\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "add9947433037e8fd349e795da5cfea3d5c9967d"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI2ODUyNA==", "bodyText": "addressed. you meant  roleSessionName string as session name instead of presto-session", "url": "https://github.com/prestodb/presto/pull/15288#discussion_r502268524", "createdAt": "2020-10-09T08:24:50Z", "author": {"login": "ashishtadose"}, "path": "presto-hive-metastore/src/main/java/com/facebook/presto/hive/metastore/glue/GlueHiveMetastore.java", "diffHunk": "@@ -191,6 +193,13 @@ else if (config.getPinGlueClientToCurrentRegion()) {\n             }\n         }\n \n+        if (config.getIamRole().isPresent()) {\n+            AWSCredentialsProvider credentialsProvider = new STSAssumeRoleSessionCredentialsProvider\n+                    .Builder(config.getIamRole().get(), \"presto-session\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk5NTAzMA=="}, "originalCommit": {"oid": "add9947433037e8fd349e795da5cfea3d5c9967d"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0MzQzMDA1OnYy", "diffSide": "LEFT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/s3/HiveS3Config.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMDozNjowMFrOHevddw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxOTo1Njo1OFrOHfW8Zw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk5NjkxOQ==", "bodyText": "am not sure about changing the default value. @highker what do you think?", "url": "https://github.com/prestodb/presto/pull/15288#discussion_r501996919", "createdAt": "2020-10-08T20:36:00Z", "author": {"login": "zhenxiao"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/s3/HiveS3Config.java", "diffHunk": "@@ -37,7 +37,7 @@\n     private String s3Endpoint;\n     private PrestoS3SignerType s3SignerType;\n     private boolean s3PathStyleAccess;\n-    private boolean s3UseInstanceCredentials = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13d16401b6b0d5c8926dde3fa45d683e9a852b8b"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI3NDk5MQ==", "bodyText": "This is needed as IAM role configuration will not take effect with the current flow for creating AWS cred provider PrestoS3FileSystem.createAwsCredentialsProvider\nOptional<AWSCredentials> credentials = getAwsCredentials(uri, conf);\n        if (credentials.isPresent()) {\n            return new AWSStaticCredentialsProvider(credentials.get());\n        }\n        if (useInstanceCredentials) {\n            return InstanceProfileCredentialsProvider.getInstance();\n        }\n\n        if (s3IamRole != null) {\n            return new STSAssumeRoleSessionCredentialsProvider.Builder(s3IamRole, \"presto-\" + uri).build();\n        }", "url": "https://github.com/prestodb/presto/pull/15288#discussion_r502274991", "createdAt": "2020-10-09T08:36:43Z", "author": {"login": "ashishtadose"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/s3/HiveS3Config.java", "diffHunk": "@@ -37,7 +37,7 @@\n     private String s3Endpoint;\n     private PrestoS3SignerType s3SignerType;\n     private boolean s3PathStyleAccess;\n-    private boolean s3UseInstanceCredentials = true;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk5NjkxOQ=="}, "originalCommit": {"oid": "13d16401b6b0d5c8926dde3fa45d683e9a852b8b"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY0MzgxNQ==", "bodyText": "get it.", "url": "https://github.com/prestodb/presto/pull/15288#discussion_r502643815", "createdAt": "2020-10-09T19:56:58Z", "author": {"login": "zhenxiao"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/s3/HiveS3Config.java", "diffHunk": "@@ -37,7 +37,7 @@\n     private String s3Endpoint;\n     private PrestoS3SignerType s3SignerType;\n     private boolean s3PathStyleAccess;\n-    private boolean s3UseInstanceCredentials = true;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk5NjkxOQ=="}, "originalCommit": {"oid": "13d16401b6b0d5c8926dde3fa45d683e9a852b8b"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0NzYyNTIyOnYy", "diffSide": "RIGHT", "path": "presto-hive/src/test/java/com/facebook/presto/hive/s3/TestPrestoS3FileSystem.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxOTo1OToyMFrOHfXAGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxMjo1NDowM1rOHf9ghw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY0NDc2Mg==", "bodyText": "shall we keep both testInstanceCredentials and testAssumeRoleCredentials?", "url": "https://github.com/prestodb/presto/pull/15288#discussion_r502644762", "createdAt": "2020-10-09T19:59:20Z", "author": {"login": "zhenxiao"}, "path": "presto-hive/src/test/java/com/facebook/presto/hive/s3/TestPrestoS3FileSystem.java", "diffHunk": "@@ -145,15 +146,16 @@ public void testEndpointWithPinToCurrentRegionConfiguration()\n     }\n \n     @Test\n-    public void testInstanceCredentialsEnabled()\n+    public void testAssumeRoleCredentials()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "90ebcf670085265ae803231e034ea6713b6a9508"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzI3NTY1NQ==", "bodyText": "yes, we can.. addressed it.", "url": "https://github.com/prestodb/presto/pull/15288#discussion_r503275655", "createdAt": "2020-10-12T12:54:03Z", "author": {"login": "ashishtadose"}, "path": "presto-hive/src/test/java/com/facebook/presto/hive/s3/TestPrestoS3FileSystem.java", "diffHunk": "@@ -145,15 +146,16 @@ public void testEndpointWithPinToCurrentRegionConfiguration()\n     }\n \n     @Test\n-    public void testInstanceCredentialsEnabled()\n+    public void testAssumeRoleCredentials()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY0NDc2Mg=="}, "originalCommit": {"oid": "90ebcf670085265ae803231e034ea6713b6a9508"}, "originalPosition": 22}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3494, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}