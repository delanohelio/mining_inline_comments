{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE5OTUxNzQ1", "number": 14557, "title": "Introduce table cache quota to HiveConnector", "bodyText": "== RELEASE NOTES ==\n\nHive Changes\n* Introduced cache quota with respect to a scope. A scope could be at global, schema, table, or partition level. Cache quota prevents queries scanning too much data to disrupt cache locality. Such queries can only use the cache within their own scopes. Cache quota now only works with `FILE_MERGE` cache. Turn it on with config `cache.cache-quota-scope` and `cache.default-cache-quota`.\n\nFor further potential steps (as following PR)\n\nRead the table quota and whitelist from FB internal configuration system\nBreak the dependency between presto-hive and presto-cache\nAdd support for CATALOG level quota if needed\n\nProject doc: https://docs.google.com/document/d/1FDcPG3okhs4tfQ3ABF-5yAJSkV4PaSmIHytfn1JNft0/edit?usp=sharing", "createdAt": "2020-05-19T08:11:22Z", "url": "https://github.com/prestodb/presto/pull/14557", "merged": true, "mergeCommit": {"oid": "4db99a82ae8499a79615dc59fb7d730a40e72e59"}, "closed": true, "closedAt": "2020-06-04T00:45:11Z", "author": {"login": "kewang1024"}, "timelineItems": {"totalCount": 48, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABci4aa9gFqTQxNDY4ODg2NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcntmM7gBqjM0MDM0NTUzNjg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0Njg4ODY0", "url": "https://github.com/prestodb/presto/pull/14557#pullrequestreview-414688864", "createdAt": "2020-05-19T17:54:13Z", "commit": {"oid": "8f3c64fe6ffa3b76c1ccb8eefb6b18aa92142193"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNzo1NDoxM1rOGXsAyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNzo1NzozOFrOGXsJtw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ5MTUzMQ==", "bodyText": "Given we have three states here, have we considered using enum as opposed to Optional<Boolean>.", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r427491531", "createdAt": "2020-05-19T17:54:13Z", "author": {"login": "shixuan-fan"}, "path": "presto-cache/src/main/java/com/facebook/presto/cache/CacheManager.java", "diffHunk": "@@ -13,22 +13,27 @@\n  */\n package com.facebook.presto.cache;\n \n+import com.facebook.presto.hive.HiveFileContext;\n import io.airlift.slice.Slice;\n \n import javax.annotation.concurrent.ThreadSafe;\n \n+import java.util.Optional;\n+\n @ThreadSafe\n public interface CacheManager\n {\n     /**\n      * Given {@param request}, check if the data is in cache.\n-     * If it is not in cache, return false.\n-     * Otherwise, save the data in {@param buffer} starting at {@param offset} and return true.\n+     * If it is in cache, save the data in {@param buffer} starting at {@param offset} and return Optional.of(True).\n+     * If it is not in cache:\n+     *      1. If there is still cache quota for this table, return Optional.of(False)\n+     *      2. Otherwise, return Optional.empty()\n      */\n-    boolean get(FileReadRequest request, byte[] buffer, int offset);\n+    Optional<Boolean> get(HiveFileContext hiveFileContext, FileReadRequest request, byte[] buffer, int offset);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f3c64fe6ffa3b76c1ccb8eefb6b18aa92142193"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ5MjE0OA==", "bodyText": "Shouldn't this be a DataSize instead?", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r427492148", "createdAt": "2020-05-19T17:55:06Z", "author": {"login": "shixuan-fan"}, "path": "presto-cache/src/main/java/com/facebook/presto/cache/filemerge/FileMergeCacheManager.java", "diffHunk": "@@ -76,6 +79,7 @@\n     private static final String EXTENSION = \".cache\";\n \n     private static final int FILE_MERGE_BUFFER_SIZE = toIntExact(new DataSize(8, MEGABYTE).toBytes());\n+    private static final long perTableCacheQuota = 100;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f3c64fe6ffa3b76c1ccb8eefb6b18aa92142193"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ5Mjg3OA==", "bodyText": "Probably extract this to a method so we don't need to add the comment below.", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r427492878", "createdAt": "2020-05-19T17:56:08Z", "author": {"login": "shixuan-fan"}, "path": "presto-cache/src/main/java/com/facebook/presto/cache/filemerge/FileMergeCacheManager.java", "diffHunk": "@@ -161,17 +166,43 @@ public boolean get(FileReadRequest request, byte[] buffer, int offset)\n             stats.incrementCacheMiss();\n         }\n \n-        return result;\n+        if (!result && hiveFileContext.getQuota().isPresent() && getCacheSize(hiveFileContext.getTable()) + request.getLength() > hiveFileContext.getQuota().getAsLong()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f3c64fe6ffa3b76c1ccb8eefb6b18aa92142193"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ5MzgxNQ==", "bodyText": "Maybe we should update the current cache usage here given there is an eviction event?", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r427493815", "createdAt": "2020-05-19T17:57:38Z", "author": {"login": "shixuan-fan"}, "path": "presto-cache/src/main/java/com/facebook/presto/cache/filemerge/FileMergeCacheManager.java", "diffHunk": "@@ -472,13 +495,14 @@ public ReadWriteLock getLock()\n     }\n \n     private class CacheRemovalListener\n-            implements RemovalListener<Path, Boolean>\n+            implements RemovalListener<Path, String>\n     {\n         @Override\n-        public void onRemoval(RemovalNotification<Path, Boolean> notification)\n+        public void onRemoval(RemovalNotification<Path, String> notification)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f3c64fe6ffa3b76c1ccb8eefb6b18aa92142193"}, "originalPosition": 119}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0OTI5MDUw", "url": "https://github.com/prestodb/presto/pull/14557#pullrequestreview-414929050", "createdAt": "2020-05-20T01:19:22Z", "commit": {"oid": "8f3c64fe6ffa3b76c1ccb8eefb6b18aa92142193"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQwMToxOToyMlrOGX4BTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQwMToxOToyMlrOGX4BTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY4ODI3MQ==", "bodyText": "I think we should not introduce cache quota here, we can leave this as it is. The only part which should worry about cacheQuota is cache writing methods(put).", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r427688271", "createdAt": "2020-05-20T01:19:22Z", "author": {"login": "jainxrohit"}, "path": "presto-cache/src/main/java/com/facebook/presto/cache/filemerge/FileMergeCachingInputStream.java", "diffHunk": "@@ -51,9 +55,16 @@ public void readFully(long position, byte[] buffer, int offset, int length)\n     {\n         FileReadRequest key = new FileReadRequest(path, position, length);\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f3c64fe6ffa3b76c1ccb8eefb6b18aa92142193"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0OTI5NzUz", "url": "https://github.com/prestodb/presto/pull/14557#pullrequestreview-414929753", "createdAt": "2020-05-20T01:21:45Z", "commit": {"oid": "8f3c64fe6ffa3b76c1ccb8eefb6b18aa92142193"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQwMToyMTo0NVrOGX4Dvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQwMToyMTo0NVrOGX4Dvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY4ODg5NQ==", "bodyText": "qutoa => tableQuota?", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r427688895", "createdAt": "2020-05-20T01:21:45Z", "author": {"login": "jainxrohit"}, "path": "presto-hive-common/src/main/java/com/facebook/presto/hive/HiveFileContext.java", "diffHunk": "@@ -14,19 +14,24 @@\n package com.facebook.presto.hive;\n \n import java.util.Optional;\n+import java.util.OptionalLong;\n \n import static java.util.Objects.requireNonNull;\n \n public class HiveFileContext\n {\n-    public static final HiveFileContext DEFAULT_HIVE_FILE_CONTEXT = new HiveFileContext(false, Optional.empty());\n+    public static final HiveFileContext DEFAULT_HIVE_FILE_CONTEXT = new HiveFileContext(false, \"dummy\", OptionalLong.of(0), Optional.empty());\n \n     private final boolean cacheable;\n+    private final String table;\n+    private final OptionalLong quota;\n     private final Optional<ExtraHiveFileInfo<?>> extraFileInfo;\n \n-    public HiveFileContext(boolean cacheable, Optional<ExtraHiveFileInfo<?>> extraFileInfo)\n+    public HiveFileContext(boolean cacheable, String table, OptionalLong quota, Optional<ExtraHiveFileInfo<?>> extraFileInfo)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f3c64fe6ffa3b76c1ccb8eefb6b18aa92142193"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0OTMwNTY5", "url": "https://github.com/prestodb/presto/pull/14557#pullrequestreview-414930569", "createdAt": "2020-05-20T01:24:26Z", "commit": {"oid": "8f3c64fe6ffa3b76c1ccb8eefb6b18aa92142193"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQwMToyNDoyNlrOGX4Geg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQwMToyNDoyNlrOGX4Geg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY4OTU5NA==", "bodyText": "This looks off. Doesn't seem like a correct place.", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r427689594", "createdAt": "2020-05-20T01:24:26Z", "author": {"login": "jainxrohit"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplit.java", "diffHunk": "@@ -62,6 +64,7 @@\n     public HiveSplit(\n             @JsonProperty(\"database\") String database,\n             @JsonProperty(\"table\") String table,\n+            @JsonProperty(\"tableCacheQuota\") OptionalLong tableCacheQuota,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f3c64fe6ffa3b76c1ccb8eefb6b18aa92142193"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0OTUzODQx", "url": "https://github.com/prestodb/presto/pull/14557#pullrequestreview-414953841", "createdAt": "2020-05-20T02:40:12Z", "commit": {"oid": "8f3c64fe6ffa3b76c1ccb8eefb6b18aa92142193"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQwMjo0MDoxMlrOGX5VEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQwNzoxNjoyOVrOGX-Qdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzcwOTcxNA==", "bodyText": "Rather than fixing this to be \"table\", we can generalize this to be schema, catalog, global, partition, etc. This means that we could have per-table, per-schema, per-catalog, per-partition, global quota etc. I'm not good at naming but potentially we could call schema, catalog, global, partition, table as \"CacheScope\" and this to be \"CacheScopeHandle\". Note that a \"Scope\" should have a distinct set of files so we don't over or under count. That means we won't be able to handle more fine-grained quota like per-user quota. But that should be fine for many use cases already.\nenum CacheScope\n{\n    GLOBAL, CATALOG, SCHEMA, TABLE, PARTITION\n}\n\nabstract class CacheScopeHandle<T>\n{\n    private final T identity;\n\n    long getIdentifier();\n}\nWith this approach, you could unify the global quota and per-XXX quota", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r427709714", "createdAt": "2020-05-20T02:40:12Z", "author": {"login": "highker"}, "path": "presto-hive-common/src/main/java/com/facebook/presto/hive/HiveFileContext.java", "diffHunk": "@@ -14,19 +14,24 @@\n package com.facebook.presto.hive;\n \n import java.util.Optional;\n+import java.util.OptionalLong;\n \n import static java.util.Objects.requireNonNull;\n \n public class HiveFileContext\n {\n-    public static final HiveFileContext DEFAULT_HIVE_FILE_CONTEXT = new HiveFileContext(false, Optional.empty());\n+    public static final HiveFileContext DEFAULT_HIVE_FILE_CONTEXT = new HiveFileContext(false, \"dummy\", OptionalLong.of(0), Optional.empty());\n \n     private final boolean cacheable;\n+    private final String table;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f3c64fe6ffa3b76c1ccb8eefb6b18aa92142193"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzcwOTkxOA==", "bodyText": "Actually, we should always have quota instead of optional. We could potentially set it to be infinite to indicate there is no limit.", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r427709918", "createdAt": "2020-05-20T02:41:04Z", "author": {"login": "highker"}, "path": "presto-hive-common/src/main/java/com/facebook/presto/hive/HiveFileContext.java", "diffHunk": "@@ -14,19 +14,24 @@\n package com.facebook.presto.hive;\n \n import java.util.Optional;\n+import java.util.OptionalLong;\n \n import static java.util.Objects.requireNonNull;\n \n public class HiveFileContext\n {\n-    public static final HiveFileContext DEFAULT_HIVE_FILE_CONTEXT = new HiveFileContext(false, Optional.empty());\n+    public static final HiveFileContext DEFAULT_HIVE_FILE_CONTEXT = new HiveFileContext(false, \"dummy\", OptionalLong.of(0), Optional.empty());\n \n     private final boolean cacheable;\n+    private final String table;\n+    private final OptionalLong quota;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f3c64fe6ffa3b76c1ccb8eefb6b18aa92142193"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzc4Njg1Ng==", "bodyText": "private final Map<Long, Set<Path>> scopeFiles = new ConcurrentHashMap<>();, where Long is gotten from CacheScopeHandle.getIdentifier()", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r427786856", "createdAt": "2020-05-20T07:08:49Z", "author": {"login": "highker"}, "path": "presto-cache/src/main/java/com/facebook/presto/cache/filemerge/FileMergeCacheManager.java", "diffHunk": "@@ -85,7 +89,8 @@\n     // a mapping from remote file `F` to a range map `M`; the corresponding local cache file for each range in `M` represents the cached chunk of `F`\n     private final Map<Path, CacheRange> persistedRanges = new ConcurrentHashMap<>();\n     // a local cache only to control the lifecycle of persisted\n-    private final Cache<Path, Boolean> cache;\n+    private final Cache<Path, String> cache;\n+    private final Map<String, Set<Path>> tableFiles = new ConcurrentHashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f3c64fe6ffa3b76c1ccb8eefb6b18aa92142193"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzc4ODQ2Ng==", "bodyText": "You need to grab the read lock for range cacheRange.getLock().readLock(). CacheRange is not thread safe without lock.", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r427788466", "createdAt": "2020-05-20T07:12:27Z", "author": {"login": "highker"}, "path": "presto-cache/src/main/java/com/facebook/presto/cache/filemerge/FileMergeCacheManager.java", "diffHunk": "@@ -161,17 +166,43 @@ public boolean get(FileReadRequest request, byte[] buffer, int offset)\n             stats.incrementCacheMiss();\n         }\n \n-        return result;\n+        if (!result && hiveFileContext.getQuota().isPresent() && getCacheSize(hiveFileContext.getTable()) + request.getLength() > hiveFileContext.getQuota().getAsLong()) {\n+            // it is not cached and we don't have enough cache quota to store\n+            return Optional.empty();\n+        }\n+\n+        try {\n+            // hint the cache\n+            cache.get(request.getPath(), hiveFileContext::getTable);\n+        }\n+        catch (ExecutionException e) {\n+            // ignore\n+        }\n+        return Optional.of(result);\n+    }\n+\n+    private long getCacheSize(String table)\n+    {\n+        long sum = 0;\n+        for (Path path : tableFiles.get(table)) {\n+            for (Range<Long> range : persistedRanges.get(path).getRange().asDescendingMapOfRanges().keySet()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f3c64fe6ffa3b76c1ccb8eefb6b18aa92142193"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzc5MDE4MA==", "bodyText": "Agree. We should not have cache quota check on any read path. We only check cache quota on put.", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r427790180", "createdAt": "2020-05-20T07:15:58Z", "author": {"login": "highker"}, "path": "presto-cache/src/main/java/com/facebook/presto/cache/filemerge/FileMergeCachingInputStream.java", "diffHunk": "@@ -51,9 +55,16 @@ public void readFully(long position, byte[] buffer, int offset, int length)\n     {\n         FileReadRequest key = new FileReadRequest(path, position, length);\n ", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY4ODI3MQ=="}, "originalCommit": {"oid": "8f3c64fe6ffa3b76c1ccb8eefb6b18aa92142193"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzc5MDQ1NA==", "bodyText": "Same, we don't wanna check quota on read. Move the checking and persisting cache logic to write.", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r427790454", "createdAt": "2020-05-20T07:16:29Z", "author": {"login": "highker"}, "path": "presto-cache/src/main/java/com/facebook/presto/cache/filemerge/FileMergeCacheManager.java", "diffHunk": "@@ -161,17 +166,43 @@ public boolean get(FileReadRequest request, byte[] buffer, int offset)\n             stats.incrementCacheMiss();\n         }\n \n-        return result;\n+        if (!result && hiveFileContext.getQuota().isPresent() && getCacheSize(hiveFileContext.getTable()) + request.getLength() > hiveFileContext.getQuota().getAsLong()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ5Mjg3OA=="}, "originalCommit": {"oid": "8f3c64fe6ffa3b76c1ccb8eefb6b18aa92142193"}, "originalPosition": 54}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8f3c64fe6ffa3b76c1ccb8eefb6b18aa92142193", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/8f3c64fe6ffa3b76c1ccb8eefb6b18aa92142193", "committedDate": "2020-05-19T07:52:54Z", "message": "Introduce table cache quota to HiveConnector"}, "afterCommit": {"oid": "85833a76850e40e07f298657431118b8bfe22476", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/85833a76850e40e07f298657431118b8bfe22476", "committedDate": "2020-05-23T04:40:55Z", "message": "Add cache quota support for hive connector"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "85833a76850e40e07f298657431118b8bfe22476", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/85833a76850e40e07f298657431118b8bfe22476", "committedDate": "2020-05-23T04:40:55Z", "message": "Add cache quota support for hive connector"}, "afterCommit": {"oid": "16c7cb54e0bd893744f0c1ee573b2295645bfb78", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/16c7cb54e0bd893744f0c1ee573b2295645bfb78", "committedDate": "2020-05-23T04:42:15Z", "message": "Add cache quota support for hive connector"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "16c7cb54e0bd893744f0c1ee573b2295645bfb78", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/16c7cb54e0bd893744f0c1ee573b2295645bfb78", "committedDate": "2020-05-23T04:42:15Z", "message": "Add cache quota support for hive connector"}, "afterCommit": {"oid": "f4b73f03f6f01f257aef9b1c92d3f327a49ff22b", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/f4b73f03f6f01f257aef9b1c92d3f327a49ff22b", "committedDate": "2020-05-24T18:13:22Z", "message": "Add cache quota support for hive connector"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f4b73f03f6f01f257aef9b1c92d3f327a49ff22b", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/f4b73f03f6f01f257aef9b1c92d3f327a49ff22b", "committedDate": "2020-05-24T18:13:22Z", "message": "Add cache quota support for hive connector"}, "afterCommit": {"oid": "2aa1bd77f9f1cc3dc8bfdc48e49437779a2de0af", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/2aa1bd77f9f1cc3dc8bfdc48e49437779a2de0af", "committedDate": "2020-05-24T19:05:16Z", "message": "Add cache quota support for hive connector"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2aa1bd77f9f1cc3dc8bfdc48e49437779a2de0af", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/2aa1bd77f9f1cc3dc8bfdc48e49437779a2de0af", "committedDate": "2020-05-24T19:05:16Z", "message": "Add cache quota support for hive connector"}, "afterCommit": {"oid": "146e2a735dda64c3acb8259a56f94a8f2ec2687c", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/146e2a735dda64c3acb8259a56f94a8f2ec2687c", "committedDate": "2020-05-24T19:07:22Z", "message": "Add cache quota support for hive connector"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3NDg3NTIw", "url": "https://github.com/prestodb/presto/pull/14557#pullrequestreview-417487520", "createdAt": "2020-05-25T06:42:31Z", "commit": {"oid": "146e2a735dda64c3acb8259a56f94a8f2ec2687c"}, "state": "COMMENTED", "comments": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQwNjo0MjozMlrOGZ2Qsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQwNzoyNDowOFrOGZ3OHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc1NjU5NQ==", "bodyText": "Put javadoc for each entry inline. Check QueryState as an example.", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r429756595", "createdAt": "2020-05-25T06:42:32Z", "author": {"login": "highker"}, "path": "presto-cache/src/main/java/com/facebook/presto/cache/filemerge/CacheResult.java", "diffHunk": "@@ -0,0 +1,26 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.cache.filemerge;\n+\n+/**\n+ * IN_CACHE represents the data we're reading is in cache", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "146e2a735dda64c3acb8259a56f94a8f2ec2687c"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc1Njg3NA==", "bodyText": "Not used?", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r429756874", "createdAt": "2020-05-25T06:43:23Z", "author": {"login": "highker"}, "path": "presto-cache/src/main/java/com/facebook/presto/cache/filemerge/FileMergeCacheManager.java", "diffHunk": "@@ -76,6 +79,7 @@\n     private static final String EXTENSION = \".cache\";\n \n     private static final int FILE_MERGE_BUFFER_SIZE = toIntExact(new DataSize(8, MEGABYTE).toBytes());\n+    private static final DataSize perTableCacheQuota = DataSize.succinctBytes(100);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "146e2a735dda64c3acb8259a56f94a8f2ec2687c"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc1NzA0MQ==", "bodyText": "else { is redundant", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r429757041", "createdAt": "2020-05-25T06:43:52Z", "author": {"login": "highker"}, "path": "presto-cache/src/main/java/com/facebook/presto/cache/filemerge/FileMergeCacheManager.java", "diffHunk": "@@ -161,17 +168,64 @@ public boolean get(FileReadRequest request, byte[] buffer, int offset)\n             stats.incrementCacheMiss();\n         }\n \n-        return result;\n+        if (!result && ifExceedQuota(cacheQuota, request)) {\n+            return CacheResult.CACHE_QUOTA_EXCEED;\n+        }\n+\n+        try {\n+            // hint the cache\n+            cache.get(request.getPath(), cacheQuota::getIdentifier);\n+        }\n+        catch (ExecutionException e) {\n+            // ignore\n+        }\n+\n+        if (result) {\n+            return CacheResult.IN_CACHE;\n+        }\n+        else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "146e2a735dda64c3acb8259a56f94a8f2ec2687c"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc1NzE2MQ==", "bodyText": "static", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r429757161", "createdAt": "2020-05-25T06:44:11Z", "author": {"login": "highker"}, "path": "presto-cache/src/main/java/com/facebook/presto/cache/filemerge/FileMergeCacheManager.java", "diffHunk": "@@ -161,17 +168,64 @@ public boolean get(FileReadRequest request, byte[] buffer, int offset)\n             stats.incrementCacheMiss();\n         }\n \n-        return result;\n+        if (!result && ifExceedQuota(cacheQuota, request)) {\n+            return CacheResult.CACHE_QUOTA_EXCEED;\n+        }\n+\n+        try {\n+            // hint the cache\n+            cache.get(request.getPath(), cacheQuota::getIdentifier);\n+        }\n+        catch (ExecutionException e) {\n+            // ignore\n+        }\n+\n+        if (result) {\n+            return CacheResult.IN_CACHE;\n+        }\n+        else {\n+            return CacheResult.NOT_IN_CACHE;\n+        }\n+    }\n+\n+    private boolean ifExceedQuota(CacheQuota cacheQuota, FileReadRequest request)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "146e2a735dda64c3acb8259a56f94a8f2ec2687c"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc1NzMxMQ==", "bodyText": "long\ngetCacheScopeSizeInBytes\nThis is an extremely expensive call that should not be tested for every read that misses a cache. Rather, we should have a single background thread populating the cache size for each scope and save it in Map<Long, Long>.", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r429757311", "createdAt": "2020-05-25T06:44:37Z", "author": {"login": "highker"}, "path": "presto-cache/src/main/java/com/facebook/presto/cache/filemerge/FileMergeCacheManager.java", "diffHunk": "@@ -161,17 +168,64 @@ public boolean get(FileReadRequest request, byte[] buffer, int offset)\n             stats.incrementCacheMiss();\n         }\n \n-        return result;\n+        if (!result && ifExceedQuota(cacheQuota, request)) {\n+            return CacheResult.CACHE_QUOTA_EXCEED;\n+        }\n+\n+        try {\n+            // hint the cache\n+            cache.get(request.getPath(), cacheQuota::getIdentifier);\n+        }\n+        catch (ExecutionException e) {\n+            // ignore\n+        }\n+\n+        if (result) {\n+            return CacheResult.IN_CACHE;\n+        }\n+        else {\n+            return CacheResult.NOT_IN_CACHE;\n+        }\n+    }\n+\n+    private boolean ifExceedQuota(CacheQuota cacheQuota, FileReadRequest request)\n+    {\n+        DataSize cacheSize = DataSize.succinctBytes(getCacheScopeSize(cacheQuota.getIdentifier()) + request.getLength());\n+        Optional<DataSize> quota = cacheQuota.getQuota();\n+        return quota.isPresent() && (cacheSize.compareTo(quota.get()) > 0);\n+    }\n+\n+    private long getCacheScopeSize(Long cacheScopeIdentifier)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "146e2a735dda64c3acb8259a56f94a8f2ec2687c"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc1ODg2Mw==", "bodyText": "Move it to CacheConfig", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r429758863", "createdAt": "2020-05-25T06:48:56Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveClientConfig.java", "diffHunk": "@@ -167,6 +168,7 @@\n     private List<String> fileStatusCacheTables = ImmutableList.of();\n \n     private DataSize pageFileStripeMaxSize = new DataSize(24, MEGABYTE);\n+    private CacheQuotaScope cacheQuotaScope = GLOBAL;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "146e2a735dda64c3acb8259a56f94a8f2ec2687c"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc1OTMwMw==", "bodyText": "Remove this session property. Scope is from config directly.", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r429759303", "createdAt": "2020-05-25T06:50:13Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSessionProperties.java", "diffHunk": "@@ -100,6 +100,7 @@\n     public static final String OFFLINE_DATA_DEBUG_MODE_ENABLED = \"offline_data_debug_mode_enabled\";\n     public static final String FAIL_FAST_ON_INSERT_INTO_IMMUTABLE_PARTITIONS_ENABLED = \"fail_fast_on_insert_into_immutable_partitions_enabled\";\n     public static final String USE_LIST_DIRECTORY_CACHE = \"use_list_directory_cache\";\n+    public static final String CACHE_QUOTA_SCOPE = \"cache_quota_scope\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "146e2a735dda64c3acb8259a56f94a8f2ec2687c"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc1OTk2MQ==", "bodyText": "Create a default value in CacheConfig and get the value from there", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r429759961", "createdAt": "2020-05-25T06:52:05Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitSource.java", "diffHunk": "@@ -465,9 +480,23 @@ void fail(Throwable e)\n                     splitBytes = internalSplit.getEnd() - internalSplit.getStart();\n                 }\n \n+                CacheQuota cacheQuota;\n+                // todo: read from config\n+                DataSize cacheQuotaSize = DataSize.succinctDataSize(10, DataSize.Unit.GIGABYTE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "146e2a735dda64c3acb8259a56f94a8f2ec2687c"}, "originalPosition": 106}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc2MTUwMQ==", "bodyText": "We don't have to have this logic in this PR. If we do wanna have it, make it map to denote what special scopes as what quota.", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r429761501", "createdAt": "2020-05-25T06:56:17Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitSource.java", "diffHunk": "@@ -465,9 +480,23 @@ void fail(Throwable e)\n                     splitBytes = internalSplit.getEnd() - internalSplit.getStart();\n                 }\n \n+                CacheQuota cacheQuota;\n+                // todo: read from config\n+                DataSize cacheQuotaSize = DataSize.succinctDataSize(10, DataSize.Unit.GIGABYTE);\n+                Set<String> cacheQuotaWhiteList = ImmutableSet.of();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "146e2a735dda64c3acb8259a56f94a8f2ec2687c"}, "originalPosition": 107}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc2MTc1Nw==", "bodyText": "We should have logic for other scopes", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r429761757", "createdAt": "2020-05-25T06:57:04Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitSource.java", "diffHunk": "@@ -465,9 +480,23 @@ void fail(Throwable e)\n                     splitBytes = internalSplit.getEnd() - internalSplit.getStart();\n                 }\n \n+                CacheQuota cacheQuota;\n+                // todo: read from config\n+                DataSize cacheQuotaSize = DataSize.succinctDataSize(10, DataSize.Unit.GIGABYTE);\n+                Set<String> cacheQuotaWhiteList = ImmutableSet.of();\n+                switch(cacheQuotaScope) {\n+                    case TABLE:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "146e2a735dda64c3acb8259a56f94a8f2ec2687c"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc2Mjk1OQ==", "bodyText": "CacheQuota<?> cacheQuota;", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r429762959", "createdAt": "2020-05-25T07:00:29Z", "author": {"login": "highker"}, "path": "presto-hive-common/src/main/java/com/facebook/presto/hive/HiveFileContext.java", "diffHunk": "@@ -15,18 +15,21 @@\n \n import java.util.Optional;\n \n+import static com.facebook.presto.hive.CacheQuotaScope.TABLE;\n import static java.util.Objects.requireNonNull;\n \n public class HiveFileContext\n {\n-    public static final HiveFileContext DEFAULT_HIVE_FILE_CONTEXT = new HiveFileContext(false, Optional.empty());\n+    public static final HiveFileContext DEFAULT_HIVE_FILE_CONTEXT = new HiveFileContext(false, new CacheQuota(TABLE, \"test\", Optional.empty()), Optional.empty());\n \n     private final boolean cacheable;\n+    private final CacheQuota cacheQuota;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "146e2a735dda64c3acb8259a56f94a8f2ec2687c"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc2MzIyMA==", "bodyText": "This class has to be serializable. I can't quite recall if generic T can be serialized. (Maybe it could; but I can't find a good example). If it's too complicated, just make identity of type String so we don't have to worry about it.", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r429763220", "createdAt": "2020-05-25T07:01:08Z", "author": {"login": "highker"}, "path": "presto-hive-common/src/main/java/com/facebook/presto/hive/CacheQuota.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import io.airlift.units.DataSize;\n+\n+import java.util.Optional;\n+\n+import static com.facebook.presto.hive.CacheQuotaScope.GLOBAL;\n+import static com.google.common.hash.Hashing.md5;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+import static java.util.Objects.requireNonNull;\n+\n+public class CacheQuota<T>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "146e2a735dda64c3acb8259a56f94a8f2ec2687c"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc2NjAzNg==", "bodyText": "Remove the first TODO in this class: TODO: Make cache eviction based on cache...", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r429766036", "createdAt": "2020-05-25T07:08:39Z", "author": {"login": "highker"}, "path": "presto-cache/src/main/java/com/facebook/presto/cache/filemerge/FileMergeCacheManager.java", "diffHunk": "@@ -13,11 +13,13 @@\n  */\n package com.facebook.presto.cache.filemerge;\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "146e2a735dda64c3acb8259a56f94a8f2ec2687c"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc3MDM1Mw==", "bodyText": "We should use CacheQuota as well to match the one in get\nMove cacheQuota to the last param", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r429770353", "createdAt": "2020-05-25T07:19:46Z", "author": {"login": "highker"}, "path": "presto-cache/src/main/java/com/facebook/presto/cache/CacheManager.java", "diffHunk": "@@ -22,13 +24,16 @@\n {\n     /**\n      * Given {@param request}, check if the data is in cache.\n-     * If it is not in cache, return false.\n-     * Otherwise, save the data in {@param buffer} starting at {@param offset} and return true.\n+     * If it is in cache, save the data in {@param buffer} starting at {@param offset} and return IN_CACHE.\n+     * If it is not in cache:\n+     *      1. If there is still cache quota for this table, return NOT_IN_CACHE\n+     *      2. Otherwise, return CACHE_QUOTA_EXCEED\n+     * @return CacheResult\n      */\n-    boolean get(FileReadRequest request, byte[] buffer, int offset);\n+    CacheResult get(CacheQuota cacheQuota, FileReadRequest request, byte[] buffer, int offset);\n \n     /**\n      * Save data in cache\n      */\n-    void put(FileReadRequest request, Slice data);\n+    void put(long cacheScopeIdentifier, FileReadRequest request, Slice data);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "146e2a735dda64c3acb8259a56f94a8f2ec2687c"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc3MDU1Mw==", "bodyText": "Move cacheQuota to the last param", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r429770553", "createdAt": "2020-05-25T07:20:14Z", "author": {"login": "highker"}, "path": "presto-cache/src/main/java/com/facebook/presto/cache/CacheManager.java", "diffHunk": "@@ -22,13 +24,16 @@\n {\n     /**\n      * Given {@param request}, check if the data is in cache.\n-     * If it is not in cache, return false.\n-     * Otherwise, save the data in {@param buffer} starting at {@param offset} and return true.\n+     * If it is in cache, save the data in {@param buffer} starting at {@param offset} and return IN_CACHE.\n+     * If it is not in cache:\n+     *      1. If there is still cache quota for this table, return NOT_IN_CACHE\n+     *      2. Otherwise, return CACHE_QUOTA_EXCEED\n+     * @return CacheResult\n      */\n-    boolean get(FileReadRequest request, byte[] buffer, int offset);\n+    CacheResult get(CacheQuota cacheQuota, FileReadRequest request, byte[] buffer, int offset);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "146e2a735dda64c3acb8259a56f94a8f2ec2687c"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc3MTYzOQ==", "bodyText": "We should have stats for this state", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r429771639", "createdAt": "2020-05-25T07:22:43Z", "author": {"login": "highker"}, "path": "presto-cache/src/main/java/com/facebook/presto/cache/filemerge/FileMergeCacheManager.java", "diffHunk": "@@ -161,17 +168,64 @@ public boolean get(FileReadRequest request, byte[] buffer, int offset)\n             stats.incrementCacheMiss();\n         }\n \n-        return result;\n+        if (!result && ifExceedQuota(cacheQuota, request)) {\n+            return CacheResult.CACHE_QUOTA_EXCEED;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "146e2a735dda64c3acb8259a56f94a8f2ec2687c"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc3MjMxOQ==", "bodyText": "typo Scopre", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r429772319", "createdAt": "2020-05-25T07:24:08Z", "author": {"login": "highker"}, "path": "presto-cache/src/main/java/com/facebook/presto/cache/filemerge/FileMergeCacheManager.java", "diffHunk": "@@ -85,7 +89,10 @@\n     // a mapping from remote file `F` to a range map `M`; the corresponding local cache file for each range in `M` represents the cached chunk of `F`\n     private final Map<Path, CacheRange> persistedRanges = new ConcurrentHashMap<>();\n     // a local cache only to control the lifecycle of persisted\n-    private final Cache<Path, Boolean> cache;\n+    // Path and its corresponding cacheScope identifier\n+    private final Cache<Path, Long> cache;\n+    // CacheScopeHandle identifier to its cached files mapping\n+    private final Map<Long, Set<Path>> cacheScopreFiles = new ConcurrentHashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "146e2a735dda64c3acb8259a56f94a8f2ec2687c"}, "originalPosition": 38}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "146e2a735dda64c3acb8259a56f94a8f2ec2687c", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/146e2a735dda64c3acb8259a56f94a8f2ec2687c", "committedDate": "2020-05-24T19:07:22Z", "message": "Add cache quota support for hive connector"}, "afterCommit": {"oid": "e23bcf5a043e46f5a7002d8907917375f5c1750e", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/e23bcf5a043e46f5a7002d8907917375f5c1750e", "committedDate": "2020-05-26T05:10:38Z", "message": "Add cache quota support for hive connector"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3OTk4MDYy", "url": "https://github.com/prestodb/presto/pull/14557#pullrequestreview-417998062", "createdAt": "2020-05-26T06:19:53Z", "commit": {"oid": "e23bcf5a043e46f5a7002d8907917375f5c1750e"}, "state": "COMMENTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQwNjoxOTo1M1rOGaQCSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQwNjozNDoyM1rOGaQYWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDE3ODg5MQ==", "bodyText": "AlluxioCacheConfig.getMaxCacheSize() can be superseded by this call.", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r430178891", "createdAt": "2020-05-26T06:19:53Z", "author": {"login": "highker"}, "path": "presto-cache/src/main/java/com/facebook/presto/cache/CacheConfig.java", "diffHunk": "@@ -76,4 +83,26 @@ public CacheType getCacheType()\n     {\n         return cacheType;\n     }\n+\n+    public CacheQuotaScope getCacheQuotaScope()\n+    {\n+        return cacheQuotaScope;\n+    }\n+\n+    @Config(\"cache.cache-scope\")\n+    public void setCacheQuotaScope(CacheQuotaScope cacheQuotaScope)\n+    {\n+        this.cacheQuotaScope = cacheQuotaScope;\n+    }\n+\n+    public Optional<DataSize> getDefaultCacheQuota()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e23bcf5a043e46f5a7002d8907917375f5c1750e"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDE3OTQ5Mg==", "bodyText": "remove this as well", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r430179492", "createdAt": "2020-05-26T06:21:34Z", "author": {"login": "highker"}, "path": "presto-cache/src/main/java/com/facebook/presto/cache/filemerge/FileMergeCacheManager.java", "diffHunk": "@@ -65,7 +70,6 @@\n import static java.util.concurrent.TimeUnit.MILLISECONDS;\n \n // 3 major TODOs for this class:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e23bcf5a043e46f5a7002d8907917375f5c1750e"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDE3OTY0OA==", "bodyText": "cacheScopeSizeInBytes", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r430179648", "createdAt": "2020-05-26T06:21:57Z", "author": {"login": "highker"}, "path": "presto-cache/src/main/java/com/facebook/presto/cache/filemerge/FileMergeCacheManager.java", "diffHunk": "@@ -81,11 +85,16 @@\n \n     private final ExecutorService cacheFlushExecutor;\n     private final ExecutorService cacheRemovalExecutor;\n+    private final ScheduledExecutorService cacheSizeCalculateExecutor;\n \n     // a mapping from remote file `F` to a range map `M`; the corresponding local cache file for each range in `M` represents the cached chunk of `F`\n     private final Map<Path, CacheRange> persistedRanges = new ConcurrentHashMap<>();\n     // a local cache only to control the lifecycle of persisted\n-    private final Cache<Path, Boolean> cache;\n+    // Path and its corresponding cacheScope identifier\n+    private final Cache<Path, Long> cache;\n+    // CacheScopeHandle identifier to its cached files mapping\n+    private final Map<Long, Set<Path>> cacheScopeFiles = new ConcurrentHashMap<>();\n+    private final Map<Long, Long> cacheScopeSize = new ConcurrentHashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e23bcf5a043e46f5a7002d8907917375f5c1750e"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDE4MDMyNA==", "bodyText": "you don't need { }", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r430180324", "createdAt": "2020-05-26T06:23:42Z", "author": {"login": "highker"}, "path": "presto-cache/src/main/java/com/facebook/presto/cache/filemerge/FileMergeCacheManager.java", "diffHunk": "@@ -140,6 +151,11 @@ public FileMergeCacheManager(\n                 }\n             }));\n         }\n+\n+        this.cacheSizeCalculateExecutor.schedule(\n+                () -> { cacheScopeFiles.keySet().forEach(cacheIdentifier -> cacheScopeSize.put(cacheIdentifier, getCacheScopeSizeInBytes(cacheIdentifier))); },", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e23bcf5a043e46f5a7002d8907917375f5c1750e"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDE4MTIxNw==", "bodyText": "toString() is redundant", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r430181217", "createdAt": "2020-05-26T06:25:57Z", "author": {"login": "highker"}, "path": "presto-hive-common/src/main/java/com/facebook/presto/hive/CacheQuota.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import io.airlift.units.DataSize;\n+\n+import java.util.Optional;\n+\n+import static com.facebook.presto.hive.CacheQuotaScope.GLOBAL;\n+import static com.google.common.hash.Hashing.md5;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+import static java.util.Objects.requireNonNull;\n+\n+public class CacheQuota\n+{\n+    private CacheQuotaScope cacheQuotaScope;\n+    private final String identity;\n+    private final Optional<DataSize> quota;\n+\n+    public static final CacheQuota NO_CACHE_CONSTRAINS = new CacheQuota(GLOBAL, \"NO_IDENTITY\", Optional.empty());\n+\n+    public CacheQuota(CacheQuotaScope cacheQuotaScope, String identity, Optional<DataSize> quota)\n+    {\n+        this.cacheQuotaScope = requireNonNull(cacheQuotaScope, \"cacheScope is null\");\n+        this.identity = requireNonNull(identity, \"identity is null\");\n+        this.quota = requireNonNull(quota, \"quota is null\");\n+    }\n+\n+    public CacheQuotaScope getCacheQuotaScope()\n+    {\n+        return cacheQuotaScope;\n+    }\n+\n+    public long getIdentifier()\n+    {\n+        return md5().hashString(identity.toString(), UTF_8).asLong();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e23bcf5a043e46f5a7002d8907917375f5c1750e"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDE4MjY2MQ==", "bodyText": "Remove CATALOG given it's only for hive catalog", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r430182661", "createdAt": "2020-05-26T06:29:40Z", "author": {"login": "highker"}, "path": "presto-hive-common/src/main/java/com/facebook/presto/hive/CacheQuotaScope.java", "diffHunk": "@@ -0,0 +1,19 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+public enum CacheQuotaScope\n+{\n+    GLOBAL, CATALOG, SCHEMA, TABLE, PARTITION", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e23bcf5a043e46f5a7002d8907917375f5c1750e"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDE4NDE5OA==", "bodyText": "You don't need to do any refactoring to achieve this:\n\nGLOBAL: \".\"\nSCHEMA: databaseName\nTABLE: databaseName + \".\" + tableName \nPARTITION: databaseName + \".\" + tableName + \".\" + internalSplit.getPartitionName()\n\nIt is very important to keep in mind that without fully qualified names, subscopes can have duplication even they are not.", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r430184198", "createdAt": "2020-05-26T06:33:32Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitSource.java", "diffHunk": "@@ -465,9 +480,23 @@ void fail(Throwable e)\n                     splitBytes = internalSplit.getEnd() - internalSplit.getStart();\n                 }\n \n+                CacheQuota cacheQuota;\n+                // todo: read from config\n+                DataSize cacheQuotaSize = DataSize.succinctDataSize(10, DataSize.Unit.GIGABYTE);\n+                Set<String> cacheQuotaWhiteList = ImmutableSet.of();\n+                switch(cacheQuotaScope) {\n+                    case TABLE:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc2MTc1Nw=="}, "originalCommit": {"oid": "146e2a735dda64c3acb8259a56f94a8f2ec2687c"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDE4NDUzNw==", "bodyText": "throw exception", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r430184537", "createdAt": "2020-05-26T06:34:23Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitSource.java", "diffHunk": "@@ -465,9 +487,23 @@ void fail(Throwable e)\n                     splitBytes = internalSplit.getEnd() - internalSplit.getStart();\n                 }\n \n+                CacheQuota cacheQuota;\n+                switch (cacheQuotaScope) {\n+                    case TABLE:\n+                        cacheQuota = new CacheQuota(TABLE, tableName, defaultCacheQuota);\n+                        break;\n+                    case PARTITION:\n+                        cacheQuota = new CacheQuota(PARTITION, internalSplit.getPartitionName(), defaultCacheQuota);\n+                        break;\n+                    default:\n+                        // todo: add cache quota support for other scope\n+                        cacheQuota = NO_CACHE_CONSTRAINS;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e23bcf5a043e46f5a7002d8907917375f5c1750e"}, "originalPosition": 113}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4NTI0MTE4", "url": "https://github.com/prestodb/presto/pull/14557#pullrequestreview-418524118", "createdAt": "2020-05-26T17:33:03Z", "commit": {"oid": "e23bcf5a043e46f5a7002d8907917375f5c1750e"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxNzozMzowM1rOGao7_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxNzo0MjoyMFrOGapRDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDU4Njg3OA==", "bodyText": "nit: Did you mean to say \"write them to cache\"?", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r430586878", "createdAt": "2020-05-26T17:33:03Z", "author": {"login": "shixuan-fan"}, "path": "presto-cache/src/main/java/com/facebook/presto/cache/filemerge/CacheResult.java", "diffHunk": "@@ -0,0 +1,30 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.cache.filemerge;\n+\n+public enum CacheResult\n+{\n+    /**\n+     * The data we're reading is in cache\n+     */\n+    IN_CACHE,\n+    /**\n+     * The data we're reading is not in cache and we have quota to read them to cache", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e23bcf5a043e46f5a7002d8907917375f5c1750e"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDU5MDA2Ng==", "bodyText": "nit: NO_CACHE_CONSTRAINTS?", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r430590066", "createdAt": "2020-05-26T17:38:34Z", "author": {"login": "shixuan-fan"}, "path": "presto-hive-common/src/main/java/com/facebook/presto/hive/CacheQuota.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import io.airlift.units.DataSize;\n+\n+import java.util.Optional;\n+\n+import static com.facebook.presto.hive.CacheQuotaScope.GLOBAL;\n+import static com.google.common.hash.Hashing.md5;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+import static java.util.Objects.requireNonNull;\n+\n+public class CacheQuota\n+{\n+    private CacheQuotaScope cacheQuotaScope;\n+    private final String identity;\n+    private final Optional<DataSize> quota;\n+\n+    public static final CacheQuota NO_CACHE_CONSTRAINS = new CacheQuota(GLOBAL, \"NO_IDENTITY\", Optional.empty());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e23bcf5a043e46f5a7002d8907917375f5c1750e"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDU5MDc1NA==", "bodyText": "I'm not particularly sure because it is possible to have multiple hive connectors under different connector names, and thus multiple catalogs.", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r430590754", "createdAt": "2020-05-26T17:39:43Z", "author": {"login": "shixuan-fan"}, "path": "presto-hive-common/src/main/java/com/facebook/presto/hive/CacheQuotaScope.java", "diffHunk": "@@ -0,0 +1,19 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+public enum CacheQuotaScope\n+{\n+    GLOBAL, CATALOG, SCHEMA, TABLE, PARTITION", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDE4MjY2MQ=="}, "originalCommit": {"oid": "e23bcf5a043e46f5a7002d8907917375f5c1750e"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDU5MjI3MQ==", "bodyText": "You probably need jackson annotation given this would be used in HiveSplit to pass from coordinator to worker.", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r430592271", "createdAt": "2020-05-26T17:42:20Z", "author": {"login": "shixuan-fan"}, "path": "presto-hive-common/src/main/java/com/facebook/presto/hive/CacheQuota.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import io.airlift.units.DataSize;\n+\n+import java.util.Optional;\n+\n+import static com.facebook.presto.hive.CacheQuotaScope.GLOBAL;\n+import static com.google.common.hash.Hashing.md5;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+import static java.util.Objects.requireNonNull;\n+\n+public class CacheQuota", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e23bcf5a043e46f5a7002d8907917375f5c1750e"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5NDcyODU1", "url": "https://github.com/prestodb/presto/pull/14557#pullrequestreview-419472855", "createdAt": "2020-05-27T17:52:44Z", "commit": {"oid": "e23bcf5a043e46f5a7002d8907917375f5c1750e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxNzo1Mjo0NFrOGbWfuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxNzo1Mjo0NFrOGbWfuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTMzMzMwNQ==", "bodyText": "Why it is called default? Isn't it the cacheQuota allocated for this config, it could be default or the one configured?", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r431333305", "createdAt": "2020-05-27T17:52:44Z", "author": {"login": "jainxrohit"}, "path": "presto-cache/src/main/java/com/facebook/presto/cache/CacheConfig.java", "diffHunk": "@@ -15,15 +15,22 @@\n \n import com.facebook.airlift.configuration.Config;\n import com.facebook.airlift.configuration.ConfigDescription;\n+import com.facebook.presto.hive.CacheQuotaScope;\n+import io.airlift.units.DataSize;\n \n import java.net.URI;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.hive.CacheQuotaScope.GLOBAL;\n \n public class CacheConfig\n {\n     private boolean cachingEnabled;\n     private CacheType cacheType;\n     private URI baseDirectory;\n     private boolean validationEnabled;\n+    private CacheQuotaScope cacheQuotaScope = GLOBAL;\n+    private Optional<DataSize> defaultCacheQuota = Optional.empty();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e23bcf5a043e46f5a7002d8907917375f5c1750e"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5NDg0NzEy", "url": "https://github.com/prestodb/presto/pull/14557#pullrequestreview-419484712", "createdAt": "2020-05-27T18:08:39Z", "commit": {"oid": "e23bcf5a043e46f5a7002d8907917375f5c1750e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxODowODozOVrOGbXKcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxODowODozOVrOGbXKcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTM0NDI0Mw==", "bodyText": "Do we need this? I thought it was already injected via CachingModule?", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r431344243", "createdAt": "2020-05-27T18:08:39Z", "author": {"login": "jainxrohit"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveClientModule.java", "diffHunk": "@@ -97,6 +98,7 @@ public void configure(Binder binder)\n         binder.bind(HdfsConfigurationInitializer.class).in(Scopes.SINGLETON);\n         newSetBinder(binder, DynamicConfigurationProvider.class);\n         configBinder(binder).bindConfig(HiveClientConfig.class);\n+        configBinder(binder).bindConfig(CacheConfig.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e23bcf5a043e46f5a7002d8907917375f5c1750e"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5NDg5NDk1", "url": "https://github.com/prestodb/presto/pull/14557#pullrequestreview-419489495", "createdAt": "2020-05-27T18:15:14Z", "commit": {"oid": "e23bcf5a043e46f5a7002d8907917375f5c1750e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxODoxNToxNVrOGbXZhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxODoxNToxNVrOGbXZhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTM0ODEwMA==", "bodyText": "I think we should just create hash at the initialization time.", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r431348100", "createdAt": "2020-05-27T18:15:15Z", "author": {"login": "jainxrohit"}, "path": "presto-hive-common/src/main/java/com/facebook/presto/hive/CacheQuota.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import io.airlift.units.DataSize;\n+\n+import java.util.Optional;\n+\n+import static com.facebook.presto.hive.CacheQuotaScope.GLOBAL;\n+import static com.google.common.hash.Hashing.md5;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+import static java.util.Objects.requireNonNull;\n+\n+public class CacheQuota\n+{\n+    private CacheQuotaScope cacheQuotaScope;\n+    private final String identity;\n+    private final Optional<DataSize> quota;\n+\n+    public static final CacheQuota NO_CACHE_CONSTRAINS = new CacheQuota(GLOBAL, \"NO_IDENTITY\", Optional.empty());\n+\n+    public CacheQuota(CacheQuotaScope cacheQuotaScope, String identity, Optional<DataSize> quota)\n+    {\n+        this.cacheQuotaScope = requireNonNull(cacheQuotaScope, \"cacheScope is null\");\n+        this.identity = requireNonNull(identity, \"identity is null\");\n+        this.quota = requireNonNull(quota, \"quota is null\");\n+    }\n+\n+    public CacheQuotaScope getCacheQuotaScope()\n+    {\n+        return cacheQuotaScope;\n+    }\n+\n+    public long getIdentifier()\n+    {\n+        return md5().hashString(identity.toString(), UTF_8).asLong();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e23bcf5a043e46f5a7002d8907917375f5c1750e"}, "originalPosition": 47}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5NTE3OTA3", "url": "https://github.com/prestodb/presto/pull/14557#pullrequestreview-419517907", "createdAt": "2020-05-27T18:54:54Z", "commit": {"oid": "e23bcf5a043e46f5a7002d8907917375f5c1750e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxODo1NDo1NFrOGbYvlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxODo1NDo1NFrOGbYvlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTM3MDEzMg==", "bodyText": "I think we discussed this. Didn't we think it would be better if we calculate these during put operation?", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r431370132", "createdAt": "2020-05-27T18:54:54Z", "author": {"login": "jainxrohit"}, "path": "presto-cache/src/main/java/com/facebook/presto/cache/filemerge/FileMergeCacheManager.java", "diffHunk": "@@ -151,27 +167,69 @@ public void destroy()\n     }\n \n     @Override\n-    public boolean get(FileReadRequest request, byte[] buffer, int offset)\n+    public CacheResult get(FileReadRequest request, byte[] buffer, int offset, CacheQuota cacheQuota)\n     {\n         boolean result = read(request, buffer, offset);\n+\n+        if (!result && ifExceedQuota(cacheQuota, request)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e23bcf5a043e46f5a7002d8907917375f5c1750e"}, "originalPosition": 90}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e23bcf5a043e46f5a7002d8907917375f5c1750e", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/e23bcf5a043e46f5a7002d8907917375f5c1750e", "committedDate": "2020-05-26T05:10:38Z", "message": "Add cache quota support for hive connector"}, "afterCommit": {"oid": "72418eb5ea5c4652582edceb91ffc3c2f04117d7", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/72418eb5ea5c4652582edceb91ffc3c2f04117d7", "committedDate": "2020-05-29T18:44:29Z", "message": "Add cache quota support for hive connector"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "72418eb5ea5c4652582edceb91ffc3c2f04117d7", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/72418eb5ea5c4652582edceb91ffc3c2f04117d7", "committedDate": "2020-05-29T18:44:29Z", "message": "Add cache quota support for hive connector"}, "afterCommit": {"oid": "a757b55fb32a06ce674facb113857be6fbac2eab", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/a757b55fb32a06ce674facb113857be6fbac2eab", "committedDate": "2020-05-29T23:54:40Z", "message": "Add cache quota support for hive connector"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxMzU3MjU2", "url": "https://github.com/prestodb/presto/pull/14557#pullrequestreview-421357256", "createdAt": "2020-05-30T00:17:20Z", "commit": {"oid": "a757b55fb32a06ce674facb113857be6fbac2eab"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxMzYwMjY5", "url": "https://github.com/prestodb/presto/pull/14557#pullrequestreview-421360269", "createdAt": "2020-05-30T00:38:36Z", "commit": {"oid": "a757b55fb32a06ce674facb113857be6fbac2eab"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0zMFQwMDozODozNlrOGcvjRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0zMFQwMDo1MjoxN1rOGcvp1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc5MjM4OQ==", "bodyText": "remove this class; check my comment below", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r432792389", "createdAt": "2020-05-30T00:38:36Z", "author": {"login": "highker"}, "path": "presto-cache/src/main/java/com/facebook/presto/cache/CacheErrorCode.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.cache;\n+\n+import com.facebook.presto.spi.ErrorCode;\n+import com.facebook.presto.spi.ErrorCodeSupplier;\n+import com.facebook.presto.spi.ErrorType;\n+\n+import static com.facebook.presto.spi.ErrorType.INTERNAL_ERROR;\n+\n+public enum CacheErrorCode", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a757b55fb32a06ce674facb113857be6fbac2eab"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc5MjQ4Ng==", "bodyText": "Use HIVE_UNKNOWN_ERROR", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r432792486", "createdAt": "2020-05-30T00:39:31Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveSplitSource.java", "diffHunk": "@@ -465,6 +485,23 @@ void fail(Throwable e)\n                     splitBytes = internalSplit.getEnd() - internalSplit.getStart();\n                 }\n \n+                CacheQuota cacheQuota;\n+                switch (cacheQuotaScope) {\n+                    case GLOBAL:\n+                        cacheQuota = new CacheQuota(\".\", configuredCacheQuota);\n+                        break;\n+                    case SCHEMA:\n+                        cacheQuota = new CacheQuota(databaseName, configuredCacheQuota);\n+                        break;\n+                    case TABLE:\n+                        cacheQuota = new CacheQuota(databaseName + \".\" + tableName, configuredCacheQuota);\n+                        break;\n+                    case PARTITION:\n+                        cacheQuota = new CacheQuota(databaseName + \".\" + tableName + \".\" + internalSplit.getPartitionName(), configuredCacheQuota);\n+                        break;\n+                    default:\n+                        throw new PrestoException(CACHE_SCOPE_NOT_SUPPORTED, format(\"%s is not supported\", cacheQuotaScope));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a757b55fb32a06ce674facb113857be6fbac2eab"}, "originalPosition": 116}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc5NDA2OQ==", "bodyText": "This will be called on the coordinator. One concern is the complexity of md5(). I'm not sure if md5() is more expensive or shipping the identity is..... To be save, I would just move this part of logic to getIdentifier() call.", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r432794069", "createdAt": "2020-05-30T00:52:17Z", "author": {"login": "highker"}, "path": "presto-hive-common/src/main/java/com/facebook/presto/hive/CacheQuota.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import io.airlift.units.DataSize;\n+\n+import java.util.Objects;\n+import java.util.Optional;\n+\n+import static com.google.common.hash.Hashing.md5;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+import static java.util.Objects.requireNonNull;\n+\n+public class CacheQuota\n+{\n+    private final long identifier;\n+    private final Optional<DataSize> quota;\n+\n+    public static final CacheQuota NO_CACHE_CONSTRAINTS = new CacheQuota(\"NO_IDENTITY\", Optional.empty());\n+\n+    public CacheQuota(String identity, Optional<DataSize> quota)\n+    {\n+        this(md5().hashString(identity, UTF_8).asLong(), quota);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a757b55fb32a06ce674facb113857be6fbac2eab"}, "originalPosition": 36}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a757b55fb32a06ce674facb113857be6fbac2eab", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/a757b55fb32a06ce674facb113857be6fbac2eab", "committedDate": "2020-05-29T23:54:40Z", "message": "Add cache quota support for hive connector"}, "afterCommit": {"oid": "c5f7627423bf250c7f6905846160e3f085b07a1f", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/c5f7627423bf250c7f6905846160e3f085b07a1f", "committedDate": "2020-05-30T19:29:52Z", "message": "Add cache quota support for hive connector"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c5f7627423bf250c7f6905846160e3f085b07a1f", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/c5f7627423bf250c7f6905846160e3f085b07a1f", "committedDate": "2020-05-30T19:29:52Z", "message": "Add cache quota support for hive connector"}, "afterCommit": {"oid": "a972e429bd017a9c29dfd5601cfbd1e8baa61b8c", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/a972e429bd017a9c29dfd5601cfbd1e8baa61b8c", "committedDate": "2020-05-30T19:31:48Z", "message": "Add cache quota support for hive connector"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a972e429bd017a9c29dfd5601cfbd1e8baa61b8c", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/a972e429bd017a9c29dfd5601cfbd1e8baa61b8c", "committedDate": "2020-05-30T19:31:48Z", "message": "Add cache quota support for hive connector"}, "afterCommit": {"oid": "f1726b4d6a4b8e9b1f9ddbb9fd534a1bebf7f492", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/f1726b4d6a4b8e9b1f9ddbb9fd534a1bebf7f492", "committedDate": "2020-05-30T20:47:51Z", "message": "Add cache quota support for hive connector"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f1726b4d6a4b8e9b1f9ddbb9fd534a1bebf7f492", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/f1726b4d6a4b8e9b1f9ddbb9fd534a1bebf7f492", "committedDate": "2020-05-30T20:47:51Z", "message": "Add cache quota support for hive connector"}, "afterCommit": {"oid": "cd2762fca1b9e282f2bfae9fd975536036b9607d", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/cd2762fca1b9e282f2bfae9fd975536036b9607d", "committedDate": "2020-05-30T21:05:58Z", "message": "Add cache quota support for hive connector"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cd2762fca1b9e282f2bfae9fd975536036b9607d", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/cd2762fca1b9e282f2bfae9fd975536036b9607d", "committedDate": "2020-05-30T21:05:58Z", "message": "Add cache quota support for hive connector"}, "afterCommit": {"oid": "802c11e4bbcc8c95862a62139a88dd132477e8ad", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/802c11e4bbcc8c95862a62139a88dd132477e8ad", "committedDate": "2020-05-30T21:09:22Z", "message": "Add cache quota support for hive connector"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "802c11e4bbcc8c95862a62139a88dd132477e8ad", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/802c11e4bbcc8c95862a62139a88dd132477e8ad", "committedDate": "2020-05-30T21:09:22Z", "message": "Add cache quota support for hive connector"}, "afterCommit": {"oid": "cf2b58acdca0aa35685fe43f850f8673bc750cc6", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/cf2b58acdca0aa35685fe43f850f8673bc750cc6", "committedDate": "2020-06-01T05:46:02Z", "message": "Add cache quota support for hive connector"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cf2b58acdca0aa35685fe43f850f8673bc750cc6", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/cf2b58acdca0aa35685fe43f850f8673bc750cc6", "committedDate": "2020-06-01T05:46:02Z", "message": "Add cache quota support for hive connector"}, "afterCommit": {"oid": "6f2ee432a87cde8aa8bfe089545a24e2b6c929c9", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/6f2ee432a87cde8aa8bfe089545a24e2b6c929c9", "committedDate": "2020-06-01T05:53:49Z", "message": "Add cache quota support for hive connector"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6f2ee432a87cde8aa8bfe089545a24e2b6c929c9", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/6f2ee432a87cde8aa8bfe089545a24e2b6c929c9", "committedDate": "2020-06-01T05:53:49Z", "message": "Add cache quota support for hive connector"}, "afterCommit": {"oid": "8da29640dd0ca7fa926b43a7177707901fadad15", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/8da29640dd0ca7fa926b43a7177707901fadad15", "committedDate": "2020-06-01T05:55:55Z", "message": "Add cache quota support for hive connector"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8da29640dd0ca7fa926b43a7177707901fadad15", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/8da29640dd0ca7fa926b43a7177707901fadad15", "committedDate": "2020-06-01T05:55:55Z", "message": "Add cache quota support for hive connector"}, "afterCommit": {"oid": "4350187428a9e110c0af526834e54ad492d17232", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/4350187428a9e110c0af526834e54ad492d17232", "committedDate": "2020-06-01T17:31:21Z", "message": "Add cache quota support for hive connector"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyMDM2MTg1", "url": "https://github.com/prestodb/presto/pull/14557#pullrequestreview-422036185", "createdAt": "2020-06-01T17:24:54Z", "commit": {"oid": "8da29640dd0ca7fa926b43a7177707901fadad15"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxNzoyNDo1NFrOGdTSTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxNzozMToxM1rOGdTflg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM3Nzg3MQ==", "bodyText": "nit: cache.cache-quota-scope?", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r433377871", "createdAt": "2020-06-01T17:24:54Z", "author": {"login": "shixuan-fan"}, "path": "presto-cache/src/main/java/com/facebook/presto/cache/CacheConfig.java", "diffHunk": "@@ -76,4 +83,30 @@ public CacheType getCacheType()\n     {\n         return cacheType;\n     }\n+\n+    public CacheQuotaScope getCacheQuotaScope()\n+    {\n+        return cacheQuotaScope;\n+    }\n+\n+    @Config(\"cache.cache-scope\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8da29640dd0ca7fa926b43a7177707901fadad15"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM4MTI3MA==", "bodyText": "nit: How about return cacheQuota.getQuota().map(quota -> cacheSize.compareTo(quota) > 0).orElse(false)?", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r433381270", "createdAt": "2020-06-01T17:31:13Z", "author": {"login": "shixuan-fan"}, "path": "presto-cache/src/main/java/com/facebook/presto/cache/filemerge/FileMergeCacheManager.java", "diffHunk": "@@ -151,27 +167,69 @@ public void destroy()\n     }\n \n     @Override\n-    public boolean get(FileReadRequest request, byte[] buffer, int offset)\n+    public CacheResult get(FileReadRequest request, byte[] buffer, int offset, CacheQuota cacheQuota)\n     {\n         boolean result = read(request, buffer, offset);\n+\n+        if (!result && ifExceedQuota(cacheQuota, request)) {\n+            stats.incrementQuotaExceed();\n+            return CacheResult.CACHE_QUOTA_EXCEED;\n+        }\n+\n+        try {\n+            // hint the cache\n+            cache.get(request.getPath(), cacheQuota::getIdentifier);\n+        }\n+        catch (ExecutionException e) {\n+            // ignore\n+        }\n+\n         if (result) {\n             stats.incrementCacheHit();\n+            return CacheResult.HIT;\n         }\n-        else {\n-            stats.incrementCacheMiss();\n-        }\n \n-        return result;\n+        stats.incrementCacheMiss();\n+        return CacheResult.MISS;\n+    }\n+\n+    private boolean ifExceedQuota(CacheQuota cacheQuota, FileReadRequest request)\n+    {\n+        DataSize cacheSize = DataSize.succinctBytes(cacheScopeSizeInBytes.getOrDefault(cacheQuota.getIdentifier(), 0L) + request.getLength());\n+        Optional<DataSize> quota = cacheQuota.getQuota();\n+        return quota.isPresent() && (cacheSize.compareTo(quota.get()) > 0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8da29640dd0ca7fa926b43a7177707901fadad15"}, "originalPosition": 122}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4350187428a9e110c0af526834e54ad492d17232", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/4350187428a9e110c0af526834e54ad492d17232", "committedDate": "2020-06-01T17:31:21Z", "message": "Add cache quota support for hive connector"}, "afterCommit": {"oid": "a00dfdc52eba849039f3604c1c81a28c936e79eb", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/a00dfdc52eba849039f3604c1c81a28c936e79eb", "committedDate": "2020-06-01T18:15:10Z", "message": "Add cache quota support for hive connector"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a00dfdc52eba849039f3604c1c81a28c936e79eb", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/a00dfdc52eba849039f3604c1c81a28c936e79eb", "committedDate": "2020-06-01T18:15:10Z", "message": "Add cache quota support for hive connector"}, "afterCommit": {"oid": "517770a523dd33d40cc1c508919fc59975c037da", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/517770a523dd33d40cc1c508919fc59975c037da", "committedDate": "2020-06-01T18:21:29Z", "message": "Add cache quota support for hive connector"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "517770a523dd33d40cc1c508919fc59975c037da", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/517770a523dd33d40cc1c508919fc59975c037da", "committedDate": "2020-06-01T18:21:29Z", "message": "Add cache quota support for hive connector"}, "afterCommit": {"oid": "7c139b58eb917dd5ab0e774af4027abc9bf890c8", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/7c139b58eb917dd5ab0e774af4027abc9bf890c8", "committedDate": "2020-06-01T18:52:26Z", "message": "Add cache quota support for hive connector"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7c139b58eb917dd5ab0e774af4027abc9bf890c8", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/7c139b58eb917dd5ab0e774af4027abc9bf890c8", "committedDate": "2020-06-01T18:52:26Z", "message": "Add cache quota support for hive connector"}, "afterCommit": {"oid": "5289c1829b91b66628756112633f30d0cb738897", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/5289c1829b91b66628756112633f30d0cb738897", "committedDate": "2020-06-01T19:28:39Z", "message": "Add cache quota support for hive connector"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5289c1829b91b66628756112633f30d0cb738897", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/5289c1829b91b66628756112633f30d0cb738897", "committedDate": "2020-06-01T19:28:39Z", "message": "Add cache quota support for hive connector"}, "afterCommit": {"oid": "0881b9d4454ed07368b8cfa0961fd0a5c2791c55", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/0881b9d4454ed07368b8cfa0961fd0a5c2791c55", "committedDate": "2020-06-01T22:28:34Z", "message": "Add cache quota support for hive connector"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyMjI5MDI1", "url": "https://github.com/prestodb/presto/pull/14557#pullrequestreview-422229025", "createdAt": "2020-06-01T22:40:40Z", "commit": {"oid": "0881b9d4454ed07368b8cfa0961fd0a5c2791c55"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQyMjo0MDo0MVrOGdcZLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQyMjo0MDo0MVrOGdcZLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUyNzA4NQ==", "bodyText": "Nice, we changed it from schedule!\nIn general, do we know how many files exist in the cache directory? It would be worthwhile to know the impact of building this in every few seconds. I would have preferred to do this asynchronously whenever we write any files to cache.", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r433527085", "createdAt": "2020-06-01T22:40:41Z", "author": {"login": "jainxrohit"}, "path": "presto-cache/src/main/java/com/facebook/presto/cache/filemerge/FileMergeCacheManager.java", "diffHunk": "@@ -140,6 +150,15 @@ public FileMergeCacheManager(\n                 }\n             }));\n         }\n+\n+        this.cacheSizeCalculateExecutor.scheduleAtFixedRate(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0881b9d4454ed07368b8cfa0961fd0a5c2791c55"}, "originalPosition": 71}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyMjg2NDUx", "url": "https://github.com/prestodb/presto/pull/14557#pullrequestreview-422286451", "createdAt": "2020-06-02T01:37:13Z", "commit": {"oid": "0881b9d4454ed07368b8cfa0961fd0a5c2791c55"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQwMTozNzoxNFrOGdfTag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQwMzozNTozOFrOGdg9gg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU3NDc2Mg==", "bodyText": "what is CacheScopeHandle? is this a typo?", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r433574762", "createdAt": "2020-06-02T01:37:14Z", "author": {"login": "apc999"}, "path": "presto-cache/src/main/java/com/facebook/presto/cache/filemerge/FileMergeCacheManager.java", "diffHunk": "@@ -81,11 +84,16 @@\n \n     private final ExecutorService cacheFlushExecutor;\n     private final ExecutorService cacheRemovalExecutor;\n+    private final ScheduledExecutorService cacheSizeCalculateExecutor;\n \n     // a mapping from remote file `F` to a range map `M`; the corresponding local cache file for each range in `M` represents the cached chunk of `F`\n     private final Map<Path, CacheRange> persistedRanges = new ConcurrentHashMap<>();\n     // a local cache only to control the lifecycle of persisted\n-    private final Cache<Path, Boolean> cache;\n+    // Path and its corresponding cacheScope identifier\n+    private final Cache<Path, Long> cache;\n+    // CacheScopeHandle identifier to its cached files mapping", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0881b9d4454ed07368b8cfa0961fd0a5c2791c55"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU3NzYyMA==", "bodyText": "is this intentional to hard-code the cache recalculation rate?", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r433577620", "createdAt": "2020-06-02T01:48:26Z", "author": {"login": "apc999"}, "path": "presto-cache/src/main/java/com/facebook/presto/cache/filemerge/FileMergeCacheManager.java", "diffHunk": "@@ -140,6 +150,15 @@ public FileMergeCacheManager(\n                 }\n             }));\n         }\n+\n+        this.cacheSizeCalculateExecutor.scheduleAtFixedRate(\n+                () -> {\n+                    cacheScopeFiles.keySet().forEach(cacheIdentifier -> cacheScopeSizeInBytes.put(cacheIdentifier, getCacheScopeSizeInBytes(cacheIdentifier)));\n+                    cacheScopeSizeInBytes.keySet().removeIf(key -> !cacheScopeFiles.containsKey(key));\n+                },\n+                0,\n+                15,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0881b9d4454ed07368b8cfa0961fd0a5c2791c55"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU3OTE1MA==", "bodyText": "Though cacheScopeFiles and cacheScopeSizeInBytes are threadsafe, the operations on these two data structures are not really atomic to each other.  E.g., the recalculation executor can run concurrently with ifExceedQuota, and leave operations on cacheScopeFiles and cacheScopeSizeInBytes interleaved in multiple threads.\nI don't see an immediate thread-safety risk on this in addition to some calculation that might be a bit \"off\".\nJust make sure we are aware of it --- the cache capacity & quota calculation may not be fully accurate", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r433579150", "createdAt": "2020-06-02T01:54:40Z", "author": {"login": "apc999"}, "path": "presto-cache/src/main/java/com/facebook/presto/cache/filemerge/FileMergeCacheManager.java", "diffHunk": "@@ -81,11 +84,16 @@\n \n     private final ExecutorService cacheFlushExecutor;\n     private final ExecutorService cacheRemovalExecutor;\n+    private final ScheduledExecutorService cacheSizeCalculateExecutor;\n \n     // a mapping from remote file `F` to a range map `M`; the corresponding local cache file for each range in `M` represents the cached chunk of `F`\n     private final Map<Path, CacheRange> persistedRanges = new ConcurrentHashMap<>();\n     // a local cache only to control the lifecycle of persisted\n-    private final Cache<Path, Boolean> cache;\n+    // Path and its corresponding cacheScope identifier\n+    private final Cache<Path, Long> cache;\n+    // CacheScopeHandle identifier to its cached files mapping\n+    private final Map<Long, Set<Path>> cacheScopeFiles = new ConcurrentHashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0881b9d4454ed07368b8cfa0961fd0a5c2791c55"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU3OTQzMA==", "bodyText": "is this change independent?", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r433579430", "createdAt": "2020-06-02T01:55:41Z", "author": {"login": "apc999"}, "path": "presto-cache/src/main/java/com/facebook/presto/cache/filemerge/FileMergeCacheManager.java", "diffHunk": "@@ -192,14 +252,6 @@ private boolean read(FileReadRequest request, byte[] buffer, int offset)\n             return true;\n         }\n \n-        try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0881b9d4454ed07368b8cfa0961fd0a5c2791c55"}, "originalPosition": 161}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzYwMTkyMg==", "bodyText": "do you document anywhere what it means by returning Optiona.empty()? assuming it means no limitation?", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r433601922", "createdAt": "2020-06-02T03:35:38Z", "author": {"login": "apc999"}, "path": "presto-hive-common/src/main/java/com/facebook/presto/hive/CacheQuota.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import io.airlift.units.DataSize;\n+\n+import java.util.Objects;\n+import java.util.Optional;\n+\n+import static com.google.common.hash.Hashing.md5;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+import static java.util.Objects.requireNonNull;\n+\n+public class CacheQuota\n+{\n+    public static final CacheQuota NO_CACHE_CONSTRAINTS = new CacheQuota(\"NO_IDENTITY\", Optional.empty());\n+\n+    private final long identifier;\n+    private final Optional<DataSize> quota;\n+\n+    public CacheQuota(String identity, Optional<DataSize> quota)\n+    {\n+        this.identifier = md5().hashString(identity, UTF_8).asLong();\n+        this.quota = requireNonNull(quota, \"quota is null\");\n+    }\n+\n+    public long getIdentifier()\n+    {\n+        return identifier;\n+    }\n+\n+    public Optional<DataSize> getQuota()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0881b9d4454ed07368b8cfa0961fd0a5c2791c55"}, "originalPosition": 43}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0881b9d4454ed07368b8cfa0961fd0a5c2791c55", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/0881b9d4454ed07368b8cfa0961fd0a5c2791c55", "committedDate": "2020-06-01T22:28:34Z", "message": "Add cache quota support for hive connector"}, "afterCommit": {"oid": "25d1e735a3739dfacefb4ab48281c0ac96e3fddd", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/25d1e735a3739dfacefb4ab48281c0ac96e3fddd", "committedDate": "2020-06-02T06:15:32Z", "message": "Add cache quota support for hive connector"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzMDM3NTEz", "url": "https://github.com/prestodb/presto/pull/14557#pullrequestreview-423037513", "createdAt": "2020-06-02T20:35:26Z", "commit": {"oid": "25d1e735a3739dfacefb4ab48281c0ac96e3fddd"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQyMDozNToyNlrOGeDBRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQyMDo0MDowNlrOGeDKpA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE1OTk0MA==", "bodyText": "This class needs to be JSON serializable.", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r434159940", "createdAt": "2020-06-02T20:35:26Z", "author": {"login": "highker"}, "path": "presto-hive-common/src/main/java/com/facebook/presto/hive/CacheQuota.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import io.airlift.units.DataSize;\n+\n+import java.util.Objects;\n+import java.util.Optional;\n+\n+import static com.google.common.hash.Hashing.md5;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+import static java.util.Objects.requireNonNull;\n+\n+public class CacheQuota", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25d1e735a3739dfacefb4ab48281c0ac96e3fddd"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE2MDM2NQ==", "bodyText": "I thought we gonna move this to getIdentifier() method?", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r434160365", "createdAt": "2020-06-02T20:36:16Z", "author": {"login": "highker"}, "path": "presto-hive-common/src/main/java/com/facebook/presto/hive/CacheQuota.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import io.airlift.units.DataSize;\n+\n+import java.util.Objects;\n+import java.util.Optional;\n+\n+import static com.google.common.hash.Hashing.md5;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+import static java.util.Objects.requireNonNull;\n+\n+public class CacheQuota\n+{\n+    public static final CacheQuota NO_CACHE_CONSTRAINTS = new CacheQuota(\"NO_IDENTITY\", Optional.empty());\n+\n+    private final long identifier;\n+    private final Optional<DataSize> quota;\n+\n+    public CacheQuota(String identity, Optional<DataSize> quota)\n+    {\n+        this.identifier = md5().hashString(identity, UTF_8).asLong();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25d1e735a3739dfacefb4ab48281c0ac96e3fddd"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE2MDUwNQ==", "bodyText": "Just store raw String identity", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r434160505", "createdAt": "2020-06-02T20:36:34Z", "author": {"login": "highker"}, "path": "presto-hive-common/src/main/java/com/facebook/presto/hive/CacheQuota.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import io.airlift.units.DataSize;\n+\n+import java.util.Objects;\n+import java.util.Optional;\n+\n+import static com.google.common.hash.Hashing.md5;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+import static java.util.Objects.requireNonNull;\n+\n+public class CacheQuota\n+{\n+    public static final CacheQuota NO_CACHE_CONSTRAINTS = new CacheQuota(\"NO_IDENTITY\", Optional.empty());\n+\n+    private final long identifier;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25d1e735a3739dfacefb4ab48281c0ac96e3fddd"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE2MDY3MA==", "bodyText": "Use Objects.equals", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r434160670", "createdAt": "2020-06-02T20:36:53Z", "author": {"login": "highker"}, "path": "presto-hive-common/src/main/java/com/facebook/presto/hive/CacheQuota.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import io.airlift.units.DataSize;\n+\n+import java.util.Objects;\n+import java.util.Optional;\n+\n+import static com.google.common.hash.Hashing.md5;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+import static java.util.Objects.requireNonNull;\n+\n+public class CacheQuota\n+{\n+    public static final CacheQuota NO_CACHE_CONSTRAINTS = new CacheQuota(\"NO_IDENTITY\", Optional.empty());\n+\n+    private final long identifier;\n+    private final Optional<DataSize> quota;\n+\n+    public CacheQuota(String identity, Optional<DataSize> quota)\n+    {\n+        this.identifier = md5().hashString(identity, UTF_8).asLong();\n+        this.quota = requireNonNull(quota, \"quota is null\");\n+    }\n+\n+    public long getIdentifier()\n+    {\n+        return identifier;\n+    }\n+\n+    public Optional<DataSize> getQuota()\n+    {\n+        return quota;\n+    }\n+\n+    @Override\n+    public boolean equals(Object o)\n+    {\n+        if (this == o) {\n+            return true;\n+        }\n+        if (o == null || getClass() != o.getClass()) {\n+            return false;\n+        }\n+        CacheQuota that = (CacheQuota) o;\n+        return identifier == that.identifier && Objects.equals(quota, that.quota);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25d1e735a3739dfacefb4ab48281c0ac96e3fddd"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE2MTM5NA==", "bodyText": "Need to destroy this after shutdown.", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r434161394", "createdAt": "2020-06-02T20:38:15Z", "author": {"login": "highker"}, "path": "presto-cache/src/main/java/com/facebook/presto/cache/filemerge/FileMergeCacheManager.java", "diffHunk": "@@ -81,11 +84,16 @@\n \n     private final ExecutorService cacheFlushExecutor;\n     private final ExecutorService cacheRemovalExecutor;\n+    private final ScheduledExecutorService cacheSizeCalculateExecutor;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25d1e735a3739dfacefb4ab48281c0ac96e3fddd"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE2MjM0MA==", "bodyText": "bytes", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r434162340", "createdAt": "2020-06-02T20:40:06Z", "author": {"login": "highker"}, "path": "presto-cache/src/main/java/com/facebook/presto/cache/filemerge/FileMergeCacheManager.java", "diffHunk": "@@ -151,27 +170,68 @@ public void destroy()\n     }\n \n     @Override\n-    public boolean get(FileReadRequest request, byte[] buffer, int offset)\n+    public CacheResult get(FileReadRequest request, byte[] buffer, int offset, CacheQuota cacheQuota)\n     {\n         boolean result = read(request, buffer, offset);\n+\n+        if (!result && ifExceedQuota(cacheQuota, request)) {\n+            stats.incrementQuotaExceed();\n+            return CacheResult.CACHE_QUOTA_EXCEED;\n+        }\n+\n+        try {\n+            // hint the cache\n+            cache.get(request.getPath(), cacheQuota::getIdentifier);\n+        }\n+        catch (ExecutionException e) {\n+            // ignore\n+        }\n+\n         if (result) {\n             stats.incrementCacheHit();\n+            return CacheResult.HIT;\n         }\n-        else {\n-            stats.incrementCacheMiss();\n-        }\n \n-        return result;\n+        stats.incrementCacheMiss();\n+        return CacheResult.MISS;\n+    }\n+\n+    private boolean ifExceedQuota(CacheQuota cacheQuota, FileReadRequest request)\n+    {\n+        DataSize cacheSize = DataSize.succinctBytes(cacheScopeSizeInBytes.getOrDefault(cacheQuota.getIdentifier(), 0L) + request.getLength());\n+        return cacheQuota.getQuota().map(quota -> cacheSize.compareTo(quota) > 0).orElse(false);\n+    }\n+\n+    private long getCacheScopeSizeInBytes(long cacheScopeIdentifier)\n+    {\n+        long sum = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25d1e735a3739dfacefb4ab48281c0ac96e3fddd"}, "originalPosition": 125}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "25d1e735a3739dfacefb4ab48281c0ac96e3fddd", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/25d1e735a3739dfacefb4ab48281c0ac96e3fddd", "committedDate": "2020-06-02T06:15:32Z", "message": "Add cache quota support for hive connector"}, "afterCommit": {"oid": "4719d46ec21fc0e341fb4c7400951faf3e0034da", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/4719d46ec21fc0e341fb4c7400951faf3e0034da", "committedDate": "2020-06-02T22:44:34Z", "message": "Add cache quota support for hive connector"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzMTA4MjY3", "url": "https://github.com/prestodb/presto/pull/14557#pullrequestreview-423108267", "createdAt": "2020-06-02T22:48:32Z", "commit": {"oid": "4719d46ec21fc0e341fb4c7400951faf3e0034da"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4719d46ec21fc0e341fb4c7400951faf3e0034da", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/4719d46ec21fc0e341fb4c7400951faf3e0034da", "committedDate": "2020-06-02T22:44:34Z", "message": "Add cache quota support for hive connector"}, "afterCommit": {"oid": "1c63fae405ccffe210e484e165fcd057f998bd05", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/1c63fae405ccffe210e484e165fcd057f998bd05", "committedDate": "2020-06-02T22:49:33Z", "message": "Add cache quota support for hive connector"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzMTU2NDYx", "url": "https://github.com/prestodb/presto/pull/14557#pullrequestreview-423156461", "createdAt": "2020-06-03T01:15:46Z", "commit": {"oid": "1c63fae405ccffe210e484e165fcd057f998bd05"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwMToxNTo0NlrOGeI9WA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwMToyMToyM1rOGeJCTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI1NzI0MA==", "bodyText": "use isEmpty()", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r434257240", "createdAt": "2020-06-03T01:15:46Z", "author": {"login": "highker"}, "path": "presto-cache/src/main/java/com/facebook/presto/cache/filemerge/FileMergeCacheManager.java", "diffHunk": "@@ -472,13 +525,18 @@ public ReadWriteLock getLock()\n     }\n \n     private class CacheRemovalListener\n-            implements RemovalListener<Path, Boolean>\n+            implements RemovalListener<Path, Long>\n     {\n         @Override\n-        public void onRemoval(RemovalNotification<Path, Boolean> notification)\n+        public void onRemoval(RemovalNotification<Path, Long> notification)\n         {\n             Path path = notification.getKey();\n             CacheRange cacheRange = persistedRanges.remove(path);\n+            cacheScopeFiles.get(notification.getValue()).remove(path);\n+            if (cacheScopeFiles.get(notification.getValue()).size() == 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c63fae405ccffe210e484e165fcd057f998bd05"}, "originalPosition": 191}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI1ODM4MQ==", "bodyText": "Use toStringHelper", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r434258381", "createdAt": "2020-06-03T01:20:50Z", "author": {"login": "highker"}, "path": "presto-hive-common/src/main/java/com/facebook/presto/hive/CacheQuotaRequirement.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import io.airlift.units.DataSize;\n+\n+import java.util.Objects;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.hive.CacheQuotaScope.GLOBAL;\n+import static java.util.Objects.requireNonNull;\n+\n+public class CacheQuotaRequirement\n+{\n+    public static final CacheQuotaRequirement NO_CACHE_REQUIREMENT = new CacheQuotaRequirement(GLOBAL, Optional.empty());\n+\n+    private final CacheQuotaScope cacheQuotaScope;\n+    private final Optional<DataSize> quota;\n+\n+    @JsonCreator\n+    public CacheQuotaRequirement(\n+            @JsonProperty(\"cacheQuotaScope\") CacheQuotaScope cacheQuotaScope,\n+            @JsonProperty(\"quota\") Optional<DataSize> quota)\n+    {\n+        this.cacheQuotaScope = requireNonNull(cacheQuotaScope, \"cacheQuotaScope\");\n+        this.quota = quota;\n+    }\n+\n+    @JsonProperty\n+    public CacheQuotaScope getCacheQuotaScope()\n+    {\n+        return cacheQuotaScope;\n+    }\n+\n+    @JsonProperty\n+    public Optional<DataSize> getQuota()\n+    {\n+        return quota;\n+    }\n+\n+    @Override\n+    public boolean equals(Object o)\n+    {\n+        if (this == o) {\n+            return true;\n+        }\n+        if (o == null || getClass() != o.getClass()) {\n+            return false;\n+        }\n+\n+        CacheQuotaRequirement that = (CacheQuotaRequirement) o;\n+        return cacheQuotaScope == that.cacheQuotaScope && Objects.equals(quota, that.quota);\n+    }\n+\n+    @Override\n+    public int hashCode()\n+    {\n+        return Objects.hash(cacheQuotaScope, quota);\n+    }\n+\n+    @Override\n+    public String toString()\n+    {\n+        return \"CacheQuotaRequirement{\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c63fae405ccffe210e484e165fcd057f998bd05"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI1ODUwOA==", "bodyText": "Use Objects.equals for cacheQuotaScope", "url": "https://github.com/prestodb/presto/pull/14557#discussion_r434258508", "createdAt": "2020-06-03T01:21:23Z", "author": {"login": "highker"}, "path": "presto-hive-common/src/main/java/com/facebook/presto/hive/CacheQuotaRequirement.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import io.airlift.units.DataSize;\n+\n+import java.util.Objects;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.hive.CacheQuotaScope.GLOBAL;\n+import static java.util.Objects.requireNonNull;\n+\n+public class CacheQuotaRequirement\n+{\n+    public static final CacheQuotaRequirement NO_CACHE_REQUIREMENT = new CacheQuotaRequirement(GLOBAL, Optional.empty());\n+\n+    private final CacheQuotaScope cacheQuotaScope;\n+    private final Optional<DataSize> quota;\n+\n+    @JsonCreator\n+    public CacheQuotaRequirement(\n+            @JsonProperty(\"cacheQuotaScope\") CacheQuotaScope cacheQuotaScope,\n+            @JsonProperty(\"quota\") Optional<DataSize> quota)\n+    {\n+        this.cacheQuotaScope = requireNonNull(cacheQuotaScope, \"cacheQuotaScope\");\n+        this.quota = quota;\n+    }\n+\n+    @JsonProperty\n+    public CacheQuotaScope getCacheQuotaScope()\n+    {\n+        return cacheQuotaScope;\n+    }\n+\n+    @JsonProperty\n+    public Optional<DataSize> getQuota()\n+    {\n+        return quota;\n+    }\n+\n+    @Override\n+    public boolean equals(Object o)\n+    {\n+        if (this == o) {\n+            return true;\n+        }\n+        if (o == null || getClass() != o.getClass()) {\n+            return false;\n+        }\n+\n+        CacheQuotaRequirement that = (CacheQuotaRequirement) o;\n+        return cacheQuotaScope == that.cacheQuotaScope && Objects.equals(quota, that.quota);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c63fae405ccffe210e484e165fcd057f998bd05"}, "originalPosition": 65}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1c63fae405ccffe210e484e165fcd057f998bd05", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/1c63fae405ccffe210e484e165fcd057f998bd05", "committedDate": "2020-06-02T22:49:33Z", "message": "Add cache quota support for hive connector"}, "afterCommit": {"oid": "9e3067a60124e480e580580973ddb5b5b2749204", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/9e3067a60124e480e580580973ddb5b5b2749204", "committedDate": "2020-06-03T05:12:00Z", "message": "Add cache quota support for hive connector"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6dd033b02debdda44ad501a56e8a52606b5292a8", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/6dd033b02debdda44ad501a56e8a52606b5292a8", "committedDate": "2020-06-03T18:16:01Z", "message": "Add cache quota support for hive connector"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9e3067a60124e480e580580973ddb5b5b2749204", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/9e3067a60124e480e580580973ddb5b5b2749204", "committedDate": "2020-06-03T05:12:00Z", "message": "Add cache quota support for hive connector"}, "afterCommit": {"oid": "6dd033b02debdda44ad501a56e8a52606b5292a8", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/6dd033b02debdda44ad501a56e8a52606b5292a8", "committedDate": "2020-06-03T18:16:01Z", "message": "Add cache quota support for hive connector"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1687, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}