{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk4NDE4MDE4", "number": 14334, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxOTozODoyOVrODwIwkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxOTozODoyOVrODwIwkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxODAxNzQ3OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/RelationPlanner.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxOTozODoyOVrOGC-D0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQyMToxNjo0NVrOGO6plA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc2NzEyMg==", "bodyText": "I'm not confident about this change.  RelationPlanner.visitTable() explicitly calls addCoercions including the hidden fields in the types.  This change seems like it would break the case were there are hidden columns.\n\n  \n    \n      presto/presto-main/src/main/java/com/facebook/presto/sql/planner/RelationPlanner.java\n    \n    \n        Lines 154 to 155\n      in\n      3c2d9d8\n    \n    \n    \n    \n\n        \n          \n           Type[] types = scope.getRelationType().getAllFields().stream().map(Field::getType).toArray(Type[]::new); \n        \n\n        \n          \n           RelationPlan withCoercions = addCoercions(subPlan, types);", "url": "https://github.com/prestodb/presto/pull/14334#discussion_r405767122", "createdAt": "2020-04-08T19:38:29Z", "author": {"login": "rschlussel"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/RelationPlanner.java", "diffHunk": "@@ -725,14 +725,18 @@ private RelationPlan processAndCoerceIfNecessary(Relation node, Void context)\n \n     private RelationPlan addCoercions(RelationPlan plan, Type[] targetColumnTypes)\n     {\n-        List<VariableReferenceExpression> oldVariables = plan.getFieldMappings();\n-        RelationType oldDescriptor = plan.getDescriptor().withOnlyVisibleFields();\n-        verify(targetColumnTypes.length == oldVariables.size());\n+        RelationType oldRelation = plan.getDescriptor();\n+        List<VariableReferenceExpression> oldVisibleVariables = oldRelation.getVisibleFields().stream()\n+                .map(oldRelation::indexOf)\n+                .map(plan.getFieldMappings()::get)\n+                .collect(toImmutableList());\n+        RelationType oldRelationWithVisibleFields = plan.getDescriptor().withOnlyVisibleFields();\n+        verify(targetColumnTypes.length == oldVisibleVariables.size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48609e9425e2b253aa3ca72c36de416e4900cfd6"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ3MjY4NA==", "bodyText": "If you refer to a hidden field explicitly in the subquery, the field will no longer be hidden. For example, if you do\nWITH t(x, y, z) as (SELECT x, y, \"some_hidden_field\" FROM t)\n\nThe \"some_hidden_field\" is no longer hidden in the scope.getRelationType(). The only situation that the named query could include hidden field is when the output is not explicit. Looking at the syntax, I think this would only happen if the named query is a table reference. For table reference, not that in StatementAnalyzer \n  \n    \n      presto/presto-main/src/main/java/com/facebook/presto/sql/analyzer/StatementAnalyzer.java\n    \n    \n         Line 2106\n      in\n      3c2d9d8\n    \n    \n    \n    \n\n        \n          \n           if (columnNames.size() != queryDescriptor.getVisibleFieldCount()) { \n        \n    \n  \n\n\nWe actually check against visible field count. So considering all fields with guarantee failure if there's hidden field.", "url": "https://github.com/prestodb/presto/pull/14334#discussion_r406472684", "createdAt": "2020-04-09T20:56:55Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/RelationPlanner.java", "diffHunk": "@@ -725,14 +725,18 @@ private RelationPlan processAndCoerceIfNecessary(Relation node, Void context)\n \n     private RelationPlan addCoercions(RelationPlan plan, Type[] targetColumnTypes)\n     {\n-        List<VariableReferenceExpression> oldVariables = plan.getFieldMappings();\n-        RelationType oldDescriptor = plan.getDescriptor().withOnlyVisibleFields();\n-        verify(targetColumnTypes.length == oldVariables.size());\n+        RelationType oldRelation = plan.getDescriptor();\n+        List<VariableReferenceExpression> oldVisibleVariables = oldRelation.getVisibleFields().stream()\n+                .map(oldRelation::indexOf)\n+                .map(plan.getFieldMappings()::get)\n+                .collect(toImmutableList());\n+        RelationType oldRelationWithVisibleFields = plan.getDescriptor().withOnlyVisibleFields();\n+        verify(targetColumnTypes.length == oldVisibleVariables.size());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc2NzEyMg=="}, "originalCommit": {"oid": "48609e9425e2b253aa3ca72c36de416e4900cfd6"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM5Nzc0NA==", "bodyText": "The explanation makes sense.  Is it possible to fix this in the AST builder, then so we don't even have the hidden column for with clause output? It seems like that would be a better solution.  Otherwise, this looks good.", "url": "https://github.com/prestodb/presto/pull/14334#discussion_r408397744", "createdAt": "2020-04-14T19:57:23Z", "author": {"login": "rschlussel"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/RelationPlanner.java", "diffHunk": "@@ -725,14 +725,18 @@ private RelationPlan processAndCoerceIfNecessary(Relation node, Void context)\n \n     private RelationPlan addCoercions(RelationPlan plan, Type[] targetColumnTypes)\n     {\n-        List<VariableReferenceExpression> oldVariables = plan.getFieldMappings();\n-        RelationType oldDescriptor = plan.getDescriptor().withOnlyVisibleFields();\n-        verify(targetColumnTypes.length == oldVariables.size());\n+        RelationType oldRelation = plan.getDescriptor();\n+        List<VariableReferenceExpression> oldVisibleVariables = oldRelation.getVisibleFields().stream()\n+                .map(oldRelation::indexOf)\n+                .map(plan.getFieldMappings()::get)\n+                .collect(toImmutableList());\n+        RelationType oldRelationWithVisibleFields = plan.getDescriptor().withOnlyVisibleFields();\n+        verify(targetColumnTypes.length == oldVisibleVariables.size());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc2NzEyMg=="}, "originalCommit": {"oid": "48609e9425e2b253aa3ca72c36de416e4900cfd6"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI5NDE2NA==", "bodyText": "the visitTable in AstBuilder doesn't really retrieve metadata from table. Unless we change that this would be hard to do. I'll merge this PR as is. Thanks!", "url": "https://github.com/prestodb/presto/pull/14334#discussion_r418294164", "createdAt": "2020-04-30T21:16:45Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/RelationPlanner.java", "diffHunk": "@@ -725,14 +725,18 @@ private RelationPlan processAndCoerceIfNecessary(Relation node, Void context)\n \n     private RelationPlan addCoercions(RelationPlan plan, Type[] targetColumnTypes)\n     {\n-        List<VariableReferenceExpression> oldVariables = plan.getFieldMappings();\n-        RelationType oldDescriptor = plan.getDescriptor().withOnlyVisibleFields();\n-        verify(targetColumnTypes.length == oldVariables.size());\n+        RelationType oldRelation = plan.getDescriptor();\n+        List<VariableReferenceExpression> oldVisibleVariables = oldRelation.getVisibleFields().stream()\n+                .map(oldRelation::indexOf)\n+                .map(plan.getFieldMappings()::get)\n+                .collect(toImmutableList());\n+        RelationType oldRelationWithVisibleFields = plan.getDescriptor().withOnlyVisibleFields();\n+        verify(targetColumnTypes.length == oldVisibleVariables.size());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc2NzEyMg=="}, "originalCommit": {"oid": "48609e9425e2b253aa3ca72c36de416e4900cfd6"}, "originalPosition": 13}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2741, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}