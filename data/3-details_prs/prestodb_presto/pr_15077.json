{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcyOTQxNjQ1", "number": 15077, "title": "Dynamic filtering integration with Aria", "bodyText": "== RELEASE NOTES ==\n\nGeneral Changes\n* Add dynamic filtering and bucket pruning support for inner join and semi join. The feature avoids full table scan on probe side for broadcast join or colocated join when the build side is small. Set config `experimental.enable-dynamic-filtering` to `True` to enable the feature. Configs `experimental.dynamic-filtering-max-per-driver-row-count` and `experimental.dynamic-filtering-max-per-driver-size` are available to tune the size on the build side join key space. Currently, only Hive connector can benefit from the feature.", "createdAt": "2020-08-25T05:11:12Z", "url": "https://github.com/prestodb/presto/pull/15077", "merged": true, "mergeCommit": {"oid": "f74a84e8b610dcddff5d29d76b345fe7ac2de5a4"}, "closed": true, "closedAt": "2020-09-04T05:40:23Z", "author": {"login": "kewang1024"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdEMfVSgFqTQ3ODMzNzAyOQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdFVKSbABqjM3MjYxMDg3Njk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4MzM3MDI5", "url": "https://github.com/prestodb/presto/pull/15077#pullrequestreview-478337029", "createdAt": "2020-08-31T06:06:01Z", "commit": {"oid": "2fc7edbd61f4cd0b239a92bde95b26f38525496b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2fc7edbd61f4cd0b239a92bde95b26f38525496b", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/2fc7edbd61f4cd0b239a92bde95b26f38525496b", "committedDate": "2020-08-25T00:42:49Z", "message": "Aria hack"}, "afterCommit": {"oid": "2ed93b36076382f86360f11fdccd8074eb5892ba", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/2ed93b36076382f86360f11fdccd8074eb5892ba", "committedDate": "2020-09-01T07:11:39Z", "message": "Dynamic filtering integration with Aria"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2ed93b36076382f86360f11fdccd8074eb5892ba", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/2ed93b36076382f86360f11fdccd8074eb5892ba", "committedDate": "2020-09-01T07:11:39Z", "message": "Dynamic filtering integration with Aria"}, "afterCommit": {"oid": "2df07b74a56ca1c62c8729f235f5010a61f3861c", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/2df07b74a56ca1c62c8729f235f5010a61f3861c", "committedDate": "2020-09-02T07:37:44Z", "message": "Dynamic filtering integration with Aria"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2df07b74a56ca1c62c8729f235f5010a61f3861c", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/2df07b74a56ca1c62c8729f235f5010a61f3861c", "committedDate": "2020-09-02T07:37:44Z", "message": "Dynamic filtering integration with Aria"}, "afterCommit": {"oid": "2f432106386727ebeb6107396109c1fd2ce95c74", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/2f432106386727ebeb6107396109c1fd2ce95c74", "committedDate": "2020-09-02T17:13:45Z", "message": "Dynamic filtering integration with Aria"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxNDMyNDEy", "url": "https://github.com/prestodb/presto/pull/15077#pullrequestreview-481432412", "createdAt": "2020-09-03T02:04:19Z", "commit": {"oid": "2f432106386727ebeb6107396109c1fd2ce95c74"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxNDMyOTQy", "url": "https://github.com/prestodb/presto/pull/15077#pullrequestreview-481432942", "createdAt": "2020-09-03T02:06:00Z", "commit": {"oid": "2f432106386727ebeb6107396109c1fd2ce95c74"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QwMjowNjowMVrOHMSkJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QwMjoxMzo0MFrOHMSslA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjY0OTEyNA==", "bodyText": "TestHiveDistributedJoinQueriesWithDynamicFilteringAndFilterPushdown", "url": "https://github.com/prestodb/presto/pull/15077#discussion_r482649124", "createdAt": "2020-09-03T02:06:01Z", "author": {"login": "highker"}, "path": "presto-hive/src/test/java/com/facebook/presto/hive/TestHiveDistributedJoinQueriesWithDynamicFilteringAndAria.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import com.facebook.presto.Session;\n+import com.facebook.presto.tests.AbstractTestJoinQueries;\n+\n+import static com.facebook.presto.SystemSessionProperties.ENABLE_DYNAMIC_FILTERING;\n+import static com.facebook.presto.SystemSessionProperties.JOIN_DISTRIBUTION_TYPE;\n+import static com.facebook.presto.SystemSessionProperties.PUSHDOWN_SUBFIELDS_ENABLED;\n+import static com.facebook.presto.hive.HiveQueryRunner.HIVE_CATALOG;\n+import static com.facebook.presto.hive.HiveQueryRunner.createQueryRunner;\n+import static com.facebook.presto.hive.HiveSessionProperties.PUSHDOWN_FILTER_ENABLED;\n+import static com.facebook.presto.sql.analyzer.FeaturesConfig.JoinDistributionType.BROADCAST;\n+import static io.airlift.tpch.TpchTable.getTables;\n+\n+public class TestHiveDistributedJoinQueriesWithDynamicFilteringAndAria", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f432106386727ebeb6107396109c1fd2ce95c74"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjY0OTIyNw==", "bodyText": "one param per line", "url": "https://github.com/prestodb/presto/pull/15077#discussion_r482649227", "createdAt": "2020-09-03T02:06:25Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/sanity/DynamicFiltersChecker.java", "diffHunk": "@@ -97,7 +97,8 @@ public void validate(PlanNode plan, Session session, Metadata metadata, SqlParse\n                 Set<String> currentJoinDynamicFilters = node.getDynamicFilters().keySet();\n                 Set<String> consumedProbeSide = node.getProbe().accept(this, context);\n                 Set<String> unconsumedByProbeSide = difference(currentJoinDynamicFilters, consumedProbeSide);\n-                verify(unconsumedByProbeSide.isEmpty(), \"Dynamic filters %s present in join were not fully consumed by its probe side.\", unconsumedByProbeSide);\n+                verify(unconsumedByProbeSide.isEmpty(), \"Dynamic filters %s present in join were not fully consumed by its probe side,\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f432106386727ebeb6107396109c1fd2ce95c74"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjY1MDQwNQ==", "bodyText": "break a line after this.", "url": "https://github.com/prestodb/presto/pull/15077#discussion_r482650405", "createdAt": "2020-09-03T02:10:42Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/rule/HiveFilterPushdown.java", "diffHunk": "@@ -248,6 +250,12 @@ public static ConnectorPushdownFilterResult pushdownFilter(\n                 .collect(toImmutableMap(HiveColumnHandle::getName, Functions.identity()));\n \n         SchemaTableName tableName = ((HiveTableHandle) tableHandle).getSchemaTableName();\n+\n+        LogicalRowExpressions logicalRowExpressions = new LogicalRowExpressions(rowExpressionService.getDeterminismEvaluator(), functionResolution, functionMetadataManager);\n+        RowExpression remainingExpression = decomposedFilter.getRemainingExpression();\n+        DynamicFilters.DynamicFilterExtractRowExpression dynamicFilterExtractRowExpression = extractDynamicFiltersRowExpression(remainingExpression);\n+        RowExpression dynamicFilterExpression = logicalRowExpressions.combineConjuncts(dynamicFilterExtractRowExpression.getDynamicConjuncts());\n+        remainingExpression = logicalRowExpressions.combineConjuncts(dynamicFilterExtractRowExpression.getStaticConjuncts());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f432106386727ebeb6107396109c1fd2ce95c74"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjY1MTIzNg==", "bodyText": "Let's just do two interfaces:\n\nRowExpression extractDynamicConjuncts(RowExpression expression) and\nRowExpression extractStaticConjuncts(RowExpression expression)", "url": "https://github.com/prestodb/presto/pull/15077#discussion_r482651236", "createdAt": "2020-09-03T02:13:32Z", "author": {"login": "highker"}, "path": "presto-expressions/src/main/java/com/facebook/presto/expressions/DynamicFilters.java", "diffHunk": "@@ -60,6 +60,26 @@ public static DynamicFilterExtractResult extractDynamicFilters(RowExpression exp\n         return new DynamicFilterExtractResult(staticConjuncts.build(), dynamicConjuncts.build());\n     }\n \n+    public static DynamicFilterExtractRowExpression extractDynamicFiltersRowExpression(RowExpression expression)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f432106386727ebeb6107396109c1fd2ce95c74"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjY1MTI4NA==", "bodyText": "remove this", "url": "https://github.com/prestodb/presto/pull/15077#discussion_r482651284", "createdAt": "2020-09-03T02:13:40Z", "author": {"login": "highker"}, "path": "presto-expressions/src/main/java/com/facebook/presto/expressions/DynamicFilters.java", "diffHunk": "@@ -110,6 +130,28 @@ public DynamicFilterExtractResult(List<RowExpression> staticConjuncts, List<Dyna\n         }\n     }\n \n+    public static class DynamicFilterExtractRowExpression", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f432106386727ebeb6107396109c1fd2ce95c74"}, "originalPosition": 31}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2f432106386727ebeb6107396109c1fd2ce95c74", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/2f432106386727ebeb6107396109c1fd2ce95c74", "committedDate": "2020-09-02T17:13:45Z", "message": "Dynamic filtering integration with Aria"}, "afterCommit": {"oid": "8c7500f75f5ec2b8e170939cd1511e49203dedb3", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/8c7500f75f5ec2b8e170939cd1511e49203dedb3", "committedDate": "2020-09-03T04:10:50Z", "message": "Dynamic filtering integration with hive filter pushdown"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8c7500f75f5ec2b8e170939cd1511e49203dedb3", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/8c7500f75f5ec2b8e170939cd1511e49203dedb3", "committedDate": "2020-09-03T04:10:50Z", "message": "Dynamic filtering integration with hive filter pushdown"}, "afterCommit": {"oid": "26a678b27485b6ca179728750b2b06f283c44390", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/26a678b27485b6ca179728750b2b06f283c44390", "committedDate": "2020-09-03T04:14:46Z", "message": "Dynamic filtering integration with hive filter pushdown"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "26a678b27485b6ca179728750b2b06f283c44390", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/26a678b27485b6ca179728750b2b06f283c44390", "committedDate": "2020-09-03T04:14:46Z", "message": "Dynamic filtering integration with hive filter pushdown"}, "afterCommit": {"oid": "88d3ce0dafa6e9fcf91b61dc194fbf9709b9f18a", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/88d3ce0dafa6e9fcf91b61dc194fbf9709b9f18a", "committedDate": "2020-09-03T05:16:41Z", "message": "Dynamic filtering integration with hive filter pushdown"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxNTEwMjgz", "url": "https://github.com/prestodb/presto/pull/15077#pullrequestreview-481510283", "createdAt": "2020-09-03T05:50:50Z", "commit": {"oid": "88d3ce0dafa6e9fcf91b61dc194fbf9709b9f18a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ac84a0a5e1ca80b5fa957c990ee8cbb406ffa6f", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/4ac84a0a5e1ca80b5fa957c990ee8cbb406ffa6f", "committedDate": "2020-09-03T18:45:55Z", "message": "Dynamic filtering integration with hive filter pushdown"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "88d3ce0dafa6e9fcf91b61dc194fbf9709b9f18a", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/88d3ce0dafa6e9fcf91b61dc194fbf9709b9f18a", "committedDate": "2020-09-03T05:16:41Z", "message": "Dynamic filtering integration with hive filter pushdown"}, "afterCommit": {"oid": "4ac84a0a5e1ca80b5fa957c990ee8cbb406ffa6f", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/4ac84a0a5e1ca80b5fa957c990ee8cbb406ffa6f", "committedDate": "2020-09-03T18:45:55Z", "message": "Dynamic filtering integration with hive filter pushdown"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4993, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}