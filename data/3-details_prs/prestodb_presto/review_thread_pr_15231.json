{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkzNzg0NTU2", "number": 15231, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNDoyNzo0MFrOEoGxeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQxODoyNDozN1rOEqHKug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEwNDg5NDY2OnYy", "diffSide": "RIGHT", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGenerator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNDoyNzo0MFrOHZAUTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNDoyNzo0MFrOHZAUTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk4MTY0Nw==", "bodyText": "Nit: uses", "url": "https://github.com/prestodb/presto/pull/15231#discussion_r495981647", "createdAt": "2020-09-28T14:27:40Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGenerator.java", "diffHunk": "@@ -392,6 +393,47 @@ else if (fractionInput instanceof VariableReferenceExpression) {\n             return format(\"PERCENTILEEST%d(%s)\", percentile, inputSelections.get(getVariableReference(inputs.get(0))));\n         }\n \n+        private String handleApproxDistinct(CallExpression aggregation, Map<VariableReferenceExpression, Selection> inputSelections)\n+        {\n+            List<RowExpression> inputs = aggregation.getArguments();\n+            if (inputs.isEmpty() || inputs.size() > 2) {\n+                throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), \"Cannot handle approx_distinct function \" + aggregation);\n+            }\n+            Selection selection = inputSelections.get(getVariableReference(inputs.get(0)));\n+            if (inputs.size() == 1) {\n+                return format(\"DISTINCTCOUNTHLL(%s)\", selection);\n+            }\n+            RowExpression standardErrorInput = inputs.get(1);\n+            String standardErrorString;\n+            if (standardErrorInput instanceof ConstantExpression) {\n+                standardErrorString = getLiteralAsString((ConstantExpression) standardErrorInput);\n+            }\n+            else if (standardErrorInput instanceof VariableReferenceExpression) {\n+                Selection fraction = inputSelections.get(standardErrorInput);\n+                if (fraction.getOrigin() != LITERAL) {\n+                    throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(),\n+                            \"Cannot handle approx_distinct standard error argument be a non literal \" + aggregation);\n+                }\n+                standardErrorString = fraction.getDefinition();\n+            }\n+            else {\n+                throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), \"Expected the standard error to be a constant or a variable \" + standardErrorInput);\n+            }\n+\n+            double standardError = Double.parseDouble(standardErrorString);\n+            if (standardError < 0) {\n+                throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(),\n+                        format(\"Cannot handle approx_distinct parsed as %d from input %s (function %s)\", standardError, standardErrorString, aggregation));\n+            }\n+            // Pinot use DisctintCountHll to do distinct count estimation, with hyperloglog algorithm.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e18011ebdec17d6545edce9f355c5ec727ea6208"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEwNjA0MzAzOnYy", "diffSide": "RIGHT", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGenerator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxODo0ODowNVrOHZLSLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxOTo0Mjo0NVrOHZNBXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE2MTMyNw==", "bodyText": "typo ... DistinctCountHll, can you also capitalize that to be consistent.\nCan you add some more details on the second argument that is needed: What is log2m in english would help understand the formula on line 433", "url": "https://github.com/prestodb/presto/pull/15231#discussion_r496161327", "createdAt": "2020-09-28T18:48:05Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGenerator.java", "diffHunk": "@@ -392,6 +393,47 @@ else if (fractionInput instanceof VariableReferenceExpression) {\n             return format(\"PERCENTILEEST%d(%s)\", percentile, inputSelections.get(getVariableReference(inputs.get(0))));\n         }\n \n+        private String handleApproxDistinct(CallExpression aggregation, Map<VariableReferenceExpression, Selection> inputSelections)\n+        {\n+            List<RowExpression> inputs = aggregation.getArguments();\n+            if (inputs.isEmpty() || inputs.size() > 2) {\n+                throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), \"Cannot handle approx_distinct function \" + aggregation);\n+            }\n+            Selection selection = inputSelections.get(getVariableReference(inputs.get(0)));\n+            if (inputs.size() == 1) {\n+                return format(\"DISTINCTCOUNTHLL(%s)\", selection);\n+            }\n+            RowExpression standardErrorInput = inputs.get(1);\n+            String standardErrorString;\n+            if (standardErrorInput instanceof ConstantExpression) {\n+                standardErrorString = getLiteralAsString((ConstantExpression) standardErrorInput);\n+            }\n+            else if (standardErrorInput instanceof VariableReferenceExpression) {\n+                Selection fraction = inputSelections.get(standardErrorInput);\n+                if (fraction.getOrigin() != LITERAL) {\n+                    throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(),\n+                            \"Cannot handle approx_distinct standard error argument be a non literal \" + aggregation);\n+                }\n+                standardErrorString = fraction.getDefinition();\n+            }\n+            else {\n+                throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), \"Expected the standard error to be a constant or a variable \" + standardErrorInput);\n+            }\n+\n+            double standardError = Double.parseDouble(standardErrorString);\n+            if (standardError < 0) {\n+                throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(),\n+                        format(\"Cannot handle approx_distinct parsed as %d from input %s (function %s)\", standardError, standardErrorString, aggregation));\n+            }\n+            // Pinot uses DisctintCountHll to do distinct count estimation, with hyperloglog algorithm.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a7c5884403359370f895f2e1ccdb15f5919912e"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE4OTc4OQ==", "bodyText": "done", "url": "https://github.com/prestodb/presto/pull/15231#discussion_r496189789", "createdAt": "2020-09-28T19:42:45Z", "author": {"login": "xiangfu0"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGenerator.java", "diffHunk": "@@ -392,6 +393,47 @@ else if (fractionInput instanceof VariableReferenceExpression) {\n             return format(\"PERCENTILEEST%d(%s)\", percentile, inputSelections.get(getVariableReference(inputs.get(0))));\n         }\n \n+        private String handleApproxDistinct(CallExpression aggregation, Map<VariableReferenceExpression, Selection> inputSelections)\n+        {\n+            List<RowExpression> inputs = aggregation.getArguments();\n+            if (inputs.isEmpty() || inputs.size() > 2) {\n+                throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), \"Cannot handle approx_distinct function \" + aggregation);\n+            }\n+            Selection selection = inputSelections.get(getVariableReference(inputs.get(0)));\n+            if (inputs.size() == 1) {\n+                return format(\"DISTINCTCOUNTHLL(%s)\", selection);\n+            }\n+            RowExpression standardErrorInput = inputs.get(1);\n+            String standardErrorString;\n+            if (standardErrorInput instanceof ConstantExpression) {\n+                standardErrorString = getLiteralAsString((ConstantExpression) standardErrorInput);\n+            }\n+            else if (standardErrorInput instanceof VariableReferenceExpression) {\n+                Selection fraction = inputSelections.get(standardErrorInput);\n+                if (fraction.getOrigin() != LITERAL) {\n+                    throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(),\n+                            \"Cannot handle approx_distinct standard error argument be a non literal \" + aggregation);\n+                }\n+                standardErrorString = fraction.getDefinition();\n+            }\n+            else {\n+                throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), \"Expected the standard error to be a constant or a variable \" + standardErrorInput);\n+            }\n+\n+            double standardError = Double.parseDouble(standardErrorString);\n+            if (standardError < 0) {\n+                throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(),\n+                        format(\"Cannot handle approx_distinct parsed as %d from input %s (function %s)\", standardError, standardErrorString, aggregation));\n+            }\n+            // Pinot uses DisctintCountHll to do distinct count estimation, with hyperloglog algorithm.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE2MTMyNw=="}, "originalCommit": {"oid": "8a7c5884403359370f895f2e1ccdb15f5919912e"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEwNjA0NzAzOnYy", "diffSide": "RIGHT", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGenerator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxODo0OToxNlrOHZLUxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxOTo0MjozOFrOHZNBCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE2MTk4OQ==", "bodyText": "Can this throw a parse error ? Should we handle that ? Or perhaps assert the type of the ConstantExpression or VariableReferenceExpression is numeric ?", "url": "https://github.com/prestodb/presto/pull/15231#discussion_r496161989", "createdAt": "2020-09-28T18:49:16Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGenerator.java", "diffHunk": "@@ -392,6 +393,47 @@ else if (fractionInput instanceof VariableReferenceExpression) {\n             return format(\"PERCENTILEEST%d(%s)\", percentile, inputSelections.get(getVariableReference(inputs.get(0))));\n         }\n \n+        private String handleApproxDistinct(CallExpression aggregation, Map<VariableReferenceExpression, Selection> inputSelections)\n+        {\n+            List<RowExpression> inputs = aggregation.getArguments();\n+            if (inputs.isEmpty() || inputs.size() > 2) {\n+                throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), \"Cannot handle approx_distinct function \" + aggregation);\n+            }\n+            Selection selection = inputSelections.get(getVariableReference(inputs.get(0)));\n+            if (inputs.size() == 1) {\n+                return format(\"DISTINCTCOUNTHLL(%s)\", selection);\n+            }\n+            RowExpression standardErrorInput = inputs.get(1);\n+            String standardErrorString;\n+            if (standardErrorInput instanceof ConstantExpression) {\n+                standardErrorString = getLiteralAsString((ConstantExpression) standardErrorInput);\n+            }\n+            else if (standardErrorInput instanceof VariableReferenceExpression) {\n+                Selection fraction = inputSelections.get(standardErrorInput);\n+                if (fraction.getOrigin() != LITERAL) {\n+                    throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(),\n+                            \"Cannot handle approx_distinct standard error argument be a non literal \" + aggregation);\n+                }\n+                standardErrorString = fraction.getDefinition();\n+            }\n+            else {\n+                throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), \"Expected the standard error to be a constant or a variable \" + standardErrorInput);\n+            }\n+\n+            double standardError = Double.parseDouble(standardErrorString);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a7c5884403359370f895f2e1ccdb15f5919912e"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE4OTcwNA==", "bodyText": "Added a try catch for double parsing.\nConstantExpression is decimal representation, so it's actually easier to convert to string then parse double value.", "url": "https://github.com/prestodb/presto/pull/15231#discussion_r496189704", "createdAt": "2020-09-28T19:42:38Z", "author": {"login": "xiangfu0"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGenerator.java", "diffHunk": "@@ -392,6 +393,47 @@ else if (fractionInput instanceof VariableReferenceExpression) {\n             return format(\"PERCENTILEEST%d(%s)\", percentile, inputSelections.get(getVariableReference(inputs.get(0))));\n         }\n \n+        private String handleApproxDistinct(CallExpression aggregation, Map<VariableReferenceExpression, Selection> inputSelections)\n+        {\n+            List<RowExpression> inputs = aggregation.getArguments();\n+            if (inputs.isEmpty() || inputs.size() > 2) {\n+                throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), \"Cannot handle approx_distinct function \" + aggregation);\n+            }\n+            Selection selection = inputSelections.get(getVariableReference(inputs.get(0)));\n+            if (inputs.size() == 1) {\n+                return format(\"DISTINCTCOUNTHLL(%s)\", selection);\n+            }\n+            RowExpression standardErrorInput = inputs.get(1);\n+            String standardErrorString;\n+            if (standardErrorInput instanceof ConstantExpression) {\n+                standardErrorString = getLiteralAsString((ConstantExpression) standardErrorInput);\n+            }\n+            else if (standardErrorInput instanceof VariableReferenceExpression) {\n+                Selection fraction = inputSelections.get(standardErrorInput);\n+                if (fraction.getOrigin() != LITERAL) {\n+                    throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(),\n+                            \"Cannot handle approx_distinct standard error argument be a non literal \" + aggregation);\n+                }\n+                standardErrorString = fraction.getDefinition();\n+            }\n+            else {\n+                throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), \"Expected the standard error to be a constant or a variable \" + standardErrorInput);\n+            }\n+\n+            double standardError = Double.parseDouble(standardErrorString);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE2MTk4OQ=="}, "originalCommit": {"oid": "8a7c5884403359370f895f2e1ccdb15f5919912e"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEwNjA1MTAwOnYy", "diffSide": "RIGHT", "path": "presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/query/TestPinotQueryGenerator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxODo1MDoyM1rOHZLXKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxOTo0MTozNVrOHZM-qw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE2MjYwMg==", "bodyText": "Does testing with approx_distinct(fare, 0) ... 0 error make sense ? I think that should throw an error. Right ?", "url": "https://github.com/prestodb/presto/pull/15231#discussion_r496162602", "createdAt": "2020-09-28T18:50:23Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/query/TestPinotQueryGenerator.java", "diffHunk": "@@ -269,6 +269,9 @@ public void testPercentileAggregation()\n     public void testApproxDistinct()\n     {\n         testUnaryAggregationHelper((planBuilder, aggregationBuilder) -> aggregationBuilder.addAggregation(planBuilder.variable(\"agg\"), getRowExpression(\"approx_distinct(fare)\", defaultSessionHolder)), \"DISTINCTCOUNTHLL(fare)\");\n+        testUnaryAggregationHelper((planBuilder, aggregationBuilder) -> aggregationBuilder.addAggregation(planBuilder.variable(\"agg\"), getRowExpression(\"approx_distinct(fare, 0.1)\", defaultSessionHolder)), \"DISTINCTCOUNTHLL(fare, 6)\");\n+        testUnaryAggregationHelper((planBuilder, aggregationBuilder) -> aggregationBuilder.addAggregation(planBuilder.variable(\"agg\"), getRowExpression(\"approx_distinct(fare, 0.02)\", defaultSessionHolder)), \"DISTINCTCOUNTHLL(fare, 11)\");\n+        testUnaryAggregationHelper((planBuilder, aggregationBuilder) -> aggregationBuilder.addAggregation(planBuilder.variable(\"agg\"), getRowExpression(\"approx_distinct(fare, 0.01)\", defaultSessionHolder)), \"DISTINCTCOUNTHLL(fare, 13)\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a7c5884403359370f895f2e1ccdb15f5919912e"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE4OTA5OQ==", "bodyText": "added the test with invalid params", "url": "https://github.com/prestodb/presto/pull/15231#discussion_r496189099", "createdAt": "2020-09-28T19:41:35Z", "author": {"login": "xiangfu0"}, "path": "presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/query/TestPinotQueryGenerator.java", "diffHunk": "@@ -269,6 +269,9 @@ public void testPercentileAggregation()\n     public void testApproxDistinct()\n     {\n         testUnaryAggregationHelper((planBuilder, aggregationBuilder) -> aggregationBuilder.addAggregation(planBuilder.variable(\"agg\"), getRowExpression(\"approx_distinct(fare)\", defaultSessionHolder)), \"DISTINCTCOUNTHLL(fare)\");\n+        testUnaryAggregationHelper((planBuilder, aggregationBuilder) -> aggregationBuilder.addAggregation(planBuilder.variable(\"agg\"), getRowExpression(\"approx_distinct(fare, 0.1)\", defaultSessionHolder)), \"DISTINCTCOUNTHLL(fare, 6)\");\n+        testUnaryAggregationHelper((planBuilder, aggregationBuilder) -> aggregationBuilder.addAggregation(planBuilder.variable(\"agg\"), getRowExpression(\"approx_distinct(fare, 0.02)\", defaultSessionHolder)), \"DISTINCTCOUNTHLL(fare, 11)\");\n+        testUnaryAggregationHelper((planBuilder, aggregationBuilder) -> aggregationBuilder.addAggregation(planBuilder.variable(\"agg\"), getRowExpression(\"approx_distinct(fare, 0.01)\", defaultSessionHolder)), \"DISTINCTCOUNTHLL(fare, 13)\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE2MjYwMg=="}, "originalCommit": {"oid": "8a7c5884403359370f895f2e1ccdb15f5919912e"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyNTkyODc0OnYy", "diffSide": "RIGHT", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGenerator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQxODoyMTo0NVrOHcJRtA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQxOTo0NDo1M1rOHcJvVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI3NDE2NA==", "bodyText": "one param per line; leave the first line empty", "url": "https://github.com/prestodb/presto/pull/15231#discussion_r499274164", "createdAt": "2020-10-04T18:21:45Z", "author": {"login": "highker"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGenerator.java", "diffHunk": "@@ -392,6 +395,68 @@ else if (fractionInput instanceof VariableReferenceExpression) {\n             return format(\"PERCENTILEEST%d(%s)\", percentile, inputSelections.get(getVariableReference(inputs.get(0))));\n         }\n \n+        private String handleApproxDistinct(CallExpression aggregation, Map<VariableReferenceExpression, Selection> inputSelections)\n+        {\n+            List<RowExpression> inputs = aggregation.getArguments();\n+            if (inputs.isEmpty() || inputs.size() > 2) {\n+                throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), \"Cannot handle approx_distinct function \" + aggregation);\n+            }\n+            Selection selection = inputSelections.get(getVariableReference(inputs.get(0)));\n+            if (inputs.size() == 1) {\n+                return format(\"DISTINCTCOUNTHLL(%s)\", selection);\n+            }\n+            RowExpression standardErrorInput = inputs.get(1);\n+            String standardErrorString;\n+            if (standardErrorInput instanceof ConstantExpression) {\n+                standardErrorString = getLiteralAsString((ConstantExpression) standardErrorInput);\n+            }\n+            else if (standardErrorInput instanceof VariableReferenceExpression) {\n+                Selection fraction = inputSelections.get(standardErrorInput);\n+                if (fraction.getOrigin() != LITERAL) {\n+                    throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "331deb8e840f88c9a1aaf7320a6f1314d47cf95a"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI4MTc1MA==", "bodyText": "done.", "url": "https://github.com/prestodb/presto/pull/15231#discussion_r499281750", "createdAt": "2020-10-04T19:44:53Z", "author": {"login": "xiangfu0"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGenerator.java", "diffHunk": "@@ -392,6 +395,68 @@ else if (fractionInput instanceof VariableReferenceExpression) {\n             return format(\"PERCENTILEEST%d(%s)\", percentile, inputSelections.get(getVariableReference(inputs.get(0))));\n         }\n \n+        private String handleApproxDistinct(CallExpression aggregation, Map<VariableReferenceExpression, Selection> inputSelections)\n+        {\n+            List<RowExpression> inputs = aggregation.getArguments();\n+            if (inputs.isEmpty() || inputs.size() > 2) {\n+                throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), \"Cannot handle approx_distinct function \" + aggregation);\n+            }\n+            Selection selection = inputSelections.get(getVariableReference(inputs.get(0)));\n+            if (inputs.size() == 1) {\n+                return format(\"DISTINCTCOUNTHLL(%s)\", selection);\n+            }\n+            RowExpression standardErrorInput = inputs.get(1);\n+            String standardErrorString;\n+            if (standardErrorInput instanceof ConstantExpression) {\n+                standardErrorString = getLiteralAsString((ConstantExpression) standardErrorInput);\n+            }\n+            else if (standardErrorInput instanceof VariableReferenceExpression) {\n+                Selection fraction = inputSelections.get(standardErrorInput);\n+                if (fraction.getOrigin() != LITERAL) {\n+                    throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI3NDE2NA=="}, "originalCommit": {"oid": "331deb8e840f88c9a1aaf7320a6f1314d47cf95a"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyNTkzMDcwOnYy", "diffSide": "RIGHT", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGenerator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQxODoyNDoyM1rOHcJSqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQxOTo0NDoxNVrOHcJvIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI3NDQwOQ==", "bodyText": "one param per line; leave the first line empty\n%d is incorrect. %f is the one to use. Feel free to adjust precision with %f", "url": "https://github.com/prestodb/presto/pull/15231#discussion_r499274409", "createdAt": "2020-10-04T18:24:23Z", "author": {"login": "highker"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGenerator.java", "diffHunk": "@@ -392,6 +395,68 @@ else if (fractionInput instanceof VariableReferenceExpression) {\n             return format(\"PERCENTILEEST%d(%s)\", percentile, inputSelections.get(getVariableReference(inputs.get(0))));\n         }\n \n+        private String handleApproxDistinct(CallExpression aggregation, Map<VariableReferenceExpression, Selection> inputSelections)\n+        {\n+            List<RowExpression> inputs = aggregation.getArguments();\n+            if (inputs.isEmpty() || inputs.size() > 2) {\n+                throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), \"Cannot handle approx_distinct function \" + aggregation);\n+            }\n+            Selection selection = inputSelections.get(getVariableReference(inputs.get(0)));\n+            if (inputs.size() == 1) {\n+                return format(\"DISTINCTCOUNTHLL(%s)\", selection);\n+            }\n+            RowExpression standardErrorInput = inputs.get(1);\n+            String standardErrorString;\n+            if (standardErrorInput instanceof ConstantExpression) {\n+                standardErrorString = getLiteralAsString((ConstantExpression) standardErrorInput);\n+            }\n+            else if (standardErrorInput instanceof VariableReferenceExpression) {\n+                Selection fraction = inputSelections.get(standardErrorInput);\n+                if (fraction.getOrigin() != LITERAL) {\n+                    throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(),\n+                            \"Cannot handle approx_distinct standard error argument be a non literal \" + aggregation);\n+                }\n+                standardErrorString = fraction.getDefinition();\n+            }\n+            else {\n+                throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), \"Expected the standard error to be a constant or a variable \" + standardErrorInput);\n+            }\n+\n+            double standardError;\n+            try {\n+                standardError = Double.parseDouble(standardErrorString);\n+                if (standardError <= LOWEST_APPROX_DISTINCT_MAX_STANDARD_ERROR || standardError >= HIGHEST_APPROX_DISTINCT_MAX_STANDARD_ERROR) {\n+                    throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), format(\"Cannot handle approx_distinct parsed as %d from input %s (function %s)\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "331deb8e840f88c9a1aaf7320a6f1314d47cf95a"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI4MTY5Ng==", "bodyText": "done.", "url": "https://github.com/prestodb/presto/pull/15231#discussion_r499281696", "createdAt": "2020-10-04T19:44:15Z", "author": {"login": "xiangfu0"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGenerator.java", "diffHunk": "@@ -392,6 +395,68 @@ else if (fractionInput instanceof VariableReferenceExpression) {\n             return format(\"PERCENTILEEST%d(%s)\", percentile, inputSelections.get(getVariableReference(inputs.get(0))));\n         }\n \n+        private String handleApproxDistinct(CallExpression aggregation, Map<VariableReferenceExpression, Selection> inputSelections)\n+        {\n+            List<RowExpression> inputs = aggregation.getArguments();\n+            if (inputs.isEmpty() || inputs.size() > 2) {\n+                throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), \"Cannot handle approx_distinct function \" + aggregation);\n+            }\n+            Selection selection = inputSelections.get(getVariableReference(inputs.get(0)));\n+            if (inputs.size() == 1) {\n+                return format(\"DISTINCTCOUNTHLL(%s)\", selection);\n+            }\n+            RowExpression standardErrorInput = inputs.get(1);\n+            String standardErrorString;\n+            if (standardErrorInput instanceof ConstantExpression) {\n+                standardErrorString = getLiteralAsString((ConstantExpression) standardErrorInput);\n+            }\n+            else if (standardErrorInput instanceof VariableReferenceExpression) {\n+                Selection fraction = inputSelections.get(standardErrorInput);\n+                if (fraction.getOrigin() != LITERAL) {\n+                    throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(),\n+                            \"Cannot handle approx_distinct standard error argument be a non literal \" + aggregation);\n+                }\n+                standardErrorString = fraction.getDefinition();\n+            }\n+            else {\n+                throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), \"Expected the standard error to be a constant or a variable \" + standardErrorInput);\n+            }\n+\n+            double standardError;\n+            try {\n+                standardError = Double.parseDouble(standardErrorString);\n+                if (standardError <= LOWEST_APPROX_DISTINCT_MAX_STANDARD_ERROR || standardError >= HIGHEST_APPROX_DISTINCT_MAX_STANDARD_ERROR) {\n+                    throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), format(\"Cannot handle approx_distinct parsed as %d from input %s (function %s)\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI3NDQwOQ=="}, "originalCommit": {"oid": "331deb8e840f88c9a1aaf7320a6f1314d47cf95a"}, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyNTkzMDc4OnYy", "diffSide": "RIGHT", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGenerator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQxODoyNDozMlrOHcJStg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQxOTo0NDoxMlrOHcJvHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI3NDQyMg==", "bodyText": "one param per line; leave the first line empty", "url": "https://github.com/prestodb/presto/pull/15231#discussion_r499274422", "createdAt": "2020-10-04T18:24:32Z", "author": {"login": "highker"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGenerator.java", "diffHunk": "@@ -392,6 +395,68 @@ else if (fractionInput instanceof VariableReferenceExpression) {\n             return format(\"PERCENTILEEST%d(%s)\", percentile, inputSelections.get(getVariableReference(inputs.get(0))));\n         }\n \n+        private String handleApproxDistinct(CallExpression aggregation, Map<VariableReferenceExpression, Selection> inputSelections)\n+        {\n+            List<RowExpression> inputs = aggregation.getArguments();\n+            if (inputs.isEmpty() || inputs.size() > 2) {\n+                throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), \"Cannot handle approx_distinct function \" + aggregation);\n+            }\n+            Selection selection = inputSelections.get(getVariableReference(inputs.get(0)));\n+            if (inputs.size() == 1) {\n+                return format(\"DISTINCTCOUNTHLL(%s)\", selection);\n+            }\n+            RowExpression standardErrorInput = inputs.get(1);\n+            String standardErrorString;\n+            if (standardErrorInput instanceof ConstantExpression) {\n+                standardErrorString = getLiteralAsString((ConstantExpression) standardErrorInput);\n+            }\n+            else if (standardErrorInput instanceof VariableReferenceExpression) {\n+                Selection fraction = inputSelections.get(standardErrorInput);\n+                if (fraction.getOrigin() != LITERAL) {\n+                    throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(),\n+                            \"Cannot handle approx_distinct standard error argument be a non literal \" + aggregation);\n+                }\n+                standardErrorString = fraction.getDefinition();\n+            }\n+            else {\n+                throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), \"Expected the standard error to be a constant or a variable \" + standardErrorInput);\n+            }\n+\n+            double standardError;\n+            try {\n+                standardError = Double.parseDouble(standardErrorString);\n+                if (standardError <= LOWEST_APPROX_DISTINCT_MAX_STANDARD_ERROR || standardError >= HIGHEST_APPROX_DISTINCT_MAX_STANDARD_ERROR) {\n+                    throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), format(\"Cannot handle approx_distinct parsed as %d from input %s (function %s)\",\n+                            standardError, standardErrorString, aggregation));\n+                }\n+            }\n+            catch (Exception e) {\n+                throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), format(\"Cannot handle approx_distinct parsing to numerical value from input %s (function %s)\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "331deb8e840f88c9a1aaf7320a6f1314d47cf95a"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI4MTY5NA==", "bodyText": "done.", "url": "https://github.com/prestodb/presto/pull/15231#discussion_r499281694", "createdAt": "2020-10-04T19:44:12Z", "author": {"login": "xiangfu0"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGenerator.java", "diffHunk": "@@ -392,6 +395,68 @@ else if (fractionInput instanceof VariableReferenceExpression) {\n             return format(\"PERCENTILEEST%d(%s)\", percentile, inputSelections.get(getVariableReference(inputs.get(0))));\n         }\n \n+        private String handleApproxDistinct(CallExpression aggregation, Map<VariableReferenceExpression, Selection> inputSelections)\n+        {\n+            List<RowExpression> inputs = aggregation.getArguments();\n+            if (inputs.isEmpty() || inputs.size() > 2) {\n+                throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), \"Cannot handle approx_distinct function \" + aggregation);\n+            }\n+            Selection selection = inputSelections.get(getVariableReference(inputs.get(0)));\n+            if (inputs.size() == 1) {\n+                return format(\"DISTINCTCOUNTHLL(%s)\", selection);\n+            }\n+            RowExpression standardErrorInput = inputs.get(1);\n+            String standardErrorString;\n+            if (standardErrorInput instanceof ConstantExpression) {\n+                standardErrorString = getLiteralAsString((ConstantExpression) standardErrorInput);\n+            }\n+            else if (standardErrorInput instanceof VariableReferenceExpression) {\n+                Selection fraction = inputSelections.get(standardErrorInput);\n+                if (fraction.getOrigin() != LITERAL) {\n+                    throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(),\n+                            \"Cannot handle approx_distinct standard error argument be a non literal \" + aggregation);\n+                }\n+                standardErrorString = fraction.getDefinition();\n+            }\n+            else {\n+                throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), \"Expected the standard error to be a constant or a variable \" + standardErrorInput);\n+            }\n+\n+            double standardError;\n+            try {\n+                standardError = Double.parseDouble(standardErrorString);\n+                if (standardError <= LOWEST_APPROX_DISTINCT_MAX_STANDARD_ERROR || standardError >= HIGHEST_APPROX_DISTINCT_MAX_STANDARD_ERROR) {\n+                    throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), format(\"Cannot handle approx_distinct parsed as %d from input %s (function %s)\",\n+                            standardError, standardErrorString, aggregation));\n+                }\n+            }\n+            catch (Exception e) {\n+                throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), format(\"Cannot handle approx_distinct parsing to numerical value from input %s (function %s)\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI3NDQyMg=="}, "originalCommit": {"oid": "331deb8e840f88c9a1aaf7320a6f1314d47cf95a"}, "originalPosition": 66}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyNTkzMDgyOnYy", "diffSide": "RIGHT", "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGenerator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQxODoyNDozN1rOHcJSuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQxOTo0NDowN1rOHcJvGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI3NDQyNw==", "bodyText": "one param per line; leave the first line empty", "url": "https://github.com/prestodb/presto/pull/15231#discussion_r499274427", "createdAt": "2020-10-04T18:24:37Z", "author": {"login": "highker"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGenerator.java", "diffHunk": "@@ -392,6 +395,68 @@ else if (fractionInput instanceof VariableReferenceExpression) {\n             return format(\"PERCENTILEEST%d(%s)\", percentile, inputSelections.get(getVariableReference(inputs.get(0))));\n         }\n \n+        private String handleApproxDistinct(CallExpression aggregation, Map<VariableReferenceExpression, Selection> inputSelections)\n+        {\n+            List<RowExpression> inputs = aggregation.getArguments();\n+            if (inputs.isEmpty() || inputs.size() > 2) {\n+                throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), \"Cannot handle approx_distinct function \" + aggregation);\n+            }\n+            Selection selection = inputSelections.get(getVariableReference(inputs.get(0)));\n+            if (inputs.size() == 1) {\n+                return format(\"DISTINCTCOUNTHLL(%s)\", selection);\n+            }\n+            RowExpression standardErrorInput = inputs.get(1);\n+            String standardErrorString;\n+            if (standardErrorInput instanceof ConstantExpression) {\n+                standardErrorString = getLiteralAsString((ConstantExpression) standardErrorInput);\n+            }\n+            else if (standardErrorInput instanceof VariableReferenceExpression) {\n+                Selection fraction = inputSelections.get(standardErrorInput);\n+                if (fraction.getOrigin() != LITERAL) {\n+                    throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(),\n+                            \"Cannot handle approx_distinct standard error argument be a non literal \" + aggregation);\n+                }\n+                standardErrorString = fraction.getDefinition();\n+            }\n+            else {\n+                throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), \"Expected the standard error to be a constant or a variable \" + standardErrorInput);\n+            }\n+\n+            double standardError;\n+            try {\n+                standardError = Double.parseDouble(standardErrorString);\n+                if (standardError <= LOWEST_APPROX_DISTINCT_MAX_STANDARD_ERROR || standardError >= HIGHEST_APPROX_DISTINCT_MAX_STANDARD_ERROR) {\n+                    throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), format(\"Cannot handle approx_distinct parsed as %d from input %s (function %s)\",\n+                            standardError, standardErrorString, aggregation));\n+                }\n+            }\n+            catch (Exception e) {\n+                throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), format(\"Cannot handle approx_distinct parsing to numerical value from input %s (function %s)\",\n+                        standardErrorString, aggregation));\n+            }\n+            // Pinot uses DISTINCTCOUNTHLL to do distinct count estimation, with hyperloglog algorithm.\n+            //\n+            // The HyperLogLog (HLL) data structure is a probabilistic data structure used to estimate the cardinality\n+            // of a data set.\n+            // In order to construct HLL data structure, the parameter log2m is used which represents the number of\n+            // registers used internally by HLL.\n+            //\n+            // If we want a higher accuracy, we need to set these to higher values. Such a configuration\n+            // will have additional overhead because our HLL will occupy more memory. If we're fine with lower accuracy,\n+            // we can lower those parameters, and our HLL will occupy less memory.\n+            //\n+            // The relative standard deviation of HyperLoglog is:\n+            //     rsd = 1.106 / sqrt(2^(log2m))\n+            // So:\n+            //     log2m = 2 * log(1.106 / rsd) / log(2)\n+            int log2m = (int) (2 * Math.log(1.106 / standardError) / Math.log(2));\n+            if (log2m < 1) {\n+                throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), format(\"Cannot handle approx_distinct, the log2m generated from error is %d from input %s (function %s)\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "331deb8e840f88c9a1aaf7320a6f1314d47cf95a"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI4MTY5MA==", "bodyText": "done.", "url": "https://github.com/prestodb/presto/pull/15231#discussion_r499281690", "createdAt": "2020-10-04T19:44:07Z", "author": {"login": "xiangfu0"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/query/PinotQueryGenerator.java", "diffHunk": "@@ -392,6 +395,68 @@ else if (fractionInput instanceof VariableReferenceExpression) {\n             return format(\"PERCENTILEEST%d(%s)\", percentile, inputSelections.get(getVariableReference(inputs.get(0))));\n         }\n \n+        private String handleApproxDistinct(CallExpression aggregation, Map<VariableReferenceExpression, Selection> inputSelections)\n+        {\n+            List<RowExpression> inputs = aggregation.getArguments();\n+            if (inputs.isEmpty() || inputs.size() > 2) {\n+                throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), \"Cannot handle approx_distinct function \" + aggregation);\n+            }\n+            Selection selection = inputSelections.get(getVariableReference(inputs.get(0)));\n+            if (inputs.size() == 1) {\n+                return format(\"DISTINCTCOUNTHLL(%s)\", selection);\n+            }\n+            RowExpression standardErrorInput = inputs.get(1);\n+            String standardErrorString;\n+            if (standardErrorInput instanceof ConstantExpression) {\n+                standardErrorString = getLiteralAsString((ConstantExpression) standardErrorInput);\n+            }\n+            else if (standardErrorInput instanceof VariableReferenceExpression) {\n+                Selection fraction = inputSelections.get(standardErrorInput);\n+                if (fraction.getOrigin() != LITERAL) {\n+                    throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(),\n+                            \"Cannot handle approx_distinct standard error argument be a non literal \" + aggregation);\n+                }\n+                standardErrorString = fraction.getDefinition();\n+            }\n+            else {\n+                throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), \"Expected the standard error to be a constant or a variable \" + standardErrorInput);\n+            }\n+\n+            double standardError;\n+            try {\n+                standardError = Double.parseDouble(standardErrorString);\n+                if (standardError <= LOWEST_APPROX_DISTINCT_MAX_STANDARD_ERROR || standardError >= HIGHEST_APPROX_DISTINCT_MAX_STANDARD_ERROR) {\n+                    throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), format(\"Cannot handle approx_distinct parsed as %d from input %s (function %s)\",\n+                            standardError, standardErrorString, aggregation));\n+                }\n+            }\n+            catch (Exception e) {\n+                throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), format(\"Cannot handle approx_distinct parsing to numerical value from input %s (function %s)\",\n+                        standardErrorString, aggregation));\n+            }\n+            // Pinot uses DISTINCTCOUNTHLL to do distinct count estimation, with hyperloglog algorithm.\n+            //\n+            // The HyperLogLog (HLL) data structure is a probabilistic data structure used to estimate the cardinality\n+            // of a data set.\n+            // In order to construct HLL data structure, the parameter log2m is used which represents the number of\n+            // registers used internally by HLL.\n+            //\n+            // If we want a higher accuracy, we need to set these to higher values. Such a configuration\n+            // will have additional overhead because our HLL will occupy more memory. If we're fine with lower accuracy,\n+            // we can lower those parameters, and our HLL will occupy less memory.\n+            //\n+            // The relative standard deviation of HyperLoglog is:\n+            //     rsd = 1.106 / sqrt(2^(log2m))\n+            // So:\n+            //     log2m = 2 * log(1.106 / rsd) / log(2)\n+            int log2m = (int) (2 * Math.log(1.106 / standardError) / Math.log(2));\n+            if (log2m < 1) {\n+                throw new PinotException(PINOT_UNSUPPORTED_EXPRESSION, Optional.empty(), format(\"Cannot handle approx_distinct, the log2m generated from error is %d from input %s (function %s)\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI3NDQyNw=="}, "originalCommit": {"oid": "331deb8e840f88c9a1aaf7320a6f1314d47cf95a"}, "originalPosition": 86}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3447, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}