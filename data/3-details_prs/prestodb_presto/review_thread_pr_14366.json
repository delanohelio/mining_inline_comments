{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAwNjk5NzMy", "number": 14366, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMVQwMToxODowN1rODw5YnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QyMjozODowMFrOD27cFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyNTk4NDI5OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/com/facebook/presto/sql/rewrite/ShowQueriesRewrite.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMVQwMToxODowN1rOGEJO_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMlQwMzowNjo0OFrOGERw8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk5ODc4MA==", "bodyText": "Wow so we actually rebuild the create function? I thought we remember it in the DB at creation time and just return it.", "url": "https://github.com/prestodb/presto/pull/14366#discussion_r406998780", "createdAt": "2020-04-11T01:18:07Z", "author": {"login": "kaikalur"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/rewrite/ShowQueriesRewrite.java", "diffHunk": "@@ -478,6 +492,66 @@ protected Node visitShowCreate(ShowCreate node, Void context)\n             throw new UnsupportedOperationException(\"SHOW CREATE only supported for tables and views\");\n         }\n \n+        @Override\n+        protected Node visitShowCreateFunction(ShowCreateFunction node, Void context)\n+        {\n+            QualifiedFunctionName functionName = qualifyFunctionName(node.getName());\n+            Collection<? extends SqlFunction> functions = metadata.getFunctionManager().getFunctions(session.getRequiredTransactionId(), functionName);\n+            if (node.getParameterTypes().isPresent()) {\n+                List<TypeSignature> parameterTypes = node.getParameterTypes().get().stream()\n+                        .map(TypeSignature::parseTypeSignature)\n+                        .collect(toImmutableList());\n+                functions = functions.stream()\n+                        .filter(function -> function.getSignature().getArgumentTypes().equals(parameterTypes))\n+                        .collect(toImmutableList());\n+            }\n+            if (functions.isEmpty()) {\n+                String types = node.getParameterTypes().isPresent()\n+                        ? format(\"(%s)\", Joiner.on(\", \").join(node.getParameterTypes().get()))\n+                        : \"\";\n+                throw new PrestoException(FUNCTION_NOT_FOUND, format(\"Function not found: %s%s\", functionName, types));\n+            }\n+\n+            ImmutableList.Builder<Expression> rows = ImmutableList.builder();\n+            for (SqlFunction function : functions) {\n+                if (!(function instanceof SqlInvokedFunction)) {\n+                    throw new PrestoException(GENERIC_USER_ERROR, \"SHOW CREATE FUNCTION only supported for SQL functions\");\n+                }\n+\n+                SqlInvokedFunction sqlFunction = (SqlInvokedFunction) function;\n+                CreateFunction createFunction = new CreateFunction(\n+                        node.getName(),\n+                        false,\n+                        sqlFunction.getParameters().stream()\n+                                .map(parameter -> new SqlParameterDeclaration(new Identifier(parameter.getName(), true), parameter.getType().toString()))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f6be7e81477f8d99e6195ee2bbfda6560858f6c"}, "originalPosition": 119}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzEzODU0Nw==", "bodyText": "Yes, we're storing different component of a SQL function as separate columns in the DB, as opposed to the entire CREATE FUNCTION statement.", "url": "https://github.com/prestodb/presto/pull/14366#discussion_r407138547", "createdAt": "2020-04-12T03:06:48Z", "author": {"login": "caithagoras"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/rewrite/ShowQueriesRewrite.java", "diffHunk": "@@ -478,6 +492,66 @@ protected Node visitShowCreate(ShowCreate node, Void context)\n             throw new UnsupportedOperationException(\"SHOW CREATE only supported for tables and views\");\n         }\n \n+        @Override\n+        protected Node visitShowCreateFunction(ShowCreateFunction node, Void context)\n+        {\n+            QualifiedFunctionName functionName = qualifyFunctionName(node.getName());\n+            Collection<? extends SqlFunction> functions = metadata.getFunctionManager().getFunctions(session.getRequiredTransactionId(), functionName);\n+            if (node.getParameterTypes().isPresent()) {\n+                List<TypeSignature> parameterTypes = node.getParameterTypes().get().stream()\n+                        .map(TypeSignature::parseTypeSignature)\n+                        .collect(toImmutableList());\n+                functions = functions.stream()\n+                        .filter(function -> function.getSignature().getArgumentTypes().equals(parameterTypes))\n+                        .collect(toImmutableList());\n+            }\n+            if (functions.isEmpty()) {\n+                String types = node.getParameterTypes().isPresent()\n+                        ? format(\"(%s)\", Joiner.on(\", \").join(node.getParameterTypes().get()))\n+                        : \"\";\n+                throw new PrestoException(FUNCTION_NOT_FOUND, format(\"Function not found: %s%s\", functionName, types));\n+            }\n+\n+            ImmutableList.Builder<Expression> rows = ImmutableList.builder();\n+            for (SqlFunction function : functions) {\n+                if (!(function instanceof SqlInvokedFunction)) {\n+                    throw new PrestoException(GENERIC_USER_ERROR, \"SHOW CREATE FUNCTION only supported for SQL functions\");\n+                }\n+\n+                SqlInvokedFunction sqlFunction = (SqlInvokedFunction) function;\n+                CreateFunction createFunction = new CreateFunction(\n+                        node.getName(),\n+                        false,\n+                        sqlFunction.getParameters().stream()\n+                                .map(parameter -> new SqlParameterDeclaration(new Identifier(parameter.getName(), true), parameter.getType().toString()))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk5ODc4MA=="}, "originalCommit": {"oid": "2f6be7e81477f8d99e6195ee2bbfda6560858f6c"}, "originalPosition": 119}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyNTk5MTY5OnYy", "diffSide": "RIGHT", "path": "presto-tests/src/test/java/com/facebook/presto/tests/TestSqlFunctions.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMVQwMToyNzowOVrOGEJSsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMlQwMzowNjowMVrOGERw2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk5OTczMA==", "bodyText": "Also add test for things like 'ARRAY_AGG'. What happens when someone tries that?", "url": "https://github.com/prestodb/presto/pull/14366#discussion_r406999730", "createdAt": "2020-04-11T01:27:09Z", "author": {"login": "kaikalur"}, "path": "presto-tests/src/test/java/com/facebook/presto/tests/TestSqlFunctions.java", "diffHunk": "@@ -73,4 +121,81 @@ public void testDropFunctionInvalidFunctionName()\n                 \"DROP FUNCTION presto.default.sin (double)\",\n                 \"Cannot drop function in built-in function namespace: presto\\\\.default\\\\.sin\");\n     }\n+\n+    @Test\n+    public void testInvalidFunctionName()\n+    {\n+        assertQueryFails(\"SELECT x.y(1)\", \".*Non-builtin functions must be referenced by 'catalog\\\\.schema\\\\.function_name', found: x\\\\.y\");\n+        assertQueryFails(\"SELECT x.y.z.w()\", \".*Non-builtin functions must be referenced by 'catalog\\\\.schema\\\\.function_name', found: x\\\\.y\\\\.z\\\\.w\");\n+    }\n+\n+    @Test\n+    public void testSqlFunctions()\n+    {\n+        assertQuerySucceeds(\"CREATE FUNCTION testing.common.array_append(a array<int>, x int)\\n\" +\n+                \"RETURNS array<int>\\n\" +\n+                \"RETURN concat(a, array[x])\");\n+        assertQuery(\"SELECT testing.common.array_append(ARRAY[1, 2, 4], 8)\", \"SELECT ARRAY[1, 2, 4, 8]\");\n+    }\n+\n+    @Test\n+    public void testShowCreateFunctions()\n+    {\n+        @Language(\"SQL\") String createFunctionInt = \"CREATE FUNCTION testing.common.array_append(a array<int>, x int)\\n\" +\n+                \"RETURNS array<int>\\n\" +\n+                \"RETURN concat(a, array[x])\";\n+        @Language(\"SQL\") String createFunctionDouble = \"CREATE FUNCTION testing.common.array_append(a array<double>, x double)\\n\" +\n+                \"RETURNS array<double>\\n\" +\n+                \"RETURN concat(a, array[x])\";\n+        @Language(\"SQL\") String createFunctionRand = \"CREATE FUNCTION testing.common.rand()\\n\" +\n+                \"RETURNS double\\n\" +\n+                \"RETURN rand()\";\n+        String createFunctionIntFormatted = \"CREATE FUNCTION testing.common.array_append (\\n\" +\n+                \"   \\\"a\\\" ARRAY(integer),\\n\" +\n+                \"   \\\"x\\\" integer\\n\" +\n+                \")\\n\" +\n+                \"RETURNS ARRAY(integer)\\n\" +\n+                \"COMMENT ''\\n\" +\n+                \"LANGUAGE SQL\\n\" +\n+                \"NOT DETERMINISTIC\\n\" +\n+                \"CALLED ON NULL INPUT\\n\" +\n+                \"RETURN \\\"concat\\\"(a, ARRAY[x])\";\n+        String createFunctionDoubleFormatted = \"CREATE FUNCTION testing.common.array_append (\\n\" +\n+                \"   \\\"a\\\" ARRAY(double),\\n\" +\n+                \"   \\\"x\\\" double\\n\" +\n+                \")\\n\" +\n+                \"RETURNS ARRAY(double)\\n\" +\n+                \"COMMENT ''\\n\" +\n+                \"LANGUAGE SQL\\n\" +\n+                \"NOT DETERMINISTIC\\n\" +\n+                \"CALLED ON NULL INPUT\\n\" +\n+                \"RETURN \\\"concat\\\"(a, ARRAY[x])\";\n+        String createFunctionRandFormatted = \"CREATE FUNCTION testing.common.rand ()\\n\" +\n+                \"RETURNS double\\n\" +\n+                \"COMMENT ''\\n\" +\n+                \"LANGUAGE SQL\\n\" +\n+                \"NOT DETERMINISTIC\\n\" +\n+                \"CALLED ON NULL INPUT\\n\" +\n+                \"RETURN \\\"rand\\\"()\";\n+        String parameterTypeInt = \"ARRAY(integer), integer\";\n+        String parameterTypeDouble = \"ARRAY(double), double\";\n+\n+        assertQuerySucceeds(createFunctionInt);\n+        assertQuerySucceeds(createFunctionDouble);\n+        assertQuerySucceeds(createFunctionRand);\n+\n+        MaterializedResult rows = computeActual(\"SHOW CREATE FUNCTION testing.common.array_append\");\n+        assertEquals(rows.getRowCount(), 2);\n+        assertEquals(rows.getMaterializedRows().get(0).getFields(), ImmutableList.of(createFunctionDoubleFormatted, parameterTypeDouble));\n+        assertEquals(rows.getMaterializedRows().get(1).getFields(), ImmutableList.of(createFunctionIntFormatted, parameterTypeInt));\n+\n+        rows = computeActual(\"SHOW CREATE FUNCTION testing.common.array_append(array(int), int)\");\n+        assertEquals(rows.getRowCount(), 1);\n+        assertEquals(rows.getMaterializedRows().get(0).getFields(), ImmutableList.of(createFunctionIntFormatted, parameterTypeInt));\n+\n+        rows = computeActual(\"SHOW CREATE FUNCTION testing.common.rand()\");\n+        assertEquals(rows.getMaterializedRows().get(0).getFields(), ImmutableList.of(createFunctionRandFormatted, \"\"));\n+\n+        assertQueryFails(\"SHOW CREATE FUNCTION testing.common.array_append()\", \"Function not found: testing\\\\.common\\\\.array_append\\\\(\\\\)\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f6be7e81477f8d99e6195ee2bbfda6560858f6c"}, "originalPosition": 145}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzEzODUyMg==", "bodyText": "test added", "url": "https://github.com/prestodb/presto/pull/14366#discussion_r407138522", "createdAt": "2020-04-12T03:06:01Z", "author": {"login": "caithagoras"}, "path": "presto-tests/src/test/java/com/facebook/presto/tests/TestSqlFunctions.java", "diffHunk": "@@ -73,4 +121,81 @@ public void testDropFunctionInvalidFunctionName()\n                 \"DROP FUNCTION presto.default.sin (double)\",\n                 \"Cannot drop function in built-in function namespace: presto\\\\.default\\\\.sin\");\n     }\n+\n+    @Test\n+    public void testInvalidFunctionName()\n+    {\n+        assertQueryFails(\"SELECT x.y(1)\", \".*Non-builtin functions must be referenced by 'catalog\\\\.schema\\\\.function_name', found: x\\\\.y\");\n+        assertQueryFails(\"SELECT x.y.z.w()\", \".*Non-builtin functions must be referenced by 'catalog\\\\.schema\\\\.function_name', found: x\\\\.y\\\\.z\\\\.w\");\n+    }\n+\n+    @Test\n+    public void testSqlFunctions()\n+    {\n+        assertQuerySucceeds(\"CREATE FUNCTION testing.common.array_append(a array<int>, x int)\\n\" +\n+                \"RETURNS array<int>\\n\" +\n+                \"RETURN concat(a, array[x])\");\n+        assertQuery(\"SELECT testing.common.array_append(ARRAY[1, 2, 4], 8)\", \"SELECT ARRAY[1, 2, 4, 8]\");\n+    }\n+\n+    @Test\n+    public void testShowCreateFunctions()\n+    {\n+        @Language(\"SQL\") String createFunctionInt = \"CREATE FUNCTION testing.common.array_append(a array<int>, x int)\\n\" +\n+                \"RETURNS array<int>\\n\" +\n+                \"RETURN concat(a, array[x])\";\n+        @Language(\"SQL\") String createFunctionDouble = \"CREATE FUNCTION testing.common.array_append(a array<double>, x double)\\n\" +\n+                \"RETURNS array<double>\\n\" +\n+                \"RETURN concat(a, array[x])\";\n+        @Language(\"SQL\") String createFunctionRand = \"CREATE FUNCTION testing.common.rand()\\n\" +\n+                \"RETURNS double\\n\" +\n+                \"RETURN rand()\";\n+        String createFunctionIntFormatted = \"CREATE FUNCTION testing.common.array_append (\\n\" +\n+                \"   \\\"a\\\" ARRAY(integer),\\n\" +\n+                \"   \\\"x\\\" integer\\n\" +\n+                \")\\n\" +\n+                \"RETURNS ARRAY(integer)\\n\" +\n+                \"COMMENT ''\\n\" +\n+                \"LANGUAGE SQL\\n\" +\n+                \"NOT DETERMINISTIC\\n\" +\n+                \"CALLED ON NULL INPUT\\n\" +\n+                \"RETURN \\\"concat\\\"(a, ARRAY[x])\";\n+        String createFunctionDoubleFormatted = \"CREATE FUNCTION testing.common.array_append (\\n\" +\n+                \"   \\\"a\\\" ARRAY(double),\\n\" +\n+                \"   \\\"x\\\" double\\n\" +\n+                \")\\n\" +\n+                \"RETURNS ARRAY(double)\\n\" +\n+                \"COMMENT ''\\n\" +\n+                \"LANGUAGE SQL\\n\" +\n+                \"NOT DETERMINISTIC\\n\" +\n+                \"CALLED ON NULL INPUT\\n\" +\n+                \"RETURN \\\"concat\\\"(a, ARRAY[x])\";\n+        String createFunctionRandFormatted = \"CREATE FUNCTION testing.common.rand ()\\n\" +\n+                \"RETURNS double\\n\" +\n+                \"COMMENT ''\\n\" +\n+                \"LANGUAGE SQL\\n\" +\n+                \"NOT DETERMINISTIC\\n\" +\n+                \"CALLED ON NULL INPUT\\n\" +\n+                \"RETURN \\\"rand\\\"()\";\n+        String parameterTypeInt = \"ARRAY(integer), integer\";\n+        String parameterTypeDouble = \"ARRAY(double), double\";\n+\n+        assertQuerySucceeds(createFunctionInt);\n+        assertQuerySucceeds(createFunctionDouble);\n+        assertQuerySucceeds(createFunctionRand);\n+\n+        MaterializedResult rows = computeActual(\"SHOW CREATE FUNCTION testing.common.array_append\");\n+        assertEquals(rows.getRowCount(), 2);\n+        assertEquals(rows.getMaterializedRows().get(0).getFields(), ImmutableList.of(createFunctionDoubleFormatted, parameterTypeDouble));\n+        assertEquals(rows.getMaterializedRows().get(1).getFields(), ImmutableList.of(createFunctionIntFormatted, parameterTypeInt));\n+\n+        rows = computeActual(\"SHOW CREATE FUNCTION testing.common.array_append(array(int), int)\");\n+        assertEquals(rows.getRowCount(), 1);\n+        assertEquals(rows.getMaterializedRows().get(0).getFields(), ImmutableList.of(createFunctionIntFormatted, parameterTypeInt));\n+\n+        rows = computeActual(\"SHOW CREATE FUNCTION testing.common.rand()\");\n+        assertEquals(rows.getMaterializedRows().get(0).getFields(), ImmutableList.of(createFunctionRandFormatted, \"\"));\n+\n+        assertQueryFails(\"SHOW CREATE FUNCTION testing.common.array_append()\", \"Function not found: testing\\\\.common\\\\.array_append\\\\(\\\\)\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk5OTczMA=="}, "originalCommit": {"oid": "2f6be7e81477f8d99e6195ee2bbfda6560858f6c"}, "originalPosition": 145}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2OTUwMDQ4OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/com/facebook/presto/sql/rewrite/ShowQueriesRewrite.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwMTozMjo1N1rOGKSpUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QyMjoyNzo1OFrOGM6Xtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzQ0NDQzNQ==", "bodyText": "Hmm, isn't it a little extreme to require transaction to run SHOW CREATE FUNCTION? It's probably ok to just fetch some version?", "url": "https://github.com/prestodb/presto/pull/14366#discussion_r413444435", "createdAt": "2020-04-23T01:32:57Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/rewrite/ShowQueriesRewrite.java", "diffHunk": "@@ -478,6 +492,66 @@ protected Node visitShowCreate(ShowCreate node, Void context)\n             throw new UnsupportedOperationException(\"SHOW CREATE only supported for tables and views\");\n         }\n \n+        @Override\n+        protected Node visitShowCreateFunction(ShowCreateFunction node, Void context)\n+        {\n+            QualifiedFunctionName functionName = qualifyFunctionName(node.getName());\n+            Collection<? extends SqlFunction> functions = metadata.getFunctionManager().getFunctions(session.getRequiredTransactionId(), functionName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a804c92cc315f0e7be3b866dbf90c25886eb9d8"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzQ0NDczMg==", "bodyText": "If you want to require transaction for sql functions, make the error message explicit at least.", "url": "https://github.com/prestodb/presto/pull/14366#discussion_r413444732", "createdAt": "2020-04-23T01:33:53Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/rewrite/ShowQueriesRewrite.java", "diffHunk": "@@ -478,6 +492,66 @@ protected Node visitShowCreate(ShowCreate node, Void context)\n             throw new UnsupportedOperationException(\"SHOW CREATE only supported for tables and views\");\n         }\n \n+        @Override\n+        protected Node visitShowCreateFunction(ShowCreateFunction node, Void context)\n+        {\n+            QualifiedFunctionName functionName = qualifyFunctionName(node.getName());\n+            Collection<? extends SqlFunction> functions = metadata.getFunctionManager().getFunctions(session.getRequiredTransactionId(), functionName);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzQ0NDQzNQ=="}, "originalCommit": {"oid": "2a804c92cc315f0e7be3b866dbf90c25886eb9d8"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE2NTMwMA==", "bodyText": "@rongrong\nFor 1: Transaction ID is guaranteed to exist during query execution, even for any single statement query.\nFor 2: If Transaction ID is missing, we're having an internal error here. The getRequiredTransaction method already checks for transactionId.isPresent() and will throw IllegalArgumentException with an error message, which will then be converted to a GENERIC_INTERNAL_ERROR.", "url": "https://github.com/prestodb/presto/pull/14366#discussion_r414165300", "createdAt": "2020-04-23T22:27:29Z", "author": {"login": "caithagoras"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/rewrite/ShowQueriesRewrite.java", "diffHunk": "@@ -478,6 +492,66 @@ protected Node visitShowCreate(ShowCreate node, Void context)\n             throw new UnsupportedOperationException(\"SHOW CREATE only supported for tables and views\");\n         }\n \n+        @Override\n+        protected Node visitShowCreateFunction(ShowCreateFunction node, Void context)\n+        {\n+            QualifiedFunctionName functionName = qualifyFunctionName(node.getName());\n+            Collection<? extends SqlFunction> functions = metadata.getFunctionManager().getFunctions(session.getRequiredTransactionId(), functionName);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzQ0NDQzNQ=="}, "originalCommit": {"oid": "2a804c92cc315f0e7be3b866dbf90c25886eb9d8"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjE5MjQzOA==", "bodyText": "I don't think missing transaction ID should be an illegal argument exception. I also don't think it's necessary to require transaction ID to exist. The fact that it probably always exist is a different matter. I think function namespaces should still work when there's no transaction. You cannot guarantee versioning consistency, but other than that why it should fail altogether?", "url": "https://github.com/prestodb/presto/pull/14366#discussion_r416192438", "createdAt": "2020-04-27T22:27:58Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/rewrite/ShowQueriesRewrite.java", "diffHunk": "@@ -478,6 +492,66 @@ protected Node visitShowCreate(ShowCreate node, Void context)\n             throw new UnsupportedOperationException(\"SHOW CREATE only supported for tables and views\");\n         }\n \n+        @Override\n+        protected Node visitShowCreateFunction(ShowCreateFunction node, Void context)\n+        {\n+            QualifiedFunctionName functionName = qualifyFunctionName(node.getName());\n+            Collection<? extends SqlFunction> functions = metadata.getFunctionManager().getFunctions(session.getRequiredTransactionId(), functionName);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzQ0NDQzNQ=="}, "originalCommit": {"oid": "2a804c92cc315f0e7be3b866dbf90c25886eb9d8"}, "originalPosition": 92}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2OTUwNjgzOnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/com/facebook/presto/sql/rewrite/ShowQueriesRewrite.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwMTozNTo1MFrOGKSs1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwMTozNTo1MFrOGKSs1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzQ0NTMzNA==", "bodyText": "you can probably just do node.getParameterTypes().map(...)", "url": "https://github.com/prestodb/presto/pull/14366#discussion_r413445334", "createdAt": "2020-04-23T01:35:50Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/rewrite/ShowQueriesRewrite.java", "diffHunk": "@@ -478,6 +492,66 @@ protected Node visitShowCreate(ShowCreate node, Void context)\n             throw new UnsupportedOperationException(\"SHOW CREATE only supported for tables and views\");\n         }\n \n+        @Override\n+        protected Node visitShowCreateFunction(ShowCreateFunction node, Void context)\n+        {\n+            QualifiedFunctionName functionName = qualifyFunctionName(node.getName());\n+            Collection<? extends SqlFunction> functions = metadata.getFunctionManager().getFunctions(session.getRequiredTransactionId(), functionName);\n+            if (node.getParameterTypes().isPresent()) {\n+                List<TypeSignature> parameterTypes = node.getParameterTypes().get().stream()\n+                        .map(TypeSignature::parseTypeSignature)\n+                        .collect(toImmutableList());\n+                functions = functions.stream()\n+                        .filter(function -> function.getSignature().getArgumentTypes().equals(parameterTypes))\n+                        .collect(toImmutableList());\n+            }\n+            if (functions.isEmpty()) {\n+                String types = node.getParameterTypes().isPresent()\n+                        ? format(\"(%s)\", Joiner.on(\", \").join(node.getParameterTypes().get()))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a804c92cc315f0e7be3b866dbf90c25886eb9d8"}, "originalPosition": 103}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2OTUwODIwOnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/com/facebook/presto/sql/rewrite/ShowQueriesRewrite.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwMTozNjoyMVrOGKStiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwMTozNjoyMVrOGKStiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzQ0NTUxNQ==", "bodyText": "is only supported", "url": "https://github.com/prestodb/presto/pull/14366#discussion_r413445515", "createdAt": "2020-04-23T01:36:21Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/rewrite/ShowQueriesRewrite.java", "diffHunk": "@@ -478,6 +492,66 @@ protected Node visitShowCreate(ShowCreate node, Void context)\n             throw new UnsupportedOperationException(\"SHOW CREATE only supported for tables and views\");\n         }\n \n+        @Override\n+        protected Node visitShowCreateFunction(ShowCreateFunction node, Void context)\n+        {\n+            QualifiedFunctionName functionName = qualifyFunctionName(node.getName());\n+            Collection<? extends SqlFunction> functions = metadata.getFunctionManager().getFunctions(session.getRequiredTransactionId(), functionName);\n+            if (node.getParameterTypes().isPresent()) {\n+                List<TypeSignature> parameterTypes = node.getParameterTypes().get().stream()\n+                        .map(TypeSignature::parseTypeSignature)\n+                        .collect(toImmutableList());\n+                functions = functions.stream()\n+                        .filter(function -> function.getSignature().getArgumentTypes().equals(parameterTypes))\n+                        .collect(toImmutableList());\n+            }\n+            if (functions.isEmpty()) {\n+                String types = node.getParameterTypes().isPresent()\n+                        ? format(\"(%s)\", Joiner.on(\", \").join(node.getParameterTypes().get()))\n+                        : \"\";\n+                throw new PrestoException(FUNCTION_NOT_FOUND, format(\"Function not found: %s%s\", functionName, types));\n+            }\n+\n+            ImmutableList.Builder<Expression> rows = ImmutableList.builder();\n+            for (SqlFunction function : functions) {\n+                if (!(function instanceof SqlInvokedFunction)) {\n+                    throw new PrestoException(GENERIC_USER_ERROR, \"SHOW CREATE FUNCTION only supported for SQL functions\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a804c92cc315f0e7be3b866dbf90c25886eb9d8"}, "originalPosition": 111}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2OTUxNjUxOnYy", "diffSide": "RIGHT", "path": "presto-parser/src/main/java/com/facebook/presto/sql/parser/AstBuilder.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwMTo0MDowMVrOGKSyGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwMTo0MDowMVrOGKSyGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzQ0NjY4Mg==", "bodyText": "I like the old way better. It's a bit tedious but it's explicit.", "url": "https://github.com/prestodb/presto/pull/14366#discussion_r413446682", "createdAt": "2020-04-23T01:40:01Z", "author": {"login": "rongrong"}, "path": "presto-parser/src/main/java/com/facebook/presto/sql/parser/AstBuilder.java", "diffHunk": "@@ -2186,11 +2193,14 @@ private static boolean isValidUnicodeEscape(char c)\n         throw new IllegalArgumentException(\"Unsupported quantifier: \" + symbol.getText());\n     }\n \n-    private List<String> getTypes(SqlBaseParser.TypesContext types)\n+    private Optional<List<String>> getTypes(@Nullable SqlBaseParser.TypesContext types)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a804c92cc315f0e7be3b866dbf90c25886eb9d8"}, "originalPosition": 57}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2OTUyMDQ3OnYy", "diffSide": "RIGHT", "path": "presto-spi/src/main/java/com/facebook/presto/spi/StandardErrorCode.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwMTo0MToyN1rOGKS0LQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QyMjoyMjoyMFrOGK-gew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzQ0NzIxMw==", "bodyText": "Where is this used?", "url": "https://github.com/prestodb/presto/pull/14366#discussion_r413447213", "createdAt": "2020-04-23T01:41:27Z", "author": {"login": "rongrong"}, "path": "presto-spi/src/main/java/com/facebook/presto/spi/StandardErrorCode.java", "diffHunk": "@@ -63,6 +63,7 @@\n     QUERY_HAS_TOO_MANY_STAGES(0x0000_0028, USER_ERROR),\n     INVALID_SPATIAL_PARTITIONING(0x0000_0029, USER_ERROR),\n     INVALID_ANALYZE_PROPERTY(0x0000_002A, USER_ERROR),\n+    INVALID_FUNCTION_NAME(0x0000_002B, USER_ERROR),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a804c92cc315f0e7be3b866dbf90c25886eb9d8"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE2MzA2Nw==", "bodyText": "accidental change, removed.", "url": "https://github.com/prestodb/presto/pull/14366#discussion_r414163067", "createdAt": "2020-04-23T22:22:20Z", "author": {"login": "caithagoras"}, "path": "presto-spi/src/main/java/com/facebook/presto/spi/StandardErrorCode.java", "diffHunk": "@@ -63,6 +63,7 @@\n     QUERY_HAS_TOO_MANY_STAGES(0x0000_0028, USER_ERROR),\n     INVALID_SPATIAL_PARTITIONING(0x0000_0029, USER_ERROR),\n     INVALID_ANALYZE_PROPERTY(0x0000_002A, USER_ERROR),\n+    INVALID_FUNCTION_NAME(0x0000_002B, USER_ERROR),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzQ0NzIxMw=="}, "originalCommit": {"oid": "2a804c92cc315f0e7be3b866dbf90c25886eb9d8"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU4OTIzNTQzOnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/com/facebook/presto/metadata/FunctionManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QyMjozODowMFrOGM6pAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQwNTozNzoyNFrOGOaSZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjE5Njg2Ng==", "bodyText": "The implementation here also suggested that TransactionId does not need to be required. FunctionNamespaceManager would happily take an empty transaction handle. So why do you enforce transaction ID as input? It happened to always exists should not be the reason you always require it to exist.", "url": "https://github.com/prestodb/presto/pull/14366#discussion_r416196866", "createdAt": "2020-04-27T22:38:00Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/metadata/FunctionManager.java", "diffHunk": "@@ -200,6 +200,17 @@ public void registerBuiltInFunctions(List<? extends BuiltInFunction> functions)\n                 .collect(toImmutableList());\n     }\n \n+    public Collection<? extends SqlFunction> getFunctions(TransactionId transactionId, QualifiedFunctionName functionName)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "811f0a432004327950f75e551ebad11c4f91d6ce"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc2Mzk0Mw==", "bodyText": "Updated to Optional<TransactionId>.\nWell, I don't think FunctionNamespaceManager happily takes an empty transaction handle. Without a transaction id / transaction handle, engine cannot guarantee correctness of function resolution.\nAnd for now, if you supply an empty transaction handle to a MySQL function namespace manager, it would sadly fail. This is an indication that allowing transaction handle to be optional is not a good design choice. I guess we have that optional because the built-in one doesn't care about transaction (since its function set is non-mutable), but I think it's much better to require function handle in the interface, while the built-in one can just use a dummy handle.\nGiven the current interface as is, I'm fine either way. In case TransactionId is empty: If we require transaction id - fail in engine; if we don't require it - fail in FunctionNamespaceManager; both internal error.", "url": "https://github.com/prestodb/presto/pull/14366#discussion_r417763943", "createdAt": "2020-04-30T05:37:24Z", "author": {"login": "caithagoras"}, "path": "presto-main/src/main/java/com/facebook/presto/metadata/FunctionManager.java", "diffHunk": "@@ -200,6 +200,17 @@ public void registerBuiltInFunctions(List<? extends BuiltInFunction> functions)\n                 .collect(toImmutableList());\n     }\n \n+    public Collection<? extends SqlFunction> getFunctions(TransactionId transactionId, QualifiedFunctionName functionName)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjE5Njg2Ng=="}, "originalCommit": {"oid": "811f0a432004327950f75e551ebad11c4f91d6ce"}, "originalPosition": 13}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2768, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}