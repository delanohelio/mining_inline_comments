{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU5NzY5MjIy", "number": 13934, "title": "Update error code when table is dropped during query execution", "bodyText": "Part of #13935\nFor drop table query, error code is changed from HIVE_METASTORE_ERROR\nto HIVE_TABLE_DROPPED_DURING_QUERY when table exists after query\nstarts execution but dropped before delete operation commits.\nThis PR fixes below scenario\n\nquery A \"drop table T\" starts running\nquery B \"drop table T\" starts running and passes analyze check (table exists at this moment, otherwise, query will fail with error message \"Table does not exist\")\nquery A tries to commit and succeed\nquery B tries to commit and fail\n\nTested by setting breakpoint and running above steps\n== RELEASE NOTE ==\nHive Changes\n* When ``DROP TABLE`` query fails because the table has being dropped by other query before this query finishes,  change error code name from ``HIVE_METASTORE_ERROR`` to  ``HIVE_TABLE_DROPPED_DURING_QUERY``", "createdAt": "2020-01-07T00:24:37Z", "url": "https://github.com/prestodb/presto/pull/13934", "merged": true, "mergeCommit": {"oid": "ce5eeb77387c7ea9e76473d1e7d93ad06a95e2c0"}, "closed": true, "closedAt": "2020-01-23T20:53:34Z", "author": {"login": "viczhang861"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb31uHPAFqTMzODk3NTc3Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb88uF3AFqTM0NjkxOTIyNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4OTc1Nzcy", "url": "https://github.com/prestodb/presto/pull/13934#pullrequestreview-338975772", "createdAt": "2020-01-07T00:36:05Z", "commit": {"oid": "af5ddf854cee5cf47a64104fc9b7c3b9741b1fc0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QwMDozNjowNlrOFatINQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QwMDozNjowNlrOFatINQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU0NjY3Nw==", "bodyText": "@viczhang861 I feel that this logic is based on an assumption that this code may not be in a position to make. E.g. this would break if the caller code changes and it seems unlikely that the caller is aware about this logic. If that's not the case, would you explain why this assumption is valid?", "url": "https://github.com/prestodb/presto/pull/13934#discussion_r363546677", "createdAt": "2020-01-07T00:36:06Z", "author": {"login": "mbasmanova"}, "path": "presto-hive-metastore/src/main/java/com/facebook/presto/hive/metastore/SemiTransactionalHiveMetastore.java", "diffHunk": "@@ -1500,7 +1500,13 @@ private void executeIrreversibleMetastoreOperations()\n                 }\n                 Joiner.on(\"; \").appendTo(message, failedIrreversibleOperationDescriptions);\n \n-                PrestoException prestoException = new PrestoException(HIVE_METASTORE_ERROR, message.toString());\n+                PrestoException prestoException;\n+                if (suppressedExceptions.size() == 1 && suppressedExceptions.get(0) instanceof TableNotFoundException) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "af5ddf854cee5cf47a64104fc9b7c3b9741b1fc0"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5MDA4MDc5", "url": "https://github.com/prestodb/presto/pull/13934#pullrequestreview-339008079", "createdAt": "2020-01-07T02:55:09Z", "commit": {"oid": "af5ddf854cee5cf47a64104fc9b7c3b9741b1fc0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "af5ddf854cee5cf47a64104fc9b7c3b9741b1fc0", "author": {"user": {"login": "viczhang861", "name": "Vic Zhang"}}, "url": "https://github.com/prestodb/presto/commit/af5ddf854cee5cf47a64104fc9b7c3b9741b1fc0", "committedDate": "2020-01-07T00:08:10Z", "message": "Update error code when table is dropped during query execution"}, "afterCommit": {"oid": "0edc2b96eb074a51d6541f3be444483d2fb12d3a", "author": {"user": {"login": "viczhang861", "name": "Vic Zhang"}}, "url": "https://github.com/prestodb/presto/commit/0edc2b96eb074a51d6541f3be444483d2fb12d3a", "committedDate": "2020-01-16T17:17:14Z", "message": "Update error code when table is dropped during query execution\n\nFor drop table query, error code is changed from HIVE_METASTORE_ERROR\nto HIVE_TABLE_DROPPED_DURING_QUERY when table is already dropped by\nother query during query execution."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0Mjc0NDk0", "url": "https://github.com/prestodb/presto/pull/13934#pullrequestreview-344274494", "createdAt": "2020-01-16T23:04:29Z", "commit": {"oid": "0edc2b96eb074a51d6541f3be444483d2fb12d3a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7cb8108c61fc41cc56477123a38d7b259ff6189a", "author": {"user": {"login": "viczhang861", "name": "Vic Zhang"}}, "url": "https://github.com/prestodb/presto/commit/7cb8108c61fc41cc56477123a38d7b259ff6189a", "committedDate": "2020-01-22T21:28:55Z", "message": "Update error code when table is dropped during query execution\n\nFor drop table query, error code is changed from HIVE_METASTORE_ERROR\nto HIVE_TABLE_DROPPED_DURING_QUERY when table exists after query\nstarts execution but dropped before delete operation commits."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0edc2b96eb074a51d6541f3be444483d2fb12d3a", "author": {"user": {"login": "viczhang861", "name": "Vic Zhang"}}, "url": "https://github.com/prestodb/presto/commit/0edc2b96eb074a51d6541f3be444483d2fb12d3a", "committedDate": "2020-01-16T17:17:14Z", "message": "Update error code when table is dropped during query execution\n\nFor drop table query, error code is changed from HIVE_METASTORE_ERROR\nto HIVE_TABLE_DROPPED_DURING_QUERY when table is already dropped by\nother query during query execution."}, "afterCommit": {"oid": "7cb8108c61fc41cc56477123a38d7b259ff6189a", "author": {"user": {"login": "viczhang861", "name": "Vic Zhang"}}, "url": "https://github.com/prestodb/presto/commit/7cb8108c61fc41cc56477123a38d7b259ff6189a", "committedDate": "2020-01-22T21:28:55Z", "message": "Update error code when table is dropped during query execution\n\nFor drop table query, error code is changed from HIVE_METASTORE_ERROR\nto HIVE_TABLE_DROPPED_DURING_QUERY when table exists after query\nstarts execution but dropped before delete operation commits."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2OTE5MjI3", "url": "https://github.com/prestodb/presto/pull/13934#pullrequestreview-346919227", "createdAt": "2020-01-22T21:35:02Z", "commit": {"oid": "7cb8108c61fc41cc56477123a38d7b259ff6189a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4459, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}