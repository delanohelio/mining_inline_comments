{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc5ODczNTA5", "number": 14160, "title": "Use HiveFileContext for OrcFileTailSource", "bodyText": "== NO RELEASE NOTE ==", "createdAt": "2020-02-25T23:25:35Z", "url": "https://github.com/prestodb/presto/pull/14160", "merged": true, "mergeCommit": {"oid": "e20ca08b3d136093e0eca2de1368326c3767a84c"}, "closed": true, "closedAt": "2020-02-26T09:30:30Z", "author": {"login": "kewang1024"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcH6x-fAFqTM2NDUyNjk0NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcIBIiBABqjMwNzIzNjQ2MjU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0NTI2OTQ0", "url": "https://github.com/prestodb/presto/pull/14160#pullrequestreview-364526944", "createdAt": "2020-02-25T23:32:34Z", "commit": {"oid": "99d3e87b979c8f80cd079e7b8f85efc8926ee75a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQyMzozMjozNFrOFuZLVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQyMzozMjozNFrOFuZLVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDE5MTMxOA==", "bodyText": "Don't use this. Use HiveFileContext. This patch does not require SPI change", "url": "https://github.com/prestodb/presto/pull/14160#discussion_r384191318", "createdAt": "2020-02-25T23:32:34Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveCacheContext.java", "diffHunk": "@@ -0,0 +1,33 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.hive;\n+\n+import com.facebook.presto.spi.connector.CacheContext;\n+\n+public class HiveCacheContext", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99d3e87b979c8f80cd079e7b8f85efc8926ee75a"}, "originalPosition": 18}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "99d3e87b979c8f80cd079e7b8f85efc8926ee75a", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/99d3e87b979c8f80cd079e7b8f85efc8926ee75a", "committedDate": "2020-02-25T23:23:20Z", "message": "Pass CacheContext to OrcFileTailSource"}, "afterCommit": {"oid": "532c8e957dfbfdfe2ac09f54a509c1952a6d5d48", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/532c8e957dfbfdfe2ac09f54a509c1952a6d5d48", "committedDate": "2020-02-25T23:37:35Z", "message": "Pass CacheContext to OrcFileTailSource"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "532c8e957dfbfdfe2ac09f54a509c1952a6d5d48", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/532c8e957dfbfdfe2ac09f54a509c1952a6d5d48", "committedDate": "2020-02-25T23:37:35Z", "message": "Pass CacheContext to OrcFileTailSource"}, "afterCommit": {"oid": "b19c76d9b21b08a6c3e50d9f7ba9d41d1c765b85", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/b19c76d9b21b08a6c3e50d9f7ba9d41d1c765b85", "committedDate": "2020-02-26T01:07:57Z", "message": "Use HiveFileContext for OrcFileTailSource"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0NTY0NjY5", "url": "https://github.com/prestodb/presto/pull/14160#pullrequestreview-364564669", "createdAt": "2020-02-26T01:17:31Z", "commit": {"oid": "b19c76d9b21b08a6c3e50d9f7ba9d41d1c765b85"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQwMToxNzozMlrOFubQnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQwMToyNTo1N1rOFubZ9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDIyNTQzNg==", "bodyText": "Keep as is. Check my comment below.", "url": "https://github.com/prestodb/presto/pull/14160#discussion_r384225436", "createdAt": "2020-02-26T01:17:32Z", "author": {"login": "highker"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/OrcFileWriter.java", "diffHunk": "@@ -158,7 +158,7 @@ public void commit()\n             try {\n                 try (OrcDataSource input = validationInputFactory.get().get()) {\n                     long startThreadCpuTime = THREAD_MX_BEAN.getCurrentThreadCpuTime();\n-                    orcWriter.validate(input);\n+                    orcWriter.validate(input, new HiveFileContext(false, Optional.empty()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b19c76d9b21b08a6c3e50d9f7ba9d41d1c765b85"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDIyNTU1Mg==", "bodyText": "break an empty line", "url": "https://github.com/prestodb/presto/pull/14160#discussion_r384225552", "createdAt": "2020-02-26T01:17:53Z", "author": {"login": "highker"}, "path": "presto-orc/pom.xml", "diffHunk": "@@ -187,6 +187,10 @@\n             <artifactId>jcl-over-slf4j</artifactId>\n             <scope>test</scope>\n         </dependency>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b19c76d9b21b08a6c3e50d9f7ba9d41d1c765b85"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDIyNTc3Mg==", "bodyText": "Do not change the interface given this is not critical path.", "url": "https://github.com/prestodb/presto/pull/14160#discussion_r384225772", "createdAt": "2020-02-26T01:18:39Z", "author": {"login": "highker"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/OrcWriter.java", "diffHunk": "@@ -511,7 +512,7 @@ private void recordValidation(Consumer<OrcWriteValidationBuilder> task)\n         }\n     }\n \n-    public void validate(OrcDataSource input)\n+    public void validate(OrcDataSource input, HiveFileContext hiveFileContext)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b19c76d9b21b08a6c3e50d9f7ba9d41d1c765b85"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDIyNTc5OA==", "bodyText": "Use DEFAULT_HIVE_FILE_CONTEXT", "url": "https://github.com/prestodb/presto/pull/14160#discussion_r384225798", "createdAt": "2020-02-26T01:18:44Z", "author": {"login": "highker"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/OrcWriter.java", "diffHunk": "@@ -522,7 +523,8 @@ public void validate(OrcDataSource input)\n                 types,\n                 hiveStorageTimeZone,\n                 orcEncoding,\n-                new OrcReaderOptions(new DataSize(1, MEGABYTE), new DataSize(8, MEGABYTE), new DataSize(16, MEGABYTE), false));\n+                new OrcReaderOptions(new DataSize(1, MEGABYTE), new DataSize(8, MEGABYTE), new DataSize(16, MEGABYTE), false),\n+                hiveFileContext);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b19c76d9b21b08a6c3e50d9f7ba9d41d1c765b85"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDIyNjE3OA==", "bodyText": "You need to test against hiveFileContext to see if you need to get data from cache or not. Check CachingFileOpener as an example", "url": "https://github.com/prestodb/presto/pull/14160#discussion_r384226178", "createdAt": "2020-02-26T01:20:10Z", "author": {"login": "highker"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/cache/CachingOrcFileTailSource.java", "diffHunk": "@@ -41,11 +42,11 @@ public CachingOrcFileTailSource(OrcFileTailSource delegate, Cache<OrcDataSourceI\n     }\n \n     @Override\n-    public OrcFileTail getOrcFileTail(OrcDataSource orcDataSource, MetadataReader metadataReader, Optional<OrcWriteValidation> writeValidation)\n+    public OrcFileTail getOrcFileTail(OrcDataSource orcDataSource, MetadataReader metadataReader, Optional<OrcWriteValidation> writeValidation, HiveFileContext hiveFileContext)\n             throws IOException\n     {\n         try {\n-            return cache.get(orcDataSource.getId(), () -> delegate.getOrcFileTail(orcDataSource, metadataReader, writeValidation));\n+            return cache.get(orcDataSource.getId(), () -> delegate.getOrcFileTail(orcDataSource, metadataReader, writeValidation, hiveFileContext));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b19c76d9b21b08a6c3e50d9f7ba9d41d1c765b85"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDIyNjMwNw==", "bodyText": "DEFAULT_HIVE_FILE_CONTEXT", "url": "https://github.com/prestodb/presto/pull/14160#discussion_r384226307", "createdAt": "2020-02-26T01:20:38Z", "author": {"login": "highker"}, "path": "presto-orc/src/test/java/com/facebook/presto/orc/BenchmarkBatchStreamReaders.java", "diffHunk": "@@ -207,7 +209,8 @@ private OrcBatchRecordReader createRecordReader()\n                     ORC,\n                     new StorageOrcFileTailSource(),\n                     new StorageStripeMetadataSource(),\n-                    OrcReaderTestingUtils.createDefaultTestConfig());\n+                    OrcReaderTestingUtils.createDefaultTestConfig(),\n+                    new HiveFileContext(false, Optional.empty()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b19c76d9b21b08a6c3e50d9f7ba9d41d1c765b85"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDIyNjM0MA==", "bodyText": "same and all other places", "url": "https://github.com/prestodb/presto/pull/14160#discussion_r384226340", "createdAt": "2020-02-26T01:20:47Z", "author": {"login": "highker"}, "path": "presto-orc/src/test/java/com/facebook/presto/orc/BenchmarkBatchStreamReadersWithZstd.java", "diffHunk": "@@ -219,7 +221,8 @@ private OrcBatchRecordReader createRecordReader(boolean zstdJniDecompressionEnab\n                     format.getOrcEncoding(),\n                     new StorageOrcFileTailSource(),\n                     new StorageStripeMetadataSource(),\n-                    OrcReaderTestingUtils.createTestingReaderOptions(zstdJniDecompressionEnabled));\n+                    OrcReaderTestingUtils.createTestingReaderOptions(zstdJniDecompressionEnabled),\n+                    new HiveFileContext(false, Optional.empty()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b19c76d9b21b08a6c3e50d9f7ba9d41d1c765b85"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDIyNzY5MQ==", "bodyText": "For Raptor we need to decide if to cache or not as well. Whether to cache or not should be determined by RaptorPageSourceProvider::createPageSource (where SplitContext will be passed in). Depends on which patch lands first. But having it default to false here is not right.", "url": "https://github.com/prestodb/presto/pull/14160#discussion_r384227691", "createdAt": "2020-02-26T01:25:28Z", "author": {"login": "highker"}, "path": "presto-raptor/src/main/java/com/facebook/presto/raptor/storage/OrcStorageManager.java", "diffHunk": "@@ -290,7 +291,8 @@ public ConnectorPageSource getPageSource(\n                     ORC,\n                     orcFileTailSource,\n                     stripeMetadataSource,\n-                    new OrcReaderOptions(readerAttributes.getMaxMergeDistance(), readerAttributes.getTinyStripeThreshold(), HUGE_MAX_READ_BLOCK_SIZE, readerAttributes.isZstdJniDecompressionEnabled()));\n+                    new OrcReaderOptions(readerAttributes.getMaxMergeDistance(), readerAttributes.getTinyStripeThreshold(), HUGE_MAX_READ_BLOCK_SIZE, readerAttributes.isZstdJniDecompressionEnabled()),\n+                    new HiveFileContext(false, Optional.empty()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b19c76d9b21b08a6c3e50d9f7ba9d41d1c765b85"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDIyNzcwNw==", "bodyText": "same", "url": "https://github.com/prestodb/presto/pull/14160#discussion_r384227707", "createdAt": "2020-02-26T01:25:32Z", "author": {"login": "highker"}, "path": "presto-raptor/src/main/java/com/facebook/presto/raptor/storage/OrcStorageManager.java", "diffHunk": "@@ -376,7 +378,8 @@ public ConnectorPageSource getPageSource(\n                             defaultReaderAttributes.getMaxMergeDistance(),\n                             defaultReaderAttributes.getTinyStripeThreshold(),\n                             HUGE_MAX_READ_BLOCK_SIZE,\n-                            defaultReaderAttributes.isZstdJniDecompressionEnabled()));\n+                            defaultReaderAttributes.isZstdJniDecompressionEnabled()),\n+                    new HiveFileContext(false, Optional.empty()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b19c76d9b21b08a6c3e50d9f7ba9d41d1c765b85"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDIyNzgzMA==", "bodyText": "DEFAULT_HIVE_FILE_CONTEXT", "url": "https://github.com/prestodb/presto/pull/14160#discussion_r384227830", "createdAt": "2020-02-26T01:25:57Z", "author": {"login": "highker"}, "path": "presto-raptor/src/main/java/com/facebook/presto/raptor/storage/OrcStorageManager.java", "diffHunk": "@@ -537,7 +540,8 @@ ShardInfo createShardInfo(FileSystem fileSystem, UUID shardUuid, OptionalInt buc\n                     ORC,\n                     orcFileTailSource,\n                     stripeMetadataSource,\n-                    new OrcReaderOptions(defaultReaderAttributes.getMaxMergeDistance(), defaultReaderAttributes.getTinyStripeThreshold(), HUGE_MAX_READ_BLOCK_SIZE, defaultReaderAttributes.isZstdJniDecompressionEnabled()));\n+                    new OrcReaderOptions(defaultReaderAttributes.getMaxMergeDistance(), defaultReaderAttributes.getTinyStripeThreshold(), HUGE_MAX_READ_BLOCK_SIZE, defaultReaderAttributes.isZstdJniDecompressionEnabled()),\n+                    new HiveFileContext(false, Optional.empty()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b19c76d9b21b08a6c3e50d9f7ba9d41d1c765b85"}, "originalPosition": 34}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b19c76d9b21b08a6c3e50d9f7ba9d41d1c765b85", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/b19c76d9b21b08a6c3e50d9f7ba9d41d1c765b85", "committedDate": "2020-02-26T01:07:57Z", "message": "Use HiveFileContext for OrcFileTailSource"}, "afterCommit": {"oid": "f40d90bcfef1c7c3d30f159fd535137f1c1a782b", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/f40d90bcfef1c7c3d30f159fd535137f1c1a782b", "committedDate": "2020-02-26T03:16:18Z", "message": "Use HiveFileContext for OrcFileTailSource"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f40d90bcfef1c7c3d30f159fd535137f1c1a782b", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/f40d90bcfef1c7c3d30f159fd535137f1c1a782b", "committedDate": "2020-02-26T03:16:18Z", "message": "Use HiveFileContext for OrcFileTailSource"}, "afterCommit": {"oid": "aabe9ea65084db988cf78b7920e41b3a32054d3e", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/aabe9ea65084db988cf78b7920e41b3a32054d3e", "committedDate": "2020-02-26T04:31:32Z", "message": "Use HiveFileContext for OrcFileTailSource"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0NjI4NTA1", "url": "https://github.com/prestodb/presto/pull/14160#pullrequestreview-364628505", "createdAt": "2020-02-26T05:19:23Z", "commit": {"oid": "aabe9ea65084db988cf78b7920e41b3a32054d3e"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQwNToxOToyM1rOFuejbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQwNToxOToyM1rOFuejbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDI3OTQwNg==", "bodyText": "Move this above all \"test\" references.", "url": "https://github.com/prestodb/presto/pull/14160#discussion_r384279406", "createdAt": "2020-02-26T05:19:23Z", "author": {"login": "highker"}, "path": "presto-orc/pom.xml", "diffHunk": "@@ -187,6 +187,11 @@\n             <artifactId>jcl-over-slf4j</artifactId>\n             <scope>test</scope>\n         </dependency>\n+\n+        <dependency>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aabe9ea65084db988cf78b7920e41b3a32054d3e"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0cd5554223dabe5728c4f99403ee46e3ebb8584", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/d0cd5554223dabe5728c4f99403ee46e3ebb8584", "committedDate": "2020-02-26T06:56:32Z", "message": "Use HiveFileContext for OrcFileTailSource"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "aabe9ea65084db988cf78b7920e41b3a32054d3e", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/aabe9ea65084db988cf78b7920e41b3a32054d3e", "committedDate": "2020-02-26T04:31:32Z", "message": "Use HiveFileContext for OrcFileTailSource"}, "afterCommit": {"oid": "d0cd5554223dabe5728c4f99403ee46e3ebb8584", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/d0cd5554223dabe5728c4f99403ee46e3ebb8584", "committedDate": "2020-02-26T06:56:32Z", "message": "Use HiveFileContext for OrcFileTailSource"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2343, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}