{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcyOTAwODgz", "number": 15076, "title": "Track cache objects sizes in CachingOrcDataSource", "bodyText": "The cache object in CachingOrcDataSource was not tracked before. This PR updates the PageSource's system memory usage whenever a new cache\nobject is allocated.\n== RELEASE NOTES ==\n\n\nHive Changes\n* Fixed a memory tracking issue in OrcPageSource\n\nIf release note is NOT required, use:\n== NO RELEASE NOTE ==", "createdAt": "2020-08-25T02:45:04Z", "url": "https://github.com/prestodb/presto/pull/15076", "merged": true, "mergeCommit": {"oid": "a458ecbe56105226c88b0f89bcf13dc09b3fc103"}, "closed": true, "closedAt": "2020-09-01T21:28:27Z", "author": {"login": "yingsu00"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdCdGD2gFqTQ3NDgyMTIxMw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdEWJQKgFqTQ3ODc5ODg3MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0ODIxMjEz", "url": "https://github.com/prestodb/presto/pull/15076#pullrequestreview-474821213", "createdAt": "2020-08-25T20:18:57Z", "commit": {"oid": "e5cf9ecc46a40d04c9cfcabd206cc62fc858e585"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0OTMwOTMy", "url": "https://github.com/prestodb/presto/pull/15076#pullrequestreview-474930932", "createdAt": "2020-08-25T21:36:59Z", "commit": {"oid": "e5cf9ecc46a40d04c9cfcabd206cc62fc858e585"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQyMTozNjo1OVrOHGrGXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQyMTozNjo1OVrOHGrGXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njc1OTY0NQ==", "bodyText": "What is the maximal possible cacheLength?  is it tinyStripeThreshold (default 8MB) ?\nHow about initialize cache size as maximal possible stripe size (8MB at most for tiny stripe?)\nIf memory accounting is only off by 8MB, it is probably ok. Is creating new cache too fast caused GC ?", "url": "https://github.com/prestodb/presto/pull/15076#discussion_r476759645", "createdAt": "2020-08-25T21:36:59Z", "author": {"login": "viczhang861"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/CachingOrcDataSource.java", "diffHunk": "@@ -73,6 +75,7 @@ void readCacheAt(long offset)\n         cacheLength = newCacheRange.getLength();\n         if (cache.length < cacheLength) {\n             cache = new byte[cacheLength];\n+            systemMemoryContext.setBytes(cacheLength);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e5cf9ecc46a40d04c9cfcabd206cc62fc858e585"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1MTYxMjM0", "url": "https://github.com/prestodb/presto/pull/15076#pullrequestreview-475161234", "createdAt": "2020-08-26T05:30:37Z", "commit": {"oid": "e5cf9ecc46a40d04c9cfcabd206cc62fc858e585"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQwNTozMDozN1rOHG8aEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQwNTozMDo1NFrOHG8aZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzA0MzIxNw==", "bodyText": "Can we assert assertEquals(systemMemoryContext.getBytes(), 8 * 1048576); after this?", "url": "https://github.com/prestodb/presto/pull/15076#discussion_r477043217", "createdAt": "2020-08-26T05:30:37Z", "author": {"login": "highker"}, "path": "presto-orc/src/test/java/com/facebook/presto/orc/TestCachingOrcDataSource.java", "diffHunk": "@@ -146,13 +153,16 @@ public void testTinyStripesReadCacheAt()\n         DataSize maxMergeDistance = new DataSize(1, Unit.MEGABYTE);\n         DataSize tinyStripeThreshold = new DataSize(8, Unit.MEGABYTE);\n \n+        OrcAggregatedMemoryContext systemMemoryContext = new TestingHiveOrcAggregatedMemoryContext();\n+\n         TestingOrcDataSource testingOrcDataSource = new TestingOrcDataSource(FakeOrcDataSource.INSTANCE);\n         CachingOrcDataSource cachingOrcDataSource = new CachingOrcDataSource(\n                 testingOrcDataSource,\n                 createTinyStripesRangeFinder(\n                         ImmutableList.of(new StripeInformation(123, 3, 10, 10, 10, ImmutableList.of()), new StripeInformation(123, 33, 10, 10, 10, ImmutableList.of()), new StripeInformation(123, 63, 1048576 * 8 - 20, 10, 10, ImmutableList.of())),\n                         maxMergeDistance,\n-                        tinyStripeThreshold));\n+                        tinyStripeThreshold),\n+                systemMemoryContext.newOrcLocalMemoryContext(CachingOrcDataSource.class.getSimpleName()));\n         cachingOrcDataSource.readCacheAt(3);\n         assertEquals(testingOrcDataSource.getLastReadRanges(), ImmutableList.of(new DiskRange(3, 60)));\n         cachingOrcDataSource.readCacheAt(63);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e5cf9ecc46a40d04c9cfcabd206cc62fc858e585"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzA0MzI3NQ==", "bodyText": "same, can we add an assertion?", "url": "https://github.com/prestodb/presto/pull/15076#discussion_r477043275", "createdAt": "2020-08-26T05:30:49Z", "author": {"login": "highker"}, "path": "presto-orc/src/test/java/com/facebook/presto/orc/TestCachingOrcDataSource.java", "diffHunk": "@@ -167,7 +177,8 @@ public void testTinyStripesReadCacheAt()\n                                 new StripeInformation(123, 33, 10, 10, 10, ImmutableList.of()),\n                                 new StripeInformation(123, 63, 1048576 * 8 - 20, 10, 10, ImmutableList.of())),\n                         maxMergeDistance,\n-                        tinyStripeThreshold));\n+                        tinyStripeThreshold),\n+                systemMemoryContext.newOrcLocalMemoryContext(CachingOrcDataSource.class.getSimpleName()));\n         cachingOrcDataSource.readCacheAt(62); // read at the end of a stripe\n         assertEquals(testingOrcDataSource.getLastReadRanges(), ImmutableList.of(new DiskRange(3, 60)));\n         cachingOrcDataSource.readCacheAt(63);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e5cf9ecc46a40d04c9cfcabd206cc62fc858e585"}, "originalPosition": 93}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzA0MzMwMA==", "bodyText": "same", "url": "https://github.com/prestodb/presto/pull/15076#discussion_r477043300", "createdAt": "2020-08-26T05:30:54Z", "author": {"login": "highker"}, "path": "presto-orc/src/test/java/com/facebook/presto/orc/TestCachingOrcDataSource.java", "diffHunk": "@@ -182,7 +193,8 @@ public void testTinyStripesReadCacheAt()\n                                 new StripeInformation(123, 4, 1048576, 1048576, 1048576 * 3, ImmutableList.of()),\n                                 new StripeInformation(123, 4 + 1048576 * 5, 1048576, 1048576, 1048576, ImmutableList.of())),\n                         maxMergeDistance,\n-                        tinyStripeThreshold));\n+                        tinyStripeThreshold),\n+                systemMemoryContext.newOrcLocalMemoryContext(CachingOrcDataSource.class.getSimpleName()));\n         cachingOrcDataSource.readCacheAt(3);\n         assertEquals(testingOrcDataSource.getLastReadRanges(), ImmutableList.of(new DiskRange(3, 1 + 1048576 * 5)));\n         cachingOrcDataSource.readCacheAt(4 + 1048576 * 5);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e5cf9ecc46a40d04c9cfcabd206cc62fc858e585"}, "originalPosition": 103}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e5cf9ecc46a40d04c9cfcabd206cc62fc858e585", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/e5cf9ecc46a40d04c9cfcabd206cc62fc858e585", "committedDate": "2020-08-25T02:33:47Z", "message": "Track cache objects sizes in CachingOrcDataSource\n\nThe cache object in CachingOrcDataSource was not tracked before. This\ncommit updates the PageSource's system memory usage whenever a new cache\nobject is allocated."}, "afterCommit": {"oid": "f8e8b6226aeab4030142e20abd6c1b6748aa7f1a", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/f8e8b6226aeab4030142e20abd6c1b6748aa7f1a", "committedDate": "2020-08-31T08:12:17Z", "message": "Track cache objects sizes in CachingOrcDataSource\n\nThe cache object in CachingOrcDataSource was not tracked before. This\ncommit updates the PageSource's system memory usage whenever a new cache\nobject is allocated."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d60863e8541c54d277c486daf892c30b96ae19a9", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/d60863e8541c54d277c486daf892c30b96ae19a9", "committedDate": "2020-08-31T08:13:38Z", "message": "Create OrcPageSource using the OrcDataSource from OrcReader\n\nOrcReader would wrap the OrcDataSource with CachingOrcDataSource if the\nfile is less than the tiny stripe threashold. However the PageSource in\nthe scan operators would still use the original OrcDataSource. This\nis confusing since the OrcReader, OrcRecordReder, and StreamReaders all\nkeep the CachingOrcDataSource while the PageSource keeps the underlying\nOrcDataSource. This commit creates the PageSource using the wrapped\nCachingOrcDataSource if the original OrcDataSource was wrapped."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55f587e0ea5aab1d23f15df2f0da801e9b40cec8", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/55f587e0ea5aab1d23f15df2f0da801e9b40cec8", "committedDate": "2020-08-31T08:14:37Z", "message": "Track cache objects sizes in CachingOrcDataSource\n\nThe cache object in CachingOrcDataSource was not tracked before. This\ncommit updates the PageSource's system memory usage whenever a new cache\nobject is allocated."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f8e8b6226aeab4030142e20abd6c1b6748aa7f1a", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/f8e8b6226aeab4030142e20abd6c1b6748aa7f1a", "committedDate": "2020-08-31T08:12:17Z", "message": "Track cache objects sizes in CachingOrcDataSource\n\nThe cache object in CachingOrcDataSource was not tracked before. This\ncommit updates the PageSource's system memory usage whenever a new cache\nobject is allocated."}, "afterCommit": {"oid": "55f587e0ea5aab1d23f15df2f0da801e9b40cec8", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/55f587e0ea5aab1d23f15df2f0da801e9b40cec8", "committedDate": "2020-08-31T08:14:37Z", "message": "Track cache objects sizes in CachingOrcDataSource\n\nThe cache object in CachingOrcDataSource was not tracked before. This\ncommit updates the PageSource's system memory usage whenever a new cache\nobject is allocated."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4NjQzNzUz", "url": "https://github.com/prestodb/presto/pull/15076#pullrequestreview-478643753", "createdAt": "2020-08-31T14:02:55Z", "commit": {"oid": "55f587e0ea5aab1d23f15df2f0da801e9b40cec8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4Nzk4ODcx", "url": "https://github.com/prestodb/presto/pull/15076#pullrequestreview-478798871", "createdAt": "2020-08-31T17:20:57Z", "commit": {"oid": "55f587e0ea5aab1d23f15df2f0da801e9b40cec8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4988, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}