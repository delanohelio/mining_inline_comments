{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkyODczMDQ0", "number": 14286, "title": "Reuse buffers in OptimizedPartitionedOutputOperator - part 2 : byte[] buffers in BlockEncodingBuffer", "bodyText": "Partially resolves #14162\nThe buffers e.g. valuesBuffers in BlockEncodingBuffer can be reused\nafter the current partition get flushed and when there is no more\nbatches in the current page. This can save a lot of memory\nwhen the page is very large and can fill the buffers every time.\n== NO RELEASE NOTE ==", "createdAt": "2020-03-24T09:22:54Z", "url": "https://github.com/prestodb/presto/pull/14286", "merged": true, "mergeCommit": {"oid": "0f2b203ee43142117e22809f4c1b728dbfd2f66b"}, "closed": true, "closedAt": "2020-03-27T12:38:10Z", "author": {"login": "yingsu00"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcQwh8DgBqjMxNTkwNjMzMzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcRv_O6AFqTM4MjgxODE3NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9fca92de5cfd235578a8fa05eca4181982ccc17c", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/9fca92de5cfd235578a8fa05eca4181982ccc17c", "committedDate": "2020-03-24T09:05:06Z", "message": "Reuse buffers in BlockEncodingBuffer\n\nThe buffers e.g. valuesBuffers in BlockEncodingBuffer can be reused\nafter the current partition get flushed and when there is no more\nbatches in the current page.. This can save a lot of memory\nwhen the page is very large and can fill the buffers every time."}, "afterCommit": {"oid": "fcbd0dbb4ccf8300aa5b10e0f238fd1a138e6acc", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/fcbd0dbb4ccf8300aa5b10e0f238fd1a138e6acc", "committedDate": "2020-03-24T10:41:02Z", "message": "Reuse buffers in BlockEncodingBuffer\n\nThe buffers e.g. valuesBuffers in BlockEncodingBuffer can be reused\nafter the current partition get flushed and when there is no more\nbatches in the current page.. This can save a lot of memory\nwhen the page is very large and can fill the buffers every time."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fcbd0dbb4ccf8300aa5b10e0f238fd1a138e6acc", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/fcbd0dbb4ccf8300aa5b10e0f238fd1a138e6acc", "committedDate": "2020-03-24T10:41:02Z", "message": "Reuse buffers in BlockEncodingBuffer\n\nThe buffers e.g. valuesBuffers in BlockEncodingBuffer can be reused\nafter the current partition get flushed and when there is no more\nbatches in the current page.. This can save a lot of memory\nwhen the page is very large and can fill the buffers every time."}, "afterCommit": {"oid": "b955c4f4b6668f3e6696bfd7460ca13b44a19dc0", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/b955c4f4b6668f3e6696bfd7460ca13b44a19dc0", "committedDate": "2020-03-24T10:46:44Z", "message": "Reuse buffers in BlockEncodingBuffer\n\nThe buffers e.g. valuesBuffers in BlockEncodingBuffer can be reused\nafter the current partition get flushed and when there is no more\nbatches in the current page.. This can save a lot of memory\nwhen the page is very large and can fill the buffers every time."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMjcwOTEz", "url": "https://github.com/prestodb/presto/pull/14286#pullrequestreview-380270913", "createdAt": "2020-03-24T12:43:54Z", "commit": {"oid": "b955c4f4b6668f3e6696bfd7460ca13b44a19dc0"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMjcyOTAy", "url": "https://github.com/prestodb/presto/pull/14286#pullrequestreview-380272902", "createdAt": "2020-03-24T12:46:36Z", "commit": {"oid": "b955c4f4b6668f3e6696bfd7460ca13b44a19dc0"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMjc5MDI3", "url": "https://github.com/prestodb/presto/pull/14286#pullrequestreview-380279027", "createdAt": "2020-03-24T12:54:54Z", "commit": {"oid": "b955c4f4b6668f3e6696bfd7460ca13b44a19dc0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMjo1NDo1NFrOF6u3Pw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMjo1NDo1NFrOF6u3Pw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzEyOTUzNQ==", "bodyText": "Do we really need this new parameter here? resetBuffer() seems to be signaling the same condition. Can't values buffer be release in resetBuffers()?", "url": "https://github.com/prestodb/presto/pull/14286#discussion_r397129535", "createdAt": "2020-03-24T12:54:54Z", "author": {"login": "mbasmanova"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/repartition/BlockEncodingBuffer.java", "diffHunk": "@@ -50,8 +50,9 @@\n \n     /**\n      * Signals that this is the last batch in this page, so that the internal buffers in BlockEncodingBuffers can recycled.\n+     * @param bufferFull\n      */\n-    void noMoreBatches();\n+    void noMoreBatches(boolean bufferFull);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b955c4f4b6668f3e6696bfd7460ca13b44a19dc0"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7f5797a8e0510d9dbba3119ce4943724dc53cbf", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/d7f5797a8e0510d9dbba3119ce4943724dc53cbf", "committedDate": "2020-03-24T23:48:12Z", "message": "Return arrays in reverse order of borrowing\n\nOptimizedPartitionedOutputOperator uses SimpleArrayAllocator to reuse\nint arrays. SimpleArrayAllocator works in stack mode that most recently\nreturned array would be borrowed out first next. To avoid unnecessary\nmemory allocations due by mismatch between borrow and return order,\nmake sure to return arrays in reverse order of borrowing."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c48ca60564823bc8f58ed0b35510b9185feef69", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/9c48ca60564823bc8f58ed0b35510b9185feef69", "committedDate": "2020-03-24T23:48:26Z", "message": "Add byte[] support to ArrayAllocator"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b955c4f4b6668f3e6696bfd7460ca13b44a19dc0", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/b955c4f4b6668f3e6696bfd7460ca13b44a19dc0", "committedDate": "2020-03-24T10:46:44Z", "message": "Reuse buffers in BlockEncodingBuffer\n\nThe buffers e.g. valuesBuffers in BlockEncodingBuffer can be reused\nafter the current partition get flushed and when there is no more\nbatches in the current page.. This can save a lot of memory\nwhen the page is very large and can fill the buffers every time."}, "afterCommit": {"oid": "feb320cd02d1d433dd7a10df82d3d31cd3b3bd02", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/feb320cd02d1d433dd7a10df82d3d31cd3b3bd02", "committedDate": "2020-03-24T23:48:29Z", "message": "Reuse buffers in BlockEncodingBuffer\n\nThe buffers e.g. valuesBuffers in BlockEncodingBuffer can be reused\nafter the current partition get flushed and when there is no more\nbatches in the current page. This can save a lot of memory\nwhen the page is very large and can fill the buffers every time."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "feb320cd02d1d433dd7a10df82d3d31cd3b3bd02", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/feb320cd02d1d433dd7a10df82d3d31cd3b3bd02", "committedDate": "2020-03-24T23:48:29Z", "message": "Reuse buffers in BlockEncodingBuffer\n\nThe buffers e.g. valuesBuffers in BlockEncodingBuffer can be reused\nafter the current partition get flushed and when there is no more\nbatches in the current page. This can save a lot of memory\nwhen the page is very large and can fill the buffers every time."}, "afterCommit": {"oid": "c492bc6bf5a6c8d435115430a494fb808fb82aed", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/c492bc6bf5a6c8d435115430a494fb808fb82aed", "committedDate": "2020-03-25T01:09:49Z", "message": "Reuse buffers in BlockEncodingBuffer\n\nThe buffers e.g. valuesBuffers in BlockEncodingBuffer can be reused\nafter the current partition get flushed and when there is no more\nbatches in the current page. This can save a lot of memory\nwhen the page is very large and can fill the buffers every time."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyMDE3Njk3", "url": "https://github.com/prestodb/presto/pull/14286#pullrequestreview-382017697", "createdAt": "2020-03-26T13:40:56Z", "commit": {"oid": "c492bc6bf5a6c8d435115430a494fb808fb82aed"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMzo0MDo1NlrOF8HXlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMzo0MDo1NlrOF8HXlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODU3OTYwNA==", "bodyText": "@yingsu00 debugging leftovers?", "url": "https://github.com/prestodb/presto/pull/14286#discussion_r398579604", "createdAt": "2020-03-26T13:40:56Z", "author": {"login": "mbasmanova"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/repartition/LongArrayBlockEncodingBuffer.java", "diffHunk": "@@ -72,7 +71,12 @@ public void serializeTo(SliceOutput output)\n         serializeNullsTo(output);\n \n         if (valuesBufferIndex > 0) {\n-            output.appendBytes(valuesBuffer, 0, valuesBufferIndex);\n+            try {\n+                output.appendBytes(valuesBuffer, 0, valuesBufferIndex);\n+            }\n+            catch (Exception e) {\n+                e.printStackTrace();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c492bc6bf5a6c8d435115430a494fb808fb82aed"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "edb40d5607f1e15c06c3d343b1638875b77f5286", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/edb40d5607f1e15c06c3d343b1638875b77f5286", "committedDate": "2020-03-26T23:32:24Z", "message": "Reuse buffers in BlockEncodingBuffer\n\nThe buffers e.g. valuesBuffers in BlockEncodingBuffer can be reused\nafter the current partition get flushed and when there is no more\nbatches in the current page. This can save a lot of memory\nwhen the page is very large and can fill the buffers every time."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c492bc6bf5a6c8d435115430a494fb808fb82aed", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/c492bc6bf5a6c8d435115430a494fb808fb82aed", "committedDate": "2020-03-25T01:09:49Z", "message": "Reuse buffers in BlockEncodingBuffer\n\nThe buffers e.g. valuesBuffers in BlockEncodingBuffer can be reused\nafter the current partition get flushed and when there is no more\nbatches in the current page. This can save a lot of memory\nwhen the page is very large and can fill the buffers every time."}, "afterCommit": {"oid": "edb40d5607f1e15c06c3d343b1638875b77f5286", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/edb40d5607f1e15c06c3d343b1638875b77f5286", "committedDate": "2020-03-26T23:32:24Z", "message": "Reuse buffers in BlockEncodingBuffer\n\nThe buffers e.g. valuesBuffers in BlockEncodingBuffer can be reused\nafter the current partition get flushed and when there is no more\nbatches in the current page. This can save a lot of memory\nwhen the page is very large and can fill the buffers every time."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyODE4MTc0", "url": "https://github.com/prestodb/presto/pull/14286#pullrequestreview-382818174", "createdAt": "2020-03-27T12:36:56Z", "commit": {"oid": "edb40d5607f1e15c06c3d343b1638875b77f5286"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxMjozNjo1NlrOF8vQ6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxMjozNjo1NlrOF8vQ6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTIzMzI1OQ==", "bodyText": "nit: consider adding a helper method to reduce copy-paste\nsliceBuffer = returnArray(sliceBuffer, bufferAllocator);\n\n\nint[] returnArray(int[] array, ArrayAllocator arrayAllocator)\n{\n   if (array != null) {\n       arrayAllocator.returnArray(array);\n   }\n   return null;\n}", "url": "https://github.com/prestodb/presto/pull/14286#discussion_r399233259", "createdAt": "2020-03-27T12:36:56Z", "author": {"login": "mbasmanova"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/repartition/VariableWidthBlockEncodingBuffer.java", "diffHunk": "@@ -125,16 +124,32 @@ public void resetBuffers()\n         sliceBufferIndex = 0;\n         offsetsBufferIndex = 0;\n         lastOffset = 0;\n+        flushed = true;\n         resetNullsBuffer();\n     }\n \n+    @Override\n+    public void noMoreBatches()\n+    {\n+        super.noMoreBatches();\n+\n+        if (flushed) {\n+            if (sliceBuffer != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "edb40d5607f1e15c06c3d343b1638875b77f5286"}, "originalPosition": 22}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2094, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}