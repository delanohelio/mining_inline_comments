{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM2ODYxMjc0", "number": 14678, "title": "Parquet: Handle nested column schema changes when subfield pruning is enabled", "bodyText": "Summary:\nAfter schema is changed (new field at depth > 1) and when trying to read files with old schema\nwe end up with a situation where the type of the newly added field type is derived incorrectly.\nWhen this new field type is merged with type of other subfields within the same column, we get\nthe following error.\nError opening Hive split file:/var/folders/kg/8w0vwj4n26db9qwybcwmpml80000gn/T/PrestoTest3674412409435240427/hive_data/tpch/test_subfield_multilevel_pruning/20200619_021654_00016_hyx9i_753399fd-0201-4017-82bf-43c808e41bba (offset=0, length=624): repetition constraint is more restrictive: can not merge type optional group shipdate {\noptional int32 ship_day;\noptional int32 ship_month;\n} into repeated group shipdate {\noptional int32 ship_day;\noptional int32 ship_month;\n}\n== RELEASE NOTES ==\nHive Changes\n* Fix a bug in Parquet reader which manifests when there are nested column schema changes", "createdAt": "2020-06-19T03:02:50Z", "url": "https://github.com/prestodb/presto/pull/14678", "merged": true, "mergeCommit": {"oid": "b6f7986d69120bc851934979488d751d85805b5a"}, "closed": true, "closedAt": "2020-06-20T00:12:28Z", "author": {"login": "vkorukanti"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcs3Z5ggFqTQzNDI3MTU2NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcs3iSngFqTQzNDI3NjUyMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0MjcxNTY0", "url": "https://github.com/prestodb/presto/pull/14678#pullrequestreview-434271564", "createdAt": "2020-06-19T18:30:51Z", "commit": {"oid": "775a57c4213daf068c081970bbb27d6e1a403d65"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxODozMDo1MVrOGmd6Lw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxODozMDo1MVrOGmd6Lw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk4OTEwMw==", "bodyText": "could we simplify the logic as:\nif (childType == null) {\n  return new MessageType(rootName, ImmutableList.of());\n}\ntypeBuilder.add(childType);\nparentType = childType;", "url": "https://github.com/prestodb/presto/pull/14678#discussion_r442989103", "createdAt": "2020-06-19T18:30:51Z", "author": {"login": "zhenxiao"}, "path": "presto-parquet/src/main/java/com/facebook/presto/parquet/ParquetTypeUtils.java", "diffHunk": "@@ -282,6 +283,10 @@ public static MessageType getSubfieldType(GroupType baseType, Subfield subfield)\n                     typeBuilder.add(childType);\n                     parentType = childType;\n                 }\n+                else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "775a57c4213daf068c081970bbb27d6e1a403d65"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be15fff78e00acaf736fec170908675e358103dd", "author": {"user": {"login": "vkorukanti", "name": "Venki Korukanti"}}, "url": "https://github.com/prestodb/presto/commit/be15fff78e00acaf736fec170908675e358103dd", "committedDate": "2020-06-19T18:37:13Z", "message": "Parquet: Handle nested column schema changes when subfield pruning is enabled\n\nAfter schema is changed (new field at depth > 1) and when trying to read files with old schema\nwe end up with a situation where the type of the newly added field type is derived incorrectly.\nWhen this new field type is merged with type of other subfields within the same column, we get\nthe following error/.\n\nError opening Hive split file:/var/folders/kg/8w0vwj4n26db9qwybcwmpml80000gn/T/PrestoTest3674412409435240427/hive_data/tpch/test_subfield_multilevel_pruning/20200619_021654_00016_hyx9i_753399fd-0201-4017-82bf-43c808e41bba (offset=0, length=624): repetition constraint is more restrictive: can not merge type optional group shipdate {\n  optional int32 ship_day;\n  optional int32 ship_month;\n} into repeated group shipdate {\n  optional int32 ship_day;\n  optional int32 ship_month;\n}"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "775a57c4213daf068c081970bbb27d6e1a403d65", "author": {"user": {"login": "vkorukanti", "name": "Venki Korukanti"}}, "url": "https://github.com/prestodb/presto/commit/775a57c4213daf068c081970bbb27d6e1a403d65", "committedDate": "2020-06-19T03:01:39Z", "message": "Parquet: Handle nested column schema changes when subfield pruning is enabled\n\nAfter schema is changed (new field at depth > 1) and when trying to read files with old schema\nwe end up with a situation where the type of the newly added field type is derived incorrectly.\nWhen this new field type is merged with type of other subfields within the same column, we get\nthe following error/.\n\ncom.facebook.presto.spi.PrestoException: Error opening Hive split file:/var/folders/kg/8w0vwj4n26db9qwybcwmpml80000gn/T/PrestoTest3674412409435240427/hive_data/tpch/test_subfield_multilevel_pruning/20200619_021654_00016_hyx9i_753399fd-0201-4017-82bf-43c808e41bba (offset=0, length=624): repetition constraint is more restrictive: can not merge type optional group shipdate {\n  optional int32 ship_day;\n  optional int32 ship_month;\n} into repeated group shipdate {\n  optional int32 ship_day;\n  optional int32 ship_month;\n}\nat com.facebook.presto.hive.parquet.ParquetPageSourceFactory.createCryptoParquetPageSource(ParquetPageSourceFactory.java:418)\nat com.facebook.presto.hive.parquet.ParquetPageSourceFactory.createPageSource(ParquetPageSourceFactory.java:157)\nat com.facebook.presto.hive.HivePageSourceProvider.createHivePageSource(HivePageSourceProvider.java:300)\nat com.facebook.presto.hive.HivePageSourceProvider.createPageSource(HivePageSourceProvider.java:123)"}, "afterCommit": {"oid": "be15fff78e00acaf736fec170908675e358103dd", "author": {"user": {"login": "vkorukanti", "name": "Venki Korukanti"}}, "url": "https://github.com/prestodb/presto/commit/be15fff78e00acaf736fec170908675e358103dd", "committedDate": "2020-06-19T18:37:13Z", "message": "Parquet: Handle nested column schema changes when subfield pruning is enabled\n\nAfter schema is changed (new field at depth > 1) and when trying to read files with old schema\nwe end up with a situation where the type of the newly added field type is derived incorrectly.\nWhen this new field type is merged with type of other subfields within the same column, we get\nthe following error/.\n\nError opening Hive split file:/var/folders/kg/8w0vwj4n26db9qwybcwmpml80000gn/T/PrestoTest3674412409435240427/hive_data/tpch/test_subfield_multilevel_pruning/20200619_021654_00016_hyx9i_753399fd-0201-4017-82bf-43c808e41bba (offset=0, length=624): repetition constraint is more restrictive: can not merge type optional group shipdate {\n  optional int32 ship_day;\n  optional int32 ship_month;\n} into repeated group shipdate {\n  optional int32 ship_day;\n  optional int32 ship_month;\n}"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0Mjc2NTIy", "url": "https://github.com/prestodb/presto/pull/14678#pullrequestreview-434276522", "createdAt": "2020-06-19T18:40:59Z", "commit": {"oid": "be15fff78e00acaf736fec170908675e358103dd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1418, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}