{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkyMDM5NzU2", "number": 14276, "title": "Fix bucket pruning when value is null and the predicate is 'IS NULL'.", "bodyText": "When filtering in buckets with matching values, handle NULL properly.\n== RELEASE NOTES ==\nFixed bucket pruning when the predicate is IS NULL and the table actually has rows with that value which we were previously not considering.", "createdAt": "2020-03-22T17:13:55Z", "url": "https://github.com/prestodb/presto/pull/14276", "merged": true, "mergeCommit": {"oid": "6613a6a1be3f4c03e4bb77382cb71a7a0fbd42e4"}, "closed": true, "closedAt": "2020-03-24T00:56:21Z", "author": {"login": "kaikalur"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcQQNXYgBqjMxNTMwNzE1MDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcQlzcggBqjMxNTczMTcyNDE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "53677ad202257bc05d8f8248683d045348099696", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/53677ad202257bc05d8f8248683d045348099696", "committedDate": "2020-03-22T17:10:55Z", "message": "Fix bucket pruning when value is null and the predicate is 'IS NULL'."}, "afterCommit": {"oid": "8f17ad11e26b256766d48cc69d8c515bd861854a", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/8f17ad11e26b256766d48cc69d8c515bd861854a", "committedDate": "2020-03-22T21:01:01Z", "message": "Fix bucket pruning when value is null and the predicate is 'IS NULL'."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5MDUyMTQ2", "url": "https://github.com/prestodb/presto/pull/14276#pullrequestreview-379052146", "createdAt": "2020-03-22T22:03:10Z", "commit": {"oid": "8f17ad11e26b256766d48cc69d8c515bd861854a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMlQyMjowMzoxMFrOF5y2zQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMlQyMjowMzoxMFrOF5y2zQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjE0NjM4MQ==", "bodyText": "nit: static import", "url": "https://github.com/prestodb/presto/pull/14276#discussion_r396146381", "createdAt": "2020-03-22T22:03:10Z", "author": {"login": "caithagoras"}, "path": "presto-spi/src/main/java/com/facebook/presto/spi/predicate/TupleDomain.java", "diffHunk": "@@ -144,6 +144,11 @@ private TupleDomain(Optional<Map<T, Domain>> domains)\n \n     private static Optional<Set<NullableValue>> extractFixedValueSet(Domain domain)\n     {\n+        if (domain.isNullableSingleValue()) {\n+            return Optional.of(Collections.singleton(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f17ad11e26b256766d48cc69d8c515bd861854a"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8f17ad11e26b256766d48cc69d8c515bd861854a", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/8f17ad11e26b256766d48cc69d8c515bd861854a", "committedDate": "2020-03-22T21:01:01Z", "message": "Fix bucket pruning when value is null and the predicate is 'IS NULL'."}, "afterCommit": {"oid": "b40b1519dd61f6915a0f13513ce63ddd9f1ed713", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/b40b1519dd61f6915a0f13513ce63ddd9f1ed713", "committedDate": "2020-03-22T22:43:16Z", "message": "Fix bucket pruning when value is null and the predicate is 'IS NULL'."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5NDYwODYy", "url": "https://github.com/prestodb/presto/pull/14276#pullrequestreview-379460862", "createdAt": "2020-03-23T14:06:29Z", "commit": {"oid": "b40b1519dd61f6915a0f13513ce63ddd9f1ed713"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b40b1519dd61f6915a0f13513ce63ddd9f1ed713", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/b40b1519dd61f6915a0f13513ce63ddd9f1ed713", "committedDate": "2020-03-22T22:43:16Z", "message": "Fix bucket pruning when value is null and the predicate is 'IS NULL'."}, "afterCommit": {"oid": "84ac3c65d0913162a1f0b0519b39f288ceb03815", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/84ac3c65d0913162a1f0b0519b39f288ceb03815", "committedDate": "2020-03-23T17:08:31Z", "message": "Fix bucket pruning when value is null and the predicate is 'IS NULL'."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5NjM3OTI3", "url": "https://github.com/prestodb/presto/pull/14276#pullrequestreview-379637927", "createdAt": "2020-03-23T17:09:21Z", "commit": {"oid": "84ac3c65d0913162a1f0b0519b39f288ceb03815"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5NjYzNDIx", "url": "https://github.com/prestodb/presto/pull/14276#pullrequestreview-379663421", "createdAt": "2020-03-23T17:34:05Z", "commit": {"oid": "84ac3c65d0913162a1f0b0519b39f288ceb03815"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxNzozNDowNVrOF6Qcbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxNzozNDowNVrOF6Qcbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYzMTE1MA==", "bodyText": "nits: space after comma in NULL,1.", "url": "https://github.com/prestodb/presto/pull/14276#discussion_r396631150", "createdAt": "2020-03-23T17:34:05Z", "author": {"login": "rongrong"}, "path": "presto-hive/src/test/java/com/facebook/presto/hive/TestHiveIntegrationSmokeTest.java", "diffHunk": "@@ -2102,6 +2102,29 @@ public void testBucketPruning()\n         }\n     }\n \n+    @Test\n+    public void testNullBucket()\n+    {\n+        Session session = getSession();\n+        QueryRunner queryRunner = getQueryRunner();\n+        queryRunner.execute(\"CREATE TABLE table_with_null_buckets WITH (bucket_count=2, bucketed_by = ARRAY['key']) AS \" +\n+                \"SELECT 10 x, CAST(NULL AS INTEGER) AS key UNION ALL SELECT 20 x, 1 key\");\n+\n+        try {\n+            assertQuery(session, \"SELECT COUNT() FROM table_with_null_buckets WHERE key IS NULL\", \"SELECT 1\");\n+            assertQuery(session, \"SELECT x FROM table_with_null_buckets WHERE key IS NULL\", \"SELECT 10\");\n+            assertQuery(session, \"SELECT key FROM table_with_null_buckets WHERE x = 10\", \"SELECT NULL\");\n+            assertQuery(session, \"SELECT x FROM table_with_null_buckets WHERE key = 1\", \"SELECT 20\");\n+            assertQuery(session, \"SELECT key FROM table_with_null_buckets WHERE key IS NULL AND x = 10\", \"SELECT NULL\");\n+            assertQuery(session, \"SELECT COUNT() FROM table_with_null_buckets WHERE key IS NULL AND x = 1\", \"SELECT 0\");\n+            assertQuery(session, \"SELECT COUNT() FROM table_with_null_buckets WHERE key = 10\", \"SELECT 0\");\n+            assertQuery(session, \"SELECT COUNT() FROM table_with_null_buckets WHERE key IN (NULL,1)\", \"SELECT 1\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84ac3c65d0913162a1f0b0519b39f288ceb03815"}, "originalPosition": 20}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "84ac3c65d0913162a1f0b0519b39f288ceb03815", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/84ac3c65d0913162a1f0b0519b39f288ceb03815", "committedDate": "2020-03-23T17:08:31Z", "message": "Fix bucket pruning when value is null and the predicate is 'IS NULL'."}, "afterCommit": {"oid": "eff8c76b62e82800c0c761f49c6bc62f951815f2", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/eff8c76b62e82800c0c761f49c6bc62f951815f2", "committedDate": "2020-03-23T20:11:02Z", "message": "Fix bucket pruning when value is null and the predicate is 'IS NULL'."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5Nzk3NjAx", "url": "https://github.com/prestodb/presto/pull/14276#pullrequestreview-379797601", "createdAt": "2020-03-23T20:29:34Z", "commit": {"oid": "eff8c76b62e82800c0c761f49c6bc62f951815f2"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "973b1b1e1db896aadac9948e807de0960822546b", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/973b1b1e1db896aadac9948e807de0960822546b", "committedDate": "2020-03-23T22:10:50Z", "message": "Fix bucket pruning when value is null and the predicate is 'IS NULL'."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eff8c76b62e82800c0c761f49c6bc62f951815f2", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/eff8c76b62e82800c0c761f49c6bc62f951815f2", "committedDate": "2020-03-23T20:11:02Z", "message": "Fix bucket pruning when value is null and the predicate is 'IS NULL'."}, "afterCommit": {"oid": "973b1b1e1db896aadac9948e807de0960822546b", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/973b1b1e1db896aadac9948e807de0960822546b", "committedDate": "2020-03-23T22:10:50Z", "message": "Fix bucket pruning when value is null and the predicate is 'IS NULL'."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2083, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}