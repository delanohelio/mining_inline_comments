{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEwMDc5MzQ5", "number": 15356, "title": "Fix memory accounting in SpillableFinalOnlyGroupedAccumulator", "bodyText": "This fixes a bug where these accumulators were underreporting\nmemory usage resulting in less spilling events.\nTest plan - Travis + deploy to flash cluster for verification\n== NO RELEASE NOTE ==", "createdAt": "2020-10-26T14:42:30Z", "url": "https://github.com/prestodb/presto/pull/15356", "merged": true, "mergeCommit": {"oid": "be57a0e596c00d6fe9b57195fe11a3e4511f3281"}, "closed": true, "closedAt": "2020-10-28T07:18:59Z", "author": {"login": "sachdevs"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdWVfNiAFqTUxNjg1MTczNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdWtv4oABqjM5Mjc2NDYyOTY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2ODUxNzM0", "url": "https://github.com/prestodb/presto/pull/15356#pullrequestreview-516851734", "createdAt": "2020-10-26T14:45:39Z", "commit": {"oid": "be5e8f1af78ca1beb6ccbb0871b4168fc27b2ba6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNDo0NTo0MFrOHoS_Xw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNDo0NTo0MFrOHoS_Xw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAxNjIyMw==", "bodyText": "@highker probably isn't necessary to count blockBuilders in as much detail as I have done so in this PR (since it created during evaluateIntermediate at which point we are already spilling). I have included some logic to do this but we can strip it out if you see fit. I figured we should report this memory correctly just to avoid the scenario in which another operator overallocates.", "url": "https://github.com/prestodb/presto/pull/15356#discussion_r512016223", "createdAt": "2020-10-26T14:45:40Z", "author": {"login": "sachdevs"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/aggregation/GenericAccumulatorFactory.java", "diffHunk": "@@ -589,6 +589,8 @@ public void prepareFinal()\n \n         private ObjectBigArray<GroupIdPage> rawInputs = new ObjectBigArray<>();\n         private ObjectBigArray<RowBlockBuilder> blockBuilders;\n+        private long rawInputsSizeInBytes;\n+        private long blockBuildersSizeInBytes;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be5e8f1af78ca1beb6ccbb0871b4168fc27b2ba6"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3MDk0Njk3", "url": "https://github.com/prestodb/presto/pull/15356#pullrequestreview-517094697", "createdAt": "2020-10-26T19:09:50Z", "commit": {"oid": "be5e8f1af78ca1beb6ccbb0871b4168fc27b2ba6"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxOTowOTo1MFrOHoed-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxOTowOTo1MFrOHoed-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjIwNDI4Mw==", "bodyText": "also add the INSTANCE_SIZE for GroupIdPage itself: ClassLayout.parseClass(GroupIdPage.class).instanceSize();", "url": "https://github.com/prestodb/presto/pull/15356#discussion_r512204283", "createdAt": "2020-10-26T19:09:50Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/aggregation/GenericAccumulatorFactory.java", "diffHunk": "@@ -748,6 +762,11 @@ public GroupByIdBlock getGroupByIdBlock()\n             {\n                 return groupByIdBlock;\n             }\n+\n+            public long getRetainedSizeInBytes()\n+            {\n+                return groupByIdBlock.getRetainedSizeInBytes() + page.getRetainedSizeInBytes();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be5e8f1af78ca1beb6ccbb0871b4168fc27b2ba6"}, "originalPosition": 86}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "be5e8f1af78ca1beb6ccbb0871b4168fc27b2ba6", "author": {"user": {"login": "sachdevs", "name": "Saksham"}}, "url": "https://github.com/prestodb/presto/commit/be5e8f1af78ca1beb6ccbb0871b4168fc27b2ba6", "committedDate": "2020-10-26T14:39:27Z", "message": "Fix memory accounting in SpillableFinalOnlyGroupedAccumulator\nThis fixes a bug where these accumulators were underreporting\nmemory usage resulting in less spilling events."}, "afterCommit": {"oid": "a8bbaf51876139969d1845cd001505e577a72d30", "author": {"user": {"login": "sachdevs", "name": "Saksham"}}, "url": "https://github.com/prestodb/presto/commit/a8bbaf51876139969d1845cd001505e577a72d30", "committedDate": "2020-10-26T19:58:09Z", "message": "Fix memory accounting in SpillableFinalOnlyGroupedAccumulator\n\nThis fixes a bug where these accumulators were underreporting\nmemory usage resulting in less spilling events."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3Mjg2NTQ4", "url": "https://github.com/prestodb/presto/pull/15356#pullrequestreview-517286548", "createdAt": "2020-10-27T01:31:08Z", "commit": {"oid": "a8bbaf51876139969d1845cd001505e577a72d30"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwMTozMTowOFrOHooK0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwMTozMTowOFrOHooK0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM2MzIxOA==", "bodyText": "This should be GroupIdPage.class", "url": "https://github.com/prestodb/presto/pull/15356#discussion_r512363218", "createdAt": "2020-10-27T01:31:08Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/aggregation/GenericAccumulatorFactory.java", "diffHunk": "@@ -724,12 +737,15 @@ public void prepareFinal()\n             }\n \n             rawInputs = null;\n+            rawInputsSizeInBytes = 0;\n             rawInputsLength = 0;\n             delegate.prepareFinal();\n         }\n \n         private static class GroupIdPage\n         {\n+            private static final int INSTANCE_SIZE = ClassLayout.parseClass(SpillableFinalOnlyGroupedAccumulator.class).instanceSize();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a8bbaf51876139969d1845cd001505e577a72d30"}, "originalPosition": 82}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4027ed1c31bf7cb6e19833769dff4bfe06217a0", "author": {"user": {"login": "sachdevs", "name": "Saksham"}}, "url": "https://github.com/prestodb/presto/commit/c4027ed1c31bf7cb6e19833769dff4bfe06217a0", "committedDate": "2020-10-27T19:01:13Z", "message": "Fix memory accounting in SpillableFinalOnlyGroupedAccumulator\n\nThis fixes a bug where these accumulators were underreporting\nmemory usage resulting in less spilling events."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a8bbaf51876139969d1845cd001505e577a72d30", "author": {"user": {"login": "sachdevs", "name": "Saksham"}}, "url": "https://github.com/prestodb/presto/commit/a8bbaf51876139969d1845cd001505e577a72d30", "committedDate": "2020-10-26T19:58:09Z", "message": "Fix memory accounting in SpillableFinalOnlyGroupedAccumulator\n\nThis fixes a bug where these accumulators were underreporting\nmemory usage resulting in less spilling events."}, "afterCommit": {"oid": "c4027ed1c31bf7cb6e19833769dff4bfe06217a0", "author": {"user": {"login": "sachdevs", "name": "Saksham"}}, "url": "https://github.com/prestodb/presto/commit/c4027ed1c31bf7cb6e19833769dff4bfe06217a0", "committedDate": "2020-10-27T19:01:13Z", "message": "Fix memory accounting in SpillableFinalOnlyGroupedAccumulator\n\nThis fixes a bug where these accumulators were underreporting\nmemory usage resulting in less spilling events."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4627, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}