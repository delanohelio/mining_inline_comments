{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAwNzQ5OTM3", "number": 15296, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQwMToyNDo0OFrOEuPvQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQwMToyNToyMlrOEuPwEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2OTI3ODExOnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/com/facebook/presto/operator/repartition/PartitionedOutputOperator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQwMToyNDo0OFrOHihhIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxMTozMzoyMVrOHi3Y7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTk2Mjc4NA==", "bodyText": "Can we rename split to splittedPages? It's easy to get confused on the wordsplit with Presto splits", "url": "https://github.com/prestodb/presto/pull/15296#discussion_r505962784", "createdAt": "2020-10-16T01:24:48Z", "author": {"login": "yingsu00"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/repartition/PartitionedOutputOperator.java", "diffHunk": "@@ -419,15 +444,21 @@ public void flush(boolean force)\n \n                     operatorContext.recordOutput(pagePartition.getSizeInBytes(), pagePartition.getPositionCount());\n \n-                    List<SerializedPage> serializedPages = splitPage(pagePartition, DEFAULT_MAX_PAGE_SIZE_IN_BYTES).stream()\n-                            .map(serde::serialize)\n-                            .collect(toImmutableList());\n-\n-                    outputBuffer.enqueue(operatorContext.getDriverContext().getLifespan(), partition, serializedPages);\n+                    outputBuffer.enqueue(operatorContext.getDriverContext().getLifespan(), partition, splitAndSerializePage(pagePartition));\n                     pagesAdded.incrementAndGet();\n                     rowsAdded.addAndGet(pagePartition.getPositionCount());\n                 }\n             }\n         }\n+\n+        private List<SerializedPage> splitAndSerializePage(Page pagePartition)\n+        {\n+            List<Page> split = splitPage(pagePartition, DEFAULT_MAX_PAGE_SIZE_IN_BYTES);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c6afb6d847f3b849cd0f0cb2e82f203db94d1a7"}, "originalPosition": 116}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMyMTEzNA==", "bodyText": "Sure, renamed.", "url": "https://github.com/prestodb/presto/pull/15296#discussion_r506321134", "createdAt": "2020-10-16T11:33:21Z", "author": {"login": "pettyjamesm"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/repartition/PartitionedOutputOperator.java", "diffHunk": "@@ -419,15 +444,21 @@ public void flush(boolean force)\n \n                     operatorContext.recordOutput(pagePartition.getSizeInBytes(), pagePartition.getPositionCount());\n \n-                    List<SerializedPage> serializedPages = splitPage(pagePartition, DEFAULT_MAX_PAGE_SIZE_IN_BYTES).stream()\n-                            .map(serde::serialize)\n-                            .collect(toImmutableList());\n-\n-                    outputBuffer.enqueue(operatorContext.getDriverContext().getLifespan(), partition, serializedPages);\n+                    outputBuffer.enqueue(operatorContext.getDriverContext().getLifespan(), partition, splitAndSerializePage(pagePartition));\n                     pagesAdded.incrementAndGet();\n                     rowsAdded.addAndGet(pagePartition.getPositionCount());\n                 }\n             }\n         }\n+\n+        private List<SerializedPage> splitAndSerializePage(Page pagePartition)\n+        {\n+            List<Page> split = splitPage(pagePartition, DEFAULT_MAX_PAGE_SIZE_IN_BYTES);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTk2Mjc4NA=="}, "originalCommit": {"oid": "7c6afb6d847f3b849cd0f0cb2e82f203db94d1a7"}, "originalPosition": 116}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2OTI4MDE2OnYy", "diffSide": "RIGHT", "path": "presto-main/src/main/java/com/facebook/presto/operator/repartition/PartitionedOutputOperator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQwMToyNToyMlrOHihiSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxMTozMzo0MVrOHi3Z8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTk2MzA4MA==", "bodyText": "Wonder if you could add the same optimization to OptimizedPartitionedOutputOperator?", "url": "https://github.com/prestodb/presto/pull/15296#discussion_r505963080", "createdAt": "2020-10-16T01:25:22Z", "author": {"login": "yingsu00"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/repartition/PartitionedOutputOperator.java", "diffHunk": "@@ -385,14 +405,19 @@ public void partitionPage(Page page)\n \n         private Page getPartitionFunctionArguments(Page page)\n         {\n-            Block[] blocks = new Block[partitionChannels.size()];\n+            // Fast path for no constants\n+            if (partitionConstantBlocks == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c6afb6d847f3b849cd0f0cb2e82f203db94d1a7"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMyMTM5NA==", "bodyText": "Didn't realize OptimizedPartitionedOutputOperator existed, added the same change there.", "url": "https://github.com/prestodb/presto/pull/15296#discussion_r506321394", "createdAt": "2020-10-16T11:33:41Z", "author": {"login": "pettyjamesm"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/repartition/PartitionedOutputOperator.java", "diffHunk": "@@ -385,14 +405,19 @@ public void partitionPage(Page page)\n \n         private Page getPartitionFunctionArguments(Page page)\n         {\n-            Block[] blocks = new Block[partitionChannels.size()];\n+            // Fast path for no constants\n+            if (partitionConstantBlocks == null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTk2MzA4MA=="}, "originalCommit": {"oid": "7c6afb6d847f3b849cd0f0cb2e82f203db94d1a7"}, "originalPosition": 79}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3501, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}