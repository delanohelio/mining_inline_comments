{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc3ODM0NzAy", "number": 14123, "title": "Optimize aggregation of nulls", "bodyText": "== NO RELEASE NOTE ==", "createdAt": "2020-02-20T15:53:07Z", "url": "https://github.com/prestodb/presto/pull/14123", "merged": true, "mergeCommit": {"oid": "1e7780e7a151f43b3107267b0bdedde0686ce511"}, "closed": true, "closedAt": "2020-02-23T03:24:31Z", "author": {"login": "mbasmanova"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcGiMLTABqjMwNjEwNzkwNDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcGp02sAFqTM2Mjk5NTc0Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4445e252377b714cccbface18f29adb986ff79a9", "author": {"user": {"login": "mbasmanova", "name": "Maria Basmanova"}}, "url": "https://github.com/prestodb/presto/commit/4445e252377b714cccbface18f29adb986ff79a9", "committedDate": "2020-02-20T15:51:59Z", "message": "Optimize aggregation of nulls"}, "afterCommit": {"oid": "da7c93ccd111317497984cd6e2549ff29dc9054d", "author": {"user": {"login": "mbasmanova", "name": "Maria Basmanova"}}, "url": "https://github.com/prestodb/presto/commit/da7c93ccd111317497984cd6e2549ff29dc9054d", "committedDate": "2020-02-21T16:19:32Z", "message": "Optimize aggregation of nulls"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "499166c91bbc2a576e74643eeb4b73c9c1832360", "author": {"user": {"login": "mbasmanova", "name": "Maria Basmanova"}}, "url": "https://github.com/prestodb/presto/commit/499166c91bbc2a576e74643eeb4b73c9c1832360", "committedDate": "2020-02-21T16:20:24Z", "message": "Add position to 'position is not valid' error message"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8957d8603c015528bfa95a9f7dedd347fbade048", "author": {"user": {"login": "mbasmanova", "name": "Maria Basmanova"}}, "url": "https://github.com/prestodb/presto/commit/8957d8603c015528bfa95a9f7dedd347fbade048", "committedDate": "2020-02-21T16:20:25Z", "message": "Optimize aggregation of nulls"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "da7c93ccd111317497984cd6e2549ff29dc9054d", "author": {"user": {"login": "mbasmanova", "name": "Maria Basmanova"}}, "url": "https://github.com/prestodb/presto/commit/da7c93ccd111317497984cd6e2549ff29dc9054d", "committedDate": "2020-02-21T16:19:32Z", "message": "Optimize aggregation of nulls"}, "afterCommit": {"oid": "8957d8603c015528bfa95a9f7dedd347fbade048", "author": {"user": {"login": "mbasmanova", "name": "Maria Basmanova"}}, "url": "https://github.com/prestodb/presto/commit/8957d8603c015528bfa95a9f7dedd347fbade048", "committedDate": "2020-02-21T16:20:25Z", "message": "Optimize aggregation of nulls"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyOTcxNTY0", "url": "https://github.com/prestodb/presto/pull/14123#pullrequestreview-362971564", "createdAt": "2020-02-21T23:15:05Z", "commit": {"oid": "8957d8603c015528bfa95a9f7dedd347fbade048"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyOTc0MzE0", "url": "https://github.com/prestodb/presto/pull/14123#pullrequestreview-362974314", "createdAt": "2020-02-21T23:25:09Z", "commit": {"oid": "8957d8603c015528bfa95a9f7dedd347fbade048"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyOTk1NzQ2", "url": "https://github.com/prestodb/presto/pull/14123#pullrequestreview-362995746", "createdAt": "2020-02-22T01:09:46Z", "commit": {"oid": "8957d8603c015528bfa95a9f7dedd347fbade048"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMlQwMTowOTo0N1rOFtIkaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMlQwMToxMjozNlrOFtIlvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg3MDYzNQ==", "bodyText": "nit: what about if (!(%s ... (basically add a space", "url": "https://github.com/prestodb/presto/pull/14123#discussion_r382870635", "createdAt": "2020-02-22T01:09:47Z", "author": {"login": "wenleix"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/aggregation/AccumulatorCompiler.java", "diffHunk": "@@ -543,14 +545,32 @@ private static BytecodeBlock generateInputForLoop(\n                         .invokeStatic(CompilerOperations.class, \"testMask\", boolean.class, Block.class, int.class))\n                 .ifTrue(loopBody);\n \n-        block.append(new ForLoop()\n+        BytecodeNode forLoop = new ForLoop()\n                 .initialize(new BytecodeBlock().putVariable(positionVariable, 0))\n                 .condition(new BytecodeBlock()\n                         .getVariable(positionVariable)\n                         .getVariable(rowsVariable)\n                         .invokeStatic(CompilerOperations.class, \"lessThan\", boolean.class, int.class, int.class))\n                 .update(new BytecodeBlock().incrementVariable(positionVariable, (byte) 1))\n-                .body(loopBody));\n+                .body(loopBody);\n+\n+        for (int i = 0; i < parameterVariables.size(); i++) {\n+            if (!nullable.get(i)) {\n+                Variable variableDefinition = parameterVariables.get(i);\n+                forLoop = new IfStatement(\"if(!(%s instanceof RunLengthEncodedBlock && %s.isNull(0)))\", variableDefinition.getName(), variableDefinition.getName())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8957d8603c015528bfa95a9f7dedd347fbade048"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg3MDk3NA==", "bodyText": "My understanding is this if-statement is required in case the RLE block has 0 position count, so the block.isNull(0)  on line 560 will fail.\nDoes it make sense to do the empty block check in the line 560 check? i.e.\n   if (!(block instanceof RunLengthEncodedBlock && block.getPositionCount() != 0 && block.isNull(0))) {\n        // for loop....\n   }", "url": "https://github.com/prestodb/presto/pull/14123#discussion_r382870974", "createdAt": "2020-02-22T01:12:36Z", "author": {"login": "wenleix"}, "path": "presto-main/src/main/java/com/facebook/presto/operator/aggregation/AccumulatorCompiler.java", "diffHunk": "@@ -543,14 +545,32 @@ private static BytecodeBlock generateInputForLoop(\n                         .invokeStatic(CompilerOperations.class, \"testMask\", boolean.class, Block.class, int.class))\n                 .ifTrue(loopBody);\n \n-        block.append(new ForLoop()\n+        BytecodeNode forLoop = new ForLoop()\n                 .initialize(new BytecodeBlock().putVariable(positionVariable, 0))\n                 .condition(new BytecodeBlock()\n                         .getVariable(positionVariable)\n                         .getVariable(rowsVariable)\n                         .invokeStatic(CompilerOperations.class, \"lessThan\", boolean.class, int.class, int.class))\n                 .update(new BytecodeBlock().incrementVariable(positionVariable, (byte) 1))\n-                .body(loopBody));\n+                .body(loopBody);\n+\n+        for (int i = 0; i < parameterVariables.size(); i++) {\n+            if (!nullable.get(i)) {\n+                Variable variableDefinition = parameterVariables.get(i);\n+                forLoop = new IfStatement(\"if(!(%s instanceof RunLengthEncodedBlock && %s.isNull(0)))\", variableDefinition.getName(), variableDefinition.getName())\n+                        .condition(and(\n+                                variableDefinition.instanceOf(RunLengthEncodedBlock.class),\n+                                variableDefinition.invoke(\"isNull\", boolean.class, constantInt(0))))\n+                        .ifFalse(forLoop);\n+            }\n+        }\n+\n+        block.append(new IfStatement(\"if(%s > 0)\", rowsVariable.getName())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8957d8603c015528bfa95a9f7dedd347fbade048"}, "originalPosition": 42}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2263, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}