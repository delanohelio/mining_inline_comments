{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMxMTc4NzUy", "number": 14621, "title": "Add reader and writer support for DWRF encryption", "bodyText": "Adds support to the ORC reader and writer for dwrf encrypted columns\n== NO RELEASE NOTE ==", "createdAt": "2020-06-08T14:27:32Z", "url": "https://github.com/prestodb/presto/pull/14621", "merged": true, "mergeCommit": {"oid": "ca600190df37eb5daaf2f767b948b08c6942f57b"}, "closed": true, "closedAt": "2020-06-26T23:31:35Z", "author": {"login": "rschlussel"}, "timelineItems": {"totalCount": 50, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcqAYlKgBqjM0MzE1MDI5OTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcvEsvsgBqjM0ODcwMDcyNTk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eb45dc8aefc857358ace9c96f5411fbf93c73122", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/eb45dc8aefc857358ace9c96f5411fbf93c73122", "committedDate": "2020-06-08T14:23:52Z", "message": "Pass in encryption libraries"}, "afterCommit": {"oid": "4d4fc6f6213ee6ed29c92e881f18fb7846405be7", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/4d4fc6f6213ee6ed29c92e881f18fb7846405be7", "committedDate": "2020-06-10T20:36:37Z", "message": "Pass encryption info from hive to writer"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4d4fc6f6213ee6ed29c92e881f18fb7846405be7", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/4d4fc6f6213ee6ed29c92e881f18fb7846405be7", "committedDate": "2020-06-10T20:36:37Z", "message": "Pass encryption info from hive to writer"}, "afterCommit": {"oid": "9edcd3b0a993d8416d3314eec26f2aa4557ea612", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/9edcd3b0a993d8416d3314eec26f2aa4557ea612", "committedDate": "2020-06-11T15:25:04Z", "message": "Pass encryption info from hive to writer"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9edcd3b0a993d8416d3314eec26f2aa4557ea612", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/9edcd3b0a993d8416d3314eec26f2aa4557ea612", "committedDate": "2020-06-11T15:25:04Z", "message": "Pass encryption info from hive to writer"}, "afterCommit": {"oid": "19a1f0532d098c636a95a10306b9eabcd3850ded", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/19a1f0532d098c636a95a10306b9eabcd3850ded", "committedDate": "2020-06-11T15:31:23Z", "message": "Pass encryption info from hive to writer"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "19a1f0532d098c636a95a10306b9eabcd3850ded", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/19a1f0532d098c636a95a10306b9eabcd3850ded", "committedDate": "2020-06-11T15:31:23Z", "message": "Pass encryption info from hive to writer"}, "afterCommit": {"oid": "c5c17a1f7698755adba68ff59978faba744203a1", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/c5c17a1f7698755adba68ff59978faba744203a1", "committedDate": "2020-06-11T17:45:34Z", "message": "Pass encryption info from hive to writer"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d3d6d579f1650c020b735ed19b2a8c1ec51519d1", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/d3d6d579f1650c020b735ed19b2a8c1ec51519d1", "committedDate": "2020-06-17T23:27:03Z", "message": "fixup tests"}, "afterCommit": {"oid": "0cb090d4d0e0ccc1d10606816cfb168ae9786443", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/0cb090d4d0e0ccc1d10606816cfb168ae9786443", "committedDate": "2020-06-18T14:08:21Z", "message": "Add more testing for encryption/decryption"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0cb090d4d0e0ccc1d10606816cfb168ae9786443", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/0cb090d4d0e0ccc1d10606816cfb168ae9786443", "committedDate": "2020-06-18T14:08:21Z", "message": "Add more testing for encryption/decryption"}, "afterCommit": {"oid": "7f796dfb21012a88a81f7f2c20a22fb0e2ebd4ea", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/7f796dfb21012a88a81f7f2c20a22fb0e2ebd4ea", "committedDate": "2020-06-18T14:19:18Z", "message": "Add more testing for encryption/decryption"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7f796dfb21012a88a81f7f2c20a22fb0e2ebd4ea", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/7f796dfb21012a88a81f7f2c20a22fb0e2ebd4ea", "committedDate": "2020-06-18T14:19:18Z", "message": "Add more testing for encryption/decryption"}, "afterCommit": {"oid": "3d8dccef4385dfd206e3af081d935bbfe07ef65a", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/3d8dccef4385dfd206e3af081d935bbfe07ef65a", "committedDate": "2020-06-18T14:20:13Z", "message": "Add more testing for encryption/decryption"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3d8dccef4385dfd206e3af081d935bbfe07ef65a", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/3d8dccef4385dfd206e3af081d935bbfe07ef65a", "committedDate": "2020-06-18T14:20:13Z", "message": "Add more testing for encryption/decryption"}, "afterCommit": {"oid": "89fca9fda0a15ff5951b9714fc40fe6a2ab15191", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/89fca9fda0a15ff5951b9714fc40fe6a2ab15191", "committedDate": "2020-06-18T14:36:19Z", "message": "Add more testing for encryption/decryption"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "89fca9fda0a15ff5951b9714fc40fe6a2ab15191", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/89fca9fda0a15ff5951b9714fc40fe6a2ab15191", "committedDate": "2020-06-18T14:36:19Z", "message": "Add more testing for encryption/decryption"}, "afterCommit": {"oid": "c828ea789e6dba9c9884c5431af77321c0096cae", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/c828ea789e6dba9c9884c5431af77321c0096cae", "committedDate": "2020-06-18T14:40:13Z", "message": "Add more testing for encryption/decryption"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNTU2MzAw", "url": "https://github.com/prestodb/presto/pull/14621#pullrequestreview-433556300", "createdAt": "2020-06-18T18:48:52Z", "commit": {"oid": "c828ea789e6dba9c9884c5431af77321c0096cae"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxODo0ODo1M1rOGl771A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxOTo0OTowOFrOGl96WQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQzMjQ2OA==", "bodyText": "why is it empty map? shouldn't we have the actual keys supplied here?", "url": "https://github.com/prestodb/presto/pull/14621#discussion_r442432468", "createdAt": "2020-06-18T18:48:53Z", "author": {"login": "zzhao0"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePageSourceProvider.java", "diffHunk": "@@ -275,7 +276,8 @@ protected static CacheQuota generateCacheQuota(HiveSplit hiveSplit)\n                     layout.getDomainPredicate(),\n                     optimizedRemainingPredicate,\n                     hiveStorageTimeZone,\n-                    new HiveFileContext(splitContext.isCacheable(), cacheQuota, split.getExtraFileInfo().map(BinaryExtraHiveFileInfo::new)));\n+                    new HiveFileContext(splitContext.isCacheable(), cacheQuota, split.getExtraFileInfo().map(BinaryExtraHiveFileInfo::new)),\n+                    ImmutableMap.of());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c828ea789e6dba9c9884c5431af77321c0096cae"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQzNTI3NQ==", "bodyText": "i'm not sure if this is the right abstraction. The design of orc encryption doesn't have the concept of intermediate key. All it has is that there is provider, and the implementation of provider may choose to have intermediate key, or something else. Ideally this should be behind some interface. In bbio/dwio, we introduce factory which hold the set of keys, and can create encryption provider with the right key attached to it. We have crypto service factory that works with crypto service and can implement other factory when needed", "url": "https://github.com/prestodb/presto/pull/14621#discussion_r442435275", "createdAt": "2020-06-18T18:53:59Z", "author": {"login": "zzhao0"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/OrcReader.java", "diffHunk": "@@ -72,10 +83,22 @@ public OrcReader(\n             StripeMetadataSource stripeMetadataSource,\n             OrcAggregatedMemoryContext aggregatedMemoryContext,\n             OrcReaderOptions orcReaderOptions,\n-            boolean cacheable)\n+            boolean cacheable,\n+            Map<Integer, Slice> columnsToIntermediateKeys,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c828ea789e6dba9c9884c5431af77321c0096cae"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQzNjgxMA==", "bodyText": "See my comment to OrcReader.java. I don't feel we should expose the concept of intermediate key. Ideally, we expose an interface here, and have fb-only implementation (which uses crypto service and intermediate key) in prism module", "url": "https://github.com/prestodb/presto/pull/14621#discussion_r442436810", "createdAt": "2020-06-18T18:56:39Z", "author": {"login": "zzhao0"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/orc/OrcSelectivePageSourceFactory.java", "diffHunk": "@@ -273,7 +279,9 @@ public static OrcSelectivePageSource createOrcPageSource(\n             OrcFileTailSource orcFileTailSource,\n             StripeMetadataSource stripeMetadataSource,\n             HiveFileContext hiveFileContext,\n-            TupleDomainFilterCache tupleDomainFilterCache)\n+            TupleDomainFilterCache tupleDomainFilterCache,\n+            Map<Integer, Slice> columnsToIntermediateKeys,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c828ea789e6dba9c9884c5431af77321c0096cae"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQzNzcxNw==", "bodyText": "and this intermediate key doesn't make sense for any format other than the fb-dwrf", "url": "https://github.com/prestodb/presto/pull/14621#discussion_r442437717", "createdAt": "2020-06-18T18:58:18Z", "author": {"login": "zzhao0"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/parquet/ParquetPageSourceFactory.java", "diffHunk": "@@ -136,7 +137,8 @@ public ParquetPageSourceFactory(TypeManager typeManager, HdfsEnvironment hdfsEnv\n             List<HiveColumnHandle> columns,\n             TupleDomain<HiveColumnHandle> effectivePredicate,\n             DateTimeZone hiveStorageTimeZone,\n-            HiveFileContext hiveFileContext)\n+            HiveFileContext hiveFileContext,\n+            Map<Integer, Slice> columnsToIntermediateKeys)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c828ea789e6dba9c9884c5431af77321c0096cae"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ2MDQ1MA==", "bodyText": "Good comment!", "url": "https://github.com/prestodb/presto/pull/14621#discussion_r442460450", "createdAt": "2020-06-18T19:40:19Z", "author": {"login": "zzhao0"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/metadata/KeyProvider.java", "diffHunk": "@@ -0,0 +1,24 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.orc.metadata;\n+\n+public enum KeyProvider\n+{\n+    // UNKNOWN is used for files encrypted with a keyProvider\n+    // not defined by the format. For an UNKNOWN keyProvider,\n+    // make sure whatever is reading and writing the file\n+    // are configured to use the same keyProvider.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c828ea789e6dba9c9884c5431af77321c0096cae"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ2NDg1Nw==", "bodyText": "Where does presto handle schema mismatch?\nday 1: table has struct<a:struct<a:int>, b:float> and we create a partition\nday 2: table has new field appended to the first column: struct<a:struct<a:int,b:int>, b:float>, we create another partition\nthen int -> key map is not stable since same id represents different columns in the partition. Also FBETL has bug so not only that table schema may be different from partition's, partition schema may be different from the partition file. I did not see a place where it's explicitly handled", "url": "https://github.com/prestodb/presto/pull/14621#discussion_r442464857", "createdAt": "2020-06-18T19:49:08Z", "author": {"login": "zzhao0"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/OrcReader.java", "diffHunk": "@@ -127,6 +168,47 @@ public OrcReader(\n         this.cacheable = requireNonNull(cacheable, \"hiveFileContext is null\");\n     }\n \n+    private static Map<Integer, Slice> createIntermediateKeysMap(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c828ea789e6dba9c9884c5431af77321c0096cae"}, "originalPosition": 114}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c828ea789e6dba9c9884c5431af77321c0096cae", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/c828ea789e6dba9c9884c5431af77321c0096cae", "committedDate": "2020-06-18T14:40:13Z", "message": "Add more testing for encryption/decryption"}, "afterCommit": {"oid": "b88ab63f4c75aba06e822fc4cacc8393303a0276", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/b88ab63f4c75aba06e822fc4cacc8393303a0276", "committedDate": "2020-06-18T19:56:22Z", "message": "Add more testing for encryption/decryption"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNjY0NDE5", "url": "https://github.com/prestodb/presto/pull/14621#pullrequestreview-433664419", "createdAt": "2020-06-18T21:35:47Z", "commit": {"oid": "153aba43e9ede18bb3531394728aec47293a8865"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMTozNTo0N1rOGmBB-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMTozNTo0N1rOGmBB-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjUxNTk2MA==", "bodyText": "@zzhao0 how are the stats supposed to be serialized. Presto doesn't use them, and I didn't see a protobuf method for serializing the list.", "url": "https://github.com/prestodb/presto/pull/14621#discussion_r442515960", "createdAt": "2020-06-18T21:35:47Z", "author": {"login": "rschlussel"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/OrcWriter.java", "diffHunk": "@@ -483,16 +604,64 @@ public void close()\n         Map<String, Slice> userMetadata = this.userMetadata.entrySet().stream()\n                 .collect(Collectors.toMap(Entry::getKey, entry -> utf8Slice(entry.getValue())));\n \n+        ImmutableList.Builder<ColumnStatistics> unencryptedStatsBuilder = ImmutableList.builder();\n+        ImmutableMultimap.Builder<Integer, ColumnStatistics> encryptedStatsBuilder = ImmutableMultimap.builder();\n+        for (int i = 0; i < fileStats.size(); i++) {\n+            if (dwrfEncryptionInfo.getGroupByNodeId(i).isPresent()) {\n+                encryptedStatsBuilder.put(dwrfEncryptionInfo.getGroupByNodeId(i).get(), fileStats.get(i));\n+            }\n+            else {\n+                unencryptedStatsBuilder.add(fileStats.get(i));\n+            }\n+        }\n+        List<ColumnStatistics> unencryptedStats = unencryptedStatsBuilder.build();\n+        Multimap<Integer, ColumnStatistics> encryptedStats = encryptedStatsBuilder.build();\n+        Optional<DwrfEncryption> dwrfEncryption;\n+        if (dwrfWriterEncryption.isPresent()) {\n+            ImmutableList.Builder<EncryptionGroup> encryptionGroupBuilder = ImmutableList.builder();\n+            List<WriterEncryptionGroup> writerEncryptionGroups = dwrfWriterEncryption.get().getWriterEncryptionGroups();\n+            for (int i = 0; i < writerEncryptionGroups.size(); i++) {\n+                WriterEncryptionGroup group = writerEncryptionGroups.get(i);\n+                List<byte[]> columnStatistics = encryptedStats.get(i)\n+                        .stream()\n+                        .map(DwrfMetadataWriter::toColumnStatistics)\n+                        .map(AbstractMessageLite::toByteArray)\n+                        .collect(toImmutableList());\n+\n+                // TODO using an object output stream does not necessarily produce the same result that proto would", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "153aba43e9ede18bb3531394728aec47293a8865"}, "originalPosition": 292}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNzAwNTA1", "url": "https://github.com/prestodb/presto/pull/14621#pullrequestreview-433700505", "createdAt": "2020-06-18T22:58:41Z", "commit": {"oid": "b88ab63f4c75aba06e822fc4cacc8393303a0276"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMjo1ODo0MVrOGmCzAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQyMjo1ODo0MVrOGmCzAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU0NDg5OA==", "bodyText": "@zzhao0  this is where we put the encodings and streams into the stripe encryption groups", "url": "https://github.com/prestodb/presto/pull/14621#discussion_r442544898", "createdAt": "2020-06-18T22:58:41Z", "author": {"login": "rschlussel"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/OrcWriter.java", "diffHunk": "@@ -418,24 +509,56 @@ private void flushStripe(FlushReason flushReason)\n         columnEncodings.put(0, new ColumnEncoding(DIRECT, 0));\n         columnStatistics.put(0, new ColumnStatistics((long) stripeRowCount, 0, null, null, null, null, null, null, null, null));\n \n-        // add footer\n-        StripeFooter stripeFooter = new StripeFooter(allStreams, toDenseList(columnEncodings, orcTypes.size()));\n+        Map<Integer, ColumnEncoding> unencryptedColumnEncodings = columnEncodings.entrySet().stream()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b88ab63f4c75aba06e822fc4cacc8393303a0276"}, "originalPosition": 219}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNzc4MTYy", "url": "https://github.com/prestodb/presto/pull/14621#pullrequestreview-433778162", "createdAt": "2020-06-19T03:23:08Z", "commit": {"oid": "b88ab63f4c75aba06e822fc4cacc8393303a0276"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQwMzoyMzowOFrOGmG0AQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQwMzoyMzowOFrOGmG0AQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjYxMDY4OQ==", "bodyText": "This logic looks right to me at first glance. Will take a closer look later.", "url": "https://github.com/prestodb/presto/pull/14621#discussion_r442610689", "createdAt": "2020-06-19T03:23:08Z", "author": {"login": "zzhao0"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/OrcWriter.java", "diffHunk": "@@ -418,24 +509,56 @@ private void flushStripe(FlushReason flushReason)\n         columnEncodings.put(0, new ColumnEncoding(DIRECT, 0));\n         columnStatistics.put(0, new ColumnStatistics((long) stripeRowCount, 0, null, null, null, null, null, null, null, null));\n \n-        // add footer\n-        StripeFooter stripeFooter = new StripeFooter(allStreams, toDenseList(columnEncodings, orcTypes.size()));\n+        Map<Integer, ColumnEncoding> unencryptedColumnEncodings = columnEncodings.entrySet().stream()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU0NDg5OA=="}, "originalCommit": {"oid": "b88ab63f4c75aba06e822fc4cacc8393303a0276"}, "originalPosition": 219}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b88ab63f4c75aba06e822fc4cacc8393303a0276", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/b88ab63f4c75aba06e822fc4cacc8393303a0276", "committedDate": "2020-06-18T19:56:22Z", "message": "Add more testing for encryption/decryption"}, "afterCommit": {"oid": "62e8d6e9a25b2733159d5c171fc8d6b62026ca01", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/62e8d6e9a25b2733159d5c171fc8d6b62026ca01", "committedDate": "2020-06-24T18:30:33Z", "message": "Add more testing for encryption/decryption"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "62e8d6e9a25b2733159d5c171fc8d6b62026ca01", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/62e8d6e9a25b2733159d5c171fc8d6b62026ca01", "committedDate": "2020-06-24T18:30:33Z", "message": "Add more testing for encryption/decryption"}, "afterCommit": {"oid": "ec2bc970e61e93920e250086d1834685455495b2", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/ec2bc970e61e93920e250086d1834685455495b2", "committedDate": "2020-06-24T19:37:26Z", "message": "Add more testing for encryption/decryption"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ec2bc970e61e93920e250086d1834685455495b2", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/ec2bc970e61e93920e250086d1834685455495b2", "committedDate": "2020-06-24T19:37:26Z", "message": "Add more testing for encryption/decryption"}, "afterCommit": {"oid": "2d826cfabeff31243cf9e9a3aaf1e8d79c10932a", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/2d826cfabeff31243cf9e9a3aaf1e8d79c10932a", "committedDate": "2020-06-24T20:44:01Z", "message": "Add more testing for encryption/decryption"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2d826cfabeff31243cf9e9a3aaf1e8d79c10932a", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/2d826cfabeff31243cf9e9a3aaf1e8d79c10932a", "committedDate": "2020-06-24T20:44:01Z", "message": "Add more testing for encryption/decryption"}, "afterCommit": {"oid": "02fb6171ae39736ce1dd7da6bea1baeddd4a309c", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/02fb6171ae39736ce1dd7da6bea1baeddd4a309c", "committedDate": "2020-06-24T20:53:14Z", "message": "Add more testing for encryption/decryption"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "02fb6171ae39736ce1dd7da6bea1baeddd4a309c", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/02fb6171ae39736ce1dd7da6bea1baeddd4a309c", "committedDate": "2020-06-24T20:53:14Z", "message": "Add more testing for encryption/decryption"}, "afterCommit": {"oid": "94292525bd05b1bb970dce026d1078e4f6d4d862", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/94292525bd05b1bb970dce026d1078e4f6d4d862", "committedDate": "2020-06-24T23:36:40Z", "message": "Add more testing for encryption/decryption"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "94292525bd05b1bb970dce026d1078e4f6d4d862", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/94292525bd05b1bb970dce026d1078e4f6d4d862", "committedDate": "2020-06-24T23:36:40Z", "message": "Add more testing for encryption/decryption"}, "afterCommit": {"oid": "aed934aa75faf797bb9b794a1a9ebf73a0ce5986", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/aed934aa75faf797bb9b794a1a9ebf73a0ce5986", "committedDate": "2020-06-25T13:07:49Z", "message": "Add more testing for encryption/decryption"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "aed934aa75faf797bb9b794a1a9ebf73a0ce5986", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/aed934aa75faf797bb9b794a1a9ebf73a0ce5986", "committedDate": "2020-06-25T13:07:49Z", "message": "Add more testing for encryption/decryption"}, "afterCommit": {"oid": "8fb9a4166814600d1380aa6b425350a6ed06717a", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/8fb9a4166814600d1380aa6b425350a6ed06717a", "committedDate": "2020-06-25T17:42:05Z", "message": "Pass encryption info from hive to ORC reader/writer"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8fb9a4166814600d1380aa6b425350a6ed06717a", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/8fb9a4166814600d1380aa6b425350a6ed06717a", "committedDate": "2020-06-25T17:42:05Z", "message": "Pass encryption info from hive to ORC reader/writer"}, "afterCommit": {"oid": "38524c8ccf450e4d5baf11b57e6aab6f3695154e", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/38524c8ccf450e4d5baf11b57e6aab6f3695154e", "committedDate": "2020-06-25T17:43:47Z", "message": "Pass encryption info from hive to ORC reader/writer"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "38524c8ccf450e4d5baf11b57e6aab6f3695154e", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/38524c8ccf450e4d5baf11b57e6aab6f3695154e", "committedDate": "2020-06-25T17:43:47Z", "message": "Pass encryption info from hive to ORC reader/writer"}, "afterCommit": {"oid": "f562501521d31ab673b89e24b4304a5a9348270b", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/f562501521d31ab673b89e24b4304a5a9348270b", "committedDate": "2020-06-25T18:42:44Z", "message": "Pass encryption info from hive to ORC reader/writer"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f562501521d31ab673b89e24b4304a5a9348270b", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/f562501521d31ab673b89e24b4304a5a9348270b", "committedDate": "2020-06-25T18:42:44Z", "message": "Pass encryption info from hive to ORC reader/writer"}, "afterCommit": {"oid": "731a5169142c8d52ed1a0fe2ff90bbfb134c798f", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/731a5169142c8d52ed1a0fe2ff90bbfb134c798f", "committedDate": "2020-06-25T20:08:28Z", "message": "Pass encryption info from hive to ORC reader/writer"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3ODg0OTU2", "url": "https://github.com/prestodb/presto/pull/14621#pullrequestreview-437884956", "createdAt": "2020-06-25T21:51:57Z", "commit": {"oid": "731a5169142c8d52ed1a0fe2ff90bbfb134c798f"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQyMTo1MTo1N1rOGpNFlg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQyMTo1MTo1N1rOGpNFlg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg1OTIyMg==", "bodyText": "do other file formats have a similar format where in column values are stored as integers? If not, we should just let the Orc code do getDwrfEncryptionMetadata and then call toKeyMap.\nMy idea behind this class was to allow for future encryption implementations to be dropped into this class.", "url": "https://github.com/prestodb/presto/pull/14621#discussion_r445859222", "createdAt": "2020-06-25T21:51:57Z", "author": {"login": "mayankgarg1990"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/EncryptionInformation.java", "diffHunk": "@@ -77,4 +82,12 @@ public boolean equals(Object obj)\n         EncryptionInformation otherObj = (EncryptionInformation) obj;\n         return Objects.equals(this.dwrfEncryptionMetadata, otherObj.dwrfEncryptionMetadata);\n     }\n+\n+    public Map<Integer, Slice> toKeyMap(List<OrcType> types, List<HiveColumnHandle> physicalColumnHandles)\n+    {\n+        if (dwrfEncryptionMetadata.isPresent()) {\n+            return dwrfEncryptionMetadata.get().toKeyMap(types, physicalColumnHandles);\n+        }\n+        return ImmutableMap.of();\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "731a5169142c8d52ed1a0fe2ff90bbfb134c798f"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3OTY3Mzg3", "url": "https://github.com/prestodb/presto/pull/14621#pullrequestreview-437967387", "createdAt": "2020-06-26T01:55:28Z", "commit": {"oid": "731a5169142c8d52ed1a0fe2ff90bbfb134c798f"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3OTY3NDQw", "url": "https://github.com/prestodb/presto/pull/14621#pullrequestreview-437967440", "createdAt": "2020-06-26T01:55:41Z", "commit": {"oid": "731a5169142c8d52ed1a0fe2ff90bbfb134c798f"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3OTY4OTE2", "url": "https://github.com/prestodb/presto/pull/14621#pullrequestreview-437968916", "createdAt": "2020-06-26T02:00:47Z", "commit": {"oid": "704008eccb83c3b6dad0ac6b613f4a2ec10263dd"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwMjowMDo0OFrOGpRYeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwMjowNDoxMlrOGpRbWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkyOTU5NA==", "bodyText": "nit: wrap", "url": "https://github.com/prestodb/presto/pull/14621#discussion_r445929594", "createdAt": "2020-06-26T02:00:48Z", "author": {"login": "arhimondr"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/metadata/DwrfMetadataReader.java", "diffHunk": "@@ -129,12 +165,22 @@ public StripeFooter readStripeFooter(List<OrcType> types, InputStream inputStrea\n     {\n         CodedInputStream input = CodedInputStream.newInstance(inputStream);\n         DwrfProto.StripeFooter stripeFooter = DwrfProto.StripeFooter.parseFrom(input);\n-        return new StripeFooter(toStream(stripeFooter.getStreamsList()), toColumnEncoding(types, stripeFooter.getColumnsList()));\n+        return new StripeFooter(\n+                toStream(stripeFooter.getStreamsList()),\n+                toColumnEncoding(types, stripeFooter.getColumnsList()),\n+                stripeFooter.getEncryptedGroupsList().stream()\n+                        .map(OrcMetadataReader::byteStringToSlice)\n+                        .collect(toImmutableList()));\n     }\n \n     private static Stream toStream(DwrfProto.Stream stream)\n     {\n-        return new Stream(stream.getColumn(), toStreamKind(stream.getKind()), toIntExact(stream.getLength()), stream.getUseVInts(), stream.getSequence());\n+        return new Stream(\n+                stream.getColumn(),\n+                toStreamKind(stream.getKind()),\n+                toIntExact(stream.getLength()),\n+                stream.getUseVInts(), stream.getSequence(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "704008eccb83c3b6dad0ac6b613f4a2ec10263dd"}, "originalPosition": 95}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkzMDA5Mw==", "bodyText": "nit ImmutableList.copyof()", "url": "https://github.com/prestodb/presto/pull/14621#discussion_r445930093", "createdAt": "2020-06-26T02:03:06Z", "author": {"login": "arhimondr"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/metadata/StripeEncryptionGroup.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.orc.metadata;\n+\n+import java.io.Serializable;\n+import java.util.List;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class StripeEncryptionGroup\n+        implements Serializable\n+{\n+    private final List<Stream> streams;\n+    private final List<ColumnEncoding> columnEncodings;\n+\n+    public StripeEncryptionGroup(List<Stream> streams, List<ColumnEncoding> columnEncodings)\n+    {\n+        this.streams = requireNonNull(streams, \"streams is null\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "704008eccb83c3b6dad0ac6b613f4a2ec10263dd"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkzMDExOA==", "bodyText": "ditto", "url": "https://github.com/prestodb/presto/pull/14621#discussion_r445930118", "createdAt": "2020-06-26T02:03:11Z", "author": {"login": "arhimondr"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/metadata/StripeEncryptionGroup.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.orc.metadata;\n+\n+import java.io.Serializable;\n+import java.util.List;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+public class StripeEncryptionGroup\n+        implements Serializable\n+{\n+    private final List<Stream> streams;\n+    private final List<ColumnEncoding> columnEncodings;\n+\n+    public StripeEncryptionGroup(List<Stream> streams, List<ColumnEncoding> columnEncodings)\n+    {\n+        this.streams = requireNonNull(streams, \"streams is null\");\n+        this.columnEncodings = requireNonNull(columnEncodings, \"columnEncodings is null\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "704008eccb83c3b6dad0ac6b613f4a2ec10263dd"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkzMDMzMQ==", "bodyText": "nit: ImmutableList.copyOf, also you can inline the requireNonNull", "url": "https://github.com/prestodb/presto/pull/14621#discussion_r445930331", "createdAt": "2020-06-26T02:04:12Z", "author": {"login": "arhimondr"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/metadata/StripeInformation.java", "diffHunk": "@@ -24,16 +29,23 @@\n     private final long dataLength;\n     private final long footerLength;\n \n-    public StripeInformation(int numberOfRows, long offset, long indexLength, long dataLength, long footerLength)\n+    // Arbitrary binary representing key metadata. It could be identifier\n+    // of key in KMS, encrypted DEK or other form of user defined key metadata.\n+    // only set for run start, and reuse until next run\n+    private final List<Slice> keyMetadata;\n+\n+    public StripeInformation(int numberOfRows, long offset, long indexLength, long dataLength, long footerLength, List<Slice> keyMetadata)\n     {\n         // dataLength can be zero when the stripe only contains empty flat maps.\n         checkArgument(numberOfRows > 0, \"Stripe must have at least one row\");\n         checkArgument(footerLength > 0, \"Stripe must have a footer section\");\n+        requireNonNull(keyMetadata, \"keyMetadata is null\");\n         this.numberOfRows = numberOfRows;\n         this.offset = offset;\n         this.indexLength = indexLength;\n         this.dataLength = dataLength;\n         this.footerLength = footerLength;\n+        this.keyMetadata = keyMetadata;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "704008eccb83c3b6dad0ac6b613f4a2ec10263dd"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3OTcwMjcx", "url": "https://github.com/prestodb/presto/pull/14621#pullrequestreview-437970271", "createdAt": "2020-06-26T02:06:01Z", "commit": {"oid": "731a5169142c8d52ed1a0fe2ff90bbfb134c798f"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3OTcwNTAz", "url": "https://github.com/prestodb/presto/pull/14621#pullrequestreview-437970503", "createdAt": "2020-06-26T02:06:53Z", "commit": {"oid": "731a5169142c8d52ed1a0fe2ff90bbfb134c798f"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3OTcxMTI1", "url": "https://github.com/prestodb/presto/pull/14621#pullrequestreview-437971125", "createdAt": "2020-06-26T02:08:53Z", "commit": {"oid": "f58d7769c6531a2a0d24d53ea1c93d985e7ceff5"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwMjowODo1M1rOGpRfow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwMjoyMzoyOFrOGpRs1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkzMTQyNw==", "bodyText": "nit: maybe ass key and previous in the error message?", "url": "https://github.com/prestodb/presto/pull/14621#discussion_r445931427", "createdAt": "2020-06-26T02:08:53Z", "author": {"login": "arhimondr"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/AbstractOrcRecordReader.java", "diffHunk": "@@ -316,6 +334,32 @@ private static void includeOrcColumnsRecursive(List<OrcType> types, Set<Integer>\n         return Optional.of(ImmutableMap.copyOf(fields));\n     }\n \n+    private static Map<Integer, Slice> createIntermediateKeysMap(\n+            Map<Integer, Slice> columnsToKeys,\n+            Map<Integer, Integer> dwrfEncryptionGroupMap,\n+            OrcDataSourceId dataSourceId)\n+    {\n+        Map<Integer, Slice> intermediateKeys = new HashMap<>(dwrfEncryptionGroupMap.values().size());\n+        for (Map.Entry<Integer, Slice> entry : columnsToKeys.entrySet()) {\n+            Slice key = entry.getValue();\n+            int group = dwrfEncryptionGroupMap.get(entry.getKey());\n+            Slice previous = intermediateKeys.putIfAbsent(group, key);\n+            if (previous != null && !key.equals(previous)) {\n+                throw new OrcCorruptionException(dataSourceId, \"intermediate keys mapping does not match encryption groups\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f58d7769c6531a2a0d24d53ea1c93d985e7ceff5"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkzMTc3NQ==", "bodyText": "nit: toIntExact", "url": "https://github.com/prestodb/presto/pull/14621#discussion_r445931775", "createdAt": "2020-06-26T02:10:17Z", "author": {"login": "arhimondr"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/DwrfEncryptionInfo.java", "diffHunk": "@@ -0,0 +1,126 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.orc;\n+\n+import com.facebook.presto.orc.metadata.OrcType;\n+import com.google.common.base.VerifyException;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+import io.airlift.slice.Slice;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+\n+import static com.google.common.base.Verify.verify;\n+import static java.lang.String.format;\n+import static java.util.Objects.requireNonNull;\n+\n+public class DwrfEncryptionInfo\n+{\n+    public static final DwrfEncryptionInfo UNENCRYPTED = new DwrfEncryptionInfo(ImmutableMap.of(), ImmutableList.of(), ImmutableMap.of());\n+    private final Map<Integer, DwrfDataEncryptor> dwrfEncryptors;\n+    private final List<Slice> encryptedKeyMetadatas;\n+    private final Map<Integer, Integer> nodeToGroupMap;\n+\n+    public DwrfEncryptionInfo(Map<Integer, DwrfDataEncryptor> dwrfEncryptors, List<Slice> encryptedKeyMetadatas, Map<Integer, Integer> nodeToGroupMap)\n+    {\n+        this.dwrfEncryptors = ImmutableMap.copyOf(requireNonNull(dwrfEncryptors, \"dwrfDecryptors is null\"));\n+        this.encryptedKeyMetadatas = ImmutableList.copyOf(requireNonNull(encryptedKeyMetadatas, \"keyMetadatas is null\"));\n+        this.nodeToGroupMap = ImmutableMap.copyOf(requireNonNull(nodeToGroupMap, \"nodeToGroupMap is null\"));\n+    }\n+\n+    public static DwrfEncryptionInfo createDwrfEncryptionInfo(\n+            EncryptionLibrary encryptionLibrary,\n+            List<Slice> encryptedKeyMetadatas,\n+            Map<Integer, Slice> intermediateKeyMetadatas,\n+            Map<Integer, Integer> nodeToGroupMap)\n+    {\n+        // A user might only have permission to read columns from some encryption groups\n+        // create encryptors for the groups a user has IEKs for\n+        ImmutableMap.Builder<Integer, DwrfDataEncryptor> encryptorsBuilder = ImmutableMap.builder();\n+        for (Integer groupId : intermediateKeyMetadatas.keySet()) {\n+            Slice encryptedDataKey = encryptedKeyMetadatas.get(groupId);\n+            Slice decryptedKeyMetadata = encryptionLibrary.decryptKey(intermediateKeyMetadatas.get(groupId), encryptedDataKey.getBytes(), 0, encryptedDataKey.length());\n+            encryptorsBuilder.put(groupId, new DwrfDataEncryptor(decryptedKeyMetadata, encryptionLibrary));\n+        }\n+\n+        return new DwrfEncryptionInfo(encryptorsBuilder.build(), encryptedKeyMetadatas, nodeToGroupMap);\n+    }\n+\n+    public static Map<Integer, Integer> createNodeToGroupMap(List<List<Integer>> encryptionGroups, List<OrcType> types)\n+    {\n+        // We don't use an immutableMap builder so that we can check what's already been added\n+        Map<Integer, Integer> nodeToGroupMapBuilder = new HashMap();\n+        for (int groupId = 0; groupId < encryptionGroups.size(); groupId++) {\n+            for (Integer nodeId : encryptionGroups.get(groupId)) {\n+                fillNodeToGroupMap(groupId, nodeId, types, nodeToGroupMapBuilder);\n+            }\n+        }\n+        return ImmutableMap.copyOf(nodeToGroupMapBuilder);\n+    }\n+\n+    private static void fillNodeToGroupMap(int groupId, int nodeId, List<OrcType> types, Map<Integer, Integer> nodeToGroupMapBuilder)\n+    {\n+        if (nodeToGroupMapBuilder.containsKey(nodeId) && nodeToGroupMapBuilder.get(nodeId) != groupId) {\n+            throw new VerifyException(format(\"Column or sub-column %s belongs to more than one encryption group: %s and %s\", nodeId, nodeToGroupMapBuilder.get(nodeId), groupId));\n+        }\n+        nodeToGroupMapBuilder.put(nodeId, groupId);\n+        OrcType type = types.get(nodeId);\n+        for (int childIndex : type.getFieldTypeIndexes()) {\n+            fillNodeToGroupMap(groupId, childIndex, types, nodeToGroupMapBuilder);\n+        }\n+    }\n+\n+    public DwrfDataEncryptor getEncryptorByGroupId(int groupId)\n+    {\n+        verify(groupId < dwrfEncryptors.size(), \"groupId exceeds the size of dwrfDecryptors\");\n+        return dwrfEncryptors.get(groupId);\n+    }\n+\n+    public Optional<DwrfDataEncryptor> getEncryptorByNodeId(int nodeId)\n+    {\n+        if (!nodeToGroupMap.containsKey(nodeId)) {\n+            return Optional.empty();\n+        }\n+        return Optional.of(getEncryptorByGroupId(nodeToGroupMap.get(nodeId)));\n+    }\n+\n+    public Optional<Integer> getGroupByNodeId(int nodeId)\n+    {\n+        return Optional.ofNullable(nodeToGroupMap.get(nodeId));\n+    }\n+\n+    public Set<Integer> getEncryptorGroupIds()\n+    {\n+        return dwrfEncryptors.keySet();\n+    }\n+\n+    public int getNumberOfEncryptedNodes()\n+    {\n+        return nodeToGroupMap.keySet().size();\n+    }\n+\n+    public int getNumberOfNodesInGroup(int group)\n+    {\n+        return (int) nodeToGroupMap.values().stream().filter(value -> value == group).count();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f58d7769c6531a2a0d24d53ea1c93d985e7ceff5"}, "originalPosition": 119}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkzMjAxMw==", "bodyText": "Why does it have to be UncheckedIOException?", "url": "https://github.com/prestodb/presto/pull/14621#discussion_r445932013", "createdAt": "2020-06-26T02:11:30Z", "author": {"login": "arhimondr"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/OrcPermissionsException.java", "diffHunk": "@@ -0,0 +1,33 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.orc;\n+\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n+\n+import static java.lang.String.format;\n+\n+public class OrcPermissionsException\n+        extends UncheckedIOException", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f58d7769c6531a2a0d24d53ea1c93d985e7ceff5"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkzMjEwNg==", "bodyText": "It it wasn't the UncheckedIOException as a base class you simply could pass the message directly", "url": "https://github.com/prestodb/presto/pull/14621#discussion_r445932106", "createdAt": "2020-06-26T02:11:53Z", "author": {"login": "arhimondr"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/OrcPermissionsException.java", "diffHunk": "@@ -0,0 +1,33 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.orc;\n+\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n+\n+import static java.lang.String.format;\n+\n+public class OrcPermissionsException\n+        extends UncheckedIOException\n+{\n+    public OrcPermissionsException(OrcDataSourceId orcDataSourceId, String messageFormat, Object... args)\n+    {\n+        super(new IOException(formatMessage(orcDataSourceId, messageFormat, args)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f58d7769c6531a2a0d24d53ea1c93d985e7ceff5"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkzMzM1Nw==", "bodyText": "nit: wrap", "url": "https://github.com/prestodb/presto/pull/14621#discussion_r445933357", "createdAt": "2020-06-26T02:17:22Z", "author": {"login": "arhimondr"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/OrcReader.java", "diffHunk": "@@ -216,7 +285,7 @@ public OrcSelectiveRecordReader createSelectiveRecordReader(\n             boolean legacyMapSubscript,\n             OrcAggregatedMemoryContext systemMemoryUsage,\n             Optional<OrcWriteValidation> writeValidation,\n-            int initialBatchSize)\n+            int initialBatchSize, Map<Integer, Slice> columnsToIntermediateKeys)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f58d7769c6531a2a0d24d53ea1c93d985e7ceff5"}, "originalPosition": 180}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkzNDY2Mw==", "bodyText": "maybe add the values to the error message", "url": "https://github.com/prestodb/presto/pull/14621#discussion_r445934663", "createdAt": "2020-06-26T02:22:49Z", "author": {"login": "arhimondr"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/DwrfEncryptionInfo.java", "diffHunk": "@@ -0,0 +1,126 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.orc;\n+\n+import com.facebook.presto.orc.metadata.OrcType;\n+import com.google.common.base.VerifyException;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+import io.airlift.slice.Slice;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+\n+import static com.google.common.base.Verify.verify;\n+import static java.lang.String.format;\n+import static java.util.Objects.requireNonNull;\n+\n+public class DwrfEncryptionInfo\n+{\n+    public static final DwrfEncryptionInfo UNENCRYPTED = new DwrfEncryptionInfo(ImmutableMap.of(), ImmutableList.of(), ImmutableMap.of());\n+    private final Map<Integer, DwrfDataEncryptor> dwrfEncryptors;\n+    private final List<Slice> encryptedKeyMetadatas;\n+    private final Map<Integer, Integer> nodeToGroupMap;\n+\n+    public DwrfEncryptionInfo(Map<Integer, DwrfDataEncryptor> dwrfEncryptors, List<Slice> encryptedKeyMetadatas, Map<Integer, Integer> nodeToGroupMap)\n+    {\n+        this.dwrfEncryptors = ImmutableMap.copyOf(requireNonNull(dwrfEncryptors, \"dwrfDecryptors is null\"));\n+        this.encryptedKeyMetadatas = ImmutableList.copyOf(requireNonNull(encryptedKeyMetadatas, \"keyMetadatas is null\"));\n+        this.nodeToGroupMap = ImmutableMap.copyOf(requireNonNull(nodeToGroupMap, \"nodeToGroupMap is null\"));\n+    }\n+\n+    public static DwrfEncryptionInfo createDwrfEncryptionInfo(\n+            EncryptionLibrary encryptionLibrary,\n+            List<Slice> encryptedKeyMetadatas,\n+            Map<Integer, Slice> intermediateKeyMetadatas,\n+            Map<Integer, Integer> nodeToGroupMap)\n+    {\n+        // A user might only have permission to read columns from some encryption groups\n+        // create encryptors for the groups a user has IEKs for\n+        ImmutableMap.Builder<Integer, DwrfDataEncryptor> encryptorsBuilder = ImmutableMap.builder();\n+        for (Integer groupId : intermediateKeyMetadatas.keySet()) {\n+            Slice encryptedDataKey = encryptedKeyMetadatas.get(groupId);\n+            Slice decryptedKeyMetadata = encryptionLibrary.decryptKey(intermediateKeyMetadatas.get(groupId), encryptedDataKey.getBytes(), 0, encryptedDataKey.length());\n+            encryptorsBuilder.put(groupId, new DwrfDataEncryptor(decryptedKeyMetadata, encryptionLibrary));\n+        }\n+\n+        return new DwrfEncryptionInfo(encryptorsBuilder.build(), encryptedKeyMetadatas, nodeToGroupMap);\n+    }\n+\n+    public static Map<Integer, Integer> createNodeToGroupMap(List<List<Integer>> encryptionGroups, List<OrcType> types)\n+    {\n+        // We don't use an immutableMap builder so that we can check what's already been added\n+        Map<Integer, Integer> nodeToGroupMapBuilder = new HashMap();\n+        for (int groupId = 0; groupId < encryptionGroups.size(); groupId++) {\n+            for (Integer nodeId : encryptionGroups.get(groupId)) {\n+                fillNodeToGroupMap(groupId, nodeId, types, nodeToGroupMapBuilder);\n+            }\n+        }\n+        return ImmutableMap.copyOf(nodeToGroupMapBuilder);\n+    }\n+\n+    private static void fillNodeToGroupMap(int groupId, int nodeId, List<OrcType> types, Map<Integer, Integer> nodeToGroupMapBuilder)\n+    {\n+        if (nodeToGroupMapBuilder.containsKey(nodeId) && nodeToGroupMapBuilder.get(nodeId) != groupId) {\n+            throw new VerifyException(format(\"Column or sub-column %s belongs to more than one encryption group: %s and %s\", nodeId, nodeToGroupMapBuilder.get(nodeId), groupId));\n+        }\n+        nodeToGroupMapBuilder.put(nodeId, groupId);\n+        OrcType type = types.get(nodeId);\n+        for (int childIndex : type.getFieldTypeIndexes()) {\n+            fillNodeToGroupMap(groupId, childIndex, types, nodeToGroupMapBuilder);\n+        }\n+    }\n+\n+    public DwrfDataEncryptor getEncryptorByGroupId(int groupId)\n+    {\n+        verify(groupId < dwrfEncryptors.size(), \"groupId exceeds the size of dwrfDecryptors\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f58d7769c6531a2a0d24d53ea1c93d985e7ceff5"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkzNDgwNw==", "bodyText": "IllegalArgumentException", "url": "https://github.com/prestodb/presto/pull/14621#discussion_r445934807", "createdAt": "2020-06-26T02:23:28Z", "author": {"login": "arhimondr"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/DwrfEncryptionProvider.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.orc;\n+\n+import com.facebook.presto.orc.metadata.KeyProvider;\n+\n+import java.util.Optional;\n+\n+import static java.lang.String.format;\n+import static java.util.Objects.requireNonNull;\n+\n+public class DwrfEncryptionProvider\n+{\n+    public static final DwrfEncryptionProvider NO_ENCRYPTION = new DwrfEncryptionProvider(Optional.empty(), Optional.empty());\n+\n+    private final Optional<EncryptionLibrary> cryptoServiceLibrary;\n+    private final Optional<EncryptionLibrary> unknownLibrary;\n+\n+    public DwrfEncryptionProvider(Optional<EncryptionLibrary> cryptoServiceLibrary, Optional<EncryptionLibrary> unknownLibrary)\n+    {\n+        this.cryptoServiceLibrary = requireNonNull(cryptoServiceLibrary, \"cryptoServiceLibrary is null\");\n+        this.unknownLibrary = requireNonNull(unknownLibrary, \"unknownLibrary is null\");\n+    }\n+\n+    public EncryptionLibrary getEncryptionLibrary(KeyProvider keyProvider)\n+    {\n+        switch (keyProvider) {\n+            case CRYPTO_SERVICE:\n+                if (!cryptoServiceLibrary.isPresent()) {\n+                    throw new UnsupportedOperationException(\"\\\"crypto_service\\\" encryption is not configured\");\n+                }\n+                return cryptoServiceLibrary.get();\n+            case UNKNOWN:\n+                if (!unknownLibrary.isPresent()) {\n+                    throw new UnsupportedOperationException(\"\\\"unknown\\\" encryption is not configured\");\n+                }\n+                return unknownLibrary.get();\n+            default:\n+                throw new UnsupportedOperationException(format(\"Unknown KeyProvider: %s\", keyProvider));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f58d7769c6531a2a0d24d53ea1c93d985e7ceff5"}, "originalPosition": 50}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3OTc3MDk4", "url": "https://github.com/prestodb/presto/pull/14621#pullrequestreview-437977098", "createdAt": "2020-06-26T02:31:26Z", "commit": {"oid": "a472e8c5b32b66358892386f3d0f4776f1d992e1"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwMjozMToyN1rOGpR0LA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwMjozMzo1OFrOGpR2UA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkzNjY4NA==", "bodyText": "IllegalArgumentException", "url": "https://github.com/prestodb/presto/pull/14621#discussion_r445936684", "createdAt": "2020-06-26T02:31:27Z", "author": {"login": "arhimondr"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/OrcOutputBuffer.java", "diffHunk": "@@ -88,24 +90,35 @@ public OrcOutputBuffer(CompressionKind compression, int maxBufferSize)\n \n         compressedOutputStream = new ChunkedSliceOutput(MINIMUM_OUTPUT_BUFFER_CHUNK_SIZE, MAXIMUM_OUTPUT_BUFFER_CHUNK_SIZE);\n \n+        Compressor compressor;\n         if (compression == CompressionKind.NONE) {\n-            this.compressor = null;\n+            compressor = null;\n         }\n         else if (compression == CompressionKind.SNAPPY) {\n-            this.compressor = new SnappyCompressor();\n+            compressor = new SnappyCompressor();\n         }\n         else if (compression == CompressionKind.ZLIB) {\n-            this.compressor = new DeflateCompressor();\n+            compressor = new DeflateCompressor();\n         }\n         else if (compression == CompressionKind.LZ4) {\n-            this.compressor = new Lz4Compressor();\n+            compressor = new Lz4Compressor();\n         }\n         else if (compression == CompressionKind.ZSTD) {\n-            this.compressor = new ZstdJniCompressor();\n+            compressor = new ZstdJniCompressor();\n         }\n         else {\n             throw new IllegalArgumentException(\"Unsupported compression \" + compression);\n         }\n+\n+        if (dwrfEncryptor.isPresent()) {\n+            if (compressor == null) {\n+                throw new UnsupportedOperationException(\"DWRF encryption not supported without compression\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a472e8c5b32b66358892386f3d0f4776f1d992e1"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkzNzIzMg==", "bodyText": "Is it because it is not used in DWRF?", "url": "https://github.com/prestodb/presto/pull/14621#discussion_r445937232", "createdAt": "2020-06-26T02:33:58Z", "author": {"login": "arhimondr"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/stream/DecimalOutputStream.java", "diffHunk": "@@ -45,7 +46,7 @@\n \n     public DecimalOutputStream(CompressionKind compression, int bufferSize)\n     {\n-        this.buffer = new OrcOutputBuffer(compression, bufferSize);\n+        this.buffer = new OrcOutputBuffer(compression, Optional.empty(), bufferSize);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a472e8c5b32b66358892386f3d0f4776f1d992e1"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3OTc5NDcx", "url": "https://github.com/prestodb/presto/pull/14621#pullrequestreview-437979471", "createdAt": "2020-06-26T02:40:41Z", "commit": {"oid": "731a5169142c8d52ed1a0fe2ff90bbfb134c798f"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3OTc5NTk1", "url": "https://github.com/prestodb/presto/pull/14621#pullrequestreview-437979595", "createdAt": "2020-06-26T02:41:11Z", "commit": {"oid": "731a5169142c8d52ed1a0fe2ff90bbfb134c798f"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3OTgwMDE3", "url": "https://github.com/prestodb/presto/pull/14621#pullrequestreview-437980017", "createdAt": "2020-06-26T02:42:40Z", "commit": {"oid": "731a5169142c8d52ed1a0fe2ff90bbfb134c798f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwMjo0Mjo0MFrOGpR-Gg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwMjo0Mjo0MFrOGpR-Gg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkzOTIyNg==", "bodyText": "nit: why this formatting?", "url": "https://github.com/prestodb/presto/pull/14621#discussion_r445939226", "createdAt": "2020-06-26T02:42:40Z", "author": {"login": "arhimondr"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HivePageSourceProvider.java", "diffHunk": "@@ -547,10 +554,10 @@ public int getIndex()\n         }\n \n         /**\n-         * @param columns columns that need to be returned to engine\n-         * @param requiredInterimColumns columns that are needed for processing, but shouldn't be returned to engine (may overlaps with columns)\n+         * @param columns                   columns that need to be returned to engine", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "731a5169142c8d52ed1a0fe2ff90bbfb134c798f"}, "originalPosition": 74}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3OTgxNDM0", "url": "https://github.com/prestodb/presto/pull/14621#pullrequestreview-437981434", "createdAt": "2020-06-26T02:48:24Z", "commit": {"oid": "731a5169142c8d52ed1a0fe2ff90bbfb134c798f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "731a5169142c8d52ed1a0fe2ff90bbfb134c798f", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/731a5169142c8d52ed1a0fe2ff90bbfb134c798f", "committedDate": "2020-06-25T20:08:28Z", "message": "Pass encryption info from hive to ORC reader/writer"}, "afterCommit": {"oid": "eb1be613c96b5ed6d1f7547a4084f768f6960a4b", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/eb1be613c96b5ed6d1f7547a4084f768f6960a4b", "committedDate": "2020-06-26T14:00:58Z", "message": "Pass encryption info from hive to ORC reader/writer"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eb1be613c96b5ed6d1f7547a4084f768f6960a4b", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/eb1be613c96b5ed6d1f7547a4084f768f6960a4b", "committedDate": "2020-06-26T14:00:58Z", "message": "Pass encryption info from hive to ORC reader/writer"}, "afterCommit": {"oid": "687f156bb2fcdfe0b2a4a12f6e674db235ff7693", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/687f156bb2fcdfe0b2a4a12f6e674db235ff7693", "committedDate": "2020-06-26T14:10:27Z", "message": "Pass encryption info from hive to ORC reader/writer"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "687f156bb2fcdfe0b2a4a12f6e674db235ff7693", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/687f156bb2fcdfe0b2a4a12f6e674db235ff7693", "committedDate": "2020-06-26T14:10:27Z", "message": "Pass encryption info from hive to ORC reader/writer"}, "afterCommit": {"oid": "53264ecfe7b3e77451632157f9681ed45138ce9b", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/53264ecfe7b3e77451632157f9681ed45138ce9b", "committedDate": "2020-06-26T14:39:07Z", "message": "Pass encryption info from hive to ORC reader/writer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "895911568772d7c7dbfc4e8e7fc6812a5c2846d6", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/895911568772d7c7dbfc4e8e7fc6812a5c2846d6", "committedDate": "2020-06-26T15:08:47Z", "message": "Fix copywrite for TestByteArrayUtils"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "920cd72e1ec048d3f0bddf5f2c0eba79bd8d56ca", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/920cd72e1ec048d3f0bddf5f2c0eba79bd8d56ca", "committedDate": "2020-06-26T15:08:47Z", "message": "Remove unused field"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "776f602f70722b47a3334f38f21183adffc5904f", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/776f602f70722b47a3334f38f21183adffc5904f", "committedDate": "2020-06-26T15:08:47Z", "message": "Add metadata support for encrypted DWRF files"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fde760a216f82a190b8ffbbae45c7eaf47d721f8", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/fde760a216f82a190b8ffbbae45c7eaf47d721f8", "committedDate": "2020-06-26T15:08:47Z", "message": "Make columnEncodings into a map\n\nWhen dwrf encryption support is added, we can't rely on list position\nof the encoding to be the same as the column index because encodings\nfor encrypted columns will be stored separately in the StripeEncryptionGroups,\nand the reader may not even have access to them if the user doesn't have\nthe key for those groups. Instead we explicitly map the column index to the\ncorrect encoding."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ffd09e72a8a1516c813f0111287a7ea938313f20", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/ffd09e72a8a1516c813f0111287a7ea938313f20", "committedDate": "2020-06-26T15:08:48Z", "message": "Move creation of includedOrcColumns to RecordReader\n\nThis will allow us to check in the recordReader whether the user has\nkeys for all the columns they are trying to access"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2099b947382e885ca8cbbeb8b250dc5f7fef77f3", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/2099b947382e885ca8cbbeb8b250dc5f7fef77f3", "committedDate": "2020-06-26T15:08:48Z", "message": "Add DWRF encryption support to ORC reader"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "977540448ecdae3964d7e2ddba02a6f9e9f4dc8e", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/977540448ecdae3964d7e2ddba02a6f9e9f4dc8e", "committedDate": "2020-06-26T15:08:48Z", "message": "Add encryption support to ORC ColumnWriters"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "047c451d4b7b981d5849ebd036804b7c0e54d826", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/047c451d4b7b981d5849ebd036804b7c0e54d826", "committedDate": "2020-06-26T15:08:48Z", "message": "Add DWRF encryption support to ORC writer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7309c39a9c23729c2c0477f80072db982bcfa0a5", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/7309c39a9c23729c2c0477f80072db982bcfa0a5", "committedDate": "2020-06-26T15:08:48Z", "message": "Add more testing for encryption/decryption"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7dcc349435becb5d3f5c093b978d71687a77a43c", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/7dcc349435becb5d3f5c093b978d71687a77a43c", "committedDate": "2020-06-26T15:08:49Z", "message": "Pass encryption info from hive to ORC reader/writer"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "53264ecfe7b3e77451632157f9681ed45138ce9b", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/53264ecfe7b3e77451632157f9681ed45138ce9b", "committedDate": "2020-06-26T14:39:07Z", "message": "Pass encryption info from hive to ORC reader/writer"}, "afterCommit": {"oid": "7dcc349435becb5d3f5c093b978d71687a77a43c", "author": {"user": {"login": "rschlussel", "name": "Rebecca Schlussel"}}, "url": "https://github.com/prestodb/presto/commit/7dcc349435becb5d3f5c093b978d71687a77a43c", "committedDate": "2020-06-26T15:08:49Z", "message": "Pass encryption info from hive to ORC reader/writer"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1312, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}