{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI5ODk4MjEz", "number": 15485, "title": "Disallow ORDER BY literal in window functions", "bodyText": "Disallow ORDER BY literal in Window functions as this is currently treated differently for int literals compared to ORDER BY in SELECT where it's treated it as an ordinal.\nTest plan - (Please fill in how you tested your changes)\nTest included.\n== RELEASE NOTES ==\n\nGeneral Changes\n* Disallow ORDER BY literals used with Window functions as it's not useful, expensive and most often used wrongly.", "createdAt": "2020-12-01T00:46:03Z", "url": "https://github.com/prestodb/presto/pull/15485", "merged": true, "mergeCommit": {"oid": "effd0ea39af14f737b6b09d96df5f19d8fe66ddc"}, "closed": true, "closedAt": "2020-12-30T21:56:05Z", "author": {"login": "kaikalur"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdiUrJCgFqTU0MzIxNTkyMQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdrVTwjABqjQxNTgyNzkzMTU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMjE1OTIx", "url": "https://github.com/prestodb/presto/pull/15485#pullrequestreview-543215921", "createdAt": "2020-12-02T20:35:53Z", "commit": {"oid": "083900eac0b4cdb28b118dde6ad1fc5f0f2e9af0"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "083900eac0b4cdb28b118dde6ad1fc5f0f2e9af0", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/083900eac0b4cdb28b118dde6ad1fc5f0f2e9af0", "committedDate": "2020-12-01T00:42:01Z", "message": "Disallow ORDER BY literal (ordinal) in window functions as this may be a misunderstood feature."}, "afterCommit": {"oid": "970f365ab5be1b0afc43a16412eabc5ff4743c6b", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/970f365ab5be1b0afc43a16412eabc5ff4743c6b", "committedDate": "2020-12-29T21:26:30Z", "message": "Disallow ORDER BY literal (ordinal) in window functions as this may be a misunderstood feature."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "970f365ab5be1b0afc43a16412eabc5ff4743c6b", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/970f365ab5be1b0afc43a16412eabc5ff4743c6b", "committedDate": "2020-12-29T21:26:30Z", "message": "Disallow ORDER BY literal (ordinal) in window functions as this may be a misunderstood feature."}, "afterCommit": {"oid": "2e5b7f1b9f4b90c596bbf19978f0dc6f5577cb58", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/2e5b7f1b9f4b90c596bbf19978f0dc6f5577cb58", "committedDate": "2020-12-29T22:00:13Z", "message": "Disallow ORDER BY literal (ordinal) in window functions as this may be a misunderstood feature."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5NzIzMTUz", "url": "https://github.com/prestodb/presto/pull/15485#pullrequestreview-559723153", "createdAt": "2020-12-29T22:14:12Z", "commit": {"oid": "2e5b7f1b9f4b90c596bbf19978f0dc6f5577cb58"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQyMjoxNDoxMlrOIMZdBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQyMjoxNDoxMlrOIMZdBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTg3MDg1Mg==", "bodyText": "Do you want to call it ordinals or literals? Just pick one! :P", "url": "https://github.com/prestodb/presto/pull/15485#discussion_r549870852", "createdAt": "2020-12-29T22:14:12Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/SystemSessionProperties.java", "diffHunk": "@@ -171,6 +171,7 @@\n     public static final String REMOTE_FUNCTIONS_ENABLED = \"remote_functions_enabled\";\n     public static final String CHECK_ACCESS_CONTROL_ON_UTILIZED_COLUMNS_ONLY = \"check_access_control_on_utilized_columns_only\";\n     public static final String SKIP_REDUNDANT_SORT = \"skip_redundant_sort\";\n+    public static final String ALLOW_WINDOW_ORDER_BY_ORDINALS = \"allow_window_order_by_ordinals\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e5b7f1b9f4b90c596bbf19978f0dc6f5577cb58"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2e5b7f1b9f4b90c596bbf19978f0dc6f5577cb58", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/2e5b7f1b9f4b90c596bbf19978f0dc6f5577cb58", "committedDate": "2020-12-29T22:00:13Z", "message": "Disallow ORDER BY literal (ordinal) in window functions as this may be a misunderstood feature."}, "afterCommit": {"oid": "9a5c7910a06e270b8561e198eef16be6ed1a3951", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/9a5c7910a06e270b8561e198eef16be6ed1a3951", "committedDate": "2020-12-29T22:19:41Z", "message": "Disallow ORDER BY literal (ordinal) in window functions as this may be a misunderstood feature."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9a5c7910a06e270b8561e198eef16be6ed1a3951", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/9a5c7910a06e270b8561e198eef16be6ed1a3951", "committedDate": "2020-12-29T22:19:41Z", "message": "Disallow ORDER BY literal (ordinal) in window functions as this may be a misunderstood feature."}, "afterCommit": {"oid": "11d2e53bfb3ccd0077e77bcf53d602e3072d971b", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/11d2e53bfb3ccd0077e77bcf53d602e3072d971b", "committedDate": "2020-12-29T22:39:36Z", "message": "Disallow ORDER BY literal (ordinal) in window functions as this may be a misunderstood feature."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5Nzc0MDAy", "url": "https://github.com/prestodb/presto/pull/15485#pullrequestreview-559774002", "createdAt": "2020-12-30T04:09:59Z", "commit": {"oid": "11d2e53bfb3ccd0077e77bcf53d602e3072d971b"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMFQwNDoxMDowMFrOIMdAUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMFQwNDoxNToxM1rOIMdDMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTkyOTA0Mg==", "bodyText": "We normally use toImmutableList() rather than Collectors.toList()\nWe normally format this as\norderBy.getSortItems().stream()\n        .filter(...)\n        .collect(toImmutableList())\n\nYou can use\nList<SortItem> constSortItems = window.getOrderBy()\n        .ifPresent(orderBy -> orderBy.getSortItems()....)\n        .orElse(ImmutableList.of());", "url": "https://github.com/prestodb/presto/pull/15485#discussion_r549929042", "createdAt": "2020-12-30T04:10:00Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/analyzer/StatementAnalyzer.java", "diffHunk": "@@ -1535,6 +1538,34 @@ private void analyzeWindowFunctions(QuerySpecification node, List<Expression> ou\n \n                 Window window = windowFunction.getWindow().get();\n \n+                ImmutableList.Builder<SortItem> orderbyConst = ImmutableList.builder();\n+                window.getOrderBy().ifPresent(\n+                        orderBy -> orderbyConst.addAll(\n+                                orderBy.getSortItems()\n+                                .stream()\n+                                .filter(item -> item.getSortKey() instanceof Literal).collect(Collectors.toList())));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11d2e53bfb3ccd0077e77bcf53d602e3072d971b"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTkyOTY4OA==", "bodyText": "instead of?", "url": "https://github.com/prestodb/presto/pull/15485#discussion_r549929688", "createdAt": "2020-12-30T04:14:43Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/analyzer/StatementAnalyzer.java", "diffHunk": "@@ -1535,6 +1538,34 @@ private void analyzeWindowFunctions(QuerySpecification node, List<Expression> ou\n \n                 Window window = windowFunction.getWindow().get();\n \n+                ImmutableList.Builder<SortItem> orderbyConst = ImmutableList.builder();\n+                window.getOrderBy().ifPresent(\n+                        orderBy -> orderbyConst.addAll(\n+                                orderBy.getSortItems()\n+                                .stream()\n+                                .filter(item -> item.getSortKey() instanceof Literal).collect(Collectors.toList())));\n+\n+                List<SortItem> constSortItems = orderbyConst.build();\n+                if (!constSortItems.isEmpty()) {\n+                    if (isAllowWindowOrderByLiterals(session)) {\n+                        warningCollector.add(\n+                                new PrestoWarning(\n+                                        PERFORMANCE_WARNING,\n+                                        String.format(\n+                                                \"ORDER BY literals/constants with window function: '%s' is unnecessary and expensive. If you intend to ORDER BY using ordinals, please use the actual expression instead: '%s'\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11d2e53bfb3ccd0077e77bcf53d602e3072d971b"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTkyOTc3Nw==", "bodyText": "I think the description is not accurate.", "url": "https://github.com/prestodb/presto/pull/15485#discussion_r549929777", "createdAt": "2020-12-30T04:15:13Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/SystemSessionProperties.java", "diffHunk": "@@ -890,6 +891,11 @@ public SystemSessionProperties(\n                         CHECK_ACCESS_CONTROL_ON_UTILIZED_COLUMNS_ONLY,\n                         \"Apply access control rules on only those columns that are required to produce the query output\",\n                         featuresConfig.isCheckAccessControlOnUtilizedColumnsOnly(),\n+                        false),\n+                booleanProperty(\n+                        ALLOW_WINDOW_ORDER_BY_LITERALS,\n+                        \"Skip redundant sort operations\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11d2e53bfb3ccd0077e77bcf53d602e3072d971b"}, "originalPosition": 15}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "11d2e53bfb3ccd0077e77bcf53d602e3072d971b", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/11d2e53bfb3ccd0077e77bcf53d602e3072d971b", "committedDate": "2020-12-29T22:39:36Z", "message": "Disallow ORDER BY literal (ordinal) in window functions as this may be a misunderstood feature."}, "afterCommit": {"oid": "aa5719a36d4399671968b506b9f754969b6b272a", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/aa5719a36d4399671968b506b9f754969b6b272a", "committedDate": "2020-12-30T05:44:26Z", "message": "Disallow ORDER BY literal (ordinal) in window functions as this may be a misunderstood feature."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "aa5719a36d4399671968b506b9f754969b6b272a", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/aa5719a36d4399671968b506b9f754969b6b272a", "committedDate": "2020-12-30T05:44:26Z", "message": "Disallow ORDER BY literal (ordinal) in window functions as this may be a misunderstood feature."}, "afterCommit": {"oid": "2df8636e75e662a8e88e43644f0a39a282ab4ad9", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/2df8636e75e662a8e88e43644f0a39a282ab4ad9", "committedDate": "2020-12-30T05:46:11Z", "message": "Disallow ORDER BY literal (ordinal) in window functions as this may be a misunderstood feature."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2df8636e75e662a8e88e43644f0a39a282ab4ad9", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/2df8636e75e662a8e88e43644f0a39a282ab4ad9", "committedDate": "2020-12-30T05:46:11Z", "message": "Disallow ORDER BY literal (ordinal) in window functions as this may be a misunderstood feature."}, "afterCommit": {"oid": "a5a5b7ab9fe3c64a9be26d3d435a03aa74a40764", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/a5a5b7ab9fe3c64a9be26d3d435a03aa74a40764", "committedDate": "2020-12-30T05:48:29Z", "message": "Disallow ORDER BY literal (ordinal) in window functions as this may be a misunderstood feature."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a5a5b7ab9fe3c64a9be26d3d435a03aa74a40764", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/a5a5b7ab9fe3c64a9be26d3d435a03aa74a40764", "committedDate": "2020-12-30T05:48:29Z", "message": "Disallow ORDER BY literal (ordinal) in window functions as this may be a misunderstood feature."}, "afterCommit": {"oid": "1972f2fcb8074f9416a7c5767f9fd3b5e1134194", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/1972f2fcb8074f9416a7c5767f9fd3b5e1134194", "committedDate": "2020-12-30T06:05:25Z", "message": "Disallow ORDER BY literal (ordinal) in window functions as this may be a misunderstood feature."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1972f2fcb8074f9416a7c5767f9fd3b5e1134194", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/1972f2fcb8074f9416a7c5767f9fd3b5e1134194", "committedDate": "2020-12-30T06:05:25Z", "message": "Disallow ORDER BY literal (ordinal) in window functions as this may be a misunderstood feature."}, "afterCommit": {"oid": "9ed1981e5e86204e6c31d7de827f1e5cc5db583c", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/9ed1981e5e86204e6c31d7de827f1e5cc5db583c", "committedDate": "2020-12-30T15:39:14Z", "message": "Disallow ORDER BY literal (ordinal) in window functions as this may be a misunderstood feature."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYwMTgwNjIw", "url": "https://github.com/prestodb/presto/pull/15485#pullrequestreview-560180620", "createdAt": "2020-12-30T19:49:36Z", "commit": {"oid": "9ed1981e5e86204e6c31d7de827f1e5cc5db583c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f7d7ae2b73c2afb2a94b57767a2d486b3275a44", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/4f7d7ae2b73c2afb2a94b57767a2d486b3275a44", "committedDate": "2020-12-30T20:25:20Z", "message": "Disallow ORDER BY literal (ordinal) in window functions as this may be a misunderstood feature."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9ed1981e5e86204e6c31d7de827f1e5cc5db583c", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/9ed1981e5e86204e6c31d7de827f1e5cc5db583c", "committedDate": "2020-12-30T15:39:14Z", "message": "Disallow ORDER BY literal (ordinal) in window functions as this may be a misunderstood feature."}, "afterCommit": {"oid": "4f7d7ae2b73c2afb2a94b57767a2d486b3275a44", "author": {"user": {"login": "kaikalur", "name": "Sreeni Viswanadha"}}, "url": "https://github.com/prestodb/presto/commit/4f7d7ae2b73c2afb2a94b57767a2d486b3275a44", "committedDate": "2020-12-30T20:25:20Z", "message": "Disallow ORDER BY literal (ordinal) in window functions as this may be a misunderstood feature."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4773, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}