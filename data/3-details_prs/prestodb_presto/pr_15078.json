{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcyOTk0MDk2", "number": 15078, "title": "Add memory tracking for OrcRecordReader", "bodyText": "== RELEASE NOTES ==\n\nHive Changes\n* Added memory tracking for OrcRecordReader", "createdAt": "2020-08-25T07:11:47Z", "url": "https://github.com/prestodb/presto/pull/15078", "merged": true, "mergeCommit": {"oid": "3d4931b1d753235aa9e6f8e8ad95bafca5a53247"}, "closed": true, "closedAt": "2020-09-02T15:56:38Z", "author": {"login": "yingsu00"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdCmiuGABqjM2OTMzNTQwNDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdE21gdgBqjM3MTgyNzM2MjQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7f34cfd3f2ada74ffe0124ce758b14067d9d2361", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/7f34cfd3f2ada74ffe0124ce758b14067d9d2361", "committedDate": "2020-08-25T06:37:23Z", "message": "Add memory tracking for OrcRecordReader"}, "afterCommit": {"oid": "85e5a7355c5088a983821eab058a9000bc81ed96", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/85e5a7355c5088a983821eab058a9000bc81ed96", "committedDate": "2020-08-26T07:16:30Z", "message": "Add memory tracking for OrcSelectiveRecordReader"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "85e5a7355c5088a983821eab058a9000bc81ed96", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/85e5a7355c5088a983821eab058a9000bc81ed96", "committedDate": "2020-08-26T07:16:30Z", "message": "Add memory tracking for OrcSelectiveRecordReader"}, "afterCommit": {"oid": "84f1d148af594b0d41f31363ab64ef45f3ef4f86", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/84f1d148af594b0d41f31363ab64ef45f3ef4f86", "committedDate": "2020-08-26T08:06:43Z", "message": "Fix memory tracking for some SelectiveStreamReader's"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3OTkwODg3", "url": "https://github.com/prestodb/presto/pull/15078#pullrequestreview-477990887", "createdAt": "2020-08-28T19:56:24Z", "commit": {"oid": "84f1d148af594b0d41f31363ab64ef45f3ef4f86"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQxOTo1NjoyNFrOHJSzJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQxOTo1NjoyNFrOHJSzJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTUwNzIzOQ==", "bodyText": "I noticed we were missing accounting for these fields as well. However @bhhari thought that we may be double counting here. Am I missing something here?", "url": "https://github.com/prestodb/presto/pull/15078#discussion_r479507239", "createdAt": "2020-08-28T19:56:24Z", "author": {"login": "sachdevs"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/reader/SliceDictionarySelectiveReader.java", "diffHunk": "@@ -622,7 +622,16 @@ public void close()\n     @Override\n     public long getRetainedSizeInBytes()\n     {\n-        return INSTANCE_SIZE + sizeOf(currentDictionaryData) + sizeOf(values) + sizeOf(outputPositions);\n+        return INSTANCE_SIZE +\n+                sizeOf(values) +\n+                sizeOf(outputPositions) +\n+                sizeOf(currentDictionaryData) +\n+                sizeOf(stripeDictionaryData) +\n+                sizeOf(stripeDictionaryOffsetVector) +\n+                sizeOf(stripeDictionaryData) +\n+                sizeOf(stripeDictionaryLength) +\n+                sizeOf(rowGroupDictionaryLength) +\n+                sizeOf(evaluationStatus);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84f1d148af594b0d41f31363ab64ef45f3ef4f86"}, "originalPosition": 14}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "84f1d148af594b0d41f31363ab64ef45f3ef4f86", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/84f1d148af594b0d41f31363ab64ef45f3ef4f86", "committedDate": "2020-08-26T08:06:43Z", "message": "Fix memory tracking for some SelectiveStreamReader's"}, "afterCommit": {"oid": "4510688fa367cf85c97665218df49df59eb07851", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/4510688fa367cf85c97665218df49df59eb07851", "committedDate": "2020-08-31T08:42:45Z", "message": "Fix memory tracking for some SelectiveStreamReader's"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwMTY2MDE3", "url": "https://github.com/prestodb/presto/pull/15078#pullrequestreview-480166017", "createdAt": "2020-09-01T22:41:25Z", "commit": {"oid": "4510688fa367cf85c97665218df49df59eb07851"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMjo0MToyNVrOHLKtbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMjo0MToyNVrOHLKtbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ3MTg1NQ==", "bodyText": "should this be currentDictionary?", "url": "https://github.com/prestodb/presto/pull/15078#discussion_r481471855", "createdAt": "2020-09-01T22:41:25Z", "author": {"login": "bhhari"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/reader/SliceDictionarySelectiveReader.java", "diffHunk": "@@ -622,7 +622,15 @@ public void close()\n     @Override\n     public long getRetainedSizeInBytes()\n     {\n-        return INSTANCE_SIZE + sizeOf(currentDictionaryData) + sizeOf(values) + sizeOf(outputPositions);\n+        return INSTANCE_SIZE +\n+                sizeOf(values) +\n+                sizeOf(outputPositions) +\n+                sizeOf(stripeDictionaryData) +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4510688fa367cf85c97665218df49df59eb07851"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwMTY3MDc2", "url": "https://github.com/prestodb/presto/pull/15078#pullrequestreview-480167076", "createdAt": "2020-09-01T22:44:01Z", "commit": {"oid": "4510688fa367cf85c97665218df49df59eb07851"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMjo0NDowMlrOHLKw0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMjo0NDowMlrOHLKw0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ3MjcyMg==", "bodyText": "this memory is quite negligible, do you think we will need to report memory from these? I don't see the same for OrcBatchRecordReader", "url": "https://github.com/prestodb/presto/pull/15078#discussion_r481472722", "createdAt": "2020-09-01T22:44:02Z", "author": {"login": "bhhari"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/OrcSelectiveRecordReader.java", "diffHunk": "@@ -729,6 +735,21 @@ else if (!hasAnyFilter(columnIndex)) {\n         return page;\n     }\n \n+    private long getSelfRetainedSizeInBytes()\n+    {\n+        return INSTANCE_SIZE +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4510688fa367cf85c97665218df49df59eb07851"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwMTY2NTgy", "url": "https://github.com/prestodb/presto/pull/15078#pullrequestreview-480166582", "createdAt": "2020-09-01T22:42:43Z", "commit": {"oid": "4510688fa367cf85c97665218df49df59eb07851"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMjo0Mjo0M1rOHLKvQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMjo0Mjo0M1rOHLKvQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ3MjMyMw==", "bodyText": "we add INSTANCE_SIZE here as well as on L740 - is that intentional?", "url": "https://github.com/prestodb/presto/pull/15078#discussion_r481472323", "createdAt": "2020-09-01T22:42:43Z", "author": {"login": "sujay-jain"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/OrcSelectiveRecordReader.java", "diffHunk": "@@ -679,6 +683,8 @@ public Page getNextPage()\n             }\n         }\n \n+        systemMemoryUsage.newOrcLocalMemoryContext(OrcSelectiveRecordReader.class.getSimpleName()).setBytes(INSTANCE_SIZE + getSelfRetainedSizeInBytes());\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4510688fa367cf85c97665218df49df59eb07851"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwMTcxNjQx", "url": "https://github.com/prestodb/presto/pull/15078#pullrequestreview-480171641", "createdAt": "2020-09-01T22:56:12Z", "commit": {"oid": "4510688fa367cf85c97665218df49df59eb07851"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwMTc0MDk1", "url": "https://github.com/prestodb/presto/pull/15078#pullrequestreview-480174095", "createdAt": "2020-09-01T23:02:55Z", "commit": {"oid": "4510688fa367cf85c97665218df49df59eb07851"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4510688fa367cf85c97665218df49df59eb07851", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/4510688fa367cf85c97665218df49df59eb07851", "committedDate": "2020-08-31T08:42:45Z", "message": "Fix memory tracking for some SelectiveStreamReader's"}, "afterCommit": {"oid": "b7c346084f5c605fb6ea3cde754b656409d456b8", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/b7c346084f5c605fb6ea3cde754b656409d456b8", "committedDate": "2020-09-01T23:56:46Z", "message": "Fix memory tracking for some SelectiveStreamReader's"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwMTk3NzU4", "url": "https://github.com/prestodb/presto/pull/15078#pullrequestreview-480197758", "createdAt": "2020-09-02T00:11:18Z", "commit": {"oid": "b7c346084f5c605fb6ea3cde754b656409d456b8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwMjA0NDg0", "url": "https://github.com/prestodb/presto/pull/15078#pullrequestreview-480204484", "createdAt": "2020-09-02T00:27:10Z", "commit": {"oid": "b7c346084f5c605fb6ea3cde754b656409d456b8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwMDoyNzoxMFrOHLMtRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwMDoyNzoxMFrOHLMtRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTUwNDU4Mw==", "bodyText": "should be AbstractLongSelectiveStreamReader?", "url": "https://github.com/prestodb/presto/pull/15078#discussion_r481504583", "createdAt": "2020-09-02T00:27:10Z", "author": {"login": "bhhari"}, "path": "presto-orc/src/main/java/com/facebook/presto/orc/reader/AbstractLongSelectiveStreamReader.java", "diffHunk": "@@ -31,12 +32,15 @@\n import static com.facebook.presto.common.type.SmallintType.SMALLINT;\n import static com.facebook.presto.orc.array.Arrays.ensureCapacity;\n import static com.google.common.base.Preconditions.checkState;\n+import static io.airlift.slice.SizeOf.sizeOf;\n import static java.lang.Math.toIntExact;\n import static java.util.Objects.requireNonNull;\n \n abstract class AbstractLongSelectiveStreamReader\n         implements SelectiveStreamReader\n {\n+    private static final int INSTANCE_SIZE = ClassLayout.parseClass(LongDictionarySelectiveStreamReader.class).instanceSize();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7c346084f5c605fb6ea3cde754b656409d456b8"}, "originalPosition": 19}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b7c346084f5c605fb6ea3cde754b656409d456b8", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/b7c346084f5c605fb6ea3cde754b656409d456b8", "committedDate": "2020-09-01T23:56:46Z", "message": "Fix memory tracking for some SelectiveStreamReader's"}, "afterCommit": {"oid": "9d5249b6ae5476e800b2b073b50d746aac2f0083", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/9d5249b6ae5476e800b2b073b50d746aac2f0083", "committedDate": "2020-09-02T02:20:16Z", "message": "Fix memory tracking for some SelectiveStreamReader's"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwNDI0MDYz", "url": "https://github.com/prestodb/presto/pull/15078#pullrequestreview-480424063", "createdAt": "2020-09-02T03:02:10Z", "commit": {"oid": "9d5249b6ae5476e800b2b073b50d746aac2f0083"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01c83ee9845c85bcaeddf954a352a67f4e12f47e", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/01c83ee9845c85bcaeddf954a352a67f4e12f47e", "committedDate": "2020-09-02T07:21:45Z", "message": "Add memory tracking for OrcSelectiveRecordReader"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "717cc71e8e33584f89a19f73d15969970c60f49c", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/717cc71e8e33584f89a19f73d15969970c60f49c", "committedDate": "2020-09-02T07:21:45Z", "message": "Fix memory tracking for some SelectiveStreamReader's"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5addab10d4203cfbf656b66699afd81a32832ef8", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/5addab10d4203cfbf656b66699afd81a32832ef8", "committedDate": "2020-09-02T07:21:45Z", "message": "Add testMemoryTracking in TestSelectiveOrcReader"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9d5249b6ae5476e800b2b073b50d746aac2f0083", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/9d5249b6ae5476e800b2b073b50d746aac2f0083", "committedDate": "2020-09-02T02:20:16Z", "message": "Fix memory tracking for some SelectiveStreamReader's"}, "afterCommit": {"oid": "5addab10d4203cfbf656b66699afd81a32832ef8", "author": {"user": null}, "url": "https://github.com/prestodb/presto/commit/5addab10d4203cfbf656b66699afd81a32832ef8", "committedDate": "2020-09-02T07:21:45Z", "message": "Add testMemoryTracking in TestSelectiveOrcReader"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}