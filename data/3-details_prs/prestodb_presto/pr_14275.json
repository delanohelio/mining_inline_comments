{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxOTc2NDQ2", "number": 14275, "title": "Upgrade presto pinot connector to be compatible with new Broker routing and time boundary APIs in Pinot 0.3.0 release", "bodyText": "Recently Pinot upgraded the Broker side routing table API and changed the behavior of timeBoundary query API. This PR aims to be compatible with new changes.\n== RELEASE NOTES ==\n\nPinot Changes\n* Adding support for new Pinot Routing Table APIs.", "createdAt": "2020-03-22T09:17:10Z", "url": "https://github.com/prestodb/presto/pull/14275", "merged": true, "mergeCommit": {"oid": "3f03c2c31986da23ec2b91772da2d6dc961c5246"}, "closed": true, "closedAt": "2020-04-01T07:19:18Z", "author": {"login": "xiangfu0"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcQOh8YgBqjMxNTI5NzI5Mjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTSYcZABqjMxODY1MjM2ODk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4b2c60f465164275ed68d88c73d167e393806b21", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/4b2c60f465164275ed68d88c73d167e393806b21", "committedDate": "2020-03-22T09:13:51Z", "message": "Upgrade presto pinot connector to be compatible with new Broker routing and time boundary APIs in Pinot 0.3.0 release"}, "afterCommit": {"oid": "2bfa3ee695ede5d48aa4cd7722816044f031768c", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/2bfa3ee695ede5d48aa4cd7722816044f031768c", "committedDate": "2020-03-22T19:04:26Z", "message": "Upgrade presto pinot connector to be compatible with new Broker routing and time boundary APIs in Pinot 0.3.0 release"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2bfa3ee695ede5d48aa4cd7722816044f031768c", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/2bfa3ee695ede5d48aa4cd7722816044f031768c", "committedDate": "2020-03-22T19:04:26Z", "message": "Upgrade presto pinot connector to be compatible with new Broker routing and time boundary APIs in Pinot 0.3.0 release"}, "afterCommit": {"oid": "1bb81ff57394de4f936ed5c3ac4e5dd297090a4a", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/1bb81ff57394de4f936ed5c3ac4e5dd297090a4a", "committedDate": "2020-03-22T19:33:51Z", "message": "Upgrade presto pinot connector to be compatible with new Broker routing and time boundary APIs in Pinot 0.3.0 release"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1bb81ff57394de4f936ed5c3ac4e5dd297090a4a", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/1bb81ff57394de4f936ed5c3ac4e5dd297090a4a", "committedDate": "2020-03-22T19:33:51Z", "message": "Upgrade presto pinot connector to be compatible with new Broker routing and time boundary APIs in Pinot 0.3.0 release"}, "afterCommit": {"oid": "36df2a9d2e6c58adfbe19081a77749c4f0568dd3", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/36df2a9d2e6c58adfbe19081a77749c4f0568dd3", "committedDate": "2020-03-22T20:52:13Z", "message": "Upgrade presto pinot connector to be compatible with new Pinot Broker routingTable and time boundary APIs in Pinot 0.3.0 release"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "36df2a9d2e6c58adfbe19081a77749c4f0568dd3", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/36df2a9d2e6c58adfbe19081a77749c4f0568dd3", "committedDate": "2020-03-22T20:52:13Z", "message": "Upgrade presto pinot connector to be compatible with new Pinot Broker routingTable and time boundary APIs in Pinot 0.3.0 release"}, "afterCommit": {"oid": "b5d62277a86272edb9b29db82a89f5ce82460950", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/b5d62277a86272edb9b29db82a89f5ce82460950", "committedDate": "2020-03-27T07:13:57Z", "message": "Upgrade presto pinot connector to be compatible with new Pinot Broker routingTable and time boundary APIs in Pinot 0.3.0 release.\n\nChanges for Pinot APIs:\nNew routingTable API returns exact a queryable snapshot of servers to segments mapping, so no extra computation needed.\nNew timeBoundary API returns 404 if no time boundary found, even if table exists. It used to return 200 and an empty Json Object.\n\nThis PR will always try the new API first then fall back to old API if exception raised."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1MTQzMTQ1", "url": "https://github.com/prestodb/presto/pull/14275#pullrequestreview-385143145", "createdAt": "2020-03-31T22:15:14Z", "commit": {"oid": "b5d62277a86272edb9b29db82a89f5ce82460950"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQyMjoxNToxNFrOF-qMtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQyMjoxNzowM1rOF-qPTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI0NzQxMw==", "bodyText": "either put all parameters in one line, or one in each line", "url": "https://github.com/prestodb/presto/pull/14275#discussion_r401247413", "createdAt": "2020-03-31T22:15:14Z", "author": {"login": "zhenxiao"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java", "diffHunk": "@@ -359,10 +395,8 @@ public RoutingTables(@JsonProperty(\"routingTableSnapshot\") List<RoutingTableSnap\n             else {\n                 List<Map<String, List<String>>> routingTableEntriesList = snapshot.getRoutingTableEntries();\n                 if (routingTableEntriesList.isEmpty()) {\n-                    throw new PinotException(\n-                            PINOT_UNEXPECTED_RESPONSE,\n-                            Optional.empty(),\n-                            String.format(\"Empty routingTableEntries for %s. RoutingTable: %s\", tableName, responseBody));\n+                    throw new PinotException(PINOT_UNEXPECTED_RESPONSE, Optional.empty(),\n+                        String.format(\"Empty routingTableEntries for %s. RoutingTable: %s\", tableName, responseBody));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5d62277a86272edb9b29db82a89f5ce82460950"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI0ODA3OQ==", "bodyText": "make \"404\" a constant?\ncheck and guard no array index out of bound exception when accessing [3]? could you please comment error message format", "url": "https://github.com/prestodb/presto/pull/14275#discussion_r401248079", "createdAt": "2020-03-31T22:17:03Z", "author": {"login": "zhenxiao"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java", "diffHunk": "@@ -426,7 +460,21 @@ public TimeBoundary(\n \n     public TimeBoundary getTimeBoundaryForTable(String table)\n     {\n-        String responseBody = sendHttpGetToBroker(table, String.format(TIME_BOUNDARY_API_TEMPLATE, table));\n-        return timeBoundaryJsonCodec.fromJson(responseBody);\n+        try {\n+            String responseBody = sendHttpGetToBroker(table, String.format(TIME_BOUNDARY_API_TEMPLATE, table));\n+            return timeBoundaryJsonCodec.fromJson(responseBody);\n+        }\n+        catch (Exception e) {\n+            if ((e instanceof PinotException)) {\n+                // New Pinot broker will set response code 404 if time boundary is not set.\n+                // This is backward incompatible with old version, as it returns an empty json object.\n+                // In order to gracefully handle this, below check will extract response code and return empty json\n+                // if not found time boundary.\n+                if (e.getMessage().split(\" \")[3].equalsIgnoreCase(\"404\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5d62277a86272edb9b29db82a89f5ce82460950"}, "originalPosition": 103}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "36c470acbd22dfc4b3551641f38e20538d822a96", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/36c470acbd22dfc4b3551641f38e20538d822a96", "committedDate": "2020-04-01T05:50:37Z", "message": "Upgrade presto pinot connector to be compatible with new Pinot Broker routingTable and time boundary APIs in Pinot 0.3.0 release.\n\nChanges for Pinot APIs:\nNew routingTable API returns exact a queryable snapshot of servers to segments mapping, so no extra computation needed.\nNew timeBoundary API returns 404 if no time boundary found, even if table exists. It used to return 200 and an empty Json Object.\n\nThis PR will always try the new API first then fall back to old API if exception raised."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bdaaba30a91c8ff7c8c43b0aa948565300734ff6", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/bdaaba30a91c8ff7c8c43b0aa948565300734ff6", "committedDate": "2020-04-01T05:50:37Z", "message": "Address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1MzE2NDg5", "url": "https://github.com/prestodb/presto/pull/14275#pullrequestreview-385316489", "createdAt": "2020-04-01T07:10:40Z", "commit": {"oid": "9a3eb74b94aae83e9be878c7dc629974bb8dfbd0"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwNzoxMDo0MFrOF-zfeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwNzoxMDo0MFrOF-zfeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM5OTY3Mw==", "bodyText": "s/errMsgSplits/errorMessageSplits/g\nminor thing, Presto usually not use abbreviation in variable name", "url": "https://github.com/prestodb/presto/pull/14275#discussion_r401399673", "createdAt": "2020-04-01T07:10:40Z", "author": {"login": "zhenxiao"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotClusterInfoFetcher.java", "diffHunk": "@@ -426,7 +463,26 @@ public TimeBoundary(\n \n     public TimeBoundary getTimeBoundaryForTable(String table)\n     {\n-        String responseBody = sendHttpGetToBroker(table, String.format(TIME_BOUNDARY_API_TEMPLATE, table));\n-        return timeBoundaryJsonCodec.fromJson(responseBody);\n+        try {\n+            String responseBody = sendHttpGetToBroker(table, String.format(TIME_BOUNDARY_API_TEMPLATE, table));\n+            return timeBoundaryJsonCodec.fromJson(responseBody);\n+        }\n+        catch (Exception e) {\n+            if ((e instanceof PinotException)) {\n+                /** New Pinot broker will set response code 404 if time boundary is not set.\n+                 * This is backward incompatible with old version, as it returns an empty json object.\n+                 * In order to gracefully handle this, below check will extract response code and return empty json\n+                 * if not found time boundary.\n+                 *\n+                 * Sample error message:\n+                 *     Unexpected response status: 404 for request  to url http://127.0.0.1:8000/debug/timeBoundary/baseballStats, with headers ...\n+                 */\n+                String[] errMsgSplits = e.getMessage().split(\" \");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a3eb74b94aae83e9be878c7dc629974bb8dfbd0"}, "originalPosition": 102}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0ba50ada93337b920c8235593e268ca570fb566", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/b0ba50ada93337b920c8235593e268ca570fb566", "committedDate": "2020-04-01T07:15:20Z", "message": "change variable errMsgSplits to errorMessageSplits"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9a3eb74b94aae83e9be878c7dc629974bb8dfbd0", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/9a3eb74b94aae83e9be878c7dc629974bb8dfbd0", "committedDate": "2020-04-01T05:21:11Z", "message": "Address comments"}, "afterCommit": {"oid": "b0ba50ada93337b920c8235593e268ca570fb566", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/b0ba50ada93337b920c8235593e268ca570fb566", "committedDate": "2020-04-01T07:15:20Z", "message": "change variable errMsgSplits to errorMessageSplits"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2080, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}