{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM0MzA2MTkz", "number": 14649, "title": "Adding a config to retry on pinot exceptions", "bodyText": "The purpose of this PR is to allow Presto retry on Pinot side data fetch exceptions, e.g. some servers not responding/timeout/etc.\n== RELEASE NOTES ==\n\nPinot Changes\n* Adding config: `pinot.mark-data-fetch-exceptions-as-retriable` to let presto retry on pinot data fetcher related exceptions.", "createdAt": "2020-06-15T05:54:36Z", "url": "https://github.com/prestodb/presto/pull/14649", "merged": true, "mergeCommit": {"oid": "298de509d09d09bd1ac57ba08643045caeb2a68f"}, "closed": true, "closedAt": "2020-06-19T05:16:48Z", "author": {"login": "xiangfu0"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcradYbgBqjM0NDI3NzkzMDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcsiDpFABqjM0NTkzNjU5NTE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a7138df4fd9020d0a98efd6839d92c0df093058c", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/a7138df4fd9020d0a98efd6839d92c0df093058c", "committedDate": "2020-06-15T05:51:07Z", "message": "Adding a config to retry on pinot exceptions"}, "afterCommit": {"oid": "0f148662e7239a56a26bc064ee8279972a75b7f5", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/0f148662e7239a56a26bc064ee8279972a75b7f5", "committedDate": "2020-06-15T06:14:15Z", "message": "Adding a config to retry on pinot exceptions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0f148662e7239a56a26bc064ee8279972a75b7f5", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/0f148662e7239a56a26bc064ee8279972a75b7f5", "committedDate": "2020-06-15T06:14:15Z", "message": "Adding a config to retry on pinot exceptions"}, "afterCommit": {"oid": "71f4b52479b23210aa8557561995d63fceadda17", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/71f4b52479b23210aa8557561995d63fceadda17", "committedDate": "2020-06-15T07:52:09Z", "message": "Adding a config to retry on pinot exceptions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "71f4b52479b23210aa8557561995d63fceadda17", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/71f4b52479b23210aa8557561995d63fceadda17", "committedDate": "2020-06-15T07:52:09Z", "message": "Adding a config to retry on pinot exceptions"}, "afterCommit": {"oid": "dacf91d9f810357b5b808870d9d9acc93b1eb600", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/dacf91d9f810357b5b808870d9d9acc93b1eb600", "committedDate": "2020-06-15T08:54:46Z", "message": "Adding a config to retry on pinot exceptions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dacf91d9f810357b5b808870d9d9acc93b1eb600", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/dacf91d9f810357b5b808870d9d9acc93b1eb600", "committedDate": "2020-06-15T08:54:46Z", "message": "Adding a config to retry on pinot exceptions"}, "afterCommit": {"oid": "51f977b2f83a3974cffdf1ab9a72ead9453113bb", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/51f977b2f83a3974cffdf1ab9a72ead9453113bb", "committedDate": "2020-06-15T11:04:27Z", "message": "Adding a config to retry on pinot exceptions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxNzQ2Njg3", "url": "https://github.com/prestodb/presto/pull/14649#pullrequestreview-431746687", "createdAt": "2020-06-16T17:44:47Z", "commit": {"oid": "51f977b2f83a3974cffdf1ab9a72ead9453113bb"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNzo0NDo0N1rOGkmYzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNzo1MDo1MVrOGkmnGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAzMDg2MA==", "bodyText": "I believe we don't use the this. for member variables.", "url": "https://github.com/prestodb/presto/pull/14649#discussion_r441030860", "createdAt": "2020-06-16T17:44:47Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotBrokerPageSource.java", "diffHunk": "@@ -315,6 +316,12 @@ public int populateFromPqlResults(\n         if (exceptions != null && exceptions.isArray() && exceptions.size() > 0) {\n             // Pinot is known to return exceptions with benign errorcodes like 200\n             // so we treat any exception as an error\n+            if (this.pinotConfig.isRetryPinotException()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51f977b2f83a3974cffdf1ab9a72ead9453113bb"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAzMzQ3OQ==", "bodyText": "My understanding is that you intend to retry on 'fetch' exceptions in the broker and segment page source codepaths.\nIf so, how about having a special exception for the 'fetch' exceptions. I don't quite like the idea of having a retriable exception, if what you really want to denote is: a fetch exception that is optionally marked as retriable.", "url": "https://github.com/prestodb/presto/pull/14649#discussion_r441033479", "createdAt": "2020-06-16T17:49:07Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotErrorCode.java", "diffHunk": "@@ -34,6 +34,7 @@\n     PINOT_DECODE_ERROR(8, EXTERNAL),\n     PINOT_INVALID_PQL_GENERATED(9, INTERNAL_ERROR),\n     PINOT_INVALID_CONFIGURATION(10, INTERNAL_ERROR),\n+    PINOT_RETRIABLE_EXCEPTION(11, EXTERNAL, true),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51f977b2f83a3974cffdf1ab9a72ead9453113bb"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAzNDE2Nw==", "bodyText": "RetryPinotException conveys to me that the pinot exception would be retried.\nHow about the name: isMarkDataFetchExceptionsAsRetriable ?", "url": "https://github.com/prestodb/presto/pull/14649#discussion_r441034167", "createdAt": "2020-06-16T17:50:14Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotConfig.java", "diffHunk": "@@ -442,4 +443,16 @@ public PinotConfig setInferTimestampTypeInSchema(boolean inferTimestampTypeInSch\n         this.inferTimestampTypeInSchema = inferTimestampTypeInSchema;\n         return this;\n     }\n+\n+    public boolean isRetryPinotException()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51f977b2f83a3974cffdf1ab9a72ead9453113bb"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAzNDUyMQ==", "bodyText": "I think presto does not use the this. notation for instance variables", "url": "https://github.com/prestodb/presto/pull/14649#discussion_r441034521", "createdAt": "2020-06-16T17:50:51Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSource.java", "diffHunk": "@@ -211,7 +218,7 @@ private void fetchPinotData()\n                     .filter(table -> table != null && table.getNumberOfRows() > 0)\n                     .forEach(dataTable ->\n                     {\n-                        checkExceptions(dataTable, split);\n+                        checkExceptions(dataTable, split, this.pinotConfig.isRetryPinotException());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51f977b2f83a3974cffdf1ab9a72ead9453113bb"}, "originalPosition": 35}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7c076f0da127cb0ceb520997e1d724e752d90207", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/7c076f0da127cb0ceb520997e1d724e752d90207", "committedDate": "2020-06-17T07:48:07Z", "message": "Address comments"}, "afterCommit": {"oid": "5a1406d698ee4a2a778ce6f8c0987dff106caa0e", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/5a1406d698ee4a2a778ce6f8c0987dff106caa0e", "committedDate": "2020-06-17T08:02:08Z", "message": "Address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyNTQ2NTEw", "url": "https://github.com/prestodb/presto/pull/14649#pullrequestreview-432546510", "createdAt": "2020-06-17T15:57:07Z", "commit": {"oid": "5a1406d698ee4a2a778ce6f8c0987dff106caa0e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxNTo1NzowN1rOGlMcmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxNTo1NzowN1rOGlMcmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY1NDQyNQ==", "bodyText": "Is it possible to use the config isMarkDataFetchExceptionsAsRetriable here as the third param (retriable or not) ?", "url": "https://github.com/prestodb/presto/pull/14649#discussion_r441654425", "createdAt": "2020-06-17T15:57:07Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotErrorCode.java", "diffHunk": "@@ -34,6 +34,7 @@\n     PINOT_DECODE_ERROR(8, EXTERNAL),\n     PINOT_INVALID_PQL_GENERATED(9, INTERNAL_ERROR),\n     PINOT_INVALID_CONFIGURATION(10, INTERNAL_ERROR),\n+    PINOT_DATA_FETCH_EXCEPTION(11, EXTERNAL, true),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a1406d698ee4a2a778ce6f8c0987dff106caa0e"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyNTQ3NTI2", "url": "https://github.com/prestodb/presto/pull/14649#pullrequestreview-432547526", "createdAt": "2020-06-17T15:58:19Z", "commit": {"oid": "5a1406d698ee4a2a778ce6f8c0987dff106caa0e"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxNTo1ODoxOVrOGlMfpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxNTo1ODozOFrOGlMgZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY1NTIwNw==", "bodyText": "I think we can unconditionally throw PINOT_DATA_FETCH_EXCEPTION here, if it is optionally marked as retriable elsewhere. ie, you can just make that change on line 319/326 below", "url": "https://github.com/prestodb/presto/pull/14649#discussion_r441655207", "createdAt": "2020-06-17T15:58:19Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotBrokerPageSource.java", "diffHunk": "@@ -315,6 +316,12 @@ public int populateFromPqlResults(\n         if (exceptions != null && exceptions.isArray() && exceptions.size() > 0) {\n             // Pinot is known to return exceptions with benign errorcodes like 200\n             // so we treat any exception as an error\n+            if (PinotSessionProperties.isMarkDataFetchExceptionsAsRetriable(session)) {\n+                throw new PinotException(\n+                    PINOT_DATA_FETCH_EXCEPTION,\n+                    Optional.of(pql),\n+                    String.format(\"Query %s encountered retriable exception %s\", pql, exceptions.get(0)));\n+            }\n             throw new PinotException(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a1406d698ee4a2a778ce6f8c0987dff106caa0e"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY1NTM5OA==", "bodyText": "same here.", "url": "https://github.com/prestodb/presto/pull/14649#discussion_r441655398", "createdAt": "2020-06-17T15:58:38Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSource.java", "diffHunk": "@@ -104,6 +105,12 @@ private static void checkExceptions(DataTable dataTable, PinotSplit split)\n             }\n         });\n         if (!exceptions.isEmpty()) {\n+            if (markDataFetchExceptionsAsRetriable) {\n+                throw new PinotException(\n+                    PINOT_DATA_FETCH_EXCEPTION,\n+                    split.getSegmentPql(),\n+                    String.format(\"Encountered %d retriable pinot exceptions for split %s: %s\", exceptions.size(), split, exceptions));\n+            }\n             throw new PinotException(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a1406d698ee4a2a778ce6f8c0987dff106caa0e"}, "originalPosition": 27}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5a1406d698ee4a2a778ce6f8c0987dff106caa0e", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/5a1406d698ee4a2a778ce6f8c0987dff106caa0e", "committedDate": "2020-06-17T08:02:08Z", "message": "Address comments"}, "afterCommit": {"oid": "63d7a0761b5e7ff18584ef0c5e1a5dce8eecad54", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/63d7a0761b5e7ff18584ef0c5e1a5dce8eecad54", "committedDate": "2020-06-17T22:48:44Z", "message": "Address comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "63d7a0761b5e7ff18584ef0c5e1a5dce8eecad54", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/63d7a0761b5e7ff18584ef0c5e1a5dce8eecad54", "committedDate": "2020-06-17T22:48:44Z", "message": "Address comments"}, "afterCommit": {"oid": "40d944b1efaeb34db44150a9b465a43d703d2994", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/40d944b1efaeb34db44150a9b465a43d703d2994", "committedDate": "2020-06-17T22:52:54Z", "message": "Address comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "40d944b1efaeb34db44150a9b465a43d703d2994", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/40d944b1efaeb34db44150a9b465a43d703d2994", "committedDate": "2020-06-17T22:52:54Z", "message": "Address comments"}, "afterCommit": {"oid": "b6e73decb0a33a93e04c431142e97946a7a4725a", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/b6e73decb0a33a93e04c431142e97946a7a4725a", "committedDate": "2020-06-17T23:14:25Z", "message": "Address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyODQ3NjEx", "url": "https://github.com/prestodb/presto/pull/14649#pullrequestreview-432847611", "createdAt": "2020-06-17T23:42:01Z", "commit": {"oid": "b6e73decb0a33a93e04c431142e97946a7a4725a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b6e73decb0a33a93e04c431142e97946a7a4725a", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/b6e73decb0a33a93e04c431142e97946a7a4725a", "committedDate": "2020-06-17T23:14:25Z", "message": "Address comments"}, "afterCommit": {"oid": "9d1ddde887ca79007e6f7b9c5e207cfefbfe0c25", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/9d1ddde887ca79007e6f7b9c5e207cfefbfe0c25", "committedDate": "2020-06-18T00:21:41Z", "message": "Address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyOTE1NTA4", "url": "https://github.com/prestodb/presto/pull/14649#pullrequestreview-432915508", "createdAt": "2020-06-18T03:28:03Z", "commit": {"oid": "9d1ddde887ca79007e6f7b9c5e207cfefbfe0c25"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9d1ddde887ca79007e6f7b9c5e207cfefbfe0c25", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/9d1ddde887ca79007e6f7b9c5e207cfefbfe0c25", "committedDate": "2020-06-18T00:21:41Z", "message": "Address comments"}, "afterCommit": {"oid": "8c1426db40f594b925c93cf8176534915cbc74c8", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/8c1426db40f594b925c93cf8176534915cbc74c8", "committedDate": "2020-06-18T05:32:14Z", "message": "Adding a config to retry on pinot exceptions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8c1426db40f594b925c93cf8176534915cbc74c8", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/8c1426db40f594b925c93cf8176534915cbc74c8", "committedDate": "2020-06-18T05:32:14Z", "message": "Adding a config to retry on pinot exceptions"}, "afterCommit": {"oid": "53cefa44cf78e9752c70c2a8dc0f72d7265aa690", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/53cefa44cf78e9752c70c2a8dc0f72d7265aa690", "committedDate": "2020-06-18T07:29:07Z", "message": "Adding a config to retry on pinot exceptions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "53cefa44cf78e9752c70c2a8dc0f72d7265aa690", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/53cefa44cf78e9752c70c2a8dc0f72d7265aa690", "committedDate": "2020-06-18T07:29:07Z", "message": "Adding a config to retry on pinot exceptions"}, "afterCommit": {"oid": "40a0de8414c6f1ea48894e522557b669070f2c6c", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/40a0de8414c6f1ea48894e522557b669070f2c6c", "committedDate": "2020-06-18T09:12:50Z", "message": "Adding a config to retry on pinot exceptions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c5de6a9c8430ea5ea0b37778a747320c86a2959", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/3c5de6a9c8430ea5ea0b37778a747320c86a2959", "committedDate": "2020-06-18T17:39:17Z", "message": "Adding a config to retry on pinot exceptions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "40a0de8414c6f1ea48894e522557b669070f2c6c", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/40a0de8414c6f1ea48894e522557b669070f2c6c", "committedDate": "2020-06-18T09:12:50Z", "message": "Adding a config to retry on pinot exceptions"}, "afterCommit": {"oid": "3c5de6a9c8430ea5ea0b37778a747320c86a2959", "author": {"user": {"login": "xiangfu0", "name": "Xiang Fu"}}, "url": "https://github.com/prestodb/presto/commit/3c5de6a9c8430ea5ea0b37778a747320c86a2959", "committedDate": "2020-06-18T17:39:17Z", "message": "Adding a config to retry on pinot exceptions"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1377, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}