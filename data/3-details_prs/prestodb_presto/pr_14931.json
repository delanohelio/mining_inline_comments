{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU5NDE1NTky", "number": 14931, "title": "Inline SQL functions at plan time", "bodyText": "== RELEASE NOTES ==\nGeneral Changes\n* Add support for inlining SQL functions at query planning time. This feature is enabled by default, and can be disabled with the ``inline_sql_functions`` session property.", "createdAt": "2020-07-30T17:16:12Z", "url": "https://github.com/prestodb/presto/pull/14931", "merged": true, "mergeCommit": {"oid": "a9d5c4c405a1bd2affd2b4f9718090959fa8869c"}, "closed": true, "closedAt": "2020-08-13T00:41:27Z", "author": {"login": "prithvip"}, "timelineItems": {"totalCount": 26, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc6D1yGgBqjM2MDUxOTkzOTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-TyRzABqjM2NDk3Njk2MDI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "06e0085caa4eb4e6bd6bda343e1c0efb4c738c13", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/06e0085caa4eb4e6bd6bda343e1c0efb4c738c13", "committedDate": "2020-07-30T17:14:10Z", "message": "[WIP] Inline SQL functions at plan time"}, "afterCommit": {"oid": "5816ffb1b4d18bc4ee4dfce471cfc810e4aaead6", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/5816ffb1b4d18bc4ee4dfce471cfc810e4aaead6", "committedDate": "2020-07-30T18:21:21Z", "message": "[WIP] Inline SQL functions at plan time"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5NDY5MzIz", "url": "https://github.com/prestodb/presto/pull/14931#pullrequestreview-459469323", "createdAt": "2020-07-31T20:48:12Z", "commit": {"oid": "5816ffb1b4d18bc4ee4dfce471cfc810e4aaead6"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQyMDo0ODoxMlrOG6V2Ow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQyMDo1MjozN1rOG6WDEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzgyODUzOQ==", "bodyText": "No need to have else here.", "url": "https://github.com/prestodb/presto/pull/14931#discussion_r463828539", "createdAt": "2020-07-31T20:48:12Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/InlineSqlFunctionsRewriter.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.sql.planner;\n+\n+import com.facebook.presto.Session;\n+import com.facebook.presto.common.type.Type;\n+import com.facebook.presto.metadata.Metadata;\n+import com.facebook.presto.spi.function.FunctionHandle;\n+import com.facebook.presto.spi.function.FunctionImplementationType;\n+import com.facebook.presto.spi.function.FunctionMetadata;\n+import com.facebook.presto.spi.function.SqlInvokedScalarFunctionImplementation;\n+import com.facebook.presto.sql.relational.SqlFunctionUtils;\n+import com.facebook.presto.sql.tree.Expression;\n+import com.facebook.presto.sql.tree.ExpressionRewriter;\n+import com.facebook.presto.sql.tree.ExpressionTreeRewriter;\n+import com.facebook.presto.sql.tree.FunctionCall;\n+import com.facebook.presto.sql.tree.NodeRef;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+\n+import static com.facebook.presto.SystemSessionProperties.isInlineSqlFunctions;\n+import static com.facebook.presto.metadata.FunctionManager.qualifyFunctionName;\n+import static com.facebook.presto.sql.analyzer.TypeSignatureProvider.fromTypes;\n+import static java.util.Objects.requireNonNull;\n+\n+public class InlineSqlFunctionsRewriter\n+{\n+    private InlineSqlFunctionsRewriter() {}\n+\n+    public static Expression rewrite(Expression expression, Session session, Metadata metadata, Map<NodeRef<Expression>, Type> expressionTypes)\n+    {\n+        if (isInlineSqlFunctions(session)) {\n+            return ExpressionTreeRewriter.rewriteWith(new Visitor(session, metadata, expressionTypes), expression);\n+        }\n+        else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5816ffb1b4d18bc4ee4dfce471cfc810e4aaead6"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzgzMDM1Ng==", "bodyText": "I think we normally would just put the rewriter as a private class for the rule itself so you can move this to InlineSqlFunctions.java, unless you expect this to be used by other classes.", "url": "https://github.com/prestodb/presto/pull/14931#discussion_r463830356", "createdAt": "2020-07-31T20:50:37Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/InlineSqlFunctionsRewriter.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.sql.planner;\n+\n+import com.facebook.presto.Session;\n+import com.facebook.presto.common.type.Type;\n+import com.facebook.presto.metadata.Metadata;\n+import com.facebook.presto.spi.function.FunctionHandle;\n+import com.facebook.presto.spi.function.FunctionImplementationType;\n+import com.facebook.presto.spi.function.FunctionMetadata;\n+import com.facebook.presto.spi.function.SqlInvokedScalarFunctionImplementation;\n+import com.facebook.presto.sql.relational.SqlFunctionUtils;\n+import com.facebook.presto.sql.tree.Expression;\n+import com.facebook.presto.sql.tree.ExpressionRewriter;\n+import com.facebook.presto.sql.tree.ExpressionTreeRewriter;\n+import com.facebook.presto.sql.tree.FunctionCall;\n+import com.facebook.presto.sql.tree.NodeRef;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+\n+import static com.facebook.presto.SystemSessionProperties.isInlineSqlFunctions;\n+import static com.facebook.presto.metadata.FunctionManager.qualifyFunctionName;\n+import static com.facebook.presto.sql.analyzer.TypeSignatureProvider.fromTypes;\n+import static java.util.Objects.requireNonNull;\n+\n+public class InlineSqlFunctionsRewriter", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5816ffb1b4d18bc4ee4dfce471cfc810e4aaead6"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzgzMTgyNQ==", "bodyText": "No need for else.", "url": "https://github.com/prestodb/presto/pull/14931#discussion_r463831825", "createdAt": "2020-07-31T20:52:37Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/InlineSqlFunctionsRewriter.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.sql.planner;\n+\n+import com.facebook.presto.Session;\n+import com.facebook.presto.common.type.Type;\n+import com.facebook.presto.metadata.Metadata;\n+import com.facebook.presto.spi.function.FunctionHandle;\n+import com.facebook.presto.spi.function.FunctionImplementationType;\n+import com.facebook.presto.spi.function.FunctionMetadata;\n+import com.facebook.presto.spi.function.SqlInvokedScalarFunctionImplementation;\n+import com.facebook.presto.sql.relational.SqlFunctionUtils;\n+import com.facebook.presto.sql.tree.Expression;\n+import com.facebook.presto.sql.tree.ExpressionRewriter;\n+import com.facebook.presto.sql.tree.ExpressionTreeRewriter;\n+import com.facebook.presto.sql.tree.FunctionCall;\n+import com.facebook.presto.sql.tree.NodeRef;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+\n+import static com.facebook.presto.SystemSessionProperties.isInlineSqlFunctions;\n+import static com.facebook.presto.metadata.FunctionManager.qualifyFunctionName;\n+import static com.facebook.presto.sql.analyzer.TypeSignatureProvider.fromTypes;\n+import static java.util.Objects.requireNonNull;\n+\n+public class InlineSqlFunctionsRewriter\n+{\n+    private InlineSqlFunctionsRewriter() {}\n+\n+    public static Expression rewrite(Expression expression, Session session, Metadata metadata, Map<NodeRef<Expression>, Type> expressionTypes)\n+    {\n+        if (isInlineSqlFunctions(session)) {\n+            return ExpressionTreeRewriter.rewriteWith(new Visitor(session, metadata, expressionTypes), expression);\n+        }\n+        else {\n+            return expression;\n+        }\n+    }\n+\n+    private static class Visitor\n+            extends ExpressionRewriter<Void>\n+    {\n+        private final Session session;\n+        private final Metadata metadata;\n+        private final Map<NodeRef<Expression>, Type> expressionTypes;\n+\n+        public Visitor(Session session, Metadata metadata, Map<NodeRef<Expression>, Type> expressionTypes)\n+        {\n+            this.session = requireNonNull(session, \"session is null\");\n+            this.metadata = requireNonNull(metadata, \"metadata is null\");\n+            this.expressionTypes = expressionTypes;\n+        }\n+\n+        @Override\n+        public Expression rewriteFunctionCall(FunctionCall node, Void context, ExpressionTreeRewriter<Void> treeRewriter)\n+        {\n+            List<Type> argumentTypes = new ArrayList<>();\n+            List<Expression> rewrittenArguments = new ArrayList<>();\n+            for (Expression argument : node.getArguments()) {\n+                argumentTypes.add(expressionTypes.get(NodeRef.of(argument)));\n+                rewrittenArguments.add(treeRewriter.rewrite(argument, context));\n+            }\n+\n+            FunctionHandle functionHandle = metadata.getFunctionManager().resolveFunction(\n+                    session.getTransactionId(),\n+                    qualifyFunctionName(node.getName()),\n+                    fromTypes(argumentTypes));\n+            FunctionMetadata functionMetadata = metadata.getFunctionManager().getFunctionMetadata(functionHandle);\n+\n+            if (functionMetadata.getImplementationType() != FunctionImplementationType.SQL) {\n+                return new FunctionCall(node.getName(), rewrittenArguments);\n+            }\n+            else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5816ffb1b4d18bc4ee4dfce471cfc810e4aaead6"}, "originalPosition": 86}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5816ffb1b4d18bc4ee4dfce471cfc810e4aaead6", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/5816ffb1b4d18bc4ee4dfce471cfc810e4aaead6", "committedDate": "2020-07-30T18:21:21Z", "message": "[WIP] Inline SQL functions at plan time"}, "afterCommit": {"oid": "da6851cc2723958f4de0d82f5d07926c7da441ff", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/da6851cc2723958f4de0d82f5d07926c7da441ff", "committedDate": "2020-08-03T16:58:52Z", "message": "[WIP] Inline SQL functions at plan time"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "da6851cc2723958f4de0d82f5d07926c7da441ff", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/da6851cc2723958f4de0d82f5d07926c7da441ff", "committedDate": "2020-08-03T16:58:52Z", "message": "[WIP] Inline SQL functions at plan time"}, "afterCommit": {"oid": "429fc09817520ad0570d9aebcd827c44c50eb63e", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/429fc09817520ad0570d9aebcd827c44c50eb63e", "committedDate": "2020-08-03T17:15:58Z", "message": "[WIP] Inline SQL functions at plan time"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "429fc09817520ad0570d9aebcd827c44c50eb63e", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/429fc09817520ad0570d9aebcd827c44c50eb63e", "committedDate": "2020-08-03T17:15:58Z", "message": "[WIP] Inline SQL functions at plan time"}, "afterCommit": {"oid": "e16c72bb287b10c2026f2d8bfd201dde3f5f22af", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/e16c72bb287b10c2026f2d8bfd201dde3f5f22af", "committedDate": "2020-08-04T17:52:58Z", "message": "[WIP] Inline SQL functions at plan time"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e16c72bb287b10c2026f2d8bfd201dde3f5f22af", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/e16c72bb287b10c2026f2d8bfd201dde3f5f22af", "committedDate": "2020-08-04T17:52:58Z", "message": "[WIP] Inline SQL functions at plan time"}, "afterCommit": {"oid": "3fb7434befe29b96e58a2f64ed24ad3ed7297c62", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/3fb7434befe29b96e58a2f64ed24ad3ed7297c62", "committedDate": "2020-08-04T18:09:31Z", "message": "[WIP] Inline SQL functions at plan time"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3fb7434befe29b96e58a2f64ed24ad3ed7297c62", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/3fb7434befe29b96e58a2f64ed24ad3ed7297c62", "committedDate": "2020-08-04T18:09:31Z", "message": "[WIP] Inline SQL functions at plan time"}, "afterCommit": {"oid": "6725caef7a26fcc8a3ee365f122b1dc20e988b16", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/6725caef7a26fcc8a3ee365f122b1dc20e988b16", "committedDate": "2020-08-04T21:15:41Z", "message": "Inline SQL functions at plan time"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6725caef7a26fcc8a3ee365f122b1dc20e988b16", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/6725caef7a26fcc8a3ee365f122b1dc20e988b16", "committedDate": "2020-08-04T21:15:41Z", "message": "Inline SQL functions at plan time"}, "afterCommit": {"oid": "e0e4a111e1636bde7e939fcec7562f4721a610af", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/e0e4a111e1636bde7e939fcec7562f4721a610af", "committedDate": "2020-08-04T21:49:49Z", "message": "Inline SQL functions at plan time"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e0e4a111e1636bde7e939fcec7562f4721a610af", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/e0e4a111e1636bde7e939fcec7562f4721a610af", "committedDate": "2020-08-04T21:49:49Z", "message": "Inline SQL functions at plan time"}, "afterCommit": {"oid": "95d51dbbda5ec295f90429f3401ea35abdfb491e", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/95d51dbbda5ec295f90429f3401ea35abdfb491e", "committedDate": "2020-08-05T20:43:03Z", "message": "Inline SQL functions at plan time"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "95d51dbbda5ec295f90429f3401ea35abdfb491e", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/95d51dbbda5ec295f90429f3401ea35abdfb491e", "committedDate": "2020-08-05T20:43:03Z", "message": "Inline SQL functions at plan time"}, "afterCommit": {"oid": "1f91c738ede0d2c46c0456b2742948e37e833ebf", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/1f91c738ede0d2c46c0456b2742948e37e833ebf", "committedDate": "2020-08-05T22:17:07Z", "message": "Inline SQL functions at plan time"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyMDgzODg5", "url": "https://github.com/prestodb/presto/pull/14931#pullrequestreview-462083889", "createdAt": "2020-08-05T23:11:14Z", "commit": {"oid": "1f91c738ede0d2c46c0456b2742948e37e833ebf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQyMzoxMToxNFrOG8dqdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQyMzoxMToxNFrOG8dqdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA1Mzc1MQ==", "bodyText": "You don't have to call setSupportedFunctionLanguages here, the default (SQL only) should work. But if you want to add THRIFT function, might as well add a test to make sure that won't be inlined. \ud83d\ude02  You can also add tests to make sure builtin SQL functions like array_sum is also inlined correctly if you want.", "url": "https://github.com/prestodb/presto/pull/14931#discussion_r466053751", "createdAt": "2020-08-05T23:11:14Z", "author": {"login": "rongrong"}, "path": "presto-main/src/test/java/com/facebook/presto/sql/planner/iterative/rule/TestInlineSqlFunctions.java", "diffHunk": "@@ -0,0 +1,160 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.sql.planner.iterative.rule;\n+\n+import com.facebook.presto.Session;\n+import com.facebook.presto.common.CatalogSchemaName;\n+import com.facebook.presto.common.function.QualifiedFunctionName;\n+import com.facebook.presto.common.type.IntegerType;\n+import com.facebook.presto.common.type.Type;\n+import com.facebook.presto.execution.warnings.WarningCollector;\n+import com.facebook.presto.functionNamespace.SqlInvokedFunctionNamespaceManagerConfig;\n+import com.facebook.presto.functionNamespace.testing.InMemoryFunctionNamespaceManager;\n+import com.facebook.presto.metadata.FunctionManager;\n+import com.facebook.presto.metadata.Metadata;\n+import com.facebook.presto.spi.function.Parameter;\n+import com.facebook.presto.spi.function.RoutineCharacteristics;\n+import com.facebook.presto.spi.function.SqlInvokedFunction;\n+import com.facebook.presto.spi.plan.AggregationNode;\n+import com.facebook.presto.sql.planner.iterative.rule.test.PlanBuilder;\n+import com.facebook.presto.sql.planner.iterative.rule.test.RuleTester;\n+import com.facebook.presto.sql.tree.Expression;\n+import com.facebook.presto.sql.tree.FunctionCall;\n+import com.facebook.presto.sql.tree.NodeRef;\n+import com.facebook.presto.sql.tree.QualifiedName;\n+import com.facebook.presto.sql.tree.SymbolReference;\n+import com.facebook.presto.testing.TestingSession;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+import org.testng.annotations.BeforeTest;\n+import org.testng.annotations.Test;\n+\n+import java.util.Map;\n+import java.util.Optional;\n+\n+import static com.facebook.presto.common.type.StandardTypes.INTEGER;\n+import static com.facebook.presto.common.type.TypeSignature.parseTypeSignature;\n+import static com.facebook.presto.spi.function.RoutineCharacteristics.Determinism.DETERMINISTIC;\n+import static com.facebook.presto.spi.function.RoutineCharacteristics.NullCallClause.RETURNS_NULL_ON_NULL_INPUT;\n+import static com.facebook.presto.sql.analyzer.ExpressionAnalyzer.getExpressionTypes;\n+import static com.facebook.presto.sql.planner.TypeProvider.viewOf;\n+import static com.facebook.presto.sql.planner.assertions.PlanMatchPattern.aggregation;\n+import static com.facebook.presto.sql.planner.assertions.PlanMatchPattern.expression;\n+import static com.facebook.presto.sql.planner.assertions.PlanMatchPattern.functionCall;\n+import static com.facebook.presto.sql.planner.assertions.PlanMatchPattern.project;\n+import static com.facebook.presto.sql.planner.assertions.PlanMatchPattern.values;\n+import static com.facebook.presto.sql.planner.iterative.rule.test.PlanBuilder.assignment;\n+import static org.testng.Assert.assertEquals;\n+\n+public class TestInlineSqlFunctions\n+{\n+    private static final SqlInvokedFunction SQL_FUNCTION_SQUARE = new SqlInvokedFunction(\n+            QualifiedFunctionName.of(new CatalogSchemaName(\"unittest\", \"memory\"), \"square\"),\n+            ImmutableList.of(new Parameter(\"x\", parseTypeSignature(INTEGER))),\n+            parseTypeSignature(INTEGER),\n+            \"square\",\n+            RoutineCharacteristics.builder()\n+                    .setDeterminism(DETERMINISTIC)\n+                    .setNullCallClause(RETURNS_NULL_ON_NULL_INPUT)\n+                    .build(),\n+            \"RETURN x * x\",\n+            Optional.empty());\n+\n+    private RuleTester tester;\n+\n+    @BeforeTest\n+    public void setup()\n+    {\n+        RuleTester tester = new RuleTester();\n+        FunctionManager functionManager = tester.getMetadata().getFunctionManager();\n+        InMemoryFunctionNamespaceManager namespaceManager = new InMemoryFunctionNamespaceManager(\n+                \"unittest\",\n+                new SqlInvokedFunctionNamespaceManagerConfig().setSupportedFunctionLanguages(\"{\\\"sql\\\": \\\"SQL\\\",\\\"java\\\": \\\"THRIFT\\\"}\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f91c738ede0d2c46c0456b2742948e37e833ebf"}, "originalPosition": 83}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyMDg0MDEz", "url": "https://github.com/prestodb/presto/pull/14931#pullrequestreview-462084013", "createdAt": "2020-08-05T23:11:34Z", "commit": {"oid": "1f91c738ede0d2c46c0456b2742948e37e833ebf"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1f91c738ede0d2c46c0456b2742948e37e833ebf", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/1f91c738ede0d2c46c0456b2742948e37e833ebf", "committedDate": "2020-08-05T22:17:07Z", "message": "Inline SQL functions at plan time"}, "afterCommit": {"oid": "df61ec1a3e5c28671c6b130032aea8ded749ed0e", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/df61ec1a3e5c28671c6b130032aea8ded749ed0e", "committedDate": "2020-08-06T17:25:16Z", "message": "Inline SQL functions at plan time"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "df61ec1a3e5c28671c6b130032aea8ded749ed0e", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/df61ec1a3e5c28671c6b130032aea8ded749ed0e", "committedDate": "2020-08-06T17:25:16Z", "message": "Inline SQL functions at plan time"}, "afterCommit": {"oid": "a870188ba4d51465c0ca1ec11c0e370036c3f491", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/a870188ba4d51465c0ca1ec11c0e370036c3f491", "committedDate": "2020-08-10T23:37:44Z", "message": "Inline SQL functions at plan time"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a870188ba4d51465c0ca1ec11c0e370036c3f491", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/a870188ba4d51465c0ca1ec11c0e370036c3f491", "committedDate": "2020-08-10T23:37:44Z", "message": "Inline SQL functions at plan time"}, "afterCommit": {"oid": "f661778386dabecc3279f90b191363498ce24991", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/f661778386dabecc3279f90b191363498ce24991", "committedDate": "2020-08-11T02:47:52Z", "message": "Inline SQL functions at plan time"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0NzE5MDE3", "url": "https://github.com/prestodb/presto/pull/14931#pullrequestreview-464719017", "createdAt": "2020-08-11T03:09:35Z", "commit": {"oid": "e3e2aaf45e46f8e6c5dfa8f72cffa5a9976f94a9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwMzowOTozNlrOG-m0Ww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwMzowOTozNlrOG-m0Ww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMwMDg5MQ==", "bodyText": "Should we do this at CREATE FUNCTION execution time?", "url": "https://github.com/prestodb/presto/pull/14931#discussion_r468300891", "createdAt": "2020-08-11T03:09:36Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/relational/SqlFunctionUtils.java", "diffHunk": "@@ -61,11 +61,12 @@\n {\n     private SqlFunctionUtils() {}\n \n-    public static Expression getSqlFunctionExpression(FunctionMetadata functionMetadata, SqlInvokedScalarFunctionImplementation implementation, SqlFunctionProperties sqlFunctionProperties, List<Expression> arguments)\n+    public static Expression getSqlFunctionExpression(FunctionMetadata functionMetadata, SqlInvokedScalarFunctionImplementation implementation, Metadata metadata, SqlFunctionProperties sqlFunctionProperties, List<Expression> arguments)\n     {\n         checkArgument(functionMetadata.getImplementationType().equals(SQL), format(\"Expect SQL function, get %s\", functionMetadata.getImplementationType()));\n         checkArgument(functionMetadata.getArgumentNames().isPresent(), \"ArgumentNames is missing\");\n         Expression expression = normalizeParameters(functionMetadata.getArgumentNames().get(), parseSqlFunctionExpression(implementation, sqlFunctionProperties));\n+        expression = coerceIfNecessary(functionMetadata, expression, sqlFunctionProperties, metadata);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e3e2aaf45e46f8e6c5dfa8f72cffa5a9976f94a9"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8de0c8fe6902f1a059d1c5e6977e0d6f60c42ed", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/a8de0c8fe6902f1a059d1c5e6977e0d6f60c42ed", "committedDate": "2020-08-12T20:27:40Z", "message": "Fix improperly scoped argument binding in lambda expressions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f661778386dabecc3279f90b191363498ce24991", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/f661778386dabecc3279f90b191363498ce24991", "committedDate": "2020-08-11T02:47:52Z", "message": "Inline SQL functions at plan time"}, "afterCommit": {"oid": "53357b133699f39a1feaaf2082ab7bf540dccf9b", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/53357b133699f39a1feaaf2082ab7bf540dccf9b", "committedDate": "2020-08-12T20:30:03Z", "message": "Coerce SQL function expressions at create time"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "53357b133699f39a1feaaf2082ab7bf540dccf9b", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/53357b133699f39a1feaaf2082ab7bf540dccf9b", "committedDate": "2020-08-12T20:30:03Z", "message": "Coerce SQL function expressions at create time"}, "afterCommit": {"oid": "f6075d233f85ac8414ada476d9730d7d945d52bd", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/f6075d233f85ac8414ada476d9730d7d945d52bd", "committedDate": "2020-08-12T20:54:40Z", "message": "Coerce SQL function expressions at create time"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2Mjc0MDM0", "url": "https://github.com/prestodb/presto/pull/14931#pullrequestreview-466274034", "createdAt": "2020-08-12T21:00:46Z", "commit": {"oid": "53357b133699f39a1feaaf2082ab7bf540dccf9b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQyMTowMDo1OFrOG_ytLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQyMTowMDo1OFrOG_ytLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU0NDIzOQ==", "bodyText": "Let's keep this. We need to check all existing functions and update them before it's safe to remove these. So also add the coercion in getSqlFunctionExpression. We can think about introducing a warning for this and deprecate this in later releases.", "url": "https://github.com/prestodb/presto/pull/14931#discussion_r469544239", "createdAt": "2020-08-12T21:00:58Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/relational/SqlFunctionUtils.java", "diffHunk": "@@ -191,30 +187,6 @@ public Expression rewriteIdentifier(Identifier node, Map<Identifier, VariableRef\n         }, sqlFunction, variableMap);\n     }\n \n-    private static Expression coerceIfNecessary(FunctionMetadata functionMetadata, Expression sqlFunction, SqlFunctionProperties sqlFunctionProperties, Metadata metadata)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6075d233f85ac8414ada476d9730d7d945d52bd"}, "originalPosition": 35}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f6075d233f85ac8414ada476d9730d7d945d52bd", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/f6075d233f85ac8414ada476d9730d7d945d52bd", "committedDate": "2020-08-12T20:54:40Z", "message": "Coerce SQL function expressions at create time"}, "afterCommit": {"oid": "9f23d48703d7eadd9f30d3c74b7500f3849cb2a5", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/9f23d48703d7eadd9f30d3c74b7500f3849cb2a5", "committedDate": "2020-08-12T21:59:00Z", "message": "Inline SQL functions at plan time"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9f23d48703d7eadd9f30d3c74b7500f3849cb2a5", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/9f23d48703d7eadd9f30d3c74b7500f3849cb2a5", "committedDate": "2020-08-12T21:59:00Z", "message": "Inline SQL functions at plan time"}, "afterCommit": {"oid": "e032df3610b3b2d2445ef48c9fb83fba5ecab2dc", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/e032df3610b3b2d2445ef48c9fb83fba5ecab2dc", "committedDate": "2020-08-12T22:06:39Z", "message": "Inline SQL functions at plan time"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2MzMwNjcy", "url": "https://github.com/prestodb/presto/pull/14931#pullrequestreview-466330672", "createdAt": "2020-08-12T22:54:47Z", "commit": {"oid": "1efe37c7371d91a3c37d00adb8162f637fe5bb69"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQyMjo1NDo0N1rOG_1mHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQyMjo1NDo0N1rOG_1mHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU5MTU4Mw==", "bodyText": "Nits: I found it more logical to have this before the return cast rather than after, but I don't have strong opinions.", "url": "https://github.com/prestodb/presto/pull/14931#discussion_r469591583", "createdAt": "2020-08-12T22:54:47Z", "author": {"login": "rongrong"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/CreateFunctionTask.java", "diffHunk": "@@ -101,12 +103,32 @@ private SqlInvokedFunction createSqlInvokedFunction(CreateFunction statement, Me\n \n         if (statement.getBody() instanceof Return) {\n             Expression bodyExpression = ((Return) statement.getBody()).getExpression();\n-            Type bodyType = analysis.getType(bodyExpression);\n-\n-            if (!bodyType.equals(metadata.getType(returnType))) {\n-                // Casting is safe-here, since we have verified that the actual type of the body is coercible to declared return type.\n-                body = new Return(new Cast(bodyExpression, statement.getReturnType()));\n+            if (!analysis.getType(bodyExpression).equals(metadata.getType(returnType))) {\n+                // Casting is safe here, since we have verified at analysis time that the actual type of the body is coercible to declared return type.\n+                bodyExpression = new Cast(bodyExpression, statement.getReturnType());\n             }\n+\n+            // Coerce expressions in body if necessary\n+            bodyExpression = ExpressionTreeRewriter.rewriteWith(new ExpressionRewriter<Void>()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1efe37c7371d91a3c37d00adb8162f637fe5bb69"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cdd798193b24e1f93c2eedae0a7d19caa89bb47c", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/cdd798193b24e1f93c2eedae0a7d19caa89bb47c", "committedDate": "2020-08-12T23:11:16Z", "message": "Add casts to expressions in SQL functions if coercible"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1942ea3cc4063e4c40004cb0f9c9b66304dcae13", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/1942ea3cc4063e4c40004cb0f9c9b66304dcae13", "committedDate": "2020-08-12T23:11:26Z", "message": "Inline SQL functions at plan time"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e032df3610b3b2d2445ef48c9fb83fba5ecab2dc", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/e032df3610b3b2d2445ef48c9fb83fba5ecab2dc", "committedDate": "2020-08-12T22:06:39Z", "message": "Inline SQL functions at plan time"}, "afterCommit": {"oid": "1942ea3cc4063e4c40004cb0f9c9b66304dcae13", "author": {"user": {"login": "prithvip", "name": null}}, "url": "https://github.com/prestodb/presto/commit/1942ea3cc4063e4c40004cb0f9c9b66304dcae13", "committedDate": "2020-08-12T23:11:26Z", "message": "Inline SQL functions at plan time"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 381, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}