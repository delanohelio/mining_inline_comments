{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMyNzU4OTA1", "number": 14632, "title": "Add allowed roles for HTTP endpoints", "bodyText": "Partially implements #14639\nDepends on: prestodb/airlift #17\n== RELEASE NOTES ==\n\nGeneral Changes\n* Specify allowed roles for HTTP endpoints", "createdAt": "2020-06-10T23:50:33Z", "url": "https://github.com/prestodb/presto/pull/14632", "merged": true, "mergeCommit": {"oid": "b7435884f747e9e5031bd028aa035ed51e335687"}, "closed": true, "closedAt": "2020-07-22T22:20:08Z", "author": {"login": "zacw7"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcqlbK8ABqjM0MzkxMTIwNzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc20RFZgFqTQ1MTc3MTMxOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "126efbb0d70dfc21d003427b8b7ce6bd67cc7dde", "author": {"user": {"login": "zacw7", "name": "Zac"}}, "url": "https://github.com/prestodb/presto/commit/126efbb0d70dfc21d003427b8b7ce6bd67cc7dde", "committedDate": "2020-06-12T16:23:04Z", "message": "Revert changes out of scope"}, "afterCommit": {"oid": "7d20f280bc648006f16758d11f87e7f5282094f5", "author": {"user": {"login": "zacw7", "name": "Zac"}}, "url": "https://github.com/prestodb/presto/commit/7d20f280bc648006f16758d11f87e7f5282094f5", "committedDate": "2020-06-12T16:24:49Z", "message": "Specify roles for Jersey resources"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxODc5OTYx", "url": "https://github.com/prestodb/presto/pull/14632#pullrequestreview-431879961", "createdAt": "2020-06-16T20:48:47Z", "commit": {"oid": "7d20f280bc648006f16758d11f87e7f5282094f5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQyMDo0ODo0N1rOGksn5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQyMDo0ODo0N1rOGksn5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEzMzAzMQ==", "bodyText": "Let's have static constants", "url": "https://github.com/prestodb/presto/pull/14632#discussion_r441133031", "createdAt": "2020-06-16T20:48:47Z", "author": {"login": "arhimondr"}, "path": "presto-main/src/main/java/com/facebook/presto/dispatcher/QueuedStatementResource.java", "diffHunk": "@@ -82,6 +83,7 @@\n import static javax.ws.rs.core.Response.Status.NOT_FOUND;\n \n @Path(\"/\")\n+@RolesAllowed(\"user\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d20f280bc648006f16758d11f87e7f5282094f5"}, "originalPosition": 12}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6ae53ab5887eb03f5e619853c1b5f2f16593bbeb", "author": {"user": {"login": "zacw7", "name": "Zac"}}, "url": "https://github.com/prestodb/presto/commit/6ae53ab5887eb03f5e619853c1b5f2f16593bbeb", "committedDate": "2020-06-17T18:41:57Z", "message": "Add static constants for RoleType"}, "afterCommit": {"oid": "18a6de4bacd841d189c394daa4a7c0dc1ac94f2a", "author": {"user": {"login": "zacw7", "name": "Zac"}}, "url": "https://github.com/prestodb/presto/commit/18a6de4bacd841d189c394daa4a7c0dc1ac94f2a", "committedDate": "2020-06-17T18:44:03Z", "message": "Add static constants for RoleType"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyNjgyODE1", "url": "https://github.com/prestodb/presto/pull/14632#pullrequestreview-432682815", "createdAt": "2020-06-17T18:49:23Z", "commit": {"oid": "18a6de4bacd841d189c394daa4a7c0dc1ac94f2a"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxODo0OToyNFrOGlSubA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxODo0OTo1N1rOGlSwsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc1NzI5Mg==", "bodyText": "nit: prefer static imports", "url": "https://github.com/prestodb/presto/pull/14632#discussion_r441757292", "createdAt": "2020-06-17T18:49:24Z", "author": {"login": "arhimondr"}, "path": "presto-main/src/main/java/com/facebook/presto/dispatcher/QueuedStatementResource.java", "diffHunk": "@@ -82,6 +84,7 @@\n import static javax.ws.rs.core.Response.Status.NOT_FOUND;\n \n @Path(\"/\")\n+@RolesAllowed(RoleType.USER)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18a6de4bacd841d189c394daa4a7c0dc1ac94f2a"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc1Nzg3NQ==", "bodyText": "We shouldn't import presto-main in presto-proxy.\n@mayankgarg1990 do we want to enforce security in presto-proxy?", "url": "https://github.com/prestodb/presto/pull/14632#discussion_r441757875", "createdAt": "2020-06-17T18:49:57Z", "author": {"login": "arhimondr"}, "path": "presto-proxy/pom.xml", "diffHunk": "@@ -154,16 +154,15 @@\n             <scope>runtime</scope>\n         </dependency>\n \n-        <!-- for testing -->\n         <dependency>\n-            <groupId>org.testng</groupId>\n-            <artifactId>testng</artifactId>\n-            <scope>test</scope>\n+            <groupId>com.facebook.presto</groupId>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18a6de4bacd841d189c394daa4a7c0dc1ac94f2a"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyNjg1NTYw", "url": "https://github.com/prestodb/presto/pull/14632#pullrequestreview-432685560", "createdAt": "2020-06-17T18:53:17Z", "commit": {"oid": "18a6de4bacd841d189c394daa4a7c0dc1ac94f2a"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxODo1MzoxN1rOGlS_Kw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxODo1Mzo0MFrOGlTApg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc2MTU3OQ==", "bodyText": "I believe that we should move this class to presto-common package. @arhimondr - thoughts?", "url": "https://github.com/prestodb/presto/pull/14632#discussion_r441761579", "createdAt": "2020-06-17T18:53:17Z", "author": {"login": "mayankgarg1990"}, "path": "presto-main/src/main/java/com/facebook/presto/server/security/RoleType.java", "diffHunk": "@@ -0,0 +1,10 @@\n+package com.facebook.presto.server.security;\n+\n+public final class RoleType", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18a6de4bacd841d189c394daa4a7c0dc1ac94f2a"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc2MTk1OA==", "bodyText": "Yes, we need to have authn and authz in every single FB endpoint", "url": "https://github.com/prestodb/presto/pull/14632#discussion_r441761958", "createdAt": "2020-06-17T18:53:40Z", "author": {"login": "mayankgarg1990"}, "path": "presto-proxy/pom.xml", "diffHunk": "@@ -154,16 +154,15 @@\n             <scope>runtime</scope>\n         </dependency>\n \n-        <!-- for testing -->\n         <dependency>\n-            <groupId>org.testng</groupId>\n-            <artifactId>testng</artifactId>\n-            <scope>test</scope>\n+            <groupId>com.facebook.presto</groupId>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc1Nzg3NQ=="}, "originalCommit": {"oid": "18a6de4bacd841d189c394daa4a7c0dc1ac94f2a"}, "originalPosition": 9}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "18a6de4bacd841d189c394daa4a7c0dc1ac94f2a", "author": {"user": {"login": "zacw7", "name": "Zac"}}, "url": "https://github.com/prestodb/presto/commit/18a6de4bacd841d189c394daa4a7c0dc1ac94f2a", "committedDate": "2020-06-17T18:44:03Z", "message": "Add static constants for RoleType"}, "afterCommit": {"oid": "2eed3bd6c27d22a4e7ba2a2d12ad7dd1c0fd27df", "author": {"user": {"login": "zacw7", "name": "Zac"}}, "url": "https://github.com/prestodb/presto/commit/2eed3bd6c27d22a4e7ba2a2d12ad7dd1c0fd27df", "committedDate": "2020-06-17T19:00:04Z", "message": "Add static constants for RoleType"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2eed3bd6c27d22a4e7ba2a2d12ad7dd1c0fd27df", "author": {"user": {"login": "zacw7", "name": "Zac"}}, "url": "https://github.com/prestodb/presto/commit/2eed3bd6c27d22a4e7ba2a2d12ad7dd1c0fd27df", "committedDate": "2020-06-17T19:00:04Z", "message": "Add static constants for RoleType"}, "afterCommit": {"oid": "af16a01022eac061fd6a5bfff224f5c179a101a2", "author": {"user": {"login": "zacw7", "name": "Zac"}}, "url": "https://github.com/prestodb/presto/commit/af16a01022eac061fd6a5bfff224f5c179a101a2", "committedDate": "2020-06-17T19:02:08Z", "message": "Add static constants for RoleType"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b32f8e6908f90efbdb6d07a68d0467efadba5cf6", "author": {"user": {"login": "zacw7", "name": "Zac"}}, "url": "https://github.com/prestodb/presto/commit/b32f8e6908f90efbdb6d07a68d0467efadba5cf6", "committedDate": "2020-06-18T16:48:31Z", "message": "Remove authorization for ProxyResource"}, "afterCommit": {"oid": "fcdbc73ad2dff284f15616921fcf5bf4601355d2", "author": {"user": {"login": "zacw7", "name": "Zac"}}, "url": "https://github.com/prestodb/presto/commit/fcdbc73ad2dff284f15616921fcf5bf4601355d2", "committedDate": "2020-06-18T16:49:29Z", "message": "Remove authorization for ProxyResource"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0MTExNzE3", "url": "https://github.com/prestodb/presto/pull/14632#pullrequestreview-434111717", "createdAt": "2020-06-19T14:15:40Z", "commit": {"oid": "fcdbc73ad2dff284f15616921fcf5bf4601355d2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwODEyODIw", "url": "https://github.com/prestodb/presto/pull/14632#pullrequestreview-440812820", "createdAt": "2020-07-01T12:14:34Z", "commit": {"oid": "a8d428082bbd487406cef4b9575b6df0e7cdb5a3"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxMjoxNDozNFrOGrjWNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxMjoyMzoyN1rOGrjnrA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMyMTA3OQ==", "bodyText": "This is used by the UI which is generally visible to everyone - should this be just ADMIN? I believe that we should add USER here as well. Thoughts @arhimondr ?", "url": "https://github.com/prestodb/presto/pull/14632#discussion_r448321079", "createdAt": "2020-07-01T12:14:34Z", "author": {"login": "mayankgarg1990"}, "path": "presto-main/src/main/java/com/facebook/presto/server/ClusterStatsResource.java", "diffHunk": "@@ -22,17 +22,20 @@\n import com.fasterxml.jackson.annotation.JsonCreator;\n import com.fasterxml.jackson.annotation.JsonProperty;\n \n+import javax.annotation.security.RolesAllowed;\n import javax.inject.Inject;\n import javax.ws.rs.GET;\n import javax.ws.rs.Path;\n import javax.ws.rs.Produces;\n import javax.ws.rs.core.MediaType;\n import javax.ws.rs.core.Response;\n \n+import static com.facebook.presto.server.security.RoleType.ADMIN;\n import static java.util.Objects.requireNonNull;\n import static java.util.concurrent.TimeUnit.SECONDS;\n \n @Path(\"/v1/cluster\")\n+@RolesAllowed(ADMIN)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a8d428082bbd487406cef4b9575b6df0e7cdb5a3"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMyMjgzNA==", "bodyText": "This can also be used in UIs to serve information - should we also open this up to users?", "url": "https://github.com/prestodb/presto/pull/14632#discussion_r448322834", "createdAt": "2020-07-01T12:18:02Z", "author": {"login": "mayankgarg1990"}, "path": "presto-main/src/main/java/com/facebook/presto/server/QueryStateInfoResource.java", "diffHunk": "@@ -35,12 +36,14 @@\n import static com.facebook.presto.execution.QueryState.QUEUED;\n import static com.facebook.presto.server.QueryStateInfo.createQueryStateInfo;\n import static com.facebook.presto.server.QueryStateInfo.createQueuedQueryStateInfo;\n+import static com.facebook.presto.server.security.RoleType.ADMIN;\n import static com.google.common.base.Strings.isNullOrEmpty;\n import static com.google.common.collect.ImmutableList.toImmutableList;\n import static java.util.Objects.requireNonNull;\n import static javax.ws.rs.core.Response.Status.NOT_FOUND;\n \n @Path(\"/v1/queryState\")\n+@RolesAllowed(ADMIN)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a8d428082bbd487406cef4b9575b6df0e7cdb5a3"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMyNTU0OA==", "bodyText": "This is used in QueryResult to allow for users to cancel their query - we should make this USER", "url": "https://github.com/prestodb/presto/pull/14632#discussion_r448325548", "createdAt": "2020-07-01T12:23:27Z", "author": {"login": "mayankgarg1990"}, "path": "presto-main/src/main/java/com/facebook/presto/server/StageResource.java", "diffHunk": "@@ -16,14 +16,17 @@\n import com.facebook.presto.execution.QueryManager;\n import com.facebook.presto.execution.StageId;\n \n+import javax.annotation.security.RolesAllowed;\n import javax.inject.Inject;\n import javax.ws.rs.DELETE;\n import javax.ws.rs.Path;\n import javax.ws.rs.PathParam;\n \n+import static com.facebook.presto.server.security.RoleType.ADMIN;\n import static java.util.Objects.requireNonNull;\n \n @Path(\"/v1/stage\")\n+@RolesAllowed(ADMIN)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a8d428082bbd487406cef4b9575b6df0e7cdb5a3"}, "originalPosition": 14}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a8d428082bbd487406cef4b9575b6df0e7cdb5a3", "author": {"user": {"login": "zacw7", "name": "Zac"}}, "url": "https://github.com/prestodb/presto/commit/a8d428082bbd487406cef4b9575b6df0e7cdb5a3", "committedDate": "2020-06-26T23:39:46Z", "message": "Specify roles for Jetty servlet"}, "afterCommit": {"oid": "fbfbef74f0da07b4a221be2d12da25edbdf01dc1", "author": {"user": {"login": "zacw7", "name": "Zac"}}, "url": "https://github.com/prestodb/presto/commit/fbfbef74f0da07b4a221be2d12da25edbdf01dc1", "committedDate": "2020-07-01T22:26:45Z", "message": "Specify roles for Jetty servlet"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f90d67c5d8a13950327e28e8a62d449bae74674", "author": {"user": {"login": "zacw7", "name": "Zac"}}, "url": "https://github.com/prestodb/presto/commit/7f90d67c5d8a13950327e28e8a62d449bae74674", "committedDate": "2020-07-06T18:39:46Z", "message": "Specify allowed roles for HTTP endpoints"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "39d857b9d39cacb270b3c759e1e4ff452a2539e8", "author": {"user": {"login": "zacw7", "name": "Zac"}}, "url": "https://github.com/prestodb/presto/commit/39d857b9d39cacb270b3c759e1e4ff452a2539e8", "committedDate": "2020-07-01T22:56:18Z", "message": "Change allowed roles"}, "afterCommit": {"oid": "7f90d67c5d8a13950327e28e8a62d449bae74674", "author": {"user": {"login": "zacw7", "name": "Zac"}}, "url": "https://github.com/prestodb/presto/commit/7f90d67c5d8a13950327e28e8a62d449bae74674", "committedDate": "2020-07-06T18:39:46Z", "message": "Specify allowed roles for HTTP endpoints"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxNzcxMzE5", "url": "https://github.com/prestodb/presto/pull/14632#pullrequestreview-451771319", "createdAt": "2020-07-20T16:31:44Z", "commit": {"oid": "7f90d67c5d8a13950327e28e8a62d449bae74674"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1338, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}