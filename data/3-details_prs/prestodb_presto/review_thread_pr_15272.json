{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk4MzkxMjIz", "number": 15272, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxMzoyNjo0N1rOEsDCag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxMzoyOTowMVrOEsDGCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0NjIyNTcwOnYy", "diffSide": "RIGHT", "path": "presto-common/src/main/java/com/facebook/presto/common/block/AbstractMapBlock.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxMzoyNjo0N1rOHfJpLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQyMzo0Nzo0OFrOHfbSLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQyNTkwMw==", "bodyText": "positionCount -> entryCount or length?", "url": "https://github.com/prestodb/presto/pull/15272#discussion_r502425903", "createdAt": "2020-10-09T13:26:47Z", "author": {"login": "mbasmanova"}, "path": "presto-common/src/main/java/com/facebook/presto/common/block/AbstractMapBlock.java", "diffHunk": "@@ -194,6 +194,22 @@ public long getRegionLogicalSizeInBytes(int position, int length)\n                 Integer.BYTES * HASH_MULTIPLIER * entryCount;\n     }\n \n+    @Override\n+    public long getApproximateRegionLogicalSizeInBytes(int position, int length)\n+    {\n+        int positionCount = getPositionCount();\n+        checkValidRegion(positionCount, position, length);\n+\n+        int entriesStart = getOffset(position);\n+        int entriesEnd = getOffset(position + length);\n+        int entryCount = entriesEnd - entriesStart;\n+\n+        return getRawKeyBlock().getApproximateRegionLogicalSizeInBytes(entriesStart, entryCount) +\n+                getRawValueBlock().getApproximateRegionLogicalSizeInBytes(entriesStart, entryCount) +\n+                (Integer.BYTES + Byte.BYTES) * positionCount +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e90e1c4ae6f6d8b65be227e06fb43993f5bd7342"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY1MjYzNg==", "bodyText": "@mbasmanova thanks for reading so carefully! It shoudl be length. I also added the comments\n                (Integer.BYTES + Byte.BYTES) * length +         // offsets and mapIsNull\n                Integer.BYTES * HASH_MULTIPLIER * entryCount;   // hashtables", "url": "https://github.com/prestodb/presto/pull/15272#discussion_r502652636", "createdAt": "2020-10-09T20:18:39Z", "author": {"login": "yingsu00"}, "path": "presto-common/src/main/java/com/facebook/presto/common/block/AbstractMapBlock.java", "diffHunk": "@@ -194,6 +194,22 @@ public long getRegionLogicalSizeInBytes(int position, int length)\n                 Integer.BYTES * HASH_MULTIPLIER * entryCount;\n     }\n \n+    @Override\n+    public long getApproximateRegionLogicalSizeInBytes(int position, int length)\n+    {\n+        int positionCount = getPositionCount();\n+        checkValidRegion(positionCount, position, length);\n+\n+        int entriesStart = getOffset(position);\n+        int entriesEnd = getOffset(position + length);\n+        int entryCount = entriesEnd - entriesStart;\n+\n+        return getRawKeyBlock().getApproximateRegionLogicalSizeInBytes(entriesStart, entryCount) +\n+                getRawValueBlock().getApproximateRegionLogicalSizeInBytes(entriesStart, entryCount) +\n+                (Integer.BYTES + Byte.BYTES) * positionCount +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQyNTkwMw=="}, "originalCommit": {"oid": "e90e1c4ae6f6d8b65be227e06fb43993f5bd7342"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjcxNDkyNw==", "bodyText": "@yingsu00 Thanks for adding comments. These make it very easy to understand what the code is doing and why.", "url": "https://github.com/prestodb/presto/pull/15272#discussion_r502714927", "createdAt": "2020-10-09T23:47:48Z", "author": {"login": "mbasmanova"}, "path": "presto-common/src/main/java/com/facebook/presto/common/block/AbstractMapBlock.java", "diffHunk": "@@ -194,6 +194,22 @@ public long getRegionLogicalSizeInBytes(int position, int length)\n                 Integer.BYTES * HASH_MULTIPLIER * entryCount;\n     }\n \n+    @Override\n+    public long getApproximateRegionLogicalSizeInBytes(int position, int length)\n+    {\n+        int positionCount = getPositionCount();\n+        checkValidRegion(positionCount, position, length);\n+\n+        int entriesStart = getOffset(position);\n+        int entriesEnd = getOffset(position + length);\n+        int entryCount = entriesEnd - entriesStart;\n+\n+        return getRawKeyBlock().getApproximateRegionLogicalSizeInBytes(entriesStart, entryCount) +\n+                getRawValueBlock().getApproximateRegionLogicalSizeInBytes(entriesStart, entryCount) +\n+                (Integer.BYTES + Byte.BYTES) * positionCount +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQyNTkwMw=="}, "originalCommit": {"oid": "e90e1c4ae6f6d8b65be227e06fb43993f5bd7342"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0NjIzMjA3OnYy", "diffSide": "RIGHT", "path": "presto-common/src/main/java/com/facebook/presto/common/block/AbstractRowBlock.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxMzoyODoxM1rOHfJs5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxMzoyODoxM1rOHfJs5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQyNjg1Mg==", "bodyText": "positionCount -> length?", "url": "https://github.com/prestodb/presto/pull/15272#discussion_r502426852", "createdAt": "2020-10-09T13:28:13Z", "author": {"login": "mbasmanova"}, "path": "presto-common/src/main/java/com/facebook/presto/common/block/AbstractRowBlock.java", "diffHunk": "@@ -130,6 +129,24 @@ public long getRegionLogicalSizeInBytes(int position, int length)\n         return regionLogicalSizeInBytes;\n     }\n \n+    @Override\n+    public long getApproximateRegionLogicalSizeInBytes(int position, int length)\n+    {\n+        int positionCount = getPositionCount();\n+        checkValidRegion(positionCount, position, length);\n+\n+        int startFieldBlockOffset = getFieldBlockOffset(position);\n+        int endFieldBlockOffset = getFieldBlockOffset(position + length);\n+        int fieldBlockLength = endFieldBlockOffset - startFieldBlockOffset;\n+\n+        long approximateLogicalSizeInBytes = (Integer.BYTES + Byte.BYTES) * positionCount;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e90e1c4ae6f6d8b65be227e06fb43993f5bd7342"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0NjIzNDk5OnYy", "diffSide": "RIGHT", "path": "presto-common/src/main/java/com/facebook/presto/common/block/DictionaryBlock.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxMzoyOTowMVrOHfJuuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQyMDozODoyNlrOHfX9hQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQyNzMyMw==", "bodyText": "what's the reason for * 1.0f ?", "url": "https://github.com/prestodb/presto/pull/15272#discussion_r502427323", "createdAt": "2020-10-09T13:29:01Z", "author": {"login": "mbasmanova"}, "path": "presto-common/src/main/java/com/facebook/presto/common/block/DictionaryBlock.java", "diffHunk": "@@ -280,6 +280,12 @@ public long getRegionLogicalSizeInBytes(int positionOffset, int length)\n         return sizeInBytes;\n     }\n \n+    @Override\n+    public long getApproximateRegionLogicalSizeInBytes(int position, int length)\n+    {\n+        return (long) (dictionary.getApproximateRegionLogicalSizeInBytes(0, dictionary.getPositionCount()) * 1.0f * length / positionCount);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e90e1c4ae6f6d8b65be227e06fb43993f5bd7342"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY2MDQ4NQ==", "bodyText": "You are right it doesn't matter. I removed it and it's just\nreturn dictionary.getApproximateRegionLogicalSizeInBytes(0, dictionary.getPositionCount()) * length / positionCount;", "url": "https://github.com/prestodb/presto/pull/15272#discussion_r502660485", "createdAt": "2020-10-09T20:38:26Z", "author": {"login": "yingsu00"}, "path": "presto-common/src/main/java/com/facebook/presto/common/block/DictionaryBlock.java", "diffHunk": "@@ -280,6 +280,12 @@ public long getRegionLogicalSizeInBytes(int positionOffset, int length)\n         return sizeInBytes;\n     }\n \n+    @Override\n+    public long getApproximateRegionLogicalSizeInBytes(int position, int length)\n+    {\n+        return (long) (dictionary.getApproximateRegionLogicalSizeInBytes(0, dictionary.getPositionCount()) * 1.0f * length / positionCount);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQyNzMyMw=="}, "originalCommit": {"oid": "e90e1c4ae6f6d8b65be227e06fb43993f5bd7342"}, "originalPosition": 7}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3481, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}