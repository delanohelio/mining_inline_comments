{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ1NDMxMjg4", "number": 14799, "title": "Add getSupportedColumnStatisticsForTemporaryTable function", "bodyText": "Hive does not support all presto types, but temporary table could use unsupported presto types via native format. Hence, directly calling metastore.getSupportedColumnStatistics() to determine supported column statistics for each column will cause problems for temporary tables.\nThis PR adds a getSupportedColumnStatisticsForTemporaryTable function to regulate how supported column statistics types are determined for temporary table, which is called by two paths: 1. When PlanFragmenter creates temporary table; 2. When PlanFragmenter configures statisticsAggregations in temporary table writer/finish nodes.\n== NO RELEASE NOTE ==", "createdAt": "2020-07-07T13:56:47Z", "url": "https://github.com/prestodb/presto/pull/14799", "merged": true, "mergeCommit": {"oid": "92c3d3cf1bbe0b8d8375bd8c9902108f2c04ce1c"}, "closed": true, "closedAt": "2020-07-07T23:09:24Z", "author": {"login": "pguofb"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcymzdrAFqTQ0Mzk1MzY5OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcyuKVagFqTQ0NDMwOTM3Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzOTUzNjk4", "url": "https://github.com/prestodb/presto/pull/14799#pullrequestreview-443953698", "createdAt": "2020-07-07T14:34:54Z", "commit": {"oid": "b99fa9a623e9eb82b630c443a39179591494583a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNDozNDo1NFrOGuBi7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNDozNDo1NFrOGuBi7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDkxMzAwNA==", "bodyText": "since this isn't dependent on the hive supported statistics at all, I would list out supported statistics here rather than calling getSupportedColumnStatistics.", "url": "https://github.com/prestodb/presto/pull/14799#discussion_r450913004", "createdAt": "2020-07-07T14:34:54Z", "author": {"login": "rschlussel"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -981,6 +982,19 @@ public ConnectorTableHandle createTemporaryTable(ConnectorSession session, List<\n         return new HiveTableHandle(schemaName, tableName);\n     }\n \n+    private Set<ColumnStatisticType> getSupportedColumnStatisticsForTemporaryTable(Type type)\n+    {\n+        // Temporary table statistics are not committed to metastore, so no need to call metastore for supported\n+        // column statistics, instead locally determine.\n+        try {\n+            return MetastoreUtil.getSupportedColumnStatistics(type);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b99fa9a623e9eb82b630c443a39179591494583a"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzOTkyNjU3", "url": "https://github.com/prestodb/presto/pull/14799#pullrequestreview-443992657", "createdAt": "2020-07-07T15:14:35Z", "commit": {"oid": "b99fa9a623e9eb82b630c443a39179591494583a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNToxNDozNVrOGuDYVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNToxNDozNVrOGuDYVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk0MzA2Mg==", "bodyText": "This function will be very similar to getSupportedColumnStatistics, replace throwing error with return ImmutableSet.of(TOTAL_SIZE_IN_BYTES);", "url": "https://github.com/prestodb/presto/pull/14799#discussion_r450943062", "createdAt": "2020-07-07T15:14:35Z", "author": {"login": "viczhang861"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -981,6 +982,19 @@ public ConnectorTableHandle createTemporaryTable(ConnectorSession session, List<\n         return new HiveTableHandle(schemaName, tableName);\n     }\n \n+    private Set<ColumnStatisticType> getSupportedColumnStatisticsForTemporaryTable(Type type)\n+    {\n+        // Temporary table statistics are not committed to metastore, so no need to call metastore for supported\n+        // column statistics, instead locally determine.\n+        try {\n+            return MetastoreUtil.getSupportedColumnStatistics(type);\n+        }\n+        // In case there are unsupported column types (native format), specify a default column statistics.\n+        catch (IllegalArgumentException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b99fa9a623e9eb82b630c443a39179591494583a"}, "originalPosition": 29}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b99fa9a623e9eb82b630c443a39179591494583a", "author": {"user": {"login": "pguofb", "name": "Peizhen Guo"}}, "url": "https://github.com/prestodb/presto/commit/b99fa9a623e9eb82b630c443a39179591494583a", "committedDate": "2020-07-07T13:45:57Z", "message": "Change getSupportedColumnStatistics for temp table\n\n- Hive does not support all presto types, but temporary table supports\nstoring unsupported presto types via native format. Hence, directly\ncalling metastore.getSupportedColumnStatistics() to determine supported\ncolumn statistics for each column will cause problems for temporary\ntables."}, "afterCommit": {"oid": "ced9a959482f944c2370df22cbdc72bc529ac6c6", "author": {"user": {"login": "pguofb", "name": "Peizhen Guo"}}, "url": "https://github.com/prestodb/presto/commit/ced9a959482f944c2370df22cbdc72bc529ac6c6", "committedDate": "2020-07-07T15:57:28Z", "message": "Change getSupportedColumnStatistics for temp table\n\n- Hive does not support all presto types, but temporary table supports\nstoring unsupported presto types via native format. Hence, directly\ncalling metastore.getSupportedColumnStatistics() to determine supported\ncolumn statistics for each column will cause problems for temporary\ntables."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0MDgwMTg0", "url": "https://github.com/prestodb/presto/pull/14799#pullrequestreview-444080184", "createdAt": "2020-07-07T16:55:47Z", "commit": {"oid": "ced9a959482f944c2370df22cbdc72bc529ac6c6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNjo1NTo0N1rOGuHaRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNjo1NTo0N1rOGuHaRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTAwOTA5NA==", "bodyText": "we can also do non-nulls by default.", "url": "https://github.com/prestodb/presto/pull/14799#discussion_r451009094", "createdAt": "2020-07-07T16:55:47Z", "author": {"login": "rschlussel"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -984,6 +1000,29 @@ public ConnectorTableHandle createTemporaryTable(ConnectorSession session, List<\n         return new HiveTableHandle(schemaName, tableName);\n     }\n \n+    private Set<ColumnStatisticType> getSupportedColumnStatisticsForTemporaryTable(Type type)\n+    {\n+        // Temporary table statistics are not committed to metastore, so no need to call metastore for supported\n+        // column statistics, instead locally determine.\n+        if (type.equals(BOOLEAN)) {\n+            return ImmutableSet.of(NUMBER_OF_NON_NULL_VALUES, NUMBER_OF_TRUE_VALUES);\n+        }\n+        if (isNumericType(type) || type.equals(DATE) || type.equals(TIMESTAMP)) {\n+            return ImmutableSet.of(MIN_VALUE, MAX_VALUE, NUMBER_OF_DISTINCT_VALUES, NUMBER_OF_NON_NULL_VALUES);\n+        }\n+        if (isVarcharType(type) || isCharType(type)) {\n+            return ImmutableSet.of(NUMBER_OF_NON_NULL_VALUES, NUMBER_OF_DISTINCT_VALUES, TOTAL_SIZE_IN_BYTES, MAX_VALUE_SIZE_IN_BYTES);\n+        }\n+        if (type.equals(VARBINARY)) {\n+            return ImmutableSet.of(NUMBER_OF_NON_NULL_VALUES, TOTAL_SIZE_IN_BYTES, MAX_VALUE_SIZE_IN_BYTES);\n+        }\n+        if (type instanceof ArrayType || type instanceof RowType || type instanceof MapType) {\n+            return ImmutableSet.of(NUMBER_OF_NON_NULL_VALUES, TOTAL_SIZE_IN_BYTES);\n+        }\n+        // For other unknown column types, specify a default column statistics TOTAL_SIZE.\n+        return ImmutableSet.of(TOTAL_SIZE_IN_BYTES);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ced9a959482f944c2370df22cbdc72bc529ac6c6"}, "originalPosition": 77}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ced9a959482f944c2370df22cbdc72bc529ac6c6", "author": {"user": {"login": "pguofb", "name": "Peizhen Guo"}}, "url": "https://github.com/prestodb/presto/commit/ced9a959482f944c2370df22cbdc72bc529ac6c6", "committedDate": "2020-07-07T15:57:28Z", "message": "Change getSupportedColumnStatistics for temp table\n\n- Hive does not support all presto types, but temporary table supports\nstoring unsupported presto types via native format. Hence, directly\ncalling metastore.getSupportedColumnStatistics() to determine supported\ncolumn statistics for each column will cause problems for temporary\ntables."}, "afterCommit": {"oid": "f029371f73e65782a9d1b095147e6c3608c591c9", "author": {"user": {"login": "pguofb", "name": "Peizhen Guo"}}, "url": "https://github.com/prestodb/presto/commit/f029371f73e65782a9d1b095147e6c3608c591c9", "committedDate": "2020-07-07T17:09:00Z", "message": "Change getSupportedColumnStatistics for temp table\n\n- Hive does not support all presto types, but temporary table supports\nstoring unsupported presto types via native format. Hence, directly\ncalling metastore.getSupportedColumnStatistics() to determine supported\ncolumn statistics for each column will cause problems for temporary\ntables."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0MTgzMTky", "url": "https://github.com/prestodb/presto/pull/14799#pullrequestreview-444183192", "createdAt": "2020-07-07T19:22:58Z", "commit": {"oid": "f029371f73e65782a9d1b095147e6c3608c591c9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxOToyMjo1OFrOGuMYOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxOToyMjo1OFrOGuMYOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA5MDQ5MA==", "bodyText": "I don't think this is a reliable way to know if something is a temporary table, since technically any table can start with that prefix", "url": "https://github.com/prestodb/presto/pull/14799#discussion_r451090490", "createdAt": "2020-07-07T19:22:58Z", "author": {"login": "rschlussel"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -2639,22 +2678,22 @@ public TableStatisticsMetadata getStatisticsCollectionMetadataForWrite(Connector\n             return TableStatisticsMetadata.empty();\n         }\n         List<String> partitionedBy = firstNonNull(getPartitionedBy(tableMetadata.getProperties()), ImmutableList.of());\n-        return getStatisticsCollectionMetadata(tableMetadata.getColumns(), partitionedBy, false);\n+        return getStatisticsCollectionMetadata(tableMetadata.getColumns(), partitionedBy, false, tableMetadata.getTable().getTableName().startsWith(PRESTO_TEMPORARY_TABLE_NAME_PREFIX));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f029371f73e65782a9d1b095147e6c3608c591c9"}, "originalPosition": 88}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0MjAzMjM2", "url": "https://github.com/prestodb/presto/pull/14799#pullrequestreview-444203236", "createdAt": "2020-07-07T19:53:32Z", "commit": {"oid": "f029371f73e65782a9d1b095147e6c3608c591c9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxOTo1MzozMlrOGuNWTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxOTo1MzozMlrOGuNWTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTEwNjM4Mg==", "bodyText": "nit  // default    is enough\nor keep names same using TOTAL_SIZE_IN_BYTES and NUMBER_OF_NON_NULL_VALUES", "url": "https://github.com/prestodb/presto/pull/14799#discussion_r451106382", "createdAt": "2020-07-07T19:53:32Z", "author": {"login": "viczhang861"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -984,6 +1000,29 @@ public ConnectorTableHandle createTemporaryTable(ConnectorSession session, List<\n         return new HiveTableHandle(schemaName, tableName);\n     }\n \n+    private Set<ColumnStatisticType> getSupportedColumnStatisticsForTemporaryTable(Type type)\n+    {\n+        // Temporary table statistics are not committed to metastore, so no need to call metastore for supported\n+        // column statistics, instead locally determine.\n+        if (type.equals(BOOLEAN)) {\n+            return ImmutableSet.of(NUMBER_OF_NON_NULL_VALUES, NUMBER_OF_TRUE_VALUES);\n+        }\n+        if (isNumericType(type) || type.equals(DATE) || type.equals(TIMESTAMP)) {\n+            return ImmutableSet.of(MIN_VALUE, MAX_VALUE, NUMBER_OF_DISTINCT_VALUES, NUMBER_OF_NON_NULL_VALUES);\n+        }\n+        if (isVarcharType(type) || isCharType(type)) {\n+            return ImmutableSet.of(NUMBER_OF_NON_NULL_VALUES, NUMBER_OF_DISTINCT_VALUES, TOTAL_SIZE_IN_BYTES, MAX_VALUE_SIZE_IN_BYTES);\n+        }\n+        if (type.equals(VARBINARY)) {\n+            return ImmutableSet.of(NUMBER_OF_NON_NULL_VALUES, TOTAL_SIZE_IN_BYTES, MAX_VALUE_SIZE_IN_BYTES);\n+        }\n+        if (type instanceof ArrayType || type instanceof RowType || type instanceof MapType) {\n+            return ImmutableSet.of(NUMBER_OF_NON_NULL_VALUES, TOTAL_SIZE_IN_BYTES);\n+        }\n+        // For other unknown column types, specify default column statistics TOTAL_SIZE and NON_NULL_VALUES which is not specific to any data type.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f029371f73e65782a9d1b095147e6c3608c591c9"}, "originalPosition": 76}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b62c550f8015d2eae7661af071400fb37911c6c2", "author": {"user": {"login": "pguofb", "name": "Peizhen Guo"}}, "url": "https://github.com/prestodb/presto/commit/b62c550f8015d2eae7661af071400fb37911c6c2", "committedDate": "2020-07-07T20:06:05Z", "message": "Change getSupportedColumnStatistics for temp table\n\n- Hive does not support all presto types, but temporary table supports\nstoring unsupported presto types via native format. Hence, directly\ncalling metastore.getSupportedColumnStatistics() to determine supported\ncolumn statistics for each column will cause problems for temporary\ntables."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f029371f73e65782a9d1b095147e6c3608c591c9", "author": {"user": {"login": "pguofb", "name": "Peizhen Guo"}}, "url": "https://github.com/prestodb/presto/commit/f029371f73e65782a9d1b095147e6c3608c591c9", "committedDate": "2020-07-07T17:09:00Z", "message": "Change getSupportedColumnStatistics for temp table\n\n- Hive does not support all presto types, but temporary table supports\nstoring unsupported presto types via native format. Hence, directly\ncalling metastore.getSupportedColumnStatistics() to determine supported\ncolumn statistics for each column will cause problems for temporary\ntables."}, "afterCommit": {"oid": "b62c550f8015d2eae7661af071400fb37911c6c2", "author": {"user": {"login": "pguofb", "name": "Peizhen Guo"}}, "url": "https://github.com/prestodb/presto/commit/b62c550f8015d2eae7661af071400fb37911c6c2", "committedDate": "2020-07-07T20:06:05Z", "message": "Change getSupportedColumnStatistics for temp table\n\n- Hive does not support all presto types, but temporary table supports\nstoring unsupported presto types via native format. Hence, directly\ncalling metastore.getSupportedColumnStatistics() to determine supported\ncolumn statistics for each column will cause problems for temporary\ntables."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0MjY4MTIy", "url": "https://github.com/prestodb/presto/pull/14799#pullrequestreview-444268122", "createdAt": "2020-07-07T21:37:09Z", "commit": {"oid": "b62c550f8015d2eae7661af071400fb37911c6c2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QyMTozNzowOVrOGuQglA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QyMTozNzowOVrOGuQglA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE1ODE2NA==", "bodyText": "is this never called for temporary tables?", "url": "https://github.com/prestodb/presto/pull/14799#discussion_r451158164", "createdAt": "2020-07-07T21:37:09Z", "author": {"login": "rschlussel"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -2639,22 +2678,23 @@ public TableStatisticsMetadata getStatisticsCollectionMetadataForWrite(Connector\n             return TableStatisticsMetadata.empty();\n         }\n         List<String> partitionedBy = firstNonNull(getPartitionedBy(tableMetadata.getProperties()), ImmutableList.of());\n-        return getStatisticsCollectionMetadata(tableMetadata.getColumns(), partitionedBy, false);\n+        Optional<Table> table = metastore.getTable(tableMetadata.getTable().getSchemaName(), tableMetadata.getTable().getTableName());\n+        return getStatisticsCollectionMetadata(tableMetadata.getColumns(), partitionedBy, false, table.isPresent() && table.get().getTableType() == TEMPORARY_TABLE);\n     }\n \n     @Override\n     public TableStatisticsMetadata getStatisticsCollectionMetadata(ConnectorSession session, ConnectorTableMetadata tableMetadata)\n     {\n         List<String> partitionedBy = firstNonNull(getPartitionedBy(tableMetadata.getProperties()), ImmutableList.of());\n-        return getStatisticsCollectionMetadata(tableMetadata.getColumns(), partitionedBy, true);\n+        return getStatisticsCollectionMetadata(tableMetadata.getColumns(), partitionedBy, true, false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b62c550f8015d2eae7661af071400fb37911c6c2"}, "originalPosition": 97}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0MzA5Mzc3", "url": "https://github.com/prestodb/presto/pull/14799#pullrequestreview-444309377", "createdAt": "2020-07-07T23:09:13Z", "commit": {"oid": "b62c550f8015d2eae7661af071400fb37911c6c2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1219, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}