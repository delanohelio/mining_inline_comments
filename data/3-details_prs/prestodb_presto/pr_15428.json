{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE5NTM1MjA1", "number": 15428, "title": "Use serialized plan hash for fragment result caching", "bodyText": "Test plan - Enhanced existing unit test. Verifier run for internal queries passed.\n== RELEASE NOTES ==\n\nGeneral Changes\n* Reduce memory usage for fragment result caching.", "createdAt": "2020-11-12T00:25:36Z", "url": "https://github.com/prestodb/presto/pull/15428", "merged": true, "mergeCommit": {"oid": "2e67116d263b02b97ef507e8ca978af731747d06"}, "closed": true, "closedAt": "2020-11-18T23:25:04Z", "author": {"login": "shixuan-fan"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdbniOKABqjM5ODYyMzM2MzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABddJQGNABqjQwMDE3MzAzMzA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f9743ea5559be3cb034e35889c52bd8071fc7e04", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/f9743ea5559be3cb034e35889c52bd8071fc7e04", "committedDate": "2020-11-12T00:21:23Z", "message": "Use serialized plan for fragment result caching"}, "afterCommit": {"oid": "d6e99fcbd44b9fcd60c53d86b584212bf331e830", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/d6e99fcbd44b9fcd60c53d86b584212bf331e830", "committedDate": "2020-11-12T00:36:42Z", "message": "Use serialized plan for fragment result caching"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d6e99fcbd44b9fcd60c53d86b584212bf331e830", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/d6e99fcbd44b9fcd60c53d86b584212bf331e830", "committedDate": "2020-11-12T00:36:42Z", "message": "Use serialized plan for fragment result caching"}, "afterCommit": {"oid": "41f220984be794c0db5439b215a358655e06b0fe", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/41f220984be794c0db5439b215a358655e06b0fe", "committedDate": "2020-11-12T00:47:34Z", "message": "Use serialized plan for fragment result caching"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwODkyMzE5", "url": "https://github.com/prestodb/presto/pull/15428#pullrequestreview-530892319", "createdAt": "2020-11-16T03:00:40Z", "commit": {"oid": "41f220984be794c0db5439b215a358655e06b0fe"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwMzowMDo0MFrOHzm0Rg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwMzowMTo1OVrOHzm1hw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzg3NTM5OA==", "bodyText": "remove this method?", "url": "https://github.com/prestodb/presto/pull/15428#discussion_r523875398", "createdAt": "2020-11-16T03:00:40Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/FragmentResultCacheContext.java", "diffHunk": "@@ -85,4 +106,9 @@ public CanonicalPlanFragment getCanonicalPlanFragment()\n     {\n         return canonicalPlanFragment;\n     }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41f220984be794c0db5439b215a358655e06b0fe"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzg3NTcxOQ==", "bodyText": "if (!canonicalPlanFragment.isPresent()) {\n    return Optional.empty();\n}\n\ntry {\n...", "url": "https://github.com/prestodb/presto/pull/15428#discussion_r523875719", "createdAt": "2020-11-16T03:01:59Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/FragmentResultCacheContext.java", "diffHunk": "@@ -24,34 +25,53 @@\n import com.facebook.presto.sql.planner.CanonicalPlanFragment;\n import com.facebook.presto.sql.planner.PartitioningScheme;\n import com.facebook.presto.sql.planner.plan.GroupIdNode;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n import com.google.common.collect.ImmutableSet;\n \n import java.util.Optional;\n import java.util.Set;\n \n import static com.facebook.presto.spi.plan.AggregationNode.Step.PARTIAL;\n import static com.facebook.presto.sql.planner.CanonicalPlanGenerator.generateCanonicalPlan;\n+import static com.google.common.hash.Hashing.sha256;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n import static java.util.Objects.requireNonNull;\n \n public class FragmentResultCacheContext\n {\n+    private static final Logger log = Logger.get(FragmentResultCacheContext.class);\n     private static final Set<Class<? extends PlanNode>> ALLOWED_CHILDREN_NODES = ImmutableSet.of(TableScanNode.class, FilterNode.class, ProjectNode.class, GroupIdNode.class);\n \n     private final FragmentResultCacheManager fragmentResultCacheManager;\n     private final CanonicalPlanFragment canonicalPlanFragment;\n+    private final String hashedCanonicalPlanFragment;\n \n     public static Optional<FragmentResultCacheContext> createFragmentResultCacheContext(\n             FragmentResultCacheManager fragmentResultCacheManager,\n             PlanNode root,\n             PartitioningScheme partitioningScheme,\n-            Session session)\n+            Session session,\n+            ObjectMapper objectMapper)\n     {\n         if (!SystemSessionProperties.isFragmentResultCachingEnabled(session) || !isEligibleForFragmentResultCaching(root)) {\n             return Optional.empty();\n         }\n \n         Optional<CanonicalPlanFragment> canonicalPlanFragment = generateCanonicalPlan(root, partitioningScheme);\n-        return canonicalPlanFragment.map(fragment -> new FragmentResultCacheContext(fragmentResultCacheManager, fragment));\n+        if (canonicalPlanFragment.isPresent()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41f220984be794c0db5439b215a358655e06b0fe"}, "originalPosition": 48}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43a62bfa3f2d2f6a550ff4119f34b17c02ba9c43", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/43a62bfa3f2d2f6a550ff4119f34b17c02ba9c43", "committedDate": "2020-11-16T18:27:37Z", "message": "Use serialized plan for fragment result caching"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "41f220984be794c0db5439b215a358655e06b0fe", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/41f220984be794c0db5439b215a358655e06b0fe", "committedDate": "2020-11-12T00:47:34Z", "message": "Use serialized plan for fragment result caching"}, "afterCommit": {"oid": "43a62bfa3f2d2f6a550ff4119f34b17c02ba9c43", "author": {"user": {"login": "shixuan-fan", "name": "Shixuan Fan"}}, "url": "https://github.com/prestodb/presto/commit/43a62bfa3f2d2f6a550ff4119f34b17c02ba9c43", "committedDate": "2020-11-16T18:27:37Z", "message": "Use serialized plan for fragment result caching"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4691, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}