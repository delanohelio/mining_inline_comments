{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc1MDA3OTQz", "number": 15093, "title": "Adding multivalued column support in Pinot connector", "bodyText": "Test plan - Tested by selecting a multivalued columns\nMultivalued columns in pinot are best described a set of same primitive type elements. Picking Array here as the closest presto type. With this diff only selecting the column is possible and not UDFs such as length, which will be added in subsequent PRs\n== NO RELEASE NOTE ==", "createdAt": "2020-08-27T23:49:02Z", "url": "https://github.com/prestodb/presto/pull/15093", "merged": true, "mergeCommit": {"oid": "405ebe6f8c4af2d0ee9aa4717c0da2d57bc2e42c"}, "closed": true, "closedAt": "2020-09-12T01:17:56Z", "author": {"login": "dharakk"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdDJvYBABqjM3MDE4NjYzMjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdH-T_JgFqTQ4NzE3Nzk5MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5fa33dcdaad9b14a2655669ab9f3cb4cc4864de6", "author": {"user": {"login": "dharakk", "name": "Dharak Kharod"}}, "url": "https://github.com/prestodb/presto/commit/5fa33dcdaad9b14a2655669ab9f3cb4cc4864de6", "committedDate": "2020-08-27T23:41:48Z", "message": "Adding multivalued column support in Pinot connector"}, "afterCommit": {"oid": "8f1b7f31b11198fea1388adee82b58d6124b39bb", "author": {"user": {"login": "dharakk", "name": "Dharak Kharod"}}, "url": "https://github.com/prestodb/presto/commit/8f1b7f31b11198fea1388adee82b58d6124b39bb", "committedDate": "2020-08-28T00:19:26Z", "message": "Adding multivalued column support in Pinot connector"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3MTY2NDk0", "url": "https://github.com/prestodb/presto/pull/15093#pullrequestreview-477166494", "createdAt": "2020-08-28T00:26:05Z", "commit": {"oid": "8f1b7f31b11198fea1388adee82b58d6124b39bb"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQwMDoyNjowNVrOHIlgwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQwMDoyODo1OVrOHIljtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc2NTI1MA==", "bodyText": "nit: Else if perhaps ? I also think type and blockbuilder cannot be null by the time we get to this function.", "url": "https://github.com/prestodb/presto/pull/15093#discussion_r478765250", "createdAt": "2020-08-28T00:26:05Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotBrokerPageSourceBase.java", "diffHunk": "@@ -110,6 +112,30 @@ private static Double parseDouble(String value)\n         }\n     }\n \n+    protected void setValue(Type type, BlockBuilder blockBuilder, JsonNode value)\n+    {\n+        if (type == null || blockBuilder == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f1b7f31b11198fea1388adee82b58d6124b39bb"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc2NTM2MA==", "bodyText": "Do we support nested types ? if not, lets somehow explicitly forbid it ? ie arrays inside of arrays.", "url": "https://github.com/prestodb/presto/pull/15093#discussion_r478765360", "createdAt": "2020-08-28T00:26:29Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotBrokerPageSourceBase.java", "diffHunk": "@@ -110,6 +112,30 @@ private static Double parseDouble(String value)\n         }\n     }\n \n+    protected void setValue(Type type, BlockBuilder blockBuilder, JsonNode value)\n+    {\n+        if (type == null || blockBuilder == null) {\n+            return;\n+        }\n+        if (value == null) {\n+            blockBuilder.appendNull();\n+            return;\n+        }\n+        if (type instanceof ArrayType) {\n+            checkState(value.isArray());\n+\n+            BlockBuilder childBuilder = blockBuilder.beginBlockEntry();\n+            ArrayNode arrayNode = (ArrayNode) value;\n+            for (int i = 0; i < arrayNode.size(); i++) {\n+                setValue(((ArrayType) type).getElementType(), childBuilder, asText(arrayNode.get(i)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f1b7f31b11198fea1388adee82b58d6124b39bb"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc2NTY2OA==", "bodyText": "I couldn't figure out how this change to TypeManager is related. It is definitely a good change and avoids duplicating framework level information.", "url": "https://github.com/prestodb/presto/pull/15093#discussion_r478765668", "createdAt": "2020-08-28T00:27:36Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/MetadataUtil.java", "diffHunk": "@@ -53,29 +49,25 @@ private MetadataUtil()\n     public static final class TestingTypeDeserializer\n             extends FromStringDeserializer<Type>\n     {\n-        private final Map<String, Type> types = ImmutableMap.of(\n-                StandardTypes.BOOLEAN, BOOLEAN,\n-                StandardTypes.BIGINT, BIGINT,\n-                StandardTypes.INTEGER, INTEGER,\n-                StandardTypes.DOUBLE, DOUBLE,\n-                StandardTypes.VARCHAR, VARCHAR);\n+        private final TypeManager typeManager;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f1b7f31b11198fea1388adee82b58d6124b39bb"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc2NjAwNg==", "bodyText": "Should this be in a separate test ? Like testJsonRoundTripWithArrays ?", "url": "https://github.com/prestodb/presto/pull/15093#discussion_r478766006", "createdAt": "2020-08-28T00:28:59Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/TestPinotColumnHandle.java", "diffHunk": "@@ -26,13 +27,18 @@\n public class TestPinotColumnHandle\n {\n     private final PinotColumnHandle columnHandle = new PinotColumnHandle(\"columnName\", VARCHAR, REGULAR);\n+    private final PinotColumnHandle arrayColumnHandle = new PinotColumnHandle(\"arrayColumn\", new ArrayType(VARCHAR), REGULAR);\n \n     @Test\n     public void testJsonRoundTrip()\n     {\n         String json = COLUMN_CODEC.toJson(columnHandle);\n         PinotColumnHandle copy = COLUMN_CODEC.fromJson(json);\n         assertEquals(copy, columnHandle);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f1b7f31b11198fea1388adee82b58d6124b39bb"}, "originalPosition": 19}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8f1b7f31b11198fea1388adee82b58d6124b39bb", "author": {"user": {"login": "dharakk", "name": "Dharak Kharod"}}, "url": "https://github.com/prestodb/presto/commit/8f1b7f31b11198fea1388adee82b58d6124b39bb", "committedDate": "2020-08-28T00:19:26Z", "message": "Adding multivalued column support in Pinot connector"}, "afterCommit": {"oid": "90e8cd6c82467c0f7cb0715fa8a53b4b20de86fd", "author": {"user": {"login": "dharakk", "name": "Dharak Kharod"}}, "url": "https://github.com/prestodb/presto/commit/90e8cd6c82467c0f7cb0715fa8a53b4b20de86fd", "committedDate": "2020-09-03T02:14:24Z", "message": "Adding multivalued column support in Pinot connector"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxNDgwMzE0", "url": "https://github.com/prestodb/presto/pull/15093#pullrequestreview-481480314", "createdAt": "2020-09-03T04:17:04Z", "commit": {"oid": "90e8cd6c82467c0f7cb0715fa8a53b4b20de86fd"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QwNDoxNzowNFrOHMVRIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QwNDoyNzoxOFrOHMVbQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjY5MzQxMA==", "bodyText": "Just confirming: This should be writeLong instead of writeInt ? Perhaps add a comment as to why.", "url": "https://github.com/prestodb/presto/pull/15093#discussion_r482693410", "createdAt": "2020-09-03T04:17:04Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSource.java", "diffHunk": "@@ -295,6 +300,66 @@ else if (javaType.equals(Slice.class)) {\n         }\n     }\n \n+    private void writeArrayBlock(BlockBuilder blockBuilder, Type columnType, int columnIndex)\n+    {\n+        for (int rowIndex = 0; rowIndex < currentDataTable.getDataTable().getNumberOfRows(); rowIndex++) {\n+            ColumnDataType columnPinotType = currentDataTable.getDataTable().getDataSchema().getColumnDataType(columnIndex);\n+            Type columnPrestoType = ((ArrayType) columnType).getElementType();\n+            BlockBuilder childBuilder = blockBuilder.beginBlockEntry();\n+            switch (columnPinotType) {\n+                case INT_ARRAY:\n+                    int[] intArray = currentDataTable.getDataTable().getIntArray(rowIndex, columnIndex);\n+                    for (int i = 0; i < intArray.length; i++) {\n+                        columnPrestoType.writeLong(childBuilder, intArray[i]);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "90e8cd6c82467c0f7cb0715fa8a53b4b20de86fd"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjY5NTE4OA==", "bodyText": "My OCD tells me we should hoist the condition outside the loop :-)", "url": "https://github.com/prestodb/presto/pull/15093#discussion_r482695188", "createdAt": "2020-09-03T04:24:21Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSource.java", "diffHunk": "@@ -295,6 +300,66 @@ else if (javaType.equals(Slice.class)) {\n         }\n     }\n \n+    private void writeArrayBlock(BlockBuilder blockBuilder, Type columnType, int columnIndex)\n+    {\n+        for (int rowIndex = 0; rowIndex < currentDataTable.getDataTable().getNumberOfRows(); rowIndex++) {\n+            ColumnDataType columnPinotType = currentDataTable.getDataTable().getDataSchema().getColumnDataType(columnIndex);\n+            Type columnPrestoType = ((ArrayType) columnType).getElementType();\n+            BlockBuilder childBuilder = blockBuilder.beginBlockEntry();\n+            switch (columnPinotType) {\n+                case INT_ARRAY:\n+                    int[] intArray = currentDataTable.getDataTable().getIntArray(rowIndex, columnIndex);\n+                    for (int i = 0; i < intArray.length; i++) {\n+                        columnPrestoType.writeLong(childBuilder, intArray[i]);\n+                        completedBytes += Long.BYTES;\n+                    }\n+                    break;\n+                case LONG_ARRAY:\n+                    long[] longArray = currentDataTable.getDataTable().getLongArray(rowIndex, columnIndex);\n+                    for (int i = 0; i < longArray.length; i++) {\n+                        columnPrestoType.writeLong(childBuilder, longArray[i]);\n+                        completedBytes += Long.BYTES;\n+                    }\n+                    break;\n+                case FLOAT_ARRAY:\n+                    float[] floatArray = currentDataTable.getDataTable().getFloatArray(rowIndex, columnIndex);\n+                    for (int i = 0; i < floatArray.length; i++) {\n+                        if (columnPrestoType.getJavaType().equals(long.class)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "90e8cd6c82467c0f7cb0715fa8a53b4b20de86fd"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjY5NTc0MQ==", "bodyText": "Hmm. I don't see any new tests in this PR about the segment page source multi-value support. How come the existing tests cover it ? IntelliJ\"s run with code coverage is your friend :-P", "url": "https://github.com/prestodb/presto/pull/15093#discussion_r482695741", "createdAt": "2020-09-03T04:26:22Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/test/java/com/facebook/presto/pinot/MetadataUtil.java", "diffHunk": "@@ -53,29 +49,25 @@ private MetadataUtil()\n     public static final class TestingTypeDeserializer\n             extends FromStringDeserializer<Type>\n     {\n-        private final Map<String, Type> types = ImmutableMap.of(\n-                StandardTypes.BOOLEAN, BOOLEAN,\n-                StandardTypes.BIGINT, BIGINT,\n-                StandardTypes.INTEGER, INTEGER,\n-                StandardTypes.DOUBLE, DOUBLE,\n-                StandardTypes.VARCHAR, VARCHAR);\n+        private final TypeManager typeManager;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc2NTY2OA=="}, "originalCommit": {"oid": "8f1b7f31b11198fea1388adee82b58d6124b39bb"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjY5NjAwMQ==", "bodyText": "^^^^ ping", "url": "https://github.com/prestodb/presto/pull/15093#discussion_r482696001", "createdAt": "2020-09-03T04:27:18Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotBrokerPageSourceBase.java", "diffHunk": "@@ -110,6 +112,30 @@ private static Double parseDouble(String value)\n         }\n     }\n \n+    protected void setValue(Type type, BlockBuilder blockBuilder, JsonNode value)\n+    {\n+        if (type == null || blockBuilder == null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc2NTI1MA=="}, "originalCommit": {"oid": "8f1b7f31b11198fea1388adee82b58d6124b39bb"}, "originalPosition": 22}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "90e8cd6c82467c0f7cb0715fa8a53b4b20de86fd", "author": {"user": {"login": "dharakk", "name": "Dharak Kharod"}}, "url": "https://github.com/prestodb/presto/commit/90e8cd6c82467c0f7cb0715fa8a53b4b20de86fd", "committedDate": "2020-09-03T02:14:24Z", "message": "Adding multivalued column support in Pinot connector"}, "afterCommit": {"oid": "d772b91492da81a29b7076601a6768e79b22709d", "author": {"user": {"login": "dharakk", "name": "Dharak Kharod"}}, "url": "https://github.com/prestodb/presto/commit/d772b91492da81a29b7076601a6768e79b22709d", "committedDate": "2020-09-03T05:56:27Z", "message": "Adding multivalued column support in Pinot connector"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d772b91492da81a29b7076601a6768e79b22709d", "author": {"user": {"login": "dharakk", "name": "Dharak Kharod"}}, "url": "https://github.com/prestodb/presto/commit/d772b91492da81a29b7076601a6768e79b22709d", "committedDate": "2020-09-03T05:56:27Z", "message": "Adding multivalued column support in Pinot connector"}, "afterCommit": {"oid": "78bb844385615c875f1c05a177cc50550d32e125", "author": {"user": {"login": "dharakk", "name": "Dharak Kharod"}}, "url": "https://github.com/prestodb/presto/commit/78bb844385615c875f1c05a177cc50550d32e125", "committedDate": "2020-09-03T07:50:05Z", "message": "Adding multivalued column support in Pinot connector"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyMDA1OTE5", "url": "https://github.com/prestodb/presto/pull/15093#pullrequestreview-482005919", "createdAt": "2020-09-03T16:22:43Z", "commit": {"oid": "78bb844385615c875f1c05a177cc50550d32e125"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxNjoyMjo0M1rOHMuTJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxNjoyMjo0M1rOHMuTJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzEwMzUyNg==", "bodyText": "super nit: Should this be a plain java comment ? Thanks for adding the comments !.", "url": "https://github.com/prestodb/presto/pull/15093#discussion_r483103526", "createdAt": "2020-09-03T16:22:43Z", "author": {"login": "agrawaldevesh"}, "path": "presto-pinot-toolkit/src/main/java/com/facebook/presto/pinot/PinotSegmentPageSource.java", "diffHunk": "@@ -295,6 +300,82 @@ else if (javaType.equals(Slice.class)) {\n         }\n     }\n \n+    private void writeArrayBlock(BlockBuilder blockBuilder, Type columnType, int columnIndex)\n+    {\n+        for (int rowIndex = 0; rowIndex < currentDataTable.getDataTable().getNumberOfRows(); rowIndex++) {\n+            ColumnDataType columnPinotType = currentDataTable.getDataTable().getDataSchema().getColumnDataType(columnIndex);\n+            Type columnPrestoType = ((ArrayType) columnType).getElementType();\n+            BlockBuilder childBuilder = blockBuilder.beginBlockEntry();\n+            switch (columnPinotType) {\n+                case INT_ARRAY:\n+                    int[] intArray = currentDataTable.getDataTable().getIntArray(rowIndex, columnIndex);\n+                    for (int i = 0; i < intArray.length; i++) {\n+                        /**", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78bb844385615c875f1c05a177cc50550d32e125"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d1eb7cc270912dbed9eb25290b230b5f572c7e6", "author": {"user": {"login": "dharakk", "name": "Dharak Kharod"}}, "url": "https://github.com/prestodb/presto/commit/6d1eb7cc270912dbed9eb25290b230b5f572c7e6", "committedDate": "2020-09-10T21:44:28Z", "message": "Adding multivalued column support in Pinot connector"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "78bb844385615c875f1c05a177cc50550d32e125", "author": {"user": {"login": "dharakk", "name": "Dharak Kharod"}}, "url": "https://github.com/prestodb/presto/commit/78bb844385615c875f1c05a177cc50550d32e125", "committedDate": "2020-09-03T07:50:05Z", "message": "Adding multivalued column support in Pinot connector"}, "afterCommit": {"oid": "6d1eb7cc270912dbed9eb25290b230b5f572c7e6", "author": {"user": {"login": "dharakk", "name": "Dharak Kharod"}}, "url": "https://github.com/prestodb/presto/commit/6d1eb7cc270912dbed9eb25290b230b5f572c7e6", "committedDate": "2020-09-10T21:44:28Z", "message": "Adding multivalued column support in Pinot connector"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MTYxMjM1", "url": "https://github.com/prestodb/presto/pull/15093#pullrequestreview-487161235", "createdAt": "2020-09-11T22:41:54Z", "commit": {"oid": "6d1eb7cc270912dbed9eb25290b230b5f572c7e6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MTc3OTkw", "url": "https://github.com/prestodb/presto/pull/15093#pullrequestreview-487177990", "createdAt": "2020-09-11T23:50:39Z", "commit": {"oid": "6d1eb7cc270912dbed9eb25290b230b5f572c7e6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 21, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}