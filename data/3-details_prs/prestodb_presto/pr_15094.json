{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc1MDM4NTgw", "number": 15094, "title": "Add config property for min spark partition count", "bodyText": "Implementation choice:\nWhen number of splits are less than min_partition_count, every partition is required to have at least one split. Therefore,  actual partition count <= number of splits\n== NO RELEASE NOTE ==", "createdAt": "2020-08-28T01:44:05Z", "url": "https://github.com/prestodb/presto/pull/15094", "merged": true, "mergeCommit": {"oid": "21c9c62b11afec44bd9d4385f67c73c5d0e37535"}, "closed": true, "closedAt": "2020-08-31T22:52:04Z", "author": {"login": "viczhang861"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdDPGquABqjM3MDI1NzI3MDc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdEUMWBgFqTQ3ODY5NTk3OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b2e97aefaa7e07b07711447b36c6c32c29ab2f8d", "author": {"user": {"login": "viczhang861", "name": "Vic Zhang"}}, "url": "https://github.com/prestodb/presto/commit/b2e97aefaa7e07b07711447b36c6c32c29ab2f8d", "committedDate": "2020-08-28T01:38:36Z", "message": "Add config property for min spark partition count"}, "afterCommit": {"oid": "6fbecde62fd8edb30e7408c9fd7cbe5d7551ce7e", "author": {"user": {"login": "viczhang861", "name": "Vic Zhang"}}, "url": "https://github.com/prestodb/presto/commit/6fbecde62fd8edb30e7408c9fd7cbe5d7551ce7e", "committedDate": "2020-08-28T06:34:13Z", "message": "Update Presto on Spark splits assignment test\n\nAssertion does not hold after introducing property\n`max_spark_input_partition_count_for_auto_tune` for auto tune."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4MjM0NjM4", "url": "https://github.com/prestodb/presto/pull/15094#pullrequestreview-478234638", "createdAt": "2020-08-30T21:13:27Z", "commit": {"oid": "93ecc884e18a35404098f87fe4b8fdfec787f6f0"}, "state": "DISMISSED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMFQyMToxMzoyN1rOHJlqZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMFQyMToxMzoyN1rOHJlqZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTgxNjI5NQ==", "bodyText": "nit: perhaps also check minPartitionCount is at least 1?", "url": "https://github.com/prestodb/presto/pull/15094#discussion_r479816295", "createdAt": "2020-08-30T21:13:27Z", "author": {"login": "wenleix"}, "path": "presto-spark-base/src/main/java/com/facebook/presto/spark/planner/PrestoSparkRddFactory.java", "diffHunk": "@@ -437,13 +438,18 @@ private PrestoSparkTaskSourceRdd createTaskSourcesRdd(\n         int partitionCount = 0;\n         boolean autoTunePartitionCount = isSparkPartitionCountAutoTuneEnabled(session);\n         if (autoTunePartitionCount) {\n+            int minPartitionCount = getMinSparkInputPartitionCountForAutoTune(session);\n             int maxPartitionCount = getMaxSparkInputPartitionCountForAutoTune(session);\n+            checkArgument(minPartitionCount <= maxPartitionCount,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93ecc884e18a35404098f87fe4b8fdfec787f6f0"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4MjM0ODk2", "url": "https://github.com/prestodb/presto/pull/15094#pullrequestreview-478234896", "createdAt": "2020-08-30T21:17:24Z", "commit": {"oid": "6fbecde62fd8edb30e7408c9fd7cbe5d7551ce7e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMFQyMToxNzoyNFrOHJlr9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMFQyMToxNzoyNFrOHJlr9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTgxNjY5Mw==", "bodyText": "I see. This essentially says, we only want to append to the existing partition if partitionCount is already large than minPartitionCount... Otherwise always create new partition.", "url": "https://github.com/prestodb/presto/pull/15094#discussion_r479816693", "createdAt": "2020-08-30T21:17:24Z", "author": {"login": "wenleix"}, "path": "presto-spark-base/src/main/java/com/facebook/presto/spark/planner/PrestoSparkRddFactory.java", "diffHunk": "@@ -437,13 +438,18 @@ private PrestoSparkTaskSourceRdd createTaskSourcesRdd(\n         int partitionCount = 0;\n         boolean autoTunePartitionCount = isSparkPartitionCountAutoTuneEnabled(session);\n         if (autoTunePartitionCount) {\n+            int minPartitionCount = getMinSparkInputPartitionCountForAutoTune(session);\n             int maxPartitionCount = getMaxSparkInputPartitionCountForAutoTune(session);\n+            checkArgument(minPartitionCount <= maxPartitionCount,\n+                    \"Min partition count for auto tune %s, cannot be larger than max partition count %s\",\n+                    minPartitionCount,\n+                    maxPartitionCount);\n \n             for (int splitIndex = 0; splitIndex < splits.size(); splitIndex++) {\n                 int partitionId;\n                 long splitSizeInBytes = splits.get(splitIndex).getSplit().getConnectorSplit().getSplitSizeInBytes().getAsLong();\n \n-                if ((!queue.isEmpty() && queue.peek().getSplitsInBytes() + splitSizeInBytes <= maxSplitsSizeInBytesPerPartition)\n+                if ((partitionCount >= minPartitionCount && queue.peek().getSplitsInBytes() + splitSizeInBytes <= maxSplitsSizeInBytesPerPartition)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6fbecde62fd8edb30e7408c9fd7cbe5d7551ce7e"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4MjM1MzQ3", "url": "https://github.com/prestodb/presto/pull/15094#pullrequestreview-478235347", "createdAt": "2020-08-30T21:25:35Z", "commit": {"oid": "6fbecde62fd8edb30e7408c9fd7cbe5d7551ce7e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7df5e23dc09a4a83a8a0cee2ef03cd1807bc3ae", "author": {"user": {"login": "viczhang861", "name": "Vic Zhang"}}, "url": "https://github.com/prestodb/presto/commit/c7df5e23dc09a4a83a8a0cee2ef03cd1807bc3ae", "committedDate": "2020-08-31T14:23:32Z", "message": "Add config property for min spark partition count"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c6ad16d947f47930d1c44b1ccfa9b1ac22da13a", "author": {"user": {"login": "viczhang861", "name": "Vic Zhang"}}, "url": "https://github.com/prestodb/presto/commit/7c6ad16d947f47930d1c44b1ccfa9b1ac22da13a", "committedDate": "2020-08-31T14:23:55Z", "message": "Update Presto on Spark splits assignment test\n\nAssertion does not hold after introducing property\n`max_spark_input_partition_count_for_auto_tune` for auto tune."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6fbecde62fd8edb30e7408c9fd7cbe5d7551ce7e", "author": {"user": {"login": "viczhang861", "name": "Vic Zhang"}}, "url": "https://github.com/prestodb/presto/commit/6fbecde62fd8edb30e7408c9fd7cbe5d7551ce7e", "committedDate": "2020-08-28T06:34:13Z", "message": "Update Presto on Spark splits assignment test\n\nAssertion does not hold after introducing property\n`max_spark_input_partition_count_for_auto_tune` for auto tune."}, "afterCommit": {"oid": "7c6ad16d947f47930d1c44b1ccfa9b1ac22da13a", "author": {"user": {"login": "viczhang861", "name": "Vic Zhang"}}, "url": "https://github.com/prestodb/presto/commit/7c6ad16d947f47930d1c44b1ccfa9b1ac22da13a", "committedDate": "2020-08-31T14:23:55Z", "message": "Update Presto on Spark splits assignment test\n\nAssertion does not hold after introducing property\n`max_spark_input_partition_count_for_auto_tune` for auto tune."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4Njk1OTc5", "url": "https://github.com/prestodb/presto/pull/15094#pullrequestreview-478695979", "createdAt": "2020-08-31T15:04:31Z", "commit": {"oid": "7c6ad16d947f47930d1c44b1ccfa9b1ac22da13a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 24, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}