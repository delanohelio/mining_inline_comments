{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgzODAzODA2", "number": 14209, "title": "Add nodeSelectionStats to monitor affinity scheduler", "bodyText": "== NO RELEASE NOTE ==", "createdAt": "2020-03-04T19:16:50Z", "url": "https://github.com/prestodb/presto/pull/14209", "merged": true, "mergeCommit": {"oid": "411b5c64aa00f655a50fe3d819082a024e7c5f99"}, "closed": true, "closedAt": "2020-03-07T02:03:10Z", "author": {"login": "kewang1024"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKdzuQAFqTM2OTEzMTU4Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcLHnYcABqjMxMDcwNDA0OTA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MTMxNTg3", "url": "https://github.com/prestodb/presto/pull/14209#pullrequestreview-369131587", "createdAt": "2020-03-04T21:21:21Z", "commit": {"oid": "bcb9d30d85ae7e86348108090eef0ca53e98fadc"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMToyMToyMVrOFx-ENg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMToyODo1N1rOFx-SYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk0MTQzMA==", "bodyText": "remove this empty line", "url": "https://github.com/prestodb/presto/pull/14209#discussion_r387941430", "createdAt": "2020-03-04T21:21:21Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/scheduler/nodeSelection/SimpleNodeSelector.java", "diffHunk": "@@ -70,6 +70,8 @@\n     private final int maxPendingSplitsPerTask;\n     private final int maxTasksPerStage;\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcb9d30d85ae7e86348108090eef0ca53e98fadc"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk0MTU3Mw==", "bodyText": "move this below nodeManager", "url": "https://github.com/prestodb/presto/pull/14209#discussion_r387941573", "createdAt": "2020-03-04T21:21:41Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/scheduler/nodeSelection/SimpleNodeSelector.java", "diffHunk": "@@ -70,6 +70,8 @@\n     private final int maxPendingSplitsPerTask;\n     private final int maxTasksPerStage;\n \n+    private final NodeSelectionStats nodeSelectionStats;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcb9d30d85ae7e86348108090eef0ca53e98fadc"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk0MTYzOQ==", "bodyText": "move this below nodeManager", "url": "https://github.com/prestodb/presto/pull/14209#discussion_r387941639", "createdAt": "2020-03-04T21:21:48Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/scheduler/nodeSelection/SimpleNodeSelector.java", "diffHunk": "@@ -78,7 +80,8 @@ public SimpleNodeSelector(\n             int minCandidates,\n             int maxSplitsPerNode,\n             int maxPendingSplitsPerTask,\n-            int maxTasksPerStage)\n+            int maxTasksPerStage,\n+            NodeSelectionStats nodeSelectionStats)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcb9d30d85ae7e86348108090eef0ca53e98fadc"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk0MTcwMw==", "bodyText": "same", "url": "https://github.com/prestodb/presto/pull/14209#discussion_r387941703", "createdAt": "2020-03-04T21:21:57Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/scheduler/nodeSelection/SimpleNodeSelector.java", "diffHunk": "@@ -88,6 +91,7 @@ public SimpleNodeSelector(\n         this.maxSplitsPerNode = maxSplitsPerNode;\n         this.maxPendingSplitsPerTask = maxPendingSplitsPerTask;\n         this.maxTasksPerStage = maxTasksPerStage;\n+        this.nodeSelectionStats = requireNonNull(nodeSelectionStats, \"NodeSelectionStats is null\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcb9d30d85ae7e86348108090eef0ca53e98fadc"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk0MjI2Mw==", "bodyText": "same", "url": "https://github.com/prestodb/presto/pull/14209#discussion_r387942263", "createdAt": "2020-03-04T21:23:03Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/scheduler/NodeScheduler.java", "diffHunk": "@@ -74,11 +75,12 @@\n     private final NodeTaskMap nodeTaskMap;\n     private final boolean useNetworkTopology;\n     private final Duration nodeMapRefreshInterval;\n+    private final NodeSelectionStats nodeSelectionStats;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcb9d30d85ae7e86348108090eef0ca53e98fadc"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk0NDU1OA==", "bodyText": "We shall give better names to these stats: (I'm not an expert on naming; maybe @shixuan-fan can give suggestions)\nprimaryPreferredNodeSelectedCount\nsecondaryPreferredNodeSelectedCount\nnonPreferredNodeSelectedCount", "url": "https://github.com/prestodb/presto/pull/14209#discussion_r387944558", "createdAt": "2020-03-04T21:27:48Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/scheduler/nodeSelection/NodeSelectionStats.java", "diffHunk": "@@ -0,0 +1,61 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.execution.scheduler.nodeSelection;\n+\n+import org.weakref.jmx.Managed;\n+\n+import javax.annotation.concurrent.ThreadSafe;\n+\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+@ThreadSafe\n+public class NodeSelectionStats\n+{\n+    private final AtomicLong primaryHit = new AtomicLong();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcb9d30d85ae7e86348108090eef0ca53e98fadc"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk0NTA1OQ==", "bodyText": "This class indicates hard assumption on \"we only have 2 preferred nodes and all other selections are random\". I'm ok with this for now. @shixuan-fan, do you have better suggestions?", "url": "https://github.com/prestodb/presto/pull/14209#discussion_r387945059", "createdAt": "2020-03-04T21:28:57Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/scheduler/nodeSelection/NodeSelectionStats.java", "diffHunk": "@@ -0,0 +1,61 @@\n+/*\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.facebook.presto.execution.scheduler.nodeSelection;\n+\n+import org.weakref.jmx.Managed;\n+\n+import javax.annotation.concurrent.ThreadSafe;\n+\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+@ThreadSafe\n+public class NodeSelectionStats", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcb9d30d85ae7e86348108090eef0ca53e98fadc"}, "originalPosition": 23}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bcb9d30d85ae7e86348108090eef0ca53e98fadc", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/bcb9d30d85ae7e86348108090eef0ca53e98fadc", "committedDate": "2020-03-04T18:51:11Z", "message": "Add nodeSelectionStats to monitor affinity scheduler"}, "afterCommit": {"oid": "9c7d100e082c6b5b5c546fd39ad3967118f5989f", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/9c7d100e082c6b5b5c546fd39ad3967118f5989f", "committedDate": "2020-03-05T19:59:04Z", "message": "Add nodeSelectionStats to monitor affinity scheduler"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9c7d100e082c6b5b5c546fd39ad3967118f5989f", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/9c7d100e082c6b5b5c546fd39ad3967118f5989f", "committedDate": "2020-03-05T19:59:04Z", "message": "Add nodeSelectionStats to monitor affinity scheduler"}, "afterCommit": {"oid": "c414b6385f6820126fe0dea4aad9d87f1498fd24", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/c414b6385f6820126fe0dea4aad9d87f1498fd24", "committedDate": "2020-03-06T07:24:58Z", "message": "Add nodeSelectionStats to monitor affinity scheduler"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c414b6385f6820126fe0dea4aad9d87f1498fd24", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/c414b6385f6820126fe0dea4aad9d87f1498fd24", "committedDate": "2020-03-06T07:24:58Z", "message": "Add nodeSelectionStats to monitor affinity scheduler"}, "afterCommit": {"oid": "5b3388028711a66a1901ebf618b7a1a743b77296", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/5b3388028711a66a1901ebf618b7a1a743b77296", "committedDate": "2020-03-06T07:33:03Z", "message": "Add nodeSelectionStats to monitor affinity scheduler"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNTIyNzYy", "url": "https://github.com/prestodb/presto/pull/14209#pullrequestreview-370522762", "createdAt": "2020-03-06T18:08:09Z", "commit": {"oid": "5b3388028711a66a1901ebf618b7a1a743b77296"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxODowODowOVrOFzCUyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxODoxMDoyNlrOFzCYug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTA1OTc4Ng==", "bodyText": "I'm not entirely sure if we should keep it static and pass stats in, or remove static. @highker: Any suggestion?", "url": "https://github.com/prestodb/presto/pull/14209#discussion_r389059786", "createdAt": "2020-03-06T18:08:09Z", "author": {"login": "shixuan-fan"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/scheduler/nodeSelection/SimpleNodeSelector.java", "diffHunk": "@@ -196,7 +199,7 @@ public SplitPlacementResult computeAssignments(Set<Split> splits, List<RemoteTas\n         return selectDistributionNodes(nodeMap.get().get(), nodeTaskMap, maxSplitsPerNode, maxPendingSplitsPerTask, splits, existingTasks, bucketNodeMap);\n     }\n \n-    private static Optional<InternalNodeInfo> chooseLeastBusyNode(List<InternalNode> candidateNodes, Function<InternalNode, Integer> splitCountProvider, OptionalInt preferredNodeCount, int maxSplitCount)\n+    private Optional<InternalNodeInfo> chooseLeastBusyNode(List<InternalNode> candidateNodes, Function<InternalNode, Integer> splitCountProvider, OptionalInt preferredNodeCount, int maxSplitCount)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b3388028711a66a1901ebf618b7a1a743b77296"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTA2MDc5NA==", "bodyText": "Would you need a getter for this class to ensure it could be exposed to jmx?", "url": "https://github.com/prestodb/presto/pull/14209#discussion_r389060794", "createdAt": "2020-03-06T18:10:26Z", "author": {"login": "shixuan-fan"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/scheduler/NodeScheduler.java", "diffHunk": "@@ -67,6 +68,7 @@\n     private final List<CounterStat> topologicalSplitCounters;\n     private final List<String> networkLocationSegmentNames;\n     private final InternalNodeManager nodeManager;\n+    private final NodeSelectionStats nodeSelectionStats;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b3388028711a66a1901ebf618b7a1a743b77296"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNTc0ODM2", "url": "https://github.com/prestodb/presto/pull/14209#pullrequestreview-370574836", "createdAt": "2020-03-06T19:34:03Z", "commit": {"oid": "5b3388028711a66a1901ebf618b7a1a743b77296"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxOTozNDowNFrOFzEy-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxOTozNDowNFrOFzEy-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTEwMDI4MA==", "bodyText": "\"nodeSelectionStats is null\"", "url": "https://github.com/prestodb/presto/pull/14209#discussion_r389100280", "createdAt": "2020-03-06T19:34:04Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/execution/scheduler/nodeSelection/SimpleNodeSelector.java", "diffHunk": "@@ -80,6 +82,7 @@ public SimpleNodeSelector(\n             int maxTasksPerStage)\n     {\n         this.nodeManager = requireNonNull(nodeManager, \"nodeManager is null\");\n+        this.nodeSelectionStats = requireNonNull(nodeSelectionStats, \"NodeSelectionStats is null\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b3388028711a66a1901ebf618b7a1a743b77296"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25f2fbd101afeab243143eee3981f78c2ba99a6f", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/25f2fbd101afeab243143eee3981f78c2ba99a6f", "committedDate": "2020-03-06T22:11:12Z", "message": "Add nodeSelectionStats to monitor affinity scheduler"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5b3388028711a66a1901ebf618b7a1a743b77296", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/5b3388028711a66a1901ebf618b7a1a743b77296", "committedDate": "2020-03-06T07:33:03Z", "message": "Add nodeSelectionStats to monitor affinity scheduler"}, "afterCommit": {"oid": "25f2fbd101afeab243143eee3981f78c2ba99a6f", "author": {"user": {"login": "kewang1024", "name": "Ke"}}, "url": "https://github.com/prestodb/presto/commit/25f2fbd101afeab243143eee3981f78c2ba99a6f", "committedDate": "2020-03-06T22:11:12Z", "message": "Add nodeSelectionStats to monitor affinity scheduler"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1977, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}