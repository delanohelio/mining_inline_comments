{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU5MDk3ODY4", "number": 13923, "title": "Move OptimizeMixedDistinctAggregations below Logical Optimization", "bodyText": "== NO RELEASE NOTE ==\n\nThis has no fb production impact so hard to test for general case.", "createdAt": "2020-01-03T19:33:05Z", "url": "https://github.com/prestodb/presto/pull/13923", "merged": true, "mergeCommit": {"oid": "f94809283ac923eeeb0152f27f64039646d1c49f"}, "closed": true, "closedAt": "2020-01-09T07:06:48Z", "author": {"login": "sachdevs"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb2znefgBqjI5MjEwNDM5OTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb4fMcMABqjI5MzMyMzMxODg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9105feb4d5b796d7e905f152b693540c895e02dd", "author": {"user": {"login": "sachdevs", "name": "Saksham"}}, "url": "https://github.com/prestodb/presto/commit/9105feb4d5b796d7e905f152b693540c895e02dd", "committedDate": "2020-01-03T19:30:45Z", "message": "Refactor OptimizeMixedDistinctAggregations to use RowExpressions and move it below logical optimization"}, "afterCommit": {"oid": "38ecc7a96780ffbcadc4c6cb1237c074aad2f9b5", "author": {"user": {"login": "sachdevs", "name": "Saksham"}}, "url": "https://github.com/prestodb/presto/commit/38ecc7a96780ffbcadc4c6cb1237c074aad2f9b5", "committedDate": "2020-01-03T19:34:51Z", "message": "Refactor OptimizeMixedDistinctAggregations to use RowExpressions and move it below logical optimization"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "38ecc7a96780ffbcadc4c6cb1237c074aad2f9b5", "author": {"user": {"login": "sachdevs", "name": "Saksham"}}, "url": "https://github.com/prestodb/presto/commit/38ecc7a96780ffbcadc4c6cb1237c074aad2f9b5", "committedDate": "2020-01-03T19:34:51Z", "message": "Refactor OptimizeMixedDistinctAggregations to use RowExpressions and move it below logical optimization"}, "afterCommit": {"oid": "99cac85e1bc05066e1332022d59d69aa0429a68a", "author": {"user": {"login": "sachdevs", "name": "Saksham"}}, "url": "https://github.com/prestodb/presto/commit/99cac85e1bc05066e1332022d59d69aa0429a68a", "committedDate": "2020-01-03T19:47:02Z", "message": "Refactor OptimizeMixedDistinctAggregations to use RowExpressions and move it below logical optimization"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4NDc1Njg2", "url": "https://github.com/prestodb/presto/pull/13923#pullrequestreview-338475686", "createdAt": "2020-01-06T05:43:27Z", "commit": {"oid": "99cac85e1bc05066e1332022d59d69aa0429a68a"}, "state": "COMMENTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQwNTo0MzoyN1rOFaV0tQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQwNTo1NzoxMVrOFaV9Ew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE2NDg1Mw==", "bodyText": "requireNonNull", "url": "https://github.com/prestodb/presto/pull/13923#discussion_r363164853", "createdAt": "2020-01-06T05:43:27Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/optimizations/OptimizeMixedDistinctAggregations.java", "diffHunk": "@@ -109,12 +104,14 @@ public PlanNode optimize(PlanNode plan, Session session, TypeProvider types, Pla\n         private final PlanNodeIdAllocator idAllocator;\n         private final PlanVariableAllocator variableAllocator;\n         private final Metadata metadata;\n+        private final StandardFunctionResolution functionResolution;\n \n-        private Optimizer(PlanNodeIdAllocator idAllocator, PlanVariableAllocator variableAllocator, Metadata metadata)\n+        private Optimizer(PlanNodeIdAllocator idAllocator, PlanVariableAllocator variableAllocator, Metadata metadata, StandardFunctionResolution functionResolution)\n         {\n             this.idAllocator = requireNonNull(idAllocator, \"idAllocator is null\");\n             this.variableAllocator = requireNonNull(variableAllocator, \"variableAllocator is null\");\n             this.metadata = requireNonNull(metadata, \"metadata is null\");\n+            this.functionResolution = functionResolution;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99cac85e1bc05066e1332022d59d69aa0429a68a"}, "originalPosition": 100}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE2NTA5Mw==", "bodyText": "nit\nRowExpression expression = new SpecialFormExpression(COALESCE, BIGINT, variable, constant(0L, BIGINT));", "url": "https://github.com/prestodb/presto/pull/13923#discussion_r363165093", "createdAt": "2020-01-06T05:45:12Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/optimizations/OptimizeMixedDistinctAggregations.java", "diffHunk": "@@ -225,11 +221,11 @@ public PlanNode visitAggregation(AggregationNode node, RewriteContext<Optional<A\n             Assignments.Builder outputVariables = Assignments.builder();\n             for (VariableReferenceExpression variable : aggregationNode.getOutputVariables()) {\n                 if (coalesceVariables.containsKey(variable)) {\n-                    Expression expression = new CoalesceExpression(new SymbolReference(variable.getName()), new Cast(new LongLiteral(\"0\"), \"bigint\"));\n-                    outputVariables.put(coalesceVariables.get(variable), castToRowExpression(expression));\n+                    SpecialFormExpression coalesce = new SpecialFormExpression(COALESCE, BIGINT, variable, new ConstantExpression(Long.valueOf(0), BIGINT));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99cac85e1bc05066e1332022d59d69aa0429a68a"}, "originalPosition": 138}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE2NTY4Ng==", "bodyText": "constant(1L, BIGINT)", "url": "https://github.com/prestodb/presto/pull/13923#discussion_r363165686", "createdAt": "2020-01-06T05:49:06Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/optimizations/OptimizeMixedDistinctAggregations.java", "diffHunk": "@@ -349,37 +345,47 @@ private ProjectNode createProjectNode(\n                     VariableReferenceExpression newVariable = variableAllocator.newVariable(\"expr\", variable.getType());\n                     aggregateInfo.setNewDistinctAggregateSymbol(newVariable);\n \n-                    Expression expression = createIfExpression(\n-                            new SymbolReference(groupVariable.getName()),\n-                            new Cast(new LongLiteral(\"1\"), \"bigint\"), // TODO: this should use GROUPING() when that's available instead of relying on specific group numbering\n-                            ComparisonExpression.Operator.EQUAL,\n-                            new SymbolReference(variable.getName()),\n-                            variable.getType());\n-                    outputVariables.put(newVariable, castToRowExpression(expression));\n+                    SpecialFormExpression ifExpression = new SpecialFormExpression(\n+                            IF,\n+                            variable.getType(),\n+                            ImmutableList.of(\n+                                    new CallExpression(\n+                                            EQUAL.name(),\n+                                            functionResolution.comparisonFunction(EQUAL, BIGINT, BIGINT),\n+                                            BOOLEAN,\n+                                            ImmutableList.of(groupVariable, new ConstantExpression(Long.valueOf(1), BIGINT))), // TODO: this should use GROUPING()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99cac85e1bc05066e1332022d59d69aa0429a68a"}, "originalPosition": 175}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE2NTcyNA==", "bodyText": "same", "url": "https://github.com/prestodb/presto/pull/13923#discussion_r363165724", "createdAt": "2020-01-06T05:49:23Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/optimizations/OptimizeMixedDistinctAggregations.java", "diffHunk": "@@ -349,37 +345,47 @@ private ProjectNode createProjectNode(\n                     VariableReferenceExpression newVariable = variableAllocator.newVariable(\"expr\", variable.getType());\n                     aggregateInfo.setNewDistinctAggregateSymbol(newVariable);\n \n-                    Expression expression = createIfExpression(\n-                            new SymbolReference(groupVariable.getName()),\n-                            new Cast(new LongLiteral(\"1\"), \"bigint\"), // TODO: this should use GROUPING() when that's available instead of relying on specific group numbering\n-                            ComparisonExpression.Operator.EQUAL,\n-                            new SymbolReference(variable.getName()),\n-                            variable.getType());\n-                    outputVariables.put(newVariable, castToRowExpression(expression));\n+                    SpecialFormExpression ifExpression = new SpecialFormExpression(\n+                            IF,\n+                            variable.getType(),\n+                            ImmutableList.of(\n+                                    new CallExpression(\n+                                            EQUAL.name(),\n+                                            functionResolution.comparisonFunction(EQUAL, BIGINT, BIGINT),\n+                                            BOOLEAN,\n+                                            ImmutableList.of(groupVariable, new ConstantExpression(Long.valueOf(1), BIGINT))), // TODO: this should use GROUPING()\n+                                    variable,\n+                                    constantNull(variable.getType())));\n+                    outputVariables.put(newVariable, ifExpression);\n                 }\n                 else if (aggregationOutputVariablesMap.containsKey(variable)) {\n                     VariableReferenceExpression newVariable = variableAllocator.newVariable(\"expr\", variable.getType());\n                     // key of outputNonDistinctAggregateSymbols is key of an aggregation in AggrNode above, it will now aggregate on this Map's value\n                     outputNonDistinctAggregateVariables.put(aggregationOutputVariablesMap.get(variable), newVariable);\n-                    Expression expression = createIfExpression(\n-                            new SymbolReference(groupVariable.getName()),\n-                            new Cast(new LongLiteral(\"0\"), \"bigint\"), // TODO: this should use GROUPING() when that's available instead of relying on specific group numbering\n-                            ComparisonExpression.Operator.EQUAL,\n-                            new SymbolReference(variable.getName()),\n-                            variable.getType());\n-                    outputVariables.put(newVariable, castToRowExpression(expression));\n+\n+                    SpecialFormExpression ifExpression = new SpecialFormExpression(\n+                            IF,\n+                            variable.getType(),\n+                            ImmutableList.of(\n+                                    new CallExpression(\n+                                            EQUAL.name(),\n+                                            functionResolution.comparisonFunction(EQUAL, BIGINT, BIGINT),\n+                                            BOOLEAN,\n+                                            ImmutableList.of(groupVariable, new ConstantExpression(Long.valueOf(0), BIGINT))), // TODO: this should use GROUPING()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99cac85e1bc05066e1332022d59d69aa0429a68a"}, "originalPosition": 200}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE2NjM1OQ==", "bodyText": "RowExpression", "url": "https://github.com/prestodb/presto/pull/13923#discussion_r363166359", "createdAt": "2020-01-06T05:53:27Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/optimizations/OptimizeMixedDistinctAggregations.java", "diffHunk": "@@ -349,37 +345,47 @@ private ProjectNode createProjectNode(\n                     VariableReferenceExpression newVariable = variableAllocator.newVariable(\"expr\", variable.getType());\n                     aggregateInfo.setNewDistinctAggregateSymbol(newVariable);\n \n-                    Expression expression = createIfExpression(\n-                            new SymbolReference(groupVariable.getName()),\n-                            new Cast(new LongLiteral(\"1\"), \"bigint\"), // TODO: this should use GROUPING() when that's available instead of relying on specific group numbering\n-                            ComparisonExpression.Operator.EQUAL,\n-                            new SymbolReference(variable.getName()),\n-                            variable.getType());\n-                    outputVariables.put(newVariable, castToRowExpression(expression));\n+                    SpecialFormExpression ifExpression = new SpecialFormExpression(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99cac85e1bc05066e1332022d59d69aa0429a68a"}, "originalPosition": 167}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE2NjM4MQ==", "bodyText": "same", "url": "https://github.com/prestodb/presto/pull/13923#discussion_r363166381", "createdAt": "2020-01-06T05:53:33Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/optimizations/OptimizeMixedDistinctAggregations.java", "diffHunk": "@@ -349,37 +345,47 @@ private ProjectNode createProjectNode(\n                     VariableReferenceExpression newVariable = variableAllocator.newVariable(\"expr\", variable.getType());\n                     aggregateInfo.setNewDistinctAggregateSymbol(newVariable);\n \n-                    Expression expression = createIfExpression(\n-                            new SymbolReference(groupVariable.getName()),\n-                            new Cast(new LongLiteral(\"1\"), \"bigint\"), // TODO: this should use GROUPING() when that's available instead of relying on specific group numbering\n-                            ComparisonExpression.Operator.EQUAL,\n-                            new SymbolReference(variable.getName()),\n-                            variable.getType());\n-                    outputVariables.put(newVariable, castToRowExpression(expression));\n+                    SpecialFormExpression ifExpression = new SpecialFormExpression(\n+                            IF,\n+                            variable.getType(),\n+                            ImmutableList.of(\n+                                    new CallExpression(\n+                                            EQUAL.name(),\n+                                            functionResolution.comparisonFunction(EQUAL, BIGINT, BIGINT),\n+                                            BOOLEAN,\n+                                            ImmutableList.of(groupVariable, new ConstantExpression(Long.valueOf(1), BIGINT))), // TODO: this should use GROUPING()\n+                                    variable,\n+                                    constantNull(variable.getType())));\n+                    outputVariables.put(newVariable, ifExpression);\n                 }\n                 else if (aggregationOutputVariablesMap.containsKey(variable)) {\n                     VariableReferenceExpression newVariable = variableAllocator.newVariable(\"expr\", variable.getType());\n                     // key of outputNonDistinctAggregateSymbols is key of an aggregation in AggrNode above, it will now aggregate on this Map's value\n                     outputNonDistinctAggregateVariables.put(aggregationOutputVariablesMap.get(variable), newVariable);\n-                    Expression expression = createIfExpression(\n-                            new SymbolReference(groupVariable.getName()),\n-                            new Cast(new LongLiteral(\"0\"), \"bigint\"), // TODO: this should use GROUPING() when that's available instead of relying on specific group numbering\n-                            ComparisonExpression.Operator.EQUAL,\n-                            new SymbolReference(variable.getName()),\n-                            variable.getType());\n-                    outputVariables.put(newVariable, castToRowExpression(expression));\n+\n+                    SpecialFormExpression ifExpression = new SpecialFormExpression(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99cac85e1bc05066e1332022d59d69aa0429a68a"}, "originalPosition": 192}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE2NjUyMQ==", "bodyText": "comment \"when that's available instead of relying on specific group numbering\" gets lost", "url": "https://github.com/prestodb/presto/pull/13923#discussion_r363166521", "createdAt": "2020-01-06T05:54:21Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/optimizations/OptimizeMixedDistinctAggregations.java", "diffHunk": "@@ -349,37 +345,47 @@ private ProjectNode createProjectNode(\n                     VariableReferenceExpression newVariable = variableAllocator.newVariable(\"expr\", variable.getType());\n                     aggregateInfo.setNewDistinctAggregateSymbol(newVariable);\n \n-                    Expression expression = createIfExpression(\n-                            new SymbolReference(groupVariable.getName()),\n-                            new Cast(new LongLiteral(\"1\"), \"bigint\"), // TODO: this should use GROUPING() when that's available instead of relying on specific group numbering", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99cac85e1bc05066e1332022d59d69aa0429a68a"}, "originalPosition": 162}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE2NjUzOA==", "bodyText": "same", "url": "https://github.com/prestodb/presto/pull/13923#discussion_r363166538", "createdAt": "2020-01-06T05:54:27Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/optimizations/OptimizeMixedDistinctAggregations.java", "diffHunk": "@@ -349,37 +345,47 @@ private ProjectNode createProjectNode(\n                     VariableReferenceExpression newVariable = variableAllocator.newVariable(\"expr\", variable.getType());\n                     aggregateInfo.setNewDistinctAggregateSymbol(newVariable);\n \n-                    Expression expression = createIfExpression(\n-                            new SymbolReference(groupVariable.getName()),\n-                            new Cast(new LongLiteral(\"1\"), \"bigint\"), // TODO: this should use GROUPING() when that's available instead of relying on specific group numbering\n-                            ComparisonExpression.Operator.EQUAL,\n-                            new SymbolReference(variable.getName()),\n-                            variable.getType());\n-                    outputVariables.put(newVariable, castToRowExpression(expression));\n+                    SpecialFormExpression ifExpression = new SpecialFormExpression(\n+                            IF,\n+                            variable.getType(),\n+                            ImmutableList.of(\n+                                    new CallExpression(\n+                                            EQUAL.name(),\n+                                            functionResolution.comparisonFunction(EQUAL, BIGINT, BIGINT),\n+                                            BOOLEAN,\n+                                            ImmutableList.of(groupVariable, new ConstantExpression(Long.valueOf(1), BIGINT))), // TODO: this should use GROUPING()\n+                                    variable,\n+                                    constantNull(variable.getType())));\n+                    outputVariables.put(newVariable, ifExpression);\n                 }\n                 else if (aggregationOutputVariablesMap.containsKey(variable)) {\n                     VariableReferenceExpression newVariable = variableAllocator.newVariable(\"expr\", variable.getType());\n                     // key of outputNonDistinctAggregateSymbols is key of an aggregation in AggrNode above, it will now aggregate on this Map's value\n                     outputNonDistinctAggregateVariables.put(aggregationOutputVariablesMap.get(variable), newVariable);\n-                    Expression expression = createIfExpression(\n-                            new SymbolReference(groupVariable.getName()),\n-                            new Cast(new LongLiteral(\"0\"), \"bigint\"), // TODO: this should use GROUPING() when that's available instead of relying on specific group numbering", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99cac85e1bc05066e1332022d59d69aa0429a68a"}, "originalPosition": 186}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE2NjY0MA==", "bodyText": "Use call(...)", "url": "https://github.com/prestodb/presto/pull/13923#discussion_r363166640", "createdAt": "2020-01-06T05:55:04Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/optimizations/OptimizeMixedDistinctAggregations.java", "diffHunk": "@@ -349,37 +345,47 @@ private ProjectNode createProjectNode(\n                     VariableReferenceExpression newVariable = variableAllocator.newVariable(\"expr\", variable.getType());\n                     aggregateInfo.setNewDistinctAggregateSymbol(newVariable);\n \n-                    Expression expression = createIfExpression(\n-                            new SymbolReference(groupVariable.getName()),\n-                            new Cast(new LongLiteral(\"1\"), \"bigint\"), // TODO: this should use GROUPING() when that's available instead of relying on specific group numbering\n-                            ComparisonExpression.Operator.EQUAL,\n-                            new SymbolReference(variable.getName()),\n-                            variable.getType());\n-                    outputVariables.put(newVariable, castToRowExpression(expression));\n+                    SpecialFormExpression ifExpression = new SpecialFormExpression(\n+                            IF,\n+                            variable.getType(),\n+                            ImmutableList.of(\n+                                    new CallExpression(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99cac85e1bc05066e1332022d59d69aa0429a68a"}, "originalPosition": 171}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE2NjY2Mw==", "bodyText": "same", "url": "https://github.com/prestodb/presto/pull/13923#discussion_r363166663", "createdAt": "2020-01-06T05:55:11Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/optimizations/OptimizeMixedDistinctAggregations.java", "diffHunk": "@@ -349,37 +345,47 @@ private ProjectNode createProjectNode(\n                     VariableReferenceExpression newVariable = variableAllocator.newVariable(\"expr\", variable.getType());\n                     aggregateInfo.setNewDistinctAggregateSymbol(newVariable);\n \n-                    Expression expression = createIfExpression(\n-                            new SymbolReference(groupVariable.getName()),\n-                            new Cast(new LongLiteral(\"1\"), \"bigint\"), // TODO: this should use GROUPING() when that's available instead of relying on specific group numbering\n-                            ComparisonExpression.Operator.EQUAL,\n-                            new SymbolReference(variable.getName()),\n-                            variable.getType());\n-                    outputVariables.put(newVariable, castToRowExpression(expression));\n+                    SpecialFormExpression ifExpression = new SpecialFormExpression(\n+                            IF,\n+                            variable.getType(),\n+                            ImmutableList.of(\n+                                    new CallExpression(\n+                                            EQUAL.name(),\n+                                            functionResolution.comparisonFunction(EQUAL, BIGINT, BIGINT),\n+                                            BOOLEAN,\n+                                            ImmutableList.of(groupVariable, new ConstantExpression(Long.valueOf(1), BIGINT))), // TODO: this should use GROUPING()\n+                                    variable,\n+                                    constantNull(variable.getType())));\n+                    outputVariables.put(newVariable, ifExpression);\n                 }\n                 else if (aggregationOutputVariablesMap.containsKey(variable)) {\n                     VariableReferenceExpression newVariable = variableAllocator.newVariable(\"expr\", variable.getType());\n                     // key of outputNonDistinctAggregateSymbols is key of an aggregation in AggrNode above, it will now aggregate on this Map's value\n                     outputNonDistinctAggregateVariables.put(aggregationOutputVariablesMap.get(variable), newVariable);\n-                    Expression expression = createIfExpression(\n-                            new SymbolReference(groupVariable.getName()),\n-                            new Cast(new LongLiteral(\"0\"), \"bigint\"), // TODO: this should use GROUPING() when that's available instead of relying on specific group numbering\n-                            ComparisonExpression.Operator.EQUAL,\n-                            new SymbolReference(variable.getName()),\n-                            variable.getType());\n-                    outputVariables.put(newVariable, castToRowExpression(expression));\n+\n+                    SpecialFormExpression ifExpression = new SpecialFormExpression(\n+                            IF,\n+                            variable.getType(),\n+                            ImmutableList.of(\n+                                    new CallExpression(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99cac85e1bc05066e1332022d59d69aa0429a68a"}, "originalPosition": 196}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE2Njk5NQ==", "bodyText": "move to previous line", "url": "https://github.com/prestodb/presto/pull/13923#discussion_r363166995", "createdAt": "2020-01-06T05:57:11Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/optimizations/OptimizeMixedDistinctAggregations.java", "diffHunk": "@@ -454,9 +460,9 @@ private AggregationNode createNonDistinctAggregation(\n                             extractVariables(entry.getValue().getArguments(), variableAllocator.getTypes()).contains(distinctVariable)) {\n                         ImmutableList.Builder<RowExpression> argumentsBuilder = ImmutableList.builder();\n                         for (RowExpression argument : aggregation.getArguments()) {\n-                            if (castToExpression(argument) instanceof SymbolReference &&\n-                                    toVariableReference(castToExpression(argument), variableAllocator.getTypes()).equals(distinctVariable)) {\n-                                argumentsBuilder.add(castToRowExpression(asSymbolReference(duplicatedDistinctVariable)));\n+                            if (argument instanceof VariableReferenceExpression &&\n+                                    argument.equals(distinctVariable)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99cac85e1bc05066e1332022d59d69aa0429a68a"}, "originalPosition": 229}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4NDc5ODY5", "url": "https://github.com/prestodb/presto/pull/13923#pullrequestreview-338479869", "createdAt": "2020-01-06T06:05:12Z", "commit": {"oid": "99cac85e1bc05066e1332022d59d69aa0429a68a"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "99cac85e1bc05066e1332022d59d69aa0429a68a", "author": {"user": {"login": "sachdevs", "name": "Saksham"}}, "url": "https://github.com/prestodb/presto/commit/99cac85e1bc05066e1332022d59d69aa0429a68a", "committedDate": "2020-01-03T19:47:02Z", "message": "Refactor OptimizeMixedDistinctAggregations to use RowExpressions and move it below logical optimization"}, "afterCommit": {"oid": "ebcd13e66b70834d5eb1a62b568bdf1bd47b2bdf", "author": {"user": {"login": "sachdevs", "name": "Saksham"}}, "url": "https://github.com/prestodb/presto/commit/ebcd13e66b70834d5eb1a62b568bdf1bd47b2bdf", "committedDate": "2020-01-08T19:40:25Z", "message": "Move OptimizeMixedDistinctAggregations below Logical Optimization"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwMDk5ODE4", "url": "https://github.com/prestodb/presto/pull/13923#pullrequestreview-340099818", "createdAt": "2020-01-08T19:42:05Z", "commit": {"oid": "ebcd13e66b70834d5eb1a62b568bdf1bd47b2bdf"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQxOTo0MjowNlrOFbhy0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQxOTo0Mjo0M1rOFbhzvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQwOTU1Mw==", "bodyText": "Use Expressions.constant", "url": "https://github.com/prestodb/presto/pull/13923#discussion_r364409553", "createdAt": "2020-01-08T19:42:06Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/optimizations/OptimizeMixedDistinctAggregations.java", "diffHunk": "@@ -225,11 +222,11 @@ public PlanNode visitAggregation(AggregationNode node, RewriteContext<Optional<A\n             Assignments.Builder outputVariables = Assignments.builder();\n             for (VariableReferenceExpression variable : aggregationNode.getOutputVariables()) {\n                 if (coalesceVariables.containsKey(variable)) {\n-                    Expression expression = new CoalesceExpression(new SymbolReference(variable.getName()), new Cast(new LongLiteral(\"0\"), \"bigint\"));\n-                    outputVariables.put(coalesceVariables.get(variable), castToRowExpression(expression));\n+                    RowExpression expression = new SpecialFormExpression(COALESCE, BIGINT, variable, new ConstantExpression(0L, BIGINT));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebcd13e66b70834d5eb1a62b568bdf1bd47b2bdf"}, "originalPosition": 139}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQwOTY3OA==", "bodyText": "same", "url": "https://github.com/prestodb/presto/pull/13923#discussion_r364409678", "createdAt": "2020-01-08T19:42:26Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/optimizations/OptimizeMixedDistinctAggregations.java", "diffHunk": "@@ -349,37 +346,47 @@ private ProjectNode createProjectNode(\n                     VariableReferenceExpression newVariable = variableAllocator.newVariable(\"expr\", variable.getType());\n                     aggregateInfo.setNewDistinctAggregateSymbol(newVariable);\n \n-                    Expression expression = createIfExpression(\n-                            new SymbolReference(groupVariable.getName()),\n-                            new Cast(new LongLiteral(\"1\"), \"bigint\"), // TODO: this should use GROUPING() when that's available instead of relying on specific group numbering\n-                            ComparisonExpression.Operator.EQUAL,\n-                            new SymbolReference(variable.getName()),\n-                            variable.getType());\n-                    outputVariables.put(newVariable, castToRowExpression(expression));\n+                    RowExpression ifExpression = new SpecialFormExpression(\n+                            IF,\n+                            variable.getType(),\n+                            ImmutableList.of(\n+                                    call(\n+                                            EQUAL.name(),\n+                                            functionResolution.comparisonFunction(EQUAL, BIGINT, BIGINT),\n+                                            BOOLEAN,\n+                                            ImmutableList.of(groupVariable, new ConstantExpression(1L, BIGINT))), // TODO: this should use GROUPING() instead of relying on specific group numbering", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebcd13e66b70834d5eb1a62b568bdf1bd47b2bdf"}, "originalPosition": 176}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQwOTc4OA==", "bodyText": "same", "url": "https://github.com/prestodb/presto/pull/13923#discussion_r364409788", "createdAt": "2020-01-08T19:42:43Z", "author": {"login": "highker"}, "path": "presto-main/src/main/java/com/facebook/presto/sql/planner/optimizations/OptimizeMixedDistinctAggregations.java", "diffHunk": "@@ -349,37 +346,47 @@ private ProjectNode createProjectNode(\n                     VariableReferenceExpression newVariable = variableAllocator.newVariable(\"expr\", variable.getType());\n                     aggregateInfo.setNewDistinctAggregateSymbol(newVariable);\n \n-                    Expression expression = createIfExpression(\n-                            new SymbolReference(groupVariable.getName()),\n-                            new Cast(new LongLiteral(\"1\"), \"bigint\"), // TODO: this should use GROUPING() when that's available instead of relying on specific group numbering\n-                            ComparisonExpression.Operator.EQUAL,\n-                            new SymbolReference(variable.getName()),\n-                            variable.getType());\n-                    outputVariables.put(newVariable, castToRowExpression(expression));\n+                    RowExpression ifExpression = new SpecialFormExpression(\n+                            IF,\n+                            variable.getType(),\n+                            ImmutableList.of(\n+                                    call(\n+                                            EQUAL.name(),\n+                                            functionResolution.comparisonFunction(EQUAL, BIGINT, BIGINT),\n+                                            BOOLEAN,\n+                                            ImmutableList.of(groupVariable, new ConstantExpression(1L, BIGINT))), // TODO: this should use GROUPING() instead of relying on specific group numbering\n+                                    variable,\n+                                    constantNull(variable.getType())));\n+                    outputVariables.put(newVariable, ifExpression);\n                 }\n                 else if (aggregationOutputVariablesMap.containsKey(variable)) {\n                     VariableReferenceExpression newVariable = variableAllocator.newVariable(\"expr\", variable.getType());\n                     // key of outputNonDistinctAggregateSymbols is key of an aggregation in AggrNode above, it will now aggregate on this Map's value\n                     outputNonDistinctAggregateVariables.put(aggregationOutputVariablesMap.get(variable), newVariable);\n-                    Expression expression = createIfExpression(\n-                            new SymbolReference(groupVariable.getName()),\n-                            new Cast(new LongLiteral(\"0\"), \"bigint\"), // TODO: this should use GROUPING() when that's available instead of relying on specific group numbering\n-                            ComparisonExpression.Operator.EQUAL,\n-                            new SymbolReference(variable.getName()),\n-                            variable.getType());\n-                    outputVariables.put(newVariable, castToRowExpression(expression));\n+\n+                    RowExpression ifExpression = new SpecialFormExpression(\n+                            IF,\n+                            variable.getType(),\n+                            ImmutableList.of(\n+                                    call(\n+                                            EQUAL.name(),\n+                                            functionResolution.comparisonFunction(EQUAL, BIGINT, BIGINT),\n+                                            BOOLEAN,\n+                                            ImmutableList.of(groupVariable, new ConstantExpression(0L, BIGINT))), // TODO: this should use GROUPING() instead of relying on specific group numbering", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebcd13e66b70834d5eb1a62b568bdf1bd47b2bdf"}, "originalPosition": 201}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90c5567e8494d9107bc0a03c1e7de854d4fd22b9", "author": {"user": {"login": "sachdevs", "name": "Saksham"}}, "url": "https://github.com/prestodb/presto/commit/90c5567e8494d9107bc0a03c1e7de854d4fd22b9", "committedDate": "2020-01-09T00:55:00Z", "message": "Move OptimizeMixedDistinctAggregations below Logical Optimization"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ebcd13e66b70834d5eb1a62b568bdf1bd47b2bdf", "author": {"user": {"login": "sachdevs", "name": "Saksham"}}, "url": "https://github.com/prestodb/presto/commit/ebcd13e66b70834d5eb1a62b568bdf1bd47b2bdf", "committedDate": "2020-01-08T19:40:25Z", "message": "Move OptimizeMixedDistinctAggregations below Logical Optimization"}, "afterCommit": {"oid": "90c5567e8494d9107bc0a03c1e7de854d4fd22b9", "author": {"user": {"login": "sachdevs", "name": "Saksham"}}, "url": "https://github.com/prestodb/presto/commit/90c5567e8494d9107bc0a03c1e7de854d4fd22b9", "committedDate": "2020-01-09T00:55:00Z", "message": "Move OptimizeMixedDistinctAggregations below Logical Optimization"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4448, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}