{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4NjcwNTYw", "number": 14146, "title": "A quick and dirty fix of CTAS failures: unable to rename from viewfs", "bodyText": "Seeing the failure below when run CTAS on viewfs\nUnable to rename from viewfs://hadoop-dw2-nn.smf1.twitter.com/user/beinanw/warehouse/aaa/.hive-staging/538ee740-6cce-46b7-96a7-ca0fbfc52148 to viewfs://hadoop-dw2-nn.smf1.twitter.com/user/beinanw/warehouse/aaa: target directory already exists\nIt seems that presto creates the temporary folder - \".hive-staging/{id}\" just under the target folder, which would also create the target folder in advance if the target folder did not exist.  But for the new tables (such as the table crated by CTAS), the target folder should not be created until the prepareAddTable():SemiTransactionalHiveMetastore got called, otherwise we will see the failure above.\nTo fix this failure,  I make it check the existence of the target folder first.  If the target folder is not there, the temporary folder is created as {target_folder}/../.hive-staging/{id} rather than {target_folder}/.hive-staging/{id}.   In this case, the temporary folder will be created in the sibling folder of the target folder.  So the target folder won't be created in advance.\n== NO RELEASE NOTE ==", "createdAt": "2020-02-23T06:48:58Z", "url": "https://github.com/prestodb/presto/pull/14146", "merged": true, "mergeCommit": {"oid": "d8a12ee72c91a82a09c9f86e43f8697070a90a33"}, "closed": true, "closedAt": "2020-08-25T22:20:08Z", "author": {"login": "beinan"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcIBwwPAFqTM2NDY3NDY3NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCdwxQAFqTQ3NDg5NzAzMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0Njc0Njc1", "url": "https://github.com/prestodb/presto/pull/14146#pullrequestreview-364674675", "createdAt": "2020-02-26T07:40:38Z", "commit": {"oid": "255f0ecbac2d9a5febddfc917f8691c4b1db16a0"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dba9aef8a2cae8d0d535c82ea76e24c54bd25524", "author": {"user": {"login": "beinan", "name": "Beinan"}}, "url": "https://github.com/prestodb/presto/commit/dba9aef8a2cae8d0d535c82ea76e24c54bd25524", "committedDate": "2020-08-24T21:28:54Z", "message": "fix CTAS failures when using viewfs"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "255f0ecbac2d9a5febddfc917f8691c4b1db16a0", "author": {"user": {"login": "beinan", "name": "Beinan"}}, "url": "https://github.com/prestodb/presto/commit/255f0ecbac2d9a5febddfc917f8691c4b1db16a0", "committedDate": "2020-02-23T05:44:24Z", "message": "fix CTAS failures when using viewfs"}, "afterCommit": {"oid": "03e5b7ecc4e13066e3ef1217f00329622f2e574a", "author": {"user": {"login": "beinan", "name": "Beinan"}}, "url": "https://github.com/prestodb/presto/commit/03e5b7ecc4e13066e3ef1217f00329622f2e574a", "committedDate": "2020-08-25T02:00:18Z", "message": "Create temporary root folder if it does not exist.\nAdd unit test for the creating temporary folder"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "03e5b7ecc4e13066e3ef1217f00329622f2e574a", "author": {"user": {"login": "beinan", "name": "Beinan"}}, "url": "https://github.com/prestodb/presto/commit/03e5b7ecc4e13066e3ef1217f00329622f2e574a", "committedDate": "2020-08-25T02:00:18Z", "message": "Create temporary root folder if it does not exist.\nAdd unit test for the creating temporary folder"}, "afterCommit": {"oid": "2ba6c154c4c2c9ee843ace53bcedcdc8e0a5ab66", "author": {"user": {"login": "beinan", "name": "Beinan"}}, "url": "https://github.com/prestodb/presto/commit/2ba6c154c4c2c9ee843ace53bcedcdc8e0a5ab66", "committedDate": "2020-08-25T04:04:58Z", "message": "Create temporary root folder if it does not exist.\nAdd unit test for the creating temporary folder"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2ba6c154c4c2c9ee843ace53bcedcdc8e0a5ab66", "author": {"user": {"login": "beinan", "name": "Beinan"}}, "url": "https://github.com/prestodb/presto/commit/2ba6c154c4c2c9ee843ace53bcedcdc8e0a5ab66", "committedDate": "2020-08-25T04:04:58Z", "message": "Create temporary root folder if it does not exist.\nAdd unit test for the creating temporary folder"}, "afterCommit": {"oid": "57c1be4837e0373e1e9b6b31beb60de5e5f4b453", "author": {"user": {"login": "beinan", "name": "Beinan"}}, "url": "https://github.com/prestodb/presto/commit/57c1be4837e0373e1e9b6b31beb60de5e5f4b453", "committedDate": "2020-08-25T04:12:55Z", "message": "Create temporary root folder if it does not exist and add unit test for creating temporary folder"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4eae741c7a165d196b6bee3af285f6643b8209dc", "author": {"user": {"login": "beinan", "name": "Beinan"}}, "url": "https://github.com/prestodb/presto/commit/4eae741c7a165d196b6bee3af285f6643b8209dc", "committedDate": "2020-08-25T06:27:21Z", "message": "Create temporary root folder when it does not exist and add unit test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "57c1be4837e0373e1e9b6b31beb60de5e5f4b453", "author": {"user": {"login": "beinan", "name": "Beinan"}}, "url": "https://github.com/prestodb/presto/commit/57c1be4837e0373e1e9b6b31beb60de5e5f4b453", "committedDate": "2020-08-25T04:12:55Z", "message": "Create temporary root folder if it does not exist and add unit test for creating temporary folder"}, "afterCommit": {"oid": "4eae741c7a165d196b6bee3af285f6643b8209dc", "author": {"user": {"login": "beinan", "name": "Beinan"}}, "url": "https://github.com/prestodb/presto/commit/4eae741c7a165d196b6bee3af285f6643b8209dc", "committedDate": "2020-08-25T06:27:21Z", "message": "Create temporary root folder when it does not exist and add unit test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0NzcxMjY0", "url": "https://github.com/prestodb/presto/pull/14146#pullrequestreview-474771264", "createdAt": "2020-08-25T19:05:21Z", "commit": {"oid": "4eae741c7a165d196b6bee3af285f6643b8209dc"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxOTowNToyMVrOHGl4LA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxOToxMDoxNlrOHGmCKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY3NDA5Mg==", "bodyText": "do we need this line?", "url": "https://github.com/prestodb/presto/pull/14146#discussion_r476674092", "createdAt": "2020-08-25T19:05:21Z", "author": {"login": "zhenxiao"}, "path": "presto-hive/src/test/java/com/facebook/presto/hive/TestHiveWriteUtils.java", "diffHunk": "@@ -13,18 +13,25 @@\n  */\n package com.facebook.presto.hive;\n \n+import com.google.common.io.Files;\n import org.apache.hadoop.fs.Path;\n import org.testng.annotations.Test;\n \n+import java.util.UUID;\n+\n+import static com.facebook.presto.hive.HiveTestUtils.SESSION;\n import static com.facebook.presto.hive.HiveTestUtils.createTestHdfsEnvironment;\n+import static com.facebook.presto.hive.HiveWriteUtils.createTemporaryPath;\n import static com.facebook.presto.hive.HiveWriteUtils.isS3FileSystem;\n import static com.facebook.presto.hive.HiveWriteUtils.isViewFileSystem;\n-import static com.facebook.presto.testing.TestingConnectorSession.SESSION;\n+import static org.testng.Assert.assertEquals;\n import static org.testng.Assert.assertFalse;\n import static org.testng.Assert.assertTrue;\n+import static org.testng.Assert.fail;\n \n public class TestHiveWriteUtils\n {\n+    //HdfsContext CONTEXT = new HdfsContext(new ConnectorIdentity(\"test\", Optional.empty(), Optional.empty()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4eae741c7a165d196b6bee3af285f6643b8209dc"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY3NjY1MA==", "bodyText": "could we have testcases for both targetPath exist and not exist?", "url": "https://github.com/prestodb/presto/pull/14146#discussion_r476676650", "createdAt": "2020-08-25T19:10:16Z", "author": {"login": "zhenxiao"}, "path": "presto-hive/src/test/java/com/facebook/presto/hive/TestHiveWriteUtils.java", "diffHunk": "@@ -48,4 +55,39 @@ public void testIsViewFileSystem()\n         assertTrue(isViewFileSystem(CONTEXT, hdfsEnvironment, viewfsPath));\n         assertFalse(isViewFileSystem(CONTEXT, hdfsEnvironment, nonViewfsPath));\n     }\n+\n+    @Test void testCreateTemporaryPathOnViewFS()\n+    {\n+        HdfsEnvironment hdfsEnvironment = createTestHdfsEnvironment(new HiveClientConfig(), new MetastoreClientConfig());\n+        Path viewfsPath = new Path(\"viewfs://ns-default/test-dir\");\n+\n+        // ViewFS check requires the mount point config\n+        hdfsEnvironment.getConfiguration(CONTEXT, viewfsPath).set(\"fs.viewfs.mounttable.ns-default.link./test-dir\", \"file://\" + Files.createTempDir());\n+\n+        Path temporaryPath = createTemporaryPath(SESSION, CONTEXT, hdfsEnvironment, viewfsPath);\n+\n+        assertEquals(temporaryPath.getParent().toString(), \"viewfs://ns-default/test-dir/.hive-staging\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4eae741c7a165d196b6bee3af285f6643b8209dc"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f4fc12f8a2833e8a58d89f17193ce7f1ba95d01", "author": {"user": {"login": "beinan", "name": "Beinan"}}, "url": "https://github.com/prestodb/presto/commit/7f4fc12f8a2833e8a58d89f17193ce7f1ba95d01", "committedDate": "2020-08-25T20:45:57Z", "message": "Add test cases for making temp dir under both exist and non-exist folder"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0ODk3MDMx", "url": "https://github.com/prestodb/presto/pull/14146#pullrequestreview-474897031", "createdAt": "2020-08-25T21:05:36Z", "commit": {"oid": "7f4fc12f8a2833e8a58d89f17193ce7f1ba95d01"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2311, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}