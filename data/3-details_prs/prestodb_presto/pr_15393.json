{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE1MDE5NjI1", "number": 15393, "title": "Make query result HTTP response compression configurable", "bodyText": "Before this change, query result JSON responses were generally compressed (assuming the response met the minimum size threshold and passed the user agent checks), so that behavior is still the default. However, disabling GZIP compression can significantly improve throughput of sending query results, especially over localhost links where the overhead of compressing the response and then uncompressing it again on the client side is never worth the bandwidth savings.\nClients are allowed to opt-out of compression, but not request compression from a server which has decided to disable compressed query result responses. Both sides ultimately negotiate the result based on their Accept-Encoding or Content-Encoding headers and the way that the gzip compression middleware interprets them.\nFor queries that are bound only by result processing throughput (eg: SELECT * FROM <large table>) execution time can reduced by 20-50% when submitted over a localhost connection with compression disabled.\n== RELEASE NOTES ==\n\nGeneral Changes\n* Add support for disabling query result compression via client and server-side configuration properties. Clients\ncan disable compressed responses using the ``--disable-compression`` flag or ``disableCompression`` driver property. Compression can be disabled server-wide by using the configuration property: ``query-results.compression-enabled=false``", "createdAt": "2020-11-03T22:14:10Z", "url": "https://github.com/prestodb/presto/pull/15393", "merged": true, "mergeCommit": {"oid": "dc2d50bc51984e0e46577b3792eceabf33a679cb"}, "closed": true, "closedAt": "2020-11-30T23:52:49Z", "author": {"login": "pettyjamesm"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZQA5QABqjM5NTgzMTQ3MjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdho7cYAFqTU0MTE0MTE1OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "919e547f33bc1ab8b58666e873387d2ca22d0604", "author": {"user": {"login": "pettyjamesm", "name": "James Petty"}}, "url": "https://github.com/prestodb/presto/commit/919e547f33bc1ab8b58666e873387d2ca22d0604", "committedDate": "2020-11-03T22:13:15Z", "message": "Make query result HTTP compression server configurable\n\nAllows configuring HTTP response compression for the query results\nendpoints at the server level, regardless of client configuration."}, "afterCommit": {"oid": "eee98d45dc0070cbdbd43d3d295092251b72ebff", "author": {"user": {"login": "pettyjamesm", "name": "James Petty"}}, "url": "https://github.com/prestodb/presto/commit/eee98d45dc0070cbdbd43d3d295092251b72ebff", "committedDate": "2020-11-04T16:03:37Z", "message": "Make query result HTTP compression server configurable\n\nAllows configuring HTTP response compression for the query results\nendpoints at the server level, regardless of client configuration."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eee98d45dc0070cbdbd43d3d295092251b72ebff", "author": {"user": {"login": "pettyjamesm", "name": "James Petty"}}, "url": "https://github.com/prestodb/presto/commit/eee98d45dc0070cbdbd43d3d295092251b72ebff", "committedDate": "2020-11-04T16:03:37Z", "message": "Make query result HTTP compression server configurable\n\nAllows configuring HTTP response compression for the query results\nendpoints at the server level, regardless of client configuration."}, "afterCommit": {"oid": "8731ada1fa220b5dfb2ede0e9c05de142270b227", "author": {"user": {"login": "pettyjamesm", "name": "James Petty"}}, "url": "https://github.com/prestodb/presto/commit/8731ada1fa220b5dfb2ede0e9c05de142270b227", "committedDate": "2020-11-16T15:01:37Z", "message": "Make query result HTTP compression server configurable\n\nAllows configuring HTTP response compression for the query results\nendpoints at the server level, regardless of client configuration."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8731ada1fa220b5dfb2ede0e9c05de142270b227", "author": {"user": {"login": "pettyjamesm", "name": "James Petty"}}, "url": "https://github.com/prestodb/presto/commit/8731ada1fa220b5dfb2ede0e9c05de142270b227", "committedDate": "2020-11-16T15:01:37Z", "message": "Make query result HTTP compression server configurable\n\nAllows configuring HTTP response compression for the query results\nendpoints at the server level, regardless of client configuration."}, "afterCommit": {"oid": "46d990c2c01faa7e492e07f2a05942d8608bb6a6", "author": {"user": {"login": "pettyjamesm", "name": "James Petty"}}, "url": "https://github.com/prestodb/presto/commit/46d990c2c01faa7e492e07f2a05942d8608bb6a6", "committedDate": "2020-11-16T16:05:22Z", "message": "Make query result HTTP compression server configurable\n\nAllows configuring HTTP response compression for the query results\nendpoints at the server level, regardless of client configuration."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "46d990c2c01faa7e492e07f2a05942d8608bb6a6", "author": {"user": {"login": "pettyjamesm", "name": "James Petty"}}, "url": "https://github.com/prestodb/presto/commit/46d990c2c01faa7e492e07f2a05942d8608bb6a6", "committedDate": "2020-11-16T16:05:22Z", "message": "Make query result HTTP compression server configurable\n\nAllows configuring HTTP response compression for the query results\nendpoints at the server level, regardless of client configuration."}, "afterCommit": {"oid": "a6f5f5b385288ddaacd318b96cf9250f9cf125d1", "author": {"user": {"login": "pettyjamesm", "name": "James Petty"}}, "url": "https://github.com/prestodb/presto/commit/a6f5f5b385288ddaacd318b96cf9250f9cf125d1", "committedDate": "2020-11-19T19:23:27Z", "message": "Make query result HTTP compression server configurable\n\nAllows configuring HTTP response compression for the query results\nendpoints at the server level, regardless of client configuration."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1ODE0NzEx", "url": "https://github.com/prestodb/presto/pull/15393#pullrequestreview-535814711", "createdAt": "2020-11-20T22:19:12Z", "commit": {"oid": "a6f5f5b385288ddaacd318b96cf9250f9cf125d1"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQyMjoxOToxM1rOH3ioyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQyMjoyMTo0NFrOH3isbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAwMTIyNQ==", "bodyText": "Can we instead use compressionEnabled? Disabled would incur one more flip in mind :)", "url": "https://github.com/prestodb/presto/pull/15393#discussion_r528001225", "createdAt": "2020-11-20T22:19:13Z", "author": {"login": "shixuan-fan"}, "path": "presto-client/src/main/java/com/facebook/presto/client/ClientSession.java", "diffHunk": "@@ -51,6 +51,7 @@\n     private final Map<String, String> extraCredentials;\n     private final String transactionId;\n     private final Duration clientRequestTimeout;\n+    private final boolean compressionDisabled;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a6f5f5b385288ddaacd318b96cf9250f9cf125d1"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAwMjE1Ng==", "bodyText": "I understand that we are trying to reduce duplicate code, but passing compressionEnabled  to withCompressionEnabled is a bit weird and sounds like this should be done outside.", "url": "https://github.com/prestodb/presto/pull/15393#discussion_r528002156", "createdAt": "2020-11-20T22:21:44Z", "author": {"login": "shixuan-fan"}, "path": "presto-main/src/main/java/com/facebook/presto/server/protocol/QueuedStatementResource.java", "diffHunk": "@@ -380,7 +392,7 @@ public synchronized QueryResults getInitialQueryResults(UriInfo uriInfo, String\n                             uriInfo,\n                             xForwardedProto,\n                             DispatchInfo.queued(NO_DURATION, NO_DURATION));\n-                    return immediateFuture(Response.ok(queryResults).build());\n+                    return immediateFuture(withCompressionEnabled(Response.ok(queryResults), compressionEnabled).build());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a6f5f5b385288ddaacd318b96cf9250f9cf125d1"}, "originalPosition": 78}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "27bf9be72be26cfe9ad9d6a07a51a407ee19a305", "author": {"user": {"login": "pettyjamesm", "name": "James Petty"}}, "url": "https://github.com/prestodb/presto/commit/27bf9be72be26cfe9ad9d6a07a51a407ee19a305", "committedDate": "2020-11-23T14:09:11Z", "message": "Make query result HTTP compression client configurable\n\nBy default, presto will GZIP query result JSON payloads sent to the\nclient. However, especially when the client is connected to the\ncoordinator over localhost, the added overhead of compressing the\nresponse and then uncompressing it on the client is a losing\nproposition.\n\nFor queries that are bound only by result processing throughput (eg:\nSELECT * FROM <large table>) execution time can reduced by 20-50%\nwhen submitted over a localhost connection with compression disabled."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33afb0cb732894a1c25e9c19bf855f381ab52a61", "author": {"user": {"login": "pettyjamesm", "name": "James Petty"}}, "url": "https://github.com/prestodb/presto/commit/33afb0cb732894a1c25e9c19bf855f381ab52a61", "committedDate": "2020-11-23T14:14:03Z", "message": "Make query result HTTP compression server configurable\n\nAllows configuring HTTP response compression for the query results\nendpoints at the server level, regardless of client configuration."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a6f5f5b385288ddaacd318b96cf9250f9cf125d1", "author": {"user": {"login": "pettyjamesm", "name": "James Petty"}}, "url": "https://github.com/prestodb/presto/commit/a6f5f5b385288ddaacd318b96cf9250f9cf125d1", "committedDate": "2020-11-19T19:23:27Z", "message": "Make query result HTTP compression server configurable\n\nAllows configuring HTTP response compression for the query results\nendpoints at the server level, regardless of client configuration."}, "afterCommit": {"oid": "33afb0cb732894a1c25e9c19bf855f381ab52a61", "author": {"user": {"login": "pettyjamesm", "name": "James Petty"}}, "url": "https://github.com/prestodb/presto/commit/33afb0cb732894a1c25e9c19bf855f381ab52a61", "committedDate": "2020-11-23T14:14:03Z", "message": "Make query result HTTP compression server configurable\n\nAllows configuring HTTP response compression for the query results\nendpoints at the server level, regardless of client configuration."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMTQxMTU5", "url": "https://github.com/prestodb/presto/pull/15393#pullrequestreview-541141159", "createdAt": "2020-11-30T17:37:52Z", "commit": {"oid": "33afb0cb732894a1c25e9c19bf855f381ab52a61"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4675, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}