{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY2NzM2MDEz", "number": 14010, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxNTozMjo0NFrODbQ7rA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxOTo0Njo1NVrODcwOTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5OTE1NTY0OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxNTozMjo0NFrOFipfkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxOToxMDoyNFrOFj2mqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTg3NTcyOA==", "bodyText": "!isShufflePartitionedColumnsForTableWriteEnabled(session) || table.getPartitionColumns().isEmpty()?", "url": "https://github.com/prestodb/presto/pull/14010#discussion_r371875728", "createdAt": "2020-01-28T15:32:44Z", "author": {"login": "arhimondr"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -2405,6 +2411,39 @@ private static Domain buildColumnDomain(ColumnHandle column, List<HivePartition>\n         return Optional.of(new ConnectorNewTableLayout(partitioningHandle, partitionColumns));\n     }\n \n+    @Override\n+    public Optional<ConnectorNewTableLayout> getPreferredShuffleLayoutForInsert(ConnectorSession session, ConnectorTableHandle tableHandle)\n+    {\n+        HiveTableHandle hiveTableHandle = (HiveTableHandle) tableHandle;\n+        SchemaTableName tableName = hiveTableHandle.getSchemaTableName();\n+        Table table = metastore.getTable(tableName.getSchemaName(), tableName.getTableName())\n+                .orElseThrow(() -> new TableNotFoundException(tableName));\n+\n+        Optional<HiveBucketHandle> hiveBucketHandle = getHiveBucketHandle(table);\n+        if (hiveBucketHandle.isPresent()) {\n+            // For bucketed table, table partitioning (i.e. the bucketing scheme) should be respected,\n+            // and there is no additional preferred shuffle partitioning\n+            return Optional.empty();\n+        }\n+\n+        if (!(isShufflePartitionedColumnsForTableWriteEnabled(session) || table.getPartitionColumns().isEmpty())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb4879b1702f26a5dad5997af3a31bb25241501b"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzEzOTExNA==", "bodyText": "@arhimondr : Nice catch!", "url": "https://github.com/prestodb/presto/pull/14010#discussion_r373139114", "createdAt": "2020-01-30T19:10:24Z", "author": {"login": "wenleix"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -2405,6 +2411,39 @@ private static Domain buildColumnDomain(ColumnHandle column, List<HivePartition>\n         return Optional.of(new ConnectorNewTableLayout(partitioningHandle, partitionColumns));\n     }\n \n+    @Override\n+    public Optional<ConnectorNewTableLayout> getPreferredShuffleLayoutForInsert(ConnectorSession session, ConnectorTableHandle tableHandle)\n+    {\n+        HiveTableHandle hiveTableHandle = (HiveTableHandle) tableHandle;\n+        SchemaTableName tableName = hiveTableHandle.getSchemaTableName();\n+        Table table = metastore.getTable(tableName.getSchemaName(), tableName.getTableName())\n+                .orElseThrow(() -> new TableNotFoundException(tableName));\n+\n+        Optional<HiveBucketHandle> hiveBucketHandle = getHiveBucketHandle(table);\n+        if (hiveBucketHandle.isPresent()) {\n+            // For bucketed table, table partitioning (i.e. the bucketing scheme) should be respected,\n+            // and there is no additional preferred shuffle partitioning\n+            return Optional.empty();\n+        }\n+\n+        if (!(isShufflePartitionedColumnsForTableWriteEnabled(session) || table.getPartitionColumns().isEmpty())) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTg3NTcyOA=="}, "originalCommit": {"oid": "bb4879b1702f26a5dad5997af3a31bb25241501b"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxMTA4MjYzOnYy", "diffSide": "RIGHT", "path": "presto-spi/src/main/java/com/facebook/presto/spi/connector/ConnectorMetadata.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wMVQwNDoxNDo0M1rOFkcSXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wMVQwNDoxNDo0M1rOFkcSXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc1NjUxMQ==", "bodyText": "Can we add javadoc to the interface?", "url": "https://github.com/prestodb/presto/pull/14010#discussion_r373756511", "createdAt": "2020-02-01T04:14:43Z", "author": {"login": "highker"}, "path": "presto-spi/src/main/java/com/facebook/presto/spi/connector/ConnectorMetadata.java", "diffHunk": "@@ -363,6 +363,11 @@ default void dropColumn(ConnectorSession session, ConnectorTableHandle tableHand\n         return Optional.empty();\n     }\n \n+    default Optional<ConnectorNewTableLayout> getPreferredShuffleLayoutForNewTable(ConnectorSession session, ConnectorTableMetadata tableMetadata)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de854efbf57322f5e9e3ae6c089063811773ef7c"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxMTA4MjY3OnYy", "diffSide": "RIGHT", "path": "presto-spi/src/main/java/com/facebook/presto/spi/connector/ConnectorMetadata.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wMVQwNDoxNDo0OFrOFkcSZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wMVQwNDoxNDo0OFrOFkcSZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc1NjUxOA==", "bodyText": "same here", "url": "https://github.com/prestodb/presto/pull/14010#discussion_r373756518", "createdAt": "2020-02-01T04:14:48Z", "author": {"login": "highker"}, "path": "presto-spi/src/main/java/com/facebook/presto/spi/connector/ConnectorMetadata.java", "diffHunk": "@@ -393,6 +398,11 @@ default void dropColumn(ConnectorSession session, ConnectorTableHandle tableHand\n         return Optional.of(new ConnectorNewTableLayout(partitioningHandle, partitionColumns));\n     }\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de854efbf57322f5e9e3ae6c089063811773ef7c"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxNDc2MzExOnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxOTo0NToyMlrOFk9pWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwMDowOTo1NlrOFlETow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDMwMzA2Nw==", "bodyText": "@wenleix I don't understand this TODO. It seems to me that bucketed tables are handled above and would never reach that code. Would you clarify?", "url": "https://github.com/prestodb/presto/pull/14010#discussion_r374303067", "createdAt": "2020-02-03T19:45:22Z", "author": {"login": "mbasmanova"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -2418,6 +2425,39 @@ private static Domain buildColumnDomain(ColumnHandle column, List<HivePartition>\n         return Optional.of(new ConnectorNewTableLayout(partitioningHandle, partitionColumns));\n     }\n \n+    @Override\n+    public Optional<ConnectorNewTableLayout> getPreferredShuffleLayoutForInsert(ConnectorSession session, ConnectorTableHandle tableHandle)\n+    {\n+        HiveTableHandle hiveTableHandle = (HiveTableHandle) tableHandle;\n+        SchemaTableName tableName = hiveTableHandle.getSchemaTableName();\n+        Table table = metastore.getTable(tableName.getSchemaName(), tableName.getTableName())\n+                .orElseThrow(() -> new TableNotFoundException(tableName));\n+\n+        Optional<HiveBucketHandle> hiveBucketHandle = getHiveBucketHandle(table);\n+        if (hiveBucketHandle.isPresent()) {\n+            // For bucketed table, table partitioning (i.e. the bucketing scheme) should be respected,\n+            // and there is no additional preferred shuffle partitioning\n+            return Optional.empty();\n+        }\n+\n+        if (!isShufflePartitionedColumnsForTableWriteEnabled(session) || table.getPartitionColumns().isEmpty()) {\n+            return Optional.empty();\n+        }\n+\n+        // TODO: the shuffle partitioning doesn't have to be the same as Hive bucket partitioning", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66e83312c63fe34b39b069367c7bf246575c9589"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQxMjE5NQ==", "bodyText": "@mbasmanova : Sorry for the confusion, I mean we don't have to use HivePartitionHandle for the shuffle partitioning. Thinking about implementing a different HiveShufflePartitioningHandle that distribute the keys more uniformly (Hive bucket function is not that great :) )", "url": "https://github.com/prestodb/presto/pull/14010#discussion_r374412195", "createdAt": "2020-02-04T00:09:56Z", "author": {"login": "wenleix"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -2418,6 +2425,39 @@ private static Domain buildColumnDomain(ColumnHandle column, List<HivePartition>\n         return Optional.of(new ConnectorNewTableLayout(partitioningHandle, partitionColumns));\n     }\n \n+    @Override\n+    public Optional<ConnectorNewTableLayout> getPreferredShuffleLayoutForInsert(ConnectorSession session, ConnectorTableHandle tableHandle)\n+    {\n+        HiveTableHandle hiveTableHandle = (HiveTableHandle) tableHandle;\n+        SchemaTableName tableName = hiveTableHandle.getSchemaTableName();\n+        Table table = metastore.getTable(tableName.getSchemaName(), tableName.getTableName())\n+                .orElseThrow(() -> new TableNotFoundException(tableName));\n+\n+        Optional<HiveBucketHandle> hiveBucketHandle = getHiveBucketHandle(table);\n+        if (hiveBucketHandle.isPresent()) {\n+            // For bucketed table, table partitioning (i.e. the bucketing scheme) should be respected,\n+            // and there is no additional preferred shuffle partitioning\n+            return Optional.empty();\n+        }\n+\n+        if (!isShufflePartitionedColumnsForTableWriteEnabled(session) || table.getPartitionColumns().isEmpty()) {\n+            return Optional.empty();\n+        }\n+\n+        // TODO: the shuffle partitioning doesn't have to be the same as Hive bucket partitioning", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDMwMzA2Nw=="}, "originalCommit": {"oid": "66e83312c63fe34b39b069367c7bf246575c9589"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxNDc2ODE0OnYy", "diffSide": "RIGHT", "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxOTo0Njo1NVrOFk9seg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxOTo0Njo1NVrOFk9seg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDMwMzg2Ng==", "bodyText": "@wenleix Same question about this TODO", "url": "https://github.com/prestodb/presto/pull/14010#discussion_r374303866", "createdAt": "2020-02-03T19:46:55Z", "author": {"login": "mbasmanova"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/HiveMetadata.java", "diffHunk": "@@ -2444,6 +2484,41 @@ private static Domain buildColumnDomain(ColumnHandle column, List<HivePartition>\n                 bucketedBy));\n     }\n \n+    @Override\n+    public Optional<ConnectorNewTableLayout> getPreferredShuffleLayoutForNewTable(ConnectorSession session, ConnectorTableMetadata tableMetadata)\n+    {\n+        validatePartitionColumns(tableMetadata);\n+        validateBucketColumns(tableMetadata);\n+        Optional<HiveBucketProperty> bucketProperty = getBucketProperty(tableMetadata.getProperties());\n+        if (bucketProperty.isPresent()) {\n+            // For bucketed table, table partitioning (i.e. the bucketing scheme) should be respected,\n+            // and there is no additional preferred shuffle partitioning\n+            return Optional.empty();\n+        }\n+\n+        List<String> partitionedBy = getPartitionedBy(tableMetadata.getProperties());\n+        if (!isShufflePartitionedColumnsForTableWriteEnabled(session) || partitionedBy.isEmpty()) {\n+            return Optional.empty();\n+        }\n+\n+        List<HiveColumnHandle> columnHandles = getColumnHandles(tableMetadata, ImmutableSet.copyOf(partitionedBy), typeTranslator);\n+        Map<String, HiveColumnHandle> columnHandlesByName = Maps.uniqueIndex(columnHandles, HiveColumnHandle::getName);\n+        List<Column> partitionColumns = partitionedBy.stream()\n+                .map(columnHandlesByName::get)\n+                .map(column -> new Column(column.getName(), column.getHiveType(), column.getComment()))\n+                .collect(toList());\n+\n+        // TODO: the shuffle partitioning doesn't have to be the same as Hive bucket partitioning", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66e83312c63fe34b39b069367c7bf246575c9589"}, "originalPosition": 89}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3190, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}