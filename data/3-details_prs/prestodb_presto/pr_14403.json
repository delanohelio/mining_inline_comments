{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA0ODg4MzYw", "number": 14403, "title": "Fix WarningsCollector", "bodyText": "When this was introduced in DispatchManager, it was unintentionally made\nto be stateful.\n== NO RELEASE NOTE ==", "createdAt": "2020-04-17T02:35:56Z", "url": "https://github.com/prestodb/presto/pull/14403", "merged": true, "mergeCommit": {"oid": "c8dbd9a149229d1912f0280fbcd340beee7ea7f1"}, "closed": true, "closedAt": "2020-04-17T21:58:55Z", "author": {"login": "tdcmeehan"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcYYuPzAFqTM5NTEzNzE0Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcYbRUUgFqTM5NTE5MDMzOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1MTM3MTQ2", "url": "https://github.com/prestodb/presto/pull/14403#pullrequestreview-395137146", "createdAt": "2020-04-17T03:25:54Z", "commit": {"oid": "beb9cd85534c4f636af1473ba7c022e1e18b6505"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwMzoyNTo1NFrOGG-pSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwMzoyODoxN1rOGG-rcQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk3MTAxOQ==", "bodyText": "nit:static import", "url": "https://github.com/prestodb/presto/pull/14403#discussion_r409971019", "createdAt": "2020-04-17T03:25:54Z", "author": {"login": "caithagoras"}, "path": "presto-tests/src/test/java/com/facebook/presto/execution/TestWarnings.java", "diffHunk": "@@ -64,40 +64,49 @@ public void testStageCountWarningThreshold()\n                     .append(stageIndex);\n         }\n         String query = queryBuilder.toString();\n-        assertWarnings(queryRunner, TEST_SESSION, query, ImmutableList.of(TOO_MANY_STAGES.toWarningCode()));\n-        assertWarnings(queryRunner, TEST_SESSION, noWarningsQuery, ImmutableList.of());\n+        assertWarnings(queryRunner, TEST_SESSION, query, ImmutableSet.of(TOO_MANY_STAGES.toWarningCode()));\n+        assertWarnings(queryRunner, TEST_SESSION, noWarningsQuery, ImmutableSet.of());\n     }\n \n     @Test\n     public void testNonReservedWordWarning()\n     {\n         String query = \"SELECT CURRENT_ROLE, t.current_role FROM (VALUES (3)) t(current_role)\";\n-        assertWarnings(queryRunner, TEST_SESSION, query, ImmutableList.of(PARSER_WARNING.toWarningCode()));\n+        assertWarnings(queryRunner, TEST_SESSION, query, ImmutableSet.of(PARSER_WARNING.toWarningCode()));\n     }\n \n     @Test\n     public void testNewReservedWordsWarning()\n     {\n         String query = \"SELECT CALLED, t.called FROM (VALUES (3)) t(called)\";\n-        assertWarnings(queryRunner, TEST_SESSION, query, ImmutableList.of(PARSER_WARNING.toWarningCode()));\n+        assertWarnings(queryRunner, TEST_SESSION, query, ImmutableSet.of(PARSER_WARNING.toWarningCode()));\n+    }\n+\n+    @Test\n+    public void testWarningsAreNotStateful()\n+    {\n+        String query = \"SELECT CALLED, t.called FROM (VALUES (3)) t(called)\";\n+        assertWarnings(queryRunner, TEST_SESSION, query, ImmutableSet.of(PARSER_WARNING.toWarningCode()));\n+        // Make sure the previous warning is not carried into the next query\n+        query = \"SELECT UNCALLED, t.uncalled FROM (VALUES (3)) t(uncalled)\";\n+        assertWarnings(queryRunner, TEST_SESSION, query, ImmutableSet.of());\n     }\n \n     @Test\n     public void testQuotedIdentifiersDoNotTriggerWarning()\n     {\n         String query = \"SELECT \\\"CALLED\\\" FROM (VALUES (3)) t(\\\"called\\\")\";\n-        assertWarnings(queryRunner, TEST_SESSION, query, ImmutableList.of());\n+        assertWarnings(queryRunner, TEST_SESSION, query, ImmutableSet.of());\n     }\n \n-    private static void assertWarnings(QueryRunner queryRunner, Session session, @Language(\"SQL\") String sql, List<WarningCode> expectedWarnings)\n+    private static void assertWarnings(QueryRunner queryRunner, Session session, @Language(\"SQL\") String sql, Set<WarningCode> expectedWarnings)\n     {\n         Set<WarningCode> warnings = queryRunner.execute(session, sql).getWarnings().stream()\n                 .map(PrestoWarning::getWarningCode)\n                 .collect(toImmutableSet());\n-        for (WarningCode warningCode : expectedWarnings) {\n-            if (!warnings.contains(warningCode)) {\n-                fail(\"Expected warning: \" + warningCode);\n-            }\n-        }\n+        Set<WarningCode> expectedButMissing = Sets.difference(expectedWarnings, warnings);\n+        Set<WarningCode> unexpectedWarnings = Sets.difference(warnings, expectedWarnings);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "beb9cd85534c4f636af1473ba7c022e1e18b6505"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk3MTU2OQ==", "bodyText": "nit: add a line break before line 90 for readability.", "url": "https://github.com/prestodb/presto/pull/14403#discussion_r409971569", "createdAt": "2020-04-17T03:28:17Z", "author": {"login": "caithagoras"}, "path": "presto-tests/src/test/java/com/facebook/presto/execution/TestWarnings.java", "diffHunk": "@@ -64,40 +64,49 @@ public void testStageCountWarningThreshold()\n                     .append(stageIndex);\n         }\n         String query = queryBuilder.toString();\n-        assertWarnings(queryRunner, TEST_SESSION, query, ImmutableList.of(TOO_MANY_STAGES.toWarningCode()));\n-        assertWarnings(queryRunner, TEST_SESSION, noWarningsQuery, ImmutableList.of());\n+        assertWarnings(queryRunner, TEST_SESSION, query, ImmutableSet.of(TOO_MANY_STAGES.toWarningCode()));\n+        assertWarnings(queryRunner, TEST_SESSION, noWarningsQuery, ImmutableSet.of());\n     }\n \n     @Test\n     public void testNonReservedWordWarning()\n     {\n         String query = \"SELECT CURRENT_ROLE, t.current_role FROM (VALUES (3)) t(current_role)\";\n-        assertWarnings(queryRunner, TEST_SESSION, query, ImmutableList.of(PARSER_WARNING.toWarningCode()));\n+        assertWarnings(queryRunner, TEST_SESSION, query, ImmutableSet.of(PARSER_WARNING.toWarningCode()));\n     }\n \n     @Test\n     public void testNewReservedWordsWarning()\n     {\n         String query = \"SELECT CALLED, t.called FROM (VALUES (3)) t(called)\";\n-        assertWarnings(queryRunner, TEST_SESSION, query, ImmutableList.of(PARSER_WARNING.toWarningCode()));\n+        assertWarnings(queryRunner, TEST_SESSION, query, ImmutableSet.of(PARSER_WARNING.toWarningCode()));\n+    }\n+\n+    @Test\n+    public void testWarningsAreNotStateful()\n+    {\n+        String query = \"SELECT CALLED, t.called FROM (VALUES (3)) t(called)\";\n+        assertWarnings(queryRunner, TEST_SESSION, query, ImmutableSet.of(PARSER_WARNING.toWarningCode()));\n+        // Make sure the previous warning is not carried into the next query", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "beb9cd85534c4f636af1473ba7c022e1e18b6505"}, "originalPosition": 57}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9994321155ad8d2545a16d1084bdd8f2ce42b102", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/9994321155ad8d2545a16d1084bdd8f2ce42b102", "committedDate": "2020-04-17T04:08:10Z", "message": "Fix WarningsCollector\n\nWhen this was introduced in DispatchManager, it was unintentionally made\nto be stateful."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "beb9cd85534c4f636af1473ba7c022e1e18b6505", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/beb9cd85534c4f636af1473ba7c022e1e18b6505", "committedDate": "2020-04-17T02:34:42Z", "message": "Fix WarningsCollector\n\nWhen this was introduced in DispatchManager, it was unintentionally made\nto be stateful."}, "afterCommit": {"oid": "9994321155ad8d2545a16d1084bdd8f2ce42b102", "author": {"user": {"login": "tdcmeehan", "name": "Timothy Meehan"}}, "url": "https://github.com/prestodb/presto/commit/9994321155ad8d2545a16d1084bdd8f2ce42b102", "committedDate": "2020-04-17T04:08:10Z", "message": "Fix WarningsCollector\n\nWhen this was introduced in DispatchManager, it was unintentionally made\nto be stateful."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1MTkwMzM5", "url": "https://github.com/prestodb/presto/pull/14403#pullrequestreview-395190339", "createdAt": "2020-04-17T06:26:37Z", "commit": {"oid": "9994321155ad8d2545a16d1084bdd8f2ce42b102"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1867, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}