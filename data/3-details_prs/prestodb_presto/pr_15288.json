{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk5NzcwMjAx", "number": 15288, "title": "S3 assume iam role", "bodyText": "== RELEASE NOTES ==\n\nGeneral Changes\n* ...\n* ...\n\nHive Changes\n* AWS SDK upgrade to leverage EKS grant feature\n* S3 configuration support to assume IAM role\n* Disabled default S3 instance credential behavior to provide configurability to choose from instance creds or IAM role\n\nIf release note is NOT required, use:\n== NO RELEASE NOTE ==\n\nresolves #15158", "createdAt": "2020-10-08T09:03:23Z", "url": "https://github.com/prestodb/presto/pull/15288", "merged": true, "mergeCommit": {"oid": "4720be3b94b1c8d97d83d98895934c5705cb09a3"}, "closed": true, "closedAt": "2020-10-12T20:16:36Z", "author": {"login": "ashishtadose"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQbiCHAH2gAyNDk5NzcwMjAxOmFiNmI2YjY2ODRkMjczNzk1YzE1YWQ3MzhjZmI1YmFmYWFmOTljZWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdR2wC7AFqTUwNjc3MTE0NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ab6b6b6684d273795c15ad738cfb5bafaaf99ceb", "author": {"user": {"login": "ashishtadose", "name": "Ashish"}}, "url": "https://github.com/prestodb/presto/commit/ab6b6b6684d273795c15ad738cfb5bafaaf99ceb", "committedDate": "2020-10-08T06:24:38Z", "message": "bump aws-sdk to 1.11.697\nNeeded for EKS presto deployments - EKS feature to grant IAM to K8s service account"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "add9947433037e8fd349e795da5cfea3d5c9967d", "author": {"user": {"login": "ashishtadose", "name": "Ashish"}}, "url": "https://github.com/prestodb/presto/commit/add9947433037e8fd349e795da5cfea3d5c9967d", "committedDate": "2020-10-08T08:06:12Z", "message": "Allow PrestoS3FileSystem and GlueHiveMetastore to assume an aws role\n\nExtracted from: https://github.com/prestodb/presto/pull/10864\n\nCo-authored-by: albert-franzi <albert.franzi@schibsted.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b695ac9acae5e7d60b8ab11bb84b608924bbda30", "author": {"user": {"login": "ashishtadose", "name": "Ashish"}}, "url": "https://github.com/prestodb/presto/commit/b695ac9acae5e7d60b8ab11bb84b608924bbda30", "committedDate": "2020-10-08T08:36:35Z", "message": "Changed default hive.s3.use-instance-credentials to false so users can select whether to use instance creds or iam assume role"}, "afterCommit": {"oid": "13d16401b6b0d5c8926dde3fa45d683e9a852b8b", "author": {"user": {"login": "ashishtadose", "name": "Ashish"}}, "url": "https://github.com/prestodb/presto/commit/13d16401b6b0d5c8926dde3fa45d683e9a852b8b", "committedDate": "2020-10-08T10:45:21Z", "message": "Changed default hive.s3.use-instance-credentials to false so users can select whether to use instance creds or iam assume role"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1MTQxNTU3", "url": "https://github.com/prestodb/presto/pull/15288#pullrequestreview-505141557", "createdAt": "2020-10-08T20:29:21Z", "commit": {"oid": "add9947433037e8fd349e795da5cfea3d5c9967d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMDoyOToyMVrOHevQDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMDozNjowMFrOHevddw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk5MzQ4Ng==", "bodyText": "s/this.s3IamRole/s3IamRole/g", "url": "https://github.com/prestodb/presto/pull/15288#discussion_r501993486", "createdAt": "2020-10-08T20:29:21Z", "author": {"login": "zhenxiao"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/s3/PrestoS3FileSystem.java", "diffHunk": "@@ -210,6 +213,9 @@ public void initialize(URI uri, Configuration conf)\n         this.isPathStyleAccess = conf.getBoolean(S3_PATH_STYLE_ACCESS, defaults.isS3PathStyleAccess());\n         this.useInstanceCredentials = conf.getBoolean(S3_USE_INSTANCE_CREDENTIALS, defaults.isS3UseInstanceCredentials());\n         this.pinS3ClientToCurrentRegion = conf.getBoolean(S3_PIN_CLIENT_TO_CURRENT_REGION, defaults.isPinS3ClientToCurrentRegion());\n+        this.s3IamRole = conf.get(S3_IAM_ROLE, defaults.getS3IamRole());\n+        verify(!(useInstanceCredentials && this.s3IamRole != null),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "add9947433037e8fd349e795da5cfea3d5c9967d"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk5NDA0Ng==", "bodyText": "same for this.s3IamRole\nshall we have a roleSessionName , instead of using presto-session?", "url": "https://github.com/prestodb/presto/pull/15288#discussion_r501994046", "createdAt": "2020-10-08T20:30:22Z", "author": {"login": "zhenxiao"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/s3/PrestoS3FileSystem.java", "diffHunk": "@@ -794,6 +800,10 @@ private AWSCredentialsProvider createAwsCredentialsProvider(URI uri, Configurati\n             return InstanceProfileCredentialsProvider.getInstance();\n         }\n \n+        if (s3IamRole != null) {\n+            return new STSAssumeRoleSessionCredentialsProvider.Builder(this.s3IamRole, \"presto-session\").build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "add9947433037e8fd349e795da5cfea3d5c9967d"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk5NTAzMA==", "bodyText": "shall we have a roleSessionName  instead of using presto-session?", "url": "https://github.com/prestodb/presto/pull/15288#discussion_r501995030", "createdAt": "2020-10-08T20:32:18Z", "author": {"login": "zhenxiao"}, "path": "presto-hive-metastore/src/main/java/com/facebook/presto/hive/metastore/glue/GlueHiveMetastore.java", "diffHunk": "@@ -191,6 +193,13 @@ else if (config.getPinGlueClientToCurrentRegion()) {\n             }\n         }\n \n+        if (config.getIamRole().isPresent()) {\n+            AWSCredentialsProvider credentialsProvider = new STSAssumeRoleSessionCredentialsProvider\n+                    .Builder(config.getIamRole().get(), \"presto-session\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "add9947433037e8fd349e795da5cfea3d5c9967d"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk5NjE1OA==", "bodyText": "following https://docs.aws.amazon.com/STS/latest/APIReference/API_AssumeRole.html\ndo you think it will be valuable to specify maybe something like \"presto - \" + uri as the roleSessionName here instead of presto-session to also have the accessed uri as part of the role name?", "url": "https://github.com/prestodb/presto/pull/15288#discussion_r501996158", "createdAt": "2020-10-08T20:34:35Z", "author": {"login": "zhenxiao"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/s3/PrestoS3FileSystem.java", "diffHunk": "@@ -794,6 +800,10 @@ private AWSCredentialsProvider createAwsCredentialsProvider(URI uri, Configurati\n             return InstanceProfileCredentialsProvider.getInstance();\n         }\n \n+        if (s3IamRole != null) {\n+            return new STSAssumeRoleSessionCredentialsProvider.Builder(this.s3IamRole, \"presto-session\").build();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk5NDA0Ng=="}, "originalCommit": {"oid": "add9947433037e8fd349e795da5cfea3d5c9967d"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk5NjkxOQ==", "bodyText": "am not sure about changing the default value. @highker what do you think?", "url": "https://github.com/prestodb/presto/pull/15288#discussion_r501996919", "createdAt": "2020-10-08T20:36:00Z", "author": {"login": "zhenxiao"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/s3/HiveS3Config.java", "diffHunk": "@@ -37,7 +37,7 @@\n     private String s3Endpoint;\n     private PrestoS3SignerType s3SignerType;\n     private boolean s3PathStyleAccess;\n-    private boolean s3UseInstanceCredentials = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13d16401b6b0d5c8926dde3fa45d683e9a852b8b"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "13d16401b6b0d5c8926dde3fa45d683e9a852b8b", "author": {"user": {"login": "ashishtadose", "name": "Ashish"}}, "url": "https://github.com/prestodb/presto/commit/13d16401b6b0d5c8926dde3fa45d683e9a852b8b", "committedDate": "2020-10-08T10:45:21Z", "message": "Changed default hive.s3.use-instance-credentials to false so users can select whether to use instance creds or iam assume role"}, "afterCommit": {"oid": "90ebcf670085265ae803231e034ea6713b6a9508", "author": {"user": {"login": "ashishtadose", "name": "Ashish"}}, "url": "https://github.com/prestodb/presto/commit/90ebcf670085265ae803231e034ea6713b6a9508", "committedDate": "2020-10-09T08:20:42Z", "message": "Allow PrestoS3FileSystem and GlueHiveMetastore to assume an aws role\n\nExtracted from: https://github.com/prestodb/presto/pull/10864\n\nCo-authored-by: albert-franzi <albert.franzi@schibsted.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1OTUzNDEz", "url": "https://github.com/prestodb/presto/pull/15288#pullrequestreview-505953413", "createdAt": "2020-10-09T19:56:58Z", "commit": {"oid": "90ebcf670085265ae803231e034ea6713b6a9508"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxOTo1Njo1OFrOHfW8Zw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxOTo1OToyMFrOHfXAGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY0MzgxNQ==", "bodyText": "get it.", "url": "https://github.com/prestodb/presto/pull/15288#discussion_r502643815", "createdAt": "2020-10-09T19:56:58Z", "author": {"login": "zhenxiao"}, "path": "presto-hive/src/main/java/com/facebook/presto/hive/s3/HiveS3Config.java", "diffHunk": "@@ -37,7 +37,7 @@\n     private String s3Endpoint;\n     private PrestoS3SignerType s3SignerType;\n     private boolean s3PathStyleAccess;\n-    private boolean s3UseInstanceCredentials = true;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk5NjkxOQ=="}, "originalCommit": {"oid": "13d16401b6b0d5c8926dde3fa45d683e9a852b8b"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY0NDc2Mg==", "bodyText": "shall we keep both testInstanceCredentials and testAssumeRoleCredentials?", "url": "https://github.com/prestodb/presto/pull/15288#discussion_r502644762", "createdAt": "2020-10-09T19:59:20Z", "author": {"login": "zhenxiao"}, "path": "presto-hive/src/test/java/com/facebook/presto/hive/s3/TestPrestoS3FileSystem.java", "diffHunk": "@@ -145,15 +146,16 @@ public void testEndpointWithPinToCurrentRegionConfiguration()\n     }\n \n     @Test\n-    public void testInstanceCredentialsEnabled()\n+    public void testAssumeRoleCredentials()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "90ebcf670085265ae803231e034ea6713b6a9508"}, "originalPosition": 22}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "90ebcf670085265ae803231e034ea6713b6a9508", "author": {"user": {"login": "ashishtadose", "name": "Ashish"}}, "url": "https://github.com/prestodb/presto/commit/90ebcf670085265ae803231e034ea6713b6a9508", "committedDate": "2020-10-09T08:20:42Z", "message": "Allow PrestoS3FileSystem and GlueHiveMetastore to assume an aws role\n\nExtracted from: https://github.com/prestodb/presto/pull/10864\n\nCo-authored-by: albert-franzi <albert.franzi@schibsted.com>"}, "afterCommit": {"oid": "c03ae12cdee96a53446641eb75e639e9b71c4871", "author": {"user": {"login": "ashishtadose", "name": "Ashish"}}, "url": "https://github.com/prestodb/presto/commit/c03ae12cdee96a53446641eb75e639e9b71c4871", "committedDate": "2020-10-12T09:33:18Z", "message": "Allow PrestoS3FileSystem and GlueHiveMetastore to assume an aws role\n\nExtracted from: https://github.com/prestodb/presto/pull/10864\n\nCo-authored-by: albert-franzi <albert.franzi@schibsted.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "596e869f9f78e83f1fa7bf1d7512c9b1add905bc", "author": {"user": {"login": "ashishtadose", "name": "Ashish"}}, "url": "https://github.com/prestodb/presto/commit/596e869f9f78e83f1fa7bf1d7512c9b1add905bc", "committedDate": "2020-10-12T11:02:48Z", "message": "Allow PrestoS3FileSystem and GlueHiveMetastore to assume an aws role\n\nExtracted from: https://github.com/prestodb/presto/pull/10864\n\nCo-authored-by: albert-franzi <albert.franzi@schibsted.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c03ae12cdee96a53446641eb75e639e9b71c4871", "author": {"user": {"login": "ashishtadose", "name": "Ashish"}}, "url": "https://github.com/prestodb/presto/commit/c03ae12cdee96a53446641eb75e639e9b71c4871", "committedDate": "2020-10-12T09:33:18Z", "message": "Allow PrestoS3FileSystem and GlueHiveMetastore to assume an aws role\n\nExtracted from: https://github.com/prestodb/presto/pull/10864\n\nCo-authored-by: albert-franzi <albert.franzi@schibsted.com>"}, "afterCommit": {"oid": "596e869f9f78e83f1fa7bf1d7512c9b1add905bc", "author": {"user": {"login": "ashishtadose", "name": "Ashish"}}, "url": "https://github.com/prestodb/presto/commit/596e869f9f78e83f1fa7bf1d7512c9b1add905bc", "committedDate": "2020-10-12T11:02:48Z", "message": "Allow PrestoS3FileSystem and GlueHiveMetastore to assume an aws role\n\nExtracted from: https://github.com/prestodb/presto/pull/10864\n\nCo-authored-by: albert-franzi <albert.franzi@schibsted.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2NzcxMTQ0", "url": "https://github.com/prestodb/presto/pull/15288#pullrequestreview-506771144", "createdAt": "2020-10-12T16:41:18Z", "commit": {"oid": "596e869f9f78e83f1fa7bf1d7512c9b1add905bc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4876, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}