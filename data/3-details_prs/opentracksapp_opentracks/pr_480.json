{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEyNDUxMDAy", "number": 480, "title": "Database enforces foreign key constraints incl. cascading deletes.", "bodyText": "So far the three tables were independent of each other (from a database perspective).\nI added now foreign key constraints incl. cascading deletes for trackId.\nThus, if a track get's deleted the database automatically deletes all referencing trackpoints and marker automatically.\nHowever, this has a drawback: There is only one notification for consent observer (i.e., the track got deleted). So far, we sent one for each trackpoint and marker as well.\nAlso the trackId column is now NOT NULL.", "createdAt": "2020-10-29T17:44:22Z", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/480", "merged": true, "mergeCommit": {"oid": "48c3695b5df54861dba544ec36ac576c7abf388b"}, "closed": true, "closedAt": "2020-10-30T20:26:14Z", "author": {"login": "dennisguse"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXVy42gH2gAyNTEyNDUxMDAyOmYyNDc3YmZlMGI1ZTBhNWU0ZmRiNGJmMTUxMWQ5ODY4NWNiMzhkYTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXr6O4gFqTUyMDk3MDEzNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f2477bfe0b5e0a5e4fdb4bf1511d98685cb38da1", "author": {"user": {"login": "dennisguse", "name": "Dennis Guse"}}, "url": "https://github.com/OpenTracksApp/OpenTracks/commit/f2477bfe0b5e0a5e4fdb4bf1511d98685cb38da1", "committedDate": "2020-10-29T17:41:05Z", "message": "Database enforces foreign key constraints incl. cascading deletes.\nFixes #317."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwMDA2Njc5", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/480#pullrequestreview-520006679", "createdAt": "2020-10-29T19:32:20Z", "commit": {"oid": "f2477bfe0b5e0a5e4fdb4bf1511d98685cb38da1"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxOTozMjoyMFrOHqrdAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxOTozMjoyMFrOHqrdAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDUxNDE3OA==", "bodyText": "downgrade contains the foreign key?", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/480#discussion_r514514178", "createdAt": "2020-10-29T19:32:20Z", "author": {"login": "pstorch"}, "path": "src/main/java/de/dennisguse/opentracks/content/provider/CustomSQLiteOpenHelper.java", "diffHunk": "@@ -220,4 +234,54 @@ private void downgradeFrom27to26(SQLiteDatabase db) {\n         db.setTransactionSuccessful();\n         db.endTransaction();\n     }\n+\n+    /**\n+     * Add foreign key constraints on trackId\n+     */\n+    private void upgradeFrom27to28(SQLiteDatabase db) {\n+        db.beginTransaction();\n+\n+        // TrackPoints\n+        db.execSQL(\"ALTER TABLE trackpoints RENAME TO trackpoints_old\");\n+        db.execSQL(\"CREATE TABLE trackpoints (_id INTEGER PRIMARY KEY AUTOINCREMENT, trackid INTEGER NOT NULL, longitude INTEGER, latitude INTEGER, time INTEGER, elevation FLOAT, accuracy FLOAT, speed FLOAT, bearing FLOAT, sensor_heartrate FLOAT, sensor_cadence FLOAT, sensor_power FLOAT, elevation_gain FLOAT, FOREIGN KEY (trackid) REFERENCES tracks(_id) ON UPDATE CASCADE ON DELETE CASCADE)\");\n+        db.execSQL(\"INSERT INTO trackpoints SELECT _id, trackid, longitude, latitude, time, elevation, accuracy, speed, bearing, sensor_heartrate, sensor_cadence, sensor_power, elevation_gain FROM trackpoints_old\");\n+        db.execSQL(\"DROP TABLE trackpoints_old\");\n+\n+        db.execSQL(\"CREATE INDEX trackpoints_trackid_index ON trackpoints(trackid)\");\n+\n+        // Markers\n+        db.execSQL(\"ALTER TABLE waypoints RENAME TO markers_old\");\n+        db.execSQL(\"CREATE TABLE markers (_id INTEGER PRIMARY KEY AUTOINCREMENT, name TEXT, description TEXT, category TEXT, icon TEXT, trackid INTEGER NOT NULL, length FLOAT, duration INTEGER, longitude INTEGER, latitude INTEGER, time INTEGER, elevation FLOAT, accuracy FLOAT, bearing FLOAT, photoUrl TEXT, FOREIGN KEY (trackid) REFERENCES tracks(_id) ON UPDATE CASCADE ON DELETE CASCADE)\");\n+\n+        db.execSQL(\"INSERT INTO markers SELECT _id, name, description, category, icon, trackid, length, duration, longitude, latitude, time, elevation, accuracy, bearing, photoUrl FROM markers_old\");\n+        db.execSQL(\"DROP TABLE markers_old\");\n+\n+        db.execSQL(\"CREATE INDEX markers_trackid_index ON markers(trackid)\");\n+\n+        db.setTransactionSuccessful();\n+        db.endTransaction();\n+    }\n+\n+    private void downgradeFrom28to27(SQLiteDatabase db) {\n+        db.beginTransaction();\n+\n+        // TrackPoints\n+        db.execSQL(\"ALTER TABLE trackpoints RENAME TO trackpoints_old\");\n+        db.execSQL(\"CREATE TABLE trackpoints (_id INTEGER PRIMARY KEY AUTOINCREMENT, trackid INTEGER NOT NULL, longitude INTEGER, latitude INTEGER, time INTEGER, elevation FLOAT, accuracy FLOAT, speed FLOAT, bearing FLOAT, sensor_heartrate FLOAT, sensor_cadence FLOAT, sensor_power FLOAT, elevation_gain FLOAT, FOREIGN KEY (trackid) REFERENCES tracks(_id) ON UPDATE CASCADE ON DELETE CASCADE)\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f2477bfe0b5e0a5e4fdb4bf1511d98685cb38da1"}, "originalPosition": 97}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eda15fc2cd5273e10013954280408e502f79f0de", "author": {"user": {"login": "dennisguse", "name": "Dennis Guse"}}, "url": "https://github.com/OpenTracksApp/OpenTracks/commit/eda15fc2cd5273e10013954280408e502f79f0de", "committedDate": "2020-10-29T23:01:47Z", "message": "OnDowngrade: remove foreign key."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwOTcwMTM0", "url": "https://github.com/OpenTracksApp/OpenTracks/pull/480#pullrequestreview-520970134", "createdAt": "2020-10-30T19:27:01Z", "commit": {"oid": "eda15fc2cd5273e10013954280408e502f79f0de"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2280, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}