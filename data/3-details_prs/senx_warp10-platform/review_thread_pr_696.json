{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg5MjExNjY4", "number": 696, "reviewThreads": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxMzozMTo1OFrODoVVoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNDo1NDo0MVrODowXVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzNjE5MjMyOnYy", "diffSide": "RIGHT", "path": "warp10/src/main/java/io/warp10/script/ext/token/TokenWarpScriptExtension.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxMzozMTo1OFrOF20SAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxMzozMTo1OFrOF20SAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzAyNDAwMA==", "bodyText": "Don't call getKeyStore multiple times, the whole keystore gets cloned when you do so.\nSpecify StandardCharsets.UTF_8 when creating the String instance.", "url": "https://github.com/senx/warp10-platform/pull/696#discussion_r393024000", "createdAt": "2020-03-16T13:31:58Z", "author": {"login": "hbs"}, "path": "warp10/src/main/java/io/warp10/script/ext/token/TokenWarpScriptExtension.java", "diffHunk": "@@ -16,57 +16,58 @@\n \n package io.warp10.script.ext.token;\n \n-import java.util.HashMap;\n-import java.util.Map;\n-import java.util.Properties;\n-\n import io.warp10.WarpConfig;\n-import io.warp10.WarpDist;\n import io.warp10.crypto.KeyStore;\n import io.warp10.standalone.Warp;\n import io.warp10.warp.sdk.WarpScriptExtension;\n \n+import java.util.HashMap;\n+import java.util.Map;\n+\n public class TokenWarpScriptExtension extends WarpScriptExtension {\n-  \n+\n   /*\n-   *  Name of configuration key with the token secret. \n+   *  Name of configuration key with the token secret.\n    */\n   public static final String CONF_TOKEN_SECRET = \"token.secret\";\n-  \n+\n   /**\n    * Current Token Secret\n    */\n   public static String TOKEN_SECRET = null;\n-  \n-  private static final Map<String,Object> functions = new HashMap<String,Object>();\n+\n+  private static final Map<String, Object> functions = new HashMap<String, Object>();\n   private static final KeyStore keystore;\n-  \n+\n   static {\n     TOKEN_SECRET = WarpConfig.getProperty(CONF_TOKEN_SECRET);\n+    if(null != Warp.getKeyStore().getKey(TokenWarpScriptExtension.CONF_TOKEN_SECRET)){\n+      TOKEN_SECRET = new String(Warp.getKeyStore().getKey(TokenWarpScriptExtension.CONF_TOKEN_SECRET)).replaceAll(\"\\n\", \"\").trim();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5bb0cca58eb9467e9ecf3020588296bbdd831c3e"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzNjIwMDQ1OnYy", "diffSide": "RIGHT", "path": "warp10/src/main/java/io/warp10/script/ext/token/TokenWarpScriptExtension.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxMzozNDowM1rOF20XFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxMzozNDowM1rOF20XFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzAyNTMwMg==", "bodyText": "Warp.getKeyStore could return null", "url": "https://github.com/senx/warp10-platform/pull/696#discussion_r393025302", "createdAt": "2020-03-16T13:34:03Z", "author": {"login": "hbs"}, "path": "warp10/src/main/java/io/warp10/script/ext/token/TokenWarpScriptExtension.java", "diffHunk": "@@ -16,57 +16,58 @@\n \n package io.warp10.script.ext.token;\n \n-import java.util.HashMap;\n-import java.util.Map;\n-import java.util.Properties;\n-\n import io.warp10.WarpConfig;\n-import io.warp10.WarpDist;\n import io.warp10.crypto.KeyStore;\n import io.warp10.standalone.Warp;\n import io.warp10.warp.sdk.WarpScriptExtension;\n \n+import java.util.HashMap;\n+import java.util.Map;\n+\n public class TokenWarpScriptExtension extends WarpScriptExtension {\n-  \n+\n   /*\n-   *  Name of configuration key with the token secret. \n+   *  Name of configuration key with the token secret.\n    */\n   public static final String CONF_TOKEN_SECRET = \"token.secret\";\n-  \n+\n   /**\n    * Current Token Secret\n    */\n   public static String TOKEN_SECRET = null;\n-  \n-  private static final Map<String,Object> functions = new HashMap<String,Object>();\n+\n+  private static final Map<String, Object> functions = new HashMap<String, Object>();\n   private static final KeyStore keystore;\n-  \n+\n   static {\n     TOKEN_SECRET = WarpConfig.getProperty(CONF_TOKEN_SECRET);\n+    if(null != Warp.getKeyStore().getKey(TokenWarpScriptExtension.CONF_TOKEN_SECRET)){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5bb0cca58eb9467e9ecf3020588296bbdd831c3e"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzNjIwNTE5OnYy", "diffSide": "RIGHT", "path": "warp10/src/main/java/io/warp10/script/ext/token/TokenWarpScriptExtension.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxMzozNToyOFrOF20aUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxMzozNToyOFrOF20aUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzAyNjEyOA==", "bodyText": "Add a comment here and in the documentation templates explaining that warp.key.token.secret will prevail if it exists.", "url": "https://github.com/senx/warp10-platform/pull/696#discussion_r393026128", "createdAt": "2020-03-16T13:35:28Z", "author": {"login": "hbs"}, "path": "warp10/src/main/java/io/warp10/script/ext/token/TokenWarpScriptExtension.java", "diffHunk": "@@ -16,57 +16,58 @@\n \n package io.warp10.script.ext.token;\n \n-import java.util.HashMap;\n-import java.util.Map;\n-import java.util.Properties;\n-\n import io.warp10.WarpConfig;\n-import io.warp10.WarpDist;\n import io.warp10.crypto.KeyStore;\n import io.warp10.standalone.Warp;\n import io.warp10.warp.sdk.WarpScriptExtension;\n \n+import java.util.HashMap;\n+import java.util.Map;\n+\n public class TokenWarpScriptExtension extends WarpScriptExtension {\n-  \n+\n   /*\n-   *  Name of configuration key with the token secret. \n+   *  Name of configuration key with the token secret.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5bb0cca58eb9467e9ecf3020588296bbdd831c3e"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzNjIwNzM2OnYy", "diffSide": "RIGHT", "path": "warp10/src/main/java/io/warp10/json/JsonUtils.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxMzozNjowMVrOF20bsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxMzo0MToyMFrOF20oow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzAyNjQ4Mg==", "bodyText": "This part of the PR doesn't have much to do with the rest!", "url": "https://github.com/senx/warp10-platform/pull/696#discussion_r393026482", "createdAt": "2020-03-16T13:36:01Z", "author": {"login": "hbs"}, "path": "warp10/src/main/java/io/warp10/json/JsonUtils.java", "diffHunk": "@@ -31,11 +31,6 @@\n import com.fasterxml.jackson.databind.ser.BeanSerializer;\n import com.fasterxml.jackson.databind.ser.BeanSerializerModifier;\n import com.fasterxml.jackson.databind.ser.impl.UnknownSerializer;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5bb0cca58eb9467e9ecf3020588296bbdd831c3e"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzAyOTc5NQ==", "bodyText": "I know, it will be a part of a second PR.", "url": "https://github.com/senx/warp10-platform/pull/696#discussion_r393029795", "createdAt": "2020-03-16T13:41:20Z", "author": {"login": "Giwi"}, "path": "warp10/src/main/java/io/warp10/json/JsonUtils.java", "diffHunk": "@@ -31,11 +31,6 @@\n import com.fasterxml.jackson.databind.ser.BeanSerializer;\n import com.fasterxml.jackson.databind.ser.BeanSerializerModifier;\n import com.fasterxml.jackson.databind.ser.impl.UnknownSerializer;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzAyNjQ4Mg=="}, "originalCommit": {"oid": "5bb0cca58eb9467e9ecf3020588296bbdd831c3e"}, "originalPosition": 3}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzOTI2MzA4OnYy", "diffSide": "RIGHT", "path": "warp10/src/main/java/io/warp10/script/ext/token/TokenWarpScriptExtension.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QwODozODo1MlrOF3SXxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QwODozODo1MlrOF3SXxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzUxNjk5OA==", "bodyText": "Extract the key only once with nested ifs.", "url": "https://github.com/senx/warp10-platform/pull/696#discussion_r393516998", "createdAt": "2020-03-17T08:38:52Z", "author": {"login": "hbs"}, "path": "warp10/src/main/java/io/warp10/script/ext/token/TokenWarpScriptExtension.java", "diffHunk": "@@ -16,57 +16,61 @@\n \n package io.warp10.script.ext.token;\n \n-import java.util.HashMap;\n-import java.util.Map;\n-import java.util.Properties;\n-\n import io.warp10.WarpConfig;\n-import io.warp10.WarpDist;\n import io.warp10.crypto.KeyStore;\n import io.warp10.standalone.Warp;\n import io.warp10.warp.sdk.WarpScriptExtension;\n \n+import java.nio.charset.StandardCharsets;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n public class TokenWarpScriptExtension extends WarpScriptExtension {\n-  \n+\n   /*\n-   *  Name of configuration key with the token secret. \n+   *  Name of configuration key with the token secret.\n+   *\n+   * Must be warp.key.token.secret if handled by OSS\n    */\n   public static final String CONF_TOKEN_SECRET = \"token.secret\";\n-  \n+\n   /**\n    * Current Token Secret\n    */\n   public static String TOKEN_SECRET = null;\n-  \n-  private static final Map<String,Object> functions = new HashMap<String,Object>();\n+\n+  private static final Map<String, Object> functions = new HashMap<String, Object>();\n   private static final KeyStore keystore;\n-  \n+\n   static {\n     TOKEN_SECRET = WarpConfig.getProperty(CONF_TOKEN_SECRET);\n \n-    if (null != TOKEN_SECRET) {\n+    if (null == TOKEN_SECRET) {\n       keystore = Warp.getKeyStore();\n+      if (null != keystore && null != keystore.getKey(TokenWarpScriptExtension.CONF_TOKEN_SECRET)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b20e5fce2bb72fdb1c971a078cefe266a38b245d"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzOTI2OTgyOnYy", "diffSide": "RIGHT", "path": "warp10/src/main/java/io/warp10/script/ext/token/TokenWarpScriptExtension.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QwODo0MTowN1rOF3ScLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QwODo0MTowN1rOF3ScLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzUxODEyNg==", "bodyText": "Use separate constants to make the code clearer, even though they have the same value. CONF_TOKEN_SECRET for the configuration key, KEY_TOKEN_SECRET for the KeyStore key. Clearly describe the behavior in the comments. As it is now it is rather hard to understand since you say \"Myst be warp.key.token.secret is handled by OSS\" with a constant defined below. What should I do if I want to use OSS? Recompile the code with a different value of CONF_TOKEN_SECRET?", "url": "https://github.com/senx/warp10-platform/pull/696#discussion_r393518126", "createdAt": "2020-03-17T08:41:07Z", "author": {"login": "hbs"}, "path": "warp10/src/main/java/io/warp10/script/ext/token/TokenWarpScriptExtension.java", "diffHunk": "@@ -16,57 +16,61 @@\n \n package io.warp10.script.ext.token;\n \n-import java.util.HashMap;\n-import java.util.Map;\n-import java.util.Properties;\n-\n import io.warp10.WarpConfig;\n-import io.warp10.WarpDist;\n import io.warp10.crypto.KeyStore;\n import io.warp10.standalone.Warp;\n import io.warp10.warp.sdk.WarpScriptExtension;\n \n+import java.nio.charset.StandardCharsets;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n public class TokenWarpScriptExtension extends WarpScriptExtension {\n-  \n+\n   /*\n-   *  Name of configuration key with the token secret. \n+   *  Name of configuration key with the token secret.\n+   *\n+   * Must be warp.key.token.secret if handled by OSS\n    */\n   public static final String CONF_TOKEN_SECRET = \"token.secret\";\n-  \n+\n   /**\n    * Current Token Secret\n    */\n   public static String TOKEN_SECRET = null;\n-  \n-  private static final Map<String,Object> functions = new HashMap<String,Object>();\n+\n+  private static final Map<String, Object> functions = new HashMap<String, Object>();\n   private static final KeyStore keystore;\n-  \n+\n   static {\n     TOKEN_SECRET = WarpConfig.getProperty(CONF_TOKEN_SECRET);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b20e5fce2bb72fdb1c971a078cefe266a38b245d"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzOTU3Njk4OnYy", "diffSide": "RIGHT", "path": "warp10/src/main/java/io/warp10/script/ext/token/TokenWarpScriptExtension.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxMDowODozNVrOF3Vfbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNDoyMTozM1rOF3edbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzU2ODExMQ==", "bodyText": "Unwrapping of any configuration key prefixed with Configuration.WARP_KEY_PREFIX is automatic, the only thing you have to do is to attempt to retrieve the KEY_TOKEN_SECRET key and use it if it is set.\nSo KEY_TOKEN_SECRET should be \"token.secret\"", "url": "https://github.com/senx/warp10-platform/pull/696#discussion_r393568111", "createdAt": "2020-03-17T10:08:35Z", "author": {"login": "hbs"}, "path": "warp10/src/main/java/io/warp10/script/ext/token/TokenWarpScriptExtension.java", "diffHunk": "@@ -16,57 +16,73 @@\n \n package io.warp10.script.ext.token;\n \n-import java.util.HashMap;\n-import java.util.Map;\n-import java.util.Properties;\n-\n import io.warp10.WarpConfig;\n-import io.warp10.WarpDist;\n import io.warp10.crypto.KeyStore;\n import io.warp10.standalone.Warp;\n import io.warp10.warp.sdk.WarpScriptExtension;\n \n+import java.nio.charset.StandardCharsets;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n public class TokenWarpScriptExtension extends WarpScriptExtension {\n-  \n+\n   /*\n-   *  Name of configuration key with the token secret. \n+   * Name of configuration key with the token secret.\n    */\n   public static final String CONF_TOKEN_SECRET = \"token.secret\";\n-  \n+  /*\n+   * Name of configuration key with OSS wrapped token secret\n+   * ie: warp.key.token.secret  = wrapped:hex:xxxxx\n+   */\n+  public static final String KEY_TOKEN_SECRET = \"warp.key.token.secret\";\n+\n   /**\n    * Current Token Secret\n    */\n   public static String TOKEN_SECRET = null;\n-  \n-  private static final Map<String,Object> functions = new HashMap<String,Object>();\n+\n+  private static final Map<String, Object> functions = new HashMap<String, Object>();\n   private static final KeyStore keystore;\n-  \n+\n   static {\n     TOKEN_SECRET = WarpConfig.getProperty(CONF_TOKEN_SECRET);\n-\n-    if (null != TOKEN_SECRET) {\n-      keystore = Warp.getKeyStore();\n+    if (null == TOKEN_SECRET) {\n+      // if OSS wrapped secret exists\n+      TOKEN_SECRET = WarpConfig.getProperty(KEY_TOKEN_SECRET);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7ac2fec9e5bd56ab09e88a4a67676fb3b859deb"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzcxNTA1NQ==", "bodyText": "indeed", "url": "https://github.com/senx/warp10-platform/pull/696#discussion_r393715055", "createdAt": "2020-03-17T14:21:33Z", "author": {"login": "Giwi"}, "path": "warp10/src/main/java/io/warp10/script/ext/token/TokenWarpScriptExtension.java", "diffHunk": "@@ -16,57 +16,73 @@\n \n package io.warp10.script.ext.token;\n \n-import java.util.HashMap;\n-import java.util.Map;\n-import java.util.Properties;\n-\n import io.warp10.WarpConfig;\n-import io.warp10.WarpDist;\n import io.warp10.crypto.KeyStore;\n import io.warp10.standalone.Warp;\n import io.warp10.warp.sdk.WarpScriptExtension;\n \n+import java.nio.charset.StandardCharsets;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n public class TokenWarpScriptExtension extends WarpScriptExtension {\n-  \n+\n   /*\n-   *  Name of configuration key with the token secret. \n+   * Name of configuration key with the token secret.\n    */\n   public static final String CONF_TOKEN_SECRET = \"token.secret\";\n-  \n+  /*\n+   * Name of configuration key with OSS wrapped token secret\n+   * ie: warp.key.token.secret  = wrapped:hex:xxxxx\n+   */\n+  public static final String KEY_TOKEN_SECRET = \"warp.key.token.secret\";\n+\n   /**\n    * Current Token Secret\n    */\n   public static String TOKEN_SECRET = null;\n-  \n-  private static final Map<String,Object> functions = new HashMap<String,Object>();\n+\n+  private static final Map<String, Object> functions = new HashMap<String, Object>();\n   private static final KeyStore keystore;\n-  \n+\n   static {\n     TOKEN_SECRET = WarpConfig.getProperty(CONF_TOKEN_SECRET);\n-\n-    if (null != TOKEN_SECRET) {\n-      keystore = Warp.getKeyStore();\n+    if (null == TOKEN_SECRET) {\n+      // if OSS wrapped secret exists\n+      TOKEN_SECRET = WarpConfig.getProperty(KEY_TOKEN_SECRET);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzU2ODExMQ=="}, "originalCommit": {"oid": "b7ac2fec9e5bd56ab09e88a4a67676fb3b859deb"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzOTU3OTAyOnYy", "diffSide": "RIGHT", "path": "etc/conf.templates/standalone/70--extensions.conf.template", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxMDowOToxMFrOF3VgwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxMDowOToxMFrOF3VgwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzU2ODQ0OQ==", "bodyText": "You need to modify the distributed configuration template too.", "url": "https://github.com/senx/warp10-platform/pull/696#discussion_r393568449", "createdAt": "2020-03-17T10:09:10Z", "author": {"login": "hbs"}, "path": "etc/conf.templates/standalone/70--extensions.conf.template", "diffHunk": "@@ -50,9 +50,14 @@\n #warpscript.extension.sensision = io.warp10.script.ext.sensision.SensisionWarpScriptExtension\n // MUTEX, SHMLOAD, SHMSTORE\n #warpscript.extension.shm = io.warp10.script.ext.shm.SharedMemoryWarpScriptExtension\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7ac2fec9e5bd56ab09e88a4a67676fb3b859deb"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzOTU4MDI0OnYy", "diffSide": "RIGHT", "path": "etc/conf.templates/standalone/70--extensions.conf.template", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxMDowOTozM1rOF3VhnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxMDowOTozM1rOF3VhnQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzU2ODY2OQ==", "bodyText": "Explain more clearly how this is taken into account vs token.secret", "url": "https://github.com/senx/warp10-platform/pull/696#discussion_r393568669", "createdAt": "2020-03-17T10:09:33Z", "author": {"login": "hbs"}, "path": "etc/conf.templates/standalone/70--extensions.conf.template", "diffHunk": "@@ -50,9 +50,14 @@\n #warpscript.extension.sensision = io.warp10.script.ext.sensision.SensisionWarpScriptExtension\n // MUTEX, SHMLOAD, SHMSTORE\n #warpscript.extension.shm = io.warp10.script.ext.shm.SharedMemoryWarpScriptExtension\n+\n // TOKENDUMP, TOKENGEN, TOKENSECRET\n #warpscript.extension.token = io.warp10.script.ext.token.TokenWarpScriptExtension\n+// If you use OSS to handle this secret", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7ac2fec9e5bd56ab09e88a4a67676fb3b859deb"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0MDUxMDg4OnYy", "diffSide": "RIGHT", "path": "warp10/src/main/java/io/warp10/script/ext/token/TokenWarpScriptExtension.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNDoyOTozMVrOF3e1IQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNDoyOTozMVrOF3e1IQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzcyMTEyMQ==", "bodyText": "It's actually the name of the secret in the key store, not in the configuration.", "url": "https://github.com/senx/warp10-platform/pull/696#discussion_r393721121", "createdAt": "2020-03-17T14:29:31Z", "author": {"login": "hbs"}, "path": "warp10/src/main/java/io/warp10/script/ext/token/TokenWarpScriptExtension.java", "diffHunk": "@@ -35,7 +35,7 @@\n    * Name of configuration key with OSS wrapped token secret", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "77ca838c38d79fd51c3bb613e7733301b983e05a"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0MDUxODU4OnYy", "diffSide": "RIGHT", "path": "warp10/src/main/java/io/warp10/script/ext/token/TokenWarpScriptExtension.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNDozMToxM1rOF3e6LQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNDozMToxM1rOF3e6LQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzcyMjQxMw==", "bodyText": "This should test the existence of the key in the keystore, i.e. Warp.getKeyStore().getKey(KEY_TOKEN_SECRET) and then set TOKEN_SECRET accordingly, here this would always set TOKEN_SECRET to null since you already checked the same configuration key.", "url": "https://github.com/senx/warp10-platform/pull/696#discussion_r393722413", "createdAt": "2020-03-17T14:31:13Z", "author": {"login": "hbs"}, "path": "warp10/src/main/java/io/warp10/script/ext/token/TokenWarpScriptExtension.java", "diffHunk": "@@ -16,57 +16,73 @@\n \n package io.warp10.script.ext.token;\n \n-import java.util.HashMap;\n-import java.util.Map;\n-import java.util.Properties;\n-\n import io.warp10.WarpConfig;\n-import io.warp10.WarpDist;\n import io.warp10.crypto.KeyStore;\n import io.warp10.standalone.Warp;\n import io.warp10.warp.sdk.WarpScriptExtension;\n \n+import java.nio.charset.StandardCharsets;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n public class TokenWarpScriptExtension extends WarpScriptExtension {\n-  \n+\n   /*\n-   *  Name of configuration key with the token secret. \n+   * Name of configuration key with the token secret.\n    */\n   public static final String CONF_TOKEN_SECRET = \"token.secret\";\n-  \n+  /*\n+   * Name of configuration key with OSS wrapped token secret\n+   * ie: warp.key.token.secret  = wrapped:hex:xxxxx\n+   */\n+  public static final String KEY_TOKEN_SECRET = \"token.secret\";\n+\n   /**\n    * Current Token Secret\n    */\n   public static String TOKEN_SECRET = null;\n-  \n-  private static final Map<String,Object> functions = new HashMap<String,Object>();\n+\n+  private static final Map<String, Object> functions = new HashMap<String, Object>();\n   private static final KeyStore keystore;\n-  \n+\n   static {\n     TOKEN_SECRET = WarpConfig.getProperty(CONF_TOKEN_SECRET);\n-\n-    if (null != TOKEN_SECRET) {\n-      keystore = Warp.getKeyStore();\n+    if (null == TOKEN_SECRET) {\n+      // if OSS wrapped secret exists\n+      TOKEN_SECRET = WarpConfig.getProperty(KEY_TOKEN_SECRET);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "77ca838c38d79fd51c3bb613e7733301b983e05a"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0MDYyMDM5OnYy", "diffSide": "RIGHT", "path": "warp10/src/main/java/io/warp10/script/ext/token/TokenWarpScriptExtension.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNDo1NDo0MVrOF3f9Cg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNDo1NDo0MVrOF3f9Cg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzczOTUzMA==", "bodyText": "Rename this variable ks so it differs frankly from keystore", "url": "https://github.com/senx/warp10-platform/pull/696#discussion_r393739530", "createdAt": "2020-03-17T14:54:41Z", "author": {"login": "hbs"}, "path": "warp10/src/main/java/io/warp10/script/ext/token/TokenWarpScriptExtension.java", "diffHunk": "@@ -16,57 +16,73 @@\n \n package io.warp10.script.ext.token;\n \n-import java.util.HashMap;\n-import java.util.Map;\n-import java.util.Properties;\n-\n import io.warp10.WarpConfig;\n-import io.warp10.WarpDist;\n import io.warp10.crypto.KeyStore;\n import io.warp10.standalone.Warp;\n import io.warp10.warp.sdk.WarpScriptExtension;\n \n+import java.nio.charset.StandardCharsets;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n public class TokenWarpScriptExtension extends WarpScriptExtension {\n-  \n+\n   /*\n-   *  Name of configuration key with the token secret. \n+   * Name of configuration key with the token secret.\n    */\n   public static final String CONF_TOKEN_SECRET = \"token.secret\";\n-  \n+  /*\n+   * Name of configuration key with OSS wrapped token secret\n+   * ie: warp.key.token.secret  = wrapped:hex:xxxxx\n+   */\n+  public static final String KEY_TOKEN_SECRET = \"token.secret\";\n+\n   /**\n    * Current Token Secret\n    */\n   public static String TOKEN_SECRET = null;\n-  \n-  private static final Map<String,Object> functions = new HashMap<String,Object>();\n+\n+  private static final Map<String, Object> functions = new HashMap<String, Object>();\n   private static final KeyStore keystore;\n-  \n+\n   static {\n     TOKEN_SECRET = WarpConfig.getProperty(CONF_TOKEN_SECRET);\n-\n-    if (null != TOKEN_SECRET) {\n-      keystore = Warp.getKeyStore();\n+    if (null == TOKEN_SECRET) {\n+      // if OSS wrapped secret exists\n+      TOKEN_SECRET = WarpConfig.getProperty(KEY_TOKEN_SECRET);\n+      if (null == TOKEN_SECRET) { // if no configuration key\n+        keystore =  Warp.getKeyStore();\n+      } else {\n+        keystore = null;\n+        KeyStore keyStore = Warp.getKeyStore();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "77ca838c38d79fd51c3bb613e7733301b983e05a"}, "originalPosition": 56}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1206, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}