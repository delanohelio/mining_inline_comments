{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE3NjM0NzY1", "number": 867, "title": "Modified safe delta mode to allow for fast merges in more cases", "bodyText": "", "createdAt": "2020-11-09T09:54:42Z", "url": "https://github.com/senx/warp10-platform/pull/867", "merged": true, "mergeCommit": {"oid": "23b49571a55162f4b2da32eaff286ef589a3cbe4"}, "closed": true, "closedAt": "2020-11-27T21:49:18Z", "author": {"login": "hbs"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdaxtIzgH2gAyNTE3NjM0NzY1OmQ2OGU1MzhhNmQ3NzIyNTgyNmYzMmIyMjY4Y2E4ZGZiNGE4MzVjOTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdeDebjgFqTUzNDQ4OTE4OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d68e538a6d77225826f32b2268ca8dfb4a835c91", "author": {"user": {"login": "hbs", "name": "Mathias Herberts"}}, "url": "https://github.com/senx/warp10-platform/commit/d68e538a6d77225826f32b2268ca8dfb4a835c91", "committedDate": "2020-11-09T09:53:55Z", "message": "Modified safe delta mode to allow for fast merges in more cases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef1d5bdb7e2fc3244930000477b34da2749f6c06", "author": {"user": {"login": "hbs", "name": "Mathias Herberts"}}, "url": "https://github.com/senx/warp10-platform/commit/ef1d5bdb7e2fc3244930000477b34da2749f6c06", "committedDate": "2020-11-13T12:48:11Z", "message": "Refactored to check validity of last value on a per type basis"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7d2bef74d0b1f91f02527bc02577565d3ff9372", "author": {"user": {"login": "hbs", "name": "Mathias Herberts"}}, "url": "https://github.com/senx/warp10-platform/commit/b7d2bef74d0b1f91f02527bc02577565d3ff9372", "committedDate": "2020-11-16T14:59:49Z", "message": "Fixed encoding of NaNs which never lead to IDENTICAL encoding."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0MjEzNjAw", "url": "https://github.com/senx/warp10-platform/pull/867#pullrequestreview-534213600", "createdAt": "2020-11-19T09:12:05Z", "commit": {"oid": "b7d2bef74d0b1f91f02527bc02577565d3ff9372"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwOToxMjowNlrOH2TWTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwOTo1NTozMFrOH2VHpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjcwMjE1OQ==", "bodyText": "I think validLastDoubleValue and validLastBDValue could also be used to tell if the last floating-point value is encoded as BigDecimal or doubleinstead of setting lastBDValue to null:\n\nvalidLastDoubleValue && !validLastBDValue -> last value encoded as double\n!validLastDoubleValue && validLastBDValue -> last value encoded as BigDecimal\n!validLastDoubleValue && !validLastBDValue -> unknown last value floating-point value\nvalidLastDoubleValue && validLastBDValue -> cannot happen\n\nThus validLastDoubleValue && null == lastBDValue could be replaced by validLastDoubleValue.", "url": "https://github.com/senx/warp10-platform/pull/867#discussion_r526702159", "createdAt": "2020-11-19T09:12:06Z", "author": {"login": "ftence"}, "path": "warp10/src/main/java/io/warp10/continuum/gts/GTSEncoder.java", "diffHunk": "@@ -378,22 +386,26 @@ public synchronized int addValue(long timestamp, long location, long elevation,\n       } else {\n         tsTypeFlag |= FLAGS_BOOLEAN_VALUE_FALSE;\n       }\n-      \n+\n     } else if (value instanceof String) {\n       tsTypeFlag |= FLAGS_TYPE_STRING;\n-      if (((String) value).equals(lastStringValue)) {\n+      if (validLastStringValue && ((String) value).equals(lastStringValue)) {\n         tsTypeFlag |= FLAGS_VALUE_IDENTICAL;\n       }\n     } else if (value instanceof byte[]) {\n       tsTypeFlag |= FLAGS_TYPE_STRING | FLAGS_STRING_BINARY;\n       binaryString = new String((byte[]) value, StandardCharsets.ISO_8859_1);\n-      if (binaryString.equals(lastStringValue)) {\n+      if (validLastStringValue && binaryString.equals(lastStringValue)) {\n         tsTypeFlag |= FLAGS_VALUE_IDENTICAL;\n       }\n     } else if (value instanceof Double || value instanceof Float) {\n       tsTypeFlag |= FLAGS_TYPE_DOUBLE;\n       // Only compare to the previous double value if the last floating point value was NOT encoded as a BigDecimal\n-      if (null == lastBDValue && lastDoubleValue == ((Number) value).doubleValue()) {\n+      if (validLastDoubleValue\n+          && null == lastBDValue", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7d2bef74d0b1f91f02527bc02577565d3ff9372"}, "originalPosition": 238}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjcwMzEyOQ==", "bodyText": "Ditto, only testing validLastBDValue should be enough to be sure lastBDValue is non-null. It can be argued that the nullity check prevents a NPE though.", "url": "https://github.com/senx/warp10-platform/pull/867#discussion_r526703129", "createdAt": "2020-11-19T09:13:44Z", "author": {"login": "ftence"}, "path": "warp10/src/main/java/io/warp10/continuum/gts/GTSEncoder.java", "diffHunk": "@@ -405,7 +417,7 @@ public synchronized int addValue(long timestamp, long location, long elevation,\n       // Strip trailing zero so we optimize the representation\n       doubleValue = doubleValue.stripTrailingZeros();\n \n-      if (null != lastBDValue && 0 == lastBDValue.compareTo(doubleValue)) {\n+      if (validLastBDValue && null != lastBDValue && 0 == lastBDValue.compareTo(doubleValue)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7d2bef74d0b1f91f02527bc02577565d3ff9372"}, "originalPosition": 250}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjcwMzc3MQ==", "bodyText": "lastGeoXPPoint = GeoTimeSerie.NO_LOCATION; is unnecessary since validLastGeoXPPoint is set to false.", "url": "https://github.com/senx/warp10-platform/pull/867#discussion_r526703771", "createdAt": "2020-11-19T09:14:45Z", "author": {"login": "ftence"}, "path": "warp10/src/main/java/io/warp10/continuum/gts/GTSEncoder.java", "diffHunk": "@@ -460,10 +472,10 @@ public synchronized int addValue(long timestamp, long location, long elevation,\n         }\n       } else {\n         // Do nothing, implicitly we will encode location as raw GeoXPPoint\n-        noDeltaMetaLocation = false;\n       }\n     } else {\n       lastGeoXPPoint = GeoTimeSerie.NO_LOCATION;\n+      validLastGeoXPPoint = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7d2bef74d0b1f91f02527bc02577565d3ff9372"}, "originalPosition": 271}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjcwNDE2Mw==", "bodyText": "lastElevation = GeoTimeSerie.NO_ELEVATION; is unnecessary since validLastElevation is set to false.", "url": "https://github.com/senx/warp10-platform/pull/867#discussion_r526704163", "createdAt": "2020-11-19T09:15:22Z", "author": {"login": "ftence"}, "path": "warp10/src/main/java/io/warp10/continuum/gts/GTSEncoder.java", "diffHunk": "@@ -496,10 +508,10 @@ public synchronized int addValue(long timestamp, long location, long elevation,\n         if (Math.abs(elevation) < (1L << 48)) {\n           locElevFlag |= FLAGS_ELEVATION_ZIGZAG;\n         }\n-        noDeltaMetaElevation = false;\n       }\n     } else {\n       lastElevation = GeoTimeSerie.NO_ELEVATION;\n+      validLastElevation = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7d2bef74d0b1f91f02527bc02577565d3ff9372"}, "originalPosition": 292}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjcwNzAzNA==", "bodyText": "I think setting validLastBDValue to false is clearer than setting lastBDValue to null. This change goes with the first comment.", "url": "https://github.com/senx/warp10-platform/pull/867#discussion_r526707034", "createdAt": "2020-11-19T09:19:54Z", "author": {"login": "ftence"}, "path": "warp10/src/main/java/io/warp10/continuum/gts/GTSEncoder.java", "diffHunk": "@@ -702,6 +717,7 @@ public synchronized int addValue(long timestamp, long location, long elevation,\n             this.stream.write(buf, 0, 8);\n             // Clear the last BDValue otherwise we might incorrectly encode the next value specified as a BigDecimal\n             lastBDValue = null;\n+            validLastDoubleValue = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7d2bef74d0b1f91f02527bc02577565d3ff9372"}, "originalPosition": 382}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjcxODUwMA==", "bodyText": "Also sets validLastDoubleValue to false. Also goes with first comment.", "url": "https://github.com/senx/warp10-platform/pull/867#discussion_r526718500", "createdAt": "2020-11-19T09:37:06Z", "author": {"login": "ftence"}, "path": "warp10/src/main/java/io/warp10/continuum/gts/GTSEncoder.java", "diffHunk": "@@ -715,6 +731,7 @@ public synchronized int addValue(long timestamp, long location, long elevation,\n             this.stream.write(buf10, 0, l);\n             // Keep track of last value\n             lastBDValue = dvalue;\n+            validLastBDValue = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7d2bef74d0b1f91f02527bc02577565d3ff9372"}, "originalPosition": 390}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjczMTE3Mw==", "bodyText": "Instead copy last loc/elev/values according to valid* booleans.", "url": "https://github.com/senx/warp10-platform/pull/867#discussion_r526731173", "createdAt": "2020-11-19T09:55:30Z", "author": {"login": "ftence"}, "path": "warp10/src/main/java/io/warp10/continuum/gts/GTSEncoder.java", "diffHunk": "@@ -1129,10 +1144,14 @@ public synchronized void merge(GTSEncoder encoder) throws IOException {\n       this.lastBDValue = encoder.lastBDValue;\n       this.lastDoubleValue = encoder.lastDoubleValue;\n       this.lastStringValue = encoder.lastStringValue;\n+\n+      // Disable delta encoding, this allows us to have a wider use of the fast path\n+      safeDelta();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7d2bef74d0b1f91f02527bc02577565d3ff9372"}, "originalPosition": 759}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2288f22fdd6f35be6cfa5f8eccfed93d9238e82f", "author": {"user": {"login": "hbs", "name": "Mathias Herberts"}}, "url": "https://github.com/senx/warp10-platform/commit/2288f22fdd6f35be6cfa5f8eccfed93d9238e82f", "committedDate": "2020-11-19T12:53:26Z", "message": "Addressed PR comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0NDg5MTg5", "url": "https://github.com/senx/warp10-platform/pull/867#pullrequestreview-534489189", "createdAt": "2020-11-19T14:17:55Z", "commit": {"oid": "2288f22fdd6f35be6cfa5f8eccfed93d9238e82f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3254, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}