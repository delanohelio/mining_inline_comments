{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI4MTc5OTEx", "number": 878, "title": "Add capabilities to tokens", "bodyText": "", "createdAt": "2020-11-26T16:33:26Z", "url": "https://github.com/senx/warp10-platform/pull/878", "merged": true, "mergeCommit": {"oid": "d991e60dc4438d2e8a0cf986cef7072bc082e302"}, "closed": true, "closedAt": "2020-12-02T15:36:31Z", "author": {"login": "hbs"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdgVlDAgH2gAyNTI4MTc5OTExOjUxODg0YThjNWQzODUwN2E3M2ViNDNiNWVkMjQyZTM4ZmQyMTllNDc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdiMm0HgFqTU0MjczMTEzNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "51884a8c5d38507a73eb43b5ed242e38fd219e47", "author": {"user": {"login": "hbs", "name": "Mathias Herberts"}}, "url": "https://github.com/senx/warp10-platform/commit/51884a8c5d38507a73eb43b5ed242e38fd219e47", "committedDate": "2020-11-26T16:31:17Z", "message": "Initial commit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4890d59f9fcc97bd7e0d79d42d9d260438844298", "author": {"user": {"login": "hbs", "name": "Mathias Herberts"}}, "url": "https://github.com/senx/warp10-platform/commit/4890d59f9fcc97bd7e0d79d42d9d260438844298", "committedDate": "2020-11-27T12:18:47Z", "message": "Added support for WRITE tokens in CAPADD"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwMDgxOTcw", "url": "https://github.com/senx/warp10-platform/pull/878#pullrequestreview-540081970", "createdAt": "2020-11-27T16:13:20Z", "commit": {"oid": "4890d59f9fcc97bd7e0d79d42d9d260438844298"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QxNjoxMzoyMFrOH7DUeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QxNjoyNzozOVrOH7DrGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTY4MjQyNg==", "bodyText": "Why it does not override already present capabilities?", "url": "https://github.com/senx/warp10-platform/pull/878#discussion_r531682426", "createdAt": "2020-11-27T16:13:20Z", "author": {"login": "ftence"}, "path": "warp10/src/main/java/io/warp10/script/ext/capabilities/CAPADD.java", "diffHunk": "@@ -0,0 +1,81 @@\n+//\n+//   Copyright 2020  SenX S.A.S.\n+//\n+//   Licensed under the Apache License, Version 2.0 (the \"License\");\n+//   you may not use this file except in compliance with the License.\n+//   You may obtain a copy of the License at\n+//\n+//     http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//   Unless required by applicable law or agreed to in writing, software\n+//   distributed under the License is distributed on an \"AS IS\" BASIS,\n+//   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+//   See the License for the specific language governing permissions and\n+//   limitations under the License.\n+//\n+\n+package io.warp10.script.ext.capabilities;\n+\n+import java.util.Map;\n+import java.util.Map.Entry;\n+\n+import io.warp10.continuum.Tokens;\n+import io.warp10.quasar.token.thrift.data.ReadToken;\n+import io.warp10.quasar.token.thrift.data.WriteToken;\n+import io.warp10.script.NamedWarpScriptFunction;\n+import io.warp10.script.WarpScriptException;\n+import io.warp10.script.WarpScriptStack;\n+import io.warp10.script.WarpScriptStackFunction;\n+\n+public class CAPADD extends NamedWarpScriptFunction implements WarpScriptStackFunction {\n+\n+  public CAPADD(String name) {\n+    super(name);\n+  }\n+\n+  @Override\n+  public Object apply(WarpScriptStack stack) throws WarpScriptException {\n+\n+    Object top = stack.pop();\n+\n+    if (!(top instanceof String)) {\n+      throw new WarpScriptException(getName() + \" expects a TOKEN.\");\n+    }\n+\n+    String token = (String) top;\n+\n+    Map<String,String> attributes = null;\n+\n+    try {\n+      ReadToken rtoken = Tokens.extractReadToken(token);\n+      attributes = rtoken.getAttributes();\n+    } catch (Exception e) {\n+      try {\n+        WriteToken wtoken = Tokens.extractWriteToken(token);\n+        attributes = wtoken.getAttributes();\n+      } catch (Exception ee) {\n+        throw new WarpScriptException(getName() + \" invalid token.\");\n+      }\n+    }\n+\n+    if (null != attributes && !attributes.isEmpty()) {\n+      Capabilities capabilities = null;\n+\n+      if (stack.getAttribute(CapabilitiesWarpScriptExtension.CAPABILITIES_ATTR) instanceof Capabilities) {\n+        capabilities = (Capabilities) stack.getAttribute(CapabilitiesWarpScriptExtension.CAPABILITIES_ATTR);\n+      }\n+\n+      for (Entry<String,String> entry: attributes.entrySet()) {\n+        if (entry.getKey().startsWith(CapabilitiesWarpScriptExtension.CAPABILITIES_PREFIX)) {\n+          if (null == capabilities) {\n+            capabilities = new Capabilities();\n+            stack.setAttribute(CapabilitiesWarpScriptExtension.CAPABILITIES_ATTR, capabilities);\n+          }\n+          capabilities.capabilities.putIfAbsent(entry.getKey().substring(CapabilitiesWarpScriptExtension.CAPABILITIES_PREFIX.length()), entry.getValue());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4890d59f9fcc97bd7e0d79d42d9d260438844298"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTY4Mjg0Mw==", "bodyText": "A WarpScriptException would be helpful here.", "url": "https://github.com/senx/warp10-platform/pull/878#discussion_r531682843", "createdAt": "2020-11-27T16:14:18Z", "author": {"login": "ftence"}, "path": "warp10/src/main/java/io/warp10/script/ext/capabilities/CAPCHECK.java", "diffHunk": "@@ -0,0 +1,50 @@\n+//\n+//   Copyright 2020  SenX S.A.S.\n+//\n+//   Licensed under the Apache License, Version 2.0 (the \"License\");\n+//   you may not use this file except in compliance with the License.\n+//   You may obtain a copy of the License at\n+//\n+//     http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//   Unless required by applicable law or agreed to in writing, software\n+//   distributed under the License is distributed on an \"AS IS\" BASIS,\n+//   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+//   See the License for the specific language governing permissions and\n+//   limitations under the License.\n+//\n+\n+package io.warp10.script.ext.capabilities;\n+\n+import io.warp10.script.NamedWarpScriptFunction;\n+import io.warp10.script.WarpScriptException;\n+import io.warp10.script.WarpScriptStack;\n+import io.warp10.script.WarpScriptStackFunction;\n+\n+public class CAPCHECK extends NamedWarpScriptFunction implements WarpScriptStackFunction {\n+  \n+  public CAPCHECK(String name) {\n+    super(name);\n+  }\n+  \n+  @Override\n+  public Object apply(WarpScriptStack stack) throws WarpScriptException {\n+\n+    Object top = stack.pop();\n+\n+    if (top instanceof String) {      \n+      Capabilities capabilities = null;\n+      \n+      if (stack.getAttribute(CapabilitiesWarpScriptExtension.CAPABILITIES_ATTR) instanceof Capabilities) {\n+        capabilities = (Capabilities) stack.getAttribute(CapabilitiesWarpScriptExtension.CAPABILITIES_ATTR);\n+        stack.push(capabilities.capabilities.containsKey((String) top));\n+      } else {\n+        stack.push(false);\n+      }\n+    } else {\n+      stack.push(false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4890d59f9fcc97bd7e0d79d42d9d260438844298"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTY4NTc3Mg==", "bodyText": "I would find NULL CAPDEL to clear all capabilities to be less error-prone than [] CAPDEL: having an empty list could happen, having a NULL capability key is much less likely.", "url": "https://github.com/senx/warp10-platform/pull/878#discussion_r531685772", "createdAt": "2020-11-27T16:21:39Z", "author": {"login": "ftence"}, "path": "warp10/src/main/java/io/warp10/script/ext/capabilities/CAPDEL.java", "diffHunk": "@@ -0,0 +1,65 @@\n+//\n+//   Copyright 2020  SenX S.A.S.\n+//\n+//   Licensed under the Apache License, Version 2.0 (the \"License\");\n+//   you may not use this file except in compliance with the License.\n+//   You may obtain a copy of the License at\n+//\n+//     http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//   Unless required by applicable law or agreed to in writing, software\n+//   distributed under the License is distributed on an \"AS IS\" BASIS,\n+//   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+//   See the License for the specific language governing permissions and\n+//   limitations under the License.\n+//\n+\n+package io.warp10.script.ext.capabilities;\n+\n+import java.util.List;\n+\n+import io.warp10.script.NamedWarpScriptFunction;\n+import io.warp10.script.WarpScriptException;\n+import io.warp10.script.WarpScriptStack;\n+import io.warp10.script.WarpScriptStackFunction;\n+\n+public class CAPDEL extends NamedWarpScriptFunction implements WarpScriptStackFunction {\n+\n+  public CAPDEL(String name) {\n+    super(name);\n+  }\n+\n+  @Override\n+  public Object apply(WarpScriptStack stack) throws WarpScriptException {\n+\n+    Object top = stack.pop();\n+\n+    Capabilities capabilities = null;\n+\n+    if (stack.getAttribute(CapabilitiesWarpScriptExtension.CAPABILITIES_ATTR) instanceof Capabilities) {\n+      capabilities = (Capabilities) stack.getAttribute(CapabilitiesWarpScriptExtension.CAPABILITIES_ATTR);\n+    }\n+\n+    if (top instanceof String) {\n+      if (null != capabilities) {\n+        capabilities.capabilities.remove((String) top);\n+      }\n+    } else if (top instanceof List) {\n+      if (null != capabilities) {\n+        if (((List) top).isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4890d59f9fcc97bd7e0d79d42d9d260438844298"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTY4NzI0Mw==", "bodyText": "top could also be null, Capabilities.get would behave the same.", "url": "https://github.com/senx/warp10-platform/pull/878#discussion_r531687243", "createdAt": "2020-11-27T16:25:13Z", "author": {"login": "ftence"}, "path": "warp10/src/main/java/io/warp10/script/ext/capabilities/CAPGET.java", "diffHunk": "@@ -0,0 +1,50 @@\n+//\n+//   Copyright 2020  SenX S.A.S.\n+//\n+//   Licensed under the Apache License, Version 2.0 (the \"License\");\n+//   you may not use this file except in compliance with the License.\n+//   You may obtain a copy of the License at\n+//\n+//     http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//   Unless required by applicable law or agreed to in writing, software\n+//   distributed under the License is distributed on an \"AS IS\" BASIS,\n+//   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+//   See the License for the specific language governing permissions and\n+//   limitations under the License.\n+//\n+\n+package io.warp10.script.ext.capabilities;\n+\n+import java.util.HashMap;\n+import java.util.LinkedHashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Map.Entry;\n+\n+import io.warp10.script.NamedWarpScriptFunction;\n+import io.warp10.script.WarpScriptException;\n+import io.warp10.script.WarpScriptStack;\n+import io.warp10.script.WarpScriptStackFunction;\n+\n+public class CAPGET extends NamedWarpScriptFunction implements WarpScriptStackFunction {\n+\n+  public CAPGET(String name) {\n+    super(name);\n+  }\n+\n+  @Override\n+  public Object apply(WarpScriptStack stack) throws WarpScriptException {\n+    Object top = stack.pop();\n+\n+    if (top instanceof String) {\n+      stack.push(Capabilities.get(stack, (String) top));\n+    } else if (top instanceof List) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4890d59f9fcc97bd7e0d79d42d9d260438844298"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTY4ODIxNg==", "bodyText": "You should also add a put method, currently in CAPADD to be consistent.", "url": "https://github.com/senx/warp10-platform/pull/878#discussion_r531688216", "createdAt": "2020-11-27T16:27:39Z", "author": {"login": "ftence"}, "path": "warp10/src/main/java/io/warp10/script/ext/capabilities/Capabilities.java", "diffHunk": "@@ -0,0 +1,68 @@\n+//\n+//   Copyright 2020  SenX S.A.S.\n+//\n+//   Licensed under the Apache License, Version 2.0 (the \"License\");\n+//   you may not use this file except in compliance with the License.\n+//   You may obtain a copy of the License at\n+//\n+//     http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//   Unless required by applicable law or agreed to in writing, software\n+//   distributed under the License is distributed on an \"AS IS\" BASIS,\n+//   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+//   See the License for the specific language governing permissions and\n+//   limitations under the License.\n+//\n+\n+package io.warp10.script.ext.capabilities;\n+\n+import java.util.HashMap;\n+import java.util.LinkedHashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import io.warp10.script.WarpScriptStack;\n+\n+/**\n+ * This class is there only to prevent the capabilities map from being accessible\n+ * on the stack after a STACKATTRIBUTE call so capabilities cannot be added manually.\n+ *\n+ */\n+public class Capabilities {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4890d59f9fcc97bd7e0d79d42d9d260438844298"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ce5085b96f7ea5fb634b48d9e569bd2b52866ab", "author": {"user": {"login": "hbs", "name": "Mathias Herberts"}}, "url": "https://github.com/senx/warp10-platform/commit/4ce5085b96f7ea5fb634b48d9e569bd2b52866ab", "committedDate": "2020-11-27T21:21:07Z", "message": "Addressed PR comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyNzMxMTM1", "url": "https://github.com/senx/warp10-platform/pull/878#pullrequestreview-542731135", "createdAt": "2020-12-02T11:11:55Z", "commit": {"oid": "4ce5085b96f7ea5fb634b48d9e569bd2b52866ab"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3266, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}