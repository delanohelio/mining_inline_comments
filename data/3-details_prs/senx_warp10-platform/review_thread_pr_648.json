{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY3MTM3NDcy", "number": 648, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxNjowNTo0NlrODdY3fA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxMDoyMjowOFrODd-dbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMyMTQyNzE2OnYy", "diffSide": "RIGHT", "path": "warp10/src/main/java/io/warp10/script/processing/typography/PcreateFont.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxNjowNTo0NlrOFl9jjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxNjowNTo0NlrOFl9jjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTM1MDE1Ng==", "bodyText": "Fails if url contains a space. This can be avoided by double escaping in WarpScript ie %2520.\nEscape in code or to be documented.", "url": "https://github.com/senx/warp10-platform/pull/648#discussion_r375350156", "createdAt": "2020-02-05T16:05:46Z", "author": {"login": "ftence"}, "path": "warp10/src/main/java/io/warp10/script/processing/typography/PcreateFont.java", "diffHunk": "@@ -45,21 +80,62 @@ public Object apply(WarpScriptStack stack) throws WarpScriptException {\n \n     PFont font = null;\n     \n-    if (3 == params.size()) {\n-      font = pg.parent.createFont(params.get(1).toString(), ((Number) params.get(2)).floatValue());\n-    } else if (4 == params.size()) {\n-      font = pg.parent.createFont(\n-          params.get(1).toString(),\n-          ((Number) params.get(2)).floatValue(),\n-          Boolean.TRUE.equals(params.get(3)));\n-    } else if (5 == params.size()) {\n-      font = pg.parent.createFont(\n-          params.get(1).toString(),\n-          ((Number) params.get(2)).floatValue(),\n-          Boolean.TRUE.equals(params.get(3)),\n-          params.get(4).toString().toCharArray());\n-    }\n+    //\n+    // Handle the case of remote font files differently, passing the URL\n+    // to the defined validator\n+    //\n+    \n+    if (params.get(1).toString().startsWith(\"http://\") || params.get(1).toString().startsWith(\"https://\")) {\n+      String url = resolver.resolve(params.get(1).toString());\n \n+      InputStream in = null;\n+      \n+      try {\n+        //\n+        // FIXME(hbs): support WOFF/WOFF2 on top of TTF/OTF\n+        //\n+        in = new URL(url).openStream();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "83c541d1a8615fa3a9d84a3f70594531fe5727ae"}, "originalPosition": 90}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMyMTQ1NDE3OnYy", "diffSide": "RIGHT", "path": "warp10/src/main/java/io/warp10/script/processing/typography/PcreateFont.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxNjoxMjozNFrOFl90eg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxNToxNjoyNlrOFmeymA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTM1NDQ5MA==", "bodyText": "Why use a resolver instead of a validator?\nIf it needs to stay a resolver, can't this macro return a special value for forbidden access, like NULL or an empty stack and produce a clear error message?", "url": "https://github.com/senx/warp10-platform/pull/648#discussion_r375354490", "createdAt": "2020-02-05T16:12:34Z", "author": {"login": "ftence"}, "path": "warp10/src/main/java/io/warp10/script/processing/typography/PcreateFont.java", "diffHunk": "@@ -31,9 +39,36 @@\n  * Call createFont\n  */\n public class PcreateFont extends NamedWarpScriptFunction implements WarpScriptStackFunction {\n+    \n+  private final FontResolver resolver;\n   \n+  private static class FontResolver {\n+    \n+    private final String warpscript;\n+    \n+    public FontResolver(String mc2) {\n+      this.warpscript = mc2;\n+    }\n+    \n+    public String resolve(String url) throws WarpScriptException {\n+      if (null == this.warpscript) {\n+        throw new WarpScriptException(\"Font resolver not set, rejecting all URLs.\");\n+      }\n+      try {\n+        MemoryWarpScriptStack stack = new MemoryWarpScriptStack(null, null);\n+        stack.push(url);\n+        stack.exec(this.warpscript);\n+        return (String) stack.pop();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "83c541d1a8615fa3a9d84a3f70594531fe5727ae"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTg5NDY4MA==", "bodyText": "Simply do a FAILMSG in your resolver if you want to reject the font. The WarpScriptException will be forwarded upstream.", "url": "https://github.com/senx/warp10-platform/pull/648#discussion_r375894680", "createdAt": "2020-02-06T15:16:26Z", "author": {"login": "hbs"}, "path": "warp10/src/main/java/io/warp10/script/processing/typography/PcreateFont.java", "diffHunk": "@@ -31,9 +39,36 @@\n  * Call createFont\n  */\n public class PcreateFont extends NamedWarpScriptFunction implements WarpScriptStackFunction {\n+    \n+  private final FontResolver resolver;\n   \n+  private static class FontResolver {\n+    \n+    private final String warpscript;\n+    \n+    public FontResolver(String mc2) {\n+      this.warpscript = mc2;\n+    }\n+    \n+    public String resolve(String url) throws WarpScriptException {\n+      if (null == this.warpscript) {\n+        throw new WarpScriptException(\"Font resolver not set, rejecting all URLs.\");\n+      }\n+      try {\n+        MemoryWarpScriptStack stack = new MemoryWarpScriptStack(null, null);\n+        stack.push(url);\n+        stack.exec(this.warpscript);\n+        return (String) stack.pop();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTM1NDQ5MA=="}, "originalCommit": {"oid": "83c541d1a8615fa3a9d84a3f70594531fe5727ae"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMyNzU4MjIyOnYy", "diffSide": "RIGHT", "path": "warp10/src/main/java/io/warp10/script/processing/typography/PcreateFont.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxMDoyMDo0NVrOFm4hOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxMDoyMDo0NVrOFm4hOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMxNjIxNg==", "bodyText": "This will fail because it will also escape part of the URL which should not be escaped resulting it \"https%3A%2F%2F\"...\nYou could unconditionally do a url.replace(\" \", \"%20\")\nor a nice solution from SO:\n      String urlStr = resolver.resolve(params.get(1).toString());\n\n      InputStream in = null;\n      \n      try {\n        URL url = new URL(urlStr);\n        URI uri = new URI(url.getProtocol(), url.getUserInfo(), url.getHost(), url.getPort(), url.getPath(), url.getQuery(), url.getRef());\n        \n        in = new URL(uri.toASCIIString()).openStream();", "url": "https://github.com/senx/warp10-platform/pull/648#discussion_r376316216", "createdAt": "2020-02-07T10:20:45Z", "author": {"login": "ftence"}, "path": "warp10/src/main/java/io/warp10/script/processing/typography/PcreateFont.java", "diffHunk": "@@ -94,6 +96,12 @@ public Object apply(WarpScriptStack stack) throws WarpScriptException {\n         //\n         // FIXME(hbs): support WOFF/WOFF2 on top of TTF/OTF\n         //\n+        \n+        // Encode the URL if it contains a whitespace\n+        if (url.contains(\" \")) {\n+          url = URLEncoder.encode(url, StandardCharsets.UTF_8.name());\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54fe37095953f60a212f4af055af2659a29da0da"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMyNzU4NjM3OnYy", "diffSide": "RIGHT", "path": "warp10/src/main/java/io/warp10/script/processing/typography/PcreateFont.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxMDoyMjowOFrOFm4jvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxMDoyMjowOFrOFm4jvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMxNjg2MA==", "bodyText": "Could be nice to also allow file://.\n(Tested and working with the SO solution below).", "url": "https://github.com/senx/warp10-platform/pull/648#discussion_r376316860", "createdAt": "2020-02-07T10:22:08Z", "author": {"login": "ftence"}, "path": "warp10/src/main/java/io/warp10/script/processing/typography/PcreateFont.java", "diffHunk": "@@ -45,21 +82,68 @@ public Object apply(WarpScriptStack stack) throws WarpScriptException {\n \n     PFont font = null;\n     \n-    if (3 == params.size()) {\n-      font = pg.parent.createFont(params.get(1).toString(), ((Number) params.get(2)).floatValue());\n-    } else if (4 == params.size()) {\n-      font = pg.parent.createFont(\n-          params.get(1).toString(),\n-          ((Number) params.get(2)).floatValue(),\n-          Boolean.TRUE.equals(params.get(3)));\n-    } else if (5 == params.size()) {\n-      font = pg.parent.createFont(\n-          params.get(1).toString(),\n-          ((Number) params.get(2)).floatValue(),\n-          Boolean.TRUE.equals(params.get(3)),\n-          params.get(4).toString().toCharArray());\n-    }\n+    //\n+    // Handle the case of remote font files differently, passing the URL\n+    // to the defined validator\n+    //\n+    \n+    if (params.get(1).toString().startsWith(\"http://\") || params.get(1).toString().startsWith(\"https://\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54fe37095953f60a212f4af055af2659a29da0da"}, "originalPosition": 83}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1290, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}