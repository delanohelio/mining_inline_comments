{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzczMTA5OTI5", "number": 660, "reviewThreads": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMzozNTo1MVrODedGcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxMDo1ODowMlrODf2kVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMjYwNjU3OnYy", "diffSide": "RIGHT", "path": "warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMzozNTo1MVrOFnmNsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMzozNTo1MVrOFnmNsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA2NDg4Mw==", "bodyText": "Comment can be removed.", "url": "https://github.com/senx/warp10-platform/pull/660#discussion_r377064883", "createdAt": "2020-02-10T13:35:51Z", "author": {"login": "hbs"}, "path": "warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java", "diffHunk": "@@ -1451,7 +1443,7 @@ static void jsonDump(PrintWriter pw, Iterator<GTSDecoder> iter, long now, long c\n             pw.print(Boolean.TRUE.equals(value) ? \"true\" : \"false\");\n           } else {\n             //pw.print(gson.toJson(value.toString()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b27cd97ec7375ab4d2ab7a6d62ef1c7597e9137"}, "originalPosition": 66}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMjYzNDIxOnYy", "diffSide": "RIGHT", "path": "warp10/src/main/java/io/warp10/json/BoundedWriter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMzo0MzoxOFrOFnmd1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMzo0MzoxOFrOFnmd1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA2OTAxNA==", "bodyText": "Add a comment indicating whether start/end are inclusive or exclusive", "url": "https://github.com/senx/warp10-platform/pull/660#discussion_r377069014", "createdAt": "2020-02-10T13:43:18Z", "author": {"login": "hbs"}, "path": "warp10/src/main/java/io/warp10/json/BoundedWriter.java", "diffHunk": "@@ -0,0 +1,64 @@\n+//\n+//   Copyright 2020  SenX S.A.S.\n+//\n+//   Licensed under the Apache License, Version 2.0 (the \"License\");\n+//   you may not use this file except in compliance with the License.\n+//   You may obtain a copy of the License at\n+//\n+//     http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//   Unless required by applicable law or agreed to in writing, software\n+//   distributed under the License is distributed on an \"AS IS\" BASIS,\n+//   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+//   See the License for the specific language governing permissions and\n+//   limitations under the License.\n+//\n+\n+package io.warp10.json;\n+\n+import java.io.IOException;\n+import java.io.Writer;\n+\n+/**\n+ * A wrapper for Writers to limit the number of written chars.\n+ * When the number of chars that should be written exceeds the given limit, a WriterBoundReachedException is thrown.\n+ */\n+public class BoundedWriter extends Writer {\n+\n+  public static class WriterBoundReachedException extends IOException {\n+\n+    public WriterBoundReachedException(String message) {\n+      super(message);\n+    }\n+\n+  }\n+\n+  protected final Writer writer;\n+  protected final long maxWrittenChars;\n+  protected long currentWrittenChars;\n+\n+  public BoundedWriter(Writer writer, long maxAppendedChars) {\n+    this.writer = writer;\n+    this.maxWrittenChars = maxAppendedChars;\n+    this.currentWrittenChars = 0;\n+  }\n+\n+  @Override\n+  public void write(char[] chars, int start, int end) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b27cd97ec7375ab4d2ab7a6d62ef1c7597e9137"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMjY0MjYyOnYy", "diffSide": "RIGHT", "path": "warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMzo0NTozOVrOFnmi6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQwOTo0NjozNVrOFoCgdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA3MDMxMg==", "bodyText": "How are .producer/.owner labels handled? The check for their exposure should probably be performed here too as this method might be called in the future from other places and responsability for exposing those labels might not be logical to implement in the caller.", "url": "https://github.com/senx/warp10-platform/pull/660#discussion_r377070312", "createdAt": "2020-02-10T13:45:39Z", "author": {"login": "hbs"}, "path": "warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java", "diffHunk": "@@ -0,0 +1,86 @@\n+//\n+//   Copyright 2020  SenX S.A.S.\n+//\n+//   Licensed under the Apache License, Version 2.0 (the \"License\");\n+//   you may not use this file except in compliance with the License.\n+//   You may obtain a copy of the License at\n+//\n+//     http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//   Unless required by applicable law or agreed to in writing, software\n+//   distributed under the License is distributed on an \"AS IS\" BASIS,\n+//   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+//   See the License for the specific language governing permissions and\n+//   limitations under the License.\n+//\n+\n+package io.warp10.json;\n+\n+import com.fasterxml.jackson.core.JsonGenerator;\n+import com.fasterxml.jackson.databind.JsonSerializer;\n+import com.fasterxml.jackson.databind.SerializerProvider;\n+import com.geoxp.GeoXPLib;\n+import io.warp10.continuum.gts.GTSDecoder;\n+import io.warp10.continuum.gts.GTSEncoder;\n+import io.warp10.continuum.gts.GeoTimeSerie;\n+import io.warp10.continuum.store.thrift.data.Metadata;\n+\n+import java.io.IOException;\n+\n+public class GTSEncoderSerializer extends JsonSerializer<GTSEncoder> {\n+\n+  @Override\n+  public void serialize(GTSEncoder encoder, JsonGenerator gen, SerializerProvider provider) throws IOException {\n+    Metadata metadata = encoder.getMetadata();\n+    String name = metadata.getName();\n+    if (null == name) {\n+      name = \"\";\n+    }\n+\n+    gen.writeStartObject();\n+    gen.writeStringField(\"c\", name);\n+    gen.writeObjectField(\"l\", metadata.getLabels());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b27cd97ec7375ab4d2ab7a6d62ef1c7597e9137"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzUyMTI2MQ==", "bodyText": "Problem is that we don't  have access to the token here, so we can't know if internal labels should be exposed or not.", "url": "https://github.com/senx/warp10-platform/pull/660#discussion_r377521261", "createdAt": "2020-02-11T09:32:26Z", "author": {"login": "ftence"}, "path": "warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java", "diffHunk": "@@ -0,0 +1,86 @@\n+//\n+//   Copyright 2020  SenX S.A.S.\n+//\n+//   Licensed under the Apache License, Version 2.0 (the \"License\");\n+//   you may not use this file except in compliance with the License.\n+//   You may obtain a copy of the License at\n+//\n+//     http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//   Unless required by applicable law or agreed to in writing, software\n+//   distributed under the License is distributed on an \"AS IS\" BASIS,\n+//   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+//   See the License for the specific language governing permissions and\n+//   limitations under the License.\n+//\n+\n+package io.warp10.json;\n+\n+import com.fasterxml.jackson.core.JsonGenerator;\n+import com.fasterxml.jackson.databind.JsonSerializer;\n+import com.fasterxml.jackson.databind.SerializerProvider;\n+import com.geoxp.GeoXPLib;\n+import io.warp10.continuum.gts.GTSDecoder;\n+import io.warp10.continuum.gts.GTSEncoder;\n+import io.warp10.continuum.gts.GeoTimeSerie;\n+import io.warp10.continuum.store.thrift.data.Metadata;\n+\n+import java.io.IOException;\n+\n+public class GTSEncoderSerializer extends JsonSerializer<GTSEncoder> {\n+\n+  @Override\n+  public void serialize(GTSEncoder encoder, JsonGenerator gen, SerializerProvider provider) throws IOException {\n+    Metadata metadata = encoder.getMetadata();\n+    String name = metadata.getName();\n+    if (null == name) {\n+      name = \"\";\n+    }\n+\n+    gen.writeStartObject();\n+    gen.writeStringField(\"c\", name);\n+    gen.writeObjectField(\"l\", metadata.getLabels());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA3MDMxMg=="}, "originalCommit": {"oid": "1b27cd97ec7375ab4d2ab7a6d62ef1c7597e9137"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzUyODQzNg==", "bodyText": "Actually it should be fine since the labels will have been removed just after the FETCH if they needed to be.", "url": "https://github.com/senx/warp10-platform/pull/660#discussion_r377528436", "createdAt": "2020-02-11T09:46:35Z", "author": {"login": "hbs"}, "path": "warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java", "diffHunk": "@@ -0,0 +1,86 @@\n+//\n+//   Copyright 2020  SenX S.A.S.\n+//\n+//   Licensed under the Apache License, Version 2.0 (the \"License\");\n+//   you may not use this file except in compliance with the License.\n+//   You may obtain a copy of the License at\n+//\n+//     http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//   Unless required by applicable law or agreed to in writing, software\n+//   distributed under the License is distributed on an \"AS IS\" BASIS,\n+//   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+//   See the License for the specific language governing permissions and\n+//   limitations under the License.\n+//\n+\n+package io.warp10.json;\n+\n+import com.fasterxml.jackson.core.JsonGenerator;\n+import com.fasterxml.jackson.databind.JsonSerializer;\n+import com.fasterxml.jackson.databind.SerializerProvider;\n+import com.geoxp.GeoXPLib;\n+import io.warp10.continuum.gts.GTSDecoder;\n+import io.warp10.continuum.gts.GTSEncoder;\n+import io.warp10.continuum.gts.GeoTimeSerie;\n+import io.warp10.continuum.store.thrift.data.Metadata;\n+\n+import java.io.IOException;\n+\n+public class GTSEncoderSerializer extends JsonSerializer<GTSEncoder> {\n+\n+  @Override\n+  public void serialize(GTSEncoder encoder, JsonGenerator gen, SerializerProvider provider) throws IOException {\n+    Metadata metadata = encoder.getMetadata();\n+    String name = metadata.getName();\n+    if (null == name) {\n+      name = \"\";\n+    }\n+\n+    gen.writeStartObject();\n+    gen.writeStringField(\"c\", name);\n+    gen.writeObjectField(\"l\", metadata.getLabels());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA3MDMxMg=="}, "originalCommit": {"oid": "1b27cd97ec7375ab4d2ab7a6d62ef1c7597e9137"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMjY0OTk4OnYy", "diffSide": "RIGHT", "path": "warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMzo0NzozMFrOFnmnIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxMjoyNDoyNVrOFoHBDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA3MTM5Mg==", "bodyText": "This introduces a different handling of byte arrays whether it appears in a GTS/GTSEncoder or outside of one. Everywhere else byte arrays are serialized as b64, but here they will be serialized as an ISO-8859-1 string?", "url": "https://github.com/senx/warp10-platform/pull/660#discussion_r377071392", "createdAt": "2020-02-10T13:47:30Z", "author": {"login": "hbs"}, "path": "warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java", "diffHunk": "@@ -0,0 +1,86 @@\n+//\n+//   Copyright 2020  SenX S.A.S.\n+//\n+//   Licensed under the Apache License, Version 2.0 (the \"License\");\n+//   you may not use this file except in compliance with the License.\n+//   You may obtain a copy of the License at\n+//\n+//     http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//   Unless required by applicable law or agreed to in writing, software\n+//   distributed under the License is distributed on an \"AS IS\" BASIS,\n+//   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+//   See the License for the specific language governing permissions and\n+//   limitations under the License.\n+//\n+\n+package io.warp10.json;\n+\n+import com.fasterxml.jackson.core.JsonGenerator;\n+import com.fasterxml.jackson.databind.JsonSerializer;\n+import com.fasterxml.jackson.databind.SerializerProvider;\n+import com.geoxp.GeoXPLib;\n+import io.warp10.continuum.gts.GTSDecoder;\n+import io.warp10.continuum.gts.GTSEncoder;\n+import io.warp10.continuum.gts.GeoTimeSerie;\n+import io.warp10.continuum.store.thrift.data.Metadata;\n+\n+import java.io.IOException;\n+\n+public class GTSEncoderSerializer extends JsonSerializer<GTSEncoder> {\n+\n+  @Override\n+  public void serialize(GTSEncoder encoder, JsonGenerator gen, SerializerProvider provider) throws IOException {\n+    Metadata metadata = encoder.getMetadata();\n+    String name = metadata.getName();\n+    if (null == name) {\n+      name = \"\";\n+    }\n+\n+    gen.writeStartObject();\n+    gen.writeStringField(\"c\", name);\n+    gen.writeObjectField(\"l\", metadata.getLabels());\n+    gen.writeObjectField(\"a\", metadata.getAttributes());\n+    gen.writeNumberField(\"la\", metadata.getLastActivity());\n+    gen.writeFieldName(\"v\");\n+    gen.writeStartArray();\n+\n+    GTSDecoder decoder = encoder.getUnsafeDecoder(false);\n+    while (decoder.next()) {\n+      long ts = decoder.getTimestamp();\n+      long location = decoder.getLocation();\n+      long elevation = decoder.getElevation();\n+      // We do not call getBinaryValue because JSON cannot represent byte arrays", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b27cd97ec7375ab4d2ab7a6d62ef1c7597e9137"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzE4OTU2OA==", "bodyText": "You're right.\nIf you're fine with the b64 serialization of byte[] we could call getBinaryValue here and b64 encode if the returned value it byte[].\nHowever, in the case of a GTS, we're stuck with an ISO-8859-1 string, correct me if I'm wrong.", "url": "https://github.com/senx/warp10-platform/pull/660#discussion_r377189568", "createdAt": "2020-02-10T16:56:28Z", "author": {"login": "ftence"}, "path": "warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java", "diffHunk": "@@ -0,0 +1,86 @@\n+//\n+//   Copyright 2020  SenX S.A.S.\n+//\n+//   Licensed under the Apache License, Version 2.0 (the \"License\");\n+//   you may not use this file except in compliance with the License.\n+//   You may obtain a copy of the License at\n+//\n+//     http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//   Unless required by applicable law or agreed to in writing, software\n+//   distributed under the License is distributed on an \"AS IS\" BASIS,\n+//   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+//   See the License for the specific language governing permissions and\n+//   limitations under the License.\n+//\n+\n+package io.warp10.json;\n+\n+import com.fasterxml.jackson.core.JsonGenerator;\n+import com.fasterxml.jackson.databind.JsonSerializer;\n+import com.fasterxml.jackson.databind.SerializerProvider;\n+import com.geoxp.GeoXPLib;\n+import io.warp10.continuum.gts.GTSDecoder;\n+import io.warp10.continuum.gts.GTSEncoder;\n+import io.warp10.continuum.gts.GeoTimeSerie;\n+import io.warp10.continuum.store.thrift.data.Metadata;\n+\n+import java.io.IOException;\n+\n+public class GTSEncoderSerializer extends JsonSerializer<GTSEncoder> {\n+\n+  @Override\n+  public void serialize(GTSEncoder encoder, JsonGenerator gen, SerializerProvider provider) throws IOException {\n+    Metadata metadata = encoder.getMetadata();\n+    String name = metadata.getName();\n+    if (null == name) {\n+      name = \"\";\n+    }\n+\n+    gen.writeStartObject();\n+    gen.writeStringField(\"c\", name);\n+    gen.writeObjectField(\"l\", metadata.getLabels());\n+    gen.writeObjectField(\"a\", metadata.getAttributes());\n+    gen.writeNumberField(\"la\", metadata.getLastActivity());\n+    gen.writeFieldName(\"v\");\n+    gen.writeStartArray();\n+\n+    GTSDecoder decoder = encoder.getUnsafeDecoder(false);\n+    while (decoder.next()) {\n+      long ts = decoder.getTimestamp();\n+      long location = decoder.getLocation();\n+      long elevation = decoder.getElevation();\n+      // We do not call getBinaryValue because JSON cannot represent byte arrays", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA3MTM5Mg=="}, "originalCommit": {"oid": "1b27cd97ec7375ab4d2ab7a6d62ef1c7597e9137"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzUyODk5OQ==", "bodyText": "I am not too fond of emitting b64 content for byte arrays, why not simply output an ISO-8859-1 string?", "url": "https://github.com/senx/warp10-platform/pull/660#discussion_r377528999", "createdAt": "2020-02-11T09:47:47Z", "author": {"login": "hbs"}, "path": "warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java", "diffHunk": "@@ -0,0 +1,86 @@\n+//\n+//   Copyright 2020  SenX S.A.S.\n+//\n+//   Licensed under the Apache License, Version 2.0 (the \"License\");\n+//   you may not use this file except in compliance with the License.\n+//   You may obtain a copy of the License at\n+//\n+//     http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//   Unless required by applicable law or agreed to in writing, software\n+//   distributed under the License is distributed on an \"AS IS\" BASIS,\n+//   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+//   See the License for the specific language governing permissions and\n+//   limitations under the License.\n+//\n+\n+package io.warp10.json;\n+\n+import com.fasterxml.jackson.core.JsonGenerator;\n+import com.fasterxml.jackson.databind.JsonSerializer;\n+import com.fasterxml.jackson.databind.SerializerProvider;\n+import com.geoxp.GeoXPLib;\n+import io.warp10.continuum.gts.GTSDecoder;\n+import io.warp10.continuum.gts.GTSEncoder;\n+import io.warp10.continuum.gts.GeoTimeSerie;\n+import io.warp10.continuum.store.thrift.data.Metadata;\n+\n+import java.io.IOException;\n+\n+public class GTSEncoderSerializer extends JsonSerializer<GTSEncoder> {\n+\n+  @Override\n+  public void serialize(GTSEncoder encoder, JsonGenerator gen, SerializerProvider provider) throws IOException {\n+    Metadata metadata = encoder.getMetadata();\n+    String name = metadata.getName();\n+    if (null == name) {\n+      name = \"\";\n+    }\n+\n+    gen.writeStartObject();\n+    gen.writeStringField(\"c\", name);\n+    gen.writeObjectField(\"l\", metadata.getLabels());\n+    gen.writeObjectField(\"a\", metadata.getAttributes());\n+    gen.writeNumberField(\"la\", metadata.getLastActivity());\n+    gen.writeFieldName(\"v\");\n+    gen.writeStartArray();\n+\n+    GTSDecoder decoder = encoder.getUnsafeDecoder(false);\n+    while (decoder.next()) {\n+      long ts = decoder.getTimestamp();\n+      long location = decoder.getLocation();\n+      long elevation = decoder.getElevation();\n+      // We do not call getBinaryValue because JSON cannot represent byte arrays", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA3MTM5Mg=="}, "originalCommit": {"oid": "1b27cd97ec7375ab4d2ab7a6d62ef1c7597e9137"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzYwMjMxNg==", "bodyText": "This would unify the GTS, Encoder and byte[] representation for binary data which is nice.\nThere is a slight downside as it will produce a lot of special characters which will be escaped in JSON, making that not very compact. I think it's fine because JSON shouldn't be used for large transfer of binary data.", "url": "https://github.com/senx/warp10-platform/pull/660#discussion_r377602316", "createdAt": "2020-02-11T12:24:25Z", "author": {"login": "ftence"}, "path": "warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java", "diffHunk": "@@ -0,0 +1,86 @@\n+//\n+//   Copyright 2020  SenX S.A.S.\n+//\n+//   Licensed under the Apache License, Version 2.0 (the \"License\");\n+//   you may not use this file except in compliance with the License.\n+//   You may obtain a copy of the License at\n+//\n+//     http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//   Unless required by applicable law or agreed to in writing, software\n+//   distributed under the License is distributed on an \"AS IS\" BASIS,\n+//   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+//   See the License for the specific language governing permissions and\n+//   limitations under the License.\n+//\n+\n+package io.warp10.json;\n+\n+import com.fasterxml.jackson.core.JsonGenerator;\n+import com.fasterxml.jackson.databind.JsonSerializer;\n+import com.fasterxml.jackson.databind.SerializerProvider;\n+import com.geoxp.GeoXPLib;\n+import io.warp10.continuum.gts.GTSDecoder;\n+import io.warp10.continuum.gts.GTSEncoder;\n+import io.warp10.continuum.gts.GeoTimeSerie;\n+import io.warp10.continuum.store.thrift.data.Metadata;\n+\n+import java.io.IOException;\n+\n+public class GTSEncoderSerializer extends JsonSerializer<GTSEncoder> {\n+\n+  @Override\n+  public void serialize(GTSEncoder encoder, JsonGenerator gen, SerializerProvider provider) throws IOException {\n+    Metadata metadata = encoder.getMetadata();\n+    String name = metadata.getName();\n+    if (null == name) {\n+      name = \"\";\n+    }\n+\n+    gen.writeStartObject();\n+    gen.writeStringField(\"c\", name);\n+    gen.writeObjectField(\"l\", metadata.getLabels());\n+    gen.writeObjectField(\"a\", metadata.getAttributes());\n+    gen.writeNumberField(\"la\", metadata.getLastActivity());\n+    gen.writeFieldName(\"v\");\n+    gen.writeStartArray();\n+\n+    GTSDecoder decoder = encoder.getUnsafeDecoder(false);\n+    while (decoder.next()) {\n+      long ts = decoder.getTimestamp();\n+      long location = decoder.getLocation();\n+      long elevation = decoder.getElevation();\n+      // We do not call getBinaryValue because JSON cannot represent byte arrays", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA3MTM5Mg=="}, "originalCommit": {"oid": "1b27cd97ec7375ab4d2ab7a6d62ef1c7597e9137"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMjY1Njc2OnYy", "diffSide": "RIGHT", "path": "warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMzo0OToxNlrOFnmrGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMzo0OToxNlrOFnmrGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA3MjQxMA==", "bodyText": "Those strings should be externalized as constants since they are used in at least the two serializers", "url": "https://github.com/senx/warp10-platform/pull/660#discussion_r377072410", "createdAt": "2020-02-10T13:49:16Z", "author": {"login": "hbs"}, "path": "warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java", "diffHunk": "@@ -0,0 +1,86 @@\n+//\n+//   Copyright 2020  SenX S.A.S.\n+//\n+//   Licensed under the Apache License, Version 2.0 (the \"License\");\n+//   you may not use this file except in compliance with the License.\n+//   You may obtain a copy of the License at\n+//\n+//     http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//   Unless required by applicable law or agreed to in writing, software\n+//   distributed under the License is distributed on an \"AS IS\" BASIS,\n+//   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+//   See the License for the specific language governing permissions and\n+//   limitations under the License.\n+//\n+\n+package io.warp10.json;\n+\n+import com.fasterxml.jackson.core.JsonGenerator;\n+import com.fasterxml.jackson.databind.JsonSerializer;\n+import com.fasterxml.jackson.databind.SerializerProvider;\n+import com.geoxp.GeoXPLib;\n+import io.warp10.continuum.gts.GTSDecoder;\n+import io.warp10.continuum.gts.GTSEncoder;\n+import io.warp10.continuum.gts.GeoTimeSerie;\n+import io.warp10.continuum.store.thrift.data.Metadata;\n+\n+import java.io.IOException;\n+\n+public class GTSEncoderSerializer extends JsonSerializer<GTSEncoder> {\n+\n+  @Override\n+  public void serialize(GTSEncoder encoder, JsonGenerator gen, SerializerProvider provider) throws IOException {\n+    Metadata metadata = encoder.getMetadata();\n+    String name = metadata.getName();\n+    if (null == name) {\n+      name = \"\";\n+    }\n+\n+    gen.writeStartObject();\n+    gen.writeStringField(\"c\", name);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b27cd97ec7375ab4d2ab7a6d62ef1c7597e9137"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMjY2MjU2OnYy", "diffSide": "RIGHT", "path": "warp10/src/main/java/io/warp10/json/GeoTimeSerieSerializer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMzo1MDo1M1rOFnmudQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMzo1MDo1M1rOFnmudQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA3MzI2OQ==", "bodyText": "Same question about exposing .producer/.owner", "url": "https://github.com/senx/warp10-platform/pull/660#discussion_r377073269", "createdAt": "2020-02-10T13:50:53Z", "author": {"login": "hbs"}, "path": "warp10/src/main/java/io/warp10/json/GeoTimeSerieSerializer.java", "diffHunk": "@@ -0,0 +1,88 @@\n+//\n+//   Copyright 2020  SenX S.A.S.\n+//\n+//   Licensed under the Apache License, Version 2.0 (the \"License\");\n+//   you may not use this file except in compliance with the License.\n+//   You may obtain a copy of the License at\n+//\n+//     http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//   Unless required by applicable law or agreed to in writing, software\n+//   distributed under the License is distributed on an \"AS IS\" BASIS,\n+//   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+//   See the License for the specific language governing permissions and\n+//   limitations under the License.\n+//\n+\n+package io.warp10.json;\n+\n+import com.fasterxml.jackson.core.JsonGenerator;\n+import com.fasterxml.jackson.databind.JsonSerializer;\n+import com.fasterxml.jackson.databind.SerializerProvider;\n+import com.geoxp.GeoXPLib;\n+import io.warp10.continuum.gts.GTSHelper;\n+import io.warp10.continuum.gts.GeoTimeSerie;\n+import io.warp10.continuum.store.thrift.data.Metadata;\n+\n+import java.io.IOException;\n+\n+public class GeoTimeSerieSerializer extends JsonSerializer<GeoTimeSerie> {\n+\n+  @Override\n+  public void serialize(GeoTimeSerie gts, JsonGenerator gen, SerializerProvider provider) throws IOException {\n+    Metadata metadata = gts.getMetadata();\n+    String name = metadata.getName();\n+    if (null == name) {\n+      name = \"\";\n+    }\n+\n+    gen.writeStartObject();\n+    gen.writeStringField(\"c\", name);\n+    gen.writeObjectField(\"l\", metadata.getLabels());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b27cd97ec7375ab4d2ab7a6d62ef1c7597e9137"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMjY3NjU2OnYy", "diffSide": "RIGHT", "path": "warp10/src/main/java/io/warp10/json/MetadataSerializer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMzo1NDo0OVrOFnm2ww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMzo1NDo0OVrOFnm2ww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA3NTM5NQ==", "bodyText": "Constants should be externalized.", "url": "https://github.com/senx/warp10-platform/pull/660#discussion_r377075395", "createdAt": "2020-02-10T13:54:49Z", "author": {"login": "hbs"}, "path": "warp10/src/main/java/io/warp10/json/MetadataSerializer.java", "diffHunk": "@@ -0,0 +1,42 @@\n+//\n+//   Copyright 2020  SenX S.A.S.\n+//\n+//   Licensed under the Apache License, Version 2.0 (the \"License\");\n+//   you may not use this file except in compliance with the License.\n+//   You may obtain a copy of the License at\n+//\n+//     http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//   Unless required by applicable law or agreed to in writing, software\n+//   distributed under the License is distributed on an \"AS IS\" BASIS,\n+//   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+//   See the License for the specific language governing permissions and\n+//   limitations under the License.\n+//\n+\n+package io.warp10.json;\n+\n+import com.fasterxml.jackson.core.JsonGenerator;\n+import com.fasterxml.jackson.databind.JsonSerializer;\n+import com.fasterxml.jackson.databind.SerializerProvider;\n+import io.warp10.continuum.store.thrift.data.Metadata;\n+\n+import java.io.IOException;\n+\n+public class MetadataSerializer extends JsonSerializer<Metadata> {\n+\n+  @Override\n+  public void serialize(Metadata metadata, JsonGenerator gen, SerializerProvider provider) throws IOException {\n+    String name = metadata.getName();\n+    if (null == name) {\n+      name = \"\";\n+    }\n+\n+    gen.writeStartObject();\n+    gen.writeStringField(\"c\", name);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b27cd97ec7375ab4d2ab7a6d62ef1c7597e9137"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMjY5MTgxOnYy", "diffSide": "RIGHT", "path": "warp10/src/main/java/io/warp10/script/functions/JSONTO.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMzo1ODo0N1rOFnm_6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMzo1ODo0N1rOFnm_6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA3NzczNw==", "bodyText": "Missing whitespace", "url": "https://github.com/senx/warp10-platform/pull/660#discussion_r377077737", "createdAt": "2020-02-10T13:58:47Z", "author": {"login": "hbs"}, "path": "warp10/src/main/java/io/warp10/script/functions/JSONTO.java", "diffHunk": "@@ -51,19 +46,13 @@ public Object apply(WarpScriptStack stack) throws WarpScriptException {\n       throw new WarpScriptException(getName() + \" expects a string on top of the stack.\");\n     }\n     \n-    JsonParser parser = BOON_PARSER_FACTORY.create();\n-    \n-    Object json = null;\n-    \n     try {\n-      json = parser.parse(o.toString());\n-    } catch(JsonException je) {      \n-      // We don't include the original message as it can be very long\n-      throw new WarpScriptException(\"Error parsing JSON\", je);\n+      Object json = JsonUtils.jsonToObject(o.toString());\n+      stack.push(transform(json));\n+    } catch (IOException ioe) {\n+      throw new WarpScriptException(getName() + \"failed to parse JSON\", ioe);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b27cd97ec7375ab4d2ab7a6d62ef1c7597e9137"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMjcwNDM5OnYy", "diffSide": "RIGHT", "path": "warp10/src/main/java/io/warp10/script/functions/TOJSON.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxNDowMjoyMVrOFnnHig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxMzowMToyNlrOFoIC6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA3OTY5MA==", "bodyText": "This call will fail with an NPE if the stack attribute retrieved above is not set. It is set in the case of MemoryWarpScriptStack instances but potentially not in other implementations of WarpScriptStack.\nSame in MAXJSON", "url": "https://github.com/senx/warp10-platform/pull/660#discussion_r377079690", "createdAt": "2020-02-10T14:02:21Z", "author": {"login": "hbs"}, "path": "warp10/src/main/java/io/warp10/script/functions/TOJSON.java", "diffHunk": "@@ -43,120 +37,22 @@ public TOJSON(String name) {\n   public Object apply(WarpScriptStack stack) throws WarpScriptException {\n     Object o = stack.pop();\n \n-    JsonSerializer parser = BOON_SERIALIZER_FACTORY.create();\n-\n     //\n     // Only allow the serialization of simple lists and maps, otherwise JSON might\n     // expose internals\n     //\n \n-    if (!validate(o)) {\n-      throw new WarpScriptException(getName() + \" can only serialize structures containing numbers, strings, booleans, lists and maps which do not reference the same list/map multiple times.\");\n+    try {\n+      Long maxJsonSize = (Long)stack.getAttribute(WarpScriptStack.ATTRIBUTE_JSON_MAXSIZE);\n+      String json = JsonUtils.objectToJson(o, false, maxJsonSize);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b27cd97ec7375ab4d2ab7a6d62ef1c7597e9137"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzE4NjU1OQ==", "bodyText": "I think this is the case for all other limits.\nIt this is not set, what should be the value? The default one or the max one?", "url": "https://github.com/senx/warp10-platform/pull/660#discussion_r377186559", "createdAt": "2020-02-10T16:51:42Z", "author": {"login": "ftence"}, "path": "warp10/src/main/java/io/warp10/script/functions/TOJSON.java", "diffHunk": "@@ -43,120 +37,22 @@ public TOJSON(String name) {\n   public Object apply(WarpScriptStack stack) throws WarpScriptException {\n     Object o = stack.pop();\n \n-    JsonSerializer parser = BOON_SERIALIZER_FACTORY.create();\n-\n     //\n     // Only allow the serialization of simple lists and maps, otherwise JSON might\n     // expose internals\n     //\n \n-    if (!validate(o)) {\n-      throw new WarpScriptException(getName() + \" can only serialize structures containing numbers, strings, booleans, lists and maps which do not reference the same list/map multiple times.\");\n+    try {\n+      Long maxJsonSize = (Long)stack.getAttribute(WarpScriptStack.ATTRIBUTE_JSON_MAXSIZE);\n+      String json = JsonUtils.objectToJson(o, false, maxJsonSize);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA3OTY5MA=="}, "originalCommit": {"oid": "1b27cd97ec7375ab4d2ab7a6d62ef1c7597e9137"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzYxOTE3OA==", "bodyText": "Better fix that in another PR as all other limit attributes suffer from the same problem.", "url": "https://github.com/senx/warp10-platform/pull/660#discussion_r377619178", "createdAt": "2020-02-11T13:01:26Z", "author": {"login": "ftence"}, "path": "warp10/src/main/java/io/warp10/script/functions/TOJSON.java", "diffHunk": "@@ -43,120 +37,22 @@ public TOJSON(String name) {\n   public Object apply(WarpScriptStack stack) throws WarpScriptException {\n     Object o = stack.pop();\n \n-    JsonSerializer parser = BOON_SERIALIZER_FACTORY.create();\n-\n     //\n     // Only allow the serialization of simple lists and maps, otherwise JSON might\n     // expose internals\n     //\n \n-    if (!validate(o)) {\n-      throw new WarpScriptException(getName() + \" can only serialize structures containing numbers, strings, booleans, lists and maps which do not reference the same list/map multiple times.\");\n+    try {\n+      Long maxJsonSize = (Long)stack.getAttribute(WarpScriptStack.ATTRIBUTE_JSON_MAXSIZE);\n+      String json = JsonUtils.objectToJson(o, false, maxJsonSize);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA3OTY5MA=="}, "originalCommit": {"oid": "1b27cd97ec7375ab4d2ab7a6d62ef1c7597e9137"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMjc2NzU5OnYy", "diffSide": "RIGHT", "path": "warp10/src/main/java/io/warp10/json/JsonUtils.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxNDoxOTozOVrOFnntwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxNDoxOTozOVrOFnntwA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA4OTQ3Mg==", "bodyText": "Won't that surround sb's content with double quotes and escape it? This might not be what is expected.", "url": "https://github.com/senx/warp10-platform/pull/660#discussion_r377089472", "createdAt": "2020-02-10T14:19:39Z", "author": {"login": "hbs"}, "path": "warp10/src/main/java/io/warp10/json/JsonUtils.java", "diffHunk": "@@ -0,0 +1,211 @@\n+//\n+//   Copyright 2020  SenX S.A.S.\n+//\n+//   Licensed under the Apache License, Version 2.0 (the \"License\");\n+//   you may not use this file except in compliance with the License.\n+//   You may obtain a copy of the License at\n+//\n+//     http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//   Unless required by applicable law or agreed to in writing, software\n+//   distributed under the License is distributed on an \"AS IS\" BASIS,\n+//   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+//   See the License for the specific language governing permissions and\n+//   limitations under the License.\n+//\n+\n+package io.warp10.json;\n+\n+import com.fasterxml.jackson.core.JsonFactoryBuilder;\n+import com.fasterxml.jackson.core.JsonGenerator;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.core.StreamWriteFeature;\n+import com.fasterxml.jackson.core.json.JsonReadFeature;\n+import com.fasterxml.jackson.core.json.JsonWriteFeature;\n+import com.fasterxml.jackson.databind.BeanDescription;\n+import com.fasterxml.jackson.databind.JsonSerializer;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.SerializationConfig;\n+import com.fasterxml.jackson.databind.SerializerProvider;\n+import com.fasterxml.jackson.databind.module.SimpleModule;\n+import com.fasterxml.jackson.databind.ser.BeanSerializer;\n+import com.fasterxml.jackson.databind.ser.BeanSerializerModifier;\n+import com.fasterxml.jackson.databind.ser.impl.UnknownSerializer;\n+import io.warp10.continuum.gts.GTSEncoder;\n+import io.warp10.continuum.gts.GeoTimeSerie;\n+import io.warp10.continuum.store.thrift.data.Metadata;\n+import io.warp10.script.NamedWarpScriptFunction;\n+import io.warp10.script.WarpScriptStack;\n+\n+import java.io.IOException;\n+import java.io.StringWriter;\n+import java.io.Writer;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+public class JsonUtils {\n+\n+  /**\n+   * A serializer for null keys.\n+   * Outputs \"null\" because most javascript engines coerce null to \"null\" when using it as a key.\n+   */\n+  private static class NullKeySerializer extends JsonSerializer<Object> {\n+    @Override\n+    public void serialize(Object value, JsonGenerator gen, SerializerProvider serializers) throws IOException {\n+      gen.writeFieldName(\"null\");\n+    }\n+  }\n+\n+  /**\n+   * Used to swap UnknownSerializer and BeanSerializer for CustomEncodersSerializer.\n+   */\n+  public static class NotSerializedToCustomSerializedModifier extends BeanSerializerModifier {\n+    @Override\n+    public JsonSerializer<?> modifySerializer(SerializationConfig config, BeanDescription beanDesc, JsonSerializer<?> serializer) {\n+      if (serializer instanceof UnknownSerializer || serializer instanceof BeanSerializer) {\n+        return customEncodersSerializer;\n+      } else {\n+        return serializer;\n+      }\n+    }\n+  }\n+\n+  public static class CustomEncodersSerializer extends JsonSerializer<Object> {\n+    @Override\n+    public void serialize(Object value, JsonGenerator gen, SerializerProvider serializers) throws IOException {\n+      if (null != encoders && !encoders.isEmpty()) {\n+        StringBuilder sb = new StringBuilder();\n+        boolean encoded = false;\n+        for (JsonEncoder encoder: encoders) {\n+          encoded = encoder.addElement(sb, value);\n+          if (encoded) {\n+            break;\n+          }\n+        }\n+        if (encoded) {\n+          gen.writeString(sb.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b27cd97ec7375ab4d2ab7a6d62ef1c7597e9137"}, "originalPosition": 86}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMjc3Njg5OnYy", "diffSide": "RIGHT", "path": "warp10/src/main/java/io/warp10/json/MetadataSerializer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxNDoyMTo1NFrOFnnzRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxNDoyMTo1NFrOFnnzRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA5MDg4NQ==", "bodyText": "Why isn't this called by the serializer for GTS and GTS Encoders?", "url": "https://github.com/senx/warp10-platform/pull/660#discussion_r377090885", "createdAt": "2020-02-10T14:21:54Z", "author": {"login": "hbs"}, "path": "warp10/src/main/java/io/warp10/json/MetadataSerializer.java", "diffHunk": "@@ -0,0 +1,42 @@\n+//\n+//   Copyright 2020  SenX S.A.S.\n+//\n+//   Licensed under the Apache License, Version 2.0 (the \"License\");\n+//   you may not use this file except in compliance with the License.\n+//   You may obtain a copy of the License at\n+//\n+//     http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//   Unless required by applicable law or agreed to in writing, software\n+//   distributed under the License is distributed on an \"AS IS\" BASIS,\n+//   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+//   See the License for the specific language governing permissions and\n+//   limitations under the License.\n+//\n+\n+package io.warp10.json;\n+\n+import com.fasterxml.jackson.core.JsonGenerator;\n+import com.fasterxml.jackson.databind.JsonSerializer;\n+import com.fasterxml.jackson.databind.SerializerProvider;\n+import io.warp10.continuum.store.thrift.data.Metadata;\n+\n+import java.io.IOException;\n+\n+public class MetadataSerializer extends JsonSerializer<Metadata> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b27cd97ec7375ab4d2ab7a6d62ef1c7597e9137"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzNjUwMDc1OnYy", "diffSide": "RIGHT", "path": "warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxNDozNDozNlrOFoLOtA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxNDozNDozNlrOFoLOtA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzY3MTM0OA==", "bodyText": "Use the constant", "url": "https://github.com/senx/warp10-platform/pull/660#discussion_r377671348", "createdAt": "2020-02-11T14:34:36Z", "author": {"login": "hbs"}, "path": "warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java", "diffHunk": "@@ -0,0 +1,84 @@\n+//\n+//   Copyright 2020  SenX S.A.S.\n+//\n+//   Licensed under the Apache License, Version 2.0 (the \"License\");\n+//   you may not use this file except in compliance with the License.\n+//   You may obtain a copy of the License at\n+//\n+//     http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//   Unless required by applicable law or agreed to in writing, software\n+//   distributed under the License is distributed on an \"AS IS\" BASIS,\n+//   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+//   See the License for the specific language governing permissions and\n+//   limitations under the License.\n+//\n+\n+package io.warp10.json;\n+\n+import com.fasterxml.jackson.core.JsonGenerator;\n+import com.fasterxml.jackson.databind.JsonSerializer;\n+import com.fasterxml.jackson.databind.SerializerProvider;\n+import com.fasterxml.jackson.databind.ser.std.StdSerializer;\n+import com.geoxp.GeoXPLib;\n+import io.warp10.continuum.gts.GTSDecoder;\n+import io.warp10.continuum.gts.GTSEncoder;\n+import io.warp10.continuum.gts.GeoTimeSerie;\n+import io.warp10.continuum.store.thrift.data.Metadata;\n+\n+import java.io.IOException;\n+\n+public class GTSEncoderSerializer extends StdSerializer<GTSEncoder> {\n+\n+  protected GTSEncoderSerializer() {\n+    super(GTSEncoder.class);\n+  }\n+\n+  @Override\n+  public void serialize(GTSEncoder encoder, JsonGenerator gen, SerializerProvider provider) throws IOException {\n+    Metadata metadata = encoder.getMetadata();\n+\n+    gen.writeStartObject();\n+    MetadataSerializer.serializeMetadataFields(metadata, gen);\n+    gen.writeFieldName(\"v\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3df08c5715d884834a21c0047d407763459db95"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzNjUxNDc5OnYy", "diffSide": "RIGHT", "path": "warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxNDozODoxOVrOFoLXow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxNDozODoxOVrOFoLXow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzY3MzYzNQ==", "bodyText": "Use the constants defined in the MetadataSerializer?", "url": "https://github.com/senx/warp10-platform/pull/660#discussion_r377673635", "createdAt": "2020-02-11T14:38:19Z", "author": {"login": "hbs"}, "path": "warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java", "diffHunk": "@@ -1341,8 +1338,7 @@ static void jsonDump(PrintWriter pw, Iterator<GTSDecoder> iter, long now, long c\n           \n           sb.append(\"{\\\"c\\\":\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3df08c5715d884834a21c0047d407763459db95"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM0MjAwMTMwOnYy", "diffSide": "RIGHT", "path": "warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQyMjoxMjowNFrOFpAbrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQyMjoxMjowNFrOFpAbrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU0MzAyMg==", "bodyText": "FIELD_ID", "url": "https://github.com/senx/warp10-platform/pull/660#discussion_r378543022", "createdAt": "2020-02-12T22:12:04Z", "author": {"login": "hbs"}, "path": "warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java", "diffHunk": "@@ -1365,38 +1367,40 @@ static void jsonDump(PrintWriter pw, Iterator<GTSDecoder> iter, long now, long c\n               sb.append(\",\");\n             }\n             \n-            //sb.append(gson.toJson(entry.getKey()));\n-            sb.append(serializer.serialize(entry.getKey()));\n+            sb.append(JsonUtils.objectToJson(entry.getKey()));\n             sb.append(\":\");\n-            //sb.append(gson.toJson(entry.getValue()));\n-            sb.append(serializer.serialize(entry.getValue()));\n+            sb.append(JsonUtils.objectToJson(entry.getValue()));\n             first = false;\n           }\n           sb.append(\"}\");\n-          \n-          sb.append(\",\\\"a\\\":{\");\n+\n+          sb.append(\",\\\"\");\n+          sb.append(MetadataSerializer.FIELD_ATTRIBUTES);\n+          sb.append(\"\\\":{\");\n \n           first = true;\n           for (Entry<String, String> entry: decoder.getMetadata().getAttributes().entrySet()) {\n             if (!first) {\n               sb.append(\",\");\n             }\n             \n-            //sb.append(gson.toJson(entry.getKey()));\n-            sb.append(serializer.serialize(entry.getKey()));\n+            sb.append(JsonUtils.objectToJson(entry.getKey()));\n             sb.append(\":\");\n-            //sb.append(gson.toJson(entry.getValue()));\n-            sb.append(serializer.serialize(entry.getValue()));\n+            sb.append(JsonUtils.objectToJson(entry.getValue()));\n             first = false;\n           }\n           \n           sb.append(\"}\");\n           sb.append(\",\\\"i\\\":\\\"\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d19b437e1adfcd813f5f6be5453372c73dfc4e00"}, "originalPosition": 93}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM0NzI1NzI2OnYy", "diffSide": "RIGHT", "path": "warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxMDo1NToxNVrOFpy2lA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxMTowMjoxOVrOFpzCnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTM2OTEwOA==", "bodyText": "It is a an id, not directly the labelsId, so better call this field FIELD_ID as it could very well not stay related to the labels id only", "url": "https://github.com/senx/warp10-platform/pull/660#discussion_r379369108", "createdAt": "2020-02-14T10:55:15Z", "author": {"login": "hbs"}, "path": "warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java", "diffHunk": "@@ -1365,38 +1367,42 @@ static void jsonDump(PrintWriter pw, Iterator<GTSDecoder> iter, long now, long c\n               sb.append(\",\");\n             }\n             \n-            //sb.append(gson.toJson(entry.getKey()));\n-            sb.append(serializer.serialize(entry.getKey()));\n+            sb.append(JsonUtils.objectToJson(entry.getKey()));\n             sb.append(\":\");\n-            //sb.append(gson.toJson(entry.getValue()));\n-            sb.append(serializer.serialize(entry.getValue()));\n+            sb.append(JsonUtils.objectToJson(entry.getValue()));\n             first = false;\n           }\n           sb.append(\"}\");\n-          \n-          sb.append(\",\\\"a\\\":{\");\n+\n+          sb.append(\",\\\"\");\n+          sb.append(MetadataSerializer.FIELD_ATTRIBUTES);\n+          sb.append(\"\\\":{\");\n \n           first = true;\n           for (Entry<String, String> entry: decoder.getMetadata().getAttributes().entrySet()) {\n             if (!first) {\n               sb.append(\",\");\n             }\n             \n-            //sb.append(gson.toJson(entry.getKey()));\n-            sb.append(serializer.serialize(entry.getKey()));\n+            sb.append(JsonUtils.objectToJson(entry.getKey()));\n             sb.append(\":\");\n-            //sb.append(gson.toJson(entry.getValue()));\n-            sb.append(serializer.serialize(entry.getValue()));\n+            sb.append(JsonUtils.objectToJson(entry.getValue()));\n             first = false;\n           }\n           \n           sb.append(\"}\");\n-          sb.append(\",\\\"i\\\":\\\"\");\n+          sb.append(\",\\\"\");\n+          sb.append(MetadataSerializer.FIELD_LABELSID);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4e1b2b6977dd432d50ccb33033ffd53d5bd55d4"}, "originalPosition": 95}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTM3MjE4OA==", "bodyText": "True. As this is not related to Metadata, I have to put this constant in EgressFetchHandler.", "url": "https://github.com/senx/warp10-platform/pull/660#discussion_r379372188", "createdAt": "2020-02-14T11:02:19Z", "author": {"login": "ftence"}, "path": "warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java", "diffHunk": "@@ -1365,38 +1367,42 @@ static void jsonDump(PrintWriter pw, Iterator<GTSDecoder> iter, long now, long c\n               sb.append(\",\");\n             }\n             \n-            //sb.append(gson.toJson(entry.getKey()));\n-            sb.append(serializer.serialize(entry.getKey()));\n+            sb.append(JsonUtils.objectToJson(entry.getKey()));\n             sb.append(\":\");\n-            //sb.append(gson.toJson(entry.getValue()));\n-            sb.append(serializer.serialize(entry.getValue()));\n+            sb.append(JsonUtils.objectToJson(entry.getValue()));\n             first = false;\n           }\n           sb.append(\"}\");\n-          \n-          sb.append(\",\\\"a\\\":{\");\n+\n+          sb.append(\",\\\"\");\n+          sb.append(MetadataSerializer.FIELD_ATTRIBUTES);\n+          sb.append(\"\\\":{\");\n \n           first = true;\n           for (Entry<String, String> entry: decoder.getMetadata().getAttributes().entrySet()) {\n             if (!first) {\n               sb.append(\",\");\n             }\n             \n-            //sb.append(gson.toJson(entry.getKey()));\n-            sb.append(serializer.serialize(entry.getKey()));\n+            sb.append(JsonUtils.objectToJson(entry.getKey()));\n             sb.append(\":\");\n-            //sb.append(gson.toJson(entry.getValue()));\n-            sb.append(serializer.serialize(entry.getValue()));\n+            sb.append(JsonUtils.objectToJson(entry.getValue()));\n             first = false;\n           }\n           \n           sb.append(\"}\");\n-          sb.append(\",\\\"i\\\":\\\"\");\n+          sb.append(\",\\\"\");\n+          sb.append(MetadataSerializer.FIELD_LABELSID);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTM2OTEwOA=="}, "originalCommit": {"oid": "f4e1b2b6977dd432d50ccb33033ffd53d5bd55d4"}, "originalPosition": 95}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM0NzI2NDg3OnYy", "diffSide": "RIGHT", "path": "warp10/src/main/java/io/warp10/json/JsonUtils.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxMDo1ODowM1rOFpy7Zg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxMTowNTo0OVrOFpzIgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTM3MDM0Mg==", "bodyText": "Are integer numbers correctly converted to LONGs by this?", "url": "https://github.com/senx/warp10-platform/pull/660#discussion_r379370342", "createdAt": "2020-02-14T10:58:03Z", "author": {"login": "hbs"}, "path": "warp10/src/main/java/io/warp10/json/JsonUtils.java", "diffHunk": "@@ -0,0 +1,214 @@\n+//\n+//   Copyright 2020  SenX S.A.S.\n+//\n+//   Licensed under the Apache License, Version 2.0 (the \"License\");\n+//   you may not use this file except in compliance with the License.\n+//   You may obtain a copy of the License at\n+//\n+//     http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//   Unless required by applicable law or agreed to in writing, software\n+//   distributed under the License is distributed on an \"AS IS\" BASIS,\n+//   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+//   See the License for the specific language governing permissions and\n+//   limitations under the License.\n+//\n+\n+package io.warp10.json;\n+\n+import com.fasterxml.jackson.core.JsonFactoryBuilder;\n+import com.fasterxml.jackson.core.JsonGenerator;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.core.StreamWriteFeature;\n+import com.fasterxml.jackson.core.json.JsonReadFeature;\n+import com.fasterxml.jackson.core.json.JsonWriteFeature;\n+import com.fasterxml.jackson.databind.BeanDescription;\n+import com.fasterxml.jackson.databind.JsonSerializer;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.SerializationConfig;\n+import com.fasterxml.jackson.databind.SerializerProvider;\n+import com.fasterxml.jackson.databind.module.SimpleModule;\n+import com.fasterxml.jackson.databind.ser.BeanSerializer;\n+import com.fasterxml.jackson.databind.ser.BeanSerializerModifier;\n+import com.fasterxml.jackson.databind.ser.impl.UnknownSerializer;\n+import io.warp10.continuum.gts.GTSEncoder;\n+import io.warp10.continuum.gts.GeoTimeSerie;\n+import io.warp10.continuum.store.thrift.data.Metadata;\n+import io.warp10.script.NamedWarpScriptFunction;\n+import io.warp10.script.WarpScriptStack;\n+\n+import java.io.IOException;\n+import java.io.StringWriter;\n+import java.io.Writer;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+public class JsonUtils {\n+\n+  /**\n+   * A serializer for null keys.\n+   * Outputs \"null\" because most javascript engines coerce null to \"null\" when using it as a key.\n+   */\n+  private static class NullKeySerializer extends JsonSerializer<Object> {\n+    @Override\n+    public void serialize(Object value, JsonGenerator gen, SerializerProvider serializers) throws IOException {\n+      gen.writeFieldName(\"null\");\n+    }\n+  }\n+\n+  /**\n+   * Used to swap UnknownSerializer and BeanSerializer for CustomEncodersSerializer.\n+   */\n+  public static class NotSerializedToCustomSerializedModifier extends BeanSerializerModifier {\n+    @Override\n+    public JsonSerializer<?> modifySerializer(SerializationConfig config, BeanDescription beanDesc, JsonSerializer<?> serializer) {\n+      if (serializer instanceof UnknownSerializer || serializer instanceof BeanSerializer) {\n+        return customEncodersSerializer;\n+      } else {\n+        return serializer;\n+      }\n+    }\n+  }\n+\n+  public static class CustomEncodersSerializer extends JsonSerializer<Object> {\n+    @Override\n+    public void serialize(Object value, JsonGenerator gen, SerializerProvider serializers) throws IOException {\n+      if (null != encoders && !encoders.isEmpty()) {\n+        StringBuilder sb = new StringBuilder();\n+        boolean encoded = false;\n+        for (JsonEncoder encoder: encoders) {\n+          encoded = encoder.addElement(sb, value);\n+          if (encoded) {\n+            break;\n+          }\n+        }\n+        if (encoded) {\n+          gen.writeRaw(sb.toString());\n+        } else {\n+          // No custom encoders able to encode this object, write null.\n+          gen.writeNull();\n+        }\n+      } else {\n+        // No custom encoders defined, write null.\n+        gen.writeNull();\n+      }\n+    }\n+  }\n+\n+  public static final NullKeySerializer nullKeySerializer = new NullKeySerializer();\n+  public static final CustomEncodersSerializer customEncodersSerializer = new CustomEncodersSerializer();\n+\n+  //\n+  // ObjectMapper instances are thread-safe, so we can safely use a single static instance.\n+  //\n+  private static final ObjectMapper strictMapper;\n+  private static final ObjectMapper looseMapper;\n+\n+  public interface JsonEncoder {\n+    boolean addElement(StringBuilder sb, Object o);\n+  }\n+\n+  private static List<JsonEncoder> encoders;\n+\n+  static {\n+    //\n+    // Configure a module to handle the serialization of non-base classes.\n+    //\n+    SimpleModule module = new SimpleModule();\n+    // Add the NotSerializedToCustomSerializedModifier instance\n+    module.setSerializerModifier(new NotSerializedToCustomSerializedModifier());\n+    // Add core custom serializers\n+    module.addSerializer(new GeoTimeSerieSerializer());\n+    module.addSerializer(new GTSEncoderSerializer());\n+    module.addSerializer(new MetadataSerializer());\n+    module.addSerializer(new NamedWarpScriptFunctionSerializer());\n+    module.addSerializer(new MacroSerializer());\n+    module.addSerializer(new BytesSerializer());\n+    module.addSerializer(new RealVectorSerializer());\n+    module.addSerializer(new RealMatrixSerializer());\n+\n+    //\n+    // Common configuration for both strict and loose mappers.\n+    //\n+    JsonFactoryBuilder builder = new JsonFactoryBuilder();\n+    builder.enable(JsonReadFeature.ALLOW_NON_NUMERIC_NUMBERS);\n+    builder.enable(JsonReadFeature.ALLOW_MISSING_VALUES);\n+    builder.enable(JsonWriteFeature.ESCAPE_NON_ASCII);\n+    builder.disable(JsonWriteFeature.WRITE_NUMBERS_AS_STRINGS);\n+    builder.disable(StreamWriteFeature.AUTO_CLOSE_TARGET);\n+\n+    //\n+    // Configure strict mapper\n+    //\n+    builder.enable(JsonWriteFeature.WRITE_NAN_AS_STRINGS);\n+    strictMapper = new ObjectMapper(builder.build());\n+    strictMapper.getSerializerProvider().setNullKeySerializer(nullKeySerializer);\n+    strictMapper.registerModule(module);\n+\n+    //\n+    // Configure loose mapper\n+    //\n+    builder.disable(JsonWriteFeature.WRITE_NAN_AS_STRINGS);\n+    looseMapper = new ObjectMapper(builder.build());\n+    looseMapper.getSerializerProvider().setNullKeySerializer(nullKeySerializer);\n+    looseMapper.registerModule(module);\n+  }\n+\n+  //\n+  // Method to deserialize JSON to Objects.\n+  //\n+\n+  public static Object jsonToObject(String json) throws JsonProcessingException {\n+    return strictMapper.readValue(json, Object.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4e1b2b6977dd432d50ccb33033ffd53d5bd55d4"}, "originalPosition": 162}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTM3MzY5OA==", "bodyText": "Yes, and floating-point numbers to Double.", "url": "https://github.com/senx/warp10-platform/pull/660#discussion_r379373698", "createdAt": "2020-02-14T11:05:49Z", "author": {"login": "ftence"}, "path": "warp10/src/main/java/io/warp10/json/JsonUtils.java", "diffHunk": "@@ -0,0 +1,214 @@\n+//\n+//   Copyright 2020  SenX S.A.S.\n+//\n+//   Licensed under the Apache License, Version 2.0 (the \"License\");\n+//   you may not use this file except in compliance with the License.\n+//   You may obtain a copy of the License at\n+//\n+//     http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//   Unless required by applicable law or agreed to in writing, software\n+//   distributed under the License is distributed on an \"AS IS\" BASIS,\n+//   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+//   See the License for the specific language governing permissions and\n+//   limitations under the License.\n+//\n+\n+package io.warp10.json;\n+\n+import com.fasterxml.jackson.core.JsonFactoryBuilder;\n+import com.fasterxml.jackson.core.JsonGenerator;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.core.StreamWriteFeature;\n+import com.fasterxml.jackson.core.json.JsonReadFeature;\n+import com.fasterxml.jackson.core.json.JsonWriteFeature;\n+import com.fasterxml.jackson.databind.BeanDescription;\n+import com.fasterxml.jackson.databind.JsonSerializer;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.SerializationConfig;\n+import com.fasterxml.jackson.databind.SerializerProvider;\n+import com.fasterxml.jackson.databind.module.SimpleModule;\n+import com.fasterxml.jackson.databind.ser.BeanSerializer;\n+import com.fasterxml.jackson.databind.ser.BeanSerializerModifier;\n+import com.fasterxml.jackson.databind.ser.impl.UnknownSerializer;\n+import io.warp10.continuum.gts.GTSEncoder;\n+import io.warp10.continuum.gts.GeoTimeSerie;\n+import io.warp10.continuum.store.thrift.data.Metadata;\n+import io.warp10.script.NamedWarpScriptFunction;\n+import io.warp10.script.WarpScriptStack;\n+\n+import java.io.IOException;\n+import java.io.StringWriter;\n+import java.io.Writer;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+public class JsonUtils {\n+\n+  /**\n+   * A serializer for null keys.\n+   * Outputs \"null\" because most javascript engines coerce null to \"null\" when using it as a key.\n+   */\n+  private static class NullKeySerializer extends JsonSerializer<Object> {\n+    @Override\n+    public void serialize(Object value, JsonGenerator gen, SerializerProvider serializers) throws IOException {\n+      gen.writeFieldName(\"null\");\n+    }\n+  }\n+\n+  /**\n+   * Used to swap UnknownSerializer and BeanSerializer for CustomEncodersSerializer.\n+   */\n+  public static class NotSerializedToCustomSerializedModifier extends BeanSerializerModifier {\n+    @Override\n+    public JsonSerializer<?> modifySerializer(SerializationConfig config, BeanDescription beanDesc, JsonSerializer<?> serializer) {\n+      if (serializer instanceof UnknownSerializer || serializer instanceof BeanSerializer) {\n+        return customEncodersSerializer;\n+      } else {\n+        return serializer;\n+      }\n+    }\n+  }\n+\n+  public static class CustomEncodersSerializer extends JsonSerializer<Object> {\n+    @Override\n+    public void serialize(Object value, JsonGenerator gen, SerializerProvider serializers) throws IOException {\n+      if (null != encoders && !encoders.isEmpty()) {\n+        StringBuilder sb = new StringBuilder();\n+        boolean encoded = false;\n+        for (JsonEncoder encoder: encoders) {\n+          encoded = encoder.addElement(sb, value);\n+          if (encoded) {\n+            break;\n+          }\n+        }\n+        if (encoded) {\n+          gen.writeRaw(sb.toString());\n+        } else {\n+          // No custom encoders able to encode this object, write null.\n+          gen.writeNull();\n+        }\n+      } else {\n+        // No custom encoders defined, write null.\n+        gen.writeNull();\n+      }\n+    }\n+  }\n+\n+  public static final NullKeySerializer nullKeySerializer = new NullKeySerializer();\n+  public static final CustomEncodersSerializer customEncodersSerializer = new CustomEncodersSerializer();\n+\n+  //\n+  // ObjectMapper instances are thread-safe, so we can safely use a single static instance.\n+  //\n+  private static final ObjectMapper strictMapper;\n+  private static final ObjectMapper looseMapper;\n+\n+  public interface JsonEncoder {\n+    boolean addElement(StringBuilder sb, Object o);\n+  }\n+\n+  private static List<JsonEncoder> encoders;\n+\n+  static {\n+    //\n+    // Configure a module to handle the serialization of non-base classes.\n+    //\n+    SimpleModule module = new SimpleModule();\n+    // Add the NotSerializedToCustomSerializedModifier instance\n+    module.setSerializerModifier(new NotSerializedToCustomSerializedModifier());\n+    // Add core custom serializers\n+    module.addSerializer(new GeoTimeSerieSerializer());\n+    module.addSerializer(new GTSEncoderSerializer());\n+    module.addSerializer(new MetadataSerializer());\n+    module.addSerializer(new NamedWarpScriptFunctionSerializer());\n+    module.addSerializer(new MacroSerializer());\n+    module.addSerializer(new BytesSerializer());\n+    module.addSerializer(new RealVectorSerializer());\n+    module.addSerializer(new RealMatrixSerializer());\n+\n+    //\n+    // Common configuration for both strict and loose mappers.\n+    //\n+    JsonFactoryBuilder builder = new JsonFactoryBuilder();\n+    builder.enable(JsonReadFeature.ALLOW_NON_NUMERIC_NUMBERS);\n+    builder.enable(JsonReadFeature.ALLOW_MISSING_VALUES);\n+    builder.enable(JsonWriteFeature.ESCAPE_NON_ASCII);\n+    builder.disable(JsonWriteFeature.WRITE_NUMBERS_AS_STRINGS);\n+    builder.disable(StreamWriteFeature.AUTO_CLOSE_TARGET);\n+\n+    //\n+    // Configure strict mapper\n+    //\n+    builder.enable(JsonWriteFeature.WRITE_NAN_AS_STRINGS);\n+    strictMapper = new ObjectMapper(builder.build());\n+    strictMapper.getSerializerProvider().setNullKeySerializer(nullKeySerializer);\n+    strictMapper.registerModule(module);\n+\n+    //\n+    // Configure loose mapper\n+    //\n+    builder.disable(JsonWriteFeature.WRITE_NAN_AS_STRINGS);\n+    looseMapper = new ObjectMapper(builder.build());\n+    looseMapper.getSerializerProvider().setNullKeySerializer(nullKeySerializer);\n+    looseMapper.registerModule(module);\n+  }\n+\n+  //\n+  // Method to deserialize JSON to Objects.\n+  //\n+\n+  public static Object jsonToObject(String json) throws JsonProcessingException {\n+    return strictMapper.readValue(json, Object.class);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTM3MDM0Mg=="}, "originalCommit": {"oid": "f4e1b2b6977dd432d50ccb33033ffd53d5bd55d4"}, "originalPosition": 162}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1300, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}