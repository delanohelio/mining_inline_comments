{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk0MDgxNzQw", "number": 854, "title": "Allow GET on String and make path-like parameter work on all accepted types", "bodyText": "", "createdAt": "2020-09-28T11:39:10Z", "url": "https://github.com/senx/warp10-platform/pull/854", "merged": true, "mergeCommit": {"oid": "de673591bfbe6bcf4f5961647240a8a943c8878d"}, "closed": true, "closedAt": "2021-01-28T15:41:05Z", "author": {"login": "ftence"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdNR6SRAH2gAyNDk0MDgxNzQwOjRiYzgwZWM1ZmEyNjZmNGJkN2RiNjdmOWNkNzNiNjI3NGMxN2U4OTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABd0QMr1AH2gAyNDk0MDgxNzQwOmQ2ZjVjYjZjNTg0MzIxMWUwZDkwZDQ5MDgyNjg1ODc5ZjIyZmRiOTA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4bc80ec5fa266f4bd7db67f9cd73b6274c17e890", "author": {"user": {"login": "ftence", "name": "Fabien Tenc\u00e9"}}, "url": "https://github.com/senx/warp10-platform/commit/4bc80ec5fa266f4bd7db67f9cd73b6274c17e890", "committedDate": "2020-09-28T11:30:18Z", "message": "Allow GET on String and make path-like parameter work on all accepted types"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a1870ba10e63dd9d4ed76e87538d52c9d0198ef", "author": {"user": {"login": "ftence", "name": "Fabien Tenc\u00e9"}}, "url": "https://github.com/senx/warp10-platform/commit/6a1870ba10e63dd9d4ed76e87538d52c9d0198ef", "committedDate": "2020-09-28T11:37:52Z", "message": "Add comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3NDMxNjg5", "url": "https://github.com/senx/warp10-platform/pull/854#pullrequestreview-497431689", "createdAt": "2020-09-28T11:45:59Z", "commit": {"oid": "6a1870ba10e63dd9d4ed76e87538d52c9d0198ef"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxMTo0NjowMFrOHY6ADQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxMTo0NzoxMlrOHY6CTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTg3ODE1Nw==", "bodyText": "LIST", "url": "https://github.com/senx/warp10-platform/pull/854#discussion_r495878157", "createdAt": "2020-09-28T11:46:00Z", "author": {"login": "hbs"}, "path": "warp10/src/main/java/io/warp10/script/functions/GET.java", "diffHunk": "@@ -17,74 +17,93 @@\n package io.warp10.script.functions;\n \n import io.warp10.script.NamedWarpScriptFunction;\n-import io.warp10.script.WarpScriptStackFunction;\n import io.warp10.script.WarpScriptException;\n import io.warp10.script.WarpScriptStack;\n+import io.warp10.script.WarpScriptStackFunction;\n \n import java.util.List;\n import java.util.Map;\n \n /**\n- * Extracts a value from a map, list, or byte array given a key.\n+ * Extracts a value from a map, list, a byte array or a String, given a key.\n  */\n public class GET extends NamedWarpScriptFunction implements WarpScriptStackFunction {\n-  \n+\n   public GET(String name) {\n     super(name);\n   }\n-  \n+\n   @Override\n   public Object apply(WarpScriptStack stack) throws WarpScriptException {\n     Object key = stack.pop();\n-    \n+\n     Object coll = stack.pop();\n \n-    if (!(coll instanceof Map) && !(coll instanceof List) && !(coll instanceof byte[])) {\n-      throw new WarpScriptException(getName() + \" operates on a map, list or byte array.\");\n-    }\n-    \n-    Object value = null;\n-    \n-    if (coll instanceof Map) {\n-      value = ((Map) coll).get(key);\n+    Object value;\n \n-    } else if (key instanceof Long) {\n-      int idx = ((Long) key).intValue();\n+    try {\n+      if (key instanceof List) {\n+        // The list is considered to be a kind of path. For instance [ 'a' 0 -1 ] GET is equivalent to 'a' GET 0 GET -1 GET.\n+        value = coll;\n+        for (Object keyElement: (List) key) {\n+          value = get(keyElement, value);\n+        }\n+      } else {\n+        value = get(key, coll);\n+      }\n+    } catch (WarpScriptException | IndexOutOfBoundsException e) {\n+      throw new WarpScriptException(getName() + \" failed.\", e);\n+    }\n \n-      if (coll instanceof List) {\n-        int size = ((List) coll).size();\n+    stack.push(value);\n \n-        idx = computeAndCheckIndex(idx, size);\n+    return stack;\n+  }\n \n-        value = ((List) coll).get(idx);\n+  /**\n+   * Get a value from a List, Map, byte[] or String using respectively a Long, Object, Long or Long key.\n+   * @param key Either on Object for a Map or a Long for List, byte[] or String. Negative indexing is possible, in that case the corresponding index is size + index.\n+   * @param collection Either a List, Map, byte[] or String instance.\n+   * @return The value at the given key.\n+   * @throws WarpScriptException If the collection type cannot be handled or the key is invalid for the collection type.\n+   */\n+  public static Object get(Object key, Object collection) throws WarpScriptException {\n+    if (collection instanceof List) {\n+      if (!(key instanceof Long)) {\n+        throw new WarpScriptException(\"Getting on List requires a Long.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6a1870ba10e63dd9d4ed76e87538d52c9d0198ef"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTg3ODczNA==", "bodyText": "It would probably be better to return a byte array of length 1 rather than a LONG, it would be more coherent with the way GET behaves for STRINGs.", "url": "https://github.com/senx/warp10-platform/pull/854#discussion_r495878734", "createdAt": "2020-09-28T11:47:12Z", "author": {"login": "hbs"}, "path": "warp10/src/main/java/io/warp10/script/functions/GET.java", "diffHunk": "@@ -17,74 +17,93 @@\n package io.warp10.script.functions;\n \n import io.warp10.script.NamedWarpScriptFunction;\n-import io.warp10.script.WarpScriptStackFunction;\n import io.warp10.script.WarpScriptException;\n import io.warp10.script.WarpScriptStack;\n+import io.warp10.script.WarpScriptStackFunction;\n \n import java.util.List;\n import java.util.Map;\n \n /**\n- * Extracts a value from a map, list, or byte array given a key.\n+ * Extracts a value from a map, list, a byte array or a String, given a key.\n  */\n public class GET extends NamedWarpScriptFunction implements WarpScriptStackFunction {\n-  \n+\n   public GET(String name) {\n     super(name);\n   }\n-  \n+\n   @Override\n   public Object apply(WarpScriptStack stack) throws WarpScriptException {\n     Object key = stack.pop();\n-    \n+\n     Object coll = stack.pop();\n \n-    if (!(coll instanceof Map) && !(coll instanceof List) && !(coll instanceof byte[])) {\n-      throw new WarpScriptException(getName() + \" operates on a map, list or byte array.\");\n-    }\n-    \n-    Object value = null;\n-    \n-    if (coll instanceof Map) {\n-      value = ((Map) coll).get(key);\n+    Object value;\n \n-    } else if (key instanceof Long) {\n-      int idx = ((Long) key).intValue();\n+    try {\n+      if (key instanceof List) {\n+        // The list is considered to be a kind of path. For instance [ 'a' 0 -1 ] GET is equivalent to 'a' GET 0 GET -1 GET.\n+        value = coll;\n+        for (Object keyElement: (List) key) {\n+          value = get(keyElement, value);\n+        }\n+      } else {\n+        value = get(key, coll);\n+      }\n+    } catch (WarpScriptException | IndexOutOfBoundsException e) {\n+      throw new WarpScriptException(getName() + \" failed.\", e);\n+    }\n \n-      if (coll instanceof List) {\n-        int size = ((List) coll).size();\n+    stack.push(value);\n \n-        idx = computeAndCheckIndex(idx, size);\n+    return stack;\n+  }\n \n-        value = ((List) coll).get(idx);\n+  /**\n+   * Get a value from a List, Map, byte[] or String using respectively a Long, Object, Long or Long key.\n+   * @param key Either on Object for a Map or a Long for List, byte[] or String. Negative indexing is possible, in that case the corresponding index is size + index.\n+   * @param collection Either a List, Map, byte[] or String instance.\n+   * @return The value at the given key.\n+   * @throws WarpScriptException If the collection type cannot be handled or the key is invalid for the collection type.\n+   */\n+  public static Object get(Object key, Object collection) throws WarpScriptException {\n+    if (collection instanceof List) {\n+      if (!(key instanceof Long)) {\n+        throw new WarpScriptException(\"Getting on List requires a Long.\");\n+      }\n \n-      } else {\n-        int size = ((byte[]) coll).length;\n+      int idx = ((Long) key).intValue();\n+      int size = ((List) collection).size();\n+      idx = computeAndCheckIndex(idx, size);\n+      return ((List) collection).get(idx);\n \n-        idx = computeAndCheckIndex(idx, size);\n+    } else if (collection instanceof Map) {\n+      return ((Map) collection).get(key);\n \n-        value = (long) (((byte[]) coll)[idx] & 0xFFL);\n+    } else if (collection instanceof String) {\n+      if (!(key instanceof Long)) {\n+        throw new WarpScriptException(\"Getting on String requires a Long.\");\n       }\n \n-    } else if (coll instanceof byte[]) {\n-      throw new WarpScriptException(getName() + \" expects the key to be an integer when operating on a byte array.\");\n-\n-    } else if (!(key instanceof List)) {\n-      throw new WarpScriptException(getName() + \" expects the key to be an integer or a list of integers when operating on a List.\");\n+      int idx = ((Long) key).intValue();\n+      int size = ((String) collection).length();\n+      idx = computeAndCheckIndex(idx, size);\n+      return String.valueOf(((String) collection).charAt(idx));\n \n-    } else {\n-      for (Object o: (List) key) {\n-        if (!(o instanceof Long)) {\n-          throw new WarpScriptException(getName() + \" expects the key to be an integer or a list of integers when operating on a List.\");\n-        }\n+    } else if (collection instanceof byte[]) {\n+      if (!(key instanceof Long)) {\n+        throw new WarpScriptException(\"Getting on bytes requires a Long.\");\n       }\n \n-      value = nestedGet((List) coll, (List<Long>) key);\n-    }\n-    \n-    stack.push(value);\n+      int idx = ((Long) key).intValue();\n+      int size = ((byte[]) collection).length;\n+      idx = computeAndCheckIndex(idx, size);\n+      return ((byte[]) collection)[idx] & 0xFFL;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6a1870ba10e63dd9d4ed76e87538d52c9d0198ef"}, "originalPosition": 130}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed62cf0c9d5218ca1e904db5f16f57180ba4b0a7", "author": {"user": {"login": "ftence", "name": "Fabien Tenc\u00e9"}}, "url": "https://github.com/senx/warp10-platform/commit/ed62cf0c9d5218ca1e904db5f16f57180ba4b0a7", "committedDate": "2020-09-28T13:04:01Z", "message": "Use WarpScript types in error messages."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18cf1dc00ec01dc39fa4b70d33bf33672867e203", "author": {"user": {"login": "ftence", "name": "Fabien Tenc\u00e9"}}, "url": "https://github.com/senx/warp10-platform/commit/18cf1dc00ec01dc39fa4b70d33bf33672867e203", "committedDate": "2020-12-09T15:57:05Z", "message": "Fix ambiguity of GETing on a Map with a List key."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTc2NzQ5MDg0", "url": "https://github.com/senx/warp10-platform/pull/854#pullrequestreview-576749084", "createdAt": "2021-01-26T20:49:50Z", "commit": {"oid": "18cf1dc00ec01dc39fa4b70d33bf33672867e203"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yNlQyMDo0OTo1MFrOIaqFQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yNlQyMDo1MTowOVrOIaqIQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDgyMzM2Mw==", "bodyText": "Fix Copyright notice ;-)", "url": "https://github.com/senx/warp10-platform/pull/854#discussion_r564823363", "createdAt": "2021-01-26T20:49:50Z", "author": {"login": "hbs"}, "path": "warp10/src/main/java/io/warp10/script/functions/GET.java", "diffHunk": "@@ -1,5 +1,5 @@\n //\n-//   Copyright 2018  SenX S.A.S.\n+//   Copyright 2018-2020  SenX S.A.S.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18cf1dc00ec01dc39fa4b70d33bf33672867e203"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDgyNDEzMA==", "bodyText": "an Object", "url": "https://github.com/senx/warp10-platform/pull/854#discussion_r564824130", "createdAt": "2021-01-26T20:51:09Z", "author": {"login": "hbs"}, "path": "warp10/src/main/java/io/warp10/script/functions/GET.java", "diffHunk": "@@ -17,74 +17,95 @@\n package io.warp10.script.functions;\n \n import io.warp10.script.NamedWarpScriptFunction;\n-import io.warp10.script.WarpScriptStackFunction;\n import io.warp10.script.WarpScriptException;\n import io.warp10.script.WarpScriptStack;\n+import io.warp10.script.WarpScriptStackFunction;\n \n import java.util.List;\n import java.util.Map;\n \n /**\n- * Extracts a value from a map, list, or byte array given a key.\n+ * Extracts a value from a map, list, a byte array or a String, given a key.\n  */\n public class GET extends NamedWarpScriptFunction implements WarpScriptStackFunction {\n-  \n+\n   public GET(String name) {\n     super(name);\n   }\n-  \n+\n   @Override\n   public Object apply(WarpScriptStack stack) throws WarpScriptException {\n     Object key = stack.pop();\n-    \n+\n     Object coll = stack.pop();\n \n-    if (!(coll instanceof Map) && !(coll instanceof List) && !(coll instanceof byte[])) {\n-      throw new WarpScriptException(getName() + \" operates on a map, list or byte array.\");\n-    }\n-    \n-    Object value = null;\n-    \n-    if (coll instanceof Map) {\n-      value = ((Map) coll).get(key);\n+    Object value;\n \n-    } else if (key instanceof Long) {\n-      int idx = ((Long) key).intValue();\n+    try {\n+      if (key instanceof List && coll instanceof List) {\n+        // The list is considered to be a kind of path. For instance [ 'a' 0 -1 ] GET is equivalent to 'a' GET 0 GET -1 GET.\n+        // We restrict that syntax only to top-level collections of type List because a Map can have list keys.\n+        // This top-level limitation allows a list of maps of strings to be addressed through this syntax.\n+        value = coll;\n+        for (Object keyElement: (List) key) {\n+          value = get(keyElement, value);\n+        }\n+      } else {\n+        value = get(key, coll);\n+      }\n+    } catch (WarpScriptException | IndexOutOfBoundsException e) {\n+      throw new WarpScriptException(getName() + \" failed.\", e);\n+    }\n \n-      if (coll instanceof List) {\n-        int size = ((List) coll).size();\n+    stack.push(value);\n \n-        idx = computeAndCheckIndex(idx, size);\n+    return stack;\n+  }\n \n-        value = ((List) coll).get(idx);\n+  /**\n+   * Get a value from a List, Map, byte[] or String using respectively a Long, Object, Long or Long key.\n+   * @param key Either on Object for a Map or a Long for List, byte[] or String. Negative indexing is possible, in that case the corresponding index is size + index.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18cf1dc00ec01dc39fa4b70d33bf33672867e203"}, "originalPosition": 77}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6f5cb6c5843211e0d90d49082685879f22fdb90", "author": {"user": {"login": "ftence", "name": "Fabien Tenc\u00e9"}}, "url": "https://github.com/senx/warp10-platform/commit/d6f5cb6c5843211e0d90d49082685879f22fdb90", "committedDate": "2021-01-27T13:33:38Z", "message": "Fix copyright and typo"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3232, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}