{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU4NTAwMDYy", "number": 802, "title": "Modify custom JSON serialization", "bodyText": "Current custom JSON serialization is not working and could be more practical.\n#798 proposed to expose Jackson API but it is preferable not to in case we want to change the JSON serialization/deserialization library.\nThis PR changes the current API to register custom serialization, making it simpler to use while not exposing Jackson.\nThe idea is to allow the registration of \"transformers\" whose role is to convert un-serializable objects to serializable ones. Typically they will create a Map corresponding to the fields of the Object.\nExample of use:\nJsonUtils.addTransformer(new JsonUtils.JsonTransformer() {\n      @Override\n      public TransformationResult transform(Object o) {\n        if (o instanceof CustomObject) {\n          HashMap<String, Object> coRepresentation = new HashMap<String, Object>();\n          coRepresentation.put(\"CustomObject\", ((CustomObject) o).children);\n          return new TransformationResult(true, coRepresentation);\n        } else {\n          return new TransformationResult(false, null);\n        }\n      }\n    });", "createdAt": "2020-07-29T15:05:05Z", "url": "https://github.com/senx/warp10-platform/pull/802", "merged": true, "mergeCommit": {"oid": "c815f1b19c014862826ca6539e898b5bf298cb56"}, "closed": true, "closedAt": "2020-08-05T12:48:59Z", "author": {"login": "ftence"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5sS_iAH2gAyNDU4NTAwMDYyOmU5ZDcxYWVjYmIxM2U3YjMxODI0ZDFjOWNlYTE1YzYyMmQ3YjRlZTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc76Hl4AH2gAyNDU4NTAwMDYyOmQ3ZjhjNjQ4ZmVjNzY1ZWUxOGJkNGQ3ZDRlOWRlNzNlMDdlY2M1Mzk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e9d71aecbb13e7b31824d1c9cea15c622d7b4ee6", "author": {"user": {"login": "ftence", "name": "Fabien Tenc\u00e9"}}, "url": "https://github.com/senx/warp10-platform/commit/e9d71aecbb13e7b31824d1c9cea15c622d7b4ee6", "committedDate": "2020-07-29T14:56:20Z", "message": "Modify custom serialization and code clean up"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5ODg0ODg5", "url": "https://github.com/senx/warp10-platform/pull/802#pullrequestreview-459884889", "createdAt": "2020-08-03T09:33:35Z", "commit": {"oid": "e9d71aecbb13e7b31824d1c9cea15c622d7b4ee6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QwOTozMzozNVrOG6yvgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QwOTozMzozNVrOG6yvgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDMwMTk1NQ==", "bodyText": "Shouldn't we leave the possibility to return JSON content too? Because the transformer may use an existing implementation of a serializer which will produce JSON. The validity of the returned JSON would be the responsability of the called entity as it was in the previous implementation.", "url": "https://github.com/senx/warp10-platform/pull/802#discussion_r464301955", "createdAt": "2020-08-03T09:33:35Z", "author": {"login": "hbs"}, "path": "warp10/src/main/java/io/warp10/json/JsonUtils.java", "diffHunk": "@@ -57,33 +52,35 @@ public void serialize(Object value, JsonGenerator gen, SerializerProvider serial\n   }\n \n   /**\n-   * Used to swap UnknownSerializer and BeanSerializer for CustomEncodersSerializer.\n+   * Used to swap UnknownSerializer and BeanSerializer for CustomSerializer.\n    */\n   public static class NotSerializedToCustomSerializedModifier extends BeanSerializerModifier {\n     @Override\n     public JsonSerializer<?> modifySerializer(SerializationConfig config, BeanDescription beanDesc, JsonSerializer<?> serializer) {\n       if (serializer instanceof UnknownSerializer || serializer instanceof BeanSerializer) {\n-        return customEncodersSerializer;\n+        return CUSTOM_SERIALIZER;\n       } else {\n         return serializer;\n       }\n     }\n   }\n \n-  public static class CustomEncodersSerializer extends JsonSerializer<Object> {\n+  /**\n+   * Handles custom serialization based on transformers.\n+   */\n+  public static class CustomSerializer extends JsonSerializer<Object> {\n     @Override\n     public void serialize(Object value, JsonGenerator gen, SerializerProvider serializers) throws IOException {\n-      if (null != encoders && !encoders.isEmpty()) {\n-        StringBuilder sb = new StringBuilder();\n-        boolean encoded = false;\n-        for (JsonEncoder encoder: encoders) {\n-          encoded = encoder.addElement(sb, value);\n-          if (encoded) {\n+      if (null != transformers && !transformers.isEmpty()) {\n+        JsonTransformer.TransformationResult transfRes = null;\n+        for (JsonTransformer transformer: transformers) {\n+          transfRes = transformer.transform(value);\n+          if (null != transfRes && transfRes.transformed) {\n             break;\n           }\n         }\n-        if (encoded) {\n-          gen.writeRaw(sb.toString());\n+        if (null != transfRes && transfRes.transformed) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9d71aecbb13e7b31824d1c9cea15c622d7b4ee6"}, "originalPosition": 54}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6835df3dc2909fb96adc75236ecaee559e56638d", "author": {"user": {"login": "ftence", "name": "Fabien Tenc\u00e9"}}, "url": "https://github.com/senx/warp10-platform/commit/6835df3dc2909fb96adc75236ecaee559e56638d", "committedDate": "2020-08-03T15:01:23Z", "message": "Add possibility for transformers to output raw JSON"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwOTM5OTUy", "url": "https://github.com/senx/warp10-platform/pull/802#pullrequestreview-460939952", "createdAt": "2020-08-04T15:44:17Z", "commit": {"oid": "6835df3dc2909fb96adc75236ecaee559e56638d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxNTo0NDoxOFrOG7mYSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxNTo0NDoxOFrOG7mYSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTE0Nzk3Nw==", "bodyText": "Add comments describing the meaning of those fields", "url": "https://github.com/senx/warp10-platform/pull/802#discussion_r465147977", "createdAt": "2020-08-04T15:44:18Z", "author": {"login": "hbs"}, "path": "warp10/src/main/java/io/warp10/json/JsonUtils.java", "diffHunk": "@@ -95,20 +96,41 @@ public void serialize(Object value, JsonGenerator gen, SerializerProvider serial\n     }\n   }\n \n-  public static final NullKeySerializer nullKeySerializer = new NullKeySerializer();\n-  public static final CustomEncodersSerializer customEncodersSerializer = new CustomEncodersSerializer();\n+  private static final NullKeySerializer NULL_KEY_SERIALIZER = new NullKeySerializer();\n+  private static final CustomSerializer CUSTOM_SERIALIZER = new CustomSerializer();\n \n   //\n   // ObjectMapper instances are thread-safe, so we can safely use a single static instance.\n   //\n-  private static final ObjectMapper strictMapper;\n-  private static final ObjectMapper looseMapper;\n+  private static final ObjectMapper STRICT_MAPPER;\n+  private static final ObjectMapper LOOSE_MAPPER;\n+\n+  public interface JsonTransformer {\n+    class TransformationResult {\n+      public final boolean transformed;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6835df3dc2909fb96adc75236ecaee559e56638d"}, "originalPosition": 82}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7f8c648fec765ee18bd4d7d4e9de73e07ecc539", "author": {"user": {"login": "ftence", "name": "Fabien Tenc\u00e9"}}, "url": "https://github.com/senx/warp10-platform/commit/d7f8c648fec765ee18bd4d7d4e9de73e07ecc539", "committedDate": "2020-08-05T12:10:24Z", "message": "Make fields private and add Javadoc"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3386, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}