{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAzMDgzOTk4", "number": 731, "title": "#Fixes 716 - Fixes edge cases of boundary fetch", "bodyText": "", "createdAt": "2020-04-14T09:54:18Z", "url": "https://github.com/senx/warp10-platform/pull/731", "merged": true, "mergeCommit": {"oid": "2d3ece5c4d4d93d5944253fafd2e7a5b75379b87"}, "closed": true, "closedAt": "2020-04-16T08:48:12Z", "author": {"login": "hbs"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcWCbfNgH2gAyNDAzMDgzOTk4OjYyYzQzODcwMjI4YTAwM2E5YmM0YjAwMmQ0YzFkZDhhZDI4ZGU1ZGM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcYIppuAFqTM5NDQyMTYyNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "62c43870228a003a9bc4b002d4c1dd8ad28de5dc", "author": {"user": {"login": "hbs", "name": "Mathias Herberts"}}, "url": "https://github.com/senx/warp10-platform/commit/62c43870228a003a9bc4b002d4c1dd8ad28de5dc", "committedDate": "2020-04-09T20:22:15Z", "message": "Fixes #716 - Modified exit checks. Converted boundary length to long."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78b03891096fbd1de6bd8cb915fda4dbe5ab4a34", "author": {"user": {"login": "hbs", "name": "Mathias Herberts"}}, "url": "https://github.com/senx/warp10-platform/commit/78b03891096fbd1de6bd8cb915fda4dbe5ab4a34", "committedDate": "2020-04-14T09:53:10Z", "message": "Merge branch 'master' of github.com:senx/warp10-platform into boundaries-fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyODk3MDMw", "url": "https://github.com/senx/warp10-platform/pull/731#pullrequestreview-392897030", "createdAt": "2020-04-14T12:54:31Z", "commit": {"oid": "78b03891096fbd1de6bd8cb915fda4dbe5ab4a34"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxMjo1NDozMVrOGFNOEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxMzoxOTowNVrOGFON_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODExMjY1Nw==", "bodyText": "There's also a nvalues > 0 line 348, should it be fixed too?", "url": "https://github.com/senx/warp10-platform/pull/731#discussion_r408112657", "createdAt": "2020-04-14T12:54:31Z", "author": {"login": "ftence"}, "path": "warp10/src/main/java/io/warp10/continuum/store/MultiScanGTSDecoderIterator.java", "diffHunk": "@@ -357,7 +357,7 @@ public GTSDecoder next() {\n       CellScanner cscanner = result.cellScanner();\n       \n       try {\n-        while(nvalues > 0 && cscanner.advance()) {\n+        while((nvalues > 0 || preBoundaryScan || postBoundaryScan) && cscanner.advance()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78b03891096fbd1de6bd8cb915fda4dbe5ab4a34"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODEyNjkzOA==", "bodyText": "Could be simplified by keeping GTSHelper.setValue(base, ts, location, elevation, value, false); here and adding\nif (countOnly && lastCount + dpcount >= count) {\n  break;\n}\n\nearlier in the loop or even in the while condition.", "url": "https://github.com/senx/warp10-platform/pull/731#discussion_r408126938", "createdAt": "2020-04-14T13:16:03Z", "author": {"login": "ftence"}, "path": "warp10/src/main/java/io/warp10/script/functions/FETCH.java", "diffHunk": "@@ -572,16 +556,35 @@ public Object apply(WarpScriptStack stack) throws WarpScriptException {\n                   base.setMetadata(decoderMeta);\n                   \n                   // Force type attribute\n-                  base.getMetadata().putToAttributes(typelabel, typename);\n+                  base.getMetadata().putToAttributes(typeattr, typename);\n                   if (null != uuid) {\n                     base.getMetadata().putToAttributes(Constants.UUID_ATTRIBUTE, uuid.toString());\n                   }\n                 }\n-                \n-                GTSHelper.setValue(base, ts, location, elevation, value, false);                \n+\n+                //\n+                // When using HBase, fetch requests which do not have boundaries may be served\n+                // using a custom filter. This filter may return more data for a GTS than the requested\n+                // count if the GTS spans multiple regions because the filtering is performed on the Region Servers\n+                // and in this specific case the request will be forwarded to all RS serving regions for a given GTS.\n+                // It is therefore necessary to keep track of how many datapoints were already fetched and\n+                // shrink the GTS so we do not return too many.\n+                //\n+\n+                if (countOnly) {\n+                  if (lastCount + dpcount < count) {\n+                    GTSHelper.setValue(base, ts, location, elevation, value, false);                \n+                  } else {\n+                    // We are done, exit\n+                    break;\n+                  }\n+                } else {\n+                  // Consider all points returned by the underlying system\n+                  GTSHelper.setValue(base, ts, location, elevation, value, false);                \n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78b03891096fbd1de6bd8cb915fda4dbe5ab4a34"}, "originalPosition": 140}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODEyOTAyMQ==", "bodyText": "Use countOnly.", "url": "https://github.com/senx/warp10-platform/pull/731#discussion_r408129021", "createdAt": "2020-04-14T13:19:05Z", "author": {"login": "ftence"}, "path": "warp10/src/main/java/io/warp10/script/functions/FETCH.java", "diffHunk": "@@ -610,27 +613,20 @@ public Object apply(WarpScriptStack stack) throws WarpScriptException {\n               }\n               lastType = gts.getType();\n             }\n-        \n-            if (null == base && count >= 0 && postBoundary > 0) {\n-              // This is the first GTS, so we need to count the size of the post boundary\n-              // so we get a correct estimate of the number of datapoints we fetched\n-              for (int i = 0; i < GTSHelper.nvalues(gts); i++) {\n-                if (GTSHelper.tickAtIndex(gts, i) > end) {\n-                  boundary++;\n-                } else {\n-                  // We can exit as soon as we find a timestamp <= end\n-                  break;                  \n-                }\n-              }\n-            }\n+\n+            //\n+            // When using HBase, fetch requests which do not have boundaries may be served\n+            // using a custom filter. This filter may return more data for a GTS than the requested\n+            // count if the GTS spans multiple regions because the filtering is performed on the Region Servers\n+            // and in this specific case the request will be forwarded to all RS serving regions for a given GTS.\n+            // It is therefore necessary to keep track of how many datapoints were already fetched and\n+            // shrink the GTS so we do not return too many.\n+            //\n             \n-            if (count >= 0 && lastCount + GTSHelper.nvalues(gts) - boundary > count) {\n-              // We would add too many datapoints, we will shrink the GTS.\n-              // As it it sorted in reverse order of the ticks (since the datapoints are organized\n-              // this way in HBase), we just need to shrink the GTS.\n-              gts = GTSHelper.shrinkTo(gts, (int) Math.max(count - lastCount + boundary, 0));\n+            if (count >= 0 && 0 == postBoundary && 0 == preBoundary && lastCount + GTSHelper.nvalues(gts) > count) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78b03891096fbd1de6bd8cb915fda4dbe5ab4a34"}, "originalPosition": 180}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "065973c88bb24c7b424d46ca409b521978e9c37b", "author": {"user": {"login": "hbs", "name": "Mathias Herberts"}}, "url": "https://github.com/senx/warp10-platform/commit/065973c88bb24c7b424d46ca409b521978e9c37b", "committedDate": "2020-04-14T15:03:17Z", "message": "Addressed PR comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0NDIxNjI0", "url": "https://github.com/senx/warp10-platform/pull/731#pullrequestreview-394421624", "createdAt": "2020-04-16T08:45:00Z", "commit": {"oid": "065973c88bb24c7b424d46ca409b521978e9c37b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3318, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}