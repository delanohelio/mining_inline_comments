{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI4MjY4NzIz", "number": 879, "title": "Support dumping file based tokens when custom keys are not in use", "bodyText": "", "createdAt": "2020-11-26T21:15:05Z", "url": "https://github.com/senx/warp10-platform/pull/879", "merged": true, "mergeCommit": {"oid": "31edb6fba0e9382bbc670b7a35a181039b2d694a"}, "closed": true, "closedAt": "2020-12-02T15:36:07Z", "author": {"login": "hbs"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdgZoEKAH2gAyNTI4MjY4NzIzOmUzNjE2ZDZhYjk5ODIxYzFhN2Y0NjRlMDY0ZDMyYzU5ZTRjN2Y2YjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdiQYVJgH2gAyNTI4MjY4NzIzOjQ3MjNiZDRmOTJlYzhjNzQ4NmNjYmVmOGQyODE1OGQyZWE2MTUzM2Y=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e3616d6ab99821c1a7f464e064d32c59e4c7f6b3", "author": {"user": {"login": "hbs", "name": "Mathias Herberts"}}, "url": "https://github.com/senx/warp10-platform/commit/e3616d6ab99821c1a7f464e064d32c59e4c7f6b3", "committedDate": "2020-11-26T21:14:12Z", "message": "Modified token decoding when custom keys are not used so file based tokens can be correctly dumped"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwMDY0NzI1", "url": "https://github.com/senx/warp10-platform/pull/879#pullrequestreview-540064725", "createdAt": "2020-11-27T15:41:46Z", "commit": {"oid": "e3616d6ab99821c1a7f464e064d32c59e4c7f6b3"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QxNTo0MTo0NlrOH7CdkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QxNTo1NTo1OVrOH7C37A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTY2ODM2OA==", "bodyText": "Thus customKeys == multikey. You could replace every use of customKeys by multikey.", "url": "https://github.com/senx/warp10-platform/pull/879#discussion_r531668368", "createdAt": "2020-11-27T15:41:46Z", "author": {"login": "ftence"}, "path": "warp10/src/main/java/io/warp10/script/ext/token/TOKENDUMP.java", "diffHunk": "@@ -102,6 +104,7 @@ public Object apply(WarpScriptStack stack) throws WarpScriptException {\n \n       AESKey = (byte[]) top;\n \n+      customKeys = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e3616d6ab99821c1a7f464e064d32c59e4c7f6b3"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTY2ODQ4Ng==", "bodyText": "Update copyright notice.", "url": "https://github.com/senx/warp10-platform/pull/879#discussion_r531668486", "createdAt": "2020-11-27T15:42:00Z", "author": {"login": "ftence"}, "path": "warp10/src/main/java/io/warp10/script/ext/token/TOKENDUMP.java", "diffHunk": "@@ -85,6 +85,8 @@ public Object apply(WarpScriptStack stack) throws WarpScriptException {\n \n     Object top = null;\n \n+    boolean customKeys = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e3616d6ab99821c1a7f464e064d32c59e4c7f6b3"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTY3NTExNg==", "bodyText": "In case customKeys and thus multikey, decoder is always null so you can replace this block with\nlong[] lkey = SipHashInline.getKey(SipHashKey);\nQuasarTokenDecoder dec = new QuasarTokenDecoder(lkey[0], lkey[1], AESKey);", "url": "https://github.com/senx/warp10-platform/pull/879#discussion_r531675116", "createdAt": "2020-11-27T15:55:59Z", "author": {"login": "ftence"}, "path": "warp10/src/main/java/io/warp10/script/ext/token/TOKENDUMP.java", "diffHunk": "@@ -131,22 +134,34 @@ public Object apply(WarpScriptStack stack) throws WarpScriptException {\n     ReadToken rtoken = null;\n     WriteToken wtoken = null;\n \n-    byte[] token = OrderPreservingBase64.decode(tokenstr.getBytes(StandardCharsets.UTF_8));\n+    if (!customKeys) {\n+      try {\n+        rtoken = Tokens.extractReadToken(tokenstr);\n+      } catch (WarpScriptException wse) {\n+        try {\n+          wtoken = Tokens.extractWriteToken(tokenstr);\n+        } catch (Exception e) {\n+          throw new WarpScriptException(getName() + \" invalid token.\", e);\n+        }\n+      }\n+    } else {\n+      byte[] token = OrderPreservingBase64.decode(tokenstr.getBytes(StandardCharsets.UTF_8));\n \n-    QuasarTokenDecoder dec = decoder;\n+      QuasarTokenDecoder dec = decoder;\n \n-    if (null == dec) {\n-      long[] lkey = SipHashInline.getKey(SipHashKey);\n-      dec = new QuasarTokenDecoder(lkey[0], lkey[1], AESKey);\n-    }\n+      if (null == dec) {\n+        long[] lkey = SipHashInline.getKey(SipHashKey);\n+        dec = new QuasarTokenDecoder(lkey[0], lkey[1], AESKey);\n+      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e3616d6ab99821c1a7f464e064d32c59e4c7f6b3"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "994f9ec811a2b6a42dfceabb8f945bce081a9d17", "author": {"user": {"login": "hbs", "name": "Mathias Herberts"}}, "url": "https://github.com/senx/warp10-platform/commit/994f9ec811a2b6a42dfceabb8f945bce081a9d17", "committedDate": "2020-11-27T21:27:23Z", "message": "Addressed PR comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06f05f142ceb3936eac61f64ccab06a9c2f556f7", "author": {"user": {"login": "ftence", "name": "Fabien Tenc\u00e9"}}, "url": "https://github.com/senx/warp10-platform/commit/06f05f142ceb3936eac61f64ccab06a9c2f556f7", "committedDate": "2020-12-02T15:04:37Z", "message": "Removed unused decoder"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4723bd4f92ec8c7486ccbef8d28158d2ea61533f", "author": {"user": {"login": "hbs", "name": "Mathias Herberts"}}, "url": "https://github.com/senx/warp10-platform/commit/4723bd4f92ec8c7486ccbef8d28158d2ea61533f", "committedDate": "2020-12-02T15:35:43Z", "message": "Merge pull request #9 from ftence/tokendump.files.nodecoder\n\nRemoved unused decoder"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3268, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}