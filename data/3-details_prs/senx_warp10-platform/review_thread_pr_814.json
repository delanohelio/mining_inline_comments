{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYzNDYzODEw", "number": 814, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxNTo0MzoxMVrOEVeFFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQwNzoyNTozOFrOEeMTtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwOTQ4MzcyOnYy", "diffSide": "RIGHT", "path": "crypto/src/main/java/io/warp10/crypto/KeyStore.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxNTo0MzoxMVrOG8PiMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxNTo0MzoxMVrOG8PiMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTgyMjI1Nw==", "bodyText": "bit -> bits", "url": "https://github.com/senx/warp10-platform/pull/814#discussion_r465822257", "createdAt": "2020-08-05T15:43:11Z", "author": {"login": "hbs"}, "path": "crypto/src/main/java/io/warp10/crypto/KeyStore.java", "diffHunk": "@@ -220,4 +224,65 @@\n    * Forget.\n    */\n   public void forget();\n+\n+\n+\n+  /**\n+   * Get a key from the configuration, add, if it exists and if the number of bits of the key is in the given values,\n+   * add it to the key store.\n+   * @param keystore The KeyStore to add the key to.\n+   * @param keyname The key name under which to add the key in the key store.\n+   * @param props The properties from which to get the key.\n+   * @param configurationKey The configuration key holding the key value.\n+   * @param sizeInBits The valid number of bits of the key. Typically 128 or 128, 192, 256.\n+   * @return The key.\n+   */\n+  public static byte[] checkAndSetKey(KeyStore keystore, String keystoreKey, Properties props, String configurationKey, int... sizeInBits) {\n+    return checkAndSetKey(keystore, keystoreKey, props, configurationKey, null, sizeInBits);\n+  }\n+\n+  /**\n+   * Get a key from the configuration, add, if it exists or has a non-null default and if the number of bits of the key\n+   * is in the given values, add it to the key store.\n+   * @param keystore The KeyStore to add the key to.\n+   * @param keyname The key name under which to add the key in the key store.\n+   * @param props The properties from which to get the key.\n+   * @param configurationKey The configuration key holding the key value.\n+   * @param defaultKeyValue The default key in case it is not found in the properties.\n+   * @param sizeInBits The valid number of bits of the key. Typically 128 or 128, 192, 256.\n+   * @return The key.\n+   */\n+  public static byte[] checkAndSetKey(KeyStore keystore, String keyname, Properties props, String configurationKey, String defaultKeyValue, int... sizeInBits) {\n+    String keyspec = props.getProperty(configurationKey, defaultKeyValue);\n+\n+    if (null != keyspec) {\n+      byte[] key = keystore.decodeKey(keyspec);\n+\n+      // Check the size of the key\n+      StringBuilder sizesStr = new StringBuilder();\n+      boolean correctSize = false;\n+      for (int sizeIndex = 0; sizeIndex < sizeInBits.length; sizeIndex++) {\n+        if (sizeInBits[sizeIndex] == key.length * 8) {\n+          correctSize = true;\n+          break;\n+        }\n+\n+        if (sizeIndex > 0) {\n+          if (sizeIndex == sizeInBits.length - 1) {\n+            sizesStr.append(\" or \");\n+          } else {\n+            sizesStr.append(\", \");\n+          }\n+        }\n+        sizesStr.append(sizeInBits[sizeIndex]);\n+      }\n+      Preconditions.checkArgument(correctSize, \"Key %s MUST be %s bit long.\", configurationKey, sizesStr);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5296a5ec9f9f893385461419a662bce8c3c35a48"}, "originalPosition": 74}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxNzY0NDAxOnYy", "diffSide": "RIGHT", "path": "crypto/src/main/java/io/warp10/crypto/KeyStore.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxNDo1ODo1NFrOG9dNSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxNDo1ODo1NFrOG9dNSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzA5NDg1Nw==", "bodyText": "extraneous add", "url": "https://github.com/senx/warp10-platform/pull/814#discussion_r467094857", "createdAt": "2020-08-07T14:58:54Z", "author": {"login": "hbs"}, "path": "crypto/src/main/java/io/warp10/crypto/KeyStore.java", "diffHunk": "@@ -220,4 +224,65 @@\n    * Forget.\n    */\n   public void forget();\n+\n+\n+\n+  /**\n+   * Get a key from the configuration, add, if it exists and if the number of bits of the key is in the given values,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5296a5ec9f9f893385461419a662bce8c3c35a48"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxNzY0NTIxOnYy", "diffSide": "RIGHT", "path": "crypto/src/main/java/io/warp10/crypto/KeyStore.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxNDo1OToxNFrOG9dOAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxNDo1OToxNFrOG9dOAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzA5NTA0Mw==", "bodyText": "keystore", "url": "https://github.com/senx/warp10-platform/pull/814#discussion_r467095043", "createdAt": "2020-08-07T14:59:14Z", "author": {"login": "hbs"}, "path": "crypto/src/main/java/io/warp10/crypto/KeyStore.java", "diffHunk": "@@ -220,4 +224,65 @@\n    * Forget.\n    */\n   public void forget();\n+\n+\n+\n+  /**\n+   * Get a key from the configuration, add, if it exists and if the number of bits of the key is in the given values,\n+   * add it to the key store.\n+   * @param keystore The KeyStore to add the key to.\n+   * @param keyname The key name under which to add the key in the key store.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5296a5ec9f9f893385461419a662bce8c3c35a48"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxNzY0ODY0OnYy", "diffSide": "RIGHT", "path": "crypto/src/main/java/io/warp10/crypto/KeyStore.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxNTowMDowNlrOG9dQIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxNTowMDowNlrOG9dQIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzA5NTU4NA==", "bodyText": "extraneous add", "url": "https://github.com/senx/warp10-platform/pull/814#discussion_r467095584", "createdAt": "2020-08-07T15:00:06Z", "author": {"login": "hbs"}, "path": "crypto/src/main/java/io/warp10/crypto/KeyStore.java", "diffHunk": "@@ -220,4 +224,65 @@\n    * Forget.\n    */\n   public void forget();\n+\n+\n+\n+  /**\n+   * Get a key from the configuration, add, if it exists and if the number of bits of the key is in the given values,\n+   * add it to the key store.\n+   * @param keystore The KeyStore to add the key to.\n+   * @param keyname The key name under which to add the key in the key store.\n+   * @param props The properties from which to get the key.\n+   * @param configurationKey The configuration key holding the key value.\n+   * @param sizeInBits The valid number of bits of the key. Typically 128 or 128, 192, 256.\n+   * @return The key.\n+   */\n+  public static byte[] checkAndSetKey(KeyStore keystore, String keystoreKey, Properties props, String configurationKey, int... sizeInBits) {\n+    return checkAndSetKey(keystore, keystoreKey, props, configurationKey, null, sizeInBits);\n+  }\n+\n+  /**\n+   * Get a key from the configuration, add, if it exists or has a non-null default and if the number of bits of the key", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5296a5ec9f9f893385461419a662bce8c3c35a48"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwMDk0MzkwOnYy", "diffSide": "RIGHT", "path": "warp10/src/main/java/io/warp10/WarpDist.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQwNzoyNTozOFrOHJtiMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxMTo1OToyN1rOHJ15Rw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTk0NTI2Ng==", "bodyText": "Incorrect parameters.", "url": "https://github.com/senx/warp10-platform/pull/814#discussion_r479945266", "createdAt": "2020-08-31T07:25:38Z", "author": {"login": "hbs"}, "path": "warp10/src/main/java/io/warp10/WarpDist.java", "diffHunk": "@@ -345,4 +307,19 @@ public static boolean isEgress() {\n   public static void setEgress(boolean egress) {\n     hasEgress = egress;\n   }\n+\n+  public static void extractKeys(KeyStore keystore, Properties properties) {\n+    KeyStore.checkAndSetKey(keystore, KeyStore.SIPHASH_CLASS, properties, Configuration.WARP_HASH_CLASS, 128);\n+    KeyStore.checkAndSetKey(keystore, KeyStore.SIPHASH_LABELS, properties, Configuration.WARP_HASH_LABELS, 128);\n+    KeyStore.checkAndSetKey(keystore, KeyStore.SIPHASH_TOKEN, properties, Configuration.WARP_HASH_TOKEN, 128);\n+    KeyStore.checkAndSetKey(keystore, KeyStore.SIPHASH_APPID, properties, Configuration.WARP_HASH_APP, 128);\n+    KeyStore.checkAndSetKey(keystore, KeyStore.AES_TOKEN, properties, Configuration.WARP_AES_TOKEN, 128, 192, 256);\n+    KeyStore.checkAndSetKey(keystore, KeyStore.AES_SECURESCRIPTS, properties, Configuration.WARP_AES_SCRIPTS, 128, 192, 256);\n+    KeyStore.checkAndSetKey(keystore, KeyStore.AES_METASETS, properties, Configuration.WARP_AES_METASETS, 128, 192, 256);\n+    KeyStore.checkAndSetKey(keystore, KeyStore.SIPHASH_CLASS, properties, Configuration.WARP_HASH_CLASS, Configuration.WARP_DEFAULT_AES_LOGGING, 128, 192, 256);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5296a5ec9f9f893385461419a662bce8c3c35a48"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDA4MjI0Nw==", "bodyText": "Nice catch. I went again through the changes and it's now highly unlikely that there is another error of this kind.", "url": "https://github.com/senx/warp10-platform/pull/814#discussion_r480082247", "createdAt": "2020-08-31T11:59:27Z", "author": {"login": "ftence"}, "path": "warp10/src/main/java/io/warp10/WarpDist.java", "diffHunk": "@@ -345,4 +307,19 @@ public static boolean isEgress() {\n   public static void setEgress(boolean egress) {\n     hasEgress = egress;\n   }\n+\n+  public static void extractKeys(KeyStore keystore, Properties properties) {\n+    KeyStore.checkAndSetKey(keystore, KeyStore.SIPHASH_CLASS, properties, Configuration.WARP_HASH_CLASS, 128);\n+    KeyStore.checkAndSetKey(keystore, KeyStore.SIPHASH_LABELS, properties, Configuration.WARP_HASH_LABELS, 128);\n+    KeyStore.checkAndSetKey(keystore, KeyStore.SIPHASH_TOKEN, properties, Configuration.WARP_HASH_TOKEN, 128);\n+    KeyStore.checkAndSetKey(keystore, KeyStore.SIPHASH_APPID, properties, Configuration.WARP_HASH_APP, 128);\n+    KeyStore.checkAndSetKey(keystore, KeyStore.AES_TOKEN, properties, Configuration.WARP_AES_TOKEN, 128, 192, 256);\n+    KeyStore.checkAndSetKey(keystore, KeyStore.AES_SECURESCRIPTS, properties, Configuration.WARP_AES_SCRIPTS, 128, 192, 256);\n+    KeyStore.checkAndSetKey(keystore, KeyStore.AES_METASETS, properties, Configuration.WARP_AES_METASETS, 128, 192, 256);\n+    KeyStore.checkAndSetKey(keystore, KeyStore.SIPHASH_CLASS, properties, Configuration.WARP_HASH_CLASS, Configuration.WARP_DEFAULT_AES_LOGGING, 128, 192, 256);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTk0NTI2Ng=="}, "originalCommit": {"oid": "5296a5ec9f9f893385461419a662bce8c3c35a48"}, "originalPosition": 72}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1147, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}