{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYwMTc2NDQ4", "number": 810, "title": "Add optimization to ASREGS", "bodyText": "Replaces STORE on lists containing only register numbers by POPRs", "createdAt": "2020-07-31T14:03:45Z", "url": "https://github.com/senx/warp10-platform/pull/810", "merged": true, "mergeCommit": {"oid": "64416c1584b53788a91a6c5a8df1124d801a5959"}, "closed": true, "closedAt": "2020-08-04T14:15:15Z", "author": {"login": "ftence"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc6UuwuAH2gAyNDYwMTc2NDQ4OjE5MDhkZWY0OTE5MTMxYzQxY2I0ZWYzODU1ZThmZTllM2NhNWYyNGI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7l2NpgH2gAyNDYwMTc2NDQ4OjM2MGZlMjMyNzc3Y2Q5M2VhMzcyZmEyYjBhYjY5ZjVkNTI4NDgxNmI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1908def4919131c41cb4ef3855e8fe9e3ca5f24b", "author": {"user": {"login": "ftence", "name": "Fabien Tenc\u00e9"}}, "url": "https://github.com/senx/warp10-platform/commit/1908def4919131c41cb4ef3855e8fe9e3ca5f24b", "committedDate": "2020-07-31T14:02:52Z", "message": "Add optimization to ASREGS so it replaces STORE on lists containing only register numbers by POPRs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwMTA3MTcx", "url": "https://github.com/senx/warp10-platform/pull/810#pullrequestreview-460107171", "createdAt": "2020-08-03T15:08:41Z", "commit": {"oid": "1908def4919131c41cb4ef3855e8fe9e3ca5f24b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxNTowODo0MVrOG69W0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxNTowODo0MVrOG69W0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDQ3NTg1OA==", "bodyText": "What happens if you initially had 1 2 3 [ 1 2 2 ] STORE? It seems that register 2 will end up with value 2 instead of 3.", "url": "https://github.com/senx/warp10-platform/pull/810#discussion_r464475858", "createdAt": "2020-08-03T15:08:41Z", "author": {"login": "hbs"}, "path": "warp10/src/main/java/io/warp10/script/functions/ASREGS.java", "diffHunk": "@@ -242,16 +242,40 @@ public Object apply(WarpScriptStack stack) throws WarpScriptException {\n             }\n           } else if (symbol instanceof ENDLIST) {\n             int idx = i - 2;\n+            int nbOfReg = 0; // Keeps track of the number of registers in this list\n             while (idx >= 0 && !(statements.get(idx) instanceof MARK)) {\n               Object stmt = statements.get(idx);\n               if (stmt instanceof String) {\n                 Integer regno = varregs.get(stmt);\n                 if (null != regno) {\n                   statements.set(idx, (long) regno);\n+                  nbOfReg++;\n                 }\n+              } else if (stmt instanceof Long) {\n+                nbOfReg++;\n               }\n               idx--;\n-            }            \n+            }\n+\n+            // Further optimization: if the list contains only registers, replace by POPRs which is much faster.\n+            // For instance, replace [ 3 7 9 ] STORE by NOOP POPR9 POPR7 POPR3 NOOP NOOP.\n+            int listLength = i - idx - 2;\n+            if (nbOfReg == listLength) {\n+              statements.set(idx, NOOP); // replace MARK\n+              statements.set(i - 1, NOOP); // replace ENDLIST\n+              statements.set(i, NOOP); // replace STORE\n+\n+              // As we must flip the order of the list, we must store the registers first.\n+              int[] regInList = new int[listLength];\n+              for (int listIndex = 0; listIndex < listLength; listIndex++) {\n+                regInList[listIndex] = ((Long) statements.get(idx + 1 + listIndex)).intValue();\n+              }\n+\n+              // Replace register number by POPRs. Be careful, we flip the list order!", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1908def4919131c41cb4ef3855e8fe9e3ca5f24b"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd0961c7d3389d6ab21756ae9474a1ac8e8b3620", "author": {"user": {"login": "ftence", "name": "Fabien Tenc\u00e9"}}, "url": "https://github.com/senx/warp10-platform/commit/bd0961c7d3389d6ab21756ae9474a1ac8e8b3620", "committedDate": "2020-08-04T10:18:59Z", "message": "Fix STORE on a list with duplicate symbols"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "53c3ef8fc9de140388ba455eb0e2305b821525fd", "author": {"user": {"login": "ftence", "name": "Fabien Tenc\u00e9"}}, "url": "https://github.com/senx/warp10-platform/commit/53c3ef8fc9de140388ba455eb0e2305b821525fd", "committedDate": "2020-08-04T10:21:13Z", "message": "More optimizations for ASREGS to convert STORE/CSTORE/LOAD on LONG to equivalent register function"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwNjkxNDc3", "url": "https://github.com/senx/warp10-platform/pull/810#pullrequestreview-460691477", "createdAt": "2020-08-04T10:31:29Z", "commit": {"oid": "53c3ef8fc9de140388ba455eb0e2305b821525fd"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxMDozMToyOVrOG7ao-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxMDozNDoyMlrOG7audw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk1NTY0MQ==", "bodyText": "Use get(n) in the loop then a dropn instead of calling popn which will allocate a new array.", "url": "https://github.com/senx/warp10-platform/pull/810#discussion_r464955641", "createdAt": "2020-08-04T10:31:29Z", "author": {"login": "hbs"}, "path": "warp10/src/main/java/io/warp10/script/functions/STORE.java", "diffHunk": "@@ -56,19 +56,22 @@ public Object apply(WarpScriptStack stack) throws WarpScriptException {\n     }\n     \n     if (count > 0) {\n-      for (int i = count - 1; i >= 0; i--) {\n+      Object[] objectsToStore = stack.popn(count);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53c3ef8fc9de140388ba455eb0e2305b821525fd"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk1NzA0Nw==", "bodyText": "Use a static set of maps instead of per call maps.", "url": "https://github.com/senx/warp10-platform/pull/810#discussion_r464957047", "createdAt": "2020-08-04T10:34:22Z", "author": {"login": "hbs"}, "path": "warp10/src/main/java/io/warp10/script/functions/ASREGS.java", "diffHunk": "@@ -177,22 +175,16 @@ public Object apply(WarpScriptStack stack) throws WarpScriptException {\n       }\n       \n       if (null == varregs.get(v.toString())) {\n-        regidx = inuse.nextClearBit(0);\n+        int regidx = inuse.nextClearBit(0);\n         inuse.set(regidx);\n         varregs.put(v.toString(), regidx);\n       }\n-    }    \n+    }\n \n-    numregs = regidx + 1;\n+    HashMap<Integer, PUSHR> PUSHRs = new HashMap<Integer, PUSHR>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53c3ef8fc9de140388ba455eb0e2305b821525fd"}, "originalPosition": 54}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b58a7721384657b0aeb276491a2c45e3de55e7cd", "author": {"user": {"login": "ftence", "name": "Fabien Tenc\u00e9"}}, "url": "https://github.com/senx/warp10-platform/commit/b58a7721384657b0aeb276491a2c45e3de55e7cd", "committedDate": "2020-08-04T12:28:58Z", "message": "Use get and dropn instead of popn"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "360fe232777cd93ea372fa2b0ab69f5d5284816b", "author": {"user": {"login": "ftence", "name": "Fabien Tenc\u00e9"}}, "url": "https://github.com/senx/warp10-platform/commit/360fe232777cd93ea372fa2b0ab69f5d5284816b", "committedDate": "2020-08-04T12:33:19Z", "message": "Use static instance for DROP and register functions, fix CPOPR, comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3187, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}