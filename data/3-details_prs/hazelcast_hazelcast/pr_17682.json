{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk3Nzg2ODY5", "number": 17682, "title": "Check duplicate fields when building class definition", "bodyText": "ClassDefinitionBuider.addX methods checks if a field\nis already added with same name and\nthrows HazelcastSerializatioException if already added.\nfixes #17616", "createdAt": "2020-10-05T11:30:26Z", "url": "https://github.com/hazelcast/hazelcast/pull/17682", "merged": true, "mergeCommit": {"oid": "aae4197d80adb21840e88d921f2f600565b73e9d"}, "closed": true, "closedAt": "2020-10-07T06:08:03Z", "author": {"login": "sancar"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdPi7tAgFqTUwMjAwMjA4NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdP5BuFAH2gAyNDk3Nzg2ODY5OjgwODZlNGFmMDEzOGY0YmNkZjg1MzhhMzZmMGE2NWE4NTM2ZGJhNjk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyMDAyMDg0", "url": "https://github.com/hazelcast/hazelcast/pull/17682#pullrequestreview-502002084", "createdAt": "2020-10-05T12:26:36Z", "commit": {"oid": "344a0b0df7ca238bb43afd5e5bf516ec4371c1c7"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxMjoyNjozNlrOHcar4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxMjoyNjozNlrOHcar4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTU1OTM5Mw==", "bodyText": "A style comment:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (addedFieldNames.contains(fieldName)) {\n          \n          \n            \n                        throw new HazelcastSerializationException(\"Field with field name : \" + fieldName + \" already exists\");\n          \n          \n            \n                    }\n          \n          \n            \n                    addedFieldNames.add(fieldName);\n          \n          \n            \n                    if (!addedFieldNames.add(fieldName)) {\n          \n          \n            \n                        throw new HazelcastSerializationException(\"Field with field name : \" + fieldName + \" already exists\");\n          \n          \n            \n                    }", "url": "https://github.com/hazelcast/hazelcast/pull/17682#discussion_r499559393", "createdAt": "2020-10-05T12:26:36Z", "author": {"login": "viliam-durina"}, "path": "hazelcast/src/main/java/com/hazelcast/nio/serialization/ClassDefinitionBuilder.java", "diffHunk": "@@ -213,7 +341,11 @@ public ClassDefinition build() {\n         return cd;\n     }\n \n-    private void check() {\n+    private void check(String fieldName) {\n+        if (addedFieldNames.contains(fieldName)) {\n+            throw new HazelcastSerializationException(\"Field with field name : \" + fieldName + \" already exists\");\n+        }\n+        addedFieldNames.add(fieldName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "344a0b0df7ca238bb43afd5e5bf516ec4371c1c7"}, "originalPosition": 324}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e126e5064164a5bace665b26ed0967948bb6ee3", "author": {"user": {"login": "sancar", "name": "sancar"}}, "url": "https://github.com/hazelcast/hazelcast/commit/1e126e5064164a5bace665b26ed0967948bb6ee3", "committedDate": "2020-10-05T12:32:11Z", "message": "Check duplicate fields when building class definition\n\nClassDefinitionBuider.addX methods checks if a field\nis already added with same name and\nthrows HazelcastSerializatioException if already added.\n\nfixes https://github.com/hazelcast/hazelcast/issues/17616"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "344a0b0df7ca238bb43afd5e5bf516ec4371c1c7", "author": {"user": {"login": "sancar", "name": "sancar"}}, "url": "https://github.com/hazelcast/hazelcast/commit/344a0b0df7ca238bb43afd5e5bf516ec4371c1c7", "committedDate": "2020-10-05T11:28:21Z", "message": "Check duplicate fields when building class definition\n\nClassDefinitionBuider.addX methods checks if a field\nis already added with same name and\nthrows HazelcastSerializatioException if already added.\n\nfixes https://github.com/hazelcast/hazelcast/issues/17616"}, "afterCommit": {"oid": "1e126e5064164a5bace665b26ed0967948bb6ee3", "author": {"user": {"login": "sancar", "name": "sancar"}}, "url": "https://github.com/hazelcast/hazelcast/commit/1e126e5064164a5bace665b26ed0967948bb6ee3", "committedDate": "2020-10-05T12:32:11Z", "message": "Check duplicate fields when building class definition\n\nClassDefinitionBuider.addX methods checks if a field\nis already added with same name and\nthrows HazelcastSerializatioException if already added.\n\nfixes https://github.com/hazelcast/hazelcast/issues/17616"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyMDE0NTg5", "url": "https://github.com/hazelcast/hazelcast/pull/17682#pullrequestreview-502014589", "createdAt": "2020-10-05T12:42:27Z", "commit": {"oid": "1e126e5064164a5bace665b26ed0967948bb6ee3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxMjo0MjoyN1rOHcbPtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxMjo0MjoyN1rOHcbPtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTU2ODU2NQ==", "bodyText": "HazelcastSerializationException isn't correct IMO. It should be thrown \"when a problem occurs while serializing/deserializing objects\". This should rather be IllegalStateException.\nBut it's consistent with the same issue 3 lines below...", "url": "https://github.com/hazelcast/hazelcast/pull/17682#discussion_r499568565", "createdAt": "2020-10-05T12:42:27Z", "author": {"login": "viliam-durina"}, "path": "hazelcast/src/main/java/com/hazelcast/nio/serialization/ClassDefinitionBuilder.java", "diffHunk": "@@ -213,7 +341,10 @@ public ClassDefinition build() {\n         return cd;\n     }\n \n-    private void check() {\n+    private void check(String fieldName) {\n+        if (!addedFieldNames.add(fieldName)) {\n+            throw new HazelcastSerializationException(\"Field with field name : \" + fieldName + \" already exists\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e126e5064164a5bace665b26ed0967948bb6ee3"}, "originalPosition": 322}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b8d43b7633c7441a129c90553973abacf4a54e8", "author": {"user": {"login": "sancar", "name": "sancar"}}, "url": "https://github.com/hazelcast/hazelcast/commit/7b8d43b7633c7441a129c90553973abacf4a54e8", "committedDate": "2020-10-06T08:22:50Z", "message": "address review comments. Javadoc and test update."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyOTgyNzAw", "url": "https://github.com/hazelcast/hazelcast/pull/17682#pullrequestreview-502982700", "createdAt": "2020-10-06T13:48:42Z", "commit": {"oid": "7b8d43b7633c7441a129c90553973abacf4a54e8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyOTg3MDM2", "url": "https://github.com/hazelcast/hazelcast/pull/17682#pullrequestreview-502987036", "createdAt": "2020-10-06T13:52:50Z", "commit": {"oid": "7b8d43b7633c7441a129c90553973abacf4a54e8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxMzo1Mjo1MVrOHdHyuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxMzo1Mjo1MVrOHdHyuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDI5ODQyNA==", "bodyText": "Forgot to mention one potential problem with this approach. In situation when #addPortableArrayField() or #addPortableField() are invoked with incorrect ClassDefinition definition (with zero classId), the field will be added into the addedFieldNames, while, in fact, it wasn't added due to next failed check. The simplest fix would be to remove the field from addedFieldNames before throwing an IllegalArgumentException in those methods, but there might be more elegant solutions like changing validation order.", "url": "https://github.com/hazelcast/hazelcast/pull/17682#discussion_r500298424", "createdAt": "2020-10-06T13:52:51Z", "author": {"login": "puzpuzpuz"}, "path": "hazelcast/src/main/java/com/hazelcast/nio/serialization/ClassDefinitionBuilder.java", "diffHunk": "@@ -213,7 +341,10 @@ public ClassDefinition build() {\n         return cd;\n     }\n \n-    private void check() {\n+    private void check(String fieldName) {\n+        if (!addedFieldNames.add(fieldName)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b8d43b7633c7441a129c90553973abacf4a54e8"}, "originalPosition": 321}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8086e4af0138f4bcdf8538a36f0a65a8536dba69", "author": {"user": {"login": "sancar", "name": "sancar"}}, "url": "https://github.com/hazelcast/hazelcast/commit/8086e4af0138f4bcdf8538a36f0a65a8536dba69", "committedDate": "2020-10-06T14:12:34Z", "message": "fix addPortable/ArrayField"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3231, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}