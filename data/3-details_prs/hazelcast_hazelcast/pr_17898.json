{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI3NjAzNzky", "number": 17898, "title": "Compress metric units defensively", "bodyText": "The units of the metrics are directly derived from the ProbeUnit enum\nand the MetricCompressor takes the ordinal when creating the blob. On\nthe consumer side, this ordinal is taken and a lookup is made with the\nordinal potentially leading to IndexOutOfBoundsException if the ordinal\nis higher than the size of the array holding the possible values of the\nunits. This can be the case every time we add a new unit to the\nProbeUnit enum, which the MetricCompressor is not aware of.\nTo prevent potential issues, we make the unit compression and extraction\nmore defensive. We change the compression to convert the marked units to\na tag with the name \"metric-unit\" and set the unit to null. With this, the\nmetric can still be processed by MC and the consumers using a metric\nextractor and retain the information about the unit. The extractor is\nmade more defensive by adding a bound check to prevent the\nIndexOutOfBoundsException in the mentioned case.", "createdAt": "2020-11-25T17:41:24Z", "url": "https://github.com/hazelcast/hazelcast/pull/17898", "merged": true, "mergeCommit": {"oid": "622eaa61c6d874723b77561f7d01410eef6733b6"}, "closed": true, "closedAt": "2020-12-07T17:23:28Z", "author": {"login": "blazember"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdj0S2LAH2gAyNTI3NjAzNzkyOmViMGU3M2M4ZDc2OTZjM2YzNjJkM2Q1ODVlNTRlMzA2ZmIwZjZlMDc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdj2ou8gH2gAyNTI3NjAzNzkyOmZhMmE2MDg3YWZhNzFkYzgxODVmYjNjYTEzODg4MWFhMzQwZjQ5MGI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "eb0e73c8d7696c3f362d3d585e54e306fb0f6e07", "author": {"user": {"login": "blazember", "name": "Zolt\u00e1n Baranyi"}}, "url": "https://github.com/hazelcast/hazelcast/commit/eb0e73c8d7696c3f362d3d585e54e306fb0f6e07", "committedDate": "2020-12-07T12:00:14Z", "message": "Compress metric unites defensively\n\nThe units of the metrics are directly derived from the ProbeUnit enum\nand the MetricCompressor takes the ordinal when creating the blob. On\nthe consumer side this ordinal is taken and a lookup is made with the\nordinal potentially leading to IndexOutOfBoundsException if the ordinal\nis higher than the size of the array holding the possible values of the\nunits. This can be the case every time we add a new unit to the\nProbeUnit enum, which the MetricCompressor is not aware of.\n\nTo prevent potential issues, we make the unit compression and extraction\nmore defensive. We change the compression to convert the marked units to\na tag with name \"metric-unit\" and set the unit to null. With this the\nmetric can still be processed by MC and the consumers using an metric\nextractor and retain the information about the unit. The extractor is\nmade more defensive by adding a bound check to prevent the\nIndexOutOfBoundsException in the mentioned case."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0edbcda7c1c08c37646a6e421d3f24b760407ebb", "author": {"user": {"login": "blazember", "name": "Zolt\u00e1n Baranyi"}}, "url": "https://github.com/hazelcast/hazelcast/commit/0edbcda7c1c08c37646a6e421d3f24b760407ebb", "committedDate": "2020-11-26T14:06:19Z", "message": "Further fixes"}, "afterCommit": {"oid": "eb0e73c8d7696c3f362d3d585e54e306fb0f6e07", "author": {"user": {"login": "blazember", "name": "Zolt\u00e1n Baranyi"}}, "url": "https://github.com/hazelcast/hazelcast/commit/eb0e73c8d7696c3f362d3d585e54e306fb0f6e07", "committedDate": "2020-12-07T12:00:14Z", "message": "Compress metric unites defensively\n\nThe units of the metrics are directly derived from the ProbeUnit enum\nand the MetricCompressor takes the ordinal when creating the blob. On\nthe consumer side this ordinal is taken and a lookup is made with the\nordinal potentially leading to IndexOutOfBoundsException if the ordinal\nis higher than the size of the array holding the possible values of the\nunits. This can be the case every time we add a new unit to the\nProbeUnit enum, which the MetricCompressor is not aware of.\n\nTo prevent potential issues, we make the unit compression and extraction\nmore defensive. We change the compression to convert the marked units to\na tag with name \"metric-unit\" and set the unit to null. With this the\nmetric can still be processed by MC and the consumers using an metric\nextractor and retain the information about the unit. The extractor is\nmade more defensive by adding a bound check to prevent the\nIndexOutOfBoundsException in the mentioned case."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2MTcyMzIx", "url": "https://github.com/hazelcast/hazelcast/pull/17898#pullrequestreview-546172321", "createdAt": "2020-12-07T14:00:05Z", "commit": {"oid": "eb0e73c8d7696c3f362d3d585e54e306fb0f6e07"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2MTYzMjUz", "url": "https://github.com/hazelcast/hazelcast/pull/17898#pullrequestreview-546163253", "createdAt": "2020-12-07T13:49:33Z", "commit": {"oid": "eb0e73c8d7696c3f362d3d585e54e306fb0f6e07"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxMzo0OTozM1rOIAnleQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxMzo1NjoxN1rOIAn39g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUxOTQ4MQ==", "bodyText": "Can we safely delete the argument in 4.3? That's probably a question on MC forward-compatibility with IMDG.", "url": "https://github.com/hazelcast/hazelcast/pull/17898#discussion_r537519481", "createdAt": "2020-12-07T13:49:33Z", "author": {"login": "puzpuzpuz"}, "path": "hazelcast/src/main/java/com/hazelcast/internal/metrics/ProbeUnit.java", "diffHunk": "@@ -36,4 +34,26 @@\n     BOOLEAN,\n     /** 0..n, ordinal of an enum */\n     ENUM,\n+    /** Timestamp or duration represented in \u00b5s */\n+    // RU_COMPAT_4_2\n+    // remove constructor argument in 4.3", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eb0e73c8d7696c3f362d3d585e54e306fb0f6e07"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUyNDIxNA==", "bodyText": "nit: I'd also add a note to the enum javadoc. The text could be Note. The order of enum ordinals is important for compatibility purposes with potential metrics consumers. Do not delete existing value and always add new ones to the end of the list. or smth like that.", "url": "https://github.com/hazelcast/hazelcast/pull/17898#discussion_r537524214", "createdAt": "2020-12-07T13:56:17Z", "author": {"login": "puzpuzpuz"}, "path": "hazelcast/src/main/java/com/hazelcast/internal/metrics/ProbeUnit.java", "diffHunk": "@@ -36,4 +34,26 @@\n     BOOLEAN,\n     /** 0..n, ordinal of an enum */\n     ENUM,\n+    /** Timestamp or duration represented in \u00b5s */\n+    // RU_COMPAT_4_2\n+    // remove constructor argument in 4.3\n+    US(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eb0e73c8d7696c3f362d3d585e54e306fb0f6e07"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa2a6087afa71dc8185fb3ca138881aa340f490b", "author": {"user": {"login": "blazember", "name": "Zolt\u00e1n Baranyi"}}, "url": "https://github.com/hazelcast/hazelcast/commit/fa2a6087afa71dc8185fb3ca138881aa340f490b", "committedDate": "2020-12-07T14:43:57Z", "message": "Address review comment and change the RU_COMPAT comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3170, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}