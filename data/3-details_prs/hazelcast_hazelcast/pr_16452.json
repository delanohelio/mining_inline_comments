{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYwOTQzMDQ1", "number": 16452, "title": "Fix client listener registry leaks", "bodyText": "Background:\nWhen a listener is added from an endpoint, we also register a\ndestroyAction. A destroyAction is a function to deregister the listener.\nIt is used when endpoint is removed. When endpoint is removed, we call\nall the registered destroy actions.\nRacy scenario is as follows:\n\nA listener is added, but not registered the destroy action.\nEndpoint is removed because the client is disconnected.\nAll the destroy actions currently registered are called.\nDestroyAction is registered to endpoint after it is destroyed.\nAfter this point, there is no one to call the last destroyAction,\nhence the leak.\n\nAs fix, we have added a second check if endpoint is destroyed after\na destroy action is put.\nfixes #16429", "createdAt": "2020-01-09T12:49:14Z", "url": "https://github.com/hazelcast/hazelcast/pull/16452", "merged": true, "mergeCommit": {"oid": "40a956bbacac7de6ec727fdd2658286c08956c0b"}, "closed": true, "closedAt": "2020-01-10T10:55:35Z", "author": {"login": "sancar"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb45I_lAFqTM0MDk4Mzc0OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb47XKNgFqTM0MTA1MDkxMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwOTgzNzQ4", "url": "https://github.com/hazelcast/hazelcast/pull/16452#pullrequestreview-340983748", "createdAt": "2020-01-10T07:06:21Z", "commit": {"oid": "600502cd5ed258ca4f44a9a7a796e2ebe806990f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQwNzowNjoyMlrOFcLuCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQwNzowNjoyMlrOFcLuCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA5NjQ1OQ==", "bodyText": "I think the following would also fix the leak and will not call the removeAction twice in any code path\n    @Override\n    public void addDestroyAction(UUID registrationId, Callable<Boolean> removeAction) {\n        synchronized (removeListenerActions) {\n            if (destroyed) {\n                callRemoveAction(removeAction);\n            } else {\n                removeListenerActions.put(registrationId, removeAction);\n            }\n        }\n    }", "url": "https://github.com/hazelcast/hazelcast/pull/16452#discussion_r365096459", "createdAt": "2020-01-10T07:06:22Z", "author": {"login": "mdumandag"}, "path": "hazelcast/src/main/java/com/hazelcast/client/impl/ClientEndpointImpl.java", "diffHunk": "@@ -198,6 +202,10 @@ public void addListenerDestroyAction(final String service, final String topic, f\n     @Override\n     public void addDestroyAction(UUID registrationId, Callable<Boolean> removeAction) {\n         removeListenerActions.put(registrationId, removeAction);\n+        if (destroyed) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "600502cd5ed258ca4f44a9a7a796e2ebe806990f"}, "originalPosition": 35}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "600502cd5ed258ca4f44a9a7a796e2ebe806990f", "author": {"user": {"login": "sancar", "name": "sancar"}}, "url": "https://github.com/hazelcast/hazelcast/commit/600502cd5ed258ca4f44a9a7a796e2ebe806990f", "committedDate": "2020-01-09T12:30:58Z", "message": "Fix client listener registry leaks\n\nBackground:\nWhen a listener is added from an endpoint, we also register a\ndestroyAction. A destroyAction is a function to deregister the listener.\nIt is used when endpoint is removed. When endpoint is removed, we call\n all the registered destroy actions.\n\nRacy scenario is as follows:\n1. A listener is added, but not registered the destroy action.\n2. Endpoint is removed because the client is disconnected.\nAll the destroy actions currently registered are called.\n3. DestroyAction is registered to endpoint after it is destroyed.\n4. After this point, there is no one to call the last destroyAction,\nhence the leak.\n\nAs fix, we have added a second check if endpoint is destroyed after\na destroy action is put.\n\nfixes https://github.com/hazelcast/hazelcast/issues/16429"}, "afterCommit": {"oid": "c18990509373b68c0276be9bf52526607eb8b991", "author": {"user": {"login": "sancar", "name": "sancar"}}, "url": "https://github.com/hazelcast/hazelcast/commit/c18990509373b68c0276be9bf52526607eb8b991", "committedDate": "2020-01-10T08:17:57Z", "message": "Fix client listener registry leaks\n\nBackground:\nWhen a listener is added from an endpoint, we also register a\ndestroyAction. A destroyAction is a function to deregister the listener.\nIt is used when endpoint is removed. When endpoint is removed, we call\n all the registered destroy actions.\n\nRacy scenario is as follows:\n1. A listener is added, but not registered the destroy action.\n2. Endpoint is removed because the client is disconnected.\nAll the destroy actions currently registered are called.\n3. DestroyAction is registered to endpoint after it is destroyed.\n4. After this point, there is no one to call the last destroyAction,\nhence the leak.\n\nAs fix, we have added a second check if endpoint is destroyed after\na destroy action is put.\n\nfixes https://github.com/hazelcast/hazelcast/issues/16429"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "922a7b17f758450424d592eb9a11a3e9748eaa6d", "author": {"user": {"login": "sancar", "name": "sancar"}}, "url": "https://github.com/hazelcast/hazelcast/commit/922a7b17f758450424d592eb9a11a3e9748eaa6d", "committedDate": "2020-01-10T08:35:47Z", "message": "Fix client listener registry leaks\n\nBackground:\nWhen a listener is added from an endpoint, we also register a\ndestroyAction. A destroyAction is a function to deregister the listener.\nIt is used when endpoint is removed. When endpoint is removed, we call\n all the registered destroy actions.\n\nRacy scenario is as follows:\n1. A listener is added, but not registered the destroy action.\n2. Endpoint is removed because the client is disconnected.\nAll the destroy actions currently registered are called.\n3. DestroyAction is registered to endpoint after it is destroyed.\n4. After this point, there is no one to call the last destroyAction,\nhence the leak.\n\nAs fix, we have added a second check if endpoint is destroyed after\na destroy action is put.\n\nfixes https://github.com/hazelcast/hazelcast/issues/16429"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c18990509373b68c0276be9bf52526607eb8b991", "author": {"user": {"login": "sancar", "name": "sancar"}}, "url": "https://github.com/hazelcast/hazelcast/commit/c18990509373b68c0276be9bf52526607eb8b991", "committedDate": "2020-01-10T08:17:57Z", "message": "Fix client listener registry leaks\n\nBackground:\nWhen a listener is added from an endpoint, we also register a\ndestroyAction. A destroyAction is a function to deregister the listener.\nIt is used when endpoint is removed. When endpoint is removed, we call\n all the registered destroy actions.\n\nRacy scenario is as follows:\n1. A listener is added, but not registered the destroy action.\n2. Endpoint is removed because the client is disconnected.\nAll the destroy actions currently registered are called.\n3. DestroyAction is registered to endpoint after it is destroyed.\n4. After this point, there is no one to call the last destroyAction,\nhence the leak.\n\nAs fix, we have added a second check if endpoint is destroyed after\na destroy action is put.\n\nfixes https://github.com/hazelcast/hazelcast/issues/16429"}, "afterCommit": {"oid": "922a7b17f758450424d592eb9a11a3e9748eaa6d", "author": {"user": {"login": "sancar", "name": "sancar"}}, "url": "https://github.com/hazelcast/hazelcast/commit/922a7b17f758450424d592eb9a11a3e9748eaa6d", "committedDate": "2020-01-10T08:35:47Z", "message": "Fix client listener registry leaks\n\nBackground:\nWhen a listener is added from an endpoint, we also register a\ndestroyAction. A destroyAction is a function to deregister the listener.\nIt is used when endpoint is removed. When endpoint is removed, we call\n all the registered destroy actions.\n\nRacy scenario is as follows:\n1. A listener is added, but not registered the destroy action.\n2. Endpoint is removed because the client is disconnected.\nAll the destroy actions currently registered are called.\n3. DestroyAction is registered to endpoint after it is destroyed.\n4. After this point, there is no one to call the last destroyAction,\nhence the leak.\n\nAs fix, we have added a second check if endpoint is destroyed after\na destroy action is put.\n\nfixes https://github.com/hazelcast/hazelcast/issues/16429"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxMDI5OTEy", "url": "https://github.com/hazelcast/hazelcast/pull/16452#pullrequestreview-341029912", "createdAt": "2020-01-10T09:06:56Z", "commit": {"oid": "922a7b17f758450424d592eb9a11a3e9748eaa6d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxMDUwOTEz", "url": "https://github.com/hazelcast/hazelcast/pull/16452#pullrequestreview-341050913", "createdAt": "2020-01-10T09:44:23Z", "commit": {"oid": "922a7b17f758450424d592eb9a11a3e9748eaa6d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4012, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}