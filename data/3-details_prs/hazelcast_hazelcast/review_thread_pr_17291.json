{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYxOTcyODk5", "number": 17291, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxMjo1NTo0NlrOEU_JFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxMjo1ODo0MlrOEU_Nkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwNDQxNDk1OnYy", "diffSide": "RIGHT", "path": "hazelcast-sql/src/main/java/com/hazelcast/sql/impl/calcite/parse/QueryParser.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxMjo1NTo0NlrOG7fG7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxMzo1MTowNlrOG7hTRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTAyODg0Ng==", "bodyText": "Changes in this class look suspicious to me - what if we reveal that some context information that is needed for a new command is not passed here?\nAn alternative is to move the whole parser instantiation to jetSqlBackend. This way the risk of the aforementioned problem is zero.", "url": "https://github.com/hazelcast/hazelcast/pull/17291#discussion_r465028846", "createdAt": "2020-08-04T12:55:46Z", "author": {"login": "devozerov"}, "path": "hazelcast-sql/src/main/java/com/hazelcast/sql/impl/calcite/parse/QueryParser.java", "diffHunk": "@@ -19,100 +19,70 @@\n import com.hazelcast.sql.SqlErrorCode;\n import com.hazelcast.sql.impl.JetSqlBackend;\n import com.hazelcast.sql.impl.QueryException;\n-import com.hazelcast.sql.impl.calcite.parser.HazelcastSqlParser;\n import com.hazelcast.sql.impl.calcite.validate.HazelcastSqlConformance;\n-import org.apache.calcite.rel.type.RelDataType;\n-import org.apache.calcite.sql.SqlCall;\n-import org.apache.calcite.sql.SqlHint;\n import org.apache.calcite.sql.SqlKind;\n import org.apache.calcite.sql.SqlNode;\n import org.apache.calcite.sql.SqlOperator;\n-import org.apache.calcite.sql.SqlOperatorTable;\n-import org.apache.calcite.sql.SqlSelect;\n import org.apache.calcite.sql.parser.SqlParser;\n-import org.apache.calcite.sql.util.SqlBasicVisitor;\n+import org.apache.calcite.sql.parser.SqlParserImplFactory;\n import org.apache.calcite.sql.validate.SqlValidator;\n \n-import java.util.Collections;\n-import java.util.HashSet;\n+import javax.annotation.Nullable;\n import java.util.Set;\n \n+import static java.util.Collections.emptySet;\n+\n /**\n  * Performs syntactic and semantic validation of the query, and converts the parse tree into a relational tree.\n  */\n public class QueryParser {\n \n-    /** A hint to force execution of a query on Jet. */\n-    private static final String RUN_ON_JET_HINT = \"jet\";\n+    private final SqlParser.Config parserConfig;\n \n-    private static final SqlParser.Config CONFIG;\n     private final SqlValidator validator;\n-\n-    static {\n+    private final Set<SqlKind> extensionSqlKinds;\n+    private final Set<SqlOperator> extensionSqlOperators;\n+\n+    @SuppressWarnings(\"unchecked\")\n+    public QueryParser(\n+            SqlValidator validator,\n+            @Nullable JetSqlBackend jetSqlBackend\n+    ) {\n         SqlParser.ConfigBuilder configBuilder = SqlParser.configBuilder();\n-\n         CasingConfiguration.DEFAULT.toParserConfig(configBuilder);\n         configBuilder.setConformance(HazelcastSqlConformance.INSTANCE);\n-        configBuilder.setParserFactory(HazelcastSqlParser.FACTORY);\n-\n-        CONFIG = configBuilder.build();\n-    }\n+        if (jetSqlBackend != null) {\n+            configBuilder.setParserFactory((SqlParserImplFactory) jetSqlBackend.createParserFactory());\n+        }\n+        this.parserConfig = configBuilder.build();\n \n-    public QueryParser(SqlValidator validator) {\n         this.validator = validator;\n+        this.extensionSqlKinds = jetSqlBackend == null ? emptySet() : (Set<SqlKind>) jetSqlBackend.kinds();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "77a834b8f39f9b63b2d940ad1453bbd65e040572"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTA2NDc3Mg==", "bodyText": "I have slightly refactored QueryParser, UnsupportedOperationVisitor is specific to either IMDG & JET", "url": "https://github.com/hazelcast/hazelcast/pull/17291#discussion_r465064772", "createdAt": "2020-08-04T13:51:06Z", "author": {"login": "gierlachg"}, "path": "hazelcast-sql/src/main/java/com/hazelcast/sql/impl/calcite/parse/QueryParser.java", "diffHunk": "@@ -19,100 +19,70 @@\n import com.hazelcast.sql.SqlErrorCode;\n import com.hazelcast.sql.impl.JetSqlBackend;\n import com.hazelcast.sql.impl.QueryException;\n-import com.hazelcast.sql.impl.calcite.parser.HazelcastSqlParser;\n import com.hazelcast.sql.impl.calcite.validate.HazelcastSqlConformance;\n-import org.apache.calcite.rel.type.RelDataType;\n-import org.apache.calcite.sql.SqlCall;\n-import org.apache.calcite.sql.SqlHint;\n import org.apache.calcite.sql.SqlKind;\n import org.apache.calcite.sql.SqlNode;\n import org.apache.calcite.sql.SqlOperator;\n-import org.apache.calcite.sql.SqlOperatorTable;\n-import org.apache.calcite.sql.SqlSelect;\n import org.apache.calcite.sql.parser.SqlParser;\n-import org.apache.calcite.sql.util.SqlBasicVisitor;\n+import org.apache.calcite.sql.parser.SqlParserImplFactory;\n import org.apache.calcite.sql.validate.SqlValidator;\n \n-import java.util.Collections;\n-import java.util.HashSet;\n+import javax.annotation.Nullable;\n import java.util.Set;\n \n+import static java.util.Collections.emptySet;\n+\n /**\n  * Performs syntactic and semantic validation of the query, and converts the parse tree into a relational tree.\n  */\n public class QueryParser {\n \n-    /** A hint to force execution of a query on Jet. */\n-    private static final String RUN_ON_JET_HINT = \"jet\";\n+    private final SqlParser.Config parserConfig;\n \n-    private static final SqlParser.Config CONFIG;\n     private final SqlValidator validator;\n-\n-    static {\n+    private final Set<SqlKind> extensionSqlKinds;\n+    private final Set<SqlOperator> extensionSqlOperators;\n+\n+    @SuppressWarnings(\"unchecked\")\n+    public QueryParser(\n+            SqlValidator validator,\n+            @Nullable JetSqlBackend jetSqlBackend\n+    ) {\n         SqlParser.ConfigBuilder configBuilder = SqlParser.configBuilder();\n-\n         CasingConfiguration.DEFAULT.toParserConfig(configBuilder);\n         configBuilder.setConformance(HazelcastSqlConformance.INSTANCE);\n-        configBuilder.setParserFactory(HazelcastSqlParser.FACTORY);\n-\n-        CONFIG = configBuilder.build();\n-    }\n+        if (jetSqlBackend != null) {\n+            configBuilder.setParserFactory((SqlParserImplFactory) jetSqlBackend.createParserFactory());\n+        }\n+        this.parserConfig = configBuilder.build();\n \n-    public QueryParser(SqlValidator validator) {\n         this.validator = validator;\n+        this.extensionSqlKinds = jetSqlBackend == null ? emptySet() : (Set<SqlKind>) jetSqlBackend.kinds();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTAyODg0Ng=="}, "originalCommit": {"oid": "77a834b8f39f9b63b2d940ad1453bbd65e040572"}, "originalPosition": 62}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwNDQyNjQyOnYy", "diffSide": "RIGHT", "path": "hazelcast-sql/src/main/java/com/hazelcast/sql/impl/calcite/parse/UnsupportedOperationVisitor.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxMjo1ODo0MlrOG7fN9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxMzo1MToyNFrOG7hUJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTAzMDY0Ng==", "bodyText": "The same concern as in the parser. It may happen that Jet would require a custom syntax somewhere deep inside some other fragment (e.g. SELECT statement), We will not be able to extend the UnsupportedOperationVisitor without a separate IMDG release.", "url": "https://github.com/hazelcast/hazelcast/pull/17291#discussion_r465030646", "createdAt": "2020-08-04T12:58:42Z", "author": {"login": "devozerov"}, "path": "hazelcast-sql/src/main/java/com/hazelcast/sql/impl/calcite/parse/UnsupportedOperationVisitor.java", "diffHunk": "@@ -182,19 +170,26 @@\n         SUPPORTED_OPERATORS.add(SqlStdOperatorTable.CURRENT_TIMESTAMP);\n         SUPPORTED_OPERATORS.add(SqlStdOperatorTable.LOCALTIMESTAMP);\n         SUPPORTED_OPERATORS.add(SqlStdOperatorTable.LOCALTIME);\n-\n-        // Other/Extensions\n-        SUPPORTED_OPERATORS.add(SqlOption.OPERATOR);\n     }\n \n-    private final Set<SqlOperator> extensionOperators;\n+    private final SqlValidatorCatalogReader catalogReader;\n+\n+    private final Set<SqlKind> extensionSqlKinds;\n+    private final Set<SqlOperator> extensionSqlOperators;\n+\n+    private boolean exclusivelyImdgStatement;\n \n     UnsupportedOperationVisitor(\n             SqlValidatorCatalogReader catalogReader,\n-            Set<SqlOperator> extensionOperators\n+            Set<SqlKind> extensionSqlKinds,\n+            Set<SqlOperator> extensionSqlOperators\n     ) {\n         this.catalogReader = catalogReader;\n-        this.extensionOperators = extensionOperators;\n+\n+        this.extensionSqlKinds = extensionSqlKinds;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "77a834b8f39f9b63b2d940ad1453bbd65e040572"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTA2NDk5Ng==", "bodyText": "UnsupportedOperationVisitor is no longer shared", "url": "https://github.com/hazelcast/hazelcast/pull/17291#discussion_r465064996", "createdAt": "2020-08-04T13:51:24Z", "author": {"login": "gierlachg"}, "path": "hazelcast-sql/src/main/java/com/hazelcast/sql/impl/calcite/parse/UnsupportedOperationVisitor.java", "diffHunk": "@@ -182,19 +170,26 @@\n         SUPPORTED_OPERATORS.add(SqlStdOperatorTable.CURRENT_TIMESTAMP);\n         SUPPORTED_OPERATORS.add(SqlStdOperatorTable.LOCALTIMESTAMP);\n         SUPPORTED_OPERATORS.add(SqlStdOperatorTable.LOCALTIME);\n-\n-        // Other/Extensions\n-        SUPPORTED_OPERATORS.add(SqlOption.OPERATOR);\n     }\n \n-    private final Set<SqlOperator> extensionOperators;\n+    private final SqlValidatorCatalogReader catalogReader;\n+\n+    private final Set<SqlKind> extensionSqlKinds;\n+    private final Set<SqlOperator> extensionSqlOperators;\n+\n+    private boolean exclusivelyImdgStatement;\n \n     UnsupportedOperationVisitor(\n             SqlValidatorCatalogReader catalogReader,\n-            Set<SqlOperator> extensionOperators\n+            Set<SqlKind> extensionSqlKinds,\n+            Set<SqlOperator> extensionSqlOperators\n     ) {\n         this.catalogReader = catalogReader;\n-        this.extensionOperators = extensionOperators;\n+\n+        this.extensionSqlKinds = extensionSqlKinds;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTAzMDY0Ng=="}, "originalCommit": {"oid": "77a834b8f39f9b63b2d940ad1453bbd65e040572"}, "originalPosition": 60}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 386, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}