{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI2NDc0Nzg3", "number": 17889, "title": "Introduce NODE_AWARE partitioning group type", "bodyText": "For Kubernetes based environments, user might want to store their backups at another Kubernetes node. They can easily decide which pod will be running on which node via defining affinity or node-selector. To satisfy these kind of specific requirements, NODE_AWARE partition group type is introduced with this PR. Newly created NodeAwareMemberGroupFactory class is just simplified version of ZoneAwareMemberGroupFactory actually. Here is the related PRD.\nThese changes will be forward-port to 4.0.z, 4.1.z and master branches.\nTodo:\n\n  Create related doc section at Partitioning Group Types  --> hazelcast/hazelcast-reference-manual#904", "createdAt": "2020-11-24T13:20:30Z", "url": "https://github.com/hazelcast/hazelcast/pull/17889", "merged": true, "mergeCommit": {"oid": "242f5b9317207b14efc08e1d9e2876124ed3fb1c"}, "closed": true, "closedAt": "2020-12-01T12:35:19Z", "author": {"login": "hasancelik"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdfpJDYgH2gAyNTI2NDc0Nzg3OmE3OGZjYjBjZmZmZTE4OWUzNWEwYTY0M2E4NjQ1NWEwMzJlZmUxOTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdh36t7gH2gAyNTI2NDc0Nzg3OjAwM2I1OGMxNmE5NDc2NDAyMThmM2QyZWFhYTE2YmFmMTdmY2Y5MDk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a78fcb0cfffe189e35a0a643a86455a032efe195", "author": {"user": {"login": "hasancelik", "name": "Hasan \u00c7elik"}}, "url": "https://github.com/hazelcast/hazelcast/commit/a78fcb0cfffe189e35a0a643a86455a032efe195", "committedDate": "2020-11-24T12:44:53Z", "message": "Introduce NODE_AWARE partitioning group type\n\nFor Kubernetes based environments, user might want to store their backups at another Kubernetes node.\nThey can easily decide which pod will be runing on which node via defining labels or node-selector.\nTo satisfy these kind of specific requirements, NODE_AWARE partition group type is introduced.\nNewly created NodeAwareMemberGroupFactory class is just simplified version of ZoneAwareMemberGroupFactory."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3NjQ4ODQ2", "url": "https://github.com/hazelcast/hazelcast/pull/17889#pullrequestreview-537648846", "createdAt": "2020-11-24T15:47:46Z", "commit": {"oid": "a78fcb0cfffe189e35a0a643a86455a032efe195"}, "state": "COMMENTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNTo0Nzo0NlrOH5IEBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNTo1NjoxNlrOH5IzeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTY2Mjk4Mg==", "bodyText": "groups are allocated according to the metadata provided by Discovery SPI Partitions are not written to the same group., could you re-write this sentence? Looks like some words are missing.", "url": "https://github.com/hazelcast/hazelcast/pull/17889#discussion_r529662982", "createdAt": "2020-11-24T15:47:46Z", "author": {"login": "leszko"}, "path": "hazelcast/src/main/java/com/hazelcast/config/PartitionGroupConfig.java", "diffHunk": "@@ -83,24 +83,34 @@\n  * <p>\n  * You can define as many <code>member-group</code>s as you want. Hazelcast will always store backups in a different\n  * member-group to the primary partition.\n+ *\n+ * <h1>Zone Aware Partition Groups</h1>\n+ * In this scheme, groups are allocated according to the metadata provided by Discovery SPI Partitions are not", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a78fcb0cfffe189e35a0a643a86455a032efe195"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTY2MzEzNg==", "bodyText": "racks?", "url": "https://github.com/hazelcast/hazelcast/pull/17889#discussion_r529663136", "createdAt": "2020-11-24T15:47:53Z", "author": {"login": "leszko"}, "path": "hazelcast/src/main/java/com/hazelcast/config/PartitionGroupConfig.java", "diffHunk": "@@ -83,24 +83,34 @@\n  * <p>\n  * You can define as many <code>member-group</code>s as you want. Hazelcast will always store backups in a different\n  * member-group to the primary partition.\n+ *\n+ * <h1>Zone Aware Partition Groups</h1>\n+ * In this scheme, groups are allocated according to the metadata provided by Discovery SPI Partitions are not\n+ * written to the same group. This is very useful for ensuring partitions are written to availability\n+ * zones or different racks without providing the IP addresses to the config ahead.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a78fcb0cfffe189e35a0a643a86455a032efe195"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTY2NDMyNA==", "bodyText": "I don't think we should mention Kubernetes here? The mechanism is generic and it may be applied to some other orchestration solutions, like Docker Swarm.", "url": "https://github.com/hazelcast/hazelcast/pull/17889#discussion_r529664324", "createdAt": "2020-11-24T15:48:45Z", "author": {"login": "leszko"}, "path": "hazelcast/src/main/java/com/hazelcast/config/PartitionGroupConfig.java", "diffHunk": "@@ -83,24 +83,34 @@\n  * <p>\n  * You can define as many <code>member-group</code>s as you want. Hazelcast will always store backups in a different\n  * member-group to the primary partition.\n+ *\n+ * <h1>Zone Aware Partition Groups</h1>\n+ * In this scheme, groups are allocated according to the metadata provided by Discovery SPI Partitions are not\n+ * written to the same group. This is very useful for ensuring partitions are written to availability\n+ * zones or different racks without providing the IP addresses to the config ahead.\n  * <code>\n  * <pre>\n  * &lt;partition-group enabled=\"true\" group-type=\"ZONE_AWARE\"/&gt;\n  * </pre>\n  * </code>\n  *\n- * <h1>Zone Aware Partition Groups</h1>\n+ * <h1>Node Aware Partition Groups</h1>\n  * In this scheme, groups are allocated according to the metadata provided by Discovery SPI Partitions are not\n- * written to the same group. This is very useful for ensuring partitions are written to availability\n- * zones or different racks without providing the IP addresses to the config ahead.\n+ * written to the same group. This is very useful for ensuring partitions are written to different Kubernetes nodes", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a78fcb0cfffe189e35a0a643a86455a032efe195"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTY2NTgxNw==", "bodyText": "The same, I don't think this feature is related only to Kubernetes.", "url": "https://github.com/hazelcast/hazelcast/pull/17889#discussion_r529665817", "createdAt": "2020-11-24T15:49:47Z", "author": {"login": "leszko"}, "path": "hazelcast/src/main/java/com/hazelcast/config/PartitionGroupConfig.java", "diffHunk": "@@ -151,6 +161,11 @@\n          * If only one zone is available, backups will be created in the same zone.\n          */\n         ZONE_AWARE,\n+        /**\n+         * Node Aware. Backups will be created in other Kubernetes nodes/physical machines.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a78fcb0cfffe189e35a0a643a86455a032efe195"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTY2ODU5MQ==", "bodyText": "I think we can just remove this @since. If you want to keep it, please add the correct version.", "url": "https://github.com/hazelcast/hazelcast/pull/17889#discussion_r529668591", "createdAt": "2020-11-24T15:51:43Z", "author": {"login": "leszko"}, "path": "hazelcast/src/main/java/com/hazelcast/partition/membergroup/NodeAwareMemberGroupFactory.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.partition.membergroup;\n+\n+import com.hazelcast.core.Member;\n+import com.hazelcast.spi.discovery.DiscoveryStrategy;\n+import com.hazelcast.spi.partitiongroup.PartitionGroupMetaData;\n+\n+import java.util.Collection;\n+import java.util.HashSet;\n+import java.util.Map;\n+import java.util.Set;\n+\n+import static com.hazelcast.util.MapUtil.createHashMap;\n+\n+/**\n+ * NodeAwareMemberGroupFactory is responsible for MemberGroups\n+ * creation according to the Kubernetes Node metadata provided by\n+ * {@link DiscoveryStrategy#discoverLocalMetadata()}\n+ * @since 3.7", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a78fcb0cfffe189e35a0a643a86455a032efe195"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTY2OTEzNQ==", "bodyText": "the same: I'd not use Kubernetes in the doc.", "url": "https://github.com/hazelcast/hazelcast/pull/17889#discussion_r529669135", "createdAt": "2020-11-24T15:52:08Z", "author": {"login": "leszko"}, "path": "hazelcast/src/main/java/com/hazelcast/partition/membergroup/NodeAwareMemberGroupFactory.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.partition.membergroup;\n+\n+import com.hazelcast.core.Member;\n+import com.hazelcast.spi.discovery.DiscoveryStrategy;\n+import com.hazelcast.spi.partitiongroup.PartitionGroupMetaData;\n+\n+import java.util.Collection;\n+import java.util.HashSet;\n+import java.util.Map;\n+import java.util.Set;\n+\n+import static com.hazelcast.util.MapUtil.createHashMap;\n+\n+/**\n+ * NodeAwareMemberGroupFactory is responsible for MemberGroups\n+ * creation according to the Kubernetes Node metadata provided by", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a78fcb0cfffe189e35a0a643a86455a032efe195"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTY3MDM4NQ==", "bodyText": "The same, we'd better not limit it to Kubernetes", "url": "https://github.com/hazelcast/hazelcast/pull/17889#discussion_r529670385", "createdAt": "2020-11-24T15:53:01Z", "author": {"login": "leszko"}, "path": "hazelcast/src/main/java/com/hazelcast/partition/membergroup/NodeAwareMemberGroupFactory.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.partition.membergroup;\n+\n+import com.hazelcast.core.Member;\n+import com.hazelcast.spi.discovery.DiscoveryStrategy;\n+import com.hazelcast.spi.partitiongroup.PartitionGroupMetaData;\n+\n+import java.util.Collection;\n+import java.util.HashSet;\n+import java.util.Map;\n+import java.util.Set;\n+\n+import static com.hazelcast.util.MapUtil.createHashMap;\n+\n+/**\n+ * NodeAwareMemberGroupFactory is responsible for MemberGroups\n+ * creation according to the Kubernetes Node metadata provided by\n+ * {@link DiscoveryStrategy#discoverLocalMetadata()}\n+ * @since 3.7\n+ */\n+public class NodeAwareMemberGroupFactory extends BackupSafeMemberGroupFactory implements MemberGroupFactory {\n+\n+    @Override\n+    protected Set<MemberGroup> createInternalMemberGroups(Collection<? extends Member> allMembers) {\n+        Map<String, MemberGroup> groups = createHashMap(allMembers.size());\n+        for (Member member : allMembers) {\n+            final String nodeInfo = member.getStringAttribute(PartitionGroupMetaData.PARTITION_GROUP_NODE);\n+            if (nodeInfo == null) {\n+                throw new IllegalArgumentException(\"Not enough metadata information is provided. \"\n+                        + \"Kubernetes node name information must be provided with NODE_AWARE partition group.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a78fcb0cfffe189e35a0a643a86455a032efe195"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTY3MjU5Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return new HashSet<MemberGroup>(groups.values());\n          \n          \n            \n                    return new HashSet<>(groups.values());", "url": "https://github.com/hazelcast/hazelcast/pull/17889#discussion_r529672592", "createdAt": "2020-11-24T15:54:34Z", "author": {"login": "leszko"}, "path": "hazelcast/src/main/java/com/hazelcast/partition/membergroup/NodeAwareMemberGroupFactory.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.partition.membergroup;\n+\n+import com.hazelcast.core.Member;\n+import com.hazelcast.spi.discovery.DiscoveryStrategy;\n+import com.hazelcast.spi.partitiongroup.PartitionGroupMetaData;\n+\n+import java.util.Collection;\n+import java.util.HashSet;\n+import java.util.Map;\n+import java.util.Set;\n+\n+import static com.hazelcast.util.MapUtil.createHashMap;\n+\n+/**\n+ * NodeAwareMemberGroupFactory is responsible for MemberGroups\n+ * creation according to the Kubernetes Node metadata provided by\n+ * {@link DiscoveryStrategy#discoverLocalMetadata()}\n+ * @since 3.7\n+ */\n+public class NodeAwareMemberGroupFactory extends BackupSafeMemberGroupFactory implements MemberGroupFactory {\n+\n+    @Override\n+    protected Set<MemberGroup> createInternalMemberGroups(Collection<? extends Member> allMembers) {\n+        Map<String, MemberGroup> groups = createHashMap(allMembers.size());\n+        for (Member member : allMembers) {\n+            final String nodeInfo = member.getStringAttribute(PartitionGroupMetaData.PARTITION_GROUP_NODE);\n+            if (nodeInfo == null) {\n+                throw new IllegalArgumentException(\"Not enough metadata information is provided. \"\n+                        + \"Kubernetes node name information must be provided with NODE_AWARE partition group.\");\n+            }\n+            MemberGroup group = groups.get(nodeInfo);\n+            if (group == null) {\n+                group = new DefaultMemberGroup();\n+                groups.put(nodeInfo, group);\n+            }\n+            group.addMember(member);\n+        }\n+        return new HashSet<MemberGroup>(groups.values());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a78fcb0cfffe189e35a0a643a86455a032efe195"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTY3NDQzNw==", "bodyText": "The same, I'd avoid limiting this feature to Kubernetes.", "url": "https://github.com/hazelcast/hazelcast/pull/17889#discussion_r529674437", "createdAt": "2020-11-24T15:55:48Z", "author": {"login": "leszko"}, "path": "hazelcast/src/main/java/com/hazelcast/spi/discovery/DiscoveryStrategy.java", "diffHunk": "@@ -77,8 +77,8 @@\n \n     /**\n      * Returns a map with discovered metadata provided by the runtime environment. Those information\n-     * may include, but are not limited, to location information like datacenter, rack, host or additional\n-     * tags to be used for custom purpose.\n+     * may include, but are not limited, to location information like datacenter, rack, host,\n+     * Kubernetes node name or additional tags to be used for custom purpose.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a78fcb0cfffe189e35a0a643a86455a032efe195"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTY3NDcyNg==", "bodyText": "The same, I'd avoid limiting this feature to Kubernetes", "url": "https://github.com/hazelcast/hazelcast/pull/17889#discussion_r529674726", "createdAt": "2020-11-24T15:56:00Z", "author": {"login": "leszko"}, "path": "hazelcast/src/main/java/com/hazelcast/spi/discovery/integration/DiscoveryService.java", "diffHunk": "@@ -68,8 +68,8 @@\n \n     /**\n      * Returns a map with discovered metadata provided by the runtime environment. Those information\n-     * may include, but are not limited, to location information like datacenter, rack, host or additional\n-     * tags to be used for custom purpose.\n+     * may include, but are not limited, to location information like datacenter, rack, host,\n+     * Kubernetes node name or additional tags to be used for custom purpose.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a78fcb0cfffe189e35a0a643a86455a032efe195"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTY3NTEyOA==", "bodyText": "the same", "url": "https://github.com/hazelcast/hazelcast/pull/17889#discussion_r529675128", "createdAt": "2020-11-24T15:56:16Z", "author": {"login": "leszko"}, "path": "hazelcast/src/main/java/com/hazelcast/spi/partitiongroup/PartitionGroupMetaData.java", "diffHunk": "@@ -18,13 +18,17 @@\n \n /**\n  * This class contains the definition of known Discovery SPI metadata to support automatic\n- * generation of zone aware backup strategies based on cloud or service discovery provided\n- * information. These information are split into three different levels of granularity:\n+ * generation of zone aware and Kubernetes node aware backup strategies.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a78fcb0cfffe189e35a0a643a86455a032efe195"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3413ad08a6a3f791ba2e129bc5f1d3cc4e581686", "author": {"user": {"login": "hasancelik", "name": "Hasan \u00c7elik"}}, "url": "https://github.com/hazelcast/hazelcast/commit/3413ad08a6a3f791ba2e129bc5f1d3cc4e581686", "committedDate": "2020-11-25T08:24:05Z", "message": "fixed test failures"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c2bf326644cc6c6e2de4c79c9bd6df818d098d1", "author": {"user": {"login": "hasancelik", "name": "Hasan \u00c7elik"}}, "url": "https://github.com/hazelcast/hazelcast/commit/2c2bf326644cc6c6e2de4c79c9bd6df818d098d1", "committedDate": "2020-11-25T20:02:19Z", "message": "revised javadoc parts based on review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e46bda41505cb538e2ab9f46b7a94cba34342916", "author": {"user": {"login": "hasancelik", "name": "Hasan \u00c7elik"}}, "url": "https://github.com/hazelcast/hazelcast/commit/e46bda41505cb538e2ab9f46b7a94cba34342916", "committedDate": "2020-11-25T20:42:15Z", "message": "use parameterized type"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a18d9822129ad4ba03d066e07841bf00cded42b", "author": {"user": {"login": "hasancelik", "name": "Hasan \u00c7elik"}}, "url": "https://github.com/hazelcast/hazelcast/commit/9a18d9822129ad4ba03d066e07841bf00cded42b", "committedDate": "2020-11-25T21:14:51Z", "message": "fixed checkstyle error"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5NDYzODI3", "url": "https://github.com/hazelcast/hazelcast/pull/17889#pullrequestreview-539463827", "createdAt": "2020-11-26T16:54:23Z", "commit": {"oid": "9a18d9822129ad4ba03d066e07841bf00cded42b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxNjo1NDoyM1rOH6ipgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxNjo1NDoyM1rOH6ipgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE0NzEzNw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * generation of zone aware and Kubernetes node aware backup strategies.\n          \n          \n            \n             * generation of zone aware and node aware backup strategies.", "url": "https://github.com/hazelcast/hazelcast/pull/17889#discussion_r531147137", "createdAt": "2020-11-26T16:54:23Z", "author": {"login": "leszko"}, "path": "hazelcast/src/main/java/com/hazelcast/spi/partitiongroup/PartitionGroupMetaData.java", "diffHunk": "@@ -18,13 +18,19 @@\n \n /**\n  * This class contains the definition of known Discovery SPI metadata to support automatic\n- * generation of zone aware backup strategies based on cloud or service discovery provided\n- * information. These information are split into three different levels of granularity:\n+ * generation of zone aware and Kubernetes node aware backup strategies.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a18d9822129ad4ba03d066e07841bf00cded42b"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5NDY0MTE4", "url": "https://github.com/hazelcast/hazelcast/pull/17889#pullrequestreview-539464118", "createdAt": "2020-11-26T16:54:58Z", "commit": {"oid": "9a18d9822129ad4ba03d066e07841bf00cded42b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxNjo1NDo1OFrOH6iqkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxNjo1NDo1OFrOH6iqkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE0NzQxMA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * one or more Hazelcast nodes to share the same physical host/Kubernetes node, rack or\n          \n          \n            \n             * one or more Hazelcast nodes to share the same physical host/node, rack or", "url": "https://github.com/hazelcast/hazelcast/pull/17889#discussion_r531147410", "createdAt": "2020-11-26T16:54:58Z", "author": {"login": "leszko"}, "path": "hazelcast/src/main/java/com/hazelcast/spi/partitiongroup/PartitionGroupStrategy.java", "diffHunk": "@@ -22,7 +22,7 @@\n /**\n  * <p>A <tt>PartitionGroupStrategy</tt> implementation defines a strategy\n  * how backup groups are designed. Backup groups are units containing\n- * one or more Hazelcast nodes to share the same physical host, rack or\n+ * one or more Hazelcast nodes to share the same physical host/Kubernetes node, rack or", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a18d9822129ad4ba03d066e07841bf00cded42b"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5NDY0ODMy", "url": "https://github.com/hazelcast/hazelcast/pull/17889#pullrequestreview-539464832", "createdAt": "2020-11-26T16:56:15Z", "commit": {"oid": "9a18d9822129ad4ba03d066e07841bf00cded42b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwODA1MjUy", "url": "https://github.com/hazelcast/hazelcast/pull/17889#pullrequestreview-540805252", "createdAt": "2020-11-30T11:06:03Z", "commit": {"oid": "9a18d9822129ad4ba03d066e07841bf00cded42b"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxMTowNjowM1rOH72KEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxMjowNDoyMFrOH74Imw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjUxNTM0Nw==", "bodyText": "Maybe something like \"The backups of the partitions are not placed on...\"?", "url": "https://github.com/hazelcast/hazelcast/pull/17889#discussion_r532515347", "createdAt": "2020-11-30T11:06:03Z", "author": {"login": "blazember"}, "path": "hazelcast/src/main/java/com/hazelcast/config/PartitionGroupConfig.java", "diffHunk": "@@ -83,24 +83,38 @@\n  * <p>\n  * You can define as many <code>member-group</code>s as you want. Hazelcast will always store backups in a different\n  * member-group to the primary partition.\n+ *\n+ * <h1>Zone Aware Partition Groups</h1>\n+ * In this scheme, groups are allocated according to the metadata provided by Discovery SPI\n+ * These metadata are availability zone, rack and host. Partitions are not written to", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a18d9822129ad4ba03d066e07841bf00cded42b"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjU0NDkxNg==", "bodyText": "Same.", "url": "https://github.com/hazelcast/hazelcast/pull/17889#discussion_r532544916", "createdAt": "2020-11-30T11:59:16Z", "author": {"login": "blazember"}, "path": "hazelcast/src/main/java/com/hazelcast/config/PartitionGroupConfig.java", "diffHunk": "@@ -83,24 +83,38 @@\n  * <p>\n  * You can define as many <code>member-group</code>s as you want. Hazelcast will always store backups in a different\n  * member-group to the primary partition.\n+ *\n+ * <h1>Zone Aware Partition Groups</h1>\n+ * In this scheme, groups are allocated according to the metadata provided by Discovery SPI\n+ * These metadata are availability zone, rack and host. Partitions are not written to\n+ * the same group so this is very useful for ensuring partitions are written to\n+ * different availability zones without providing the IP addresses to the config ahead.\n  * <code>\n  * <pre>\n  * &lt;partition-group enabled=\"true\" group-type=\"ZONE_AWARE\"/&gt;\n  * </pre>\n  * </code>\n  *\n- * <h1>Zone Aware Partition Groups</h1>\n- * In this scheme, groups are allocated according to the metadata provided by Discovery SPI Partitions are not\n- * written to the same group. This is very useful for ensuring partitions are written to availability\n- * zones or different racks without providing the IP addresses to the config ahead.\n+ * <h1>Node Aware Partition Groups</h1>\n+ * In this scheme, groups are allocated according to node name metadata provided by Discovery SPI.\n+ * For container orchestration tools like Kubernetes and Docker Swarm, node is the term used to refer\n+ * machine that containers/pods run on. A node may be a virtual or physical machine.\n+ * Partitions are not written to the same group so this is very useful for ensuring partitions", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a18d9822129ad4ba03d066e07841bf00cded42b"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjU0NzczOQ==", "bodyText": "I wonder if logging the group:member mappings at debug level would be useful.", "url": "https://github.com/hazelcast/hazelcast/pull/17889#discussion_r532547739", "createdAt": "2020-11-30T12:04:20Z", "author": {"login": "blazember"}, "path": "hazelcast/src/main/java/com/hazelcast/partition/membergroup/NodeAwareMemberGroupFactory.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.partition.membergroup;\n+\n+import com.hazelcast.core.Member;\n+import com.hazelcast.spi.discovery.DiscoveryStrategy;\n+import com.hazelcast.spi.partitiongroup.PartitionGroupMetaData;\n+\n+import java.util.Collection;\n+import java.util.HashSet;\n+import java.util.Map;\n+import java.util.Set;\n+\n+import static com.hazelcast.util.MapUtil.createHashMap;\n+\n+/**\n+ * NodeAwareMemberGroupFactory is responsible for MemberGroups\n+ * creation according to name of the node metadata. For container orchestration\n+ * tools like Kubernetes and Docker Swarm, node is the term used to refer\n+ * machine that containers/pods run on. A node may be a virtual or physical machine.\n+ * Node name metadata provided by\n+ * {@link DiscoveryStrategy#discoverLocalMetadata()}\n+ * @since 3.12.11\n+ */\n+public class NodeAwareMemberGroupFactory extends BackupSafeMemberGroupFactory implements MemberGroupFactory {\n+\n+    @Override\n+    protected Set<MemberGroup> createInternalMemberGroups(Collection<? extends Member> allMembers) {\n+        Map<String, MemberGroup> groups = createHashMap(allMembers.size());\n+        for (Member member : allMembers) {\n+            final String nodeInfo = member.getStringAttribute(PartitionGroupMetaData.PARTITION_GROUP_NODE);\n+            if (nodeInfo == null) {\n+                throw new IllegalArgumentException(\"Not enough metadata information is provided. \"\n+                        + \"Node name information must be provided with NODE_AWARE partition group.\");\n+            }\n+            MemberGroup group = groups.get(nodeInfo);\n+            if (group == null) {\n+                group = new DefaultMemberGroup();\n+                groups.put(nodeInfo, group);\n+            }\n+            group.addMember(member);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a18d9822129ad4ba03d066e07841bf00cded42b"}, "originalPosition": 56}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd6e116cb3aad46a157a7a2a818ad94a15c90b75", "author": {"user": {"login": "hasancelik", "name": "Hasan \u00c7elik"}}, "url": "https://github.com/hazelcast/hazelcast/commit/fd6e116cb3aad46a157a7a2a818ad94a15c90b75", "committedDate": "2020-11-30T14:05:23Z", "message": "review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a77634c44b6464bb10b14b96a19f4a6e829c006f", "author": {"user": {"login": "hasancelik", "name": "Hasan \u00c7elik"}}, "url": "https://github.com/hazelcast/hazelcast/commit/a77634c44b6464bb10b14b96a19f4a6e829c006f", "committedDate": "2020-12-01T07:13:24Z", "message": "removed since notation from NodeAwareMemberGroupFactory javadoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "003b58c16a947640218f3d2eaaa16baf17fcf909", "author": {"user": {"login": "hasancelik", "name": "Hasan \u00c7elik"}}, "url": "https://github.com/hazelcast/hazelcast/commit/003b58c16a947640218f3d2eaaa16baf17fcf909", "committedDate": "2020-12-01T11:05:39Z", "message": "added testNodeAwareMemberGroupFactoryThrowsIllegalArgumentExceptionWhenNoMetadataIsProvided"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3144, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}