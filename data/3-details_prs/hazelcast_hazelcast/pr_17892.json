{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI2Nzc1OTQx", "number": 17892, "title": "Improved telemetry 4.2", "bodyText": "Same changes as in #17422 , now targeting the master branch.\nCopying description:\nGSoC 2020 Work:\nThe original commits can be found in the improved-telemetry branch, and this is a squash of those.\nAlong with the minimal information of hazelcast version, java version, operating system, uptime, memory used, Number of clients, Number of clusters, etc. the Phonehome process now also collects the following information-\n\nCount of hazelcast maps with backup read enabled, map store, eviction, at least one query cache, hot restart enabled, at least one index, WAN replication configured, and at least one custom attribute.\nCount of various distributed data structures including sets, queues, multimaps, caches, list, ring buffer, topic, replicated maps, cardinality estimator, PN counter, Flake Id generator.\nThroughput and Latency of MapLoaders and MapStores.\nDetails of the Cloud used for deployment of hazelcast (AWS, Azure, or GCP), also whether it runs in Kubernetes or Docker.\n\nRefactored the initial phonehome code with some necessary changes. Created a global node in the phonehome as the four methods(check() , phoneHome() , createParameters() and addClientInfo()) of the class received same node parameter.To avoid the complications in the PhoneHome class, a MetricsCollector Interface is used, which the various collectors implemented to collect relevant metrics. A common function of computeMetrics(Node node) to collect the metric details in Phonehome, made the design optimal to use.\nMoving onto the integration tests for Phonehome using wire mock, it turned out that the network communication performed by PhoneHome can not be tested. Although if we fake the call home server with wire mock, the endpoint was hardcoded in the phonehome.So to achieve testability, the URL was made parametrizable. Also, to test the latency of maps with a map store, a fake map store(Delay Map Store) is being used, which gives a delay of 200ms to achieve testability. To achieve testability for the cloud details of Hazelcast, we made the CloudInfoCollector parametrized because we had to hardcode the endpoints of the cloud service providers.\nPhoneHomeBenchmark measures the average time by the phonehome process for a node using quite a significant number of data structures(10k maps with different cases and 5k other distributed objects).\nPhoneHomeMetrics enum contains all the details about the keys used for the various metrics for ease.\nFollowing is the list of new metrics that are now being collected by Phonehome-\nMetrics name (Key)\n\nNumber of Maps (mpct)\nNumber of caches (cact)\nNumber of caches with WAN replication configured (cawact)\nNumber of maps with WAN replication configured (mpwact)\nNumber of queues (quct)\nNumber of multimaps (mmct)\nNumber of sets (sect)\nNumber of lists (lict)\nNumber of ring buffers (rbct)\nNumber of maps with backup read enabled (mpbrct)\nNumber of maps using map store (mpmsct)\nNumber of maps using at least one index (mpaoict)\nNumber of maps having at least one custom attribute (mpaocct)\nNumber of maps with at least one query cache (mpaoqcct)\nNumber of maps with hotstart enabled (mphect)\nNumber of maps with eviction (mpevct)\nNumber of maps with native in memory (mpnmct)\nNumber of topics (tpct)\nNumber of replicated Map (rpct)\nNumber of cardinality estimator (cect)\nNumber of FlakeIdgenerator (figct)\nNumber of PNcounter (pncct)\nAverage Put Latency of map with mapstore (mpptlams)\nAverage Put Latency of map without mapstore(mpptla)\nAverage Get Latency of map with mapstore (mpgtlams)\nAverage Get Latency of map without mapstore (mpgtla)\nCloud used for deployment of Hazelcast ( cld is G it means GCP, if A means AWS and if Z it means Azure) and whether use  docker( dck is K if in Kubernetes, if Only docker then it is D and is N if it is not in a docker).\n\nEE: hazelcast/hazelcast-enterprise#3914", "createdAt": "2020-11-24T20:48:05Z", "url": "https://github.com/hazelcast/hazelcast/pull/17892", "merged": true, "mergeCommit": {"oid": "bea98a2fd1cafb35905a272125e164c60d6d2d6c"}, "closed": true, "closedAt": "2021-01-26T12:04:07Z", "author": {"login": "erosb"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdyS-BWgFqTU3MzI0MjUxMA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdz6MqjAFqTU3NjI3NzUyMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTczMjQyNTEw", "url": "https://github.com/hazelcast/hazelcast/pull/17892#pullrequestreview-573242510", "createdAt": "2021-01-21T11:39:29Z", "commit": {"oid": "c7d0cc0e35d54bd4ef08d1d6376be71ae1bcda77"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMVQxMTozOToyOVrOIXyQ1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMVQxMTozOToyOVrOIXyQ1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTgxMTY3MQ==", "bodyText": "Can we switch to HTTPS please?", "url": "https://github.com/hazelcast/hazelcast/pull/17892#discussion_r561811671", "createdAt": "2021-01-21T11:39:29Z", "author": {"login": "kwart"}, "path": "hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/PhoneHome.java", "diffHunk": "@@ -0,0 +1,111 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.hazelcast.internal.util.phonehome;\n+\n+import com.hazelcast.instance.impl.Node;\n+import com.hazelcast.logging.ILogger;\n+import com.hazelcast.spi.properties.ClusterProperty;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.RejectedExecutionException;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import static java.lang.System.getenv;\n+\n+/**\n+ * Pings phone home server with cluster info daily.\n+ */\n+public class PhoneHome {\n+\n+    private static final String FALSE = \"false\";\n+    private static final String DEFAULT_BASE_PHONE_HOME_URL = \"http://phonehome.hazelcast.com/ping\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c7d0cc0e35d54bd4ef08d1d6376be71ae1bcda77"}, "originalPosition": 38}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c7d0cc0e35d54bd4ef08d1d6376be71ae1bcda77", "author": {"user": {"login": "erosb", "name": "Bence Eros"}}, "url": "https://github.com/hazelcast/hazelcast/commit/c7d0cc0e35d54bd4ef08d1d6376be71ae1bcda77", "committedDate": "2020-11-25T11:50:25Z", "message": "changing wiremock-based tests not to be parallel, so that they do not fail due to port 8080 being already used"}, "afterCommit": {"oid": "fadc5ad3803e60aae976c3986aae64dcf46dfc70", "author": {"user": {"login": "chanmol1999", "name": "Anmol Chaddha"}}, "url": "https://github.com/hazelcast/hazelcast/commit/fadc5ad3803e60aae976c3986aae64dcf46dfc70", "committedDate": "2021-01-25T14:52:42Z", "message": "Improved telemetry"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef1f7244608b53ce2b91b2b3e27b451aa0a5fcdc", "author": {"user": {"login": "chanmol1999", "name": "Anmol Chaddha"}}, "url": "https://github.com/hazelcast/hazelcast/commit/ef1f7244608b53ce2b91b2b3e27b451aa0a5fcdc", "committedDate": "2021-01-25T15:31:13Z", "message": "Improved telemetry"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fadc5ad3803e60aae976c3986aae64dcf46dfc70", "author": {"user": {"login": "chanmol1999", "name": "Anmol Chaddha"}}, "url": "https://github.com/hazelcast/hazelcast/commit/fadc5ad3803e60aae976c3986aae64dcf46dfc70", "committedDate": "2021-01-25T14:52:42Z", "message": "Improved telemetry"}, "afterCommit": {"oid": "7ee9ea21fcb2c6bf33aca79687827bbad94ac686", "author": {"user": {"login": "mmedenjak", "name": "Matko Medenjak"}}, "url": "https://github.com/hazelcast/hazelcast/commit/7ee9ea21fcb2c6bf33aca79687827bbad94ac686", "committedDate": "2021-01-25T15:42:39Z", "message": "Improved telemetry"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTc1NjA0ODcz", "url": "https://github.com/hazelcast/hazelcast/pull/17892#pullrequestreview-575604873", "createdAt": "2021-01-25T16:59:42Z", "commit": {"oid": "7ee9ea21fcb2c6bf33aca79687827bbad94ac686"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yNVQxNjo1OTo0MlrOIZwt6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yNVQxNjo1OTo0MlrOIZwt6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Mzg4MzQ5OA==", "bodyText": "Why doesn't CLIENT_ENDPOINT_COUNT go to the ClientInfoCollector?", "url": "https://github.com/hazelcast/hazelcast/pull/17892#discussion_r563883498", "createdAt": "2021-01-25T16:59:42Z", "author": {"login": "mmedenjak"}, "path": "hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/BuildInfoCollector.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.hazelcast.internal.util.phonehome;\n+\n+import com.hazelcast.instance.BuildInfo;\n+import com.hazelcast.instance.BuildInfoProvider;\n+import com.hazelcast.instance.JetBuildInfo;\n+import com.hazelcast.instance.impl.Node;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Properties;\n+\n+import static com.hazelcast.internal.nio.IOUtil.closeResource;\n+import static com.hazelcast.internal.util.EmptyStatement.ignore;\n+\n+class BuildInfoCollector implements MetricsCollector {\n+\n+    @Override\n+    public Map<PhoneHomeMetrics, String> computeMetrics(Node hazelcastNode) {\n+        BuildInfo build = BuildInfoProvider.getBuildInfo();\n+        Map<PhoneHomeMetrics, String> buildInfo = new HashMap<>();\n+        JetBuildInfo jetBuildInfo = hazelcastNode.getBuildInfo().getJetBuildInfo();\n+        buildInfo.put(PhoneHomeMetrics.HAZELCAST_DOWNLOAD_ID, getDownloadId());\n+        buildInfo.put(PhoneHomeMetrics.CLIENT_ENDPOINT_COUNT,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ee9ea21fcb2c6bf33aca79687827bbad94ac686"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e676e203689bf2e24084f0f073e6f47fb93d934e", "author": {"user": {"login": "mmedenjak", "name": "Matko Medenjak"}}, "url": "https://github.com/hazelcast/hazelcast/commit/e676e203689bf2e24084f0f073e6f47fb93d934e", "committedDate": "2021-01-25T19:23:01Z", "message": "Minor cleanup\n\n- add runner for integration test\n- add generics\n- avoid creating maps for collecting metrics\n- code cleanup and reformatting"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7ee9ea21fcb2c6bf33aca79687827bbad94ac686", "author": {"user": {"login": "mmedenjak", "name": "Matko Medenjak"}}, "url": "https://github.com/hazelcast/hazelcast/commit/7ee9ea21fcb2c6bf33aca79687827bbad94ac686", "committedDate": "2021-01-25T15:42:39Z", "message": "Improved telemetry"}, "afterCommit": {"oid": "e676e203689bf2e24084f0f073e6f47fb93d934e", "author": {"user": {"login": "mmedenjak", "name": "Matko Medenjak"}}, "url": "https://github.com/hazelcast/hazelcast/commit/e676e203689bf2e24084f0f073e6f47fb93d934e", "committedDate": "2021-01-25T19:23:01Z", "message": "Minor cleanup\n\n- add runner for integration test\n- add generics\n- avoid creating maps for collecting metrics\n- code cleanup and reformatting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9cdaa95633e6b1abf31e0bf4542780da50e5c8d5", "author": {"user": {"login": "mmedenjak", "name": "Matko Medenjak"}}, "url": "https://github.com/hazelcast/hazelcast/commit/9cdaa95633e6b1abf31e0bf4542780da50e5c8d5", "committedDate": "2021-01-25T20:38:51Z", "message": "Fix test runner"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aadd9004a9a7e654fb2ef64435ed21752ae2ced3", "author": {"user": {"login": "mmedenjak", "name": "Matko Medenjak"}}, "url": "https://github.com/hazelcast/hazelcast/commit/aadd9004a9a7e654fb2ef64435ed21752ae2ced3", "committedDate": "2021-01-25T21:03:10Z", "message": "Checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTc2MTA0NDA2", "url": "https://github.com/hazelcast/hazelcast/pull/17892#pullrequestreview-576104406", "createdAt": "2021-01-26T08:12:00Z", "commit": {"oid": "aadd9004a9a7e654fb2ef64435ed21752ae2ced3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fce44b3ed9b85ec2416ae2f857995d7a689db64f", "author": {"user": {"login": "erosb", "name": "Bence Eros"}}, "url": "https://github.com/hazelcast/hazelcast/commit/fce44b3ed9b85ec2416ae2f857995d7a689db64f", "committedDate": "2021-01-26T10:22:38Z", "message": "moving collection of CLIENT_ENDPOINT_COUNT metric to ClientInfoCollector (addressing PR comment)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTc2Mjc3NTIz", "url": "https://github.com/hazelcast/hazelcast/pull/17892#pullrequestreview-576277523", "createdAt": "2021-01-26T11:55:42Z", "commit": {"oid": "aadd9004a9a7e654fb2ef64435ed21752ae2ced3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3150, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}