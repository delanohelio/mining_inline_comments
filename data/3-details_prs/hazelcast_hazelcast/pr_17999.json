{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ0ODgzMjcx", "number": 17999, "title": "Changes to SQL expressions needed for Jet", "bodyText": "", "createdAt": "2020-12-23T14:56:49Z", "url": "https://github.com/hazelcast/hazelcast/pull/17999", "merged": true, "mergeCommit": {"oid": "0bffff1e7c17789761ef205e7379de0043dd9bdf"}, "closed": true, "closedAt": "2021-01-21T16:09:22Z", "author": {"login": "viliam-durina"}, "timelineItems": {"totalCount": 30, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdpAZ6ZAH2gAyNTQ0ODgzMjcxOjQ2ODQzYzY2NDgyODZkNWRlMzMzOTJlMTNhYTEzMDJlMDg4ZTVkM2Q=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdyWKB_gFqTU3MzQ0MDAxNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "46843c6648286d5de33392e13aa1302e088e5d3d", "author": {"user": {"login": "viliam-durina", "name": "Viliam Durina"}}, "url": "https://github.com/hazelcast/hazelcast/commit/46843c6648286d5de33392e13aa1302e088e5d3d", "committedDate": "2020-12-23T14:56:26Z", "message": "Changes to SQL expressions needed for Jet"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3941febb7223608df5fa95d4bb1a41e267075ece", "author": {"user": {"login": "viliam-durina", "name": "Viliam Durina"}}, "url": "https://github.com/hazelcast/hazelcast/commit/3941febb7223608df5fa95d4bb1a41e267075ece", "committedDate": "2020-12-23T14:56:28Z", "message": "Unrelated javadoc fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e66e76b512f867400d8aa48519d210599de5069", "author": {"user": {"login": "viliam-durina", "name": "Viliam Durina"}}, "url": "https://github.com/hazelcast/hazelcast/commit/1e66e76b512f867400d8aa48519d210599de5069", "committedDate": "2020-12-23T14:56:30Z", "message": "Fix style"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c623c6d3ecf7499c9a66bedb4f980fb931c052f", "author": {"user": {"login": "viliam-durina", "name": "Viliam Durina"}}, "url": "https://github.com/hazelcast/hazelcast/commit/3c623c6d3ecf7499c9a66bedb4f980fb931c052f", "committedDate": "2020-12-23T22:31:30Z", "message": "Grammar fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6394fb8904bf0459928f066351637880b7d6124a", "author": {"user": {"login": "viliam-durina", "name": "Viliam Durina"}}, "url": "https://github.com/hazelcast/hazelcast/commit/6394fb8904bf0459928f066351637880b7d6124a", "committedDate": "2020-12-23T23:06:11Z", "message": "Use explicit cast when inferOperandTypes changes the type"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1c7365d31ba323c680547bea42c3ad8b676c3592", "author": {"user": {"login": "viliam-durina", "name": "Viliam Durina"}}, "url": "https://github.com/hazelcast/hazelcast/commit/1c7365d31ba323c680547bea42c3ad8b676c3592", "committedDate": "2020-12-23T23:03:48Z", "message": "Use explicit cast when inferOperandTypes changes the type"}, "afterCommit": {"oid": "6394fb8904bf0459928f066351637880b7d6124a", "author": {"user": {"login": "viliam-durina", "name": "Viliam Durina"}}, "url": "https://github.com/hazelcast/hazelcast/commit/6394fb8904bf0459928f066351637880b7d6124a", "committedDate": "2020-12-23T23:06:11Z", "message": "Use explicit cast when inferOperandTypes changes the type"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5MDg0NjU2", "url": "https://github.com/hazelcast/hazelcast/pull/17999#pullrequestreview-559084656", "createdAt": "2020-12-28T10:26:45Z", "commit": {"oid": "6394fb8904bf0459928f066351637880b7d6124a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOFQxMDoyNjo0NlrOIL2XfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOFQxMDoyNjo0NlrOIL2XfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTI5NTk5Ng==", "bodyText": "What is the result of sql-to-rex conversion of the SqlNode with the SqlKind.DEFAULT?", "url": "https://github.com/hazelcast/hazelcast/pull/17999#discussion_r549295996", "createdAt": "2020-12-28T10:26:46Z", "author": {"login": "devozerov"}, "path": "hazelcast-sql-core/src/main/java/com/hazelcast/sql/impl/calcite/HazelcastSqlToRelConverter.java", "diffHunk": "@@ -169,19 +169,24 @@ private RexNode convertCast(SqlCall call, Blackboard blackboard) {\n \n     /**\n      * This method overcomes a bug in Apache Calcite that ignores previously resolved return types of the expression\n-     * and instead attempts to infer them again using different logic. Without this fix, we will get type resolution\n-     * errors after SQL-to-rel conversion.\n+     * and instead attempts to infer them again using a different logic. Without this fix, we will get type resolution\n+     * errors after a SQL-to-rel conversion.\n      * <p>\n      * The method relies on the fact that all operators use {@link HazelcastReturnTypeInference} as a top-level return type\n      * inference method.\n      * <ul>\n-     *     <li>When a call node is observed for the first time, get it's return type and save it to a thread local variable</li>\n-     *     <li>Then delegate back to original converter code</li>\n-     *     <li>When converter attempts to resolve the return type of a call, he will get the previously saved type from\n-     *     the thread-local variable</li>\n+     *     <li>When a call node is observed for the first time, get its return type and save it to a thread-local variable\n+     *     <li>Then delegate back to original converter code\n+     *     <li>When converter attempts to resolve the return type of a call, it will get the previously saved type from\n+     *     the thread-local variable\n      * </ul>\n      */\n     private RexNode convertCall(SqlNode node, Blackboard blackboard) {\n+        // ignore DEFAULT (used for default function arguments). It doesn't support getValidatedNodeType()\n+        if (node.getKind() == SqlKind.DEFAULT) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6394fb8904bf0459928f066351637880b7d6124a"}, "originalPosition": 60}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5MDg1MzA5", "url": "https://github.com/hazelcast/hazelcast/pull/17999#pullrequestreview-559085309", "createdAt": "2020-12-28T10:28:44Z", "commit": {"oid": "6394fb8904bf0459928f066351637880b7d6124a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOFQxMDoyODo0NFrOIL2Zzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOFQxMDoyODo0NFrOIL2Zzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTI5NjU5MQ==", "bodyText": "Could you please remind me in which case the delegate could be null?", "url": "https://github.com/hazelcast/hazelcast/pull/17999#discussion_r549296591", "createdAt": "2020-12-28T10:28:44Z", "author": {"login": "devozerov"}, "path": "hazelcast-sql-core/src/main/java/com/hazelcast/sql/impl/calcite/validate/operators/HazelcastReturnTypeInference.java", "diffHunk": "@@ -27,34 +28,40 @@\n import org.apache.calcite.sql.SqlOperatorBinding;\n import org.apache.calcite.sql.type.SqlReturnTypeInference;\n \n+import javax.annotation.Nullable;\n import java.util.ArrayDeque;\n import java.util.Deque;\n \n /**\n- * The inference strategy that allows to thransfer return type info between validation and conversion phases.\n+ * The inference strategy that allows to transfer the return type info between validation and conversion phases.\n  * <p>\n- * When doing sql-to-rel conversion Apache Calcite ignores information about the inferred return types from the validation\n+ * When doing sql-to-rel conversion, Apache Calcite ignores information about the inferred return types from the validation\n  * phase. To fix this, we intercept {@link SqlCall} conversions in the {@link HazelcastSqlToRelConverter}, lookup the\n- * real return type, and put it to the thread-local. Then, when the return type inference is invoked again during the\n- * conversion phase, it uses the information from the thread-local, rather than trying to infer again.\n+ * real return type, and put it to thread-local stack. Then, when the return type inference is invoked again during the\n+ * conversion phase, it peeks the thread-local stack, rather than trying to infer again.\n  * <p>\n  * In order for this workaround to work, every operator must have {@code HazelcastReturnTypeInference} as a\n  * return type inference strategy. This is controlled by the automated test. To simplify the development of operators,\n  * we create a number of base operator classes that set the required return type inference: {@link HazelcastFunction},\n  * {@link HazelcastPrefixOperator}, {@link HazelcastPostfixOperator}, {@link HazelcastBinaryOperator},\n- * {@link HazelcastSpecialOperator}. Every defined operator should extend one of these classes.\n+ * {@link HazelcastSpecialOperator}, {@link HazelcastAggFunction}. Every defined operator should extend one of these\n+ * classes.\n  */\n public final class HazelcastReturnTypeInference implements SqlReturnTypeInference {\n \n-    private static final ThreadLocal<Deque<RelDataType>> QUEUE = new ThreadLocal<>();\n+    private static final ThreadLocal<Deque<RelDataType>> QUEUE = ThreadLocal.withInitial(() -> new ArrayDeque<>(2));\n \n     private final SqlReturnTypeInference delegate;\n \n     private HazelcastReturnTypeInference(SqlReturnTypeInference delegate) {\n         this.delegate = delegate;\n     }\n \n-    public static HazelcastReturnTypeInference wrap(SqlReturnTypeInference delegate) {\n+    @Nullable\n+    public static HazelcastReturnTypeInference wrap(@Nullable SqlReturnTypeInference delegate) {\n+        if (delegate == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6394fb8904bf0459928f066351637880b7d6124a"}, "originalPosition": 50}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5MDg1Njc4", "url": "https://github.com/hazelcast/hazelcast/pull/17999#pullrequestreview-559085678", "createdAt": "2020-12-28T10:29:50Z", "commit": {"oid": "6394fb8904bf0459928f066351637880b7d6124a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOFQxMDoyOTo1MFrOIL2bCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOFQxMDoyOTo1MFrOIL2bCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTI5NjkwNg==", "bodyText": "I do not like that COUNT(*) leaks into a general-purpose ReplaceUnknownOperandTypeInference. Let's use another specialized implementation for ReplaceUnknownOperandTypeInference instead.", "url": "https://github.com/hazelcast/hazelcast/pull/17999#discussion_r549296906", "createdAt": "2020-12-28T10:29:50Z", "author": {"login": "devozerov"}, "path": "hazelcast-sql-core/src/main/java/com/hazelcast/sql/impl/calcite/validate/operators/ReplaceUnknownOperandTypeInference.java", "diffHunk": "@@ -51,6 +51,10 @@ public ReplaceUnknownOperandTypeInference(SqlTypeName[] typeNames, SqlTypeName d\n \n     @Override\n     public void inferOperandTypes(SqlCallBinding callBinding, RelDataType returnType, RelDataType[] operandTypes) {\n+        if (callBinding.getCall().isCountStar()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6394fb8904bf0459928f066351637880b7d6124a"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5MDg2Mjgw", "url": "https://github.com/hazelcast/hazelcast/pull/17999#pullrequestreview-559086280", "createdAt": "2020-12-28T10:31:28Z", "commit": {"oid": "6394fb8904bf0459928f066351637880b7d6124a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOFQxMDozMToyOFrOIL2dCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOFQxMDozMToyOFrOIL2dCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTI5NzQxNg==", "bodyText": "This should not be there. Coercion is specific to operators and should not be enforced on the global level.", "url": "https://github.com/hazelcast/hazelcast/pull/17999#discussion_r549297416", "createdAt": "2020-12-28T10:31:28Z", "author": {"login": "devozerov"}, "path": "hazelcast-sql-core/src/main/java/com/hazelcast/sql/impl/calcite/validate/operators/common/HazelcastOperandTypeCheckerAware.java", "diffHunk": "@@ -73,6 +73,9 @@ default HazelcastCallBinding prepareBinding(SqlCallBinding binding) {\n             operandTypeInference.inferOperandTypes(binding, binding.getValidator().getUnknownType(), operandTypes);\n \n             for (int i = 0; i < binding.getOperandCount(); i++) {\n+                if (binding.getOperandType(i).getSqlTypeName() != operandTypes[i].getSqlTypeName()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6394fb8904bf0459928f066351637880b7d6124a"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5MDg3NDYx", "url": "https://github.com/hazelcast/hazelcast/pull/17999#pullrequestreview-559087461", "createdAt": "2020-12-28T10:35:01Z", "commit": {"oid": "6394fb8904bf0459928f066351637880b7d6124a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOFQxMDozNTowMlrOIL2hEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOFQxMDozNTowMlrOIL2hEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTI5ODQ1MQ==", "bodyText": "rowTypeCoercion, querySourceCoercion, and other similar methods are added here to ensure that we never rely on Calcite's coercion logic, but instead provide our own. Removal of these methods means that we again rely on Calcite, breaking the whole idea of controllable operator behavior.\nInstead, we should ensure that these functions are never invoked by providing the proper type checking implementations to the required operators.", "url": "https://github.com/hazelcast/hazelcast/pull/17999#discussion_r549298451", "createdAt": "2020-12-28T10:35:02Z", "author": {"login": "devozerov"}, "path": "hazelcast-sql-core/src/main/java/com/hazelcast/sql/impl/calcite/validate/types/HazelcastTypeCoercion.java", "diffHunk": "@@ -100,11 +98,6 @@ public boolean binaryComparisonCoercion(SqlCallBinding binding) {\n         throw new UnsupportedOperationException(\"Should not be called\");\n     }\n \n-    @Override\n-    public boolean rowTypeCoercion(SqlValidatorScope scope, SqlNode query, int columnIndex, RelDataType targetType) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6394fb8904bf0459928f066351637880b7d6124a"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5MDg4MTA4", "url": "https://github.com/hazelcast/hazelcast/pull/17999#pullrequestreview-559088108", "createdAt": "2020-12-28T10:36:59Z", "commit": {"oid": "6394fb8904bf0459928f066351637880b7d6124a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOFQxMDozNjo1OVrOIL2juQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOFQxMDozNjo1OVrOIL2juQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTI5OTEyOQ==", "bodyText": "This change is incorrect. We add CAST only when type names are different. If type names are equal, but types are different (e.g. BIGINT(63) vs BIGINT(64)), we only update the operand type in the validator. See usages of HazelcastTypeCoercion.coerceOperandType.", "url": "https://github.com/hazelcast/hazelcast/pull/17999#discussion_r549299129", "createdAt": "2020-12-28T10:36:59Z", "author": {"login": "devozerov"}, "path": "hazelcast-sql-core/src/main/java/com/hazelcast/sql/impl/calcite/validate/types/HazelcastTypeCoercion.java", "diffHunk": "@@ -79,15 +79,13 @@ public boolean coerceOperandType(SqlValidatorScope scope, SqlCall call, int inde\n     private boolean requiresCast(SqlValidatorScope scope, SqlNode node, RelDataType to) {\n         RelDataType from = validator.deriveType(scope, node);\n \n-        assert from.isNullable() == to.isNullable();\n-\n         if (from.getSqlTypeName() == NULL || SqlUtil.isNullLiteral(node, false) || node.getKind() == SqlKind.DYNAMIC_PARAM) {\n             // Never cast NULLs or dynamic params, just assign types to them\n             return false;\n         }\n \n         // CAST is only required between different types.\n-        return from.getSqlTypeName() != to.getSqlTypeName();\n+        return !from.equals(to);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6394fb8904bf0459928f066351637880b7d6124a"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5MDg4ODI1", "url": "https://github.com/hazelcast/hazelcast/pull/17999#pullrequestreview-559088825", "createdAt": "2020-12-28T10:39:05Z", "commit": {"oid": "6394fb8904bf0459928f066351637880b7d6124a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOFQxMDozOTowNVrOIL2mNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOFQxMDozOTowNVrOIL2mNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTI5OTc2Nw==", "bodyText": "Changes to ReplicatedMap, NamedOperation, BaseInvocation, and MessageListener are not relevant to this PR and the SQL engine as a whole. I would propose to apply them in a separate PR to avoid mixing changes to unrelated parts of the product in a single PR.", "url": "https://github.com/hazelcast/hazelcast/pull/17999#discussion_r549299767", "createdAt": "2020-12-28T10:39:05Z", "author": {"login": "devozerov"}, "path": "hazelcast/src/main/java/com/hazelcast/topic/MessageListener.java", "diffHunk": "@@ -20,23 +20,23 @@\n \n /**\n  * Message listener for {@link ITopic}.\n- *\n- * Provided that a MessageListener is not registered twice, a MessageListener will never be called concurrently. So there\n- * is no need to provide thread-safety on internal state in the MessageListener. Also there is no need to enforce safe\n- * publication, the ITopic is responsible for the memory consistency effects. In other words, there is no need to make\n+ * <p>\n+ * A MessageListener will never be called concurrently (provided that it's not registered twice). So there\n+ * is no need to synchronize access to the internal state in the MessageListener. Also there is no need to enforce\n+ * safe publication, the ITopic is responsible for memory consistency effects. In other words, there is no need to make\n  * internal fields of the MessageListener volatile or access them using synchronized blocks.\n  *\n- * @param <E> message\n+ * @param <E> message type\n  */\n @FunctionalInterface\n public interface MessageListener<E> extends EventListener {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6394fb8904bf0459928f066351637880b7d6124a"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "809f2fa4f562f3a41457dca38d23a7346255a3fe", "author": {"user": {"login": "viliam-durina", "name": "Viliam Durina"}}, "url": "https://github.com/hazelcast/hazelcast/commit/809f2fa4f562f3a41457dca38d23a7346255a3fe", "committedDate": "2020-12-29T11:00:10Z", "message": "Remove space before comma"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d9fa71594ce393e4694977d216cf7088f324974", "author": {"user": {"login": "viliam-durina", "name": "Viliam Durina"}}, "url": "https://github.com/hazelcast/hazelcast/commit/5d9fa71594ce393e4694977d216cf7088f324974", "committedDate": "2020-12-29T14:08:42Z", "message": "Remove the hack for COUNT(*)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d44f28f006353cd553090818b10583bc0590c7c", "author": {"user": {"login": "viliam-durina", "name": "Viliam Durina"}}, "url": "https://github.com/hazelcast/hazelcast/commit/8d44f28f006353cd553090818b10583bc0590c7c", "committedDate": "2020-12-29T14:31:48Z", "message": "Remove contested changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "405c18bdff739180801bd295af8b25c0be644ee9", "author": {"user": {"login": "viliam-durina", "name": "Viliam Durina"}}, "url": "https://github.com/hazelcast/hazelcast/commit/405c18bdff739180801bd295af8b25c0be644ee9", "committedDate": "2020-12-29T14:33:13Z", "message": "Remove unrelated typo fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e8433d4093a98dbac24adc0f7d45a09e91ecc01", "author": {"user": {"login": "viliam-durina", "name": "Viliam Durina"}}, "url": "https://github.com/hazelcast/hazelcast/commit/7e8433d4093a98dbac24adc0f7d45a09e91ecc01", "committedDate": "2020-12-29T14:43:55Z", "message": "Merge branch 'master' into jet-expressions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e471a5c3a5d0ebcdc5a887b3a173eaefbea48030", "author": {"user": {"login": "viliam-durina", "name": "Viliam Durina"}}, "url": "https://github.com/hazelcast/hazelcast/commit/e471a5c3a5d0ebcdc5a887b3a173eaefbea48030", "committedDate": "2021-01-04T10:32:50Z", "message": "Final changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d5a581f412e42787ad602b24e77362680231571", "author": {"user": {"login": "viliam-durina", "name": "Viliam Durina"}}, "url": "https://github.com/hazelcast/hazelcast/commit/4d5a581f412e42787ad602b24e77362680231571", "committedDate": "2021-01-11T15:41:34Z", "message": "Merge remote-tracking branch 'remotes/hazelcast/master' into jet-expressions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY1NDgzNTky", "url": "https://github.com/hazelcast/hazelcast/pull/17999#pullrequestreview-565483592", "createdAt": "2021-01-11T15:46:07Z", "commit": {"oid": "7e8433d4093a98dbac24adc0f7d45a09e91ecc01"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQxNTo0NjowN1rOIRbBow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQxNTo0NjowN1rOIRbBow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTEzOTQ5MQ==", "bodyText": "If we use this constructor, we do not wrap the return type inference, which means that we may lose the return type inferred during the validation. All our constructors should have a non-null inference strategy wrapped with HazelcastReturnTypeInference.wrap.", "url": "https://github.com/hazelcast/hazelcast/pull/17999#discussion_r555139491", "createdAt": "2021-01-11T15:46:07Z", "author": {"login": "devozerov"}, "path": "hazelcast-sql-core/src/main/java/com/hazelcast/sql/impl/calcite/validate/operators/common/HazelcastSpecialOperator.java", "diffHunk": "@@ -31,6 +31,13 @@\n  * See {@link HazelcastOperandTypeCheckerAware} for motivation.\n  */\n public abstract class HazelcastSpecialOperator extends SqlSpecialOperator implements HazelcastOperandTypeCheckerAware {\n+    protected HazelcastSpecialOperator(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e8433d4093a98dbac24adc0f7d45a09e91ecc01"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY1NDkwMjY0", "url": "https://github.com/hazelcast/hazelcast/pull/17999#pullrequestreview-565490264", "createdAt": "2021-01-11T15:49:26Z", "commit": {"oid": "7e8433d4093a98dbac24adc0f7d45a09e91ecc01"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQxNTo0OToyNlrOIRbLUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQxNTo0OToyNlrOIRbLUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTE0MTk2OA==", "bodyText": "Is there a reason to limit all aggregate operators to a single operand only? I think this should be decided on a per-operator basis (e.g. see LISTAGG function).", "url": "https://github.com/hazelcast/hazelcast/pull/17999#discussion_r555141968", "createdAt": "2021-01-11T15:49:26Z", "author": {"login": "devozerov"}, "path": "hazelcast-sql-core/src/main/java/com/hazelcast/sql/impl/calcite/validate/operators/common/HazelcastAggFunction.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.sql.impl.calcite.validate.operators.common;\n+\n+import com.hazelcast.sql.impl.calcite.validate.HazelcastCallBinding;\n+import org.apache.calcite.sql.SqlAggFunction;\n+import org.apache.calcite.sql.SqlCallBinding;\n+import org.apache.calcite.sql.SqlFunctionCategory;\n+import org.apache.calcite.sql.SqlKind;\n+import org.apache.calcite.sql.SqlOperandCountRange;\n+import org.apache.calcite.sql.type.SqlOperandCountRanges;\n+import org.apache.calcite.sql.type.SqlOperandTypeChecker;\n+import org.apache.calcite.sql.type.SqlOperandTypeInference;\n+import org.apache.calcite.sql.type.SqlReturnTypeInference;\n+import org.apache.calcite.util.Optionality;\n+\n+import static com.hazelcast.sql.impl.calcite.validate.operators.HazelcastReturnTypeInference.wrap;\n+\n+/**\n+ * A common subclass for aggregate functions (in Jet).\n+ * <p>\n+ * See {@link HazelcastOperandTypeCheckerAware} for motivation.\n+ */\n+public abstract class HazelcastAggFunction extends SqlAggFunction implements HazelcastOperandTypeCheckerAware {\n+\n+    public HazelcastAggFunction(\n+            String name,\n+            SqlKind kind,\n+            SqlReturnTypeInference returnTypeInference,\n+            SqlOperandTypeInference operandTypeInference,\n+            SqlOperandTypeChecker operandTypeChecker,\n+            SqlFunctionCategory funcType,\n+            boolean requiresOrder,\n+            boolean requiresOver,\n+            Optionality requiresGroupOrder\n+    ) {\n+        super(name, null, kind, wrap(returnTypeInference), operandTypeInference, operandTypeChecker,\n+                funcType, requiresOrder, requiresOver, requiresGroupOrder);\n+    }\n+\n+    @Override\n+    public final boolean checkOperandTypes(SqlCallBinding callBinding, boolean throwOnFailure) {\n+        HazelcastCallBinding bindingOverride = prepareBinding(callBinding);\n+\n+        return checkOperandTypes(bindingOverride, throwOnFailure);\n+    }\n+\n+    @Override\n+    public SqlOperandCountRange getOperandCountRange() {\n+        return SqlOperandCountRanges.between(1, 1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e8433d4093a98dbac24adc0f7d45a09e91ecc01"}, "originalPosition": 64}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY1NDkyNDI5", "url": "https://github.com/hazelcast/hazelcast/pull/17999#pullrequestreview-565492429", "createdAt": "2021-01-11T15:51:37Z", "commit": {"oid": "7e8433d4093a98dbac24adc0f7d45a09e91ecc01"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQxNTo1MTozN1rOIRbWLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQxNTo1MTozN1rOIRbWLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTE0NDc1MQ==", "bodyText": "In which cases an operandTypeInference could be null? Generally, this should never happen, because otherwise, we may miss some inferred types of the children nodes, as explained in the JavaDoc.", "url": "https://github.com/hazelcast/hazelcast/pull/17999#discussion_r555144751", "createdAt": "2021-01-11T15:51:37Z", "author": {"login": "devozerov"}, "path": "hazelcast-sql-core/src/main/java/com/hazelcast/sql/impl/calcite/validate/operators/common/HazelcastOperandTypeCheckerAware.java", "diffHunk": "@@ -70,10 +70,12 @@ default HazelcastCallBinding prepareBinding(SqlCallBinding binding) {\n             RelDataType[] operandTypes = new RelDataType[binding.getOperandCount()];\n             Arrays.fill(operandTypes, unknownType);\n \n-            operandTypeInference.inferOperandTypes(binding, binding.getValidator().getUnknownType(), operandTypes);\n+            if (operandTypeInference != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e8433d4093a98dbac24adc0f7d45a09e91ecc01"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea8644ba78967e931323f8c8f217a35113202ab1", "author": {"user": {"login": "viliam-durina", "name": "Viliam Durina"}}, "url": "https://github.com/hazelcast/hazelcast/commit/ea8644ba78967e931323f8c8f217a35113202ab1", "committedDate": "2021-01-12T09:58:58Z", "message": "Add more explanation for DEFAULT"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY2MTEzMDY5", "url": "https://github.com/hazelcast/hazelcast/pull/17999#pullrequestreview-566113069", "createdAt": "2021-01-12T10:05:29Z", "commit": {"oid": "ea8644ba78967e931323f8c8f217a35113202ab1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47532dbf0d772366835e927eb757056549cde93f", "author": {"user": {"login": "viliam-durina", "name": "Viliam Durina"}}, "url": "https://github.com/hazelcast/hazelcast/commit/47532dbf0d772366835e927eb757056549cde93f", "committedDate": "2021-01-14T08:13:28Z", "message": "Merge branch 'master' into jet-expressions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03efb874912afcc326d5073b25ebe0f2fee62661", "author": {"user": {"login": "viliam-durina", "name": "Viliam Durina"}}, "url": "https://github.com/hazelcast/hazelcast/commit/03efb874912afcc326d5073b25ebe0f2fee62661", "committedDate": "2021-01-19T14:45:13Z", "message": "Merge branch 'master' into jet-expressions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e56e1a4471ff32a9dc1e1fb9c9933b4f7e039faf", "author": {"user": {"login": "viliam-durina", "name": "Viliam Durina"}}, "url": "https://github.com/hazelcast/hazelcast/commit/e56e1a4471ff32a9dc1e1fb9c9933b4f7e039faf", "committedDate": "2021-01-20T15:39:53Z", "message": "Make operandTypeInference mandatory"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d2316582d409d320163df3385836d8198ab2b16", "author": {"user": {"login": "viliam-durina", "name": "Viliam Durina"}}, "url": "https://github.com/hazelcast/hazelcast/commit/9d2316582d409d320163df3385836d8198ab2b16", "committedDate": "2021-01-21T14:21:18Z", "message": "Remove null ReturnTypeInference"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTczNDQwMDE0", "url": "https://github.com/hazelcast/hazelcast/pull/17999#pullrequestreview-573440014", "createdAt": "2021-01-21T15:22:19Z", "commit": {"oid": "9d2316582d409d320163df3385836d8198ab2b16"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3052, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}