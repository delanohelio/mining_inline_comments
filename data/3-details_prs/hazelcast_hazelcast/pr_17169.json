{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQzNTk2MTM4", "number": 17169, "title": "Put node wide map loader limit", "bodyText": "closes #17164", "createdAt": "2020-07-02T15:33:58Z", "url": "https://github.com/hazelcast/hazelcast/pull/17169", "merged": true, "mergeCommit": {"oid": "f1883f57d65d39a2874ec9b0629d22b3f3b6e759"}, "closed": true, "closedAt": "2020-09-08T09:05:19Z", "author": {"login": "ahmetmircik"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc_ulMPABqjM2NjA4OTAxMzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdGzsJ1AFqTQ4MzkyOTcyMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "21237238695e819d14b8c9def0a358f26e84a09e", "author": {"user": {"login": "ahmetmircik", "name": "Ahmet Mircik"}}, "url": "https://github.com/hazelcast/hazelcast/commit/21237238695e819d14b8c9def0a358f26e84a09e", "committedDate": "2020-07-02T16:06:33Z", "message": "Fix checkstyle"}, "afterCommit": {"oid": "9805c5adf2bca759e211ab1f8a3624fe9e370cab", "author": {"user": {"login": "ahmetmircik", "name": "Ahmet Mircik"}}, "url": "https://github.com/hazelcast/hazelcast/commit/9805c5adf2bca759e211ab1f8a3624fe9e370cab", "committedDate": "2020-08-17T08:59:10Z", "message": "Put node wide map loader limit"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9805c5adf2bca759e211ab1f8a3624fe9e370cab", "author": {"user": {"login": "ahmetmircik", "name": "Ahmet Mircik"}}, "url": "https://github.com/hazelcast/hazelcast/commit/9805c5adf2bca759e211ab1f8a3624fe9e370cab", "committedDate": "2020-08-17T08:59:10Z", "message": "Put node wide map loader limit"}, "afterCommit": {"oid": "e4a0d60434459b3ca4e6942a59031f35fd3e7425", "author": {"user": {"login": "ahmetmircik", "name": "Ahmet Mircik"}}, "url": "https://github.com/hazelcast/hazelcast/commit/e4a0d60434459b3ca4e6942a59031f35fd3e7425", "committedDate": "2020-08-19T09:28:29Z", "message": "Put node wide map loader limit"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e4a0d60434459b3ca4e6942a59031f35fd3e7425", "author": {"user": {"login": "ahmetmircik", "name": "Ahmet Mircik"}}, "url": "https://github.com/hazelcast/hazelcast/commit/e4a0d60434459b3ca4e6942a59031f35fd3e7425", "committedDate": "2020-08-19T09:28:29Z", "message": "Put node wide map loader limit"}, "afterCommit": {"oid": "373369f304e15d7589c727fd3c95b1f2b3039a38", "author": {"user": {"login": "ahmetmircik", "name": "Ahmet Mircik"}}, "url": "https://github.com/hazelcast/hazelcast/commit/373369f304e15d7589c727fd3c95b1f2b3039a38", "committedDate": "2020-08-27T18:05:13Z", "message": "Put node wide map loader limit"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5NTQyMDc2", "url": "https://github.com/hazelcast/hazelcast/pull/17169#pullrequestreview-479542076", "createdAt": "2020-09-01T09:05:59Z", "commit": {"oid": "373369f304e15d7589c727fd3c95b1f2b3039a38"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwOTowNTo1OVrOHKtF_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwOTowNTo1OVrOHKtF_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDk4NjYyMw==", "bodyText": "Here we need to validate a positive value of nodeEngine.getProperties().getInteger(LOADED_KEY_LIMITER), otherwise the map loader will be stuck", "url": "https://github.com/hazelcast/hazelcast/pull/17169#discussion_r480986623", "createdAt": "2020-09-01T09:05:59Z", "author": {"login": "vbekiaris"}, "path": "hazelcast/src/main/java/com/hazelcast/map/impl/MapServiceContextImpl.java", "diffHunk": "@@ -173,6 +176,7 @@\n         this.operationProviders = createOperationProviders();\n         this.partitioningStrategyFactory = new PartitioningStrategyFactory(nodeEngine.getConfigClassLoader());\n         this.nodeWideUsedCapacityCounter = new NodeWideUsedCapacityCounter(nodeEngine.getProperties());\n+        this.loadedKeyLimiter = new Semaphore(nodeEngine.getProperties().getInteger(LOADED_KEY_LIMITER));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "373369f304e15d7589c727fd3c95b1f2b3039a38"}, "originalPosition": 28}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "373369f304e15d7589c727fd3c95b1f2b3039a38", "author": {"user": {"login": "ahmetmircik", "name": "Ahmet Mircik"}}, "url": "https://github.com/hazelcast/hazelcast/commit/373369f304e15d7589c727fd3c95b1f2b3039a38", "committedDate": "2020-08-27T18:05:13Z", "message": "Put node wide map loader limit"}, "afterCommit": {"oid": "480e1ccf6aa31be37b3619e896c78e72c4334928", "author": {"user": {"login": "ahmetmircik", "name": "Ahmet Mircik"}}, "url": "https://github.com/hazelcast/hazelcast/commit/480e1ccf6aa31be37b3619e896c78e72c4334928", "committedDate": "2020-09-02T11:32:08Z", "message": "Address Vassilis commnets"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwNzk1OTE5", "url": "https://github.com/hazelcast/hazelcast/pull/17169#pullrequestreview-480795919", "createdAt": "2020-09-02T13:03:12Z", "commit": {"oid": "480e1ccf6aa31be37b3619e896c78e72c4334928"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "480e1ccf6aa31be37b3619e896c78e72c4334928", "author": {"user": {"login": "ahmetmircik", "name": "Ahmet Mircik"}}, "url": "https://github.com/hazelcast/hazelcast/commit/480e1ccf6aa31be37b3619e896c78e72c4334928", "committedDate": "2020-09-02T11:32:08Z", "message": "Address Vassilis commnets"}, "afterCommit": {"oid": "456b716bbc5927b3045844af18a51ead39055aec", "author": {"user": {"login": "ahmetmircik", "name": "Ahmet Mircik"}}, "url": "https://github.com/hazelcast/hazelcast/commit/456b716bbc5927b3045844af18a51ead39055aec", "committedDate": "2020-09-05T09:01:40Z", "message": "Address Vassilis commnets"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e3ad70e4830772fa509b4a19b8b9f0f5bd70ed46", "author": {"user": {"login": "ahmetmircik", "name": "Ahmet Mircik"}}, "url": "https://github.com/hazelcast/hazelcast/commit/e3ad70e4830772fa509b4a19b8b9f0f5bd70ed46", "committedDate": "2020-09-05T10:05:54Z", "message": "Parallel"}, "afterCommit": {"oid": "456b716bbc5927b3045844af18a51ead39055aec", "author": {"user": {"login": "ahmetmircik", "name": "Ahmet Mircik"}}, "url": "https://github.com/hazelcast/hazelcast/commit/456b716bbc5927b3045844af18a51ead39055aec", "committedDate": "2020-09-05T09:01:40Z", "message": "Address Vassilis commnets"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzNDY3NDQ3", "url": "https://github.com/hazelcast/hazelcast/pull/17169#pullrequestreview-483467447", "createdAt": "2020-09-07T11:03:41Z", "commit": {"oid": "456b716bbc5927b3045844af18a51ead39055aec"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QxMTowMzo0MVrOHN7DMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QxMTowMzo0MVrOHN7DMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDM2MTAxMA==", "bodyText": "I wonder if we should use .acquire() here or drop in an IdleStrategy. As I understand if this method returns an empty batch, we call this method in a tight loop until the semaphore gives us the green light to proceed. Along the path, we create hashmaps etc.\nAs a second thought, shouldn't the semaphore be checked for available permits in MapKeyLoader#sendKeysInBatches in its\nwhile (batches.hasNext()) {\n                Map<Integer, List<Data>> batch = batches.next();\n                futures.addAll(sendBatch(batch, replaceExistingValues, nodeWideLoadedKeyLimiter));\n            }\n\nloop? Then the whole concurrency control would be in the same class and avoiding unnecessary allocations would be easier. WDYT?", "url": "https://github.com/hazelcast/hazelcast/pull/17169#discussion_r484361010", "createdAt": "2020-09-07T11:03:41Z", "author": {"login": "blazember"}, "path": "hazelcast/src/main/java/com/hazelcast/map/impl/MapKeyLoaderUtil.java", "diffHunk": "@@ -110,13 +112,19 @@ public boolean hasNext() {\n      * until at least one group has up to {@code maxBatch}\n      * entries or until the {@code entries} have been exhausted.\n      *\n-     * @param entries  the entries to be grouped by key\n-     * @param maxBatch the maximum size of a group\n+     * @param entries                  the entries to be grouped by key\n+     * @param maxBatch                 the maximum size of a group\n+     * @param nodeWideLoadedKeyLimiter controls the loaded number of keys per node\n      * @return the grouped entries by entry key\n      */\n-    private static Map<Integer, List<Data>> nextBatch(Iterator<Entry<Integer, Data>> entries, int maxBatch) {\n+    private static Map<Integer, List<Data>> nextBatch(Iterator<Entry<Integer, Data>> entries,\n+                                                      int maxBatch, Semaphore nodeWideLoadedKeyLimiter) {\n         Map<Integer, List<Data>> batch = createHashMap(maxBatch);\n         while (entries.hasNext()) {\n+            if (!nodeWideLoadedKeyLimiter.tryAcquire()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "456b716bbc5927b3045844af18a51ead39055aec"}, "originalPosition": 75}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8fbbc0682f7092a428d03adcb85b6157d177c6d4", "author": {"user": {"login": "ahmetmircik", "name": "Ahmet Mircik"}}, "url": "https://github.com/hazelcast/hazelcast/commit/8fbbc0682f7092a428d03adcb85b6157d177c6d4", "committedDate": "2020-09-07T14:16:33Z", "message": "Put node wide map loader limit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0010587976551b40593f3daa79690b7561c1108", "author": {"user": {"login": "ahmetmircik", "name": "Ahmet Mircik"}}, "url": "https://github.com/hazelcast/hazelcast/commit/d0010587976551b40593f3daa79690b7561c1108", "committedDate": "2020-09-07T14:16:33Z", "message": "Address Vassilis commnets"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "456b716bbc5927b3045844af18a51ead39055aec", "author": {"user": {"login": "ahmetmircik", "name": "Ahmet Mircik"}}, "url": "https://github.com/hazelcast/hazelcast/commit/456b716bbc5927b3045844af18a51ead39055aec", "committedDate": "2020-09-05T09:01:40Z", "message": "Address Vassilis commnets"}, "afterCommit": {"oid": "7a3153cd7818745e95125c9f3a1a29c2acd08b9c", "author": {"user": {"login": "ahmetmircik", "name": "Ahmet Mircik"}}, "url": "https://github.com/hazelcast/hazelcast/commit/7a3153cd7818745e95125c9f3a1a29c2acd08b9c", "committedDate": "2020-09-07T15:54:33Z", "message": "Address Zoltan commnets"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31efcee0192f681d8734acb4ee59e503c8cc5023", "author": {"user": {"login": "ahmetmircik", "name": "Ahmet Mircik"}}, "url": "https://github.com/hazelcast/hazelcast/commit/31efcee0192f681d8734acb4ee59e503c8cc5023", "committedDate": "2020-09-08T06:54:32Z", "message": "Address Zoltan comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7a3153cd7818745e95125c9f3a1a29c2acd08b9c", "author": {"user": {"login": "ahmetmircik", "name": "Ahmet Mircik"}}, "url": "https://github.com/hazelcast/hazelcast/commit/7a3153cd7818745e95125c9f3a1a29c2acd08b9c", "committedDate": "2020-09-07T15:54:33Z", "message": "Address Zoltan commnets"}, "afterCommit": {"oid": "31efcee0192f681d8734acb4ee59e503c8cc5023", "author": {"user": {"login": "ahmetmircik", "name": "Ahmet Mircik"}}, "url": "https://github.com/hazelcast/hazelcast/commit/31efcee0192f681d8734acb4ee59e503c8cc5023", "committedDate": "2020-09-08T06:54:32Z", "message": "Address Zoltan comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzOTI5NzIx", "url": "https://github.com/hazelcast/hazelcast/pull/17169#pullrequestreview-483929721", "createdAt": "2020-09-08T08:54:10Z", "commit": {"oid": "31efcee0192f681d8734acb4ee59e503c8cc5023"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3520, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}