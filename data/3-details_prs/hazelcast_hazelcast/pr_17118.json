{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM3NzgyMjE1", "number": 17118, "title": "Add support for incorporating IMDG rels into Jet", "bodyText": "", "createdAt": "2020-06-22T08:45:12Z", "url": "https://github.com/hazelcast/hazelcast/pull/17118", "merged": true, "mergeCommit": {"oid": "73d882274af3c8db0d531cc97bd227e335ed8743"}, "closed": true, "closedAt": "2020-06-26T13:47:50Z", "author": {"login": "viliam-durina"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcs0RZegH2gAyNDM3NzgyMjE1OjExNWJjN2FkOWRhMWUxYTFhMWE2YmJjNmUwYWE0ZmVhNWM1NzZlNmU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcvDYr0AH2gAyNDM3NzgyMjE1OmNlZGMyNzU3ZjVkYjQwYjM5ZjRiZGJlNTEwNWYyODQyMjU3YjgyZDc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "115bc7ad9da1e1a1a1a6bbc6e0aa4fea5c576e6e", "author": {"user": {"login": "viliam-durina", "name": "Viliam Durina"}}, "url": "https://github.com/hazelcast/hazelcast/commit/115bc7ad9da1e1a1a1a6bbc6e0aa4fea5c576e6e", "committedDate": "2020-06-19T14:52:49Z", "message": "Add support for running IMDG plans on Jet"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98ab0476df25703cea3f49f3c403028ff5ab448a", "author": {"user": {"login": "viliam-durina", "name": "Viliam Durina"}}, "url": "https://github.com/hazelcast/hazelcast/commit/98ab0476df25703cea3f49f3c403028ff5ab448a", "committedDate": "2020-06-22T10:30:45Z", "message": "Fix checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85eecd8d70688ec581c9c0575954660a3c3e8fdf", "author": {"user": {"login": "viliam-durina", "name": "Viliam Durina"}}, "url": "https://github.com/hazelcast/hazelcast/commit/85eecd8d70688ec581c9c0575954660a3c3e8fdf", "committedDate": "2020-06-22T12:08:13Z", "message": "Fix checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1NjczMjY1", "url": "https://github.com/hazelcast/hazelcast/pull/17118#pullrequestreview-435673265", "createdAt": "2020-06-23T11:04:02Z", "commit": {"oid": "85eecd8d70688ec581c9c0575954660a3c3e8fdf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxMTowNDowMlrOGnkOvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxMTowNDowMlrOGnkOvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDE0MTI0Ng==", "bodyText": "This check should be performed in the rule pattern, rather than the rule's body.\nAn example of how to add a custom predicate to rule patterns could be found in the ProjectIntoScanLogicalRule constructor.", "url": "https://github.com/hazelcast/hazelcast/pull/17118#discussion_r444141246", "createdAt": "2020-06-23T11:04:02Z", "author": {"login": "devozerov"}, "path": "hazelcast-sql/src/main/java/com/hazelcast/sql/impl/calcite/opt/logical/MapScanLogicalRule.java", "diffHunk": "@@ -37,6 +39,11 @@ private MapScanLogicalRule() {\n     @Override\n     public RelNode convert(RelNode rel) {\n         LogicalTableScan scan = (LogicalTableScan) rel;\n+        HazelcastTable table = scan.getTable().unwrap(HazelcastTable.class);\n+        if (!(table.getTarget() instanceof AbstractMapTable)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85eecd8d70688ec581c9c0575954660a3c3e8fdf"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1Njc3NDMz", "url": "https://github.com/hazelcast/hazelcast/pull/17118#pullrequestreview-435677433", "createdAt": "2020-06-23T11:10:46Z", "commit": {"oid": "85eecd8d70688ec581c9c0575954660a3c3e8fdf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxMToxMDo0N1rOGnka-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxMToxMDo0N1rOGnka-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDE0NDM3OA==", "bodyText": "We do not pass NodeEngine for a reason - we do not want to leak internals everywhere, because it breaks decomposition and makes testing harder. Moreover, this refactoring will make merge with master harder, because PlanCreateVisitor is already in master.\nIn general, we should avoid refactorings for now unless there are strong reasons to do so, to minimize wasted work. If refactoring is needed, then it should be performed through pr -> master -> sql flow.", "url": "https://github.com/hazelcast/hazelcast/pull/17118#discussion_r444144378", "createdAt": "2020-06-23T11:10:47Z", "author": {"login": "devozerov"}, "path": "hazelcast-sql/src/main/java/com/hazelcast/sql/impl/calcite/opt/physical/visitor/PlanCreateVisitor.java", "diffHunk": "@@ -159,21 +164,33 @@\n     /** Row metadata. */\n     private SqlRowMetadata rowMetadata;\n \n+    /**\n+     * @param rootColumnNames Root column names. They are null when called from\n+     *     Jet for a sub-relNode and the row metadata aren't needed\n+     */\n     public PlanCreateVisitor(\n-        UUID localMemberId,\n-        Map<UUID, PartitionIdSet> partMap,\n+        NodeEngine nodeEngine,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85eecd8d70688ec581c9c0575954660a3c3e8fdf"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1Njc5OTg3", "url": "https://github.com/hazelcast/hazelcast/pull/17118#pullrequestreview-435679987", "createdAt": "2020-06-23T11:14:48Z", "commit": {"oid": "85eecd8d70688ec581c9c0575954660a3c3e8fdf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxMToxNDo0OFrOGnkiLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxMToxNDo0OFrOGnkiLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDE0NjIyMg==", "bodyText": "What was the reason to remove this assertion?", "url": "https://github.com/hazelcast/hazelcast/pull/17118#discussion_r444146222", "createdAt": "2020-06-23T11:14:48Z", "author": {"login": "devozerov"}, "path": "hazelcast/src/main/java/com/hazelcast/sql/impl/row/ListRowBatch.java", "diffHunk": "@@ -42,8 +42,6 @@ public ListRowBatch(List<Row> rows) {\n \n     @Override\n     public Row getRow(int index) {\n-        assert index >= 0 && index < rows.size() : index;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85eecd8d70688ec581c9c0575954660a3c3e8fdf"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1NjgzMjA4", "url": "https://github.com/hazelcast/hazelcast/pull/17118#pullrequestreview-435683208", "createdAt": "2020-06-23T11:19:52Z", "commit": {"oid": "85eecd8d70688ec581c9c0575954660a3c3e8fdf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxMToxOTo1MlrOGnkrXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxMToxOTo1MlrOGnkrXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDE0ODU3Mw==", "bodyText": "Previously I reverted all changes from this class related to external tables for a reason - to keep a single responsibility principle in place.\nThe goal of PartitionedMapTableResolver is to expose existing maps through a predefined schema. We should not add external fields handling here. The same is applicable to ReplicatedMapTableResolver.\nIf there are some static methods that are common for both internal and external resolvers, let's factor them out, instead of mixing unrelated concepts inside a single class.", "url": "https://github.com/hazelcast/hazelcast/pull/17118#discussion_r444148573", "createdAt": "2020-06-23T11:19:52Z", "author": {"login": "devozerov"}, "path": "hazelcast/src/main/java/com/hazelcast/sql/impl/schema/map/PartitionedMapTableResolver.java", "diffHunk": "@@ -101,103 +101,129 @@ public PartitionedMapTableResolver(NodeEngine nodeEngine) {\n         return res;\n     }\n \n-    // TODO: VO: Abstract out Jet stuff in a clean way.\n-    @SuppressWarnings({\"rawtypes\", \"checkstyle:MethodLength\", \"checkstyle:CyclomaticComplexity\", \"checkstyle:NPathComplexity\"})\n+    /**\n+     * @param explicitRequest True, if the table was requested explicitly\n+     *     through DDL. In this case the result is non-null and the returned\n+     *     table never contains an exception. If false, might return null or a\n+     *     table with an exception.\n+     */\n+    @Nullable\n+    @SuppressWarnings({\"checkstyle:MethodLength\", \"checkstyle:CyclomaticComplexity\", \"checkstyle:NPathComplexity\"})\n     public static PartitionedMapTable createTable(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85eecd8d70688ec581c9c0575954660a3c3e8fdf"}, "originalPosition": 62}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bbeac4f6addba82a3e8272d2bf3933c86629844a", "author": {"user": {"login": "viliam-durina", "name": "Viliam Durina"}}, "url": "https://github.com/hazelcast/hazelcast/commit/bbeac4f6addba82a3e8272d2bf3933c86629844a", "committedDate": "2020-06-23T13:05:07Z", "message": "Move the rule check to the constructor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13927da6c6db613bdb0d1200f11d1abdb3eaa652", "author": {"user": {"login": "viliam-durina", "name": "Viliam Durina"}}, "url": "https://github.com/hazelcast/hazelcast/commit/13927da6c6db613bdb0d1200f11d1abdb3eaa652", "committedDate": "2020-06-23T13:40:30Z", "message": "Fix checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f9adaa6f03e64873b7df0b3d5b46e5c93778a4e", "author": {"user": {"login": "viliam-durina", "name": "Viliam Durina"}}, "url": "https://github.com/hazelcast/hazelcast/commit/3f9adaa6f03e64873b7df0b3d5b46e5c93778a4e", "committedDate": "2020-06-23T15:43:56Z", "message": "Refactor createTable into two methods calling shared methods"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc4b09646a50f8767356f311292eae2e69075251", "author": {"user": {"login": "viliam-durina", "name": "Viliam Durina"}}, "url": "https://github.com/hazelcast/hazelcast/commit/cc4b09646a50f8767356f311292eae2e69075251", "committedDate": "2020-06-24T15:23:25Z", "message": "Merge branch 'sql' into sql-exec-on-jet2"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3NDc0ODg3", "url": "https://github.com/hazelcast/hazelcast/pull/17118#pullrequestreview-437474887", "createdAt": "2020-06-25T13:07:52Z", "commit": {"oid": "cc4b09646a50f8767356f311292eae2e69075251"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxMzowNzo1MlrOGo52ag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxMzowNzo1MlrOGo52ag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTU0NDA0Mg==", "bodyText": "We may move methods from this class to MapTableUtils, because the latter was created exactly to host static helpers for metadata resolution.", "url": "https://github.com/hazelcast/hazelcast/pull/17118#discussion_r445544042", "createdAt": "2020-06-25T13:07:52Z", "author": {"login": "devozerov"}, "path": "hazelcast/src/main/java/com/hazelcast/sql/impl/schema/map/ResolverUtils.java", "diffHunk": "@@ -0,0 +1,141 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.sql.impl.schema.map;\n+\n+import com.hazelcast.config.InMemoryFormat;\n+import com.hazelcast.config.MapConfig;\n+import com.hazelcast.internal.serialization.Data;\n+import com.hazelcast.internal.serialization.InternalSerializationService;\n+import com.hazelcast.map.impl.MapContainer;\n+import com.hazelcast.map.impl.MapServiceContext;\n+import com.hazelcast.map.impl.PartitionContainer;\n+import com.hazelcast.map.impl.record.Record;\n+import com.hazelcast.map.impl.recordstore.RecordStore;\n+import com.hazelcast.sql.impl.QueryException;\n+import com.hazelcast.sql.impl.extract.QueryTargetDescriptor;\n+import com.hazelcast.sql.impl.schema.TableField;\n+import com.hazelcast.sql.impl.schema.map.sample.MapSampleMetadata;\n+import com.hazelcast.sql.impl.schema.map.sample.MapSampleMetadataResolver;\n+\n+import javax.annotation.Nullable;\n+import java.util.ArrayList;\n+import java.util.Iterator;\n+import java.util.LinkedHashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public final class ResolverUtils {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc4b09646a50f8767356f311292eae2e69075251"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3NDc1ODY1", "url": "https://github.com/hazelcast/hazelcast/pull/17118#pullrequestreview-437475865", "createdAt": "2020-06-25T13:09:01Z", "commit": {"oid": "cc4b09646a50f8767356f311292eae2e69075251"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05ef2cbd8542741edf8ab678415eb74dc439fa3a", "author": {"user": {"login": "viliam-durina", "name": "Viliam Durina"}}, "url": "https://github.com/hazelcast/hazelcast/commit/05ef2cbd8542741edf8ab678415eb74dc439fa3a", "committedDate": "2020-06-25T13:48:13Z", "message": "Move methods from ResolverUtils to MapTableUtils"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5face6d30bacd5b76a04e2ac758a117c35f01363", "author": {"user": {"login": "viliam-durina", "name": "Viliam Durina"}}, "url": "https://github.com/hazelcast/hazelcast/commit/5face6d30bacd5b76a04e2ac758a117c35f01363", "committedDate": "2020-06-26T06:31:30Z", "message": "Merge branch 'sql' into sql-exec-on-jet2\n\n# Conflicts:\n#\thazelcast/src/main/java/com/hazelcast/sql/impl/connector/LocalPartitionedMapConnector.java\n#\thazelcast/src/main/java/com/hazelcast/sql/impl/connector/LocalReplicatedMapConnector.java\n#\thazelcast/src/main/java/com/hazelcast/sql/impl/schema/ExternalCatalog.java\n#\thazelcast/src/main/java/com/hazelcast/sql/impl/schema/map/PartitionedMapTableResolver.java\n#\thazelcast/src/main/java/com/hazelcast/sql/impl/schema/map/ReplicatedMapTableResolver.java\n#\thazelcast/src/test/java/com/hazelcast/sql/impl/schema/ExternalCatalogTest.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c0cb057aacddf89bf5dd37fa1232c4cbf678f44", "author": {"user": {"login": "viliam-durina", "name": "Viliam Durina"}}, "url": "https://github.com/hazelcast/hazelcast/commit/5c0cb057aacddf89bf5dd37fa1232c4cbf678f44", "committedDate": "2020-06-26T12:46:27Z", "message": "Followup changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8fd3f4536e46635d02b78d70792dedd8c69371be", "author": {"user": {"login": "viliam-durina", "name": "Viliam Durina"}}, "url": "https://github.com/hazelcast/hazelcast/commit/8fd3f4536e46635d02b78d70792dedd8c69371be", "committedDate": "2020-06-26T12:54:41Z", "message": "Remove PlanCreateVisitor dep on NodeEngine"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b585246a5d859a20515d95a100844e0a8ca33a9", "author": {"user": {"login": "viliam-durina", "name": "Viliam Durina"}}, "url": "https://github.com/hazelcast/hazelcast/commit/7b585246a5d859a20515d95a100844e0a8ca33a9", "committedDate": "2020-06-26T12:58:32Z", "message": "Fix checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cedc2757f5db40b39f4bdbe5105f2842257b82d7", "author": {"user": {"login": "viliam-durina", "name": "Viliam Durina"}}, "url": "https://github.com/hazelcast/hazelcast/commit/cedc2757f5db40b39f4bdbe5105f2842257b82d7", "committedDate": "2020-06-26T13:37:12Z", "message": "More changes"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3720, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}