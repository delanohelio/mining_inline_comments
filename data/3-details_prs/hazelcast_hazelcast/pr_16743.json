{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg3NzMzNDgz", "number": 16743, "title": "Add ability to disallow on random target for ClientInvocations", "bodyText": "New API usage:\nClientInvocation invocation = new ClientInvocation(client, request, objectName, target);\ninvocation.disallowRetryOnRandom();\ninvocation.invoke()\nfixes #16653", "createdAt": "2020-03-13T11:42:33Z", "url": "https://github.com/hazelcast/hazelcast/pull/16743", "merged": true, "mergeCommit": {"oid": "4fb627880d697c66eb721518d62c6cbe8c8e3d6e"}, "closed": true, "closedAt": "2020-03-20T11:06:31Z", "author": {"login": "sancar"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcNPqQrAFqTM3NDI2Nzk3OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcPdFGlAH2gAyMzg3NzMzNDgzOjhjYWJiYzE2Njk0ZTU5MDBiZGViZDM3YzY0ZjYyM2MwNzJkNjQ5NDc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0MjY3OTc5", "url": "https://github.com/hazelcast/hazelcast/pull/16743#pullrequestreview-374267979", "createdAt": "2020-03-13T12:41:50Z", "commit": {"oid": "4930f2efec2de7b42d042cd5031ef70f574fdb3a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4930f2efec2de7b42d042cd5031ef70f574fdb3a", "author": {"user": {"login": "sancar", "name": "sancar"}}, "url": "https://github.com/hazelcast/hazelcast/commit/4930f2efec2de7b42d042cd5031ef70f574fdb3a", "committedDate": "2020-03-13T11:37:15Z", "message": "Add ability to disallow on random target for ClientInvocations\n\nNew API usage:\nClientInvocation invocation = new ClientInvocation(client, request, objectName, target);\ninvocation.disallowRetryOnRandom();\ninvocation.invoke()\n\nfixes https://github.com/hazelcast/hazelcast/issues/16653"}, "afterCommit": {"oid": "a762a71a712362c3d0c8aec96ed3a14d111bdfc1", "author": {"user": {"login": "sancar", "name": "sancar"}}, "url": "https://github.com/hazelcast/hazelcast/commit/a762a71a712362c3d0c8aec96ed3a14d111bdfc1", "committedDate": "2020-03-16T11:28:33Z", "message": "Add ability to disallow on random target for ClientInvocations\n\nNew API usage:\nClientInvocation invocation = new ClientInvocation(client, request, objectName, target);\ninvocation.disallowRetryOnRandom();\ninvocation.invoke()\n\nfixes https://github.com/hazelcast/hazelcast/issues/16653"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a762a71a712362c3d0c8aec96ed3a14d111bdfc1", "author": {"user": {"login": "sancar", "name": "sancar"}}, "url": "https://github.com/hazelcast/hazelcast/commit/a762a71a712362c3d0c8aec96ed3a14d111bdfc1", "committedDate": "2020-03-16T11:28:33Z", "message": "Add ability to disallow on random target for ClientInvocations\n\nNew API usage:\nClientInvocation invocation = new ClientInvocation(client, request, objectName, target);\ninvocation.disallowRetryOnRandom();\ninvocation.invoke()\n\nfixes https://github.com/hazelcast/hazelcast/issues/16653"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2ODM3NjMw", "url": "https://github.com/hazelcast/hazelcast/pull/16743#pullrequestreview-376837630", "createdAt": "2020-03-18T12:59:18Z", "commit": {"oid": "a762a71a712362c3d0c8aec96ed3a14d111bdfc1"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxMjo1OToxOFrOF4DyOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxMjo1OToxOFrOF4DyOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDMyNjU4Ng==", "bodyText": "for non smart, there is really no concept of random, hence, the name is misleading but this is not a major issue.", "url": "https://github.com/hazelcast/hazelcast/pull/16743#discussion_r394326586", "createdAt": "2020-03-18T12:59:18Z", "author": {"login": "ihsandemir"}, "path": "hazelcast/src/main/java/com/hazelcast/client/impl/spi/impl/ClientInvocation.java", "diffHunk": "@@ -159,20 +165,41 @@ private void invokeOnSelection() {\n             if (!urgent) {\n                 invocationService.checkInvocationAllowed();\n             }\n+\n+\n             if (isBindToSingleConnection()) {\n-                invocationService.invokeOnConnection(this, (ClientConnection) connection);\n-            } else if (partitionId != -1) {\n-                invocationService.invokeOnPartitionOwner(this, partitionId);\n-            } else if (uuid != null) {\n-                invocationService.invokeOnTarget(this, uuid);\n+                boolean invoked = invocationService.invokeOnConnection(this, (ClientConnection) connection);\n+                if (!invoked) {\n+                    notifyException(new IOException(\"Could not invoke on connection \" + connection));\n+                }\n+                return;\n+            }\n+\n+            boolean invoked;\n+            if (isSmartRoutingEnabled) {\n+                if (partitionId != -1) {\n+                    invoked = invocationService.invokeOnPartitionOwner(this, partitionId);\n+                } else if (uuid != null) {\n+                    invoked = invocationService.invokeOnTarget(this, uuid);\n+                } else {\n+                    invoked = invocationService.invokeOnRandomTarget(this);\n+                }\n+                if (allowRetryOnRandom && !invoked) {\n+                    invoked = invocationService.invokeOnRandomTarget(this);\n+                }\n             } else {\n-                invocationService.invokeOnRandomTarget(this);\n+                invoked = invocationService.invokeOnRandomTarget(this);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a762a71a712362c3d0c8aec96ed3a14d111bdfc1"}, "originalPosition": 104}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8cabbc16694e5900bdebd37c64f623c072d64947", "author": {"user": {"login": "sancar", "name": "sancar"}}, "url": "https://github.com/hazelcast/hazelcast/commit/8cabbc16694e5900bdebd37c64f623c072d64947", "committedDate": "2020-03-20T09:27:46Z", "message": "review change. InvokeOnRandom -> invoke , and some javadoc for invocaitonService"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3873, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}