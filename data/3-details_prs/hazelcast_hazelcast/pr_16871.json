{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAxNDEzMTUx", "number": 16871, "title": "Remove assert and log instead", "bodyText": "closes #16837\nIt is a known issue that permit count can exceed allowed max parallelization count. Given that the issue happens rarely, when it happens, there is no real reason to make replica sync process fail.\nIn this PR, not to introduce a complex fix, we are improving the situation and trying to keep released permit count eventually under max allowed and logging any anomalies as a warning.", "createdAt": "2020-04-09T13:07:33Z", "url": "https://github.com/hazelcast/hazelcast/pull/16871", "merged": true, "mergeCommit": {"oid": "a5b46106076ee417bf197b1f346becf3dc06c340"}, "closed": true, "closedAt": "2020-04-10T12:54:16Z", "author": {"login": "ahmetmircik"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcV8MOegH2gAyNDAxNDEzMTUxOjRkMzg4NzY5MzFmNzM0NTNmYTAxZTFhZjU0OGMwNDdmMzcwMWJiMGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcWQljfgFqTM5MTQyNjAxNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4d38876931f73453fa01e1af548c047f3701bb0f", "author": {"user": {"login": "ahmetmircik", "name": "Ahmet Mircik"}}, "url": "https://github.com/hazelcast/hazelcast/commit/4d38876931f73453fa01e1af548c047f3701bb0f", "committedDate": "2020-04-09T13:06:09Z", "message": "Open trace level logging (#16865)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9399e9e718170eda0eaf8c6a965e8547bc86632c", "author": {"user": {"login": "ahmetmircik", "name": "Ahmet Mircik"}}, "url": "https://github.com/hazelcast/hazelcast/commit/9399e9e718170eda0eaf8c6a965e8547bc86632c", "committedDate": "2020-04-09T13:06:26Z", "message": "Remove assert and log instead"}, "afterCommit": {"oid": "1d913ce796b1a4cf3f18273498ee4046136c1f9d", "author": {"user": {"login": "ahmetmircik", "name": "Ahmet Mircik"}}, "url": "https://github.com/hazelcast/hazelcast/commit/1d913ce796b1a4cf3f18273498ee4046136c1f9d", "committedDate": "2020-04-09T13:14:20Z", "message": "Remove assert and log instead"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4078622f54303743496dd0876f6b112d553ec240", "author": {"user": {"login": "ahmetmircik", "name": "Ahmet Mircik"}}, "url": "https://github.com/hazelcast/hazelcast/commit/4078622f54303743496dd0876f6b112d553ec240", "committedDate": "2020-04-09T13:26:28Z", "message": "Remove assert and log instead"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1d913ce796b1a4cf3f18273498ee4046136c1f9d", "author": {"user": {"login": "ahmetmircik", "name": "Ahmet Mircik"}}, "url": "https://github.com/hazelcast/hazelcast/commit/1d913ce796b1a4cf3f18273498ee4046136c1f9d", "committedDate": "2020-04-09T13:14:20Z", "message": "Remove assert and log instead"}, "afterCommit": {"oid": "4078622f54303743496dd0876f6b112d553ec240", "author": {"user": {"login": "ahmetmircik", "name": "Ahmet Mircik"}}, "url": "https://github.com/hazelcast/hazelcast/commit/4078622f54303743496dd0876f6b112d553ec240", "committedDate": "2020-04-09T13:26:28Z", "message": "Remove assert and log instead"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMzAxMDc2", "url": "https://github.com/hazelcast/hazelcast/pull/16871#pullrequestreview-391301076", "createdAt": "2020-04-10T07:14:10Z", "commit": {"oid": "4078622f54303743496dd0876f6b112d553ec240"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQwNzoxNDoxMFrOGDzCSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQwNzoxNDoxMFrOGDzCSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjYzNTA4MA==", "bodyText": "If there is a bad configuration, then it is better to throw an exception. Now you are at risk of loosing the problematic configuration completely and I have no idea if the system will actually behave correctly.", "url": "https://github.com/hazelcast/hazelcast/pull/16871#discussion_r406635080", "createdAt": "2020-04-10T07:14:10Z", "author": {"login": "pveentjer"}, "path": "hazelcast/src/main/java/com/hazelcast/internal/partition/impl/PartitionReplicaManager.java", "diffHunk": "@@ -453,6 +465,9 @@ void reset() {\n         // permit count can exceed allowed parallelization count.\n         replicaSyncSemaphore.drainPermits();\n         replicaSyncSemaphore.release(maxParallelReplications);\n+        if (logger.isFinestEnabled()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4078622f54303743496dd0876f6b112d553ec240"}, "originalPosition": 115}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMzI4NjIx", "url": "https://github.com/hazelcast/hazelcast/pull/16871#pullrequestreview-391328621", "createdAt": "2020-04-10T08:24:33Z", "commit": {"oid": "4078622f54303743496dd0876f6b112d553ec240"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQwODoyNDozM1rOGD0eWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQwODoyNDozM1rOGD0eWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY1ODY1MA==", "bodyText": "I think we should log this as a warning. So it will be visible.", "url": "https://github.com/hazelcast/hazelcast/pull/16871#discussion_r406658650", "createdAt": "2020-04-10T08:24:33Z", "author": {"login": "mdogan"}, "path": "hazelcast/src/main/java/com/hazelcast/internal/partition/impl/PartitionReplicaManager.java", "diffHunk": "@@ -409,13 +413,21 @@ public int tryAcquireReplicaSyncPermits(int requestedPermits) {\n      */\n     public void releaseReplicaSyncPermits(int permits) {\n         assert permits > 0 : \"Invalid permits: \" + permits;\n+\n         replicaSyncSemaphore.release(permits);\n+\n         if (logger.isFinestEnabled()) {\n-            logger.finest(\"Released \" + permits + \" replica sync permits. Available permits: \"\n-                        + replicaSyncSemaphore.availablePermits());\n+            int availableReplicaSyncPermits = availableReplicaSyncPermits();\n+\n+            logger.finest(format(\"Released %d replica sync permits. Available permits: %d\",\n+                    permits, availableReplicaSyncPermits));\n+\n+            if (availableReplicaSyncPermits <= maxParallelReplications) {\n+                logger.finest(format(\"Replica sync permits exceeded the configured number! (available: %d, max: %d)\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4078622f54303743496dd0876f6b112d553ec240"}, "originalPosition": 101}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9f9da8990f50b2d67592b017d860fdb9a81ee08", "author": {"user": {"login": "ahmetmircik", "name": "Ahmet Mircik"}}, "url": "https://github.com/hazelcast/hazelcast/commit/c9f9da8990f50b2d67592b017d860fdb9a81ee08", "committedDate": "2020-04-10T10:38:12Z", "message": "Address review comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5a3c51fe9202d4d607ea1fdd48d322ca34cd1fcc", "author": {"user": {"login": "ahmetmircik", "name": "Ahmet Mircik"}}, "url": "https://github.com/hazelcast/hazelcast/commit/5a3c51fe9202d4d607ea1fdd48d322ca34cd1fcc", "committedDate": "2020-04-10T10:29:13Z", "message": "Address review comments"}, "afterCommit": {"oid": "c9f9da8990f50b2d67592b017d860fdb9a81ee08", "author": {"user": {"login": "ahmetmircik", "name": "Ahmet Mircik"}}, "url": "https://github.com/hazelcast/hazelcast/commit/c9f9da8990f50b2d67592b017d860fdb9a81ee08", "committedDate": "2020-04-10T10:38:12Z", "message": "Address review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20f4d22a191c014c47fd05d51f3bd6f9fac0e2d6", "author": {"user": {"login": "ahmetmircik", "name": "Ahmet Mircik"}}, "url": "https://github.com/hazelcast/hazelcast/commit/20f4d22a191c014c47fd05d51f3bd6f9fac0e2d6", "committedDate": "2020-04-10T10:48:36Z", "message": "Address review comments: permitsToRelease"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMzg0MDkw", "url": "https://github.com/hazelcast/hazelcast/pull/16871#pullrequestreview-391384090", "createdAt": "2020-04-10T10:50:11Z", "commit": {"oid": "20f4d22a191c014c47fd05d51f3bd6f9fac0e2d6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNDI2MDE3", "url": "https://github.com/hazelcast/hazelcast/pull/16871#pullrequestreview-391426017", "createdAt": "2020-04-10T12:51:55Z", "commit": {"oid": "20f4d22a191c014c47fd05d51f3bd6f9fac0e2d6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3766, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}