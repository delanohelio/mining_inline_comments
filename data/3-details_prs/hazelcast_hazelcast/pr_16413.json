{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU5ODg2ODQ0", "number": 16413, "title": "ScheduledExecutor task size logging", "bodyText": "", "createdAt": "2020-01-07T08:51:26Z", "url": "https://github.com/hazelcast/hazelcast/pull/16413", "merged": true, "mergeCommit": {"oid": "5b695ed11ac7b628d31d54e032e095ace6d2a48e"}, "closed": true, "closedAt": "2020-01-08T14:02:19Z", "author": {"login": "pveentjer"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb383-8gFqTMzOTEwMjU2Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb4VJhtABqjI5MzExMDExOTU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5MTAyNTYz", "url": "https://github.com/hazelcast/hazelcast/pull/16413#pullrequestreview-339102563", "createdAt": "2020-01-07T08:56:12Z", "commit": {"oid": "b1437112935129ac50e58ffdc85b8a987e6bff72"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QwODo1NjoxMlrOFazODQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QwODo1NjoxMlrOFazODQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzY0NjQ3Nw==", "bodyText": "Will be removed from final PR", "url": "https://github.com/hazelcast/hazelcast/pull/16413#discussion_r363646477", "createdAt": "2020-01-07T08:56:12Z", "author": {"login": "pveentjer"}, "path": "hazelcast/src/test/java/com/EchoTask.java", "diffHunk": "@@ -0,0 +1,21 @@\n+package com;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1437112935129ac50e58ffdc85b8a987e6bff72"}, "originalPosition": 1}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5MTAyNjM2", "url": "https://github.com/hazelcast/hazelcast/pull/16413#pullrequestreview-339102636", "createdAt": "2020-01-07T08:56:23Z", "commit": {"oid": "b1437112935129ac50e58ffdc85b8a987e6bff72"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QwODo1NjoyM1rOFazOTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QwODo1NjoyM1rOFazOTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzY0NjU0Mg==", "bodyText": "Will be removed in final PR", "url": "https://github.com/hazelcast/hazelcast/pull/16413#discussion_r363646542", "createdAt": "2020-01-07T08:56:23Z", "author": {"login": "pveentjer"}, "path": "hazelcast/src/test/java/com/Main.java", "diffHunk": "@@ -0,0 +1,35 @@\n+package com;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1437112935129ac50e58ffdc85b8a987e6bff72"}, "originalPosition": 1}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b1437112935129ac50e58ffdc85b8a987e6bff72", "author": {"user": {"login": "pveentjer", "name": "Peter Veentjer"}}, "url": "https://github.com/hazelcast/hazelcast/commit/b1437112935129ac50e58ffdc85b8a987e6bff72", "committedDate": "2020-01-07T08:50:51Z", "message": "WIP"}, "afterCommit": {"oid": "1a942d1de14a6fcb41ee46a4524ebed32ed25193", "author": {"user": {"login": "pveentjer", "name": "Peter Veentjer"}}, "url": "https://github.com/hazelcast/hazelcast/commit/1a942d1de14a6fcb41ee46a4524ebed32ed25193", "committedDate": "2020-01-07T09:42:52Z", "message": "WIP"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1a942d1de14a6fcb41ee46a4524ebed32ed25193", "author": {"user": {"login": "pveentjer", "name": "Peter Veentjer"}}, "url": "https://github.com/hazelcast/hazelcast/commit/1a942d1de14a6fcb41ee46a4524ebed32ed25193", "committedDate": "2020-01-07T09:42:52Z", "message": "WIP"}, "afterCommit": {"oid": "cc29637ad63f8bc21952d7163662e6297fab5e76", "author": {"user": {"login": "pveentjer", "name": "Peter Veentjer"}}, "url": "https://github.com/hazelcast/hazelcast/commit/cc29637ad63f8bc21952d7163662e6297fab5e76", "committedDate": "2020-01-07T09:49:22Z", "message": "WIP"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5MTM2NzEx", "url": "https://github.com/hazelcast/hazelcast/pull/16413#pullrequestreview-339136711", "createdAt": "2020-01-07T10:00:28Z", "commit": {"oid": "cc29637ad63f8bc21952d7163662e6297fab5e76"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxMDowMDoyOFrOFa0zpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxMDowMjo1OFrOFa03zg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzY3MjQ4Nw==", "bodyText": "Minor^2: redundant empty line.", "url": "https://github.com/hazelcast/hazelcast/pull/16413#discussion_r363672487", "createdAt": "2020-01-07T10:00:28Z", "author": {"login": "blazember"}, "path": "hazelcast/src/main/java/com/hazelcast/scheduledexecutor/impl/DistributedScheduledExecutorService.java", "diffHunk": "@@ -359,4 +375,60 @@ private void sendBatch(int partitionId, String name, List<ScheduledExecutorMerge\n             invoke(SERVICE_NAME, operation, partitionId);\n         }\n     }\n+\n+    private class StatsLoggerThread extends HazelcastManagedThread {\n+        private final Map<String, MutableInteger> tasksSizes = new HashMap<String, MutableInteger>();\n+        private final ILogger logger = nodeEngine.getLogger(DistributedScheduledExecutorService.class);\n+        private final IPartitionService partitionService = nodeEngine.getPartitionService();\n+        private final long logDelayMillis;\n+        private volatile boolean shutdown;\n+\n+        public StatsLoggerThread(int logDelaySeconds) {\n+            this.logDelayMillis = TimeUnit.SECONDS.toMillis(logDelaySeconds);\n+        }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc29637ad63f8bc21952d7163662e6297fab5e76"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzY3MzU1MA==", "bodyText": "This can be replaced with partition.isLocal(). Also, it might deserve a note somewhere that the reported sizes might be inaccurate during a migration.", "url": "https://github.com/hazelcast/hazelcast/pull/16413#discussion_r363673550", "createdAt": "2020-01-07T10:02:58Z", "author": {"login": "blazember"}, "path": "hazelcast/src/main/java/com/hazelcast/scheduledexecutor/impl/DistributedScheduledExecutorService.java", "diffHunk": "@@ -359,4 +375,60 @@ private void sendBatch(int partitionId, String name, List<ScheduledExecutorMerge\n             invoke(SERVICE_NAME, operation, partitionId);\n         }\n     }\n+\n+    private class StatsLoggerThread extends HazelcastManagedThread {\n+        private final Map<String, MutableInteger> tasksSizes = new HashMap<String, MutableInteger>();\n+        private final ILogger logger = nodeEngine.getLogger(DistributedScheduledExecutorService.class);\n+        private final IPartitionService partitionService = nodeEngine.getPartitionService();\n+        private final long logDelayMillis;\n+        private volatile boolean shutdown;\n+\n+        public StatsLoggerThread(int logDelaySeconds) {\n+            this.logDelayMillis = TimeUnit.SECONDS.toMillis(logDelaySeconds);\n+        }\n+\n+\n+        private void shutdown() {\n+            shutdown = true;\n+            interrupt();\n+        }\n+\n+        @Override\n+        public void run() {\n+            while (!shutdown) {\n+                try {\n+                    Thread.sleep(logDelayMillis);\n+                } catch (InterruptedException e) {\n+                    continue;\n+                }\n+\n+                tasksSizes.clear();\n+                for (ScheduledExecutorPartition partition : partitions) {\n+                    if (partition == null) {\n+                        continue;\n+                    }\n+\n+                    if (partitionService.getPartitionOwner(partition.partitionId()) != nodeEngine.getThisAddress()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc29637ad63f8bc21952d7163662e6297fab5e76"}, "originalPosition": 102}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5MTk0OTk1", "url": "https://github.com/hazelcast/hazelcast/pull/16413#pullrequestreview-339194995", "createdAt": "2020-01-07T12:02:46Z", "commit": {"oid": "cc29637ad63f8bc21952d7163662e6297fab5e76"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxMjowMjo0NlrOFa3jGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxMjowMjo0NlrOFa3jGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzcxNzQwMA==", "bodyText": "Why old_value + current_value? If it was 1 task in the previous log, and now we have two tasks in the container, we will log 3?", "url": "https://github.com/hazelcast/hazelcast/pull/16413#discussion_r363717400", "createdAt": "2020-01-07T12:02:46Z", "author": {"login": "tkountis"}, "path": "hazelcast/src/main/java/com/hazelcast/scheduledexecutor/impl/DistributedScheduledExecutorService.java", "diffHunk": "@@ -359,4 +375,60 @@ private void sendBatch(int partitionId, String name, List<ScheduledExecutorMerge\n             invoke(SERVICE_NAME, operation, partitionId);\n         }\n     }\n+\n+    private class StatsLoggerThread extends HazelcastManagedThread {\n+        private final Map<String, MutableInteger> tasksSizes = new HashMap<String, MutableInteger>();\n+        private final ILogger logger = nodeEngine.getLogger(DistributedScheduledExecutorService.class);\n+        private final IPartitionService partitionService = nodeEngine.getPartitionService();\n+        private final long logDelayMillis;\n+        private volatile boolean shutdown;\n+\n+        public StatsLoggerThread(int logDelaySeconds) {\n+            this.logDelayMillis = TimeUnit.SECONDS.toMillis(logDelaySeconds);\n+        }\n+\n+\n+        private void shutdown() {\n+            shutdown = true;\n+            interrupt();\n+        }\n+\n+        @Override\n+        public void run() {\n+            while (!shutdown) {\n+                try {\n+                    Thread.sleep(logDelayMillis);\n+                } catch (InterruptedException e) {\n+                    continue;\n+                }\n+\n+                tasksSizes.clear();\n+                for (ScheduledExecutorPartition partition : partitions) {\n+                    if (partition == null) {\n+                        continue;\n+                    }\n+\n+                    if (partitionService.getPartitionOwner(partition.partitionId()) != nodeEngine.getThisAddress()) {\n+                        // skip non primary partitions.\n+                        continue;\n+                    }\n+\n+                    for (Map.Entry<String, ScheduledExecutorContainer> entry : partition.containers.entrySet()) {\n+                        String name = entry.getKey();\n+                        ScheduledExecutorContainer container = entry.getValue();\n+                        MutableInteger tasksSize = tasksSizes.get(name);\n+                        if (tasksSize == null) {\n+                            tasksSize = new MutableInteger();\n+                            tasksSizes.put(name, tasksSize);\n+                        }\n+                        tasksSize.value += container.tasks.size();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc29637ad63f8bc21952d7163662e6297fab5e76"}, "originalPosition": 115}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cc29637ad63f8bc21952d7163662e6297fab5e76", "author": {"user": {"login": "pveentjer", "name": "Peter Veentjer"}}, "url": "https://github.com/hazelcast/hazelcast/commit/cc29637ad63f8bc21952d7163662e6297fab5e76", "committedDate": "2020-01-07T09:49:22Z", "message": "WIP"}, "afterCommit": {"oid": "9a2d527ea58e2679af2d274e11007a0ea81e5e32", "author": {"user": {"login": "pveentjer", "name": "Peter Veentjer"}}, "url": "https://github.com/hazelcast/hazelcast/commit/9a2d527ea58e2679af2d274e11007a0ea81e5e32", "committedDate": "2020-01-08T06:39:38Z", "message": "Adds ScheduledExecutor logging uncomplete task logging\n\nThis is a temporary solution to provide insights in the number of\nincomplete tasks for the ScheduledExecutor.\n\nIn HZ 4.0 the metrics system was fixed so that dynamic collection\nof data-structures can cause memory leaks.\n\nIn HZ 4.1 the ScheduledExecutor will get metrics.\n\nBut till that time, there is a temporary solution that scans\nthe ScheduledExecutors, collects the metrics and dumps them\nto the log file."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5MjQ1MTY1", "url": "https://github.com/hazelcast/hazelcast/pull/16413#pullrequestreview-339245165", "createdAt": "2020-01-07T13:49:27Z", "commit": {"oid": "cc29637ad63f8bc21952d7163662e6297fab5e76"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9a2d527ea58e2679af2d274e11007a0ea81e5e32", "author": {"user": {"login": "pveentjer", "name": "Peter Veentjer"}}, "url": "https://github.com/hazelcast/hazelcast/commit/9a2d527ea58e2679af2d274e11007a0ea81e5e32", "committedDate": "2020-01-08T06:39:38Z", "message": "Adds ScheduledExecutor logging uncomplete task logging\n\nThis is a temporary solution to provide insights in the number of\nincomplete tasks for the ScheduledExecutor.\n\nIn HZ 4.0 the metrics system was fixed so that dynamic collection\nof data-structures can cause memory leaks.\n\nIn HZ 4.1 the ScheduledExecutor will get metrics.\n\nBut till that time, there is a temporary solution that scans\nthe ScheduledExecutors, collects the metrics and dumps them\nto the log file."}, "afterCommit": {"oid": "db842150b06c340677d85495efcfccac1c6a5fca", "author": {"user": {"login": "pveentjer", "name": "Peter Veentjer"}}, "url": "https://github.com/hazelcast/hazelcast/commit/db842150b06c340677d85495efcfccac1c6a5fca", "committedDate": "2020-01-08T07:43:18Z", "message": "Adds ScheduledExecutor logging uncomplete task logging\n\nThis is a temporary solution to provide insights in the number of\nincomplete tasks for the ScheduledExecutor.\n\nIn HZ 4.0 the metrics system was fixed so that dynamic collection\nof data-structures can cause memory leaks.\n\nIn HZ 4.1 the ScheduledExecutor will get metrics.\n\nBut till that time, there is a temporary solution that scans\nthe ScheduledExecutors, collects the metrics and dumps them\nto the log file."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5NzI2MDk3", "url": "https://github.com/hazelcast/hazelcast/pull/16413#pullrequestreview-339726097", "createdAt": "2020-01-08T09:08:13Z", "commit": {"oid": "db842150b06c340677d85495efcfccac1c6a5fca"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "efe629cac93738367673276e4e1f3440481b7fa5", "author": {"user": {"login": "pveentjer", "name": "Peter Veentjer"}}, "url": "https://github.com/hazelcast/hazelcast/commit/efe629cac93738367673276e4e1f3440481b7fa5", "committedDate": "2020-01-08T13:12:48Z", "message": "Adds ScheduledExecutor logging uncomplete task logging\n\nThis is a temporary solution to provide insights in the number of\nincomplete tasks for the ScheduledExecutor.\n\nIn HZ 4.0 the metrics system was fixed so that dynamic collection\nof data-structures can cause memory leaks.\n\nIn HZ 4.1 the ScheduledExecutor will get metrics.\n\nBut till that time, there is a temporary solution that scans\nthe ScheduledExecutors, collects the metrics and dumps them\nto the log file."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "db842150b06c340677d85495efcfccac1c6a5fca", "author": {"user": {"login": "pveentjer", "name": "Peter Veentjer"}}, "url": "https://github.com/hazelcast/hazelcast/commit/db842150b06c340677d85495efcfccac1c6a5fca", "committedDate": "2020-01-08T07:43:18Z", "message": "Adds ScheduledExecutor logging uncomplete task logging\n\nThis is a temporary solution to provide insights in the number of\nincomplete tasks for the ScheduledExecutor.\n\nIn HZ 4.0 the metrics system was fixed so that dynamic collection\nof data-structures can cause memory leaks.\n\nIn HZ 4.1 the ScheduledExecutor will get metrics.\n\nBut till that time, there is a temporary solution that scans\nthe ScheduledExecutors, collects the metrics and dumps them\nto the log file."}, "afterCommit": {"oid": "efe629cac93738367673276e4e1f3440481b7fa5", "author": {"user": {"login": "pveentjer", "name": "Peter Veentjer"}}, "url": "https://github.com/hazelcast/hazelcast/commit/efe629cac93738367673276e4e1f3440481b7fa5", "committedDate": "2020-01-08T13:12:48Z", "message": "Adds ScheduledExecutor logging uncomplete task logging\n\nThis is a temporary solution to provide insights in the number of\nincomplete tasks for the ScheduledExecutor.\n\nIn HZ 4.0 the metrics system was fixed so that dynamic collection\nof data-structures can cause memory leaks.\n\nIn HZ 4.1 the ScheduledExecutor will get metrics.\n\nBut till that time, there is a temporary solution that scans\nthe ScheduledExecutors, collects the metrics and dumps them\nto the log file."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3990, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}