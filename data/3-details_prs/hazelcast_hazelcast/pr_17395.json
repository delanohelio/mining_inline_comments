{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcyMTE5ODIy", "number": 17395, "title": "Support temporal columns in SQL", "bodyText": "This PR adds support for access to temporal columns in SQL. The support was implemented before, but it was not tested properly.\nIn this PR we add a number of tests, and improve/fix several things:\n\nAdded TIMESTAMP_WITH_TIME_ZONE type that is mapped to Calcite's TIMESTAMP_WITH_LOCAL_TIME_ZONE\nDo not display precision for TIME/TIMEZONE/TIMESTAMP_WITH_TIME_ZONE types because it is not used in our engine anyway\nFixed incorrect conversion from TIMESTAMP to TIMESTAMP_WITH_TIME_ZONE\nForcefully disallowed temporal types for comparison operators, see the change in HazelcastTypeCoercion. Without this fix, Calcite fails with the AssertionError because HazelcastTypeCoercion.needToCast is not aligned with Calcite's SqlTypeUtil.canCastFrom. It doesn't make sense to invest into deeper fixes or more precise error messages with parser position for two reasons: a) our type coercion is broken anyway, and requires general revision (there are separate issues for this); b) temporal type comparison has a high priority for the engine, so we will have to fix it soon.", "createdAt": "2020-08-23T12:45:05Z", "url": "https://github.com/hazelcast/hazelcast/pull/17395", "merged": true, "mergeCommit": {"oid": "8a9e0ee7ff6e57b5bb1a7f7441814199faa79718"}, "closed": true, "closedAt": "2020-08-26T13:07:38Z", "author": {"login": "devozerov"}, "timelineItems": {"totalCount": 27, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdBoMdJAH2gAyNDcyMTE5ODIyOjEwZjZmZjU2ODRhNjY2OGNiZTg5YTUwNTkxOWNmYzc5YTZjOGNkZTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCrFL8AFqTQ3NTQ0Mjg1NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "10f6ff5684a6668cbe89a505919cfc79a6c8cde8", "author": {"user": {"login": "devozerov", "name": "Vladimir Ozerov"}}, "url": "https://github.com/hazelcast/hazelcast/commit/10f6ff5684a6668cbe89a505919cfc79a6c8cde8", "committedDate": "2020-08-23T06:40:58Z", "message": "WIP on tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f2ace7a893816c8bec84d5be1ada5a9b984bc88c", "author": {"user": {"login": "devozerov", "name": "Vladimir Ozerov"}}, "url": "https://github.com/hazelcast/hazelcast/commit/f2ace7a893816c8bec84d5be1ada5a9b984bc88c", "committedDate": "2020-08-23T06:57:48Z", "message": "WIP on tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8dcb9039b001e2025b9610f4dcffd51c0b0d07b", "author": {"user": {"login": "devozerov", "name": "Vladimir Ozerov"}}, "url": "https://github.com/hazelcast/hazelcast/commit/e8dcb9039b001e2025b9610f4dcffd51c0b0d07b", "committedDate": "2020-08-23T07:15:48Z", "message": "WIP on tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d131087970567ec8c031d16e5635cdf9c9b3880", "author": {"user": {"login": "devozerov", "name": "Vladimir Ozerov"}}, "url": "https://github.com/hazelcast/hazelcast/commit/3d131087970567ec8c031d16e5635cdf9c9b3880", "committedDate": "2020-08-23T10:10:09Z", "message": "CAST tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ff78fb95f4cdb23bc8ddc787ed3d839481ac6b0", "author": {"user": {"login": "devozerov", "name": "Vladimir Ozerov"}}, "url": "https://github.com/hazelcast/hazelcast/commit/5ff78fb95f4cdb23bc8ddc787ed3d839481ac6b0", "committedDate": "2020-08-23T10:20:09Z", "message": "Tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ffbd16d67280ac50f493947076bfd970f65ee2c", "author": {"user": {"login": "devozerov", "name": "Vladimir Ozerov"}}, "url": "https://github.com/hazelcast/hazelcast/commit/1ffbd16d67280ac50f493947076bfd970f65ee2c", "committedDate": "2020-08-23T10:26:09Z", "message": "Tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef8a18ef6f9c5a77232e13b904b84f6d02d5b7d7", "author": {"user": {"login": "devozerov", "name": "Vladimir Ozerov"}}, "url": "https://github.com/hazelcast/hazelcast/commit/ef8a18ef6f9c5a77232e13b904b84f6d02d5b7d7", "committedDate": "2020-08-23T10:31:08Z", "message": "Tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "078c17fce68d635b476efd5a32a083576215fc6b", "author": {"user": {"login": "devozerov", "name": "Vladimir Ozerov"}}, "url": "https://github.com/hazelcast/hazelcast/commit/078c17fce68d635b476efd5a32a083576215fc6b", "committedDate": "2020-08-23T10:48:59Z", "message": "Finished with string function tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2030dfcd5579a31543a4e0798d9f2e8bd41ec097", "author": {"user": {"login": "devozerov", "name": "Vladimir Ozerov"}}, "url": "https://github.com/hazelcast/hazelcast/commit/2030dfcd5579a31543a4e0798d9f2e8bd41ec097", "committedDate": "2020-08-23T10:52:32Z", "message": "WIP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c5d5d3745e8c582a5b3ebf90c2c19bc5a845a59", "author": {"user": {"login": "devozerov", "name": "Vladimir Ozerov"}}, "url": "https://github.com/hazelcast/hazelcast/commit/3c5d5d3745e8c582a5b3ebf90c2c19bc5a845a59", "committedDate": "2020-08-23T11:12:27Z", "message": "Tests for math"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33a077675dff391ffcf8e5a59278e5a6e07cab4a", "author": {"user": {"login": "devozerov", "name": "Vladimir Ozerov"}}, "url": "https://github.com/hazelcast/hazelcast/commit/33a077675dff391ffcf8e5a59278e5a6e07cab4a", "committedDate": "2020-08-23T11:41:13Z", "message": "WIP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "194f94a1a08a74da036ecb106283ac0623b2e2ed", "author": {"user": {"login": "devozerov", "name": "Vladimir Ozerov"}}, "url": "https://github.com/hazelcast/hazelcast/commit/194f94a1a08a74da036ecb106283ac0623b2e2ed", "committedDate": "2020-08-23T11:51:02Z", "message": "Arithmetics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb8fcaa0b896688941eb9ac9cb8d1c96787a7213", "author": {"user": {"login": "devozerov", "name": "Vladimir Ozerov"}}, "url": "https://github.com/hazelcast/hazelcast/commit/bb8fcaa0b896688941eb9ac9cb8d1c96787a7213", "committedDate": "2020-08-23T12:00:32Z", "message": "Predicate tests (1)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e8e5da4bf0fd5ec76b317a9b6a2b4de11d256fd", "author": {"user": {"login": "devozerov", "name": "Vladimir Ozerov"}}, "url": "https://github.com/hazelcast/hazelcast/commit/8e8e5da4bf0fd5ec76b317a9b6a2b4de11d256fd", "committedDate": "2020-08-23T12:07:50Z", "message": "AND/OR tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b6e6ac488161934c841e730a6d80af2477e5d0f", "author": {"user": {"login": "devozerov", "name": "Vladimir Ozerov"}}, "url": "https://github.com/hazelcast/hazelcast/commit/0b6e6ac488161934c841e730a6d80af2477e5d0f", "committedDate": "2020-08-23T12:32:22Z", "message": "Comparisons"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1117f692684c2ef218d94abfe3f325b6ae6e4d31", "author": {"user": {"login": "devozerov", "name": "Vladimir Ozerov"}}, "url": "https://github.com/hazelcast/hazelcast/commit/1117f692684c2ef218d94abfe3f325b6ae6e4d31", "committedDate": "2020-08-23T12:35:55Z", "message": "Minor fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45c48345eaac90efe04c6e678a09dd6a4a8f1c49", "author": {"user": {"login": "devozerov", "name": "Vladimir Ozerov"}}, "url": "https://github.com/hazelcast/hazelcast/commit/45c48345eaac90efe04c6e678a09dd6a4a8f1c49", "committedDate": "2020-08-23T12:38:15Z", "message": "Revert unnecessary changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2bbf272b9f1dd081c3e1a5487192a023bbaa1a41", "author": {"user": {"login": "devozerov", "name": "Vladimir Ozerov"}}, "url": "https://github.com/hazelcast/hazelcast/commit/2bbf272b9f1dd081c3e1a5487192a023bbaa1a41", "committedDate": "2020-08-23T13:44:41Z", "message": "Minor fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0MjA3Mjg3", "url": "https://github.com/hazelcast/hazelcast/pull/17395#pullrequestreview-474207287", "createdAt": "2020-08-25T07:31:46Z", "commit": {"oid": "2bbf272b9f1dd081c3e1a5487192a023bbaa1a41"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQwNzozMTo0NlrOHGLLMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQwNzozMTo0NlrOHGLLMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjIzNjU5Mg==", "bodyText": "What's the reasoning behind introducing an abstract class with a single non-abstract implementation?", "url": "https://github.com/hazelcast/hazelcast/pull/17395#discussion_r476236592", "createdAt": "2020-08-25T07:31:46Z", "author": {"login": "taburet"}, "path": "hazelcast-sql/src/main/java/com/hazelcast/sql/impl/calcite/validate/types/HazelcastOperandTypes.java", "diffHunk": "@@ -65,11 +66,11 @@ public static SqlOperandTypeChecker notAllNull(SqlOperandTypeChecker base) {\n         return new NotAllNull(base);\n     }\n \n-    private static final class NotAny implements SqlSingleOperandTypeChecker {\n+    private abstract static class DisallowedTypeOperandTypeChecker implements SqlSingleOperandTypeChecker {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bbf272b9f1dd081c3e1a5487192a023bbaa1a41"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0MjEyMjE3", "url": "https://github.com/hazelcast/hazelcast/pull/17395#pullrequestreview-474212217", "createdAt": "2020-08-25T07:38:37Z", "commit": {"oid": "2bbf272b9f1dd081c3e1a5487192a023bbaa1a41"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQwNzozODozN1rOHGLZiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQwNzozODozN1rOHGLZiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI0MDI2NA==", "bodyText": "What's the status of TIME_WITH_LOCAL_TIME_ZONE? There is no mapping from/to query data type for it, but it's listed as allowed.", "url": "https://github.com/hazelcast/hazelcast/pull/17395#discussion_r476240264", "createdAt": "2020-08-25T07:38:37Z", "author": {"login": "taburet"}, "path": "hazelcast-sql/src/main/java/com/hazelcast/sql/impl/calcite/parse/UnsupportedOperationVisitor.java", "diffHunk": "@@ -204,6 +208,10 @@ public Void visit(SqlDataTypeSpec type) {\n             case REAL:\n             case DOUBLE:\n             case VARCHAR:\n+            case DATE:\n+            case TIME:\n+            case TIMESTAMP:\n+            case TIME_WITH_LOCAL_TIME_ZONE:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bbf272b9f1dd081c3e1a5487192a023bbaa1a41"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f3403afcd54f7c13913dd9f177fafbd2b9e396b", "author": {"user": {"login": "devozerov", "name": "Vladimir Ozerov"}}, "url": "https://github.com/hazelcast/hazelcast/commit/0f3403afcd54f7c13913dd9f177fafbd2b9e396b", "committedDate": "2020-08-25T09:15:02Z", "message": "Merge branch 'master' into sql-temporal-columns"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e442d1cae09e167e80a20d5656c891458e84aaae", "author": {"user": {"login": "devozerov", "name": "Vladimir Ozerov"}}, "url": "https://github.com/hazelcast/hazelcast/commit/e442d1cae09e167e80a20d5656c891458e84aaae", "committedDate": "2020-08-25T09:16:50Z", "message": "Rolled back changes in the HazelcastOperandTypes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77e3f84bd99cd2f3f7b9b375b9e34ca518f6ac81", "author": {"user": {"login": "devozerov", "name": "Vladimir Ozerov"}}, "url": "https://github.com/hazelcast/hazelcast/commit/77e3f84bd99cd2f3f7b9b375b9e34ca518f6ac81", "committedDate": "2020-08-25T09:19:42Z", "message": "UnsuportedOperationVisitor: TIME_WITH_LOCAL_TIME_ZONE -> TIMESTAMP_WITH_LOCAL_TIME_ZONE"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0Mjk5MTA4", "url": "https://github.com/hazelcast/hazelcast/pull/17395#pullrequestreview-474299108", "createdAt": "2020-08-25T09:24:03Z", "commit": {"oid": "2bbf272b9f1dd081c3e1a5487192a023bbaa1a41"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQwOToyNDowM1rOHGPijg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQwOToyNDowM1rOHGPijg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjMwODExMA==", "bodyText": "Is it ok to use underscored type names while Calcite, and SQL in general, refer to them without underscores?", "url": "https://github.com/hazelcast/hazelcast/pull/17395#discussion_r476308110", "createdAt": "2020-08-25T09:24:03Z", "author": {"login": "taburet"}, "path": "hazelcast-sql/src/main/java/com/hazelcast/sql/impl/calcite/validate/types/HazelcastTemporalType.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.sql.impl.calcite.validate.types;\n+\n+import com.hazelcast.sql.impl.calcite.SqlToQueryType;\n+import org.apache.calcite.rel.type.RelDataType;\n+import org.apache.calcite.sql.type.BasicSqlType;\n+import org.apache.calcite.sql.type.SqlTypeName;\n+\n+/**\n+ * Class describing TIME, TIMESTAMP and TIMESTAMP_WITH_TIME_ZONE types.\n+ */\n+public final class HazelcastTemporalType extends BasicSqlType {\n+\n+    public static final RelDataType TIME = new HazelcastTemporalType(SqlTypeName.TIME, false);\n+    public static final RelDataType TIME_NULLABLE = new HazelcastTemporalType(SqlTypeName.TIME, true);\n+\n+    public static final RelDataType TIMESTAMP = new HazelcastTemporalType(SqlTypeName.TIMESTAMP, false);\n+    public static final RelDataType TIMESTAMP_NULLABLE = new HazelcastTemporalType(SqlTypeName.TIMESTAMP, true);\n+\n+    public static final RelDataType TIMESTAMP_WITH_TIME_ZONE = new HazelcastTemporalType(\n+        SqlTypeName.TIMESTAMP_WITH_LOCAL_TIME_ZONE, false\n+    );\n+\n+    public static final RelDataType TIMESTAMP_WITH_TIME_ZONE_NULLABLE = new HazelcastTemporalType(\n+        SqlTypeName.TIMESTAMP_WITH_LOCAL_TIME_ZONE,\n+        true\n+    );\n+\n+    private HazelcastTemporalType(SqlTypeName typeName, boolean nullable) {\n+        super(HazelcastTypeSystem.INSTANCE, typeName);\n+\n+        this.isNullable = nullable;\n+\n+        computeDigest();\n+    }\n+\n+    @Override\n+    protected void generateTypeString(StringBuilder sb, boolean withDetail) {\n+        sb.append(SqlToQueryType.map(typeName).getTypeFamily());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bbf272b9f1dd081c3e1a5487192a023bbaa1a41"}, "originalPosition": 54}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ebe4af6c3654ab9a3f52666d25517929e7e94e5", "author": {"user": {"login": "devozerov", "name": "Vladimir Ozerov"}}, "url": "https://github.com/hazelcast/hazelcast/commit/5ebe4af6c3654ab9a3f52666d25517929e7e94e5", "committedDate": "2020-08-25T09:24:49Z", "message": "UnsuportedOperationVisitor: removed TIMESTAMP_WITH_LOCAL_TIME_ZONE"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1MTY4NjY1", "url": "https://github.com/hazelcast/hazelcast/pull/17395#pullrequestreview-475168665", "createdAt": "2020-08-26T05:51:17Z", "commit": {"oid": "5ebe4af6c3654ab9a3f52666d25517929e7e94e5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1NDQyODU0", "url": "https://github.com/hazelcast/hazelcast/pull/17395#pullrequestreview-475442854", "createdAt": "2020-08-26T12:36:40Z", "commit": {"oid": "5ebe4af6c3654ab9a3f52666d25517929e7e94e5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3420, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}