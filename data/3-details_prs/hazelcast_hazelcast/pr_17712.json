{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAxNDcyNDE0", "number": 17712, "title": "SQL: Do not clear query handles during split brain recovery", "bodyText": "This PR fixes the hang observed during the split-brain testing in #17706. Before the fix, we had an incorrect implementation of the reset routine invoked during cluster merge: we cleared existing query handles without invoking cancellation on them. As a result, the user ended up with an unregistered handle that can never complete.\nAfter the fix, we do not clear query handles on reset. Instead, we rely on the QueryStateRegistryUpdater to eventually detect that some members have new IDs, and cancel affected handles properly. Basically, the fix is to remove the reset routine completely, because it was implemented incorrectly, and the existing mechanisms are sufficient to ensure that problematic queries are canceled.\nNote that the same hang could occur during member shutdown. It will be fixed separately in #17714\nCloses #17706", "createdAt": "2020-10-12T10:11:49Z", "url": "https://github.com/hazelcast/hazelcast/pull/17712", "merged": true, "mergeCommit": {"oid": "c7dace36d384bae98a741655b19141a47f3d4931"}, "closed": true, "closedAt": "2020-10-13T13:03:05Z", "author": {"login": "devozerov"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdRw4wXgH2gAyNTAxNDcyNDE0OjQ1YTViODk1OTUwMjQ2MzlkMGEwYjMxMjkwZDM3NmExZDBkZGRkOGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSH7gKAFqTUwNzM4OTU2NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "45a5b89595024639d0a0b31290d376a1d0dddd8f", "author": {"user": {"login": "devozerov", "name": "Vladimir Ozerov"}}, "url": "https://github.com/hazelcast/hazelcast/commit/45a5b89595024639d0a0b31290d376a1d0dddd8f", "committedDate": "2020-10-12T09:51:23Z", "message": "SQL: Do not clear query handles during split brain recovery"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3MTY3ODIx", "url": "https://github.com/hazelcast/hazelcast/pull/17712#pullrequestreview-507167821", "createdAt": "2020-10-13T08:02:12Z", "commit": {"oid": "45a5b89595024639d0a0b31290d376a1d0dddd8f"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3MzI0NjEx", "url": "https://github.com/hazelcast/hazelcast/pull/17712#pullrequestreview-507324611", "createdAt": "2020-10-13T11:15:18Z", "commit": {"oid": "45a5b89595024639d0a0b31290d376a1d0dddd8f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3Mzc2NzQy", "url": "https://github.com/hazelcast/hazelcast/pull/17712#pullrequestreview-507376742", "createdAt": "2020-10-13T12:26:42Z", "commit": {"oid": "45a5b89595024639d0a0b31290d376a1d0dddd8f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3Mzg5NTY0", "url": "https://github.com/hazelcast/hazelcast/pull/17712#pullrequestreview-507389564", "createdAt": "2020-10-13T12:41:39Z", "commit": {"oid": "45a5b89595024639d0a0b31290d376a1d0dddd8f"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMjo0MTozOVrOHgksng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMjo0MTozOVrOHgksng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzkxNzcyNg==", "bodyText": "Wondering if we can leave an empty reset in case it might be used in the future, but probably not.\nAlso, I see there's a jetSqlCoreBackend but I can't find it. Is it used at all? cc @viliam-durina", "url": "https://github.com/hazelcast/hazelcast/pull/17712#discussion_r503917726", "createdAt": "2020-10-13T12:41:39Z", "author": {"login": "mmedenjak"}, "path": "hazelcast/src/main/java/com/hazelcast/sql/impl/SqlServiceImpl.java", "diffHunk": "@@ -151,9 +151,6 @@ public void reset() {\n         if (jetSqlCoreBackend != null) {\n             jetSqlCoreBackend.reset();\n         }\n-        if (internalService != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "45a5b89595024639d0a0b31290d376a1d0dddd8f"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3250, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}