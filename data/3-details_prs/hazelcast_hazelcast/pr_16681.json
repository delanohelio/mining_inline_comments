{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4OTM1ODk5", "number": 16681, "title": "Decrease preallocated partition container sizes", "bodyText": "hazelcast/hazelcast-enterprise#3536\nCode to test effects - adds a single entry in each of 20k partitions, clears the map and then we take a heap dump to see the size:\npublic static void main(String[] args) throws InterruptedException {\n        int partitions = 20_001;\n        Config c = new Config()\n                .setLicenseKey(licenseKey)\n                .setProperty(ClusterProperty.PARTITION_COUNT.getName(), String.valueOf(partitions));\n\n        HazelcastInstance i = Hazelcast.newHazelcastInstance(c);\n        IMap<Object, Object> map = i.getMap(\"map\");\n        IMap<Object, Object> map2 = i.getMap(\"map1\");\n\n        int parallelism = 4;\n        Thread[] threads = new Thread[parallelism];\n\n        for (int j = 0; j < parallelism; j++) {\n            int finalJ = j;\n            Thread t = new Thread(() -> {\n                for (int k = finalJ; k < partitions; k += parallelism) {\n                    String key = generateKeyForPartition(i, finalJ);\n                    map.put(key, \"\");\n                    map2.put(key, \"\");\n                }\n            });\n            t.start();\n            threads[j] = t;\n        }\n        for (Thread thread : threads) {\n            thread.join();\n        }\n\n        System.out.println(\"DONE \" + map.size() + \" \" + map2.size());\n        map.clear();\n        map2.clear();\n        System.out.println(\"DONE 2 \" + map.size() + \" \" + map2.size());\n\n    }\nHeap dump after code runs, with this PR: 312M\nHeap dump after code runs, on master: 616M", "createdAt": "2020-02-24T11:17:52Z", "url": "https://github.com/hazelcast/hazelcast/pull/16681", "merged": true, "mergeCommit": {"oid": "073eea5bf3f6df323c66e9b143d36863878b1472"}, "closed": true, "closedAt": "2020-05-29T10:12:07Z", "author": {"login": "mmedenjak"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcHcvx-gFqTM2MzM1NjAzNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcl_dDbAFqTQyMDgxNDM1OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMzU2MDM0", "url": "https://github.com/hazelcast/hazelcast/pull/16681#pullrequestreview-363356034", "createdAt": "2020-02-24T12:33:05Z", "commit": {"oid": "967b2bd60a80bb7600a780fd1d277824eb3619f3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMjozMzowNVrOFtfC6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMjozMzowNVrOFtfC6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzIzODg5MA==", "bodyText": "Can't we initialize this with the number of DSs defined in the static config? Then we can grow on-demand if new ones created dynamically.", "url": "https://github.com/hazelcast/hazelcast/pull/16681#discussion_r383238890", "createdAt": "2020-02-24T12:33:05Z", "author": {"login": "blazember"}, "path": "hazelcast/src/main/java/com/hazelcast/collection/impl/queue/QueueService.java", "diffHunk": "@@ -103,7 +104,7 @@\n     private static final Object NULL_OBJECT = new Object();\n \n     private final ConcurrentMap<String, QueueContainer> containerMap = new ConcurrentHashMap<>();\n-    private final ConcurrentMap<String, LocalQueueStatsImpl> statsMap = new ConcurrentHashMap<>(1000);\n+    private final ConcurrentMap<String, LocalQueueStatsImpl> statsMap = MapUtil.createConcurrentHashMap(10);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "967b2bd60a80bb7600a780fd1d277824eb3619f3"}, "originalPosition": 13}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "967b2bd60a80bb7600a780fd1d277824eb3619f3", "author": {"user": {"login": "mmedenjak", "name": "Matko Medenjak"}}, "url": "https://github.com/hazelcast/hazelcast/commit/967b2bd60a80bb7600a780fd1d277824eb3619f3", "committedDate": "2020-02-24T11:12:55Z", "message": "Decrease preallocated partition container sizes"}, "afterCommit": {"oid": "1488b8ba06254730d4940f8053e006c217b7baba", "author": {"user": {"login": "mmedenjak", "name": "Matko Medenjak"}}, "url": "https://github.com/hazelcast/hazelcast/commit/1488b8ba06254730d4940f8053e006c217b7baba", "committedDate": "2020-04-06T11:12:53Z", "message": "Decrease preallocated partition container sizes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de17efa417219ce601265e81c8e66b6cfa46e53b", "author": {"user": {"login": "mmedenjak", "name": "Matko Medenjak"}}, "url": "https://github.com/hazelcast/hazelcast/commit/de17efa417219ce601265e81c8e66b6cfa46e53b", "committedDate": "2020-05-24T14:13:01Z", "message": "Decrease preallocated partition container sizes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c6c49c2dd538401bc7d09f6e0fcf2a915fc1cc2", "author": {"user": {"login": "mmedenjak", "name": "Matko Medenjak"}}, "url": "https://github.com/hazelcast/hazelcast/commit/1c6c49c2dd538401bc7d09f6e0fcf2a915fc1cc2", "committedDate": "2020-05-24T14:13:01Z", "message": "Fix compilation issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1ee883fe5d5337e8c562ad18557cb104ecab2b1", "author": {"user": {"login": "mmedenjak", "name": "Matko Medenjak"}}, "url": "https://github.com/hazelcast/hazelcast/commit/f1ee883fe5d5337e8c562ad18557cb104ecab2b1", "committedDate": "2020-05-24T14:21:11Z", "message": "Address review comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d0c05a814b480a9c5c842c7489a9f512719eff27", "author": {"user": {"login": "mmedenjak", "name": "Matko Medenjak"}}, "url": "https://github.com/hazelcast/hazelcast/commit/d0c05a814b480a9c5c842c7489a9f512719eff27", "committedDate": "2020-04-06T11:35:36Z", "message": "Fix compilation issue"}, "afterCommit": {"oid": "f1ee883fe5d5337e8c562ad18557cb104ecab2b1", "author": {"user": {"login": "mmedenjak", "name": "Matko Medenjak"}}, "url": "https://github.com/hazelcast/hazelcast/commit/f1ee883fe5d5337e8c562ad18557cb104ecab2b1", "committedDate": "2020-05-24T14:21:11Z", "message": "Address review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3ODAxNjU4", "url": "https://github.com/hazelcast/hazelcast/pull/16681#pullrequestreview-417801658", "createdAt": "2020-05-25T16:23:46Z", "commit": {"oid": "f1ee883fe5d5337e8c562ad18557cb104ecab2b1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwODE0MzU4", "url": "https://github.com/hazelcast/hazelcast/pull/16681#pullrequestreview-420814358", "createdAt": "2020-05-29T09:57:02Z", "commit": {"oid": "f1ee883fe5d5337e8c562ad18557cb104ecab2b1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3826, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}