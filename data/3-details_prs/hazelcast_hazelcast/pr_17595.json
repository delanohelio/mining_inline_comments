{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwNzM3MzIw", "number": 17595, "title": "SqlErrorAbstractTest should wait for partition assignment", "bodyText": "Two flaky test failures were observed in #17347 (comment) and #17347 (comment).\nThey are very different, but have a common root cause - we do not wait for a specific partition distribution in tests:\n\ntestMapDestroy_secondMember failed because there was an unassigned partition that didn't allow a query execution to start\ntestMapMigration failed because it expected that a partition should be re-assigned to a newly started member in no more than 2 seconds, but it didn't happen\n\nIn both cases, the trigger is likely to be a GC pauses or so. The test class uses a parallel runner, so tens of members start at the same time.\nThe fix is two-fold:\n\nAwait for all partitions to be assigned and await for all members to have at least one partition assigned\nChange parallel runner to serial, to make hiccups less frequent\n\nCloses #17347", "createdAt": "2020-09-22T07:06:59Z", "url": "https://github.com/hazelcast/hazelcast/pull/17595", "merged": true, "mergeCommit": {"oid": "6d129e1b5c2468dd3b7fe45467ab40afb88ee445"}, "closed": true, "closedAt": "2020-09-22T09:19:43Z", "author": {"login": "devozerov"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLSNyOgH2gAyNDkwNzM3MzIwOmRmNzZlOGE3YmJmMDA3NTBlZjBjNWExZjcxOTYzYzcwMTdlYmM5Njk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLUV1QgFqTQ5MzI2NjY3MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "df76e8a7bbf00750ef0c5a1f71963c7017ebc969", "author": {"user": {"login": "devozerov", "name": "Vladimir Ozerov"}}, "url": "https://github.com/hazelcast/hazelcast/commit/df76e8a7bbf00750ef0c5a1f71963c7017ebc969", "committedDate": "2020-09-22T06:43:45Z", "message": "Better error messages"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "765116e7c52d46ff5126b87112ccd6ead6373e25", "author": {"user": {"login": "devozerov", "name": "Vladimir Ozerov"}}, "url": "https://github.com/hazelcast/hazelcast/commit/765116e7c52d46ff5126b87112ccd6ead6373e25", "committedDate": "2020-09-22T07:00:59Z", "message": "Wait for partition state"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e584de97896c9d28ef9454496533a8382dda97c", "author": {"user": {"login": "devozerov", "name": "Vladimir Ozerov"}}, "url": "https://github.com/hazelcast/hazelcast/commit/1e584de97896c9d28ef9454496533a8382dda97c", "committedDate": "2020-09-22T07:46:33Z", "message": "Fixed if-statement in the wrong place."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMjEwODcy", "url": "https://github.com/hazelcast/hazelcast/pull/17595#pullrequestreview-493210872", "createdAt": "2020-09-22T08:00:09Z", "commit": {"oid": "1e584de97896c9d28ef9454496533a8382dda97c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMjU1NTM5", "url": "https://github.com/hazelcast/hazelcast/pull/17595#pullrequestreview-493255539", "createdAt": "2020-09-22T08:57:55Z", "commit": {"oid": "1e584de97896c9d28ef9454496533a8382dda97c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwODo1Nzo1NVrOHVwjvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwODo1Nzo1NVrOHVwjvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU3NzcyNA==", "bodyText": "Can we rely on the family of waitAllForSafeState methods?", "url": "https://github.com/hazelcast/hazelcast/pull/17595#discussion_r492577724", "createdAt": "2020-09-22T08:57:55Z", "author": {"login": "petrpleshachkov"}, "path": "hazelcast-sql/src/test/java/com/hazelcast/sql/SqlErrorAbstractTest.java", "diffHunk": "@@ -309,4 +316,44 @@ protected HazelcastInstance newClient() {\n     protected ClientConfig clientConfig() {\n         return new ClientConfig();\n     }\n+\n+    protected static void assertErrorCode(int expected, HazelcastSqlException error) {\n+        assertEquals(error.getCode() + \": \" + error.getMessage(), expected, error.getCode());\n+    }\n+\n+    /**\n+     * Start the new Hazelcast instance.\n+     *\n+     * @param awaitAssignment whether to wait for a partition assignment to a new member\n+     * @return created instance\n+     */\n+    protected HazelcastInstance newHazelcastInstance(boolean awaitAssignment) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e584de97896c9d28ef9454496533a8382dda97c"}, "originalPosition": 175}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMjY2Njcw", "url": "https://github.com/hazelcast/hazelcast/pull/17595#pullrequestreview-493266670", "createdAt": "2020-09-22T09:12:21Z", "commit": {"oid": "1e584de97896c9d28ef9454496533a8382dda97c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3342, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}