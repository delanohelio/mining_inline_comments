{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQwNTc5ODg3", "number": 17133, "title": "Integrate concurrent off-heap B+tree index into the old engine", "bodyText": "Introduced a global system property to enable global HD indexes;\n\n\nIntroduced a new HDOrderedConcurrentIndexStore (based on BPlusTree) for global HD indexes\nsupport;\n\n\nFallback to the old partitioned HD index if the global indices are\ndisabled for HD.\n\n\nEE PR: hazelcast/hazelcast-enterprise#3653\nCloses hazelcast/hazelcast-enterprise#3652", "createdAt": "2020-06-26T13:15:33Z", "url": "https://github.com/hazelcast/hazelcast/pull/17133", "merged": true, "mergeCommit": {"oid": "5c3d1df3ac0ba57e5ce6df12952c8ba3201a1f0e"}, "closed": true, "closedAt": "2020-07-07T13:41:33Z", "author": {"login": "petrpleshachkov"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcv7XnbgBqjM0OTE1MTEwNjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcylK8OAH2gAyNDQwNTc5ODg3OjIwNGUxOGYzOWUwZDQ1MjE0YmJjNzQ3MTE1ODdhYjc4NDIyMzExZjI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7565563989b64e2fa957a50d7def2924c3d10548", "author": {"user": {"login": "petrpleshachkov", "name": null}}, "url": "https://github.com/hazelcast/hazelcast/commit/7565563989b64e2fa957a50d7def2924c3d10548", "committedDate": "2020-06-26T16:30:59Z", "message": "Disabled global lock for on-heap indexes\n\nOtherwise the updates are not atomic"}, "afterCommit": {"oid": "01f680f9a967646e8e27cb05842ac1a06412d046", "author": {"user": {"login": "petrpleshachkov", "name": null}}, "url": "https://github.com/hazelcast/hazelcast/commit/01f680f9a967646e8e27cb05842ac1a06412d046", "committedDate": "2020-06-29T06:48:18Z", "message": "Disabled global lock for on-heap indexes\n\nOtherwise the updates are not atomic"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NzE1MjEw", "url": "https://github.com/hazelcast/hazelcast/pull/17133#pullrequestreview-439715210", "createdAt": "2020-06-30T06:48:00Z", "commit": {"oid": "01f680f9a967646e8e27cb05842ac1a06412d046"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwNjo0ODowMFrOGquD3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwNjo0ODowMFrOGquD3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ0ODAyOQ==", "bodyText": "Minor: mapConfig.getInMemoryFormat() != NATIVE || mapServiceContext.globalIndexEnabled()?", "url": "https://github.com/hazelcast/hazelcast/pull/17133#discussion_r447448029", "createdAt": "2020-06-30T06:48:00Z", "author": {"login": "devozerov"}, "path": "hazelcast/src/main/java/com/hazelcast/map/impl/MapContainer.java", "diffHunk": "@@ -179,7 +178,8 @@ protected Evictor newEvictor(EvictionPolicyComparator evictionPolicyComparator,\n \n     public boolean shouldUseGlobalIndex() {\n         // for non-native memory populate a single global index\n-        return !mapConfig.getInMemoryFormat().equals(NATIVE);\n+        return !mapConfig.getInMemoryFormat().equals(NATIVE)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01f680f9a967646e8e27cb05842ac1a06412d046"}, "originalPosition": 47}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NzE5NTQ0", "url": "https://github.com/hazelcast/hazelcast/pull/17133#pullrequestreview-439719544", "createdAt": "2020-06-30T06:55:28Z", "commit": {"oid": "01f680f9a967646e8e27cb05842ac1a06412d046"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwNjo1NToyOFrOGquSDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwNjo1NToyOFrOGquSDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ1MTY2MA==", "bodyText": "If we are removing the global lock for HD index (which changes the behavior), is there a reason to leave it for other indexes?\nMaybe we should introduce a single property that will enable/disable global lock globally?", "url": "https://github.com/hazelcast/hazelcast/pull/17133#discussion_r447451660", "createdAt": "2020-06-30T06:55:28Z", "author": {"login": "devozerov"}, "path": "hazelcast/src/main/java/com/hazelcast/query/impl/OrderedIndexStore.java", "diffHunk": "@@ -45,7 +45,7 @@\n     private volatile Map<Data, QueryableEntry> recordsWithNullValue;\n \n     public OrderedIndexStore(IndexCopyBehavior copyOn) {\n-        super(copyOn);\n+        super(copyOn, true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01f680f9a967646e8e27cb05842ac1a06412d046"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NzUwOTQy", "url": "https://github.com/hazelcast/hazelcast/pull/17133#pullrequestreview-439750942", "createdAt": "2020-06-30T07:42:19Z", "commit": {"oid": "01f680f9a967646e8e27cb05842ac1a06412d046"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwNzo0MjoxOVrOGqv0FQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwNzo0MjoxOVrOGqv0FQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ3Njc1Nw==", "bodyText": "I cannot find usages of this method in either OS or ENT. Could you please point me to the code where it is used?", "url": "https://github.com/hazelcast/hazelcast/pull/17133#discussion_r447476757", "createdAt": "2020-06-30T07:42:19Z", "author": {"login": "devozerov"}, "path": "hazelcast/src/main/java/com/hazelcast/query/impl/IndexProvider.java", "diffHunk": "@@ -43,11 +43,13 @@\n      * @return the created index instance.\n      */\n     InternalIndex createIndex(\n-        IndexConfig config,\n-        Extractors extractors,\n-        InternalSerializationService ss,\n-        IndexCopyBehavior copyBehavior,\n-        PerIndexStats stats,\n-        StoreAdapter storeAdapter\n+            IndexConfig config,\n+            Extractors extractors,\n+            InternalSerializationService ss,\n+            IndexCopyBehavior copyBehavior,\n+            PerIndexStats stats,\n+            StoreAdapter storeAdapter\n     );\n+\n+    PerIndexStats createPerIndexStats(boolean ordered, boolean usesCachedQueryableEntries);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01f680f9a967646e8e27cb05842ac1a06412d046"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NzU1NDAx", "url": "https://github.com/hazelcast/hazelcast/pull/17133#pullrequestreview-439755401", "createdAt": "2020-06-30T07:48:21Z", "commit": {"oid": "01f680f9a967646e8e27cb05842ac1a06412d046"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwNzo0ODoyMVrOGqwB9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwNzo0ODoyMVrOGqwB9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ4MDMxMQ==", "bodyText": "Is it guaranteed that updateMemoryCost is not invoked from several threads concurrently? I see that the fields of the superclass are updated through CAS operations.", "url": "https://github.com/hazelcast/hazelcast/pull/17133#discussion_r447480311", "createdAt": "2020-06-30T07:48:21Z", "author": {"login": "devozerov"}, "path": "hazelcast/src/main/java/com/hazelcast/internal/monitor/impl/HDGlobalPerIndexStats.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.internal.monitor.impl;\n+\n+import com.hazelcast.internal.memory.MemoryAllocator;\n+\n+import java.util.concurrent.atomic.AtomicLongFieldUpdater;\n+\n+import static java.util.concurrent.atomic.AtomicLongFieldUpdater.newUpdater;\n+\n+/**\n+ * The implementation of internal index stats specialized for HD global indexes.\n+ * <p>\n+ * The main trait of the implementation is the concurrency support, which is\n+ * required for HD global indexes because they are shared among partitions.\n+ */\n+public final class HDGlobalPerIndexStats extends GlobalPerIndexStats {\n+\n+    private static final AtomicLongFieldUpdater<HDGlobalPerIndexStats> MEMORY_COST = newUpdater(HDGlobalPerIndexStats.class,\n+            \"memoryCost\");\n+\n+    private volatile long memoryCost;\n+\n+    public HDGlobalPerIndexStats(boolean ordered, boolean usesCachedQueryableEntries) {\n+        super(ordered, usesCachedQueryableEntries);\n+    }\n+\n+    @Override\n+    public long getMemoryCost() {\n+        return memoryCost;\n+    }\n+\n+    @Override\n+    public MemoryAllocator wrapMemoryAllocator(MemoryAllocator memoryAllocator) {\n+        return new MemoryAllocatorWithStats(memoryAllocator);\n+    }\n+\n+    private void updateMemoryCost(long delta) {\n+        MEMORY_COST.lazySet(HDGlobalPerIndexStats.this, memoryCost + delta);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01f680f9a967646e8e27cb05842ac1a06412d046"}, "originalPosition": 53}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5OTkzMjg2", "url": "https://github.com/hazelcast/hazelcast/pull/17133#pullrequestreview-439993286", "createdAt": "2020-06-30T13:06:44Z", "commit": {"oid": "be787bcfe2104c9d291b488ebbf84355b26f3893"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8e816bc305f26d58b9e3b3723409492db8ee75dd", "author": {"user": {"login": "petrpleshachkov", "name": null}}, "url": "https://github.com/hazelcast/hazelcast/commit/8e816bc305f26d58b9e3b3723409492db8ee75dd", "committedDate": "2020-07-02T07:42:26Z", "message": "Destroy global indexes when the map is being destroyed"}, "afterCommit": {"oid": "cd6d8a67eb1b7dfd50f5d291c357e415c54d796e", "author": {"user": {"login": "petrpleshachkov", "name": null}}, "url": "https://github.com/hazelcast/hazelcast/commit/cd6d8a67eb1b7dfd50f5d291c357e415c54d796e", "committedDate": "2020-07-03T13:05:37Z", "message": "Destroy global indexes when the map is being destroyed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyODM5NDU0", "url": "https://github.com/hazelcast/hazelcast/pull/17133#pullrequestreview-442839454", "createdAt": "2020-07-06T07:38:24Z", "commit": {"oid": "cd6d8a67eb1b7dfd50f5d291c357e415c54d796e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50c3ec0cd8ff6bfb1dc200fa9ad63a0ea8d83555", "author": {"user": {"login": "petrpleshachkov", "name": null}}, "url": "https://github.com/hazelcast/hazelcast/commit/50c3ec0cd8ff6bfb1dc200fa9ad63a0ea8d83555", "committedDate": "2020-07-07T12:29:27Z", "message": "HD SQL: integrate concurrent off-heap B+tree index into the old query engine\n\n* Introduced a global system property to enable global HD indexes;\n\n* Introduced a new HDOrderedConcurrentIndexStore (based on BPlusTree) for global HD indexes\nsupport;\n\n* Fallback to the old partitioned HD index if the global indices are\ndisabled for HD.\n\nCloses https://github.com/hazelcast/hazelcast-enterprise/issues/3652"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "239cb6c4f4bb4274841d7ddf573b3c5391a74e26", "author": {"user": {"login": "petrpleshachkov", "name": null}}, "url": "https://github.com/hazelcast/hazelcast/commit/239cb6c4f4bb4274841d7ddf573b3c5391a74e26", "committedDate": "2020-07-07T12:29:27Z", "message": "Disabled global lock for on-heap indexes\n\nOtherwise the updates are not atomic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be7262d3f99cfa14f2f20c4361a66b01b0f697c5", "author": {"user": {"login": "petrpleshachkov", "name": null}}, "url": "https://github.com/hazelcast/hazelcast/commit/be7262d3f99cfa14f2f20c4361a66b01b0f697c5", "committedDate": "2020-07-07T12:29:27Z", "message": "Minor: made code a bit simpler"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ff173584a3338322a565d2e6ea4281a7717da3d", "author": {"user": {"login": "petrpleshachkov", "name": null}}, "url": "https://github.com/hazelcast/hazelcast/commit/6ff173584a3338322a565d2e6ea4281a7717da3d", "committedDate": "2020-07-07T12:29:27Z", "message": "Removed a felftover code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be7c5ce852d274d9ce10ff7607e11520fd5dc383", "author": {"user": {"login": "petrpleshachkov", "name": null}}, "url": "https://github.com/hazelcast/hazelcast/commit/be7c5ce852d274d9ce10ff7607e11520fd5dc383", "committedDate": "2020-07-07T12:29:27Z", "message": "Fixed a race condition in indices stats"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99f225db55e444b925821291c1a52675f876b965", "author": {"user": {"login": "petrpleshachkov", "name": null}}, "url": "https://github.com/hazelcast/hazelcast/commit/99f225db55e444b925821291c1a52675f876b965", "committedDate": "2020-07-07T12:29:27Z", "message": "Prevent destroying HD Storage on migration\n\nbefore it can be used by other logic."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3be542e280f8c0f772c03d127cf1547a6fe3b44c", "author": {"user": {"login": "petrpleshachkov", "name": null}}, "url": "https://github.com/hazelcast/hazelcast/commit/3be542e280f8c0f772c03d127cf1547a6fe3b44c", "committedDate": "2020-07-07T12:29:27Z", "message": "Adjusted a unit test to handle global HD indices"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3927f5cdd30a4dc2e8a50d70bd68622125a854aa", "author": {"user": {"login": "petrpleshachkov", "name": null}}, "url": "https://github.com/hazelcast/hazelcast/commit/3927f5cdd30a4dc2e8a50d70bd68622125a854aa", "committedDate": "2020-07-07T12:29:27Z", "message": "Adjusted a unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "27e9681d70de1854b8b71cf7097f5037777a4b08", "author": {"user": {"login": "petrpleshachkov", "name": null}}, "url": "https://github.com/hazelcast/hazelcast/commit/27e9681d70de1854b8b71cf7097f5037777a4b08", "committedDate": "2020-07-07T12:29:27Z", "message": "Adjusted a unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7eb115508b52c5faa85b10a0415b49a8df09944e", "author": {"user": {"login": "petrpleshachkov", "name": null}}, "url": "https://github.com/hazelcast/hazelcast/commit/7eb115508b52c5faa85b10a0415b49a8df09944e", "committedDate": "2020-07-07T12:29:27Z", "message": "Destroy global indexes when the map is being destroyed"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cd6d8a67eb1b7dfd50f5d291c357e415c54d796e", "author": {"user": {"login": "petrpleshachkov", "name": null}}, "url": "https://github.com/hazelcast/hazelcast/commit/cd6d8a67eb1b7dfd50f5d291c357e415c54d796e", "committedDate": "2020-07-03T13:05:37Z", "message": "Destroy global indexes when the map is being destroyed"}, "afterCommit": {"oid": "7eb115508b52c5faa85b10a0415b49a8df09944e", "author": {"user": {"login": "petrpleshachkov", "name": null}}, "url": "https://github.com/hazelcast/hazelcast/commit/7eb115508b52c5faa85b10a0415b49a8df09944e", "committedDate": "2020-07-07T12:29:27Z", "message": "Destroy global indexes when the map is being destroyed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzODMwMzk0", "url": "https://github.com/hazelcast/hazelcast/pull/17133#pullrequestreview-443830394", "createdAt": "2020-07-07T12:13:48Z", "commit": {"oid": "cd6d8a67eb1b7dfd50f5d291c357e415c54d796e"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxMjoxMzo0OFrOGt7wJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxMjozMTowNVrOGt8U8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDgxODA4NA==", "bodyText": "The javadoc looks outdated comparing to the actual code.", "url": "https://github.com/hazelcast/hazelcast/pull/17133#discussion_r450818084", "createdAt": "2020-07-07T12:13:48Z", "author": {"login": "taburet"}, "path": "hazelcast/src/main/java/com/hazelcast/query/impl/BaseSingleValueIndexStore.java", "diffHunk": "@@ -27,13 +27,24 @@\n  * The base store for indexes that are unable to work with multi-value\n  * attributes natively. For such indexes {@link MultiResult}s are split into\n  * individual values and each value is inserted/removed separately.\n+ * <p>\n+ * All operations on the index store like insert/remove/getRecords are\n+ * not guarded by a global lock. The subclasses must either implement thread-safe", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd6d8a67eb1b7dfd50f5d291c357e415c54d796e"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDgyNzUwNw==", "bodyText": "Looks like we still can relax the locking a bit: take the locks for mutating operations and skip the locking for index queries. Probably there is no that much sense in doing so, the benefits would be visible for the old engine mainly, the new engine would not use the locks for the new iterator-based index query API, if understand things right. WDYT guys?", "url": "https://github.com/hazelcast/hazelcast/pull/17133#discussion_r450827507", "createdAt": "2020-07-07T12:31:05Z", "author": {"login": "taburet"}, "path": "hazelcast/src/main/java/com/hazelcast/query/impl/OrderedIndexStore.java", "diffHunk": "@@ -45,7 +45,7 @@\n     private volatile Map<Data, QueryableEntry> recordsWithNullValue;\n \n     public OrderedIndexStore(IndexCopyBehavior copyOn) {\n-        super(copyOn);\n+        super(copyOn, true);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ1MTY2MA=="}, "originalCommit": {"oid": "01f680f9a967646e8e27cb05842ac1a06412d046"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "204e18f39e0d45214bbc74711587ab78422311f2", "author": {"user": {"login": "petrpleshachkov", "name": null}}, "url": "https://github.com/hazelcast/hazelcast/commit/204e18f39e0d45214bbc74711587ab78422311f2", "committedDate": "2020-07-07T12:40:44Z", "message": "Fixed JavaDoc"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3506, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}