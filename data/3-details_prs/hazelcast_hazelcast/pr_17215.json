{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ5MDE5MTk5", "number": 17215, "title": "Introduce auto-disposable tasks for ScheduledExecutor", "bodyText": "Issue: #16994\nHazelcast client protocol PR: hazelcast/hazelcast-client-protocol#330", "createdAt": "2020-07-14T17:38:37Z", "url": "https://github.com/hazelcast/hazelcast/pull/17215", "merged": true, "mergeCommit": {"oid": "4609d0b461fce1a7aea462b0e128d5f5e81d3e7e"}, "closed": true, "closedAt": "2020-07-26T17:51:08Z", "author": {"login": "peterjot"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc24E38AFqTQ1MTk1NDIwNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc4HBq2AH2gAyNDQ5MDE5MTk5OmJmMWU1MmQwNzA1MzQzNGM5MDJhYWViNmQzMDI4N2QwYjRhNDQ5YzM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxOTU0MjA0", "url": "https://github.com/hazelcast/hazelcast/pull/17215#pullrequestreview-451954204", "createdAt": "2020-07-20T20:58:00Z", "commit": {"oid": "502a4cfa5a4d0d225c7ebc26be680f4b47775e87"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQyMDo1ODowMFrOG0fCKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQyMDo1ODowMFrOG0fCKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY4NzU5Mg==", "bodyText": "I like what you did here, but unfortunately the NamedTask marker is public, meaning anyone can implement it directly without the use of our helper. In this case, the AbstractTaskDecorator inheritance expectation is not going to be valid.", "url": "https://github.com/hazelcast/hazelcast/pull/17215#discussion_r457687592", "createdAt": "2020-07-20T20:58:00Z", "author": {"login": "tkountis"}, "path": "hazelcast/src/main/java/com/hazelcast/client/impl/proxy/ClientScheduledExecutorProxy.java", "diffHunk": "@@ -382,12 +394,19 @@ private int getTaskOrKeyPartitionId(Runnable task, Object key) {\n     }\n \n     private String extractNameOrGenerateOne(Object command) {\n-        String name = null;\n-        if (command instanceof NamedTask) {\n-            name = ((NamedTask) command).getName();\n-        }\n+        String taskName = getNamedTaskName(command);\n+        return taskName != null ? taskName : UuidUtil.newUnsecureUuidString();\n+    }\n \n-        return name != null ? name : UuidUtil.newUnsecureUuidString();\n+    private String getNamedTaskName(Object command) {\n+        if (command instanceof AbstractTaskDecorator) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "502a4cfa5a4d0d225c7ebc26be680f4b47775e87"}, "originalPosition": 98}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxOTU1MTE4", "url": "https://github.com/hazelcast/hazelcast/pull/17215#pullrequestreview-451955118", "createdAt": "2020-07-20T20:59:25Z", "commit": {"oid": "502a4cfa5a4d0d225c7ebc26be680f4b47775e87"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQyMDo1OToyNVrOG0fE9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQyMDo1OToyNVrOG0fE9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY4ODMwOQ==", "bodyText": "Same here.", "url": "https://github.com/hazelcast/hazelcast/pull/17215#discussion_r457688309", "createdAt": "2020-07-20T20:59:25Z", "author": {"login": "tkountis"}, "path": "hazelcast/src/main/java/com/hazelcast/client/impl/proxy/ClientScheduledExecutorProxy.java", "diffHunk": "@@ -433,4 +452,11 @@ private String extractNameOrGenerateOne(Object command) {\n             throw rethrow(e);\n         }\n     }\n+\n+    private boolean isAutoDisposable(Object command) {\n+        if (command instanceof AbstractTaskDecorator) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "502a4cfa5a4d0d225c7ebc26be680f4b47775e87"}, "originalPosition": 133}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxOTYyMzc2", "url": "https://github.com/hazelcast/hazelcast/pull/17215#pullrequestreview-451962376", "createdAt": "2020-07-20T21:11:17Z", "commit": {"oid": "502a4cfa5a4d0d225c7ebc26be680f4b47775e87"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQyMToxMToxN1rOG0fbTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQyMToxMToxN1rOG0fbTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY5NDAzMA==", "bodyText": "Same concerns as client proxy", "url": "https://github.com/hazelcast/hazelcast/pull/17215#discussion_r457694030", "createdAt": "2020-07-20T21:11:17Z", "author": {"login": "tkountis"}, "path": "hazelcast/src/main/java/com/hazelcast/scheduledexecutor/impl/ScheduledExecutorServiceProxy.java", "diffHunk": "@@ -493,11 +503,10 @@ private String extractNameOrGenerateOne(Object command) {\n         return createFutureProxy(uuid, taskName);\n     }\n \n-    @SuppressWarnings(\"unchecked\")\n     private <T> T initializeManagedContext(Object object) {\n         ManagedContext context = getNodeEngine().getSerializationService().getManagedContext();\n-        if (object instanceof NamedTaskDecorator) {\n-            ((NamedTaskDecorator) object).initializeContext(context);\n+        if (object instanceof AbstractTaskDecorator) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "502a4cfa5a4d0d225c7ebc26be680f4b47775e87"}, "originalPosition": 90}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxOTY2MTg2", "url": "https://github.com/hazelcast/hazelcast/pull/17215#pullrequestreview-451966186", "createdAt": "2020-07-20T21:17:38Z", "commit": {"oid": "502a4cfa5a4d0d225c7ebc26be680f4b47775e87"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQyMToxNzozOFrOG0fnUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQyMToxNzozOFrOG0fnUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY5NzEwNg==", "bodyText": "Thread.sleep as you already mentioned is prone to cause flakiness. See assertTrueEventually which works with the maximum test waiting time.", "url": "https://github.com/hazelcast/hazelcast/pull/17215#discussion_r457697106", "createdAt": "2020-07-20T21:17:38Z", "author": {"login": "tkountis"}, "path": "hazelcast/src/test/java/com/hazelcast/scheduledexecutor/impl/ScheduledExecutorServiceBasicTest.java", "diffHunk": "@@ -874,6 +904,49 @@ public void schedule_thenCancelAndGet() throws Exception {\n         first.get();\n     }\n \n+    @Test\n+    public void schedule_whenAutoDisposable_thenGet() throws Exception {\n+        HazelcastInstance[] instances = createClusterWithCount(2);\n+        IScheduledExecutorService executorService = getScheduledExecutor(instances, \"s\");\n+\n+        IScheduledFuture<Double> future = executorService.schedule(autoDisposable(new PlainCallableTask()), 1, SECONDS);\n+\n+        expected.expect(ExecutionException.class);\n+        expected.expectCause(isA(StaleTaskException.class));\n+        Thread.sleep(2000);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "502a4cfa5a4d0d225c7ebc26be680f4b47775e87"}, "originalPosition": 63}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "502a4cfa5a4d0d225c7ebc26be680f4b47775e87", "author": {"user": {"login": "peterjot", "name": "Piotr Jasina"}}, "url": "https://github.com/hazelcast/hazelcast/commit/502a4cfa5a4d0d225c7ebc26be680f4b47775e87", "committedDate": "2020-07-20T18:05:23Z", "message": "Regenerate protocol codecs"}, "afterCommit": {"oid": "7a6c5a326fe2c2d6eb6075edc5553a5897272363", "author": {"user": {"login": "peterjot", "name": "Piotr Jasina"}}, "url": "https://github.com/hazelcast/hazelcast/commit/7a6c5a326fe2c2d6eb6075edc5553a5897272363", "committedDate": "2020-07-22T23:15:58Z", "message": "Remove flaky Thread.sleep from tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0MDE4NTcw", "url": "https://github.com/hazelcast/hazelcast/pull/17215#pullrequestreview-454018570", "createdAt": "2020-07-23T10:47:01Z", "commit": {"oid": "7a6c5a326fe2c2d6eb6075edc5553a5897272363"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e082f70e50d17cf78879099e820c12506af4c93", "author": {"user": {"login": "peterjot", "name": "Piotr Jasina"}}, "url": "https://github.com/hazelcast/hazelcast/commit/4e082f70e50d17cf78879099e820c12506af4c93", "committedDate": "2020-07-23T22:04:01Z", "message": "Add autoDisposable flag to TaskDefinition"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd482204717ee9c5e4c539ecd3a6cbef2abbf20a", "author": {"user": {"login": "peterjot", "name": "Piotr Jasina"}}, "url": "https://github.com/hazelcast/hazelcast/commit/fd482204717ee9c5e4c539ecd3a6cbef2abbf20a", "committedDate": "2020-07-23T22:04:02Z", "message": "Dispose the auto-disposable task on state-sync"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54db6741b158281a0243311022f3cbd9a19c04f6", "author": {"user": {"login": "peterjot", "name": "Piotr Jasina"}}, "url": "https://github.com/hazelcast/hazelcast/commit/54db6741b158281a0243311022f3cbd9a19c04f6", "committedDate": "2020-07-23T22:04:02Z", "message": "Add AutoDisposableTask interface to check whether the task is auto-disposable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c7480bc3851d485051511a26085c25b6f3f9b4c", "author": {"user": {"login": "peterjot", "name": "Piotr Jasina"}}, "url": "https://github.com/hazelcast/hazelcast/commit/7c7480bc3851d485051511a26085c25b6f3f9b4c", "committedDate": "2020-07-23T22:04:03Z", "message": "Regenerate protocol codecs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20b116f7260ca5734bf3bf68a4a3dddbd67c793b", "author": {"user": {"login": "peterjot", "name": "Piotr Jasina"}}, "url": "https://github.com/hazelcast/hazelcast/commit/20b116f7260ca5734bf3bf68a4a3dddbd67c793b", "committedDate": "2020-07-23T22:04:03Z", "message": "Handle task implementing NamedTask interface"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83d04646fb6e28f9b0c57825d0fc9dc07afd7736", "author": {"user": {"login": "peterjot", "name": "Piotr Jasina"}}, "url": "https://github.com/hazelcast/hazelcast/commit/83d04646fb6e28f9b0c57825d0fc9dc07afd7736", "committedDate": "2020-07-23T22:04:04Z", "message": "Remove flaky Thread.sleep from tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf17183680c7c7bff1e7a8bfae224b1ba06627d1", "author": {"user": {"login": "peterjot", "name": "Piotr Jasina"}}, "url": "https://github.com/hazelcast/hazelcast/commit/cf17183680c7c7bff1e7a8bfae224b1ba06627d1", "committedDate": "2020-07-23T22:04:04Z", "message": "Test: getScheduled when a task implementing NamedTask"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7a6c5a326fe2c2d6eb6075edc5553a5897272363", "author": {"user": {"login": "peterjot", "name": "Piotr Jasina"}}, "url": "https://github.com/hazelcast/hazelcast/commit/7a6c5a326fe2c2d6eb6075edc5553a5897272363", "committedDate": "2020-07-22T23:15:58Z", "message": "Remove flaky Thread.sleep from tests"}, "afterCommit": {"oid": "cf17183680c7c7bff1e7a8bfae224b1ba06627d1", "author": {"user": {"login": "peterjot", "name": "Piotr Jasina"}}, "url": "https://github.com/hazelcast/hazelcast/commit/cf17183680c7c7bff1e7a8bfae224b1ba06627d1", "committedDate": "2020-07-23T22:04:04Z", "message": "Test: getScheduled when a task implementing NamedTask"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0Nzk1Nzc5", "url": "https://github.com/hazelcast/hazelcast/pull/17215#pullrequestreview-454795779", "createdAt": "2020-07-24T10:52:45Z", "commit": {"oid": "cf17183680c7c7bff1e7a8bfae224b1ba06627d1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf1e52d07053434c902aaeb6d30287d0b4a449c3", "author": {"user": {"login": "peterjot", "name": "Piotr Jasina"}}, "url": "https://github.com/hazelcast/hazelcast/commit/bf1e52d07053434c902aaeb6d30287d0b4a449c3", "committedDate": "2020-07-24T16:57:00Z", "message": "Regenerate protocol"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3570, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}