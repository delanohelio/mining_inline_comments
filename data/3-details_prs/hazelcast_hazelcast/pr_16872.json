{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAxNDEzNDUx", "number": 16872, "title": "Remove assert and log instead ", "bodyText": "closes #16837\nIt is a known issue that permit count can exceed allowed max parallelization count. Given that the issue happens rarely, when it happens, there is no real reason to make replica sync process fail.\nIn this PR, not to introduce a complex fix, we are improving the situation and trying to keep released permit count eventually under max allowed and logging any anomalies as a warning.", "createdAt": "2020-04-09T13:08:14Z", "url": "https://github.com/hazelcast/hazelcast/pull/16872", "merged": true, "mergeCommit": {"oid": "14e3008aec2b518b37a50713aab73631ae35433a"}, "closed": true, "closedAt": "2020-04-10T12:53:41Z", "author": {"login": "ahmetmircik"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcV8UIVgH2gAyNDAxNDEzNDUxOmQ0NTE3MzNlNmZiNzI2YWY3ZjgwNjNmOWVlYzY1MWM3YmZkNWQyNmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcWQk0ngFqTM5MTQyNTY5NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d451733e6fb726af7f8063f9eec651c7bfd5d26a", "author": {"user": {"login": "ahmetmircik", "name": "Ahmet Mircik"}}, "url": "https://github.com/hazelcast/hazelcast/commit/d451733e6fb726af7f8063f9eec651c7bfd5d26a", "committedDate": "2020-04-09T13:14:47Z", "message": "Remove assert and log instead"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "609e2e77ef61a4f2d5b39297f3458f091876e307", "author": {"user": {"login": "ahmetmircik", "name": "Ahmet Mircik"}}, "url": "https://github.com/hazelcast/hazelcast/commit/609e2e77ef61a4f2d5b39297f3458f091876e307", "committedDate": "2020-04-09T13:05:08Z", "message": "Remove assert and log instead"}, "afterCommit": {"oid": "d451733e6fb726af7f8063f9eec651c7bfd5d26a", "author": {"user": {"login": "ahmetmircik", "name": "Ahmet Mircik"}}, "url": "https://github.com/hazelcast/hazelcast/commit/d451733e6fb726af7f8063f9eec651c7bfd5d26a", "committedDate": "2020-04-09T13:14:47Z", "message": "Remove assert and log instead"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMzAxNzMw", "url": "https://github.com/hazelcast/hazelcast/pull/16872#pullrequestreview-391301730", "createdAt": "2020-04-10T07:16:02Z", "commit": {"oid": "d451733e6fb726af7f8063f9eec651c7bfd5d26a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQwNzoxNjowM1rOGDzEjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQwNzoxNjowM1rOGDzEjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjYzNTY2Mg==", "bodyText": "I'm not fully understanding the logic so I'm not sure how bad the situation actually is when you would run into this assert failure. But if we log it to finest, it is effectively the same as removing the checking completely because it will be lost.\nIsn't it better to throw an exception?", "url": "https://github.com/hazelcast/hazelcast/pull/16872#discussion_r406635662", "createdAt": "2020-04-10T07:16:03Z", "author": {"login": "pveentjer"}, "path": "hazelcast/src/main/java/com/hazelcast/internal/partition/impl/PartitionReplicaManager.java", "diffHunk": "@@ -409,13 +413,21 @@ public int tryAcquireReplicaSyncPermits(int requestedPermits) {\n      */\n     public void releaseReplicaSyncPermits(int permits) {\n         assert permits > 0 : \"Invalid permits: \" + permits;\n+\n         replicaSyncSemaphore.release(permits);\n+\n         if (logger.isFinestEnabled()) {\n-            logger.finest(\"Released \" + permits + \" replica sync permits. Available permits: \"\n-                        + replicaSyncSemaphore.availablePermits());\n+            int availableReplicaSyncPermits = availableReplicaSyncPermits();\n+\n+            logger.finest(format(\"Released %d replica sync permits. Available permits: %d\",\n+                    permits, availableReplicaSyncPermits));\n+\n+            if (availableReplicaSyncPermits <= maxParallelReplications) {\n+                logger.finest(format(\"Replica sync permits exceeded the configured number! (available: %d, max: %d)\",\n+                        availableReplicaSyncPermits, maxParallelReplications));\n+\n+            }\n         }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d451733e6fb726af7f8063f9eec651c7bfd5d26a"}, "originalPosition": 105}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c6850412a216437d07d3c53c16ef7a02c15f89c", "author": {"user": {"login": "ahmetmircik", "name": "Ahmet Mircik"}}, "url": "https://github.com/hazelcast/hazelcast/commit/4c6850412a216437d07d3c53c16ef7a02c15f89c", "committedDate": "2020-04-10T10:38:55Z", "message": "Address review comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fb5487ed9dc3a62271451ae07e5471c945930bd7", "author": {"user": {"login": "ahmetmircik", "name": "Ahmet Mircik"}}, "url": "https://github.com/hazelcast/hazelcast/commit/fb5487ed9dc3a62271451ae07e5471c945930bd7", "committedDate": "2020-04-10T10:31:45Z", "message": "Address review comments"}, "afterCommit": {"oid": "4c6850412a216437d07d3c53c16ef7a02c15f89c", "author": {"user": {"login": "ahmetmircik", "name": "Ahmet Mircik"}}, "url": "https://github.com/hazelcast/hazelcast/commit/4c6850412a216437d07d3c53c16ef7a02c15f89c", "committedDate": "2020-04-10T10:38:55Z", "message": "Address review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76046825d3c5d87f522f601298d61726f7a1cc07", "author": {"user": {"login": "ahmetmircik", "name": "Ahmet Mircik"}}, "url": "https://github.com/hazelcast/hazelcast/commit/76046825d3c5d87f522f601298d61726f7a1cc07", "committedDate": "2020-04-10T10:48:01Z", "message": "Address review comments: pertmitsToRelease"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMzgzOTA5", "url": "https://github.com/hazelcast/hazelcast/pull/16872#pullrequestreview-391383909", "createdAt": "2020-04-10T10:49:30Z", "commit": {"oid": "76046825d3c5d87f522f601298d61726f7a1cc07"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNDI1Njk0", "url": "https://github.com/hazelcast/hazelcast/pull/16872#pullrequestreview-391425694", "createdAt": "2020-04-10T12:51:07Z", "commit": {"oid": "76046825d3c5d87f522f601298d61726f7a1cc07"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3769, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}