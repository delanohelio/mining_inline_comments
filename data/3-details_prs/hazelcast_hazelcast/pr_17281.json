{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU5MzA1NjY2", "number": 17281, "title": "Update SQL public API to include update count", "bodyText": "Client protocol PR: hazelcast/hazelcast-client-protocol#332", "createdAt": "2020-07-30T15:27:59Z", "url": "https://github.com/hazelcast/hazelcast/pull/17281", "merged": true, "mergeCommit": {"oid": "985cbbcd6c3188d9d3b74a870286b2cd71053a28"}, "closed": true, "closedAt": "2020-08-04T07:30:55Z", "author": {"login": "viliam-durina"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc6BE9sgH2gAyNDU5MzA1NjY2OjIwZmY1M2NkYTI5ZWRkZjU2ZDFmYTMzNjRkZWZiNzVjN2IzM2YxOTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7hKvogFqTQ2MDU0ODA1NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "20ff53cda29eddf56d1fa3364defb75c7b33f198", "author": {"user": {"login": "viliam-durina", "name": "Viliam Durina"}}, "url": "https://github.com/hazelcast/hazelcast/commit/20ff53cda29eddf56d1fa3364defb75c7b33f198", "committedDate": "2020-07-30T15:09:01Z", "message": "Update SQL public API to include update count\n\nClient protocol PR: hazelcast/hazelcast-client-protocol#332"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b82c6c1bf045600c8ed5a1f11b4a8adf8aef056", "author": {"user": {"login": "viliam-durina", "name": "Viliam Durina"}}, "url": "https://github.com/hazelcast/hazelcast/commit/4b82c6c1bf045600c8ed5a1f11b4a8adf8aef056", "committedDate": "2020-07-30T15:27:45Z", "message": "Add tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4OTMwOTE0", "url": "https://github.com/hazelcast/hazelcast/pull/17281#pullrequestreview-458930914", "createdAt": "2020-07-31T05:51:18Z", "commit": {"oid": "4b82c6c1bf045600c8ed5a1f11b4a8adf8aef056"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwNTo1MToxOFrOG58x4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwNTo1MToxOFrOG58x4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQxNzgyNQ==", "bodyText": "Looks like this should be changed to hazelcastInstance.getSql().query(\"UPDATE ...\").updatedCount()", "url": "https://github.com/hazelcast/hazelcast/pull/17281#discussion_r463417825", "createdAt": "2020-07-31T05:51:18Z", "author": {"login": "devozerov"}, "path": "hazelcast/src/main/java/com/hazelcast/sql/SqlResult.java", "diffHunk": "@@ -35,13 +41,32 @@\n  * }\n  * </pre>\n  *\n- * @see #iterator()\n- * @see #close()\n+ * <p>\n+ * <h4>Usage for update count</h4>\n+ *\n+ * <pre>\n+ *     long updated = hazelcastInstance.getSql().query(\"UPDATE ...\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b82c6c1bf045600c8ed5a1f11b4a8adf8aef056"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4OTMxMjcw", "url": "https://github.com/hazelcast/hazelcast/pull/17281#pullrequestreview-458931270", "createdAt": "2020-07-31T05:52:29Z", "commit": {"oid": "4b82c6c1bf045600c8ed5a1f11b4a8adf8aef056"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwNTo1MjoyOVrOG58zKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwNTo1MjoyOVrOG58zKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQxODE1NQ==", "bodyText": "There is an inconsistency in naming: updatedCount, but is isUpdateCount.\nShould we rename this method to JDBC-like updateCount?", "url": "https://github.com/hazelcast/hazelcast/pull/17281#discussion_r463418155", "createdAt": "2020-07-31T05:52:29Z", "author": {"login": "devozerov"}, "path": "hazelcast/src/main/java/com/hazelcast/sql/SqlResult.java", "diffHunk": "@@ -53,17 +78,28 @@\n      * The iterator may be requested only once.\n      *\n      * @return iterator\n-     * @throws IllegalStateException if the method is invoked more than once\n+     * @throws IllegalStateException if the method is invoked more than once or\n+     *    if this result doesn't have rows (i.e. when {@link #isUpdateCount()}\n+     *    returns {@code true})\n      * @throws SqlException in case of an SQL-related error condition\n      */\n     @Nonnull\n     @Override\n     Iterator<SqlRow> iterator();\n \n     /**\n-     * Release the resources associated with the query result.\n+     * Returns the number of rows updated by the execution.\n+     *\n+     * @throws IllegalStateException if this result doesn't represent an update\n+     *     count (i.e. when {@link #isUpdateCount()} returns {@code false})\n+     */\n+    long updatedCount();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b82c6c1bf045600c8ed5a1f11b4a8adf8aef056"}, "originalPosition": 81}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4OTMyMzQz", "url": "https://github.com/hazelcast/hazelcast/pull/17281#pullrequestreview-458932343", "createdAt": "2020-07-31T05:55:56Z", "commit": {"oid": "4b82c6c1bf045600c8ed5a1f11b4a8adf8aef056"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwNTo1NTo1N1rOG5821w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwNTo1NTo1N1rOG5821w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQxOTA5NQ==", "bodyText": "In JDBC, if the result is a result set, then -1 is returned. But we throw an exception.\nNot advocating for any of these approaches, my question is - do we have any specific reason to prefer one over the other? One minor advantage of the -1 marker, is that we may use it instead of isUpdateCount to check for result type.", "url": "https://github.com/hazelcast/hazelcast/pull/17281#discussion_r463419095", "createdAt": "2020-07-31T05:55:57Z", "author": {"login": "devozerov"}, "path": "hazelcast/src/main/java/com/hazelcast/sql/SqlResult.java", "diffHunk": "@@ -53,17 +78,28 @@\n      * The iterator may be requested only once.\n      *\n      * @return iterator\n-     * @throws IllegalStateException if the method is invoked more than once\n+     * @throws IllegalStateException if the method is invoked more than once or\n+     *    if this result doesn't have rows (i.e. when {@link #isUpdateCount()}\n+     *    returns {@code true})\n      * @throws SqlException in case of an SQL-related error condition\n      */\n     @Nonnull\n     @Override\n     Iterator<SqlRow> iterator();\n \n     /**\n-     * Release the resources associated with the query result.\n+     * Returns the number of rows updated by the execution.\n+     *\n+     * @throws IllegalStateException if this result doesn't represent an update", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b82c6c1bf045600c8ed5a1f11b4a8adf8aef056"}, "originalPosition": 78}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4OTMzMjIx", "url": "https://github.com/hazelcast/hazelcast/pull/17281#pullrequestreview-458933221", "createdAt": "2020-07-31T05:58:37Z", "commit": {"oid": "4b82c6c1bf045600c8ed5a1f11b4a8adf8aef056"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwNTo1ODozN1rOG585uw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwNTo1ODozN1rOG585uw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQxOTgzNQ==", "bodyText": "A minor thought to consider - we may have a method to check for \"update count\", like now, or we may have a method to check for result set, e.g. hasResultSet. Which one is better?", "url": "https://github.com/hazelcast/hazelcast/pull/17281#discussion_r463419835", "createdAt": "2020-07-31T05:58:37Z", "author": {"login": "devozerov"}, "path": "hazelcast/src/main/java/com/hazelcast/sql/SqlResult.java", "diffHunk": "@@ -35,13 +41,32 @@\n  * }\n  * </pre>\n  *\n- * @see #iterator()\n- * @see #close()\n+ * <p>\n+ * <h4>Usage for update count</h4>\n+ *\n+ * <pre>\n+ *     long updated = hazelcastInstance.getSql().query(\"UPDATE ...\");\n+ * </pre>\n+ *\n+ * You don't need to call {@link #close()} in this case.\n  */\n public interface SqlResult extends Iterable<SqlRow>, AutoCloseable {\n+\n+    /**\n+     * If this result represents a row set, this method returns {@code false}.\n+     * If this result represents an update count (such as for a DML query), it\n+     * returns {@code true}.\n+     *\n+     * @return {@code false} for a rows result and {@code true} for an update\n+     *     count result\n+     */\n+    boolean isUpdateCount();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b82c6c1bf045600c8ed5a1f11b4a8adf8aef056"}, "originalPosition": 50}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4OTMzNDcz", "url": "https://github.com/hazelcast/hazelcast/pull/17281#pullrequestreview-458933473", "createdAt": "2020-07-31T05:59:19Z", "commit": {"oid": "4b82c6c1bf045600c8ed5a1f11b4a8adf8aef056"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwNTo1OToxOVrOG586gQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwNTo1OToxOVrOG586gQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQyMDAzMw==", "bodyText": "On the protocol level, we may encode the missing update count as -1 and thus avoid this flag.", "url": "https://github.com/hazelcast/hazelcast/pull/17281#discussion_r463420033", "createdAt": "2020-07-31T05:59:19Z", "author": {"login": "devozerov"}, "path": "hazelcast/src/main/java/com/hazelcast/client/impl/protocol/codec/SqlExecuteCodec.java", "diffHunk": "@@ -103,6 +105,10 @@ public static ClientMessage encodeRequest(java.lang.String sql, java.util.Collec\n \n     @edu.umd.cs.findbugs.annotations.SuppressFBWarnings({\"URF_UNREAD_PUBLIC_OR_PROTECTED_FIELD\"})\n     public static class ResponseParameters {\n+        /**\n+         * True, if this result is an update count, false, if it contains rows.\n+         */\n+        public boolean isUpdateCount;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b82c6c1bf045600c8ed5a1f11b4a8adf8aef056"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7443bf3a397a3d75b29736ed72f434d6fa0d5103", "author": {"user": {"login": "viliam-durina", "name": "Viliam Durina"}}, "url": "https://github.com/hazelcast/hazelcast/commit/7443bf3a397a3d75b29736ed72f434d6fa0d5103", "committedDate": "2020-08-03T07:42:41Z", "message": "Address some reviews"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5OTc0MzQz", "url": "https://github.com/hazelcast/hazelcast/pull/17281#pullrequestreview-459974343", "createdAt": "2020-08-03T12:10:52Z", "commit": {"oid": "7443bf3a397a3d75b29736ed72f434d6fa0d5103"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwNTQ4MDU0", "url": "https://github.com/hazelcast/hazelcast/pull/17281#pullrequestreview-460548054", "createdAt": "2020-08-04T07:06:13Z", "commit": {"oid": "7443bf3a397a3d75b29736ed72f434d6fa0d5103"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3472, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}