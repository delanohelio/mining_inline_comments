{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY1NzY2NjQy", "number": 16524, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxNDozMTozNlrODZ2fwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QwODo1MjowOVrODaF6Uw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4NDMzODU4OnYy", "diffSide": "RIGHT", "path": "hazelcast/src/test/java/com/hazelcast/config/MapConfigTest.java", "isResolved": false, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxNDozMTozNlrOFgeK8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QwODoxNTo1OVrOFg1r5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU5MzA3Mg==", "bodyText": "Probably not that important but this is just one of possible 4 allowed combinations. I don't think we cover setOptimizeQueries(false) followed by setCacheDeserializedValues(CacheDeserializedValues.INDEX_ONLY), and setCacheDeserializedValues(CacheDeserializedValues.NEVER/INDEX_ONLY) followed by setOptimizeQueries(false).", "url": "https://github.com/hazelcast/hazelcast/pull/16524#discussion_r369593072", "createdAt": "2020-01-22T14:31:36Z", "author": {"login": "vojtechtoman"}, "path": "hazelcast/src/test/java/com/hazelcast/config/MapConfigTest.java", "diffHunk": "@@ -401,6 +401,16 @@ public void givenSetOptimizeQueryIsTrue_whenSetCacheDeserializedValuesToINDEX_ON\n         mapConfig.setCacheDeserializedValues(CacheDeserializedValues.INDEX_ONLY);\n     }\n \n+    @Test\n+    public void givenSetOptimizeQueryIsFalse_whenSetCacheDeserializedValuesToNEVER_thenNoException() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2076302a3a01da62ab339da2f3d00d4eb26d50b0"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTY3MTE1MQ==", "bodyText": "what's the expected behaviour when INDEX_ONLY is set?", "url": "https://github.com/hazelcast/hazelcast/pull/16524#discussion_r369671151", "createdAt": "2020-01-22T16:38:17Z", "author": {"login": "cangencer"}, "path": "hazelcast/src/test/java/com/hazelcast/config/MapConfigTest.java", "diffHunk": "@@ -401,6 +401,16 @@ public void givenSetOptimizeQueryIsTrue_whenSetCacheDeserializedValuesToINDEX_ON\n         mapConfig.setCacheDeserializedValues(CacheDeserializedValues.INDEX_ONLY);\n     }\n \n+    @Test\n+    public void givenSetOptimizeQueryIsFalse_whenSetCacheDeserializedValuesToNEVER_thenNoException() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU5MzA3Mg=="}, "originalCommit": {"oid": "2076302a3a01da62ab339da2f3d00d4eb26d50b0"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTY4MDAyMQ==", "bodyText": "We actually had another bug which wasn't covered. I've updated the tests and cleaned up the code", "url": "https://github.com/hazelcast/hazelcast/pull/16524#discussion_r369680021", "createdAt": "2020-01-22T16:53:10Z", "author": {"login": "cangencer"}, "path": "hazelcast/src/test/java/com/hazelcast/config/MapConfigTest.java", "diffHunk": "@@ -401,6 +401,16 @@ public void givenSetOptimizeQueryIsTrue_whenSetCacheDeserializedValuesToINDEX_ON\n         mapConfig.setCacheDeserializedValues(CacheDeserializedValues.INDEX_ONLY);\n     }\n \n+    @Test\n+    public void givenSetOptimizeQueryIsFalse_whenSetCacheDeserializedValuesToNEVER_thenNoException() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU5MzA3Mg=="}, "originalCommit": {"oid": "2076302a3a01da62ab339da2f3d00d4eb26d50b0"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTk3NTgxMg==", "bodyText": "I actually don't know what the expected behaviour is with INDEX_ONLY, I simply looked at the current impl. INDEX_ONLY is the default and when setOptimizeQueries(false) is called, this default value does not change.", "url": "https://github.com/hazelcast/hazelcast/pull/16524#discussion_r369975812", "createdAt": "2020-01-23T08:08:32Z", "author": {"login": "vojtechtoman"}, "path": "hazelcast/src/test/java/com/hazelcast/config/MapConfigTest.java", "diffHunk": "@@ -401,6 +401,16 @@ public void givenSetOptimizeQueryIsTrue_whenSetCacheDeserializedValuesToINDEX_ON\n         mapConfig.setCacheDeserializedValues(CacheDeserializedValues.INDEX_ONLY);\n     }\n \n+    @Test\n+    public void givenSetOptimizeQueryIsFalse_whenSetCacheDeserializedValuesToNEVER_thenNoException() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU5MzA3Mg=="}, "originalCommit": {"oid": "2076302a3a01da62ab339da2f3d00d4eb26d50b0"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTk3NzMzMQ==", "bodyText": "ok, so nothing should happen when it's set to false and it's set to INDEX_ONLY?", "url": "https://github.com/hazelcast/hazelcast/pull/16524#discussion_r369977331", "createdAt": "2020-01-23T08:13:06Z", "author": {"login": "cangencer"}, "path": "hazelcast/src/test/java/com/hazelcast/config/MapConfigTest.java", "diffHunk": "@@ -401,6 +401,16 @@ public void givenSetOptimizeQueryIsTrue_whenSetCacheDeserializedValuesToINDEX_ON\n         mapConfig.setCacheDeserializedValues(CacheDeserializedValues.INDEX_ONLY);\n     }\n \n+    @Test\n+    public void givenSetOptimizeQueryIsFalse_whenSetCacheDeserializedValuesToNEVER_thenNoException() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU5MzA3Mg=="}, "originalCommit": {"oid": "2076302a3a01da62ab339da2f3d00d4eb26d50b0"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTk3ODM0MA==", "bodyText": "To be honest, I actually don't know - maybe @jerrinot will be able to help?", "url": "https://github.com/hazelcast/hazelcast/pull/16524#discussion_r369978340", "createdAt": "2020-01-23T08:15:59Z", "author": {"login": "vojtechtoman"}, "path": "hazelcast/src/test/java/com/hazelcast/config/MapConfigTest.java", "diffHunk": "@@ -401,6 +401,16 @@ public void givenSetOptimizeQueryIsTrue_whenSetCacheDeserializedValuesToINDEX_ON\n         mapConfig.setCacheDeserializedValues(CacheDeserializedValues.INDEX_ONLY);\n     }\n \n+    @Test\n+    public void givenSetOptimizeQueryIsFalse_whenSetCacheDeserializedValuesToNEVER_thenNoException() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU5MzA3Mg=="}, "originalCommit": {"oid": "2076302a3a01da62ab339da2f3d00d4eb26d50b0"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4NDQyMDI3OnYy", "diffSide": "RIGHT", "path": "hazelcast/src/main/java/com/hazelcast/config/MapConfig.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxNDo1MjozMVrOFge8vA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxNDo1MjozMVrOFge8vA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTYwNTgyMA==", "bodyText": "I believe this if can be removed now as it has become just a subset of the following if (I think).", "url": "https://github.com/hazelcast/hazelcast/pull/16524#discussion_r369605820", "createdAt": "2020-01-22T14:52:31Z", "author": {"login": "vojtechtoman"}, "path": "hazelcast/src/main/java/com/hazelcast/config/MapConfig.java", "diffHunk": "@@ -851,17 +851,19 @@ private void validateCacheDeserializedValuesOption(CacheDeserializedValues valid\n         if (optimizeQueryExplicitlyInvoked) {\n             // deprecated {@link #setOptimizeQueries(boolean)} was explicitly invoked\n             // we need to be strict with validation to detect conflicts\n-            boolean optimizeQuerySet = (cacheDeserializedValues == CacheDeserializedValues.ALWAYS);\n-            if (optimizeQuerySet && validatedCacheDeserializedValues == CacheDeserializedValues.NEVER) {\n+            boolean optimizeQueryFlag = (cacheDeserializedValues == CacheDeserializedValues.ALWAYS);\n+            if (!optimizeQueryFlag && validatedCacheDeserializedValues == CacheDeserializedValues.NEVER) {\n+                // settings are compatible\n+                return;\n+            }\n+            if (optimizeQueryFlag && validatedCacheDeserializedValues == CacheDeserializedValues.NEVER) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2076302a3a01da62ab339da2f3d00d4eb26d50b0"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4Njc2MzU0OnYy", "diffSide": "RIGHT", "path": "hazelcast/src/main/java/com/hazelcast/config/MapConfig.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QwODoxMzoyN1rOFg1oZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QwODoxMzoyN1rOFg1oZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTk3NzQ0Ng==", "bodyText": "Is this really what we want? INDEX_ONLY is the default, so what makes calling setCacheDeserializedValues(INDEX_ONLY) so significant that it should suddenly trigger an error?", "url": "https://github.com/hazelcast/hazelcast/pull/16524#discussion_r369977446", "createdAt": "2020-01-23T08:13:27Z", "author": {"login": "vojtechtoman"}, "path": "hazelcast/src/main/java/com/hazelcast/config/MapConfig.java", "diffHunk": "@@ -819,16 +819,21 @@ public MapConfig setOptimizeQueries(boolean optimizeQueries) {\n     }\n \n     private void validateSetOptimizeQueriesOption(boolean optimizeQueries) {\n-        if (setCacheDeserializedValuesExplicitlyInvoked) {\n-            if (optimizeQueries && cacheDeserializedValues == CacheDeserializedValues.NEVER) {\n-                throw new ConfigurationException(\"Deprecated option 'optimize-queries' is set to true, \"\n-                        + \"but 'cacheDeserializedValues' is set to NEVER. \"\n-                        + \"These are conflicting options. Please remove the `optimize-queries'\");\n-            } else if (!optimizeQueries && cacheDeserializedValues == CacheDeserializedValues.ALWAYS) {\n-                throw new ConfigurationException(\"Deprecated option 'optimize-queries' is set to false, \"\n-                        + \"but 'cacheDeserializedValues' is set to ALWAYS. \"\n-                        + \"These are conflicting options. Please remove the `optimize-queries'\");\n-            }\n+        if (!setCacheDeserializedValuesExplicitlyInvoked) {\n+            return;\n+        }\n+        if (cacheDeserializedValues == CacheDeserializedValues.INDEX_ONLY) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9778cb7c6183161b159d732b21e4cac67ea42b94"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4NjgzODg5OnYy", "diffSide": "RIGHT", "path": "hazelcast/src/main/java/com/hazelcast/config/MapConfig.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QwODo0MzozNlrOFg2VgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QwODo0MzozNlrOFg2VgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTk4ODk5Mg==", "bodyText": "typo: \"begin\" - > \"being\"", "url": "https://github.com/hazelcast/hazelcast/pull/16524#discussion_r369988992", "createdAt": "2020-01-23T08:43:36Z", "author": {"login": "vojtechtoman"}, "path": "hazelcast/src/main/java/com/hazelcast/config/MapConfig.java", "diffHunk": "@@ -861,13 +858,13 @@ private void validateCacheDeserializedValuesOption(CacheDeserializedValues valid\n         // we need to be strict with validation to detect conflicts\n         boolean optimizeQueryFlag = (cacheDeserializedValues == CacheDeserializedValues.ALWAYS);\n \n-        if (optimizeQueryFlag && validatedCacheDeserializedValues != CacheDeserializedValues.ALWAYS) {\n+        if (optimizeQueryFlag && newValue != CacheDeserializedValues.ALWAYS) {\n             throw new ConfigurationException(\"Deprecated option 'optimize-queries' is set to `true`, \"\n                     + \"but 'cacheDeserializedValues' is being set to NEVER or INDEX_ONLY.\"\n                     + \" These are conflicting options. Please remove the `optimize-queries'\");\n-        } else if (!optimizeQueryFlag && validatedCacheDeserializedValues != CacheDeserializedValues.NEVER) {\n+        } else if (!optimizeQueryFlag && newValue == CacheDeserializedValues.ALWAYS) {\n             throw new ConfigurationException(\"Deprecated option 'optimize-queries' is set to `false`, \"\n-                    + \"but 'cacheDeserializedValues' is begin set to ALWAYS or INDEX_ONLY. These are conflicting options.\"\n+                    + \"but 'cacheDeserializedValues' is begin set to ALWAYS. These are conflicting options.\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2246ba35dbcd7145b210d3476cad9f88e3fa1beb"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4Njg0MjQ5OnYy", "diffSide": "RIGHT", "path": "hazelcast/src/main/java/com/hazelcast/config/MapConfig.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QwODo0NDo1NFrOFg2XnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QwODo0NDo1NFrOFg2XnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTk4OTUzMg==", "bodyText": "really minor: for symmetry with validateCacheDeserializedValuesOption, maybe use: if (cacheDeserializedValues != CacheDeserializedValues.ALWAYS)?", "url": "https://github.com/hazelcast/hazelcast/pull/16524#discussion_r369989532", "createdAt": "2020-01-23T08:44:54Z", "author": {"login": "vojtechtoman"}, "path": "hazelcast/src/main/java/com/hazelcast/config/MapConfig.java", "diffHunk": "@@ -822,17 +822,14 @@ private void validateSetOptimizeQueriesOption(boolean optimizeQueries) {\n         if (!setCacheDeserializedValuesExplicitlyInvoked) {\n             return;\n         }\n-        if (cacheDeserializedValues == CacheDeserializedValues.INDEX_ONLY) {\n-            throw new ConfigurationException(\"Deprecated option 'optimize-queries' is being set\"\n-                    + \", but 'cacheDeserializedValues' was set to INDEX_ONLY. \"\n-                    + \"These are conflicting options. Please remove the `optimize-queries'\");\n-        } else if (cacheDeserializedValues == CacheDeserializedValues.NEVER && optimizeQueries) {\n+        if ((cacheDeserializedValues == CacheDeserializedValues.INDEX_ONLY ||\n+                cacheDeserializedValues == CacheDeserializedValues.NEVER) && optimizeQueries) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2246ba35dbcd7145b210d3476cad9f88e3fa1beb"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4Njg2NDE5OnYy", "diffSide": "RIGHT", "path": "hazelcast/src/test/java/com/hazelcast/config/MapConfigTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QwODo1MjowOVrOFg2kSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QwODo1MjowOVrOFg2kSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTk5Mjc3OA==", "bodyText": "At the risk of becoming really annoying now: what about adding givenCacheDeserializedValuesSetToNEVER_whenSetOptimizeQueriesToFalse, too?", "url": "https://github.com/hazelcast/hazelcast/pull/16524#discussion_r369992778", "createdAt": "2020-01-23T08:52:09Z", "author": {"login": "vojtechtoman"}, "path": "hazelcast/src/test/java/com/hazelcast/config/MapConfigTest.java", "diffHunk": "@@ -312,8 +312,8 @@ public void givenCacheDeserializedValuesSetToALWAYS_whenSetOptimizeQueriesToFals\n         mapConfig.setOptimizeQueries(false);\n     }\n \n-    @Test(expected = ConfigurationException.class)\n-    public void givenCacheDeserializedValuesSetToINDEX_ONLY_whenSetOptimizeQueriesToFalse_thenThrowConfigurationException() {\n+    @Test\n+    public void givenCacheDeserializedValuesSetToINDEX_ONLY_whenSetOptimizeQueriesToFalse_thenNoException() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2246ba35dbcd7145b210d3476cad9f88e3fa1beb"}, "originalPosition": 7}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 780, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}