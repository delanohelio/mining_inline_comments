{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcxNDY3Njc4", "number": 16618, "title": "Fix txn near cache", "bodyText": "Fixes: #16577\nBackport of: #16579\nee: hazelcast/hazelcast-enterprise#3514", "createdAt": "2020-02-05T16:28:47Z", "url": "https://github.com/hazelcast/hazelcast/pull/16618", "merged": true, "mergeCommit": {"oid": "d24c0195ce690f5e10d02e718f6383a1e3a4cf6d"}, "closed": true, "closedAt": "2020-02-11T08:57:24Z", "author": {"login": "ahmetmircik"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBY9NTgBqjMwMTA3NTYwODA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcC9UZSgFqTM1NTk0MjIxMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7a996faec15e19c54553ec6058aa4ff6ee325c3e", "author": {"user": {"login": "ahmetmircik", "name": "Ahmet Mircik"}}, "url": "https://github.com/hazelcast/hazelcast/commit/7a996faec15e19c54553ec6058aa4ff6ee325c3e", "committedDate": "2020-02-05T12:45:11Z", "message": "Fix txn near cache"}, "afterCommit": {"oid": "997c9bc552b1dcd489880a3f92372b9f73456e9b", "author": {"user": {"login": "ahmetmircik", "name": "Ahmet Mircik"}}, "url": "https://github.com/hazelcast/hazelcast/commit/997c9bc552b1dcd489880a3f92372b9f73456e9b", "committedDate": "2020-02-05T16:44:24Z", "message": "Fix txn near cache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a37ead056e9394ab2719dc3d030c4925206cebc7", "author": {"user": {"login": "ahmetmircik", "name": "Ahmet Mircik"}}, "url": "https://github.com/hazelcast/hazelcast/commit/a37ead056e9394ab2719dc3d030c4925206cebc7", "committedDate": "2020-02-05T18:07:37Z", "message": "Fix txn near cache"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "997c9bc552b1dcd489880a3f92372b9f73456e9b", "author": {"user": {"login": "ahmetmircik", "name": "Ahmet Mircik"}}, "url": "https://github.com/hazelcast/hazelcast/commit/997c9bc552b1dcd489880a3f92372b9f73456e9b", "committedDate": "2020-02-05T16:44:24Z", "message": "Fix txn near cache"}, "afterCommit": {"oid": "a37ead056e9394ab2719dc3d030c4925206cebc7", "author": {"user": {"login": "ahmetmircik", "name": "Ahmet Mircik"}}, "url": "https://github.com/hazelcast/hazelcast/commit/a37ead056e9394ab2719dc3d030c4925206cebc7", "committedDate": "2020-02-05T18:07:37Z", "message": "Fix txn near cache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b8ecbc7dce7ecd6a2e6b70ad04a28e51fe3d535", "author": {"user": {"login": "ahmetmircik", "name": "Ahmet Mircik"}}, "url": "https://github.com/hazelcast/hazelcast/commit/3b8ecbc7dce7ecd6a2e6b70ad04a28e51fe3d535", "committedDate": "2020-02-05T18:17:11Z", "message": "Checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0Mzk3NDY4", "url": "https://github.com/hazelcast/hazelcast/pull/16618#pullrequestreview-354397468", "createdAt": "2020-02-06T12:00:50Z", "commit": {"oid": "3b8ecbc7dce7ecd6a2e6b70ad04a28e51fe3d535"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxMjowMDo1MFrOFmYsyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxMjowMDo1MFrOFmYsyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTc5NDg5MQ==", "bodyText": "If some exceptions happen in this block, we still call invalidation in the finally. We don't do this in the new code. Is it OK if we have an exceptional scenario? It seems in the new implementation we handle failures only on commit.", "url": "https://github.com/hazelcast/hazelcast/pull/16618#discussion_r375794891", "createdAt": "2020-02-06T12:00:50Z", "author": {"login": "petrpleshachkov"}, "path": "hazelcast/src/main/java/com/hazelcast/map/impl/tx/TransactionalMapProxy.java", "diffHunk": "@@ -143,19 +145,19 @@ public Object put(Object key, Object value, long ttl, TimeUnit timeUnit) {\n         checkNotNull(key, \"key can't be null\");\n         checkNotNull(value, \"value can't be null\");\n \n-        Object nearCacheKey = toNearCacheKeyWithStrategy(key);\n-        try {\n-            Data keyData = mapServiceContext.toData(nearCacheKey, partitionStrategy);\n-            Object valueBeforeTxn = toObjectIfNeeded(putInternal(keyData, mapServiceContext.toData(value), ttl, timeUnit));\n-\n-            TxnValueWrapper currentValue = txMap.get(keyData);\n-            Type type = valueBeforeTxn == null ? Type.NEW : Type.UPDATED;\n-            TxnValueWrapper wrapper = new TxnValueWrapper(value, type);\n-            txMap.put(keyData, wrapper);\n-            return currentValue == null ? valueBeforeTxn : checkIfRemoved(currentValue);\n-        } finally {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3b8ecbc7dce7ecd6a2e6b70ad04a28e51fe3d535"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0NTA5NjY0", "url": "https://github.com/hazelcast/hazelcast/pull/16618#pullrequestreview-354509664", "createdAt": "2020-02-06T14:52:40Z", "commit": {"oid": "3b8ecbc7dce7ecd6a2e6b70ad04a28e51fe3d535"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1OTQyMjEw", "url": "https://github.com/hazelcast/hazelcast/pull/16618#pullrequestreview-355942210", "createdAt": "2020-02-10T13:40:25Z", "commit": {"oid": "3b8ecbc7dce7ecd6a2e6b70ad04a28e51fe3d535"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3962, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}