{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI1MjQ5OTM2", "number": 17020, "title": "Fixes interoperability issues with CompletableFuture", "bodyText": "CompletableFuture subclasses DelegatingCompletableFuture and\nAbstractInvocationFuture manage their own completion\nvalue state separately from their superclass.\nHowever CompletableFuture 's\nmethods make use of private CompletableFuture state\nresulting in broken interoperability. This PR ensures that when\nAbstractInvocationFuture/DelegatingCompletableFuture are\ncompleted, the CompletableFuture superclass internal state is\nalso updated to allow for CompletableFuture methods which use\nits internals to work properly.\nSecond commit in this PR fixes a leftover from #16154: dependent\nactions registered with default sync methods (like thenCompose,\nwhenComplete etc) should use the\nConcurrencyUtil#DEFAULT_ASYNC_EXECUTOR. See #16154\ndescription for reasoning.\nFixes #17019", "createdAt": "2020-05-29T18:10:16Z", "url": "https://github.com/hazelcast/hazelcast/pull/17020", "merged": true, "mergeCommit": {"oid": "2b04ed212ad21e4da627407214ec2e3dc489810f"}, "closed": true, "closedAt": "2020-06-16T10:07:11Z", "author": {"login": "vbekiaris"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcmGrQegBqjMzODgzMjEwMjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcrw-lvAFqTQzMTI3NTYwMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d3097a2b382429fc0995d4947437ddeedfbac271", "author": {"user": {"login": "vbekiaris", "name": "Vassilis Bekiaris"}}, "url": "https://github.com/hazelcast/hazelcast/commit/d3097a2b382429fc0995d4947437ddeedfbac271", "committedDate": "2020-05-29T18:07:48Z", "message": "Fixes interoperability issues with CompletableFuture\n\nSubclasses DelegatingCompletableFuture and\nAbstractInvocationFuture manage their own completion\nvalue state separately from superclass\nCompletableFuture. However CompletableFuture's\nmethods make use of private CompletableFuture state\nresulting in broken interoperability."}, "afterCommit": {"oid": "74769b4233694fb7b43768247b011e39fb8f1cff", "author": {"user": {"login": "vbekiaris", "name": "Vassilis Bekiaris"}}, "url": "https://github.com/hazelcast/hazelcast/commit/74769b4233694fb7b43768247b011e39fb8f1cff", "committedDate": "2020-05-29T18:21:34Z", "message": "Fixes interoperability issues with CompletableFuture\n\nSubclasses DelegatingCompletableFuture and\nAbstractInvocationFuture manage their own completion\nvalue state separately from superclass\nCompletableFuture. However CompletableFuture's\nmethods make use of private CompletableFuture state\nresulting in broken interoperability."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "74769b4233694fb7b43768247b011e39fb8f1cff", "author": {"user": {"login": "vbekiaris", "name": "Vassilis Bekiaris"}}, "url": "https://github.com/hazelcast/hazelcast/commit/74769b4233694fb7b43768247b011e39fb8f1cff", "committedDate": "2020-05-29T18:21:34Z", "message": "Fixes interoperability issues with CompletableFuture\n\nSubclasses DelegatingCompletableFuture and\nAbstractInvocationFuture manage their own completion\nvalue state separately from superclass\nCompletableFuture. However CompletableFuture's\nmethods make use of private CompletableFuture state\nresulting in broken interoperability."}, "afterCommit": {"oid": "e8038e3a9d487f55227772839a0e997009e0cc67", "author": {"user": {"login": "vbekiaris", "name": "Vassilis Bekiaris"}}, "url": "https://github.com/hazelcast/hazelcast/commit/e8038e3a9d487f55227772839a0e997009e0cc67", "committedDate": "2020-06-02T09:19:56Z", "message": "Fixes interoperability issues with CompletableFuture\n\nSubclasses DelegatingCompletableFuture and\nAbstractInvocationFuture manage their own completion\nvalue state separately from superclass\nCompletableFuture. However CompletableFuture's\nmethods make use of private CompletableFuture state\nresulting in broken interoperability."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzNjE3NzIx", "url": "https://github.com/hazelcast/hazelcast/pull/17020#pullrequestreview-423617721", "createdAt": "2020-06-03T14:34:49Z", "commit": {"oid": "51f996889305738665f8b1c250531337c78086de"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNDozNDo0OVrOGee1Vg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNDozNDo0OVrOGee1Vg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDYxNTYzOA==", "bodyText": "This test would fail with IllegalStateException because the response thread that completes the setAsync stage is not allowed to make the getAsync remote call. Changing the default dependent action executor to DEFAULT_ASYNC_EXECUTOR fixes this.", "url": "https://github.com/hazelcast/hazelcast/pull/17020#discussion_r434615638", "createdAt": "2020-06-03T14:34:49Z", "author": {"login": "vbekiaris"}, "path": "hazelcast/src/test/java/com/hazelcast/map/BasicMapTest.java", "diffHunk": "@@ -917,6 +918,14 @@ public void testGetPutRemoveAsync() {\n         }\n     }\n \n+    @Test\n+    public void testAsyncMethodChaining() {\n+        IMap<Integer, Integer> map = getInstance().getMap(\"testGetPutRemoveAsync\");\n+        CompletionStage<Integer> setThenGet = map.setAsync(1, 1)\n+                                              .thenCompose(v -> map.getAsync(1));\n+        assertEquals(1L, (long) setThenGet.toCompletableFuture().join());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51f996889305738665f8b1c250531337c78086de"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac91be5b2fe9da20163347ddbf8da27e48ee8fb7", "author": {"user": {"login": "vbekiaris", "name": "Vassilis Bekiaris"}}, "url": "https://github.com/hazelcast/hazelcast/commit/ac91be5b2fe9da20163347ddbf8da27e48ee8fb7", "committedDate": "2020-06-04T15:22:19Z", "message": "Fixes interoperability issues with CompletableFuture\n\nSubclasses DelegatingCompletableFuture and\nAbstractInvocationFuture manage their own completion\nvalue state separately from superclass\nCompletableFuture. However CompletableFuture's\nmethods make use of private CompletableFuture state\nresulting in broken interoperability."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a8b72739b89f3b660108027b33f517ee2ba794a", "author": {"user": {"login": "vbekiaris", "name": "Vassilis Bekiaris"}}, "url": "https://github.com/hazelcast/hazelcast/commit/7a8b72739b89f3b660108027b33f517ee2ba794a", "committedDate": "2020-06-04T16:38:53Z", "message": "Use async executor for dependent actions from default methods\n\nAs described in asynchronous methods javadoc (eg in\nIMap), default non-async method callbacks\nmust be executed by the DEFAULT_ASYNC_EXECUTOR.\nSee #16154 for reasoning."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a21f99b4b31a85e4b74645e77011e873594fe074", "author": {"user": {"login": "vbekiaris", "name": "Vassilis Bekiaris"}}, "url": "https://github.com/hazelcast/hazelcast/commit/a21f99b4b31a85e4b74645e77011e873594fe074", "committedDate": "2020-06-03T15:39:09Z", "message": "Fix test"}, "afterCommit": {"oid": "7a8b72739b89f3b660108027b33f517ee2ba794a", "author": {"user": {"login": "vbekiaris", "name": "Vassilis Bekiaris"}}, "url": "https://github.com/hazelcast/hazelcast/commit/7a8b72739b89f3b660108027b33f517ee2ba794a", "committedDate": "2020-06-04T16:38:53Z", "message": "Use async executor for dependent actions from default methods\n\nAs described in asynchronous methods javadoc (eg in\nIMap), default non-async method callbacks\nmust be executed by the DEFAULT_ASYNC_EXECUTOR.\nSee #16154 for reasoning."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a15cf9e1de5c771c2a7026b853c2797dea67299", "author": {"user": {"login": "vbekiaris", "name": "Vassilis Bekiaris"}}, "url": "https://github.com/hazelcast/hazelcast/commit/6a15cf9e1de5c771c2a7026b853c2797dea67299", "committedDate": "2020-06-05T05:57:03Z", "message": "Return cached value under concurrent requests\n\nIn ClientDelegatingFuture when the current thread\ndoesn't win the CAS to set the cached deserialized\nvalue, return the same deserialized instance that\nis cached. The same behaviour applies in superclass\nDelegatingCompletableFuture."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1MjkyMzQ2", "url": "https://github.com/hazelcast/hazelcast/pull/17020#pullrequestreview-425292346", "createdAt": "2020-06-05T13:21:43Z", "commit": {"oid": "6a15cf9e1de5c771c2a7026b853c2797dea67299"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxMzoyMTo0M1rOGfuOCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxMzoyMTo0M1rOGfuOCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTkxNjI5Nw==", "bodyText": "Minor: why do we not want the parent to listen to the future completion instead?", "url": "https://github.com/hazelcast/hazelcast/pull/17020#discussion_r435916297", "createdAt": "2020-06-05T13:21:43Z", "author": {"login": "mmedenjak"}, "path": "hazelcast/src/main/java/com/hazelcast/client/impl/ClientDelegatingFuture.java", "diffHunk": "@@ -54,14 +54,18 @@\n \n     final boolean deserializeResponse;\n     private final ClientMessageDecoder clientMessageDecoder;\n-    private volatile Object decodedResponse = VOID;\n+    private volatile Object decodedResponse;\n \n     public ClientDelegatingFuture(ClientInvocationFuture clientInvocationFuture,\n                                   SerializationService serializationService,\n                                   ClientMessageDecoder clientMessageDecoder, V defaultValue, boolean deserializeResponse) {\n-        super(serializationService, clientInvocationFuture, defaultValue);\n+        super(serializationService, clientInvocationFuture, defaultValue, false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6a15cf9e1de5c771c2a7026b853c2797dea67299"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxMjc1NjAz", "url": "https://github.com/hazelcast/hazelcast/pull/17020#pullrequestreview-431275603", "createdAt": "2020-06-16T08:28:38Z", "commit": {"oid": "6a15cf9e1de5c771c2a7026b853c2797dea67299"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3650, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}