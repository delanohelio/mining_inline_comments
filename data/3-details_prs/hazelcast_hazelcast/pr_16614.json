{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcxNDE0OTk1", "number": 16614, "title": "Allow blocking Raft invocations to op-timeout after wait timeout", "bodyText": "If the wait key of a blocking call times out, it is still reported\nas a live operation. This could lead to hang the caller side when\nthe majority is lost because the Raft invocation does not fail with\noperation timeout.\nTo prevent this problem, we don't report a wait key as a live operation\nif it is not expired on the CP group after its wait timeout occurs.", "createdAt": "2020-02-05T14:50:13Z", "url": "https://github.com/hazelcast/hazelcast/pull/16614", "merged": true, "mergeCommit": {"oid": "ebb49cc89c99b49d8eebf8ad24c328b50daa60b0"}, "closed": true, "closedAt": "2020-02-07T07:26:44Z", "author": {"login": "metanet"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBloHvgFqTM1NDI0MjkwNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcBsAKAABqjMwMTQxOTgxMDg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0MjQyOTA0", "url": "https://github.com/hazelcast/hazelcast/pull/16614#pullrequestreview-354242904", "createdAt": "2020-02-06T07:28:21Z", "commit": {"oid": "2dead3b0b7af55dfca34818f98b523998697c4b6"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQwNzoyODoyMlrOFmRXJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQwNzoyOTozNlrOFmRYmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY3NDY2Mw==", "bodyText": "What if Clock.currentTimeMillis() + timeoutMs overflows?", "url": "https://github.com/hazelcast/hazelcast/pull/16614#discussion_r375674663", "createdAt": "2020-02-06T07:28:22Z", "author": {"login": "mdogan"}, "path": "hazelcast/src/main/java/com/hazelcast/cp/internal/datastructures/spi/blocking/ResourceRegistry.java", "diffHunk": "@@ -110,12 +116,12 @@ private void checkNotDestroyed(String name) {\n     }\n \n     protected final void addWaitKey(String name, W key, long timeoutMs) {\n+        long deadline = timeoutMs > 0 ? Clock.currentTimeMillis() + timeoutMs : NO_WAIT_KEY_DEADLINE;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2dead3b0b7af55dfca34818f98b523998697c4b6"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY3NTAzMw==", "bodyText": "I think it's better to use Long.MAX as NO_WAIT_KEY_DEADLINE. That way, there'll be no need to check deadline == NO_WAIT_KEY_DEADLINE equality.", "url": "https://github.com/hazelcast/hazelcast/pull/16614#discussion_r375675033", "createdAt": "2020-02-06T07:29:36Z", "author": {"login": "mdogan"}, "path": "hazelcast/src/main/java/com/hazelcast/cp/internal/datastructures/spi/blocking/ResourceRegistry.java", "diffHunk": "@@ -57,7 +57,10 @@\n  * @param <R> concrete type of the resource\n  */\n public abstract class ResourceRegistry<W extends WaitKey, R extends BlockingResource<W>>\n-        implements LiveOperationsTracker, DataSerializable {\n+        implements DataSerializable {\n+\n+    private static final long OPERATION_TIMEOUT_EXTENSION_MS = TimeUnit.SECONDS.toMillis(5);\n+    private static final long NO_WAIT_KEY_DEADLINE = -1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2dead3b0b7af55dfca34818f98b523998697c4b6"}, "originalPosition": 49}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2dead3b0b7af55dfca34818f98b523998697c4b6", "author": {"user": {"login": "metanet", "name": "Ensar Basri Kahveci"}}, "url": "https://github.com/hazelcast/hazelcast/commit/2dead3b0b7af55dfca34818f98b523998697c4b6", "committedDate": "2020-02-05T13:58:55Z", "message": "Allow blocking Raft invocations to op-timeout after wait timeout\n\nIf the wait key of a blocking call times out, it is still reported\nas a live operation. This cloud lead to hang the caller side when\nthe majority is lost because the Raft invocation does not fail with\noperation timeout.\n\nTo prevent this problem, we don't report a wait key as a live operation\nif it is not expired on the CP group after its wait timeout occurs."}, "afterCommit": {"oid": "4bd7bb10b09461f0a1ddf068545c0824fa4c0cc1", "author": {"user": {"login": "metanet", "name": "Ensar Basri Kahveci"}}, "url": "https://github.com/hazelcast/hazelcast/commit/4bd7bb10b09461f0a1ddf068545c0824fa4c0cc1", "committedDate": "2020-02-06T09:07:35Z", "message": "Allow blocking Raft invocations to op-timeout after wait timeout\n\nIf the wait key of a blocking call times out, it is still reported\nas a live operation. This cloud lead to hang the caller side when\nthe majority is lost because the Raft invocation does not fail with\noperation timeout.\n\nTo prevent this problem, we don't report a wait key as a live operation\nif it is not expired on the CP group after its wait timeout occurs."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0MzMwNzIw", "url": "https://github.com/hazelcast/hazelcast/pull/16614#pullrequestreview-354330720", "createdAt": "2020-02-06T10:08:05Z", "commit": {"oid": "4bd7bb10b09461f0a1ddf068545c0824fa4c0cc1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0MzU3NzU2", "url": "https://github.com/hazelcast/hazelcast/pull/16614#pullrequestreview-354357756", "createdAt": "2020-02-06T10:49:51Z", "commit": {"oid": "4bd7bb10b09461f0a1ddf068545c0824fa4c0cc1"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxMDo0OTo1MVrOFmW2Kg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxMDo1MzoyM1rOFmW8yw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTc2NDUyMg==", "bodyText": "Can we add a comment why we need this extension?", "url": "https://github.com/hazelcast/hazelcast/pull/16614#discussion_r375764522", "createdAt": "2020-02-06T10:49:51Z", "author": {"login": "petrpleshachkov"}, "path": "hazelcast/src/main/java/com/hazelcast/cp/internal/datastructures/spi/blocking/ResourceRegistry.java", "diffHunk": "@@ -57,7 +57,10 @@\n  * @param <R> concrete type of the resource\n  */\n public abstract class ResourceRegistry<W extends WaitKey, R extends BlockingResource<W>>\n-        implements LiveOperationsTracker, DataSerializable {\n+        implements DataSerializable {\n+\n+    private static final long OPERATION_TIMEOUT_EXTENSION_MS = TimeUnit.SECONDS.toMillis(5);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4bd7bb10b09461f0a1ddf068545c0824fa4c0cc1"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTc2NjIxOQ==", "bodyText": "else deadline = Long.MAX_VALUE ?", "url": "https://github.com/hazelcast/hazelcast/pull/16614#discussion_r375766219", "createdAt": "2020-02-06T10:53:23Z", "author": {"login": "petrpleshachkov"}, "path": "hazelcast/src/main/java/com/hazelcast/cp/internal/datastructures/spi/blocking/ResourceRegistry.java", "diffHunk": "@@ -217,29 +228,42 @@ public final CPGroupId getGroupId() {\n         return indices;\n     }\n \n-    @Override\n-    public void populate(LiveOperations liveOperations) {\n-        for (BiTuple<Address, Long> t : liveOperationsSet) {\n-            liveOperations.add(t.element1, t.element2);\n+    public void populate(LiveOperations liveOperations, long now) {\n+        Iterator<Entry<BiTuple<Address, Long>, Long>> it = liveOperationMap.entrySet().iterator();\n+        while (it.hasNext()) {\n+            Entry<BiTuple<Address, Long>, Long> e = it.next();\n+            long deadline = e.getValue();\n+            if (deadline >= now) {\n+                BiTuple<Address, Long> t = e.getKey();\n+                liveOperations.add(t.element1, t.element2);\n+            } else {\n+                it.remove();\n+            }\n         }\n     }\n \n-    private void addLiveOperation(W key) {\n-        liveOperationsSet.add(BiTuple.of(key.callerAddress(), key.callId()));\n+    private void addLiveOperation(W key, long deadline) {\n+        if (Long.MAX_VALUE - deadline >= OPERATION_TIMEOUT_EXTENSION_MS) {\n+            deadline += OPERATION_TIMEOUT_EXTENSION_MS;\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4bd7bb10b09461f0a1ddf068545c0824fa4c0cc1"}, "originalPosition": 115}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4bd7bb10b09461f0a1ddf068545c0824fa4c0cc1", "author": {"user": {"login": "metanet", "name": "Ensar Basri Kahveci"}}, "url": "https://github.com/hazelcast/hazelcast/commit/4bd7bb10b09461f0a1ddf068545c0824fa4c0cc1", "committedDate": "2020-02-06T09:07:35Z", "message": "Allow blocking Raft invocations to op-timeout after wait timeout\n\nIf the wait key of a blocking call times out, it is still reported\nas a live operation. This cloud lead to hang the caller side when\nthe majority is lost because the Raft invocation does not fail with\noperation timeout.\n\nTo prevent this problem, we don't report a wait key as a live operation\nif it is not expired on the CP group after its wait timeout occurs."}, "afterCommit": {"oid": "5da2d660df976201ae6fcc556545a6b2bc80a9ec", "author": {"user": {"login": "metanet", "name": "Ensar Basri Kahveci"}}, "url": "https://github.com/hazelcast/hazelcast/commit/5da2d660df976201ae6fcc556545a6b2bc80a9ec", "committedDate": "2020-02-06T14:39:36Z", "message": "Allow blocking Raft invocations to op-timeout after wait timeout\n\nIf the wait key of a blocking call times out, it is still reported\nas a live operation. This cloud lead to hang the caller side when\nthe majority is lost because the Raft invocation does not fail with\noperation timeout.\n\nTo prevent this problem, we don't report a wait key as a live operation\nif it is not expired on the CP group after its wait timeout occurs."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0NTAzNjgz", "url": "https://github.com/hazelcast/hazelcast/pull/16614#pullrequestreview-354503683", "createdAt": "2020-02-06T14:45:19Z", "commit": {"oid": "5da2d660df976201ae6fcc556545a6b2bc80a9ec"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxNDo0NToxOVrOFmdk4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxNDo0NToxOVrOFmdk4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTg3NDc4NQ==", "bodyText": "typo cloud -> could", "url": "https://github.com/hazelcast/hazelcast/pull/16614#discussion_r375874785", "createdAt": "2020-02-06T14:45:19Z", "author": {"login": "petrpleshachkov"}, "path": "hazelcast/src/main/java/com/hazelcast/cp/internal/datastructures/spi/blocking/ResourceRegistry.java", "diffHunk": "@@ -57,11 +57,31 @@\n  * @param <R> concrete type of the resource\n  */\n public abstract class ResourceRegistry<W extends WaitKey, R extends BlockingResource<W>>\n-        implements LiveOperationsTracker, DataSerializable {\n+        implements DataSerializable {\n+\n+    // If the wait key of a blocking call times out, it is still reported\n+    // as a live operation. This cloud lead to hang the caller side when", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5da2d660df976201ae6fcc556545a6b2bc80a9ec"}, "originalPosition": 49}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5da2d660df976201ae6fcc556545a6b2bc80a9ec", "author": {"user": {"login": "metanet", "name": "Ensar Basri Kahveci"}}, "url": "https://github.com/hazelcast/hazelcast/commit/5da2d660df976201ae6fcc556545a6b2bc80a9ec", "committedDate": "2020-02-06T14:39:36Z", "message": "Allow blocking Raft invocations to op-timeout after wait timeout\n\nIf the wait key of a blocking call times out, it is still reported\nas a live operation. This cloud lead to hang the caller side when\nthe majority is lost because the Raft invocation does not fail with\noperation timeout.\n\nTo prevent this problem, we don't report a wait key as a live operation\nif it is not expired on the CP group after its wait timeout occurs."}, "afterCommit": {"oid": "3a971db8b95e5f594394aae2e58364bc4362d3bf", "author": {"user": {"login": "metanet", "name": "Ensar Basri Kahveci"}}, "url": "https://github.com/hazelcast/hazelcast/commit/3a971db8b95e5f594394aae2e58364bc4362d3bf", "committedDate": "2020-02-06T14:55:01Z", "message": "Allow blocking Raft invocations to op-timeout after wait timeout\n\nIf the wait key of a blocking call times out, it is still reported\nas a live operation. This cloud lead to hang the caller side when\nthe majority is lost because the Raft invocation does not fail with\noperation timeout.\n\nTo prevent this problem, we don't report a wait key as a live operation\nif it is not expired on the CP group after its wait timeout occurs."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c1b916c833668782fad2791060debdf21f40bd3", "author": {"user": {"login": "metanet", "name": "Ensar Basri Kahveci"}}, "url": "https://github.com/hazelcast/hazelcast/commit/8c1b916c833668782fad2791060debdf21f40bd3", "committedDate": "2020-02-06T14:55:49Z", "message": "Allow blocking Raft invocations to op-timeout after wait timeout\n\nIf the wait key of a blocking call times out, it is still reported\nas a live operation. This could lead to hang the caller side when\nthe majority is lost because the Raft invocation does not fail with\noperation timeout.\n\nTo prevent this problem, we don't report a wait key as a live operation\nif it is not expired on the CP group after its wait timeout occurs."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3a971db8b95e5f594394aae2e58364bc4362d3bf", "author": {"user": {"login": "metanet", "name": "Ensar Basri Kahveci"}}, "url": "https://github.com/hazelcast/hazelcast/commit/3a971db8b95e5f594394aae2e58364bc4362d3bf", "committedDate": "2020-02-06T14:55:01Z", "message": "Allow blocking Raft invocations to op-timeout after wait timeout\n\nIf the wait key of a blocking call times out, it is still reported\nas a live operation. This cloud lead to hang the caller side when\nthe majority is lost because the Raft invocation does not fail with\noperation timeout.\n\nTo prevent this problem, we don't report a wait key as a live operation\nif it is not expired on the CP group after its wait timeout occurs."}, "afterCommit": {"oid": "8c1b916c833668782fad2791060debdf21f40bd3", "author": {"user": {"login": "metanet", "name": "Ensar Basri Kahveci"}}, "url": "https://github.com/hazelcast/hazelcast/commit/8c1b916c833668782fad2791060debdf21f40bd3", "committedDate": "2020-02-06T14:55:49Z", "message": "Allow blocking Raft invocations to op-timeout after wait timeout\n\nIf the wait key of a blocking call times out, it is still reported\nas a live operation. This could lead to hang the caller side when\nthe majority is lost because the Raft invocation does not fail with\noperation timeout.\n\nTo prevent this problem, we don't report a wait key as a live operation\nif it is not expired on the CP group after its wait timeout occurs."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3953, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}