{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxOTkxODYy", "number": 16787, "title": "Add IMap#setAll and IMap#setAllAsync", "bodyText": "See #5337", "createdAt": "2020-03-22T11:34:20Z", "url": "https://github.com/hazelcast/hazelcast/pull/16787", "merged": true, "mergeCommit": {"oid": "64ffcabcaf9527963cdf180e8cfe7c8fb1c497da"}, "closed": true, "closedAt": "2020-04-06T10:31:37Z", "author": {"login": "pertsodian"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcQWs8EABqjMxNTM1ODgwMjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcU8Ho-gFqTM4ODEyMDMzMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "31565a0ae33119d9721054564acb603fb63b78a5", "author": {"user": {"login": "pertsodian", "name": "Harry Tran"}}, "url": "https://github.com/hazelcast/hazelcast/commit/31565a0ae33119d9721054564acb603fb63b78a5", "committedDate": "2020-03-22T11:29:12Z", "message": "Add IMap#setAll and IMap#setAllAsync"}, "afterCommit": {"oid": "618c41dec2c739e221bfc2a01cb966a330657325", "author": {"user": {"login": "pertsodian", "name": "Harry Tran"}}, "url": "https://github.com/hazelcast/hazelcast/commit/618c41dec2c739e221bfc2a01cb966a330657325", "committedDate": "2020-03-23T04:35:34Z", "message": "Add IMap#setAll and IMap#setAllAsync"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "618c41dec2c739e221bfc2a01cb966a330657325", "author": {"user": {"login": "pertsodian", "name": "Harry Tran"}}, "url": "https://github.com/hazelcast/hazelcast/commit/618c41dec2c739e221bfc2a01cb966a330657325", "committedDate": "2020-03-23T04:35:34Z", "message": "Add IMap#setAll and IMap#setAllAsync"}, "afterCommit": {"oid": "29c09c6c2cdec9a4fbb1c621aad77e6b6aa6a7d5", "author": {"user": {"login": "pertsodian", "name": "Harry Tran"}}, "url": "https://github.com/hazelcast/hazelcast/commit/29c09c6c2cdec9a4fbb1c621aad77e6b6aa6a7d5", "committedDate": "2020-03-31T11:44:58Z", "message": "Add IMap#setAll and IMap#setAllAsync"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0NjY1NzYx", "url": "https://github.com/hazelcast/hazelcast/pull/16787#pullrequestreview-384665761", "createdAt": "2020-03-31T12:06:48Z", "commit": {"oid": "29c09c6c2cdec9a4fbb1c621aad77e6b6aa6a7d5"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMjowNjo0OFrOF-SfsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMjoyMjowM1rOF-TEVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDg1OTA1Ng==", "bodyText": "Do not concurrently mutate the given map. -> what does this mean? Should I as a user stop mutating the map during this call?", "url": "https://github.com/hazelcast/hazelcast/pull/16787#discussion_r400859056", "createdAt": "2020-03-31T12:06:48Z", "author": {"login": "mmedenjak"}, "path": "hazelcast/src/main/java/com/hazelcast/map/IMap.java", "diffHunk": "@@ -1762,6 +1764,82 @@ void set(@Nonnull K key, @Nonnull V value,\n              long ttl, @Nonnull TimeUnit ttlUnit,\n              long maxIdle, @Nonnull TimeUnit maxIdleUnit);\n \n+    /**\n+     * Copies all of the mappings from the specified map to this map without loading\n+     * non-existing elements from map store (which is more efficient than {@code putAll()}).\n+     * Do not concurrently mutate the given map.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29c09c6c2cdec9a4fbb1c621aad77e6b6aa6a7d5"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDg1OTc1NQ==", "bodyText": "This version doesn't support batching. -> it's an implementation detail, not relevant to the contract.\nDon't mutate the given map until the future completes. -> why? It's a pretty bad requirement, most multi-threaded applications won't be able to adhere to this rule.", "url": "https://github.com/hazelcast/hazelcast/pull/16787#discussion_r400859755", "createdAt": "2020-03-31T12:08:06Z", "author": {"login": "mmedenjak"}, "path": "hazelcast/src/main/java/com/hazelcast/map/IMap.java", "diffHunk": "@@ -1762,6 +1764,82 @@ void set(@Nonnull K key, @Nonnull V value,\n              long ttl, @Nonnull TimeUnit ttlUnit,\n              long maxIdle, @Nonnull TimeUnit maxIdleUnit);\n \n+    /**\n+     * Copies all of the mappings from the specified map to this map without loading\n+     * non-existing elements from map store (which is more efficient than {@code putAll()}).\n+     * Do not concurrently mutate the given map.\n+     * <p>\n+     * This method breaks the contract of EntryListener.\n+     * EntryEvent of all the updated entries will have null oldValue even if they exist previously.\n+     * <p>\n+     * No atomicity guarantees are given. It could be that in case of failure\n+     * some of the key/value-pairs get written, while others are not.\n+     *\n+     * <p><b>Interactions with the map store</b>\n+     * <p>\n+     * If write-through persistence mode is configured,\n+     * {@link MapStore#store(Object, Object)} is invoked for each element\n+     * before the element is added in memory, which may come at a\n+     * significant performance cost. Exceptions thrown by store fail the\n+     * operation and are propagated to the caller. The elements which\n+     * were added before the exception was thrown will remain in the map,\n+     * the rest will not be added.\n+     * <p>\n+     * If write-behind persistence mode is configured with\n+     * write-coalescing turned off,\n+     * {@link com.hazelcast.map.ReachedMaxSizeException} may be thrown\n+     * if the write-behind queue has reached its per-node maximum\n+     * capacity.\n+     */\n+    void setAll(@Nonnull Map<? extends K, ? extends V> map);\n+\n+    /**\n+     * Asynchronously copies all of the mappings from the specified map to this map\n+     * without loading non-existing elements from map store. This version doesn't", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29c09c6c2cdec9a4fbb1c621aad77e6b6aa6a7d5"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDg2ODQzNg==", "bodyText": "We have a feature called \"rolling upgrade\" which means that at a certain point, a cluster may consist of members of different minor versions, one minor version apart. In another words, this operation and all other objects that are serialised and deserialised may be sent and received by members of different versions. In the case when this object was sent by a 4.0 member and received by a 4.1 member, this may cause an exception.\nThis is why we have to introduce additional safeguards. It starts by adding the Versioned interface to this class. After that, you can add checks in the writeInternal and readInternal methods, like:\n    @Override\n    protected void writeInternal(ObjectDataOutput out) throws IOException {\n        super.writeInternal(out);\n        out.writeObject(mapEntries);\n        if (out.getVersion().isGreaterOrEqual(Versions.V4_1)) {\n            out.writeBoolean(triggerMapLoader);\n        }\n    }\n\n    @Override\n    protected void readInternal(ObjectDataInput in) throws IOException {\n        super.readInternal(in);\n        mapEntries = in.readObject();\n        if (in.getVersion().isGreaterOrEqual(Versions.V4_1)) {\n            triggerMapLoader = in.readBoolean();\n        } else {\n            // old behaviour\n            triggerMapLoader = true;\n        }\n    }\nSame goes for PutAllPartitionAwareOperationFactory .", "url": "https://github.com/hazelcast/hazelcast/pull/16787#discussion_r400868436", "createdAt": "2020-03-31T12:22:03Z", "author": {"login": "mmedenjak"}, "path": "hazelcast/src/main/java/com/hazelcast/map/impl/operation/PutAllOperation.java", "diffHunk": "@@ -211,12 +214,14 @@ private List toBackupListByRemovingEvictedRecords() {\n     protected void writeInternal(ObjectDataOutput out) throws IOException {\n         super.writeInternal(out);\n         out.writeObject(mapEntries);\n+        out.writeBoolean(triggerMapLoader);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29c09c6c2cdec9a4fbb1c621aad77e6b6aa6a7d5"}, "originalPosition": 48}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e259a85a0987f3578574920f773a7fbd4e734de2", "author": {"user": {"login": "pertsodian", "name": "Harry Tran"}}, "url": "https://github.com/hazelcast/hazelcast/commit/e259a85a0987f3578574920f773a7fbd4e734de2", "committedDate": "2020-03-31T13:25:19Z", "message": "Add IMap#setAll and IMap#setAllAsync"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "29c09c6c2cdec9a4fbb1c621aad77e6b6aa6a7d5", "author": {"user": {"login": "pertsodian", "name": "Harry Tran"}}, "url": "https://github.com/hazelcast/hazelcast/commit/29c09c6c2cdec9a4fbb1c621aad77e6b6aa6a7d5", "committedDate": "2020-03-31T11:44:58Z", "message": "Add IMap#setAll and IMap#setAllAsync"}, "afterCommit": {"oid": "e259a85a0987f3578574920f773a7fbd4e734de2", "author": {"user": {"login": "pertsodian", "name": "Harry Tran"}}, "url": "https://github.com/hazelcast/hazelcast/commit/e259a85a0987f3578574920f773a7fbd4e734de2", "committedDate": "2020-03-31T13:25:19Z", "message": "Add IMap#setAll and IMap#setAllAsync"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1NDc5NjE5", "url": "https://github.com/hazelcast/hazelcast/pull/16787#pullrequestreview-385479619", "createdAt": "2020-04-01T11:02:40Z", "commit": {"oid": "e259a85a0987f3578574920f773a7fbd4e734de2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cbd5b107fe5a5fb541532b3064c46fc814831d56", "author": {"user": {"login": "pertsodian", "name": "Harry Tran"}}, "url": "https://github.com/hazelcast/hazelcast/commit/cbd5b107fe5a5fb541532b3064c46fc814831d56", "committedDate": "2020-04-01T11:39:43Z", "message": "Remove javadoc regarding concurrently mutate input Map for setAll / setAllAsync / putAllAsync"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1NTI4ODUy", "url": "https://github.com/hazelcast/hazelcast/pull/16787#pullrequestreview-385528852", "createdAt": "2020-04-01T12:19:49Z", "commit": {"oid": "cbd5b107fe5a5fb541532b3064c46fc814831d56"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxMjoxOTo0OVrOF-99sA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxMjoxOTo0OVrOF-99sA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTU3MTI0OA==", "bodyText": "After you regenerate the codec with correct since version. You will see an extra field parameters.isTriggerMapLoaderExists this should if the client is aware of the new field or not.\nif isTriggerMapLoaderExists is true then your field has two options as you did. But if it is false then, you should fall back to the old behavior and pass a true value into the triggerMapLoader parameter of the operation.", "url": "https://github.com/hazelcast/hazelcast/pull/16787#discussion_r401571248", "createdAt": "2020-04-01T12:19:49Z", "author": {"login": "asimarslan"}, "path": "hazelcast/src/main/java/com/hazelcast/client/impl/protocol/task/map/MapPutAllMessageTask.java", "diffHunk": "@@ -47,7 +47,7 @@ public MapPutAllMessageTask(ClientMessage clientMessage, Node node, Connection c\n     protected Operation prepareOperation() {\n         MapEntries mapEntries = new MapEntries(parameters.entries);\n         MapOperationProvider operationProvider = getMapOperationProvider(parameters.name);\n-        return operationProvider.createPutAllOperation(parameters.name, mapEntries);\n+        return operationProvider.createPutAllOperation(parameters.name, mapEntries, parameters.triggerMapLoader);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cbd5b107fe5a5fb541532b3064c46fc814831d56"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1NTI5ODEy", "url": "https://github.com/hazelcast/hazelcast/pull/16787#pullrequestreview-385529812", "createdAt": "2020-04-01T12:21:06Z", "commit": {"oid": "cbd5b107fe5a5fb541532b3064c46fc814831d56"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a70c935ef0929260d5cb494aedd0940cdb3369c4", "author": {"user": {"login": "pertsodian", "name": "Harry Tran"}}, "url": "https://github.com/hazelcast/hazelcast/commit/a70c935ef0929260d5cb494aedd0940cdb3369c4", "committedDate": "2020-04-01T12:41:28Z", "message": "Update MapPutAllCodec"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4MTIwMzMw", "url": "https://github.com/hazelcast/hazelcast/pull/16787#pullrequestreview-388120330", "createdAt": "2020-04-06T10:27:13Z", "commit": {"oid": "a70c935ef0929260d5cb494aedd0940cdb3369c4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3903, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}