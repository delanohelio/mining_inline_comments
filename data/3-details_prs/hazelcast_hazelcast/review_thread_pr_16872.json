{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAxNDEzNDUx", "number": 16872, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQwNzoxNjowM1rODwq00A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQwNzoxNjowM1rODwq00A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyMzU5ODg4OnYy", "diffSide": "RIGHT", "path": "hazelcast/src/main/java/com/hazelcast/internal/partition/impl/PartitionReplicaManager.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQwNzoxNjowM1rOGDzEjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxMjo1MDo1NlrOGD5pBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjYzNTY2Mg==", "bodyText": "I'm not fully understanding the logic so I'm not sure how bad the situation actually is when you would run into this assert failure. But if we log it to finest, it is effectively the same as removing the checking completely because it will be lost.\nIsn't it better to throw an exception?", "url": "https://github.com/hazelcast/hazelcast/pull/16872#discussion_r406635662", "createdAt": "2020-04-10T07:16:03Z", "author": {"login": "pveentjer"}, "path": "hazelcast/src/main/java/com/hazelcast/internal/partition/impl/PartitionReplicaManager.java", "diffHunk": "@@ -409,13 +413,21 @@ public int tryAcquireReplicaSyncPermits(int requestedPermits) {\n      */\n     public void releaseReplicaSyncPermits(int permits) {\n         assert permits > 0 : \"Invalid permits: \" + permits;\n+\n         replicaSyncSemaphore.release(permits);\n+\n         if (logger.isFinestEnabled()) {\n-            logger.finest(\"Released \" + permits + \" replica sync permits. Available permits: \"\n-                        + replicaSyncSemaphore.availablePermits());\n+            int availableReplicaSyncPermits = availableReplicaSyncPermits();\n+\n+            logger.finest(format(\"Released %d replica sync permits. Available permits: %d\",\n+                    permits, availableReplicaSyncPermits));\n+\n+            if (availableReplicaSyncPermits <= maxParallelReplications) {\n+                logger.finest(format(\"Replica sync permits exceeded the configured number! (available: %d, max: %d)\",\n+                        availableReplicaSyncPermits, maxParallelReplications));\n+\n+            }\n         }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d451733e6fb726af7f8063f9eec651c7bfd5d26a"}, "originalPosition": 105}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY2MDM1Mw==", "bodyText": "I think we should log this as warning. I don't prefer throwing an exception because this might happen when split-brain merge happens concurrently with replica anti-entropy synchronization. But it's a very rare case and when happens, should not cause any significant effect.", "url": "https://github.com/hazelcast/hazelcast/pull/16872#discussion_r406660353", "createdAt": "2020-04-10T08:29:24Z", "author": {"login": "mdogan"}, "path": "hazelcast/src/main/java/com/hazelcast/internal/partition/impl/PartitionReplicaManager.java", "diffHunk": "@@ -409,13 +413,21 @@ public int tryAcquireReplicaSyncPermits(int requestedPermits) {\n      */\n     public void releaseReplicaSyncPermits(int permits) {\n         assert permits > 0 : \"Invalid permits: \" + permits;\n+\n         replicaSyncSemaphore.release(permits);\n+\n         if (logger.isFinestEnabled()) {\n-            logger.finest(\"Released \" + permits + \" replica sync permits. Available permits: \"\n-                        + replicaSyncSemaphore.availablePermits());\n+            int availableReplicaSyncPermits = availableReplicaSyncPermits();\n+\n+            logger.finest(format(\"Released %d replica sync permits. Available permits: %d\",\n+                    permits, availableReplicaSyncPermits));\n+\n+            if (availableReplicaSyncPermits <= maxParallelReplications) {\n+                logger.finest(format(\"Replica sync permits exceeded the configured number! (available: %d, max: %d)\",\n+                        availableReplicaSyncPermits, maxParallelReplications));\n+\n+            }\n         }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjYzNTY2Mg=="}, "originalCommit": {"oid": "d451733e6fb726af7f8063f9eec651c7bfd5d26a"}, "originalPosition": 105}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY2MDYyOA==", "bodyText": "If we see it happening more frequently, then we can handle it more gracefully.", "url": "https://github.com/hazelcast/hazelcast/pull/16872#discussion_r406660628", "createdAt": "2020-04-10T08:30:13Z", "author": {"login": "mdogan"}, "path": "hazelcast/src/main/java/com/hazelcast/internal/partition/impl/PartitionReplicaManager.java", "diffHunk": "@@ -409,13 +413,21 @@ public int tryAcquireReplicaSyncPermits(int requestedPermits) {\n      */\n     public void releaseReplicaSyncPermits(int permits) {\n         assert permits > 0 : \"Invalid permits: \" + permits;\n+\n         replicaSyncSemaphore.release(permits);\n+\n         if (logger.isFinestEnabled()) {\n-            logger.finest(\"Released \" + permits + \" replica sync permits. Available permits: \"\n-                        + replicaSyncSemaphore.availablePermits());\n+            int availableReplicaSyncPermits = availableReplicaSyncPermits();\n+\n+            logger.finest(format(\"Released %d replica sync permits. Available permits: %d\",\n+                    permits, availableReplicaSyncPermits));\n+\n+            if (availableReplicaSyncPermits <= maxParallelReplications) {\n+                logger.finest(format(\"Replica sync permits exceeded the configured number! (available: %d, max: %d)\",\n+                        availableReplicaSyncPermits, maxParallelReplications));\n+\n+            }\n         }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjYzNTY2Mg=="}, "originalCommit": {"oid": "d451733e6fb726af7f8063f9eec651c7bfd5d26a"}, "originalPosition": 105}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjcwMzA4OA==", "bodyText": "changed log level to warning.", "url": "https://github.com/hazelcast/hazelcast/pull/16872#discussion_r406703088", "createdAt": "2020-04-10T10:36:20Z", "author": {"login": "ahmetmircik"}, "path": "hazelcast/src/main/java/com/hazelcast/internal/partition/impl/PartitionReplicaManager.java", "diffHunk": "@@ -409,13 +413,21 @@ public int tryAcquireReplicaSyncPermits(int requestedPermits) {\n      */\n     public void releaseReplicaSyncPermits(int permits) {\n         assert permits > 0 : \"Invalid permits: \" + permits;\n+\n         replicaSyncSemaphore.release(permits);\n+\n         if (logger.isFinestEnabled()) {\n-            logger.finest(\"Released \" + permits + \" replica sync permits. Available permits: \"\n-                        + replicaSyncSemaphore.availablePermits());\n+            int availableReplicaSyncPermits = availableReplicaSyncPermits();\n+\n+            logger.finest(format(\"Released %d replica sync permits. Available permits: %d\",\n+                    permits, availableReplicaSyncPermits));\n+\n+            if (availableReplicaSyncPermits <= maxParallelReplications) {\n+                logger.finest(format(\"Replica sync permits exceeded the configured number! (available: %d, max: %d)\",\n+                        availableReplicaSyncPermits, maxParallelReplications));\n+\n+            }\n         }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjYzNTY2Mg=="}, "originalCommit": {"oid": "d451733e6fb726af7f8063f9eec651c7bfd5d26a"}, "originalPosition": 105}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc0MzMwMA==", "bodyText": "Ok. Warning sounds like a good compromise.", "url": "https://github.com/hazelcast/hazelcast/pull/16872#discussion_r406743300", "createdAt": "2020-04-10T12:50:56Z", "author": {"login": "pveentjer"}, "path": "hazelcast/src/main/java/com/hazelcast/internal/partition/impl/PartitionReplicaManager.java", "diffHunk": "@@ -409,13 +413,21 @@ public int tryAcquireReplicaSyncPermits(int requestedPermits) {\n      */\n     public void releaseReplicaSyncPermits(int permits) {\n         assert permits > 0 : \"Invalid permits: \" + permits;\n+\n         replicaSyncSemaphore.release(permits);\n+\n         if (logger.isFinestEnabled()) {\n-            logger.finest(\"Released \" + permits + \" replica sync permits. Available permits: \"\n-                        + replicaSyncSemaphore.availablePermits());\n+            int availableReplicaSyncPermits = availableReplicaSyncPermits();\n+\n+            logger.finest(format(\"Released %d replica sync permits. Available permits: %d\",\n+                    permits, availableReplicaSyncPermits));\n+\n+            if (availableReplicaSyncPermits <= maxParallelReplications) {\n+                logger.finest(format(\"Replica sync permits exceeded the configured number! (available: %d, max: %d)\",\n+                        availableReplicaSyncPermits, maxParallelReplications));\n+\n+            }\n         }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjYzNTY2Mg=="}, "originalCommit": {"oid": "d451733e6fb726af7f8063f9eec651c7bfd5d26a"}, "originalPosition": 105}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 647, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}