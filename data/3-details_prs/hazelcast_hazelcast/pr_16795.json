{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkzMDc4OTU0", "number": 16795, "title": "fix: measure ReplicatedMap operations latency in nanoseconds and report in milliseconds", "bodyText": "LocalReplicatedMapStatsImpl states that maxGetLatency is measured in MS but in ReplicatedMapGetMessageTask we call incrementGets with nanoseconds diff.\n\nAs suggested in #16795 (comment) the PR changes logic how IMDG compute max*Latency metrics.\nAfter merging the PR max*Latency values are collected in nanoseconds and reported in milliseconds", "createdAt": "2020-03-24T15:52:49Z", "url": "https://github.com/hazelcast/hazelcast/pull/16795", "merged": true, "mergeCommit": {"oid": "df3bec578c78ae873a194e8a6866db81a8004fc1"}, "closed": true, "closedAt": "2020-03-31T12:18:30Z", "author": {"login": "alex-dukhno"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcQ08WRgH2gAyMzkzMDc4OTU0OmNmOGRkODQzMTM3NjAwMjg0YTllZjI4NjUxYjMzN2Y3NzEyZTI4ZWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTCDgagFqTM4NDY3MTE1MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "cf8dd843137600284a9ef28651b337f7712e28ef", "author": {"user": {"login": "alex-dukhno", "name": "Alex Dukhno"}}, "url": "https://github.com/hazelcast/hazelcast/commit/cf8dd843137600284a9ef28651b337f7712e28ef", "committedDate": "2020-03-24T15:49:51Z", "message": "fix: measure ReplicatedMap gets latency in milliseconds"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwNDkwNDUy", "url": "https://github.com/hazelcast/hazelcast/pull/16795#pullrequestreview-380490452", "createdAt": "2020-03-24T16:34:20Z", "commit": {"oid": "cf8dd843137600284a9ef28651b337f7712e28ef"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxNjozNDoyMFrOF649vw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxNjozNDoyMFrOF649vw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI5NTAzOQ==", "bodyText": "I think we should rather report it as nanos and change the unit to NS too, similarly to the map counterpart: \n  \n    \n      hazelcast/hazelcast/src/main/java/com/hazelcast/client/impl/protocol/task/map/MapGetMessageTask.java\n    \n    \n         Line 71\n      in\n      97ff57b\n    \n    \n    \n    \n\n        \n          \n           .incrementGetLatencyNanos(System.nanoTime() - startTimeNanos); \n        \n    \n  \n\n\nI'd expect with reporting as millis, we typically report 0.\nThe same fields in the map are not metrics though \ud83e\udd14 This seems to be an error, I send a PR to fix this.\n\n  \n    \n      hazelcast/hazelcast/src/main/java/com/hazelcast/internal/monitor/impl/LocalMapStatsImpl.java\n    \n    \n         Line 140\n      in\n      296aac5\n    \n    \n    \n    \n\n        \n          \n           private volatile long totalGetLatenciesNanos;", "url": "https://github.com/hazelcast/hazelcast/pull/16795#discussion_r397295039", "createdAt": "2020-03-24T16:34:20Z", "author": {"login": "blazember"}, "path": "hazelcast/src/main/java/com/hazelcast/client/impl/protocol/task/replicatedmap/ReplicatedMapGetMessageTask.java", "diffHunk": "@@ -59,7 +60,7 @@ protected Object processResponseBeforeSending(Object response) {\n         ReplicatedMapService replicatedMapService = getService(ReplicatedMapService.SERVICE_NAME);\n         if (replicatedMapService.getReplicatedMapConfig(parameters.name).isStatisticsEnabled()) {\n             LocalReplicatedMapStatsImpl stats = replicatedMapService.getLocalReplicatedMapStatsImpl(parameters.name);\n-            stats.incrementGets(System.nanoTime() - startTimeNanos);\n+            stats.incrementGets(TimeUnit.NANOSECONDS.toMillis(System.nanoTime() - startTimeNanos));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf8dd843137600284a9ef28651b337f7712e28ef"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a1c6241fcdd7f799d43e31b85508a6030960a75", "author": {"user": {"login": "alex-dukhno", "name": "Alex Dukhno"}}, "url": "https://github.com/hazelcast/hazelcast/commit/7a1c6241fcdd7f799d43e31b85508a6030960a75", "committedDate": "2020-03-24T20:00:40Z", "message": "collect in nanos report in millis"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3fee425df019c96880582cdaf749e894f4ae50e6", "author": {"user": {"login": "alex-dukhno", "name": "Alex Dukhno"}}, "url": "https://github.com/hazelcast/hazelcast/commit/3fee425df019c96880582cdaf749e894f4ae50e6", "committedDate": "2020-03-24T19:58:12Z", "message": "collect in nanos report in millis"}, "afterCommit": {"oid": "7a1c6241fcdd7f799d43e31b85508a6030960a75", "author": {"user": {"login": "alex-dukhno", "name": "Alex Dukhno"}}, "url": "https://github.com/hazelcast/hazelcast/commit/7a1c6241fcdd7f799d43e31b85508a6030960a75", "committedDate": "2020-03-24T20:00:40Z", "message": "collect in nanos report in millis"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwODkzNjA0", "url": "https://github.com/hazelcast/hazelcast/pull/16795#pullrequestreview-380893604", "createdAt": "2020-03-25T06:57:20Z", "commit": {"oid": "7a1c6241fcdd7f799d43e31b85508a6030960a75"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwNjo1NzoyMFrOF7OFRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwNjo1NzoyMFrOF7OFRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzY0MTAzMA==", "bodyText": "Changes in this class seem to be unrelated. #16781 is meant to address the problem across the whole code base.\nIf these changes are aimed to make operation latency probes for LocalReplicatedMapStats consistent, PR description has to updated at least.", "url": "https://github.com/hazelcast/hazelcast/pull/16795#discussion_r397641030", "createdAt": "2020-03-25T06:57:20Z", "author": {"login": "puzpuzpuz"}, "path": "hazelcast/src/main/java/com/hazelcast/replicatedmap/impl/record/AbstractReplicatedRecordStore.java", "diffHunk": "@@ -75,7 +75,7 @@ public Object removeWithVersion(Object key, long version) {\n     @SuppressWarnings(\"unchecked\")\n     private Object remove(InternalReplicatedMapStorage<K, V> storage, Object key) {\n         isNotNull(key, \"key\");\n-        long time = Clock.currentTimeMillis();\n+        long time = System.nanoTime();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a1c6241fcdd7f799d43e31b85508a6030960a75"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxNzUxMTUy", "url": "https://github.com/hazelcast/hazelcast/pull/16795#pullrequestreview-381751152", "createdAt": "2020-03-26T07:22:43Z", "commit": {"oid": "7a1c6241fcdd7f799d43e31b85508a6030960a75"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQwNzoyMjo0M1rOF75_vA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQwNzozNDoyMFrOF76SiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODM2MDUwOA==", "bodyText": "nit: extract this and the following one methods into a common module (say, TimeUtil) and reuse them here and in LocalMapStats.", "url": "https://github.com/hazelcast/hazelcast/pull/16795#discussion_r398360508", "createdAt": "2020-03-26T07:22:43Z", "author": {"login": "puzpuzpuz"}, "path": "hazelcast/src/main/java/com/hazelcast/internal/monitor/impl/LocalReplicatedMapStatsImpl.java", "diffHunk": "@@ -400,14 +405,22 @@ public void fromJson(JsonObject json) {\n         ownedEntryCount = getLong(json, \"ownedEntryCount\", -1L);\n         ownedEntryMemoryCost = getLong(json, \"ownedEntryMemoryCost\", -1L);\n         creationTime = getLong(json, \"creationTime\", -1L);\n-        totalGetLatencies = getLong(json, \"totalGetLatencies\", -1L);\n-        totalPutLatencies = getLong(json, \"totalPutLatencies\", -1L);\n-        totalRemoveLatencies = getLong(json, \"totalRemoveLatencies\", -1L);\n+        totalGetLatenciesNanos = convertMillisToNanos(getLong(json, \"totalGetLatencies\", -1L));\n+        totalPutLatenciesNanos = convertMillisToNanos(getLong(json, \"totalPutLatencies\", -1L));\n+        totalRemoveLatenciesNanos = convertMillisToNanos(getLong(json, \"totalRemoveLatencies\", -1L));\n         maxGetLatency = getLong(json, \"maxGetLatency\", -1L);\n         maxPutLatency = getLong(json, \"maxPutLatency\", -1L);\n         maxRemoveLatency = getLong(json, \"maxRemoveLatency\", -1L);\n     }\n \n+    private static long convertNanosToMillis(long nanos) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a1c6241fcdd7f799d43e31b85508a6030960a75"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODM2NDQ5NQ==", "bodyText": "This call with nanos instead of millis as the argument automatically changes unit for maxRemoveLatency (and other max*Latency fields) in LocalReplicatedMapStatsImpl to nanos. Thus, they should be converted when reading the probe and when serializing stats to JSON, like it's done in LocalMapStatsImpl.", "url": "https://github.com/hazelcast/hazelcast/pull/16795#discussion_r398364495", "createdAt": "2020-03-26T07:32:18Z", "author": {"login": "puzpuzpuz"}, "path": "hazelcast/src/main/java/com/hazelcast/replicatedmap/impl/record/AbstractReplicatedRecordStore.java", "diffHunk": "@@ -86,7 +86,7 @@ private Object remove(InternalReplicatedMapStorage<K, V> storage, Object key) {\n             storage.remove(marshalledKey, current);\n         }\n         if (replicatedMapConfig.isStatisticsEnabled()) {\n-            getStats().incrementRemoves(Clock.currentTimeMillis() - time);\n+            getStats().incrementRemoves(System.nanoTime() - time);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a1c6241fcdd7f799d43e31b85508a6030960a75"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODM2NTMyMQ==", "bodyText": "nit: rename argument of #incrementRemoves() to latencyNanos and, optionally, rename the method itself to #incrementRemovesLatencyNanos (see LocalMapStatsImpl for example). The same consideration applies to other #increment*() methods.", "url": "https://github.com/hazelcast/hazelcast/pull/16795#discussion_r398365321", "createdAt": "2020-03-26T07:34:20Z", "author": {"login": "puzpuzpuz"}, "path": "hazelcast/src/main/java/com/hazelcast/replicatedmap/impl/record/AbstractReplicatedRecordStore.java", "diffHunk": "@@ -86,7 +86,7 @@ private Object remove(InternalReplicatedMapStorage<K, V> storage, Object key) {\n             storage.remove(marshalledKey, current);\n         }\n         if (replicatedMapConfig.isStatisticsEnabled()) {\n-            getStats().incrementRemoves(Clock.currentTimeMillis() - time);\n+            getStats().incrementRemoves(System.nanoTime() - time);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a1c6241fcdd7f799d43e31b85508a6030960a75"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "518f0bd2dcc6981e8db9601e457eca2864209de5", "author": {"user": {"login": "alex-dukhno", "name": "Alex Dukhno"}}, "url": "https://github.com/hazelcast/hazelcast/commit/518f0bd2dcc6981e8db9601e457eca2864209de5", "committedDate": "2020-03-26T10:10:52Z", "message": "align naming to nanos"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxOTEzNDA3", "url": "https://github.com/hazelcast/hazelcast/pull/16795#pullrequestreview-381913407", "createdAt": "2020-03-26T11:20:36Z", "commit": {"oid": "518f0bd2dcc6981e8db9601e457eca2864209de5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyMjA3OTU0", "url": "https://github.com/hazelcast/hazelcast/pull/16795#pullrequestreview-382207954", "createdAt": "2020-03-26T16:51:49Z", "commit": {"oid": "518f0bd2dcc6981e8db9601e457eca2864209de5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyMjExNTc1", "url": "https://github.com/hazelcast/hazelcast/pull/16795#pullrequestreview-382211575", "createdAt": "2020-03-26T16:55:42Z", "commit": {"oid": "518f0bd2dcc6981e8db9601e457eca2864209de5"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNjo1NTo0MlrOF8Qu8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNjo1NTo0MlrOF8Qu8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODczMzA0MA==", "bodyText": "These should be converted to MS too.", "url": "https://github.com/hazelcast/hazelcast/pull/16795#discussion_r398733040", "createdAt": "2020-03-26T16:55:42Z", "author": {"login": "blazember"}, "path": "hazelcast/src/main/java/com/hazelcast/internal/monitor/impl/LocalReplicatedMapStatsImpl.java", "diffHunk": "@@ -235,62 +232,68 @@ public long getPutOperationCount() {\n         return putCount;\n     }\n \n-    public void incrementPuts(long latency) {\n+    public void incrementPutsNanos(long latencyNanos) {\n         PUT_COUNT.incrementAndGet(this);\n-        TOTAL_PUT_LATENCIES.addAndGet(this, latency);\n-        setMax(this, MAX_PUT_LATENCY, latency);\n+        TOTAL_PUT_LATENCIES.addAndGet(this, latencyNanos);\n+        setMax(this, MAX_PUT_LATENCY, latencyNanos);\n     }\n \n     @Override\n     public long getGetOperationCount() {\n         return getCount;\n     }\n \n-    public void incrementGets(long latency) {\n+    public void incrementGetsNanos(long latencyNanos) {\n         GET_COUNT.incrementAndGet(this);\n-        TOTAL_GET_LATENCIES.addAndGet(this, latency);\n-        setMax(this, MAX_GET_LATENCY, latency);\n+        TOTAL_GET_LATENCIES.addAndGet(this, latencyNanos);\n+        setMax(this, MAX_GET_LATENCY, latencyNanos);\n     }\n \n     @Override\n     public long getRemoveOperationCount() {\n         return removeCount;\n     }\n \n-    public void incrementRemoves(long latency) {\n+    public void incrementRemovesNanos(long latencyNanos) {\n         REMOVE_COUNT.incrementAndGet(this);\n-        TOTAL_REMOVE_LATENCIES.addAndGet(this, latency);\n-        setMax(this, MAX_REMOVE_LATENCY, latency);\n+        TOTAL_REMOVE_LATENCIES.addAndGet(this, latencyNanos);\n+        setMax(this, MAX_REMOVE_LATENCY, latencyNanos);\n     }\n \n+    @Probe(name = REPLICATED_MAP_METRIC_TOTAL_PUT_LATENCIES, unit = MS)\n     @Override\n     public long getTotalPutLatency() {\n-        return totalPutLatencies;\n+        return convertNanosToMillis(totalPutLatenciesNanos);\n     }\n \n+    @Probe(name = REPLICATED_MAP_METRIC_TOTAL_GET_LATENCIES, unit = MS)\n     @Override\n     public long getTotalGetLatency() {\n-        return totalGetLatencies;\n+        return convertNanosToMillis(totalGetLatenciesNanos);\n     }\n \n+    @Probe(name = REPLICATED_MAP_METRIC_TOTAL_REMOVE_LATENCIES, unit = MS)\n     @Override\n     public long getTotalRemoveLatency() {\n-        return totalRemoveLatencies;\n+        return convertNanosToMillis(totalRemoveLatenciesNanos);\n     }\n \n+    @Probe(name = REPLICATED_MAP_MAX_GET_LATENCY, unit = MS)\n     @Override\n     public long getMaxPutLatency() {\n-        return maxPutLatency;\n+        return maxPutLatencyNanos;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "518f0bd2dcc6981e8db9601e457eca2864209de5"}, "originalPosition": 125}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a5ec91df0b4252c2870c0bd581b691c2b9854b5", "author": {"user": {"login": "alex-dukhno", "name": "Alex Dukhno"}}, "url": "https://github.com/hazelcast/hazelcast/commit/4a5ec91df0b4252c2870c0bd581b691c2b9854b5", "committedDate": "2020-03-27T15:34:18Z", "message": "fix convertions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a212d66f816837aa092d1c855edff40587e2fea0", "author": {"user": {"login": "alex-dukhno", "name": "Alex Dukhno"}}, "url": "https://github.com/hazelcast/hazelcast/commit/a212d66f816837aa092d1c855edff40587e2fea0", "committedDate": "2020-03-31T10:39:33Z", "message": "fix tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0NjUzNzUy", "url": "https://github.com/hazelcast/hazelcast/pull/16795#pullrequestreview-384653752", "createdAt": "2020-03-31T11:49:05Z", "commit": {"oid": "a212d66f816837aa092d1c855edff40587e2fea0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0NjcxMTUw", "url": "https://github.com/hazelcast/hazelcast/pull/16795#pullrequestreview-384671150", "createdAt": "2020-03-31T12:14:17Z", "commit": {"oid": "a212d66f816837aa092d1c855edff40587e2fea0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3912, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}