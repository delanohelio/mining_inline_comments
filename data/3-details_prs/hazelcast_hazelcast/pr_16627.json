{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzczMDQxMzA2", "number": 16627, "title": "Several migration fixes", "bodyText": "Several fixes in migration system. See individual commits for more details:\n\nPartitionStateOperation should not be sent to unknown members\nMigration operations should rely master member observed by PartitionService\nFix race between fetching the most recent partition table and ongoing migration\nOnly first migration fragment should set active migration in MigrationOperation\nAvoid unnecessary empty replication operations\n\nFixes #16601", "createdAt": "2020-02-10T10:00:21Z", "url": "https://github.com/hazelcast/hazelcast/pull/16627", "merged": true, "mergeCommit": {"oid": "fa7660e5d53b1041f26e45029512c21860f6f850"}, "closed": true, "closedAt": "2020-02-12T10:18:54Z", "author": {"login": "mdogan"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcC6lmxABqjMwMjIxMzYyMTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcDiH2UABqjMwMjk4MTY4OTY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7d254446206df7a8fe8ef07b84b3cd031df9db74", "author": {"user": {"login": "mdogan", "name": "Mehmet Dogan"}}, "url": "https://github.com/hazelcast/hazelcast/commit/7d254446206df7a8fe8ef07b84b3cd031df9db74", "committedDate": "2020-02-10T07:52:17Z", "message": "Avoid unnecessary empty replication operations\n\nWhen there is no data to replicate, some services are still\ncreating empty replication operations. This causes redundant migration steps."}, "afterCommit": {"oid": "a8fb7de0e2d21fdb3dd39bc7f3bd7c3cf4290c5e", "author": {"user": {"login": "mdogan", "name": "Mehmet Dogan"}}, "url": "https://github.com/hazelcast/hazelcast/commit/a8fb7de0e2d21fdb3dd39bc7f3bd7c3cf4290c5e", "committedDate": "2020-02-10T10:26:40Z", "message": "Avoid unnecessary empty replication operations\n\nWhen there is no data to replicate, some services are still\ncreating empty replication operations. This causes redundant migration steps."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a8fb7de0e2d21fdb3dd39bc7f3bd7c3cf4290c5e", "author": {"user": {"login": "mdogan", "name": "Mehmet Dogan"}}, "url": "https://github.com/hazelcast/hazelcast/commit/a8fb7de0e2d21fdb3dd39bc7f3bd7c3cf4290c5e", "committedDate": "2020-02-10T10:26:40Z", "message": "Avoid unnecessary empty replication operations\n\nWhen there is no data to replicate, some services are still\ncreating empty replication operations. This causes redundant migration steps."}, "afterCommit": {"oid": "2d2afb6dd3bf98c46a11d4f02d640dbef4c1d27a", "author": {"user": {"login": "mdogan", "name": "Mehmet Dogan"}}, "url": "https://github.com/hazelcast/hazelcast/commit/2d2afb6dd3bf98c46a11d4f02d640dbef4c1d27a", "committedDate": "2020-02-10T12:14:18Z", "message": "Avoid unnecessary empty replication operations\n\nWhen there is no data to replicate, some services are still\ncreating empty replication operations. This causes redundant migration steps."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2MDA1MzA2", "url": "https://github.com/hazelcast/hazelcast/pull/16627#pullrequestreview-356005306", "createdAt": "2020-02-10T15:01:31Z", "commit": {"oid": "de8e7ef29522a87b144c6f0f0e3ec636f72ab4ae"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxNTowMTozMVrOFnpTxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxNTowMTozMVrOFnpTxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzExNTU5MQ==", "bodyText": "should we still throw IllegalStateException if the caller is different than clusterService.getMasterAddress() here?", "url": "https://github.com/hazelcast/hazelcast/pull/16627#discussion_r377115591", "createdAt": "2020-02-10T15:01:31Z", "author": {"login": "metanet"}, "path": "hazelcast/src/main/java/com/hazelcast/internal/partition/operation/FetchPartitionStateOperation.java", "diffHunk": "@@ -42,12 +42,11 @@ public FetchPartitionStateOperation() {\n     @Override\n     public void run() {\n         Address caller = getCallerAddress();\n-        NodeEngine nodeEngine = getNodeEngine();\n-        Address master = nodeEngine.getMasterAddress();\n-        if (!caller.equals(master)) {\n-            String msg = caller + \" requested our partition table but it's not our known master. \" + \"Master: \" + master;\n+        InternalPartitionServiceImpl service = getService();\n+        if (!service.isMemberMaster(caller)) {\n+            String msg = caller + \" requested our partition table but it's not our known master.\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de8e7ef29522a87b144c6f0f0e3ec636f72ab4ae"}, "originalPosition": 10}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2d2afb6dd3bf98c46a11d4f02d640dbef4c1d27a", "author": {"user": {"login": "mdogan", "name": "Mehmet Dogan"}}, "url": "https://github.com/hazelcast/hazelcast/commit/2d2afb6dd3bf98c46a11d4f02d640dbef4c1d27a", "committedDate": "2020-02-10T12:14:18Z", "message": "Avoid unnecessary empty replication operations\n\nWhen there is no data to replicate, some services are still\ncreating empty replication operations. This causes redundant migration steps."}, "afterCommit": {"oid": "a2fb59b7601192d764e5f7dc7c6bf6e3a2b44c75", "author": {"user": {"login": "mdogan", "name": "Mehmet Dogan"}}, "url": "https://github.com/hazelcast/hazelcast/commit/a2fb59b7601192d764e5f7dc7c6bf6e3a2b44c75", "committedDate": "2020-02-11T07:02:07Z", "message": "Avoid unnecessary empty replication operations\n\nWhen there is no data to replicate, some services are still\ncreating empty replication operations. This causes redundant migration steps."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2NTAxNTY0", "url": "https://github.com/hazelcast/hazelcast/pull/16627#pullrequestreview-356501564", "createdAt": "2020-02-11T09:17:12Z", "commit": {"oid": "a2fb59b7601192d764e5f7dc7c6bf6e3a2b44c75"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2Njc5MDAz", "url": "https://github.com/hazelcast/hazelcast/pull/16627#pullrequestreview-356679003", "createdAt": "2020-02-11T14:03:04Z", "commit": {"oid": "a2fb59b7601192d764e5f7dc7c6bf6e3a2b44c75"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ceeadc8a6100a4c7340c74dd9bfc757efd5dbdb", "author": {"user": {"login": "mdogan", "name": "Mehmet Dogan"}}, "url": "https://github.com/hazelcast/hazelcast/commit/7ceeadc8a6100a4c7340c74dd9bfc757efd5dbdb", "committedDate": "2020-02-12T08:32:24Z", "message": "PartitionStateOperation should not be sent to unknown members\n\nPartitionStateOperation is sent by master to other cluster members.\nTarget member might be removed from cluster while invocation is being\nretried. In this case, invocation should fail."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e254f09653e02f9421184de3d43bde6873206fb", "author": {"user": {"login": "mdogan", "name": "Mehmet Dogan"}}, "url": "https://github.com/hazelcast/hazelcast/commit/5e254f09653e02f9421184de3d43bde6873206fb", "committedDate": "2020-02-12T08:32:27Z", "message": "Migration operations should rely master member observed by PartitionService\n\nNormally observation of master member and partition update operations are ordered\nusing the latest observed master by the PartitionService under partition lock.\nThis was introduced by fa9616336f7c693fa740cf8d60aefebaeb5f19d4.\n\nBut there were some remaining direct usages of `ClusterService.masterAddress`,\nwhich are causing inconsistencies while mastership claim is in progress\n(while master is about to change).\n\nIntroduced a new method, `isMemberMaster(address)`, which returns `true`\nonly and only if the given `address` is equal to the master address\nin ClusterService and the master member observed by PartitionService."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2d8a08e7a0781dca8f1d36f422f0b72b044d32d", "author": {"user": {"login": "mdogan", "name": "Mehmet Dogan"}}, "url": "https://github.com/hazelcast/hazelcast/commit/e2d8a08e7a0781dca8f1d36f422f0b72b044d32d", "committedDate": "2020-02-12T08:32:27Z", "message": "Fix race between fetching the most recent partition table and ongoing migration\n\n`FetchMostRecentPartitionTableTask` is executed when a member becomes master\nand used to determine the most recent partition table in cluster.\n\n`FetchPartitionStateOperation` is submitted to cluster members by the new master\nto fetch their partition tables.\n\nBut if there is a concurrently running `MigrationOperation` while\n`FetchMostRecentPartitionTableTask` or `FetchPartitionStateOperation` is being executed,\nthey might not observe the active migration on local node.\nThis is a very small window of race but when happens that active migration remains uncommitted\nand further migrations cannot be processed on that node.\n\nTo fix that, a task submitted to each partition thread to ensure\nthere's no ongoing migration operation before reading the most recent\npartition table on that node."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2bbf1f2adddc968af28e2c5cda6e3341a2b2441", "author": {"user": {"login": "mdogan", "name": "Mehmet Dogan"}}, "url": "https://github.com/hazelcast/hazelcast/commit/c2bbf1f2adddc968af28e2c5cda6e3341a2b2441", "committedDate": "2020-02-12T08:32:27Z", "message": "Only first migration fragment should set active migration in MigrationOperation\n\nFirst migration fragment should set the active migration\nand later fragments should check whether active migration is set\nand equal to the expected migration."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea8f5913165c13fd5dd6805ab3463853acd189eb", "author": {"user": {"login": "mdogan", "name": "Mehmet Dogan"}}, "url": "https://github.com/hazelcast/hazelcast/commit/ea8f5913165c13fd5dd6805ab3463853acd189eb", "committedDate": "2020-02-12T08:32:27Z", "message": "Avoid unnecessary empty replication operations\n\nWhen there is no data to replicate, some services are still\ncreating empty replication operations. This causes redundant migration steps."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a2fb59b7601192d764e5f7dc7c6bf6e3a2b44c75", "author": {"user": {"login": "mdogan", "name": "Mehmet Dogan"}}, "url": "https://github.com/hazelcast/hazelcast/commit/a2fb59b7601192d764e5f7dc7c6bf6e3a2b44c75", "committedDate": "2020-02-11T07:02:07Z", "message": "Avoid unnecessary empty replication operations\n\nWhen there is no data to replicate, some services are still\ncreating empty replication operations. This causes redundant migration steps."}, "afterCommit": {"oid": "ea8f5913165c13fd5dd6805ab3463853acd189eb", "author": {"user": {"login": "mdogan", "name": "Mehmet Dogan"}}, "url": "https://github.com/hazelcast/hazelcast/commit/ea8f5913165c13fd5dd6805ab3463853acd189eb", "committedDate": "2020-02-12T08:32:27Z", "message": "Avoid unnecessary empty replication operations\n\nWhen there is no data to replicate, some services are still\ncreating empty replication operations. This causes redundant migration steps."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3966, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}