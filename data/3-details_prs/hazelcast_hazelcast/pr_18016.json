{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ2NDk5MTI2", "number": 18016, "title": "Support OBJECT type in comparison operators", "bodyText": "Closes #17302\nPR implements support of OBJECT type comparison. Both left and right operand have to be the same class and implements Comparable interface to be compared, otherwise, QueryException is thrown", "createdAt": "2020-12-29T14:04:23Z", "url": "https://github.com/hazelcast/hazelcast/pull/18016", "merged": true, "mergeCommit": {"oid": "2f1f6efb2fc8a46955026ab1aaec40c850b735e4"}, "closed": true, "closedAt": "2021-01-19T14:38:18Z", "author": {"login": "alex-dukhno"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdq9r8sAFqTU1OTYxNzM1Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdxsM1dAFqTU3MTI5NjUxNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5NjE3MzUz", "url": "https://github.com/hazelcast/hazelcast/pull/18016#pullrequestreview-559617353", "createdAt": "2020-12-29T16:54:16Z", "commit": {"oid": "fe3bc1a44a09267cf612d22d0eb95b7c43b32f70"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQxNjo1NDoxNlrOIMTpEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQxNjo1NDoxNlrOIMTpEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc3NTYzMw==", "bodyText": "The check for class should be performed only for operands of OBJECT type since for all other operand types, we know for sure that they are comparable, and of the same type.", "url": "https://github.com/hazelcast/hazelcast/pull/18016#discussion_r549775633", "createdAt": "2020-12-29T16:54:16Z", "author": {"login": "devozerov"}, "path": "hazelcast/src/main/java/com/hazelcast/sql/impl/expression/predicate/ComparisonPredicate.java", "diffHunk": "@@ -77,6 +78,13 @@ public Boolean eval(Row row, ExpressionEvalContext context) {\n             return null;\n         }\n \n+        Class<?> leftClass = left.getClass();\n+        Class<?> rightClass = right.getClass();\n+\n+        if (!(left instanceof Comparable && leftClass.equals(rightClass))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe3bc1a44a09267cf612d22d0eb95b7c43b32f70"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5NjE5MzE2", "url": "https://github.com/hazelcast/hazelcast/pull/18016#pullrequestreview-559619316", "createdAt": "2020-12-29T16:59:29Z", "commit": {"oid": "fe3bc1a44a09267cf612d22d0eb95b7c43b32f70"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQxNjo1OToyOVrOIMTwAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQxNjo1OToyOVrOIMTwAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc3NzQxMA==", "bodyText": "It is not very obvious from the message what does \"incomparable\" mean. Better messages could be (rough examples):\n\nIf the object is not comparable: Cannot compare OBJECT value because it doesn't implement Comparable interface\nIf objects are of different types: Cannot compare two OBJECT values, because they have different classes", "url": "https://github.com/hazelcast/hazelcast/pull/18016#discussion_r549777410", "createdAt": "2020-12-29T16:59:29Z", "author": {"login": "devozerov"}, "path": "hazelcast/src/main/java/com/hazelcast/sql/impl/expression/predicate/ComparisonPredicate.java", "diffHunk": "@@ -77,6 +78,13 @@ public Boolean eval(Row row, ExpressionEvalContext context) {\n             return null;\n         }\n \n+        Class<?> leftClass = left.getClass();\n+        Class<?> rightClass = right.getClass();\n+\n+        if (!(left instanceof Comparable && leftClass.equals(rightClass))) {\n+            throw QueryException.error(\"trying to compare two incomparable objects\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe3bc1a44a09267cf612d22d0eb95b7c43b32f70"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5NjIwNjk3", "url": "https://github.com/hazelcast/hazelcast/pull/18016#pullrequestreview-559620697", "createdAt": "2020-12-29T17:00:37Z", "commit": {"oid": "fe3bc1a44a09267cf612d22d0eb95b7c43b32f70"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQxNzowMDozN1rOIMTyYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQxNzowMDozN1rOIMTyYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc3ODAxNg==", "bodyText": "We now do not have tests for OBJECT vs non-OBJECT compares.", "url": "https://github.com/hazelcast/hazelcast/pull/18016#discussion_r549778016", "createdAt": "2020-12-29T17:00:37Z", "author": {"login": "devozerov"}, "path": "hazelcast-sql-core/src/test/java/com/hazelcast/sql/impl/expression/predicate/ComparisonPredicateIntegrationTest.java", "diffHunk": "@@ -223,7 +224,51 @@ public void testUnsupported() {\n         checkUnsupportedColumnColumn(ExpressionTypes.LOCAL_TIME, ExpressionTypes.allExcept());\n         checkUnsupportedColumnColumn(ExpressionTypes.LOCAL_DATE_TIME, ExpressionTypes.allExcept());\n         checkUnsupportedColumnColumn(ExpressionTypes.OFFSET_DATE_TIME, ExpressionTypes.allExcept());\n-        checkUnsupportedColumnColumn(ExpressionTypes.OBJECT, ExpressionTypes.allExcept());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe3bc1a44a09267cf612d22d0eb95b7c43b32f70"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY1NDUwMTEx", "url": "https://github.com/hazelcast/hazelcast/pull/18016#pullrequestreview-565450111", "createdAt": "2021-01-11T15:17:08Z", "commit": {"oid": "204c10d84dfb1fdfeab435fbd765e45d045ad9ae"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY2MDI0Mzk4", "url": "https://github.com/hazelcast/hazelcast/pull/18016#pullrequestreview-566024398", "createdAt": "2021-01-12T08:15:49Z", "commit": {"oid": "204c10d84dfb1fdfeab435fbd765e45d045ad9ae"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMlQwODoxNTo1MFrOIR2HFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMlQwODoxNTo1MFrOIR2HFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTU4MzI1Mw==", "bodyText": "consider printing the actual class.\nmore diagnostics could be very useful here. for example with Portable object it would be good to know its class/factory IDs.\notherwise it's hard to tell what actually went wrong and how to fix it.", "url": "https://github.com/hazelcast/hazelcast/pull/18016#discussion_r555583253", "createdAt": "2021-01-12T08:15:50Z", "author": {"login": "jerrinot"}, "path": "hazelcast/src/main/java/com/hazelcast/sql/impl/expression/predicate/ComparisonPredicate.java", "diffHunk": "@@ -77,6 +79,20 @@ public Boolean eval(Row row, ExpressionEvalContext context) {\n             return null;\n         }\n \n+        if (this.operand1.getType().getTypeFamily() == QueryDataTypeFamily.OBJECT) {\n+            Class<?> leftClass = left.getClass();\n+            Class<?> rightClass = right.getClass();\n+\n+            if (!leftClass.equals(rightClass)) {\n+                throw QueryException.error(\"Cannot compare two OBJECT values, because they have different classes\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "204c10d84dfb1fdfeab435fbd765e45d045ad9ae"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c5a8306b25438fa2f2d30a5f11caa14b2e01856", "author": {"user": {"login": "alex-dukhno", "name": "Alex Dukhno"}}, "url": "https://github.com/hazelcast/hazelcast/commit/6c5a8306b25438fa2f2d30a5f11caa14b2e01856", "committedDate": "2021-01-15T11:36:30Z", "message": "Support OBJECT type in comparison operators"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "199549dfada196d2872cf87d8f3d2b2fb0261aaa", "author": {"user": {"login": "alex-dukhno", "name": "Alex Dukhno"}}, "url": "https://github.com/hazelcast/hazelcast/commit/199549dfada196d2872cf87d8f3d2b2fb0261aaa", "committedDate": "2021-01-15T11:36:33Z", "message": "fix checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2b67ba9184858586ec06c142fffc24e6efb8b57", "author": {"user": {"login": "alex-dukhno", "name": "Alex Dukhno"}}, "url": "https://github.com/hazelcast/hazelcast/commit/c2b67ba9184858586ec06c142fffc24e6efb8b57", "committedDate": "2021-01-15T11:36:33Z", "message": "update test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d5b1b6ea84534c5ef412bade2c91c1c1c180b63", "author": {"user": {"login": "alex-dukhno", "name": "Alex Dukhno"}}, "url": "https://github.com/hazelcast/hazelcast/commit/5d5b1b6ea84534c5ef412bade2c91c1c1c180b63", "committedDate": "2021-01-15T11:38:47Z", "message": "address review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "006b5233cd0a35f2483dcd544e9fab67b4b211f9", "author": {"user": {"login": "alex-dukhno", "name": "Alex Dukhno"}}, "url": "https://github.com/hazelcast/hazelcast/commit/006b5233cd0a35f2483dcd544e9fab67b4b211f9", "committedDate": "2021-01-15T11:38:49Z", "message": "added class names in query error messages"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0730341e5bac89609e658b323ee5a7ab16ae453", "author": {"user": {"login": "alex-dukhno", "name": "Alex Dukhno"}}, "url": "https://github.com/hazelcast/hazelcast/commit/c0730341e5bac89609e658b323ee5a7ab16ae453", "committedDate": "2021-01-15T11:38:50Z", "message": "fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bcefa1fd725661c8712e9565c82f115dc1b15cc3", "author": {"user": {"login": "alex-dukhno", "name": "Alex Dukhno"}}, "url": "https://github.com/hazelcast/hazelcast/commit/bcefa1fd725661c8712e9565c82f115dc1b15cc3", "committedDate": "2021-01-15T11:50:03Z", "message": "rebase with master"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7009c6ab0dc4c6f08ca025e39a837000b5ffbe76", "author": {"user": {"login": "alex-dukhno", "name": "Alex Dukhno"}}, "url": "https://github.com/hazelcast/hazelcast/commit/7009c6ab0dc4c6f08ca025e39a837000b5ffbe76", "committedDate": "2021-01-12T10:12:52Z", "message": "fix tests"}, "afterCommit": {"oid": "bcefa1fd725661c8712e9565c82f115dc1b15cc3", "author": {"user": {"login": "alex-dukhno", "name": "Alex Dukhno"}}, "url": "https://github.com/hazelcast/hazelcast/commit/bcefa1fd725661c8712e9565c82f115dc1b15cc3", "committedDate": "2021-01-15T11:50:03Z", "message": "rebase with master"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTcxMjk2NTE1", "url": "https://github.com/hazelcast/hazelcast/pull/18016#pullrequestreview-571296515", "createdAt": "2021-01-19T14:29:22Z", "commit": {"oid": "bcefa1fd725661c8712e9565c82f115dc1b15cc3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3078, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}