{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYwNTY0NDUy", "number": 16440, "title": "Fix LossToleranceTest", "bodyText": "Because of the behaviour change introduced in\n#16303, when the requested\nsequence is larger than the largest sequence (tailSequence) + 1, we\ndon't listen from the oldest sequence (headSequence) but rather from the\ntailSequence + 1. Both approaches are fine and both approaches work\nbetter in some scenarios. Since the listener is loss tolerant, we can\nskip items from headSequence..tailSequence+1 anyway.\nFixed the test to adhere to the new behaviour. We assume that eventually\nas we publish an item, it will reach the listener.\nA better fix would be to introduce unique IDs per ringbuffer, where we\nwould then be able to distinguish between a completely lost ringbuffer\nand a ringbuffer which has not received the last few items and\nappropriately reset the requested sequence to the headSequence or\ntailSequence.\nFixes: #16430", "createdAt": "2020-01-08T17:14:49Z", "url": "https://github.com/hazelcast/hazelcast/pull/16440", "merged": true, "mergeCommit": {"oid": "17fa0d0e20777340bc4f988215ed3f0a6104801a"}, "closed": true, "closedAt": "2020-01-09T11:23:51Z", "author": {"login": "mmedenjak"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb4lMSmAFqTM0MDMzODE1Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb4ncn5gBqjI5MzQ0MjY3MDc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwMzM4MTUz", "url": "https://github.com/hazelcast/hazelcast/pull/16440#pullrequestreview-340338153", "createdAt": "2020-01-09T07:54:32Z", "commit": {"oid": "9584a09d12e0cd13a81d3391f982a4658333097a"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQwNzo1NDozMlrOFbtSJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQwNzo1NDozMlrOFbtSJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDU5Nzc5OA==", "bodyText": "I don't know why we assert this bit - as it's internal detail", "url": "https://github.com/hazelcast/hazelcast/pull/16440#discussion_r364597798", "createdAt": "2020-01-09T07:54:32Z", "author": {"login": "cangencer"}, "path": "hazelcast/src/test/java/com/hazelcast/topic/impl/reliable/LossToleranceTest.java", "diffHunk": "@@ -130,24 +117,19 @@ public void whenLossTolerant_andOwnerCrashes_thenContinue() {\n         topic.publish(\"item1\");\n         topic.publish(\"item2\");\n \n-        assertTrueEventually(new AssertTask() {\n-            @Override\n-            public void run() {\n-                assertContains(listener.objects, \"item1\");\n-                assertContains(listener.objects, \"item2\");\n-            }\n+        assertTrueEventually(() -> {\n+            assertContains(listener.objects, \"item1\");\n+            assertContains(listener.objects, \"item2\");\n         });\n         TestUtil.terminateInstance(topicOwnerInstance);\n \n-        topic.publish(\"newItem\");\n-\n-\n-        assertTrueEventually(new AssertTask() {\n-            @Override\n-            public void run() {\n-                assertContains(listener.objects, \"newItem\");\n+        assertTrueEventually(() -> {\n+            String item = \"newItem \" + UUID.randomUUID();\n+            topic.publish(item);\n+            assertTrueEventually(() -> {\n+                assertContains(listener.objects, item);\n                 assertFalse(topic.runnersMap.isEmpty());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9584a09d12e0cd13a81d3391f982a4658333097a"}, "originalPosition": 104}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwMzgyMzM5", "url": "https://github.com/hazelcast/hazelcast/pull/16440#pullrequestreview-340382339", "createdAt": "2020-01-09T09:23:20Z", "commit": {"oid": "9584a09d12e0cd13a81d3391f982a4658333097a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "04f850b8341ae57b9930ae2579402efe9579e100", "author": {"user": {"login": "mmedenjak", "name": "Matko Medenjak"}}, "url": "https://github.com/hazelcast/hazelcast/commit/04f850b8341ae57b9930ae2579402efe9579e100", "committedDate": "2020-01-09T10:31:38Z", "message": "Fix LossToleranceTest\n\nBecause of the behaviour change introduced in\nhttps://github.com/hazelcast/hazelcast/pull/16303, when the requested\nsequence is larger than the largest sequence (tailSequence) + 1, we\ndon't listen from the oldest sequence (headSequence) but rather from the\ntailSequence + 1. Both approaches are fine and both approaches work\nbetter in some scenarios. Since the listener is loss tolerant, we can\nskip items from headSequence..tailSequence+1 anyway.\n\nFixed the test to adhere to the new behaviour. We assume that eventually\nas we publish an item, it will reach the listener.\n\nA better fix would be to introduce unique IDs per ringbuffer, where we\nwould then be able to distinguish between a completely lost ringbuffer\nand a ringbuffer which has not received the last few items and\nappropriately reset the requested sequence to the headSequence or\ntailSequence.\n\nFixes: https://github.com/hazelcast/hazelcast/issues/16430"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1cb58212ef01321041fcf6ba8159969e8322d92", "author": {"user": {"login": "mmedenjak", "name": "Matko Medenjak"}}, "url": "https://github.com/hazelcast/hazelcast/commit/a1cb58212ef01321041fcf6ba8159969e8322d92", "committedDate": "2020-01-09T10:31:38Z", "message": "Address review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "872c8c7f802df1619b8a48010a4ac3189178486b", "author": {"user": {"login": "mmedenjak", "name": "Matko Medenjak"}}, "url": "https://github.com/hazelcast/hazelcast/commit/872c8c7f802df1619b8a48010a4ac3189178486b", "committedDate": "2020-01-09T10:31:59Z", "message": "Checkstyle"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ba5c8ae950dcce3d1aa32ad018b96be0efa91d58", "author": {"user": {"login": "mmedenjak", "name": "Matko Medenjak"}}, "url": "https://github.com/hazelcast/hazelcast/commit/ba5c8ae950dcce3d1aa32ad018b96be0efa91d58", "committedDate": "2020-01-09T09:57:16Z", "message": "Address review comments"}, "afterCommit": {"oid": "872c8c7f802df1619b8a48010a4ac3189178486b", "author": {"user": {"login": "mmedenjak", "name": "Matko Medenjak"}}, "url": "https://github.com/hazelcast/hazelcast/commit/872c8c7f802df1619b8a48010a4ac3189178486b", "committedDate": "2020-01-09T10:31:59Z", "message": "Checkstyle"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4002, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}