{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM4MjYxNzMw", "number": 17121, "title": "TenantControl - creating cache records must use tenant", "bodyText": "Version 3.12.X\nWrapped factory instantiation in try/finally block with tenant control enabled.\nThis is so factories have their tenant environment set\nPlease view diff w/o whitespace changes to make it a very easy diff :)\n4.0 version of this PR #17122", "createdAt": "2020-06-23T01:37:00Z", "url": "https://github.com/hazelcast/hazelcast/pull/17121", "merged": true, "mergeCommit": {"oid": "08e53cf232b72a06594bdcc7c48246b9ab0b9dd6"}, "closed": true, "closedAt": "2020-06-24T08:18:16Z", "author": {"login": "lprimak"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABct7Lf9AH2gAyNDM4MjYxNzMwOmRhYTg2YTA3OWQ5ZGVlYjhiNDI5ZjEwYTc5MDRlZjFlNzQ4MWMzMGI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcuVgjtAFqTQzNjQxOTIxMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "daa86a079d9deeb8b429f10a7904ef1e7481c30b", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/hazelcast/hazelcast/commit/daa86a079d9deeb8b429f10a7904ef1e7481c30b", "committedDate": "2020-06-23T01:29:38Z", "message": "invoke tenant control when creating cache, so\nwhen factories get invoked, appropriate tenant environment is created"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08482d9750781fdd63799c79fd391b4c9c1336e0", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/hazelcast/hazelcast/commit/08482d9750781fdd63799c79fd391b4c9c1336e0", "committedDate": "2020-06-23T01:42:45Z", "message": "Merge remote-tracking branch 'upstream/3.12.z' into TENANT_CACHE_CREATE_FIX"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1NjY4MTU2", "url": "https://github.com/hazelcast/hazelcast/pull/17121#pullrequestreview-435668156", "createdAt": "2020-06-23T10:55:51Z", "commit": {"oid": "08482d9750781fdd63799c79fd391b4c9c1336e0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxMDo1NTo1MVrOGnj_2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxMDo1NTo1MVrOGnj_2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDEzNzQzMw==", "bodyText": "use throw ExceptionUtil.rethrow(ex); instead here. If ex is already a runtime exception, it will be thrown as is, otherwise it will be wrapped in a HazelcastException.", "url": "https://github.com/hazelcast/hazelcast/pull/17121#discussion_r444137433", "createdAt": "2020-06-23T10:55:51Z", "author": {"login": "vbekiaris"}, "path": "hazelcast/src/main/java/com/hazelcast/cache/impl/AbstractCacheRecordStore.java", "diffHunk": "@@ -162,53 +164,62 @@ public AbstractCacheRecordStore(String cacheNameWithPrefix, int partitionId, Nod\n             throw new CacheNotExistsException(\"Cache \" + cacheNameWithPrefix + \" is already destroyed or not created yet, on \"\n                     + nodeEngine.getLocalMember());\n         }\n-        this.eventJournalConfig = nodeEngine.getConfig().findCacheEventJournalConfig(cacheConfig.getName());\n-        this.evictionConfig = cacheConfig.getEvictionConfig();\n-        if (evictionConfig == null) {\n-            throw new IllegalStateException(\"Eviction config cannot be null!\");\n-        }\n-        this.wanReplicationEnabled = cacheService.isWanReplicationEnabled(cacheNameWithPrefix);\n-        this.disablePerEntryInvalidationEvents = cacheConfig.isDisablePerEntryInvalidationEvents();\n-        if (cacheConfig.isStatisticsEnabled()) {\n-            statistics = cacheService.createCacheStatIfAbsent(cacheNameWithPrefix);\n-        }\n-        if (cacheConfig.getCacheLoaderFactory() != null) {\n-            Factory<CacheLoader> cacheLoaderFactory = cacheConfig.getCacheLoaderFactory();\n-            injectDependencies(cacheLoaderFactory);\n-            cacheLoader = cacheLoaderFactory.create();\n-            injectDependencies(cacheLoader);\n-        }\n-        if (cacheConfig.getCacheWriterFactory() != null) {\n-            Factory<CacheWriter> cacheWriterFactory = cacheConfig.getCacheWriterFactory();\n-            injectDependencies(cacheWriterFactory);\n-            cacheWriter = cacheWriterFactory.create();\n-            injectDependencies(cacheWriter);\n-        }\n-        if (cacheConfig.getExpiryPolicyFactory() != null) {\n-            Factory<ExpiryPolicy> expiryPolicyFactory = cacheConfig.getExpiryPolicyFactory();\n-            injectDependencies(expiryPolicyFactory);\n-            defaultExpiryPolicy = expiryPolicyFactory.create();\n-            injectDependencies(defaultExpiryPolicy);\n-        } else {\n-            throw new IllegalStateException(\"Expiry policy factory cannot be null!\");\n-        }\n-\n-        this.cacheContext = cacheService.getOrCreateCacheContext(cacheNameWithPrefix);\n-        this.records = createRecordCacheMap();\n-        this.evictionChecker = createCacheEvictionChecker(evictionConfig.getSize(), evictionConfig.getMaximumSizePolicy());\n-        this.evictionPolicyEvaluator = createEvictionPolicyEvaluator(evictionConfig);\n-        this.evictionStrategy = createEvictionStrategy(evictionConfig);\n-        this.objectNamespace = CacheService.getObjectNamespace(cacheNameWithPrefix);\n-        this.persistWanReplicatedData = canPersistWanReplicatedData(cacheConfig, nodeEngine);\n-        this.cacheRecordFactory = new CacheRecordFactory(cacheConfig.getInMemoryFormat(), ss);\n-        this.valueComparator = getValueComparatorOf(cacheConfig.getInMemoryFormat());\n-        this.clearExpiredRecordsTask = cacheService.getExpirationManager().getTask();\n-\n-        injectDependencies(evictionPolicyEvaluator.getEvictionPolicyComparator());\n-        registerResourceIfItIsClosable(cacheWriter);\n-        registerResourceIfItIsClosable(cacheLoader);\n-        registerResourceIfItIsClosable(defaultExpiryPolicy);\n-        init();\n+        Closeable tenantContext = CacheConfigAccessor.getTenantControl(cacheConfig).setTenant(true);\n+        try {\n+            this.eventJournalConfig = nodeEngine.getConfig().findCacheEventJournalConfig(cacheConfig.getName());\n+            this.evictionConfig = cacheConfig.getEvictionConfig();\n+            if (evictionConfig == null) {\n+                throw new IllegalStateException(\"Eviction config cannot be null!\");\n+            }\n+            this.wanReplicationEnabled = cacheService.isWanReplicationEnabled(cacheNameWithPrefix);\n+            this.disablePerEntryInvalidationEvents = cacheConfig.isDisablePerEntryInvalidationEvents();\n+            if (cacheConfig.isStatisticsEnabled()) {\n+                statistics = cacheService.createCacheStatIfAbsent(cacheNameWithPrefix);\n+            }\n+            if (cacheConfig.getCacheLoaderFactory() != null) {\n+                Factory<CacheLoader> cacheLoaderFactory = cacheConfig.getCacheLoaderFactory();\n+                injectDependencies(cacheLoaderFactory);\n+                cacheLoader = cacheLoaderFactory.create();\n+                injectDependencies(cacheLoader);\n+            }\n+            if (cacheConfig.getCacheWriterFactory() != null) {\n+                Factory<CacheWriter> cacheWriterFactory = cacheConfig.getCacheWriterFactory();\n+                injectDependencies(cacheWriterFactory);\n+                cacheWriter = cacheWriterFactory.create();\n+                injectDependencies(cacheWriter);\n+            }\n+            if (cacheConfig.getExpiryPolicyFactory() != null) {\n+                Factory<ExpiryPolicy> expiryPolicyFactory = cacheConfig.getExpiryPolicyFactory();\n+                injectDependencies(expiryPolicyFactory);\n+                defaultExpiryPolicy = expiryPolicyFactory.create();\n+                injectDependencies(defaultExpiryPolicy);\n+            } else {\n+                throw new IllegalStateException(\"Expiry policy factory cannot be null!\");\n+            }\n+\n+            this.cacheContext = cacheService.getOrCreateCacheContext(cacheNameWithPrefix);\n+            this.records = createRecordCacheMap();\n+            this.evictionChecker = createCacheEvictionChecker(evictionConfig.getSize(), evictionConfig.getMaximumSizePolicy());\n+            this.evictionPolicyEvaluator = createEvictionPolicyEvaluator(evictionConfig);\n+            this.evictionStrategy = createEvictionStrategy(evictionConfig);\n+            this.objectNamespace = CacheService.getObjectNamespace(cacheNameWithPrefix);\n+            this.persistWanReplicatedData = canPersistWanReplicatedData(cacheConfig, nodeEngine);\n+            this.cacheRecordFactory = new CacheRecordFactory(cacheConfig.getInMemoryFormat(), ss);\n+            this.valueComparator = getValueComparatorOf(cacheConfig.getInMemoryFormat());\n+            this.clearExpiredRecordsTask = cacheService.getExpirationManager().getTask();\n+\n+            injectDependencies(evictionPolicyEvaluator.getEvictionPolicyComparator());\n+            registerResourceIfItIsClosable(cacheWriter);\n+            registerResourceIfItIsClosable(cacheLoader);\n+            registerResourceIfItIsClosable(defaultExpiryPolicy);\n+            init();\n+        } finally {\n+            try {\n+                tenantContext.close();\n+            } catch (IOException ex) {\n+                throw new RuntimeException(ex);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08482d9750781fdd63799c79fd391b4c9c1336e0"}, "originalPosition": 120}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1NjcwNTk5", "url": "https://github.com/hazelcast/hazelcast/pull/17121#pullrequestreview-435670599", "createdAt": "2020-06-23T10:59:40Z", "commit": {"oid": "08482d9750781fdd63799c79fd391b4c9c1336e0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "17c413484339ec2d470ff292ed5a6f472bfb531f", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/hazelcast/hazelcast/commit/17c413484339ec2d470ff292ed5a6f472bfb531f", "committedDate": "2020-06-23T16:49:40Z", "message": "- using ExceptionUtils.rethrow() instead of throw RuntimeException()\n- moved some of constructor's functionality into a private method to comply with checkstyle rules"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "308765aa5d0b96441f7cd804e15c56ac97766433", "author": {"user": {"login": "lprimak", "name": "Lenny Primak"}}, "url": "https://github.com/hazelcast/hazelcast/commit/308765aa5d0b96441f7cd804e15c56ac97766433", "committedDate": "2020-06-23T20:17:30Z", "message": "fixed failing test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2MzgwODYz", "url": "https://github.com/hazelcast/hazelcast/pull/17121#pullrequestreview-436380863", "createdAt": "2020-06-24T07:11:48Z", "commit": {"oid": "308765aa5d0b96441f7cd804e15c56ac97766433"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2NDE5MjEy", "url": "https://github.com/hazelcast/hazelcast/pull/17121#pullrequestreview-436419212", "createdAt": "2020-06-24T08:10:10Z", "commit": {"oid": "308765aa5d0b96441f7cd804e15c56ac97766433"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3723, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}