{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc5MDM0MTQ0", "number": 16682, "title": "Remove OAHashSet from merkle trees", "bodyText": "EE: hazelcast/hazelcast-enterprise#3537\nOAHashSets were collections in merkle tree leaves holding references to keys. It allows us to easily collect keys and entries when doing merkle tree sync. Unfortunately, these consume lots of heap, especially when the partition and map count is high. Instead, we will now iterate over the entire partition and calculate the hashcode to determine if the entry belongs to the leaf or not. Turns out, iterating the partition is not that costly.\nFurther heap cost optimizations of the tree are possible but are out of scope for this PR.\nResults for iterating a single partition in a record store and calculating hash codes for a number of entries on a lab machine. Entry count is number of entries in a single partition. Key size is in bytes. Keys are always serialized so there's no point in measuring with OBJECT format or using classes with complicated hashcode implementations, the size of the byte array and the backing store implementation is all that matters.\nBenchmark                                               (entryCount)  (inMemoryFormat)  (keySize)  Mode  Cnt   Score   Error  Units\nRecordStoreMerkleTreeIterationBenchmark.test_iteration         10000            NATIVE         10  avgt   50   0.163 ? 0.003  ms/op\nRecordStoreMerkleTreeIterationBenchmark.test_iteration         10000            NATIVE        128  avgt   50   0.163 ? 0.002  ms/op\nRecordStoreMerkleTreeIterationBenchmark.test_iteration         10000            NATIVE       1024  avgt   50   0.163 ? 0.002  ms/op\nRecordStoreMerkleTreeIterationBenchmark.test_iteration         10000            BINARY         10  avgt   50   1.376 ? 0.012  ms/op\nRecordStoreMerkleTreeIterationBenchmark.test_iteration         10000            BINARY        128  avgt   50   1.366 ? 0.015  ms/op\nRecordStoreMerkleTreeIterationBenchmark.test_iteration         10000            BINARY       1024  avgt   50   1.378 ? 0.014  ms/op\nRecordStoreMerkleTreeIterationBenchmark.test_iteration        100000            NATIVE         10  avgt   50   1.543 ? 0.009  ms/op\nRecordStoreMerkleTreeIterationBenchmark.test_iteration        100000            NATIVE        128  avgt   50   1.542 ? 0.015  ms/op\nRecordStoreMerkleTreeIterationBenchmark.test_iteration        100000            NATIVE       1024  avgt   50   1.542 ? 0.008  ms/op\nRecordStoreMerkleTreeIterationBenchmark.test_iteration        100000            BINARY         10  avgt   50  14.662 ? 0.227  ms/op\nRecordStoreMerkleTreeIterationBenchmark.test_iteration        100000            BINARY        128  avgt   50  14.613 ? 0.201  ms/op\nRecordStoreMerkleTreeIterationBenchmark.test_iteration        100000            BINARY       1024  avgt   50  14.359 ? 0.155  ms/op\n\nWe can see that the overhead of calculating hashcode is insignificant in relation to synchronizing partitions over WAN or local network, which means we can proceed with removing the OAHashSet.", "createdAt": "2020-02-24T14:55:52Z", "url": "https://github.com/hazelcast/hazelcast/pull/16682", "merged": true, "mergeCommit": {"oid": "aeca5e040ea14a2be643681abad2e1d5e9bc409a"}, "closed": true, "closedAt": "2020-08-04T19:39:21Z", "author": {"login": "mmedenjak"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABckcZTSABqjMzNjgwMDE0NzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc3ESK3gH2gAyMzc5MDM0MTQ0OjA5NWRhOTIzMjlmN2NmOTM1NjY5MmI5MmZkMTI1YzE4Mjg5ZGFjYWU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dcfba1bee73d6e700a4f26b2ea6542a47af6c4bd", "author": {"user": {"login": "mmedenjak", "name": "Matko Medenjak"}}, "url": "https://github.com/hazelcast/hazelcast/commit/dcfba1bee73d6e700a4f26b2ea6542a47af6c4bd", "committedDate": "2020-02-24T14:54:43Z", "message": "wip"}, "afterCommit": {"oid": "c2dd2d1f8942d050360be9ef98f1f11533c965f6", "author": {"user": {"login": "mmedenjak", "name": "Matko Medenjak"}}, "url": "https://github.com/hazelcast/hazelcast/commit/c2dd2d1f8942d050360be9ef98f1f11533c965f6", "committedDate": "2020-05-24T14:31:59Z", "message": "Remove OAHashSet"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f1bf6d517f65045d1a66c57df8feb971521c4afb", "author": {"user": {"login": "mmedenjak", "name": "Matko Medenjak"}}, "url": "https://github.com/hazelcast/hazelcast/commit/f1bf6d517f65045d1a66c57df8feb971521c4afb", "committedDate": "2020-05-24T14:34:04Z", "message": "Remove OAHashSet"}, "afterCommit": {"oid": "d7ea324d0dc118d0b4c578b2258d167847ba98a4", "author": {"user": {"login": "mmedenjak", "name": "Matko Medenjak"}}, "url": "https://github.com/hazelcast/hazelcast/commit/d7ea324d0dc118d0b4c578b2258d167847ba98a4", "committedDate": "2020-06-29T13:47:34Z", "message": "Remove OAHashSet"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7b690f4a4471759b9e3d445ebcf151420068be63", "author": {"user": {"login": "mmedenjak", "name": "Matko Medenjak"}}, "url": "https://github.com/hazelcast/hazelcast/commit/7b690f4a4471759b9e3d445ebcf151420068be63", "committedDate": "2020-06-30T06:44:10Z", "message": "Checkstyle"}, "afterCommit": {"oid": "c009f562c566d61c0d0cc9756ffad49b165bc48a", "author": {"user": {"login": "mmedenjak", "name": "Matko Medenjak"}}, "url": "https://github.com/hazelcast/hazelcast/commit/c009f562c566d61c0d0cc9756ffad49b165bc48a", "committedDate": "2020-07-01T15:40:12Z", "message": "Address review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwOTk0ODEz", "url": "https://github.com/hazelcast/hazelcast/pull/16682#pullrequestreview-440994813", "createdAt": "2020-07-01T15:49:52Z", "commit": {"oid": "c009f562c566d61c0d0cc9756ffad49b165bc48a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxNTo0OTo1M1rOGrrrPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxNTo0OTo1M1rOGrrrPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ1NzUzMw==", "bodyText": "It was really nice seeing the footprint no longer increases with entry count.", "url": "https://github.com/hazelcast/hazelcast/pull/16682#discussion_r448457533", "createdAt": "2020-07-01T15:49:53Z", "author": {"login": "mmedenjak"}, "path": "hazelcast/src/test/java/com/hazelcast/wan/impl/merkletree/ArrayMerkleTreeTest.java", "diffHunk": "@@ -67,11 +60,11 @@ public void testFootprint() {\n             merkleTree2.updateAdd(i, i);\n         }\n \n-        assertTrue(merkleTree2.footprint() > merkleTree1.footprint());\n+        assertEquals(merkleTree2.footprint(), merkleTree1.footprint());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c009f562c566d61c0d0cc9756ffad49b165bc48a"}, "originalPosition": 21}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ac2f99685fd51b2b1eef62972f7cbc1000d25a09", "author": {"user": {"login": "mmedenjak", "name": "Matko Medenjak"}}, "url": "https://github.com/hazelcast/hazelcast/commit/ac2f99685fd51b2b1eef62972f7cbc1000d25a09", "committedDate": "2020-07-01T15:50:19Z", "message": "Checkstyle"}, "afterCommit": {"oid": "8ee677389d9a21defcaec3dfa05e0b1bd69a5cae", "author": {"user": {"login": "mmedenjak", "name": "Matko Medenjak"}}, "url": "https://github.com/hazelcast/hazelcast/commit/8ee677389d9a21defcaec3dfa05e0b1bd69a5cae", "committedDate": "2020-07-03T14:56:35Z", "message": "Checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzOTAyMjY5", "url": "https://github.com/hazelcast/hazelcast/pull/16682#pullrequestreview-443902269", "createdAt": "2020-07-07T13:42:40Z", "commit": {"oid": "8ee677389d9a21defcaec3dfa05e0b1bd69a5cae"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxMzo0Mjo0MFrOGt_JsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxMzo0Mjo0MFrOGt_JsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg3Mzc3Ng==", "bodyText": "I think we don't have this anymore since leafKeys is removed", "url": "https://github.com/hazelcast/hazelcast/pull/16682#discussion_r450873776", "createdAt": "2020-07-07T13:42:40Z", "author": {"login": "blazember"}, "path": "hazelcast/src/main/java/com/hazelcast/wan/impl/merkletree/ArrayMerkleTree.java", "diffHunk": "@@ -81,32 +80,29 @@\n  * {@link MerkleTreeUtil#sumHash(int, int)}\n  */\n public class ArrayMerkleTree extends AbstractMerkleTreeView implements MerkleTree {\n-    private final OAHashSet<Object>[] leafKeys;\n     private final int leafLevel;\n \n     /**\n-     * Footprint holds the total memory footprint of the Merkle tree and\n-     * the leaf data blocks.\n-     * <p>\n-     * Note that this field leverages a single-writer and a non-atomic\n-     * operation is executed on the field. See {@link #adjustFootprintWithLeafKeySetChange}\n+     * Footprint holds the total memory footprint of the Merkle tree.\n      */\n-    private volatile long footprint;\n+    private final long footprint;\n \n-    @SuppressWarnings(\"unchecked\")\n     public ArrayMerkleTree(int depth) {\n         super(depth);\n-\n         this.leafLevel = depth - 1;\n-\n-        final int leaves = MerkleTreeUtil.getNodesOnLevel(leafLevel);\n-\n-        leafKeys = new OAHashSet[leaves];\n-        for (int i = 0; i < leaves; i++) {\n-            leafKeys[i] = new OAHashSet<Object>(1);\n-        }\n-\n-        initializeFootprint();\n+        this.footprint = INT_SIZE_IN_BYTES * tree.length\n+                // reference to the tree\n+                + REFERENCE_COST_IN_BYTES\n+                // reference to leafKeys array", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ee677389d9a21defcaec3dfa05e0b1bd69a5cae"}, "originalPosition": 43}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13e98001813a4b4429c3b5fc93a0605e1e6968a6", "author": {"user": {"login": "mmedenjak", "name": "Matko Medenjak"}}, "url": "https://github.com/hazelcast/hazelcast/commit/13e98001813a4b4429c3b5fc93a0605e1e6968a6", "committedDate": "2020-07-09T09:03:23Z", "message": "Remove OAHashSet"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a2c4b1b73db592e61c495c984d002ee86637dcd", "author": {"user": {"login": "mmedenjak", "name": "Matko Medenjak"}}, "url": "https://github.com/hazelcast/hazelcast/commit/8a2c4b1b73db592e61c495c984d002ee86637dcd", "committedDate": "2020-07-09T09:03:23Z", "message": "Remove OAHashSet"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81703254b918f8346ad8fd4ebfd247c38bffc7f8", "author": {"user": {"login": "mmedenjak", "name": "Matko Medenjak"}}, "url": "https://github.com/hazelcast/hazelcast/commit/81703254b918f8346ad8fd4ebfd247c38bffc7f8", "committedDate": "2020-07-09T09:03:23Z", "message": "Fix compile error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5e5d573843ba742f0d414022ae0bb301b51a9dd", "author": {"user": {"login": "mmedenjak", "name": "Matko Medenjak"}}, "url": "https://github.com/hazelcast/hazelcast/commit/e5e5d573843ba742f0d414022ae0bb301b51a9dd", "committedDate": "2020-07-09T09:03:23Z", "message": "Checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31005b4298b4fcbe1e5025e2ebecd8ef6dfe2635", "author": {"user": {"login": "mmedenjak", "name": "Matko Medenjak"}}, "url": "https://github.com/hazelcast/hazelcast/commit/31005b4298b4fcbe1e5025e2ebecd8ef6dfe2635", "committedDate": "2020-07-09T09:03:23Z", "message": "Address review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ba131aa542893dd126455019c33e5f6ceb2c4a4", "author": {"user": {"login": "mmedenjak", "name": "Matko Medenjak"}}, "url": "https://github.com/hazelcast/hazelcast/commit/7ba131aa542893dd126455019c33e5f6ceb2c4a4", "committedDate": "2020-07-09T09:03:23Z", "message": "Checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5750448f8666c08e55af8ae659ef494c5f2e735a", "author": {"user": {"login": "mmedenjak", "name": "Matko Medenjak"}}, "url": "https://github.com/hazelcast/hazelcast/commit/5750448f8666c08e55af8ae659ef494c5f2e735a", "committedDate": "2020-07-09T09:18:48Z", "message": "Address review comment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8ee677389d9a21defcaec3dfa05e0b1bd69a5cae", "author": {"user": {"login": "mmedenjak", "name": "Matko Medenjak"}}, "url": "https://github.com/hazelcast/hazelcast/commit/8ee677389d9a21defcaec3dfa05e0b1bd69a5cae", "committedDate": "2020-07-03T14:56:35Z", "message": "Checkstyle"}, "afterCommit": {"oid": "5750448f8666c08e55af8ae659ef494c5f2e735a", "author": {"user": {"login": "mmedenjak", "name": "Matko Medenjak"}}, "url": "https://github.com/hazelcast/hazelcast/commit/5750448f8666c08e55af8ae659ef494c5f2e735a", "committedDate": "2020-07-09T09:18:48Z", "message": "Address review comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1NjE2NTg5", "url": "https://github.com/hazelcast/hazelcast/pull/16682#pullrequestreview-445616589", "createdAt": "2020-07-09T13:30:17Z", "commit": {"oid": "5750448f8666c08e55af8ae659ef494c5f2e735a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3ODQ4NjQw", "url": "https://github.com/hazelcast/hazelcast/pull/16682#pullrequestreview-447848640", "createdAt": "2020-07-14T07:17:51Z", "commit": {"oid": "5750448f8666c08e55af8ae659ef494c5f2e735a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "095da92329f7cf9356692b92fd125c18289dacae", "author": {"user": null}, "url": "https://github.com/hazelcast/hazelcast/commit/095da92329f7cf9356692b92fd125c18289dacae", "committedDate": "2020-07-21T11:11:23Z", "message": "Merge branch 'master' into 4.0-wan-remove-oahashset"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3829, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}