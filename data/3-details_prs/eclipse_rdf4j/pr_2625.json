{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE0MDgxNDg4", "number": 2625, "title": "GH-2624: support pass through of single source federated queries", "bodyText": "GitHub issue resolved: #2624\nThis change provides an optimization to the FedX federation engine to\nallow pass-through of query results for single source queries, if a\nTupleQueryResultHandler was supplied (i.e. if the query was executed\nthrough TupleQuery#evaluate(handler).\nThe implementation is done through a helper tuple expression (to\npropagate information into the federation evaluation strategy. Also we\nuse a number of marker interfaces.\nThe implementation is covered by unit tests whose assertions are very\nstrict and will ensure to find errors if other parts of the framework\nchange.\nNote that if no pass-through is possible, the same logic as before is\napplied.\n\nPR Author Checklist (see the contributor guidelines for more details):\n\n my pull request is self-contained\n I've added tests for the changes I made\n I've applied code formatting (you can use mvn process-resources to format from the command line)\n[] I've squashed my commits down to one or a few meaningful commits\n every commit message starts with the issue number (GH-xxxx) followed by a meaningful description of the change\n every commit has been signed off", "createdAt": "2020-11-02T14:03:40Z", "url": "https://github.com/eclipse/rdf4j/pull/2625", "merged": true, "mergeCommit": {"oid": "13146bd6177995ceebf6eecb2174c2e00b263948"}, "closed": true, "closedAt": "2020-11-04T07:30:53Z", "author": {"login": "aschwarte10"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdYlC4RgH2gAyNTE0MDgxNDg4OmNiMmI2MzgyMmU2NGY3MDEzZGNkODcwODQxNTA3NGJkZmRmMmY4NjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZIMnrAFqTUyMzA4MzQ0MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "cb2b63822e64f7013dcd8708415074bdfdf2f866", "author": {"user": {"login": "aschwarte10", "name": "Andreas Schwarte"}}, "url": "https://github.com/eclipse/rdf4j/commit/cb2b63822e64f7013dcd8708415074bdfdf2f866", "committedDate": "2020-11-02T14:01:03Z", "message": "GH-2624: support pass through of single source federated queries\n\nThis change provides an optimization to the FedX federation engine to\nallow pass-through of query results for single source queries, if a\nTupleQueryResultHandler was supplied (i.e. if the query was executed\nthrough TupleQuery#evaluate(handler).\n\nThe implementation is done through a helper tuple expression (to\npropagate information into the federation evaluation strategy. Also we\nuse a number of marker interfaces.\n\nThe implementation is covered by unit tests whose assertions are very\nstrict and will ensure to find errors if other parts of the framework\nchange.\n\nNote that if no pass-through is possible, the same logic as before is\napplied.\n\nSigned-off-by: Andreas Schwarte <aschwarte10@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyOTYyODAw", "url": "https://github.com/eclipse/rdf4j/pull/2625#pullrequestreview-522962800", "createdAt": "2020-11-04T00:13:06Z", "commit": {"oid": "cb2b63822e64f7013dcd8708415074bdfdf2f866"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwMDoxMzowNlrOHtE5qQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwMDoxMzowNlrOHtE5qQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAyODI2NQ==", "bodyText": "Should this be in a try-with-resources block rather than this if-else? There's a possibility here that the resource is left dangling (e.g. if the isPassedThrough method craps out with an exception).", "url": "https://github.com/eclipse/rdf4j/pull/2625#discussion_r517028265", "createdAt": "2020-11-04T00:13:06Z", "author": {"login": "jeenbroekstra"}, "path": "tools/federation/src/main/java/org/eclipse/rdf4j/federated/structures/FedXTupleQuery.java", "diffHunk": "@@ -48,8 +51,26 @@ public TupleQueryResult evaluate() throws QueryEvaluationException {\n \t@Override\n \tpublic void evaluate(TupleQueryResultHandler handler)\n \t\t\tthrows QueryEvaluationException, TupleQueryResultHandlerException {\n+\n+\t\t// attach the handler to the query to allow pass through of results\n+\t\t// for single source queries\n+\t\tTupleExpr tupleExpr = getParsedQuery().getTupleExpr();\n+\t\tPassThroughTupleExpr passThroughTupleExpr = new PassThroughTupleExpr(tupleExpr,\n+\t\t\t\thandler);\n+\t\tdelegate.getParsedQuery().setTupleExpr(passThroughTupleExpr);\n+\n \t\tFedXUtil.applyQueryBindings(this);\n-\t\tdelegate.evaluate(handler);\n+\t\tTupleQueryResult tqr = delegate.evaluate();\n+\n+\t\tif (!passThroughTupleExpr.isPassedThrough()) {\n+\t\t\t// if the result is not passed through to the handler directly,\n+\t\t\t// we need to make sure to report the result. Note that only\n+\t\t\t// SingleSourceQuery instances can be passed through\n+\t\t\tQueryResults.report(tqr, handler);\n+\t\t} else {\n+\t\t\t// to be absolutely sure that everything is closed\n+\t\t\ttqr.close();\n+\t\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb2b63822e64f7013dcd8708415074bdfdf2f866"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzMDgzNDQw", "url": "https://github.com/eclipse/rdf4j/pull/2625#pullrequestreview-523083440", "createdAt": "2020-11-04T06:58:22Z", "commit": {"oid": "cb2b63822e64f7013dcd8708415074bdfdf2f866"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 78, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}