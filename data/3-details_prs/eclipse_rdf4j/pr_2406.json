{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU5NjU4NDQ5", "number": 2406, "title": "GH-2392 elasticsearch upgrade", "bodyText": "GitHub issue resolved: #2392 \nBriefly describe the changes proposed in this PR:\n\nupgrade Elasticsearch / Lucene libraries\nupgrade to Solr 8.4 (instead of 8.5, since 8.5 version seems to break some tests,  which might be related to highlighting)\nuse ElasticsearchClusterRunner instead of EmbeddedElasticsearch (which doesn't support ES7) and updated tests accordingly\nraise the Xmx to 2 GB (needed for ElasticsearchClusterrunner)\nremove explicit snakeyaml dependency from pom.xml (introduced when moving to ES6.8)\nexcluded jetty-alpn HTTP/2, since it caused problems (see also jetty-project/jetty-alpn#15)\nuse ES seqNo en primaryTerm instead of (deprecated) document Version to detect concurrent update issues (see also https://www.elastic.co/guide/en/elasticsearch/reference/current/breaking-changes-7.0.html#_internal_versioning_is_no_longer_supported_for_optimistic_concurrency_control)\nreindex lucene index when the index was written by an older version\n\n\nPR Author Checklist (see the contributor guidelines for more details):\n\n my pull request is self-contained\n I've added tests for the changes I made\n I've applied code formatting (you can use mvn process-resources to format from the command line)\n every commit message starts with the issue number (GH-xxxx) followed by a meaningful description of the change\n every commit has been signed off\n\nNote: we merge all feature pull requests using squash and merge. See RDF4J git merge strategy for more details.", "createdAt": "2020-07-30T22:59:36Z", "url": "https://github.com/eclipse/rdf4j/pull/2406", "merged": true, "mergeCommit": {"oid": "c919c15979bc28a0794cfcf15053eb91d09bf7e5"}, "closed": true, "closedAt": "2021-06-27T11:03:04Z", "author": {"login": "barthanssens"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc8OR76ABqjM2Mjg2NDA2MTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABekrX8cAFqTY5MzM2NzU5NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c22a0c5964de8caa1379376b2c18bc6828152993", "author": {"user": {"login": "barthanssens", "name": "Bart Hanssens"}}, "url": "https://github.com/eclipse/rdf4j/commit/c22a0c5964de8caa1379376b2c18bc6828152993", "committedDate": "2020-08-05T22:21:10Z", "message": "GH-2392 use ES seqno/primary_term instead of deprecated version\n\nSigned-off-by: Bart Hanssens <bart.hanssens@bosa.fgov.be>"}, "afterCommit": {"oid": "241223ec8ee212c1b40a33958e2076e0c40d6c8b", "author": {"user": {"login": "barthanssens", "name": "Bart Hanssens"}}, "url": "https://github.com/eclipse/rdf4j/commit/241223ec8ee212c1b40a33958e2076e0c40d6c8b", "committedDate": "2020-08-06T11:37:11Z", "message": "GH-2392 upgrade ES/Solr/Lucene dependencies + fix test\n\nSigned-off-by: Bart Hanssens <bart.hanssens@bosa.fgov.be>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyOTI3NTEy", "url": "https://github.com/eclipse/rdf4j/pull/2406#pullrequestreview-462927512", "createdAt": "2020-08-06T22:52:53Z", "commit": {"oid": "0f42da053484943f3419d116cd3c5321f60d5ec6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQyMjo1Mjo1M1rOG9GygQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQyMzowNDo0N1rOG9HBjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjcyNzU1Mw==", "bodyText": "Given that this is ignored anyway, perhaps just remove it?", "url": "https://github.com/eclipse/rdf4j/pull/2406#discussion_r466727553", "createdAt": "2020-08-06T22:52:53Z", "author": {"login": "jeenbroekstra"}, "path": "core/sail/elasticsearch-store/src/test/java/org/eclipse/rdf4j/sail/elasticsearchstore/benchmark/AddBenchmark.java", "diffHunk": "@@ -47,22 +46,20 @@\n @OutputTimeUnit(TimeUnit.MILLISECONDS)\n public class AddBenchmark {\n \n-\tprivate static EmbeddedElastic embeddedElastic;\n-\n \tprivate static File installLocation = Files.newTemporaryFolder();\n-\n+\tprivate static ElasticsearchClusterRunner runner;\n \tprivate SailRepository elasticsearchStore;\n \n \t@Setup(Level.Trial)\n \tpublic void beforeClass() throws IOException, InterruptedException {\n \t\t// JMH does not correctly set JAVA_HOME. Change the JAVA_HOME below if you the following error:\n \t\t// [EmbeddedElsHandler] INFO p.a.t.e.ElasticServer - could not find java; set JAVA_HOME or ensure java is in\n \t\t// PATH\n-\t\tembeddedElastic = TestHelpers.startElasticsearch(installLocation,\n+\t\trunner = TestHelpers.startElasticsearch(installLocation,\n \t\t\t\t\"/Library/Java/JavaVirtualMachines/adoptopenjdk-8.jdk/Contents/Home\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f42da053484943f3419d116cd3c5321f60d5ec6"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjczMTIzMA==", "bodyText": "I'd be fine with marking this deprecated at least or even just getting rid of it - given that the java home is not something we can set anymore, and even if we could it's kind of a problematic hack anyway.", "url": "https://github.com/eclipse/rdf4j/pull/2406#discussion_r466731230", "createdAt": "2020-08-06T23:04:15Z", "author": {"login": "jeenbroekstra"}, "path": "core/sail/elasticsearch-store/src/test/java/org/eclipse/rdf4j/sail/elasticsearchstore/TestHelpers.java", "diffHunk": "@@ -9,72 +9,55 @@\n \n import java.io.File;\n import java.io.IOException;\n-import java.util.Random;\n+import java.net.URL;\n import java.util.concurrent.TimeUnit;\n \n import org.apache.commons.io.FileUtils;\n+import org.codelibs.elasticsearch.runner.ElasticsearchClusterRunner;\n+import org.elasticsearch.common.settings.Settings.Builder;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-import pl.allegro.tech.embeddedelasticsearch.EmbeddedElastic;\n-import pl.allegro.tech.embeddedelasticsearch.JavaHomeOption;\n-import pl.allegro.tech.embeddedelasticsearch.PopularProperties;\n-\n public class TestHelpers {\n-\n-\tprivate final static Random random = new Random();\n-\tpublic static final String VERSION = \"6.8.8\";\n \tpublic static final String CLUSTER = \"cluster1\";\n-\tpublic static final String ELASTICSEARCH_DOWNLOAD_DIRECTORY = \"tempElasticsearchDownload\";\n \n \tprivate static final Logger logger = LoggerFactory.getLogger(TestHelpers.class);\n \n-\tpublic static EmbeddedElastic startElasticsearch(File installLocation) throws IOException, InterruptedException {\n-\n-\t\tEmbeddedElastic embeddedElastic = EmbeddedElastic.builder()\n-\t\t\t\t.withElasticVersion(VERSION)\n-\t\t\t\t.withSetting(PopularProperties.TRANSPORT_TCP_PORT, random.nextInt(10000) + 10000)\n-\t\t\t\t.withSetting(PopularProperties.HTTP_PORT, random.nextInt(10000) + 10000)\n-\t\t\t\t.withSetting(PopularProperties.CLUSTER_NAME, \"cluster1\")\n-\t\t\t\t.withInstallationDirectory(installLocation)\n-\t\t\t\t.withDownloadDirectory(new File(\"tempElasticsearchDownload\"))\n-//\t\t\t.withPlugin(\"analysis-stempel\")\n-\t\t\t\t.withStartTimeout(5, TimeUnit.MINUTES)\n-\t\t\t\t.build();\n-\n-\t\tembeddedElastic.start();\n-\t\tlogger.info(\"Elasticearch using transport port: \" + embeddedElastic.getTransportTcpPort());\n-\t\tlogger.info(\"Elasticearch using http port: \" + embeddedElastic.getHttpPort());\n+\tpublic static ElasticsearchClusterRunner startElasticsearch(File installLocation)\n+\t\t\tthrows IOException, InterruptedException {\n \n-\t\treturn embeddedElastic;\n+\t\tElasticsearchClusterRunner runner = new ElasticsearchClusterRunner();\n+\t\trunner.onBuild(new ElasticsearchClusterRunner.Builder() {\n+\t\t\t@Override\n+\t\t\tpublic void build(int number, Builder settingsBuilder) {\n+\t\t\t\t// settingsBuilder.put(\"indices.breaker.total.limit\", \"1100m\");\n+\t\t\t}\n+\t\t});\n+\t\trunner.build(ElasticsearchClusterRunner.newConfigs()\n+\t\t\t\t.numOfNode(1)\n+\t\t\t\t.basePath(installLocation.toString())\n+\t\t\t\t.clusterName(CLUSTER));\n+\n+\t\trunner.ensureYellow();\n+\n+\t\treturn runner;\n \t}\n \n-\tpublic static void stopElasticsearch(EmbeddedElastic embeddedElastic, File installLocation) {\n-\t\tembeddedElastic.stop();\n+\tpublic static int getPort(ElasticsearchClusterRunner runner) {\n+\t\treturn runner.node().settings().getAsInt(\"transport.port\", 9300);\n+\t}\n \n+\tpublic static void stopElasticsearch(ElasticsearchClusterRunner runner) {\n \t\ttry {\n-\t\t\tFileUtils.deleteDirectory(installLocation);\n-\t\t} catch (IOException e) {\n-\t\t\tthrow new RuntimeException(e);\n+\t\t\trunner.close();\n+\t\t} catch (IOException ioe) {\n+\t\t\tlogger.error(\"Error closing ES cluster\", ioe);\n \t\t}\n+\t\trunner.clean();\n \t}\n \n-\tpublic static EmbeddedElastic startElasticsearch(File installLocation, String javaHomePath)\n+\tpublic static ElasticsearchClusterRunner startElasticsearch(File installLocation, String javaHomePath)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f42da053484943f3419d116cd3c5321f60d5ec6"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjczMTQwNw==", "bodyText": "Very nice. Happy we can upgrade to a more maintained embedded cluster setup.", "url": "https://github.com/eclipse/rdf4j/pull/2406#discussion_r466731407", "createdAt": "2020-08-06T23:04:47Z", "author": {"login": "jeenbroekstra"}, "path": "core/sail/elasticsearch-store/src/test/java/org/eclipse/rdf4j/sail/elasticsearchstore/TestHelpers.java", "diffHunk": "@@ -9,72 +9,55 @@\n \n import java.io.File;\n import java.io.IOException;\n-import java.util.Random;\n+import java.net.URL;\n import java.util.concurrent.TimeUnit;\n \n import org.apache.commons.io.FileUtils;\n+import org.codelibs.elasticsearch.runner.ElasticsearchClusterRunner;\n+import org.elasticsearch.common.settings.Settings.Builder;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-import pl.allegro.tech.embeddedelasticsearch.EmbeddedElastic;\n-import pl.allegro.tech.embeddedelasticsearch.JavaHomeOption;\n-import pl.allegro.tech.embeddedelasticsearch.PopularProperties;\n-\n public class TestHelpers {\n-\n-\tprivate final static Random random = new Random();\n-\tpublic static final String VERSION = \"6.8.8\";\n \tpublic static final String CLUSTER = \"cluster1\";\n-\tpublic static final String ELASTICSEARCH_DOWNLOAD_DIRECTORY = \"tempElasticsearchDownload\";\n \n \tprivate static final Logger logger = LoggerFactory.getLogger(TestHelpers.class);\n \n-\tpublic static EmbeddedElastic startElasticsearch(File installLocation) throws IOException, InterruptedException {\n-\n-\t\tEmbeddedElastic embeddedElastic = EmbeddedElastic.builder()\n-\t\t\t\t.withElasticVersion(VERSION)\n-\t\t\t\t.withSetting(PopularProperties.TRANSPORT_TCP_PORT, random.nextInt(10000) + 10000)\n-\t\t\t\t.withSetting(PopularProperties.HTTP_PORT, random.nextInt(10000) + 10000)\n-\t\t\t\t.withSetting(PopularProperties.CLUSTER_NAME, \"cluster1\")\n-\t\t\t\t.withInstallationDirectory(installLocation)\n-\t\t\t\t.withDownloadDirectory(new File(\"tempElasticsearchDownload\"))\n-//\t\t\t.withPlugin(\"analysis-stempel\")\n-\t\t\t\t.withStartTimeout(5, TimeUnit.MINUTES)\n-\t\t\t\t.build();\n-\n-\t\tembeddedElastic.start();\n-\t\tlogger.info(\"Elasticearch using transport port: \" + embeddedElastic.getTransportTcpPort());\n-\t\tlogger.info(\"Elasticearch using http port: \" + embeddedElastic.getHttpPort());\n+\tpublic static ElasticsearchClusterRunner startElasticsearch(File installLocation)\n+\t\t\tthrows IOException, InterruptedException {\n \n-\t\treturn embeddedElastic;\n+\t\tElasticsearchClusterRunner runner = new ElasticsearchClusterRunner();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f42da053484943f3419d116cd3c5321f60d5ec6"}, "originalPosition": 47}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzNzI3ODA1", "url": "https://github.com/eclipse/rdf4j/pull/2406#pullrequestreview-483727805", "createdAt": "2020-09-07T23:45:32Z", "commit": {"oid": "fce33932b8c970a640af833728786cc523b1bd55"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e8334914b2c3dfaf14dc126698e7b7b066943464", "author": {"user": {"login": "barthanssens", "name": "Bart Hanssens"}}, "url": "https://github.com/eclipse/rdf4j/commit/e8334914b2c3dfaf14dc126698e7b7b066943464", "committedDate": "2021-03-31T20:45:49Z", "message": "GH-2392 test cleaning\nSigned-off-by:Bart Hanssens <bart.hanssens@bosa.fgov.be>"}, "afterCommit": {"oid": "28023960044ebd5210bc4cd3e314dbad9a309cd1", "author": {"user": {"login": "barthanssens", "name": "Bart Hanssens"}}, "url": "https://github.com/eclipse/rdf4j/commit/28023960044ebd5210bc4cd3e314dbad9a309cd1", "committedDate": "2021-03-31T21:04:22Z", "message": "GH-2392 upgrade ES/Solr/Lucene dependencies + fix test\n\nSigned-off-by: Bart Hanssens <bart.hanssens@bosa.fgov.be>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "91769b84301938e485ca6784a87bce34ec0a782c", "author": {"user": {"login": "barthanssens", "name": "Bart Hanssens"}}, "url": "https://github.com/eclipse/rdf4j/commit/91769b84301938e485ca6784a87bce34ec0a782c", "committedDate": "2021-06-09T11:18:39Z", "message": "Revert \"GH-2392 upgrade lucene index when loading older version\"\n\nThis reverts commit 021b7b5e52c09acc09caf84e8ab27bcfca86f8d7."}, "afterCommit": {"oid": "04f1f4182350df755a8c9ed12615c27c75edbdcb", "author": {"user": {"login": "barthanssens", "name": "Bart Hanssens"}}, "url": "https://github.com/eclipse/rdf4j/commit/04f1f4182350df755a8c9ed12615c27c75edbdcb", "committedDate": "2021-06-09T11:26:06Z", "message": "GH-2392 upgrade ES/Solr/Lucene dependencies\n\nSigned-off-by: Bart Hanssens <bart.hanssens@bosa.fgov.be>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f5a86cfb869f3859e7f84cd74c1e0d53541ed6c", "author": {"user": {"login": "barthanssens", "name": "Bart Hanssens"}}, "url": "https://github.com/eclipse/rdf4j/commit/8f5a86cfb869f3859e7f84cd74c1e0d53541ed6c", "committedDate": "2021-06-22T10:35:58Z", "message": "GH-2392 upgrade ES/Solr/Lucene dependencies and use ES cluster runner for testing\n\nSigned-off-by: Bart Hanssens <bart.hanssens@bosa.fgov.be>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ddf2971fe996c7ebd121fcd46607345886e404ad", "author": {"user": {"login": "barthanssens", "name": "Bart Hanssens"}}, "url": "https://github.com/eclipse/rdf4j/commit/ddf2971fe996c7ebd121fcd46607345886e404ad", "committedDate": "2021-06-22T10:28:52Z", "message": "GH-2392: back to slightly older Lucene/Solr/ES\n\nSigned-off-by: Bart Hanssens <bart.hanssens@bosa.fgov.be>"}, "afterCommit": {"oid": "8f5a86cfb869f3859e7f84cd74c1e0d53541ed6c", "author": {"user": {"login": "barthanssens", "name": "Bart Hanssens"}}, "url": "https://github.com/eclipse/rdf4j/commit/8f5a86cfb869f3859e7f84cd74c1e0d53541ed6c", "committedDate": "2021-06-22T10:35:58Z", "message": "GH-2392 upgrade ES/Solr/Lucene dependencies and use ES cluster runner for testing\n\nSigned-off-by: Bart Hanssens <bart.hanssens@bosa.fgov.be>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjkzMzY3NTk0", "url": "https://github.com/eclipse/rdf4j/pull/2406#pullrequestreview-693367594", "createdAt": "2021-06-27T00:21:44Z", "commit": {"oid": "8f5a86cfb869f3859e7f84cd74c1e0d53541ed6c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 139, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}