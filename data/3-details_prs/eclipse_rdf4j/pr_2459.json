{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcyMDMzNTQ4", "number": 2459, "title": "GH-2458 sh:hasValue and dash:hasValueIn support as node shapes", "bodyText": "GitHub issue resolved: #2458  \nBriefly describe the changes proposed in this PR:\nMake sh:hasValue and dash:hasValueIn work when part of a sh:NodeShape. This fixes when they are used as part of a logical operator like sh:or.\n\nPR Author Checklist (see the contributor guidelines for more details):\n\n my pull request is self-contained\n I've added tests for the changes I made\n I've applied code formatting (you can use mvn process-resources to format from the command line)\n every commit message starts with the issue number (GH-xxxx) followed by a meaningful description of the change\n every commit has been signed off\n\nNote: we merge all feature pull requests using squash and merge. See RDF4J git merge strategy for more details.", "createdAt": "2020-08-22T19:58:06Z", "url": "https://github.com/eclipse/rdf4j/pull/2459", "merged": true, "mergeCommit": {"oid": "4d5f6ea41786132460b75dc3f1173e00a44788ae"}, "closed": true, "closedAt": "2020-09-14T12:55:35Z", "author": {"login": "hmottestad"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdBY0UxAH2gAyNDcyMDMzNTQ4OmIyODI2NGNkZTgzODBhMWIyYTcwNjRlYTE0OGVkOTBhN2Y0NzE0NDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdIowrUAFqTQ4NzM2MzY0MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b28264cde8380a1b2a7064ea148ed90a7f471442", "author": {"user": {"login": "hmottestad", "name": null}}, "url": "https://github.com/eclipse/rdf4j/commit/b28264cde8380a1b2a7064ea148ed90a7f471442", "committedDate": "2020-08-22T12:46:02Z", "message": "https://github.com/eclipse/rdf4j/issues/2458 initial test cases\n\nSigned-off-by: Ha\u030avard Ottestad <hmottestad@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "410b03551fe9bf887f0198e2b58e00bbb5af5c68", "author": {"user": {"login": "hmottestad", "name": null}}, "url": "https://github.com/eclipse/rdf4j/commit/410b03551fe9bf887f0198e2b58e00bbb5af5c68", "committedDate": "2020-08-22T13:07:35Z", "message": "more test cases\n\nSigned-off-by: Ha\u030avard Ottestad <hmottestad@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2d5acf8de6333b2a07205e13b2d62d0c92dc716", "author": {"user": {"login": "hmottestad", "name": null}}, "url": "https://github.com/eclipse/rdf4j/commit/d2d5acf8de6333b2a07205e13b2d62d0c92dc716", "committedDate": "2020-08-22T19:07:12Z", "message": "GH-2458 initial fix\n\nSigned-off-by: Ha\u030avard Ottestad <hmottestad@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7995ba0943e251ecb2a92773b2d0bff17dde61b5", "author": {"user": {"login": "hmottestad", "name": null}}, "url": "https://github.com/eclipse/rdf4j/commit/7995ba0943e251ecb2a92773b2d0bff17dde61b5", "committedDate": "2020-08-22T19:55:14Z", "message": "GH-2458 better fix\n\nSigned-off-by: Ha\u030avard Ottestad <hmottestad@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bdb330f6042a7626a49d6de9918df6c9aa3d3e1f", "author": {"user": {"login": "hmottestad", "name": null}}, "url": "https://github.com/eclipse/rdf4j/commit/bdb330f6042a7626a49d6de9918df6c9aa3d3e1f", "committedDate": "2020-08-29T12:17:05Z", "message": "more passing tests\n\nSigned-off-by: Ha\u030avard Ottestad <hmottestad@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf1b2372a41cc3d886c4c2adb5a07af53d80927b", "author": {"user": {"login": "hmottestad", "name": null}}, "url": "https://github.com/eclipse/rdf4j/commit/cf1b2372a41cc3d886c4c2adb5a07af53d80927b", "committedDate": "2020-08-29T13:51:42Z", "message": "GH-2458 all tests pass\n\nSigned-off-by: Ha\u030avard Ottestad <hmottestad@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4MjQ4MDU1", "url": "https://github.com/eclipse/rdf4j/pull/2459#pullrequestreview-478248055", "createdAt": "2020-08-31T00:07:20Z", "commit": {"oid": "cf1b2372a41cc3d886c4c2adb5a07af53d80927b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQwMDowNzoyMVrOHJmuzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQwMDoyMTozMFrOHJm1eQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTgzMzgwNQ==", "bodyText": "Please remove this class.", "url": "https://github.com/eclipse/rdf4j/pull/2459#discussion_r479833805", "createdAt": "2020-08-31T00:07:21Z", "author": {"login": "jeenbroekstra"}, "path": "core/sail/shacl/src/test/java/org/eclipse/rdf4j/sail/shacl/TempTest.java", "diffHunk": "@@ -500,4 +500,50 @@ private void add(SailRepositoryConnection connection, String data) throws IOExce\n \t\tconnection.commit();\n \t}\n \n+\t@Test()\n+\tpublic void temp() throws Throwable {\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf1b2372a41cc3d886c4c2adb5a07af53d80927b"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTgzNDk2Mg==", "bodyText": "I don't object to having a test for a corner case, but isn't this an odd use of dash:hasValueIn? I thought the point was to allow use of a list so you don't have to use an or constraint at all. In other words, isn't the above equivalent to just saying:\n sh:path ex:info;\n dash:hasValueIn (\"blue\" \"green\" \"red\");", "url": "https://github.com/eclipse/rdf4j/pull/2459#discussion_r479834962", "createdAt": "2020-08-31T00:16:56Z", "author": {"login": "jeenbroekstra"}, "path": "core/sail/shacl/src/test/resources/test-cases/hasValueIn/or/shacl.ttl", "diffHunk": "@@ -0,0 +1,16 @@\n+@base <http://example.com/ns> .\n+@prefix ex: <http://example.com/ns#> .\n+@prefix owl: <http://www.w3.org/2002/07/owl#> .\n+@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .\n+@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .\n+@prefix sh: <http://www.w3.org/ns/shacl#> .\n+@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .\n+@prefix dash: <http://datashapes.org/dash#>.\n+\n+ex:shape1\n+\ta sh:NodeShape ;\n+\tsh:targetClass ex:Person ;\n+\tsh:property [\n+\t\tsh:path ex:info ;\n+\t\tsh:or ([ dash:hasValueIn (\"blue\") ; ] [ dash:hasValueIn (\"green\") ; ] [ dash:hasValueIn (\"red\"); ]) ;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf1b2372a41cc3d886c4c2adb5a07af53d80927b"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTgzNTUxMw==", "bodyText": "what is VALUES_INJECTION_POINT?", "url": "https://github.com/eclipse/rdf4j/pull/2459#discussion_r479835513", "createdAt": "2020-08-31T00:21:30Z", "author": {"login": "jeenbroekstra"}, "path": "core/sail/shacl/src/main/java/org/eclipse/rdf4j/sail/shacl/AST/AndPropertyShape.java", "diffHunk": "@@ -227,15 +227,45 @@ public PlanNode getAllTargetsPlan(ConnectionsGroup connectionsGroup, boolean neg\n \n \t@Override\n \tpublic String buildSparqlValidNodes(String targetVar) {\n-\t\treturn and.stream()\n-\t\t\t\t.map(propertyShapes -> propertyShapes\n-\t\t\t\t\t\t.stream()\n-\t\t\t\t\t\t.map(propertyShape -> propertyShape.buildSparqlValidNodes(targetVar))\n-\t\t\t\t\t\t.reduce((a, b) -> a + \"\\n\" + b))\n-\t\t\t\t.filter(Optional::isPresent)\n-\t\t\t\t.map(Optional::get)\n-\t\t\t\t.reduce((a, b) -> a + \"\\n\" + b)\n-\t\t\t\t.orElse(\"\");\n+\n+\t\tif (hasOwnPath()) {\n+\t\t\t// within property shape\n+\t\t\tString objectVariable = \"?b\";\n+\t\t\tString pathQuery1 = getPath().getQuery(targetVar, objectVariable, null);\n+\n+\t\t\tString collect = and.stream()\n+\t\t\t\t\t.map(l -> l.stream()\n+\t\t\t\t\t\t\t.map(p -> p.buildSparqlValidNodes(objectVariable))\n+\t\t\t\t\t\t\t.reduce((a, b) -> a + \" && \" + b))\n+\t\t\t\t\t.filter(Optional::isPresent)\n+\t\t\t\t\t.map(Optional::get)\n+\t\t\t\t\t.collect(Collectors.joining(\" ) && ( \", \"( \",\n+\t\t\t\t\t\t\t\" )\"));\n+\n+\t\t\tString query = pathQuery1 + \"\\n FILTER (! EXISTS {\\n\" + pathQuery1.replaceAll(\"(?m)^\", \"\\t\")\n+\t\t\t\t\t+ \"\\n\\tFILTER(!(\" + collect + \"))\\n})\";\n+\n+\t\t\tString pathQuery2 = getPath().getQuery(targetVar, randomVariable(), null);\n+\n+\t\t\tquery = \"{\\n#VALUES_INJECTION_POINT#\\n \" + query.replaceAll(\"(?m)^\", \"\\t\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf1b2372a41cc3d886c4c2adb5a07af53d80927b"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwNjEzNjA2", "url": "https://github.com/eclipse/rdf4j/pull/2459#pullrequestreview-480613606", "createdAt": "2020-09-02T08:49:55Z", "commit": {"oid": "cf1b2372a41cc3d886c4c2adb5a07af53d80927b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwODo0OTo1NVrOHLlAVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwODo0OTo1NVrOHLlAVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkwMjY3Nw==", "bodyText": "Do we have an edge case when this may run multiple times, overriding the ?b object variable?", "url": "https://github.com/eclipse/rdf4j/pull/2459#discussion_r481902677", "createdAt": "2020-09-02T08:49:55Z", "author": {"login": "rdstn"}, "path": "core/sail/shacl/src/main/java/org/eclipse/rdf4j/sail/shacl/AST/AndPropertyShape.java", "diffHunk": "@@ -227,15 +227,45 @@ public PlanNode getAllTargetsPlan(ConnectionsGroup connectionsGroup, boolean neg\n \n \t@Override\n \tpublic String buildSparqlValidNodes(String targetVar) {\n-\t\treturn and.stream()\n-\t\t\t\t.map(propertyShapes -> propertyShapes\n-\t\t\t\t\t\t.stream()\n-\t\t\t\t\t\t.map(propertyShape -> propertyShape.buildSparqlValidNodes(targetVar))\n-\t\t\t\t\t\t.reduce((a, b) -> a + \"\\n\" + b))\n-\t\t\t\t.filter(Optional::isPresent)\n-\t\t\t\t.map(Optional::get)\n-\t\t\t\t.reduce((a, b) -> a + \"\\n\" + b)\n-\t\t\t\t.orElse(\"\");\n+\n+\t\tif (hasOwnPath()) {\n+\t\t\t// within property shape\n+\t\t\tString objectVariable = \"?b\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf1b2372a41cc3d886c4c2adb5a07af53d80927b"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9485374d1e12dcd5ec355c08c2bb3d6a97fc1e44", "author": {"user": {"login": "hmottestad", "name": null}}, "url": "https://github.com/eclipse/rdf4j/commit/9485374d1e12dcd5ec355c08c2bb3d6a97fc1e44", "committedDate": "2020-09-12T11:44:13Z", "message": "Merge branch 'master' into GH-2458-sh_or-sh_hasValue-scoping"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "216becfc1fd316a4d50c28c09a4b85a17935aaff", "author": {"user": {"login": "hmottestad", "name": null}}, "url": "https://github.com/eclipse/rdf4j/commit/216becfc1fd316a4d50c28c09a4b85a17935aaff", "committedDate": "2020-09-12T11:51:13Z", "message": "fixed based on review\n\nSigned-off-by: Ha\u030avard Ottestad <hmottestad@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d754f205629fb3ee073856bda9ed899f2047d178", "author": {"user": {"login": "hmottestad", "name": null}}, "url": "https://github.com/eclipse/rdf4j/commit/d754f205629fb3ee073856bda9ed899f2047d178", "committedDate": "2020-09-12T16:49:40Z", "message": "GH-2458 added some more test cases and fixed them\n\nSigned-off-by: Ha\u030avard Ottestad <hmottestad@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MzYzNjQx", "url": "https://github.com/eclipse/rdf4j/pull/2459#pullrequestreview-487363641", "createdAt": "2020-09-14T01:18:00Z", "commit": {"oid": "d754f205629fb3ee073856bda9ed899f2047d178"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 95, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}