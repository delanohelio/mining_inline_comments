{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU1MDg1Nzky", "number": 2378, "title": "GH-2377: fix LuceneSail#reindex() to create document for last resource", "bodyText": "GitHub issue resolved: #2377  \nWith the current algorithm the document for the last resource was never\npersisted. This is now change to explicitly persist the last document\nafter loop completion.\nBehavior is covered with a unit test\n\nPR Author Checklist (see the contributor guidelines for more details):\n\n[ x] my pull request is self-contained\n[x ] I've added tests for the changes I made\n[ x] I've applied code formatting (you can use mvn process-resources to format from the command line)\n[x ] every commit message starts with the issue number (GH-xxxx) followed by a meaningful description of the change\n[x ] every commit has been signed off\n\nNote: we merge all feature pull requests using squash and merge. See RDF4J git merge strategy for more details.", "createdAt": "2020-07-22T12:25:42Z", "url": "https://github.com/eclipse/rdf4j/pull/2378", "merged": true, "mergeCommit": {"oid": "c94b6bab07aea513861bf63dacaac345d27e3805"}, "closed": true, "closedAt": "2020-07-23T02:46:26Z", "author": {"login": "aschwarte10"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3Z656gH2gAyNDU1MDg1NzkyOjBlNjhhYjhhZDgzNmUzNzA1MGY2YjJlYmMzYTJhNzI1MDBlYzcwYTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc3lTb5AFqTQ1Mzc5MDMxNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0e68ab8ad836e37050f6b2ebc3a2a72500ec70a0", "author": {"user": {"login": "aschwarte10", "name": "Andreas Schwarte"}}, "url": "https://github.com/eclipse/rdf4j/commit/0e68ab8ad836e37050f6b2ebc3a2a72500ec70a0", "committedDate": "2020-07-22T12:23:53Z", "message": "GH-2377: fix LuceneSail#reindex() to create document for last resource\n\nWith the current algorithm the document for the last resource was never\npersisted. This is now change to explicitly persist the last document\nafter loop completion.\n\nBehavior is covered with a unit test\n\nSigned-off-by: Andreas Schwarte <aschwarte10@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76a6a30aff091de6fe548e34220c19348636cf37", "author": {"user": {"login": "aschwarte10", "name": "Andreas Schwarte"}}, "url": "https://github.com/eclipse/rdf4j/commit/76a6a30aff091de6fe548e34220c19348636cf37", "committedDate": "2020-07-22T19:39:27Z", "message": "GH-2377: move unit test to LuceneSailTest\n\nRe-indexing apparently does not work correctly for Solr Index, thus\nmoving it to LuceneSailTest\n\nSigned-off-by: Andreas Schwarte <aschwarte10@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzNjk4OTM1", "url": "https://github.com/eclipse/rdf4j/pull/2378#pullrequestreview-453698935", "createdAt": "2020-07-22T21:29:02Z", "commit": {"oid": "76a6a30aff091de6fe548e34220c19348636cf37"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQyMToyOTowM1rOG1054A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQyMToyOTowM1rOG1054A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA5NDQ5Ng==", "bodyText": "Just a a general note, the whole code above should actually be using a peeking iterator. It's iterating over all the statements in the database and grouping by subject. It's doing it in a streaming fashion, which makes me assume that the iterator it has against the database is sorted by subject (which would take a massive amount of memory!). And it needs to check the next statement to see if it's got a different subject so it can add all the statements it's gathered for that subject to the lucene index as a document. Is that correct?\nI'm not proposing that we need to actually rewrite the code.\nCould you check that !statements.empty() as well, so we don't add the last document twice?", "url": "https://github.com/eclipse/rdf4j/pull/2378#discussion_r459094496", "createdAt": "2020-07-22T21:29:03Z", "author": {"login": "hmottestad"}, "path": "core/sail/lucene-api/src/main/java/org/eclipse/rdf4j/sail/lucene/LuceneSail.java", "diffHunk": "@@ -551,6 +551,15 @@ public void shutDown() {\n \t\t\t\t\t\t}\n \t\t\t\t\t\tstatements.add(vf.createStatement(r, p, o, c));\n \t\t\t\t\t}\n+\n+\t\t\t\t\t// make sure to index statements for last resource\n+\t\t\t\t\tif (current != null) {\n+\t\t\t\t\t\tif (logger.isDebugEnabled()) {\n+\t\t\t\t\t\t\tlogger.debug(\"reindexing resource \" + current);\n+\t\t\t\t\t\t}\n+\t\t\t\t\t\t// commit\n+\t\t\t\t\t\tluceneIndex.addDocuments(current, statements);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76a6a30aff091de6fe548e34220c19348636cf37"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzNzAwMjcy", "url": "https://github.com/eclipse/rdf4j/pull/2378#pullrequestreview-453700272", "createdAt": "2020-07-22T21:31:19Z", "commit": {"oid": "76a6a30aff091de6fe548e34220c19348636cf37"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQyMTozMToyMFrOG10-MA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQyMTozMToyMFrOG10-MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA5NTYwMA==", "bodyText": "ps, explicit initialization is now optional", "url": "https://github.com/eclipse/rdf4j/pull/2378#discussion_r459095600", "createdAt": "2020-07-22T21:31:20Z", "author": {"login": "hmottestad"}, "path": "testsuites/lucene/src/main/java/org/eclipse/rdf4j/sail/lucene/AbstractLuceneSailTest.java", "diffHunk": "@@ -121,7 +121,7 @@ public void setUp() throws Exception {\n \n \t\t// create a Repository wrapping the LuceneSail\n \t\trepository = new SailRepository(sail);\n-\t\trepository.initialize();\n+\t\trepository.init();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76a6a30aff091de6fe548e34220c19348636cf37"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0808d0127940b8ac165410d1e5eb31dc22d3988", "author": {"user": {"login": "jeenbroekstra", "name": "Jeen Broekstra"}}, "url": "https://github.com/eclipse/rdf4j/commit/a0808d0127940b8ac165410d1e5eb31dc22d3988", "committedDate": "2020-07-23T01:36:43Z", "message": "GH-2377 avoid duplicate add by checking statements is empty"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzNzkwMzE3", "url": "https://github.com/eclipse/rdf4j/pull/2378#pullrequestreview-453790317", "createdAt": "2020-07-23T01:39:38Z", "commit": {"oid": "a0808d0127940b8ac165410d1e5eb31dc22d3988"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 135, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}