{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMwMjgwNjk2", "number": 2684, "title": "GH 2666 jetty federated fix", "bodyText": "GitHub issue resolved: #2666 \nBriefly describe the changes proposed in this PR:\n\nbump Jetty and HttpClient version\nadded custom retry handler to (only) retry stale connections, which became an issue for Jetty 9.4.24+\n(doesn't seem to occur that often, but is happening in federated tests)\n\nThere are different ways to solve this, but\n\nretries were explicitly disabled in #647 (including omnipotent requests)\nApache HttpClient offers the option to retry stale connections at RequestConfig level, but this method setStaleConnectionCheckEnabled has been deprecated\nanother HttpClient option is a ConnectionPool with a separate monitoring thread, but this seems to add more complexity and may need additional (sizing) configuration\n\n\nPR Author Checklist (see the contributor guidelines for more details):\n\n my pull request is self-contained\n I've added tests for the changes I made\n I've applied code formatting (you can use mvn process-resources to format from the command line)\n I've squashed my commits down to one or a few meaningful commits\n every commit message starts with the issue number (GH-xxxx) followed by a meaningful description of the change\n every commit has been signed off", "createdAt": "2020-12-01T12:51:39Z", "url": "https://github.com/eclipse/rdf4j/pull/2684", "merged": true, "mergeCommit": {"oid": "b0e99d792bd5c984ee653fffd04146a46d91feaa"}, "closed": true, "closedAt": "2020-12-03T11:44:56Z", "author": {"login": "barthanssens"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdiXBIpgFqTU0MzMxODk4Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdihDWNgBqjQwNjY4NjAxOTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMzE4OTg3", "url": "https://github.com/eclipse/rdf4j/pull/2684#pullrequestreview-543318987", "createdAt": "2020-12-02T23:18:37Z", "commit": {"oid": "c6131d381849b542d1ad9155049bbe9e8d86696c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMzoxODozOFrOH9yP_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMzoxODozOFrOH9yP_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDU0ODQ3OA==", "bodyText": "I haven't looked in detail, but is this thread-safe? If (potentially) not, perhaps slap a synchronized block on it to be sure?", "url": "https://github.com/eclipse/rdf4j/pull/2684#discussion_r534548478", "createdAt": "2020-12-02T23:18:38Z", "author": {"login": "jeenbroekstra"}, "path": "core/http/client/src/main/java/org/eclipse/rdf4j/http/client/SharedHttpClientSessionManager.java", "diffHunk": "@@ -57,6 +62,39 @@\n \n \tprivate final Map<SPARQLProtocolSession, Boolean> openSessions = new ConcurrentHashMap<>();\n \n+\tprivate static final HttpRequestRetryHandler retryHandlerStale = new RetryHandlerStale();\n+\n+\t/**\n+\t * Retry handler: closes stale connections and suggests to simply retry the HTTP request once. This seems to be\n+\t * necessary for Jetty 9.4.24+\n+\t * \n+\t * Other HTTP issues are considered to be more severe, so these requests are not retried.\n+\t */\n+\tprivate static class RetryHandlerStale implements HttpRequestRetryHandler {\n+\t\tprivate final Logger logger = LoggerFactory.getLogger(RetryHandlerStale.class);\n+\n+\t\t@Override\n+\t\tpublic boolean retryRequest(IOException ioe, int count, HttpContext context) {\n+\t\t\t// only try this once\n+\t\t\tif (count > 1) {\n+\t\t\t\treturn false;\n+\t\t\t}\n+\t\t\tHttpClientContext clientContext = HttpClientContext.adapt(context);\n+\t\t\tHttpConnection conn = clientContext.getConnection();\n+\n+\t\t\tif (conn.isStale()) {\n+\t\t\t\ttry {\n+\t\t\t\t\tlogger.warn(\"Closing stale connection\");\n+\t\t\t\t\tconn.close();\n+\t\t\t\t\treturn true;\n+\t\t\t\t} catch (IOException e) {\n+\t\t\t\t\tlogger.error(\"Error closing connection\", e);\n+\t\t\t\t}\n+\t\t\t}\n+\t\t\treturn false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c6131d381849b542d1ad9155049bbe9e8d86696c"}, "originalPosition": 58}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8704df257254e40811910c537a86b5cf0f4313ce", "author": {"user": {"login": "barthanssens", "name": "Bart Hanssens"}}, "url": "https://github.com/eclipse/rdf4j/commit/8704df257254e40811910c537a86b5cf0f4313ce", "committedDate": "2020-12-03T10:59:15Z", "message": "GH-2666 added custom retry handler and Jetty version bump in pom\nSigned-off-by:Bart Hanssens <bart.hanssens@bosa.fgov.be>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6576a5a4744e41f2602bf4b2b1f94206e9ebf09e", "author": {"user": {"login": "barthanssens", "name": "Bart Hanssens"}}, "url": "https://github.com/eclipse/rdf4j/commit/6576a5a4744e41f2602bf4b2b1f94206e9ebf09e", "committedDate": "2020-12-03T10:28:58Z", "message": "GH-2666 code formatting\nSigned-off-by:Bart Hanssens <bart.hanssens@bosa.fgov.be>"}, "afterCommit": {"oid": "8704df257254e40811910c537a86b5cf0f4313ce", "author": {"user": {"login": "barthanssens", "name": "Bart Hanssens"}}, "url": "https://github.com/eclipse/rdf4j/commit/8704df257254e40811910c537a86b5cf0f4313ce", "committedDate": "2020-12-03T10:59:15Z", "message": "GH-2666 added custom retry handler and Jetty version bump in pom\nSigned-off-by:Bart Hanssens <bart.hanssens@bosa.fgov.be>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 85, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}