{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk3MzMwMTcy", "number": 2058, "title": "GH-99 allow SailConnection to bypass Query Parser", "bodyText": "GitHub issue resolved: #99 \nBriefly describe the changes proposed in this PR:\n\nadds new method 'prepareQuery' to SailConnection that gets the raw\nquery string\nSailConnection can optionally pass back a custom implementation of\nTupleExpr. If this happens the SailRepository skips parsing the query\nand will just pass back in the custom TuplExpr when\nSailConnection.evaluate is called.\nby default the method does nothing (returns empty optional)", "createdAt": "2020-04-02T03:02:48Z", "url": "https://github.com/eclipse/rdf4j/pull/2058", "merged": true, "mergeCommit": {"oid": "b8632381c8add3589dfbea5a5524bec89c92987d"}, "closed": true, "closedAt": "2020-04-05T02:10:33Z", "author": {"login": "jeenbroekstra"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcTjaqzgH2gAyMzk3MzMwMTcyOmFjNDYwY2QyMGIzODFmYTEwYjIxMmEwYTllMzA2ODE3MzE0NzNkNjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcUTvaWgFqTM4NzY5MTExNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ac460cd20b381fa10b212a0a9e30681731473d66", "author": {"user": {"login": "jeenbroekstra", "name": "Jeen Broekstra"}}, "url": "https://github.com/eclipse/rdf4j/commit/ac460cd20b381fa10b212a0a9e30681731473d66", "committedDate": "2020-04-02T03:06:27Z", "message": "GH-99 allow SailConnection to bypass Query Parser\n\n- adds new method 'prepareQuery' to SailConnection that gets the raw\n  query string\n- SailConnection can optionally pass back a custom implementation of\n  TupleExpr. If this happens the SailRepository skips parsing the query\n  and will just pass back in the custom TuplExpr when\n  SailConnection.evaluate is called.\n- by default the method does nothing (returns empty optional)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "64cd50c16ff7c04975abcb7fa112f67b70ea04ac", "author": {"user": {"login": "jeenbroekstra", "name": "Jeen Broekstra"}}, "url": "https://github.com/eclipse/rdf4j/commit/64cd50c16ff7c04975abcb7fa112f67b70ea04ac", "committedDate": "2020-04-02T02:58:54Z", "message": "GH-99 allow SailConnection to bypass Query Parser\n\n- adds new method 'prepareQuery' to SailConnection that gets the raw\n  query string\n- SailConnection can optionally pass back a custom implementation of\n  TupleExpr. If this happens the SailRepository skips parsing the query\n  and will just pass back in the custom TuplExpr when\n  SailConnection.evaluate is called.\n- by default the method does nothing (returns empty optional)"}, "afterCommit": {"oid": "ac460cd20b381fa10b212a0a9e30681731473d66", "author": {"user": {"login": "jeenbroekstra", "name": "Jeen Broekstra"}}, "url": "https://github.com/eclipse/rdf4j/commit/ac460cd20b381fa10b212a0a9e30681731473d66", "committedDate": "2020-04-02T03:06:27Z", "message": "GH-99 allow SailConnection to bypass Query Parser\n\n- adds new method 'prepareQuery' to SailConnection that gets the raw\n  query string\n- SailConnection can optionally pass back a custom implementation of\n  TupleExpr. If this happens the SailRepository skips parsing the query\n  and will just pass back in the custom TuplExpr when\n  SailConnection.evaluate is called.\n- by default the method does nothing (returns empty optional)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3f2d05a1d8cfa25ccddd3a352621bcdf06c6b58", "author": {"user": {"login": "jeenbroekstra", "name": "Jeen Broekstra"}}, "url": "https://github.com/eclipse/rdf4j/commit/f3f2d05a1d8cfa25ccddd3a352621bcdf06c6b58", "committedDate": "2020-04-02T04:41:10Z", "message": "GH-99 pass query type into SailConnection for bypass\n\n- added new enum for different query types\n- adapted RepositoryConnection.prepareQuery to also use bypass if\npossible"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2MTA0MTcz", "url": "https://github.com/eclipse/rdf4j/pull/2058#pullrequestreview-386104173", "createdAt": "2020-04-02T04:45:07Z", "commit": {"oid": "f3f2d05a1d8cfa25ccddd3a352621bcdf06c6b58"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwNDo0NTowN1rOF_bGyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwNDo0NTowN1rOF_bGyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA0ODcxMw==", "bodyText": "Fwiw I still haven't come up with a decent convention for this kind of test naming. Using CamelCase just quickly becomes unreadable.", "url": "https://github.com/eclipse/rdf4j/pull/2058#discussion_r402048713", "createdAt": "2020-04-02T04:45:07Z", "author": {"login": "jeenbroekstra"}, "path": "core/repository/sail/src/test/java/org/eclipse/rdf4j/repository/sail/SailRepositoryConnectionTest.java", "diffHunk": "@@ -0,0 +1,149 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Eclipse RDF4J contributors.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Distribution License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/org/documents/edl-v10.php.\n+ *******************************************************************************/\n+package org.eclipse.rdf4j.repository.sail;\n+\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.anyBoolean;\n+import static org.mockito.ArgumentMatchers.eq;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+import java.util.Optional;\n+\n+import org.eclipse.rdf4j.common.iteration.EmptyIteration;\n+import org.eclipse.rdf4j.query.BooleanQuery;\n+import org.eclipse.rdf4j.query.GraphQuery;\n+import org.eclipse.rdf4j.query.Query;\n+import org.eclipse.rdf4j.query.TupleQuery;\n+import org.eclipse.rdf4j.query.algebra.TupleExpr;\n+import org.eclipse.rdf4j.sail.SailConnection;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+/**\n+ * Unit tests for {@link SailRepositoryConnection}\n+ * \n+ * @author Jeen Broekstra\n+ *\n+ */\n+public class SailRepositoryConnectionTest {\n+\n+\tprivate SailRepositoryConnection subject;\n+\tprivate SailConnection sailConnection;\n+\tprivate SailRepository sailRepository;\n+\n+\t@Before\n+\tpublic void setUp() throws Exception {\n+\t\tsailConnection = mock(SailConnection.class);\n+\t\tsailRepository = mock(SailRepository.class);\n+\n+\t\tsubject = new SailRepositoryConnection(sailRepository, sailConnection);\n+\t}\n+\n+\t@Test\n+\tpublic void testPrepareQuery_not_bypassed() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3f2d05a1d8cfa25ccddd3a352621bcdf06c6b58"}, "originalPosition": 50}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MDQyMzA1", "url": "https://github.com/eclipse/rdf4j/pull/2058#pullrequestreview-387042305", "createdAt": "2020-04-03T08:07:35Z", "commit": {"oid": "f3f2d05a1d8cfa25ccddd3a352621bcdf06c6b58"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwODowNzozNVrOGAJs7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwODowNzozNVrOGAJs7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjgxMjE0Mw==", "bodyText": "note to self: rename to QueryType for greater clarity.", "url": "https://github.com/eclipse/rdf4j/pull/2058#discussion_r402812143", "createdAt": "2020-04-03T08:07:35Z", "author": {"login": "jeenbroekstra"}, "path": "core/query/src/main/java/org/eclipse/rdf4j/query/Query.java", "diffHunk": "@@ -16,6 +16,17 @@\n  */\n public interface Query extends Operation {\n \n+\t/**\n+\t * The different types of queries that RDF4J recognizes: boolean queries, graph queries, and tuple queries.\n+\t * \n+\t * @since 3.2.0\n+\t */\n+\tpublic enum Type {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3f2d05a1d8cfa25ccddd3a352621bcdf06c6b58"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2MTUyNDA0", "url": "https://github.com/eclipse/rdf4j/pull/2058#pullrequestreview-386152404", "createdAt": "2020-04-02T07:00:28Z", "commit": {"oid": "f3f2d05a1d8cfa25ccddd3a352621bcdf06c6b58"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwNzowMDoyOFrOF_dvlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwODo1NToxM1rOGAMPqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA5MTkyNQ==", "bodyText": "Is this a general thing you would like to start doing?", "url": "https://github.com/eclipse/rdf4j/pull/2058#discussion_r402091925", "createdAt": "2020-04-02T07:00:28Z", "author": {"login": "hmottestad"}, "path": "core/query/src/main/java/org/eclipse/rdf4j/query/Query.java", "diffHunk": "@@ -16,6 +16,17 @@\n  */\n public interface Query extends Operation {\n \n+\t/**\n+\t * The different types of queries that RDF4J recognizes: boolean queries, graph queries, and tuple queries.\n+\t * \n+\t * @since 3.2.0", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3f2d05a1d8cfa25ccddd3a352621bcdf06c6b58"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjg0ODcxMw==", "bodyText": "Does this end up potentially parsing twice? Parsing queries is one of the slowest parts of the SHACL sail, so I think we should avoid parsing twice at all costs.", "url": "https://github.com/eclipse/rdf4j/pull/2058#discussion_r402848713", "createdAt": "2020-04-03T08:49:36Z", "author": {"login": "hmottestad"}, "path": "core/repository/sail/src/main/java/org/eclipse/rdf4j/repository/sail/SailRepositoryConnection.java", "diffHunk": "@@ -195,10 +199,23 @@ public SailQuery prepareQuery(QueryLanguage ql, String queryString, String baseU\n \t\tParsedQuery parsedQuery = QueryParserUtil.parseQuery(ql, queryString, baseURI);\n \n \t\tif (parsedQuery instanceof ParsedTupleQuery) {\n+\t\t\tOptional<TupleExpr> sailTupleExpr = sailConnection.prepareQuery(ql, Query.Type.TUPLE, queryString, baseURI);\n+\t\t\tif (sailTupleExpr.isPresent()) {\n+\t\t\t\tparsedQuery = new ParsedTupleQuery(queryString, sailTupleExpr.get());\n+\t\t\t}\n \t\t\treturn new SailTupleQuery((ParsedTupleQuery) parsedQuery, this);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3f2d05a1d8cfa25ccddd3a352621bcdf06c6b58"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjg1MzgwMw==", "bodyText": "This looks like it ends up parsing only once.  Thats good :)\nBtw. Optionals have some rather nice chaining potential in java 8.\n\t\tParsedTupleQuery parsedQuery = sailTupleExpr\n\t\t\t.map(expr -> new ParsedTupleQuery(queryString, expr))\n\t\t\t.orElse(QueryParserUtil.parseTupleQuery(ql, queryString, baseURI));", "url": "https://github.com/eclipse/rdf4j/pull/2058#discussion_r402853803", "createdAt": "2020-04-03T08:55:13Z", "author": {"login": "hmottestad"}, "path": "core/repository/sail/src/main/java/org/eclipse/rdf4j/repository/sail/SailRepositoryConnection.java", "diffHunk": "@@ -208,21 +225,30 @@ public SailQuery prepareQuery(QueryLanguage ql, String queryString, String baseU\n \t@Override\n \tpublic SailTupleQuery prepareTupleQuery(QueryLanguage ql, String queryString, String baseURI)\n \t\t\tthrows MalformedQueryException {\n-\t\tParsedTupleQuery parsedQuery = QueryParserUtil.parseTupleQuery(ql, queryString, baseURI);\n+\t\tOptional<TupleExpr> sailTupleExpr = sailConnection.prepareQuery(ql, Query.Type.TUPLE, queryString, baseURI);\n+\t\tParsedTupleQuery parsedQuery = sailTupleExpr.isPresent()\n+\t\t\t\t? new ParsedTupleQuery(queryString, sailTupleExpr.get())\n+\t\t\t\t: QueryParserUtil.parseTupleQuery(ql, queryString, baseURI);\n \t\treturn new SailTupleQuery(parsedQuery, this);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3f2d05a1d8cfa25ccddd3a352621bcdf06c6b58"}, "originalPosition": 67}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e41e207b392db5b791a49df2f81eb01cb0f5e61", "author": {"user": {"login": "jeenbroekstra", "name": "Jeen Broekstra"}}, "url": "https://github.com/eclipse/rdf4j/commit/1e41e207b392db5b791a49df2f81eb01cb0f5e61", "committedDate": "2020-04-04T02:46:43Z", "message": "GH-99 Improved explanation in Javadoc\n\n- also changed to use Optional.map to process sailTupleExpr"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3018cc4d740ba5464875743c853c57c54e412ae0", "author": {"user": {"login": "jeenbroekstra", "name": "Jeen Broekstra"}}, "url": "https://github.com/eclipse/rdf4j/commit/3018cc4d740ba5464875743c853c57c54e412ae0", "committedDate": "2020-04-04T02:59:45Z", "message": "GH-99 renamed enum to QueryType, added javadoc"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "52e34d742939800e03191eb13c907558ac10f050", "author": {"user": {"login": "jeenbroekstra", "name": "Jeen Broekstra"}}, "url": "https://github.com/eclipse/rdf4j/commit/52e34d742939800e03191eb13c907558ac10f050", "committedDate": "2020-04-04T02:54:25Z", "message": "GH-99 renamed enum to QueryType, added javadoc"}, "afterCommit": {"oid": "3018cc4d740ba5464875743c853c57c54e412ae0", "author": {"user": {"login": "jeenbroekstra", "name": "Jeen Broekstra"}}, "url": "https://github.com/eclipse/rdf4j/commit/3018cc4d740ba5464875743c853c57c54e412ae0", "committedDate": "2020-04-04T02:59:45Z", "message": "GH-99 renamed enum to QueryType, added javadoc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3NjkxMTE3", "url": "https://github.com/eclipse/rdf4j/pull/2058#pullrequestreview-387691117", "createdAt": "2020-04-04T11:24:33Z", "commit": {"oid": "3018cc4d740ba5464875743c853c57c54e412ae0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 22, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}