{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU0MTg3ODIy", "number": 2375, "title": "GH-2374 fix docker build", "bodyText": "GitHub issue resolved: #2374 \nBriefly describe the changes proposed in this PR:\n\n\nPR Author Checklist (see the contributor guidelines for more details):\n\n my pull request is self-contained\n I've added tests for the changes I made\n I've applied code formatting (you can use mvn process-resources to format from the command line)\n every commit message starts with the issue number (GH-xxxx) followed by a meaningful description of the change\n every commit has been signed off\n\nNote: we merge all feature pull requests using squash and merge. See RDF4J git merge strategy for more details.", "createdAt": "2020-07-21T06:41:26Z", "url": "https://github.com/eclipse/rdf4j/pull/2375", "merged": true, "mergeCommit": {"oid": "8478dfd96238152c74041ce34f0aa150307718a8"}, "closed": true, "closedAt": "2021-02-07T09:16:31Z", "author": {"login": "hmottestad"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3AaNugH2gAyNDU0MTg3ODIyOjQwNTRlM2I2YTExZjZiODlhYTNlNTZiNGQ2YjFhZjEyYTU4ZWVlZjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABd3tuqdAH2gAyNDU0MTg3ODIyOjk4ZDU4YmQzZWY2YjNkNTc5YjE1NjcwYTI0ODQ1ZmRjNjUzNzY1YWU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4054e3b6a11f6b89aa3e56b4d6b1af12a58eeef3", "author": {"user": {"login": "hmottestad", "name": null}}, "url": "https://github.com/eclipse/rdf4j/commit/4054e3b6a11f6b89aa3e56b4d6b1af12a58eeef3", "committedDate": "2020-07-21T06:40:33Z", "message": "GH-2374 fix docker build\n\nSigned-off-by: Ha\u030avard Ottestad <hmottestad@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyMzQzMzE3", "url": "https://github.com/eclipse/rdf4j/pull/2375#pullrequestreview-452343317", "createdAt": "2020-07-21T10:54:45Z", "commit": {"oid": "4054e3b6a11f6b89aa3e56b4d6b1af12a58eeef3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxMDo1NDo0NVrOG0yrig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxMDo1NDo0NVrOG0yrig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODAwOTQ4Mg==", "bodyText": "IIRC, each RUN will add a layer, which will increase the size of the docker image (hence the '&&' hack, especially for not increasing the image size with unzipped files etc that will be eventually removed).\nPerhaps the \"new\" docker multistage build feature https://docs.docker.com/develop/develop-images/multistage-build/ would be a better approach ?", "url": "https://github.com/eclipse/rdf4j/pull/2375#discussion_r458009482", "createdAt": "2020-07-21T10:54:45Z", "author": {"login": "barthanssens"}, "path": "assembly/src/main/dist/docker/Dockerfile.amd64", "diffHunk": "@@ -1,30 +1,32 @@\n FROM amd64/tomcat:8.5-jre8-alpine\n MAINTAINER Bart Hanssens (bart.hanssens@bosa.fgov.be)\n \n-ARG VERSION=\"2.5.1\"\n-\n ENV JAVA_OPTS=\"-Xmx2g\"\n ENV CATALINA_OPTS=\"-Dorg.eclipse.rdf4j.appdata.basedir=/var/rdf4j\"\n \n-RUN adduser -S tomcat \n+RUN adduser -S tomcat\n+\n+COPY ignore/rdf4j.zip /tmp/rdf4j.zip\n+\n+WORKDIR /tmp\n \n-RUN cd /tmp && \\\n-\twget -q \"https://www.eclipse.org/downloads/download.php?file=/rdf4j/eclipse-rdf4j-${VERSION}-sdk.zip&r=1\" -O /tmp/rdf4j.zip && \\\n-\tunzip -q /tmp/rdf4j.zip && \\\n-\trm -rf /usr/local/tomcat/webapps/* && \\\n-\tcp /tmp/eclipse-rdf4j-${VERSION}/war/*.war /usr/local/tomcat/webapps && \\\n-\trm -rf /tmp/eclipse && \\\n-\trm /tmp/rdf4j.zip && \\\n-\tmkdir -p /var/rdf4j && \\\n-\tchown -R tomcat /var/rdf4j /usr/local/tomcat && \\\n-\tchmod a+x /usr/local/tomcat /usr/local/tomcat/bin /usr/local/tomcat/bin/catalina.sh\n+RUN\tunzip -q /tmp/rdf4j.zip", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4054e3b6a11f6b89aa3e56b4d6b1af12a58eeef3"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3Njk2NjAz", "url": "https://github.com/eclipse/rdf4j/pull/2375#pullrequestreview-527696603", "createdAt": "2020-11-10T23:43:28Z", "commit": {"oid": "4054e3b6a11f6b89aa3e56b4d6b1af12a58eeef3"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQyMzo0MzoyOFrOHwz93g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQyMzo0Nzo1NlrOHw0EAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk0NTExOA==", "bodyText": "Like I also mentioned on the mailinglist: I may end up pulling this change out into a separate PR because it is blocking me from using this script.", "url": "https://github.com/eclipse/rdf4j/pull/2375#discussion_r520945118", "createdAt": "2020-11-10T23:43:28Z", "author": {"login": "jeenbroekstra"}, "path": "assembly/src/main/dist/docker/build.sh", "diffHunk": "@@ -14,10 +14,10 @@ rm -rf ../../../../target/\n \n # go to root of project and do clean, format, install and assembly\n cd ../../../../..\n-MVN_VERSION=$(mvn -q -Dexec.executable=echo -Dexec.args='${project.version}' --non-recursive exec:exec)\n+MVN_VERSION=$(xmllint --xpath \"//*[local-name()='project']/*[local-name()='version']/text()\" pom.xml)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4054e3b6a11f6b89aa3e56b4d6b1af12a58eeef3"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk0NTYyNg==", "bodyText": "I'm not entirely sure why but this command failed for me on the first run, reporting that it couldn't find the rdf4j-workbench.war (as part of the assembly process). On a second run (after removing the -T 2) it succeeded, but I'm not sure if that is because I removed the parallel execution flag or because I just ran it a second time.", "url": "https://github.com/eclipse/rdf4j/pull/2375#discussion_r520945626", "createdAt": "2020-11-10T23:44:52Z", "author": {"login": "jeenbroekstra"}, "path": "assembly/src/main/dist/docker/build.sh", "diffHunk": "@@ -14,10 +14,10 @@ rm -rf ../../../../target/\n \n # go to root of project and do clean, format, install and assembly\n cd ../../../../..\n-MVN_VERSION=$(mvn -q -Dexec.executable=echo -Dexec.args='${project.version}' --non-recursive exec:exec)\n+MVN_VERSION=$(xmllint --xpath \"//*[local-name()='project']/*[local-name()='version']/text()\" pom.xml)\n+\n mvn clean\n-mvn formatter:format\n-mvn -Passembly install -DskipTests\n+mvn -T 2 -Passembly install -DskipTests -Dmaven.javadoc.skip=true -Dmaven.test.skip=true -Dformatter.skip=true -Dimpsort.skip=true -Dxml-format.skip=true  -Djapicmp.skip -Denforcer.skip=true -Dbuildnumber.plugin.phase=none -Danimal.sniffer.skip=true", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4054e3b6a11f6b89aa3e56b4d6b1af12a58eeef3"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk0NjY5MQ==", "bodyText": "I'm a little lost on what this script produces. Clearly, the end result of this will be a locally tagged docker image using just the version, so, e.g., eclipse/rdf4j-workbench:3.4.4. So where and how do we produce the different images for the ARM and AMD architectures, and how are they pushed to dockerhub?", "url": "https://github.com/eclipse/rdf4j/pull/2375#discussion_r520946691", "createdAt": "2020-11-10T23:47:56Z", "author": {"login": "jeenbroekstra"}, "path": "assembly/src/main/dist/docker/build.sh", "diffHunk": "@@ -30,4 +30,4 @@ cp $ZIP ./ignore/rdf4j.zip\n # build\n docker-compose build\n \n-docker tag docker_rdf4j:latest eclipse/rdf4j-workbench:${MVN_VERSION}\n\\ No newline at end of file\n+docker tag docker_rdf4j:latest eclipse/rdf4j-workbench:${MVN_VERSION}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4054e3b6a11f6b89aa3e56b4d6b1af12a58eeef3"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4f6e2cb9d840c668ba324bd3dd285a1f098f2a2", "author": {"user": {"login": "hmottestad", "name": null}}, "url": "https://github.com/eclipse/rdf4j/commit/e4f6e2cb9d840c668ba324bd3dd285a1f098f2a2", "committedDate": "2021-02-07T07:10:09Z", "message": "GH-2374 fixes based on review\n\nSigned-off-by: Ha\u030avard Ottestad <hmottestad@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a056d9bff559f56e24e2defe8754172d0db9a3f3", "author": {"user": {"login": "hmottestad", "name": null}}, "url": "https://github.com/eclipse/rdf4j/commit/a056d9bff559f56e24e2defe8754172d0db9a3f3", "committedDate": "2021-02-07T07:10:40Z", "message": "Merge branch 'develop' into GH-2374-docker"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98d58bd3ef6b3d579b15670a24845fdc653765ae", "author": {"user": {"login": "hmottestad", "name": null}}, "url": "https://github.com/eclipse/rdf4j/commit/98d58bd3ef6b3d579b15670a24845fdc653765ae", "committedDate": "2021-02-07T07:39:46Z", "message": "GH-2374 fix minor issues with the build script\n\nSigned-off-by: Ha\u030avard Ottestad <hmottestad@gmail.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 134, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}