{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEwMTI2ODQ3", "number": 2146, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQwNzowMDoxNVrOD43uRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQwNzowMDoxNVrOD43uRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwOTU5ODEzOnYy", "diffSide": "RIGHT", "path": "tools/federation/src/main/java/org/eclipse/rdf4j/federated/FederationManager.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQwNzowMDoxNVrOGP0jfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQyMjo1NjoyMFrOGQVHIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTI0Mjg3OA==", "bodyText": "@aschwarte10 I could use your eyes on this problem. FedX is currently designed to instantiate the EvaluationStrategy once (unless the config changes). But in RDF4J Sails, it is generally assumed that each query gets its own EvaluationStategy - that is why the Dataset object is passed in on the constructor. I believe that this has caused some of the named graph queries to fail on FedX (basically because we don't pass the dataset along). I'd like to hear your opinion on the best way forward: can we just remove the assumption that the strategy is defined once and let FedX instantiate a new strategy for each query?\nI'm a little wary of doing something like just setting/overwriting the Dataset  assigned to the strategy on each query, as I'm not sure what the consequences would be in a multithreaded environment.", "url": "https://github.com/eclipse/rdf4j/pull/2146#discussion_r419242878", "createdAt": "2020-05-04T07:00:15Z", "author": {"login": "jeenbroekstra"}, "path": "tools/federation/src/main/java/org/eclipse/rdf4j/federated/FederationManager.java", "diffHunk": "@@ -332,7 +342,10 @@ public void updateStrategy() {\n \t\t}\n \n \t\tif (updated) {\n-\t\t\tstrategy = FederationEvaluationStrategyFactory.getEvaluationStrategy(type, federationContext);\n+\t\t\t// TODO problem here: we need to (optionally) inject a Dataset object into the EvaluationStrategy, which is\n+\t\t\t// query-specific and determines what parts of the store are relevant for the query. However this part of\n+\t\t\t// the code assumes that we can instantiate an EvaluationStrategy once and then reuse it for each query.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "498297b31e0a348cba7898da0a25c9e3678b63ef"}, "originalPosition": 101}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTQxNTM2MQ==", "bodyText": "Hmm, I see. I wasn't aware of this assumption when initially implementing FedX.\nGenerally, I do not see a bigger problem in instantiating the strategy for each query (except for the amount of objects). However, quickly scanning the code and the references to where the strategy is passed around, such a change would be a huge refactoring.\nI am not sure if at this time right before the release it is such a good idea to do this refactoring. If at all, I would suggest to do it outside of this PR to have a cleaner and easier change.\nHowever, I think we can cope without it: the query specific QueryInfo object always has a reference to the externally passed Dataset. And this QueryInfo is available basically everywhere at evaluation time. This also how all the other named graph queries are working.\nLet's synch offline on this and come to the best conclusion.\nNote: I will probably re-order your last commit on top (i.e. a force-push), to have some other must changes integrated. The we have the possibility to decide on this special thing", "url": "https://github.com/eclipse/rdf4j/pull/2146#discussion_r419415361", "createdAt": "2020-05-04T12:57:34Z", "author": {"login": "aschwarte10"}, "path": "tools/federation/src/main/java/org/eclipse/rdf4j/federated/FederationManager.java", "diffHunk": "@@ -332,7 +342,10 @@ public void updateStrategy() {\n \t\t}\n \n \t\tif (updated) {\n-\t\t\tstrategy = FederationEvaluationStrategyFactory.getEvaluationStrategy(type, federationContext);\n+\t\t\t// TODO problem here: we need to (optionally) inject a Dataset object into the EvaluationStrategy, which is\n+\t\t\t// query-specific and determines what parts of the store are relevant for the query. However this part of\n+\t\t\t// the code assumes that we can instantiate an EvaluationStrategy once and then reuse it for each query.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTI0Mjg3OA=="}, "originalCommit": {"oid": "498297b31e0a348cba7898da0a25c9e3678b63ef"}, "originalPosition": 101}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc3NjI5MQ==", "bodyText": "I agree a full refactoring is out of scope (and fwiw, the assumption I'm talking about isn't particularly well documented or obvious, so not blaming your design here). I may have an idea for a quick workaround fix. If I can get that to work I'll push it, otherwise I'll revert the WIP changes I made and log this as a known bug.", "url": "https://github.com/eclipse/rdf4j/pull/2146#discussion_r419776291", "createdAt": "2020-05-04T22:56:20Z", "author": {"login": "jeenbroekstra"}, "path": "tools/federation/src/main/java/org/eclipse/rdf4j/federated/FederationManager.java", "diffHunk": "@@ -332,7 +342,10 @@ public void updateStrategy() {\n \t\t}\n \n \t\tif (updated) {\n-\t\t\tstrategy = FederationEvaluationStrategyFactory.getEvaluationStrategy(type, federationContext);\n+\t\t\t// TODO problem here: we need to (optionally) inject a Dataset object into the EvaluationStrategy, which is\n+\t\t\t// query-specific and determines what parts of the store are relevant for the query. However this part of\n+\t\t\t// the code assumes that we can instantiate an EvaluationStrategy once and then reuse it for each query.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTI0Mjg3OA=="}, "originalCommit": {"oid": "498297b31e0a348cba7898da0a25c9e3678b63ef"}, "originalPosition": 101}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1467, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}