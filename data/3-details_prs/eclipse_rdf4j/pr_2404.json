{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU4NjM5ODQ2", "number": 2404, "title": "GH-2324 inlining blank nodes", "bodyText": "GitHub issue resolved: #2324 \nBriefly describe the changes proposed in this PR:\n\n\nPR Author Checklist (see the contributor guidelines for more details):\n\n my pull request is self-contained\n I've added tests for the changes I made\n I've applied code formatting (you can use mvn process-resources to format from the command line)\n every commit message starts with the issue number (GH-xxxx) followed by a meaningful description of the change\n every commit has been signed off\n\nNote: we merge all feature pull requests using squash and merge. See RDF4J git merge strategy for more details.", "createdAt": "2020-07-29T19:29:43Z", "url": "https://github.com/eclipse/rdf4j/pull/2404", "merged": true, "mergeCommit": {"oid": "d7b51c198c0d07361a7f1899d82b27fe0fc83ae2"}, "closed": true, "closedAt": "2020-07-30T09:36:20Z", "author": {"login": "hmottestad"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5wYpoAH2gAyNDU4NjM5ODQ2OjljODc4MGYzYmZmZTFlNjI3NjI1ZjFlZDk5NDU2YmY5Y2I3ZDc0NDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc58TlwAFqTQ1ODI0MjMwOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9c8780f3bffe1e627625f1ed99456bf9cb7d7441", "author": {"user": {"login": "hmottestad", "name": null}}, "url": "https://github.com/eclipse/rdf4j/commit/9c8780f3bffe1e627625f1ed99456bf9cb7d7441", "committedDate": "2020-07-29T19:42:08Z", "message": "GH-2324 handle inlining issue\n\nSigned-off-by: Ha\u030avard Ottestad <hmottestad@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ce49301cab13c0c07ebd297bc9103abd27d2a1f0", "author": {"user": {"login": "hmottestad", "name": null}}, "url": "https://github.com/eclipse/rdf4j/commit/ce49301cab13c0c07ebd297bc9103abd27d2a1f0", "committedDate": "2020-07-29T19:28:38Z", "message": "GH-2324 handle inlining issue\n\nSigned-off-by: Ha\u030avard Ottestad <hmottestad@gmail.com>"}, "afterCommit": {"oid": "9c8780f3bffe1e627625f1ed99456bf9cb7d7441", "author": {"user": {"login": "hmottestad", "name": null}}, "url": "https://github.com/eclipse/rdf4j/commit/9c8780f3bffe1e627625f1ed99456bf9cb7d7441", "committedDate": "2020-07-29T19:42:08Z", "message": "GH-2324 handle inlining issue\n\nSigned-off-by: Ha\u030avard Ottestad <hmottestad@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c48787f21aa64041cd04d4a9c7b95ff8860c57b5", "author": {"user": {"login": "hmottestad", "name": null}}, "url": "https://github.com/eclipse/rdf4j/commit/c48787f21aa64041cd04d4a9c7b95ff8860c57b5", "committedDate": "2020-07-29T23:35:24Z", "message": "cleaned up the code a bit and optimized the process for deciding if a node should be inlined or not\n\nSigned-off-by: Ha\u030avard Ottestad <hmottestad@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3OTk1NzQ0", "url": "https://github.com/eclipse/rdf4j/pull/2404#pullrequestreview-457995744", "createdAt": "2020-07-30T01:03:57Z", "commit": {"oid": "c48787f21aa64041cd04d4a9c7b95ff8860c57b5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwMTowMzo1N1rOG5PYqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwMTowMzo1N1rOG5PYqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY3NDA4OA==", "bodyText": "Shouldn't you check if the subject is a blank node before adding it?", "url": "https://github.com/eclipse/rdf4j/pull/2404#discussion_r462674088", "createdAt": "2020-07-30T01:03:57Z", "author": {"login": "jeenbroekstra"}, "path": "core/rio/turtle/src/main/java/org/eclipse/rdf4j/rio/turtle/ArrangedWriter.java", "diffHunk": "@@ -293,58 +299,74 @@ private boolean isStillReferenced(SubjectInContext key) {\n \n \tprivate synchronized void queueStatement(Statement st) {\n \t\tSubjectInContext key = new SubjectInContext(st);\n-\t\tSet<Statement> stmts = stmtBySubject.get(key);\n+\t\tSet<Statement> stmts = statementBySubject.get(key);\n \t\tif (stmts == null && st.getSubject() instanceof BNode && !stack.contains(key)) {\n \t\t\tblanks.add(st);\n \t\t} else {\n \t\t\tif (stmts == null) {\n-\t\t\t\tstmtBySubject.put(key, stmts = new TreeSet<>(comparator));\n+\t\t\t\tstatementBySubject.put(key, stmts = new TreeSet<>(comparator));\n \t\t\t}\n \t\t\tstmts.add(st);\n \t\t}\n \t\tqueueSize++;\n \t}\n \n \tprivate synchronized void flushStatements() throws RDFHandlerException {\n-\t\tif (!stmtBySubject.isEmpty() || !blanks.isEmpty()) {\n+\t\tif (!statementBySubject.isEmpty() || !blanks.isEmpty()) {\n \t\t\tflushNamespaces();\n-\t\t\tStatement st;\n \n \t\t\t// used to store all the statements\n-\t\t\tArrayList<Statement> statements = new ArrayList<Statement>();\n+\t\t\tArrayList<Statement> statements = new ArrayList<>();\n \n \t\t\t// used to store blank nodes along with the number of times they are used as an object in a statement.\n-\t\t\tMap<BNode, Integer> bNodeOccurence = new HashMap<BNode, Integer>();\n+\t\t\tMap<BNode, Integer> bNodeOccurrences = new HashMap<>();\n \n+\t\t\tStatement st;\n \t\t\twhile ((st = nextStatement()) != null) {\n \t\t\t\tstatements.add(st);\n+\n \t\t\t\tValue obj = st.getObject();\n \n-\t\t\t\t// if the object in the statement is a blank node, we will update its number of occurence\n+\t\t\t\t// if the object in the statement is a blank node, we will update its number of occurrences\n \t\t\t\tif (obj instanceof BNode) {\n-\t\t\t\t\tBNode bNode = (BNode) obj;\n-\t\t\t\t\tif (!bNodeOccurence.containsKey(bNode)) {\n-\t\t\t\t\t\tbNodeOccurence.put(bNode, 0);\n+\t\t\t\t\tbNodeOccurrences.compute(\n+\t\t\t\t\t\t\t(BNode) obj,\n+\t\t\t\t\t\t\t(key, i) -> i == null ? 1 : i + 1\n+\t\t\t\t\t);\n+\n+\t\t\t\t\tif (bNodeOccurrences.get(obj) > 1) {\n+\t\t\t\t\t\tnoneInlinedNodes.add(st.getSubject());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c48787f21aa64041cd04d4a9c7b95ff8860c57b5"}, "originalPosition": 151}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4491450df5f0311b0e6b80f8239a8059fca99d46", "author": {"user": {"login": "jeenbroekstra", "name": "Jeen Broekstra"}}, "url": "https://github.com/eclipse/rdf4j/commit/4491450df5f0311b0e6b80f8239a8059fca99d46", "committedDate": "2020-07-30T04:54:53Z", "message": "GH-2324 only register nodes if they are blank nodes\n\n- fixes corner case in ArrangedWriterTest"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4MjQyMzA4", "url": "https://github.com/eclipse/rdf4j/pull/2404#pullrequestreview-458242308", "createdAt": "2020-07-30T09:35:28Z", "commit": {"oid": "4491450df5f0311b0e6b80f8239a8059fca99d46"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 138, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}