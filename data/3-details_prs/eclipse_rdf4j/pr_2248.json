{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIxMDA4MzI4", "number": 2248, "title": "GH-399 detect invalid INSERT/DELETE on parse", "bodyText": "GitHub issue resolved: #399\nBriefly describe the changes proposed in this PR:\nAdded code for detecting invalid queries for both the insert and delete data expressions in prepareUpdate function. Also added test cases to check that RDFParseException is thrown in both cases.\n\nPR Author Checklist:\n\n my pull request is self-contained\n I've added tests for the changes I made\n every commit message starts with the issue number (GH-399) followed by a meaningful description of the change\n every commit has been signed off\n\nNote: we merge all feature pull requests using squash and merge. See RDF4J git merge strategy for more details.", "createdAt": "2020-05-20T20:41:02Z", "url": "https://github.com/eclipse/rdf4j/pull/2248", "merged": true, "mergeCommit": {"oid": "b30eb571b0e6edfbb96c70fe53156d411c66b0e0"}, "closed": true, "closedAt": "2020-05-26T07:12:02Z", "author": {"login": "ishaanbassi"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcjO_t_AH2gAyNDIxMDA4MzI4OjY1YzZhNWJmNzk1MzYzNmY2Yzc0NDI5M2M2YjQ0NTZiYWFkYzI0ZTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABckv8GEAFqTQxNzcwNTMzOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "65c6a5bf7953636f6c744293c6b4456baadc24e9", "author": {"user": {"login": "ishaanbassi", "name": "Ishaan Bassi"}}, "url": "https://github.com/eclipse/rdf4j/commit/65c6a5bf7953636f6c744293c6b4456baadc24e9", "committedDate": "2020-05-20T20:21:42Z", "message": "GH-399 Added code and test for insert query validation\n\nSigned-off-by: ishaanbassi <ishaan16238@iiitd.ac.in>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c1faaf6624e70620b7b2799814168db24f38cfd", "author": {"user": {"login": "abhishekag03", "name": "Abhishek Agarwal"}}, "url": "https://github.com/eclipse/rdf4j/commit/9c1faaf6624e70620b7b2799814168db24f38cfd", "committedDate": "2020-05-20T20:25:01Z", "message": "GH-399 Added Delete query validation code\n\nSigned-off-by: abhishekag03 <abhishek16126@iiitd.ac.in>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77ad791d1227a5c78671faab2ab78cb629c9cb2a", "author": {"user": {"login": "Kvatsx", "name": "Kaustav Vats"}}, "url": "https://github.com/eclipse/rdf4j/commit/77ad791d1227a5c78671faab2ab78cb629c9cb2a", "committedDate": "2020-05-20T20:35:18Z", "message": "GH-399 Added invalid delete query testcase\n\nSigned-off-by: kaustavvats <kaustav16048@iiitd.ac.in>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2dedcedda0b4197103c1480669636126697acb33", "author": {"user": {"login": "Kvatsx", "name": "Kaustav Vats"}}, "url": "https://github.com/eclipse/rdf4j/commit/2dedcedda0b4197103c1480669636126697acb33", "committedDate": "2020-05-20T20:38:14Z", "message": "GH-399 Added invalid delete query testcase\n\nSigned-off-by: kaustavvats <kaustav16048@iiitd.ac.in>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ebd48ad054f9952cd147b187b3f6298480de1818", "author": {"user": {"login": "Kvatsx", "name": "Kaustav Vats"}}, "url": "https://github.com/eclipse/rdf4j/commit/ebd48ad054f9952cd147b187b3f6298480de1818", "committedDate": "2020-05-20T20:46:25Z", "message": "GH-399 fixed formatting\n\nSigned-off-by: kaustavvats <kaustav16048@iiitd.ac.in>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1NzU4ODA1", "url": "https://github.com/eclipse/rdf4j/pull/2248#pullrequestreview-415758805", "createdAt": "2020-05-20T22:29:12Z", "commit": {"oid": "ebd48ad054f9952cd147b187b3f6298480de1818"}, "state": "COMMENTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMjoyOToxMlrOGYgDJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMzowMjoyNlrOGYgv-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM0NDEwMQ==", "bodyText": "It shouldn't be necessary to extend TestCase - we use JUnit 4, and TestCase is a JUnit 3 thing.", "url": "https://github.com/eclipse/rdf4j/pull/2248#discussion_r428344101", "createdAt": "2020-05-20T22:29:12Z", "author": {"login": "jeenbroekstra"}, "path": "compliance/repository/src/test/java/org/eclipse/rdf4j/repository/sparql/SPARQLRepositorySparqlUpdateTest.java", "diffHunk": "@@ -52,3 +64,42 @@\n //\t\tSystem.err.println(\"temporarily disabled testAutoCommitHandling() for HTTPRepository\");\n //\t}\n //}\n+public class SPARQLRepositorySparqlUpdateTest extends TestCase {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebd48ad054f9952cd147b187b3f6298480de1818"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM0NjgzNA==", "bodyText": "This exception should be wrapped and rethrown, probably in a MalformedQueryException. Also, I think you should catch RDFParseException and rethrow it wrapped in a MalformedQueryException.", "url": "https://github.com/eclipse/rdf4j/pull/2248#discussion_r428346834", "createdAt": "2020-05-20T22:36:56Z", "author": {"login": "jeenbroekstra"}, "path": "core/repository/sail/src/main/java/org/eclipse/rdf4j/repository/sail/SailRepositoryConnection.java", "diffHunk": "@@ -262,7 +269,22 @@ public SailBooleanQuery prepareBooleanQuery(QueryLanguage ql, String queryString\n \tpublic Update prepareUpdate(QueryLanguage ql, String update, String baseURI)\n \t\t\tthrows RepositoryException, MalformedQueryException {\n \t\tParsedUpdate parsedUpdate = QueryParserUtil.parseUpdate(ql, update, baseURI);\n+\t\tList<UpdateExpr> updateExprs = parsedUpdate.getUpdateExprs();\n+\t\tSPARQLUpdateDataBlockParser parser = new SPARQLUpdateDataBlockParser(this.getValueFactory());\n+\t\tfor (UpdateExpr expr : updateExprs) {\n+\t\t\tString datablock = \"\";\n+\t\t\tif (expr instanceof InsertData) {\n+\t\t\t\tdatablock = ((InsertData) expr).getDataBlock();\n+\t\t\t} else if (expr instanceof DeleteData) {\n+\t\t\t\tdatablock = ((DeleteData) expr).getDataBlock();\n+\t\t\t}\n+\t\t\ttry {\n+\t\t\t\tparser.parse(new StringReader(datablock), \"\");\n+\t\t\t} catch (IOException e) {\n+\t\t\t\te.printStackTrace();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebd48ad054f9952cd147b187b3f6298480de1818"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM0OTQ5OQ==", "bodyText": "I think it should throw a MalformedQueryException rather than an RDFParseException - similar to how other syntactically illegal queries or updates result in a MalformedQueryException. You could wrap the RDFParseException produced by the parser in it so the cause is clear.", "url": "https://github.com/eclipse/rdf4j/pull/2248#discussion_r428349499", "createdAt": "2020-05-20T22:44:32Z", "author": {"login": "jeenbroekstra"}, "path": "compliance/repository/src/test/java/org/eclipse/rdf4j/repository/sparql/SPARQLRepositorySparqlUpdateTest.java", "diffHunk": "@@ -52,3 +64,42 @@\n //\t\tSystem.err.println(\"temporarily disabled testAutoCommitHandling() for HTTPRepository\");\n //\t}\n //}\n+public class SPARQLRepositorySparqlUpdateTest extends TestCase {\n+\n+\tprivate Repository m_repository;\n+\n+\t@Override\n+\tprotected void setUp() throws Exception {\n+\t\tsuper.setUp();\n+\t\tm_repository = new SailRepository(new MemoryStore());\n+\t}\n+\n+\t@Override\n+\tprotected void tearDown() throws Exception {\n+\t\tsuper.tearDown();\n+\t\tm_repository.shutDown();\n+\t}\n+\n+\t// @Test (expected = org.eclipse.rdf4j.rio.RDFParseException.class)\n+\t@Test\n+\tpublic void testInvalidInsertUpdate() {\n+\t\tRepositoryConnection connection = m_repository.getConnection();\n+\t\ttry {\n+\t\t\tUpdate update = connection.prepareUpdate(QueryLanguage.SPARQL, \"insert data { ?s ?p ?o }\");\n+\t\t} catch (RDFParseException rdfpe) {\n+\t\t\tAssert.assertEquals(7, rdfpe.getLineNumber());\n+\t\t}\n+\n+\t}\n+\n+\t// @Test (expected = org.eclipse.rdf4j.rio.RDFParseException.class)\n+\t@Test\n+\tpublic void testInvalidDeleteUpdate() {\n+\t\tRepositoryConnection connection = m_repository.getConnection();\n+\t\ttry {\n+\t\t\tUpdate update = connection.prepareUpdate(QueryLanguage.SPARQL, \"delete data { ?s ?p ?o }\");\n+\t\t} catch (RDFParseException rdfpe) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebd48ad054f9952cd147b187b3f6298480de1818"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM0OTkxMw==", "bodyText": "You don't need to do this when the datablock is empty.", "url": "https://github.com/eclipse/rdf4j/pull/2248#discussion_r428349913", "createdAt": "2020-05-20T22:45:41Z", "author": {"login": "jeenbroekstra"}, "path": "core/repository/sail/src/main/java/org/eclipse/rdf4j/repository/sail/SailRepositoryConnection.java", "diffHunk": "@@ -262,7 +269,22 @@ public SailBooleanQuery prepareBooleanQuery(QueryLanguage ql, String queryString\n \tpublic Update prepareUpdate(QueryLanguage ql, String update, String baseURI)\n \t\t\tthrows RepositoryException, MalformedQueryException {\n \t\tParsedUpdate parsedUpdate = QueryParserUtil.parseUpdate(ql, update, baseURI);\n+\t\tList<UpdateExpr> updateExprs = parsedUpdate.getUpdateExprs();\n+\t\tSPARQLUpdateDataBlockParser parser = new SPARQLUpdateDataBlockParser(this.getValueFactory());\n+\t\tfor (UpdateExpr expr : updateExprs) {\n+\t\t\tString datablock = \"\";\n+\t\t\tif (expr instanceof InsertData) {\n+\t\t\t\tdatablock = ((InsertData) expr).getDataBlock();\n+\t\t\t} else if (expr instanceof DeleteData) {\n+\t\t\t\tdatablock = ((DeleteData) expr).getDataBlock();\n+\t\t\t}\n+\t\t\ttry {\n+\t\t\t\tparser.parse(new StringReader(datablock), \"\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebd48ad054f9952cd147b187b3f6298480de1818"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM1NDg1Mw==", "bodyText": "Perhaps we should move all of this into the SPARQLParser itself. It seems the more logical place to handle it. If you do it here, you will need to duplicate this code in other repository implementations (such as HTTPRepository and SPARQLRepository).\nWhen actually executing the insert/delete, the parser is reconfigured for specific types of errors. For INSERTs, the following config settings are done:\n\tparser.setLineNumberOffset(insertDataExpr.getLineNumberOffset());\n\tparser.getParserConfig().addNonFatalError(BasicParserSettings.VERIFY_DATATYPE_VALUES);\n\tparser.getParserConfig().addNonFatalError(BasicParserSettings.FAIL_ON_UNKNOWN_DATATYPES);\n\tparser.getParserConfig().set(BasicParserSettings.SKOLEMIZE_ORIGIN, null);\n\nand for DELETE, the following:\n\tparser.setLineNumberOffset(deleteDataExpr.getLineNumberOffset());\n\tparser.setAllowBlankNodes(false); // no blank nodes allowed in DELETE DATA.\n\nI don't think we need the 'non-fatal error' settings (after all we want a parse exception when an error occurs), but the other settings we should probably duplicate here. The line number offset will hopefully correct the odd line numbers you're currently seeing in the tests.", "url": "https://github.com/eclipse/rdf4j/pull/2248#discussion_r428354853", "createdAt": "2020-05-20T23:00:10Z", "author": {"login": "jeenbroekstra"}, "path": "core/repository/sail/src/main/java/org/eclipse/rdf4j/repository/sail/SailRepositoryConnection.java", "diffHunk": "@@ -262,7 +269,22 @@ public SailBooleanQuery prepareBooleanQuery(QueryLanguage ql, String queryString\n \tpublic Update prepareUpdate(QueryLanguage ql, String update, String baseURI)\n \t\t\tthrows RepositoryException, MalformedQueryException {\n \t\tParsedUpdate parsedUpdate = QueryParserUtil.parseUpdate(ql, update, baseURI);\n+\t\tList<UpdateExpr> updateExprs = parsedUpdate.getUpdateExprs();\n+\t\tSPARQLUpdateDataBlockParser parser = new SPARQLUpdateDataBlockParser(this.getValueFactory());\n+\t\tfor (UpdateExpr expr : updateExprs) {\n+\t\t\tString datablock = \"\";\n+\t\t\tif (expr instanceof InsertData) {\n+\t\t\t\tdatablock = ((InsertData) expr).getDataBlock();\n+\t\t\t} else if (expr instanceof DeleteData) {\n+\t\t\t\tdatablock = ((DeleteData) expr).getDataBlock();\n+\t\t\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebd48ad054f9952cd147b187b3f6298480de1818"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM1NTEzMA==", "bodyText": "In JUnit 4, rather than @Override, this should have a @Before annotation.", "url": "https://github.com/eclipse/rdf4j/pull/2248#discussion_r428355130", "createdAt": "2020-05-20T23:00:55Z", "author": {"login": "jeenbroekstra"}, "path": "compliance/repository/src/test/java/org/eclipse/rdf4j/repository/sparql/SPARQLRepositorySparqlUpdateTest.java", "diffHunk": "@@ -52,3 +64,42 @@\n //\t\tSystem.err.println(\"temporarily disabled testAutoCommitHandling() for HTTPRepository\");\n //\t}\n //}\n+public class SPARQLRepositorySparqlUpdateTest extends TestCase {\n+\n+\tprivate Repository m_repository;\n+\n+\t@Override\n+\tprotected void setUp() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebd48ad054f9952cd147b187b3f6298480de1818"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM1NTI0Ng==", "bodyText": "Use JUnit 4 @After  instead of overrriding.", "url": "https://github.com/eclipse/rdf4j/pull/2248#discussion_r428355246", "createdAt": "2020-05-20T23:01:22Z", "author": {"login": "jeenbroekstra"}, "path": "compliance/repository/src/test/java/org/eclipse/rdf4j/repository/sparql/SPARQLRepositorySparqlUpdateTest.java", "diffHunk": "@@ -52,3 +64,42 @@\n //\t\tSystem.err.println(\"temporarily disabled testAutoCommitHandling() for HTTPRepository\");\n //\t}\n //}\n+public class SPARQLRepositorySparqlUpdateTest extends TestCase {\n+\n+\tprivate Repository m_repository;\n+\n+\t@Override\n+\tprotected void setUp() throws Exception {\n+\t\tsuper.setUp();\n+\t\tm_repository = new SailRepository(new MemoryStore());\n+\t}\n+\n+\t@Override", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebd48ad054f9952cd147b187b3f6298480de1818"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM1NTU3OQ==", "bodyText": "Why is it reporting line 7, on a one-line update? That can't be right.", "url": "https://github.com/eclipse/rdf4j/pull/2248#discussion_r428355579", "createdAt": "2020-05-20T23:02:26Z", "author": {"login": "jeenbroekstra"}, "path": "compliance/repository/src/test/java/org/eclipse/rdf4j/repository/sparql/SPARQLRepositorySparqlUpdateTest.java", "diffHunk": "@@ -52,3 +64,42 @@\n //\t\tSystem.err.println(\"temporarily disabled testAutoCommitHandling() for HTTPRepository\");\n //\t}\n //}\n+public class SPARQLRepositorySparqlUpdateTest extends TestCase {\n+\n+\tprivate Repository m_repository;\n+\n+\t@Override\n+\tprotected void setUp() throws Exception {\n+\t\tsuper.setUp();\n+\t\tm_repository = new SailRepository(new MemoryStore());\n+\t}\n+\n+\t@Override\n+\tprotected void tearDown() throws Exception {\n+\t\tsuper.tearDown();\n+\t\tm_repository.shutDown();\n+\t}\n+\n+\t// @Test (expected = org.eclipse.rdf4j.rio.RDFParseException.class)\n+\t@Test\n+\tpublic void testInvalidInsertUpdate() {\n+\t\tRepositoryConnection connection = m_repository.getConnection();\n+\t\ttry {\n+\t\t\tUpdate update = connection.prepareUpdate(QueryLanguage.SPARQL, \"insert data { ?s ?p ?o }\");\n+\t\t} catch (RDFParseException rdfpe) {\n+\t\t\tAssert.assertEquals(7, rdfpe.getLineNumber());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebd48ad054f9952cd147b187b3f6298480de1818"}, "originalPosition": 46}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1Nzc1NDE3", "url": "https://github.com/eclipse/rdf4j/pull/2248#pullrequestreview-415775417", "createdAt": "2020-05-20T23:10:04Z", "commit": {"oid": "ebd48ad054f9952cd147b187b3f6298480de1818"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMzoxMDowNFrOGYg57w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMzoxMDowNFrOGYg57w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM1ODEyNw==", "bodyText": "Ah, I only just now noticed that this was an existing, commented-out test class that you added your test to. I don't think that's quite right, let me have a closer look and I'll try and give some advice on how to better organize this.", "url": "https://github.com/eclipse/rdf4j/pull/2248#discussion_r428358127", "createdAt": "2020-05-20T23:10:04Z", "author": {"login": "jeenbroekstra"}, "path": "compliance/repository/src/test/java/org/eclipse/rdf4j/repository/sparql/SPARQLRepositorySparqlUpdateTest.java", "diffHunk": "@@ -52,3 +64,42 @@\n //\t\tSystem.err.println(\"temporarily disabled testAutoCommitHandling() for HTTPRepository\");\n //\t}\n //}\n+public class SPARQLRepositorySparqlUpdateTest extends TestCase {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebd48ad054f9952cd147b187b3f6298480de1818"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff392f4dc644ba7ef0fbda42b8c15a6a2cad654e", "author": {"user": {"login": "jeenbroekstra", "name": "Jeen Broekstra"}}, "url": "https://github.com/eclipse/rdf4j/commit/ff392f4dc644ba7ef0fbda42b8c15a6a2cad654e", "committedDate": "2020-05-22T07:46:43Z", "message": "GH-399 migrate SPARQLUpdateDataBlockParser to sparql parser module"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6abced7872395d62c42ce144412fcafd5d1df112", "author": {"user": {"login": "jeenbroekstra", "name": "Jeen Broekstra"}}, "url": "https://github.com/eclipse/rdf4j/commit/6abced7872395d62c42ce144412fcafd5d1df112", "committedDate": "2020-05-22T07:51:26Z", "message": "GH-399 add constructors to deprecated class for backward compatibility"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a7a7ab7261fdee49e3efb88cc343c562da9021a0", "author": {"user": {"login": "ishaanbassi", "name": "Ishaan Bassi"}}, "url": "https://github.com/eclipse/rdf4j/commit/a7a7ab7261fdee49e3efb88cc343c562da9021a0", "committedDate": "2020-05-22T11:56:20Z", "message": "GH-399 Added datablock parser to SPARQLParser\n\nSigned-off-by: ishaanbassi <ishaan16238@iiitd.ac.in>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b1b4a4afa7b71a898102ba5a8d85352f150f473", "author": {"user": {"login": "abhishekag03", "name": "Abhishek Agarwal"}}, "url": "https://github.com/eclipse/rdf4j/commit/0b1b4a4afa7b71a898102ba5a8d85352f150f473", "committedDate": "2020-05-22T12:18:13Z", "message": "GH-399 added invalid insert data test case\n\nSigned-off-by: abhishekag03 <abhishek16126@iiitd.ac.in>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ab15ccb26a83a91f6818a2cee9488f9375e29a6", "author": {"user": {"login": "Kvatsx", "name": "Kaustav Vats"}}, "url": "https://github.com/eclipse/rdf4j/commit/1ab15ccb26a83a91f6818a2cee9488f9375e29a6", "committedDate": "2020-05-22T12:35:05Z", "message": "GH-399 Added delete update testcase and fixed formatting\n\nSigned-off-by: kaustavvats <kaustav16048@iiitd.ac.in>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2ODg2NDQw", "url": "https://github.com/eclipse/rdf4j/pull/2248#pullrequestreview-416886440", "createdAt": "2020-05-22T12:53:54Z", "commit": {"oid": "1ab15ccb26a83a91f6818a2cee9488f9375e29a6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxMjo1Mzo1NFrOGZWB5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxMjo1Mzo1NFrOGZWB5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTIyODUxNg==", "bodyText": "Thanks for the help @jeenbroekstra . We have done all the changes suggested above.\nWe also noted one thing in the SPARQLParser.java file. In case the updateNode itself is not null, then do we need to check separately that the datablock is empty? We have kept this condition for now.", "url": "https://github.com/eclipse/rdf4j/pull/2248#discussion_r429228516", "createdAt": "2020-05-22T12:53:54Z", "author": {"login": "ishaanbassi"}, "path": "core/queryparser/sparql/src/main/java/org/eclipse/rdf4j/query/parser/sparql/SPARQLParser.java", "diffHunk": "@@ -130,23 +130,23 @@ public ParsedUpdate parseUpdate(String updateStr, String baseURI) throws Malform\n \n \t\t\t\t\tString datablock = \"\";\n \t\t\t\t\tif (updateExpr instanceof InsertData) {\n-\t\t\t\t\t\tInsertData insertDataExpr = (InsertData)updateExpr;\n+\t\t\t\t\t\tInsertData insertDataExpr = (InsertData) updateExpr;\n \t\t\t\t\t\tparser.getParserConfig().set(BasicParserSettings.SKOLEMIZE_ORIGIN, null);\n \t\t\t\t\t\tparser.setLineNumberOffset(insertDataExpr.getLineNumberOffset());\n \t\t\t\t\t\tdatablock = insertDataExpr.getDataBlock();\n \t\t\t\t\t} else if (updateExpr instanceof DeleteData) {\n-\t\t\t\t\t\tDeleteData deleteDataExpr = (DeleteData)updateExpr;\n+\t\t\t\t\t\tDeleteData deleteDataExpr = (DeleteData) updateExpr;\n \t\t\t\t\t\tparser.setLineNumberOffset(deleteDataExpr.getLineNumberOffset());\n \t\t\t\t\t\tparser.setAllowBlankNodes(false);\n \t\t\t\t\t\tdatablock = deleteDataExpr.getDataBlock();\n \t\t\t\t\t}\n-\t\t\t\t\tif(!datablock.equals(\"\")){\n+\n+\t\t\t\t\tif (!datablock.equals(\"\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ab15ccb26a83a91f6818a2cee9488f9375e29a6"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3MjQwOTUz", "url": "https://github.com/eclipse/rdf4j/pull/2248#pullrequestreview-417240953", "createdAt": "2020-05-23T01:56:44Z", "commit": {"oid": "1ab15ccb26a83a91f6818a2cee9488f9375e29a6"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c54ab36e3e05c9c7e682f057a99500432dab5c07", "author": {"user": {"login": "Kvatsx", "name": "Kaustav Vats"}}, "url": "https://github.com/eclipse/rdf4j/commit/c54ab36e3e05c9c7e682f057a99500432dab5c07", "committedDate": "2020-05-23T12:50:24Z", "message": "GH-399 Fixed all remaining testcases, Added condition in parseGraph function\n\nSigned-off-by: Kaustav Vats <kaustav16048@iiitd.ac.in>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3MzU5NjUy", "url": "https://github.com/eclipse/rdf4j/pull/2248#pullrequestreview-417359652", "createdAt": "2020-05-24T13:38:50Z", "commit": {"oid": "c54ab36e3e05c9c7e682f057a99500432dab5c07"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNFQxMzozODo1MVrOGZvAsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNFQxMzozODo1MVrOGZvAsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTYzNzgxMQ==", "bodyText": "@jeenbroekstra, we found that the failing testcases in ShaclTest, are due to this condition on readCodePoint function. Hence, we are not sure if these changes are sufficient. Kindly suggest an alternative solution or you can push a fix. Thanks for the help!", "url": "https://github.com/eclipse/rdf4j/pull/2248#discussion_r429637811", "createdAt": "2020-05-24T13:38:51Z", "author": {"login": "ishaanbassi"}, "path": "core/queryparser/sparql/src/main/java/org/eclipse/rdf4j/query/parser/sparql/SPARQLUpdateDataBlockParser.java", "diffHunk": "@@ -70,7 +72,90 @@ public RDFFormat getRDFFormat() {\n \n \t@Override\n \tprotected void parseGraph() throws RDFParseException, RDFHandlerException, IOException {\n-\t\tsuper.parseGraph();\n+\t\tint c = readCodePoint();\n+\t\tint c2 = peekCodePoint();\n+\t\tResource contextOrSubject = null;\n+\t\tboolean foundContextOrSubject = false;\n+\t\tif (c == '[') {\n+\t\t\tskipWSC();\n+\t\t\tc2 = readCodePoint();\n+\t\t\tif (c2 == ']') {\n+\t\t\t\tcontextOrSubject = createNode();\n+\t\t\t\tfoundContextOrSubject = true;\n+\t\t\t\tskipWSC();\n+\t\t\t} else {\n+\t\t\t\tunread(c2);\n+\t\t\t\tunread(c);\n+\t\t\t}\n+\t\t\tc = readCodePoint();\n+\t\t} else if (c == '<' || TurtleUtil.isPrefixStartChar(c) || (c == ':' && c2 != '-') || (c == '_' && c2 == ':')) {\n+\t\t\tunread(c);\n+\n+\t\t\tValue value = parseValue();\n+\n+\t\t\tif (value instanceof Resource) {\n+\t\t\t\tcontextOrSubject = (Resource) value;\n+\t\t\t\tfoundContextOrSubject = true;\n+\t\t\t} else {\n+\t\t\t\t// NOTE: If a user parses Turtle using TriG, then the following\n+\t\t\t\t// could actually be \"Illegal subject name\", but it should still\n+\t\t\t\t// hold\n+\t\t\t\treportFatalError(\"Illegal graph name: \" + value);\n+\t\t\t}\n+\n+\t\t\tskipWSC();\n+\t\t\tc = readCodePoint();\n+\t\t} else {\n+\t\t\tsetContext(null);\n+\t\t}\n+\n+\t\tif (c == '{') {\n+\t\t\tsetContext(contextOrSubject);\n+\n+\t\t\tc = skipWSC();\n+\n+\t\t\tif (c != '}') {\n+\t\t\t\tparseTriples();\n+\n+\t\t\t\tc = skipWSC();\n+\n+\t\t\t\twhile (c == '.') {\n+\t\t\t\t\treadCodePoint();\n+\n+\t\t\t\t\tc = skipWSC();\n+\n+\t\t\t\t\tif (c == '}') {\n+\t\t\t\t\t\tbreak;\n+\t\t\t\t\t}\n+\n+\t\t\t\t\tparseTriples();\n+\n+\t\t\t\t\tc = skipWSC();\n+\t\t\t\t}\n+\n+\t\t\t\tverifyCharacterOrFail(c, \"}\");\n+\t\t\t}\n+\t\t} else {\n+\t\t\tsetContext(null);\n+\n+\t\t\t// Did not turn out to be a graph, so assign it to subject instead\n+\t\t\t// and\n+\t\t\t// parse from here to triples\n+\t\t\tif (foundContextOrSubject) {\n+\t\t\t\tsubject = contextOrSubject;\n+\t\t\t\tunread(c);\n+\t\t\t\tparsePredicateObjectList();\n+\t\t\t}\n+\t\t\t// Or if we didn't recognise anything, just parse as Turtle\n+\t\t\telse {\n+\t\t\t\tunread(c);\n+\t\t\t\tparseTriples();\n+\t\t\t}\n+\t\t}\n+\n+\t\tif (c == '.' || c == '}') {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c54ab36e3e05c9c7e682f057a99500432dab5c07"}, "originalPosition": 101}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3NDQ3OTU1", "url": "https://github.com/eclipse/rdf4j/pull/2248#pullrequestreview-417447955", "createdAt": "2020-05-25T04:17:35Z", "commit": {"oid": "c54ab36e3e05c9c7e682f057a99500432dab5c07"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQwNDoxNzozNVrOGZ0VEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQwNDoxNzozNVrOGZ0VEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTcyNDk0NQ==", "bodyText": "The problem is that you are looking at the wrong character. You haven't advanced c yet, so it's still the last processed char - which will never be equal to '.' or '}', so the end char is never read. This is what causes the failures in the SHACL tests.\nTo fix, add this line before your if-condition:\n\tc = peekCodePoint();\n\nThat sets the value of c to the next char to be read, and then we decide to actually read if it is indeed a full stop or a closing bracket. Note that we use peek instead of read so that if the character isn't one we need to skip over, we haven't removed it for future processing yet.", "url": "https://github.com/eclipse/rdf4j/pull/2248#discussion_r429724945", "createdAt": "2020-05-25T04:17:35Z", "author": {"login": "jeenbroekstra"}, "path": "core/queryparser/sparql/src/main/java/org/eclipse/rdf4j/query/parser/sparql/SPARQLUpdateDataBlockParser.java", "diffHunk": "@@ -70,7 +72,90 @@ public RDFFormat getRDFFormat() {\n \n \t@Override\n \tprotected void parseGraph() throws RDFParseException, RDFHandlerException, IOException {\n-\t\tsuper.parseGraph();\n+\t\tint c = readCodePoint();\n+\t\tint c2 = peekCodePoint();\n+\t\tResource contextOrSubject = null;\n+\t\tboolean foundContextOrSubject = false;\n+\t\tif (c == '[') {\n+\t\t\tskipWSC();\n+\t\t\tc2 = readCodePoint();\n+\t\t\tif (c2 == ']') {\n+\t\t\t\tcontextOrSubject = createNode();\n+\t\t\t\tfoundContextOrSubject = true;\n+\t\t\t\tskipWSC();\n+\t\t\t} else {\n+\t\t\t\tunread(c2);\n+\t\t\t\tunread(c);\n+\t\t\t}\n+\t\t\tc = readCodePoint();\n+\t\t} else if (c == '<' || TurtleUtil.isPrefixStartChar(c) || (c == ':' && c2 != '-') || (c == '_' && c2 == ':')) {\n+\t\t\tunread(c);\n+\n+\t\t\tValue value = parseValue();\n+\n+\t\t\tif (value instanceof Resource) {\n+\t\t\t\tcontextOrSubject = (Resource) value;\n+\t\t\t\tfoundContextOrSubject = true;\n+\t\t\t} else {\n+\t\t\t\t// NOTE: If a user parses Turtle using TriG, then the following\n+\t\t\t\t// could actually be \"Illegal subject name\", but it should still\n+\t\t\t\t// hold\n+\t\t\t\treportFatalError(\"Illegal graph name: \" + value);\n+\t\t\t}\n+\n+\t\t\tskipWSC();\n+\t\t\tc = readCodePoint();\n+\t\t} else {\n+\t\t\tsetContext(null);\n+\t\t}\n+\n+\t\tif (c == '{') {\n+\t\t\tsetContext(contextOrSubject);\n+\n+\t\t\tc = skipWSC();\n+\n+\t\t\tif (c != '}') {\n+\t\t\t\tparseTriples();\n+\n+\t\t\t\tc = skipWSC();\n+\n+\t\t\t\twhile (c == '.') {\n+\t\t\t\t\treadCodePoint();\n+\n+\t\t\t\t\tc = skipWSC();\n+\n+\t\t\t\t\tif (c == '}') {\n+\t\t\t\t\t\tbreak;\n+\t\t\t\t\t}\n+\n+\t\t\t\t\tparseTriples();\n+\n+\t\t\t\t\tc = skipWSC();\n+\t\t\t\t}\n+\n+\t\t\t\tverifyCharacterOrFail(c, \"}\");\n+\t\t\t}\n+\t\t} else {\n+\t\t\tsetContext(null);\n+\n+\t\t\t// Did not turn out to be a graph, so assign it to subject instead\n+\t\t\t// and\n+\t\t\t// parse from here to triples\n+\t\t\tif (foundContextOrSubject) {\n+\t\t\t\tsubject = contextOrSubject;\n+\t\t\t\tunread(c);\n+\t\t\t\tparsePredicateObjectList();\n+\t\t\t}\n+\t\t\t// Or if we didn't recognise anything, just parse as Turtle\n+\t\t\telse {\n+\t\t\t\tunread(c);\n+\t\t\t\tparseTriples();\n+\t\t\t}\n+\t\t}\n+\n+\t\tif (c == '.' || c == '}') {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTYzNzgxMQ=="}, "originalCommit": {"oid": "c54ab36e3e05c9c7e682f057a99500432dab5c07"}, "originalPosition": 101}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f0e7cf24c35d1e20903983cc18017e014a7e15a", "author": {"user": {"login": "ishaanbassi", "name": "Ishaan Bassi"}}, "url": "https://github.com/eclipse/rdf4j/commit/5f0e7cf24c35d1e20903983cc18017e014a7e15a", "committedDate": "2020-05-25T12:26:58Z", "message": "GH-399 updated SPARQLUpdateDataBlockParser to read end character\n\nSigned-off-by: ishaanbassi <ishaan16238@iiitd.ac.in>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3NzA1MzM4", "url": "https://github.com/eclipse/rdf4j/pull/2248#pullrequestreview-417705338", "createdAt": "2020-05-25T13:18:32Z", "commit": {"oid": "5f0e7cf24c35d1e20903983cc18017e014a7e15a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 163, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}