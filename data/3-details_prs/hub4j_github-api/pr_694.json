{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcxOTg1Njg5", "number": 694, "title": "Streamline fetch and retry process", "bodyText": "Description\nStreamlining and clean up of fetching.  Not quite a refactoring but close.\nRate limit changed to be updated for each retry.\nRate and Abuse handlers are part of the retry process - they will not loop indefinitely.  They will also be detected without requiring an exception.  This means that fetchHttpStatusCode no longer simply returns forbidden status when rate limit is hit.", "createdAt": "2020-02-06T16:13:33Z", "url": "https://github.com/hub4j/github-api/pull/694", "merged": true, "mergeCommit": {"oid": "2f32e034d86d0d78912f1c5b5dd90a8bea83a8fc"}, "closed": true, "closedAt": "2020-02-13T06:29:23Z", "author": {"login": "bitwiseman"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBs77MgH2gAyMzcxOTg1Njg5OmI4ZmFlMTMwOGQ2N2U5NzE3NzZhZmEyMjMzM2U0YzliMDIxN2M0M2Y=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcB0pQcABqjMwMTYwMTc3MzQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b8fae1308d67e971776afa22333e4c9b0217c43f", "author": {"user": {"login": "bitwiseman", "name": "Liam Newman"}}, "url": "https://github.com/hub4j/github-api/commit/b8fae1308d67e971776afa22333e4c9b0217c43f", "committedDate": "2020-02-06T16:01:17Z", "message": "Streamline fetch and retry process"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1234c2e99e8265e87cc22eab6476e4f1fc77f2d1", "author": {"user": {"login": "bitwiseman", "name": "Liam Newman"}}, "url": "https://github.com/hub4j/github-api/commit/1234c2e99e8265e87cc22eab6476e4f1fc77f2d1", "committedDate": "2020-02-06T21:33:29Z", "message": "Add tests for rate limit"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4ca8f06f2a4bab89a5b2d1d14c57062c5ef06cad", "author": {"user": {"login": "bitwiseman", "name": "Liam Newman"}}, "url": "https://github.com/hub4j/github-api/commit/4ca8f06f2a4bab89a5b2d1d14c57062c5ef06cad", "committedDate": "2020-02-06T20:55:10Z", "message": "Formatting"}, "afterCommit": {"oid": "1234c2e99e8265e87cc22eab6476e4f1fc77f2d1", "author": {"user": {"login": "bitwiseman", "name": "Liam Newman"}}, "url": "https://github.com/hub4j/github-api/commit/1234c2e99e8265e87cc22eab6476e4f1fc77f2d1", "committedDate": "2020-02-06T21:33:29Z", "message": "Add tests for rate limit"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0NzkxODk4", "url": "https://github.com/hub4j/github-api/pull/694#pullrequestreview-354791898", "createdAt": "2020-02-06T21:41:11Z", "commit": {"oid": "1234c2e99e8265e87cc22eab6476e4f1fc77f2d1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQyMTo0MToxMVrOFmrLCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQyMTo0MToxMVrOFmrLCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjA5NzU0NA==", "bodyText": "It is better to view this in split diff view.  Two methods got squashed down and blended.", "url": "https://github.com/hub4j/github-api/pull/694#discussion_r376097544", "createdAt": "2020-02-06T21:41:11Z", "author": {"login": "bitwiseman"}, "path": "src/main/java/org/kohsuke/github/Requester.java", "diffHunk": "@@ -497,73 +497,81 @@ public InputStream fetchStream() throws IOException {\n     }\n \n     private <T> T _fetch(String tailApiUrl, URL url, SupplierThrows<T, IOException> supplier) throws IOException {\n-        while (true) {// loop while API rate limit is hit\n+        int responseCode = -1;\n+        String responseMessage = null;\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1234c2e99e8265e87cc22eab6476e4f1fc77f2d1"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0NzkyNTMy", "url": "https://github.com/hub4j/github-api/pull/694#pullrequestreview-354792532", "createdAt": "2020-02-06T21:42:18Z", "commit": {"oid": "1234c2e99e8265e87cc22eab6476e4f1fc77f2d1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQyMTo0MjoxOFrOFmrM5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQyMTo0MjoxOFrOFmrM5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjA5ODAyMw==", "bodyText": "This ensures that on retry we don't somehow accidentally use the connection from the previous loop.", "url": "https://github.com/hub4j/github-api/pull/694#discussion_r376098023", "createdAt": "2020-02-06T21:42:18Z", "author": {"login": "bitwiseman"}, "path": "src/main/java/org/kohsuke/github/Requester.java", "diffHunk": "@@ -497,73 +497,81 @@ public InputStream fetchStream() throws IOException {\n     }\n \n     private <T> T _fetch(String tailApiUrl, URL url, SupplierThrows<T, IOException> supplier) throws IOException {\n-        while (true) {// loop while API rate limit is hit\n+        int responseCode = -1;\n+        String responseMessage = null;\n+\n+        int retries = CONNECTION_ERROR_RETRIES;\n+\n+        do {\n+            // if we fail to create a connection we do not retry and we do not wrap\n+            uc = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1234c2e99e8265e87cc22eab6476e4f1fc77f2d1"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0Nzk1NzE0", "url": "https://github.com/hub4j/github-api/pull/694#pullrequestreview-354795714", "createdAt": "2020-02-06T21:47:55Z", "commit": {"oid": "1234c2e99e8265e87cc22eab6476e4f1fc77f2d1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQyMTo0Nzo1NVrOFmrW5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQyMTo0Nzo1NVrOFmrW5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjEwMDU4Mw==", "bodyText": "We note the rate limit change as soon as we have confidence that we have enough information to do so.\nBetter for race conditions.", "url": "https://github.com/hub4j/github-api/pull/694#discussion_r376100583", "createdAt": "2020-02-06T21:47:55Z", "author": {"login": "bitwiseman"}, "path": "src/main/java/org/kohsuke/github/Requester.java", "diffHunk": "@@ -497,73 +497,81 @@ public InputStream fetchStream() throws IOException {\n     }\n \n     private <T> T _fetch(String tailApiUrl, URL url, SupplierThrows<T, IOException> supplier) throws IOException {\n-        while (true) {// loop while API rate limit is hit\n+        int responseCode = -1;\n+        String responseMessage = null;\n+\n+        int retries = CONNECTION_ERROR_RETRIES;\n+\n+        do {\n+            // if we fail to create a connection we do not retry and we do not wrap\n+            uc = null;\n             uc = setupConnection(url);\n \n             try {\n-                return _fetchOrRetry(supplier, CONNECTION_ERROR_RETRIES);\n-            } catch (IOException e) {\n-                handleApiError(e);\n-            } finally {\n+                // This is where the request is sent and response is processing starts\n+                responseCode = uc.getResponseCode();\n+                responseMessage = uc.getResponseMessage();\n                 noteRateLimit(tailApiUrl);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1234c2e99e8265e87cc22eab6476e4f1fc77f2d1"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "825c36c15eb427fb2fd4366e95da0111722bc6da", "author": {"user": {"login": "bitwiseman", "name": "Liam Newman"}}, "url": "https://github.com/hub4j/github-api/commit/825c36c15eb427fb2fd4366e95da0111722bc6da", "committedDate": "2020-02-06T22:11:16Z", "message": "Tweaks for clarity"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0ODA5MzM2", "url": "https://github.com/hub4j/github-api/pull/694#pullrequestreview-354809336", "createdAt": "2020-02-06T22:11:59Z", "commit": {"oid": "825c36c15eb427fb2fd4366e95da0111722bc6da"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQyMjoxMTo1OVrOFmsBDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQyMjoxMTo1OVrOFmsBDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjExMTM3NA==", "bodyText": "If we have an error condition that we can detect early, skip calling the lambda.", "url": "https://github.com/hub4j/github-api/pull/694#discussion_r376111374", "createdAt": "2020-02-06T22:11:59Z", "author": {"login": "bitwiseman"}, "path": "src/main/java/org/kohsuke/github/Requester.java", "diffHunk": "@@ -497,73 +497,89 @@ public InputStream fetchStream() throws IOException {\n     }\n \n     private <T> T _fetch(String tailApiUrl, URL url, SupplierThrows<T, IOException> supplier) throws IOException {\n-        while (true) {// loop while API rate limit is hit\n+        int responseCode = -1;\n+        String responseMessage = null;\n+\n+        int retries = CONNECTION_ERROR_RETRIES;\n+\n+        do {\n+            // if we fail to create a connection we do not retry and we do not wrap\n+            uc = null;\n             uc = setupConnection(url);\n \n             try {\n-                return _fetchOrRetry(supplier, CONNECTION_ERROR_RETRIES);\n-            } catch (IOException e) {\n-                handleApiError(e);\n-            } finally {\n+                // This is where the request is sent and response is processing starts\n+                responseCode = uc.getResponseCode();\n+                responseMessage = uc.getResponseMessage();\n                 noteRateLimit(tailApiUrl);\n+\n+                // for this workaround, we can retry now\n+                if (isInvalidCached404Response(responseCode)) {\n+                    continue;\n+                }\n+                if (!(isRateLimitResponse(responseCode) || isAbuseLimitResponse(responseCode))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "825c36c15eb427fb2fd4366e95da0111722bc6da"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0ODEwMjIw", "url": "https://github.com/hub4j/github-api/pull/694#pullrequestreview-354810220", "createdAt": "2020-02-06T22:13:41Z", "commit": {"oid": "825c36c15eb427fb2fd4366e95da0111722bc6da"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQyMjoxMzo0MVrOFmsD2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQyMjoxMzo0MVrOFmsD2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjExMjA4OA==", "bodyText": "If the error is not transient, process it if needed and throw.", "url": "https://github.com/hub4j/github-api/pull/694#discussion_r376112088", "createdAt": "2020-02-06T22:13:41Z", "author": {"login": "bitwiseman"}, "path": "src/main/java/org/kohsuke/github/Requester.java", "diffHunk": "@@ -497,73 +497,89 @@ public InputStream fetchStream() throws IOException {\n     }\n \n     private <T> T _fetch(String tailApiUrl, URL url, SupplierThrows<T, IOException> supplier) throws IOException {\n-        while (true) {// loop while API rate limit is hit\n+        int responseCode = -1;\n+        String responseMessage = null;\n+\n+        int retries = CONNECTION_ERROR_RETRIES;\n+\n+        do {\n+            // if we fail to create a connection we do not retry and we do not wrap\n+            uc = null;\n             uc = setupConnection(url);\n \n             try {\n-                return _fetchOrRetry(supplier, CONNECTION_ERROR_RETRIES);\n-            } catch (IOException e) {\n-                handleApiError(e);\n-            } finally {\n+                // This is where the request is sent and response is processing starts\n+                responseCode = uc.getResponseCode();\n+                responseMessage = uc.getResponseMessage();\n                 noteRateLimit(tailApiUrl);\n+\n+                // for this workaround, we can retry now\n+                if (isInvalidCached404Response(responseCode)) {\n+                    continue;\n+                }\n+                if (!(isRateLimitResponse(responseCode) || isAbuseLimitResponse(responseCode))) {\n+                    return supplier.get();\n+                }\n+            } catch (IOException e) {\n+                // For transient errors, retry\n+                if (handledTransientConnectionError(e, url, retries)) {\n+                    continue;\n+                }\n+\n+                throw interpretApiError(e, responseCode, responseMessage, url, retries);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "825c36c15eb427fb2fd4366e95da0111722bc6da"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0ODEyODk5", "url": "https://github.com/hub4j/github-api/pull/694#pullrequestreview-354812899", "createdAt": "2020-02-06T22:18:49Z", "commit": {"oid": "825c36c15eb427fb2fd4366e95da0111722bc6da"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQyMjoxODo0OVrOFmsLsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQyMjoxODo0OVrOFmsLsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjExNDA5Ng==", "bodyText": "This case is handled in the main _fetch method now.  We pass in the best known values and don't have to guard against bad state here.", "url": "https://github.com/hub4j/github-api/pull/694#discussion_r376114096", "createdAt": "2020-02-06T22:18:49Z", "author": {"login": "bitwiseman"}, "path": "src/main/java/org/kohsuke/github/Requester.java", "diffHunk": "@@ -1023,57 +1039,36 @@ private InputStream wrapStream(InputStream in) throws IOException {\n     /**\n      * Handle API error by either throwing it or by returning normally to retry.\n      */\n-    void handleApiError(IOException e) throws IOException {\n-        int responseCode;\n-        try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "825c36c15eb427fb2fd4366e95da0111722bc6da"}, "originalPosition": 186}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0ODc0NDcz", "url": "https://github.com/hub4j/github-api/pull/694#pullrequestreview-354874473", "createdAt": "2020-02-07T00:58:09Z", "commit": {"oid": "a0fb8d3730135aacafe20d102983698567b2786a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwMDo1ODowOVrOFmvTdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwMDo1ODowOVrOFmvTdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE2NTIzOA==", "bodyText": "All of these were move from handleApiError.", "url": "https://github.com/hub4j/github-api/pull/694#discussion_r376165238", "createdAt": "2020-02-07T00:58:09Z", "author": {"login": "bitwiseman"}, "path": "src/main/java/org/kohsuke/github/Requester.java", "diffHunk": "@@ -497,73 +497,101 @@ public InputStream fetchStream() throws IOException {\n     }\n \n     private <T> T _fetch(String tailApiUrl, URL url, SupplierThrows<T, IOException> supplier) throws IOException {\n-        while (true) {// loop while API rate limit is hit\n+        int responseCode = -1;\n+        String responseMessage = null;\n+\n+        int retries = CONNECTION_ERROR_RETRIES;\n+\n+        do {\n+            // if we fail to create a connection we do not retry and we do not wrap\n+            uc = null;\n             uc = setupConnection(url);\n \n             try {\n-                return _fetchOrRetry(supplier, CONNECTION_ERROR_RETRIES);\n-            } catch (IOException e) {\n-                handleApiError(e);\n-            } finally {\n+                // This is where the request is sent and response is processing starts\n+                responseCode = uc.getResponseCode();\n+                responseMessage = uc.getResponseMessage();\n                 noteRateLimit(tailApiUrl);\n+                detectOTPRequired(responseCode);\n+\n+                // for this workaround, we can retry now\n+                if (isInvalidCached404Response(responseCode)) {\n+                    continue;\n+                }\n+                if (!(isRateLimitResponse(responseCode) || isAbuseLimitResponse(responseCode))) {\n+                    return supplier.get();\n+                }\n+            } catch (IOException e) {\n+                // For transient errors, retry\n+                if (handledTransientConnectionError(e, url, retries)) {\n+                    continue;\n+                }\n+\n+                throw interpretApiError(e, responseCode, responseMessage, url, retries);\n             }\n-        }\n-    }\n \n-    private <T> T _fetchOrRetry(SupplierThrows<T, IOException> supplier, int retries) throws IOException {\n-        int responseCode = -1;\n-        String responseMessage = null;\n-        // When retries equal 0 the previous call must return or throw, not retry again\n-        if (retries < 0) {\n-            throw new IllegalArgumentException(\"'retries' cannot be less than 0\");\n-        }\n+            handleLimitingErrors(responseCode);\n \n-        try {\n-            // This is where the request is sent and response is processing starts\n-            responseCode = uc.getResponseCode();\n-            responseMessage = uc.getResponseMessage();\n+        } while (--retries >= 0);\n \n-            // If we are caching and get an invalid cached 404, retry it.\n-            if (!retryInvalidCached404Response(responseCode, retries)) {\n-                return supplier.get();\n-            }\n-        } catch (FileNotFoundException e) {\n-            // java.net.URLConnection handles 404 exception as FileNotFoundException,\n-            // don't wrap exception in HttpException to preserve backward compatibility\n-            throw e;\n-        } catch (IOException e) {\n+        throw new GHIOException(\"Ran out of retries for URL: \" + url.toString());\n+    }\n \n-            if (!retryConnectionError(e, retries)) {\n-                throw new HttpException(responseCode, responseMessage, uc.getURL(), e);\n+    private void detectOTPRequired(int responseCode) throws GHIOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a0fb8d3730135aacafe20d102983698567b2786a"}, "originalPosition": 73}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "289282e235997bfe24ac07bd8d77d071561450f6", "author": {"user": {"login": "bitwiseman", "name": "Liam Newman"}}, "url": "https://github.com/hub4j/github-api/commit/289282e235997bfe24ac07bd8d77d071561450f6", "committedDate": "2020-02-07T00:59:49Z", "message": "Move OTP detection earlier\n\nLike other errors we've been waiting until later to catch, this one is detectable so\nwhe should do that before the downstream exception needs to be thrown."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a0fb8d3730135aacafe20d102983698567b2786a", "author": {"user": {"login": "bitwiseman", "name": "Liam Newman"}}, "url": "https://github.com/hub4j/github-api/commit/a0fb8d3730135aacafe20d102983698567b2786a", "committedDate": "2020-02-07T00:55:58Z", "message": "Move OTP detection earlier\n\nLike other errors we've been waiting until later to catch, this one is detectable so\nwhe should do that before the downstream exception needs to be thrown."}, "afterCommit": {"oid": "289282e235997bfe24ac07bd8d77d071561450f6", "author": {"user": {"login": "bitwiseman", "name": "Liam Newman"}}, "url": "https://github.com/hub4j/github-api/commit/289282e235997bfe24ac07bd8d77d071561450f6", "committedDate": "2020-02-07T00:59:49Z", "message": "Move OTP detection earlier\n\nLike other errors we've been waiting until later to catch, this one is detectable so\nwhe should do that before the downstream exception needs to be thrown."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1668, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}