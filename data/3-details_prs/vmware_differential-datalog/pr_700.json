{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ4OTI0Nzc0", "number": 700, "title": "D3log updated realization", "bodyText": "This pull request refactors the Realization interface, specifically the input side. The old interface did not allow for changes; to change a realization, the existing one had to be torn down and an entirely new one created. The new interface allows one to add a source to an existing realization or remove a source from the existing realization. The following is a brief list of changes made to allow for the new functionality:\n\nChanges the type of _sources for a Realization struct to be keyed by Source and contain the Source's accumulator.\nRewrites accumulator on_completed() to no longer automatically clear the accumulator.\nMoves accumulator clearing logic to clear().\nFor TxnMux: add_observable() now returns a handle, and remove_observable() function was added.\nImplements remove_source() and add_source() for Realization and refactors add_file_sources() to use add_source().", "createdAt": "2020-07-14T14:41:10Z", "url": "https://github.com/vmware/differential-datalog/pull/700", "merged": true, "mergeCommit": {"oid": "b1042caa3f4764a0bb3d23932f80ba16a92b3fa9"}, "closed": true, "closedAt": "2020-07-24T18:20:57Z", "author": {"login": "krs85"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc1M7aAgFqTQ0OTA3NjM5OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc3gGqCgBqjM1NzcyNjE3Nzg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5MDc2Mzk5", "url": "https://github.com/vmware/differential-datalog/pull/700#pullrequestreview-449076399", "createdAt": "2020-07-15T15:33:12Z", "commit": {"oid": "44d1269d2b008987729bf134e87be7c9234194ef"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNTozMzoxMlrOGyDzPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNTo0OTo1M1rOGyEcWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE0NDI1Mw==", "bodyText": "This method can only be safely invoked when there is no transaction in progress (because it starts a transaction internally and we don't support nested transactions). Please change this function to return an error if there is a transaction in progress and also reflect this in the comment.", "url": "https://github.com/vmware/differential-datalog/pull/700#discussion_r455144253", "createdAt": "2020-07-15T15:33:12Z", "author": {"login": "ryzhyk"}, "path": "rust/template/distributed_datalog/src/accumulate/accumulator.rs", "diffHunk": "@@ -47,6 +47,10 @@ where\n \n     /// Return the current state of the data.\n     fn get_current_state(&self) -> HashMap<RelId, HashSet<V>>;\n+\n+    /// Sends a deletion update to all observers, thus clearing the accumulated state.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44d1269d2b008987729bf134e87be7c9234194ef"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE0ODgyMQ==", "bodyText": "I think, get_current_state returns a copy of the internal state, i.e., it does not actually clear the accumulator plus introduces the overhead of cloning.  You probably want to add another method to AccumulatingObserver that swaps its internal state with empty set and returns the actual internal state rather than its clone.\nI realize, this code was copied from previous on_completed implementation, so it looks like the problem already existed there. (@sugohugo , do you agree?)", "url": "https://github.com/vmware/differential-datalog/pull/700#discussion_r455148821", "createdAt": "2020-07-15T15:40:14Z", "author": {"login": "ryzhyk"}, "path": "rust/template/distributed_datalog/src/accumulate/accumulator.rs", "diffHunk": "@@ -98,6 +102,33 @@ where\n         trace!(\"DistributingAccumulator({})::get_current_state()\", self.id);\n         self.observer.get_current_state()\n     }\n+\n+    fn clear(&mut self) {\n+        trace!(\"DistributingAccumulator({})::clear\", self.id);\n+        let mut distributor = self.distributor.lock().unwrap();\n+\n+        let mut delete_updates = self\n+            .get_current_state()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44d1269d2b008987729bf134e87be7c9234194ef"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE1Mzk0OQ==", "bodyText": "Please add a FIXME to eventually find a way to connect the accumulator to receiver.", "url": "https://github.com/vmware/differential-datalog/pull/700#discussion_r455153949", "createdAt": "2020-07-15T15:48:30Z", "author": {"login": "ryzhyk"}, "path": "rust/template/distributed_datalog/src/instantiate.rs", "diffHunk": "@@ -175,16 +182,18 @@ where\n     let receiver =\n         TcpReceiver::new(addr).map_err(|e| format!(\"failed to create TcpReceiver: {}\", e))?;\n     let receiver = Arc::new(Mutex::new(receiver));\n-    // an empty set indicates the TcpReceiver\n-    let _ = sources.insert(\n-        BTreeSet::new(),\n-        vec![(SourceRealization::Node(receiver.clone()), ())],\n-    );\n-\n-    txnmux\n-        .add_observable(Box::new(receiver))\n-        .map_err(|_| \"failed to register TcpReceiver with TxnMux\".to_string())?;\n-    Ok(())\n+    let accumulator = Arc::new(Mutex::new(DistributingAccumulator::new()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44d1269d2b008987729bf134e87be7c9234194ef"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE1NDc3OA==", "bodyText": "Shouldn't this be called add_file_source?", "url": "https://github.com/vmware/differential-datalog/pull/700#discussion_r455154778", "createdAt": "2020-07-15T15:49:53Z", "author": {"login": "ryzhyk"}, "path": "rust/template/distributed_datalog/src/instantiate.rs", "diffHunk": "@@ -388,6 +372,63 @@ where\n     _sinks: HashMap<BTreeSet<RelId>, Vec<(SinkRealization<P::Convert>, usize)>>,\n }\n \n+impl<P> Realization<P>\n+where\n+    P: Send + DDlog + 'static,\n+    P::Convert: Send + DDlogConvert,\n+{\n+    /// Remove a source from the existing realization.\n+    /// Also clear the accumulator and disconnect\n+    /// from the TxnMux.\n+    pub fn remove_source(&mut self, src: &Source) {\n+        // Remove entry.\n+        let (_, accumulator, id) = self._sources.remove(src).unwrap();\n+        let mut accum_observ = accumulator.lock().unwrap();\n+\n+        // Clear accumulator.\n+        accum_observ.clear();\n+\n+        // Disconnect from TxnMux.\n+        self._txnmux.remove_observable(id);\n+    }\n+\n+    /// Add a source to an existing realization.\n+    pub fn add_source(&mut self, path: &Path) -> Result<(), String> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44d1269d2b008987729bf134e87be7c9234194ef"}, "originalPosition": 183}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "725a517e6c10dd48412812f5107ddc6fdef628a9", "author": {"user": {"login": "krs85", "name": "Kelly"}}, "url": "https://github.com/vmware/differential-datalog/commit/725a517e6c10dd48412812f5107ddc6fdef628a9", "committedDate": "2020-07-22T19:27:57Z", "message": "Refactor Realization sources structure"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "21d10b975ea9e30687af36225e5584227e5d721f", "author": {"user": {"login": "krs85", "name": "Kelly"}}, "url": "https://github.com/vmware/differential-datalog/commit/21d10b975ea9e30687af36225e5584227e5d721f", "committedDate": "2020-07-22T19:27:57Z", "message": "No more automatic clearing of accumulator on on_completed(). Functionality moved to clear()."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8fdc0cfbe42e0e165777632dfed817aa634e9f1", "author": {"user": {"login": "krs85", "name": "Kelly"}}, "url": "https://github.com/vmware/differential-datalog/commit/d8fdc0cfbe42e0e165777632dfed817aa634e9f1", "committedDate": "2020-07-22T19:27:57Z", "message": "TxnMux: add_observable() now returns handle, implemented remove_observable()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ba0d3c23184868f5196d0a78e49b5b443aea5f1", "author": {"user": {"login": "krs85", "name": "Kelly"}}, "url": "https://github.com/vmware/differential-datalog/commit/7ba0d3c23184868f5196d0a78e49b5b443aea5f1", "committedDate": "2020-07-22T19:27:57Z", "message": "implements remove_source() functionality for Realization struct"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99d92ebde23e8ef7080908500c5788b78ec5f2dd", "author": {"user": {"login": "krs85", "name": "Kelly"}}, "url": "https://github.com/vmware/differential-datalog/commit/99d92ebde23e8ef7080908500c5788b78ec5f2dd", "committedDate": "2020-07-22T19:27:57Z", "message": "Implements add_source() for Realization, refactors add_file_sources() to use this new function."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1ef957c23726a8c271f0552b480a1684ccbd4ac", "author": {"user": {"login": "krs85", "name": "Kelly"}}, "url": "https://github.com/vmware/differential-datalog/commit/c1ef957c23726a8c271f0552b480a1684ccbd4ac", "committedDate": "2020-07-22T19:27:57Z", "message": "Updates accumulator unit tests to reflect no more automatic deletions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ed579b9f2e885266d16c6a359d92c60d56b4a18", "author": {"user": {"login": "krs85", "name": "Kelly"}}, "url": "https://github.com/vmware/differential-datalog/commit/2ed579b9f2e885266d16c6a359d92c60d56b4a18", "committedDate": "2020-07-22T19:27:57Z", "message": "Fixes clippy warning"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6c9bd65ded5fb8b260f93ef779e2b01384625c3", "author": {"user": {"login": "krs85", "name": "Kelly"}}, "url": "https://github.com/vmware/differential-datalog/commit/c6c9bd65ded5fb8b260f93ef779e2b01384625c3", "committedDate": "2020-07-22T19:27:57Z", "message": "Adds fixme for connecting accumulator to receiver, changes add_source() to add_file_source(), converts create_txn_mux() and add_tcp_receiver() from static to member functions on Realization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1945c1a469c1295195fa8730dcab73ffcb89893f", "author": {"user": {"login": "krs85", "name": "Kelly"}}, "url": "https://github.com/vmware/differential-datalog/commit/1945c1a469c1295195fa8730dcab73ffcb89893f", "committedDate": "2020-07-22T19:27:57Z", "message": "modifies accumulator's clear() function to swap internal state with empty set and returns the internal state"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0676360382607e60e7fcc56958ba0eae2d2b732", "author": {"user": {"login": "krs85", "name": "Kelly"}}, "url": "https://github.com/vmware/differential-datalog/commit/e0676360382607e60e7fcc56958ba0eae2d2b732", "committedDate": "2020-07-22T19:27:57Z", "message": "modifies accumulator's clear() to return an err if a transaction is in progress"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7933d990b04a49a49618a43c71a38ba78e79305c", "author": {"user": {"login": "krs85", "name": "Kelly"}}, "url": "https://github.com/vmware/differential-datalog/commit/7933d990b04a49a49618a43c71a38ba78e79305c", "committedDate": "2020-07-22T19:27:57Z", "message": "Fix accumulator tests for clear()"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "44d1269d2b008987729bf134e87be7c9234194ef", "author": {"user": {"login": "krs85", "name": "Kelly"}}, "url": "https://github.com/vmware/differential-datalog/commit/44d1269d2b008987729bf134e87be7c9234194ef", "committedDate": "2020-07-13T18:17:41Z", "message": "Fixes clippy warning"}, "afterCommit": {"oid": "7933d990b04a49a49618a43c71a38ba78e79305c", "author": {"user": {"login": "krs85", "name": "Kelly"}}, "url": "https://github.com/vmware/differential-datalog/commit/7933d990b04a49a49618a43c71a38ba78e79305c", "committedDate": "2020-07-22T19:27:57Z", "message": "Fix accumulator tests for clear()"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4563, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}