{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMwNjM2MDkz", "number": 835, "title": "Removed some of the allocations in running programs", "bodyText": "", "createdAt": "2020-12-01T23:22:30Z", "url": "https://github.com/vmware/differential-datalog/pull/835", "merged": true, "mergeCommit": {"oid": "82fba5003f011a2fe94f8bbeaa411014b104f86f"}, "closed": true, "closedAt": "2020-12-11T07:29:04Z", "author": {"login": "Kixiron"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdiCcAwAH2gAyNTMwNjM2MDkzOmRhNjlmYzI5MzQ5ODYwZGYzNjA3ZDhmMTAwMTIwZTM4NDFhMGVkNDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdlCqiFAFqTU0OTg1MTA2MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "da69fc29349860df3607d8f100120e3841a0ed48", "author": {"user": {"login": "Kixiron", "name": "Chase Wilson"}}, "url": "https://github.com/vmware/differential-datalog/commit/da69fc29349860df3607d8f100120e3841a0ed48", "committedDate": "2020-12-01T23:21:04Z", "message": "Minimized some of the allocations in running programs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3ODAyNzgz", "url": "https://github.com/vmware/differential-datalog/pull/835#pullrequestreview-547802783", "createdAt": "2020-12-09T03:09:29Z", "commit": {"oid": "da69fc29349860df3607d8f100120e3841a0ed48"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQwMzowOToyOVrOICANuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQwMzowOToyOVrOICANuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODk3MTU3OQ==", "bodyText": "This is where this PR breaks things.  The original version takes a slice and traverses it multiple times.  The new version takes iterator.  It exhausts the iterator in the first loop, so subsequent call to rels.all always returns true, so filter does nothing.", "url": "https://github.com/vmware/differential-datalog/pull/835#discussion_r538971579", "createdAt": "2020-12-09T03:09:29Z", "author": {"login": "ryzhyk"}, "path": "rust/template/differential_datalog/program/mod.rs", "diffHunk": "@@ -1595,39 +1601,41 @@ impl Program {\n     }\n \n     /// Returns all input relations of the program\n-    fn input_relations(&self) -> Vec<RelId> {\n-        self.nodes\n-            .iter()\n-            .flat_map(|node| match node {\n-                ProgNode::Rel { rel: r } => {\n-                    if r.input {\n-                        vec![r.id]\n-                    } else {\n-                        vec![]\n-                    }\n+    fn input_relations<'a>(&'a self) -> impl Iterator<Item = RelId> + 'a {\n+        self.nodes.iter().filter_map(|node| match node {\n+            ProgNode::Rel { rel: r } => {\n+                if r.input {\n+                    Some(r.id)\n+                } else {\n+                    None\n                 }\n-                ProgNode::Apply { .. } => vec![],\n-                ProgNode::SCC { rels: rs } => {\n-                    for r in rs {\n-                        assert!(!r.rel.input, \"input relation ({}) in SCC\", r.rel.name);\n-                    }\n-                    vec![]\n+            }\n+            ProgNode::Apply { .. } => None,\n+            ProgNode::SCC { rels: rs } => {\n+                for r in rs {\n+                    assert!(!r.rel.input, \"input relation ({}) in SCC\", r.rel.name);\n                 }\n-            })\n-            .collect()\n+\n+                None\n+            }\n+        })\n     }\n \n     /// Return all relations required to compute rels, excluding recursive dependencies on rels\n-    fn dependencies(rels: &[&Relation]) -> FnvHashSet<Dep> {\n+    fn dependencies<'a, R>(mut rels: R) -> FnvHashSet<Dep>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "da69fc29349860df3607d8f100120e3841a0ed48"}, "originalPosition": 233}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "628aabde04ca8b431319f38b9f5611ee74254aa0", "author": {"user": {"login": "ryzhyk", "name": "Leonid Ryzhyk"}}, "url": "https://github.com/vmware/differential-datalog/commit/628aabde04ca8b431319f38b9f5611ee74254aa0", "committedDate": "2020-12-11T06:19:12Z", "message": "Bug fix in `Program::dependencies`.\n\nClone the iterator to avoid exhausting it at the first iteration of the\nouter loop."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5ODUxMDYw", "url": "https://github.com/vmware/differential-datalog/pull/835#pullrequestreview-549851060", "createdAt": "2020-12-11T07:18:42Z", "commit": {"oid": "628aabde04ca8b431319f38b9f5611ee74254aa0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4465, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}