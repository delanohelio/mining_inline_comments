{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc2MTU2MDE3", "number": 2309, "title": "Fix 5725: Spider Check for JSON/YAML'ish content", "bodyText": "Content type check in canParseResource(Httpmessage, String, boolean) is made more specific. Fixes zaproxy/zaproxy#5725.\nSigned-off-by: Akshath Kothari akshath.kothari@gmail.com", "createdAt": "2020-02-17T14:08:23Z", "url": "https://github.com/zaproxy/zap-extensions/pull/2309", "merged": true, "mergeCommit": {"oid": "74508176dd117373f0b8d03dccd1d13252a7ebfa"}, "closed": true, "closedAt": "2020-02-24T10:36:48Z", "author": {"login": "ricekot"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcFOeljgFqTM1OTc4MzI1Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcHbFJwgFqTM2MzI5NDIyNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5NzgzMjU3", "url": "https://github.com/zaproxy/zap-extensions/pull/2309#pullrequestreview-359783257", "createdAt": "2020-02-17T14:42:17Z", "commit": {"oid": "0f7faf7020c4077976a5211368eaca34360fb8a7"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxNDo0MjoxN1rOFqmx3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxNDo0Nzo0MVrOFqm9Rg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDIxOTg3MQ==", "bodyText": "How about adding the toLowerCase() here and then it wont be needed later?", "url": "https://github.com/zaproxy/zap-extensions/pull/2309#discussion_r380219871", "createdAt": "2020-02-17T14:42:17Z", "author": {"login": "psiinon"}, "path": "addOns/openapi/src/main/java/org/zaproxy/zap/extension/openapi/OpenApiSpider.java", "diffHunk": "@@ -65,10 +65,15 @@ public boolean parseResource(HttpMessage message, Source source, int depth) {\n     public boolean canParseResource(HttpMessage message, String path, boolean wasAlreadyConsumed) {\n         try {\n             String contentType = message.getResponseHeader().getHeader(HttpHeader.CONTENT_TYPE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f7faf7020c4077976a5211368eaca34360fb8a7"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDIyMjc5MA==", "bodyText": "Calling message.getResponseBody().toString().toLowerCase() twice seems very inefficient. Maybe do it just once, and could extract the first 8 chrs rather than doing toLowerCase() on a potentially very large response?", "url": "https://github.com/zaproxy/zap-extensions/pull/2309#discussion_r380222790", "createdAt": "2020-02-17T14:47:41Z", "author": {"login": "psiinon"}, "path": "addOns/openapi/src/main/java/org/zaproxy/zap/extension/openapi/OpenApiSpider.java", "diffHunk": "@@ -65,10 +65,15 @@ public boolean parseResource(HttpMessage message, Source source, int depth) {\n     public boolean canParseResource(HttpMessage message, String path, boolean wasAlreadyConsumed) {\n         try {\n             String contentType = message.getResponseHeader().getHeader(HttpHeader.CONTENT_TYPE);\n-            if (contentType.toLowerCase().startsWith(\"text\")\n-                    && message.getResponseBody().toString().toLowerCase().startsWith(\"swagger:\")) {\n+            if (contentType.toLowerCase().startsWith(\"application/vnd.oai.openapi\")) {\n                 return true;\n-            } else if (contentType.toLowerCase().startsWith(\"application\")) {\n+            } else if ((contentType.toLowerCase().contains(\"json\")\n+                            || contentType.toLowerCase().contains(\"yaml\"))\n+                    && (message.getResponseBody().toString().toLowerCase().startsWith(\"swagger:\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f7faf7020c4077976a5211368eaca34360fb8a7"}, "originalPosition": 11}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0f7faf7020c4077976a5211368eaca34360fb8a7", "author": {"user": {"login": "ricekot", "name": "Akshath Kothari"}}, "url": "https://github.com/zaproxy/zap-extensions/commit/0f7faf7020c4077976a5211368eaca34360fb8a7", "committedDate": "2020-02-17T14:06:57Z", "message": "Fix #5725: Spider Check for JSON/YAML'ish content\n\nContent type check in canParseResource(Httpmessage, String,\nboolean) is made more specific.\n\nSigned-off-by: Akshath Kothari <akshath.kothari@gmail.com>"}, "afterCommit": {"oid": "2e4fddb9aa78965331167dde3df2e83609c3ed26", "author": {"user": {"login": "ricekot", "name": "Akshath Kothari"}}, "url": "https://github.com/zaproxy/zap-extensions/commit/2e4fddb9aa78965331167dde3df2e83609c3ed26", "committedDate": "2020-02-17T17:00:46Z", "message": "Fix #5725: Spider Check for JSON/YAML'ish content\n\nContent type check in canParseResource(Httpmessage, String,\nboolean) is made more specific.\n\nSigned-off-by: Akshath Kothari <akshath.kothari@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwMjk1OTUy", "url": "https://github.com/zaproxy/zap-extensions/pull/2309#pullrequestreview-360295952", "createdAt": "2020-02-18T12:25:03Z", "commit": {"oid": "2e4fddb9aa78965331167dde3df2e83609c3ed26"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxMjoyNTowM1rOFrAZcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxMjoyNTowM1rOFrAZcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDYzOTYwMw==", "bodyText": "String.substring will throw an exception if the body length is less than 8, so should check for that first.", "url": "https://github.com/zaproxy/zap-extensions/pull/2309#discussion_r380639603", "createdAt": "2020-02-18T12:25:03Z", "author": {"login": "psiinon"}, "path": "addOns/openapi/src/main/java/org/zaproxy/zap/extension/openapi/OpenApiSpider.java", "diffHunk": "@@ -64,11 +64,15 @@ public boolean parseResource(HttpMessage message, Source source, int depth) {\n     @Override\n     public boolean canParseResource(HttpMessage message, String path, boolean wasAlreadyConsumed) {\n         try {\n-            String contentType = message.getResponseHeader().getHeader(HttpHeader.CONTENT_TYPE);\n-            if (contentType.toLowerCase().startsWith(\"text\")\n-                    && message.getResponseBody().toString().toLowerCase().startsWith(\"swagger:\")) {\n+            String contentType =\n+                    message.getResponseHeader().getHeader(HttpHeader.CONTENT_TYPE).toLowerCase();\n+            String responseBodyStart =\n+                    message.getResponseBody().toString().substring(0, 8).toLowerCase();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e4fddb9aa78965331167dde3df2e83609c3ed26"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwMzExNDU0", "url": "https://github.com/zaproxy/zap-extensions/pull/2309#pullrequestreview-360311454", "createdAt": "2020-02-18T12:51:38Z", "commit": {"oid": "2e4fddb9aa78965331167dde3df2e83609c3ed26"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxMjo1MTozOVrOFrBJMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxMjo1MjowNVrOFrBJ-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDY1MTgyNg==", "bodyText": "These entries should be less code oriented, the user reading this might not know about the code, e.g. Improve content checks when spidering for specifications (Issue 5725).", "url": "https://github.com/zaproxy/zap-extensions/pull/2309#discussion_r380651826", "createdAt": "2020-02-18T12:51:39Z", "author": {"login": "thc202"}, "path": "addOns/openapi/CHANGELOG.md", "diffHunk": "@@ -4,7 +4,8 @@ All notable changes to this add-on will be documented in this file.\n The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/).\n \n ## Unreleased\n-\n+### Changed\n+- Content type check in canParseResource(...) is made more specific (Issue 5725).", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e4fddb9aa78965331167dde3df2e83609c3ed26"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDY1MTkyNg==", "bodyText": "Should lower case with Locale.ROOT, to not rely on the default locale.", "url": "https://github.com/zaproxy/zap-extensions/pull/2309#discussion_r380651926", "createdAt": "2020-02-18T12:51:51Z", "author": {"login": "thc202"}, "path": "addOns/openapi/src/main/java/org/zaproxy/zap/extension/openapi/OpenApiSpider.java", "diffHunk": "@@ -64,11 +64,15 @@ public boolean parseResource(HttpMessage message, Source source, int depth) {\n     @Override\n     public boolean canParseResource(HttpMessage message, String path, boolean wasAlreadyConsumed) {\n         try {\n-            String contentType = message.getResponseHeader().getHeader(HttpHeader.CONTENT_TYPE);\n-            if (contentType.toLowerCase().startsWith(\"text\")\n-                    && message.getResponseBody().toString().toLowerCase().startsWith(\"swagger:\")) {\n+            String contentType =\n+                    message.getResponseHeader().getHeader(HttpHeader.CONTENT_TYPE).toLowerCase();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e4fddb9aa78965331167dde3df2e83609c3ed26"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDY1MjAyNg==", "bodyText": "These checks might not work properly (e.g. if the OpenAPI has comments or when JSON which starts with {), some examples in https://github.com/OAI/OpenAPI-Specification/tree/master/examples", "url": "https://github.com/zaproxy/zap-extensions/pull/2309#discussion_r380652026", "createdAt": "2020-02-18T12:52:05Z", "author": {"login": "thc202"}, "path": "addOns/openapi/src/main/java/org/zaproxy/zap/extension/openapi/OpenApiSpider.java", "diffHunk": "@@ -64,11 +64,15 @@ public boolean parseResource(HttpMessage message, Source source, int depth) {\n     @Override\n     public boolean canParseResource(HttpMessage message, String path, boolean wasAlreadyConsumed) {\n         try {\n-            String contentType = message.getResponseHeader().getHeader(HttpHeader.CONTENT_TYPE);\n-            if (contentType.toLowerCase().startsWith(\"text\")\n-                    && message.getResponseBody().toString().toLowerCase().startsWith(\"swagger:\")) {\n+            String contentType =\n+                    message.getResponseHeader().getHeader(HttpHeader.CONTENT_TYPE).toLowerCase();\n+            String responseBodyStart =\n+                    message.getResponseBody().toString().substring(0, 8).toLowerCase();\n+            if (contentType.startsWith(\"application/vnd.oai.openapi\")) {\n                 return true;\n-            } else if (contentType.toLowerCase().startsWith(\"application\")) {\n+            } else if ((contentType.contains(\"json\") || contentType.contains(\"yaml\"))\n+                    && (responseBodyStart.equals(\"swagger:\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e4fddb9aa78965331167dde3df2e83609c3ed26"}, "originalPosition": 15}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2e4fddb9aa78965331167dde3df2e83609c3ed26", "author": {"user": {"login": "ricekot", "name": "Akshath Kothari"}}, "url": "https://github.com/zaproxy/zap-extensions/commit/2e4fddb9aa78965331167dde3df2e83609c3ed26", "committedDate": "2020-02-17T17:00:46Z", "message": "Fix #5725: Spider Check for JSON/YAML'ish content\n\nContent type check in canParseResource(Httpmessage, String,\nboolean) is made more specific.\n\nSigned-off-by: Akshath Kothari <akshath.kothari@gmail.com>"}, "afterCommit": {"oid": "63854a7be96b0c355dac0165c9fad8836bffe806", "author": {"user": {"login": "ricekot", "name": "Akshath Kothari"}}, "url": "https://github.com/zaproxy/zap-extensions/commit/63854a7be96b0c355dac0165c9fad8836bffe806", "committedDate": "2020-02-18T13:02:53Z", "message": "Fix #5725: Spider Check for JSON/YAML'ish content\n\nContent type check in canParseResource(Httpmessage, String,\nboolean) is made more specific.\n\nSigned-off-by: Akshath Kothari <akshath.kothari@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1021009af4c1d2525f60316342ea558e3d28773e", "author": {"user": {"login": "ricekot", "name": "Akshath Kothari"}}, "url": "https://github.com/zaproxy/zap-extensions/commit/1021009af4c1d2525f60316342ea558e3d28773e", "committedDate": "2020-02-18T16:55:26Z", "message": "Fix 5725: Spider Check for JSON/YAML'ish content\n\n- Content type check in canParseResource(Httpmessage, String,\nboolean) is made more specific.\n- Updated Changelog\n\nSigned-off-by: Akshath Kothari <akshath.kothari@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "63854a7be96b0c355dac0165c9fad8836bffe806", "author": {"user": {"login": "ricekot", "name": "Akshath Kothari"}}, "url": "https://github.com/zaproxy/zap-extensions/commit/63854a7be96b0c355dac0165c9fad8836bffe806", "committedDate": "2020-02-18T13:02:53Z", "message": "Fix #5725: Spider Check for JSON/YAML'ish content\n\nContent type check in canParseResource(Httpmessage, String,\nboolean) is made more specific.\n\nSigned-off-by: Akshath Kothari <akshath.kothari@gmail.com>"}, "afterCommit": {"oid": "1021009af4c1d2525f60316342ea558e3d28773e", "author": {"user": {"login": "ricekot", "name": "Akshath Kothari"}}, "url": "https://github.com/zaproxy/zap-extensions/commit/1021009af4c1d2525f60316342ea558e3d28773e", "committedDate": "2020-02-18T16:55:26Z", "message": "Fix 5725: Spider Check for JSON/YAML'ish content\n\n- Content type check in canParseResource(Httpmessage, String,\nboolean) is made more specific.\n- Updated Changelog\n\nSigned-off-by: Akshath Kothari <akshath.kothari@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNTM4MDk4", "url": "https://github.com/zaproxy/zap-extensions/pull/2309#pullrequestreview-360538098", "createdAt": "2020-02-18T17:37:48Z", "commit": {"oid": "1021009af4c1d2525f60316342ea558e3d28773e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwOTUyMjE5", "url": "https://github.com/zaproxy/zap-extensions/pull/2309#pullrequestreview-360952219", "createdAt": "2020-02-19T09:24:43Z", "commit": {"oid": "1021009af4c1d2525f60316342ea558e3d28773e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMjk0MjI0", "url": "https://github.com/zaproxy/zap-extensions/pull/2309#pullrequestreview-363294224", "createdAt": "2020-02-24T10:36:38Z", "commit": {"oid": "1021009af4c1d2525f60316342ea558e3d28773e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 443, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}