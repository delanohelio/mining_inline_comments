{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTExODE5MjIx", "number": 2592, "title": "Allow to ignore cookies in same site and loosely scoped scan rules", "bodyText": "Allow to ignore cookies in same site and loosely scoped scan rules\nResolves zaproxy/zaproxy#6264\n(Edit: by @kingthorin, fixed linked issue number)", "createdAt": "2020-10-28T20:29:34Z", "url": "https://github.com/zaproxy/zap-extensions/pull/2592", "merged": true, "mergeCommit": {"oid": "e30d36cdff2fe13afdf64afc40501e720a3f6bdf"}, "closed": true, "closedAt": "2020-10-30T13:29:43Z", "author": {"login": "dhruvil-93"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXEAM4AFqTUxOTA3NzIwMA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXmyfTAFqTUyMDY2NjY1MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5MDc3MjAw", "url": "https://github.com/zaproxy/zap-extensions/pull/2592#pullrequestreview-519077200", "createdAt": "2020-10-28T20:57:19Z", "commit": {"oid": "ccfe3b32ae86a7f722f011f2c52754df8b315bd9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQyMDo1NzoxOVrOHp9H9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQyMDo1NzoxOVrOHp9H9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc1NTEyNA==", "bodyText": "There's a typo in scoped (also in the commit message/PR description).", "url": "https://github.com/zaproxy/zap-extensions/pull/2592#discussion_r513755124", "createdAt": "2020-10-28T20:57:19Z", "author": {"login": "thc202"}, "path": "addOns/pscanrules/CHANGELOG.md", "diffHunk": "@@ -10,6 +10,7 @@ The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/).\n - Maintenance changes.\n - Changed ViewState and XFrameOption rules to return example alerts for the docs\n - Handle an IllegalArgumentException that could occur in the CSP scan rule if multiple CSP headers were present and one (or more) had a report-uri directive when trying to merge them.\n+- Extend support for cookie ignore rule to same site and loosely scopped scan rules.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccfe3b32ae86a7f722f011f2c52754df8b315bd9"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5MDc3NDAx", "url": "https://github.com/zaproxy/zap-extensions/pull/2592#pullrequestreview-519077401", "createdAt": "2020-10-28T20:57:34Z", "commit": {"oid": "ccfe3b32ae86a7f722f011f2c52754df8b315bd9"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQyMDo1NzozNFrOHp9IhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQyMDo1OTozM1rOHp9NAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc1NTI2OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void cookieOnIgnoreList() throws HttpMalformedHeaderException {\n          \n          \n            \n                public void shouldNotAlertWhenCookieOnIgnoreList() throws HttpMalformedHeaderException {", "url": "https://github.com/zaproxy/zap-extensions/pull/2592#discussion_r513755269", "createdAt": "2020-10-28T20:57:34Z", "author": {"login": "kingthorin"}, "path": "addOns/pscanrules/src/test/java/org/zaproxy/zap/extension/pscanrules/CookieLooselyScopedScanRuleUnitTest.java", "diffHunk": "@@ -198,4 +216,39 @@ public void shouldScanHostWithoutTld() throws Exception {\n         // When / Then\n         assertDoesNotThrow(() -> scanHttpResponseReceive(msg));\n     }\n+\n+    @Test\n+    public void cookieOnIgnoreList() throws HttpMalformedHeaderException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccfe3b32ae86a7f722f011f2c52754df8b315bd9"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc1NTQ2MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void cookieNotOnIgnoreList() throws HttpMalformedHeaderException {\n          \n          \n            \n                public void shouldAlertWhenCookieNotOnIgnoreList() throws HttpMalformedHeaderException {", "url": "https://github.com/zaproxy/zap-extensions/pull/2592#discussion_r513755461", "createdAt": "2020-10-28T20:57:57Z", "author": {"login": "kingthorin"}, "path": "addOns/pscanrules/src/test/java/org/zaproxy/zap/extension/pscanrules/CookieLooselyScopedScanRuleUnitTest.java", "diffHunk": "@@ -198,4 +216,39 @@ public void shouldScanHostWithoutTld() throws Exception {\n         // When / Then\n         assertDoesNotThrow(() -> scanHttpResponseReceive(msg));\n     }\n+\n+    @Test\n+    public void cookieOnIgnoreList() throws HttpMalformedHeaderException {\n+        // Given\n+        HttpMessage msg = createBasicMessage();\n+        msg.setRequestHeader(\"GET http://test.example.com/admin/roles HTTP/1.1\");\n+        msg.getResponseHeader()\n+                .setHeader(HttpResponseHeader.SET_COOKIE, \"aaaa=b;domain=.example.com\");\n+        model.getOptionsParam()\n+                .getConfig()\n+                .setProperty(RuleConfigParam.RULE_COOKIE_IGNORE_LIST, \"aaaa,bbb,ccc\");\n+\n+        // When\n+        scanHttpResponseReceive(msg);\n+\n+        // Then\n+        assertThat(alertsRaised.size(), equalTo(0));\n+    }\n+\n+    @Test\n+    public void cookieNotOnIgnoreList() throws HttpMalformedHeaderException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccfe3b32ae86a7f722f011f2c52754df8b315bd9"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc1NTg2MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void cookieOnIgnoreList() throws HttpMalformedHeaderException {\n          \n          \n            \n                public void shouldNotAlertWhenCookieOnIgnoreList() throws HttpMalformedHeaderException {", "url": "https://github.com/zaproxy/zap-extensions/pull/2592#discussion_r513755860", "createdAt": "2020-10-28T20:58:38Z", "author": {"login": "kingthorin"}, "path": "addOns/pscanrules/src/test/java/org/zaproxy/zap/extension/pscanrules/CookieSameSiteScanRuleUnitTest.java", "diffHunk": "@@ -307,4 +324,52 @@ public void secondCookieNoSameSiteAttributeFirstExpired() throws HttpMalformedHe\n         assertThat(alertsRaised.get(0).getParam(), equalTo(\"test\"));\n         assertThat(alertsRaised.get(0).getEvidence(), equalTo(\"Set-Cookie: test\"));\n     }\n+\n+    @Test\n+    public void cookieOnIgnoreList() throws HttpMalformedHeaderException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccfe3b32ae86a7f722f011f2c52754df8b315bd9"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc1NjQxOA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void cookieNotOnIgnoreList() throws HttpMalformedHeaderException {\n          \n          \n            \n                public void shouldAlertWhenCookieNotOnIgnoreList() throws HttpMalformedHeaderException {", "url": "https://github.com/zaproxy/zap-extensions/pull/2592#discussion_r513756418", "createdAt": "2020-10-28T20:59:33Z", "author": {"login": "kingthorin"}, "path": "addOns/pscanrules/src/test/java/org/zaproxy/zap/extension/pscanrules/CookieSameSiteScanRuleUnitTest.java", "diffHunk": "@@ -307,4 +324,52 @@ public void secondCookieNoSameSiteAttributeFirstExpired() throws HttpMalformedHe\n         assertThat(alertsRaised.get(0).getParam(), equalTo(\"test\"));\n         assertThat(alertsRaised.get(0).getEvidence(), equalTo(\"Set-Cookie: test\"));\n     }\n+\n+    @Test\n+    public void cookieOnIgnoreList() throws HttpMalformedHeaderException {\n+        model.getOptionsParam()\n+                .getConfig()\n+                .setProperty(RuleConfigParam.RULE_COOKIE_IGNORE_LIST, \"aaaa,test,bbb\");\n+\n+        HttpMessage msg = new HttpMessage();\n+        msg.setRequestHeader(\"GET https://www.example.com/test/ HTTP/1.1\");\n+\n+        msg.setResponseBody(\"<html></html>\");\n+        msg.setResponseHeader(\n+                \"HTTP/1.1 200 OK\\r\\n\"\n+                        + \"Server: Apache-Coyote/1.1\\r\\n\"\n+                        + \"Set-Cookie: test=123; Path=/; HttpOnly\\r\\n\"\n+                        + \"Content-Type: text/html;charset=ISO-8859-1\\r\\n\"\n+                        + \"Content-Length: \"\n+                        + msg.getResponseBody().length()\n+                        + \"\\r\\n\");\n+        scanHttpResponseReceive(msg);\n+\n+        assertThat(alertsRaised.size(), equalTo(0));\n+    }\n+\n+    @Test\n+    public void cookieNotOnIgnoreList() throws HttpMalformedHeaderException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccfe3b32ae86a7f722f011f2c52754df8b315bd9"}, "originalPosition": 67}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5MDg5MDA1", "url": "https://github.com/zaproxy/zap-extensions/pull/2592#pullrequestreview-519089005", "createdAt": "2020-10-28T21:13:59Z", "commit": {"oid": "ccfe3b32ae86a7f722f011f2c52754df8b315bd9"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQyMToxMzo1OVrOHp9tFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQyMToxNTowN1rOHp9vnQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc2NDYyOA==", "bodyText": "This should be done in the above if and before calling isLooselyScopedCookie, avoids doing all the work if the cookie is ignored.", "url": "https://github.com/zaproxy/zap-extensions/pull/2592#discussion_r513764628", "createdAt": "2020-10-28T21:13:59Z", "author": {"login": "thc202"}, "path": "addOns/pscanrules/src/main/java/org/zaproxy/zap/extension/pscanrules/CookieLooselyScopedScanRule.java", "diffHunk": "@@ -58,11 +63,15 @@ public void scanHttpResponseReceive(HttpMessage msg, int id, Source source) {\n         // name of a host from which the response has been sent from\n         String host = msg.getRequestHeader().getHostName();\n \n+        Set<String> ignoreList = CookieUtils.getCookieIgnoreList(getModel());\n+\n         // find all loosely scoped cookies\n         List<HttpCookie> looselyScopedCookies = new LinkedList<HttpCookie>();\n         for (HttpCookie cookie : cookies) {\n             if (isLooselyScopedCookie(cookie, host)) {\n-                looselyScopedCookies.add(cookie);\n+                if (!ignoreList.contains(cookie.getName())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccfe3b32ae86a7f722f011f2c52754df8b315bd9"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc2NTI3Nw==", "bodyText": "This should be done in the above if, same reason as the previous comment.", "url": "https://github.com/zaproxy/zap-extensions/pull/2592#discussion_r513765277", "createdAt": "2020-10-28T21:15:07Z", "author": {"login": "thc202"}, "path": "addOns/pscanrules/src/main/java/org/zaproxy/zap/extension/pscanrules/CookieSameSiteScanRule.java", "diffHunk": "@@ -62,19 +66,30 @@ private void checkCookies(HttpMessage msg, int id, String cookieHeader) {\n         if (cookies.isEmpty()) {\n             return;\n         }\n+\n+        Set<String> ignoreList = CookieUtils.getCookieIgnoreList(getModel());\n+\n         for (String cookie : cookies) {\n             if (CookieUtils.isExpired(cookie)) {\n                 continue;\n             }\n+            boolean isInIgnoreList = ignoreList.contains(CookieUtils.getCookieName(cookie));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccfe3b32ae86a7f722f011f2c52754df8b315bd9"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7490ab8bdd2fd08e6475477c96c459fe1dc0e719", "author": {"user": null}, "url": "https://github.com/zaproxy/zap-extensions/commit/7490ab8bdd2fd08e6475477c96c459fe1dc0e719", "committedDate": "2020-10-28T21:17:06Z", "message": "Allow to ignore cookies in same site and loosely scoped scan rules\n\nSigned-off-by: Dhruvilsinh Vaghela <dhruvil.vaghela@outlook.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14af706386098966e34279087bf2470ccd80a532", "author": {"user": {"login": "dhruvil-93", "name": "Dhruvilsinh Vaghela"}}, "url": "https://github.com/zaproxy/zap-extensions/commit/14af706386098966e34279087bf2470ccd80a532", "committedDate": "2020-10-28T21:20:41Z", "message": "Fix typo in changelog. Rename newly added tests appropriately.\n\nSigned-off-by: Dhruvilsinh Vaghela <dhruvil.vaghela@outlook.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a8723e4c582b3b08b77a876e8b6f5026d166dcc", "author": {"user": {"login": "dhruvil-93", "name": "Dhruvilsinh Vaghela"}}, "url": "https://github.com/zaproxy/zap-extensions/commit/3a8723e4c582b3b08b77a876e8b6f5026d166dcc", "committedDate": "2020-10-28T21:27:33Z", "message": "Simplify condition check for ignore cookie list to avoid unnecessary processing\n\nSigned-off-by: Dhruvilsinh Vaghela <dhruvil.vaghela@outlook.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e34782d66624b99aa8eba5a6390fb35540e8dc6d", "author": {"user": {"login": "dhruvil-93", "name": "Dhruvilsinh Vaghela"}}, "url": "https://github.com/zaproxy/zap-extensions/commit/e34782d66624b99aa8eba5a6390fb35540e8dc6d", "committedDate": "2020-10-28T21:35:22Z", "message": "Code formatting\n\nSigned-off-by: Dhruvilsinh Vaghela <dhruvil.vaghela@outlook.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5MTA2MzI3", "url": "https://github.com/zaproxy/zap-extensions/pull/2592#pullrequestreview-519106327", "createdAt": "2020-10-28T21:41:23Z", "commit": {"oid": "e34782d66624b99aa8eba5a6390fb35540e8dc6d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c37a0f6377d17b6cd6aba6f0240bb80f13534243", "author": {"user": {"login": "dhruvil-93", "name": "Dhruvilsinh Vaghela"}}, "url": "https://github.com/zaproxy/zap-extensions/commit/c37a0f6377d17b6cd6aba6f0240bb80f13534243", "committedDate": "2020-10-29T08:49:43Z", "message": "Reduce nesting in conditionals as per feedback\n\nSigned-off-by: Dhruvilsinh Vaghela <dhruvil.vaghela@outlook.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94824e8d10df0fea2ed51e238995cc3568daafd7", "author": {"user": {"login": "dhruvil-93", "name": "Dhruvilsinh Vaghela"}}, "url": "https://github.com/zaproxy/zap-extensions/commit/94824e8d10df0fea2ed51e238995cc3568daafd7", "committedDate": "2020-10-29T08:59:17Z", "message": "Merge conditionals for readability\n\nSigned-off-by: Dhruvilsinh Vaghela <dhruvil.vaghela@outlook.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56a857ae7a70f9a264604a3301405aa650b68fc8", "author": {"user": {"login": "dhruvil-93", "name": "Dhruvilsinh Vaghela"}}, "url": "https://github.com/zaproxy/zap-extensions/commit/56a857ae7a70f9a264604a3301405aa650b68fc8", "committedDate": "2020-10-29T09:05:14Z", "message": "Code formatting\n\nSigned-off-by: Dhruvilsinh Vaghela <dhruvil.vaghela@outlook.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwNjY2NjUx", "url": "https://github.com/zaproxy/zap-extensions/pull/2592#pullrequestreview-520666651", "createdAt": "2020-10-30T13:29:02Z", "commit": {"oid": "56a857ae7a70f9a264604a3301405aa650b68fc8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 234, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}