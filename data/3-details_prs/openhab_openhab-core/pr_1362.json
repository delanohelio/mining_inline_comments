{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzczMTUzODAx", "number": 1362, "title": "Metadata-based state & command description providers", "bodyText": "Implements #1185.\nThese providers will look into item metadata, which\ncan be managed by UIs with the API, to set or override\nthe item's state description (pattern, options, read\nonly...) or command description.\nSigned-off-by: Yannick Schaus github@schaus.net", "createdAt": "2020-02-10T14:07:38Z", "url": "https://github.com/openhab/openhab-core/pull/1362", "merged": true, "mergeCommit": {"oid": "60e040c5296c20a0acd2d4b7e54c202f186edf7f"}, "closed": true, "closedAt": "2020-02-15T17:08:43Z", "author": {"login": "ghys"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcC9slJAH2gAyMzczMTUzODAxOmU2OTM3Yzg2YTY5NWZmZmZiZTQ5NDVhNWMxZWJiY2NmNTQ1ZTVkNGU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcEmC2UgH2gAyMzczMTUzODAxOjRkMzlhNDRjOWFjMzU2ZGI1MWExNDgyZjM1MTgwNjcyMDc3NDI3YzU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e6937c86a695ffffbe4945a5c1ebbccf545e5d4e", "author": {"user": {"login": "ghys", "name": "Yannick Schaus"}}, "url": "https://github.com/openhab/openhab-core/commit/e6937c86a695ffffbe4945a5c1ebbccf545e5d4e", "committedDate": "2020-02-10T14:06:50Z", "message": "Metadata-based state & command description providers\n\nImplements #1185.\n\nThese providers will look into item metadata, which\ncan be managed by UIs with the API, to set or override\nthe item's state description (pattern, options, read\nonly...) or command description.\n\nSigned-off-by: Yannick Schaus <github@schaus.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "237d8bd3ca6202e1c2fd394c2ef24b9ca01daacc", "author": {"user": {"login": "ghys", "name": "Yannick Schaus"}}, "url": "https://github.com/openhab/openhab-core/commit/237d8bd3ca6202e1c2fd394c2ef24b9ca01daacc", "committedDate": "2020-02-10T14:53:40Z", "message": "Support service ranking to fix itest\n\nSigned-off-by: Yannick Schaus <github@schaus.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3MDEzNDE3", "url": "https://github.com/openhab/openhab-core/pull/1362#pullrequestreview-357013417", "createdAt": "2020-02-11T21:35:41Z", "commit": {"oid": "237d8bd3ca6202e1c2fd394c2ef24b9ca01daacc"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQyMTozNTo0MlrOFoZ_1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQyMTo0MToxN1rOFoaLKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkxMzMwMA==", "bodyText": "You can add the @Reference directly in line 45 and get rid off the getter and setter methods.\nOr pass it in via constructor as you do in MetadataStateDescriptionFragmentProvider.", "url": "https://github.com/openhab/openhab-core/pull/1362#discussion_r377913300", "createdAt": "2020-02-11T21:35:42Z", "author": {"login": "kaikreuzer"}, "path": "bundles/org.openhab.core/src/main/java/org/openhab/core/internal/items/MetadataCommandDescriptionProvider.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.core.internal.items;\n+\n+import java.util.Locale;\n+import java.util.stream.Stream;\n+\n+import org.eclipse.jdt.annotation.NonNull;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.openhab.core.internal.types.CommandDescriptionImpl;\n+import org.openhab.core.items.Metadata;\n+import org.openhab.core.items.MetadataKey;\n+import org.openhab.core.items.MetadataRegistry;\n+import org.openhab.core.types.CommandDescription;\n+import org.openhab.core.types.CommandDescriptionProvider;\n+import org.openhab.core.types.CommandOption;\n+import org.osgi.service.component.annotations.Component;\n+import org.osgi.service.component.annotations.Reference;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * A {@link CommandDescription} provider from items' metadata\n+ *\n+ * @author Yannick Schaus - initial contribution\n+ *\n+ */\n+@Component(service = CommandDescriptionProvider.class)\n+public class MetadataCommandDescriptionProvider implements CommandDescriptionProvider {\n+\n+    private final Logger logger = LoggerFactory.getLogger(MetadataCommandDescriptionProvider.class);\n+\n+    public static final String COMMANDDESCRIPTION_METADATA_NAMESPACE = \"commandDescription\";\n+\n+    private MetadataRegistry metadataRegistry;\n+\n+    @Override\n+    public @Nullable CommandDescription getCommandDescription(@NonNull String itemName, @Nullable Locale locale) {\n+        Metadata metadata = metadataRegistry.get(new MetadataKey(COMMANDDESCRIPTION_METADATA_NAMESPACE, itemName));\n+\n+        if (metadata != null) {\n+            try {\n+                CommandDescriptionImpl commandDescription = new CommandDescriptionImpl();\n+                if (metadata.getConfiguration().containsKey(\"options\")) {\n+                    Stream.of(metadata.getConfiguration().get(\"options\").toString().split(\",\")).forEach(o -> {\n+                        if (o.contains(\"=\")) {\n+                            commandDescription.addCommandOption(\n+                                    new CommandOption(o.split(\"=\")[0].trim(), o.split(\"=\")[1].trim()));\n+                        } else {\n+                            commandDescription.addCommandOption(new CommandOption(o.trim(), null));\n+                        }\n+                    });\n+                }\n+\n+                return commandDescription;\n+            } catch (Exception e) {\n+                logger.error(\"Unable to parse the commandDescription from metadata for item {}\", itemName, e);\n+                return null;\n+            }\n+        }\n+\n+        return null;\n+    }\n+\n+    @Reference", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "237d8bd3ca6202e1c2fd394c2ef24b9ca01daacc"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkxNDQ0Mw==", "bodyText": "This should imho be a WARN for the user, telling him that the value is ignored. No stacktrace must be added here as we are not talking about a bug in the software.", "url": "https://github.com/openhab/openhab-core/pull/1362#discussion_r377914443", "createdAt": "2020-02-11T21:37:52Z", "author": {"login": "kaikreuzer"}, "path": "bundles/org.openhab.core/src/main/java/org/openhab/core/internal/items/MetadataStateDescriptionFragmentProvider.java", "diffHunk": "@@ -0,0 +1,151 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.core.internal.items;\n+\n+import java.math.BigDecimal;\n+import java.math.BigInteger;\n+import java.util.List;\n+import java.util.Locale;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import org.eclipse.jdt.annotation.NonNull;\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.openhab.core.items.Metadata;\n+import org.openhab.core.items.MetadataKey;\n+import org.openhab.core.items.MetadataRegistry;\n+import org.openhab.core.types.StateDescriptionFragment;\n+import org.openhab.core.types.StateDescriptionFragmentBuilder;\n+import org.openhab.core.types.StateDescriptionFragmentProvider;\n+import org.openhab.core.types.StateOption;\n+import org.osgi.framework.Constants;\n+import org.osgi.service.component.annotations.Activate;\n+import org.osgi.service.component.annotations.Component;\n+import org.osgi.service.component.annotations.Reference;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * A {@link StateDescriptionFragment} provider from items' metadata\n+ *\n+ * @author Yannick Schaus - initial contribution\n+ *\n+ */\n+@NonNullByDefault\n+@Component(service = StateDescriptionFragmentProvider.class)\n+public class MetadataStateDescriptionFragmentProvider implements StateDescriptionFragmentProvider {\n+\n+    private final Logger logger = LoggerFactory.getLogger(MetadataStateDescriptionFragmentProvider.class);\n+\n+    public static final String STATEDESCRIPTION_METADATA_NAMESPACE = \"stateDescription\";\n+\n+    private final MetadataRegistry metadataRegistry;\n+\n+    private final Integer rank;\n+\n+    @Activate\n+    public MetadataStateDescriptionFragmentProvider(final @Reference MetadataRegistry metadataRegistry,\n+            Map<String, Object> properties) {\n+        this.metadataRegistry = metadataRegistry;\n+\n+        Object serviceRanking = properties.get(Constants.SERVICE_RANKING);\n+        if (serviceRanking instanceof Integer) {\n+            rank = (Integer) serviceRanking;\n+        } else {\n+            rank = 1; // takes precedence over other providers usually ranked 0\n+        }\n+    }\n+\n+    @Override\n+    public @Nullable StateDescriptionFragment getStateDescriptionFragment(@NonNull String itemName,\n+            @Nullable Locale locale) {\n+        Metadata metadata = metadataRegistry.get(new MetadataKey(STATEDESCRIPTION_METADATA_NAMESPACE, itemName));\n+\n+        if (metadata != null) {\n+            try {\n+                StateDescriptionFragmentBuilder builder = StateDescriptionFragmentBuilder.create();\n+                if (metadata.getConfiguration().containsKey(\"pattern\")) {\n+                    builder.withPattern((String) metadata.getConfiguration().get(\"pattern\"));\n+                }\n+                if (metadata.getConfiguration().containsKey(\"min\")) {\n+                    builder.withMinimum(getBigDecimal(metadata.getConfiguration().get(\"min\")));\n+                }\n+                if (metadata.getConfiguration().containsKey(\"max\")) {\n+                    builder.withMaximum(getBigDecimal(metadata.getConfiguration().get(\"min\")));\n+                }\n+                if (metadata.getConfiguration().containsKey(\"step\")) {\n+                    builder.withStep(getBigDecimal(metadata.getConfiguration().get(\"min\")));\n+                }\n+                if (metadata.getConfiguration().containsKey(\"readOnly\")) {\n+                    builder.withReadOnly(getBoolean(metadata.getConfiguration().get(\"readOnly\")));\n+                }\n+                if (metadata.getConfiguration().containsKey(\"options\")) {\n+                    List<StateOption> stateOptions = Stream\n+                            .of(metadata.getConfiguration().get(\"options\").toString().split(\",\")).map(o -> {\n+                                return (o.contains(\"=\"))\n+                                        ? new StateOption(o.split(\"=\")[0].trim(), o.split(\"=\")[1].trim())\n+                                        : new StateOption(o.trim(), null);\n+                            }).collect(Collectors.toList());\n+                    builder.withOptions(stateOptions);\n+                }\n+\n+                return builder.build();\n+            } catch (Exception e) {\n+                logger.error(\"Unable to parse the stateDescription from metadata for item {}\", itemName, e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "237d8bd3ca6202e1c2fd394c2ef24b9ca01daacc"}, "originalPosition": 106}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkxNjIwMw==", "bodyText": "This should imho be a WARN for the user, telling him that the value is ignored. No stacktrace must be added here as we are not talking about a bug in the software.", "url": "https://github.com/openhab/openhab-core/pull/1362#discussion_r377916203", "createdAt": "2020-02-11T21:41:17Z", "author": {"login": "kaikreuzer"}, "path": "bundles/org.openhab.core/src/main/java/org/openhab/core/internal/items/MetadataCommandDescriptionProvider.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.core.internal.items;\n+\n+import java.util.Locale;\n+import java.util.stream.Stream;\n+\n+import org.eclipse.jdt.annotation.NonNull;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.openhab.core.internal.types.CommandDescriptionImpl;\n+import org.openhab.core.items.Metadata;\n+import org.openhab.core.items.MetadataKey;\n+import org.openhab.core.items.MetadataRegistry;\n+import org.openhab.core.types.CommandDescription;\n+import org.openhab.core.types.CommandDescriptionProvider;\n+import org.openhab.core.types.CommandOption;\n+import org.osgi.service.component.annotations.Component;\n+import org.osgi.service.component.annotations.Reference;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * A {@link CommandDescription} provider from items' metadata\n+ *\n+ * @author Yannick Schaus - initial contribution\n+ *\n+ */\n+@Component(service = CommandDescriptionProvider.class)\n+public class MetadataCommandDescriptionProvider implements CommandDescriptionProvider {\n+\n+    private final Logger logger = LoggerFactory.getLogger(MetadataCommandDescriptionProvider.class);\n+\n+    public static final String COMMANDDESCRIPTION_METADATA_NAMESPACE = \"commandDescription\";\n+\n+    private MetadataRegistry metadataRegistry;\n+\n+    @Override\n+    public @Nullable CommandDescription getCommandDescription(@NonNull String itemName, @Nullable Locale locale) {\n+        Metadata metadata = metadataRegistry.get(new MetadataKey(COMMANDDESCRIPTION_METADATA_NAMESPACE, itemName));\n+\n+        if (metadata != null) {\n+            try {\n+                CommandDescriptionImpl commandDescription = new CommandDescriptionImpl();\n+                if (metadata.getConfiguration().containsKey(\"options\")) {\n+                    Stream.of(metadata.getConfiguration().get(\"options\").toString().split(\",\")).forEach(o -> {\n+                        if (o.contains(\"=\")) {\n+                            commandDescription.addCommandOption(\n+                                    new CommandOption(o.split(\"=\")[0].trim(), o.split(\"=\")[1].trim()));\n+                        } else {\n+                            commandDescription.addCommandOption(new CommandOption(o.trim(), null));\n+                        }\n+                    });\n+                }\n+\n+                return commandDescription;\n+            } catch (Exception e) {\n+                logger.error(\"Unable to parse the commandDescription from metadata for item {}\", itemName, e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "237d8bd3ca6202e1c2fd394c2ef24b9ca01daacc"}, "originalPosition": 67}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f662d7c081c850934a7c962c551d039d7997c63", "author": {"user": {"login": "ghys", "name": "Yannick Schaus"}}, "url": "https://github.com/openhab/openhab-core/commit/0f662d7c081c850934a7c962c551d039d7997c63", "committedDate": "2020-02-13T01:37:17Z", "message": "Add unit tests, address review comments\n\nSigned-off-by: Yannick Schaus <github@schaus.net>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "35c839ec195ab2c933e7850d7ef17408b70141b3", "author": {"user": {"login": "ghys", "name": "Yannick Schaus"}}, "url": "https://github.com/openhab/openhab-core/commit/35c839ec195ab2c933e7850d7ef17408b70141b3", "committedDate": "2020-02-13T01:34:28Z", "message": "Add unit tests, address review comments\n\nSigned-off-by: Yannick Schaus <github@schaus.net>"}, "afterCommit": {"oid": "0f662d7c081c850934a7c962c551d039d7997c63", "author": {"user": {"login": "ghys", "name": "Yannick Schaus"}}, "url": "https://github.com/openhab/openhab-core/commit/0f662d7c081c850934a7c962c551d039d7997c63", "committedDate": "2020-02-13T01:37:17Z", "message": "Add unit tests, address review comments\n\nSigned-off-by: Yannick Schaus <github@schaus.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4NTM0MDEw", "url": "https://github.com/openhab/openhab-core/pull/1362#pullrequestreview-358534010", "createdAt": "2020-02-13T20:38:18Z", "commit": {"oid": "0f662d7c081c850934a7c962c551d039d7997c63"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QyMDozODoxOVrOFpixoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QyMDozODoxOVrOFpixoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTEwNTY5Ng==", "bodyText": "haha, it seems the unit tests have already helped ;-)", "url": "https://github.com/openhab/openhab-core/pull/1362#discussion_r379105696", "createdAt": "2020-02-13T20:38:19Z", "author": {"login": "kaikreuzer"}, "path": "bundles/org.openhab.core/src/main/java/org/openhab/core/internal/items/MetadataStateDescriptionFragmentProvider.java", "diffHunk": "@@ -83,10 +83,10 @@ public MetadataStateDescriptionFragmentProvider(final @Reference MetadataRegistr\n                     builder.withMinimum(getBigDecimal(metadata.getConfiguration().get(\"min\")));\n                 }\n                 if (metadata.getConfiguration().containsKey(\"max\")) {\n-                    builder.withMaximum(getBigDecimal(metadata.getConfiguration().get(\"min\")));\n+                    builder.withMaximum(getBigDecimal(metadata.getConfiguration().get(\"max\")));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f662d7c081c850934a7c962c551d039d7997c63"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4NTM0Mjc2", "url": "https://github.com/openhab/openhab-core/pull/1362#pullrequestreview-358534276", "createdAt": "2020-02-13T20:38:48Z", "commit": {"oid": "0f662d7c081c850934a7c962c551d039d7997c63"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d39a44c9ac356db51a1482f35180672077427c5", "author": {"user": {"login": "ghys", "name": "Yannick Schaus"}}, "url": "https://github.com/openhab/openhab-core/commit/4d39a44c9ac356db51a1482f35180672077427c5", "committedDate": "2020-02-15T15:41:17Z", "message": "Make constructor public\n\nSigned-off-by: Yannick Schaus <github@schaus.net>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4545, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}