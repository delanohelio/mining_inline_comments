{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1MDU3MjE5", "number": 1387, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOFQxMTowNDowMlrODmFmiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOFQxMToyMjo0MFrODmFqRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMjY0MjY3OnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.core.persistence/src/main/java/org/openhab/core/persistence/PersistenceService.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOFQxMTowNDowMlrOFzUiwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOFQyMDoxOTo0NVrOFzXMtw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM1ODI3Mw==", "bodyText": "I know that this PR is APIBreaking anyways but you also can add the default method implementation here:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                List<PersistenceStrategy> getDefaultStrategies();\n          \n          \n            \n                default List<PersistenceStrategy> getDefaultStrategies() {\n          \n          \n            \n                    return Collections.emptyList();\n          \n          \n            \n                }\n          \n      \n    \n    \n  \n\nBe aware of an eventually missing import.", "url": "https://github.com/openhab/openhab-core/pull/1387#discussion_r389358273", "createdAt": "2020-03-08T11:04:02Z", "author": {"login": "cweitkamp"}, "path": "bundles/org.openhab.core.persistence/src/main/java/org/openhab/core/persistence/PersistenceService.java", "diffHunk": "@@ -70,4 +72,11 @@\n      * @param alias the alias under which the item should be persisted.\n      */\n     void store(Item item, String alias);\n+\n+    /**\n+     * Provides default persistence strategies that are used for all items if no user defined configuration is found.\n+     *\n+     * @return The default persistence strategies\n+     */\n+    List<PersistenceStrategy> getDefaultStrategies();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "da4f3b99f2c858a62dfe54442bd92b4a0183a044"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQwMTc4Mw==", "bodyText": "I thought about this, but I decided against it. Problem with the default methods is that no method skeleton is created in implementing classes, so that developers are not aware that they should actually think about implementing the method.", "url": "https://github.com/openhab/openhab-core/pull/1387#discussion_r389401783", "createdAt": "2020-03-08T20:19:45Z", "author": {"login": "kaikreuzer"}, "path": "bundles/org.openhab.core.persistence/src/main/java/org/openhab/core/persistence/PersistenceService.java", "diffHunk": "@@ -70,4 +72,11 @@\n      * @param alias the alias under which the item should be persisted.\n      */\n     void store(Item item, String alias);\n+\n+    /**\n+     * Provides default persistence strategies that are used for all items if no user defined configuration is found.\n+     *\n+     * @return The default persistence strategies\n+     */\n+    List<PersistenceStrategy> getDefaultStrategies();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM1ODI3Mw=="}, "originalCommit": {"oid": "da4f3b99f2c858a62dfe54442bd92b4a0183a044"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMjY0Mjk3OnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.core.persistence/src/main/java/org/openhab/core/persistence/PersistenceFilter.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOFQxMTowNDo1MFrOFzUi4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOFQyMDozNTowMFrOFzXRRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM1ODMwNA==", "bodyText": "Should we add nullness annotations and other touched interfaces / classes?", "url": "https://github.com/openhab/openhab-core/pull/1387#discussion_r389358304", "createdAt": "2020-03-08T11:04:50Z", "author": {"login": "cweitkamp"}, "path": "bundles/org.openhab.core.persistence/src/main/java/org/openhab/core/persistence/PersistenceFilter.java", "diffHunk": "@@ -17,6 +17,6 @@\n  *\n  * @author Markus Rathgeb - Initial contribution\n  */\n-public class SimpleFilter {\n+public class PersistenceFilter {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "da4f3b99f2c858a62dfe54442bd92b4a0183a044"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQwMjk0OQ==", "bodyText": "Added.", "url": "https://github.com/openhab/openhab-core/pull/1387#discussion_r389402949", "createdAt": "2020-03-08T20:35:00Z", "author": {"login": "kaikreuzer"}, "path": "bundles/org.openhab.core.persistence/src/main/java/org/openhab/core/persistence/PersistenceFilter.java", "diffHunk": "@@ -17,6 +17,6 @@\n  *\n  * @author Markus Rathgeb - Initial contribution\n  */\n-public class SimpleFilter {\n+public class PersistenceFilter {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM1ODMwNA=="}, "originalCommit": {"oid": "da4f3b99f2c858a62dfe54442bd92b4a0183a044"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMjY0OTM3OnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.core.persistence/src/main/java/org/openhab/core/persistence/internal/PersistenceManagerImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOFQxMToxNjo1NVrOFzUmIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOFQxMToxNjo1NVrOFzUmIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM1OTEzOA==", "bodyText": "Minor spelling improvement:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                                        \"Failed to restore item states as persistence service '{}' can not be queried.\",\n          \n          \n            \n                                                        \"Failed to restore item states as persistence service '{}' cannot be queried.\",", "url": "https://github.com/openhab/openhab-core/pull/1387#discussion_r389359138", "createdAt": "2020-03-08T11:16:55Z", "author": {"login": "cweitkamp"}, "path": "bundles/org.openhab.core.persistence/src/main/java/org/openhab/core/persistence/internal/PersistenceManagerImpl.java", "diffHunk": "@@ -256,46 +261,50 @@ private boolean appliesToItem(SimpleItemConfiguration config, Item item) {\n     private void initialize(Item item) {\n         // get the last persisted state from the persistence service if no state is yet set\n         if (item.getState().equals(UnDefType.NULL) && item instanceof GenericItem) {\n-            for (Entry<String, PersistenceServiceConfiguration> entry : persistenceServiceConfigs.entrySet()) {\n+            for (Entry<String, @Nullable PersistenceServiceConfiguration> entry : persistenceServiceConfigs\n+                    .entrySet()) {\n                 final String serviceName = entry.getKey();\n                 final PersistenceServiceConfiguration config = entry.getValue();\n-                for (SimpleItemConfiguration itemConfig : config.getConfigs()) {\n-                    if (hasStrategy(config, itemConfig, SimpleStrategy.Globals.RESTORE)) {\n-                        if (appliesToItem(itemConfig, item)) {\n-                            PersistenceService service = persistenceServices.get(serviceName);\n-                            if (service instanceof QueryablePersistenceService) {\n-                                QueryablePersistenceService queryService = (QueryablePersistenceService) service;\n-                                FilterCriteria filter = new FilterCriteria().setItemName(item.getName()).setPageSize(1);\n-                                Iterable<HistoricItem> result = safeCaller\n-                                        .create(queryService, QueryablePersistenceService.class).onTimeout(() -> {\n-                                            logger.warn(\"Querying persistence service '{}' takes more than {}ms.\",\n-                                                    queryService.getId(), SafeCaller.DEFAULT_TIMEOUT);\n-                                        }).onException(e -> {\n-                                            logger.error(\n-                                                    \"Exception occurred while querying persistence service '{}': {}\",\n-                                                    queryService.getId(), e.getMessage(), e);\n-                                        }).build().query(filter);\n-                                if (result != null) {\n-                                    Iterator<HistoricItem> it = result.iterator();\n-                                    if (it.hasNext()) {\n-                                        HistoricItem historicItem = it.next();\n-                                        GenericItem genericItem = (GenericItem) item;\n-                                        genericItem.removeStateChangeListener(this);\n-                                        genericItem.setState(historicItem.getState());\n-                                        genericItem.addStateChangeListener(this);\n-                                        if (logger.isDebugEnabled()) {\n-                                            logger.debug(\"Restored item state from '{}' for item '{}' -> '{}'\",\n-                                                    DateFormat.getDateTimeInstance()\n-                                                            .format(historicItem.getTimestamp()),\n-                                                    item.getName(), historicItem.getState());\n+                if (config != null) {\n+                    for (PersistenceItemConfiguration itemConfig : config.getConfigs()) {\n+                        if (hasStrategy(config, itemConfig, PersistenceStrategy.Globals.RESTORE)) {\n+                            if (appliesToItem(itemConfig, item)) {\n+                                PersistenceService service = persistenceServices.get(serviceName);\n+                                if (service instanceof QueryablePersistenceService) {\n+                                    QueryablePersistenceService queryService = (QueryablePersistenceService) service;\n+                                    FilterCriteria filter = new FilterCriteria().setItemName(item.getName())\n+                                            .setPageSize(1);\n+                                    Iterable<HistoricItem> result = safeCaller\n+                                            .create(queryService, QueryablePersistenceService.class).onTimeout(() -> {\n+                                                logger.warn(\"Querying persistence service '{}' takes more than {}ms.\",\n+                                                        queryService.getId(), SafeCaller.DEFAULT_TIMEOUT);\n+                                            }).onException(e -> {\n+                                                logger.error(\n+                                                        \"Exception occurred while querying persistence service '{}': {}\",\n+                                                        queryService.getId(), e.getMessage(), e);\n+                                            }).build().query(filter);\n+                                    if (result != null) {\n+                                        Iterator<HistoricItem> it = result.iterator();\n+                                        if (it.hasNext()) {\n+                                            HistoricItem historicItem = it.next();\n+                                            GenericItem genericItem = (GenericItem) item;\n+                                            genericItem.removeStateChangeListener(this);\n+                                            genericItem.setState(historicItem.getState());\n+                                            genericItem.addStateChangeListener(this);\n+                                            if (logger.isDebugEnabled()) {\n+                                                logger.debug(\"Restored item state from '{}' for item '{}' -> '{}'\",\n+                                                        DateFormat.getDateTimeInstance()\n+                                                                .format(historicItem.getTimestamp()),\n+                                                        item.getName(), historicItem.getState());\n+                                            }\n+                                            return;\n                                         }\n-                                        return;\n                                     }\n+                                } else if (service != null) {\n+                                    logger.warn(\n+                                            \"Failed to restore item states as persistence service '{}' can not be queried.\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "da4f3b99f2c858a62dfe54442bd92b4a0183a044"}, "originalPosition": 226}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMjY1MjIyOnYy", "diffSide": "RIGHT", "path": "bundles/org.openhab.core.persistence/src/main/java/org/openhab/core/persistence/internal/PersistenceManagerImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOFQxMToyMjo0MFrOFzUnnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOFQxMToyMjo0MFrOFzUnnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM1OTUxNg==", "bodyText": "One liner?\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (!persistenceServiceConfigs.containsKey(persistenceService.getId())) {\n          \n          \n            \n                        persistenceServiceConfigs.put(persistenceService.getId(), getDefaultConfig(persistenceService));\n          \n          \n            \n                    }\n          \n          \n            \n                    persistenceServiceConfigs.putIfAbsent(persistenceService.getId(), getDefaultConfig(persistenceService));", "url": "https://github.com/openhab/openhab-core/pull/1387#discussion_r389359516", "createdAt": "2020-03-08T11:22:40Z", "author": {"login": "cweitkamp"}, "path": "bundles/org.openhab.core.persistence/src/main/java/org/openhab/core/persistence/internal/PersistenceManagerImpl.java", "diffHunk": "@@ -107,6 +108,9 @@ protected void deactivate() {\n     protected void addPersistenceService(PersistenceService persistenceService) {\n         logger.debug(\"Initializing {} persistence service.\", persistenceService.getId());\n         persistenceServices.put(persistenceService.getId(), persistenceService);\n+        if (!persistenceServiceConfigs.containsKey(persistenceService.getId())) {\n+            persistenceServiceConfigs.put(persistenceService.getId(), getDefaultConfig(persistenceService));\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "da4f3b99f2c858a62dfe54442bd92b4a0183a044"}, "originalPosition": 48}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3161, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}