{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAwNjEwNTc3", "number": 2343, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMVQwMToyNzo1OFrOEsVUKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMVQwMTozODoxNlrOEsVWrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0OTIyMDI0OnYy", "diffSide": "RIGHT", "path": "broker/src/main/java/org/apache/rocketmq/broker/processor/SendMessageProcessor.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMVQwMToyNzo1OFrOHfjpOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMTozNDozMFrOHgiQBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjg1MTg5OA==", "bodyText": "IMO, set properties has been done in this code MessageAccessor.setProperties(messageExtBatch, MessageDecoder.string2messageProperties(requestHeader.getProperties()));, so we don't need add a new variable named propertiesString to MessageExtBatch to do this thing.", "url": "https://github.com/apache/rocketmq/pull/2343#discussion_r502851898", "createdAt": "2020-10-11T01:27:58Z", "author": {"login": "RongtongJin"}, "path": "broker/src/main/java/org/apache/rocketmq/broker/processor/SendMessageProcessor.java", "diffHunk": "@@ -577,6 +577,7 @@ private RemotingCommand handlePutMessageResult(PutMessageResult putMessageResult\n         messageExtBatch.setFlag(requestHeader.getFlag());\n         MessageAccessor.setProperties(messageExtBatch, MessageDecoder.string2messageProperties(requestHeader.getProperties()));\n         messageExtBatch.setBody(request.getBody());\n+        messageExtBatch.setPropertiesString(requestHeader.getProperties());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18e2acc4fda9bfdfc73794cb0518653ff407cc05"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg3NzYzNw==", "bodyText": "Yes, I agree with you. My Intention was to avoid another transformation since there was already a transformed string.  I thought that MessageExtBrokerInner is out of the same consideration.", "url": "https://github.com/apache/rocketmq/pull/2343#discussion_r503877637", "createdAt": "2020-10-13T11:34:30Z", "author": {"login": "AVP42"}, "path": "broker/src/main/java/org/apache/rocketmq/broker/processor/SendMessageProcessor.java", "diffHunk": "@@ -577,6 +577,7 @@ private RemotingCommand handlePutMessageResult(PutMessageResult putMessageResult\n         messageExtBatch.setFlag(requestHeader.getFlag());\n         MessageAccessor.setProperties(messageExtBatch, MessageDecoder.string2messageProperties(requestHeader.getProperties()));\n         messageExtBatch.setBody(request.getBody());\n+        messageExtBatch.setPropertiesString(requestHeader.getProperties());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjg1MTg5OA=="}, "originalCommit": {"oid": "18e2acc4fda9bfdfc73794cb0518653ff407cc05"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0OTIyNjcxOnYy", "diffSide": "RIGHT", "path": "store/src/main/java/org/apache/rocketmq/store/CommitLog.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMVQwMTozODoxNlrOHfjsCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMTozNTo0MFrOHgiSwA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjg1MjYxNg==", "bodyText": "Just put properties of MessageExtBatch into msgBatchMemory. The original code takes the properties of a single message, so it does not exist.", "url": "https://github.com/apache/rocketmq/pull/2343#discussion_r502852616", "createdAt": "2020-10-11T01:38:16Z", "author": {"login": "RongtongJin"}, "path": "store/src/main/java/org/apache/rocketmq/store/CommitLog.java", "diffHunk": "@@ -1871,9 +1878,13 @@ public ByteBuffer encode(final MessageExtBatch messageExtBatch) {\n                 this.msgBatchMemory.put((byte) topicLength);\n                 this.msgBatchMemory.put(topicData);\n                 // 17 PROPERTIES\n-                this.msgBatchMemory.putShort(propertiesLen);\n-                if (propertiesLen > 0)\n+                this.msgBatchMemory.putShort((short) (propertiesLen + batchPropLen));\n+                if (propertiesLen > 0) {\n                     this.msgBatchMemory.put(messagesByteBuff.array(), propertiesPos, propertiesLen);\n+                }\n+                if (batchPropLen > 0) {\n+                    this.msgBatchMemory.put(batchPropData, 0, batchPropLen);\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18e2acc4fda9bfdfc73794cb0518653ff407cc05"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg3ODMzNg==", "bodyText": "Sure.", "url": "https://github.com/apache/rocketmq/pull/2343#discussion_r503878336", "createdAt": "2020-10-13T11:35:40Z", "author": {"login": "AVP42"}, "path": "store/src/main/java/org/apache/rocketmq/store/CommitLog.java", "diffHunk": "@@ -1871,9 +1878,13 @@ public ByteBuffer encode(final MessageExtBatch messageExtBatch) {\n                 this.msgBatchMemory.put((byte) topicLength);\n                 this.msgBatchMemory.put(topicData);\n                 // 17 PROPERTIES\n-                this.msgBatchMemory.putShort(propertiesLen);\n-                if (propertiesLen > 0)\n+                this.msgBatchMemory.putShort((short) (propertiesLen + batchPropLen));\n+                if (propertiesLen > 0) {\n                     this.msgBatchMemory.put(messagesByteBuff.array(), propertiesPos, propertiesLen);\n+                }\n+                if (batchPropLen > 0) {\n+                    this.msgBatchMemory.put(batchPropData, 0, batchPropLen);\n+                }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjg1MjYxNg=="}, "originalCommit": {"oid": "18e2acc4fda9bfdfc73794cb0518653ff407cc05"}, "originalPosition": 35}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1645, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}