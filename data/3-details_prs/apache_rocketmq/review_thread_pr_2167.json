{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUwMTgwNDI4", "number": 2167, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxMjowMjowNVrOEsBMyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwMDo0MTo1NlrOEtReuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0NTkyNDU2OnYy", "diffSide": "RIGHT", "path": "client/src/main/java/org/apache/rocketmq/client/impl/factory/MQClientInstance.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxMjowMjowNVrOHfGzag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxNjowNDozM1rOHfQDgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM3OTM3MA==", "bodyText": "why just choose the concrete index 2 while not 3, 4 or other if size > 2? Is there any optimized space, image if the first follower also not available?", "url": "https://github.com/apache/rocketmq/pull/2167#discussion_r502379370", "createdAt": "2020-10-09T12:02:05Z", "author": {"login": "vongosling"}, "path": "client/src/main/java/org/apache/rocketmq/client/impl/factory/MQClientInstance.java", "diffHunk": "@@ -1044,9 +1044,14 @@ public FindBrokerResult findBrokerAddressInSubscribe(\n             found = brokerAddr != null;\n \n             if (!found && !onlyThisBroker) {\n-                Entry<Long, String> entry = map.entrySet().iterator().next();\n-                brokerAddr = entry.getValue();\n-                slave = entry.getKey() != MixAll.MASTER_ID;\n+                if (brokerId == 1 && map.size() > 2) {\n+                    brokerAddr = map.get(2L);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d747e8a4ba0f0078bb91e65a47162872a9d6f1bd"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUzMDk0NQ==", "bodyText": "I agree with u, I'will try to find a more elegant way.", "url": "https://github.com/apache/rocketmq/pull/2167#discussion_r502530945", "createdAt": "2020-10-09T16:04:33Z", "author": {"login": "maixiaohai"}, "path": "client/src/main/java/org/apache/rocketmq/client/impl/factory/MQClientInstance.java", "diffHunk": "@@ -1044,9 +1044,14 @@ public FindBrokerResult findBrokerAddressInSubscribe(\n             found = brokerAddr != null;\n \n             if (!found && !onlyThisBroker) {\n-                Entry<Long, String> entry = map.entrySet().iterator().next();\n-                brokerAddr = entry.getValue();\n-                slave = entry.getKey() != MixAll.MASTER_ID;\n+                if (brokerId == 1 && map.size() > 2) {\n+                    brokerAddr = map.get(2L);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM3OTM3MA=="}, "originalCommit": {"oid": "d747e8a4ba0f0078bb91e65a47162872a9d6f1bd"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0NTkyOTQ4OnYy", "diffSide": "RIGHT", "path": "client/src/test/java/org/apache/rocketmq/client/impl/factory/MQClientInstanceTest.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxMjowMzo1MFrOHfG2Tg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMFQwMTo0MTo1N1rOHfcMZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM4MDExMA==", "bodyText": "Is there any difference in your test case?(0,1,2 vs 0,2,3)", "url": "https://github.com/apache/rocketmq/pull/2167#discussion_r502380110", "createdAt": "2020-10-09T12:03:50Z", "author": {"login": "vongosling"}, "path": "client/src/test/java/org/apache/rocketmq/client/impl/factory/MQClientInstanceTest.java", "diffHunk": "@@ -74,6 +87,34 @@ public void testTopicRouteData2TopicPublishInfo() {\n         assertThat(topicPublishInfo.getMessageQueueList().size()).isEqualTo(4);\n     }\n \n+    @Test\n+    public void testFindBrokerAddressInSubscribe() {\n+        // dledger normal case\n+        String brokerName = \"BrokerA\";\n+        HashMap<Long, String> addrMap = new HashMap<Long, String>();\n+        addrMap.put(0L, \"127.0.0.1:10911\");\n+        addrMap.put(1L, \"127.0.0.1:10912\");\n+        addrMap.put(2L, \"127.0.0.1:10913\");\n+        brokerAddrTable.put(brokerName, addrMap);\n+        long brokerId = 1;\n+        FindBrokerResult brokerResult = mqClientInstance.findBrokerAddressInSubscribe(brokerName, brokerId, false);\n+        assertThat(brokerResult).isNotNull();\n+        assertThat(brokerResult.getBrokerAddr()).isEqualTo(\"127.0.0.1:10912\");\n+        assertThat(brokerResult.isSlave()).isTrue();\n+\n+        // dledger case, when node n0 was voted as the leader\n+        brokerName = \"BrokerB\";\n+        HashMap<Long, String> addrMapNew = new HashMap<Long, String>();\n+        addrMapNew.put(0L, \"127.0.0.1:10911\");\n+        addrMapNew.put(2L, \"127.0.0.1:10912\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d747e8a4ba0f0078bb91e65a47162872a9d6f1bd"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUzMzA2Ng==", "bodyText": "(0,1,2) is the normal case, which is added to check my code and also for the future changes from others. IMO, it can improve the coverage of UT.\n(0,2,3) is the \"bugfix\" case, which is added to check if my code fix the bug.", "url": "https://github.com/apache/rocketmq/pull/2167#discussion_r502533066", "createdAt": "2020-10-09T16:08:17Z", "author": {"login": "maixiaohai"}, "path": "client/src/test/java/org/apache/rocketmq/client/impl/factory/MQClientInstanceTest.java", "diffHunk": "@@ -74,6 +87,34 @@ public void testTopicRouteData2TopicPublishInfo() {\n         assertThat(topicPublishInfo.getMessageQueueList().size()).isEqualTo(4);\n     }\n \n+    @Test\n+    public void testFindBrokerAddressInSubscribe() {\n+        // dledger normal case\n+        String brokerName = \"BrokerA\";\n+        HashMap<Long, String> addrMap = new HashMap<Long, String>();\n+        addrMap.put(0L, \"127.0.0.1:10911\");\n+        addrMap.put(1L, \"127.0.0.1:10912\");\n+        addrMap.put(2L, \"127.0.0.1:10913\");\n+        brokerAddrTable.put(brokerName, addrMap);\n+        long brokerId = 1;\n+        FindBrokerResult brokerResult = mqClientInstance.findBrokerAddressInSubscribe(brokerName, brokerId, false);\n+        assertThat(brokerResult).isNotNull();\n+        assertThat(brokerResult.getBrokerAddr()).isEqualTo(\"127.0.0.1:10912\");\n+        assertThat(brokerResult.isSlave()).isTrue();\n+\n+        // dledger case, when node n0 was voted as the leader\n+        brokerName = \"BrokerB\";\n+        HashMap<Long, String> addrMapNew = new HashMap<Long, String>();\n+        addrMapNew.put(0L, \"127.0.0.1:10911\");\n+        addrMapNew.put(2L, \"127.0.0.1:10912\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM4MDExMA=="}, "originalCommit": {"oid": "d747e8a4ba0f0078bb91e65a47162872a9d6f1bd"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjcyOTgyOQ==", "bodyText": "Please go ahead, I would like to follow your pr :-)", "url": "https://github.com/apache/rocketmq/pull/2167#discussion_r502729829", "createdAt": "2020-10-10T01:41:57Z", "author": {"login": "vongosling"}, "path": "client/src/test/java/org/apache/rocketmq/client/impl/factory/MQClientInstanceTest.java", "diffHunk": "@@ -74,6 +87,34 @@ public void testTopicRouteData2TopicPublishInfo() {\n         assertThat(topicPublishInfo.getMessageQueueList().size()).isEqualTo(4);\n     }\n \n+    @Test\n+    public void testFindBrokerAddressInSubscribe() {\n+        // dledger normal case\n+        String brokerName = \"BrokerA\";\n+        HashMap<Long, String> addrMap = new HashMap<Long, String>();\n+        addrMap.put(0L, \"127.0.0.1:10911\");\n+        addrMap.put(1L, \"127.0.0.1:10912\");\n+        addrMap.put(2L, \"127.0.0.1:10913\");\n+        brokerAddrTable.put(brokerName, addrMap);\n+        long brokerId = 1;\n+        FindBrokerResult brokerResult = mqClientInstance.findBrokerAddressInSubscribe(brokerName, brokerId, false);\n+        assertThat(brokerResult).isNotNull();\n+        assertThat(brokerResult.getBrokerAddr()).isEqualTo(\"127.0.0.1:10912\");\n+        assertThat(brokerResult.isSlave()).isTrue();\n+\n+        // dledger case, when node n0 was voted as the leader\n+        brokerName = \"BrokerB\";\n+        HashMap<Long, String> addrMapNew = new HashMap<Long, String>();\n+        addrMapNew.put(0L, \"127.0.0.1:10911\");\n+        addrMapNew.put(2L, \"127.0.0.1:10912\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM4MDExMA=="}, "originalCommit": {"oid": "d747e8a4ba0f0078bb91e65a47162872a9d6f1bd"}, "originalPosition": 63}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE1OTA3NDQ1OnYy", "diffSide": "RIGHT", "path": "client/src/test/java/org/apache/rocketmq/client/impl/factory/MQClientInstanceTest.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwMDo0MDoxMFrOHg-MAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQwNjoyMDo1MlrOHhyklQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMzNTM2MQ==", "bodyText": "mockito and jmockit has native support for the reflection", "url": "https://github.com/apache/rocketmq/pull/2167#discussion_r504335361", "createdAt": "2020-10-14T00:40:10Z", "author": {"login": "vongosling"}, "path": "client/src/test/java/org/apache/rocketmq/client/impl/factory/MQClientInstanceTest.java", "diffHunk": "@@ -42,6 +47,14 @@\n     private MQClientInstance mqClientInstance = MQClientManager.getInstance().getOrCreateMQClientInstance(new ClientConfig());\n     private String topic = \"FooBar\";\n     private String group = \"FooBarGroup\";\n+    private ConcurrentMap<String, HashMap<Long, String>> brokerAddrTable = new ConcurrentHashMap<String, HashMap<Long, String>>();\n+\n+    @Before\n+    public void init() throws Exception {\n+        Field field = MQClientInstance.class.getDeclaredField(\"brokerAddrTable\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "593f3fca444ba4e56c82441c41c22332057570cb"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDM4MDQ5OA==", "bodyText": "done", "url": "https://github.com/apache/rocketmq/pull/2167#discussion_r504380498", "createdAt": "2020-10-14T03:34:49Z", "author": {"login": "maixiaohai"}, "path": "client/src/test/java/org/apache/rocketmq/client/impl/factory/MQClientInstanceTest.java", "diffHunk": "@@ -42,6 +47,14 @@\n     private MQClientInstance mqClientInstance = MQClientManager.getInstance().getOrCreateMQClientInstance(new ClientConfig());\n     private String topic = \"FooBar\";\n     private String group = \"FooBarGroup\";\n+    private ConcurrentMap<String, HashMap<Long, String>> brokerAddrTable = new ConcurrentHashMap<String, HashMap<Long, String>>();\n+\n+    @Before\n+    public void init() throws Exception {\n+        Field field = MQClientInstance.class.getDeclaredField(\"brokerAddrTable\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMzNTM2MQ=="}, "originalCommit": {"oid": "593f3fca444ba4e56c82441c41c22332057570cb"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTEzNjU2Ng==", "bodyText": "My idea was to remind you to use jmockit's built-in reflection method to mock private implementation. For some tools, do not use the internal package. These codes are created mainly by its usage, which is not suitable for direct import in projects. This is good practice. For this problem, The value of the two implementations\uff08mock or inject reflection\uff09 is not much different. I hope you could pay attention to this point in the future :-)", "url": "https://github.com/apache/rocketmq/pull/2167#discussion_r505136566", "createdAt": "2020-10-15T03:03:02Z", "author": {"login": "vongosling"}, "path": "client/src/test/java/org/apache/rocketmq/client/impl/factory/MQClientInstanceTest.java", "diffHunk": "@@ -42,6 +47,14 @@\n     private MQClientInstance mqClientInstance = MQClientManager.getInstance().getOrCreateMQClientInstance(new ClientConfig());\n     private String topic = \"FooBar\";\n     private String group = \"FooBarGroup\";\n+    private ConcurrentMap<String, HashMap<Long, String>> brokerAddrTable = new ConcurrentHashMap<String, HashMap<Long, String>>();\n+\n+    @Before\n+    public void init() throws Exception {\n+        Field field = MQClientInstance.class.getDeclaredField(\"brokerAddrTable\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMzNTM2MQ=="}, "originalCommit": {"oid": "593f3fca444ba4e56c82441c41c22332057570cb"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTE5MzYyMQ==", "bodyText": "Thanks for your reminding\uff01I will pay attention to it.", "url": "https://github.com/apache/rocketmq/pull/2167#discussion_r505193621", "createdAt": "2020-10-15T06:20:52Z", "author": {"login": "maixiaohai"}, "path": "client/src/test/java/org/apache/rocketmq/client/impl/factory/MQClientInstanceTest.java", "diffHunk": "@@ -42,6 +47,14 @@\n     private MQClientInstance mqClientInstance = MQClientManager.getInstance().getOrCreateMQClientInstance(new ClientConfig());\n     private String topic = \"FooBar\";\n     private String group = \"FooBarGroup\";\n+    private ConcurrentMap<String, HashMap<Long, String>> brokerAddrTable = new ConcurrentHashMap<String, HashMap<Long, String>>();\n+\n+    @Before\n+    public void init() throws Exception {\n+        Field field = MQClientInstance.class.getDeclaredField(\"brokerAddrTable\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMzNTM2MQ=="}, "originalCommit": {"oid": "593f3fca444ba4e56c82441c41c22332057570cb"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE1OTA3NzY5OnYy", "diffSide": "RIGHT", "path": "client/src/main/java/org/apache/rocketmq/client/impl/factory/MQClientInstance.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwMDo0MTo1NlrOHg-N3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwMjoyOTowOVrOHg_4Ig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMzNTgzNw==", "bodyText": "How do we handle if the slave has happened to become a master?", "url": "https://github.com/apache/rocketmq/pull/2167#discussion_r504335837", "createdAt": "2020-10-14T00:41:56Z", "author": {"login": "vongosling"}, "path": "client/src/main/java/org/apache/rocketmq/client/impl/factory/MQClientInstance.java", "diffHunk": "@@ -1043,6 +1043,11 @@ public FindBrokerResult findBrokerAddressInSubscribe(\n             slave = brokerId != MixAll.MASTER_ID;\n             found = brokerAddr != null;\n \n+            if (!found && slave) {\n+                brokerAddr = map.get(brokerId + 1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "593f3fca444ba4e56c82441c41c22332057570cb"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDM2MzA0Mg==", "bodyText": "The broker id will change as dledger role change.\nIf it happended to be the temporary state, the request will return error code, and client will refresh addr tables", "url": "https://github.com/apache/rocketmq/pull/2167#discussion_r504363042", "createdAt": "2020-10-14T02:29:09Z", "author": {"login": "maixiaohai"}, "path": "client/src/main/java/org/apache/rocketmq/client/impl/factory/MQClientInstance.java", "diffHunk": "@@ -1043,6 +1043,11 @@ public FindBrokerResult findBrokerAddressInSubscribe(\n             slave = brokerId != MixAll.MASTER_ID;\n             found = brokerAddr != null;\n \n+            if (!found && slave) {\n+                brokerAddr = map.get(brokerId + 1);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMzNTgzNw=="}, "originalCommit": {"oid": "593f3fca444ba4e56c82441c41c22332057570cb"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1677, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}