{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUwMTgwNDI4", "number": 2167, "title": "[ISSUE #2165] Slave read enable not work sometimes When cluster deployed on DLedger mode", "bodyText": "What is the purpose of the change\nissue #2165\nBrief changelog\n1.when brokerId not found and read from slave, use brokerId + 1 as the key\n2.add unit test\nVerifying this change\nXXXX\nFollow this checklist to help us incorporate your contribution quickly and easily. Notice, it would be helpful if you could finish the following 5 checklist(the last one is not necessary)before request the community to review your PR.\n\n Make sure there is a Github issue filed for the change (usually before you start working on it). Trivial changes like typos do not require a Github issue. Your pull request should address just this issue, without pulling in other changes - one PR resolves one issue.\n Format the pull request title like [ISSUE #123] Fix UnknownException when host config not exist. Each commit in the pull request should have a meaningful subject line and body.\n Write a pull request description that is detailed enough to understand what the pull request does, how, and why.\n Write necessary unit-test(over 80% coverage) to verify your logic correction, more mock a little better when cross module dependency exist. If the new feature or significant change is committed, please remember to add integration-test in test module.\n Run mvn -B clean apache-rat:check findbugs:findbugs checkstyle:checkstyle to make sure basic checks pass. Run mvn clean install -DskipITs to make sure unit-test pass. Run mvn clean test-compile failsafe:integration-test  to make sure integration-test pass.\n If this contribution is large, please file an Apache Individual Contributor License Agreement.", "createdAt": "2020-07-16T13:06:23Z", "url": "https://github.com/apache/rocketmq/pull/2167", "merged": true, "mergeCommit": {"oid": "d5cb67ff802c5d92ba8b42f0a0ebe94a05eb9965"}, "closed": true, "closedAt": "2020-10-15T03:04:19Z", "author": {"login": "maixiaohai"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc1e4YMAH2gAyNDUwMTgwNDI4OjM3M2Y2NDUxYzM2MGRhYTkzMGU2MTkwMTljMjM1NDhmYWZjYmQ1ZGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSUq00gH2gAyNDUwMTgwNDI4OjhjYmI3MDlmYTJiOWU3ZWYyNWFlNTk1ZGE2YjNhOTE5YTU5ZjQ4MTc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "373f6451c360daa930e619019c23548fafcbd5dd", "author": {"user": null}, "url": "https://github.com/apache/rocketmq/commit/373f6451c360daa930e619019c23548fafcbd5dd", "committedDate": "2020-07-16T13:02:48Z", "message": "[Client] Fix slaveReadEnable=true not work sometimes When cluster deployed on DLedger mode"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a7f802b8efedbe69605d09145968814df6b5dbb", "author": {"user": null}, "url": "https://github.com/apache/rocketmq/commit/0a7f802b8efedbe69605d09145968814df6b5dbb", "committedDate": "2020-07-16T13:03:04Z", "message": "[Client] Add unit test for findBrokerAddressInSubscribe"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d747e8a4ba0f0078bb91e65a47162872a9d6f1bd", "author": {"user": null}, "url": "https://github.com/apache/rocketmq/commit/d747e8a4ba0f0078bb91e65a47162872a9d6f1bd", "committedDate": "2020-07-17T02:05:12Z", "message": "refine unit test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1MjU5Njg2", "url": "https://github.com/apache/rocketmq/pull/2167#pullrequestreview-505259686", "createdAt": "2020-10-09T00:18:09Z", "commit": {"oid": "d747e8a4ba0f0078bb91e65a47162872a9d6f1bd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1NjA4MTUz", "url": "https://github.com/apache/rocketmq/pull/2167#pullrequestreview-505608153", "createdAt": "2020-10-09T12:02:05Z", "commit": {"oid": "d747e8a4ba0f0078bb91e65a47162872a9d6f1bd"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxMjowMjowNVrOHfGzag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxMjowMzo1MFrOHfG2Tg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM3OTM3MA==", "bodyText": "why just choose the concrete index 2 while not 3, 4 or other if size > 2? Is there any optimized space, image if the first follower also not available?", "url": "https://github.com/apache/rocketmq/pull/2167#discussion_r502379370", "createdAt": "2020-10-09T12:02:05Z", "author": {"login": "vongosling"}, "path": "client/src/main/java/org/apache/rocketmq/client/impl/factory/MQClientInstance.java", "diffHunk": "@@ -1044,9 +1044,14 @@ public FindBrokerResult findBrokerAddressInSubscribe(\n             found = brokerAddr != null;\n \n             if (!found && !onlyThisBroker) {\n-                Entry<Long, String> entry = map.entrySet().iterator().next();\n-                brokerAddr = entry.getValue();\n-                slave = entry.getKey() != MixAll.MASTER_ID;\n+                if (brokerId == 1 && map.size() > 2) {\n+                    brokerAddr = map.get(2L);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d747e8a4ba0f0078bb91e65a47162872a9d6f1bd"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM4MDExMA==", "bodyText": "Is there any difference in your test case?(0,1,2 vs 0,2,3)", "url": "https://github.com/apache/rocketmq/pull/2167#discussion_r502380110", "createdAt": "2020-10-09T12:03:50Z", "author": {"login": "vongosling"}, "path": "client/src/test/java/org/apache/rocketmq/client/impl/factory/MQClientInstanceTest.java", "diffHunk": "@@ -74,6 +87,34 @@ public void testTopicRouteData2TopicPublishInfo() {\n         assertThat(topicPublishInfo.getMessageQueueList().size()).isEqualTo(4);\n     }\n \n+    @Test\n+    public void testFindBrokerAddressInSubscribe() {\n+        // dledger normal case\n+        String brokerName = \"BrokerA\";\n+        HashMap<Long, String> addrMap = new HashMap<Long, String>();\n+        addrMap.put(0L, \"127.0.0.1:10911\");\n+        addrMap.put(1L, \"127.0.0.1:10912\");\n+        addrMap.put(2L, \"127.0.0.1:10913\");\n+        brokerAddrTable.put(brokerName, addrMap);\n+        long brokerId = 1;\n+        FindBrokerResult brokerResult = mqClientInstance.findBrokerAddressInSubscribe(brokerName, brokerId, false);\n+        assertThat(brokerResult).isNotNull();\n+        assertThat(brokerResult.getBrokerAddr()).isEqualTo(\"127.0.0.1:10912\");\n+        assertThat(brokerResult.isSlave()).isTrue();\n+\n+        // dledger case, when node n0 was voted as the leader\n+        brokerName = \"BrokerB\";\n+        HashMap<Long, String> addrMapNew = new HashMap<Long, String>();\n+        addrMapNew.put(0L, \"127.0.0.1:10911\");\n+        addrMapNew.put(2L, \"127.0.0.1:10912\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d747e8a4ba0f0078bb91e65a47162872a9d6f1bd"}, "originalPosition": 63}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5dd7a3e4e59e81ee97509ec672b7e42900bf1678", "author": {"user": null}, "url": "https://github.com/apache/rocketmq/commit/5dd7a3e4e59e81ee97509ec672b7e42900bf1678", "committedDate": "2020-10-12T06:10:53Z", "message": "update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "593f3fca444ba4e56c82441c41c22332057570cb", "author": {"user": null}, "url": "https://github.com/apache/rocketmq/commit/593f3fca444ba4e56c82441c41c22332057570cb", "committedDate": "2020-10-13T14:00:02Z", "message": "refine"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3OTE5OTA4", "url": "https://github.com/apache/rocketmq/pull/2167#pullrequestreview-507919908", "createdAt": "2020-10-14T00:40:10Z", "commit": {"oid": "593f3fca444ba4e56c82441c41c22332057570cb"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwMDo0MDoxMFrOHg-MAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwMDo0MTo1NlrOHg-N3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMzNTM2MQ==", "bodyText": "mockito and jmockit has native support for the reflection", "url": "https://github.com/apache/rocketmq/pull/2167#discussion_r504335361", "createdAt": "2020-10-14T00:40:10Z", "author": {"login": "vongosling"}, "path": "client/src/test/java/org/apache/rocketmq/client/impl/factory/MQClientInstanceTest.java", "diffHunk": "@@ -42,6 +47,14 @@\n     private MQClientInstance mqClientInstance = MQClientManager.getInstance().getOrCreateMQClientInstance(new ClientConfig());\n     private String topic = \"FooBar\";\n     private String group = \"FooBarGroup\";\n+    private ConcurrentMap<String, HashMap<Long, String>> brokerAddrTable = new ConcurrentHashMap<String, HashMap<Long, String>>();\n+\n+    @Before\n+    public void init() throws Exception {\n+        Field field = MQClientInstance.class.getDeclaredField(\"brokerAddrTable\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "593f3fca444ba4e56c82441c41c22332057570cb"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMzNTgzNw==", "bodyText": "How do we handle if the slave has happened to become a master?", "url": "https://github.com/apache/rocketmq/pull/2167#discussion_r504335837", "createdAt": "2020-10-14T00:41:56Z", "author": {"login": "vongosling"}, "path": "client/src/main/java/org/apache/rocketmq/client/impl/factory/MQClientInstance.java", "diffHunk": "@@ -1043,6 +1043,11 @@ public FindBrokerResult findBrokerAddressInSubscribe(\n             slave = brokerId != MixAll.MASTER_ID;\n             found = brokerAddr != null;\n \n+            if (!found && slave) {\n+                brokerAddr = map.get(brokerId + 1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "593f3fca444ba4e56c82441c41c22332057570cb"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8b0044ddf766bbdedb7d76dbf4841ea050fb75e", "author": {"user": null}, "url": "https://github.com/apache/rocketmq/commit/f8b0044ddf766bbdedb7d76dbf4841ea050fb75e", "committedDate": "2020-10-14T03:31:13Z", "message": "refine UT code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8cbb709fa2b9e7ef25ae595da6b3a919a59f4817", "author": {"user": null}, "url": "https://github.com/apache/rocketmq/commit/8cbb709fa2b9e7ef25ae595da6b3a919a59f4817", "committedDate": "2020-10-14T03:32:45Z", "message": "Merge branch 'slave_read_enable_not_work_sometimes' of https://github.com/maixiaohai/rocketmq into slave_read_enable_not_work_sometimes"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4947, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}