{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk2ODY5NzU1", "number": 1040, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxMzowNDoxMFrOEpzk8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxMzowNDoyOVrOEpzlTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMjcyMTEyOnYy", "diffSide": "RIGHT", "path": "engine/src/test/java/org/camunda/bpm/engine/test/api/mgmt/telemetry/TelemetryReporterTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxMzowNDoxMFrOHbszMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxMzoyODo1MFrOHbtoxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODgwNzYwMA==", "bodyText": "Do we need new test cases for this or should we simply integrate this into the other test cases directly above (in the end, they simply make it more specific that initial data should only be sent once)?", "url": "https://github.com/camunda/camunda-bpm-platform/pull/1040#discussion_r498807600", "createdAt": "2020-10-02T13:04:10Z", "author": {"login": "tmetzke"}, "path": "engine/src/test/java/org/camunda/bpm/engine/test/api/mgmt/telemetry/TelemetryReporterTest.java", "diffHunk": "@@ -315,6 +357,76 @@ public void shouldReportInitialDataWhenReporterActivatedAndInitTelemetryEnabled(\n               .withHeader(\"Content-Type\",  equalTo(\"application/json\")));\n   }\n \n+  @Test\n+  public void shouldReportInitialDataOnceInitTelemetryUndefined() {\n+    // given\n+    ProcessEngineConfigurationImpl processEngineConfiguration = createEngineWithInitMessage(null);\n+    stubFor(post(urlEqualTo(TELEMETRY_ENDPOINT_PATH))\n+            .willReturn(aResponse()\n+                        .withStatus(HttpURLConnection.HTTP_ACCEPTED)));\n+\n+    Data expectedData = createInitialDataToSend(processEngineConfiguration.getTelemetryData(), null);\n+    String requestBody = new Gson().toJson(expectedData);\n+\n+    // when\n+    processEngineConfiguration.getTelemetryReporter().reportNow();\n+    standaloneProcessEngine.close();\n+    standaloneProcessEngine = null;\n+\n+    // then\n+    verify(1, postRequestedFor(urlEqualTo(TELEMETRY_ENDPOINT_PATH))\n+              .withRequestBody(equalToJson(requestBody, JSONCompareMode.LENIENT))\n+              .withHeader(\"Content-Type\",  equalTo(\"application/json\")));\n+  }\n+\n+\n+  @Test\n+  public void shouldReportInitialDataOnceInitTelemetryDisabled() {\n+    // given\n+    ProcessEngineConfigurationImpl processEngineConfiguration = createEngineWithInitMessage(false);\n+    stubFor(post(urlEqualTo(TELEMETRY_ENDPOINT_PATH))\n+            .willReturn(aResponse()\n+                        .withStatus(HttpURLConnection.HTTP_ACCEPTED)));\n+\n+    Data expectedData = createInitialDataToSend(processEngineConfiguration.getTelemetryData(), false);\n+    String requestBody = new Gson().toJson(expectedData);\n+\n+    // when\n+    processEngineConfiguration.getTelemetryReporter().reportNow();\n+    standaloneProcessEngine.close();\n+    standaloneProcessEngine = null;\n+\n+    // then\n+    verify(1, postRequestedFor(urlEqualTo(TELEMETRY_ENDPOINT_PATH))\n+              .withRequestBody(equalToJson(requestBody, JSONCompareMode.LENIENT))\n+              .withHeader(\"Content-Type\",  equalTo(\"application/json\")));\n+  }\n+\n+  @Test\n+  @WatchLogger(loggerNames = {\"org.camunda.bpm.engine.telemetry\"}, level = \"DEBUG\")\n+  public void shouldReportInitialDataOnceInitTelemetryEnabled() {\n+    // given\n+    ProcessEngineConfigurationImpl processEngineConfiguration = createEngineWithInitMessage(true);\n+    stubFor(post(urlEqualTo(TELEMETRY_ENDPOINT_PATH))\n+            .willReturn(aResponse()\n+                        .withStatus(HttpURLConnection.HTTP_ACCEPTED)));\n+\n+    Data expectedData = createInitialDataToSend(processEngineConfiguration.getTelemetryData(), true);\n+    String requestBody = new Gson().toJson(expectedData);\n+\n+    // when\n+    processEngineConfiguration.getTelemetryReporter().reportNow();\n+    standaloneProcessEngine.close();\n+    standaloneProcessEngine = null;\n+\n+    // then\n+    verify(3, postRequestedFor(urlEqualTo(TELEMETRY_ENDPOINT_PATH))\n+              .withRequestBody(equalToJson(requestBody, JSONCompareMode.LENIENT))\n+              .withHeader(\"Content-Type\",  equalTo(\"application/json\")));\n+    assertThat(loggingRule.getFilteredLog(\"Sending initial telemetry data\").size()).isOne();\n+    assertThat(loggingRule.getFilteredLog(\"Initial telemetry request was successful.\").size()).isOne();\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85882c496778568a24daffaa687dd6f2ab4b7da8"}, "originalPosition": 146}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODgyMTMxOA==", "bodyText": "Now I spotted the difference! Cool, let's keep them \ud83d\udc4d", "url": "https://github.com/camunda/camunda-bpm-platform/pull/1040#discussion_r498821318", "createdAt": "2020-10-02T13:28:50Z", "author": {"login": "tmetzke"}, "path": "engine/src/test/java/org/camunda/bpm/engine/test/api/mgmt/telemetry/TelemetryReporterTest.java", "diffHunk": "@@ -315,6 +357,76 @@ public void shouldReportInitialDataWhenReporterActivatedAndInitTelemetryEnabled(\n               .withHeader(\"Content-Type\",  equalTo(\"application/json\")));\n   }\n \n+  @Test\n+  public void shouldReportInitialDataOnceInitTelemetryUndefined() {\n+    // given\n+    ProcessEngineConfigurationImpl processEngineConfiguration = createEngineWithInitMessage(null);\n+    stubFor(post(urlEqualTo(TELEMETRY_ENDPOINT_PATH))\n+            .willReturn(aResponse()\n+                        .withStatus(HttpURLConnection.HTTP_ACCEPTED)));\n+\n+    Data expectedData = createInitialDataToSend(processEngineConfiguration.getTelemetryData(), null);\n+    String requestBody = new Gson().toJson(expectedData);\n+\n+    // when\n+    processEngineConfiguration.getTelemetryReporter().reportNow();\n+    standaloneProcessEngine.close();\n+    standaloneProcessEngine = null;\n+\n+    // then\n+    verify(1, postRequestedFor(urlEqualTo(TELEMETRY_ENDPOINT_PATH))\n+              .withRequestBody(equalToJson(requestBody, JSONCompareMode.LENIENT))\n+              .withHeader(\"Content-Type\",  equalTo(\"application/json\")));\n+  }\n+\n+\n+  @Test\n+  public void shouldReportInitialDataOnceInitTelemetryDisabled() {\n+    // given\n+    ProcessEngineConfigurationImpl processEngineConfiguration = createEngineWithInitMessage(false);\n+    stubFor(post(urlEqualTo(TELEMETRY_ENDPOINT_PATH))\n+            .willReturn(aResponse()\n+                        .withStatus(HttpURLConnection.HTTP_ACCEPTED)));\n+\n+    Data expectedData = createInitialDataToSend(processEngineConfiguration.getTelemetryData(), false);\n+    String requestBody = new Gson().toJson(expectedData);\n+\n+    // when\n+    processEngineConfiguration.getTelemetryReporter().reportNow();\n+    standaloneProcessEngine.close();\n+    standaloneProcessEngine = null;\n+\n+    // then\n+    verify(1, postRequestedFor(urlEqualTo(TELEMETRY_ENDPOINT_PATH))\n+              .withRequestBody(equalToJson(requestBody, JSONCompareMode.LENIENT))\n+              .withHeader(\"Content-Type\",  equalTo(\"application/json\")));\n+  }\n+\n+  @Test\n+  @WatchLogger(loggerNames = {\"org.camunda.bpm.engine.telemetry\"}, level = \"DEBUG\")\n+  public void shouldReportInitialDataOnceInitTelemetryEnabled() {\n+    // given\n+    ProcessEngineConfigurationImpl processEngineConfiguration = createEngineWithInitMessage(true);\n+    stubFor(post(urlEqualTo(TELEMETRY_ENDPOINT_PATH))\n+            .willReturn(aResponse()\n+                        .withStatus(HttpURLConnection.HTTP_ACCEPTED)));\n+\n+    Data expectedData = createInitialDataToSend(processEngineConfiguration.getTelemetryData(), true);\n+    String requestBody = new Gson().toJson(expectedData);\n+\n+    // when\n+    processEngineConfiguration.getTelemetryReporter().reportNow();\n+    standaloneProcessEngine.close();\n+    standaloneProcessEngine = null;\n+\n+    // then\n+    verify(3, postRequestedFor(urlEqualTo(TELEMETRY_ENDPOINT_PATH))\n+              .withRequestBody(equalToJson(requestBody, JSONCompareMode.LENIENT))\n+              .withHeader(\"Content-Type\",  equalTo(\"application/json\")));\n+    assertThat(loggingRule.getFilteredLog(\"Sending initial telemetry data\").size()).isOne();\n+    assertThat(loggingRule.getFilteredLog(\"Initial telemetry request was successful.\").size()).isOne();\n+  }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODgwNzYwMA=="}, "originalCommit": {"oid": "85882c496778568a24daffaa687dd6f2ab4b7da8"}, "originalPosition": 146}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMjcyMjA0OnYy", "diffSide": "LEFT", "path": "engine/src/test/java/org/camunda/bpm/engine/test/api/mgmt/telemetry/TelemetryReporterTest.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxMzowNDozMFrOHbszww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxMzowOTo1MlrOHbs-og==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODgwNzc0Nw==", "bodyText": "Why don't we need this anymore?", "url": "https://github.com/camunda/camunda-bpm-platform/pull/1040#discussion_r498807747", "createdAt": "2020-10-02T13:04:30Z", "author": {"login": "tmetzke"}, "path": "engine/src/test/java/org/camunda/bpm/engine/test/api/mgmt/telemetry/TelemetryReporterTest.java", "diffHunk": "@@ -182,7 +181,6 @@ public void tearDown() {\n         standaloneProcessEngine.getManagementService().toggleTelemetry(false);\n       }\n       standaloneProcessEngine.close();\n-      ProcessEngines.unregister(standaloneProcessEngine);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85882c496778568a24daffaa687dd6f2ab4b7da8"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODgwOTU4Mg==", "bodyText": "ahm, processEngine#close() does that already, I just saw it today", "url": "https://github.com/camunda/camunda-bpm-platform/pull/1040#discussion_r498809582", "createdAt": "2020-10-02T13:07:57Z", "author": {"login": "yanavasileva"}, "path": "engine/src/test/java/org/camunda/bpm/engine/test/api/mgmt/telemetry/TelemetryReporterTest.java", "diffHunk": "@@ -182,7 +181,6 @@ public void tearDown() {\n         standaloneProcessEngine.getManagementService().toggleTelemetry(false);\n       }\n       standaloneProcessEngine.close();\n-      ProcessEngines.unregister(standaloneProcessEngine);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODgwNzc0Nw=="}, "originalCommit": {"oid": "85882c496778568a24daffaa687dd6f2ab4b7da8"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODgxMDUzMA==", "bodyText": "OK nice, good catch \ud83d\udc4d", "url": "https://github.com/camunda/camunda-bpm-platform/pull/1040#discussion_r498810530", "createdAt": "2020-10-02T13:09:52Z", "author": {"login": "tmetzke"}, "path": "engine/src/test/java/org/camunda/bpm/engine/test/api/mgmt/telemetry/TelemetryReporterTest.java", "diffHunk": "@@ -182,7 +181,6 @@ public void tearDown() {\n         standaloneProcessEngine.getManagementService().toggleTelemetry(false);\n       }\n       standaloneProcessEngine.close();\n-      ProcessEngines.unregister(standaloneProcessEngine);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODgwNzc0Nw=="}, "originalCommit": {"oid": "85882c496778568a24daffaa687dd6f2ab4b7da8"}, "originalPosition": 12}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4411, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}