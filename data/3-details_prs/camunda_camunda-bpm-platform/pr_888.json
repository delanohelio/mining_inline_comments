{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ1MzkxODg5", "number": 888, "title": "fix(engine): ignore failure of db operation when op for owning entity has failed", "bodyText": "", "createdAt": "2020-07-07T12:51:00Z", "url": "https://github.com/camunda/camunda-bpm-platform/pull/888", "merged": true, "mergeCommit": {"oid": "6643144778008d8d807b03f53b9d0d8f8a10b84b"}, "closed": true, "closedAt": "2020-07-14T14:26:18Z", "author": {"login": "yanavasileva"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcylQfsAH2gAyNDQ1MzkxODg5OjM0M2YzOTY4ZGI3ZTY5Njg0MDQ1NzUxMzkzZDY1NzU5YzYwZGRmZWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc02k7OgFqTQ0ODEzODk4MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "343f3968db7e69684045751393d65759c60ddfec", "author": {"user": {"login": "yanavasileva", "name": null}}, "url": "https://github.com/camunda/camunda-bpm-platform/commit/343f3968db7e69684045751393d65759c60ddfec", "committedDate": "2020-07-07T12:46:48Z", "message": "chore(engine): resolve foreign key constraint violation as OLE"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3f3ef96c15d3b4a1589fc08083efa5c976567b2", "author": {"user": {"login": "yanavasileva", "name": null}}, "url": "https://github.com/camunda/camunda-bpm-platform/commit/d3f3ef96c15d3b4a1589fc08083efa5c976567b2", "committedDate": "2020-07-07T13:05:35Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d72263b48bd82dc73e1a427709eaa5cd7c71b969", "author": {"user": {"login": "yanavasileva", "name": null}}, "url": "https://github.com/camunda/camunda-bpm-platform/commit/d72263b48bd82dc73e1a427709eaa5cd7c71b969", "committedDate": "2020-07-08T11:34:31Z", "message": "test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "944b639dcc0b49291c0e91b17cdf26f479a96330", "author": {"user": {"login": "yanavasileva", "name": null}}, "url": "https://github.com/camunda/camunda-bpm-platform/commit/944b639dcc0b49291c0e91b17cdf26f479a96330", "committedDate": "2020-07-08T12:46:54Z", "message": "adj"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8444e7f5347caf587a7af5c86a4f1d8504da716", "author": {"user": {"login": "yanavasileva", "name": null}}, "url": "https://github.com/camunda/camunda-bpm-platform/commit/e8444e7f5347caf587a7af5c86a4f1d8504da716", "committedDate": "2020-07-09T12:18:30Z", "message": "adjust test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52363a916694cebc02f51a5aa490bc6813abc246", "author": {"user": {"login": "yanavasileva", "name": null}}, "url": "https://github.com/camunda/camunda-bpm-platform/commit/52363a916694cebc02f51a5aa490bc6813abc246", "committedDate": "2020-07-09T13:45:15Z", "message": "transaction listener"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d9eec4db6637b39a26251d324972a5a4ec10a02", "author": {"user": {"login": "yanavasileva", "name": null}}, "url": "https://github.com/camunda/camunda-bpm-platform/commit/1d9eec4db6637b39a26251d324972a5a4ec10a02", "committedDate": "2020-07-09T14:35:20Z", "message": "comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2803dcf435efafabead5dfe6b780e65a9f6a48e", "author": {"user": {"login": "ThorbenLindhauer", "name": "Thorben Lindhauer"}}, "url": "https://github.com/camunda/camunda-bpm-platform/commit/a2803dcf435efafabead5dfe6b780e65a9f6a48e", "committedDate": "2020-07-09T15:43:36Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b143b413b289e51e639a461cccc6b6361f781273", "author": {"user": {"login": "ThorbenLindhauer", "name": "Thorben Lindhauer"}}, "url": "https://github.com/camunda/camunda-bpm-platform/commit/b143b413b289e51e639a461cccc6b6361f781273", "committedDate": "2020-07-10T16:17:34Z", "message": "try out fix with dependency between operations\n\n- ignore failure of a db operation if an operation for an owning entity\n  has failed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3MDM1NTYz", "url": "https://github.com/camunda/camunda-bpm-platform/pull/888#pullrequestreview-447035563", "createdAt": "2020-07-13T08:30:44Z", "commit": {"oid": "b143b413b289e51e639a461cccc6b6361f781273"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QwODozMDo0NFrOGweSlw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QwODozMDo0NFrOGweSlw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ4MTExMQ==", "bodyText": "I will not add them so far. We can add them later if we need it.", "url": "https://github.com/camunda/camunda-bpm-platform/pull/888#discussion_r453481111", "createdAt": "2020-07-13T08:30:44Z", "author": {"login": "yanavasileva"}, "path": "engine/src/main/java/org/camunda/bpm/engine/impl/db/entitymanager/operation/DbOperationManager.java", "diffHunk": "@@ -133,9 +135,38 @@ public boolean addOperationPreserveOrder(DbBulkOperation newOperation) {\n     addSortedInserts(flush);\n     // then UPDATEs + DELETEs\n     addSortedModifications(flush);\n+    \n+    resolveDependencies(flush);\n     return flush;\n   }\n \n+  // TODO: resolve is probably not the correct verb\n+  private void resolveDependencies(List<DbOperation> flush) {\n+    for (DbOperation operation : flush) {\n+      if (operation instanceof DbEntityOperation) {\n+        DbEntity entity = ((DbEntityOperation) operation).getEntity();\n+        if (entity instanceof HasDbReferences) {\n+          Map<String, Class> dependentEntities = ((HasDbReferences) entity).getDependentEntities();\n+          \n+          \n+          if (dependentEntities != null) {\n+            dependentEntities.forEach((id, type) -> {\n+              // TODO: also updates and inserts?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b143b413b289e51e639a461cccc6b6361f781273"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f927caba5404a25a9221332fe77187737752c76e", "author": {"user": {"login": "yanavasileva", "name": null}}, "url": "https://github.com/camunda/camunda-bpm-platform/commit/f927caba5404a25a9221332fe77187737752c76e", "committedDate": "2020-07-13T09:54:32Z", "message": "chrore(engine): cleanup code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38525a96e4eaa3cf3615a147c91116c025efa102", "author": {"user": {"login": "yanavasileva", "name": null}}, "url": "https://github.com/camunda/camunda-bpm-platform/commit/38525a96e4eaa3cf3615a147c91116c025efa102", "committedDate": "2020-07-13T12:05:39Z", "message": "chore(test): adjust test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d5b2e0f3a32f4965b3e5e229af36d6b67be35d0", "author": {"user": {"login": "yanavasileva", "name": null}}, "url": "https://github.com/camunda/camunda-bpm-platform/commit/5d5b2e0f3a32f4965b3e5e229af36d6b67be35d0", "committedDate": "2020-07-13T14:52:49Z", "message": "chore(engine): adjust failed operations list\n\n* skip test on prefix scenario\n* add operation to failed operation list only if it's marked as failed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3ODk2NjM0", "url": "https://github.com/camunda/camunda-bpm-platform/pull/888#pullrequestreview-447896634", "createdAt": "2020-07-14T08:27:49Z", "commit": {"oid": "5d5b2e0f3a32f4965b3e5e229af36d6b67be35d0"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQwODoyNzo0OVrOGxJm6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQwODoyODo0NFrOGxJpEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE5MDgyNA==", "bodyText": "We can (optionally) add a comment here why this test is ignored for this profile.", "url": "https://github.com/camunda/camunda-bpm-platform/pull/888#discussion_r454190824", "createdAt": "2020-07-14T08:27:49Z", "author": {"login": "koevskinikola"}, "path": "engine/pom.xml", "diffHunk": "@@ -807,6 +807,7 @@\n                 <exclude>**/removaltime/cleanup/HistoryCleanupScheduler*Test.java</exclude>\n                 <exclude>**/HistoryCleanupDisabledOnBootstrapTest.java</exclude>\n                 <exclude>**/LoginAttemptsTest.java</exclude>\n+                <exclude>**/ConcurrentHistoryCleanupUpdateOfFailingJobTest.java</exclude>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d5b2e0f3a32f4965b3e5e229af36d6b67be35d0"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE5MTM3Ng==", "bodyText": "Is it possible to pass some contextual info here? E.g. \"parent operation failed\".", "url": "https://github.com/camunda/camunda-bpm-platform/pull/888#discussion_r454191376", "createdAt": "2020-07-14T08:28:44Z", "author": {"login": "koevskinikola"}, "path": "engine/src/main/java/org/camunda/bpm/engine/impl/db/EnginePersistenceLogger.java", "diffHunk": "@@ -792,4 +792,9 @@ public void installationIdPropertyFound(String value) {\n         \"100\", \"Installation id property found in the database: {}\", value);\n   }\n \n+  public void ignoreFailureDuePreconditionNotMet() {\n+    logDebug(\n+        \"101\", \"Ignoring operation failure due to unmet precondition\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d5b2e0f3a32f4965b3e5e229af36d6b67be35d0"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3OTE4NDkz", "url": "https://github.com/camunda/camunda-bpm-platform/pull/888#pullrequestreview-447918493", "createdAt": "2020-07-14T08:57:14Z", "commit": {"oid": "5d5b2e0f3a32f4965b3e5e229af36d6b67be35d0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQwODo1NzoxNFrOGxKp4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQwODo1NzoxNFrOGxKp4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDIwNzk2OQ==", "bodyText": "*determine", "url": "https://github.com/camunda/camunda-bpm-platform/pull/888#discussion_r454207969", "createdAt": "2020-07-14T08:57:14Z", "author": {"login": "ThorbenLindhauer"}, "path": "engine/src/main/java/org/camunda/bpm/engine/impl/db/entitymanager/operation/DbOperationManager.java", "diffHunk": "@@ -243,4 +246,28 @@ protected void addSortedModificationsForType(Class<?> type, SortedSet<DbEntityOp\n \n     return opList;\n   }\n+\n+  protected void determinateDependencies(List<DbOperation> flush) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d5b2e0f3a32f4965b3e5e229af36d6b67be35d0"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3OTIxNTA1", "url": "https://github.com/camunda/camunda-bpm-platform/pull/888#pullrequestreview-447921505", "createdAt": "2020-07-14T09:01:15Z", "commit": {"oid": "5d5b2e0f3a32f4965b3e5e229af36d6b67be35d0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQwOTowMToxNlrOGxKzFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQwOTowMToxNlrOGxKzFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDIxMDMyNQ==", "bodyText": "Let's try to get the wording right to avoid future confusion. I propose we call the parent operation (here: job update) the \"dependency\" and the child operation (here: byte array delete) the \"dependent\" (based on https://english.stackexchange.com/questions/25575/what-is-the-correct-word-for-dependee).", "url": "https://github.com/camunda/camunda-bpm-platform/pull/888#discussion_r454210325", "createdAt": "2020-07-14T09:01:16Z", "author": {"login": "ThorbenLindhauer"}, "path": "engine/src/main/java/org/camunda/bpm/engine/impl/db/sql/DbSqlSession.java", "diffHunk": "@@ -184,12 +184,19 @@ protected void bulkOperationPerformed(DbBulkOperation operation, int rowsAffecte\n   }\n \n   protected void entityDeletePerformed(DbEntityOperation operation, int rowsAffected, Exception failure) {\n+    \n     if (failure != null) {\n       operation.setRowsAffected(0);\n       operation.setFailure(failure);\n \n+      DbOperation dependentOperation = operation.getDependentOperation();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d5b2e0f3a32f4965b3e5e229af36d6b67be35d0"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c00ba2ecb563ca650576d90cf1b90b5fa3516acd", "author": {"user": {"login": "yanavasileva", "name": null}}, "url": "https://github.com/camunda/camunda-bpm-platform/commit/c00ba2ecb563ca650576d90cf1b90b5fa3516acd", "committedDate": "2020-07-14T10:11:58Z", "message": "improve(engine): improve varables naming and log message"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4MTM4OTgx", "url": "https://github.com/camunda/camunda-bpm-platform/pull/888#pullrequestreview-448138981", "createdAt": "2020-07-14T14:05:21Z", "commit": {"oid": "c00ba2ecb563ca650576d90cf1b90b5fa3516acd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2579, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}