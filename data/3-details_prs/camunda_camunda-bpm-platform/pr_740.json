{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkwNTE0Njgw", "number": 740, "title": "feat(engine): set removal time to auth when identity link is added", "bodyText": "related to CAM-11646", "createdAt": "2020-03-18T15:44:10Z", "url": "https://github.com/camunda/camunda-bpm-platform/pull/740", "merged": true, "mergeCommit": {"oid": "0f8b8242c8a689ba80974fd8792e4f50de2a8b15"}, "closed": true, "closedAt": "2020-03-31T11:40:59Z", "author": {"login": "tasso94"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcPL584ABqjMxNDU1MzkxNDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTBkAygBqjMxODI4ODMxNzI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4624590d4e42c6b1fa55404e05d6e010c547b8ae", "author": {"user": {"login": "tasso94", "name": "Tassilo Weidner"}}, "url": "https://github.com/camunda/camunda-bpm-platform/commit/4624590d4e42c6b1fa55404e05d6e010c547b8ae", "committedDate": "2020-03-18T15:39:19Z", "message": "feat(engine): set removal time to auth when identity link is added\n\nrelated to CAM-11646"}, "afterCommit": {"oid": "cbd62054664c534ade0375344b3560e22d4ececa", "author": {"user": {"login": "tasso94", "name": "Tassilo Weidner"}}, "url": "https://github.com/camunda/camunda-bpm-platform/commit/cbd62054664c534ade0375344b3560e22d4ececa", "committedDate": "2020-03-19T13:24:58Z", "message": "feat(engine): set removal time to auth when identity link is added\n\nrelated to CAM-11646"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ce4b34615eafa42200a6fa433d9b4f4b5ee14703", "author": {"user": {"login": "tasso94", "name": "Tassilo Weidner"}}, "url": "https://github.com/camunda/camunda-bpm-platform/commit/ce4b34615eafa42200a6fa433d9b4f4b5ee14703", "committedDate": "2020-03-20T09:26:49Z", "message": "Trigger CI"}, "afterCommit": {"oid": "bdd022a1aca7c6350de8c649495815f136b20bf9", "author": {"user": {"login": "tasso94", "name": "Tassilo Weidner"}}, "url": "https://github.com/camunda/camunda-bpm-platform/commit/bdd022a1aca7c6350de8c649495815f136b20bf9", "committedDate": "2020-03-20T14:55:15Z", "message": "feat(engine): set removal time to auth when identity link is added\n\nrelated to CAM-11646"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bdd022a1aca7c6350de8c649495815f136b20bf9", "author": {"user": {"login": "tasso94", "name": "Tassilo Weidner"}}, "url": "https://github.com/camunda/camunda-bpm-platform/commit/bdd022a1aca7c6350de8c649495815f136b20bf9", "committedDate": "2020-03-20T14:55:15Z", "message": "feat(engine): set removal time to auth when identity link is added\n\nrelated to CAM-11646"}, "afterCommit": {"oid": "89fdcef1f0a957b75fa707d24f2a5204b16a694f", "author": {"user": {"login": "tasso94", "name": "Tassilo Weidner"}}, "url": "https://github.com/camunda/camunda-bpm-platform/commit/89fdcef1f0a957b75fa707d24f2a5204b16a694f", "committedDate": "2020-03-23T17:23:32Z", "message": "feat(engine): set removal time to auth when identity link is added\n\nrelated to CAM-11646"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "89fdcef1f0a957b75fa707d24f2a5204b16a694f", "author": {"user": {"login": "tasso94", "name": "Tassilo Weidner"}}, "url": "https://github.com/camunda/camunda-bpm-platform/commit/89fdcef1f0a957b75fa707d24f2a5204b16a694f", "committedDate": "2020-03-23T17:23:32Z", "message": "feat(engine): set removal time to auth when identity link is added\n\nrelated to CAM-11646"}, "afterCommit": {"oid": "551b0e6d5e1817c54949ec9d6de5a881c340422c", "author": {"user": {"login": "tasso94", "name": "Tassilo Weidner"}}, "url": "https://github.com/camunda/camunda-bpm-platform/commit/551b0e6d5e1817c54949ec9d6de5a881c340422c", "committedDate": "2020-03-25T16:28:16Z", "message": "feat(engine): set removal time to auth when identity link is added\n\nrelated to CAM-11646"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "551b0e6d5e1817c54949ec9d6de5a881c340422c", "author": {"user": {"login": "tasso94", "name": "Tassilo Weidner"}}, "url": "https://github.com/camunda/camunda-bpm-platform/commit/551b0e6d5e1817c54949ec9d6de5a881c340422c", "committedDate": "2020-03-25T16:28:16Z", "message": "feat(engine): set removal time to auth when identity link is added\n\nrelated to CAM-11646"}, "afterCommit": {"oid": "b61320cc696524b53a5c4890ff80c18becc6eb27", "author": {"user": {"login": "tasso94", "name": "Tassilo Weidner"}}, "url": "https://github.com/camunda/camunda-bpm-platform/commit/b61320cc696524b53a5c4890ff80c18becc6eb27", "committedDate": "2020-03-25T16:38:11Z", "message": "feat(engine): set removal time to auth when identity link is added\n\nrelated to CAM-11646"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b61320cc696524b53a5c4890ff80c18becc6eb27", "author": {"user": {"login": "tasso94", "name": "Tassilo Weidner"}}, "url": "https://github.com/camunda/camunda-bpm-platform/commit/b61320cc696524b53a5c4890ff80c18becc6eb27", "committedDate": "2020-03-25T16:38:11Z", "message": "feat(engine): set removal time to auth when identity link is added\n\nrelated to CAM-11646"}, "afterCommit": {"oid": "5b3ceaf2631992fa79ee0a57562ffe6f5f024de2", "author": {"user": {"login": "tasso94", "name": "Tassilo Weidner"}}, "url": "https://github.com/camunda/camunda-bpm-platform/commit/5b3ceaf2631992fa79ee0a57562ffe6f5f024de2", "committedDate": "2020-03-25T16:53:52Z", "message": "feat(engine): set removal time to auth when identity link is added\n\nrelated to CAM-11646"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyNjg1Nzg5", "url": "https://github.com/camunda/camunda-bpm-platform/pull/740#pullrequestreview-382685789", "createdAt": "2020-03-27T09:12:37Z", "commit": {"oid": "5b3ceaf2631992fa79ee0a57562ffe6f5f024de2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwOToxMjozN1rOF8or3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwOTo0NToyN1rOF8p18w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTEyNTQ3MQ==", "bodyText": "The logic in the lines above (setting root instance id and removal time) is only necessary when the authorization is created, not when it is updated. I think it would be good to only perform it in the creation case to avoid unnecessary queries for the root process instance.", "url": "https://github.com/camunda/camunda-bpm-platform/pull/740#discussion_r399125471", "createdAt": "2020-03-27T09:12:37Z", "author": {"login": "ThorbenLindhauer"}, "path": "engine/src/main/java/org/camunda/bpm/engine/impl/cfg/auth/DefaultAuthorizationProvider.java", "diffHunk": "@@ -292,10 +294,53 @@\n           updateAuthorization(historyAuthorization, userId, groupId, HISTORIC_TASK,\n               taskId, HistoricTaskPermissions.READ);\n \n+      String rootProcessInstanceId = getRootProcessInstanceId(task);\n+\n+      historyAuthorization.setRootProcessInstanceId(rootProcessInstanceId);\n+\n+      if (isHistoryRemovalTimeStrategyStart()) {\n+        HistoryEvent rootProcessInstance = findHistoricProcessInstance(rootProcessInstanceId);\n+\n+        Date removalTime = null;\n+        if (rootProcessInstance != null) {\n+          removalTime = rootProcessInstance.getRemovalTime();\n+\n+        }\n+\n+        historyAuthorization.setRemovalTime(removalTime);\n+      }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b3ceaf2631992fa79ee0a57562ffe6f5f024de2"}, "originalPosition": 134}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTEyODM3NA==", "bodyText": "In case of standalone tasks (root instance id == null), we don't have to go looking for the root instance.\nWhich removal time should a standalone task permissions receive?", "url": "https://github.com/camunda/camunda-bpm-platform/pull/740#discussion_r399128374", "createdAt": "2020-03-27T09:17:34Z", "author": {"login": "ThorbenLindhauer"}, "path": "engine/src/main/java/org/camunda/bpm/engine/impl/cfg/auth/DefaultAuthorizationProvider.java", "diffHunk": "@@ -292,10 +294,53 @@\n           updateAuthorization(historyAuthorization, userId, groupId, HISTORIC_TASK,\n               taskId, HistoricTaskPermissions.READ);\n \n+      String rootProcessInstanceId = getRootProcessInstanceId(task);\n+\n+      historyAuthorization.setRootProcessInstanceId(rootProcessInstanceId);\n+\n+      if (isHistoryRemovalTimeStrategyStart()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b3ceaf2631992fa79ee0a57562ffe6f5f024de2"}, "originalPosition": 123}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTEzMzMwMA==", "bodyText": "This is a bit inconsistent with removal time not being part of the authorization's persistent state (#getPersistentState). I don't see a concrete problem here and believe both of the following should work:\n\nRemove REMOVAL_TIME_ from the update mapping: With removal time strategy start, we always set the removal time when the permission is inserted and it can never change later\nAdd removalTime to the persistent state. This makes it consistent, although probably not strictly necessary as the removal time is never updated on its own. Could avoid future bugs though.", "url": "https://github.com/camunda/camunda-bpm-platform/pull/740#discussion_r399133300", "createdAt": "2020-03-27T09:26:06Z", "author": {"login": "ThorbenLindhauer"}, "path": "engine/src/main/resources/org/camunda/bpm/engine/impl/mapping/entity/Authorization.xml", "diffHunk": "@@ -55,11 +59,20 @@\n       USER_ID_ = #{userId, jdbcType=VARCHAR},\n       RESOURCE_TYPE_ = #{resourceType, jdbcType=INTEGER},\n       RESOURCE_ID_ = #{resourceId, jdbcType=VARCHAR},\n-      PERMS_ = #{permissions, jdbcType=INTEGER}\n+      PERMS_ = #{permissions, jdbcType=INTEGER},\n+      REMOVAL_TIME_ = #{removalTime, jdbcType=TIMESTAMP}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b3ceaf2631992fa79ee0a57562ffe6f5f024de2"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE0MTk3Nw==", "bodyText": "Why was this test changed?", "url": "https://github.com/camunda/camunda-bpm-platform/pull/740#discussion_r399141977", "createdAt": "2020-03-27T09:41:10Z", "author": {"login": "ThorbenLindhauer"}, "path": "engine/src/test/java/org/camunda/bpm/engine/test/api/history/removaltime/HistoricRootProcessInstanceTest.java", "diffHunk": "@@ -588,9 +592,11 @@ public void shouldResolveUserOperationLog_ClaimTask() {\n \n     ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(CALLING_PROCESS_KEY);\n \n+    String taskId = taskService.createTaskQuery().singleResult().getId();\n+\n     // when\n     identityService.setAuthenticatedUserId(\"aUserId\");\n-    taskService.claim(taskService.createTaskQuery().singleResult().getId(), \"aUserId\");\n+    taskService.setAssignee(taskId, \"aUserId\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b3ceaf2631992fa79ee0a57562ffe6f5f024de2"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE0NDQzNQ==", "bodyText": "Nitpicking: The //then part of the test begins here. For me, the most important aspect of the given-when-then structure is that I can quickly understand which functionality is tested, so the when part should contain only the statements that trigger the code under test.", "url": "https://github.com/camunda/camunda-bpm-platform/pull/740#discussion_r399144435", "createdAt": "2020-03-27T09:45:27Z", "author": {"login": "ThorbenLindhauer"}, "path": "engine/src/test/java/org/camunda/bpm/engine/test/api/history/removaltime/RemovalTimeStrategyEndTest.java", "diffHunk": "@@ -349,6 +353,92 @@ public void shouldResolveHistoricTaskInstance() {\n     assertThat(historicTaskInstance.getRemovalTime(), is(removalTime));\n   }\n \n+  @Test\n+  public void shouldWriteHistoryAndResolveHistoricTaskAuthorizationInDifferentTransactions() {\n+    // given\n+    processEngineConfiguration.setEnableHistoricInstancePermissions(true);\n+\n+    testRule.deploy(CALLING_PROCESS);\n+\n+    testRule.deploy(CALLED_PROCESS);\n+\n+    ClockUtil.setCurrentTime(START_DATE);\n+\n+    runtimeService.startProcessInstanceByKey(CALLING_PROCESS_KEY);\n+\n+    String taskId = taskService.createTaskQuery().singleResult().getId();\n+\n+    enabledAuth();\n+    taskService.setAssignee(taskId, \"myUserId\");\n+    disableAuth();\n+\n+    Authorization authorization = authorizationService.createAuthorizationQuery()\n+        .resourceType(Resources.HISTORIC_TASK)\n+        .singleResult();\n+\n+    // assume\n+    assertThat(authorization.getRemovalTime(), nullValue());\n+\n+    ClockUtil.setCurrentTime(END_DATE);\n+\n+    // when\n+    taskService.complete(taskId);\n+\n+    authorization = authorizationService.createAuthorizationQuery()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b3ceaf2631992fa79ee0a57562ffe6f5f024de2"}, "originalPosition": 55}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5b3ceaf2631992fa79ee0a57562ffe6f5f024de2", "author": {"user": {"login": "tasso94", "name": "Tassilo Weidner"}}, "url": "https://github.com/camunda/camunda-bpm-platform/commit/5b3ceaf2631992fa79ee0a57562ffe6f5f024de2", "committedDate": "2020-03-25T16:53:52Z", "message": "feat(engine): set removal time to auth when identity link is added\n\nrelated to CAM-11646"}, "afterCommit": {"oid": "93d3547ebbae88e27cf5b4c565c01803da7c1ff1", "author": {"user": {"login": "tasso94", "name": "Tassilo Weidner"}}, "url": "https://github.com/camunda/camunda-bpm-platform/commit/93d3547ebbae88e27cf5b4c565c01803da7c1ff1", "committedDate": "2020-03-30T13:13:08Z", "message": "feat(engine): set removal time to auth when identity link is added\n\nrelated to CAM-11646"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "93d3547ebbae88e27cf5b4c565c01803da7c1ff1", "author": {"user": {"login": "tasso94", "name": "Tassilo Weidner"}}, "url": "https://github.com/camunda/camunda-bpm-platform/commit/93d3547ebbae88e27cf5b4c565c01803da7c1ff1", "committedDate": "2020-03-30T13:13:08Z", "message": "feat(engine): set removal time to auth when identity link is added\n\nrelated to CAM-11646"}, "afterCommit": {"oid": "c270402e06c71b8a6db5ef57c85fa42ae673d222", "author": {"user": {"login": "tasso94", "name": "Tassilo Weidner"}}, "url": "https://github.com/camunda/camunda-bpm-platform/commit/c270402e06c71b8a6db5ef57c85fa42ae673d222", "committedDate": "2020-03-31T07:08:33Z", "message": "feat(engine): set removal time to auth when identity link is added\n\nrelated to CAM-11646"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0NjM5MzY3", "url": "https://github.com/camunda/camunda-bpm-platform/pull/740#pullrequestreview-384639367", "createdAt": "2020-03-31T11:27:00Z", "commit": {"oid": "c270402e06c71b8a6db5ef57c85fa42ae673d222"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ba0cafabeaeb80feec14993ef480608b9e6d66f", "author": {"user": {"login": "tasso94", "name": "Tassilo Weidner"}}, "url": "https://github.com/camunda/camunda-bpm-platform/commit/4ba0cafabeaeb80feec14993ef480608b9e6d66f", "committedDate": "2020-03-31T11:37:42Z", "message": "feat(engine): set removal time to auth when identity link is added\n\nrelated to CAM-11646"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c270402e06c71b8a6db5ef57c85fa42ae673d222", "author": {"user": {"login": "tasso94", "name": "Tassilo Weidner"}}, "url": "https://github.com/camunda/camunda-bpm-platform/commit/c270402e06c71b8a6db5ef57c85fa42ae673d222", "committedDate": "2020-03-31T07:08:33Z", "message": "feat(engine): set removal time to auth when identity link is added\n\nrelated to CAM-11646"}, "afterCommit": {"oid": "4ba0cafabeaeb80feec14993ef480608b9e6d66f", "author": {"user": {"login": "tasso94", "name": "Tassilo Weidner"}}, "url": "https://github.com/camunda/camunda-bpm-platform/commit/4ba0cafabeaeb80feec14993ef480608b9e6d66f", "committedDate": "2020-03-31T11:37:42Z", "message": "feat(engine): set removal time to auth when identity link is added\n\nrelated to CAM-11646"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1993, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}