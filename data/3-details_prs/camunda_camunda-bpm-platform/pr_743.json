{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxMDQ0OTc4", "number": 743, "title": "feat(engine): set removal time to authorization on creation", "bodyText": "\u26a0\ufe0f Needs to be rebased onto master before merge.\nrelated to CAM-11617", "createdAt": "2020-03-19T14:43:13Z", "url": "https://github.com/camunda/camunda-bpm-platform/pull/743", "merged": true, "mergeCommit": {"oid": "4b911a61f7b3ad8e6caa306161f0218c2de57464"}, "closed": true, "closedAt": "2020-03-31T11:47:15Z", "author": {"login": "tasso94"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcPhusegBqjMxNDk2NDQ5MTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTBpv-gBqjMxODI5MDM3ODk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "73de06d13a88b36ed2c46d330ba38b28a45a2efb", "author": {"user": {"login": "tasso94", "name": "Tassilo Weidner"}}, "url": "https://github.com/camunda/camunda-bpm-platform/commit/73de06d13a88b36ed2c46d330ba38b28a45a2efb", "committedDate": "2020-03-19T14:40:06Z", "message": "feat(engine): set removal time to authorization on creation\n\nrelated to CAM-11617"}, "afterCommit": {"oid": "04bd1a280714a158452d1dc13e4be4b2575b5e8d", "author": {"user": {"login": "tasso94", "name": "Tassilo Weidner"}}, "url": "https://github.com/camunda/camunda-bpm-platform/commit/04bd1a280714a158452d1dc13e4be4b2575b5e8d", "committedDate": "2020-03-20T14:52:23Z", "message": "feat(engine): set removal time to authorization on creation\n\nrelated to CAM-11617"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "04bd1a280714a158452d1dc13e4be4b2575b5e8d", "author": {"user": {"login": "tasso94", "name": "Tassilo Weidner"}}, "url": "https://github.com/camunda/camunda-bpm-platform/commit/04bd1a280714a158452d1dc13e4be4b2575b5e8d", "committedDate": "2020-03-20T14:52:23Z", "message": "feat(engine): set removal time to authorization on creation\n\nrelated to CAM-11617"}, "afterCommit": {"oid": "5854b7d876c5eb3274b44147c1eb9695a6770fc1", "author": {"user": {"login": "tasso94", "name": "Tassilo Weidner"}}, "url": "https://github.com/camunda/camunda-bpm-platform/commit/5854b7d876c5eb3274b44147c1eb9695a6770fc1", "committedDate": "2020-03-23T17:27:19Z", "message": "feat(engine): set removal time to authorization on creation\n\nrelated to CAM-11617"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5854b7d876c5eb3274b44147c1eb9695a6770fc1", "author": {"user": {"login": "tasso94", "name": "Tassilo Weidner"}}, "url": "https://github.com/camunda/camunda-bpm-platform/commit/5854b7d876c5eb3274b44147c1eb9695a6770fc1", "committedDate": "2020-03-23T17:27:19Z", "message": "feat(engine): set removal time to authorization on creation\n\nrelated to CAM-11617"}, "afterCommit": {"oid": "d070123bf4d2c45cef52e19afc747fd885cfae35", "author": {"user": {"login": "tasso94", "name": "Tassilo Weidner"}}, "url": "https://github.com/camunda/camunda-bpm-platform/commit/d070123bf4d2c45cef52e19afc747fd885cfae35", "committedDate": "2020-03-24T10:35:59Z", "message": "feat(engine): set removal time to authorization on creation\n\nrelated to CAM-11617"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d070123bf4d2c45cef52e19afc747fd885cfae35", "author": {"user": {"login": "tasso94", "name": "Tassilo Weidner"}}, "url": "https://github.com/camunda/camunda-bpm-platform/commit/d070123bf4d2c45cef52e19afc747fd885cfae35", "committedDate": "2020-03-24T10:35:59Z", "message": "feat(engine): set removal time to authorization on creation\n\nrelated to CAM-11617"}, "afterCommit": {"oid": "f0d39dbd7a896c5b3c5a57a13a7bcab067745164", "author": {"user": {"login": "tasso94", "name": "Tassilo Weidner"}}, "url": "https://github.com/camunda/camunda-bpm-platform/commit/f0d39dbd7a896c5b3c5a57a13a7bcab067745164", "committedDate": "2020-03-25T16:58:57Z", "message": "feat(engine): set removal time to authorization on creation\n\nrelated to CAM-11617"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyNzIxNzcw", "url": "https://github.com/camunda/camunda-bpm-platform/pull/743#pullrequestreview-382721770", "createdAt": "2020-03-27T10:04:07Z", "commit": {"oid": "f0d39dbd7a896c5b3c5a57a13a7bcab067745164"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxMDowNDowOFrOF8qenw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxMDoxMDozOFrOF8qsog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE1NDg0Nw==", "bodyText": "Why does this use a supplier as the method parameter? The first thing the method does is call #get.", "url": "https://github.com/camunda/camunda-bpm-platform/pull/743#discussion_r399154847", "createdAt": "2020-03-27T10:04:08Z", "author": {"login": "ThorbenLindhauer"}, "path": "engine/src/main/java/org/camunda/bpm/engine/impl/cmd/SaveAuthorizationCmd.java", "diffHunk": "@@ -50,6 +56,10 @@ public Authorization execute(CommandContext commandContext) {\n \n     authorizationManager.validateResourceCompatibility(authorization);\n \n+    if (isHistoricTaskInstanceResource()) {\n+      provideRemovalTime(() -> getHistoricTaskInstance(commandContext));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0d39dbd7a896c5b3c5a57a13a7bcab067745164"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE1NTQ4Nw==", "bodyText": "We can also skip the query if the resourceId is *", "url": "https://github.com/camunda/camunda-bpm-platform/pull/743#discussion_r399155487", "createdAt": "2020-03-27T10:05:18Z", "author": {"login": "ThorbenLindhauer"}, "path": "engine/src/main/java/org/camunda/bpm/engine/impl/cmd/SaveAuthorizationCmd.java", "diffHunk": "@@ -65,4 +75,36 @@ public Authorization execute(CommandContext commandContext) {\n     return authorization;\n   }\n \n+  protected void provideRemovalTime(Supplier<HistoryEvent> supplier) {\n+    HistoryEvent historicInstance = supplier.get();\n+\n+    if (historicInstance != null) {\n+      String rootProcessInstanceId = historicInstance.getRootProcessInstanceId();\n+      authorization.setRootProcessInstanceId(rootProcessInstanceId);\n+\n+      Date removalTime = historicInstance.getRemovalTime();\n+      authorization.setRemovalTime(removalTime);\n+\n+    } else { // reset\n+      authorization.setRootProcessInstanceId(null);\n+      authorization.setRemovalTime(null);\n+\n+    }\n+  }\n+\n+  protected HistoryEvent getHistoricTaskInstance(CommandContext commandContext) {\n+    String historicTaskInstanceId = authorization.getResourceId();\n+\n+    if (historicTaskInstanceId == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0d39dbd7a896c5b3c5a57a13a7bcab067745164"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE1ODQzNA==", "bodyText": "Maybe here as well it makes sense to add the root instance id to the persistent state then.", "url": "https://github.com/camunda/camunda-bpm-platform/pull/743#discussion_r399158434", "createdAt": "2020-03-27T10:10:38Z", "author": {"login": "ThorbenLindhauer"}, "path": "engine/src/main/resources/org/camunda/bpm/engine/impl/mapping/entity/Authorization.xml", "diffHunk": "@@ -60,7 +60,8 @@\n       RESOURCE_TYPE_ = #{resourceType, jdbcType=INTEGER},\n       RESOURCE_ID_ = #{resourceId, jdbcType=VARCHAR},\n       PERMS_ = #{permissions, jdbcType=INTEGER},\n-      REMOVAL_TIME_ = #{removalTime, jdbcType=TIMESTAMP}\n+      REMOVAL_TIME_ = #{removalTime, jdbcType=TIMESTAMP},\n+      ROOT_PROC_INST_ID_ = #{rootProcessInstanceId, jdbcType=TIMESTAMP}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0d39dbd7a896c5b3c5a57a13a7bcab067745164"}, "originalPosition": 6}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f0d39dbd7a896c5b3c5a57a13a7bcab067745164", "author": {"user": {"login": "tasso94", "name": "Tassilo Weidner"}}, "url": "https://github.com/camunda/camunda-bpm-platform/commit/f0d39dbd7a896c5b3c5a57a13a7bcab067745164", "committedDate": "2020-03-25T16:58:57Z", "message": "feat(engine): set removal time to authorization on creation\n\nrelated to CAM-11617"}, "afterCommit": {"oid": "690fcd719220ead190169a43af038579a185e112", "author": {"user": {"login": "tasso94", "name": "Tassilo Weidner"}}, "url": "https://github.com/camunda/camunda-bpm-platform/commit/690fcd719220ead190169a43af038579a185e112", "committedDate": "2020-03-30T13:30:53Z", "message": "feat(engine): set removal time to authorization on creation\n\nrelated to CAM-11617"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "690fcd719220ead190169a43af038579a185e112", "author": {"user": {"login": "tasso94", "name": "Tassilo Weidner"}}, "url": "https://github.com/camunda/camunda-bpm-platform/commit/690fcd719220ead190169a43af038579a185e112", "committedDate": "2020-03-30T13:30:53Z", "message": "feat(engine): set removal time to authorization on creation\n\nrelated to CAM-11617"}, "afterCommit": {"oid": "832c3a1c894a5e739a7399f9c68ec70302900745", "author": {"user": {"login": "tasso94", "name": "Tassilo Weidner"}}, "url": "https://github.com/camunda/camunda-bpm-platform/commit/832c3a1c894a5e739a7399f9c68ec70302900745", "committedDate": "2020-03-31T07:29:00Z", "message": "feat(engine): set removal time to authorization on creation\n\nrelated to CAM-11617"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0NjMwNTE0", "url": "https://github.com/camunda/camunda-bpm-platform/pull/743#pullrequestreview-384630514", "createdAt": "2020-03-31T11:13:13Z", "commit": {"oid": "832c3a1c894a5e739a7399f9c68ec70302900745"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00ba6e0343c4c03d20af3a1afb90ebdcf415adec", "author": {"user": {"login": "tasso94", "name": "Tassilo Weidner"}}, "url": "https://github.com/camunda/camunda-bpm-platform/commit/00ba6e0343c4c03d20af3a1afb90ebdcf415adec", "committedDate": "2020-03-31T11:45:54Z", "message": "feat(engine): set removal time to authorization on creation\n\nrelated to CAM-11617"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "832c3a1c894a5e739a7399f9c68ec70302900745", "author": {"user": {"login": "tasso94", "name": "Tassilo Weidner"}}, "url": "https://github.com/camunda/camunda-bpm-platform/commit/832c3a1c894a5e739a7399f9c68ec70302900745", "committedDate": "2020-03-31T07:29:00Z", "message": "feat(engine): set removal time to authorization on creation\n\nrelated to CAM-11617"}, "afterCommit": {"oid": "00ba6e0343c4c03d20af3a1afb90ebdcf415adec", "author": {"user": {"login": "tasso94", "name": "Tassilo Weidner"}}, "url": "https://github.com/camunda/camunda-bpm-platform/commit/00ba6e0343c4c03d20af3a1afb90ebdcf415adec", "committedDate": "2020-03-31T11:45:54Z", "message": "feat(engine): set removal time to authorization on creation\n\nrelated to CAM-11617"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1999, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}