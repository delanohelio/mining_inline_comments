{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEyNjM2ODk1", "number": 3076, "title": "Enhance UX of Searchbar and make code simpler and more streamlined", "bodyText": "resolve #3007\nI think the current search bar has the following problems\n\nBecause it uses external libraries such as react-select, the design and keyboard operations are not fully controlled by lens side.\nThe implementation is more complex than it needs to be.\nThe design is also a bit confusing (especially lookback and limit).\nIt is hard to make unit tests because its implementation is too complex.\n\nSo I decided to reimplement it from scratch.\nThis PR will accomplish the following\n\nIndependence from difficult-to-control external libraries.\nCode will be simpler and the code lines will be fewer.\nBecome testable.\nUI will probably be easier to understand.\nIt will be more extensible & customizable in the future because it does not depend on external libraries.\nTypeScriptize search bar!\n\n\nGIFs\nLookback\n\nSearchbar", "createdAt": "2020-05-03T17:29:28Z", "url": "https://github.com/openzipkin/zipkin/pull/3076", "merged": true, "mergeCommit": {"oid": "7cb3bd38b47828d1f68cd1f8a787b27c87a6b1f3"}, "closed": true, "closedAt": "2020-08-08T03:48:28Z", "author": {"login": "tacigar"}, "timelineItems": {"totalCount": 69, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcduESSAH2gAyNDEyNjM2ODk1OjU0YzU1MjYxYTA0MGNiNTFjZjY2NDNlOTU5OTg0ZThkN2Y1ZDViYjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc8hdFBAH2gAyNDEyNjM2ODk1OjIzZWQzYmU3ZmM1ODg3OWQwYTc5ZTg1M2Q5YWYwYTU1Y2M0ZTBlZjM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "54c55261a040cb51cf6643e959984e8d7f5d5bb1", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/54c55261a040cb51cf6643e959984e8d7f5d5bb1", "committedDate": "2020-05-03T17:10:12Z", "message": "Enhance UX of Searchbar and make code simpler and more streamlined"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9050fa11764588116861b3da9ca2818a1e5f7945", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/9050fa11764588116861b3da9ca2818a1e5f7945", "committedDate": "2020-05-03T17:14:22Z", "message": "Remove unused files"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78521f8059a24d66077e0ff2bb5d6768387c4d1c", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/78521f8059a24d66077e0ff2bb5d6768387c4d1c", "committedDate": "2020-05-04T00:43:10Z", "message": "TypeScriptize ExplainBox"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "867b7aedf05e07874884d9f6b9682205274271f6", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/867b7aedf05e07874884d9f6b9682205274271f6", "committedDate": "2020-05-04T01:51:29Z", "message": "Remove unused imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87723a04c5a6cabc8bca8c40e12612329055a47a", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/87723a04c5a6cabc8bca8c40e12612329055a47a", "committedDate": "2020-05-04T01:51:55Z", "message": "Add LookbackMenu's unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "834d44838e9dc68d84d03e07094519fe00807a58", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/834d44838e9dc68d84d03e07094519fe00807a58", "committedDate": "2020-05-04T05:29:40Z", "message": "Add @testing-library/react-hooks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2003233b3c0711d18b4273f5e9ee40c8df54c6cf", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/2003233b3c0711d18b4273f5e9ee40c8df54c6cf", "committedDate": "2020-05-04T06:05:06Z", "message": "Add DiscoverPageContent's unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d11db5d4f90ce7b0a9c507576af125b1c9384b60", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/d11db5d4f90ce7b0a9c507576af125b1c9384b60", "committedDate": "2020-05-04T16:51:51Z", "message": "Add SearchBar's unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6234f15446e6917c5637532d3adc94c6a54ed9ee", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/6234f15446e6917c5637532d3adc94c6a54ed9ee", "committedDate": "2020-05-04T16:52:36Z", "message": "Update CriterionBox"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b72f69824e5711f50a4ec34658625a43f18d768f", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/b72f69824e5711f50a4ec34658625a43f18d768f", "committedDate": "2020-05-04T17:09:05Z", "message": "Add zIndex props to SuggestionList"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e3e5b5c6a834e51de884a74d40e96cf2a50ab060", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/e3e5b5c6a834e51de884a74d40e96cf2a50ab060", "committedDate": "2020-05-05T08:42:34Z", "message": "Update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5d903ceda98dc933f084c6f617191a6bea374c3", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/a5d903ceda98dc933f084c6f617191a6bea374c3", "committedDate": "2020-05-05T11:50:31Z", "message": "Simplify"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0b992c6f583c6b473771444f326de8509c933778", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/0b992c6f583c6b473771444f326de8509c933778", "committedDate": "2020-05-05T08:40:47Z", "message": "Update"}, "afterCommit": {"oid": "a5d903ceda98dc933f084c6f617191a6bea374c3", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/a5d903ceda98dc933f084c6f617191a6bea374c3", "committedDate": "2020-05-05T11:50:31Z", "message": "Simplify"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec257e4fbd8195993542892675e44e48bc285585", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/ec257e4fbd8195993542892675e44e48bc285585", "committedDate": "2020-05-05T23:36:13Z", "message": "More simple"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9332a43983a93eed4a8d989e5cb866100f3be4f9", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/9332a43983a93eed4a8d989e5cb866100f3be4f9", "committedDate": "2020-05-06T14:26:51Z", "message": "Fetch autocomplete values when autocomplete key is selected"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0be2d24f60b86da32318d200359c3096d2882e37", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/0be2d24f60b86da32318d200359c3096d2882e37", "committedDate": "2020-05-06T15:15:46Z", "message": "Supports strings containing \"=\""}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3MTQzNDkz", "url": "https://github.com/openzipkin/zipkin/pull/3076#pullrequestreview-407143493", "createdAt": "2020-05-07T04:37:58Z", "commit": {"oid": "0be2d24f60b86da32318d200359c3096d2882e37"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QwNDozNzo1OFrOGRuGkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QwNToyNDozM1rOGRu2tQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTIzNDMyMg==", "bodyText": "For new files I've been trying to alphabetize imports, can you try it?", "url": "https://github.com/openzipkin/zipkin/pull/3076#discussion_r421234322", "createdAt": "2020-05-07T04:37:58Z", "author": {"login": "anuraaga"}, "path": "zipkin-lens/src/components/DiscoverPage/DiscoverPage.tsx", "diffHunk": "@@ -0,0 +1,65 @@\n+/* eslint-disable no-shadow */\n+/*\n+ * Copyright 2015-2020 The OpenZipkin Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+import React from 'react';", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0be2d24f60b86da32318d200359c3096d2882e37"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTIzNzE4Mw==", "bodyText": "Instead of passing in history, location you should be able to call useHistory, useLocation in this hook", "url": "https://github.com/openzipkin/zipkin/pull/3076#discussion_r421237183", "createdAt": "2020-05-07T04:49:04Z", "author": {"login": "anuraaga"}, "path": "zipkin-lens/src/components/DiscoverPage/DiscoverPageContent.tsx", "diffHunk": "@@ -0,0 +1,386 @@\n+/*\n+ * Copyright 2015-2020 The OpenZipkin Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+/* eslint-disable no-shadow */\n+import React, { useEffect, useCallback, useState, useMemo } from 'react';\n+import { useDispatch, useSelector } from 'react-redux';\n+import { RouteComponentProps, withRouter } from 'react-router-dom';\n+import {\n+  Box,\n+  Button,\n+  TextField,\n+  CircularProgress,\n+  Paper,\n+} from '@material-ui/core';\n+import { History, Location } from 'history';\n+import moment from 'moment';\n+import { createStyles, makeStyles, Theme } from '@material-ui/core/styles';\n+import { faHistory, faSearch } from '@fortawesome/free-solid-svg-icons';\n+import { FontAwesomeIcon } from '@fortawesome/react-fontawesome';\n+\n+import Criterion from './Criterion';\n+import { Lookback, fixedLookbackMap } from './lookback';\n+import { clearTraces, loadTraces } from '../../actions/traces-action';\n+import SearchBar from './SearchBar';\n+import { RootState } from '../../store';\n+import ExplainBox from './ExplainBox';\n+import LookbackMenu from './LookbackMenu';\n+\n+const TracesTab = require('./TracesTab').default;\n+\n+const useStyles = makeStyles((theme: Theme) =>\n+  createStyles({\n+    limitInput: {\n+      fontSize: '1rem',\n+      height: 31,\n+      padding: `${theme.spacing(0.1)}px ${theme.spacing(1)}px`,\n+    },\n+    searchButton: {\n+      height: 60,\n+      minWidth: 60,\n+      color: theme.palette.common.white,\n+    },\n+    paper: {\n+      height: '100%',\n+    },\n+  }),\n+);\n+\n+interface Props extends RouteComponentProps {}\n+\n+// Export for testing\n+export const useQueryParams = (history: History, location: Location) => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0be2d24f60b86da32318d200359c3096d2882e37"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTI0MjI4Nw==", "bodyText": "Think it's more conventional to use undefined instead of null. For example, in interface definitions there's shorthand for it\ninterface Foo {\n  bar: boolean?;\n}", "url": "https://github.com/openzipkin/zipkin/pull/3076#discussion_r421242287", "createdAt": "2020-05-07T05:08:40Z", "author": {"login": "anuraaga"}, "path": "zipkin-lens/src/components/DiscoverPage/DiscoverPageContent.tsx", "diffHunk": "@@ -0,0 +1,386 @@\n+/*\n+ * Copyright 2015-2020 The OpenZipkin Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+/* eslint-disable no-shadow */\n+import React, { useEffect, useCallback, useState, useMemo } from 'react';\n+import { useDispatch, useSelector } from 'react-redux';\n+import { RouteComponentProps, withRouter } from 'react-router-dom';\n+import {\n+  Box,\n+  Button,\n+  TextField,\n+  CircularProgress,\n+  Paper,\n+} from '@material-ui/core';\n+import { History, Location } from 'history';\n+import moment from 'moment';\n+import { createStyles, makeStyles, Theme } from '@material-ui/core/styles';\n+import { faHistory, faSearch } from '@fortawesome/free-solid-svg-icons';\n+import { FontAwesomeIcon } from '@fortawesome/react-fontawesome';\n+\n+import Criterion from './Criterion';\n+import { Lookback, fixedLookbackMap } from './lookback';\n+import { clearTraces, loadTraces } from '../../actions/traces-action';\n+import SearchBar from './SearchBar';\n+import { RootState } from '../../store';\n+import ExplainBox from './ExplainBox';\n+import LookbackMenu from './LookbackMenu';\n+\n+const TracesTab = require('./TracesTab').default;\n+\n+const useStyles = makeStyles((theme: Theme) =>\n+  createStyles({\n+    limitInput: {\n+      fontSize: '1rem',\n+      height: 31,\n+      padding: `${theme.spacing(0.1)}px ${theme.spacing(1)}px`,\n+    },\n+    searchButton: {\n+      height: 60,\n+      minWidth: 60,\n+      color: theme.palette.common.white,\n+    },\n+    paper: {\n+      height: '100%',\n+    },\n+  }),\n+);\n+\n+interface Props extends RouteComponentProps {}\n+\n+// Export for testing\n+export const useQueryParams = (history: History, location: Location) => {\n+  const setQueryParams = useCallback(\n+    (criteria: Criterion[], lookback: Lookback, limit: number) => {\n+      const params = new URLSearchParams();\n+      criteria.forEach((criterion) => {\n+        params.set(criterion.key, criterion.value);\n+      });\n+      switch (lookback.type) {\n+        case 'fixed':\n+          params.set('lookback', lookback.value);\n+          params.set('endTs', lookback.endTime.valueOf().toString());\n+          break;\n+        case 'custom':\n+          params.set('lookback', 'custom');\n+          params.set('endTs', lookback.endTime.valueOf().toString());\n+          params.set('startTs', lookback.startTime.valueOf().toString());\n+          break;\n+        default:\n+      }\n+      params.set('limit', limit.toString());\n+      history.push({\n+        pathname: location.pathname,\n+        search: params.toString(),\n+      });\n+    },\n+    [history, location.pathname],\n+  );\n+\n+  const criteria = useMemo(() => {\n+    const ret: Criterion[] = [];\n+    const params = new URLSearchParams(location.search);\n+\n+    params.forEach((value, key) => {\n+      switch (key) {\n+        case 'lookback':\n+        case 'startTs':\n+        case 'endTs':\n+        case 'limit':\n+          break;\n+        default:\n+          ret.push({ key, value });\n+          break;\n+      }\n+    });\n+    return ret;\n+  }, [location.search]);\n+\n+  const lookback = useMemo<Lookback | null>(() => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0be2d24f60b86da32318d200359c3096d2882e37"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTI0NjY0NQ==", "bodyText": "I think we should also handle when the lookback is milliseconds, not short durations tring", "url": "https://github.com/openzipkin/zipkin/pull/3076#discussion_r421246645", "createdAt": "2020-05-07T05:24:33Z", "author": {"login": "anuraaga"}, "path": "zipkin-lens/src/components/DiscoverPage/DiscoverPageContent.tsx", "diffHunk": "@@ -0,0 +1,386 @@\n+/*\n+ * Copyright 2015-2020 The OpenZipkin Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+/* eslint-disable no-shadow */\n+import React, { useEffect, useCallback, useState, useMemo } from 'react';\n+import { useDispatch, useSelector } from 'react-redux';\n+import { RouteComponentProps, withRouter } from 'react-router-dom';\n+import {\n+  Box,\n+  Button,\n+  TextField,\n+  CircularProgress,\n+  Paper,\n+} from '@material-ui/core';\n+import { History, Location } from 'history';\n+import moment from 'moment';\n+import { createStyles, makeStyles, Theme } from '@material-ui/core/styles';\n+import { faHistory, faSearch } from '@fortawesome/free-solid-svg-icons';\n+import { FontAwesomeIcon } from '@fortawesome/react-fontawesome';\n+\n+import Criterion from './Criterion';\n+import { Lookback, fixedLookbackMap } from './lookback';\n+import { clearTraces, loadTraces } from '../../actions/traces-action';\n+import SearchBar from './SearchBar';\n+import { RootState } from '../../store';\n+import ExplainBox from './ExplainBox';\n+import LookbackMenu from './LookbackMenu';\n+\n+const TracesTab = require('./TracesTab').default;\n+\n+const useStyles = makeStyles((theme: Theme) =>\n+  createStyles({\n+    limitInput: {\n+      fontSize: '1rem',\n+      height: 31,\n+      padding: `${theme.spacing(0.1)}px ${theme.spacing(1)}px`,\n+    },\n+    searchButton: {\n+      height: 60,\n+      minWidth: 60,\n+      color: theme.palette.common.white,\n+    },\n+    paper: {\n+      height: '100%',\n+    },\n+  }),\n+);\n+\n+interface Props extends RouteComponentProps {}\n+\n+// Export for testing\n+export const useQueryParams = (history: History, location: Location) => {\n+  const setQueryParams = useCallback(\n+    (criteria: Criterion[], lookback: Lookback, limit: number) => {\n+      const params = new URLSearchParams();\n+      criteria.forEach((criterion) => {\n+        params.set(criterion.key, criterion.value);\n+      });\n+      switch (lookback.type) {\n+        case 'fixed':\n+          params.set('lookback', lookback.value);\n+          params.set('endTs', lookback.endTime.valueOf().toString());\n+          break;\n+        case 'custom':\n+          params.set('lookback', 'custom');\n+          params.set('endTs', lookback.endTime.valueOf().toString());\n+          params.set('startTs', lookback.startTime.valueOf().toString());\n+          break;\n+        default:\n+      }\n+      params.set('limit', limit.toString());\n+      history.push({\n+        pathname: location.pathname,\n+        search: params.toString(),\n+      });\n+    },\n+    [history, location.pathname],\n+  );\n+\n+  const criteria = useMemo(() => {\n+    const ret: Criterion[] = [];\n+    const params = new URLSearchParams(location.search);\n+\n+    params.forEach((value, key) => {\n+      switch (key) {\n+        case 'lookback':\n+        case 'startTs':\n+        case 'endTs':\n+        case 'limit':\n+          break;\n+        default:\n+          ret.push({ key, value });\n+          break;\n+      }\n+    });\n+    return ret;\n+  }, [location.search]);\n+\n+  const lookback = useMemo<Lookback | null>(() => {\n+    const ps = new URLSearchParams(location.search);\n+    const lookback = ps.get('lookback');\n+    if (!lookback) {\n+      return null;\n+    }\n+    if (lookback === 'custom') {\n+      const startTs = ps.get('startTs');\n+      const endTs = ps.get('endTs');\n+      if (!endTs || !startTs) {\n+        return null;\n+      }\n+      const startTime = moment(parseInt(startTs, 10));\n+      const endTime = moment(parseInt(endTs, 10));\n+      return {\n+        type: 'custom',\n+        startTime,\n+        endTime,\n+      };\n+    }\n+    const endTs = ps.get('endTs');\n+    if (!endTs) {\n+      return null;\n+    }\n+    const data = fixedLookbackMap[lookback];\n+    if (!data) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0be2d24f60b86da32318d200359c3096d2882e37"}, "originalPosition": 134}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d467d68899b7f4c8b8fd639af9bb1a1083f57880", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/d467d68899b7f4c8b8fd639af9bb1a1083f57880", "committedDate": "2020-06-29T09:08:21Z", "message": "Add styled-components package"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f4a6c3b53fde1a217edbe190c335614803ab5e6", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/7f4a6c3b53fde1a217edbe190c335614803ab5e6", "committedDate": "2020-06-29T09:09:36Z", "message": "Setup styled-component's ThemeProvider and type definition"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b98f762252b7faf4cc2c82046978f4e19a1c9939", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/b98f762252b7faf4cc2c82046978f4e19a1c9939", "committedDate": "2020-06-29T12:06:03Z", "message": "Use styled-components for SuggestionList"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "774228004ee89e1d061c9099a136dc28f4610e8a", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/774228004ee89e1d061c9099a136dc28f4610e8a", "committedDate": "2020-06-29T09:10:08Z", "message": "Use styled-components for SuggestionList"}, "afterCommit": {"oid": "b98f762252b7faf4cc2c82046978f4e19a1c9939", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/b98f762252b7faf4cc2c82046978f4e19a1c9939", "committedDate": "2020-06-29T12:06:03Z", "message": "Use styled-components for SuggestionList"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8c3afb0cf9866cf498356640f349b7ac3eb7e9a", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/e8c3afb0cf9866cf498356640f349b7ac3eb7e9a", "committedDate": "2020-06-30T01:52:24Z", "message": "Change DataTimePicker size"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb97f2c7cef93f20f68afc0fe8349735facd5381", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/bb97f2c7cef93f20f68afc0fe8349735facd5381", "committedDate": "2020-06-30T03:00:45Z", "message": "Allow to set up a millisecond lookbacks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b57d7c40e7c2176e220c254f1920299219dba51d", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/b57d7c40e7c2176e220c254f1920299219dba51d", "committedDate": "2020-06-30T03:29:49Z", "message": "Handle defaultLookback of UiConfig"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb9620e50ba676572405ff1206086705cb532557", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/cb9620e50ba676572405ff1206086705cb532557", "committedDate": "2020-06-30T03:30:02Z", "message": "Fix UiConfig bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d788d950d22d15c03c835b82250dcb69d2380f6", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/5d788d950d22d15c03c835b82250dcb69d2380f6", "committedDate": "2020-07-01T09:04:35Z", "message": "Handle 'tags' correctly"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e256e78b2a568b814406ed8677d0e60ffbee3621", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/e256e78b2a568b814406ed8677d0e60ffbee3621", "committedDate": "2020-07-02T06:36:14Z", "message": "Update DiscoverPageContent unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb05b3779553638da3656c791ad4040422b03be3", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/eb05b3779553638da3656c791ad4040422b03be3", "committedDate": "2020-07-02T07:10:23Z", "message": "Alphabetize imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe2712a3ae241f8d77fd8b5969582ad0a692bac6", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/fe2712a3ae241f8d77fd8b5969582ad0a692bac6", "committedDate": "2020-07-04T12:23:01Z", "message": "Use styled-components for CriterionBox and fix delete-button's style bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d99070fcc4a02c82d7deb68a77b702c5ab57a893", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/d99070fcc4a02c82d7deb68a77b702c5ab57a893", "committedDate": "2020-07-04T12:44:52Z", "message": "Add animations to CriterionBox"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8d98a0bbdb43e77fe71eccdf44f430cc52acfa3", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/e8d98a0bbdb43e77fe71eccdf44f430cc52acfa3", "committedDate": "2020-07-05T07:38:40Z", "message": "Suggestions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87cfb7945eaf157b841440d4d0027b954f19f6f9", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/87cfb7945eaf157b841440d4d0027b954f19f6f9", "committedDate": "2020-07-05T07:58:14Z", "message": "Fix z-index bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ee8e902a7aa8898108bb88c4269315d276d6af3", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/7ee8e902a7aa8898108bb88c4269315d276d6af3", "committedDate": "2020-07-05T14:16:31Z", "message": "Fix query parameter bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "beca61d875c9565cbbd0aeadb4a3bd74f20f88d9", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/beca61d875c9565cbbd0aeadb4a3bd74f20f88d9", "committedDate": "2020-07-05T15:45:39Z", "message": "Add HowToUse component"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1050db6d873ddc931a2dae019ddd745b92921d70", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/1050db6d873ddc931a2dae019ddd745b92921d70", "committedDate": "2020-07-05T16:58:13Z", "message": "Parse duration criteria"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7765ca1d4d59ca999749222e15da2e3ed0a93120", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/7765ca1d4d59ca999749222e15da2e3ed0a93120", "committedDate": "2020-07-05T17:01:01Z", "message": "Update SearchBar unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dccac24e96da428f7a2620a8651c84280b00cb08", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/dccac24e96da428f7a2620a8651c84280b00cb08", "committedDate": "2020-07-05T17:15:33Z", "message": "Setup queryLimit using config.json"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de56bdd1ffa1324ad9f1ae0b64dce3758031b0a4", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/de56bdd1ffa1324ad9f1ae0b64dce3758031b0a4", "committedDate": "2020-07-05T23:27:09Z", "message": "Refactor DiscoverPageContent"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0fdf56bd2beac908497e28fa5245609ccd33cac5", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/0fdf56bd2beac908497e28fa5245609ccd33cac5", "committedDate": "2020-07-05T23:46:44Z", "message": "Update tags explanation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "140f41339caac258de95e4ba25d8105216b70813", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/140f41339caac258de95e4ba25d8105216b70813", "committedDate": "2020-07-05T23:59:55Z", "message": "tags -> tagQuery"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0dcaf8ba8752ee48fb507228f966a62483ccb3f4", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/0dcaf8ba8752ee48fb507228f966a62483ccb3f4", "committedDate": "2020-07-06T00:35:35Z", "message": "Resolve conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bcb5cefdf0b1021270628d91f26219f1d79fc967", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/bcb5cefdf0b1021270628d91f26219f1d79fc967", "committedDate": "2020-07-07T09:23:24Z", "message": "Update copyright"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1ce4e97d86eddbd693442acc6613f0b001888c7", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/f1ce4e97d86eddbd693442acc6613f0b001888c7", "committedDate": "2020-07-08T05:58:29Z", "message": "Update package-lock.json"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88dfa14e90f2b834fb44afb631bb92597389ecd8", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/88dfa14e90f2b834fb44afb631bb92597389ecd8", "committedDate": "2020-07-08T05:58:43Z", "message": "Add CriterionBox unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "899f481fb321fdd2b4bae827e1a7c337c88c5624", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/899f481fb321fdd2b4bae827e1a7c337c88c5624", "committedDate": "2020-07-08T06:55:59Z", "message": "use useLocation and useHistory"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d38094ad2bf5f14f94da8caed609c5c52ef6209f", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/d38094ad2bf5f14f94da8caed609c5c52ef6209f", "committedDate": "2020-07-09T11:07:53Z", "message": "Show spanName and remoteServiceName after serviceName is selected"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2MDM2ODMx", "url": "https://github.com/openzipkin/zipkin/pull/3076#pullrequestreview-446036831", "createdAt": "2020-07-09T23:40:28Z", "commit": {"oid": "d38094ad2bf5f14f94da8caed609c5c52ef6209f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQyMzo0MDoyOVrOGvlSrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQyMzo0MDoyOVrOGvlSrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjU0NzI0NQ==", "bodyText": "I know tagQuery doesn't match the old rest api annotationQuery, but chatted with @tacigar and I think these days almost never someone would put an \"annotation\" in there.\nanyone object to having the UI say tagQuery not annotationQuery? (the rest api is the same regardless as not important enough to change) @openzipkin/core", "url": "https://github.com/openzipkin/zipkin/pull/3076#discussion_r452547245", "createdAt": "2020-07-09T23:40:29Z", "author": {"login": "codefromthecrypt"}, "path": "zipkin-lens/src/components/DiscoverPage/DiscoverPageContent.test.jsx", "diffHunk": "@@ -0,0 +1,215 @@\n+/*\n+ * Copyright 2015-2020 The OpenZipkin Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+/* eslint-disable react/prop-types */\n+\n+import { act, renderHook } from '@testing-library/react-hooks';\n+import { createMemoryHistory } from 'history';\n+import moment from 'moment';\n+import React from 'react';\n+import { Router } from 'react-router-dom';\n+\n+import DiscoverPageContent, {\n+  buildApiQuery,\n+  parseDuration,\n+  useQueryParams,\n+} from './DiscoverPageContent';\n+import render from '../../test/util/render-with-default-settings';\n+\n+describe('useQueryParams', () => {\n+  it('should extract criteria from query string', () => {\n+    const history = createMemoryHistory();\n+    const wrapper = ({ children }) => {\n+      return <Router history={history}>{children}</Router>;\n+    };\n+\n+    history.push({\n+      pathname: '/zipkin/',\n+      // serviceName: serviceA\n+      // spanName: spanB\n+      // remoteServiceName: remoteServiceNameC\n+      // minDuration: 10us\n+      // maxDuration: 100ms\n+      // annotationQuery:\n+      //   key1: value1\n+      //   key2\n+      //   key3: value3\n+      search:\n+        '?serviceName=serviceA&spanName=spanB&remoteServiceName=remoteServiceNameC&minDuration=10us&maxDuration=100ms&annotationQuery=key1%3Dvalue1+and+key2+and+key3%3Dvalue3&limit=10',\n+    });\n+\n+    const { result } = renderHook(() => useQueryParams(['key3']), { wrapper });\n+    expect(result.current.criteria).toEqual([\n+      { key: 'serviceName', value: 'serviceA' },\n+      { key: 'spanName', value: 'spanB' },\n+      { key: 'remoteServiceName', value: 'remoteServiceNameC' },\n+      { key: 'minDuration', value: '10us' },\n+      { key: 'maxDuration', value: '100ms' },\n+      // AnnotationQuery\n+      { key: 'key3', value: 'value3' },\n+      { key: 'tagQuery', value: 'key1=value1 and key2' },", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d38094ad2bf5f14f94da8caed609c5c52ef6209f"}, "originalPosition": 61}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2MDM4NzI5", "url": "https://github.com/openzipkin/zipkin/pull/3076#pullrequestreview-446038729", "createdAt": "2020-07-09T23:46:13Z", "commit": {"oid": "d38094ad2bf5f14f94da8caed609c5c52ef6209f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a7ded3bf0db32b341eb34806da45870d8606dee", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/0a7ded3bf0db32b341eb34806da45870d8606dee", "committedDate": "2020-07-10T04:29:54Z", "message": "Search traces when enter key is pressed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af48cf49ddaf744dadb71e6f71c3a12ecad29d18", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/af48cf49ddaf744dadb71e6f71c3a12ecad29d18", "committedDate": "2020-07-10T07:58:12Z", "message": "Add @types/shortid"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5bec2c1d1f5fcdaea0e8e883304a05db63a71ee", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/f5bec2c1d1f5fcdaea0e8e883304a05db63a71ee", "committedDate": "2020-07-10T07:58:29Z", "message": "Fix key props bug of SearchBar"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2MjQ0OTM5", "url": "https://github.com/openzipkin/zipkin/pull/3076#pullrequestreview-446244939", "createdAt": "2020-07-10T09:07:44Z", "commit": {"oid": "f5bec2c1d1f5fcdaea0e8e883304a05db63a71ee"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQwOTowNzo0NVrOGvv7GA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQwOToyMDowOFrOGvwT5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjcyMTQzMg==", "bodyText": "Are we going to handle this one? I think lookback can be a millisecond value if the user specifies the environment variable for it.", "url": "https://github.com/openzipkin/zipkin/pull/3076#discussion_r452721432", "createdAt": "2020-07-10T09:07:45Z", "author": {"login": "anuraaga"}, "path": "zipkin-lens/src/components/DiscoverPage/DiscoverPageContent.tsx", "diffHunk": "@@ -0,0 +1,386 @@\n+/*\n+ * Copyright 2015-2020 The OpenZipkin Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+/* eslint-disable no-shadow */\n+import React, { useEffect, useCallback, useState, useMemo } from 'react';\n+import { useDispatch, useSelector } from 'react-redux';\n+import { RouteComponentProps, withRouter } from 'react-router-dom';\n+import {\n+  Box,\n+  Button,\n+  TextField,\n+  CircularProgress,\n+  Paper,\n+} from '@material-ui/core';\n+import { History, Location } from 'history';\n+import moment from 'moment';\n+import { createStyles, makeStyles, Theme } from '@material-ui/core/styles';\n+import { faHistory, faSearch } from '@fortawesome/free-solid-svg-icons';\n+import { FontAwesomeIcon } from '@fortawesome/react-fontawesome';\n+\n+import Criterion from './Criterion';\n+import { Lookback, fixedLookbackMap } from './lookback';\n+import { clearTraces, loadTraces } from '../../actions/traces-action';\n+import SearchBar from './SearchBar';\n+import { RootState } from '../../store';\n+import ExplainBox from './ExplainBox';\n+import LookbackMenu from './LookbackMenu';\n+\n+const TracesTab = require('./TracesTab').default;\n+\n+const useStyles = makeStyles((theme: Theme) =>\n+  createStyles({\n+    limitInput: {\n+      fontSize: '1rem',\n+      height: 31,\n+      padding: `${theme.spacing(0.1)}px ${theme.spacing(1)}px`,\n+    },\n+    searchButton: {\n+      height: 60,\n+      minWidth: 60,\n+      color: theme.palette.common.white,\n+    },\n+    paper: {\n+      height: '100%',\n+    },\n+  }),\n+);\n+\n+interface Props extends RouteComponentProps {}\n+\n+// Export for testing\n+export const useQueryParams = (history: History, location: Location) => {\n+  const setQueryParams = useCallback(\n+    (criteria: Criterion[], lookback: Lookback, limit: number) => {\n+      const params = new URLSearchParams();\n+      criteria.forEach((criterion) => {\n+        params.set(criterion.key, criterion.value);\n+      });\n+      switch (lookback.type) {\n+        case 'fixed':\n+          params.set('lookback', lookback.value);\n+          params.set('endTs', lookback.endTime.valueOf().toString());\n+          break;\n+        case 'custom':\n+          params.set('lookback', 'custom');\n+          params.set('endTs', lookback.endTime.valueOf().toString());\n+          params.set('startTs', lookback.startTime.valueOf().toString());\n+          break;\n+        default:\n+      }\n+      params.set('limit', limit.toString());\n+      history.push({\n+        pathname: location.pathname,\n+        search: params.toString(),\n+      });\n+    },\n+    [history, location.pathname],\n+  );\n+\n+  const criteria = useMemo(() => {\n+    const ret: Criterion[] = [];\n+    const params = new URLSearchParams(location.search);\n+\n+    params.forEach((value, key) => {\n+      switch (key) {\n+        case 'lookback':\n+        case 'startTs':\n+        case 'endTs':\n+        case 'limit':\n+          break;\n+        default:\n+          ret.push({ key, value });\n+          break;\n+      }\n+    });\n+    return ret;\n+  }, [location.search]);\n+\n+  const lookback = useMemo<Lookback | null>(() => {\n+    const ps = new URLSearchParams(location.search);\n+    const lookback = ps.get('lookback');\n+    if (!lookback) {\n+      return null;\n+    }\n+    if (lookback === 'custom') {\n+      const startTs = ps.get('startTs');\n+      const endTs = ps.get('endTs');\n+      if (!endTs || !startTs) {\n+        return null;\n+      }\n+      const startTime = moment(parseInt(startTs, 10));\n+      const endTime = moment(parseInt(endTs, 10));\n+      return {\n+        type: 'custom',\n+        startTime,\n+        endTime,\n+      };\n+    }\n+    const endTs = ps.get('endTs');\n+    if (!endTs) {\n+      return null;\n+    }\n+    const data = fixedLookbackMap[lookback];\n+    if (!data) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTI0NjY0NQ=="}, "originalCommit": {"oid": "0be2d24f60b86da32318d200359c3096d2882e37"}, "originalPosition": 134}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjcyMjExNA==", "bodyText": "What's an incorrect default lookback?", "url": "https://github.com/openzipkin/zipkin/pull/3076#discussion_r452722114", "createdAt": "2020-07-10T09:09:09Z", "author": {"login": "anuraaga"}, "path": "zipkin-lens/src/components/DiscoverPage/DiscoverPageContent.tsx", "diffHunk": "@@ -0,0 +1,463 @@\n+/*\n+ * Copyright 2015-2020 The OpenZipkin Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+/* eslint-disable no-shadow */\n+\n+import { faHistory, faSearch } from '@fortawesome/free-solid-svg-icons';\n+import { FontAwesomeIcon } from '@fortawesome/react-fontawesome';\n+import {\n+  Box,\n+  Button,\n+  CircularProgress,\n+  Paper,\n+  TextField,\n+} from '@material-ui/core';\n+import moment from 'moment';\n+import React, { useCallback, useEffect, useMemo, useState } from 'react';\n+import { useDispatch, useSelector } from 'react-redux';\n+import { useHistory, useLocation } from 'react-router-dom';\n+import styled from 'styled-components';\n+\n+import Criterion, { newCriterion } from './Criterion';\n+import ExplainBox from './ExplainBox';\n+import LookbackMenu from './LookbackMenu';\n+import SearchBar from './SearchBar';\n+import { Lookback, fixedLookbackMap, millisecondsToValue } from './lookback';\n+import { useUiConfig } from '../UiConfig';\n+import { clearTraces, loadTraces } from '../../actions/traces-action';\n+import { RootState } from '../../store';\n+\n+const TracesTab = require('./TracesTab').default;\n+\n+const LookbackButton = styled(Button)`\n+  /* Align LookbackButton height with the TextField height. */\n+  padding-top: 7.5px;\n+  padding-bottom: 7.5px;\n+`;\n+\n+const SearchButton = styled(Button)`\n+  height: 60px;\n+  min-width: 60px;\n+  color: ${({ theme }) => theme.palette.common.white};\n+`;\n+\n+const TracesPaper = styled(Paper)`\n+  height: 100%;\n+`;\n+\n+interface DiscoverPageContentProps {\n+  autocompleteKeys: string[];\n+}\n+\n+// Export for testing\n+export const useQueryParams = (autocompleteKeys: string[]) => {\n+  const history = useHistory();\n+  const location = useLocation();\n+\n+  const setQueryParams = useCallback(\n+    (criteria: Criterion[], lookback: Lookback, limit: number) => {\n+      const params = new URLSearchParams();\n+      const annotationQuery: string[] = [];\n+      criteria.forEach((criterion) => {\n+        // If the key is 'tag' or a string included in autocompleteKeys,\n+        // the criterion will be included in annotationQuery.\n+        if (criterion.key === 'tagQuery') {\n+          annotationQuery.push(criterion.value);\n+        } else if (autocompleteKeys.includes(criterion.key)) {\n+          if (criterion.value) {\n+            annotationQuery.push(`${criterion.key}=${criterion.value}`);\n+          } else {\n+            annotationQuery.push(criterion.key);\n+          }\n+        } else {\n+          params.set(criterion.key, criterion.value);\n+        }\n+      });\n+      if (annotationQuery.length > 0) {\n+        params.set('annotationQuery', annotationQuery.join(' and '));\n+      }\n+      switch (lookback.type) {\n+        case 'fixed':\n+          params.set('lookback', lookback.value);\n+          params.set('endTs', lookback.endTime.valueOf().toString());\n+          break;\n+        case 'custom':\n+          params.set('lookback', 'custom');\n+          params.set('endTs', lookback.endTime.valueOf().toString());\n+          params.set('startTs', lookback.startTime.valueOf().toString());\n+          break;\n+        default:\n+      }\n+      params.set('limit', limit.toString());\n+      history.push({\n+        pathname: location.pathname,\n+        search: params.toString(),\n+      });\n+    },\n+    [autocompleteKeys, history, location.pathname],\n+  );\n+\n+  const criteria = useMemo(() => {\n+    const ret: Criterion[] = [];\n+    const params = new URLSearchParams(location.search);\n+\n+    params.forEach((value, key) => {\n+      switch (key) {\n+        case 'lookback':\n+        case 'startTs':\n+        case 'endTs':\n+        case 'limit':\n+          break;\n+        case 'annotationQuery': {\n+          // Split annotationQuery into keys of autocompleteKeys and the others.\n+          // If the autocompleteKeys is ['projectID', 'phase'] and the annotationQuery is\n+          // 'projectID=projectA and phase=BETA and http.path=/api/v1/users and http.method=GET',\n+          // criterion will be like the following.\n+          // [\n+          //   { key: 'tagQuery', value: 'http.path=/api/v1/users and http.method=GET' },\n+          //   { key: 'projectID', value: 'projectA' },\n+          //   { key: 'phase', value: 'BETA' },\n+          // ]\n+          const tagQuery: string[] = [];\n+          const exps = value.split(' and ');\n+          exps.forEach((exp) => {\n+            const strs = exp.split('=');\n+            if (strs.length === 0) {\n+              return;\n+            }\n+            const [key, value] = strs;\n+            if (autocompleteKeys.includes(key)) {\n+              ret.push(newCriterion(key, value || ''));\n+            } else {\n+              tagQuery.push(exp);\n+            }\n+          });\n+          ret.push(newCriterion('tagQuery', tagQuery.join(' and ')));\n+          break;\n+        }\n+        default:\n+          ret.push(newCriterion(key, value));\n+          break;\n+      }\n+    });\n+    return ret;\n+  }, [autocompleteKeys, location.search]);\n+\n+  const lookback = useMemo<Lookback | undefined>(() => {\n+    const ps = new URLSearchParams(location.search);\n+    const lookback = ps.get('lookback');\n+    if (!lookback) {\n+      return undefined;\n+    }\n+    if (lookback === 'custom') {\n+      const startTs = ps.get('startTs');\n+      const endTs = ps.get('endTs');\n+      if (!endTs || !startTs) {\n+        return undefined;\n+      }\n+      const startTime = moment(parseInt(startTs, 10));\n+      const endTime = moment(parseInt(endTs, 10));\n+      return {\n+        type: 'custom',\n+        startTime,\n+        endTime,\n+      };\n+    }\n+    const endTs = ps.get('endTs');\n+    if (!endTs) {\n+      return undefined;\n+    }\n+    const data = fixedLookbackMap[lookback];\n+    if (!data) {\n+      return undefined;\n+    }\n+    return {\n+      type: 'fixed',\n+      value: data.value,\n+      endTime: moment(parseInt(endTs, 10)),\n+    };\n+  }, [location.search]);\n+\n+  const limit = useMemo(() => {\n+    const ps = new URLSearchParams(location.search);\n+    const limit = ps.get('limit');\n+    if (!limit) {\n+      return undefined;\n+    }\n+    return parseInt(limit, 10);\n+  }, [location.search]);\n+\n+  return {\n+    setQueryParams,\n+    criteria,\n+    lookback,\n+    limit,\n+  };\n+};\n+\n+// Export for testing\n+export const parseDuration = (duration: string) => {\n+  const regex = /^(\\d+)(s|ms|us)?$/;\n+  const match = duration.match(regex);\n+\n+  if (!match || match.length < 2) {\n+    return undefined;\n+  }\n+  if (match.length === 2 || typeof match[2] === 'undefined') {\n+    return parseInt(match[1], 10);\n+  }\n+  switch (match[2]) {\n+    case 's':\n+      return parseInt(match[1], 10) * 1000 * 1000;\n+    case 'ms':\n+      return parseInt(match[1], 10) * 1000;\n+    case 'us':\n+      return parseInt(match[1], 10);\n+    default:\n+      return undefined;\n+  }\n+};\n+\n+// Export for testing\n+export const buildApiQuery = (\n+  criteria: Criterion[],\n+  lookback: Lookback,\n+  limit: number,\n+  autocompleteKeys: string[],\n+) => {\n+  const params: { [key: string]: string } = {};\n+  const annotationQuery: string[] = [];\n+  criteria.forEach((criterion) => {\n+    if (criterion.key === 'tagQuery') {\n+      annotationQuery.push(criterion.value);\n+    } else if (autocompleteKeys.includes(criterion.key)) {\n+      if (criterion.value) {\n+        annotationQuery.push(`${criterion.key}=${criterion.value}`);\n+      } else {\n+        annotationQuery.push(criterion.key);\n+      }\n+    } else if (\n+      criterion.key === 'minDuration' ||\n+      criterion.key === 'maxDuration'\n+    ) {\n+      const duration = parseDuration(criterion.value);\n+      if (duration) {\n+        params[criterion.key] = duration.toString();\n+      }\n+    } else {\n+      params[criterion.key] = criterion.value;\n+    }\n+  });\n+  if (annotationQuery.length > 0) {\n+    params.annotationQuery = annotationQuery.join(' and ');\n+  }\n+\n+  params.endTs = lookback.endTime.valueOf().toString();\n+  switch (lookback.type) {\n+    case 'custom': {\n+      const lb = lookback.endTime.valueOf() - lookback.startTime.valueOf();\n+      params.lookback = lb.toString();\n+      break;\n+    }\n+    case 'fixed': {\n+      params.lookback = fixedLookbackMap[lookback.value].duration\n+        .asMilliseconds()\n+        .toString();\n+      break;\n+    }\n+    default:\n+  }\n+\n+  params.limit = limit.toString();\n+  return params;\n+};\n+\n+const useFetchTraces = (\n+  autocompleteKeys: string[],\n+  criteria: Criterion[],\n+  lookback?: Lookback,\n+  limit?: number,\n+) => {\n+  const dispatch = useDispatch();\n+\n+  useEffect(() => {\n+    // For searching, lookback and limit are always required.\n+    // If it doesn't exist, clear traces.\n+    if (!lookback || !limit) {\n+      dispatch(clearTraces());\n+      return;\n+    }\n+\n+    const params = buildApiQuery(criteria, lookback, limit, autocompleteKeys);\n+    dispatch(loadTraces(params));\n+  }, [autocompleteKeys, criteria, dispatch, limit, lookback]);\n+};\n+\n+const DiscoverPageContent: React.FC<DiscoverPageContentProps> = ({\n+  autocompleteKeys,\n+}) => {\n+  const { setQueryParams, criteria, lookback, limit } = useQueryParams(\n+    autocompleteKeys,\n+  );\n+\n+  const [tempCriteria, setTempCriteria] = useState(criteria);\n+\n+  const { defaultLookback, queryLimit } = useUiConfig();\n+  const [tempLookback, setTempLookback] = useState<Lookback>(\n+    lookback || {\n+      type: 'fixed',\n+      // If defaultLookback in config.json is incorrect, use 15m as an initial value.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5bec2c1d1f5fcdaea0e8e883304a05db63a71ee"}, "originalPosition": 320}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjcyMzQwOQ==", "bodyText": "Why is this important?", "url": "https://github.com/openzipkin/zipkin/pull/3076#discussion_r452723409", "createdAt": "2020-07-10T09:11:35Z", "author": {"login": "anuraaga"}, "path": "zipkin-lens/src/components/DiscoverPage/LookbackMenu.tsx", "diffHunk": "@@ -0,0 +1,233 @@\n+/*\n+ * Copyright 2015-2020 The OpenZipkin Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+import {\n+  Box,\n+  Button,\n+  Grid,\n+  List,\n+  ListItem,\n+  ListItemText,\n+  Paper,\n+  Theme,\n+  createStyles,\n+  makeStyles,\n+} from '@material-ui/core';\n+import { KeyboardDateTimePicker } from '@material-ui/pickers';\n+import { MaterialUiPickersDate } from '@material-ui/pickers/typings/date';\n+import moment, { Moment } from 'moment';\n+import React, { useCallback, useRef, useState } from 'react';\n+import { useEvent } from 'react-use';\n+\n+import { fixedLookbackMap, FixedLookbackValue, Lookback } from './lookback';\n+\n+const useStyles = makeStyles((theme: Theme) =>\n+  createStyles({\n+    root: {\n+      position: 'absolute',\n+      top: 35,\n+      left: 0,\n+      height: 300,\n+      width: 500,\n+      zIndex: theme.zIndex.modal,\n+    },\n+    containerGrid: {\n+      height: '100%',\n+    },\n+    fixedLookbackItemGrid: {\n+      height: '100%',\n+      overflowY: 'auto',\n+      borderRight: `1px solid ${theme.palette.divider}`,\n+    },\n+    list: {\n+      padding: 0,\n+    },\n+  }),\n+);\n+\n+interface LookbackMenuProps {\n+  close: () => void;\n+  onChange: (lookback: Lookback) => void;\n+  lookback: Lookback;\n+}\n+\n+const initialStartTime = (lookback: Lookback): Moment => {\n+  if (lookback.type === 'custom') {\n+    return lookback.startTime;\n+  }\n+  return moment().subtract(1, 'h');\n+};\n+\n+const initialEndTime = (lookback: Lookback): Moment => {\n+  if (lookback.type === 'custom') {\n+    return lookback.endTime;\n+  }\n+  return moment();\n+};\n+\n+const LookbackMenu: React.FC<LookbackMenuProps> = ({\n+  close,\n+  onChange,\n+  lookback,\n+}) => {\n+  const classes = useStyles();\n+\n+  // LookbackMenu is closed when click on the outside of the component.\n+  // This state is needed to prevent LookbackMenu component from closing\n+  // when the dialog of DateTimePicker is clicked.\n+  const [isOpeningDialog, setIsOpeningDialog] = useState(false);\n+\n+  const handleDialogOpen = useCallback(() => {\n+    setIsOpeningDialog(true);\n+  }, []);\n+\n+  const handleDialogClose = useCallback(() => {\n+    // Use setTimeout to change isOpeningDialog state after\n+    // handleOutsideClick callback function is executed.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5bec2c1d1f5fcdaea0e8e883304a05db63a71ee"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjcyMzU5Mw==", "bodyText": "Looks like you can combine the ifs", "url": "https://github.com/openzipkin/zipkin/pull/3076#discussion_r452723593", "createdAt": "2020-07-10T09:11:55Z", "author": {"login": "anuraaga"}, "path": "zipkin-lens/src/components/DiscoverPage/LookbackMenu.tsx", "diffHunk": "@@ -0,0 +1,233 @@\n+/*\n+ * Copyright 2015-2020 The OpenZipkin Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+import {\n+  Box,\n+  Button,\n+  Grid,\n+  List,\n+  ListItem,\n+  ListItemText,\n+  Paper,\n+  Theme,\n+  createStyles,\n+  makeStyles,\n+} from '@material-ui/core';\n+import { KeyboardDateTimePicker } from '@material-ui/pickers';\n+import { MaterialUiPickersDate } from '@material-ui/pickers/typings/date';\n+import moment, { Moment } from 'moment';\n+import React, { useCallback, useRef, useState } from 'react';\n+import { useEvent } from 'react-use';\n+\n+import { fixedLookbackMap, FixedLookbackValue, Lookback } from './lookback';\n+\n+const useStyles = makeStyles((theme: Theme) =>\n+  createStyles({\n+    root: {\n+      position: 'absolute',\n+      top: 35,\n+      left: 0,\n+      height: 300,\n+      width: 500,\n+      zIndex: theme.zIndex.modal,\n+    },\n+    containerGrid: {\n+      height: '100%',\n+    },\n+    fixedLookbackItemGrid: {\n+      height: '100%',\n+      overflowY: 'auto',\n+      borderRight: `1px solid ${theme.palette.divider}`,\n+    },\n+    list: {\n+      padding: 0,\n+    },\n+  }),\n+);\n+\n+interface LookbackMenuProps {\n+  close: () => void;\n+  onChange: (lookback: Lookback) => void;\n+  lookback: Lookback;\n+}\n+\n+const initialStartTime = (lookback: Lookback): Moment => {\n+  if (lookback.type === 'custom') {\n+    return lookback.startTime;\n+  }\n+  return moment().subtract(1, 'h');\n+};\n+\n+const initialEndTime = (lookback: Lookback): Moment => {\n+  if (lookback.type === 'custom') {\n+    return lookback.endTime;\n+  }\n+  return moment();\n+};\n+\n+const LookbackMenu: React.FC<LookbackMenuProps> = ({\n+  close,\n+  onChange,\n+  lookback,\n+}) => {\n+  const classes = useStyles();\n+\n+  // LookbackMenu is closed when click on the outside of the component.\n+  // This state is needed to prevent LookbackMenu component from closing\n+  // when the dialog of DateTimePicker is clicked.\n+  const [isOpeningDialog, setIsOpeningDialog] = useState(false);\n+\n+  const handleDialogOpen = useCallback(() => {\n+    setIsOpeningDialog(true);\n+  }, []);\n+\n+  const handleDialogClose = useCallback(() => {\n+    // Use setTimeout to change isOpeningDialog state after\n+    // handleOutsideClick callback function is executed.\n+    window.setTimeout(() => {\n+      setIsOpeningDialog(false);\n+    }, 0);\n+  }, []);\n+\n+  const el = useRef<HTMLDivElement>();\n+\n+  const handleOutsideClick = useCallback(\n+    (event: any) => {\n+      if (!isOpeningDialog) {\n+        if (!el.current) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5bec2c1d1f5fcdaea0e8e883304a05db63a71ee"}, "originalPosition": 108}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjcyNDM2Ng==", "bodyText": "Can we use a more descriptive name than ss? Not sure what ss stands for here", "url": "https://github.com/openzipkin/zipkin/pull/3076#discussion_r452724366", "createdAt": "2020-07-10T09:13:32Z", "author": {"login": "anuraaga"}, "path": "zipkin-lens/src/components/DiscoverPage/SearchBar/CriterionBox.tsx", "diffHunk": "@@ -0,0 +1,458 @@\n+/*\n+ * Copyright 2015-2020 The OpenZipkin Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+/* eslint-disable no-shadow */\n+\n+import { faTimes } from '@fortawesome/free-solid-svg-icons';\n+import { FontAwesomeIcon } from '@fortawesome/react-fontawesome';\n+import { Box, ClickAwayListener } from '@material-ui/core';\n+import React, {\n+  useCallback,\n+  useEffect,\n+  useMemo,\n+  useRef,\n+  useState,\n+} from 'react';\n+import { useMount } from 'react-use';\n+import styled, { keyframes } from 'styled-components';\n+\n+import HowToUse from './HowToUse';\n+import SuggestionList from './SuggestionList';\n+import Criterion, { newCriterion } from '../Criterion';\n+\n+const fadeIn = keyframes`\n+  0% { opacity: 0 }\n+  30% { opacity: 0.1 }\n+  70% { opacity: 0.9 }\n+  100% { opacity: 1 }\n+`;\n+\n+const Root = styled(Box)`\n+  display: flex;\n+  height: 40px;\n+  border-radius: 3px;\n+  box-shadow: ${({ theme }) => theme.shadows[1]};\n+  overflow: hidden;\n+  margin-right: ${({ theme }) => theme.spacing(1)}px;\n+  font-size: 1.1rem;\n+  color: ${({ theme }) => theme.palette.common.white};\n+  cursor: pointer;\n+  & > *:hover {\n+    opacity: 0.9;\n+  }\n+  animation: 0.25s 0s both ${fadeIn};\n+`;\n+\n+const FocusedRoot = styled(Box)`\n+  margin-right: ${({ theme }) => theme.spacing(2)}px;\n+  position: relative;\n+  animation: 0.25s 0s both ${fadeIn};\n+  z-index: ${({ theme }) => theme.zIndex.modal};\n+`;\n+\n+const DeleteButton = styled.button`\n+  height: 100%;\n+  width: 30;\n+  color: ${({ theme }) => theme.palette.common.white};\n+  background-color: ${({ theme }) => theme.palette.primary.main};\n+  cursor: pointer;\n+  border: none;\n+  &:focus {\n+    outline: none;\n+  }\n+`;\n+\n+const Input = styled.input.attrs(() => ({\n+  'data-testid': 'criterion-input',\n+}))`\n+  width: 350px;\n+  height: 40px;\n+  padding: 10px;\n+  box-sizing: border-box;\n+  font-size: 1.1rem;\n+`;\n+\n+interface CriterionBoxProps {\n+  criteria: Criterion[];\n+  criterion: Criterion;\n+  serviceNames: string[];\n+  remoteServiceNames: string[];\n+  spanNames: string[];\n+  autocompleteKeys: string[];\n+  autocompleteValues: string[];\n+  isLoadingServiceNames: boolean;\n+  isLoadingRemoteServiceNames: boolean;\n+  isLoadingSpanNames: boolean;\n+  isLoadingAutocompleteValues: boolean;\n+  isFocused: boolean;\n+  onFocus: () => void;\n+  onBlur: () => void;\n+  onDecide: () => void;\n+  onChange: (criterion: Criterion) => void;\n+  onDelete: () => void;\n+  loadAutocompleteValues: (autocompleteKey: string) => void;\n+}\n+\n+const initialText = (criterion: Criterion) => {\n+  if (criterion.key) {\n+    if (criterion.value) {\n+      return `${criterion.key}=${criterion.value}`;\n+    }\n+    return `${criterion.key}=`;\n+  }\n+  return '';\n+};\n+\n+const CriterionBox: React.FC<CriterionBoxProps> = ({\n+  criteria,\n+  criterion,\n+  serviceNames,\n+  remoteServiceNames,\n+  spanNames,\n+  autocompleteKeys,\n+  autocompleteValues,\n+  isLoadingServiceNames,\n+  isLoadingRemoteServiceNames,\n+  isLoadingSpanNames,\n+  isLoadingAutocompleteValues,\n+  isFocused,\n+  onFocus,\n+  onBlur,\n+  onDecide,\n+  onChange,\n+  onDelete,\n+  loadAutocompleteValues,\n+}) => {\n+  const inputEl = useRef<HTMLInputElement>(null);\n+\n+  const [text, setText] = useState(initialText(criterion));\n+  const [fixedText, setFixedText] = useState(initialText(criterion));\n+\n+  useMount(() => {\n+    if (inputEl.current) {\n+      inputEl.current.focus();\n+    }\n+  });\n+\n+  const prevIsFocused = useRef(isFocused);\n+  useEffect(() => {\n+    if (prevIsFocused.current && !isFocused) {\n+      if (!fixedText) {\n+        onDelete();\n+        return;\n+      }\n+      let ss = fixedText.split('=');", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5bec2c1d1f5fcdaea0e8e883304a05db63a71ee"}, "originalPosition": 155}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjcyNzc4MQ==", "bodyText": "As far as I can tell this callback pattern has bad performance since the functions all get initialized every render. Instead of using the index factory can't you do something like useCallback((criterion) => criteria.find(c => c.id == criterion.id)?", "url": "https://github.com/openzipkin/zipkin/pull/3076#discussion_r452727781", "createdAt": "2020-07-10T09:20:08Z", "author": {"login": "anuraaga"}, "path": "zipkin-lens/src/components/DiscoverPage/SearchBar/SearchBar.tsx", "diffHunk": "@@ -0,0 +1,262 @@\n+/*\n+ * Copyright 2015-2020 The OpenZipkin Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+import { faPlus } from '@fortawesome/free-solid-svg-icons';\n+import { FontAwesomeIcon } from '@fortawesome/react-fontawesome';\n+import {\n+  Box,\n+  Button,\n+  Theme,\n+  createStyles,\n+  makeStyles,\n+} from '@material-ui/core';\n+import React, { useCallback, useEffect, useRef, useState } from 'react';\n+import { connect } from 'react-redux';\n+import { ThunkDispatch } from 'redux-thunk';\n+\n+import Criterion, { newCriterion } from '../Criterion';\n+import CriterionBox from './CriterionBox';\n+import { fetchAutocompleteValues } from '../../../actions/autocomplete-values-action';\n+import { fetchRemoteServices } from '../../../actions/remote-services-action';\n+import { fetchServices } from '../../../actions/services-action';\n+import { fetchSpans } from '../../../actions/spans-action';\n+import RootState from '../../../types/RootState';\n+\n+const useStyles = makeStyles((theme: Theme) =>\n+  createStyles({\n+    addButton: {\n+      height: 40,\n+      width: 40,\n+      minWidth: 40,\n+      color: theme.palette.common.white,\n+    },\n+  }),\n+);\n+\n+type SearchBarProps = {\n+  searchTraces: () => void;\n+  criteria: Criterion[];\n+  onChange: (criteria: Criterion[]) => void;\n+  serviceNames: string[];\n+  isLoadingServiceNames: boolean;\n+  spanNames: string[];\n+  isLoadingSpanNames: boolean;\n+  remoteServiceNames: string[];\n+  isLoadingRemoteServiceNames: boolean;\n+  autocompleteKeys: string[];\n+  autocompleteValues: string[];\n+  isLoadingAutocompleteValues: boolean;\n+  loadServices: () => void;\n+  loadRemoteServices: (serviceName: string) => void;\n+  loadSpans: (serviceName: string) => void;\n+  loadAutocompleteValues: (autocompleteKey: string) => void;\n+};\n+\n+export const SearchBarImpl: React.FC<SearchBarProps> = ({\n+  searchTraces,\n+  criteria,\n+  onChange,\n+  serviceNames,\n+  isLoadingServiceNames,\n+  spanNames,\n+  isLoadingSpanNames,\n+  remoteServiceNames,\n+  isLoadingRemoteServiceNames,\n+  autocompleteKeys,\n+  autocompleteValues,\n+  isLoadingAutocompleteValues,\n+  loadServices,\n+  loadRemoteServices,\n+  loadSpans,\n+  loadAutocompleteValues,\n+}) => {\n+  const classes = useStyles();\n+\n+  // criterionIndex is the index of the criterion currently being edited.\n+  // If the value is -1, there is no criterion being edited.\n+  const [criterionIndex, setCriterionIndex] = useState(-1);\n+\n+  const handleCriterionFocus = (index: number) => () => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5bec2c1d1f5fcdaea0e8e883304a05db63a71ee"}, "originalPosition": 90}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93ca037c3fc6d2025e21a094775ef27d55d92b6e", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/93ca037c3fc6d2025e21a094775ef27d55d92b6e", "committedDate": "2020-07-10T09:57:19Z", "message": "Combine ifs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2bc31581c7a331ee43145f8d480171f54f1e68ee", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/2bc31581c7a331ee43145f8d480171f54f1e68ee", "committedDate": "2020-07-10T10:30:32Z", "message": "Don't support milliseconds in custom lookback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ea978787612dab7716b6d00d229c3f7c8af2c08", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/6ea978787612dab7716b6d00d229c3f7c8af2c08", "committedDate": "2020-07-10T10:54:25Z", "message": "Update unit tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2OTgyOTc1", "url": "https://github.com/openzipkin/zipkin/pull/3076#pullrequestreview-446982975", "createdAt": "2020-07-13T05:04:41Z", "commit": {"oid": "6ea978787612dab7716b6d00d229c3f7c8af2c08"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QwNTowNDo0MlrOGwbj9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QwNTowNDo0MlrOGwbj9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQzNjQwNQ==", "bodyText": "More specifically, we should have a test where this is set to an arbitrary milliseconds like 1234567", "url": "https://github.com/openzipkin/zipkin/pull/3076#discussion_r453436405", "createdAt": "2020-07-13T05:04:42Z", "author": {"login": "anuraaga"}, "path": "zipkin-lens/src/components/DiscoverPage/DiscoverPageContent.test.jsx", "diffHunk": "@@ -0,0 +1,221 @@\n+/*\n+ * Copyright 2015-2020 The OpenZipkin Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+/* eslint-disable react/prop-types */\n+\n+import { act, renderHook } from '@testing-library/react-hooks';\n+import { createMemoryHistory } from 'history';\n+import moment from 'moment';\n+import React from 'react';\n+import { Router } from 'react-router-dom';\n+\n+import DiscoverPageContent, {\n+  buildApiQuery,\n+  parseDuration,\n+  useQueryParams,\n+} from './DiscoverPageContent';\n+import render from '../../test/util/render-with-default-settings';\n+\n+describe('useQueryParams', () => {\n+  it('should extract criteria from query string', () => {\n+    const history = createMemoryHistory();\n+    const wrapper = ({ children }) => {\n+      return <Router history={history}>{children}</Router>;\n+    };\n+\n+    history.push({\n+      pathname: '/zipkin/',\n+      // serviceName: serviceA\n+      // spanName: spanB\n+      // remoteServiceName: remoteServiceNameC\n+      // minDuration: 10us\n+      // maxDuration: 100ms\n+      // annotationQuery:\n+      //   key1: value1\n+      //   key2\n+      //   key3: value3\n+      search:\n+        '?serviceName=serviceA&spanName=spanB&remoteServiceName=remoteServiceNameC&minDuration=10us&maxDuration=100ms&annotationQuery=key1%3Dvalue1+and+key2+and+key3%3Dvalue3&limit=10',\n+    });\n+\n+    const { result } = renderHook(() => useQueryParams(['key3']), { wrapper });\n+\n+    const expected = [\n+      { key: 'serviceName', value: 'serviceA' },\n+      { key: 'spanName', value: 'spanB' },\n+      { key: 'remoteServiceName', value: 'remoteServiceNameC' },\n+      { key: 'minDuration', value: '10us' },\n+      { key: 'maxDuration', value: '100ms' },\n+      // AnnotationQuery\n+      { key: 'key3', value: 'value3' },\n+      { key: 'tagQuery', value: 'key1=value1 and key2' },\n+    ];\n+\n+    for (let i = 0; i < expected.length; i += 1) {\n+      expect(result.current.criteria[i].key).toBe(expected[i].key);\n+      expect(result.current.criteria[i].value).toBe(expected[i].value);\n+    }\n+  });\n+\n+  it('should extract custom lookback from query string', () => {\n+    const history = createMemoryHistory();\n+    const wrapper = ({ children }) => {\n+      return <Router history={history}>{children}</Router>;\n+    };\n+    history.push({\n+      pathname: '/zipkin/',\n+      search: '?lookback=custom&startTs=1588558961791&endTs=1588558961791',\n+    });\n+\n+    const { result } = renderHook(() => useQueryParams([]), { wrapper });\n+    expect(result.current.lookback.type).toBe('custom');\n+    expect(result.current.lookback.startTime.valueOf()).toBe(1588558961791);\n+    expect(result.current.lookback.endTime.valueOf()).toBe(1588558961791);\n+  });\n+\n+  it('should extract fixed lookback from query string', () => {\n+    const history = createMemoryHistory();\n+    const wrapper = ({ children }) => {\n+      return <Router history={history}>{children}</Router>;\n+    };\n+    history.push({\n+      pathname: '/zipkin/',\n+      search: '?lookback=2h&endTs=1588558961791',\n+    });\n+\n+    const { result } = renderHook(() => useQueryParams([]), { wrapper });\n+    expect(result.current.lookback.type).toBe('fixed');\n+    expect(result.current.lookback.value).toBe('2h');\n+    expect(result.current.lookback.endTime.valueOf()).toBe(1588558961791);\n+  });\n+\n+  it('should extract limit from query string', () => {\n+    const history = createMemoryHistory();\n+    const wrapper = ({ children }) => {\n+      return <Router history={history}>{children}</Router>;\n+    };\n+    history.push({\n+      pathname: '/zipkin/',\n+      search: '?limit=300',\n+    });\n+\n+    const { result } = renderHook(() => useQueryParams([]), { wrapper });\n+    expect(result.current.limit).toBe(300);\n+  });\n+\n+  it('should set query string using setQueryParams', () => {\n+    const history = createMemoryHistory();\n+    const wrapper = ({ children }) => {\n+      return <Router history={history}>{children}</Router>;\n+    };\n+    history.push({\n+      pathname: '/zipkin/',\n+      search: '?limit=300',\n+    });\n+\n+    const { result } = renderHook(() => useQueryParams(['key3']), { wrapper });\n+\n+    act(() => {\n+      result.current.setQueryParams(\n+        [\n+          { key: 'serviceName', value: 'serviceA' },\n+          { key: 'spanName', value: 'spanB' },\n+          { key: 'remoteServiceName', value: 'remoteServiceNameC' },\n+          // Durations will NOT converted to microsecond values.\n+          { key: 'minDuration', value: '10us' },\n+          { key: 'maxDuration', value: '100ms' },\n+          // AnnotationQuery\n+          { key: 'tagQuery', value: 'key1=value1 and key2' },\n+          { key: 'key3', value: 'value3' },\n+        ],\n+        {\n+          type: 'fixed',\n+          endTime: moment(1588558961791),\n+          value: '2h',\n+        },\n+        10,\n+      );\n+    });\n+    expect(history.location.search).toBe(\n+      '?serviceName=serviceA&spanName=spanB&remoteServiceName=remoteServiceNameC&minDuration=10us&maxDuration=100ms&annotationQuery=key1%3Dvalue1+and+key2+and+key3%3Dvalue3&lookback=2h&endTs=1588558961791&limit=10',\n+    );\n+  });\n+});\n+\n+it('parseDuration', () => {\n+  [\n+    { in: '35', out: 35 },\n+    { in: '35us', out: 35 },\n+    { in: '35ms', out: 35 * 1000 },\n+    { in: '35s', out: 35 * 1000 * 1000 },\n+  ].forEach((e) => {\n+    expect(parseDuration(e.in)).toBe(e.out);\n+  });\n+});\n+\n+describe('buildApiQuery', () => {\n+  it('should build API Query', () => {\n+    const params = buildApiQuery(\n+      [\n+        { key: 'serviceName', value: 'serviceA' },\n+        { key: 'spanName', value: 'spanB' },\n+        { key: 'remoteServiceName', value: 'remoteServiceNameC' },\n+        // Durations will converted to microsecond values.\n+        { key: 'minDuration', value: '10us' },\n+        { key: 'maxDuration', value: '100ms' },\n+        // AnnotationQuery\n+        { key: 'tagQuery', value: 'key1=value1 and key2' },\n+        { key: 'key3', value: 'value3' },\n+      ],\n+      {\n+        type: 'fixed',\n+        endTime: moment(1588558961791),\n+        value: '2h',\n+      },\n+      30,\n+      ['key3'],\n+    );\n+    expect(params.serviceName).toBe('serviceA');\n+    expect(params.spanName).toBe('spanB');\n+    expect(params.remoteServiceName).toBe('remoteServiceNameC');\n+    expect(params.minDuration).toBe('10');\n+    expect(params.maxDuration).toBe('100000');\n+    expect(params.annotationQuery).toBe('key1=value1 and key2 and key3=value3');\n+    expect(params.lookback).toBe('7200000');\n+    expect(params.endTs).toBe('1588558961791');\n+    expect(params.limit).toBe('30');\n+  });\n+});\n+\n+describe('<DiscoverPageContent />', () => {\n+  it('should initialize the lookback using config.json', () => {\n+    const { getAllByText } = render(<DiscoverPageContent />, {\n+      uiConfig: {\n+        defaultLookback: 60 * 1000 * 5, // 5m", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ea978787612dab7716b6d00d229c3f7c8af2c08"}, "originalPosition": 205}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dea013bd9c704a580f3187f385ff58f885d31f4c", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/dea013bd9c704a580f3187f385ff58f885d31f4c", "committedDate": "2020-08-01T18:38:36Z", "message": "Support specifying a lookback in any millisecond"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b626f13a3dcfd5fc74393139d8258d78db52c7f", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/0b626f13a3dcfd5fc74393139d8258d78db52c7f", "committedDate": "2020-08-05T14:28:26Z", "message": "Fix bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66288829262404dbeaf112ba8b76efc7b46465ae", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/66288829262404dbeaf112ba8b76efc7b46465ae", "committedDate": "2020-08-05T14:43:45Z", "message": "Fix DiscoverPageContent unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43a92f087df57c13bbfd5bf2177c3227927a01d6", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/43a92f087df57c13bbfd5bf2177c3227927a01d6", "committedDate": "2020-08-05T15:56:30Z", "message": "Add defaultLookback test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c15ef7dfa62d15fdab2915509c2f52465d479674", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/c15ef7dfa62d15fdab2915509c2f52465d479674", "committedDate": "2020-08-05T17:07:41Z", "message": "Fix CriterionBox behavior"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "449ade050e51f21606bc20ffc6234d8ec2f6a89e", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/449ade050e51f21606bc20ffc6234d8ec2f6a89e", "committedDate": "2020-08-06T11:46:48Z", "message": "Merge branch 'master' into tacigar/search-bar"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "72e1188a78e4dbfbb80c80085d85b1d1a55cb6a4", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/72e1188a78e4dbfbb80c80085d85b1d1a55cb6a4", "committedDate": "2020-08-06T11:40:08Z", "message": "Merge branch 'master' into tacigar/search-bar"}, "afterCommit": {"oid": "449ade050e51f21606bc20ffc6234d8ec2f6a89e", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/449ade050e51f21606bc20ffc6234d8ec2f6a89e", "committedDate": "2020-08-06T11:46:48Z", "message": "Merge branch 'master' into tacigar/search-bar"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d30771761f26c5a1d70343a64ccd5f0b55e88e28", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/d30771761f26c5a1d70343a64ccd5f0b55e88e28", "committedDate": "2020-08-06T12:11:55Z", "message": "Optimize"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5ebfa5fc77278bab574e71e9f2adb2213042cb1b", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/5ebfa5fc77278bab574e71e9f2adb2213042cb1b", "committedDate": "2020-08-06T12:09:15Z", "message": "Optimize"}, "afterCommit": {"oid": "d30771761f26c5a1d70343a64ccd5f0b55e88e28", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/d30771761f26c5a1d70343a64ccd5f0b55e88e28", "committedDate": "2020-08-06T12:11:55Z", "message": "Optimize"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff86e2944159b8d56052c8568a44dff2ce933fd0", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/ff86e2944159b8d56052c8568a44dff2ce933fd0", "committedDate": "2020-08-06T12:18:04Z", "message": "Change design a bit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9a323328ca82bda4c2de49cbc79ff50c8b293a0", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/e9a323328ca82bda4c2de49cbc79ff50c8b293a0", "committedDate": "2020-08-07T02:17:21Z", "message": "Fix bugs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzMTAxNTM4", "url": "https://github.com/openzipkin/zipkin/pull/3076#pullrequestreview-463101538", "createdAt": "2020-08-07T07:43:31Z", "commit": {"oid": "e9a323328ca82bda4c2de49cbc79ff50c8b293a0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23ed3be7fc58879d0a79e853d9af0a55cc4e0ef3", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/23ed3be7fc58879d0a79e853d9af0a55cc4e0ef3", "committedDate": "2020-08-07T10:00:10Z", "message": "Update unit tests"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1406, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}