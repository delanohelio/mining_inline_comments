{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYwMjk0Nzgx", "number": 2956, "title": "Fix orphaned spans bug", "bodyText": "Fix an obvious bug pointed out in #2922 .\nMainly change the calculation method of shownTree.\nPreviously, span ID was used to calculate the span's parent-child relationship and Expand/Collapse buttons were implemented using that parent-child relationship.\nThis created the orphaned span problem pointed out in #2922 because orphaned spans don't have parent-child relationship using span IDs.\nPlease see here. Orphan spans are simply appended to the root span:\n\n  \n    \n      zipkin/zipkin-lens/src/zipkin/span-node.js\n    \n    \n        Lines 272 to 276\n      in\n      8a5609a\n    \n    \n    \n    \n\n        \n          \n           if (!parent) { // Handle headless by attaching spans missing parents to root \n        \n\n        \n          \n             this._rootSpan.addChild(child); \n        \n\n        \n          \n           } else { \n        \n\n        \n          \n             parent.addChild(child); \n        \n\n        \n          \n           } \n        \n    \n  \n\n\nThis PR uses span indices to calculate parent-child relationship instead of span IDs.\np.s. TraceSummary component is fairly complex, so I wanted to create custom hooks and improve readability, but I'm not doing it now to minimize PR.\nBefore\n\nAfter", "createdAt": "2020-01-08T05:56:52Z", "url": "https://github.com/openzipkin/zipkin/pull/2956", "merged": true, "mergeCommit": {"oid": "d772581581fd5153f3df9290ed77da278404d2e0"}, "closed": true, "closedAt": "2020-01-15T02:31:08Z", "author": {"login": "tacigar"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb4Ok9sAH2gAyMzYwMjk0NzgxOmQyMzRmYzA4OTRhZmEwNWJhNmQ1ODYxNTI1MzExYTM4YWE2MGUzNjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb6M4x8gFqTM0MjM2Mzc4NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d234fc0894afa05ba6d5861525311a38aa60e368", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/d234fc0894afa05ba6d5861525311a38aa60e368", "committedDate": "2020-01-08T05:33:44Z", "message": "Fix orphaned spans bug"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5NjYwNDQ1", "url": "https://github.com/openzipkin/zipkin/pull/2956#pullrequestreview-339660445", "createdAt": "2020-01-08T06:04:52Z", "commit": {"oid": "d234fc0894afa05ba6d5861525311a38aa60e368"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQwNjowNDo1MlrOFbNZeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQwNjowNToxNVrOFbNZvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDA3NTM4NQ==", "bodyText": "This logic is pretty complex, can you add some comments? In particular, this propagation of skip is confusing me.", "url": "https://github.com/openzipkin/zipkin/pull/2956#discussion_r364075385", "createdAt": "2020-01-08T06:04:52Z", "author": {"login": "anuraaga"}, "path": "zipkin-lens/src/components/TracePage/TraceSummary.jsx", "diffHunk": "@@ -80,19 +83,34 @@ const TraceSummary = React.memo(({ traceSummary }) => {\n   }, [isRootedTrace, rootSpanIndex, traceSummary.spans]);\n \n   const shownTree = useMemo(() => {\n-    const allHiddenSpanIds = {};\n-    rerootedTree.forEach((span) => {\n-      if (childrenHiddenSpanIds[span.parentId]) {\n-        allHiddenSpanIds[span.spanId] = true;\n+    let depth = 0;\n+    let skip = false;\n+\n+    return rerootedTree.reduce((acc, cur) => {\n+      if (cur.depth > depth && skip) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d234fc0894afa05ba6d5861525311a38aa60e368"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDA3NTQ1Mw==", "bodyText": "Let's use semantic names instead of acc, cur - I think it's shownTraces, trace?", "url": "https://github.com/openzipkin/zipkin/pull/2956#discussion_r364075453", "createdAt": "2020-01-08T06:05:15Z", "author": {"login": "anuraaga"}, "path": "zipkin-lens/src/components/TracePage/TraceSummary.jsx", "diffHunk": "@@ -80,19 +83,34 @@ const TraceSummary = React.memo(({ traceSummary }) => {\n   }, [isRootedTrace, rootSpanIndex, traceSummary.spans]);\n \n   const shownTree = useMemo(() => {\n-    const allHiddenSpanIds = {};\n-    rerootedTree.forEach((span) => {\n-      if (childrenHiddenSpanIds[span.parentId]) {\n-        allHiddenSpanIds[span.spanId] = true;\n+    let depth = 0;\n+    let skip = false;\n+\n+    return rerootedTree.reduce((acc, cur) => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d234fc0894afa05ba6d5861525311a38aa60e368"}, "originalPosition": 43}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1dd7a9ae56a29d64b46c4cc63044d14b2bb303c", "author": {"user": {"login": "tacigar", "name": "tacigar"}}, "url": "https://github.com/openzipkin/zipkin/commit/b1dd7a9ae56a29d64b46c4cc63044d14b2bb303c", "committedDate": "2020-01-09T04:00:28Z", "message": "Simplify calculation of shownTree"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyMzYzNzg0", "url": "https://github.com/openzipkin/zipkin/pull/2956#pullrequestreview-342363784", "createdAt": "2020-01-14T08:43:25Z", "commit": {"oid": "b1dd7a9ae56a29d64b46c4cc63044d14b2bb303c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1569, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}