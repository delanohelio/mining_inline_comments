{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcyODc1Nzc5", "number": 3189, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQwMTo1NTo1NVrOEb1dCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQwMzoyNDozOFrOEb3bnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3NjIyNzk1OnYy", "diffSide": "RIGHT", "path": "docker/collector/kafka/Dockerfile", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQwMTo1NTo1NVrOHGAOEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQwMTo1NTo1NVrOHGAOEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjA1NzEwNg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            # All Kafka content including binaries logs writes under WORKDIR\n          \n          \n            \n            # All Kafka content including binaries and logs write under WORKDIR", "url": "https://github.com/openzipkin/zipkin/pull/3189#discussion_r476057106", "createdAt": "2020-08-25T01:55:55Z", "author": {"login": "codefromthecrypt"}, "path": "docker/collector/kafka/Dockerfile", "diffHunk": "@@ -26,17 +25,19 @@ RUN /tmp/install && rm /tmp/install\n FROM openzipkin/jre-full:14.0.2-14.29.23\n LABEL MAINTAINER Zipkin \"https://zipkin.io/\"\n \n-# add HEALTHCHECK and ENTRYPOINT scripts\n+# Add HEALTHCHECK and ENTRYPOINT scripts\n COPY docker/collector/kafka/docker-bin/* /usr/local/bin/\n \n-# setup non-root user and its home dir\n+# All Kafka content including binaries logs writes under WORKDIR", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ed87e6cd86c9e8e5769910497d894cd39f97e46"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3NjIzMDQ4OnYy", "diffSide": "LEFT", "path": "docker/collector/kafka/Dockerfile", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQwMTo1NjozNlrOHGAP0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQwMTo1NjozNlrOHGAP0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjA1NzU1Mg==", "bodyText": "note: the workdir is now decoupled from the convention", "url": "https://github.com/openzipkin/zipkin/pull/3189#discussion_r476057552", "createdAt": "2020-08-25T01:56:36Z", "author": {"login": "codefromthecrypt"}, "path": "docker/collector/kafka/Dockerfile", "diffHunk": "@@ -26,17 +25,19 @@ RUN /tmp/install && rm /tmp/install\n FROM openzipkin/jre-full:14.0.2-14.29.23\n LABEL MAINTAINER Zipkin \"https://zipkin.io/\"\n \n-# add HEALTHCHECK and ENTRYPOINT scripts\n+# Add HEALTHCHECK and ENTRYPOINT scripts\n COPY docker/collector/kafka/docker-bin/* /usr/local/bin/\n \n-# setup non-root user and its home dir\n+# All Kafka content including binaries and logs write under WORKDIR\n+WORKDIR /kafka\n+\n+# Ensure the process doesn't run as root\n ARG USER=kafka\n-WORKDIR /${USER}\n-RUN adduser -g '' -h /${USER} -D ${USER}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01758f6193fc2904736f53b5a10dbf8256edcdaa"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3NjIzMjE1OnYy", "diffSide": "RIGHT", "path": "docker/collector/kafka/docker-bin/docker-entrypoint", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQwMTo1Njo1OFrOHGAQ2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQwMTo1Njo1OFrOHGAQ2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjA1NzgxOQ==", "bodyText": "clears a minor log warning", "url": "https://github.com/openzipkin/zipkin/pull/3189#discussion_r476057819", "createdAt": "2020-08-25T01:56:58Z", "author": {"login": "codefromthecrypt"}, "path": "docker/collector/kafka/docker-bin/docker-entrypoint", "diffHunk": "@@ -14,10 +14,13 @@\n #\n \n # ENTRYPOINT script that starts ZooKeeper and then Kafka\n+#\n+# This intentionally locates config using the current working directory, in order to consolidate\n+# Dockerfile instructions to WORKDIR\n set -eu\n \n echo Starting ZooKeeper\n-bin/kafka-run-class.sh -Dlog4j.configuration=file:config/log4j.properties org.apache.zookeeper.server.quorum.QuorumPeerMain config/zookeeper.properties &\n+bin/kafka-run-class.sh -Dlog4j.configuration=file:./config/log4j.properties org.apache.zookeeper.server.quorum.QuorumPeerMain ./config/zookeeper.properties &", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01758f6193fc2904736f53b5a10dbf8256edcdaa"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3NjI1NTc4OnYy", "diffSide": "RIGHT", "path": "docker/collector/kafka/Dockerfile", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQwMjowMzoxNFrOHGAgwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQwMjowMzoxNFrOHGAgwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjA2MTg4OQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            # Add HEALTHCHECK and ENTRYPOINT scripts\n          \n          \n            \n            # Add HEALTHCHECK and ENTRYPOINT scripts into the default search path", "url": "https://github.com/openzipkin/zipkin/pull/3189#discussion_r476061889", "createdAt": "2020-08-25T02:03:14Z", "author": {"login": "codefromthecrypt"}, "path": "docker/collector/kafka/Dockerfile", "diffHunk": "@@ -26,17 +25,19 @@ RUN /tmp/install && rm /tmp/install\n FROM openzipkin/jre-full:14.0.2-14.29.23\n LABEL MAINTAINER Zipkin \"https://zipkin.io/\"\n \n-# add HEALTHCHECK and ENTRYPOINT scripts\n+# Add HEALTHCHECK and ENTRYPOINT scripts", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01758f6193fc2904736f53b5a10dbf8256edcdaa"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3NjI1ODMzOnYy", "diffSide": "RIGHT", "path": "docker/collector/kafka/Dockerfile", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQwMjowMzo1NlrOHGAihg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQwMjowMzo1NlrOHGAihg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjA2MjM0Mg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            # Copy content we installed earlier\n          \n          \n            \n            # Copy binaries and config we installed earlier", "url": "https://github.com/openzipkin/zipkin/pull/3189#discussion_r476062342", "createdAt": "2020-08-25T02:03:56Z", "author": {"login": "codefromthecrypt"}, "path": "docker/collector/kafka/Dockerfile", "diffHunk": "@@ -26,17 +25,19 @@ RUN /tmp/install && rm /tmp/install\n FROM openzipkin/jre-full:14.0.2-14.29.23\n LABEL MAINTAINER Zipkin \"https://zipkin.io/\"\n \n-# add HEALTHCHECK and ENTRYPOINT scripts\n+# Add HEALTHCHECK and ENTRYPOINT scripts into the default search path\n COPY docker/collector/kafka/docker-bin/* /usr/local/bin/\n \n-# setup non-root user and its home dir\n+# All Kafka content including binaries and logs write under WORKDIR\n+WORKDIR /kafka\n+\n+# Ensure the process doesn't run as root\n ARG USER=kafka\n-WORKDIR /${USER}\n-RUN adduser -g '' -h /${USER} -D ${USER}\n+RUN adduser -g '' -h  ${PWD} -D ${USER}\n USER ${USER}\n \n-# copy content we installed earlier into the home dir\n-COPY --from=install --chown=${USER} /install /${USER}\n+# Copy content we installed earlier", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6b222f8c5e8cca81a2594ea38fd56fe27caad9f"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3NjU1MTk2OnYy", "diffSide": "RIGHT", "path": "docker/collector/kafka/install", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQwMzoyNDozOFrOHGDlew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQwMzoyNDozOFrOHGDlew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjExMjI1MQ==", "bodyText": "the power of GNU tar :D", "url": "https://github.com/openzipkin/zipkin/pull/3189#discussion_r476112251", "createdAt": "2020-08-25T03:24:38Z", "author": {"login": "codefromthecrypt"}, "path": "docker/collector/kafka/install", "diffHunk": "@@ -13,16 +13,18 @@\n # the License.\n \n # install script used only in building the docker image, but not at runtime.\n+# This uses relative path so that you can change the home dir without editing this file.\n+# This also trims dependencies to only those used at runtime.\n set -eux\n \n echo \"*** Installing Kafka and dependencies\"\n APACHE_MIRROR=$(curl --stderr /dev/null https://www.apache.org/dyn/closer.cgi\\?as_json\\=1 | sed -n '/preferred/s/.*\"\\(.*\\)\"/\\1/gp')\n \n-# download kafka binaries\n-curl -sSL $APACHE_MIRROR/kafka/$KAFKA_VERSION/kafka_$SCALA_VERSION-$KAFKA_VERSION.tgz | tar xz\n-mv kafka_$SCALA_VERSION-$KAFKA_VERSION/* .\n+# Download scripts and config for Kafka and ZooKeeper, but not for Connect\n+curl -sSL $APACHE_MIRROR/kafka/$KAFKA_VERSION/kafka_$SCALA_VERSION-$KAFKA_VERSION.tgz | tar xvz \\\n+  --wildcards --strip=1 --exclude=connect* */bin/zookeeper-* */bin/kafka-* */config", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03f768e749e727c0162c7cc74698055ea4d8ae85"}, "originalPosition": 16}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1228, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}