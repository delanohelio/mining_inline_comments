{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ1NDkwMDUw", "number": 3333, "title": "Adds support for Elasticsearch 7.10", "bodyText": "This fixes a comparison bug which installed the incorrect template.\nWhat happened was v7.10 was mistaken for v7.1\nFixes #3329", "createdAt": "2020-12-25T01:18:59Z", "url": "https://github.com/openzipkin/zipkin/pull/3333", "merged": true, "mergeCommit": {"oid": "ad8520e1e535d52d9f20a94a1086924726158a05"}, "closed": true, "closedAt": "2020-12-25T01:44:41Z", "author": {"login": "codefromthecrypt"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdpd45-AH2gAyNTQ1NDkwMDUwOmM4NmVkMmY0Y2Y3NDUwODYyMDYyMmExNDIyZGZiMDJlMTk4YzAwNmM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdpeCXcAH2gAyNTQ1NDkwMDUwOjY3MjdlNjg2ZDFmODNlMzVkOGZlYTc2YzU4ZTAxYTYyYjA3MGJkNWU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c86ed2f4cf74508620622a1422dfb02e198c006c", "author": {"user": null}, "url": "https://github.com/openzipkin/zipkin/commit/c86ed2f4cf74508620622a1422dfb02e198c006c", "committedDate": "2020-12-25T01:17:32Z", "message": "Adds support for Elasticsearch 7.10\n\nThis fixes a comparison bug which installed the incorrect template.\n\nWhat happened was v7.10 was mistaken for v7.1"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4NzMwNzY1", "url": "https://github.com/openzipkin/zipkin/pull/3333#pullrequestreview-558730765", "createdAt": "2020-12-25T01:20:38Z", "commit": {"oid": "c86ed2f4cf74508620622a1422dfb02e198c006c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNVQwMToyMDozOFrOILWc3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNVQwMToyMDozOFrOILWc3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODc3MzA4NA==", "bodyText": "this was the bug cc @xeraa!", "url": "https://github.com/openzipkin/zipkin/pull/3333#discussion_r548773084", "createdAt": "2020-12-25T01:20:38Z", "author": {"login": "codefromthecrypt"}, "path": "zipkin-storage/elasticsearch/src/main/java/zipkin2/elasticsearch/ElasticsearchVersion.java", "diffHunk": "@@ -17,35 +17,93 @@\n import com.linecorp.armeria.common.AggregatedHttpRequest;\n import com.linecorp.armeria.common.HttpMethod;\n import java.io.IOException;\n+import java.util.Objects;\n import java.util.function.Supplier;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n import zipkin2.elasticsearch.internal.client.HttpCall;\n \n import static zipkin2.elasticsearch.internal.JsonReaders.enterPath;\n \n-enum ElasticsearchVersion implements HttpCall.BodyConverter<Float> {\n-  INSTANCE;\n+/** Helps avoid problems comparing versions by number. Ex 7.10 should be > 7.9 */\n+public final class ElasticsearchVersion implements Comparable<ElasticsearchVersion> {\n+  public static final ElasticsearchVersion V5_0 = new ElasticsearchVersion(5, 0);\n+  public static final ElasticsearchVersion V6_0 = new ElasticsearchVersion(6, 0);\n+  public static final ElasticsearchVersion V7_0 = new ElasticsearchVersion(7, 0);\n+  public static final ElasticsearchVersion V7_8 = new ElasticsearchVersion(7, 8);\n+  public static final ElasticsearchVersion V8_0 = new ElasticsearchVersion(8, 0);\n \n-  float get(HttpCall.Factory callFactory) throws IOException {\n-    AggregatedHttpRequest getNode = AggregatedHttpRequest.of(HttpMethod.GET, \"/\");\n-    Float version = callFactory.newCall(getNode, this, \"get-node\").execute();\n-    if (version == null) {\n-      throw new IllegalArgumentException(\"No content reading Elasticsearch version\");\n-    }\n-    return version;\n+  static ElasticsearchVersion get(HttpCall.Factory http) throws IOException {\n+    return Parser.INSTANCE.get(http);\n+  }\n+\n+  final int major, minor;\n+\n+  ElasticsearchVersion(int major, int minor) {\n+    this.major = major;\n+    this.minor = minor;\n+  }\n+\n+  @Override public int compareTo(ElasticsearchVersion other) {\n+    if (major < other.major) return -1;\n+    if (major > other.major) return 1;\n+    return Integer.compare(minor, other.minor);\n+  }\n+\n+  @Override public boolean equals(Object o) {\n+    if (o == this) return true;\n+    if (!(o instanceof ElasticsearchVersion)) return false;\n+    ElasticsearchVersion that = (ElasticsearchVersion) o;\n+    return this.major == that.major && this.minor == that.minor;\n+  }\n+\n+  @Override public int hashCode() {\n+    return Objects.hash(major, minor);\n+  }\n+\n+  @Override public String toString() {\n+    return major + \".\" + minor;\n   }\n \n-  @Override public Float convert(JsonParser parser, Supplier<String> contentString) {\n-    String version = null;\n-    try {\n-      if (enterPath(parser, \"version\", \"number\") != null) version = parser.getText();\n-    } catch (RuntimeException | IOException possiblyParseException) {\n-      // EmptyCatch ignored\n+  enum Parser implements HttpCall.BodyConverter<ElasticsearchVersion> {\n+    INSTANCE;\n+\n+    final Pattern REGEX = Pattern.compile(\"(\\\\d+)\\\\.(\\\\d+).*\");\n+\n+    ElasticsearchVersion get(HttpCall.Factory callFactory) throws IOException {\n+      AggregatedHttpRequest getNode = AggregatedHttpRequest.of(HttpMethod.GET, \"/\");\n+      ElasticsearchVersion version = callFactory.newCall(getNode, this, \"get-node\").execute();\n+      if (version == null) {\n+        throw new IllegalArgumentException(\"No content reading Elasticsearch version\");\n+      }\n+      return version;\n     }\n-    if (version == null) {\n-      throw new IllegalArgumentException(\n-        \".version.number not found in response: \" + contentString.get());\n+\n+    @Override\n+    public ElasticsearchVersion convert(JsonParser parser, Supplier<String> contentString) {\n+      String version = null;\n+      try {\n+        if (enterPath(parser, \"version\", \"number\") != null) version = parser.getText();\n+      } catch (RuntimeException | IOException possiblyParseException) {\n+        // EmptyCatch ignored\n+      }\n+      if (version == null) {\n+        throw new IllegalArgumentException(\n+          \".version.number not found in response: \" + contentString.get());\n+      }\n+\n+      Matcher matcher = REGEX.matcher(version);\n+      if (!matcher.matches()) {\n+        throw new IllegalArgumentException(\"Invalid .version.number: \" + version);\n+      }\n+\n+      try {\n+        int major = Integer.parseInt(matcher.group(1));\n+        int minor = Integer.parseInt(matcher.group(2));\n+        return new ElasticsearchVersion(major, minor);\n+      } catch (NumberFormatException e) {\n+        throw new IllegalArgumentException(\"Invalid .version.number: \" + version);\n+      }\n     }\n-    return Float.valueOf(version.substring(0, 3));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c86ed2f4cf74508620622a1422dfb02e198c006c"}, "originalPosition": 110}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6727e686d1f83e35d8fea76c58e01a62b070bd5e", "author": {"user": null}, "url": "https://github.com/openzipkin/zipkin/commit/6727e686d1f83e35d8fea76c58e01a62b070bd5e", "committedDate": "2020-12-25T01:27:52Z", "message": "drift"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1403, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}