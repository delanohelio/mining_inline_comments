{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQxOTg5Njk1", "number": 3130, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxMjoyMToxNFrOEKEj_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQwMTo1Njo0MlrOEKVcNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4OTk1OTY1OnYy", "diffSide": "LEFT", "path": "zipkin-server/src/main/java/zipkin2/server/internal/elasticsearch/LazyHttpClientImpl.java", "isResolved": true, "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxMjoyMToxNFrOGq5vYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQwMjoxOTowN1rOGrUjGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzYzOTM5Mg==", "bodyText": "I might have misunderstood line/armeria#2837 (comment) by @trustin or maybe the two tests below mentioning TODO are drifting for a different reason", "url": "https://github.com/openzipkin/zipkin/pull/3130#discussion_r447639392", "createdAt": "2020-06-30T12:21:14Z", "author": {"login": "codefromthecrypt"}, "path": "zipkin-server/src/main/java/zipkin2/server/internal/elasticsearch/LazyHttpClientImpl.java", "diffHunk": "@@ -60,32 +59,10 @@\n   EndpointGroup getEndpoint() {\n     EndpointGroup initial = initialEndpoints.get();\n     // Only health-check when there are alternative endpoints. There aren't when instanceof Endpoint\n-    if (initial instanceof Endpoint) return initial;\n+    if (initial instanceof Endpoint || !healthCheck.isEnabled()) return initial;\n \n     // Wrap the result when health checking is enabled.\n-    EndpointGroup result = initial;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49d883fcedee6c427108dd3365179ce1d1838723"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA3MTkxOA==", "bodyText": "with or without this change, the health check code doesn't work anymore. for example, if I revert it, one of the tests that checks that a server can blip off -> on .. that one fails on the on part.", "url": "https://github.com/openzipkin/zipkin/pull/3130#discussion_r448071918", "createdAt": "2020-07-01T01:52:20Z", "author": {"login": "codefromthecrypt"}, "path": "zipkin-server/src/main/java/zipkin2/server/internal/elasticsearch/LazyHttpClientImpl.java", "diffHunk": "@@ -60,32 +59,10 @@\n   EndpointGroup getEndpoint() {\n     EndpointGroup initial = initialEndpoints.get();\n     // Only health-check when there are alternative endpoints. There aren't when instanceof Endpoint\n-    if (initial instanceof Endpoint) return initial;\n+    if (initial instanceof Endpoint || !healthCheck.isEnabled()) return initial;\n \n     // Wrap the result when health checking is enabled.\n-    EndpointGroup result = initial;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzYzOTM5Mg=="}, "originalCommit": {"oid": "49d883fcedee6c427108dd3365179ce1d1838723"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA3NDcwNw==", "bodyText": "This change itself looks like what I'd expect after the async endpoint selection change. Perhaps a timing issue that needs to tweak the timeouts in the test with this change added, or possibly a bug introduced? /cc @trustin", "url": "https://github.com/openzipkin/zipkin/pull/3130#discussion_r448074707", "createdAt": "2020-07-01T02:03:23Z", "author": {"login": "anuraaga"}, "path": "zipkin-server/src/main/java/zipkin2/server/internal/elasticsearch/LazyHttpClientImpl.java", "diffHunk": "@@ -60,32 +59,10 @@\n   EndpointGroup getEndpoint() {\n     EndpointGroup initial = initialEndpoints.get();\n     // Only health-check when there are alternative endpoints. There aren't when instanceof Endpoint\n-    if (initial instanceof Endpoint) return initial;\n+    if (initial instanceof Endpoint || !healthCheck.isEnabled()) return initial;\n \n     // Wrap the result when health checking is enabled.\n-    EndpointGroup result = initial;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzYzOTM5Mg=="}, "originalCommit": {"oid": "49d883fcedee6c427108dd3365179ce1d1838723"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA3NjE0NQ==", "bodyText": "Would you try to increase the connect timeout of the client factory?\nClientFactory.builder()\n             .channelOption(ChannelOption.CONNECT_TIMEOUT_MILLIS, ...)\n             ...\n             .build()", "url": "https://github.com/openzipkin/zipkin/pull/3130#discussion_r448076145", "createdAt": "2020-07-01T02:09:11Z", "author": {"login": "trustin"}, "path": "zipkin-server/src/main/java/zipkin2/server/internal/elasticsearch/LazyHttpClientImpl.java", "diffHunk": "@@ -60,32 +59,10 @@\n   EndpointGroup getEndpoint() {\n     EndpointGroup initial = initialEndpoints.get();\n     // Only health-check when there are alternative endpoints. There aren't when instanceof Endpoint\n-    if (initial instanceof Endpoint) return initial;\n+    if (initial instanceof Endpoint || !healthCheck.isEnabled()) return initial;\n \n     // Wrap the result when health checking is enabled.\n-    EndpointGroup result = initial;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzYzOTM5Mg=="}, "originalCommit": {"oid": "49d883fcedee6c427108dd3365179ce1d1838723"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA3Nzg3MA==", "bodyText": "we currently set like this..\n    // Elasticsearch 7 never returns a response when receiving an HTTP/2 preface instead of the more\n    // valid behavior of returning a bad request response, so we can't use the preface.\n    // TODO: find or raise a bug with Elastic\n    return builder.useHttp2Preface(false)\n      .connectTimeoutMillis(es.getTimeout())\n      .meterRegistry(meterRegistry)\n      .build();\nThe unit test value for timeout is 200ms\nThe following test fails\n  @Test public void notHealthyThenHealthyThenNotHealthy() {\n    server1Health.setHealthy(false);\n    server2Health.setHealthy(false);\n\n    try (ElasticsearchStorage storage = context.getBean(ElasticsearchStorage.class)) {\n      CheckResult result = storage.check();\n      assertThat(result.ok()).isFalse();\n\n      server2Health.setHealthy(true);\n\n      // Health check interval is 100ms\n      await().timeout(300, TimeUnit.MILLISECONDS).untilAsserted(() ->\n        assertThat(storage.check().ok()).isTrue());\n\n      server2Health.setHealthy(false);\n\n      // Health check interval is 100ms\n      await().timeout(300, TimeUnit.MILLISECONDS).untilAsserted(() ->\n        assertThat(storage.check().ok()).isFalse()); <<< this never becomes false!\n    }\n  }", "url": "https://github.com/openzipkin/zipkin/pull/3130#discussion_r448077870", "createdAt": "2020-07-01T02:15:55Z", "author": {"login": "codefromthecrypt"}, "path": "zipkin-server/src/main/java/zipkin2/server/internal/elasticsearch/LazyHttpClientImpl.java", "diffHunk": "@@ -60,32 +59,10 @@\n   EndpointGroup getEndpoint() {\n     EndpointGroup initial = initialEndpoints.get();\n     // Only health-check when there are alternative endpoints. There aren't when instanceof Endpoint\n-    if (initial instanceof Endpoint) return initial;\n+    if (initial instanceof Endpoint || !healthCheck.isEnabled()) return initial;\n \n     // Wrap the result when health checking is enabled.\n-    EndpointGroup result = initial;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzYzOTM5Mg=="}, "originalCommit": {"oid": "49d883fcedee6c427108dd3365179ce1d1838723"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA3ODI1OQ==", "bodyText": "This is the other that fails\n  // TODO: FIXME\n  @Test public void healthyThenNotHealthyThenHealthy() {\n    try (ElasticsearchStorage storage = context.getBean(ElasticsearchStorage.class)) {\n      CheckResult result = storage.check();\n      assertThat(result.ok()).isTrue();\n\n      server1Health.setHealthy(false);\n      server2Health.setHealthy(false);\n\n      // Health check interval is 100ms\n      await().timeout(300, TimeUnit.MILLISECONDS).untilAsserted(() ->\n        assertThat(storage.check().ok()).isFalse()); <<< this never becomes false\n\n      server1Health.setHealthy(true);\n\n      // Health check interval is 100ms\n      await().timeout(300, TimeUnit.MILLISECONDS).untilAsserted(() ->\n        assertThat(storage.check().ok()).isTrue());\n    }\n  }", "url": "https://github.com/openzipkin/zipkin/pull/3130#discussion_r448078259", "createdAt": "2020-07-01T02:17:26Z", "author": {"login": "codefromthecrypt"}, "path": "zipkin-server/src/main/java/zipkin2/server/internal/elasticsearch/LazyHttpClientImpl.java", "diffHunk": "@@ -60,32 +59,10 @@\n   EndpointGroup getEndpoint() {\n     EndpointGroup initial = initialEndpoints.get();\n     // Only health-check when there are alternative endpoints. There aren't when instanceof Endpoint\n-    if (initial instanceof Endpoint) return initial;\n+    if (initial instanceof Endpoint || !healthCheck.isEnabled()) return initial;\n \n     // Wrap the result when health checking is enabled.\n-    EndpointGroup result = initial;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzYzOTM5Mg=="}, "originalCommit": {"oid": "49d883fcedee6c427108dd3365179ce1d1838723"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA3ODYxNg==", "bodyText": "there could be a red herring also.. if for example the mocks act differently than before.. running ITElasticsearchHealthCheck on this branch should fail on those two tests\n  static final SettableHealthChecker server1Health = new SettableHealthChecker(true);\n\n  @ClassRule public static ServerRule server1 = new ServerRule() {\n    @Override protected void configure(ServerBuilder sb) {\n      sb.service(\"/\", (ctx, req) -> VERSION_RESPONSE.toHttpResponse());\n      sb.service(\"/_cluster/health\", HealthCheckService.of(server1Health));\n      sb.serviceUnder(\"/_cluster/health/\", (ctx, req) -> GREEN_RESPONSE.toHttpResponse());\n    }\n  };\n\n  static final SettableHealthChecker server2Health = new SettableHealthChecker(true);\n\n  @ClassRule public static ServerRule server2 = new ServerRule() {\n    @Override protected void configure(ServerBuilder sb) {\n      sb.service(\"/\", (ctx, req) -> VERSION_RESPONSE.toHttpResponse());\n      sb.service(\"/_cluster/health\", HealthCheckService.of(server2Health));\n      sb.serviceUnder(\"/_cluster/health/\", (ctx, req) -> GREEN_RESPONSE.toHttpResponse());\n    }\n  };", "url": "https://github.com/openzipkin/zipkin/pull/3130#discussion_r448078616", "createdAt": "2020-07-01T02:19:07Z", "author": {"login": "codefromthecrypt"}, "path": "zipkin-server/src/main/java/zipkin2/server/internal/elasticsearch/LazyHttpClientImpl.java", "diffHunk": "@@ -60,32 +59,10 @@\n   EndpointGroup getEndpoint() {\n     EndpointGroup initial = initialEndpoints.get();\n     // Only health-check when there are alternative endpoints. There aren't when instanceof Endpoint\n-    if (initial instanceof Endpoint) return initial;\n+    if (initial instanceof Endpoint || !healthCheck.isEnabled()) return initial;\n \n     // Wrap the result when health checking is enabled.\n-    EndpointGroup result = initial;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzYzOTM5Mg=="}, "originalCommit": {"oid": "49d883fcedee6c427108dd3365179ce1d1838723"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4OTk2MjQxOnYy", "diffSide": "LEFT", "path": "zipkin-storage/elasticsearch/src/test/java/zipkin2/elasticsearch/integration/ITElasticsearchStorageV7.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxMjoyMjowNlrOGq5xEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxMjoyMjowNlrOGq5xEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzYzOTgyNw==", "bodyText": "current image is busted per #3129", "url": "https://github.com/openzipkin/zipkin/pull/3130#discussion_r447639827", "createdAt": "2020-06-30T12:22:06Z", "author": {"login": "codefromthecrypt"}, "path": "zipkin-storage/elasticsearch/src/test/java/zipkin2/elasticsearch/integration/ITElasticsearchStorageV7.java", "diffHunk": "@@ -20,7 +20,7 @@\n class ITElasticsearchStorageV7 extends ITElasticsearchStorage {\n \n   @RegisterExtension ElasticsearchStorageExtension backend = new ElasticsearchStorageExtension(\n-    \"openzipkin/zipkin-elasticsearch7:2.21.4\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49d883fcedee6c427108dd3365179ce1d1838723"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5MjcyNTAwOnYy", "diffSide": "RIGHT", "path": "zipkin-storage/elasticsearch/src/main/java/zipkin2/elasticsearch/internal/client/HttpCall.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQwMTo1Njo0MlrOGrUNWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxMjowNzo0N1rOGsuU0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA3MzA1MQ==", "bodyText": "Not sure if you're looking to do larger cleanup but you can use PooledWebClient.of(httpClient) to have a PooledWebClient where all the methods return Pooled*Response", "url": "https://github.com/openzipkin/zipkin/pull/3130#discussion_r448073051", "createdAt": "2020-07-01T01:56:42Z", "author": {"login": "anuraaga"}, "path": "zipkin-storage/elasticsearch/src/main/java/zipkin2/elasticsearch/internal/client/HttpCall.java", "diffHunk": "@@ -143,14 +145,13 @@ public Factory(WebClient httpClient) {\n \n   final WebClient httpClient;\n \n-  volatile CompletableFuture<AggregatedHttpResponse> responseFuture;\n+  volatile CompletableFuture<PooledAggregatedHttpResponse> responseFuture;\n \n   HttpCall(WebClient httpClient, RequestSupplier request, BodyConverter<V> bodyConverter,\n     String name) {\n     this.httpClient = httpClient;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49d883fcedee6c427108dd3365179ce1d1838723"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTU0OTUyMg==", "bodyText": "good idea. thanks!", "url": "https://github.com/openzipkin/zipkin/pull/3130#discussion_r449549522", "createdAt": "2020-07-03T12:07:47Z", "author": {"login": "codefromthecrypt"}, "path": "zipkin-storage/elasticsearch/src/main/java/zipkin2/elasticsearch/internal/client/HttpCall.java", "diffHunk": "@@ -143,14 +145,13 @@ public Factory(WebClient httpClient) {\n \n   final WebClient httpClient;\n \n-  volatile CompletableFuture<AggregatedHttpResponse> responseFuture;\n+  volatile CompletableFuture<PooledAggregatedHttpResponse> responseFuture;\n \n   HttpCall(WebClient httpClient, RequestSupplier request, BodyConverter<V> bodyConverter,\n     String name) {\n     this.httpClient = httpClient;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA3MzA1MQ=="}, "originalCommit": {"oid": "49d883fcedee6c427108dd3365179ce1d1838723"}, "originalPosition": 18}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1150, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}