{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ0MzQ1MzI1", "number": 3136, "title": "Refactors DelayLimiter in preparation of re-use in cassandra v1", "bodyText": "This refactors code relating to DelayLimiter so that it is easier to\nreuse later. What will happen in a separate PR (or what will be\nattempted) is change the limiter so that it can run a predicate instead\nof an exact match. For example Cassandra v1's Indexer currently mutes\nindex insertions which are logically equivalent to data already written.\nConcretely, a service name that appears 3 times in the same trace,\nresults in two writes (earliest and latest). If it appears again, and\nbetween those timestamps, that write is muted as it is redundant.", "createdAt": "2020-07-05T01:22:24Z", "url": "https://github.com/openzipkin/zipkin/pull/3136", "merged": true, "mergeCommit": {"oid": "89b013e978c60b17b53804dd2e5ee3476948b8ee"}, "closed": true, "closedAt": "2020-07-05T02:20:38Z", "author": {"login": "codefromthecrypt"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcxyLxcgH2gAyNDQ0MzQ1MzI1OmYxYTJiNDg1ZDZmY2EyZGZhZDhhZGQ1MjJlOWE4YzU4YWUwYTlmZjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcxzAsKgFqTQ0MjY0MDQxMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f1a2b485d6fca2dfad8add522e9a8c58ae0a9ff5", "author": {"user": null}, "url": "https://github.com/openzipkin/zipkin/commit/f1a2b485d6fca2dfad8add522e9a8c58ae0a9ff5", "committedDate": "2020-07-05T01:16:29Z", "message": "Refactors DelayLimiter in preparation of re-use in cassandra v1\n\nThis refactors code relating to DelayLimiter so that it is easier to\nreuse later. What will happen in a separate PR (or what will be\nattempted) is change the limiter so that it can run a predicate instead\nof an exact match. For example Cassandra v1's Indexer currently mutes\nindex insertions which are logically equivalent to data already written.\n\nConcretely, a service name that appears 3 times in the same trace,\nresults in two writes (earliest and latest). If it appears again, and\nbetween those timestamps, that write is muted as it is redundant."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNjM5MTQ5", "url": "https://github.com/openzipkin/zipkin/pull/3136#pullrequestreview-442639149", "createdAt": "2020-07-05T01:23:21Z", "commit": {"oid": "f1a2b485d6fca2dfad8add522e9a8c58ae0a9ff5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNVQwMToyMzoyMVrOGs-0-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNVQwMToyMzoyMVrOGs-0-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgxOTg5Ng==", "bodyText": "changes like this, just strangle guava usages to be replaced by DelayLimiter into one place", "url": "https://github.com/openzipkin/zipkin/pull/3136#discussion_r449819896", "createdAt": "2020-07-05T01:23:21Z", "author": {"login": "codefromthecrypt"}, "path": "zipkin-storage/cassandra-v1/src/main/java/zipkin2/storage/cassandra/v1/CassandraSpanConsumer.java", "diffHunk": "@@ -14,7 +14,6 @@\n package zipkin2.storage.cassandra.v1;\n \n import com.datastax.driver.core.Session;\n-import com.google.common.cache.CacheBuilderSpec;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f1a2b485d6fca2dfad8add522e9a8c58ae0a9ff5"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNjM5MTU5", "url": "https://github.com/openzipkin/zipkin/pull/3136#pullrequestreview-442639159", "createdAt": "2020-07-05T01:23:44Z", "commit": {"oid": "f1a2b485d6fca2dfad8add522e9a8c58ae0a9ff5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNVQwMToyMzo0NFrOGs-0_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNVQwMToyMzo0NFrOGs-0_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgxOTkwMg==", "bodyText": "later, this code will change to DelayLimiter (or an extension of it)", "url": "https://github.com/openzipkin/zipkin/pull/3136#discussion_r449819902", "createdAt": "2020-07-05T01:23:44Z", "author": {"login": "codefromthecrypt"}, "path": "zipkin-storage/cassandra-v1/src/main/java/zipkin2/storage/cassandra/v1/CompositeIndexer.java", "diffHunk": "@@ -27,19 +27,21 @@\n   private final Set<Indexer> indexers;\n   // Shared across all threads as updates can come from any thread.\n   // Shared for all indexes to make data management easier (ex. maximumSize)\n-  private final ConcurrentMap<PartitionKeyToTraceId, Pair> sharedState;\n+  private final Map<PartitionKeyToTraceId, Pair> sharedState;\n \n-  CompositeIndexer(CassandraStorage storage, CacheBuilderSpec spec, int indexTtl) {\n-    this.sharedState = CacheBuilder.from(spec).<PartitionKeyToTraceId, Pair>build().asMap();\n+  CompositeIndexer(CassandraStorage storage, int indexTtl) {\n+    sharedState = CacheBuilder.newBuilder()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f1a2b485d6fca2dfad8add522e9a8c58ae0a9ff5"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNjM5MTcz", "url": "https://github.com/openzipkin/zipkin/pull/3136#pullrequestreview-442639173", "createdAt": "2020-07-05T01:24:25Z", "commit": {"oid": "f1a2b485d6fca2dfad8add522e9a8c58ae0a9ff5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNVQwMToyNDoyNVrOGs-1Lw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNVQwMToyNDoyNVrOGs-1Lw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgxOTk1MQ==", "bodyText": "this parameter changed because the units are different. Ex the index mutes are second granularity", "url": "https://github.com/openzipkin/zipkin/pull/3136#discussion_r449819951", "createdAt": "2020-07-05T01:24:25Z", "author": {"login": "codefromthecrypt"}, "path": "zipkin-storage/elasticsearch/src/main/java/zipkin2/elasticsearch/ElasticsearchSpanConsumer.java", "diffHunk": "@@ -46,13 +46,13 @@\n     this.indexTypeDelimiter = es.indexTypeDelimiter();\n     this.searchEnabled = es.searchEnabled();\n     this.delayLimiter = DelayLimiter.newBuilder()\n-      .ttl(es.autocompleteTtl())\n+      .ttl(es.autocompleteTtl(), TimeUnit.MILLISECONDS)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f1a2b485d6fca2dfad8add522e9a8c58ae0a9ff5"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNjM5MTkw", "url": "https://github.com/openzipkin/zipkin/pull/3136#pullrequestreview-442639190", "createdAt": "2020-07-05T01:25:06Z", "commit": {"oid": "f1a2b485d6fca2dfad8add522e9a8c58ae0a9ff5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNVQwMToyNTowN1rOGs-1UQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNVQwMToyNTowN1rOGs-1UQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgxOTk4NQ==", "bodyText": "these defaults and the factory method were not used except in the benchmarks.", "url": "https://github.com/openzipkin/zipkin/pull/3136#discussion_r449819985", "createdAt": "2020-07-05T01:25:07Z", "author": {"login": "codefromthecrypt"}, "path": "zipkin/src/main/java/zipkin2/internal/DelayLimiter.java", "diffHunk": "@@ -21,67 +21,52 @@\n /** Limits invocations of a given context to at most once per period. */\n // this is a dependency-free variant formerly served by an expiring guava cache\n public final class DelayLimiter<C> {\n-\n-  public static <C> DelayLimiter<C> create() {\n-    return new Builder().build();\n-  }\n-\n   public static Builder newBuilder() {\n     return new Builder();\n   }\n \n   public static final class Builder {\n-    Ticker ticker = new Ticker();\n-    long ttlNanos = TimeUnit.HOURS.toNanos(1); // legacy default from cassandra", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f1a2b485d6fca2dfad8add522e9a8c58ae0a9ff5"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNjQwNDEx", "url": "https://github.com/openzipkin/zipkin/pull/3136#pullrequestreview-442640411", "createdAt": "2020-07-05T02:14:17Z", "commit": {"oid": "f1a2b485d6fca2dfad8add522e9a8c58ae0a9ff5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1453, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}