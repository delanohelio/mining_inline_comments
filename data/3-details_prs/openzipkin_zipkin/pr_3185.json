{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcyMDQzMDQ0", "number": 3185, "title": "Composable index templates for ES 7.8", "bodyText": "Description\nFor #3138, this PR lets Zipkin uses composable index templates for ES >= 7.8. Also, a new env variable is added for index template priority.\nType of change\nPlease delete options that are not relevant.\n\n New feature (non-breaking change which adds functionality)\n This change requires a documentation update\n\nHow Has This Been Tested?\nUnit tests are added for the features. The unit tests passed when ran locally. Also, I have done E2E tests using both ES >=7.8 and ES < 7.8 using the brave sample project.\nChecklist:\n\n My code follows the style guidelines of this project\n I have made corresponding changes to the documentation\n I have added tests that prove my fix is effective or that my feature works", "createdAt": "2020-08-22T21:40:38Z", "url": "https://github.com/openzipkin/zipkin/pull/3185", "merged": true, "mergeCommit": {"oid": "346ac51601043b6299e9e856f7a070aae8f4b65e"}, "closed": true, "closedAt": "2020-09-04T05:52:24Z", "author": {"login": "ccharnkij"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdBifOJAFqTQ3Mjk2OTExNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdFarDkgFqTQ4MjI5NTMyNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyOTY5MTE1", "url": "https://github.com/openzipkin/zipkin/pull/3185#pullrequestreview-472969115", "createdAt": "2020-08-22T23:51:07Z", "commit": {"oid": "c3cf8028b2d73cca9dbb6d377d92680a76c2895b"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMlQyMzo1MTowN1rOHFI3oA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMlQyMzo1NDoxNlrOHFI4Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTE1MDI0MA==", "bodyText": "beginTemplate", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r475150240", "createdAt": "2020-08-22T23:51:07Z", "author": {"login": "codefromthecrypt"}, "path": "zipkin-storage/elasticsearch/src/main/java/zipkin2/elasticsearch/VersionSpecificTemplates.java", "diffHunk": "@@ -66,10 +67,35 @@ String indexProperties(float version) {\n     return result + \",\\n    \\\"index.mapper.dynamic\\\": false\\n\";\n   }\n \n+  String indexTemplate(float version) {\n+    if (version >= 7.8f) {\n+      return \"\\\"template\\\": {\\n\";\n+    }\n+\n+    return \"\";\n+  }\n+\n+  String indexTemplateClosing(float version) {\n+    if (version >= 7.8f) {\n+      return \"},\\n\";\n+    }\n+\n+    return \"\";\n+  }\n+\n+  String templatePriority(float version) {\n+    if (version >= 7.8f) {\n+      return \"\\\"priority\\\": \" + templatePriority + \"\\n\";\n+    }\n+\n+    return \"\";\n+  }\n+\n   /** Templatized due to version differences. Only fields used in search are declared */\n   String spanIndexTemplate(float version) {\n     String result = \"{\\n\"\n       + \"  \" + indexPattern(TYPE_SPAN, version) + \",\\n\"\n+      + indexTemplate(version)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3cf8028b2d73cca9dbb6d377d92680a76c2895b"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTE1MDI2Mg==", "bodyText": "squash this and below into endTemplate as it is distracting to add template priority here when sometimes there's no template anyway.", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r475150262", "createdAt": "2020-08-22T23:52:06Z", "author": {"login": "codefromthecrypt"}, "path": "zipkin-storage/elasticsearch/src/main/java/zipkin2/elasticsearch/VersionSpecificTemplates.java", "diffHunk": "@@ -141,6 +167,8 @@ String spanIndexTemplate(float version) {\n         + \"      \\\"_q\\\": \" + KEYWORD + \"\\n\"\n         + \"    }\\n\")\n         + \"  }\\n\"\n+        + indexTemplateClosing(version)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3cf8028b2d73cca9dbb6d377d92680a76c2895b"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTE1MDMzOA==", "bodyText": "sorry I don't understand what is special checked here, as unless blind, I would expect the same to pass before 7.8?\nIn any case, if we are verifying these are legacy, we should mention that in the test name or description, as currently the name doesn't seem to suggest what we are looking at (unless I miss something)", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r475150338", "createdAt": "2020-08-22T23:53:19Z", "author": {"login": "codefromthecrypt"}, "path": "zipkin-storage/elasticsearch/src/test/java/zipkin2/elasticsearch/ElasticsearchStorageTest.java", "diffHunk": "@@ -199,6 +199,26 @@\n       String.format(\"ElasticsearchStorage{initialEndpoints=%s, index=zipkin}\", server.httpUri()));\n   }\n \n+  @Test void check_composable_indexTemplate() throws Exception {\n+    server.enqueue(AggregatedHttpResponse.of(\n+      HttpStatus.OK, MediaType.JSON_UTF_8, \"{\\\"version\\\":{\\\"number\\\":\\\"7.8.0\\\"}}\"));\n+    server.enqueue(SUCCESS_RESPONSE); // get span template\n+    server.enqueue(SUCCESS_RESPONSE); // get dependency template\n+    server.enqueue(SUCCESS_RESPONSE); // get autocomplete template\n+    server.enqueue(SUCCESS_RESPONSE); // cluster health\n+\n+    storage.check();\n+\n+    server.takeRequest(); // get version\n+\n+    assertThat(server.takeRequest().request().path()) // get span template", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3cf8028b2d73cca9dbb6d377d92680a76c2895b"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTE1MDM5MA==", "bodyText": "nice. I suppose at some point we should switch this assert to json path, but works for me.", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r475150390", "createdAt": "2020-08-22T23:54:16Z", "author": {"login": "codefromthecrypt"}, "path": "zipkin-storage/elasticsearch/src/test/java/zipkin2/elasticsearch/VersionSpecificTemplatesTest.java", "diffHunk": "@@ -107,6 +107,24 @@\n       + \"  }\");\n   }\n \n+  @Test void version78() {\n+    IndexTemplates template = storage.versionSpecificTemplates(7.8f);\n+\n+    assertThat(template.version()).isEqualTo(7.8f);\n+    assertThat(template.autocomplete())\n+      .withFailMessage(\"Starting at v7.x, we delimit index and type with hyphen\")\n+      .contains(\"\\\"index_patterns\\\": \\\"zipkin-autocomplete-*\\\"\");\n+    assertThat(template.span())\n+      .contains(\"\\\"template\\\": {\\n\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3cf8028b2d73cca9dbb6d377d92680a76c2895b"}, "originalPosition": 12}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c3cf8028b2d73cca9dbb6d377d92680a76c2895b", "author": {"user": null}, "url": "https://github.com/openzipkin/zipkin/commit/c3cf8028b2d73cca9dbb6d377d92680a76c2895b", "committedDate": "2020-08-22T19:33:19Z", "message": "Composable index templates for ES 7.8"}, "afterCommit": {"oid": "3591b6f45d7794108e3f5b72d48edb3e3ab36cc7", "author": {"user": null}, "url": "https://github.com/openzipkin/zipkin/commit/3591b6f45d7794108e3f5b72d48edb3e3ab36cc7", "committedDate": "2020-08-24T07:25:35Z", "message": "Composable index templates for ES 7.8"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczMjYxNzM4", "url": "https://github.com/openzipkin/zipkin/pull/3185#pullrequestreview-473261738", "createdAt": "2020-08-24T09:12:07Z", "commit": {"oid": "3591b6f45d7794108e3f5b72d48edb3e3ab36cc7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQwOToxMjowN1rOHFbNlg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQwOToxMjowN1rOHFbNlg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ1MDc3NA==", "bodyText": "this comment doesn't belong. probably you want to say // highest priority", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r475450774", "createdAt": "2020-08-24T09:12:07Z", "author": {"login": "codefromthecrypt"}, "path": "zipkin-storage/elasticsearch/src/main/java/zipkin2/elasticsearch/ElasticsearchStorage.java", "diffHunk": "@@ -88,7 +88,8 @@ public static Builder newBuilder(LazyHttpClient lazyHttpClient) {\n       .flushOnWrites(false)\n       .autocompleteKeys(Collections.emptyList())\n       .autocompleteTtl((int) TimeUnit.HOURS.toMillis(1))\n-      .autocompleteCardinality(5 * 4000); // Ex. 5 site tags with cardinality 4000 each\n+      .autocompleteCardinality(5 * 4000)\n+      .templatePriority(\"0\"); // Ex. 5 site tags with cardinality 4000 each", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3591b6f45d7794108e3f5b72d48edb3e3ab36cc7"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczMjYzNDc1", "url": "https://github.com/openzipkin/zipkin/pull/3185#pullrequestreview-473263475", "createdAt": "2020-08-24T09:12:55Z", "commit": {"oid": "3591b6f45d7794108e3f5b72d48edb3e3ab36cc7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQwOToxMjo1NVrOHFbPWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQwOToxMjo1NVrOHFbPWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ1MTIyNQ==", "bodyText": "for example, eaisiest way is to change this to 7.9", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r475451225", "createdAt": "2020-08-24T09:12:55Z", "author": {"login": "codefromthecrypt"}, "path": "zipkin-storage/elasticsearch/src/test/java/zipkin2/elasticsearch/ElasticsearchStorageTest.java", "diffHunk": "@@ -199,6 +199,30 @@\n       String.format(\"ElasticsearchStorage{initialEndpoints=%s, index=zipkin}\", server.httpUri()));\n   }\n \n+  /**\n+   * Ensure that Zipkin uses the correct resource path of /_index_template when creating index\n+   * template for ES >= 7.8, as opposed to ES < 7.8 that uses /_template/\n+   */\n+  @Test void check_create_composable_indexTemplate_resourcePath() throws Exception {\n+    server.enqueue(AggregatedHttpResponse.of(\n+      HttpStatus.OK, MediaType.JSON_UTF_8, \"{\\\"version\\\":{\\\"number\\\":\\\"7.8.0\\\"}}\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3591b6f45d7794108e3f5b72d48edb3e3ab36cc7"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczMjY0NjM0", "url": "https://github.com/openzipkin/zipkin/pull/3185#pullrequestreview-473264634", "createdAt": "2020-08-24T09:13:27Z", "commit": {"oid": "3591b6f45d7794108e3f5b72d48edb3e3ab36cc7"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQwOToxMzoyN1rOHFbQhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQwOToxNToxMlrOHFbUkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ1MTUyNQ==", "bodyText": "if using square formatter it will expand wildcard imports", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r475451525", "createdAt": "2020-08-24T09:13:27Z", "author": {"login": "codefromthecrypt"}, "path": "zipkin-storage/elasticsearch/src/test/java/zipkin2/elasticsearch/integration/ITElasticsearchStorageV7.java", "diffHunk": "@@ -13,8 +13,14 @@\n  */\n package zipkin2.elasticsearch.integration;\n \n+import com.linecorp.armeria.common.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3591b6f45d7794108e3f5b72d48edb3e3ab36cc7"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ1MTYzNQ==", "bodyText": "maybe revert this as it effects all tests.. that or comment why.", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r475451635", "createdAt": "2020-08-24T09:13:40Z", "author": {"login": "codefromthecrypt"}, "path": "zipkin-storage/elasticsearch/src/test/java/zipkin2/elasticsearch/integration/ElasticsearchStorageExtension.java", "diffHunk": "@@ -116,6 +116,7 @@ Builder computeStorageBuilder() {\n     WebClient client = builder.build();\n     return ElasticsearchStorage.newBuilder(() -> client)\n       .index(\"zipkin-test\")\n+      .templatePriority(\"10\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3591b6f45d7794108e3f5b72d48edb3e3ab36cc7"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ1MjU2Mg==", "bodyText": "should be a separate test instead of a before for everything.", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r475452562", "createdAt": "2020-08-24T09:15:12Z", "author": {"login": "codefromthecrypt"}, "path": "zipkin-storage/elasticsearch/src/test/java/zipkin2/elasticsearch/integration/ITElasticsearchStorageV7.java", "diffHunk": "@@ -25,4 +31,40 @@\n   @Override ElasticsearchStorageExtension backend() {\n     return backend;\n   }\n+\n+  /**\n+   * Create a \"catch-all\" index template with the lowest priority prior to running tests to\n+   * ensure that the index templates created during tests with higher priority function as\n+   * designed. Only applicable for ES >= 7.8\n+   */\n+  @BeforeAll void setUpCatchAllTemplate() throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3591b6f45d7794108e3f5b72d48edb3e3ab36cc7"}, "originalPosition": 25}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3591b6f45d7794108e3f5b72d48edb3e3ab36cc7", "author": {"user": null}, "url": "https://github.com/openzipkin/zipkin/commit/3591b6f45d7794108e3f5b72d48edb3e3ab36cc7", "committedDate": "2020-08-24T07:25:35Z", "message": "Composable index templates for ES 7.8"}, "afterCommit": {"oid": "4a45de4126b6d5403dc7c12a83667490fbb19b85", "author": {"user": null}, "url": "https://github.com/openzipkin/zipkin/commit/4a45de4126b6d5403dc7c12a83667490fbb19b85", "committedDate": "2020-08-28T05:18:44Z", "message": "Composable index templates for ES 7.8"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3MzU4MjUx", "url": "https://github.com/openzipkin/zipkin/pull/3185#pullrequestreview-477358251", "createdAt": "2020-08-28T07:16:57Z", "commit": {"oid": "4a45de4126b6d5403dc7c12a83667490fbb19b85"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQwNzoxNjo1N1rOHIsVGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQwNzoyMDo1N1rOHIsb4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODg3Njk1NA==", "bodyText": "I think you can move this to the ITEs7 class?", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r478876954", "createdAt": "2020-08-28T07:16:57Z", "author": {"login": "codefromthecrypt"}, "path": "zipkin-storage/elasticsearch/src/test/java/zipkin2/elasticsearch/integration/ITElasticsearchStorage.java", "diffHunk": "@@ -114,4 +114,12 @@\n       storage.clear();\n     }\n   }\n+\n+  @Nested\n+  class ITEnsureIndexTemplate extends zipkin2.elasticsearch.integration.ITEnsureIndexTemplate {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a45de4126b6d5403dc7c12a83667490fbb19b85"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODg3NzM5MA==", "bodyText": "with this pinned to the ES 7 IT, you don't need to check version as our image is already this I think right? In this case you can do this in the test method itself", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r478877390", "createdAt": "2020-08-28T07:18:03Z", "author": {"login": "codefromthecrypt"}, "path": "zipkin-storage/elasticsearch/src/test/java/zipkin2/elasticsearch/integration/ITEnsureIndexTemplate.java", "diffHunk": "@@ -0,0 +1,126 @@\n+/*\n+ * Copyright 2015-2020 The OpenZipkin Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package zipkin2.elasticsearch.integration;\n+\n+import com.linecorp.armeria.common.AggregatedHttpRequest;\n+import com.linecorp.armeria.common.HttpData;\n+import com.linecorp.armeria.common.HttpHeaderNames;\n+import com.linecorp.armeria.common.HttpMethod;\n+import com.linecorp.armeria.common.MediaType;\n+import com.linecorp.armeria.common.RequestHeaders;\n+import java.io.IOException;\n+import java.util.List;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestInfo;\n+import org.junit.jupiter.api.TestInstance;\n+import zipkin2.CheckResult;\n+import zipkin2.Span;\n+import zipkin2.elasticsearch.ElasticsearchStorage;\n+import zipkin2.elasticsearch.internal.Internal;\n+\n+import static java.util.Arrays.asList;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.junit.jupiter.api.Assumptions.assumeTrue;\n+import static zipkin2.TestObjects.LOTS_OF_SPANS;\n+\n+@TestInstance(TestInstance.Lifecycle.PER_CLASS)\n+abstract class ITEnsureIndexTemplate {\n+\n+  ElasticsearchStorage storage;\n+\n+  /**\n+   * Returns a new {@link ElasticsearchStorage.Builder} for connecting to the backend for the test.\n+   */\n+  protected abstract ElasticsearchStorage.Builder newStorageBuilder(TestInfo testInfo);\n+\n+  @BeforeAll void setUpCatchAllTemplate(TestInfo testInfo) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a45de4126b6d5403dc7c12a83667490fbb19b85"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODg3ODEwNQ==", "bodyText": "this should be  a \"finally\" of the catchAllTemplateTest as it would only need to be tested once anyway", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r478878105", "createdAt": "2020-08-28T07:19:41Z", "author": {"login": "codefromthecrypt"}, "path": "zipkin-storage/elasticsearch/src/test/java/zipkin2/elasticsearch/integration/ITEnsureIndexTemplate.java", "diffHunk": "@@ -0,0 +1,126 @@\n+/*\n+ * Copyright 2015-2020 The OpenZipkin Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package zipkin2.elasticsearch.integration;\n+\n+import com.linecorp.armeria.common.AggregatedHttpRequest;\n+import com.linecorp.armeria.common.HttpData;\n+import com.linecorp.armeria.common.HttpHeaderNames;\n+import com.linecorp.armeria.common.HttpMethod;\n+import com.linecorp.armeria.common.MediaType;\n+import com.linecorp.armeria.common.RequestHeaders;\n+import java.io.IOException;\n+import java.util.List;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestInfo;\n+import org.junit.jupiter.api.TestInstance;\n+import zipkin2.CheckResult;\n+import zipkin2.Span;\n+import zipkin2.elasticsearch.ElasticsearchStorage;\n+import zipkin2.elasticsearch.internal.Internal;\n+\n+import static java.util.Arrays.asList;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.junit.jupiter.api.Assumptions.assumeTrue;\n+import static zipkin2.TestObjects.LOTS_OF_SPANS;\n+\n+@TestInstance(TestInstance.Lifecycle.PER_CLASS)\n+abstract class ITEnsureIndexTemplate {\n+\n+  ElasticsearchStorage storage;\n+\n+  /**\n+   * Returns a new {@link ElasticsearchStorage.Builder} for connecting to the backend for the test.\n+   */\n+  protected abstract ElasticsearchStorage.Builder newStorageBuilder(TestInfo testInfo);\n+\n+  @BeforeAll void setUpCatchAllTemplate(TestInfo testInfo) throws IOException {\n+    ElasticsearchStorage.Builder builder = newStorageBuilder(testInfo);\n+    storage = builder.build();\n+    assumeTrue(storage.version() >= 7.8f, () -> \"Applicable only for ES >= 7.8, skipping test\");\n+\n+    /**\n+     * Delete all index templates in order to create the \"catch-all\" index template, because\n+     * ES does not allow multiple index templates of the same index_patterns and priority\n+     */\n+    deleteIndexTemplate(\"*\");\n+    setUpCatchAllTemplate();\n+  }\n+\n+  @Test void createZipkinIndexTemplate_getTraces_returnsSuccess() throws IOException {\n+    /** Create index template with {@link ElasticsearchStorage#ensureIndexTemplates()} */\n+    CheckResult check = storage.check();\n+\n+    assertThat(check.ok()).isTrue();\n+\n+    List<String> traceIds = asList(LOTS_OF_SPANS[0].traceId(), LOTS_OF_SPANS[1].traceId());\n+    List<Span> spans = asList(LOTS_OF_SPANS[0], LOTS_OF_SPANS[1]);\n+\n+    storage.spanConsumer().accept(spans).execute();\n+\n+    assertThat(storage.traces().getTraces(traceIds).execute())\n+      .containsOnly(asList(LOTS_OF_SPANS[0]), asList(LOTS_OF_SPANS[1]));\n+  }\n+\n+  /**\n+   * Create a \"catch-all\" index template with the lowest priority prior to running tests to\n+   * ensure that the index templates created during tests with higher priority function as\n+   * designed. Only applicable for ES >= 7.8\n+   */\n+  void setUpCatchAllTemplate() throws IOException {\n+    AggregatedHttpRequest updateTemplate = AggregatedHttpRequest.of(\n+      RequestHeaders.of(\n+        HttpMethod.PUT, catchAllIndexPath(), HttpHeaderNames.CONTENT_TYPE, MediaType.JSON_UTF_8),\n+      HttpData.ofUtf8(catchAllTemplate()));\n+    Internal.instance.http(storage).newCall(updateTemplate, (parser, contentString) -> null,\n+      \"update-template\").execute();\n+  }\n+\n+  String catchAllIndexPath() {\n+    return \"/_index_template/catch-all\";\n+  }\n+\n+  String catchAllTemplate() {\n+    return \"{\\n\"\n+      + \"  \\\"index_patterns\\\" : [\\\"*\\\"],\\n\"\n+      + \"  \\\"priority\\\" : 0,\\n\"\n+      + \"  \\\"template\\\": {\\n\"\n+      + \"    \\\"settings\\\" : {\\n\"\n+      + \"      \\\"number_of_shards\\\" : 1\\n\"\n+      + \"    },\\n\"\n+      + \"    \\\"mappings\\\" : {\\n\"\n+      + \"      \\\"_source\\\" : { \\\"enabled\\\" : true }\\n\"\n+      + \"    }\\n\"\n+      + \"  }\\n\"\n+      + \"}\";\n+  }\n+\n+  void deleteIndexTemplate(String pattern) throws IOException {\n+    String url = \"/_index_template/\" + pattern;\n+    AggregatedHttpRequest delete = AggregatedHttpRequest.of(HttpMethod.DELETE, url);\n+    Internal.instance.http(storage)\n+      .newCall(delete, (parser, contentString) -> null, \"delete-index\").execute();\n+  }\n+\n+  /**\n+   * Delete \"catch-all\" index template so it does not interfere with any other test\n+   */\n+  @AfterAll void deleteCatchAllTemplate() throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a45de4126b6d5403dc7c12a83667490fbb19b85"}, "originalPosition": 120}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODg3ODY5MA==", "bodyText": "verify the catch-all template works? you might want to make something more interesting so that you can use ES HTTP query on it. ex this one https://gist.github.com/adriancole/1af1259102e7a2da1b3c9103565165d7", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r478878690", "createdAt": "2020-08-28T07:20:57Z", "author": {"login": "codefromthecrypt"}, "path": "zipkin-storage/elasticsearch/src/test/java/zipkin2/elasticsearch/integration/ITEnsureIndexTemplate.java", "diffHunk": "@@ -0,0 +1,126 @@\n+/*\n+ * Copyright 2015-2020 The OpenZipkin Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package zipkin2.elasticsearch.integration;\n+\n+import com.linecorp.armeria.common.AggregatedHttpRequest;\n+import com.linecorp.armeria.common.HttpData;\n+import com.linecorp.armeria.common.HttpHeaderNames;\n+import com.linecorp.armeria.common.HttpMethod;\n+import com.linecorp.armeria.common.MediaType;\n+import com.linecorp.armeria.common.RequestHeaders;\n+import java.io.IOException;\n+import java.util.List;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestInfo;\n+import org.junit.jupiter.api.TestInstance;\n+import zipkin2.CheckResult;\n+import zipkin2.Span;\n+import zipkin2.elasticsearch.ElasticsearchStorage;\n+import zipkin2.elasticsearch.internal.Internal;\n+\n+import static java.util.Arrays.asList;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.junit.jupiter.api.Assumptions.assumeTrue;\n+import static zipkin2.TestObjects.LOTS_OF_SPANS;\n+\n+@TestInstance(TestInstance.Lifecycle.PER_CLASS)\n+abstract class ITEnsureIndexTemplate {\n+\n+  ElasticsearchStorage storage;\n+\n+  /**\n+   * Returns a new {@link ElasticsearchStorage.Builder} for connecting to the backend for the test.\n+   */\n+  protected abstract ElasticsearchStorage.Builder newStorageBuilder(TestInfo testInfo);\n+\n+  @BeforeAll void setUpCatchAllTemplate(TestInfo testInfo) throws IOException {\n+    ElasticsearchStorage.Builder builder = newStorageBuilder(testInfo);\n+    storage = builder.build();\n+    assumeTrue(storage.version() >= 7.8f, () -> \"Applicable only for ES >= 7.8, skipping test\");\n+\n+    /**\n+     * Delete all index templates in order to create the \"catch-all\" index template, because\n+     * ES does not allow multiple index templates of the same index_patterns and priority\n+     */\n+    deleteIndexTemplate(\"*\");\n+    setUpCatchAllTemplate();\n+  }\n+\n+  @Test void createZipkinIndexTemplate_getTraces_returnsSuccess() throws IOException {\n+    /** Create index template with {@link ElasticsearchStorage#ensureIndexTemplates()} */\n+    CheckResult check = storage.check();\n+\n+    assertThat(check.ok()).isTrue();\n+\n+    List<String> traceIds = asList(LOTS_OF_SPANS[0].traceId(), LOTS_OF_SPANS[1].traceId());\n+    List<Span> spans = asList(LOTS_OF_SPANS[0], LOTS_OF_SPANS[1]);\n+\n+    storage.spanConsumer().accept(spans).execute();\n+\n+    assertThat(storage.traces().getTraces(traceIds).execute())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a45de4126b6d5403dc7c12a83667490fbb19b85"}, "originalPosition": 73}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4a45de4126b6d5403dc7c12a83667490fbb19b85", "author": {"user": null}, "url": "https://github.com/openzipkin/zipkin/commit/4a45de4126b6d5403dc7c12a83667490fbb19b85", "committedDate": "2020-08-28T05:18:44Z", "message": "Composable index templates for ES 7.8"}, "afterCommit": {"oid": "f1e14495a9739ac692056bfed6d542e70d02c121", "author": {"user": null}, "url": "https://github.com/openzipkin/zipkin/commit/f1e14495a9739ac692056bfed6d542e70d02c121", "committedDate": "2020-08-29T10:36:16Z", "message": "Composable index templates for ES 7.8"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4MTYyMzE4", "url": "https://github.com/openzipkin/zipkin/pull/3185#pullrequestreview-478162318", "createdAt": "2020-08-30T00:22:24Z", "commit": {"oid": "f1e14495a9739ac692056bfed6d542e70d02c121"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMFQwMDoyMjoyNFrOHJey2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMFQwMDozMjoxNVrOHJe1dQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTcwMzc3MA==", "bodyText": "as other tests we add to ITEnsureIndexTemplate won't necessarily effect templatePriority, I would move that setting into the test itself. Then, you can use the same setup as the other tests like this:\n    @Override protected ElasticsearchStorage.Builder newStorageBuilder(TestInfo testInfo) {\n      return backend().computeStorageBuilder().index(index(testInfo));\n    }\n\n    @AfterEach public void clear() throws IOException {\n      storage.clear();\n    }", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r479703770", "createdAt": "2020-08-30T00:22:24Z", "author": {"login": "codefromthecrypt"}, "path": "zipkin-storage/elasticsearch/src/test/java/zipkin2/elasticsearch/integration/ITElasticsearchStorageV7.java", "diffHunk": "@@ -25,4 +30,12 @@\n   @Override ElasticsearchStorageExtension backend() {\n     return backend;\n   }\n+\n+  @Nested\n+  class ITEnsureIndexTemplate extends zipkin2.elasticsearch.integration.ITEnsureIndexTemplate {\n+    @Override protected ElasticsearchStorage.Builder newStorageBuilder(TestInfo testInfo) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f1e14495a9739ac692056bfed6d542e70d02c121"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTcwMzc3OA==", "bodyText": "nit protected not needed in the same package", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r479703778", "createdAt": "2020-08-30T00:22:39Z", "author": {"login": "codefromthecrypt"}, "path": "zipkin-storage/elasticsearch/src/test/java/zipkin2/elasticsearch/integration/ITEnsureIndexTemplate.java", "diffHunk": "@@ -0,0 +1,129 @@\n+/*\n+ * Copyright 2015-2020 The OpenZipkin Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package zipkin2.elasticsearch.integration;\n+\n+import com.linecorp.armeria.common.AggregatedHttpRequest;\n+import com.linecorp.armeria.common.HttpData;\n+import com.linecorp.armeria.common.HttpHeaderNames;\n+import com.linecorp.armeria.common.HttpMethod;\n+import com.linecorp.armeria.common.MediaType;\n+import com.linecorp.armeria.common.RequestHeaders;\n+import java.io.IOException;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestInfo;\n+import org.junit.jupiter.api.TestInstance;\n+import zipkin2.CheckResult;\n+import zipkin2.Span;\n+import zipkin2.elasticsearch.ElasticsearchStorage;\n+import zipkin2.elasticsearch.internal.Internal;\n+import zipkin2.storage.QueryRequest;\n+\n+import static java.util.Arrays.asList;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static zipkin2.TestObjects.CLIENT_SPAN;\n+import static zipkin2.TestObjects.DAY;\n+import static zipkin2.TestObjects.TODAY;\n+\n+@TestInstance(TestInstance.Lifecycle.PER_CLASS)\n+abstract class ITEnsureIndexTemplate {\n+\n+  ElasticsearchStorage storage;\n+\n+  /**\n+   * Returns a new {@link ElasticsearchStorage.Builder} for connecting to the backend for the test.\n+   */\n+  protected abstract ElasticsearchStorage.Builder newStorageBuilder(TestInfo testInfo);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f1e14495a9739ac692056bfed6d542e70d02c121"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTcwNDQzNw==", "bodyText": "if this is the catch all change you want to make, it would be useful to test that this applies. The test could pass for a subtle reason, then in ES 7.10 it might break and we wouldn't know what it was trying to do either.\nFor this reason, making a template that sets default which I think this does, maybe isn't a good choice.\nInstead try something with semantic value and also relevant in tracing? ex\n  \"mappings\": {\n    \"properties\": {\n      \"tags.http.status_code\": {\n        \"norms\": false,\n        \"type\": \"keyword\"\n      }\n    }\n  }\n\nIn this case, your test can switch from making a fake tag \"queryTest\"->\"ok\"  to a tag very commonly requested  like \"http.status_code\" \"404\"\nThen, you can verify your catch-all worked by using HTTP to do the following (except in java):\ncurl -s 'localhost:9200/zipkin-span-*/_search?q=tags.http.status_code:404'\n\nEx what you are doing is literally verifying automatically this https://gist.github.com/adriancole/1af1259102e7a2da1b3c9103565165d7", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r479704437", "createdAt": "2020-08-30T00:32:15Z", "author": {"login": "codefromthecrypt"}, "path": "zipkin-storage/elasticsearch/src/test/java/zipkin2/elasticsearch/integration/ITEnsureIndexTemplate.java", "diffHunk": "@@ -0,0 +1,129 @@\n+/*\n+ * Copyright 2015-2020 The OpenZipkin Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package zipkin2.elasticsearch.integration;\n+\n+import com.linecorp.armeria.common.AggregatedHttpRequest;\n+import com.linecorp.armeria.common.HttpData;\n+import com.linecorp.armeria.common.HttpHeaderNames;\n+import com.linecorp.armeria.common.HttpMethod;\n+import com.linecorp.armeria.common.MediaType;\n+import com.linecorp.armeria.common.RequestHeaders;\n+import java.io.IOException;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestInfo;\n+import org.junit.jupiter.api.TestInstance;\n+import zipkin2.CheckResult;\n+import zipkin2.Span;\n+import zipkin2.elasticsearch.ElasticsearchStorage;\n+import zipkin2.elasticsearch.internal.Internal;\n+import zipkin2.storage.QueryRequest;\n+\n+import static java.util.Arrays.asList;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static zipkin2.TestObjects.CLIENT_SPAN;\n+import static zipkin2.TestObjects.DAY;\n+import static zipkin2.TestObjects.TODAY;\n+\n+@TestInstance(TestInstance.Lifecycle.PER_CLASS)\n+abstract class ITEnsureIndexTemplate {\n+\n+  ElasticsearchStorage storage;\n+\n+  /**\n+   * Returns a new {@link ElasticsearchStorage.Builder} for connecting to the backend for the test.\n+   */\n+  protected abstract ElasticsearchStorage.Builder newStorageBuilder(TestInfo testInfo);\n+\n+  @Test void createZipkinIndexTemplate_getTraces_returnsSuccess(TestInfo testInfo) throws IOException {\n+    ElasticsearchStorage.Builder builder = newStorageBuilder(testInfo);\n+    storage = builder.build();\n+\n+    try {\n+      /**\n+       * Delete all index templates in order to create the \"catch-all\" index template, because\n+       * ES does not allow multiple index templates of the same index_patterns and priority\n+       */\n+      deleteIndexTemplate(\"*\");\n+      setUpCatchAllTemplate();\n+\n+      /** Create index template with {@link ElasticsearchStorage#ensureIndexTemplates()} */\n+      CheckResult check = storage.check();\n+\n+      assertThat(check.ok()).isTrue();\n+\n+      Span span = Span.newBuilder().traceId(CLIENT_SPAN.traceId())\n+        .id(\"1\")\n+        .timestamp(TODAY * 1000L)\n+        .putTag(\"queryTest\", \"ok\")\n+        .build();\n+\n+      storage.spanConsumer().accept(asList(span)).execute();\n+\n+      assertThat(storage.spanStore().getTraces(QueryRequest.newBuilder()\n+        .endTs(TODAY + DAY)\n+        .lookback(DAY * 2)\n+        .limit(10)\n+        .parseAnnotationQuery(\"queryTest=\" + span.tags().get(\"queryTest\"))\n+        .build()).execute())\n+      .flatExtracting(t -> t).containsExactly(span);\n+    }\n+    finally {\n+      /**\n+       * Delete \"catch-all\" index template so it does not interfere with any other test\n+       */\n+      deleteIndexTemplate(\"catch-all\");\n+      storage.close();\n+    }\n+  }\n+\n+  /**\n+   * Create a \"catch-all\" index template with the lowest priority prior to running tests to\n+   * ensure that the index templates created during tests with higher priority function as\n+   * designed. Only applicable for ES >= 7.8\n+   */\n+  void setUpCatchAllTemplate() throws IOException {\n+    AggregatedHttpRequest updateTemplate = AggregatedHttpRequest.of(\n+      RequestHeaders.of(\n+        HttpMethod.PUT, catchAllIndexPath(), HttpHeaderNames.CONTENT_TYPE, MediaType.JSON_UTF_8),\n+      HttpData.ofUtf8(catchAllTemplate()));\n+    Internal.instance.http(storage).newCall(updateTemplate, (parser, contentString) -> null,\n+      \"update-template\").execute();\n+  }\n+\n+  String catchAllIndexPath() {\n+    return \"/_index_template/catch-all\";\n+  }\n+\n+  String catchAllTemplate() {\n+    return \"{\\n\"\n+      + \"  \\\"index_patterns\\\" : [\\\"*\\\"],\\n\"\n+      + \"  \\\"priority\\\" : 0,\\n\"\n+      + \"  \\\"template\\\": {\\n\"\n+      + \"    \\\"settings\\\" : {\\n\"\n+      + \"      \\\"number_of_shards\\\" : 1\\n\"\n+      + \"    },\\n\"\n+      + \"    \\\"mappings\\\" : {\\n\"\n+      + \"      \\\"_source\\\" : { \\\"enabled\\\" : true }\\n\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f1e14495a9739ac692056bfed6d542e70d02c121"}, "originalPosition": 117}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f1e14495a9739ac692056bfed6d542e70d02c121", "author": {"user": null}, "url": "https://github.com/openzipkin/zipkin/commit/f1e14495a9739ac692056bfed6d542e70d02c121", "committedDate": "2020-08-29T10:36:16Z", "message": "Composable index templates for ES 7.8"}, "afterCommit": {"oid": "15643801f066015a4fae3a8ae6a3dffc60c8ebe2", "author": {"user": null}, "url": "https://github.com/openzipkin/zipkin/commit/15643801f066015a4fae3a8ae6a3dffc60c8ebe2", "committedDate": "2020-09-01T04:16:46Z", "message": "Composable index templates for ES 7.8"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "15643801f066015a4fae3a8ae6a3dffc60c8ebe2", "author": {"user": null}, "url": "https://github.com/openzipkin/zipkin/commit/15643801f066015a4fae3a8ae6a3dffc60c8ebe2", "committedDate": "2020-09-01T04:16:46Z", "message": "Composable index templates for ES 7.8"}, "afterCommit": {"oid": "c36cf3263a7f392561a6fbf3b47415ba0ece81f1", "author": {"user": null}, "url": "https://github.com/openzipkin/zipkin/commit/c36cf3263a7f392561a6fbf3b47415ba0ece81f1", "committedDate": "2020-09-02T08:10:38Z", "message": "Composable index templates for ES 7.8"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwNjE5NDY2", "url": "https://github.com/openzipkin/zipkin/pull/3185#pullrequestreview-480619466", "createdAt": "2020-09-02T08:57:06Z", "commit": {"oid": "c36cf3263a7f392561a6fbf3b47415ba0ece81f1"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwODo1NzowNlrOHLla_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwOTowMDoyN1rOHLlmyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkwOTUwMw==", "bodyText": "probably using Zipkin's Nullable for Integer is better, just to prevent a little brain break", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r481909503", "createdAt": "2020-09-02T08:57:06Z", "author": {"login": "codefromthecrypt"}, "path": "zipkin-storage/elasticsearch/src/main/java/zipkin2/elasticsearch/ElasticsearchStorage.java", "diffHunk": "@@ -213,6 +222,8 @@ public final Builder dateSeparator(char dateSeparator) {\n \n   public abstract int namesLookback();\n \n+  @Nullable abstract String templatePriority();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c36cf3263a7f392561a6fbf3b47415ba0ece81f1"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkxMDg4Mw==", "bodyText": "to match your docs..\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  priority: ${ES_TEMPLATE_PRIORITY:0}\n          \n          \n            \n                  priority: ${ES_TEMPLATE_PRIORITY:}", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r481910883", "createdAt": "2020-09-02T08:58:40Z", "author": {"login": "codefromthecrypt"}, "path": "zipkin-server/src/main/resources/zipkin-server-shared.yml", "diffHunk": "@@ -164,6 +164,7 @@ zipkin:\n       health-check:\n         enabled: ${ES_HEALTH_CHECK_ENABLED:true}\n         interval: ${ES_HEALTH_CHECK_INTERVAL:3s}\n+      priority: ${ES_TEMPLATE_PRIORITY:0}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c36cf3263a7f392561a6fbf3b47415ba0ece81f1"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkxMTIwOA==", "bodyText": "make Integer", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r481911208", "createdAt": "2020-09-02T08:59:03Z", "author": {"login": "codefromthecrypt"}, "path": "zipkin-server/src/main/java/zipkin2/server/internal/elasticsearch/ZipkinElasticsearchStorageProperties.java", "diffHunk": "@@ -212,6 +213,8 @@ public void setInterval(Duration interval) {\n \n   private HealthCheck healthCheck = new HealthCheck();\n \n+  private String priority;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c36cf3263a7f392561a6fbf3b47415ba0ece81f1"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkxMjUyMA==", "bodyText": "If this is a string to coerce empty to null, make a comment (also coerce empty to null :P) but still use an integer in the builder. I'm not actually sure what Spring does to an integer field set to \"\"", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r481912520", "createdAt": "2020-09-02T09:00:27Z", "author": {"login": "codefromthecrypt"}, "path": "zipkin-server/src/main/java/zipkin2/server/internal/elasticsearch/ZipkinElasticsearchStorageProperties.java", "diffHunk": "@@ -346,6 +349,10 @@ public void setSsl(Ssl ssl) {\n     this.ssl = ssl;\n   }\n \n+  public String getPriority() { return priority; }\n+\n+  public void setPriority(String priority) { this.priority = priority; }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c36cf3263a7f392561a6fbf3b47415ba0ece81f1"}, "originalPosition": 23}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c36cf3263a7f392561a6fbf3b47415ba0ece81f1", "author": {"user": null}, "url": "https://github.com/openzipkin/zipkin/commit/c36cf3263a7f392561a6fbf3b47415ba0ece81f1", "committedDate": "2020-09-02T08:10:38Z", "message": "Composable index templates for ES 7.8"}, "afterCommit": {"oid": "a0919a8935fa247fd7d1c5b8c5aa5a2902bbe8e8", "author": {"user": null}, "url": "https://github.com/openzipkin/zipkin/commit/a0919a8935fa247fd7d1c5b8c5aa5a2902bbe8e8", "committedDate": "2020-09-03T07:52:15Z", "message": "Composable index templates for ES 7.8"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxNjE5OTEw", "url": "https://github.com/openzipkin/zipkin/pull/3185#pullrequestreview-481619910", "createdAt": "2020-09-03T08:37:50Z", "commit": {"oid": "a0919a8935fa247fd7d1c5b8c5aa5a2902bbe8e8"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QwODozNzo1MFrOHMcMOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QwODozOTo1MlrOHMcQ0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjgwNjg0Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Nullable public abstract Builder templatePriority(Integer priority);\n          \n          \n            \n                public abstract Builder templatePriority(@Nullable Integer priority);", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r482806842", "createdAt": "2020-09-03T08:37:50Z", "author": {"login": "codefromthecrypt"}, "path": "zipkin-storage/elasticsearch/src/main/java/zipkin2/elasticsearch/ElasticsearchStorage.java", "diffHunk": "@@ -162,6 +162,15 @@ public final Builder dateSeparator(char dateSeparator) {\n     /** False disables automatic index template installation. */\n     public abstract Builder ensureTemplates(boolean ensureTemplates);\n \n+    /**\n+     * Only valid when the destination is Elasticsearch >= 7.8. Indicates the index template\n+     * priority in case of multiple matching templates. The template with highest priority is used.\n+     * Default to 0.\n+     *\n+     * <p>See https://www.elastic.co/guide/en/elasticsearch/reference/7.8/_index_template_and_settings_priority.html\n+     */\n+    @Nullable public abstract Builder templatePriority(Integer priority);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a0919a8935fa247fd7d1c5b8c5aa5a2902bbe8e8"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjgwNzc3OQ==", "bodyText": "sorry I didn't notice this earlier: rename to template-priority\nadd a test in ZipkinElasticsearchStorageConfigurationTest to ensure that zipkin.storage.elasticsearch.template-priority: coerces to null not zero", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r482807779", "createdAt": "2020-09-03T08:39:27Z", "author": {"login": "codefromthecrypt"}, "path": "zipkin-server/src/main/resources/zipkin-server-shared.yml", "diffHunk": "@@ -164,6 +164,7 @@ zipkin:\n       health-check:\n         enabled: ${ES_HEALTH_CHECK_ENABLED:true}\n         interval: ${ES_HEALTH_CHECK_INTERVAL:3s}\n+      priority: ${ES_TEMPLATE_PRIORITY:}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a0919a8935fa247fd7d1c5b8c5aa5a2902bbe8e8"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjgwNzk1Mg==", "bodyText": "rename to templatePriority", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r482807952", "createdAt": "2020-09-03T08:39:45Z", "author": {"login": "codefromthecrypt"}, "path": "zipkin-server/src/main/java/zipkin2/server/internal/elasticsearch/ZipkinElasticsearchStorageProperties.java", "diffHunk": "@@ -212,6 +213,8 @@ public void setInterval(Duration interval) {\n \n   private HealthCheck healthCheck = new HealthCheck();\n \n+  private Integer priority;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a0919a8935fa247fd7d1c5b8c5aa5a2902bbe8e8"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjgwODAxNw==", "bodyText": "rename to template-priority", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r482808017", "createdAt": "2020-09-03T08:39:52Z", "author": {"login": "codefromthecrypt"}, "path": "zipkin-server/src/main/java/zipkin2/server/internal/elasticsearch/ZipkinElasticsearchStorageProperties.java", "diffHunk": "@@ -50,6 +50,7 @@\n  *     enabled: true\n  *     http-logging: HEADERS\n  *     interval: 3s\n+ *   priority: 0", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a0919a8935fa247fd7d1c5b8c5aa5a2902bbe8e8"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "687de3a8532565c05294ba3b82b0e8dae2fc4428", "author": {"user": null}, "url": "https://github.com/openzipkin/zipkin/commit/687de3a8532565c05294ba3b82b0e8dae2fc4428", "committedDate": "2020-09-04T00:53:31Z", "message": "Composable index templates for ES 7.8"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a0919a8935fa247fd7d1c5b8c5aa5a2902bbe8e8", "author": {"user": null}, "url": "https://github.com/openzipkin/zipkin/commit/a0919a8935fa247fd7d1c5b8c5aa5a2902bbe8e8", "committedDate": "2020-09-03T07:52:15Z", "message": "Composable index templates for ES 7.8"}, "afterCommit": {"oid": "687de3a8532565c05294ba3b82b0e8dae2fc4428", "author": {"user": null}, "url": "https://github.com/openzipkin/zipkin/commit/687de3a8532565c05294ba3b82b0e8dae2fc4428", "committedDate": "2020-09-04T00:53:31Z", "message": "Composable index templates for ES 7.8"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyMjk1MzI0", "url": "https://github.com/openzipkin/zipkin/pull/3185#pullrequestreview-482295324", "createdAt": "2020-09-04T01:11:25Z", "commit": {"oid": "687de3a8532565c05294ba3b82b0e8dae2fc4428"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1519, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}