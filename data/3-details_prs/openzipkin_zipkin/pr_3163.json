{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYzMTU0NjMx", "number": 3163, "title": "Adds Docker HEALTHCHECK to Kafka and adjusts for upstream /bin/sh change", "bodyText": "Before, we were linking individual images /bin/sh to BusyBox. This change\nuses the upstream change here. Especially as it allows HEALTHCHECK to\nwork (HEALTHCHECK at Dockerfile level only works with /bin/sh)\nopenzipkin/docker-java#20\nUsing this, we add a HEALTHCHECK for our test Kafka image based on a Gitter\ndiscussion.", "createdAt": "2020-08-05T05:30:56Z", "url": "https://github.com/openzipkin/zipkin/pull/3163", "merged": true, "mergeCommit": {"oid": "745d9cfd38a16abde70ed502b78a8fbb50b0b0f3"}, "closed": true, "closedAt": "2020-08-05T10:12:54Z", "author": {"login": "codefromthecrypt"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc70WomAH2gAyNDYzMTU0NjMxOmNhMzQwYzQ4YzgxMmM3YTRiNGQ5N2IzZGZhODA2ZTc2YTJkMGYwN2Y=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc75BkbgFqTQ2MTU0Nzk0Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ca340c48c812c7a4b4d97b3dfa806e76a2d0f07f", "author": {"user": null}, "url": "https://github.com/openzipkin/zipkin/commit/ca340c48c812c7a4b4d97b3dfa806e76a2d0f07f", "committedDate": "2020-08-05T05:27:24Z", "message": "Adds Docker HEALTHCHECK to Kafka and adjusts for upstream /bin/sh change\n\nBefore, we were linking individual images /bin/sh to BusyBox. This change\nuses the upstream change here. Especially as it allows HEALTHCHECK to\nwork (HEALTHCHECK at Dockerfile level only works with /bin/sh)\n\nhttps://github.com/openzipkin/docker-jre-full/pull/20\n\nUsing this, we add a HEALTHCHECK for our test Kafka image based on a Gitter\ndiscussion."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMzUwNjU2", "url": "https://github.com/openzipkin/zipkin/pull/3163#pullrequestreview-461350656", "createdAt": "2020-08-05T05:31:16Z", "commit": {"oid": "ca340c48c812c7a4b4d97b3dfa806e76a2d0f07f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQwNTozMToxNlrOG76yRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQwNTozMToxNlrOG76yRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ4MjMxMA==", "bodyText": "we forgot to add this to our main image!", "url": "https://github.com/openzipkin/zipkin/pull/3163#discussion_r465482310", "createdAt": "2020-08-05T05:31:16Z", "author": {"login": "codefromthecrypt"}, "path": "docker/Dockerfile.release", "diffHunk": "@@ -108,4 +108,7 @@ USER zipkin\n \n EXPOSE 9410 9411\n \n-ENTRYPOINT [\"/busybox/sh\", \"run.sh\"]\n+# Same settings and rationale as Dockerfile (non-release)\n+HEALTHCHECK --interval=5s --start-period=30s --timeout=5s CMD wget -qO- http://127.0.0.1:9411/health &> /dev/null || exit 1", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca340c48c812c7a4b4d97b3dfa806e76a2d0f07f"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMzU3Mjc1", "url": "https://github.com/openzipkin/zipkin/pull/3163#pullrequestreview-461357275", "createdAt": "2020-08-05T05:49:36Z", "commit": {"oid": "ca340c48c812c7a4b4d97b3dfa806e76a2d0f07f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQwNTo0OTozNlrOG77H1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQwNTo0OTozNlrOG77H1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ4NzgzMA==", "bodyText": "we don't need to bind host ports by default as it is especially confusing as only 19092 will work\nthe others are exposed directly by the Dockerfile so we don't need to re-declare expose here either.", "url": "https://github.com/openzipkin/zipkin/pull/3163#discussion_r465487830", "createdAt": "2020-08-05T05:49:36Z", "author": {"login": "codefromthecrypt"}, "path": "docker/examples/docker-compose-kafka.yml", "diffHunk": "@@ -29,10 +29,7 @@ services:\n     # environment:\n       # - KAFKA_ADVERTISED_HOST_NAME=192.168.99.100\n     ports:\n-      - 2181:2181", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca340c48c812c7a4b4d97b3dfa806e76a2d0f07f"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMzU3NjA0", "url": "https://github.com/openzipkin/zipkin/pull/3163#pullrequestreview-461357604", "createdAt": "2020-08-05T05:50:05Z", "commit": {"oid": "ca340c48c812c7a4b4d97b3dfa806e76a2d0f07f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQwNTo1MDowNVrOG77JFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQwNTo1MDowNVrOG77JFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ4ODE0OQ==", "bodyText": "this version is what allows health conditions (note: v3 does not!!)", "url": "https://github.com/openzipkin/zipkin/pull/3163#discussion_r465488149", "createdAt": "2020-08-05T05:50:05Z", "author": {"login": "codefromthecrypt"}, "path": "docker/examples/docker-compose-mem.yml", "diffHunk": "@@ -20,7 +20,7 @@\n #\n # Note that this file is meant for learning Zipkin, not production deployments.\n \n-version: '2'\n+version: '2.4'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca340c48c812c7a4b4d97b3dfa806e76a2d0f07f"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMzcyMDA4", "url": "https://github.com/openzipkin/zipkin/pull/3163#pullrequestreview-461372008", "createdAt": "2020-08-05T06:25:03Z", "commit": {"oid": "ca340c48c812c7a4b4d97b3dfa806e76a2d0f07f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18879a1af6b8676909911f9880b1f8d5b2162eda", "author": {"user": null}, "url": "https://github.com/openzipkin/zipkin/commit/18879a1af6b8676909911f9880b1f8d5b2162eda", "committedDate": "2020-08-05T07:14:47Z", "message": "license"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1edccdb44585d07344cdf451fb4e27aa0caf91d2", "author": {"user": null}, "url": "https://github.com/openzipkin/zipkin/commit/1edccdb44585d07344cdf451fb4e27aa0caf91d2", "committedDate": "2020-08-05T08:18:05Z", "message": "fix zipkin entrypoints"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48bca925febc2eca74eb1051484ec5ab8fd95afe", "author": {"user": null}, "url": "https://github.com/openzipkin/zipkin/commit/48bca925febc2eca74eb1051484ec5ab8fd95afe", "committedDate": "2020-08-05T08:45:21Z", "message": "license"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxNTQ3OTQz", "url": "https://github.com/openzipkin/zipkin/pull/3163#pullrequestreview-461547943", "createdAt": "2020-08-05T10:48:42Z", "commit": {"oid": "48bca925febc2eca74eb1051484ec5ab8fd95afe"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxMDo0ODo0MlrOG8ETGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxMDo1Mjo1NVrOG8EbUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTYzODE3MA==", "bodyText": "nit: typo\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * to allow manual allows usage of the docker-compose v2 service_healthy condition\n          \n          \n            \n             * to allow manual usage of the docker-compose v2 service_healthy condition", "url": "https://github.com/openzipkin/zipkin/pull/3163#discussion_r465638170", "createdAt": "2020-08-05T10:48:42Z", "author": {"login": "jeqo"}, "path": "docker/RATIONALE.md", "diffHunk": "@@ -0,0 +1,17 @@\n+# zipkin-docker rationale\n+\n+## Why do we add HEALTHCHECK for test images?\n+\n+While most of our images are not production, we still add HEALTHCHECK for a better ad-hoc\n+and automation experience. Many of our setups will not operate without a service\n+dependency: having HEALTHCHECK present makes triage and scripting a bit easier.\n+\n+HEALTHCHECK on our test image serves primarily two purposes:\n+ * ad-hoc or scripted status of health using docker ps instead of knowing Kafka commands\n+ * to allow manual allows usage of the docker-compose v2 service_healthy condition", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48bca925febc2eca74eb1051484ec5ab8fd95afe"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTYzOTU2MQ==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/openzipkin/zipkin/pull/3163#discussion_r465639561", "createdAt": "2020-08-05T10:51:22Z", "author": {"login": "jeqo"}, "path": "docker/examples/docker-compose-kafka.yml", "diffHunk": "@@ -29,10 +29,7 @@ services:\n     # environment:\n       # - KAFKA_ADVERTISED_HOST_NAME=192.168.99.100\n     ports:\n-      - 2181:2181", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ4NzgzMA=="}, "originalCommit": {"oid": "ca340c48c812c7a4b4d97b3dfa806e76a2d0f07f"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTY0MDI3NA==", "bodyText": "just in case, is there any docs confirming this (v3 not supporting healthchecks)? I wasn't able to find this restriction.", "url": "https://github.com/openzipkin/zipkin/pull/3163#discussion_r465640274", "createdAt": "2020-08-05T10:52:55Z", "author": {"login": "jeqo"}, "path": "docker/examples/docker-compose-mem.yml", "diffHunk": "@@ -20,7 +20,7 @@\n #\n # Note that this file is meant for learning Zipkin, not production deployments.\n \n-version: '2'\n+version: '2.4'", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ4ODE0OQ=="}, "originalCommit": {"oid": "ca340c48c812c7a4b4d97b3dfa806e76a2d0f07f"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1481, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}