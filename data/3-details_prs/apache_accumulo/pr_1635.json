{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM3MTE2MDYx", "number": 1635, "title": "Create bulkRename method in VolumeManager", "bodyText": "Refactor fate code in BulkImportMove (bulkVer2) and MoveExportedFiles to call the\nnew method for handling renames of lots of files\nWork related to #1620\nMade bulkRename method return the list of completed Futures so FATE operations can handle errors accordingly", "createdAt": "2020-06-19T13:56:00Z", "url": "https://github.com/apache/accumulo/pull/1635", "merged": true, "mergeCommit": {"oid": "88b11923e61bd7905ba42d9b8d58a3620dcd2e36"}, "closed": true, "closedAt": "2020-07-13T19:10:51Z", "author": {"login": "milleruntime"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcszYb-AH2gAyNDM3MTE2MDYxOjQ1NmJjZTg1MDc0ZDRiZmU2NjY2Y2I3MzdhNmFlY2MzN2Y5YTJlYjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcxD8HegH2gAyNDM3MTE2MDYxOjM1NWIwZTk0Y2M4ZDViZmEzYmZlNDlmMTU2M2VjNWIyZGEzZWI2ODE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "456bce85074d4bfe6666cb737a6aecc37f9a2eb1", "author": {"user": {"login": "milleruntime", "name": "Mike Miller"}}, "url": "https://github.com/apache/accumulo/commit/456bce85074d4bfe6666cb737a6aecc37f9a2eb1", "committedDate": "2020-06-19T13:50:36Z", "message": "Create bulkRename method in VolumeManager\n\n* Refactor fate code in BulkImportMove and MoveExportedFiles to call the\nnew method for handling renames of lots of files"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0MzY1NTIy", "url": "https://github.com/apache/accumulo/pull/1635#pullrequestreview-434365522", "createdAt": "2020-06-19T22:22:19Z", "commit": {"oid": "456bce85074d4bfe6666cb737a6aecc37f9a2eb1"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQyMjoyMjoyMFrOGmifvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQyMjozMjo0NlrOGmioiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA2NDI1NA==", "bodyText": "should this throw an exception?", "url": "https://github.com/apache/accumulo/pull/1635#discussion_r443064254", "createdAt": "2020-06-19T22:22:20Z", "author": {"login": "keith-turner"}, "path": "server/base/src/main/java/org/apache/accumulo/server/fs/VolumeManagerImpl.java", "diffHunk": "@@ -289,6 +294,38 @@ public boolean rename(Path path, Path newPath) throws IOException {\n     return source.rename(path, newPath);\n   }\n \n+  @Override\n+  public List<Future<Boolean>> bulkRename(Map<Path,Path> oldToNewPathMap,\n+      SimpleThreadPool workerPool, String transactionId) throws InterruptedException {\n+    List<Future<Boolean>> results = new ArrayList<>();\n+    oldToNewPathMap.forEach((oldPath, newPath) -> results.add(workerPool.submit(() -> {\n+      boolean success;\n+      try {\n+        success = rename(oldPath, newPath);\n+      } catch (IOException e) {\n+        // The rename could have failed because this is the second time its running (failures\n+        // could cause this to run multiple times).\n+        if (!exists(newPath) || exists(oldPath)) {\n+          throw e;\n+        }\n+        log.debug(\n+            \"Ignoring rename exception for {} because destination already exists. orig: {} new: {}\",\n+            transactionId, oldPath, newPath, e);\n+        success = true;\n+      }\n+      if (!success) {\n+        log.error(\"Rename operation {} returned false. orig: {} new: {}\", transactionId, oldPath,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "456bce85074d4bfe6666cb737a6aecc37f9a2eb1"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA2NTAzNg==", "bodyText": "A lambda within a lambda. I was looking for a way to add a third inner lambda, but did not see an opportunity.", "url": "https://github.com/apache/accumulo/pull/1635#discussion_r443065036", "createdAt": "2020-06-19T22:25:41Z", "author": {"login": "keith-turner"}, "path": "server/base/src/main/java/org/apache/accumulo/server/fs/VolumeManagerImpl.java", "diffHunk": "@@ -289,6 +294,38 @@ public boolean rename(Path path, Path newPath) throws IOException {\n     return source.rename(path, newPath);\n   }\n \n+  @Override\n+  public List<Future<Boolean>> bulkRename(Map<Path,Path> oldToNewPathMap,\n+      SimpleThreadPool workerPool, String transactionId) throws InterruptedException {\n+    List<Future<Boolean>> results = new ArrayList<>();\n+    oldToNewPathMap.forEach((oldPath, newPath) -> results.add(workerPool.submit(() -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "456bce85074d4bfe6666cb737a6aecc37f9a2eb1"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA2NjUwNQ==", "bodyText": "If this method is going to shutdown the pool, I think it would be better if it created the pool also.  This method could accept a number of threads and operation name instead of a thread pool and use those to create the pool.", "url": "https://github.com/apache/accumulo/pull/1635#discussion_r443066505", "createdAt": "2020-06-19T22:32:46Z", "author": {"login": "keith-turner"}, "path": "server/base/src/main/java/org/apache/accumulo/server/fs/VolumeManagerImpl.java", "diffHunk": "@@ -289,6 +294,38 @@ public boolean rename(Path path, Path newPath) throws IOException {\n     return source.rename(path, newPath);\n   }\n \n+  @Override\n+  public List<Future<Boolean>> bulkRename(Map<Path,Path> oldToNewPathMap,\n+      SimpleThreadPool workerPool, String transactionId) throws InterruptedException {\n+    List<Future<Boolean>> results = new ArrayList<>();\n+    oldToNewPathMap.forEach((oldPath, newPath) -> results.add(workerPool.submit(() -> {\n+      boolean success;\n+      try {\n+        success = rename(oldPath, newPath);\n+      } catch (IOException e) {\n+        // The rename could have failed because this is the second time its running (failures\n+        // could cause this to run multiple times).\n+        if (!exists(newPath) || exists(oldPath)) {\n+          throw e;\n+        }\n+        log.debug(\n+            \"Ignoring rename exception for {} because destination already exists. orig: {} new: {}\",\n+            transactionId, oldPath, newPath, e);\n+        success = true;\n+      }\n+      if (!success) {\n+        log.error(\"Rename operation {} returned false. orig: {} new: {}\", transactionId, oldPath,\n+            newPath);\n+      } else if (log.isTraceEnabled()) {\n+        log.trace(\"{} moved {} to {}\", transactionId, oldPath, newPath);\n+      }\n+      return success;\n+    })));\n+    workerPool.shutdown();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "456bce85074d4bfe6666cb737a6aecc37f9a2eb1"}, "originalPosition": 56}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b258447471ac196b27734d626e15ab29cedd6e7", "author": {"user": {"login": "milleruntime", "name": "Mike Miller"}}, "url": "https://github.com/apache/accumulo/commit/9b258447471ac196b27734d626e15ab29cedd6e7", "committedDate": "2020-06-29T18:06:50Z", "message": "Create thread pool in method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwMTMyNjMy", "url": "https://github.com/apache/accumulo/pull/1635#pullrequestreview-440132632", "createdAt": "2020-06-30T15:26:52Z", "commit": {"oid": "9b258447471ac196b27734d626e15ab29cedd6e7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNToyNjo1MlrOGrB51g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNToyNjo1MlrOGrB51g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc3MzE0Mg==", "bodyText": "I wonder if this check should also be done in the case where rename returns false.", "url": "https://github.com/apache/accumulo/pull/1635#discussion_r447773142", "createdAt": "2020-06-30T15:26:52Z", "author": {"login": "keith-turner"}, "path": "server/base/src/main/java/org/apache/accumulo/server/fs/VolumeManagerImpl.java", "diffHunk": "@@ -289,6 +294,39 @@ public boolean rename(Path path, Path newPath) throws IOException {\n     return source.rename(path, newPath);\n   }\n \n+  @Override\n+  public List<Future<Boolean>> bulkRename(Map<Path,Path> oldToNewPathMap, int poolSize,\n+      String poolName, String transactionId) throws InterruptedException {\n+    List<Future<Boolean>> results = new ArrayList<>();\n+    SimpleThreadPool workerPool = new SimpleThreadPool(poolSize, poolName);\n+    oldToNewPathMap.forEach((oldPath, newPath) -> results.add(workerPool.submit(() -> {\n+      boolean success;\n+      try {\n+        success = rename(oldPath, newPath);\n+      } catch (IOException e) {\n+        // The rename could have failed because this is the second time its running (failures\n+        // could cause this to run multiple times).\n+        if (!exists(newPath) || exists(oldPath)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b258447471ac196b27734d626e15ab29cedd6e7"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5399cc4ccd03400d9ec9e0a3cb05f299c3f65e4", "author": {"user": {"login": "milleruntime", "name": "Mike Miller"}}, "url": "https://github.com/apache/accumulo/commit/f5399cc4ccd03400d9ec9e0a3cb05f299c3f65e4", "committedDate": "2020-07-02T15:31:39Z", "message": "Move handling of futures into VolumeManagerImpl method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxOTQ5NDA5", "url": "https://github.com/apache/accumulo/pull/1635#pullrequestreview-441949409", "createdAt": "2020-07-02T18:58:55Z", "commit": {"oid": "f5399cc4ccd03400d9ec9e0a3cb05f299c3f65e4"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxODo1ODo1NVrOGsZubQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxOTowMDo1MVrOGsZx9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIxMjAxMw==", "bodyText": "Seems like this should do the following.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  if (!success) {\n          \n          \n            \n                    log.error(\"Rename operation {} returned false. orig: {} new: {}\", transactionId, oldPath,\n          \n          \n            \n                        newPath);\n          \n          \n            \n                  } else if (log.isTraceEnabled()) {\n          \n          \n            \n                  if (!success && (!exists(newPath) || exists(oldPath))) {\n          \n          \n            \n                      throw new IOException(\"Rename operation \"+transactionId+\" returned false. orig: \"+oldPath+\" new: \"+newPath);\n          \n          \n            \n                  } else if (log.isTraceEnabled()) {", "url": "https://github.com/apache/accumulo/pull/1635#discussion_r449212013", "createdAt": "2020-07-02T18:58:55Z", "author": {"login": "keith-turner"}, "path": "server/base/src/main/java/org/apache/accumulo/server/fs/VolumeManagerImpl.java", "diffHunk": "@@ -289,6 +295,45 @@ public boolean rename(Path path, Path newPath) throws IOException {\n     return source.rename(path, newPath);\n   }\n \n+  @Override\n+  public void bulkRename(Map<Path,Path> oldToNewPathMap, int poolSize, String poolName,\n+      String transactionId) throws IOException {\n+    List<Future<Void>> results = new ArrayList<>();\n+    SimpleThreadPool workerPool = new SimpleThreadPool(poolSize, poolName);\n+    oldToNewPathMap.forEach((oldPath, newPath) -> results.add(workerPool.submit(() -> {\n+      boolean success;\n+      try {\n+        success = rename(oldPath, newPath);\n+      } catch (IOException e) {\n+        // The rename could have failed because this is the second time its running (failures\n+        // could cause this to run multiple times).\n+        if (!exists(newPath) || exists(oldPath)) {\n+          throw e;\n+        }\n+        log.debug(\n+            \"Ignoring rename exception for {} because destination already exists. orig: {} new: {}\",\n+            transactionId, oldPath, newPath, e);\n+        success = true;\n+      }\n+      if (!success) {\n+        log.error(\"Rename operation {} returned false. orig: {} new: {}\", transactionId, oldPath,\n+            newPath);\n+      } else if (log.isTraceEnabled()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5399cc4ccd03400d9ec9e0a3cb05f299c3f65e4"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIxMjkxNg==", "bodyText": "could add something to the docs about this operation being idempotent, safe to call again after previous partial run of bulkRename", "url": "https://github.com/apache/accumulo/pull/1635#discussion_r449212916", "createdAt": "2020-07-02T19:00:51Z", "author": {"login": "keith-turner"}, "path": "server/base/src/main/java/org/apache/accumulo/server/fs/VolumeManager.java", "diffHunk": "@@ -149,6 +150,11 @@ FSDataOutputStream createSyncable(Path logPath, int buffersize, short replicatio\n   // volumes\n   boolean rename(Path path, Path newPath) throws IOException;\n \n+  // rename lots of files at once in a thread pool\n+  // returns once all the threads have completed", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5399cc4ccd03400d9ec9e0a3cb05f299c3f65e4"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d66514d5e31062ed185ef5eb70913cbb3f382e55", "author": {"user": {"login": "milleruntime", "name": "Mike Miller"}}, "url": "https://github.com/apache/accumulo/commit/d66514d5e31062ed185ef5eb70913cbb3f382e55", "committedDate": "2020-07-02T19:14:31Z", "message": "Update server/base/src/main/java/org/apache/accumulo/server/fs/VolumeManagerImpl.java\n\nCo-authored-by: Keith Turner <kturner@apache.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "355b0e94cc8d5bfa3bfe49f1563ec5b2da3eb681", "author": {"user": {"login": "milleruntime", "name": "Mike Miller"}}, "url": "https://github.com/apache/accumulo/commit/355b0e94cc8d5bfa3bfe49f1563ec5b2da3eb681", "committedDate": "2020-07-02T19:23:45Z", "message": "Cleanup"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1975, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}