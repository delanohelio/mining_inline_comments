{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA0MTg2NzQz", "number": 1738, "title": "VolumeManager and Volume internals cleanup", "bodyText": "VolumeManager\n\nremove getDefaultVolume, which was only used to create a temporary\ndirectory for creating tables with split points, and to resolve\nrelative paths\nreplace \"default volume\" concept with the first available volume\n(this is what it was effectively doing anyway... but now it's\nimplemented more cleanly)\nsimplified much of the volume management code in the CreateTable\nFaTE operation classes, where creation of temporary files for\nstoring splits on a pre-split table was being handled\nrename getFileSystem methods throughout that return VolumeManager to\ngetVolumeManager, and stop passing it as an extra parameter if it is\nalready available via a ServerContext object\n\n\nVolume\n\nRemove unneeded overloaded Volume.prefixChild(Path)\nRename Volume.isValidPath(Path) to Volume.containsPath(Path) to\nimprove readability\nUpdate javadoc for containsPath to describe what it means for a Path\nto be contained\nUpdate VolumeImplTest to verify behavior of containsPath\n\n\nVolumeImpl\n\nMake protected fields private\nRename conf to hadoopConf to clarify which config it is\nnormalize base path by stripping out trailing slashes\nrename helper method equivalentPaths(Path) to isAncestorPathOf(Path)\nfor readability in containsPath(Path) implementation\nadd more strict argument checking for prefixChild(String)\nfix bug in isAncestorPathOf(Path) that incorrectly concluded /a/path\nis an ancestor of /a/pa (/a is an ancestor, but /a/pa is not)\n\n\nVolumeImplTest\n\ncheck normalization by testing with trailing slashes\nadd more test cases for isAncestorPathOf, including checking for\n\"breakout\" path terms, like \"..\"\nadd test cases for prefixChild and containsPath\n\n\nTablet\n\nFix bug in Tablet that wasn't using the Path's FileSystem when\ndeleting a file, but instead was using an arbitrary FileSystem", "createdAt": "2020-10-15T15:22:19Z", "url": "https://github.com/apache/accumulo/pull/1738", "merged": true, "mergeCommit": {"oid": "62110a3c27b9a27d8a7c0bc272aa6778910acad7"}, "closed": true, "closedAt": "2020-10-21T08:57:34Z", "author": {"login": "ctubbsii"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSzUmiAH2gAyNTA0MTg2NzQzOjhmNTY0NDIyMjBkZjViYjQ1ZjE2YTNkMjhhZGIzZGMwNjFiZTU4ODE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUfOeHgH2gAyNTA0MTg2NzQzOmQ0YjY2ZWY3NTdmZWM4NjJjNTg5NWFmNTBjMTcyMTEzOWEwMTE3YzE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8f56442220df5bb45f16a3d28adb3dc061be5881", "author": {"user": {"login": "ctubbsii", "name": "Christopher Tubbs"}}, "url": "https://github.com/apache/accumulo/commit/8f56442220df5bb45f16a3d28adb3dc061be5881", "committedDate": "2020-10-15T15:15:32Z", "message": "VolumeManager and Volume internals cleanup\n\n* VolumeManager\n  * remove getDefaultVolume, which was only used to create a temporary\n    directory for creating tables with split points, and to resolve\n    relative paths\n  * replace \"default volume\" concept with the first available volume\n    (this is what it was effectively doing anyway... but now it's\n    implemented more cleanly)\n  * simplified much of the volume management code in the CreateTable\n    FaTE operation classes, where creation of temporary files for\n    storing splits on a pre-split table was being handled\n  * rename getFileSystem methods throughout that return VolumeManager to\n    getVolumeManager, and stop passing it as an extra parameter if it is\n    already available via a ServerContext object\n* Volume\n  * Remove unneeded overloaded Volume.prefixChild(Path)\n  * Rename Volume.isValidPath(Path) to Volume.containsPath(Path) to\n    improve readability\n  * Update javadoc for containsPath to describe what it means for a Path\n    to be contained\n  * Update VolumeImplTest to verify behavior of containsPath\n* VolumeImpl\n  * Make protected fields private\n  * Rename conf to hadoopConf to clarify which config it is\n  * normalize base path by stripping out trailing slashes\n  * rename helper method equivalentPaths(Path) to isAncestorPathOf(Path)\n    for readability in containsPath(Path) implementation\n  * add more strict argument checking for prefixChild(String)\n  * fix bug in isAncestorPathOf(Path) that incorrectly concluded /a/path\n    is an ancestor of /a/pa (/a is an ancestor, but /a/pa is not)\n* VolumeImplTest\n  * check normalization by testing with trailing slashes\n  * add more test cases for isAncestorPathOf, including checking for\n    \"breakout\" path terms, like \"..\"\n  * add test cases for prefixChild and containsPath\n* Tablet\n  * Fix bug in Tablet that wasn't using the Path's FileSystem when\n    deleting a file, but instead was using an arbitrary FileSystem"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5NTE1ODg0", "url": "https://github.com/apache/accumulo/pull/1738#pullrequestreview-509515884", "createdAt": "2020-10-15T15:38:54Z", "commit": {"oid": "8f56442220df5bb45f16a3d28adb3dc061be5881"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxNTozODo1NFrOHiOExA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxNTozODo1NFrOHiOExA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY0NDIyOA==", "bodyText": "It looks like you are just clarifying what should be in the string parameter and did not change the behavior correct?", "url": "https://github.com/apache/accumulo/pull/1738#discussion_r505644228", "createdAt": "2020-10-15T15:38:54Z", "author": {"login": "milleruntime"}, "path": "core/src/main/java/org/apache/accumulo/core/volume/Volume.java", "diffHunk": "@@ -38,26 +38,25 @@\n   String getBasePath();\n \n   /**\n-   * Convert the given Path into a Path that is relative to the base path for this Volume\n+   * Convert the given child path into a Path that is relative to the base path for this Volume. The\n+   * supplied path should not include any scheme (such as <code>file:</code> or <code>hdfs:</code>),\n+   * and should not contain any relative path \"breakout\" patterns, such as <code>../</code>. If the\n+   * path begins with a single slash, it will be preserved while prefixing this volume. If it does\n+   * not begin with a single slash, one will be inserted.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f56442220df5bb45f16a3d28adb3dc061be5881"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5NTIwMzI3", "url": "https://github.com/apache/accumulo/pull/1738#pullrequestreview-509520327", "createdAt": "2020-10-15T15:43:42Z", "commit": {"oid": "8f56442220df5bb45f16a3d28adb3dc061be5881"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxNTo0Mzo0M1rOHiOSZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxNTo0Mzo0M1rOHiOSZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY0NzcxNg==", "bodyText": "Nice, this is much more clear.", "url": "https://github.com/apache/accumulo/pull/1738#discussion_r505647716", "createdAt": "2020-10-15T15:43:43Z", "author": {"login": "milleruntime"}, "path": "server/base/src/main/java/org/apache/accumulo/server/fs/VolumeManager.java", "diffHunk": "@@ -179,12 +179,14 @@ void bulkRename(Map<Path,Path> oldToNewPathMap, int poolSize, String poolName,\n   boolean canSyncAndFlush(Path path);\n \n   /**\n-   * Fetch the default Volume\n+   * Fetch the first configured instance Volume\n    */\n-  Volume getDefaultVolume();\n+  default Volume getFirst() {\n+    return getVolumes().iterator().next();\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f56442220df5bb45f16a3d28adb3dc061be5881"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5NTI1OTcw", "url": "https://github.com/apache/accumulo/pull/1738#pullrequestreview-509525970", "createdAt": "2020-10-15T15:49:48Z", "commit": {"oid": "8f56442220df5bb45f16a3d28adb3dc061be5881"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxNTo0OTo0OFrOHiOjMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxNTo0OTo0OFrOHiOjMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY1MjAxNg==", "bodyText": "Any idea why this temp file was created? Sounds like it was created to help with failover somewhere.", "url": "https://github.com/apache/accumulo/pull/1738#discussion_r505652016", "createdAt": "2020-10-15T15:49:48Z", "author": {"login": "milleruntime"}, "path": "server/manager/src/main/java/org/apache/accumulo/master/FateServiceHandler.java", "diffHunk": "@@ -779,65 +781,37 @@ private String validateNewNamespaceArgument(ByteBuffer namespaceArg, TableOperat\n   /**\n    * Create a file on the file system to hold the splits to be created at table creation.\n    */\n-  private String writeSplitsToFile(final long opid, final List<ByteBuffer> arguments,\n+  private void writeSplitsToFile(Path splitsPath, final List<ByteBuffer> arguments,\n       final int splitCount, final int splitOffset) throws IOException {\n-    String opidStr = String.format(\"%016x\", opid);\n-    String splitsPath = getSplitPath(\"/tmp/splits-\" + opidStr);\n-    removeAndCreateTempFile(splitsPath);\n-    try (FSDataOutputStream stream = master.getOutputStream(splitsPath)) {\n-      writeSplitsToFileSystem(stream, arguments, splitCount, splitOffset);\n+    FileSystem fs = splitsPath.getFileSystem(master.getContext().getHadoopConf());\n+    try (FSDataOutputStream stream = fs.create(splitsPath)) {\n+      // base64 encode because splits can contain binary\n+      for (int i = splitOffset; i < splitCount + splitOffset; i++) {\n+        byte[] splitBytes = ByteBufferUtil.toBytes(arguments.get(i));\n+        String encodedSplit = Base64.getEncoder().encodeToString(splitBytes);\n+        stream.writeBytes(encodedSplit + '\\n');\n+      }\n     } catch (IOException e) {\n-      log.error(\"Error in FateServiceHandler while writing splits for opid: \" + opidStr + \": \"\n-          + e.getMessage());\n+      log.error(\"Error in FateServiceHandler while writing splits to {}: {}\", splitsPath,\n+          e.getMessage());\n       throw e;\n     }\n-    return splitsPath;\n-  }\n-\n-  /**\n-   * Always check for and delete the splits file if it exists to prevent issues in case of server\n-   * failure and/or FateServiceHandler retries.\n-   */\n-  private void removeAndCreateTempFile(String path) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f56442220df5bb45f16a3d28adb3dc061be5881"}, "originalPosition": 62}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5NTI3NjUy", "url": "https://github.com/apache/accumulo/pull/1738#pullrequestreview-509527652", "createdAt": "2020-10-15T15:51:37Z", "commit": {"oid": "8f56442220df5bb45f16a3d28adb3dc061be5881"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxNTo1MTozN1rOHiOoNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxNTo1MTozN1rOHiOoNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY1MzMwMw==", "bodyText": "Looks like the comments are outdated now that you changed the parameters.", "url": "https://github.com/apache/accumulo/pull/1738#discussion_r505653303", "createdAt": "2020-10-15T15:51:37Z", "author": {"login": "milleruntime"}, "path": "server/manager/src/main/java/org/apache/accumulo/master/tableOps/Utils.java", "diffHunk": "@@ -198,19 +197,21 @@ public static void checkNamespaceDoesNotExist(ServerContext context, String name\n    * Given an input stream and a flag indicating if the file info is base64 encoded or not, retrieve\n    * the data from a file on the file system. It is assumed that the file is textual and not binary\n    * data.\n+   *", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f56442220df5bb45f16a3d28adb3dc061be5881"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd1c1f7262a9cc74b729077f4c090243d1fd9208", "author": {"user": {"login": "ctubbsii", "name": "Christopher Tubbs"}}, "url": "https://github.com/apache/accumulo/commit/bd1c1f7262a9cc74b729077f4c090243d1fd9208", "committedDate": "2020-10-15T18:02:06Z", "message": "Update from code review\n\n* Update instance.volumes property description\n* Ensure split files get written and read using UTF-8\n* Fix javadoc for Utils.getSortedSetFromFile"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwNzE0OTUz", "url": "https://github.com/apache/accumulo/pull/1738#pullrequestreview-510714953", "createdAt": "2020-10-16T18:37:19Z", "commit": {"oid": "bd1c1f7262a9cc74b729077f4c090243d1fd9208"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12440636b8305a169108efd646883f07e3f29dfe", "author": {"user": {"login": "ctubbsii", "name": "Christopher Tubbs"}}, "url": "https://github.com/apache/accumulo/commit/12440636b8305a169108efd646883f07e3f29dfe", "committedDate": "2020-10-20T19:09:17Z", "message": "Merge branch 'main' into fix-default-volume"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4b66ef757fec862c5895af50c1721139a0117c1", "author": {"user": {"login": "ctubbsii", "name": "Christopher Tubbs"}}, "url": "https://github.com/apache/accumulo/commit/d4b66ef757fec862c5895af50c1721139a0117c1", "committedDate": "2020-10-20T20:58:35Z", "message": "Fix test breakages\n\n* Fix `VolumeImpl.toString()`\n* Improve exception message for prefixChild to include volume name\n* Improve test cases for VolumeImplTest, separating out the different\n  failure cases to validate the exception messages"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1747, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}