{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMyMTM2ODE5", "number": 1821, "title": "Create listtablets shell command. Closes #1317", "bodyText": "New command for debugging tablets called listtablets\nAdded getLiveTServers() to TabletMetadata for generating a list of\ntservers that currently have a lock in ZK, similar to master.\nThe list of live tservers is passed to TabletMetadata in order to get\nthe current state of a tablet\nCommand will print one line for every tablet in a table\nCreated TabletMetadataIT for testing getLiveTServers()\n\nCo-authored-by: EdColeman dev1@etcoleman.com", "createdAt": "2020-12-03T21:42:34Z", "url": "https://github.com/apache/accumulo/pull/1821", "merged": true, "mergeCommit": {"oid": "376910eb26e51d7361f3852705a954ad998e4c6b"}, "closed": true, "closedAt": "2021-01-04T20:16:09Z", "author": {"login": "milleruntime"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdj7XWIgFqTU0NjQ5NTgyOA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABds7vRSABqjQxNjY0NDc5ODk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2NDk1ODI4", "url": "https://github.com/apache/accumulo/pull/1821#pullrequestreview-546495828", "createdAt": "2020-12-07T20:08:27Z", "commit": {"oid": "93f69b57af04ac53f21fcf5147bb876da7b7665b"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMDowODoyN1rOIA4i_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMDoxNDoyM1rOIA4xQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzc5NzM3Mg==", "bodyText": "This pattern of populating currentServers inside the other method, checkServer, after looping over all can be improved with something like:\n  var children = context.getZooCache().getChildren(path);\n  var liveTservers = children.map(TabletMetadata::checkServer).filter(Optional::isPresent).collect(Collectors.toSet());\n  log(liveTservers);\n  return liveTservers;\nThis requires checkServer to be modified to return either Optional.of(instance) or Optional.empty(), but I think it's more readable.", "url": "https://github.com/apache/accumulo/pull/1821#discussion_r537797372", "createdAt": "2020-12-07T20:08:27Z", "author": {"login": "ctubbsii"}, "path": "core/src/main/java/org/apache/accumulo/core/metadata/schema/TabletMetadata.java", "diffHunk": "@@ -435,4 +445,34 @@ static TabletMetadata create(String id, String prevEndRow, String endRow) {\n     te.fetchedCols = EnumSet.of(ColumnType.PREV_ROW);\n     return te;\n   }\n+\n+  public static synchronized Set<TServerInstance> getLiveTServers(ClientContext context) {\n+    final Set<TServerInstance> currentServers = new HashSet<>();\n+\n+    final String path = context.getZooKeeperRoot() + Constants.ZTSERVERS;\n+\n+    HashSet<String> all = new HashSet<>(context.getZooCache().getChildren(path));\n+\n+    for (String zPath : all) {\n+      checkServer(context, currentServers, path, zPath);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93f69b57af04ac53f21fcf5147bb876da7b7665b"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgwMTAyNA==", "bodyText": "I feel like we have some sort of ConfigurableMacIT that is our normal way of doing this. Will that work here instead of this callback?", "url": "https://github.com/apache/accumulo/pull/1821#discussion_r537801024", "createdAt": "2020-12-07T20:14:23Z", "author": {"login": "ctubbsii"}, "path": "test/src/main/java/org/apache/accumulo/test/functional/TabletMetadataIT.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.test.functional;\n+\n+import static org.apache.accumulo.fate.util.UtilWaitThread.sleepUninterruptibly;\n+import static org.apache.accumulo.minicluster.ServerType.TABLET_SERVER;\n+import static org.junit.Assert.assertEquals;\n+\n+import java.util.Set;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.apache.accumulo.core.client.Accumulo;\n+import org.apache.accumulo.core.client.AccumuloClient;\n+import org.apache.accumulo.core.clientImpl.ClientContext;\n+import org.apache.accumulo.core.metadata.TServerInstance;\n+import org.apache.accumulo.core.metadata.schema.TabletMetadata;\n+import org.apache.accumulo.harness.MiniClusterConfigurationCallback;\n+import org.apache.accumulo.harness.SharedMiniClusterBase;\n+import org.apache.accumulo.miniclusterImpl.MiniAccumuloConfigImpl;\n+import org.apache.hadoop.conf.Configuration;\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Tests features of the Ample TabletMetadata class that can't be tested in TabletMetadataTest\n+ */\n+public class TabletMetadataIT extends SharedMiniClusterBase {\n+  private static final Logger log = LoggerFactory.getLogger(TabletMetadataIT.class);\n+  private static final int NUM_TSERVERS = 4;\n+\n+  @BeforeClass\n+  public static void setup() throws Exception {\n+    SharedMiniClusterBase.startMiniClusterWithConfig(new Callback());\n+  }\n+\n+  @AfterClass\n+  public static void teardown() {\n+    SharedMiniClusterBase.stopMiniCluster();\n+  }\n+\n+  @Override\n+  protected int defaultTimeoutSeconds() {\n+    return 120;\n+  }\n+\n+  private static class Callback implements MiniClusterConfigurationCallback {\n+    @Override\n+    public void configureMiniCluster(MiniAccumuloConfigImpl cfg, Configuration conf) {\n+      cfg.setNumTservers(NUM_TSERVERS);\n+    }\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93f69b57af04ac53f21fcf5147bb876da7b7665b"}, "originalPosition": 70}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "93f69b57af04ac53f21fcf5147bb876da7b7665b", "author": {"user": {"login": "milleruntime", "name": "Mike Miller"}}, "url": "https://github.com/apache/accumulo/commit/93f69b57af04ac53f21fcf5147bb876da7b7665b", "committedDate": "2020-12-04T13:26:27Z", "message": "Fix Test"}, "afterCommit": {"oid": "f7dcec9964eb70bd69357a6cae91fe02c334d26d", "author": {"user": {"login": "milleruntime", "name": "Mike Miller"}}, "url": "https://github.com/apache/accumulo/commit/f7dcec9964eb70bd69357a6cae91fe02c334d26d", "committedDate": "2020-12-15T16:05:00Z", "message": "Fix Test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe21059ad1d76475d226cfcda71a4fff41f4cad2", "author": {"user": {"login": "milleruntime", "name": "Mike Miller"}}, "url": "https://github.com/apache/accumulo/commit/fe21059ad1d76475d226cfcda71a4fff41f4cad2", "committedDate": "2021-01-04T19:45:42Z", "message": "Create listtablets shell command. Closes #1317\n\n* New command for debugging tablets called listtablets\n* Added getLiveTServers() to TabletMetadata for generating a list of\ntservers that currently have a lock in ZK, similar to master.\n* The list of live tservers is passed to TabletMetadata in order to get\nthe current state of a tablet\n* Command will print one line for every tablet in a table\n* Created TabletMetadataIT for testing getLiveTServers()\n\nCo-authored-by: EdColeman <dev1@etcoleman.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd67a6bae391bd3cf25a0baac213f19cc07337b5", "author": {"user": {"login": "milleruntime", "name": "Mike Miller"}}, "url": "https://github.com/apache/accumulo/commit/fd67a6bae391bd3cf25a0baac213f19cc07337b5", "committedDate": "2021-01-04T19:45:42Z", "message": "Fix Test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c34866cddd7be7a3181fd457a65a4c8112c45fa", "author": {"user": {"login": "milleruntime", "name": "Mike Miller"}}, "url": "https://github.com/apache/accumulo/commit/4c34866cddd7be7a3181fd457a65a4c8112c45fa", "committedDate": "2021-01-04T19:45:43Z", "message": "Improvements to IT and TabletMetadata method"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ba8fb271f6ba0bc9c7bf841093c76ead9ae03244", "author": {"user": {"login": "milleruntime", "name": "Mike Miller"}}, "url": "https://github.com/apache/accumulo/commit/ba8fb271f6ba0bc9c7bf841093c76ead9ae03244", "committedDate": "2020-12-15T18:05:56Z", "message": "Improvements to IT and TabletMetadata method"}, "afterCommit": {"oid": "4c34866cddd7be7a3181fd457a65a4c8112c45fa", "author": {"user": {"login": "milleruntime", "name": "Mike Miller"}}, "url": "https://github.com/apache/accumulo/commit/4c34866cddd7be7a3181fd457a65a4c8112c45fa", "committedDate": "2021-01-04T19:45:43Z", "message": "Improvements to IT and TabletMetadata method"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1667, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}