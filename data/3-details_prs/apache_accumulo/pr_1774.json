{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE4ODE3NTgz", "number": 1774, "title": "Refactor Tablet state classes", "bodyText": "Move TabletState, TabletLocationState, TServerInstance and\nSuspendingTServer from master to core.metadata package to allow\npackages outside of master to use them\nMake ample TabletMetadata.Location extend TServerInstance to\neliminate a temporary interface and some redundant object creation\nRewrite GroupBalancer getLocationProvider() method to eliminate\nLocation inner class\nModify GroupBalancerTest to override new method", "createdAt": "2020-11-10T23:07:22Z", "url": "https://github.com/apache/accumulo/pull/1774", "merged": true, "mergeCommit": {"oid": "cccac86255cd2d0ecd49e791162ca5cdf07512b6"}, "closed": true, "closedAt": "2020-11-17T19:11:02Z", "author": {"login": "milleruntime"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdbRhVNgH2gAyNTE4ODE3NTgzOjgwYTVkMjUzMjQ5MzU5Zjg4NjNhZDFiNTQxMjY4NTJlOTU4ODIwZDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdddeObAH2gAyNTE4ODE3NTgzOjFlMTM4ZGFmY2UzY2Y3MTRjZGVjYjFiMzVjNzdkNTljZWJlZDM0Yjg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "80a5d253249359f8863ad1b54126852e958820d4", "author": {"user": {"login": "milleruntime", "name": "Mike Miller"}}, "url": "https://github.com/apache/accumulo/commit/80a5d253249359f8863ad1b54126852e958820d4", "committedDate": "2020-11-10T22:57:59Z", "message": "Refactor Tablet state classes\n\n* Move TabletState, TabletLocationState, TServerInstance and\nSuspendingTServer from master to core.metadata package\n* Make ample TabletMetadata.Location extend TServerInstance\n* Rewrite GroupBalancer getLocationProvider() method\n* Modify GroupBalancerTest to override new method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3ODI5Njc1", "url": "https://github.com/apache/accumulo/pull/1774#pullrequestreview-527829675", "createdAt": "2020-11-11T03:06:17Z", "commit": {"oid": "80a5d253249359f8863ad1b54126852e958820d4"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQwMzowNjoxN1rOHw7X3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQwMzowOTowOFrOHw7iCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTA2NjQ2MA==", "bodyText": "This seems like a regression. In general, unless you're printing something, it's better to use a more specific type than a String type, and a more specific method name than toString(), since toString() should not be relied upon to not change over time.", "url": "https://github.com/apache/accumulo/pull/1774#discussion_r521066460", "createdAt": "2020-11-11T03:06:17Z", "author": {"login": "ctubbsii"}, "path": "core/src/main/java/org/apache/accumulo/core/clientImpl/TableOperationsImpl.java", "diffHunk": "@@ -1301,7 +1301,7 @@ private void waitForTableStateTransition(TableId tableId, TableState expectedSta\n           lastRow = tablet.getExtent().toMetaRow();\n \n           if (loc != null) {\n-            serverCounts.increment(loc.getId(), 1);\n+            serverCounts.increment(loc.toString(), 1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "80a5d253249359f8863ad1b54126852e958820d4"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTA2OTA2Ng==", "bodyText": "getLocation().getLocation() seems funny here. Too many types known as 'location'.", "url": "https://github.com/apache/accumulo/pull/1774#discussion_r521069066", "createdAt": "2020-11-11T03:09:08Z", "author": {"login": "ctubbsii"}, "path": "core/src/test/java/org/apache/accumulo/core/metadata/schema/TabletMetadataTest.java", "diffHunk": "@@ -145,7 +145,7 @@ public void testFuture() {\n         EnumSet.allOf(ColumnType.class), false);\n \n     assertEquals(extent, tm.getExtent());\n-    assertEquals(HostAndPort.fromParts(\"server1\", 8555), tm.getLocation().getHostAndPort());\n+    assertEquals(HostAndPort.fromParts(\"server1\", 8555), tm.getLocation().getLocation());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "80a5d253249359f8863ad1b54126852e958820d4"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6893e012510c1a02aebbd42fbbc040406456ba09", "author": {"user": {"login": "milleruntime", "name": "Mike Miller"}}, "url": "https://github.com/apache/accumulo/commit/6893e012510c1a02aebbd42fbbc040406456ba09", "committedDate": "2020-11-12T19:19:55Z", "message": "Drop temporary Ample interface and rename methods in TServerInstance.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c2b91d6825aed44884bae250554524424af054e", "author": {"user": {"login": "milleruntime", "name": "Mike Miller"}}, "url": "https://github.com/apache/accumulo/commit/2c2b91d6825aed44884bae250554524424af054e", "committedDate": "2020-11-12T19:51:10Z", "message": "Cleanup variables in TServerInstance and stop extra calls to toString"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b735d2291bc59c416c049079b8f182d08511828f", "author": {"user": {"login": "milleruntime", "name": "Mike Miller"}}, "url": "https://github.com/apache/accumulo/commit/b735d2291bc59c416c049079b8f182d08511828f", "committedDate": "2020-11-16T21:31:38Z", "message": "Drop serialization from TServerInstance\n\n* Serialize HostAndPort and string in ShutdownTServer master op instead\nof TserverInstance so we can drop custom serialization\n* Update ShutdownTServerTest"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxODIzMDg0", "url": "https://github.com/apache/accumulo/pull/1774#pullrequestreview-531823084", "createdAt": "2020-11-16T22:01:04Z", "commit": {"oid": "b735d2291bc59c416c049079b8f182d08511828f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQyMjowMTowNFrOH0V-Vg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQyMjowMTowNFrOH0V-Vg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDY0ODAyMg==", "bodyText": "The constructor can still use this type, since that won't affect serialization. The fields can be derived from the constructor parameter, rather than passed in as separate parameters.", "url": "https://github.com/apache/accumulo/pull/1774#discussion_r524648022", "createdAt": "2020-11-16T22:01:04Z", "author": {"login": "ctubbsii"}, "path": "server/manager/src/main/java/org/apache/accumulo/master/MasterClientServiceHandler.java", "diffHunk": "@@ -278,7 +278,9 @@ public void shutdownTabletServer(TInfo info, TCredentials c, String tabletServer\n \n     log.debug(\"Seeding FATE op to shutdown \" + tabletServer + \" with tid \" + tid);\n \n-    master.fate.seedTransaction(tid, new TraceRepo<>(new ShutdownTServer(doomed, force)), false);\n+    master.fate.seedTransaction(tid,\n+        new TraceRepo<>(new ShutdownTServer(doomed.getHostAndPort(), doomed.getSession(), force)),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b735d2291bc59c416c049079b8f182d08511828f"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f85258ebfa3b80ad3b209704a4072d57b8676b7", "author": {"user": {"login": "milleruntime", "name": "Mike Miller"}}, "url": "https://github.com/apache/accumulo/commit/3f85258ebfa3b80ad3b209704a4072d57b8676b7", "committedDate": "2020-11-17T15:57:19Z", "message": "Keep ShutdownTServer constructor and revert some changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyNTcyMTg0", "url": "https://github.com/apache/accumulo/pull/1774#pullrequestreview-532572184", "createdAt": "2020-11-17T16:46:06Z", "commit": {"oid": "3f85258ebfa3b80ad3b209704a4072d57b8676b7"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNjo0NjowN1rOH0-seA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNjo0NjowN1rOH0-seA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTMxNTE5Mg==", "bodyText": "Nice cleanup here.", "url": "https://github.com/apache/accumulo/pull/1774#discussion_r525315192", "createdAt": "2020-11-17T16:46:07Z", "author": {"login": "ctubbsii"}, "path": "server/base/src/main/java/org/apache/accumulo/server/master/balancer/GroupBalancer.java", "diffHunk": "@@ -79,21 +79,13 @@ public GroupBalancer(TableId tableId) {\n     this.tableId = tableId;\n   }\n \n-  protected Iterable<Pair<KeyExtent,Location>> getLocationProvider() {\n-    return () -> {\n-      try {\n-        return TabletsMetadata.builder().forTable(tableId).fetch(LOCATION, PREV_ROW).build(context)\n-            .stream().map(tm -> {\n-              Location loc = Location.NONE;\n-              if (tm.hasCurrent()) {\n-                loc = new Location(new TServerInstance(tm.getLocation()));\n-              }\n-              return new Pair<>(tm.getExtent(), loc);\n-            }).iterator();\n-      } catch (Exception e) {\n-        throw new RuntimeException(e);\n-      }\n-    };\n+  protected Map<KeyExtent,TServerInstance> getLocationProvider() {\n+    Map<KeyExtent,TServerInstance> tablets = new LinkedHashMap<>();\n+    for (var tm : TabletsMetadata.builder().forTable(tableId).fetch(LOCATION, PREV_ROW)\n+        .build(context)) {\n+      tablets.put(tm.getExtent(), tm.getLocation());\n+    }\n+    return tablets;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f85258ebfa3b80ad3b209704a4072d57b8676b7"}, "originalPosition": 50}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e138dafce3cf714cdecb1b35c77d59cebed34b8", "author": {"user": {"login": "milleruntime", "name": "Mike Miller"}}, "url": "https://github.com/apache/accumulo/commit/1e138dafce3cf714cdecb1b35c77d59cebed34b8", "committedDate": "2020-11-17T18:01:18Z", "message": "Replace mock object in test with real object\n\n* Also remove serialID no longer needed on Location"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1793, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}