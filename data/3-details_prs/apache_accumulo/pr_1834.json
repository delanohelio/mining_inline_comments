{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM1NTgxMjU2", "number": 1834, "title": "Remove centralized crypto constants", "bodyText": "This PR contains two small commits:\n\nConsolidate tablet obscuring code\nThis fixes #1805\nMove implementation of tablet obscuring code into KeyExtent and remove\nduplicate implementations.\nAlso fixup trivial constant in VisMetricsGatherer, so it is private and\nfix typo in ZKSecurityTool to clarify that the salt length is 8 bytes by\ndefault, not the hash length\n\nUpdate SystemCredentials to use crypt(3) format\nThis fixes #1810\nThis updates the SystemToken generation to use SHA-512 while hashing the\nsystem's instance.* configuration properties (including\ninstance.secret) by using commons-codec's crypt(3) implementation.\nIt also adds more javadocs and makes the code a bit more readable, while\nremoving a hard-coded global constant and an unneeded new instance\nproperty introduced in #1798. That property is unneeded, since the\nexistence of the property itself creates wire-incompatibility. Instead,\nthis change explicitly bumps the wire version.\nAlso add sanity checks in SystemCredentialsTest for the wire version\nvalues and to detect significant changes in the default algorithm used\nby commons-codec to hash the credentials to prevent suprises when\nupgrading the commons-codec library in future.", "createdAt": "2020-12-10T01:56:34Z", "url": "https://github.com/apache/accumulo/pull/1834", "merged": true, "mergeCommit": {"oid": "d4c21f80843483a74a53477b8952d53e39c80d5d"}, "closed": true, "closedAt": "2020-12-10T13:25:36Z", "author": {"login": "ctubbsii"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdkoKB6AH2gAyNTM1NTgxMjU2OmQ5ZWQ3YjQxMWM5Y2E2ODZjODk4NzBhMzYzY2ExOTkwNDIwNTdkMmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmKHYMAFqTU1MTc4MDU4Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d9ed7b411c9ca686c89870a363ca199042057d2d", "author": {"user": {"login": "ctubbsii", "name": "Christopher Tubbs"}}, "url": "https://github.com/apache/accumulo/commit/d9ed7b411c9ca686c89870a363ca199042057d2d", "committedDate": "2020-12-10T00:25:40Z", "message": "Update SystemCredentials to use crypt(3) format\n\nThis fixes #1810\n\nThis updates the SystemToken generation to use SHA-512 while hashing the\nsystem's `instance.*` configuration properties (including\n`instance.secret`) by using commons-codec's crypt(3) implementation.\n\nIt also adds more javadocs and makes the code a bit more readable, while\nremoving a hard-coded global constant and an unneeded new instance\nproperty introduced in #1798. That property is unneeded, since the\nexistence of the property itself creates wire-incompatibility. Instead,\nthis change explicitly bumps the wire version.\n\nAlso add sanity checks in SystemCredentialsTest for the wire version\nvalues and to detect significant changes in the default algorithm used\nby commons-codec to hash the credentials to prevent suprises when\nupgrading the commons-codec library in future."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "babb1d9e559a78577fbe763181043715e572bfa5", "author": {"user": {"login": "ctubbsii", "name": "Christopher Tubbs"}}, "url": "https://github.com/apache/accumulo/commit/babb1d9e559a78577fbe763181043715e572bfa5", "committedDate": "2020-12-10T01:50:16Z", "message": "Consolidate tablet obscuring code\n\nThis fixes #1805\n\nMove implementation of tablet obscuring code into KeyExtent and remove\nduplicate implementations.\n\nAlso fixup trivial constant in VisMetricsGatherer, so it is private and\nfix typo in ZKSecurityTool to clarify that the salt length is 8 bytes by\ndefault, not the hash length"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxNzc4Njk1", "url": "https://github.com/apache/accumulo/pull/1834#pullrequestreview-551778695", "createdAt": "2020-12-14T18:31:03Z", "commit": {"oid": "babb1d9e559a78577fbe763181043715e572bfa5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxODozMTowNFrOIFevGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxODozMTowNFrOIFevGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjYxNzM2OA==", "bodyText": "It looks like this is required by the Crypt library?  Would be nice to mention where these values for the salt string are coming from.", "url": "https://github.com/apache/accumulo/pull/1834#discussion_r542617368", "createdAt": "2020-12-14T18:31:04Z", "author": {"login": "milleruntime"}, "path": "server/base/src/main/java/org/apache/accumulo/server/security/SystemCredentials.java", "diffHunk": "@@ -83,10 +82,19 @@ public TCredentials toThrift(String instanceID) {\n   public static final class SystemToken extends PasswordToken {\n \n     /**\n-     * Accumulo servers will only communicate with each other when this is the same. Bumped for 2.0\n-     * to prevent 1.9 and 2.0 servers from communicating.\n+     * Accumulo servers will only communicate with each other when this is the same.\n+     *\n+     * <ul>\n+     * <li>Initial version 2 for 1.5 to support rolling upgrades for bugfix releases (ACCUMULO-751)\n+     * <li>Bumped to 3 for 1.6 for additional namespace RPC changes (ACCUMULO-802)\n+     * <li>Bumped to 4 for 2.0 to prevent 1.9 and 2.0 servers from communicating (#1139)\n+     * <li>Bumped to 5 for 2.1 because of system credential hash incompatibility (#1798 / #1810)\n+     * </ul>\n      */\n-    private static final Integer INTERNAL_WIRE_VERSION = 4;\n+    static final int INTERNAL_WIRE_VERSION = 5;\n+\n+    static final String SALT_PREFIX = \"$6$\"; // SHA-512", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "babb1d9e559a78577fbe763181043715e572bfa5"}, "originalPosition": 47}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxNzgwNTgz", "url": "https://github.com/apache/accumulo/pull/1834#pullrequestreview-551780583", "createdAt": "2020-12-14T18:33:27Z", "commit": {"oid": "babb1d9e559a78577fbe763181043715e572bfa5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxODozMzoyN1rOIFe4zA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxODozMzoyN1rOIFe4zA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjYxOTg1Mg==", "bodyText": "This is a great test.  I wish we had more tests like this with dependencies so the test will simply fail if defaults change on an update.", "url": "https://github.com/apache/accumulo/pull/1834#discussion_r542619852", "createdAt": "2020-12-14T18:33:27Z", "author": {"login": "milleruntime"}, "path": "server/base/src/test/java/org/apache/accumulo/server/security/SystemCredentialsTest.java", "diffHunk": "@@ -67,6 +68,27 @@ public static void setUp() throws IOException {\n     }\n   }\n \n+  @Test\n+  public void testWireVersion() {\n+    // sanity check to make sure it's a positive number\n+    assertTrue(SystemToken.INTERNAL_WIRE_VERSION > 0);\n+    // this is a sanity check that our wire version isn't crazy long, because\n+    // it must be less than or equal to 16 chars to be used as the SALT for SHA-512\n+    // when using Crypt.crypt()\n+    assertTrue(Integer.toString(SystemToken.INTERNAL_WIRE_VERSION).length() <= 16);\n+  }\n+\n+  @Test\n+  public void testCryptDefaults() {\n+    // this is a sanity check that the default hash algorithm for commons-codec's\n+    // Crypt.crypt() method is still SHA-512 and the format hasn't changed\n+    // if that changes, we need to consider whether the new default is acceptable, and\n+    // whether or not we want to bump the wire version\n+    String hash = Crypt.crypt(new byte[0]);\n+    assertEquals(3, hash.chars().filter(ch -> ch == '$').count());\n+    assertTrue(hash.startsWith(SystemToken.SALT_PREFIX));\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "babb1d9e559a78577fbe763181043715e572bfa5"}, "originalPosition": 31}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1678, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}