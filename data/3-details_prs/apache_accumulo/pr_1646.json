{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyMjIyNDU4", "number": 1646, "title": "fixes #1644: minor compaction retry", "bodyText": "Updated the minor compaction to gracefully handle temporary VFS class loader issues while minor compacting", "createdAt": "2020-06-30T18:35:24Z", "url": "https://github.com/apache/accumulo/pull/1646", "merged": true, "mergeCommit": {"oid": "6b5b9058898a1cff7ea2a64c899ce5578b22c5fc"}, "closed": true, "closedAt": "2020-07-07T12:22:59Z", "author": {"login": "ivakegg"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcwafWIgFqTQ0MDMwNjY5OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcw__M9AFqTQ0MTc1MTE1Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwMzA2Njk4", "url": "https://github.com/apache/accumulo/pull/1646#pullrequestreview-440306698", "createdAt": "2020-06-30T19:06:12Z", "commit": {"oid": "2770957370cf4276e2e2930fb1921a5cd14d6e3d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxOTowNjoxMlrOGrKoyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxOTowNjoxMlrOGrKoyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzkxNjIzNQ==", "bodyText": "We typically try to either log an error or throw, not both.  Instead of halting in MinorCompactor, we may want halt here in Tablet where we catch Exception or Error.  That code currently does not catch Throwable.", "url": "https://github.com/apache/accumulo/pull/1646#discussion_r447916235", "createdAt": "2020-06-30T19:06:12Z", "author": {"login": "milleruntime"}, "path": "server/tserver/src/main/java/org/apache/accumulo/tserver/tablet/MinorCompactor.java", "diffHunk": "@@ -148,6 +149,13 @@ public CompactionStats call() {\n           reportedProblem = true;\n         } catch (CompactionCanceledException e) {\n           throw new IllegalStateException(e);\n+        } catch (Throwable t) {\n+          // This is an unexpected situation which is critical. If we cannot minor compact\n+          // then this tablet will eventually become unusable if we are still ingesting data.\n+          log.error(\"MinC failed ({}).  Aborting.\", t.getMessage(), t);\n+          // TODO: Should we simply unload this tablet instead?\n+          Halt.halt(\"Unexpected MinC failure: \" + t.getMessage(), 2);\n+          throw t;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2770957370cf4276e2e2930fb1921a5cd14d6e3d"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwMzkxMTk2", "url": "https://github.com/apache/accumulo/pull/1646#pullrequestreview-440391196", "createdAt": "2020-06-30T21:15:04Z", "commit": {"oid": "2770957370cf4276e2e2930fb1921a5cd14d6e3d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQyMToxNTowNFrOGrOvIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQyMToxNTowNFrOGrOvIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk4MzM5Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    } catch (Throwable t) {\n          \n          \n            \n                    } catch (Error t) {\n          \n      \n    \n    \n  \n\nCatching throwable will mask checked exceptions in future code changes.  For example if the checked exceptions on a method called here are changed, and those checked exceptions should be handled.. then catching Throwable would hide the need to handle those.", "url": "https://github.com/apache/accumulo/pull/1646#discussion_r447983392", "createdAt": "2020-06-30T21:15:04Z", "author": {"login": "keith-turner"}, "path": "server/tserver/src/main/java/org/apache/accumulo/tserver/tablet/MinorCompactor.java", "diffHunk": "@@ -148,6 +149,13 @@ public CompactionStats call() {\n           reportedProblem = true;\n         } catch (CompactionCanceledException e) {\n           throw new IllegalStateException(e);\n+        } catch (Throwable t) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2770957370cf4276e2e2930fb1921a5cd14d6e3d"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f32d087e1bc6ace1baf36766d42b37338cde916", "author": {"user": {"login": "ivakegg", "name": "Ivan Bella"}}, "url": "https://github.com/apache/accumulo/commit/9f32d087e1bc6ace1baf36766d42b37338cde916", "committedDate": "2020-07-01T19:51:17Z", "message": "fixes #1644: minor compaction retry\n* Updated the minor compaction to gracefully handle temporary VFS class loader issues while minor compacting"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "16a20add3da5ee25e52cb0c5770a14a5770694be", "author": {"user": {"login": "ivakegg", "name": "Ivan Bella"}}, "url": "https://github.com/apache/accumulo/commit/16a20add3da5ee25e52cb0c5770a14a5770694be", "committedDate": "2020-07-01T16:06:56Z", "message": "re #1644: Updated to retry failed minor compactions"}, "afterCommit": {"oid": "9f32d087e1bc6ace1baf36766d42b37338cde916", "author": {"user": {"login": "ivakegg", "name": "Ivan Bella"}}, "url": "https://github.com/apache/accumulo/commit/9f32d087e1bc6ace1baf36766d42b37338cde916", "committedDate": "2020-07-01T19:51:17Z", "message": "fixes #1644: minor compaction retry\n* Updated the minor compaction to gracefully handle temporary VFS class loader issues while minor compacting"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMjE4OTU4", "url": "https://github.com/apache/accumulo/pull/1646#pullrequestreview-441218958", "createdAt": "2020-07-01T21:49:51Z", "commit": {"oid": "9f32d087e1bc6ace1baf36766d42b37338cde916"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMTo0OTo1MVrOGr2elA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMTo0OTo1MVrOGr2elA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYzNDUxNg==", "bodyText": "This has nothing to do with your change.  I was puzzled what the diff between this catch block and the prev one was looking at the code.  AFAICT the only diff is that one passes the exception to the log.warn and the other does not.", "url": "https://github.com/apache/accumulo/pull/1646#discussion_r448634516", "createdAt": "2020-07-01T21:49:51Z", "author": {"login": "keith-turner"}, "path": "server/tserver/src/main/java/org/apache/accumulo/tserver/tablet/MinorCompactor.java", "diffHunk": "@@ -138,7 +138,7 @@ public CompactionStats call() {\n           ProblemReports.getInstance(tabletServer).report(new ProblemReport(\n               getExtent().getTableId(), ProblemType.FILE_WRITE, outputFileName, e));\n           reportedProblem = true;\n-        } catch (RuntimeException e) {\n+        } catch (RuntimeException | NoClassDefFoundError e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f32d087e1bc6ace1baf36766d42b37338cde916"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxNzUxMTU3", "url": "https://github.com/apache/accumulo/pull/1646#pullrequestreview-441751157", "createdAt": "2020-07-02T14:47:30Z", "commit": {"oid": "9f32d087e1bc6ace1baf36766d42b37338cde916"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1979, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}