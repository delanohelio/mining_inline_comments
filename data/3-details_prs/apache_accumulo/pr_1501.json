{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcxOTc3ODA2", "number": 1501, "title": "Use TabletFile for Tablet, Scans and compaction", "bodyText": "Made use of TabletFile from Ample through Tablet code, compactions\nand scans where object represents a file in a Tablet\nMoved TabletFile to metadata package\nAdded TabletFile constructor for the cases when switching volumes and\nbulk import where we aren't reading a string from the metadata but have\nto create a Path object to resolve the absolute path. That Path object\ngets passed to TabletFile so multiple Paths don't need to be created\nGarbage collector will still use strings for delete candidates since\nthey can be a tablet directory", "createdAt": "2020-02-06T15:59:06Z", "url": "https://github.com/apache/accumulo/pull/1501", "merged": true, "mergeCommit": {"oid": "7a2ab3bccb32e57cb6f82bdbf6c7d06ea887f876"}, "closed": true, "closedAt": "2020-02-11T14:37:39Z", "author": {"login": "milleruntime"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBuJNfAFqTM1NDYyMTM4OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcC_iHmgBqjMwMjMzNzYyMDc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0NjIxMzg5", "url": "https://github.com/apache/accumulo/pull/1501#pullrequestreview-354621389", "createdAt": "2020-02-06T17:07:03Z", "commit": {"oid": "8ea08f8ef59cd199ec23d414d8dbc89be7eb1667"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxNzowNzowNFrOFmjE_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxNzoyMzo1NVrOFmjoow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk2NDkyNA==", "bodyText": "When I looked at this code I found myself wondering if any follow on code relies on the metadata entry for the TabletFile created here.  If so that could result in a silent bug (where we try to delete something in the metadata table that does not exists).  This makes me think it would be nice to be able to construct a TabletFile w/o a metadata entry and anything trying to get the metadata path would get an exception.  This would cause things to fail fast.\nCould possibly have a TabletFile constructor that only takes a path and when this constructor is used to create a the object, attempts to get the metadata entry result in an exception.", "url": "https://github.com/apache/accumulo/pull/1501#discussion_r375964924", "createdAt": "2020-02-06T17:07:04Z", "author": {"login": "keith-turner"}, "path": "server/base/src/main/java/org/apache/accumulo/server/fs/VolumeUtil.java", "diffHunk": "@@ -159,14 +160,14 @@ public static TabletFiles updateTabletVolumes(ServerContext context, ZooLock zoo\n       }\n     }\n \n-    for (Entry<FileRef,DataFileValue> entry : tabletFiles.datafiles.entrySet()) {\n-      String metaPath = entry.getKey().meta().toString();\n+    for (Entry<TabletFile,DataFileValue> entry : tabletFiles.datafiles.entrySet()) {\n+      String metaPath = entry.getKey().getNormalizedPath();\n       Path switchedPath = switchVolume(metaPath, FileType.TABLE, replacements);\n       if (switchedPath != null) {\n         filesToRemove.add(entry.getKey());\n-        FileRef switchedRef = new FileRef(switchedPath.toString(), switchedPath);\n-        filesToAdd.put(switchedRef, entry.getValue());\n-        ret.datafiles.put(switchedRef, entry.getValue());\n+        TabletFile switchedFile = new TabletFile(switchedPath, switchedPath.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ea08f8ef59cd199ec23d414d8dbc89be7eb1667"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk2OTc3Mw==", "bodyText": "Why did this end up Set<String>?", "url": "https://github.com/apache/accumulo/pull/1501#discussion_r375969773", "createdAt": "2020-02-06T17:15:53Z", "author": {"login": "keith-turner"}, "path": "server/base/src/main/java/org/apache/accumulo/server/util/MetadataTableUtil.java", "diffHunk": "@@ -247,44 +247,48 @@ public static void splitTablet(KeyExtent extent, Text oldPrevEndRow, double spli\n     update(context, zooLock, m, extent);\n   }\n \n-  public static void finishSplit(Text metadataEntry, Map<FileRef,DataFileValue> datafileSizes,\n-      List<FileRef> highDatafilesToRemove, final ServerContext context, ZooLock zooLock) {\n+  public static void finishSplit(Text metadataEntry, Map<TabletFile,DataFileValue> datafileSizes,\n+      List<TabletFile> highDatafilesToRemove, final ServerContext context, ZooLock zooLock) {\n     Mutation m = new Mutation(metadataEntry);\n     TabletsSection.TabletColumnFamily.SPLIT_RATIO_COLUMN.putDelete(m);\n     TabletsSection.TabletColumnFamily.OLD_PREV_ROW_COLUMN.putDelete(m);\n     ChoppedColumnFamily.CHOPPED_COLUMN.putDelete(m);\n \n-    for (Entry<FileRef,DataFileValue> entry : datafileSizes.entrySet()) {\n-      m.put(DataFileColumnFamily.NAME, entry.getKey().meta(), new Value(entry.getValue().encode()));\n+    for (Entry<TabletFile,DataFileValue> entry : datafileSizes.entrySet()) {\n+      m.put(DataFileColumnFamily.NAME, entry.getKey().getMetadataText(),\n+          new Value(entry.getValue().encode()));\n     }\n \n-    for (FileRef pathToRemove : highDatafilesToRemove) {\n-      m.putDelete(DataFileColumnFamily.NAME, pathToRemove.meta());\n+    for (TabletFile pathToRemove : highDatafilesToRemove) {\n+      m.putDelete(DataFileColumnFamily.NAME, pathToRemove.getMetadataText());\n     }\n \n     update(context, zooLock, m, new KeyExtent(metadataEntry, (Text) null));\n   }\n \n-  public static void finishSplit(KeyExtent extent, Map<FileRef,DataFileValue> datafileSizes,\n-      List<FileRef> highDatafilesToRemove, ServerContext context, ZooLock zooLock) {\n+  public static void finishSplit(KeyExtent extent, Map<TabletFile,DataFileValue> datafileSizes,\n+      List<TabletFile> highDatafilesToRemove, ServerContext context, ZooLock zooLock) {\n     finishSplit(extent.getMetadataEntry(), datafileSizes, highDatafilesToRemove, context, zooLock);\n   }\n \n-  public static void addDeleteEntries(KeyExtent extent, Set<FileRef> datafilesToDelete,\n+  /**\n+   * datafilesToDelete are strings because they can be a TabletFile or directory\n+   */\n+  public static void addDeleteEntries(KeyExtent extent, Set<String> datafilesToDelete,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ea08f8ef59cd199ec23d414d8dbc89be7eb1667"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk3MDM5NA==", "bodyText": "That is kinda of a neat that sizes::put can be done now.", "url": "https://github.com/apache/accumulo/pull/1501#discussion_r375970394", "createdAt": "2020-02-06T17:17:05Z", "author": {"login": "keith-turner"}, "path": "server/base/src/main/java/org/apache/accumulo/server/util/MetadataTableUtil.java", "diffHunk": "@@ -414,7 +420,7 @@ public static void deleteTable(TableId tableId, boolean insertDeletes, ServerCon\n \n     result.addAll(tablet.getLogs());\n \n-    tablet.getFilesMap().forEach((tf, v) -> sizes.put(new FileRef(tf.getMetadataEntry()), v));\n+    tablet.getFilesMap().forEach(sizes::put);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ea08f8ef59cd199ec23d414d8dbc89be7eb1667"}, "originalPosition": 140}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk3Mjk0MA==", "bodyText": "This test seems suspicious.  I am wondering if this test is still needed.  I will look into this later.", "url": "https://github.com/apache/accumulo/pull/1501#discussion_r375972940", "createdAt": "2020-02-06T17:21:52Z", "author": {"login": "keith-turner"}, "path": "server/base/src/test/java/org/apache/accumulo/server/util/FileUtilTest.java", "diffHunk": "@@ -66,13 +66,13 @@ public void createTmpDir() throws IOException {\n \n   @Test\n   public void testToPathStrings() {\n-    Collection<FileRef> c = new java.util.ArrayList<>();\n-    FileRef r1 = createMock(FileRef.class);\n-    expect(r1.path()).andReturn(new Path(\"/foo\"));\n+    Collection<TabletFile> c = new java.util.ArrayList<>();\n+    TabletFile r1 = createMock(TabletFile.class);\n+    expect(r1.getNormalizedPath()).andReturn(\"/foo\");\n     replay(r1);\n     c.add(r1);\n-    FileRef r2 = createMock(FileRef.class);\n-    expect(r2.path()).andReturn(new Path(\"/bar\"));\n+    TabletFile r2 = createMock(TabletFile.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ea08f8ef59cd199ec23d414d8dbc89be7eb1667"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk3NDA1MQ==", "bodyText": "Why drop validation here?", "url": "https://github.com/apache/accumulo/pull/1501#discussion_r375974051", "createdAt": "2020-02-06T17:23:55Z", "author": {"login": "keith-turner"}, "path": "server/master/src/main/java/org/apache/accumulo/master/TabletGroupWatcher.java", "diffHunk": "@@ -611,12 +609,11 @@ private void deleteTablets(MergeInfo info) throws AccumuloException {\n       TabletsSection.ServerColumnFamily.TIME_COLUMN.fetch(scanner);\n       scanner.fetchColumnFamily(DataFileColumnFamily.NAME);\n       scanner.fetchColumnFamily(TabletsSection.CurrentLocationColumnFamily.NAME);\n-      Set<FileRef> datafiles = new TreeSet<>();\n+      Set<String> datafiles = new TreeSet<>();\n       for (Entry<Key,Value> entry : scanner) {\n         Key key = entry.getKey();\n         if (key.compareColumnFamily(DataFileColumnFamily.NAME) == 0) {\n-          datafiles\n-              .add(new FileRef(TabletFileUtil.validate(key.getColumnQualifierData().toString())));\n+          datafiles.add(key.getColumnQualifierData().toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ea08f8ef59cd199ec23d414d8dbc89be7eb1667"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0NjQ2MDU5", "url": "https://github.com/apache/accumulo/pull/1501#pullrequestreview-354646059", "createdAt": "2020-02-06T17:43:43Z", "commit": {"oid": "8ea08f8ef59cd199ec23d414d8dbc89be7eb1667"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0NzEzODAy", "url": "https://github.com/apache/accumulo/pull/1501#pullrequestreview-354713802", "createdAt": "2020-02-06T19:30:24Z", "commit": {"oid": "8ea08f8ef59cd199ec23d414d8dbc89be7eb1667"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxOTozMDoyNFrOFmne-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxOTozMDoyNFrOFmne-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjAzNzExMw==", "bodyText": "This class is used by CompactionStrategy which is a pluggable component.  So this changes could break existing compaction strategy plugins.\nI think this change is ok because with these types being outside of SPI, its hard to analyze in a rigorous way.   It would not surprise me if there were already other breaking changes.", "url": "https://github.com/apache/accumulo/pull/1501#discussion_r376037113", "createdAt": "2020-02-06T19:30:24Z", "author": {"login": "keith-turner"}, "path": "server/tserver/src/main/java/org/apache/accumulo/tserver/compaction/MajorCompactionRequest.java", "diffHunk": "@@ -105,7 +105,7 @@ public MajorCompactionReason getReason() {\n     return reason;\n   }\n \n-  public Map<FileRef,DataFileValue> getFiles() {\n+  public Map<TabletFile,DataFileValue> getFiles() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ea08f8ef59cd199ec23d414d8dbc89be7eb1667"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59cb6dd103d7f3c83f38970af7d03932ed820e78", "author": {"user": {"login": "milleruntime", "name": "Mike Miller"}}, "url": "https://github.com/apache/accumulo/commit/59cb6dd103d7f3c83f38970af7d03932ed820e78", "committedDate": "2020-02-10T15:57:25Z", "message": "Use TabletFile for Tablet, Scans and compaction\n\n* Made use of TabletFile from Ample through Tablet code, compactions\nand scans where object represents a file in a Tablet\n* Moved TabletFile to metadata package\n* Added TabletFile constructor for the cases when switching volumes and\nbulk import where we aren't reading a string from the metadata but have\nto create a Path object to resolve the absolute path. That Path object\ngets passed to TabletFile so multiple Paths don't need to be created\n* Garbage collector will still use strings for delete candidates since\nthey can be a tablet directory"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c8607a52ab772cda9867cfbcaede7fb431f13a8", "author": {"user": {"login": "milleruntime", "name": "Mike Miller"}}, "url": "https://github.com/apache/accumulo/commit/7c8607a52ab772cda9867cfbcaede7fb431f13a8", "committedDate": "2020-02-10T15:57:25Z", "message": "Fix from CR"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05be3b91c1bb5e626906b67b05c33613fda5576b", "author": {"user": {"login": "milleruntime", "name": "Mike Miller"}}, "url": "https://github.com/apache/accumulo/commit/05be3b91c1bb5e626906b67b05c33613fda5576b", "committedDate": "2020-02-10T16:07:46Z", "message": "Resolve merge conflicts"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3aacfe603ad9c5d432df1da6411297783adba004", "author": {"user": {"login": "milleruntime", "name": "Mike Miller"}}, "url": "https://github.com/apache/accumulo/commit/3aacfe603ad9c5d432df1da6411297783adba004", "committedDate": "2020-02-06T20:38:04Z", "message": "Fix from CR"}, "afterCommit": {"oid": "05be3b91c1bb5e626906b67b05c33613fda5576b", "author": {"user": {"login": "milleruntime", "name": "Mike Miller"}}, "url": "https://github.com/apache/accumulo/commit/05be3b91c1bb5e626906b67b05c33613fda5576b", "committedDate": "2020-02-10T16:07:46Z", "message": "Resolve merge conflicts"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1834, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}