{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYyMzM3ODIx", "number": 1670, "title": "#1631 - Tablet in memory compaction ID is updated before metadata write", "bodyText": "@keith-turner  What about something like this? The tablet compaction ID should only be set after a successful Metadata table update.", "createdAt": "2020-08-03T18:44:59Z", "url": "https://github.com/apache/accumulo/pull/1670", "merged": true, "mergeCommit": {"oid": "3dae7d3357248e97193acb3bbac0448183df165e"}, "closed": true, "closedAt": "2020-10-13T16:48:18Z", "author": {"login": "cradal"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcsg75SAH2gAyNDYyMzM3ODIxOmY1YmRlM2JlY2QwYWIzYTY4ZTBmNzQ0OGQxZDY1NTk4YjJlMTU5OWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSIdptAH2gAyNDYyMzM3ODIxOjc5ZTljNTljNDdkNWI1YWFhMzAxYmVlNmFiYjVjMDhhMTJjYTZjZDk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f5bde3becd0ab3a68e0f7448d1d65598b2e1599e", "author": {"user": null}, "url": "https://github.com/apache/accumulo/commit/f5bde3becd0ab3a68e0f7448d1d65598b2e1599e", "committedDate": "2020-06-18T16:21:08Z", "message": "Fixing master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20b5640c072a497fd0dee5f86a536fb8ea31281c", "author": {"user": null}, "url": "https://github.com/apache/accumulo/commit/20b5640c072a497fd0dee5f86a536fb8ea31281c", "committedDate": "2020-06-18T16:22:04Z", "message": "Merge branch 'master' of https://github.com/apache/accumulo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb98a46024716df3fff97d0c65f85e1e5e885f68", "author": {"user": null}, "url": "https://github.com/apache/accumulo/commit/eb98a46024716df3fff97d0c65f85e1e5e885f68", "committedDate": "2020-07-07T12:02:07Z", "message": "WIP Fixes #1473 - Added readTablets() to Ample."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8f527d493b4341327c4307966a843b1d46dbebc", "author": {"user": null}, "url": "https://github.com/apache/accumulo/commit/c8f527d493b4341327c4307966a843b1d46dbebc", "committedDate": "2020-07-07T17:06:39Z", "message": "Switch BulkImport back to original version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "732d1e5abc684e86259b20fbccaf6f2cbd0fb702", "author": {"user": null}, "url": "https://github.com/apache/accumulo/commit/732d1e5abc684e86259b20fbccaf6f2cbd0fb702", "committedDate": "2020-07-10T13:35:12Z", "message": "Fixes #1473 - Added test with mock table in AccumuloClientIT"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44767101ba328751800b96947d332da3584d1a4b", "author": {"user": null}, "url": "https://github.com/apache/accumulo/commit/44767101ba328751800b96947d332da3584d1a4b", "committedDate": "2020-07-20T12:50:38Z", "message": "Fixes #1473 - Added readTablets() function to Ample. Made TabletsMetadata Builder protected class."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7cebe4366ee4f3c0dc2493d192155ae4e90b872", "author": {"user": null}, "url": "https://github.com/apache/accumulo/commit/b7cebe4366ee4f3c0dc2493d192155ae4e90b872", "committedDate": "2020-08-03T18:37:40Z", "message": "Fixes #1631 - Surrounded MetadataTabe update call in try-catch. Sets flag that calls setLastCompactionID if Metadata update successful."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNjQ0Mjc2", "url": "https://github.com/apache/accumulo/pull/1670#pullrequestreview-493644276", "createdAt": "2020-09-22T16:29:19Z", "commit": {"oid": "b7cebe4366ee4f3c0dc2493d192155ae4e90b872"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNjoyOToxOVrOHWCqng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNjozODozM1rOHWDCHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjg3NDM5OA==", "bodyText": "Should use primitive, rather than boxed form.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    Boolean updateMetadataTabletFail = false;\n          \n          \n            \n                    boolean updateMetadataTabletFail = false;", "url": "https://github.com/apache/accumulo/pull/1670#discussion_r492874398", "createdAt": "2020-09-22T16:29:19Z", "author": {"login": "ctubbsii"}, "path": "server/tserver/src/main/java/org/apache/accumulo/tserver/tablet/CompactableUtils.java", "diffHunk": "@@ -441,10 +441,17 @@ private UserCompactionHelper(CompactionConfig compactionConfig, Tablet tablet,\n       }\n \n       if (selectedFiles.isEmpty()) {\n-        tablet.setLastCompactionID(compactionId);\n-\n-        MetadataTableUtil.updateTabletCompactID(tablet.getExtent(), compactionId,\n-            tablet.getTabletServer().getContext(), tablet.getTabletServer().getLock());\n+        Boolean updateMetadataTabletFail = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7cebe4366ee4f3c0dc2493d192155ae4e90b872"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjg4MDQxMw==", "bodyText": "This catches exceptions that were previously thrown. Is this a valid change in behavior? Why wouldn't it be sufficient to simply reorder these lines, and let the exception be thrown?", "url": "https://github.com/apache/accumulo/pull/1670#discussion_r492880413", "createdAt": "2020-09-22T16:38:33Z", "author": {"login": "ctubbsii"}, "path": "server/tserver/src/main/java/org/apache/accumulo/tserver/tablet/CompactableUtils.java", "diffHunk": "@@ -441,10 +441,17 @@ private UserCompactionHelper(CompactionConfig compactionConfig, Tablet tablet,\n       }\n \n       if (selectedFiles.isEmpty()) {\n-        tablet.setLastCompactionID(compactionId);\n-\n-        MetadataTableUtil.updateTabletCompactID(tablet.getExtent(), compactionId,\n-            tablet.getTabletServer().getContext(), tablet.getTabletServer().getLock());\n+        Boolean updateMetadataTabletFail = false;\n+        try {\n+          MetadataTableUtil.updateTabletCompactID(tablet.getExtent(), compactionId,\n+              tablet.getTabletServer().getContext(), tablet.getTabletServer().getLock());\n+        } catch (Exception exc) {\n+          updateMetadataTabletFail = true;\n+          log.error(exc.getMessage());\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7cebe4366ee4f3c0dc2493d192155ae4e90b872"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d2eed962d3ba2e461ac1058246a93dbcc37e70b", "author": {"user": null}, "url": "https://github.com/apache/accumulo/commit/0d2eed962d3ba2e461ac1058246a93dbcc37e70b", "committedDate": "2020-09-23T13:13:30Z", "message": "Merge branch 'main' of https://github.com/apache/accumulo into accumulo-#1473"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2537fdaabac678a63c0bdd9edcd0cee1d2d72f1", "author": {"user": {"login": "cradal", "name": null}}, "url": "https://github.com/apache/accumulo/commit/a2537fdaabac678a63c0bdd9edcd0cee1d2d72f1", "committedDate": "2020-09-23T13:29:44Z", "message": "Update server/tserver/src/main/java/org/apache/accumulo/tserver/tablet/CompactableUtils.java\n\nCo-authored-by: Christopher Tubbs <ctubbsii@apache.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c83cb90a072a4d1a02ca3dc971e9e6c62305f853", "author": {"user": null}, "url": "https://github.com/apache/accumulo/commit/c83cb90a072a4d1a02ca3dc971e9e6c62305f853", "committedDate": "2020-09-23T17:28:55Z", "message": "Merge branch 'main' into accumulo-#1631"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ec1c7a28c6d93176743806a8fbcc8287a6ad5a4", "author": {"user": null}, "url": "https://github.com/apache/accumulo/commit/9ec1c7a28c6d93176743806a8fbcc8287a6ad5a4", "committedDate": "2020-09-24T18:04:10Z", "message": "Merge branch 'main' into accumulo-#1631"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a6a63251a2f55b3f3cbb31ecb75b0a27a3381ac", "author": {"user": null}, "url": "https://github.com/apache/accumulo/commit/7a6a63251a2f55b3f3cbb31ecb75b0a27a3381ac", "committedDate": "2020-09-24T20:21:05Z", "message": "Fixes #1631 - Removed try-catch from compaction IDcode. Removed code intended for another ticket."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk4NjU4NjIx", "url": "https://github.com/apache/accumulo/pull/1670#pullrequestreview-498658621", "createdAt": "2020-09-29T16:13:23Z", "commit": {"oid": "7a6a63251a2f55b3f3cbb31ecb75b0a27a3381ac"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxNjoxMzoyM1rOHZ2D3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxNjoxMzoyM1rOHZ2D3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg2MjE3Mw==", "bodyText": "Is this needed?", "url": "https://github.com/apache/accumulo/pull/1670#discussion_r496862173", "createdAt": "2020-09-29T16:13:23Z", "author": {"login": "ctubbsii"}, "path": "core/src/main/java/org/apache/accumulo/core/metadata/schema/TabletsMetadata.java", "diffHunk": "@@ -371,6 +371,10 @@ private TabletsMetadata(Scanner scanner, Iterable<TabletMetadata> tmi) {\n     this.tablets = tmi;\n   }\n \n+  public TabletsMetadata() {\n+\n+  }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a6a63251a2f55b3f3cbb31ecb75b0a27a3381ac"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f54d0bd05243c752b62be24f311170d95d218bfd", "author": {"user": null}, "url": "https://github.com/apache/accumulo/commit/f54d0bd05243c752b62be24f311170d95d218bfd", "committedDate": "2020-09-30T13:26:21Z", "message": "Fixes #1631 - Removed unused method stub"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae295483eb1e8272eda77b381d4b169eb05070fd", "author": {"user": null}, "url": "https://github.com/apache/accumulo/commit/ae295483eb1e8272eda77b381d4b169eb05070fd", "committedDate": "2020-10-09T16:56:17Z", "message": "Moved tablet.setLastCompactionID to be called after id is set in metadata table."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1OTE2OTk5", "url": "https://github.com/apache/accumulo/pull/1670#pullrequestreview-505916999", "createdAt": "2020-10-09T18:52:39Z", "commit": {"oid": "ae295483eb1e8272eda77b381d4b169eb05070fd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxODo1Mjo0MFrOHfVOyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxODo1Mjo0MFrOHfVOyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjYxNTc1Mw==", "bodyText": "I believe there is a related comment a few lines above that can probably be removed, about known consistency issue between minor and major compactions", "url": "https://github.com/apache/accumulo/pull/1670#discussion_r502615753", "createdAt": "2020-10-09T18:52:40Z", "author": {"login": "ctubbsii"}, "path": "server/tserver/src/main/java/org/apache/accumulo/tserver/tablet/DatafileManager.java", "diffHunk": "@@ -458,6 +457,7 @@ StoredTabletFile bringMajorCompactionOnline(Set<StoredTabletFile> oldDatafiles,\n         filesInUseByScans, newFile, compactionId, dfv,\n         tablet.getTabletServer().getClientAddressString(), lastLocation,\n         tablet.getTabletServer().getLock());\n+    tablet.setLastCompactionID(compactionId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae295483eb1e8272eda77b381d4b169eb05070fd"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc7ff8dcf33e092f3c21c2a7e114390e312d84cb", "author": {"user": null}, "url": "https://github.com/apache/accumulo/commit/cc7ff8dcf33e092f3c21c2a7e114390e312d84cb", "committedDate": "2020-10-09T19:41:25Z", "message": "Fixes #1631 - Removed unneeded comment from DataFileManager"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2NzEwNzEx", "url": "https://github.com/apache/accumulo/pull/1670#pullrequestreview-506710711", "createdAt": "2020-10-12T15:17:00Z", "commit": {"oid": "cc7ff8dcf33e092f3c21c2a7e114390e312d84cb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79e9c59c47d5b5aaa301bee6abb5c08a12ca6cd9", "author": {"user": null}, "url": "https://github.com/apache/accumulo/commit/79e9c59c47d5b5aaa301bee6abb5c08a12ca6cd9", "committedDate": "2020-10-13T13:19:30Z", "message": "Fixes #1631 - Added comment back into DatafileManager."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1693, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}