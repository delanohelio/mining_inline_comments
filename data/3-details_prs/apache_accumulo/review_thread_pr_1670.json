{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYyMzM3ODIx", "number": 1670, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNjoyOToxOVrOEmKz0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxODo1Mjo0MFrOEsKcZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4NDU4NDUxOnYy", "diffSide": "RIGHT", "path": "server/tserver/src/main/java/org/apache/accumulo/tserver/tablet/CompactableUtils.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNjoyOToxOVrOHWCqng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNjoyOToxOVrOHWCqng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjg3NDM5OA==", "bodyText": "Should use primitive, rather than boxed form.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    Boolean updateMetadataTabletFail = false;\n          \n          \n            \n                    boolean updateMetadataTabletFail = false;", "url": "https://github.com/apache/accumulo/pull/1670#discussion_r492874398", "createdAt": "2020-09-22T16:29:19Z", "author": {"login": "ctubbsii"}, "path": "server/tserver/src/main/java/org/apache/accumulo/tserver/tablet/CompactableUtils.java", "diffHunk": "@@ -441,10 +441,17 @@ private UserCompactionHelper(CompactionConfig compactionConfig, Tablet tablet,\n       }\n \n       if (selectedFiles.isEmpty()) {\n-        tablet.setLastCompactionID(compactionId);\n-\n-        MetadataTableUtil.updateTabletCompactID(tablet.getExtent(), compactionId,\n-            tablet.getTabletServer().getContext(), tablet.getTabletServer().getLock());\n+        Boolean updateMetadataTabletFail = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7cebe4366ee4f3c0dc2493d192155ae4e90b872"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4NDYyMjE1OnYy", "diffSide": "RIGHT", "path": "server/tserver/src/main/java/org/apache/accumulo/tserver/tablet/CompactableUtils.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNjozODozM1rOHWDCHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxMzo1ODo0NFrOHWv5lQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjg4MDQxMw==", "bodyText": "This catches exceptions that were previously thrown. Is this a valid change in behavior? Why wouldn't it be sufficient to simply reorder these lines, and let the exception be thrown?", "url": "https://github.com/apache/accumulo/pull/1670#discussion_r492880413", "createdAt": "2020-09-22T16:38:33Z", "author": {"login": "ctubbsii"}, "path": "server/tserver/src/main/java/org/apache/accumulo/tserver/tablet/CompactableUtils.java", "diffHunk": "@@ -441,10 +441,17 @@ private UserCompactionHelper(CompactionConfig compactionConfig, Tablet tablet,\n       }\n \n       if (selectedFiles.isEmpty()) {\n-        tablet.setLastCompactionID(compactionId);\n-\n-        MetadataTableUtil.updateTabletCompactID(tablet.getExtent(), compactionId,\n-            tablet.getTabletServer().getContext(), tablet.getTabletServer().getLock());\n+        Boolean updateMetadataTabletFail = false;\n+        try {\n+          MetadataTableUtil.updateTabletCompactID(tablet.getExtent(), compactionId,\n+              tablet.getTabletServer().getContext(), tablet.getTabletServer().getLock());\n+        } catch (Exception exc) {\n+          updateMetadataTabletFail = true;\n+          log.error(exc.getMessage());\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7cebe4366ee4f3c0dc2493d192155ae4e90b872"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzYxNTUwOQ==", "bodyText": "I see what you mean. updateTabletCompactID does not throw any exception. I thought that this would guarantee no attempts to set the LastCompactionID if the Metadata table update failed. Thinking it over, simply reordering the method calls should work.", "url": "https://github.com/apache/accumulo/pull/1670#discussion_r493615509", "createdAt": "2020-09-23T13:58:44Z", "author": {"login": "cradal"}, "path": "server/tserver/src/main/java/org/apache/accumulo/tserver/tablet/CompactableUtils.java", "diffHunk": "@@ -441,10 +441,17 @@ private UserCompactionHelper(CompactionConfig compactionConfig, Tablet tablet,\n       }\n \n       if (selectedFiles.isEmpty()) {\n-        tablet.setLastCompactionID(compactionId);\n-\n-        MetadataTableUtil.updateTabletCompactID(tablet.getExtent(), compactionId,\n-            tablet.getTabletServer().getContext(), tablet.getTabletServer().getLock());\n+        Boolean updateMetadataTabletFail = false;\n+        try {\n+          MetadataTableUtil.updateTabletCompactID(tablet.getExtent(), compactionId,\n+              tablet.getTabletServer().getContext(), tablet.getTabletServer().getLock());\n+        } catch (Exception exc) {\n+          updateMetadataTabletFail = true;\n+          log.error(exc.getMessage());\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjg4MDQxMw=="}, "originalCommit": {"oid": "b7cebe4366ee4f3c0dc2493d192155ae4e90b872"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExMDQ3NDc5OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/accumulo/core/metadata/schema/TabletsMetadata.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxNjoxMzoyM1rOHZ2D3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxNjoxMzoyM1rOHZ2D3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg2MjE3Mw==", "bodyText": "Is this needed?", "url": "https://github.com/apache/accumulo/pull/1670#discussion_r496862173", "createdAt": "2020-09-29T16:13:23Z", "author": {"login": "ctubbsii"}, "path": "core/src/main/java/org/apache/accumulo/core/metadata/schema/TabletsMetadata.java", "diffHunk": "@@ -371,6 +371,10 @@ private TabletsMetadata(Scanner scanner, Iterable<TabletMetadata> tmi) {\n     this.tablets = tmi;\n   }\n \n+  public TabletsMetadata() {\n+\n+  }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a6a63251a2f55b3f3cbb31ecb75b0a27a3381ac"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0NzQzOTExOnYy", "diffSide": "RIGHT", "path": "server/tserver/src/main/java/org/apache/accumulo/tserver/tablet/DatafileManager.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxODo1Mjo0MFrOHfVOyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QwMTozMjoyN1rOHgSYhg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjYxNTc1Mw==", "bodyText": "I believe there is a related comment a few lines above that can probably be removed, about known consistency issue between minor and major compactions", "url": "https://github.com/apache/accumulo/pull/1670#discussion_r502615753", "createdAt": "2020-10-09T18:52:40Z", "author": {"login": "ctubbsii"}, "path": "server/tserver/src/main/java/org/apache/accumulo/tserver/tablet/DatafileManager.java", "diffHunk": "@@ -458,6 +457,7 @@ StoredTabletFile bringMajorCompactionOnline(Set<StoredTabletFile> oldDatafiles,\n         filesInUseByScans, newFile, compactionId, dfv,\n         tablet.getTabletServer().getClientAddressString(), lastLocation,\n         tablet.getTabletServer().getLock());\n+    tablet.setLastCompactionID(compactionId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae295483eb1e8272eda77b381d4b169eb05070fd"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzM2MTM1MA==", "bodyText": "Actually that comment is still relevant.  The tablet's list of files are still being updated before the the metadata table update is made.  For minor compactions the tablets list of files is updated after the metadata update. The comment was referring to when the in memory list of files is updated.", "url": "https://github.com/apache/accumulo/pull/1670#discussion_r503361350", "createdAt": "2020-10-12T15:10:02Z", "author": {"login": "keith-turner"}, "path": "server/tserver/src/main/java/org/apache/accumulo/tserver/tablet/DatafileManager.java", "diffHunk": "@@ -458,6 +457,7 @@ StoredTabletFile bringMajorCompactionOnline(Set<StoredTabletFile> oldDatafiles,\n         filesInUseByScans, newFile, compactionId, dfv,\n         tablet.getTabletServer().getClientAddressString(), lastLocation,\n         tablet.getTabletServer().getLock());\n+    tablet.setLastCompactionID(compactionId);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjYxNTc1Mw=="}, "originalCommit": {"oid": "ae295483eb1e8272eda77b381d4b169eb05070fd"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzYxNzY3MA==", "bodyText": "Oh my mistake.", "url": "https://github.com/apache/accumulo/pull/1670#discussion_r503617670", "createdAt": "2020-10-13T01:32:27Z", "author": {"login": "ctubbsii"}, "path": "server/tserver/src/main/java/org/apache/accumulo/tserver/tablet/DatafileManager.java", "diffHunk": "@@ -458,6 +457,7 @@ StoredTabletFile bringMajorCompactionOnline(Set<StoredTabletFile> oldDatafiles,\n         filesInUseByScans, newFile, compactionId, dfv,\n         tablet.getTabletServer().getClientAddressString(), lastLocation,\n         tablet.getTabletServer().getLock());\n+    tablet.setLastCompactionID(compactionId);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjYxNTc1Mw=="}, "originalCommit": {"oid": "ae295483eb1e8272eda77b381d4b169eb05070fd"}, "originalPosition": 12}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4040, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}