{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYxMDg5ODgz", "number": 1471, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQxOToyMjo0OVrODXP6_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxOTo1NTozMFrODX-GRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI1NzA0NzAxOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/accumulo/core/metadata/schema/TabletFile.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQxOToyMjo0OVrOFcdx4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMVQwMDo0NTo1NVrOFcjT7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTM5MjM1Mw==", "bodyText": "Not complete sure, but I think unless a <p> this will not show up as its own paragraph in the rendered javadoc.", "url": "https://github.com/apache/accumulo/pull/1471#discussion_r365392353", "createdAt": "2020-01-10T19:22:49Z", "author": {"login": "keith-turner"}, "path": "core/src/main/java/org/apache/accumulo/core/metadata/schema/TabletFile.java", "diffHunk": "@@ -0,0 +1,128 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.core.metadata.schema;\n+\n+import java.util.Objects;\n+\n+import org.apache.accumulo.core.Constants;\n+import org.apache.accumulo.core.data.TableId;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.io.Text;\n+\n+/**\n+ * Object representing a tablet file entry in the metadata table. Keeps a string of the exact entry\n+ * of what is in the metadata table for the column qualifier of the\n+ * {@link org.apache.accumulo.core.metadata.schema.MetadataSchema.TabletsSection.DataFileColumnFamily}\n+ *\n+ * As of 2.1, Tablet file paths should now be only absolute URIs with the removal of relative paths", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78eebbf6dad187348bfcaf71241daf91e0237cd6"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ4Mjk5MQ==", "bodyText": "True.", "url": "https://github.com/apache/accumulo/pull/1471#discussion_r365482991", "createdAt": "2020-01-11T00:45:55Z", "author": {"login": "ctubbsii"}, "path": "core/src/main/java/org/apache/accumulo/core/metadata/schema/TabletFile.java", "diffHunk": "@@ -0,0 +1,128 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.core.metadata.schema;\n+\n+import java.util.Objects;\n+\n+import org.apache.accumulo.core.Constants;\n+import org.apache.accumulo.core.data.TableId;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.io.Text;\n+\n+/**\n+ * Object representing a tablet file entry in the metadata table. Keeps a string of the exact entry\n+ * of what is in the metadata table for the column qualifier of the\n+ * {@link org.apache.accumulo.core.metadata.schema.MetadataSchema.TabletsSection.DataFileColumnFamily}\n+ *\n+ * As of 2.1, Tablet file paths should now be only absolute URIs with the removal of relative paths", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTM5MjM1Mw=="}, "originalCommit": {"oid": "78eebbf6dad187348bfcaf71241daf91e0237cd6"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI1NzA3MzM0OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/accumulo/core/metadata/schema/TabletFile.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQxOTozMzowOVrOFceCig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxODoyMDo0MlrOFdAFvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTM5NjYxOA==", "bodyText": "Could do the following which avoid calling TabletFileUtil.getVolumeFromFullPath.   This method converts a path to a string internally and then back to a path.  The following code uses the exisitng path object.\n  Path tablePath = Objects.requireNonNull(tableIdPath.getParent(), \"Table\" + errorMsg);\n  Preconditions.checkArgument(tablePath.getName().equals(Constants.HDFS_TABLES_DIR));\n  Path volumePath = Objects.requireNonNull(tablePath.getParent());\nWhen profiling in the past I have seen the Hadoop Path object show up.  So if its easy to avoid creating one, I try to do that.  This code would be used pretty frequently.", "url": "https://github.com/apache/accumulo/pull/1471#discussion_r365396618", "createdAt": "2020-01-10T19:33:09Z", "author": {"login": "keith-turner"}, "path": "core/src/main/java/org/apache/accumulo/core/metadata/schema/TabletFile.java", "diffHunk": "@@ -0,0 +1,128 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.core.metadata.schema;\n+\n+import java.util.Objects;\n+\n+import org.apache.accumulo.core.Constants;\n+import org.apache.accumulo.core.data.TableId;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.io.Text;\n+\n+/**\n+ * Object representing a tablet file entry in the metadata table. Keeps a string of the exact entry\n+ * of what is in the metadata table for the column qualifier of the\n+ * {@link org.apache.accumulo.core.metadata.schema.MetadataSchema.TabletsSection.DataFileColumnFamily}\n+ *\n+ * As of 2.1, Tablet file paths should now be only absolute URIs with the removal of relative paths\n+ * in Upgrader9to10.upgradeRelativePaths()\n+ */\n+public class TabletFile implements Comparable<TabletFile> {\n+  // parts of an absolute URI, like \"hdfs://1.2.3.4/accumulo/tables/2a/t-0003/C0004.rf\"\n+  private final String volume; // hdfs://1.2.3.4/accumulo\n+  private final TableId tableId; // 2a\n+  private final String tabletDir; // t-0003\n+  private final String fileName; // C0004.rf\n+  private final String metadataEntry;\n+  private final String normalizedPath; // 2a/t-0003/C0004.rf\n+\n+  public TabletFile(String metadataEntry) {\n+    this.metadataEntry = Objects.requireNonNull(metadataEntry);\n+    String errorMsg = \" is missing from tablet file metadata entry: \" + metadataEntry;\n+\n+    Path metaPath = new Path(metadataEntry);\n+\n+    // use Path object to step backwards from the filename through all the parts\n+    this.fileName = metaPath.getName();\n+    MetadataSchema.TabletsSection.ServerColumnFamily.validateDirCol(fileName);\n+\n+    Path tabletDirPath = Objects.requireNonNull(metaPath.getParent(), \"Tablet dir\" + errorMsg);\n+    this.tabletDir = tabletDirPath.getName();\n+    MetadataSchema.TabletsSection.ServerColumnFamily.validateDirCol(tabletDir);\n+\n+    Path tableIdPath = Objects.requireNonNull(tabletDirPath.getParent(), \"Table ID\" + errorMsg);\n+    this.tableId = TableId.of(tableIdPath.getName());\n+    MetadataSchema.TabletsSection.ServerColumnFamily.validateDirCol(tableId.canonical());\n+\n+    Path volumePath = Objects.requireNonNull(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78eebbf6dad187348bfcaf71241daf91e0237cd6"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTk1NDQ5NQ==", "bodyText": "I like this a lot better.  I can then drop TabletFileUtil, since this was the last thing it was doing.", "url": "https://github.com/apache/accumulo/pull/1471#discussion_r365954495", "createdAt": "2020-01-13T18:20:42Z", "author": {"login": "milleruntime"}, "path": "core/src/main/java/org/apache/accumulo/core/metadata/schema/TabletFile.java", "diffHunk": "@@ -0,0 +1,128 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.core.metadata.schema;\n+\n+import java.util.Objects;\n+\n+import org.apache.accumulo.core.Constants;\n+import org.apache.accumulo.core.data.TableId;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.io.Text;\n+\n+/**\n+ * Object representing a tablet file entry in the metadata table. Keeps a string of the exact entry\n+ * of what is in the metadata table for the column qualifier of the\n+ * {@link org.apache.accumulo.core.metadata.schema.MetadataSchema.TabletsSection.DataFileColumnFamily}\n+ *\n+ * As of 2.1, Tablet file paths should now be only absolute URIs with the removal of relative paths\n+ * in Upgrader9to10.upgradeRelativePaths()\n+ */\n+public class TabletFile implements Comparable<TabletFile> {\n+  // parts of an absolute URI, like \"hdfs://1.2.3.4/accumulo/tables/2a/t-0003/C0004.rf\"\n+  private final String volume; // hdfs://1.2.3.4/accumulo\n+  private final TableId tableId; // 2a\n+  private final String tabletDir; // t-0003\n+  private final String fileName; // C0004.rf\n+  private final String metadataEntry;\n+  private final String normalizedPath; // 2a/t-0003/C0004.rf\n+\n+  public TabletFile(String metadataEntry) {\n+    this.metadataEntry = Objects.requireNonNull(metadataEntry);\n+    String errorMsg = \" is missing from tablet file metadata entry: \" + metadataEntry;\n+\n+    Path metaPath = new Path(metadataEntry);\n+\n+    // use Path object to step backwards from the filename through all the parts\n+    this.fileName = metaPath.getName();\n+    MetadataSchema.TabletsSection.ServerColumnFamily.validateDirCol(fileName);\n+\n+    Path tabletDirPath = Objects.requireNonNull(metaPath.getParent(), \"Tablet dir\" + errorMsg);\n+    this.tabletDir = tabletDirPath.getName();\n+    MetadataSchema.TabletsSection.ServerColumnFamily.validateDirCol(tabletDir);\n+\n+    Path tableIdPath = Objects.requireNonNull(tabletDirPath.getParent(), \"Table ID\" + errorMsg);\n+    this.tableId = TableId.of(tableIdPath.getName());\n+    MetadataSchema.TabletsSection.ServerColumnFamily.validateDirCol(tableId.canonical());\n+\n+    Path volumePath = Objects.requireNonNull(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTM5NjYxOA=="}, "originalCommit": {"oid": "78eebbf6dad187348bfcaf71241daf91e0237cd6"}, "originalPosition": 63}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI1NzA4Mzk0OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/accumulo/core/metadata/schema/TabletFile.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQxOTozNjozM1rOFceIzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMVQwMDo0Nzo0NVrOFcjU7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTM5ODIyMA==", "bodyText": "Do you know if Hadoop's path object normalizes?", "url": "https://github.com/apache/accumulo/pull/1471#discussion_r365398220", "createdAt": "2020-01-10T19:36:33Z", "author": {"login": "keith-turner"}, "path": "core/src/main/java/org/apache/accumulo/core/metadata/schema/TabletFile.java", "diffHunk": "@@ -0,0 +1,128 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.core.metadata.schema;\n+\n+import java.util.Objects;\n+\n+import org.apache.accumulo.core.Constants;\n+import org.apache.accumulo.core.data.TableId;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.io.Text;\n+\n+/**\n+ * Object representing a tablet file entry in the metadata table. Keeps a string of the exact entry\n+ * of what is in the metadata table for the column qualifier of the\n+ * {@link org.apache.accumulo.core.metadata.schema.MetadataSchema.TabletsSection.DataFileColumnFamily}\n+ *\n+ * As of 2.1, Tablet file paths should now be only absolute URIs with the removal of relative paths\n+ * in Upgrader9to10.upgradeRelativePaths()\n+ */\n+public class TabletFile implements Comparable<TabletFile> {\n+  // parts of an absolute URI, like \"hdfs://1.2.3.4/accumulo/tables/2a/t-0003/C0004.rf\"\n+  private final String volume; // hdfs://1.2.3.4/accumulo\n+  private final TableId tableId; // 2a\n+  private final String tabletDir; // t-0003\n+  private final String fileName; // C0004.rf\n+  private final String metadataEntry;\n+  private final String normalizedPath; // 2a/t-0003/C0004.rf\n+\n+  public TabletFile(String metadataEntry) {\n+    this.metadataEntry = Objects.requireNonNull(metadataEntry);\n+    String errorMsg = \" is missing from tablet file metadata entry: \" + metadataEntry;\n+\n+    Path metaPath = new Path(metadataEntry);\n+\n+    // use Path object to step backwards from the filename through all the parts\n+    this.fileName = metaPath.getName();\n+    MetadataSchema.TabletsSection.ServerColumnFamily.validateDirCol(fileName);\n+\n+    Path tabletDirPath = Objects.requireNonNull(metaPath.getParent(), \"Tablet dir\" + errorMsg);\n+    this.tabletDir = tabletDirPath.getName();\n+    MetadataSchema.TabletsSection.ServerColumnFamily.validateDirCol(tabletDir);\n+\n+    Path tableIdPath = Objects.requireNonNull(tabletDirPath.getParent(), \"Table ID\" + errorMsg);\n+    this.tableId = TableId.of(tableIdPath.getName());\n+    MetadataSchema.TabletsSection.ServerColumnFamily.validateDirCol(tableId.canonical());\n+\n+    Path volumePath = Objects.requireNonNull(\n+        TabletFileUtil.getVolumeFromFullPath(metaPath, \"tables\"), \"Volume\" + errorMsg);\n+    this.volume = volumePath.toString();\n+\n+    this.normalizedPath = volume + Constants.HDFS_TABLES_DIR + \"/\" + tableId.canonical() + \"/\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78eebbf6dad187348bfcaf71241daf91e0237cd6"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQxMzg3Ng==", "bodyText": "It does, which I tested with my previous recent change to Upgrader9to10Test.", "url": "https://github.com/apache/accumulo/pull/1471#discussion_r365413876", "createdAt": "2020-01-10T20:18:20Z", "author": {"login": "milleruntime"}, "path": "core/src/main/java/org/apache/accumulo/core/metadata/schema/TabletFile.java", "diffHunk": "@@ -0,0 +1,128 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.core.metadata.schema;\n+\n+import java.util.Objects;\n+\n+import org.apache.accumulo.core.Constants;\n+import org.apache.accumulo.core.data.TableId;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.io.Text;\n+\n+/**\n+ * Object representing a tablet file entry in the metadata table. Keeps a string of the exact entry\n+ * of what is in the metadata table for the column qualifier of the\n+ * {@link org.apache.accumulo.core.metadata.schema.MetadataSchema.TabletsSection.DataFileColumnFamily}\n+ *\n+ * As of 2.1, Tablet file paths should now be only absolute URIs with the removal of relative paths\n+ * in Upgrader9to10.upgradeRelativePaths()\n+ */\n+public class TabletFile implements Comparable<TabletFile> {\n+  // parts of an absolute URI, like \"hdfs://1.2.3.4/accumulo/tables/2a/t-0003/C0004.rf\"\n+  private final String volume; // hdfs://1.2.3.4/accumulo\n+  private final TableId tableId; // 2a\n+  private final String tabletDir; // t-0003\n+  private final String fileName; // C0004.rf\n+  private final String metadataEntry;\n+  private final String normalizedPath; // 2a/t-0003/C0004.rf\n+\n+  public TabletFile(String metadataEntry) {\n+    this.metadataEntry = Objects.requireNonNull(metadataEntry);\n+    String errorMsg = \" is missing from tablet file metadata entry: \" + metadataEntry;\n+\n+    Path metaPath = new Path(metadataEntry);\n+\n+    // use Path object to step backwards from the filename through all the parts\n+    this.fileName = metaPath.getName();\n+    MetadataSchema.TabletsSection.ServerColumnFamily.validateDirCol(fileName);\n+\n+    Path tabletDirPath = Objects.requireNonNull(metaPath.getParent(), \"Tablet dir\" + errorMsg);\n+    this.tabletDir = tabletDirPath.getName();\n+    MetadataSchema.TabletsSection.ServerColumnFamily.validateDirCol(tabletDir);\n+\n+    Path tableIdPath = Objects.requireNonNull(tabletDirPath.getParent(), \"Table ID\" + errorMsg);\n+    this.tableId = TableId.of(tableIdPath.getName());\n+    MetadataSchema.TabletsSection.ServerColumnFamily.validateDirCol(tableId.canonical());\n+\n+    Path volumePath = Objects.requireNonNull(\n+        TabletFileUtil.getVolumeFromFullPath(metaPath, \"tables\"), \"Volume\" + errorMsg);\n+    this.volume = volumePath.toString();\n+\n+    this.normalizedPath = volume + Constants.HDFS_TABLES_DIR + \"/\" + tableId.canonical() + \"/\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTM5ODIyMA=="}, "originalCommit": {"oid": "78eebbf6dad187348bfcaf71241daf91e0237cd6"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ4MzI0NQ==", "bodyText": "I can attest to that. I had the same question on an earlier PR, and Mike and I tested all sorts of combinations together as a sanity check to be sure that it does... at least with the minimum Hadoop version we're specifying in our pom.xml.", "url": "https://github.com/apache/accumulo/pull/1471#discussion_r365483245", "createdAt": "2020-01-11T00:47:45Z", "author": {"login": "ctubbsii"}, "path": "core/src/main/java/org/apache/accumulo/core/metadata/schema/TabletFile.java", "diffHunk": "@@ -0,0 +1,128 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.core.metadata.schema;\n+\n+import java.util.Objects;\n+\n+import org.apache.accumulo.core.Constants;\n+import org.apache.accumulo.core.data.TableId;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.io.Text;\n+\n+/**\n+ * Object representing a tablet file entry in the metadata table. Keeps a string of the exact entry\n+ * of what is in the metadata table for the column qualifier of the\n+ * {@link org.apache.accumulo.core.metadata.schema.MetadataSchema.TabletsSection.DataFileColumnFamily}\n+ *\n+ * As of 2.1, Tablet file paths should now be only absolute URIs with the removal of relative paths\n+ * in Upgrader9to10.upgradeRelativePaths()\n+ */\n+public class TabletFile implements Comparable<TabletFile> {\n+  // parts of an absolute URI, like \"hdfs://1.2.3.4/accumulo/tables/2a/t-0003/C0004.rf\"\n+  private final String volume; // hdfs://1.2.3.4/accumulo\n+  private final TableId tableId; // 2a\n+  private final String tabletDir; // t-0003\n+  private final String fileName; // C0004.rf\n+  private final String metadataEntry;\n+  private final String normalizedPath; // 2a/t-0003/C0004.rf\n+\n+  public TabletFile(String metadataEntry) {\n+    this.metadataEntry = Objects.requireNonNull(metadataEntry);\n+    String errorMsg = \" is missing from tablet file metadata entry: \" + metadataEntry;\n+\n+    Path metaPath = new Path(metadataEntry);\n+\n+    // use Path object to step backwards from the filename through all the parts\n+    this.fileName = metaPath.getName();\n+    MetadataSchema.TabletsSection.ServerColumnFamily.validateDirCol(fileName);\n+\n+    Path tabletDirPath = Objects.requireNonNull(metaPath.getParent(), \"Tablet dir\" + errorMsg);\n+    this.tabletDir = tabletDirPath.getName();\n+    MetadataSchema.TabletsSection.ServerColumnFamily.validateDirCol(tabletDir);\n+\n+    Path tableIdPath = Objects.requireNonNull(tabletDirPath.getParent(), \"Table ID\" + errorMsg);\n+    this.tableId = TableId.of(tableIdPath.getName());\n+    MetadataSchema.TabletsSection.ServerColumnFamily.validateDirCol(tableId.canonical());\n+\n+    Path volumePath = Objects.requireNonNull(\n+        TabletFileUtil.getVolumeFromFullPath(metaPath, \"tables\"), \"Volume\" + errorMsg);\n+    this.volume = volumePath.toString();\n+\n+    this.normalizedPath = volume + Constants.HDFS_TABLES_DIR + \"/\" + tableId.canonical() + \"/\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTM5ODIyMA=="}, "originalCommit": {"oid": "78eebbf6dad187348bfcaf71241daf91e0237cd6"}, "originalPosition": 67}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI1NzA5MDY5OnYy", "diffSide": "RIGHT", "path": "core/src/test/java/org/apache/accumulo/core/metadata/schema/TabletFileTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQxOTozOToxNVrOFceM9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQyMDoxOToyMFrOFcfHdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTM5OTI4NA==", "bodyText": "Would be nice to also verify normalization.", "url": "https://github.com/apache/accumulo/pull/1471#discussion_r365399284", "createdAt": "2020-01-10T19:39:15Z", "author": {"login": "keith-turner"}, "path": "core/src/test/java/org/apache/accumulo/core/metadata/schema/TabletFileTest.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.core.metadata.schema;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.fail;\n+\n+import org.apache.accumulo.core.data.TableId;\n+import org.junit.Test;\n+\n+public class TabletFileTest {\n+\n+  private void test(String metadataEntry, TableId tableId, String tabletDir, String fileName) {\n+    TabletFile tabletFile = new TabletFile(metadataEntry);\n+\n+    assertEquals(metadataEntry, tabletFile.getMetadataEntry());\n+    assertEquals(tableId, tabletFile.getTableId());\n+    assertEquals(tabletDir, tabletFile.getTabletDir());\n+    assertEquals(fileName, tabletFile.getFileName());\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78eebbf6dad187348bfcaf71241daf91e0237cd6"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQxNDI2Mg==", "bodyText": "I will add more tests with your ideas.  I thought I had a normalize test but I was thinking of the recent one I added for the upgrade code here.", "url": "https://github.com/apache/accumulo/pull/1471#discussion_r365414262", "createdAt": "2020-01-10T20:19:20Z", "author": {"login": "milleruntime"}, "path": "core/src/test/java/org/apache/accumulo/core/metadata/schema/TabletFileTest.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.core.metadata.schema;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.fail;\n+\n+import org.apache.accumulo.core.data.TableId;\n+import org.junit.Test;\n+\n+public class TabletFileTest {\n+\n+  private void test(String metadataEntry, TableId tableId, String tabletDir, String fileName) {\n+    TabletFile tabletFile = new TabletFile(metadataEntry);\n+\n+    assertEquals(metadataEntry, tabletFile.getMetadataEntry());\n+    assertEquals(tableId, tabletFile.getTableId());\n+    assertEquals(tabletDir, tabletFile.getTabletDir());\n+    assertEquals(fileName, tabletFile.getFileName());\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTM5OTI4NA=="}, "originalCommit": {"oid": "78eebbf6dad187348bfcaf71241daf91e0237cd6"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI1NzEwMDc0OnYy", "diffSide": "RIGHT", "path": "core/src/test/java/org/apache/accumulo/core/metadata/schema/TabletFileTest.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQxOTo0MzoyMlrOFceTNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNTowOTo0OVrOFda1ew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQwMDg4Ng==", "bodyText": "The following are some additional bad paths that would be nice to check.\nhdfs://localhost:8020/accumulo/tablets/2a/default_tablet/F0000070.rf\nhdfs://localhost:8020/accumulo/2a/default_tablet/F0000070.rf\n/accumulo/tables/2a/default_tablet/F0000070.rf\nhdfs://localhost:8020/accumulo/tables/2a/F0000070.rf\nhdfs://localhost:8020/accumulo/tables/F0000070.rf", "url": "https://github.com/apache/accumulo/pull/1471#discussion_r365400886", "createdAt": "2020-01-10T19:43:22Z", "author": {"login": "keith-turner"}, "path": "core/src/test/java/org/apache/accumulo/core/metadata/schema/TabletFileTest.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.core.metadata.schema;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.fail;\n+\n+import org.apache.accumulo.core.data.TableId;\n+import org.junit.Test;\n+\n+public class TabletFileTest {\n+\n+  private void test(String metadataEntry, TableId tableId, String tabletDir, String fileName) {\n+    TabletFile tabletFile = new TabletFile(metadataEntry);\n+\n+    assertEquals(metadataEntry, tabletFile.getMetadataEntry());\n+    assertEquals(tableId, tabletFile.getTableId());\n+    assertEquals(tabletDir, tabletFile.getTabletDir());\n+    assertEquals(fileName, tabletFile.getFileName());\n+\n+  }\n+\n+  @Test\n+  public void testValidPaths() {\n+    test(\"hdfs://localhost:8020/accumulo/tables/2a/default_tablet/F0000070.rf\", TableId.of(\"2a\"),\n+        \"default_tablet\", \"F0000070.rf\");\n+    test(\"hdfs://nn1:9000/accumulo/tables/5a/t-0005/C0009.rf\", TableId.of(\"5a\"), \"t-0005\",\n+        \"C0009.rf\");\n+  }\n+\n+  @Test\n+  public void testBadPaths() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78eebbf6dad187348bfcaf71241daf91e0237cd6"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjAxMTU4Mw==", "bodyText": "I just tested these and noticed we need more validation on the volume.  Since we are traversing backwards up from the filename, anything before \"tables\" will be a valid volume.  Any ideas?  The best I can come up with is what I've seen... valid if path.contains(\":\")", "url": "https://github.com/apache/accumulo/pull/1471#discussion_r366011583", "createdAt": "2020-01-13T20:28:15Z", "author": {"login": "milleruntime"}, "path": "core/src/test/java/org/apache/accumulo/core/metadata/schema/TabletFileTest.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.core.metadata.schema;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.fail;\n+\n+import org.apache.accumulo.core.data.TableId;\n+import org.junit.Test;\n+\n+public class TabletFileTest {\n+\n+  private void test(String metadataEntry, TableId tableId, String tabletDir, String fileName) {\n+    TabletFile tabletFile = new TabletFile(metadataEntry);\n+\n+    assertEquals(metadataEntry, tabletFile.getMetadataEntry());\n+    assertEquals(tableId, tabletFile.getTableId());\n+    assertEquals(tabletDir, tabletFile.getTabletDir());\n+    assertEquals(fileName, tabletFile.getFileName());\n+\n+  }\n+\n+  @Test\n+  public void testValidPaths() {\n+    test(\"hdfs://localhost:8020/accumulo/tables/2a/default_tablet/F0000070.rf\", TableId.of(\"2a\"),\n+        \"default_tablet\", \"F0000070.rf\");\n+    test(\"hdfs://nn1:9000/accumulo/tables/5a/t-0005/C0009.rf\", TableId.of(\"5a\"), \"t-0005\",\n+        \"C0009.rf\");\n+  }\n+\n+  @Test\n+  public void testBadPaths() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQwMDg4Ng=="}, "originalCommit": {"oid": "78eebbf6dad187348bfcaf71241daf91e0237cd6"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA1MDUyOQ==", "bodyText": "Maybe ensure that volumePath.toUri().getScheme() is not null.", "url": "https://github.com/apache/accumulo/pull/1471#discussion_r366050529", "createdAt": "2020-01-13T21:57:57Z", "author": {"login": "keith-turner"}, "path": "core/src/test/java/org/apache/accumulo/core/metadata/schema/TabletFileTest.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.core.metadata.schema;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.fail;\n+\n+import org.apache.accumulo.core.data.TableId;\n+import org.junit.Test;\n+\n+public class TabletFileTest {\n+\n+  private void test(String metadataEntry, TableId tableId, String tabletDir, String fileName) {\n+    TabletFile tabletFile = new TabletFile(metadataEntry);\n+\n+    assertEquals(metadataEntry, tabletFile.getMetadataEntry());\n+    assertEquals(tableId, tabletFile.getTableId());\n+    assertEquals(tabletDir, tabletFile.getTabletDir());\n+    assertEquals(fileName, tabletFile.getFileName());\n+\n+  }\n+\n+  @Test\n+  public void testValidPaths() {\n+    test(\"hdfs://localhost:8020/accumulo/tables/2a/default_tablet/F0000070.rf\", TableId.of(\"2a\"),\n+        \"default_tablet\", \"F0000070.rf\");\n+    test(\"hdfs://nn1:9000/accumulo/tables/5a/t-0005/C0009.rf\", TableId.of(\"5a\"), \"t-0005\",\n+        \"C0009.rf\");\n+  }\n+\n+  @Test\n+  public void testBadPaths() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQwMDg4Ng=="}, "originalCommit": {"oid": "78eebbf6dad187348bfcaf71241daf91e0237cd6"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjM5MjY5OQ==", "bodyText": "That works great thanks!", "url": "https://github.com/apache/accumulo/pull/1471#discussion_r366392699", "createdAt": "2020-01-14T15:09:49Z", "author": {"login": "milleruntime"}, "path": "core/src/test/java/org/apache/accumulo/core/metadata/schema/TabletFileTest.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.core.metadata.schema;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.fail;\n+\n+import org.apache.accumulo.core.data.TableId;\n+import org.junit.Test;\n+\n+public class TabletFileTest {\n+\n+  private void test(String metadataEntry, TableId tableId, String tabletDir, String fileName) {\n+    TabletFile tabletFile = new TabletFile(metadataEntry);\n+\n+    assertEquals(metadataEntry, tabletFile.getMetadataEntry());\n+    assertEquals(tableId, tabletFile.getTableId());\n+    assertEquals(tabletDir, tabletFile.getTabletDir());\n+    assertEquals(fileName, tabletFile.getFileName());\n+\n+  }\n+\n+  @Test\n+  public void testValidPaths() {\n+    test(\"hdfs://localhost:8020/accumulo/tables/2a/default_tablet/F0000070.rf\", TableId.of(\"2a\"),\n+        \"default_tablet\", \"F0000070.rf\");\n+    test(\"hdfs://nn1:9000/accumulo/tables/5a/t-0005/C0009.rf\", TableId.of(\"5a\"), \"t-0005\",\n+        \"C0009.rf\");\n+  }\n+\n+  @Test\n+  public void testBadPaths() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQwMDg4Ng=="}, "originalCommit": {"oid": "78eebbf6dad187348bfcaf71241daf91e0237cd6"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2NDU4OTc5OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/accumulo/core/metadata/schema/TabletFile.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxOTo0NzoxNlrOFdjvIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQyMDoxMjo0MFrOFdka8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjUzODUzMA==", "bodyText": "There is a lot of string concatenation (which causes object allocation) for error messages that will usually never be seen in this method.", "url": "https://github.com/apache/accumulo/pull/1471#discussion_r366538530", "createdAt": "2020-01-14T19:47:16Z", "author": {"login": "keith-turner"}, "path": "core/src/main/java/org/apache/accumulo/core/metadata/schema/TabletFile.java", "diffHunk": "@@ -0,0 +1,136 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.core.metadata.schema;\n+\n+import java.util.Objects;\n+\n+import org.apache.accumulo.core.Constants;\n+import org.apache.accumulo.core.data.TableId;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.io.Text;\n+\n+import com.google.common.base.Preconditions;\n+\n+/**\n+ * Object representing a tablet file entry in the metadata table. Keeps a string of the exact entry\n+ * of what is in the metadata table for the column qualifier of the\n+ * {@link org.apache.accumulo.core.metadata.schema.MetadataSchema.TabletsSection.DataFileColumnFamily}\n+ * <p>\n+ * As of 2.1, Tablet file paths should now be only absolute URIs with the removal of relative paths\n+ * in Upgrader9to10.upgradeRelativePaths()\n+ */\n+public class TabletFile implements Comparable<TabletFile> {\n+  // parts of an absolute URI, like \"hdfs://1.2.3.4/accumulo/tables/2a/t-0003/C0004.rf\"\n+  private final String volume; // hdfs://1.2.3.4/accumulo\n+  private final TableId tableId; // 2a\n+  private final String tabletDir; // t-0003\n+  private final String fileName; // C0004.rf\n+  private final String metadataEntry;\n+  private final Path metaPath;\n+  private final String normalizedPath;\n+\n+  public TabletFile(String metadataEntry) {\n+    this.metadataEntry = Objects.requireNonNull(metadataEntry);\n+    String errorMsg = \" is missing/invalid from tablet file metadata entry: \" + metadataEntry;\n+\n+    this.metaPath = new Path(metadataEntry);\n+\n+    // use Path object to step backwards from the filename through all the parts\n+    this.fileName = metaPath.getName();\n+    MetadataSchema.TabletsSection.ServerColumnFamily.validateDirCol(fileName);\n+\n+    Path tabletDirPath = Objects.requireNonNull(metaPath.getParent(), \"Tablet dir\" + errorMsg);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f51d1cb8ddec323fafac5b8787a6f9c269b04b1c"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjU0OTc0Nw==", "bodyText": "Good point.  I think I'd rather make one generic error message that includes the metadataEntry than trying to describe the part of the string which had an error.", "url": "https://github.com/apache/accumulo/pull/1471#discussion_r366549747", "createdAt": "2020-01-14T20:12:40Z", "author": {"login": "milleruntime"}, "path": "core/src/main/java/org/apache/accumulo/core/metadata/schema/TabletFile.java", "diffHunk": "@@ -0,0 +1,136 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.core.metadata.schema;\n+\n+import java.util.Objects;\n+\n+import org.apache.accumulo.core.Constants;\n+import org.apache.accumulo.core.data.TableId;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.io.Text;\n+\n+import com.google.common.base.Preconditions;\n+\n+/**\n+ * Object representing a tablet file entry in the metadata table. Keeps a string of the exact entry\n+ * of what is in the metadata table for the column qualifier of the\n+ * {@link org.apache.accumulo.core.metadata.schema.MetadataSchema.TabletsSection.DataFileColumnFamily}\n+ * <p>\n+ * As of 2.1, Tablet file paths should now be only absolute URIs with the removal of relative paths\n+ * in Upgrader9to10.upgradeRelativePaths()\n+ */\n+public class TabletFile implements Comparable<TabletFile> {\n+  // parts of an absolute URI, like \"hdfs://1.2.3.4/accumulo/tables/2a/t-0003/C0004.rf\"\n+  private final String volume; // hdfs://1.2.3.4/accumulo\n+  private final TableId tableId; // 2a\n+  private final String tabletDir; // t-0003\n+  private final String fileName; // C0004.rf\n+  private final String metadataEntry;\n+  private final Path metaPath;\n+  private final String normalizedPath;\n+\n+  public TabletFile(String metadataEntry) {\n+    this.metadataEntry = Objects.requireNonNull(metadataEntry);\n+    String errorMsg = \" is missing/invalid from tablet file metadata entry: \" + metadataEntry;\n+\n+    this.metaPath = new Path(metadataEntry);\n+\n+    // use Path object to step backwards from the filename through all the parts\n+    this.fileName = metaPath.getName();\n+    MetadataSchema.TabletsSection.ServerColumnFamily.validateDirCol(fileName);\n+\n+    Path tabletDirPath = Objects.requireNonNull(metaPath.getParent(), \"Tablet dir\" + errorMsg);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjUzODUzMA=="}, "originalCommit": {"oid": "f51d1cb8ddec323fafac5b8787a6f9c269b04b1c"}, "originalPosition": 58}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2NDYxMjUzOnYy", "diffSide": "RIGHT", "path": "core/src/test/java/org/apache/accumulo/core/metadata/schema/TabletFileTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxOTo1NTozMFrOFdj9iQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxOTo1NTozMFrOFdj9iQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjU0MjIxNw==", "bodyText": "Would also be nice to verify that TabletFile.equals and TabletFile.hashCode work as expected for normalized paths.", "url": "https://github.com/apache/accumulo/pull/1471#discussion_r366542217", "createdAt": "2020-01-14T19:55:30Z", "author": {"login": "keith-turner"}, "path": "core/src/test/java/org/apache/accumulo/core/metadata/schema/TabletFileTest.java", "diffHunk": "@@ -0,0 +1,104 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.core.metadata.schema;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.fail;\n+\n+import org.apache.accumulo.core.data.TableId;\n+import org.junit.Test;\n+\n+public class TabletFileTest {\n+\n+  private void test(String metadataEntry, String volume, String tableId, String tabletDir,\n+      String fileName) {\n+    TabletFile tabletFile = new TabletFile(metadataEntry);\n+\n+    assertEquals(volume, tabletFile.getVolume());\n+    assertEquals(metadataEntry, tabletFile.getMetadataEntry());\n+    assertEquals(TableId.of(tableId), tabletFile.getTableId());\n+    assertEquals(tabletDir, tabletFile.getTabletDir());\n+    assertEquals(fileName, tabletFile.getFileName());\n+  }\n+\n+  @Test\n+  public void testValidPaths() {\n+    test(\"hdfs://localhost:8020/accumulo/tables/2a/default_tablet/F0000070.rf\",\n+        \"hdfs://localhost:8020/accumulo\", \"2a\", \"default_tablet\", \"F0000070.rf\");\n+    test(\"hdfs://nn1:9000/accumulo/tables/5a/t-0005/C0009.rf\", \"hdfs://nn1:9000/accumulo\", \"5a\",\n+        \"t-0005\", \"C0009.rf\");\n+    test(\n+        \"file:/home/dude/workspace/accumulo/test/target/mini-tests/org.apache.accumulo.test.VolumeIT_test/volumes/v1/tables/1/t-0000003/F0000006.rf\",\n+        \"file:/home/dude/workspace/accumulo/test/target/mini-tests/org.apache.accumulo.test.VolumeIT_test/volumes/v1\",\n+        \"1\", \"t-0000003\", \"F0000006.rf\");\n+  }\n+\n+  @Test\n+  public void testBadPaths() {\n+    try {\n+      test(\"C0004.rf\", \"\", \"2a\", \"t-0003\", \"C0004.rf\");\n+      fail(\"Failed to throw error on bad path\");\n+    } catch (NullPointerException e) {}\n+    // 2a< srv:dir\n+    try {\n+      test(\"dir\", \"\", \"2a\", \"\", \"\");\n+      fail(\"Failed to throw error on bad path\");\n+    } catch (NullPointerException e) {}\n+    try {\n+      test(\"hdfs://localhost:8020/accumulo/tablets/2a/default_tablet/F0000070.rf\",\n+          \"hdfs://localhost:8020/accumulo\", \"2a\", \"default_tablet\", \"F0000070.rf\");\n+      fail(\"Failed to throw error on bad path\");\n+    } catch (IllegalArgumentException e) {}\n+    try {\n+      test(\"hdfs://localhost:8020/accumulo/2a/default_tablet/F0000070.rf\",\n+          \" hdfs://localhost:8020/accumulo\", \"2a\", \"default_tablet\", \" F0000070.rf\");\n+    } catch (IllegalArgumentException e) {}\n+    try {\n+      test(\"/accumulo/tables/2a/default_tablet/F0000070.rf\", \"\", \"2a\", \"default_tablet\",\n+          \"F0000070.rf\");\n+    } catch (IllegalArgumentException e) {}\n+    try {\n+      test(\"hdfs://localhost:8020/accumulo/tables/2a/F0000070.rf\", \"hdfs://localhost:8020/accumulo\",\n+          \"2a\", \"\", \"F0000070.rf\");\n+    } catch (IllegalArgumentException e) {}\n+    try {\n+      test(\"hdfs://localhost:8020/accumulo/tables/F0000070.rf\", \"hdfs://localhost:8020/accumulo\",\n+          null, \"\", \"F0000070.rf\");\n+    } catch (IllegalArgumentException e) {}\n+  }\n+\n+  private final String id = \"2a\";\n+  private final String dir = \"t-0003\";\n+  private final String filename = \"C0004.rf\";\n+\n+  @Test\n+  public void testFullPathWithVolume() {\n+    String volume = \"hdfs://1.2.3.4/accumulo\";\n+    String metadataEntry = volume + \"/tables/\" + id + \"/\" + dir + \"/\" + filename;\n+    test(metadataEntry, volume, id, dir, filename);\n+  }\n+\n+  @Test\n+  public void testNormalizePath() {\n+    String uglyVolume = \"hdfs://nn.somewhere.com:86753/accumulo/blah/.././/bad/bad2/../.././/////\";\n+    String metadataEntry = uglyVolume + \"/tables/\" + id + \"/\" + dir + \"/\" + filename;\n+    test(metadataEntry, \"hdfs://nn.somewhere.com:86753/accumulo\", id, dir, filename);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f51d1cb8ddec323fafac5b8787a6f9c269b04b1c"}, "originalPosition": 101}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4294, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}