{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg2MzEzNTEw", "number": 1558, "title": "Resolve relative delete markers on upgrade. Closes #1463", "bodyText": "Also some minor clean up to Upgrader9to10", "createdAt": "2020-03-10T19:07:43Z", "url": "https://github.com/apache/accumulo/pull/1558", "merged": true, "mergeCommit": {"oid": "7adc1f1652607f7e8430b687e5f79b705803233a"}, "closed": true, "closedAt": "2020-03-13T20:47:25Z", "author": {"login": "milleruntime"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMXP8IAH2gAyMzg2MzEzNTEwOmQxOWJjY2Q2ZDMzZTEyMTljZWFhZWE1NGEyMTMwNGRmYjk5YjVmYzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcNViwYAFqTM3NDU2MDgxNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d19bccd6d33e1219ceaaea54a21304dfb99b5fc7", "author": {"user": {"login": "milleruntime", "name": "Mike Miller"}}, "url": "https://github.com/apache/accumulo/commit/d19bccd6d33e1219ceaaea54a21304dfb99b5fc7", "committedDate": "2020-03-10T18:58:24Z", "message": "Resolve relative delete markers on upgrade. Closes #1463"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMzUwMzM3", "url": "https://github.com/apache/accumulo/pull/1558#pullrequestreview-372350337", "createdAt": "2020-03-10T21:57:26Z", "commit": {"oid": "d19bccd6d33e1219ceaaea54a21304dfb99b5fc7"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQyMTo1NzoyNlrOF0iecg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQyMjowNToyMFrOF0iqSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDYzNTEyMg==", "bodyText": "What is the significance of depth 4? Could add to a comment.", "url": "https://github.com/apache/accumulo/pull/1558#discussion_r390635122", "createdAt": "2020-03-10T21:57:26Z", "author": {"login": "ctubbsii"}, "path": "server/master/src/main/java/org/apache/accumulo/master/upgrade/Upgrader9to10.java", "diffHunk": "@@ -430,26 +432,27 @@ public void upgradeFileDeletes(ServerContext ctx, Ample.DataLevel level) {\n     }\n   }\n \n+  /**\n+   * If path of file to delete is a directory, change it to all volumes. See {@link GcVolumeUtil}.\n+   * For example: A directory \"hdfs://localhost:9000/accumulo/tables/5a/t-0005\" with depth = 4 will\n+   * be switched to \"agcav:/tables/5a/t-0005\". A file\n+   * \"hdfs://localhost:9000/accumulo/tables/5a/t-0005/A0012.rf\" with depth = 5 will be returned as\n+   * is.\n+   */\n   @VisibleForTesting\n-  static String switchToAllVolumes(String olddelete) {\n-    Path relPath = VolumeManager.FileType.TABLE.removeVolume(new Path(olddelete));\n-\n-    if (relPath == null) {\n-      // An old style relative delete marker of the form /<table id>/<tablet dir>[/<file>]\n-      relPath = new Path(\"/\" + VolumeManager.FileType.TABLE.getDirectory() + olddelete);\n-      Preconditions.checkState(\n-          olddelete.startsWith(\"/\") && relPath.depth() == 3 || relPath.depth() == 4,\n-          \"Unrecongnized relative delete marker {}\", olddelete);\n-    }\n-\n-    if (relPath.depth() == 3 && !relPath.getName().startsWith(Constants.BULK_PREFIX)) {\n-      return GcVolumeUtil.getDeleteTabletOnAllVolumesUri(TableId.of(relPath.getParent().getName()),\n-          relPath.getName());\n+  static String switchToAllVolumes(Path olddelete) {\n+    // for directory, change volume to all volumes\n+    if (olddelete.depth() == 4 && !olddelete.getName().startsWith(Constants.BULK_PREFIX)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d19bccd6d33e1219ceaaea54a21304dfb99b5fc7"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDYzNzM1OA==", "bodyText": "Should have comment to briefly explain intent of this check, so its implementation can be more easily verified. The current comment just says \"check the format is correct\", but does not explain what it means to be \"correct\".", "url": "https://github.com/apache/accumulo/pull/1558#discussion_r390637358", "createdAt": "2020-03-10T22:03:14Z", "author": {"login": "ctubbsii"}, "path": "server/master/src/main/java/org/apache/accumulo/master/upgrade/Upgrader9to10.java", "diffHunk": "@@ -625,4 +626,39 @@ private static Path resolveRelativePath(String metadataEntry, Key key) {\n       return new Path(prefix + tableId.canonical() + metadataEntry);\n     }\n   }\n+\n+  /**\n+   * Resolve old relative delete markers of the form /tableId/tabletDir/[file] to\n+   * UpgradeVolume/tables/tableId/tabletDir/[file]\n+   */\n+  static Path resolveRelativeDelete(VolumeManager fs, String oldDelete, String upgradeProperty) {\n+    Path pathNoVolume = VolumeManager.FileType.TABLE.removeVolume(new Path(oldDelete));\n+\n+    // abs path won't be null so return\n+    if (pathNoVolume != null)\n+      return pathNoVolume;\n+\n+    // use Path to check the format is correct\n+    Path pathToCheck = new Path(oldDelete);\n+    Preconditions.checkState(\n+        oldDelete.startsWith(\"/\") && (pathToCheck.depth() == 2 || pathToCheck.depth() == 3),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d19bccd6d33e1219ceaaea54a21304dfb99b5fc7"}, "originalPosition": 114}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDYzODE1NQ==", "bodyText": "This says \"absolute path won't be null\", but that's not the same as \"relative path must be null\". Can relative path be non-null? If so, then this will return for both absolute paths and non-null relative paths.", "url": "https://github.com/apache/accumulo/pull/1558#discussion_r390638155", "createdAt": "2020-03-10T22:05:20Z", "author": {"login": "ctubbsii"}, "path": "server/master/src/main/java/org/apache/accumulo/master/upgrade/Upgrader9to10.java", "diffHunk": "@@ -625,4 +626,39 @@ private static Path resolveRelativePath(String metadataEntry, Key key) {\n       return new Path(prefix + tableId.canonical() + metadataEntry);\n     }\n   }\n+\n+  /**\n+   * Resolve old relative delete markers of the form /tableId/tabletDir/[file] to\n+   * UpgradeVolume/tables/tableId/tabletDir/[file]\n+   */\n+  static Path resolveRelativeDelete(VolumeManager fs, String oldDelete, String upgradeProperty) {\n+    Path pathNoVolume = VolumeManager.FileType.TABLE.removeVolume(new Path(oldDelete));\n+\n+    // abs path won't be null so return\n+    if (pathNoVolume != null)\n+      return pathNoVolume;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d19bccd6d33e1219ceaaea54a21304dfb99b5fc7"}, "originalPosition": 109}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMzkwODMx", "url": "https://github.com/apache/accumulo/pull/1558#pullrequestreview-372390831", "createdAt": "2020-03-10T23:35:18Z", "commit": {"oid": "d19bccd6d33e1219ceaaea54a21304dfb99b5fc7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQyMzozNToxOFrOF0kqNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQyMzozNToxOFrOF0kqNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY3MDkwMQ==", "bodyText": "Delete entries do not have to exists.  This can happen when the GC deletes some files, but the GC process dies before it deletes the delete entries.", "url": "https://github.com/apache/accumulo/pull/1558#discussion_r390670901", "createdAt": "2020-03-10T23:35:18Z", "author": {"login": "keith-turner"}, "path": "server/master/src/main/java/org/apache/accumulo/master/upgrade/Upgrader9to10.java", "diffHunk": "@@ -625,4 +626,39 @@ private static Path resolveRelativePath(String metadataEntry, Key key) {\n       return new Path(prefix + tableId.canonical() + metadataEntry);\n     }\n   }\n+\n+  /**\n+   * Resolve old relative delete markers of the form /tableId/tabletDir/[file] to\n+   * UpgradeVolume/tables/tableId/tabletDir/[file]\n+   */\n+  static Path resolveRelativeDelete(VolumeManager fs, String oldDelete, String upgradeProperty) {\n+    Path pathNoVolume = VolumeManager.FileType.TABLE.removeVolume(new Path(oldDelete));\n+\n+    // abs path won't be null so return\n+    if (pathNoVolume != null)\n+      return pathNoVolume;\n+\n+    // use Path to check the format is correct\n+    Path pathToCheck = new Path(oldDelete);\n+    Preconditions.checkState(\n+        oldDelete.startsWith(\"/\") && (pathToCheck.depth() == 2 || pathToCheck.depth() == 3),\n+        \"Unrecognized relative delete marker {}\", oldDelete);\n+\n+    // found relative paths so verify the property used to build the absolute paths\n+    if (upgradeProperty == null || upgradeProperty.isBlank()) {\n+      throw new IllegalArgumentException(\n+          \"Missing required property \" + Property.INSTANCE_VOLUMES_UPGRADE_RELATIVE.getKey());\n+    }\n+    Path absPath =\n+        new Path(upgradeProperty, VolumeManager.FileType.TABLE.getDirectory() + oldDelete);\n+    try {\n+      if (!fs.exists(absPath)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d19bccd6d33e1219ceaaea54a21304dfb99b5fc7"}, "originalPosition": 125}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70dd2760ce5974d47ca2902e609d1f6261376829", "author": {"user": {"login": "milleruntime", "name": "Mike Miller"}}, "url": "https://github.com/apache/accumulo/commit/70dd2760ce5974d47ca2902e609d1f6261376829", "committedDate": "2020-03-11T13:18:14Z", "message": "PR updates"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f97f349f5ffdf4cd991fedac6526acb9ea4fcb38", "author": {"user": {"login": "milleruntime", "name": "Mike Miller"}}, "url": "https://github.com/apache/accumulo/commit/f97f349f5ffdf4cd991fedac6526acb9ea4fcb38", "committedDate": "2020-03-11T13:25:23Z", "message": "Remove param no longer used"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczOTc5MTQ0", "url": "https://github.com/apache/accumulo/pull/1558#pullrequestreview-373979144", "createdAt": "2020-03-13T00:23:06Z", "commit": {"oid": "f97f349f5ffdf4cd991fedac6526acb9ea4fcb38"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QwMDoyMzowNlrOF10AYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QwMDoyMzowNlrOF10AYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk3MDkxMw==", "bodyText": "I'm still a bit concerned about the wording of this comment here. Is this an if or an iff (if and only if)?", "url": "https://github.com/apache/accumulo/pull/1558#discussion_r391970913", "createdAt": "2020-03-13T00:23:06Z", "author": {"login": "ctubbsii"}, "path": "server/master/src/main/java/org/apache/accumulo/master/upgrade/Upgrader9to10.java", "diffHunk": "@@ -625,4 +630,30 @@ private static Path resolveRelativePath(String metadataEntry, Key key) {\n       return new Path(prefix + tableId.canonical() + metadataEntry);\n     }\n   }\n+\n+  /**\n+   * Resolve old relative delete markers of the form /tableId/tabletDir/[file] to\n+   * UpgradeVolume/tables/tableId/tabletDir/[file]\n+   */\n+  static Path resolveRelativeDelete(String oldDelete, String upgradeProperty) {\n+    Path pathNoVolume = VolumeManager.FileType.TABLE.removeVolume(new Path(oldDelete));\n+\n+    // removeVolume will return null if path doesn't have a volume aka is a relative path", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f97f349f5ffdf4cd991fedac6526acb9ea4fcb38"}, "originalPosition": 118}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b5c4dca9014009dda28155d0ea4b5cec48b42a0", "author": {"user": {"login": "milleruntime", "name": "Mike Miller"}}, "url": "https://github.com/apache/accumulo/commit/1b5c4dca9014009dda28155d0ea4b5cec48b42a0", "committedDate": "2020-03-13T14:31:49Z", "message": "Fix replace method after changing other method. Update comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0MzczOTc1", "url": "https://github.com/apache/accumulo/pull/1558#pullrequestreview-374373975", "createdAt": "2020-03-13T15:05:03Z", "commit": {"oid": "1b5c4dca9014009dda28155d0ea4b5cec48b42a0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c12724007ee4258c1f10a86df9655dfe8b47b86", "author": {"user": {"login": "milleruntime", "name": "Mike Miller"}}, "url": "https://github.com/apache/accumulo/commit/4c12724007ee4258c1f10a86df9655dfe8b47b86", "committedDate": "2020-03-13T19:28:27Z", "message": "Update comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0NTYwODE1", "url": "https://github.com/apache/accumulo/pull/1558#pullrequestreview-374560815", "createdAt": "2020-03-13T19:33:04Z", "commit": {"oid": "1b5c4dca9014009dda28155d0ea4b5cec48b42a0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1892, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}