{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ2ODExODU1", "number": 1653, "title": "Use Ample for tablet location updates", "bodyText": "This is the rest of the reverted code from pull request #1453 and includes some slight fixes for some of the IT's that it broke. This is still a work in progress due to some inconsistencies in my testing of the IT's and I know there are currently some fixes in the works for a few of those.\nMost of the code changes are aimed to use TabletMutator in the various state store setLocation functions (some of these functions were already doing so but not all) and deleting unused code. Parts of these changes coincide with my change in #1616 in when we update lastLocation.", "createdAt": "2020-07-09T11:54:41Z", "url": "https://github.com/apache/accumulo/pull/1653", "merged": true, "mergeCommit": {"oid": "bfe173ec140f07086b0ff8940fc08d640b9539a7"}, "closed": true, "closedAt": "2020-09-16T18:38:21Z", "author": {"login": "Manno15"}, "timelineItems": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcyk4XvgH2gAyNDQ2ODExODU1OjZiNDQ3YzQ2NmM0Njc1MDdmZDIxMGMwNTcxMDM5ZjcxYmEzMDkzMWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJc2IIgFqTQ4OTY1NTE3NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6b447c466c467507fd210c0571039f71ba30931b", "author": {"user": null}, "url": "https://github.com/apache/accumulo/commit/6b447c466c467507fd210c0571039f71ba30931b", "committedDate": "2020-07-07T12:20:27Z", "message": "Fixes to ammend refactor errors from reversion"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "456b7e088e708c286ae4fdd967c22ee9f4230dab", "author": {"user": {"login": "Manno15", "name": "Jeffrey Manno"}}, "url": "https://github.com/apache/accumulo/commit/456b7e088e708c286ae4fdd967c22ee9f4230dab", "committedDate": "2020-07-07T13:04:20Z", "message": "Removed random letter that was added"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd1fdb484447d4eb6c537d9695f4b30f58f8d471", "author": {"user": {"login": "Manno15", "name": "Jeffrey Manno"}}, "url": "https://github.com/apache/accumulo/commit/bd1fdb484447d4eb6c537d9695f4b30f58f8d471", "committedDate": "2020-07-08T11:12:46Z", "message": "Merge branch 'master' of https://github.com/apache/accumulo into fix_update_revert"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "655743a8a02bc895420658f5b7065300a0c0650d", "author": {"user": {"login": "Manno15", "name": "Jeffrey Manno"}}, "url": "https://github.com/apache/accumulo/commit/655743a8a02bc895420658f5b7065300a0c0650d", "committedDate": "2020-07-08T11:27:21Z", "message": "small fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b747180151d0c734a31bad657d831d9dc1f00165", "author": {"user": {"login": "Manno15", "name": "Jeffrey Manno"}}, "url": "https://github.com/apache/accumulo/commit/b747180151d0c734a31bad657d831d9dc1f00165", "committedDate": "2020-09-08T15:51:19Z", "message": "fix merge conflict"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9cf2c9c228745b4ba55c86cf112de4663e57a2a", "author": {"user": {"login": "Manno15", "name": "Jeffrey Manno"}}, "url": "https://github.com/apache/accumulo/commit/b9cf2c9c228745b4ba55c86cf112de4663e57a2a", "committedDate": "2020-09-08T16:01:33Z", "message": "fix imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf262bf01afc8980e6d3d546a0dd1d656ddbcfac", "author": {"user": {"login": "Manno15", "name": "Jeffrey Manno"}}, "url": "https://github.com/apache/accumulo/commit/bf262bf01afc8980e6d3d546a0dd1d656ddbcfac", "committedDate": "2020-09-09T11:30:39Z", "message": "small change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d543ae65eb4bce624bafddd9c7ebb0a7f3f0971f", "author": {"user": {"login": "Manno15", "name": "Jeffrey Manno"}}, "url": "https://github.com/apache/accumulo/commit/d543ae65eb4bce624bafddd9c7ebb0a7f3f0971f", "committedDate": "2020-09-09T15:40:48Z", "message": "whitespace removal"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c025e5cf13ef0af5e35f8897ae5b86ee54b4d04", "author": {"user": {"login": "Manno15", "name": "Jeffrey Manno"}}, "url": "https://github.com/apache/accumulo/commit/7c025e5cf13ef0af5e35f8897ae5b86ee54b4d04", "committedDate": "2020-09-09T15:52:34Z", "message": "fix merge conflicts"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2MjEzOTE3", "url": "https://github.com/apache/accumulo/pull/1653#pullrequestreview-486213917", "createdAt": "2020-09-10T18:41:21Z", "commit": {"oid": "7c025e5cf13ef0af5e35f8897ae5b86ee54b4d04"}, "state": "COMMENTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxODo0MToyMVrOHQBNFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMDozOTo1NFrOHQE8GA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjU1ODk5Ng==", "bodyText": "This could use a small comment above it to explain what situation it is checking for.", "url": "https://github.com/apache/accumulo/pull/1653#discussion_r486558996", "createdAt": "2020-09-10T18:41:21Z", "author": {"login": "ctubbsii"}, "path": "core/src/main/java/org/apache/accumulo/core/util/HostAndPort.java", "diffHunk": "@@ -171,6 +171,10 @@ public static HostAndPort fromString(String hostPortString) {\n       // JDK7 accepts leading plus signs. We don't want to.\n       checkArgument(!portString.startsWith(\"+\"), \"Unparseable port number: %s\", hostPortString);\n       try {\n+        if (portString.contains(\"[\")) {\n+          int endIndex = portString.indexOf(\"[\");\n+          portString = portString.substring(0, endIndex);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c025e5cf13ef0af5e35f8897ae5b86ee54b4d04"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYwOTUwNQ==", "bodyText": "Why is it the case that these location entries no longer need to be updated here? Where is the replacement code?", "url": "https://github.com/apache/accumulo/pull/1653#discussion_r486609505", "createdAt": "2020-09-10T20:19:24Z", "author": {"login": "ctubbsii"}, "path": "server/base/src/main/java/org/apache/accumulo/server/util/MasterMetadataUtil.java", "diffHunk": "@@ -227,14 +204,6 @@ public static StoredTabletFile updateTabletDataFile(ServerContext context, KeyEx\n       tablet.putFile(path, dfv);\n       tablet.putTime(time);\n       newFile = path.insert();\n-\n-      TServerInstance self = getTServerInstance(address, zooLock);\n-      tablet.putLocation(self, LocationType.LAST);\n-\n-      // remove the old location\n-      if (lastLocation != null && !lastLocation.equals(self)) {\n-        tablet.deleteLocation(lastLocation, LocationType.LAST);\n-      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c025e5cf13ef0af5e35f8897ae5b86ee54b4d04"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYwOTU3Nw==", "bodyText": "Why is it the case that these location entries no longer need to be updated here? Where is the replacement code?", "url": "https://github.com/apache/accumulo/pull/1653#discussion_r486609577", "createdAt": "2020-09-10T20:19:34Z", "author": {"login": "ctubbsii"}, "path": "server/base/src/main/java/org/apache/accumulo/server/util/MasterMetadataUtil.java", "diffHunk": "@@ -197,13 +181,6 @@ public static void replaceDatafiles(ServerContext context, KeyExtent extent,\n     if (compactionId != null)\n       tablet.putCompactionId(compactionId);\n \n-    TServerInstance self = getTServerInstance(address, zooLock);\n-    tablet.putLocation(self, LocationType.LAST);\n-\n-    // remove the old location\n-    if (lastLocation != null && !lastLocation.equals(self))\n-      tablet.deleteLocation(lastLocation, LocationType.LAST);\n-", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c025e5cf13ef0af5e35f8897ae5b86ee54b4d04"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYxMjA4OQ==", "bodyText": "I'm not sure these catch clauses should be removed, and that DistributedStoreException should be deleted. While the conversion to Ample does eliminate the checked exception of MutationsRejectedException, by wrapping it (and all other exceptions) with a RuntimeException, the RuntimeException was previously being handled here, and now it falls through.", "url": "https://github.com/apache/accumulo/pull/1653#discussion_r486612089", "createdAt": "2020-09-10T20:24:17Z", "author": {"login": "ctubbsii"}, "path": "server/base/src/main/java/org/apache/accumulo/server/master/state/MetaDataStateStore.java", "diffHunk": "@@ -58,137 +54,86 @@ protected MetaDataStateStore(ClientContext context, CurrentState state, String t\n     return new MetaDataTableScanner(context, TabletsSection.getRange(), state, targetTableName);\n   }\n \n-  @Override\n-  public void setLocations(Collection<Assignment> assignments) throws DistributedStoreException {\n-    BatchWriter writer = createBatchWriter();\n-    try {\n-      for (Assignment assignment : assignments) {\n-        Mutation m = new Mutation(assignment.tablet.toMetaRow());\n-        assignment.server.putLocation(m);\n-        assignment.server.putLastLocation(m);\n-        assignment.server.clearFutureLocation(m);\n-        SuspendingTServer.clearSuspension(m);\n-        writer.addMutation(m);\n-      }\n-    } catch (Exception ex) {\n-      throw new DistributedStoreException(ex);\n-    } finally {\n-      try {\n-        writer.close();\n-      } catch (MutationsRejectedException e) {\n-        throw new DistributedStoreException(e);\n-      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c025e5cf13ef0af5e35f8897ae5b86ee54b4d04"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYxNTk3OA==", "bodyText": "It seems like this code would be less efficient, because it creates a new batch writer for each assignment, and that the method that handles the updates in Ample should deal with updating all of the assignments in one pass. What do you know about the performance implications of this change?", "url": "https://github.com/apache/accumulo/pull/1653#discussion_r486615978", "createdAt": "2020-09-10T20:31:43Z", "author": {"login": "ctubbsii"}, "path": "server/manager/src/main/java/org/apache/accumulo/master/TabletGroupWatcher.java", "diffHunk": "@@ -871,7 +870,9 @@ private void flushChanges(SortedMap<TServerInstance,TabletServerStatus> currentT\n \n     if (!assignments.isEmpty()) {\n       Master.log.info(String.format(\"Assigning %d tablets\", assignments.size()));\n-      store.setFutureLocations(assignments);\n+\n+      for (Assignment assignment : assignments)\n+        store.setFutureLocation(assignment);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c025e5cf13ef0af5e35f8897ae5b86ee54b4d04"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYxOTE1NA==", "bodyText": "Is assignment.server really the previously assigned location to clear? This doesn't seem right because MetaDataStateStore.setLocation just compares this prevLastLoc (passed in here as assignment.server against assignment.server. It seems like it would never be different, and the last location entries would remain (and possibly keep accruing?)", "url": "https://github.com/apache/accumulo/pull/1653#discussion_r486619154", "createdAt": "2020-09-10T20:37:53Z", "author": {"login": "ctubbsii"}, "path": "server/tserver/src/main/java/org/apache/accumulo/tserver/AssignmentHandler.java", "diffHunk": "@@ -177,7 +177,7 @@ public void run() {\n         throw new RuntimeException(\"Minor compaction after recovery fails for \" + extent);\n       }\n       Assignment assignment = new Assignment(extent, server.getTabletSession());\n-      TabletStateStore.setLocation(server.getContext(), assignment);\n+      TabletStateStore.setLocation(server.getContext(), assignment, assignment.server);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c025e5cf13ef0af5e35f8897ae5b86ee54b4d04"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYxOTY4MA==", "bodyText": "After your changes, this catch clause has no effect (since it was removed), and the RuntimeExceptions now thrown will continue falling through this, completely unhandled.", "url": "https://github.com/apache/accumulo/pull/1653#discussion_r486619680", "createdAt": "2020-09-10T20:38:53Z", "author": {"login": "ctubbsii"}, "path": "server/tserver/src/main/java/org/apache/accumulo/tserver/UnloadTabletHandler.java", "diffHunk": "@@ -123,8 +122,6 @@ public void run() {\n         TabletStateStore.suspend(server.getContext(), tls, null,\n             requestTimeSkew + MILLISECONDS.convert(System.nanoTime(), NANOSECONDS));\n       }\n-    } catch (DistributedStoreException ex) {\n-      log.warn(\"Unable to update storage\", ex);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c025e5cf13ef0af5e35f8897ae5b86ee54b4d04"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYyMDE4NA==", "bodyText": "This seems likely where the actual lastLocation information is lost.", "url": "https://github.com/apache/accumulo/pull/1653#discussion_r486620184", "createdAt": "2020-09-10T20:39:54Z", "author": {"login": "ctubbsii"}, "path": "server/tserver/src/main/java/org/apache/accumulo/tserver/tablet/DatafileManager.java", "diffHunk": "@@ -444,7 +442,7 @@ StoredTabletFile bringMajorCompactionOnline(Set<StoredTabletFile> oldDatafiles,\n \n       tablet.computeNumEntries();\n \n-      lastLocation = tablet.resetLastLocation();\n+      tablet.resetLastLocation();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c025e5cf13ef0af5e35f8897ae5b86ee54b4d04"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "804326608eeb133de83f7ac0a00f354cd35aa8d2", "author": {"user": {"login": "Manno15", "name": "Jeffrey Manno"}}, "url": "https://github.com/apache/accumulo/commit/804326608eeb133de83f7ac0a00f354cd35aa8d2", "committedDate": "2020-09-11T12:04:46Z", "message": "pass in the proper prevLastLoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2833ac4c775a4b7668430cec1dec162b5700ad14", "author": {"user": {"login": "Manno15", "name": "Jeffrey Manno"}}, "url": "https://github.com/apache/accumulo/commit/2833ac4c775a4b7668430cec1dec162b5700ad14", "committedDate": "2020-09-11T12:54:32Z", "message": "add DistrubutedStoreException back"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a3981279dd0ab1a755d4b1442080bb236f7b120", "author": {"user": {"login": "ctubbsii", "name": "Christopher Tubbs"}}, "url": "https://github.com/apache/accumulo/commit/7a3981279dd0ab1a755d4b1442080bb236f7b120", "committedDate": "2020-09-15T12:09:09Z", "message": "Revert \"Update Last Location. Fix #1169  (#1616)\"\n\nThis reverts commit 1c0f8df4ebf7ecb75cde889b32fcdbcfeaf4689d.\n\nThis changed the behavior of updating the LAST location field to update\non assignment, rather than on writing data to DFS. The LAST location\nfield should be updated when writing data to DFS, because it identifies\nthe location where the tablet last wrote data, so that a balancing\nstrategy can re-assign it to a location where at least some data is\nlocal."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7cfc9ffe2f62cb956c55f25538b55869b37ed421", "author": {"user": {"login": "Manno15", "name": "Jeffrey Manno"}}, "url": "https://github.com/apache/accumulo/commit/7cfc9ffe2f62cb956c55f25538b55869b37ed421", "committedDate": "2020-09-15T12:09:09Z", "message": "revert to just doing ample changes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "10312038c0b06884df0e9d7baaa1c83cb2f11efb", "author": {"user": {"login": "Manno15", "name": "Jeffrey Manno"}}, "url": "https://github.com/apache/accumulo/commit/10312038c0b06884df0e9d7baaa1c83cb2f11efb", "committedDate": "2020-09-15T12:05:13Z", "message": "revert to just doing ample changes"}, "afterCommit": {"oid": "7cfc9ffe2f62cb956c55f25538b55869b37ed421", "author": {"user": {"login": "Manno15", "name": "Jeffrey Manno"}}, "url": "https://github.com/apache/accumulo/commit/7cfc9ffe2f62cb956c55f25538b55869b37ed421", "committedDate": "2020-09-15T12:09:09Z", "message": "revert to just doing ample changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de98dd7388d3f4e147b05b2acf78d18aa5583da0", "author": {"user": {"login": "Manno15", "name": "Jeffrey Manno"}}, "url": "https://github.com/apache/accumulo/commit/de98dd7388d3f4e147b05b2acf78d18aa5583da0", "committedDate": "2020-09-15T12:14:02Z", "message": "remove various whitespaces"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4NjkzNzg5", "url": "https://github.com/apache/accumulo/pull/1653#pullrequestreview-488693789", "createdAt": "2020-09-15T13:40:03Z", "commit": {"oid": "59d1155d151bc6c784e8b89ebad708a194a60f63"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxMzo0MDowNFrOHSCZcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxMzo0NjowMlrOHSCrqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODY3NTY5OQ==", "bodyText": "This replaces SuspendingTServer.toValue(), which does not appear to be used any longer. The old method stored a HostAndPort.toString(), but this stores Ample.TServer.toString(). Are these identical?\nThe serialization for toValue should probably remain in the SuspendingTServer class, since that's where the corresponding fromValue method is. So, I recommend changing SuspendingTServer.toValue that is called from here, so if the serialization changes, it can be changed in both toValue and fromValue at the same time.", "url": "https://github.com/apache/accumulo/pull/1653#discussion_r488675699", "createdAt": "2020-09-15T13:40:04Z", "author": {"login": "ctubbsii"}, "path": "server/base/src/main/java/org/apache/accumulo/server/metadata/TabletMutatorBase.java", "diffHunk": "@@ -202,6 +203,23 @@ private String getLocationFamily(LocationType type) {\n     return this;\n   }\n \n+  @Override\n+  public Ample.TabletMutator putSuspension(Ample.TServer tServer, long suspensionTime) {\n+    Preconditions.checkState(updatesEnabled, \"Cannot make updates after calling mutate.\");\n+    mutation.put(SuspendLocationColumn.SUSPEND_COLUMN.getColumnFamily(),\n+        SuspendLocationColumn.SUSPEND_COLUMN.getColumnQualifier(),\n+        new Value(tServer + \"|\" + suspensionTime));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59d1155d151bc6c784e8b89ebad708a194a60f63"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODY4MDM2MA==", "bodyText": "I think this loop could benefit from the same batch writer reuse that you did in the unassign method below this, where you called try (var tabletsMutator = ample.mutateTablets()) { outside the loop. (Same comment applies to the setLocations method above.)", "url": "https://github.com/apache/accumulo/pull/1653#discussion_r488680360", "createdAt": "2020-09-15T13:46:02Z", "author": {"login": "ctubbsii"}, "path": "server/base/src/main/java/org/apache/accumulo/server/master/state/MetaDataStateStore.java", "diffHunk": "@@ -58,57 +54,31 @@ protected MetaDataStateStore(ClientContext context, CurrentState state, String t\n     return new MetaDataTableScanner(context, TabletsSection.getRange(), state, targetTableName);\n   }\n \n-  @Override\n   public void setLocations(Collection<Assignment> assignments) throws DistributedStoreException {\n-    BatchWriter writer = createBatchWriter();\n     try {\n       for (Assignment assignment : assignments) {\n-        Mutation m = new Mutation(assignment.tablet.toMetaRow());\n-        assignment.server.putLocation(m);\n-        assignment.server.clearFutureLocation(m);\n-        SuspendingTServer.clearSuspension(m);\n-        writer.addMutation(m);\n+        TabletMutator tabletMutator = ample.mutateTablet(assignment.tablet);\n+        tabletMutator.putLocation(assignment.server, LocationType.CURRENT);\n+        tabletMutator.deleteLocation(assignment.server, LocationType.FUTURE);\n+        tabletMutator.mutate();\n       }\n     } catch (Exception ex) {\n       throw new DistributedStoreException(ex);\n-    } finally {\n-      try {\n-        writer.close();\n-      } catch (MutationsRejectedException e) {\n-        throw new DistributedStoreException(e);\n-      }\n-    }\n-  }\n-\n-  BatchWriter createBatchWriter() {\n-    try {\n-      return context.createBatchWriter(targetTableName,\n-          new BatchWriterConfig().setMaxMemory(MAX_MEMORY)\n-              .setMaxLatency(LATENCY, TimeUnit.MILLISECONDS).setMaxWriteThreads(THREADS));\n-    } catch (Exception e) {\n-      throw new RuntimeException(e);\n     }\n   }\n \n   @Override\n   public void setFutureLocations(Collection<Assignment> assignments)\n       throws DistributedStoreException {\n-    BatchWriter writer = createBatchWriter();\n     try {\n       for (Assignment assignment : assignments) {\n-        Mutation m = new Mutation(assignment.tablet.toMetaRow());\n-        SuspendingTServer.clearSuspension(m);\n-        assignment.server.putFutureLocation(m);\n-        writer.addMutation(m);\n+        TabletMutator tabletMutator = ample.mutateTablet(assignment.tablet);\n+        tabletMutator.deleteSuspension();\n+        tabletMutator.putLocation(assignment.server, LocationType.FUTURE);\n+        tabletMutator.mutate();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59d1155d151bc6c784e8b89ebad708a194a60f63"}, "originalPosition": 90}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bce08e46c12e74cce3bc0132fe73c74a936f68eb", "author": {"user": {"login": "Manno15", "name": "Jeffrey Manno"}}, "url": "https://github.com/apache/accumulo/commit/bce08e46c12e74cce3bc0132fe73c74a936f68eb", "committedDate": "2020-09-15T16:48:39Z", "message": "made requested changes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "59d1155d151bc6c784e8b89ebad708a194a60f63", "author": {"user": {"login": "Manno15", "name": "Jeffrey Manno"}}, "url": "https://github.com/apache/accumulo/commit/59d1155d151bc6c784e8b89ebad708a194a60f63", "committedDate": "2020-09-15T12:16:22Z", "message": "Merge branch 'main' into fix_update_revert"}, "afterCommit": {"oid": "bce08e46c12e74cce3bc0132fe73c74a936f68eb", "author": {"user": {"login": "Manno15", "name": "Jeffrey Manno"}}, "url": "https://github.com/apache/accumulo/commit/bce08e46c12e74cce3bc0132fe73c74a936f68eb", "committedDate": "2020-09-15T16:48:39Z", "message": "made requested changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c3fa108ad6dbb53cbb05e4b15f5079ff0de8bfa", "author": {"user": {"login": "Manno15", "name": "Jeffrey Manno"}}, "url": "https://github.com/apache/accumulo/commit/8c3fa108ad6dbb53cbb05e4b15f5079ff0de8bfa", "committedDate": "2020-09-15T16:49:37Z", "message": "Merge branch 'main' into fix_update_revert"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5MTI5Njk2", "url": "https://github.com/apache/accumulo/pull/1653#pullrequestreview-489129696", "createdAt": "2020-09-15T21:44:25Z", "commit": {"oid": "8c3fa108ad6dbb53cbb05e4b15f5079ff0de8bfa"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQyMTo0NDoyNVrOHSV3Tg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQyMTo1MTozN1rOHSWPNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODk5NDYzOA==", "bodyText": "Did you forget to include the deleteSuspension() here?\nAlso, the code might look cleaner if you chained the methods, something like (not formatted):\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    TabletMutator tabletMutator = tabletsMutator.mutateTablet(assignment.tablet);\n          \n          \n            \n                    tabletMutator.putLocation(assignment.server, LocationType.CURRENT);\n          \n          \n            \n                    tabletMutator.deleteLocation(assignment.server, LocationType.FUTURE);\n          \n          \n            \n                    tabletMutator.mutate();\n          \n          \n            \n                    tabletsMutator.mutateTablet(assignment.tablet)\n          \n          \n            \n                      .putLocation(assignment.server, LocationType.CURRENT)\n          \n          \n            \n                      .deleteLocation(assignment.server, LocationType.FUTURE)\n          \n          \n            \n                      .deleteSuspension()\n          \n          \n            \n                      .mutate();\n          \n      \n    \n    \n  \n\nIf the formatter makes it look too ugly, you could prevent the formatter from messing with it by wrapping it with a comment line before and after, // @formatter:off and // @formatter:on.\nThis kind of simplification can be done in other places in this PR also (I made a review comment elsewhere where it can be a one-liner.", "url": "https://github.com/apache/accumulo/pull/1653#discussion_r488994638", "createdAt": "2020-09-15T21:44:25Z", "author": {"login": "ctubbsii"}, "path": "server/base/src/main/java/org/apache/accumulo/server/master/state/MetaDataStateStore.java", "diffHunk": "@@ -58,57 +54,31 @@ protected MetaDataStateStore(ClientContext context, CurrentState state, String t\n     return new MetaDataTableScanner(context, TabletsSection.getRange(), state, targetTableName);\n   }\n \n-  @Override\n   public void setLocations(Collection<Assignment> assignments) throws DistributedStoreException {\n-    BatchWriter writer = createBatchWriter();\n-    try {\n+    try (var tabletsMutator = ample.mutateTablets()) {\n       for (Assignment assignment : assignments) {\n-        Mutation m = new Mutation(assignment.tablet.toMetaRow());\n-        assignment.server.putLocation(m);\n-        assignment.server.clearFutureLocation(m);\n-        SuspendingTServer.clearSuspension(m);\n-        writer.addMutation(m);\n+        TabletMutator tabletMutator = tabletsMutator.mutateTablet(assignment.tablet);\n+        tabletMutator.putLocation(assignment.server, LocationType.CURRENT);\n+        tabletMutator.deleteLocation(assignment.server, LocationType.FUTURE);\n+        tabletMutator.mutate();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c3fa108ad6dbb53cbb05e4b15f5079ff0de8bfa"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODk5OTc5Ng==", "bodyText": "If all of these code blocks that were updated to use the Ample mutator utility don't throw any checked exceptions, these catch blocks can be updated to only catch the more specific, RuntimeException, as in:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                } catch (Exception ex) {\n          \n          \n            \n                } catch (RuntimeException ex) {", "url": "https://github.com/apache/accumulo/pull/1653#discussion_r488999796", "createdAt": "2020-09-15T21:50:31Z", "author": {"login": "ctubbsii"}, "path": "server/base/src/main/java/org/apache/accumulo/server/master/state/MetaDataStateStore.java", "diffHunk": "@@ -128,73 +98,56 @@ public void suspend(Collection<TabletLocationState> tablets,\n   private void unassign(Collection<TabletLocationState> tablets,\n       Map<TServerInstance,List<Path>> logsForDeadServers, long suspensionTimestamp)\n       throws DistributedStoreException {\n-    BatchWriter writer = createBatchWriter();\n-    try {\n+    try (var tabletsMutator = ample.mutateTablets()) {\n       for (TabletLocationState tls : tablets) {\n-        Mutation m = new Mutation(tls.extent.toMetaRow());\n+        TabletMutator tabletMutator = tabletsMutator.mutateTablet(tls.extent);\n         if (tls.current != null) {\n-          tls.current.clearLocation(m);\n+          tabletMutator.deleteLocation(tls.current, LocationType.CURRENT);\n           if (logsForDeadServers != null) {\n             List<Path> logs = logsForDeadServers.get(tls.current);\n             if (logs != null) {\n               for (Path log : logs) {\n                 LogEntry entry =\n                     new LogEntry(tls.extent, 0, tls.current.hostPort(), log.toString());\n-                m.put(entry.getColumnFamily(), entry.getColumnQualifier(), entry.getValue());\n+                tabletMutator.putWal(entry);\n               }\n             }\n           }\n           if (suspensionTimestamp >= 0) {\n-            SuspendingTServer suspender =\n-                new SuspendingTServer(tls.current.getLocation(), suspensionTimestamp);\n-            suspender.setSuspension(m);\n+            tabletMutator.putSuspension(tls.current, suspensionTimestamp);\n           }\n         }\n         if (tls.suspend != null && suspensionTimestamp < 0) {\n-          SuspendingTServer.clearSuspension(m);\n+          tabletMutator.deleteSuspension();\n         }\n         if (tls.future != null) {\n-          tls.future.clearFutureLocation(m);\n+          tabletMutator.deleteLocation(tls.future, LocationType.FUTURE);\n         }\n-        writer.addMutation(m);\n+        tabletMutator.mutate();\n       }\n     } catch (Exception ex) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c3fa108ad6dbb53cbb05e4b15f5079ff0de8bfa"}, "originalPosition": 147}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTAwMDc1OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    TabletMutator tabletMutator = tabletsMutator.mutateTablet(tls.extent);\n          \n          \n            \n                    tabletMutator.deleteSuspension();\n          \n          \n            \n                    tabletMutator.mutate();\n          \n          \n            \n                    tabletsMutator.mutateTablet(tls.extent).deleteSuspension().mutate();", "url": "https://github.com/apache/accumulo/pull/1653#discussion_r489000758", "createdAt": "2020-09-15T21:51:37Z", "author": {"login": "ctubbsii"}, "path": "server/base/src/main/java/org/apache/accumulo/server/master/state/MetaDataStateStore.java", "diffHunk": "@@ -128,73 +98,56 @@ public void suspend(Collection<TabletLocationState> tablets,\n   private void unassign(Collection<TabletLocationState> tablets,\n       Map<TServerInstance,List<Path>> logsForDeadServers, long suspensionTimestamp)\n       throws DistributedStoreException {\n-    BatchWriter writer = createBatchWriter();\n-    try {\n+    try (var tabletsMutator = ample.mutateTablets()) {\n       for (TabletLocationState tls : tablets) {\n-        Mutation m = new Mutation(tls.extent.toMetaRow());\n+        TabletMutator tabletMutator = tabletsMutator.mutateTablet(tls.extent);\n         if (tls.current != null) {\n-          tls.current.clearLocation(m);\n+          tabletMutator.deleteLocation(tls.current, LocationType.CURRENT);\n           if (logsForDeadServers != null) {\n             List<Path> logs = logsForDeadServers.get(tls.current);\n             if (logs != null) {\n               for (Path log : logs) {\n                 LogEntry entry =\n                     new LogEntry(tls.extent, 0, tls.current.hostPort(), log.toString());\n-                m.put(entry.getColumnFamily(), entry.getColumnQualifier(), entry.getValue());\n+                tabletMutator.putWal(entry);\n               }\n             }\n           }\n           if (suspensionTimestamp >= 0) {\n-            SuspendingTServer suspender =\n-                new SuspendingTServer(tls.current.getLocation(), suspensionTimestamp);\n-            suspender.setSuspension(m);\n+            tabletMutator.putSuspension(tls.current, suspensionTimestamp);\n           }\n         }\n         if (tls.suspend != null && suspensionTimestamp < 0) {\n-          SuspendingTServer.clearSuspension(m);\n+          tabletMutator.deleteSuspension();\n         }\n         if (tls.future != null) {\n-          tls.future.clearFutureLocation(m);\n+          tabletMutator.deleteLocation(tls.future, LocationType.FUTURE);\n         }\n-        writer.addMutation(m);\n+        tabletMutator.mutate();\n       }\n     } catch (Exception ex) {\n       throw new DistributedStoreException(ex);\n-    } finally {\n-      try {\n-        writer.close();\n-      } catch (MutationsRejectedException e) {\n-        throw new DistributedStoreException(e);\n-      }\n     }\n   }\n \n   @Override\n   public void unsuspend(Collection<TabletLocationState> tablets) throws DistributedStoreException {\n-    BatchWriter writer = createBatchWriter();\n-    try {\n+    try (var tabletsMutator = ample.mutateTablets()) {\n       for (TabletLocationState tls : tablets) {\n         if (tls.suspend != null) {\n           continue;\n         }\n-        Mutation m = new Mutation(tls.extent.toMetaRow());\n-        SuspendingTServer.clearSuspension(m);\n-        writer.addMutation(m);\n+        TabletMutator tabletMutator = tabletsMutator.mutateTablet(tls.extent);\n+        tabletMutator.deleteSuspension();\n+        tabletMutator.mutate();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c3fa108ad6dbb53cbb05e4b15f5079ff0de8bfa"}, "originalPosition": 172}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f02526af39d9cc05d237b6ea258c7ad3a629e29", "author": {"user": {"login": "Manno15", "name": "Jeffrey Manno"}}, "url": "https://github.com/apache/accumulo/commit/4f02526af39d9cc05d237b6ea258c7ad3a629e29", "committedDate": "2020-09-16T12:06:30Z", "message": "made more requested changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5NjU1MTc1", "url": "https://github.com/apache/accumulo/pull/1653#pullrequestreview-489655175", "createdAt": "2020-09-16T13:59:01Z", "commit": {"oid": "4f02526af39d9cc05d237b6ea258c7ad3a629e29"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1685, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}