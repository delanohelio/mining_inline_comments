{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxODAzMDk5", "number": 1568, "title": "Support multiple tservers / node in accumulo-service", "bodyText": "If NUM_TSERVERS is defined (typically by adding it in accumulo-env.sh\nthis modification to accumulo-service enables trivial support for\nrunning more than 1 tserver per node. Of course, the corresponding\nchanges in accumulo.properties (tserver.port.search and\nreplication.receipt.service.port) are still needed.", "createdAt": "2020-03-21T02:21:03Z", "url": "https://github.com/apache/accumulo/pull/1568", "merged": true, "mergeCommit": {"oid": "f27ade9abf6d907cee77a4b2c7ce81563782eef3"}, "closed": true, "closedAt": "2020-03-27T21:04:28Z", "author": {"login": "arvindshmicrosoft"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcPtyJhgFqTM3ODg5MjUwMg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcRtfD7gFqTM4MjcwNjYyMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4ODkyNTAy", "url": "https://github.com/apache/accumulo/pull/1568#pullrequestreview-378892502", "createdAt": "2020-03-21T04:55:27Z", "commit": {"oid": "dc35ce0c2e8d54747603af0e76b4fc831122eb10"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dc35ce0c2e8d54747603af0e76b4fc831122eb10", "author": {"user": {"login": "arvindshmicrosoft", "name": "Arvind Shyamsundar"}}, "url": "https://github.com/apache/accumulo/commit/dc35ce0c2e8d54747603af0e76b4fc831122eb10", "committedDate": "2020-03-21T02:14:36Z", "message": "Support multiple tservers / node in helper scripts\nIf NUM_TSERVERS is defined (typically by adding it in accumulo-env.sh\nthis modification to accumulo-service enables trivial support for\nrunning more than 1 tserver per node. Of course, the corresponding\nchanges in accumulo.properties (tserver.port.search and\nreplication.receipt.service.port) are still needed."}, "afterCommit": {"oid": "3d91d5c32960401df1d1c196213fc0184d9bade5", "author": {"user": {"login": "arvindshmicrosoft", "name": "Arvind Shyamsundar"}}, "url": "https://github.com/apache/accumulo/commit/3d91d5c32960401df1d1c196213fc0184d9bade5", "committedDate": "2020-03-25T01:17:56Z", "message": "Support multiple tservers / node in helper scripts\n\nEnhances accumulo-cluster to start multiple TServers / node if\nNUM_TSERVERS is exported (outside of accumulo-env.sh). Corresponding\nchanges in accumulo.properties (tserver.port.search and\nreplication.receipt.service.port) are still needed."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ff3ae3892f10f434433f878fe66f7122ab98a46", "author": {"user": {"login": "arvindshmicrosoft", "name": "Arvind Shyamsundar"}}, "url": "https://github.com/apache/accumulo/commit/4ff3ae3892f10f434433f878fe66f7122ab98a46", "committedDate": "2020-03-25T02:34:39Z", "message": "Support multiple tservers / node in helper scripts\n\nEnhances accumulo-cluster to start multiple TServers / node if\nNUM_TSERVERS is exported (outside of accumulo-env.sh). Corresponding\nchanges in accumulo.properties (tserver.port.search and\nreplication.receipt.service.port) are still needed."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3d91d5c32960401df1d1c196213fc0184d9bade5", "author": {"user": {"login": "arvindshmicrosoft", "name": "Arvind Shyamsundar"}}, "url": "https://github.com/apache/accumulo/commit/3d91d5c32960401df1d1c196213fc0184d9bade5", "committedDate": "2020-03-25T01:17:56Z", "message": "Support multiple tservers / node in helper scripts\n\nEnhances accumulo-cluster to start multiple TServers / node if\nNUM_TSERVERS is exported (outside of accumulo-env.sh). Corresponding\nchanges in accumulo.properties (tserver.port.search and\nreplication.receipt.service.port) are still needed."}, "afterCommit": {"oid": "4ff3ae3892f10f434433f878fe66f7122ab98a46", "author": {"user": {"login": "arvindshmicrosoft", "name": "Arvind Shyamsundar"}}, "url": "https://github.com/apache/accumulo/commit/4ff3ae3892f10f434433f878fe66f7122ab98a46", "committedDate": "2020-03-25T02:34:39Z", "message": "Support multiple tservers / node in helper scripts\n\nEnhances accumulo-cluster to start multiple TServers / node if\nNUM_TSERVERS is exported (outside of accumulo-env.sh). Corresponding\nchanges in accumulo.properties (tserver.port.search and\nreplication.receipt.service.port) are still needed."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxMjM0MTIy", "url": "https://github.com/apache/accumulo/pull/1568#pullrequestreview-381234122", "createdAt": "2020-03-25T15:00:34Z", "commit": {"oid": "4ff3ae3892f10f434433f878fe66f7122ab98a46"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxNTowMDozNFrOF7fV-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxNTowMDozNFrOF7fV-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzkyMzgzMg==", "bodyText": "Not sure the following will work, the thought is to make running on localhost and remote consistent.  Both ensuring the env var is not set when running the script.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                service_instance_cmd=\n          \n          \n            \n                service_instance_cmd=\"export ACCUMULO_SERVICE_INSTANCE=;\"", "url": "https://github.com/apache/accumulo/pull/1568#discussion_r397923832", "createdAt": "2020-03-25T15:00:34Z", "author": {"login": "keith-turner"}, "path": "assemble/bin/accumulo-cluster", "diffHunk": "@@ -100,15 +100,45 @@ function get_ip() {\n   echo \"$ip_addr\"\n }\n \n+function set_last_instance_id() {\n+  if [[ \"$service\" == \"tserver\" ]]; then\n+    last_instance_id=${NUM_TSERVERS:-1}\n+  else\n+    last_instance_id=1\n+  fi\n+}\n+\n+function set_service_instance_if_needed() {\n+  if [[ \"$service\" == \"tserver\" && ${NUM_TSERVERS:-1} > 1 ]]; then\n+    export ACCUMULO_SERVICE_INSTANCE=$inst_id\n+    service_instance_cmd=\"export ACCUMULO_SERVICE_INSTANCE=${inst_id};\"\n+  else\n+    export ACCUMULO_SERVICE_INSTANCE=\n+    service_instance_cmd=", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ff3ae3892f10f434433f878fe66f7122ab98a46"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxNDAwMTgx", "url": "https://github.com/apache/accumulo/pull/1568#pullrequestreview-381400181", "createdAt": "2020-03-25T17:57:40Z", "commit": {"oid": "4ff3ae3892f10f434433f878fe66f7122ab98a46"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxNzo1Nzo0MVrOF7nizg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxODoyMjo0N1rOF7oj7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA1ODE5MA==", "bodyText": "This mixes double equals and single equals. Both are equivalent in bash double-square braces, so it's fine either way, but it'd be nice to be consistent.", "url": "https://github.com/apache/accumulo/pull/1568#discussion_r398058190", "createdAt": "2020-03-25T17:57:41Z", "author": {"login": "ctubbsii"}, "path": "assemble/bin/accumulo-cluster", "diffHunk": "@@ -100,15 +100,45 @@ function get_ip() {\n   echo \"$ip_addr\"\n }\n \n+function set_last_instance_id() {\n+  if [[ \"$service\" == \"tserver\" ]]; then\n+    last_instance_id=${NUM_TSERVERS:-1}\n+  else\n+    last_instance_id=1\n+  fi\n+}\n+\n+function set_service_instance_if_needed() {\n+  if [[ \"$service\" == \"tserver\" && ${NUM_TSERVERS:-1} > 1 ]]; then\n+    export ACCUMULO_SERVICE_INSTANCE=$inst_id\n+    service_instance_cmd=\"export ACCUMULO_SERVICE_INSTANCE=${inst_id};\"\n+  else\n+    export ACCUMULO_SERVICE_INSTANCE=\n+    service_instance_cmd=\n+  fi\n+}\n+\n+function control_service() {\n+  set_last_instance_id\n+\n+  for (( inst_id=1; inst_id<=last_instance_id; inst_id++ ))\n+  do\n+    set_service_instance_if_needed\n+\n+    if [[ $host == localhost || $host = \"$(hostname -s)\" || $host = \"$(hostname -f)\" || $host = $(get_ip) ]] ; then", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ff3ae3892f10f434433f878fe66f7122ab98a46"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA2OTgzNQ==", "bodyText": "Could use a simple local variable here.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              set_last_instance_id\n          \n          \n            \n              local last_instance_id; last_instance_id=1\n          \n          \n            \n              [[ \"$service\" = \"tserver\" ]] && last_instance_id=${NUM_TSERVERS:-1}", "url": "https://github.com/apache/accumulo/pull/1568#discussion_r398069835", "createdAt": "2020-03-25T18:15:11Z", "author": {"login": "ctubbsii"}, "path": "assemble/bin/accumulo-cluster", "diffHunk": "@@ -100,15 +100,45 @@ function get_ip() {\n   echo \"$ip_addr\"\n }\n \n+function set_last_instance_id() {\n+  if [[ \"$service\" == \"tserver\" ]]; then\n+    last_instance_id=${NUM_TSERVERS:-1}\n+  else\n+    last_instance_id=1\n+  fi\n+}\n+\n+function set_service_instance_if_needed() {\n+  if [[ \"$service\" == \"tserver\" && ${NUM_TSERVERS:-1} > 1 ]]; then\n+    export ACCUMULO_SERVICE_INSTANCE=$inst_id\n+    service_instance_cmd=\"export ACCUMULO_SERVICE_INSTANCE=${inst_id};\"\n+  else\n+    export ACCUMULO_SERVICE_INSTANCE=\n+    service_instance_cmd=\n+  fi\n+}\n+\n+function control_service() {\n+  set_last_instance_id", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ff3ae3892f10f434433f878fe66f7122ab98a46"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA3MDU3Mw==", "bodyText": "This can be inline'd. It's only used once, and doesn't do much.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \n          \n          \n            \n            function set_last_instance_id() {\n          \n          \n            \n              if [[ \"$service\" == \"tserver\" ]]; then\n          \n          \n            \n                last_instance_id=${NUM_TSERVERS:-1}\n          \n          \n            \n              else\n          \n          \n            \n                last_instance_id=1\n          \n          \n            \n              fi\n          \n          \n            \n            }", "url": "https://github.com/apache/accumulo/pull/1568#discussion_r398070573", "createdAt": "2020-03-25T18:16:17Z", "author": {"login": "ctubbsii"}, "path": "assemble/bin/accumulo-cluster", "diffHunk": "@@ -100,15 +100,45 @@ function get_ip() {\n   echo \"$ip_addr\"\n }\n \n+function set_last_instance_id() {\n+  if [[ \"$service\" == \"tserver\" ]]; then\n+    last_instance_id=${NUM_TSERVERS:-1}\n+  else\n+    last_instance_id=1\n+  fi\n+}\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ff3ae3892f10f434433f878fe66f7122ab98a46"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA3MTE5NQ==", "bodyText": "Should use numeric greater-than comparison here, instead of ASCII lexical comparison:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              if [[ \"$service\" == \"tserver\" && ${NUM_TSERVERS:-1} > 1 ]]; then\n          \n          \n            \n              if [[ \"$service\" == \"tserver\" && ${NUM_TSERVERS:-1} -gt 1 ]]; then", "url": "https://github.com/apache/accumulo/pull/1568#discussion_r398071195", "createdAt": "2020-03-25T18:17:13Z", "author": {"login": "ctubbsii"}, "path": "assemble/bin/accumulo-cluster", "diffHunk": "@@ -100,15 +100,45 @@ function get_ip() {\n   echo \"$ip_addr\"\n }\n \n+function set_last_instance_id() {\n+  if [[ \"$service\" == \"tserver\" ]]; then\n+    last_instance_id=${NUM_TSERVERS:-1}\n+  else\n+    last_instance_id=1\n+  fi\n+}\n+\n+function set_service_instance_if_needed() {\n+  if [[ \"$service\" == \"tserver\" && ${NUM_TSERVERS:-1} > 1 ]]; then", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ff3ae3892f10f434433f878fe66f7122ab98a46"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA3MzEyNg==", "bodyText": "Instead of creating a second variable and exporting here, you can probably just execute it with the environment variable set for the execution:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  $SSH \"$host\" \"bash -c '${service_instance_cmd} ${bin}/accumulo-service \\\"$service\\\" \\\"$control_cmd\\\"'\"\n          \n          \n            \n                  $SSH \"$host\" \"bash -c 'ACCUMULO_SERVICE_INSTANCE='\"$ACCUMULO_SERVICE_INSTANCE\"' ${bin}/accumulo-service \\\"$service\\\" \\\"$control_cmd\\\"'\"", "url": "https://github.com/apache/accumulo/pull/1568#discussion_r398073126", "createdAt": "2020-03-25T18:20:07Z", "author": {"login": "ctubbsii"}, "path": "assemble/bin/accumulo-cluster", "diffHunk": "@@ -100,15 +100,45 @@ function get_ip() {\n   echo \"$ip_addr\"\n }\n \n+function set_last_instance_id() {\n+  if [[ \"$service\" == \"tserver\" ]]; then\n+    last_instance_id=${NUM_TSERVERS:-1}\n+  else\n+    last_instance_id=1\n+  fi\n+}\n+\n+function set_service_instance_if_needed() {\n+  if [[ \"$service\" == \"tserver\" && ${NUM_TSERVERS:-1} > 1 ]]; then\n+    export ACCUMULO_SERVICE_INSTANCE=$inst_id\n+    service_instance_cmd=\"export ACCUMULO_SERVICE_INSTANCE=${inst_id};\"\n+  else\n+    export ACCUMULO_SERVICE_INSTANCE=\n+    service_instance_cmd=\n+  fi\n+}\n+\n+function control_service() {\n+  set_last_instance_id\n+\n+  for (( inst_id=1; inst_id<=last_instance_id; inst_id++ ))\n+  do\n+    set_service_instance_if_needed\n+\n+    if [[ $host == localhost || $host = \"$(hostname -s)\" || $host = \"$(hostname -f)\" || $host = $(get_ip) ]] ; then\n+      \"${bin}/accumulo-service\" \"$service\" \"$control_cmd\"\n+    else\n+      $SSH \"$host\" \"bash -c '${service_instance_cmd} ${bin}/accumulo-service \\\"$service\\\" \\\"$control_cmd\\\"'\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ff3ae3892f10f434433f878fe66f7122ab98a46"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA3NDg2MQ==", "bodyText": "Could pass the arguments to the function instead of setting up global variables and picking them up in the function.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              control_service\n          \n          \n            \n              control_service start \"$@\"", "url": "https://github.com/apache/accumulo/pull/1568#discussion_r398074861", "createdAt": "2020-03-25T18:22:47Z", "author": {"login": "ctubbsii"}, "path": "assemble/bin/accumulo-cluster", "diffHunk": "@@ -100,15 +100,45 @@ function get_ip() {\n   echo \"$ip_addr\"\n }\n \n+function set_last_instance_id() {\n+  if [[ \"$service\" == \"tserver\" ]]; then\n+    last_instance_id=${NUM_TSERVERS:-1}\n+  else\n+    last_instance_id=1\n+  fi\n+}\n+\n+function set_service_instance_if_needed() {\n+  if [[ \"$service\" == \"tserver\" && ${NUM_TSERVERS:-1} > 1 ]]; then\n+    export ACCUMULO_SERVICE_INSTANCE=$inst_id\n+    service_instance_cmd=\"export ACCUMULO_SERVICE_INSTANCE=${inst_id};\"\n+  else\n+    export ACCUMULO_SERVICE_INSTANCE=\n+    service_instance_cmd=\n+  fi\n+}\n+\n+function control_service() {\n+  set_last_instance_id\n+\n+  for (( inst_id=1; inst_id<=last_instance_id; inst_id++ ))\n+  do\n+    set_service_instance_if_needed\n+\n+    if [[ $host == localhost || $host = \"$(hostname -s)\" || $host = \"$(hostname -f)\" || $host = $(get_ip) ]] ; then\n+      \"${bin}/accumulo-service\" \"$service\" \"$control_cmd\"\n+    else\n+      $SSH \"$host\" \"bash -c '${service_instance_cmd} ${bin}/accumulo-service \\\"$service\\\" \\\"$control_cmd\\\"'\"\n+    fi\n+  done\n+}\n+\n function start_service() {\n   host=\"$1\"\n   service=\"$2\"\n+  control_cmd=\"start\"\n \n-  if [[ $host == \"localhost\" || $host == $(hostname -f) || $host == $(hostname -s) || $host == $(get_ip) ]]; then\n-    \"${bin}/accumulo-service\" \"$service\" start\n-  else\n-    $SSH \"$host\" \"bash -c '${bin}/accumulo-service \\\"$service\\\" start'\"\n-  fi\n+  control_service", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ff3ae3892f10f434433f878fe66f7122ab98a46"}, "originalPosition": 47}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e2fa5f59396eca7eb86d0af02e169b60692fae8", "author": {"user": {"login": "arvindshmicrosoft", "name": "Arvind Shyamsundar"}}, "url": "https://github.com/apache/accumulo/commit/3e2fa5f59396eca7eb86d0af02e169b60692fae8", "committedDate": "2020-03-27T07:19:26Z", "message": "Address code review comments\n\n* Inline trivial functions within accumulo-cluster\n* Use numeric comparison correctly and double equals consistently\n* Efficiently pass ACCUMULO_SERVICE_INSTANCE to SSH connections\n* Adds accumulo.metrics.service.instance to accumulo-env.sh to ensure\n  that metrics for different TServers are correctly identified"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyNzA2NjIw", "url": "https://github.com/apache/accumulo/pull/1568#pullrequestreview-382706620", "createdAt": "2020-03-27T09:42:27Z", "commit": {"oid": "3e2fa5f59396eca7eb86d0af02e169b60692fae8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1903, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}