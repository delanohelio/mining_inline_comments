{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI5NzM1MjYx", "number": 1816, "title": "Fixes #1763 - Flaky test: SimpleTimerTest", "bodyText": "Did my best to resolve #1763. Replaced the assert statements with an if statement so that they could be repeated if they don't pass immediately. The test will repeat until passed or until the added timeout occurs. As suggested, I left the assert statement after the loop which verifies the thread pool size remains unchanged after the previous operations. Not sure if I should have kept the other asserts as well but I don't see the point if the same conditions were verified already. Please suggest any changes or improvements.", "createdAt": "2020-11-30T18:36:54Z", "url": "https://github.com/apache/accumulo/pull/1816", "merged": true, "mergeCommit": {"oid": "ca58658cce43d4758fe3b0dfcc0653cb11791850"}, "closed": true, "closedAt": "2020-11-30T22:14:29Z", "author": {"login": "DomGarguilo"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdhpQSXAH2gAyNTI5NzM1MjYxOjQwNjlhMmIyMWNkNmU0ZWQ4NTc0ZWY5NTc1YjNiZjNkNTJkOGFjMmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdhsqOmgFqTU0MTMyODUyNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4069a2b21cd6e4ed8574ef9575b3bf3d52d8ac2d", "author": {"user": {"login": "DomGarguilo", "name": "Dom G."}}, "url": "https://github.com/apache/accumulo/commit/4069a2b21cd6e4ed8574ef9575b3bf3d52d8ac2d", "committedDate": "2020-11-30T18:00:38Z", "message": "replaced asserts with loop to recheck test conditions if failed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd42721be45078e280da69275b8e6e391af0c301", "author": {"user": {"login": "DomGarguilo", "name": "Dom G."}}, "url": "https://github.com/apache/accumulo/commit/fd42721be45078e280da69275b8e6e391af0c301", "committedDate": "2020-11-30T18:06:54Z", "message": "removed unused import"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMjA0Mjk2", "url": "https://github.com/apache/accumulo/pull/1816#pullrequestreview-541204296", "createdAt": "2020-11-30T19:01:07Z", "commit": {"oid": "fd42721be45078e280da69275b8e6e391af0c301"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxOTowMTowOFrOH8JSvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxOTowMTowOFrOH8JSvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgyODg2Mw==", "bodyText": "This is the right strategy (albeit with a few extra parenthesis than necessary on that if statement \ud83d\ude09 )", "url": "https://github.com/apache/accumulo/pull/1816#discussion_r532828863", "createdAt": "2020-11-30T19:01:08Z", "author": {"login": "ctubbsii"}, "path": "server/base/src/test/java/org/apache/accumulo/server/util/time/SimpleTimerTest.java", "diffHunk": "@@ -98,11 +97,15 @@ public void testFailure() throws InterruptedException {\n     assertTrue(r.wasRun);\n   }\n \n-  @Test\n-  public void testSingleton() {\n-    assertEquals(1, SimpleTimer.getInstanceThreadPoolSize());\n-    SimpleTimer t2 = SimpleTimer.getInstance(2);\n-    assertSame(t, t2);\n+  @Test(timeout = 5000)\n+  public void testSingleton() throws InterruptedException {\n+    while (true) {\n+      SimpleTimer t2 = SimpleTimer.getInstance(2);\n+      if((SimpleTimer.getInstanceThreadPoolSize() == 1) && (t == t2)) {\n+        break;\n+      }\n+      Thread.sleep(PAD);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd42721be45078e280da69275b8e6e391af0c301"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3460b860c0917138733b58748efd783a05bb6f7b", "author": {"user": {"login": "DomGarguilo", "name": "Dom G."}}, "url": "https://github.com/apache/accumulo/commit/3460b860c0917138733b58748efd783a05bb6f7b", "committedDate": "2020-11-30T20:53:28Z", "message": "added loop to most of the tests to catch false fails"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMzEzMzA4", "url": "https://github.com/apache/accumulo/pull/1816#pullrequestreview-541313308", "createdAt": "2020-11-30T21:35:02Z", "commit": {"oid": "3460b860c0917138733b58748efd783a05bb6f7b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQyMTozNTowMlrOH8OwNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQyMTozNTowMlrOH8OwNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkxODMyNQ==", "bodyText": "Just realized that you can simplify this to while (i.get() != 1) { sleep }; you can do similar things for the other tests as well.", "url": "https://github.com/apache/accumulo/pull/1816#discussion_r532918325", "createdAt": "2020-11-30T21:35:02Z", "author": {"login": "ctubbsii"}, "path": "server/base/src/test/java/org/apache/accumulo/server/util/time/SimpleTimerTest.java", "diffHunk": "@@ -70,35 +69,50 @@ public void run() {\n     }\n   }\n \n-  @Test\n+  @Test(timeout = 5000)\n   public void testOneTimeSchedule() throws InterruptedException {\n     AtomicInteger i = new AtomicInteger();\n     Incrementer r = new Incrementer(i);\n     t.schedule(r, DELAY);\n     Thread.sleep(DELAY + PAD);\n-    assertEquals(1, i.get());\n+    while (true) {\n+      if (i.get() == 1) {\n+        break;\n+      }\n+      Thread.sleep(PAD);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3460b860c0917138733b58748efd783a05bb6f7b"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf59109738368655564888a6f37821c2a53fbec4", "author": {"user": {"login": "DomGarguilo", "name": "Dom G."}}, "url": "https://github.com/apache/accumulo/commit/cf59109738368655564888a6f37821c2a53fbec4", "committedDate": "2020-11-30T21:50:48Z", "message": "Simplified the while loops."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMzI4NTI1", "url": "https://github.com/apache/accumulo/pull/1816#pullrequestreview-541328525", "createdAt": "2020-11-30T21:58:41Z", "commit": {"oid": "cf59109738368655564888a6f37821c2a53fbec4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1661, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}