{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI4MDEwNjcw", "number": 1622, "title": "fixes #1621: The ClientPool thread pool allows all core threads to time out", "bodyText": "Added properties to allow overridding the allowCoreThreadTimeout in\nvarious threadpools: master incoming requests, tserver incoming requests, master bulk imports", "createdAt": "2020-06-04T18:20:26Z", "url": "https://github.com/apache/accumulo/pull/1622", "merged": true, "mergeCommit": {"oid": "9c4f732e56f7d52f7969ad4a95904c51877ddc56"}, "closed": true, "closedAt": "2020-07-07T14:57:09Z", "author": {"login": "ivakegg"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcoCNWtgH2gAyNDI4MDEwNjcwOmRiZmFiMDFhMzllN2JjNmFjOTJmODY0MWZjNGIxYzBmMGMyMjAzOWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcylkmzAH2gAyNDI4MDEwNjcwOjNlZThkYzJiNmZhYzYyODc2NTI5NDI4NjNlOTk5YjljYTY5NGJmYjA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "dbfab01a39e7bc6ac92f8641fc4b1c0f0c22039f", "author": {"user": {"login": "ivakegg", "name": "Ivan Bella"}}, "url": "https://github.com/apache/accumulo/commit/dbfab01a39e7bc6ac92f8641fc4b1c0f0c22039f", "committedDate": "2020-06-04T18:17:27Z", "message": "fixes #1621: The ClientPool thread pool allows all core threads to time out\n  * Added properties to allow overridding the allowCoreThreadTimeout in\n    various threadpools: master incoming requests, tserver incoming requests, master bulk imports"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0NzI1Nzk0", "url": "https://github.com/apache/accumulo/pull/1622#pullrequestreview-424725794", "createdAt": "2020-06-04T18:34:13Z", "commit": {"oid": "dbfab01a39e7bc6ac92f8641fc4b1c0f0c22039f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQxODozNDoxM1rOGfS19Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQxODozNDoxM1rOGfS19Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ2Nzc2NQ==", "bodyText": "The default of true maintains the current behavior, however that behavior seemed problematic in the issue you opened.  Makes me wonder if the default should be false.", "url": "https://github.com/apache/accumulo/pull/1622#discussion_r435467765", "createdAt": "2020-06-04T18:34:13Z", "author": {"login": "keith-turner"}, "path": "core/src/main/java/org/apache/accumulo/core/conf/Property.java", "diffHunk": "@@ -452,6 +458,9 @@\n       \"The time to wait for a tablet server to process a bulk import request.\"),\n   TSERV_MINTHREADS(\"tserver.server.threads.minimum\", \"20\", PropertyType.COUNT,\n       \"The minimum number of threads to use to handle incoming requests.\"),\n+  TSERV_MINTHREADS_ALLOW_TIMEOUT(\"tserver.server.thread.timeout.allowed\", \"true\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dbfab01a39e7bc6ac92f8641fc4b1c0f0c22039f"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d6991afc9c9589b829c2b9677a47e85586cc5aa", "author": {"user": {"login": "ivakegg", "name": "Ivan Bella"}}, "url": "https://github.com/apache/accumulo/commit/4d6991afc9c9589b829c2b9677a47e85586cc5aa", "committedDate": "2020-06-05T12:43:15Z", "message": "re #1621: Changed the default to \"false\" for the ...ALLOW_TIMEOUT properties"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2NDM0MTAz", "url": "https://github.com/apache/accumulo/pull/1622#pullrequestreview-426434103", "createdAt": "2020-06-08T16:57:54Z", "commit": {"oid": "4d6991afc9c9589b829c2b9677a47e85586cc5aa"}, "state": "APPROVED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxNjo1Nzo1NFrOGgnf4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxNzowMzoxNVrOGgnrtA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg1NDc1Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              TSERV_MINTHREADS_ALLOW_TIMEOUT(\"tserver.server.thread.timeout.allowed\", \"false\",\n          \n          \n            \n              TSERV_MINTHREADS_ALLOW_TIMEOUT(\"tserver.server.threads.timeout.allowed\", \"false\",", "url": "https://github.com/apache/accumulo/pull/1622#discussion_r436854753", "createdAt": "2020-06-08T16:57:54Z", "author": {"login": "keith-turner"}, "path": "core/src/main/java/org/apache/accumulo/core/conf/Property.java", "diffHunk": "@@ -452,6 +458,9 @@\n       \"The time to wait for a tablet server to process a bulk import request.\"),\n   TSERV_MINTHREADS(\"tserver.server.threads.minimum\", \"20\", PropertyType.COUNT,\n       \"The minimum number of threads to use to handle incoming requests.\"),\n+  TSERV_MINTHREADS_ALLOW_TIMEOUT(\"tserver.server.thread.timeout.allowed\", \"false\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d6991afc9c9589b829c2b9677a47e85586cc5aa"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg1NDk0Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              MASTER_MINTHREADS_ALLOW_TIMEOUT(\"master.server.thread.timeout.allowed\", \"false\",\n          \n          \n            \n              MASTER_MINTHREADS_ALLOW_TIMEOUT(\"master.server.threads.timeout.allowed\", \"false\",", "url": "https://github.com/apache/accumulo/pull/1622#discussion_r436854946", "createdAt": "2020-06-08T16:58:14Z", "author": {"login": "keith-turner"}, "path": "core/src/main/java/org/apache/accumulo/core/conf/Property.java", "diffHunk": "@@ -259,6 +262,9 @@\n       \"Regular expression that defines the set of Tablet Servers that will perform bulk imports\"),\n   MASTER_MINTHREADS(\"master.server.threads.minimum\", \"20\", PropertyType.COUNT,\n       \"The minimum number of threads to use to handle incoming requests.\"),\n+  MASTER_MINTHREADS_ALLOW_TIMEOUT(\"master.server.thread.timeout.allowed\", \"false\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d6991afc9c9589b829c2b9677a47e85586cc5aa"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg1NTIwMA==", "bodyText": "To me making the property perfix the same as far as possible with the existing prop provides a clue that these two props go together.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              MASTER_BULK_THREADPOOL_ALLOW_TIMEOUT(\"master.bulk.thread.timeout.allowed\", \"false\",\n          \n          \n            \n              MASTER_BULK_THREADPOOL_ALLOW_TIMEOUT(\"master.bulk.threadpool.timeout.allowed\", \"false\",", "url": "https://github.com/apache/accumulo/pull/1622#discussion_r436855200", "createdAt": "2020-06-08T16:58:42Z", "author": {"login": "keith-turner"}, "path": "core/src/main/java/org/apache/accumulo/core/conf/Property.java", "diffHunk": "@@ -246,6 +246,9 @@\n       \"The number of attempts to bulk import a RFile before giving up.\"),\n   MASTER_BULK_THREADPOOL_SIZE(\"master.bulk.threadpool.size\", \"5\", PropertyType.COUNT,\n       \"The number of threads to use when coordinating a bulk import.\"),\n+  MASTER_BULK_THREADPOOL_ALLOW_TIMEOUT(\"master.bulk.thread.timeout.allowed\", \"false\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d6991afc9c9589b829c2b9677a47e85586cc5aa"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg1NzU5MQ==", "bodyText": "While we are examining this code, I think it would be a good idea to increase this timeout to a few minutes and use a a private constant.   Maybe 3 to 5 mins.  Could do private static final   TIMEOUT_SECS=180\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                super(coreAndMax, coreAndMax, 4L, TimeUnit.SECONDS, queue, new NamingThreadFactory(name));\n          \n          \n            \n                super(coreAndMax, coreAndMax, TIMEOUT_SECS, TimeUnit.SECONDS, queue, new NamingThreadFactory(name));", "url": "https://github.com/apache/accumulo/pull/1622#discussion_r436857591", "createdAt": "2020-06-08T17:02:57Z", "author": {"login": "keith-turner"}, "path": "core/src/main/java/org/apache/accumulo/core/util/SimpleThreadPool.java", "diffHunk": "@@ -28,15 +28,16 @@\n  */\n public class SimpleThreadPool extends ThreadPoolExecutor {\n \n-  public SimpleThreadPool(int max, final String name) {\n-    super(max, max, 4L, TimeUnit.SECONDS, new LinkedBlockingQueue<>(),\n+  public SimpleThreadPool(int coreAndMax, boolean allowCoreThreadTimeOut, final String name) {\n+    super(coreAndMax, coreAndMax, 4L, TimeUnit.SECONDS, new LinkedBlockingQueue<>(),\n         new NamingThreadFactory(name));\n-    allowCoreThreadTimeOut(true);\n+    allowCoreThreadTimeOut(allowCoreThreadTimeOut);\n   }\n \n-  public SimpleThreadPool(int max, final String name, BlockingQueue<Runnable> queue) {\n-    super(max, max, 4L, TimeUnit.SECONDS, queue, new NamingThreadFactory(name));\n-    allowCoreThreadTimeOut(true);\n+  public SimpleThreadPool(int coreAndMax, boolean allowCoreThreadTimeOut, final String name,\n+      BlockingQueue<Runnable> queue) {\n+    super(coreAndMax, coreAndMax, 4L, TimeUnit.SECONDS, queue, new NamingThreadFactory(name));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d6991afc9c9589b829c2b9677a47e85586cc5aa"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg1Nzc4MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                super(coreAndMax, coreAndMax, 4L, TimeUnit.SECONDS, new LinkedBlockingQueue<>(),\n          \n          \n            \n                super(coreAndMax, coreAndMax, TIMEOUT_SECS, TimeUnit.SECONDS, new LinkedBlockingQueue<>(),", "url": "https://github.com/apache/accumulo/pull/1622#discussion_r436857780", "createdAt": "2020-06-08T17:03:15Z", "author": {"login": "keith-turner"}, "path": "core/src/main/java/org/apache/accumulo/core/util/SimpleThreadPool.java", "diffHunk": "@@ -28,15 +28,16 @@\n  */\n public class SimpleThreadPool extends ThreadPoolExecutor {\n \n-  public SimpleThreadPool(int max, final String name) {\n-    super(max, max, 4L, TimeUnit.SECONDS, new LinkedBlockingQueue<>(),\n+  public SimpleThreadPool(int coreAndMax, boolean allowCoreThreadTimeOut, final String name) {\n+    super(coreAndMax, coreAndMax, 4L, TimeUnit.SECONDS, new LinkedBlockingQueue<>(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d6991afc9c9589b829c2b9677a47e85586cc5aa"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxNDgwMjY2", "url": "https://github.com/apache/accumulo/pull/1622#pullrequestreview-431480266", "createdAt": "2020-06-16T13:05:04Z", "commit": {"oid": "4d6991afc9c9589b829c2b9677a47e85586cc5aa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxMzowNTowNVrOGkaTvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxMzowNTowNVrOGkaTvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgzMjk1Nw==", "bodyText": "minor nit: I think this is a great set of features; however, I had a question about the wording. \"True... if... allowed\" made me think another setting would impact this, but I imagine it is the case that if this is true then timeouts can occur.\n\"Allows request threads to time out when no work is available\" might be more clear but @keith-turner spent more time here so he can likely correct me from his perspective -- and it may be the case that my interpretation is wrong.", "url": "https://github.com/apache/accumulo/pull/1622#discussion_r440832957", "createdAt": "2020-06-16T13:05:05Z", "author": {"login": "phrocker"}, "path": "core/src/main/java/org/apache/accumulo/core/conf/Property.java", "diffHunk": "@@ -452,6 +458,9 @@\n       \"The time to wait for a tablet server to process a bulk import request.\"),\n   TSERV_MINTHREADS(\"tserver.server.threads.minimum\", \"20\", PropertyType.COUNT,\n       \"The minimum number of threads to use to handle incoming requests.\"),\n+  TSERV_MINTHREADS_ALLOW_TIMEOUT(\"tserver.server.thread.timeout.allowed\", \"false\",\n+      PropertyType.BOOLEAN,\n+      \"True if the incoming request threads are allowed to timeout with no work available.\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d6991afc9c9589b829c2b9677a47e85586cc5aa"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b7c4662406ade21d50ada9add35a2576809205b", "author": {"user": {"login": "ivakegg", "name": "Ivan Bella"}}, "url": "https://github.com/apache/accumulo/commit/6b7c4662406ade21d50ada9add35a2576809205b", "committedDate": "2020-06-23T14:20:32Z", "message": "Update core/src/main/java/org/apache/accumulo/core/conf/Property.java\n\nCo-authored-by: Keith Turner <kturner@apache.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d02af53a2b23df64b5b808553222bfbe876b9c95", "author": {"user": {"login": "ivakegg", "name": "Ivan Bella"}}, "url": "https://github.com/apache/accumulo/commit/d02af53a2b23df64b5b808553222bfbe876b9c95", "committedDate": "2020-06-23T14:20:40Z", "message": "Update core/src/main/java/org/apache/accumulo/core/conf/Property.java\n\nCo-authored-by: Keith Turner <kturner@apache.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f43f0eea064723e58ae7152e5b9718b845314b9", "author": {"user": {"login": "ivakegg", "name": "Ivan Bella"}}, "url": "https://github.com/apache/accumulo/commit/8f43f0eea064723e58ae7152e5b9718b845314b9", "committedDate": "2020-06-23T14:20:47Z", "message": "Update core/src/main/java/org/apache/accumulo/core/conf/Property.java\n\nCo-authored-by: Keith Turner <kturner@apache.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3bfd3b1bd0f5758ab02b49f176adfbcc302266b9", "author": {"user": {"login": "ivakegg", "name": "Ivan Bella"}}, "url": "https://github.com/apache/accumulo/commit/3bfd3b1bd0f5758ab02b49f176adfbcc302266b9", "committedDate": "2020-06-23T15:50:15Z", "message": "re #1621: Increased the thread pool timeout."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "748ebbcdc8aa24db501c0d4f5df7afcb8ec85993", "author": {"user": {"login": "ivakegg", "name": "Ivan Bella"}}, "url": "https://github.com/apache/accumulo/commit/748ebbcdc8aa24db501c0d4f5df7afcb8ec85993", "committedDate": "2020-06-23T16:00:51Z", "message": "re #1621: refine property description"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1OTU0NjE0", "url": "https://github.com/apache/accumulo/pull/1622#pullrequestreview-435954614", "createdAt": "2020-06-23T16:29:54Z", "commit": {"oid": "748ebbcdc8aa24db501c0d4f5df7afcb8ec85993"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7d70a6a0d2c3f859e3299831812ae30cec27e95", "author": {"user": {"login": "ivakegg", "name": "Ivan Bella"}}, "url": "https://github.com/apache/accumulo/commit/c7d70a6a0d2c3f859e3299831812ae30cec27e95", "committedDate": "2020-07-01T19:37:10Z", "message": "re #1621: Changed the mechanism to supply a timeout property instead of allow_timeout boolean"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMjA5NTA2", "url": "https://github.com/apache/accumulo/pull/1622#pullrequestreview-441209506", "createdAt": "2020-07-01T21:30:16Z", "commit": {"oid": "c7d70a6a0d2c3f859e3299831812ae30cec27e95"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMTozMDoxNlrOGr1_Ww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMTo0NDoyOVrOGr2V1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYyNjUyMw==", "bodyText": "Would it work to only do the following in the constructor?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                super(coreAndMax, coreAndMax, threadTimeOut, TimeUnit.MILLISECONDS, new LinkedBlockingQueue<>(),\n          \n          \n            \n                this(coreAndMax, threadTimeOut, name, new LinkedBlockingQueue<>());", "url": "https://github.com/apache/accumulo/pull/1622#discussion_r448626523", "createdAt": "2020-07-01T21:30:16Z", "author": {"login": "keith-turner"}, "path": "core/src/main/java/org/apache/accumulo/core/util/SimpleThreadPool.java", "diffHunk": "@@ -28,15 +28,32 @@\n  */\n public class SimpleThreadPool extends ThreadPoolExecutor {\n \n-  public SimpleThreadPool(int max, final String name) {\n-    super(max, max, 4L, TimeUnit.SECONDS, new LinkedBlockingQueue<>(),\n+  // the number of seconds before we allow a thread to terminate with non-use.\n+  public static final long DEFAULT_TIMEOUT_MILLISECS = 180000L;\n+\n+  public SimpleThreadPool(int coreAndMax, final String name) {\n+    this(coreAndMax, DEFAULT_TIMEOUT_MILLISECS, name);\n+  }\n+\n+  public SimpleThreadPool(int coreAndMax, long threadTimeOut, final String name) {\n+    super(coreAndMax, coreAndMax, threadTimeOut, TimeUnit.MILLISECONDS, new LinkedBlockingQueue<>(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c7d70a6a0d2c3f859e3299831812ae30cec27e95"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYzMjI3OQ==", "bodyText": "I was trying to ensure the parameter order was correct when looking at this PR.  Once I realized you had consistently put the timeout after the number of threads here and elsewhere it made verifying the order much easier.", "url": "https://github.com/apache/accumulo/pull/1622#discussion_r448632279", "createdAt": "2020-07-01T21:44:29Z", "author": {"login": "keith-turner"}, "path": "server/base/src/main/java/org/apache/accumulo/server/rpc/TServerUtils.java", "diffHunk": "@@ -231,8 +236,8 @@ public static ServerAddress startServer(MetricsSystem metricsSystem, ServerConte\n    */\n   public static ServerAddress createThreadedSelectorServer(HostAndPort address,\n       TProcessor processor, TProtocolFactory protocolFactory, final String serverName,\n-      final int numThreads, final int numSTThreads, long timeBetweenThreadChecks,\n-      long maxMessageSize) throws TTransportException {\n+      final int numThreads, final long threadTimeOut, final int numSTThreads,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c7d70a6a0d2c3f859e3299831812ae30cec27e95"}, "originalPosition": 53}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ee8dc2b6fac6287652942863e999b9ca694bfb0", "author": {"user": {"login": "ivakegg", "name": "Ivan Bella"}}, "url": "https://github.com/apache/accumulo/commit/3ee8dc2b6fac6287652942863e999b9ca694bfb0", "committedDate": "2020-07-07T13:08:46Z", "message": "re #1621: Simplified constructors in the SimpleThreadPool"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1968, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}