{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk0MTk2NjUy", "number": 1572, "title": "Refactor use of ServerConfigurationFactory", "bodyText": "Divided this PR into 2 commits:\n1 - Deprecates the init method in MemoryManager that took ServerConfigurationFactory as a parameter.  Replace it with a method that takes ServerContext.  Updated Test to mock ServerContext.\n2 -  Inline some of the methods of ServerConfigurationFactory into ServerContext to reduce references to it.  Removed sychronization on the methods now they are a part of ServerContext because i don't think its needed since each server should only have one instance.  This is just a first step into eliminating internal use of ServerConfigurationFactory.\nUpdate: Broke out changes to MemoryManager in a separate branch.", "createdAt": "2020-03-26T14:14:22Z", "url": "https://github.com/apache/accumulo/pull/1572", "merged": true, "mergeCommit": {"oid": "58e70870db8e1600ee860c984e062efaeac7e4e6"}, "closed": true, "closedAt": "2020-04-08T12:38:13Z", "author": {"login": "milleruntime"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcRcz7DgFqTM4MjA1MjEzNw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcR21Y5gBqjMxNzQwMTI0Mzc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyMDUyMTM3", "url": "https://github.com/apache/accumulo/pull/1572#pullrequestreview-382052137", "createdAt": "2020-03-26T14:16:50Z", "commit": {"oid": "48bd7946a89508b6fc5c87e510d30d61887fa3cf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNDoxNjo1MFrOF8JClQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNDoxNjo1MFrOF8JClQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODYwNjk5Nw==", "bodyText": "Method was never used.", "url": "https://github.com/apache/accumulo/pull/1572#discussion_r398606997", "createdAt": "2020-03-26T14:16:50Z", "author": {"login": "milleruntime"}, "path": "server/base/src/main/java/org/apache/accumulo/server/conf/TableConfiguration.java", "diffHunk": "@@ -140,13 +140,6 @@ public TableId getTableId() {\n     return tableId;\n   }\n \n-  /**\n-   * returns the actual NamespaceConfiguration that corresponds to the current parent namespace.\n-   */\n-  public NamespaceConfiguration getNamespaceConfiguration() {\n-    return context.getServerConfFactory().getNamespaceConfiguration(parent.namespaceId);\n-  }\n-", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48bd7946a89508b6fc5c87e510d30d61887fa3cf"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyMTM3OTA1", "url": "https://github.com/apache/accumulo/pull/1572#pullrequestreview-382137905", "createdAt": "2020-03-26T15:40:49Z", "commit": {"oid": "efb503ac50fe6b0a424006f3449316d755313d9b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNTo0MDo0OVrOF8NH_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNTo0MDo0OVrOF8NH_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY3MzkxOA==", "bodyText": "Another option for this update would be to call the new init method:\ninit(((ServerConfigurationFactory) conf).getServerContext());\nBut I put the exception to prevent calling this in Accumulo.  If a user extends this class, I don't think they should be calling this method.  The init currently gets called in TabletServerResourceManager here.", "url": "https://github.com/apache/accumulo/pull/1572#discussion_r398673918", "createdAt": "2020-03-26T15:40:49Z", "author": {"login": "milleruntime"}, "path": "server/base/src/main/java/org/apache/accumulo/server/tabletserver/LargestFirstMemoryManager.java", "diffHunk": "@@ -121,18 +122,16 @@ public void remove(Long key) {\n     }\n   }\n \n-  LargestFirstMemoryManager(long maxMemory, int maxConcurrentMincs, int numWaitingMultiplier) {\n-    this();\n-    this.maxMemory = maxMemory;\n-    this.maxConcurrentMincs = maxConcurrentMincs;\n-    this.numWaitingMultiplier = numWaitingMultiplier;\n+  @Override\n+  public void init(ServerConfiguration conf) {\n+    throw new IllegalStateException(\"Deprecated method, no longer should be used.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "efb503ac50fe6b0a424006f3449316d755313d9b"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzMDg5ODA5", "url": "https://github.com/apache/accumulo/pull/1572#pullrequestreview-383089809", "createdAt": "2020-03-27T18:05:41Z", "commit": {"oid": "1824acdfed11fd8d8aebc3d09e3c752470dc7833"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxODowNTo0MVrOF88dcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxODoyMzo0OVrOF89FPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ0OTQ1Nw==", "bodyText": "I don't think there's any reason to load this singleton lazily.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (defaultConfig == null) {\n          \n          \n            \n                  defaultConfig = DefaultConfiguration.getInstance();\n          \n          \n            \n                }\n          \n          \n            \n                return defaultConfig;\n          \n          \n            \n                return DefaultConfiguration.getInstance();", "url": "https://github.com/apache/accumulo/pull/1572#discussion_r399449457", "createdAt": "2020-03-27T18:05:41Z", "author": {"login": "ctubbsii"}, "path": "server/base/src/main/java/org/apache/accumulo/server/ServerContext.java", "diffHunk": "@@ -112,7 +125,26 @@ public synchronized ServerConfigurationFactory getServerConfFactory() {\n \n   @Override\n   public AccumuloConfiguration getConfiguration() {\n-    return getServerConfFactory().getSystemConfiguration();\n+    if (systemConfig == null) {\n+      ZooCache propCache = new ZooCache(getZooKeepers(), getZooKeepersSessionTimeOut());\n+      systemConfig = new ZooConfiguration(this, propCache, getSiteConfiguration());\n+    }\n+    return systemConfig;\n+  }\n+\n+  public TableConfiguration getTableConfiguration(TableId id) {\n+    return getServerConfFactory().getTableConfiguration(id);\n+  }\n+\n+  public NamespaceConfiguration getNamespaceConfiguration(NamespaceId namespaceId) {\n+    return getServerConfFactory().getNamespaceConfiguration(namespaceId);\n+  }\n+\n+  public DefaultConfiguration getDefaultConfiguration() {\n+    if (defaultConfig == null) {\n+      defaultConfig = DefaultConfiguration.getInstance();\n+    }\n+    return defaultConfig;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1824acdfed11fd8d8aebc3d09e3c752470dc7833"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ1ODYwOA==", "bodyText": "I'd add the note about scheduled for removal in this javadoc tag also.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * @deprecated since 2.1 use {@link #init(ServerContext)}\n          \n          \n            \n               * @deprecated since 2.1 use {@link #init(ServerContext)}; to be removed in 3.0.0", "url": "https://github.com/apache/accumulo/pull/1572#discussion_r399458608", "createdAt": "2020-03-27T18:22:03Z", "author": {"login": "ctubbsii"}, "path": "server/base/src/main/java/org/apache/accumulo/server/tabletserver/MemoryManager.java", "diffHunk": "@@ -32,8 +33,22 @@\n \n   /**\n    * Initialize the memory manager.\n+   *\n+   * @deprecated since 2.1 use {@link #init(ServerContext)}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1824acdfed11fd8d8aebc3d09e3c752470dc7833"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ1OTY0Nw==", "bodyText": "My only concern with this is that context is not public API any more than ServerConfiguration was. The object has already changed from a ServerConfiguration object to a ServerConfigurationFactory object (which implemented ServerConfiguration, just to make this API happy), and now ServerContext.\nWhile it's unlikely that too many people have implemented their own MemoryManager, it is configurable, and this churn in the API isn't good for implementers. I think it would be cool if we could follow up on this PR with one that promotes this interface to SPI, and uses a stable MemoryManagerEnvironment object to inject here in place of the internal ServerContext.", "url": "https://github.com/apache/accumulo/pull/1572#discussion_r399459647", "createdAt": "2020-03-27T18:23:49Z", "author": {"login": "ctubbsii"}, "path": "server/base/src/main/java/org/apache/accumulo/server/tabletserver/MemoryManager.java", "diffHunk": "@@ -32,8 +33,22 @@\n \n   /**\n    * Initialize the memory manager.\n+   *\n+   * @deprecated since 2.1 use {@link #init(ServerContext)}\n+   */\n+  @Deprecated\n+  default void init(ServerConfiguration conf) {\n+    throw new IllegalStateException(\"Deprecated method scheduled for removal in 3.0.0\");\n+  }\n+\n+  /**\n+   * Initialize the memory manager.\n+   *\n+   * @param context\n+   *          ServerContext passed from the Tablet server\n+   * @since 2.1\n    */\n-  void init(ServerConfiguration conf);\n+  void init(ServerContext context);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1824acdfed11fd8d8aebc3d09e3c752470dc7833"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e23a904f0ffc85c1a41e40e4d4c118e4c2ed74e9", "author": {"user": {"login": "milleruntime", "name": "Mike Miller"}}, "url": "https://github.com/apache/accumulo/commit/e23a904f0ffc85c1a41e40e4d4c118e4c2ed74e9", "committedDate": "2020-03-27T19:42:07Z", "message": "Minimize calls to ServerConfFactory by inlining methods in ServerContext"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f95bc5e65fdbea41b7889b79672d3106e50b896", "author": {"user": {"login": "milleruntime", "name": "Mike Miller"}}, "url": "https://github.com/apache/accumulo/commit/7f95bc5e65fdbea41b7889b79672d3106e50b896", "committedDate": "2020-03-27T20:25:06Z", "message": "Fix TableLoadBalancerTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "68aa1070afd576c45c7b98d36d98766dd62d847e", "author": {"user": {"login": "milleruntime", "name": "Mike Miller"}}, "url": "https://github.com/apache/accumulo/commit/68aa1070afd576c45c7b98d36d98766dd62d847e", "committedDate": "2020-03-27T20:25:06Z", "message": "Fix 2 more tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a2d1daa42c061e3c7014a669dbe8d2a69122d1ef", "author": {"user": {"login": "milleruntime", "name": "Mike Miller"}}, "url": "https://github.com/apache/accumulo/commit/a2d1daa42c061e3c7014a669dbe8d2a69122d1ef", "committedDate": "2020-03-27T18:44:29Z", "message": "Update server/base/src/main/java/org/apache/accumulo/server/tabletserver/MemoryManager.java\n\nCo-Authored-By: Christopher Tubbs <ctubbsii@apache.org>"}, "afterCommit": {"oid": "68aa1070afd576c45c7b98d36d98766dd62d847e", "author": {"user": {"login": "milleruntime", "name": "Mike Miller"}}, "url": "https://github.com/apache/accumulo/commit/68aa1070afd576c45c7b98d36d98766dd62d847e", "committedDate": "2020-03-27T20:25:06Z", "message": "Fix 2 more tests"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1909, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}