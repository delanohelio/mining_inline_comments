{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE2OTA5NjA1", "number": 1771, "title": "Add tablename option to shell insert command.", "bodyText": "This change adds the --tablename option to the insert command when inside the shell or when using the accumulo command with accumulo shell -e <task>. The option is not required, but if used it allows data to be inserted into a table in situations where the shell is not within a table context or when in a table context to insert data into another table.\nAlthough I would not expect this option to be utilized very often, I found myself in need of it when working with the various accumulo examples in the accumulo-examples repo. I had many situations where I wished to insert some test data from a bash shell using the form:\naccumulo shell -u user -p pwd -e \"insert r f q v\"\nbut this would fail due to there being no table name context for the insertion. This update allows data inserts from a command line using the form:\naccumulo shell -u user -p pwd -e \"insert r f q v --tablename destination_table\" \nNote, there is no shortened form of the option to minimize confusion with the -ts option.", "createdAt": "2020-11-06T18:25:43Z", "url": "https://github.com/apache/accumulo/pull/1771", "merged": true, "mergeCommit": {"oid": "7e563c8e9ef94991efe3fde12f48b2e8e68cd964"}, "closed": true, "closedAt": "2020-11-10T16:51:34Z", "author": {"login": "jmark99"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZ61SBAH2gAyNTE2OTA5NjA1OjM3MjFjNDNlNjNlNTMxMTY2NzZkOTZiYzBkODkxYTZhY2JhM2QwMTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbMJYhAFqTUyNzM5NjE5OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3721c43e63e53116676d96bc0d891a6acba3d013", "author": {"user": {"login": "jmark99", "name": "Mark Owens"}}, "url": "https://github.com/apache/accumulo/commit/3721c43e63e53116676d96bc0d891a6acba3d013", "committedDate": "2020-11-06T17:58:02Z", "message": "Add tablename option to shell insert command.\n\nThis change adds the --tablename option to the insert command when\ninside the shell or when using the accumulo command with 'accumulo shell\n-e <task>'. The option is not required, but if used it allows data to be\ninserted into a table in situations where the shell is not within a\ntable context or when in a table context to insert data into another\ntable.\n\nAlthough I would not expect this option to be utilized very often, I\nfound myself in need of it when working with the various accumulo\nexamples in the accumulo-examples repo. I had many situations where I\nwished to insert some test data from a bash shell using the 'accumulo\nshell -e insert r f q v' form but this would fail due to there being no\ntable context for the insertion. This update allows data inserts from a\ncommand line using the 'accumulo shell' format.\n\nAlso, there is no shortened form of the option to minimize confusion\nwith the -ts option."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9eaf446003a743bc1ebf99b95025a25e219dcb0a", "author": {"user": {"login": "jmark99", "name": "Mark Owens"}}, "url": "https://github.com/apache/accumulo/commit/9eaf446003a743bc1ebf99b95025a25e219dcb0a", "committedDate": "2020-11-06T18:50:06Z", "message": "Add tablename option to shell insert command.\n\nFormmatting changes applied via maven plugin."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1NDczNjg1", "url": "https://github.com/apache/accumulo/pull/1771#pullrequestreview-525473685", "createdAt": "2020-11-06T20:30:04Z", "commit": {"oid": "9eaf446003a743bc1ebf99b95025a25e219dcb0a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQyMDozMDowNFrOHu8myA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQyMDozMDowNFrOHu8myA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODk4OTUxMg==", "bodyText": "This command should use the table specified, but it should not update the table state for the entire shell. All you need to do is set a local variable to either the specified table, or default to the current shell state's table, and use that local variable in the line below that creates the batch writer.", "url": "https://github.com/apache/accumulo/pull/1771#discussion_r518989512", "createdAt": "2020-11-06T20:30:04Z", "author": {"login": "ctubbsii"}, "path": "shell/src/main/java/org/apache/accumulo/shell/commands/InsertCommand.java", "diffHunk": "@@ -63,81 +64,96 @@ protected long getTimeout(final CommandLine cl) {\n   public int execute(final String fullCommand, final CommandLine cl, final Shell shellState)\n       throws AccumuloException, AccumuloSecurityException, TableNotFoundException, IOException,\n       ConstraintViolationException {\n-    shellState.checkTableState();\n \n-    final Mutation m = new Mutation(new Text(cl.getArgs()[0].getBytes(Shell.CHARSET)));\n-    final Text colf = new Text(cl.getArgs()[1].getBytes(Shell.CHARSET));\n-    final Text colq = new Text(cl.getArgs()[2].getBytes(Shell.CHARSET));\n-    final Value val = new Value(cl.getArgs()[3].getBytes(Shell.CHARSET));\n-\n-    if (cl.hasOption(insertOptAuths.getOpt())) {\n-      final ColumnVisibility le = new ColumnVisibility(cl.getOptionValue(insertOptAuths.getOpt()));\n-      Shell.log.debug(\"Authorization label will be set to: {}\", le);\n-\n-      if (cl.hasOption(timestampOpt.getOpt()))\n-        m.put(colf, colq, le, Long.parseLong(cl.getOptionValue(timestampOpt.getOpt())), val);\n-      else\n-        m.put(colf, colq, le, val);\n-    } else if (cl.hasOption(timestampOpt.getOpt()))\n-      m.put(colf, colq, Long.parseLong(cl.getOptionValue(timestampOpt.getOpt())), val);\n-    else\n-      m.put(colf, colq, val);\n-\n-    final BatchWriterConfig cfg =\n-        new BatchWriterConfig().setMaxMemory(Math.max(m.estimatedMemoryUsed(), 1024))\n-            .setMaxWriteThreads(1).setTimeout(getTimeout(cl), TimeUnit.MILLISECONDS);\n-    if (cl.hasOption(durabilityOption.getOpt())) {\n-      String userDurability = cl.getOptionValue(durabilityOption.getOpt());\n-      switch (userDurability) {\n-        case \"sync\":\n-          cfg.setDurability(Durability.SYNC);\n-          break;\n-        case \"flush\":\n-          cfg.setDurability(Durability.FLUSH);\n-          break;\n-        case \"none\":\n-          cfg.setDurability(Durability.NONE);\n-          break;\n-        case \"log\":\n-          cfg.setDurability(Durability.NONE);\n-          break;\n-        default:\n-          throw new IllegalArgumentException(\"Unknown durability: \" + userDurability);\n-      }\n-    }\n-    final BatchWriter bw =\n-        shellState.getAccumuloClient().createBatchWriter(shellState.getTableName(), cfg);\n-    bw.addMutation(m);\n+    String initialTable = null;\n     try {\n-      bw.close();\n-    } catch (MutationsRejectedException e) {\n-      final ArrayList<String> lines = new ArrayList<>();\n-      if (!e.getSecurityErrorCodes().isEmpty()) {\n-        lines.add(\"\\tAuthorization Failures:\");\n+      if (cl.hasOption(tableNameOption.getOpt())) {\n+        initialTable = shellState.getTableName();\n+        shellState.setTableName(cl.getOptionValue(tableNameOption.getOpt()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9eaf446003a743bc1ebf99b95025a25e219dcb0a"}, "originalPosition": 66}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f867c74b182b330b6ee4eb4566268250ff566c50", "author": {"user": {"login": "jmark99", "name": "Mark Owens"}}, "url": "https://github.com/apache/accumulo/commit/f867c74b182b330b6ee4eb4566268250ff566c50", "committedDate": "2020-11-09T16:09:13Z", "message": "Add tablename option to shell insert command.\n\nSimplified task based upon suggestion from @ctubbsii."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NjQxMDQw", "url": "https://github.com/apache/accumulo/pull/1771#pullrequestreview-526641040", "createdAt": "2020-11-09T20:47:19Z", "commit": {"oid": "f867c74b182b330b6ee4eb4566268250ff566c50"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMDo0NzoxOVrOHwA_Hg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMDo0NzoxOVrOHwA_Hg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDEwOTg1NA==", "bodyText": "What's the reason for not supporting -t short name?", "url": "https://github.com/apache/accumulo/pull/1771#discussion_r520109854", "createdAt": "2020-11-09T20:47:19Z", "author": {"login": "ctubbsii"}, "path": "shell/src/main/java/org/apache/accumulo/shell/commands/InsertCommand.java", "diffHunk": "@@ -171,6 +180,11 @@ public Options getOptions() {\n         \"durability to use for insert, should be one of \\\"none\\\" \\\"log\\\" \\\"flush\\\" or \\\"sync\\\"\");\n     o.addOption(durabilityOption);\n \n+    tableNameOption =\n+        new Option(\"\", \"tablename\", true, \"name of table in which data is being inserted\");\n+    tableNameOption.setArgName(\"tablename\");\n+    o.addOption(tableNameOption);\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f867c74b182b330b6ee4eb4566268250ff566c50"}, "originalPosition": 44}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52d2254f0e0d181bb0fd7f1d2714718d793a83b9", "author": {"user": {"login": "jmark99", "name": "Mark Owens"}}, "url": "https://github.com/apache/accumulo/commit/52d2254f0e0d181bb0fd7f1d2714718d793a83b9", "committedDate": "2020-11-10T16:06:22Z", "message": "Add tablename option to shell insert command.\n\nModified the tablename parameter for 'insert' to use the shortened '-t'\nand the longer '--table' options."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3Mzc3MzE4", "url": "https://github.com/apache/accumulo/pull/1771#pullrequestreview-527377318", "createdAt": "2020-11-10T16:23:04Z", "commit": {"oid": "52d2254f0e0d181bb0fd7f1d2714718d793a83b9"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxNjoyMzowNFrOHwkodw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxNjoyMzowNFrOHwkodw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY5Mzg3OQ==", "bodyText": "Minor grammatical nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                o.addOption(OptUtil.tableOpt(\"table in which data is to be inserted\"));\n          \n          \n            \n                o.addOption(OptUtil.tableOpt(\"table into which data will be inserted\"));", "url": "https://github.com/apache/accumulo/pull/1771#discussion_r520693879", "createdAt": "2020-11-10T16:23:04Z", "author": {"login": "ctubbsii"}, "path": "shell/src/main/java/org/apache/accumulo/shell/commands/InsertCommand.java", "diffHunk": "@@ -171,6 +171,8 @@ public Options getOptions() {\n         \"durability to use for insert, should be one of \\\"none\\\" \\\"log\\\" \\\"flush\\\" or \\\"sync\\\"\");\n     o.addOption(durabilityOption);\n \n+    o.addOption(OptUtil.tableOpt(\"table in which data is to be inserted\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "52d2254f0e0d181bb0fd7f1d2714718d793a83b9"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b773d80c67a3bfdfe0214a37e5e81b7dc741c3c7", "author": {"user": {"login": "jmark99", "name": "Mark Owens"}}, "url": "https://github.com/apache/accumulo/commit/b773d80c67a3bfdfe0214a37e5e81b7dc741c3c7", "committedDate": "2020-11-10T16:27:31Z", "message": "Add tablename option to shell insert command.\n\nChanged wording of -t/--table parameter usage message."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3Mzk2MTk4", "url": "https://github.com/apache/accumulo/pull/1771#pullrequestreview-527396198", "createdAt": "2020-11-10T16:42:18Z", "commit": {"oid": "b773d80c67a3bfdfe0214a37e5e81b7dc741c3c7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1788, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}