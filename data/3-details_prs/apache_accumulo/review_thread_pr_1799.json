{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI0ODU0MzU2", "number": 1799, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxODowMDo0M1rOE8VXRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QyMzowODo1MFrOE8btGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMxNzAwMDM4OnYy", "diffSide": "LEFT", "path": "core/src/main/java/org/apache/accumulo/core/metadata/schema/TabletMetadata.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxODowMDo0M1rOH4ZP9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxODozOTowMFrOH4ai5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODg5NTk5MA==", "bodyText": "If there's any chance this is serialized, removing the enum changes the ordinals and could break things. Might be safer to mark it as deprecated and add a comment that it is no longer in use.", "url": "https://github.com/apache/accumulo/pull/1799#discussion_r528895990", "createdAt": "2020-11-23T18:00:43Z", "author": {"login": "ctubbsii"}, "path": "core/src/main/java/org/apache/accumulo/core/metadata/schema/TabletMetadata.java", "diffHunk": "@@ -98,11 +104,10 @@\n   }\n \n   public enum ColumnType {\n-    LOCATION,\n+    LOCATION, // includes all types in LocationType + SUSPEND\n     PREV_ROW,\n     OLD_PREV_ROW,\n     FILES,\n-    LAST,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f1b2d53c7a91b82d1dbed43de9f62ef28ca9efbb"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODkwNzg2Mg==", "bodyText": "I don't think so.  This enum is used to tell the class what column families to fetch in the scanner created in TabletsMetadata.  There is also a check ensureFetched(ColumnType col) that is called on the get methods that will throw an error if you didn't fetch the column family associated with that type.", "url": "https://github.com/apache/accumulo/pull/1799#discussion_r528907862", "createdAt": "2020-11-23T18:21:54Z", "author": {"login": "milleruntime"}, "path": "core/src/main/java/org/apache/accumulo/core/metadata/schema/TabletMetadata.java", "diffHunk": "@@ -98,11 +104,10 @@\n   }\n \n   public enum ColumnType {\n-    LOCATION,\n+    LOCATION, // includes all types in LocationType + SUSPEND\n     PREV_ROW,\n     OLD_PREV_ROW,\n     FILES,\n-    LAST,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODg5NTk5MA=="}, "originalCommit": {"oid": "f1b2d53c7a91b82d1dbed43de9f62ef28ca9efbb"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODkxNzIyMw==", "bodyText": "As long as it's just used internally, and never serialized or sent over the wire, it's fine.", "url": "https://github.com/apache/accumulo/pull/1799#discussion_r528917223", "createdAt": "2020-11-23T18:39:00Z", "author": {"login": "ctubbsii"}, "path": "core/src/main/java/org/apache/accumulo/core/metadata/schema/TabletMetadata.java", "diffHunk": "@@ -98,11 +104,10 @@\n   }\n \n   public enum ColumnType {\n-    LOCATION,\n+    LOCATION, // includes all types in LocationType + SUSPEND\n     PREV_ROW,\n     OLD_PREV_ROW,\n     FILES,\n-    LAST,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODg5NTk5MA=="}, "originalCommit": {"oid": "f1b2d53c7a91b82d1dbed43de9f62ef28ca9efbb"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMxNzE0MTI3OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/accumulo/core/metadata/schema/TabletsMetadata.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxODo0MDowNFrOH4alVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QyMjozMjo0M1rOH4h9kQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODkxNzg0Ng==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        families.add(TabletsSection.SuspendLocationColumn.SUSPEND_COLUMN.getColumnFamily());\n          \n          \n            \n                        families.add(SuspendLocationColumn.SUSPEND_COLUMN.getColumnFamily());", "url": "https://github.com/apache/accumulo/pull/1799#discussion_r528917846", "createdAt": "2020-11-23T18:40:04Z", "author": {"login": "ctubbsii"}, "path": "core/src/main/java/org/apache/accumulo/core/metadata/schema/TabletsMetadata.java", "diffHunk": "@@ -163,15 +163,14 @@ public Options fetch(ColumnType... colsToFetch) {\n           case FLUSH_ID:\n             qualifiers.add(FLUSH_COLUMN);\n             break;\n-          case LAST:\n-            families.add(LastLocationColumnFamily.NAME);\n-            break;\n           case LOADED:\n             families.add(BulkFileColumnFamily.NAME);\n             break;\n           case LOCATION:\n             families.add(CurrentLocationColumnFamily.NAME);\n             families.add(FutureLocationColumnFamily.NAME);\n+            families.add(LastLocationColumnFamily.NAME);\n+            families.add(TabletsSection.SuspendLocationColumn.SUSPEND_COLUMN.getColumnFamily());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f1b2d53c7a91b82d1dbed43de9f62ef28ca9efbb"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTAzODczNw==", "bodyText": "I applied this suggestion manually to the case for SUSPEND.", "url": "https://github.com/apache/accumulo/pull/1799#discussion_r529038737", "createdAt": "2020-11-23T22:32:43Z", "author": {"login": "milleruntime"}, "path": "core/src/main/java/org/apache/accumulo/core/metadata/schema/TabletsMetadata.java", "diffHunk": "@@ -163,15 +163,14 @@ public Options fetch(ColumnType... colsToFetch) {\n           case FLUSH_ID:\n             qualifiers.add(FLUSH_COLUMN);\n             break;\n-          case LAST:\n-            families.add(LastLocationColumnFamily.NAME);\n-            break;\n           case LOADED:\n             families.add(BulkFileColumnFamily.NAME);\n             break;\n           case LOCATION:\n             families.add(CurrentLocationColumnFamily.NAME);\n             families.add(FutureLocationColumnFamily.NAME);\n+            families.add(LastLocationColumnFamily.NAME);\n+            families.add(TabletsSection.SuspendLocationColumn.SUSPEND_COLUMN.getColumnFamily());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODkxNzg0Ng=="}, "originalCommit": {"oid": "f1b2d53c7a91b82d1dbed43de9f62ef28ca9efbb"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMxNzE0Nzk0OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/accumulo/core/metadata/schema/TabletMetadata.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxODo0MTo0OVrOH4apRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxOTowNjozMFrOH4bfZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODkxODg1Mw==", "bodyText": "This still looks like it's fetching the \"loc\" column. It might be more clear if this enum that refers to fetching all locations, was something like ALL_LOCATIONS", "url": "https://github.com/apache/accumulo/pull/1799#discussion_r528918853", "createdAt": "2020-11-23T18:41:49Z", "author": {"login": "ctubbsii"}, "path": "core/src/main/java/org/apache/accumulo/core/metadata/schema/TabletMetadata.java", "diffHunk": "@@ -190,10 +195,15 @@ public boolean hasCurrent() {\n   }\n \n   public Location getLast() {\n-    ensureFetched(ColumnType.LAST);\n+    ensureFetched(ColumnType.LOCATION);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f1b2d53c7a91b82d1dbed43de9f62ef28ca9efbb"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODkzMjcxMA==", "bodyText": "One of the issues is that there is a separate enum called LocationType that is used in the inner class Location to differentiate between the types. This doesn't really work with SuspendingTServer because it is its own special type.  I made an attempt to have SuspendingTServer extend the Location or TServerInstance types but it stores the suspension time with the host and port string in Value, differently from how we typically store the tserver host and port with the zk session id.\n\n  \n    \n      accumulo/core/src/main/java/org/apache/accumulo/core/metadata/SuspendingTServer.java\n    \n    \n         Line 45\n      in\n      cccac86\n    \n    \n    \n    \n\n        \n          \n           return new Value(tServer.getHostPort() + \"|\" + suspensionTime); \n        \n    \n  \n\n\nThen this is how TServerInstance is written:\n\n  \n    \n      accumulo/server/base/src/main/java/org/apache/accumulo/server/metadata/TabletMutatorBase.java\n    \n    \n        Lines 144 to 147\n      in\n      cccac86\n    \n    \n    \n    \n\n        \n          \n           public Ample.TabletMutator putLocation(TServerInstance tsi, LocationType type) { \n        \n\n        \n          \n             Preconditions.checkState(updatesEnabled, \"Cannot make updates after calling mutate.\"); \n        \n\n        \n          \n             mutation.put(getLocationFamily(type), tsi.getSession(), tsi.getHostPort()); \n        \n\n        \n          \n             return this;", "url": "https://github.com/apache/accumulo/pull/1799#discussion_r528932710", "createdAt": "2020-11-23T19:06:30Z", "author": {"login": "milleruntime"}, "path": "core/src/main/java/org/apache/accumulo/core/metadata/schema/TabletMetadata.java", "diffHunk": "@@ -190,10 +195,15 @@ public boolean hasCurrent() {\n   }\n \n   public Location getLast() {\n-    ensureFetched(ColumnType.LAST);\n+    ensureFetched(ColumnType.LOCATION);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODkxODg1Mw=="}, "originalCommit": {"oid": "f1b2d53c7a91b82d1dbed43de9f62ef28ca9efbb"}, "originalPosition": 54}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMxNzE2ODc3OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/accumulo/core/metadata/schema/TabletMetadata.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxODo0Nzo1MFrOH4a16A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxODo0Nzo1MFrOH4a16A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODkyMjA4OA==", "bodyText": "@ctubbsii I have a comment here.  I could rename it to ALL_LOCATIONS", "url": "https://github.com/apache/accumulo/pull/1799#discussion_r528922088", "createdAt": "2020-11-23T18:47:50Z", "author": {"login": "milleruntime"}, "path": "core/src/main/java/org/apache/accumulo/core/metadata/schema/TabletMetadata.java", "diffHunk": "@@ -98,11 +104,10 @@\n   }\n \n   public enum ColumnType {\n-    LOCATION,\n+    LOCATION, // includes all types in LocationType + SUSPEND", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f1b2d53c7a91b82d1dbed43de9f62ef28ca9efbb"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMxODAzOTMwOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/accumulo/core/metadata/schema/TabletsMetadata.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QyMzowODo1MFrOH4i8aw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNDo0MDoyOFrOH5D7dA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTA1NDgyNw==", "bodyText": "This needs a break statement to avoid unintentional fall-through:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        families.add(SuspendLocationColumn.SUSPEND_COLUMN.getColumnFamily());\n          \n          \n            \n                        families.add(SuspendLocationColumn.SUSPEND_COLUMN.getColumnFamily());\n          \n          \n            \n                        break;", "url": "https://github.com/apache/accumulo/pull/1799#discussion_r529054827", "createdAt": "2020-11-23T23:08:50Z", "author": {"login": "ctubbsii"}, "path": "core/src/main/java/org/apache/accumulo/core/metadata/schema/TabletsMetadata.java", "diffHunk": "@@ -182,6 +183,8 @@ public Options fetch(ColumnType... colsToFetch) {\n           case SCANS:\n             families.add(ScanFileColumnFamily.NAME);\n             break;\n+          case SUSPEND:\n+            families.add(SuspendLocationColumn.SUSPEND_COLUMN.getColumnFamily());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4dce7c9eab23ba15bdcbd7f1e382f45c8af35c87"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTU5NTI1Mg==", "bodyText": "Thanks good catch.", "url": "https://github.com/apache/accumulo/pull/1799#discussion_r529595252", "createdAt": "2020-11-24T14:40:28Z", "author": {"login": "milleruntime"}, "path": "core/src/main/java/org/apache/accumulo/core/metadata/schema/TabletsMetadata.java", "diffHunk": "@@ -182,6 +183,8 @@ public Options fetch(ColumnType... colsToFetch) {\n           case SCANS:\n             families.add(ScanFileColumnFamily.NAME);\n             break;\n+          case SUSPEND:\n+            families.add(SuspendLocationColumn.SUSPEND_COLUMN.getColumnFamily());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTA1NDgyNw=="}, "originalCommit": {"oid": "4dce7c9eab23ba15bdcbd7f1e382f45c8af35c87"}, "originalPosition": 13}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4140, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}