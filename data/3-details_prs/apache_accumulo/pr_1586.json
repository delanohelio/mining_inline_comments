{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAyODcyOTc1", "number": 1586, "title": "Fix Accumulo hanging when TLS enabled on ZooKeeper", "bodyText": "This PR addresses the issue described in #1578. The code changes has been successfully tested against TLS & non-TLS configured ZK setup. Please review & let me know for any questions/suggestions.\nLike I mentioned in #1578 regarding the warning message during start/stop of services I'll create a separate issue to investigate.", "createdAt": "2020-04-13T22:31:21Z", "url": "https://github.com/apache/accumulo/pull/1586", "merged": true, "mergeCommit": {"oid": "16d46a85895b2aa8c2e8efa4949eac0fdef4ce55"}, "closed": true, "closedAt": "2020-04-14T20:27:33Z", "author": {"login": "karthick-rn"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcXWMIRAH2gAyNDAyODcyOTc1Ojc4NmNhZjFhYWI3OGE1YzAxNzBkZjFjMzZlOTIwYTMxZDcyMWFhZmU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcXpejMgH2gAyNDAyODcyOTc1OmE2NzYzZTNhMTE4ZGUyNjg2ZmRkNTAyMDViZDBlMThiMDZjMjY4ZDg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "786caf1aab78a5c0170df1c36e920a31d721aafe", "author": {"user": {"login": "karthick-rn", "name": "Karthick Narendran"}}, "url": "https://github.com/apache/accumulo/commit/786caf1aab78a5c0170df1c36e920a31d721aafe", "committedDate": "2020-04-13T21:57:30Z", "message": "Fix for #1578"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyNTY0OTY1", "url": "https://github.com/apache/accumulo/pull/1586#pullrequestreview-392564965", "createdAt": "2020-04-14T02:38:47Z", "commit": {"oid": "65dbef8c227a0527840a9c347db5b407339937b4"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwMjozODo0N1rOGE8DkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwMjo1MTowMlrOGE8QhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgzMTQ0MQ==", "bodyText": "As I understand it, the basis of this pull request is to create this CLOSED mode. What is this CLOSED mode for? This could use a javadoc similar to the other modes.", "url": "https://github.com/apache/accumulo/pull/1586#discussion_r407831441", "createdAt": "2020-04-14T02:38:47Z", "author": {"login": "ctubbsii"}, "path": "core/src/main/java/org/apache/accumulo/core/singletons/SingletonManager.java", "diffHunk": "@@ -65,7 +65,8 @@\n      * In this mode singletons are never disabled unless the mode is set back to CLIENT. The user\n      * can do this by using util.CleanUp (an old API created for users).\n      */\n-    CONNECTOR\n+    CONNECTOR,\n+    CLOSED", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65dbef8c227a0527840a9c347db5b407339937b4"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgzMzEzNQ==", "bodyText": "Would it be okay to just return if the mode parameter is already the current mode?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (SingletonManager.mode == Mode.CLOSED && mode != Mode.CLOSED)\n          \n          \n            \n                  throw new IllegalStateException(\"Cannot leave closed mode once entered\");\n          \n          \n            \n                if (SingletonManager.mode == mode)\n          \n          \n            \n                  return;\n          \n          \n            \n                if (SingletonManager.mode == Mode.CLOSED)\n          \n          \n            \n                  throw new IllegalStateException(\"Cannot leave closed mode once entered\");\n          \n      \n    \n    \n  \n\nOr is it necessary to fall through and do something if they are both CLOSED already?", "url": "https://github.com/apache/accumulo/pull/1586#discussion_r407833135", "createdAt": "2020-04-14T02:45:07Z", "author": {"login": "ctubbsii"}, "path": "core/src/main/java/org/apache/accumulo/core/singletons/SingletonManager.java", "diffHunk": "@@ -148,6 +149,8 @@ public static long getReservationCount() {\n    * Change how singletons are managed. The default mode is {@link Mode#CLIENT}\n    */\n   public static synchronized void setMode(Mode mode) {\n+    if (SingletonManager.mode == Mode.CLOSED && mode != Mode.CLOSED)\n+      throw new IllegalStateException(\"Cannot leave closed mode once entered\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65dbef8c227a0527840a9c347db5b407339937b4"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgzNDA2OA==", "bodyText": "The comment above this line covers the left hand side, but doesn't explain the right hand side of this || expression. Should it say something about always allow changing state to CLOSED?", "url": "https://github.com/apache/accumulo/pull/1586#discussion_r407834068", "createdAt": "2020-04-14T02:48:39Z", "author": {"login": "ctubbsii"}, "path": "core/src/main/java/org/apache/accumulo/core/singletons/SingletonManager.java", "diffHunk": "@@ -161,7 +164,7 @@ public static synchronized void setMode(Mode mode) {\n     }\n \n     // do not change from server mode, its a terminal mode that can not be left once entered\n-    if (SingletonManager.mode != Mode.SERVER) {\n+    if (SingletonManager.mode != Mode.SERVER || mode == Mode.CLOSED) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65dbef8c227a0527840a9c347db5b407339937b4"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgzNDc1Nw==", "bodyText": "Does this prevent this code from being called from a process that might have other Accumulo client Connectors? If so, this is a bit concerning as a restriction.\n(Same comment for ZooZap and SetGoalState)", "url": "https://github.com/apache/accumulo/pull/1586#discussion_r407834757", "createdAt": "2020-04-14T02:51:02Z", "author": {"login": "ctubbsii"}, "path": "server/base/src/main/java/org/apache/accumulo/server/util/Admin.java", "diffHunk": "@@ -275,6 +277,8 @@ public void execute(final String[] args) {\n     } catch (Exception e) {\n       log.error(\"{}\", e.getMessage(), e);\n       System.exit(3);\n+    } finally {\n+      SingletonManager.setMode(Mode.CLOSED);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65dbef8c227a0527840a9c347db5b407339937b4"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5fccb4b2db688009f49350ec09d0c727612b2b0", "author": {"user": {"login": "karthick-rn", "name": "Karthick Narendran"}}, "url": "https://github.com/apache/accumulo/commit/c5fccb4b2db688009f49350ec09d0c727612b2b0", "committedDate": "2020-04-14T19:19:11Z", "message": "Update based on Christopher's comments\n\nThe comment section of SingletonManager Java class has been updated based on Christopher's comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ef38811b3a66668e9def8be4615c0bf20f3e496f", "author": {"user": {"login": "karthick-rn", "name": "Karthick Narendran"}}, "url": "https://github.com/apache/accumulo/commit/ef38811b3a66668e9def8be4615c0bf20f3e496f", "committedDate": "2020-04-14T18:03:55Z", "message": "Update core/src/main/java/org/apache/accumulo/core/singletons/SingletonManager.java\n\nCo-Authored-By: Christopher Tubbs <ctubbsii@apache.org>"}, "afterCommit": {"oid": "c5fccb4b2db688009f49350ec09d0c727612b2b0", "author": {"user": {"login": "karthick-rn", "name": "Karthick Narendran"}}, "url": "https://github.com/apache/accumulo/commit/c5fccb4b2db688009f49350ec09d0c727612b2b0", "committedDate": "2020-04-14T19:19:11Z", "message": "Update based on Christopher's comments\n\nThe comment section of SingletonManager Java class has been updated based on Christopher's comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzMjM3NDAz", "url": "https://github.com/apache/accumulo/pull/1586#pullrequestreview-393237403", "createdAt": "2020-04-14T19:39:04Z", "commit": {"oid": "c5fccb4b2db688009f49350ec09d0c727612b2b0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3df1011e210663fd11e330bd5b5f215e213b3080", "author": {"user": {"login": "karthick-rn", "name": "Karthick Narendran"}}, "url": "https://github.com/apache/accumulo/commit/3df1011e210663fd11e330bd5b5f215e213b3080", "committedDate": "2020-04-14T19:49:38Z", "message": "Replace single-line with multi-line comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzMjQ2MDEz", "url": "https://github.com/apache/accumulo/pull/1586#pullrequestreview-393246013", "createdAt": "2020-04-14T19:52:11Z", "commit": {"oid": "3df1011e210663fd11e330bd5b5f215e213b3080"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxOTo1MjoxMVrOGFecQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxOTo1MjoxMVrOGFecQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM5NDgxNw==", "bodyText": "This isn't a javadoc comment.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                /**\n          \n          \n            \n                /*", "url": "https://github.com/apache/accumulo/pull/1586#discussion_r408394817", "createdAt": "2020-04-14T19:52:11Z", "author": {"login": "ctubbsii"}, "path": "core/src/main/java/org/apache/accumulo/core/singletons/SingletonManager.java", "diffHunk": "@@ -170,8 +170,10 @@ public static synchronized void setMode(Mode mode) {\n       transitionedFromClientToConnector = true;\n     }\n \n-    // always allow transition to closed and only allow transition to client/connector when the\n-    // current mode is not server\n+    /**", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3df1011e210663fd11e330bd5b5f215e213b3080"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d765a92c07c6682ce8ec8bfd7f04594df870d4f3", "author": {"user": {"login": "ctubbsii", "name": "Christopher Tubbs"}}, "url": "https://github.com/apache/accumulo/commit/d765a92c07c6682ce8ec8bfd7f04594df870d4f3", "committedDate": "2020-04-14T19:53:50Z", "message": "Apply suggestions from code review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6763e3a118de2686fdd50205bd0e18b06c268d8", "author": {"user": {"login": "ctubbsii", "name": "Christopher Tubbs"}}, "url": "https://github.com/apache/accumulo/commit/a6763e3a118de2686fdd50205bd0e18b06c268d8", "committedDate": "2020-04-14T20:25:49Z", "message": "Fix import ordering"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1932, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}