{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg5NTA5NjA5", "number": 11965, "title": "(CDAP-16369) Use twill to launch job on remote Hadoop cluster", "bodyText": "This change is to move services that are used to run in AbstractProgramTwillRunnable\ninto DefaultRuntimeJob. It provides a unified way of running job in any hadoop cluster,\nregardless of how the DefaultRuntimeJob is being started.", "createdAt": "2020-03-16T21:44:44Z", "url": "https://github.com/cdapio/cdap/pull/11965", "merged": true, "mergeCommit": {"oid": "853cf913cf9075da77fec88f2b543b6e52a308d8"}, "closed": true, "closedAt": "2020-03-17T02:06:38Z", "author": {"login": "chtyim"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcOVfrpAFqTM3NTYwNTMxMQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcOXrLYABqjMxMzU0MDQ1ODY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1NjA1MzEx", "url": "https://github.com/cdapio/cdap/pull/11965#pullrequestreview-375605311", "createdAt": "2020-03-16T21:48:33Z", "commit": {"oid": "05dbdc7790725437cbe3a406ba4a5f57f59da9c9"}, "state": "COMMENTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQyMTo0ODozM1rOF3G3ew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQyMjowMDo1OVrOF3HMeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzMyODUwNw==", "bodyText": "why is this property need to be set now?", "url": "https://github.com/cdapio/cdap/pull/11965#discussion_r393328507", "createdAt": "2020-03-16T21:48:33Z", "author": {"login": "CuriousVini"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/runtime/distributed/DistributedProgramRunner.java", "diffHunk": "@@ -532,6 +528,11 @@ private ProgramOptions updateProgramOptions(ProgramOptions options,\n    */\n   @Nullable\n   private URI getLogBackURI(Program program, File tempDir) throws IOException, URISyntaxException {\n+    String configurationFile = System.getProperty(\"logback.configurationFile\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05dbdc7790725437cbe3a406ba4a5f57f59da9c9"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzMyOTA3NQ==", "bodyText": "nit: static constant", "url": "https://github.com/cdapio/cdap/pull/11965#discussion_r393329075", "createdAt": "2020-03-16T21:49:32Z", "author": {"login": "CuriousVini"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/runtime/distributed/remote/RemoteExecutionJobMain.java", "diffHunk": "@@ -0,0 +1,196 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.app.runtime.distributed.remote;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.inject.AbstractModule;\n+import com.google.inject.Guice;\n+import com.google.inject.Injector;\n+import com.google.inject.Scopes;\n+import io.cdap.cdap.api.security.store.SecureStore;\n+import io.cdap.cdap.api.security.store.SecureStoreData;\n+import io.cdap.cdap.api.security.store.SecureStoreMetadata;\n+import io.cdap.cdap.app.guice.TwillModule;\n+import io.cdap.cdap.common.NotFoundException;\n+import io.cdap.cdap.common.app.RunIds;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.discovery.ResolvingDiscoverable;\n+import io.cdap.cdap.common.guice.ConfigModule;\n+import io.cdap.cdap.common.guice.DFSLocationModule;\n+import io.cdap.cdap.common.guice.InMemoryDiscoveryModule;\n+import io.cdap.cdap.internal.app.runtime.distributed.runtimejob.DefaultRuntimeJob;\n+import io.cdap.cdap.runtime.spi.runtimejob.RuntimeJobEnvironment;\n+import io.cdap.cdap.security.auth.context.AuthenticationContextModules;\n+import io.cdap.cdap.security.impersonation.CurrentUGIProvider;\n+import io.cdap.cdap.security.impersonation.UGIProvider;\n+import org.apache.twill.api.RunId;\n+import org.apache.twill.api.TwillRunner;\n+import org.apache.twill.api.TwillRunnerService;\n+import org.apache.twill.filesystem.Location;\n+import org.apache.twill.filesystem.LocationFactory;\n+import org.apache.twill.internal.zookeeper.InMemoryZKServer;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.IOException;\n+import java.net.InetSocketAddress;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * The main class to setup the {@link RuntimeJobEnvironment} for remote execution.\n+ */\n+public class RemoteExecutionJobMain {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(RemoteExecutionJobMain.class);\n+\n+  private final DefaultRuntimeJob runtimeJob = new DefaultRuntimeJob();\n+\n+  private InMemoryZKServer zkServer;\n+  private TwillRunnerService twillRunnerService;\n+  private LocationFactory locationFactory;\n+\n+  public static void main(String[] args) throws Exception {\n+    System.setProperty(\"twill.zk.server.localhost\", \"false\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05dbdc7790725437cbe3a406ba4a5f57f59da9c9"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzMyOTI0Nw==", "bodyText": "nit: missing javadoc.", "url": "https://github.com/cdapio/cdap/pull/11965#discussion_r393329247", "createdAt": "2020-03-16T21:49:52Z", "author": {"login": "CuriousVini"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/runtime/distributed/remote/RemoteExecutionJobMain.java", "diffHunk": "@@ -0,0 +1,196 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.app.runtime.distributed.remote;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.inject.AbstractModule;\n+import com.google.inject.Guice;\n+import com.google.inject.Injector;\n+import com.google.inject.Scopes;\n+import io.cdap.cdap.api.security.store.SecureStore;\n+import io.cdap.cdap.api.security.store.SecureStoreData;\n+import io.cdap.cdap.api.security.store.SecureStoreMetadata;\n+import io.cdap.cdap.app.guice.TwillModule;\n+import io.cdap.cdap.common.NotFoundException;\n+import io.cdap.cdap.common.app.RunIds;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.discovery.ResolvingDiscoverable;\n+import io.cdap.cdap.common.guice.ConfigModule;\n+import io.cdap.cdap.common.guice.DFSLocationModule;\n+import io.cdap.cdap.common.guice.InMemoryDiscoveryModule;\n+import io.cdap.cdap.internal.app.runtime.distributed.runtimejob.DefaultRuntimeJob;\n+import io.cdap.cdap.runtime.spi.runtimejob.RuntimeJobEnvironment;\n+import io.cdap.cdap.security.auth.context.AuthenticationContextModules;\n+import io.cdap.cdap.security.impersonation.CurrentUGIProvider;\n+import io.cdap.cdap.security.impersonation.UGIProvider;\n+import org.apache.twill.api.RunId;\n+import org.apache.twill.api.TwillRunner;\n+import org.apache.twill.api.TwillRunnerService;\n+import org.apache.twill.filesystem.Location;\n+import org.apache.twill.filesystem.LocationFactory;\n+import org.apache.twill.internal.zookeeper.InMemoryZKServer;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.IOException;\n+import java.net.InetSocketAddress;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * The main class to setup the {@link RuntimeJobEnvironment} for remote execution.\n+ */\n+public class RemoteExecutionJobMain {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(RemoteExecutionJobMain.class);\n+\n+  private final DefaultRuntimeJob runtimeJob = new DefaultRuntimeJob();\n+\n+  private InMemoryZKServer zkServer;\n+  private TwillRunnerService twillRunnerService;\n+  private LocationFactory locationFactory;\n+\n+  public static void main(String[] args) throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05dbdc7790725437cbe3a406ba4a5f57f59da9c9"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzMyOTUwMg==", "bodyText": "it would be good to check number of args and throw appropriate error in case some one modifies caller to not provide any args", "url": "https://github.com/cdapio/cdap/pull/11965#discussion_r393329502", "createdAt": "2020-03-16T21:50:31Z", "author": {"login": "CuriousVini"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/runtime/distributed/remote/RemoteExecutionJobMain.java", "diffHunk": "@@ -0,0 +1,196 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.app.runtime.distributed.remote;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.inject.AbstractModule;\n+import com.google.inject.Guice;\n+import com.google.inject.Injector;\n+import com.google.inject.Scopes;\n+import io.cdap.cdap.api.security.store.SecureStore;\n+import io.cdap.cdap.api.security.store.SecureStoreData;\n+import io.cdap.cdap.api.security.store.SecureStoreMetadata;\n+import io.cdap.cdap.app.guice.TwillModule;\n+import io.cdap.cdap.common.NotFoundException;\n+import io.cdap.cdap.common.app.RunIds;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.discovery.ResolvingDiscoverable;\n+import io.cdap.cdap.common.guice.ConfigModule;\n+import io.cdap.cdap.common.guice.DFSLocationModule;\n+import io.cdap.cdap.common.guice.InMemoryDiscoveryModule;\n+import io.cdap.cdap.internal.app.runtime.distributed.runtimejob.DefaultRuntimeJob;\n+import io.cdap.cdap.runtime.spi.runtimejob.RuntimeJobEnvironment;\n+import io.cdap.cdap.security.auth.context.AuthenticationContextModules;\n+import io.cdap.cdap.security.impersonation.CurrentUGIProvider;\n+import io.cdap.cdap.security.impersonation.UGIProvider;\n+import org.apache.twill.api.RunId;\n+import org.apache.twill.api.TwillRunner;\n+import org.apache.twill.api.TwillRunnerService;\n+import org.apache.twill.filesystem.Location;\n+import org.apache.twill.filesystem.LocationFactory;\n+import org.apache.twill.internal.zookeeper.InMemoryZKServer;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.IOException;\n+import java.net.InetSocketAddress;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * The main class to setup the {@link RuntimeJobEnvironment} for remote execution.\n+ */\n+public class RemoteExecutionJobMain {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(RemoteExecutionJobMain.class);\n+\n+  private final DefaultRuntimeJob runtimeJob = new DefaultRuntimeJob();\n+\n+  private InMemoryZKServer zkServer;\n+  private TwillRunnerService twillRunnerService;\n+  private LocationFactory locationFactory;\n+\n+  public static void main(String[] args) throws Exception {\n+    System.setProperty(\"twill.zk.server.localhost\", \"false\");\n+    RunId runId = RunIds.fromString(args[0]);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05dbdc7790725437cbe3a406ba4a5f57f59da9c9"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzMyOTcwOQ==", "bodyText": "please add comment on why this is needed", "url": "https://github.com/cdapio/cdap/pull/11965#discussion_r393329709", "createdAt": "2020-03-16T21:50:57Z", "author": {"login": "CuriousVini"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/runtime/distributed/remote/RemoteExecutionJobMain.java", "diffHunk": "@@ -0,0 +1,196 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.app.runtime.distributed.remote;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.inject.AbstractModule;\n+import com.google.inject.Guice;\n+import com.google.inject.Injector;\n+import com.google.inject.Scopes;\n+import io.cdap.cdap.api.security.store.SecureStore;\n+import io.cdap.cdap.api.security.store.SecureStoreData;\n+import io.cdap.cdap.api.security.store.SecureStoreMetadata;\n+import io.cdap.cdap.app.guice.TwillModule;\n+import io.cdap.cdap.common.NotFoundException;\n+import io.cdap.cdap.common.app.RunIds;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.discovery.ResolvingDiscoverable;\n+import io.cdap.cdap.common.guice.ConfigModule;\n+import io.cdap.cdap.common.guice.DFSLocationModule;\n+import io.cdap.cdap.common.guice.InMemoryDiscoveryModule;\n+import io.cdap.cdap.internal.app.runtime.distributed.runtimejob.DefaultRuntimeJob;\n+import io.cdap.cdap.runtime.spi.runtimejob.RuntimeJobEnvironment;\n+import io.cdap.cdap.security.auth.context.AuthenticationContextModules;\n+import io.cdap.cdap.security.impersonation.CurrentUGIProvider;\n+import io.cdap.cdap.security.impersonation.UGIProvider;\n+import org.apache.twill.api.RunId;\n+import org.apache.twill.api.TwillRunner;\n+import org.apache.twill.api.TwillRunnerService;\n+import org.apache.twill.filesystem.Location;\n+import org.apache.twill.filesystem.LocationFactory;\n+import org.apache.twill.internal.zookeeper.InMemoryZKServer;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.IOException;\n+import java.net.InetSocketAddress;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * The main class to setup the {@link RuntimeJobEnvironment} for remote execution.\n+ */\n+public class RemoteExecutionJobMain {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(RemoteExecutionJobMain.class);\n+\n+  private final DefaultRuntimeJob runtimeJob = new DefaultRuntimeJob();\n+\n+  private InMemoryZKServer zkServer;\n+  private TwillRunnerService twillRunnerService;\n+  private LocationFactory locationFactory;\n+\n+  public static void main(String[] args) throws Exception {\n+    System.setProperty(\"twill.zk.server.localhost\", \"false\");\n+    RunId runId = RunIds.fromString(args[0]);\n+    CConfiguration cConf = CConfiguration.create();\n+    cConf.set(Constants.CFG_HDFS_NAMESPACE, \"/twill-\" + runId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05dbdc7790725437cbe3a406ba4a5f57f59da9c9"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzMzMDYyOA==", "bodyText": "I dont think this in needed in dataproc environment now.", "url": "https://github.com/cdapio/cdap/pull/11965#discussion_r393330628", "createdAt": "2020-03-16T21:53:08Z", "author": {"login": "CuriousVini"}, "path": "cdap-runtime-ext-dataproc/src/main/java/io/cdap/cdap/runtime/spi/runtimejob/DataprocRuntimeEnvironment.java", "diffHunk": "@@ -117,16 +94,12 @@ public void destroy() {\n     if (yarnTwillRunnerService != null) {\n       yarnTwillRunnerService.stop();\n     }\n-    if (zkDiscoveryService != null) {\n-      zkDiscoveryService.close();\n-    }\n-    if (zkClientService != null) {\n+    if (locationFactory != null) {\n+      Location location = locationFactory.create(\"/\");\n       try {\n-        // Invoke method through reflection. This is needed because of conflict in guava versions during compilation\n-        Method stopAndWait = zkClientService.getClass().getMethod(\"stopAndWait\");\n-        stopAndWait.invoke(zkClientService);\n-      } catch (Exception e) {\n-        throw new RuntimeException(\"Error occurred while invoking stop on zk client service\", e);\n+        location.delete(true);\n+      } catch (IOException e) {\n+        LOG.warn(\"Failed to delete location {}\", location, e);\n       }\n     }\n     if (zkServer != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05dbdc7790725437cbe3a406ba4a5f57f59da9c9"}, "originalPosition": 105}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzMzMjM4Mw==", "bodyText": "May be we should move this to another class rather than creating its own object just to call non static methods", "url": "https://github.com/cdapio/cdap/pull/11965#discussion_r393332383", "createdAt": "2020-03-16T21:57:21Z", "author": {"login": "CuriousVini"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/runtime/distributed/remote/RemoteExecutionJobMain.java", "diffHunk": "@@ -0,0 +1,196 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.app.runtime.distributed.remote;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.inject.AbstractModule;\n+import com.google.inject.Guice;\n+import com.google.inject.Injector;\n+import com.google.inject.Scopes;\n+import io.cdap.cdap.api.security.store.SecureStore;\n+import io.cdap.cdap.api.security.store.SecureStoreData;\n+import io.cdap.cdap.api.security.store.SecureStoreMetadata;\n+import io.cdap.cdap.app.guice.TwillModule;\n+import io.cdap.cdap.common.NotFoundException;\n+import io.cdap.cdap.common.app.RunIds;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.discovery.ResolvingDiscoverable;\n+import io.cdap.cdap.common.guice.ConfigModule;\n+import io.cdap.cdap.common.guice.DFSLocationModule;\n+import io.cdap.cdap.common.guice.InMemoryDiscoveryModule;\n+import io.cdap.cdap.internal.app.runtime.distributed.runtimejob.DefaultRuntimeJob;\n+import io.cdap.cdap.runtime.spi.runtimejob.RuntimeJobEnvironment;\n+import io.cdap.cdap.security.auth.context.AuthenticationContextModules;\n+import io.cdap.cdap.security.impersonation.CurrentUGIProvider;\n+import io.cdap.cdap.security.impersonation.UGIProvider;\n+import org.apache.twill.api.RunId;\n+import org.apache.twill.api.TwillRunner;\n+import org.apache.twill.api.TwillRunnerService;\n+import org.apache.twill.filesystem.Location;\n+import org.apache.twill.filesystem.LocationFactory;\n+import org.apache.twill.internal.zookeeper.InMemoryZKServer;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.IOException;\n+import java.net.InetSocketAddress;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * The main class to setup the {@link RuntimeJobEnvironment} for remote execution.\n+ */\n+public class RemoteExecutionJobMain {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(RemoteExecutionJobMain.class);\n+\n+  private final DefaultRuntimeJob runtimeJob = new DefaultRuntimeJob();\n+\n+  private InMemoryZKServer zkServer;\n+  private TwillRunnerService twillRunnerService;\n+  private LocationFactory locationFactory;\n+\n+  public static void main(String[] args) throws Exception {\n+    System.setProperty(\"twill.zk.server.localhost\", \"false\");\n+    RunId runId = RunIds.fromString(args[0]);\n+    CConfiguration cConf = CConfiguration.create();\n+    cConf.set(Constants.CFG_HDFS_NAMESPACE, \"/twill-\" + runId);\n+\n+    RemoteExecutionJobMain runner = new RemoteExecutionJobMain();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05dbdc7790725437cbe3a406ba4a5f57f59da9c9"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzMzMzA3MQ==", "bodyText": "initialize should also be called in try in case initialization fails, all the started services should be stopped. Otherwise JVM may not exit due to non demon thread hanging", "url": "https://github.com/cdapio/cdap/pull/11965#discussion_r393333071", "createdAt": "2020-03-16T21:58:55Z", "author": {"login": "CuriousVini"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/runtime/distributed/remote/RemoteExecutionJobMain.java", "diffHunk": "@@ -0,0 +1,196 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.app.runtime.distributed.remote;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.inject.AbstractModule;\n+import com.google.inject.Guice;\n+import com.google.inject.Injector;\n+import com.google.inject.Scopes;\n+import io.cdap.cdap.api.security.store.SecureStore;\n+import io.cdap.cdap.api.security.store.SecureStoreData;\n+import io.cdap.cdap.api.security.store.SecureStoreMetadata;\n+import io.cdap.cdap.app.guice.TwillModule;\n+import io.cdap.cdap.common.NotFoundException;\n+import io.cdap.cdap.common.app.RunIds;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.discovery.ResolvingDiscoverable;\n+import io.cdap.cdap.common.guice.ConfigModule;\n+import io.cdap.cdap.common.guice.DFSLocationModule;\n+import io.cdap.cdap.common.guice.InMemoryDiscoveryModule;\n+import io.cdap.cdap.internal.app.runtime.distributed.runtimejob.DefaultRuntimeJob;\n+import io.cdap.cdap.runtime.spi.runtimejob.RuntimeJobEnvironment;\n+import io.cdap.cdap.security.auth.context.AuthenticationContextModules;\n+import io.cdap.cdap.security.impersonation.CurrentUGIProvider;\n+import io.cdap.cdap.security.impersonation.UGIProvider;\n+import org.apache.twill.api.RunId;\n+import org.apache.twill.api.TwillRunner;\n+import org.apache.twill.api.TwillRunnerService;\n+import org.apache.twill.filesystem.Location;\n+import org.apache.twill.filesystem.LocationFactory;\n+import org.apache.twill.internal.zookeeper.InMemoryZKServer;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.IOException;\n+import java.net.InetSocketAddress;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * The main class to setup the {@link RuntimeJobEnvironment} for remote execution.\n+ */\n+public class RemoteExecutionJobMain {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(RemoteExecutionJobMain.class);\n+\n+  private final DefaultRuntimeJob runtimeJob = new DefaultRuntimeJob();\n+\n+  private InMemoryZKServer zkServer;\n+  private TwillRunnerService twillRunnerService;\n+  private LocationFactory locationFactory;\n+\n+  public static void main(String[] args) throws Exception {\n+    System.setProperty(\"twill.zk.server.localhost\", \"false\");\n+    RunId runId = RunIds.fromString(args[0]);\n+    CConfiguration cConf = CConfiguration.create();\n+    cConf.set(Constants.CFG_HDFS_NAMESPACE, \"/twill-\" + runId);\n+\n+    RemoteExecutionJobMain runner = new RemoteExecutionJobMain();\n+    RemoteExecutionRuntimeJobEnvironment jobEnv = runner.initialize(cConf);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05dbdc7790725437cbe3a406ba4a5f57f59da9c9"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzMzMzIzNg==", "bodyText": "why is this commented?", "url": "https://github.com/cdapio/cdap/pull/11965#discussion_r393333236", "createdAt": "2020-03-16T21:59:20Z", "author": {"login": "CuriousVini"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/runtime/distributed/remote/RemoteExecutionTwillPreparer.java", "diffHunk": "@@ -921,11 +921,14 @@ private String generateLaunchScript(RuntimeSpecification runtimeSpec, String tar\n     scriptWriter.println(\"export HADOOP_CLASSPATH=`hadoop classpath`\");\n \n     scriptWriter.printf(\n-      \"nohup java -Djava.io.tmpdir=tmp -Dcdap.runid=%s -cp %s/%s -Xmx%dm %s %s '%s' true >%s/stdout 2>%s/stderr &\\n\",\n+      \"nohup java -Djava.io.tmpdir=tmp -Dcdap.runid=%s -cp %s/%s -Xmx%dm %s %s '%s' true %s >%s/stdout 2>%s/stderr &\\n\",\n       programRunId.getRun(), targetPath, Constants.Files.LAUNCHER_JAR, memory,\n-      getJvmOptions().getRunnableExtraOptions(runnableName),\n+//      getJvmOptions().getRunnableExtraOptions(runnableName),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05dbdc7790725437cbe3a406ba4a5f57f59da9c9"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzMzMzMwNA==", "bodyText": "remove?", "url": "https://github.com/cdapio/cdap/pull/11965#discussion_r393333304", "createdAt": "2020-03-16T21:59:31Z", "author": {"login": "CuriousVini"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/runtime/distributed/remote/RemoteExecutionTwillPreparer.java", "diffHunk": "@@ -921,11 +921,14 @@ private String generateLaunchScript(RuntimeSpecification runtimeSpec, String tar\n     scriptWriter.println(\"export HADOOP_CLASSPATH=`hadoop classpath`\");\n \n     scriptWriter.printf(\n-      \"nohup java -Djava.io.tmpdir=tmp -Dcdap.runid=%s -cp %s/%s -Xmx%dm %s %s '%s' true >%s/stdout 2>%s/stderr &\\n\",\n+      \"nohup java -Djava.io.tmpdir=tmp -Dcdap.runid=%s -cp %s/%s -Xmx%dm %s %s '%s' true %s >%s/stdout 2>%s/stderr &\\n\",\n       programRunId.getRun(), targetPath, Constants.Files.LAUNCHER_JAR, memory,\n-      getJvmOptions().getRunnableExtraOptions(runnableName),\n+//      getJvmOptions().getRunnableExtraOptions(runnableName),\n+      getJvmOptions().getAMExtraOptions(),\n       RemoteLauncher.class.getName(),\n-      runtimeSpec.getRunnableSpecification().getClassName(),\n+//      runtimeSpec.getRunnableSpecification().getClassName(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05dbdc7790725437cbe3a406ba4a5f57f59da9c9"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzMzMzg4MQ==", "bodyText": "could you please add information on javadoc on why this is needed?", "url": "https://github.com/cdapio/cdap/pull/11965#discussion_r393333881", "createdAt": "2020-03-16T22:00:59Z", "author": {"login": "CuriousVini"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/runtime/distributed/runtimejob/DefaultRuntimeJob.java", "diffHunk": "@@ -82,69 +110,109 @@\n  * {@link TwillRunner} provided by {@link RuntimeJobEnvironment}.\n  */\n public class DefaultRuntimeJob implements RuntimeJob {\n-  private static final String PROGRAM_OPTIONS_FILE_NAME = \"program.options.json\";\n-  private static final String CDAP_CONF_FILE_NAME = \"cConf.xml\";\n-  private static final String APP_SPEC_FILE_NAME = \"appSpec.json\";\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(DefaultRuntimeJob.class);\n+\n   private static final Gson GSON =\n     ApplicationSpecificationAdapter.addTypeAdapters(new GsonBuilder())\n       .registerTypeAdapter(Arguments.class, new ArgumentsCodec())\n       .registerTypeAdapter(ProgramOptions.class, new ProgramOptionsCodec()).create();\n \n+  private final CompletableFuture<ProgramController> controllerFuture = new CompletableFuture<>();\n+\n   @Override\n   public void run(RuntimeJobEnvironment runtimeJobEnv) throws Exception {\n     // Get Program Options\n-    ProgramOptions programOptions = readJsonFile(new File(PROGRAM_OPTIONS_FILE_NAME), ProgramOptions.class);\n-    ProgramId programId = programOptions.getProgramId();\n+    ProgramOptions programOptions = readJsonFile(new File(DistributedProgramRunner.PROGRAM_OPTIONS_FILE_NAME),\n+                                                 ProgramOptions.class);\n+    ProgramRunId programRunId = programOptions.getProgramId().run(ProgramRunners.getRunId(programOptions));\n+    ProgramId programId = programRunId.getParent();\n \n     // Get App spec\n-    ApplicationSpecification appSpec = readJsonFile(new File(APP_SPEC_FILE_NAME), ApplicationSpecification.class);\n+    ApplicationSpecification appSpec = readJsonFile(new File(DistributedProgramRunner.APP_SPEC_FILE_NAME),\n+                                                    ApplicationSpecification.class);\n     ProgramDescriptor programDescriptor = new ProgramDescriptor(programId, appSpec);\n \n-    // Create cConf with provided properties. These properties can be used to set configs for twill runner such as\n-    // connection string for discovery.\n-    CConfiguration cConf = createCConf(runtimeJobEnv);\n-\n     // Create injector and get program runner\n-    Injector injector = Guice.createInjector(createmodule(runtimeJobEnv, cConf));\n-    ProgramRunner programRunner = injector.getInstance(ProgramRunnerFactory.class).create(programId.getType());\n-\n-    // Create and run the program. The program files should be present in current working directory.\n-    try (Program program = createProgram(cConf, programRunner, programDescriptor, programOptions)) {\n-      CompletableFuture<ProgramController.State> programCompletion = new CompletableFuture<>();\n-      ProgramController controller = programRunner.run(program, programOptions);\n-      controller.addListener(new AbstractListener() {\n-        @Override\n-        public void completed() {\n-          programCompletion.complete(ProgramController.State.COMPLETED);\n-        }\n+    Injector injector = Guice.createInjector(createModules(runtimeJobEnv, createCConf(runtimeJobEnv)));\n+    LogAppenderInitializer logAppenderInitializer = injector.getInstance(LogAppenderInitializer.class);\n+    Deque<Service> coreServices = createCoreServices(injector);\n+    startCoreServices(coreServices, logAppenderInitializer);\n \n-        @Override\n-        public void killed() {\n-          programCompletion.complete(ProgramController.State.KILLED);\n-        }\n+    try {\n+      SystemArguments.setLogLevel(programOptions.getUserArguments(), logAppenderInitializer);\n+      CConfiguration cConf = injector.getInstance(CConfiguration.class);\n+      ProgramRunner programRunner = injector.getInstance(ProgramRunnerFactory.class).create(programId.getType());\n \n-        @Override\n-        public void error(Throwable cause) {\n-          programCompletion.completeExceptionally(cause);\n-        }\n-      }, Threads.SAME_THREAD_EXECUTOR);\n+      // Create and run the program. The program files should be present in current working directory.\n+      try (Program program = createProgram(cConf, programRunner, programDescriptor, programOptions)) {\n+        CompletableFuture<ProgramController.State> programCompletion = new CompletableFuture<>();\n+        ProgramController controller = programRunner.run(program, programOptions);\n+        controllerFuture.complete(controller);\n+\n+        controller.addListener(new AbstractListener() {\n+          @Override\n+          public void completed() {\n+            programCompletion.complete(ProgramController.State.COMPLETED);\n+          }\n \n-      // Block on the completion\n-      programCompletion.get();\n+          @Override\n+          public void killed() {\n+            programCompletion.complete(ProgramController.State.KILLED);\n+          }\n+\n+          @Override\n+          public void error(Throwable cause) {\n+            programCompletion.completeExceptionally(cause);\n+          }\n+        }, Threads.SAME_THREAD_EXECUTOR);\n+\n+        // Block on the completion\n+        programCompletion.get();\n+      } finally {\n+        if (programRunner instanceof Closeable) {\n+          Closeables.closeQuietly((Closeable) programRunner);\n+        }\n+      }\n+    } catch (Throwable t) {\n+      controllerFuture.completeExceptionally(t);\n+      throw t;\n     } finally {\n-      if (programRunner instanceof Closeable) {\n-        ((Closeable) programRunner).close();\n+      stopCoreServices(coreServices, logAppenderInitializer);\n+    }\n+  }\n+\n+  /**\n+   * Stops the running job.\n+   */\n+  private void stop() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05dbdc7790725437cbe3a406ba4a5f57f59da9c9"}, "originalPosition": 205}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1NjY2NTA2", "url": "https://github.com/cdapio/cdap/pull/11965#pullrequestreview-375666506", "createdAt": "2020-03-17T00:30:12Z", "commit": {"oid": "ab55d5dec9fd6d3446fc9ddf2a7eab14c2ac808e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ddee9e380ef64c52d38dc3aac268d3ff2b04906", "author": {"user": {"login": "chtyim", "name": "Terence Yim"}}, "url": "https://github.com/cdapio/cdap/commit/5ddee9e380ef64c52d38dc3aac268d3ff2b04906", "committedDate": "2020-03-17T00:35:44Z", "message": "(CDAP-16369) Use twill to launch job on remote Hadoop cluster\n\n- This change is to move services that are used to run in AbstractProgramTwillRunnable\n  into DefaultRuntimeJob. It provides a unified way of running job in any hadoop cluster,\n  regardless of how the DefaultRuntimeJob is being started."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3585615390f886919c1195052252465eeab24843", "author": {"user": {"login": "chtyim", "name": "Terence Yim"}}, "url": "https://github.com/cdapio/cdap/commit/3585615390f886919c1195052252465eeab24843", "committedDate": "2020-03-17T00:35:44Z", "message": "Disable chatty spark logs."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ab55d5dec9fd6d3446fc9ddf2a7eab14c2ac808e", "author": {"user": {"login": "chtyim", "name": "Terence Yim"}}, "url": "https://github.com/cdapio/cdap/commit/ab55d5dec9fd6d3446fc9ddf2a7eab14c2ac808e", "committedDate": "2020-03-16T23:57:45Z", "message": "Disable chatty spark logs."}, "afterCommit": {"oid": "3585615390f886919c1195052252465eeab24843", "author": {"user": {"login": "chtyim", "name": "Terence Yim"}}, "url": "https://github.com/cdapio/cdap/commit/3585615390f886919c1195052252465eeab24843", "committedDate": "2020-03-17T00:35:44Z", "message": "Disable chatty spark logs."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2255, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}