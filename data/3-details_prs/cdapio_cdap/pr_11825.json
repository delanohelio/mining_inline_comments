{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY2MDY1NTk5", "number": 11825, "title": "[CDAP-16210] Support multiple hubs in UI", "bodyText": "Add framework support which allows connecting to multiple markets from UI", "createdAt": "2020-01-22T21:12:31Z", "url": "https://github.com/cdapio/cdap/pull/11825", "merged": true, "mergeCommit": {"oid": "ee56e03deb56cb4fd545ab8e05a7001f1f4a2102"}, "closed": true, "closedAt": "2020-03-11T22:34:10Z", "author": {"login": "Biao"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb-7Ro9AFqTM0OTgwNzA1NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMu7v2AFqTM3MzE3MjIzMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5ODA3MDU0", "url": "https://github.com/cdapio/cdap/pull/11825#pullrequestreview-349807054", "createdAt": "2020-01-29T01:01:54Z", "commit": {"oid": "a1a39c223b25364ca5ee6996e2b93591aca5e7b2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MTcxNDM1", "url": "https://github.com/cdapio/cdap/pull/11825#pullrequestreview-369171435", "createdAt": "2020-03-04T22:28:41Z", "commit": {"oid": "40d61999d2a35da82751b8f96e10081e51bc83a1"}, "state": "COMMENTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMjoyODo0MVrOFx__8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMjo1NjoyMFrOFyArnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3MzEwNQ==", "bodyText": "Why is the function returning empty string? This should be undefined if UI is trying fetch an asset form an unknown market right.", "url": "https://github.com/cdapio/cdap/pull/11825#discussion_r387973105", "createdAt": "2020-03-04T22:28:41Z", "author": {"login": "ajainarayanan"}, "path": "cdap-ui/app/cdap/api/market.js", "diffHunk": "@@ -19,14 +19,21 @@ import { apiCreatorAbsPath } from 'services/resource-helper';\n \n let dataSrc = DataSourceConfigurer.getInstance();\n const basepath = window.CDAP_CONFIG.marketUrl;\n+const basepaths = window.CDAP_CONFIG.marketUrls;\n // FIXME (CDAP-14836): Right now this is scattered across node and client. Need to consolidate this.\n const REQUEST_TYPE_MARKET = 'MARKET';\n const requestOptions = {\n   requestOrigin: REQUEST_TYPE_MARKET,\n };\n \n+function getVerifiedMarketBaseUrl(url) {\n+  const found = basepaths.find((element) => element === decodeURIComponent(url));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40d61999d2a35da82751b8f96e10081e51bc83a1"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3MzM2OA==", "bodyText": "nit: the input is also not url. It should be host. We are checking the host of the url to talk to right.", "url": "https://github.com/cdapio/cdap/pull/11825#discussion_r387973368", "createdAt": "2020-03-04T22:29:18Z", "author": {"login": "ajainarayanan"}, "path": "cdap-ui/app/cdap/api/market.js", "diffHunk": "@@ -19,14 +19,21 @@ import { apiCreatorAbsPath } from 'services/resource-helper';\n \n let dataSrc = DataSourceConfigurer.getInstance();\n const basepath = window.CDAP_CONFIG.marketUrl;\n+const basepaths = window.CDAP_CONFIG.marketUrls;\n // FIXME (CDAP-14836): Right now this is scattered across node and client. Need to consolidate this.\n const REQUEST_TYPE_MARKET = 'MARKET';\n const requestOptions = {\n   requestOrigin: REQUEST_TYPE_MARKET,\n };\n \n+function getVerifiedMarketBaseUrl(url) {\n+  const found = basepaths.find((element) => element === decodeURIComponent(url));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3MzEwNQ=="}, "originalCommit": {"oid": "40d61999d2a35da82751b8f96e10081e51bc83a1"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3NDQ4OQ==", "bodyText": "There could also be a case where basepaths could be empty right? If the user doesn't provide multiple market urls the property would be empty and we need to fallback to basepath", "url": "https://github.com/cdapio/cdap/pull/11825#discussion_r387974489", "createdAt": "2020-03-04T22:31:57Z", "author": {"login": "ajainarayanan"}, "path": "cdap-ui/app/cdap/api/market.js", "diffHunk": "@@ -35,11 +42,27 @@ export const MyMarketApi = {\n     `/packages/:packageName/:version/spec.json`,\n     requestOptions\n   ),\n-  getCategoryIcon: (category) => {\n-    return `${basepath}/categories/${category}/icon.png`;\n+  getCategoryIcon: (category, marketHost) => {\n+    if (basepaths.length === 0) {\n+      return `${basepath}/categories/${category}/icon.png`;\n+    }\n+\n+    if (marketHost) {\n+      const verifiedMarketHost = getVerifiedMarketBaseUrl(marketHost);\n+      return `${verifiedMarketHost}/categories/${category}/icon.png`;\n+    }\n+    return `${basepaths[0].url}/categories/${category}/icon.png`;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40d61999d2a35da82751b8f96e10081e51bc83a1"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3NTYzNA==", "bodyText": "Also assuming the default market would be at 0 index might not be valid all the time. The user can always change the order.", "url": "https://github.com/cdapio/cdap/pull/11825#discussion_r387975634", "createdAt": "2020-03-04T22:34:36Z", "author": {"login": "ajainarayanan"}, "path": "cdap-ui/app/cdap/api/market.js", "diffHunk": "@@ -35,11 +42,27 @@ export const MyMarketApi = {\n     `/packages/:packageName/:version/spec.json`,\n     requestOptions\n   ),\n-  getCategoryIcon: (category) => {\n-    return `${basepath}/categories/${category}/icon.png`;\n+  getCategoryIcon: (category, marketHost) => {\n+    if (basepaths.length === 0) {\n+      return `${basepath}/categories/${category}/icon.png`;\n+    }\n+\n+    if (marketHost) {\n+      const verifiedMarketHost = getVerifiedMarketBaseUrl(marketHost);\n+      return `${verifiedMarketHost}/categories/${category}/icon.png`;\n+    }\n+    return `${basepaths[0].url}/categories/${category}/icon.png`;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3NDQ4OQ=="}, "originalCommit": {"oid": "40d61999d2a35da82751b8f96e10081e51bc83a1"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3NzM3MQ==", "bodyText": "This might look a little unconventional, we are passing the path as main url and the host as query parameter. We can define the market host to be a url param, so that when we make a call to the Nodejs it already has the full url to talk to.\nFor instance in api/market.js we can define,\n{\n...\ngetSampleData: apiCreateorAbsPath(\n  dataSrc,\n  'GET',\n  'REQUEST',\n  ':host/packages/:entityName/:entityVersion/:filename',\n   requestOptions\n),\n...\n\nThis still makes the call to getSampleData the same, but the host is actually added and we send a valid market url.", "url": "https://github.com/cdapio/cdap/pull/11825#discussion_r387977371", "createdAt": "2020-03-04T22:39:02Z", "author": {"login": "ajainarayanan"}, "path": "cdap-ui/app/cdap/components/CaskWizards/LicenseStep/index.js", "diffHunk": "@@ -30,9 +31,11 @@ export default class LicenseStep extends Component {\n   }\n   componentWillMount() {\n     let { entityName, entityVersion, licenseFileName } = this.props;\n+    const marketHost = MarketStore.getState().selectedMarketHost;\n     let params = {\n       entityName,\n       entityVersion,\n+      marketHost,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40d61999d2a35da82751b8f96e10081e51bc83a1"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3NzgxNQ==", "bodyText": "Correspondingly we will change the matketPath directly to be full url instead of passing an additional marketHost as query parameter.", "url": "https://github.com/cdapio/cdap/pull/11825#discussion_r387977815", "createdAt": "2020-03-04T22:40:13Z", "author": {"login": "ajainarayanan"}, "path": "cdap-ui/app/cdap/components/CaskWizards/OneStepDeploy/OneStepDeployPlugin.js", "diffHunk": "@@ -129,6 +133,7 @@ export default class OneStepDeployPlugin extends Component {\n         }\n \n         let fetchUrl = `/forwardMarketToCdap?source=${marketPath}&target=${cdapPath}`;\n+        fetchUrl += marketHost ? `&marketHost=${encodeURIComponent(marketHost)}` : '';", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40d61999d2a35da82751b8f96e10081e51bc83a1"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3OTEzMw==", "bodyText": "nit: Remove?", "url": "https://github.com/cdapio/cdap/pull/11825#discussion_r387979133", "createdAt": "2020-03-04T22:43:29Z", "author": {"login": "ajainarayanan"}, "path": "cdap-ui/app/cdap/components/Market/index.js", "diffHunk": "@@ -49,12 +60,52 @@ export default class Market extends Component {\n       }\n     });\n \n-    MyMarketApi.list().subscribe(this.getCategories, (err) => {\n-      console.log('Error', err);\n-      MarketAction.setError();\n+    if (!enableMultipleHub()) {\n+      MyMarketApi.list().subscribe(this.getCategories, (err) => {\n+        this.handleMarketConnectionError(err);\n+      });\n+      return;\n+    }\n+\n+    this.populateMultipleMarkets();\n+  }\n+\n+  populateMultipleMarkets() {\n+    if (!enableMultipleHub()) {\n+      return;\n+    }\n+    const markets = window.CDAP_CONFIG.marketUrls;\n+\n+    // Cache all market names from market metadata.\n+    const observables = markets.map((marketHost) =>\n+      MyMarketApi.getMetaData({ marketHost }).catch(() => {\n+        // Fallback to \"Unknown\" as the market name. If the user clicks the unknown\n+        // market, a connection failure UI would most likly appear.\n+        return Observable.of({ marketName: 'Unknown' });\n+      })\n+    );\n+    Observable.forkJoin(observables).subscribe((marketMetas) => {\n+      const marketNames = marketMetas.map((marketMeta) => marketMeta.marketName);\n+      this.setState({ marketNames }, () => {\n+        const marketHost = markets[0];\n+        MyMarketApi.list({ marketHost }).subscribe(\n+          (packages) => {\n+            this.getCategories(packages, marketHost);\n+          },\n+          (err) => {\n+            this.handleMarketConnectionError(err, marketHost);\n+          }\n+        );\n+      });\n     });\n   }\n \n+  handleMarketConnectionError(e, marketHost) {\n+    console.log(e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40d61999d2a35da82751b8f96e10081e51bc83a1"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk4MDc4NQ==", "bodyText": "This should also be the window.CDAP_CONFIG.marketBaseUrl. We cannot assume the market 0 index will be the default.", "url": "https://github.com/cdapio/cdap/pull/11825#discussion_r387980785", "createdAt": "2020-03-04T22:47:31Z", "author": {"login": "ajainarayanan"}, "path": "cdap-ui/app/cdap/components/Market/store/market-store.js", "diffHunk": "@@ -21,8 +21,13 @@ import Version from 'services/VersionRange/Version';\n import VersionStore from 'services/VersionStore';\n import isNil from 'lodash/isNil';\n \n+function getDefaultMarketHost() {\n+  return window.CDAP_CONFIG.marketUrls.length > 0 ? window.CDAP_CONFIG.marketUrls[0] : '';", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40d61999d2a35da82751b8f96e10081e51bc83a1"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk4MTc2NQ==", "bodyText": "One solution would be to check if there is list of markets passed on and find the host that we host (marketBaseUrl). If there is no list then we should fallback to marketBaseUrl which will always be passed.\nThis assumes that we always set marketBaseUrl to be cdap default market.", "url": "https://github.com/cdapio/cdap/pull/11825#discussion_r387981765", "createdAt": "2020-03-04T22:50:04Z", "author": {"login": "ajainarayanan"}, "path": "cdap-ui/app/cdap/components/Market/store/market-store.js", "diffHunk": "@@ -21,8 +21,13 @@ import Version from 'services/VersionRange/Version';\n import VersionStore from 'services/VersionStore';\n import isNil from 'lodash/isNil';\n \n+function getDefaultMarketHost() {\n+  return window.CDAP_CONFIG.marketUrls.length > 0 ? window.CDAP_CONFIG.marketUrls[0] : '';", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk4MDc4NQ=="}, "originalCommit": {"oid": "40d61999d2a35da82751b8f96e10081e51bc83a1"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk4MjE1NA==", "bodyText": "This prompted, we should have a fallback to handle when user removes all market urls. We should the very least say no markets specified. We don't have to address it in this JIRA but we can come back to it later.", "url": "https://github.com/cdapio/cdap/pull/11825#discussion_r387982154", "createdAt": "2020-03-04T22:50:56Z", "author": {"login": "ajainarayanan"}, "path": "cdap-ui/app/cdap/components/Market/store/market-store.js", "diffHunk": "@@ -21,8 +21,13 @@ import Version from 'services/VersionRange/Version';\n import VersionStore from 'services/VersionStore';\n import isNil from 'lodash/isNil';\n \n+function getDefaultMarketHost() {\n+  return window.CDAP_CONFIG.marketUrls.length > 0 ? window.CDAP_CONFIG.marketUrls[0] : '';", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk4MDc4NQ=="}, "originalCommit": {"oid": "40d61999d2a35da82751b8f96e10081e51bc83a1"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk4NDI4NA==", "bodyText": "This should check if the sourceLink is a valid market url and return undefined.\nThe consumer (/forwardMarketToCdap) API should send a 403 response denying the request.\nAs an attacker I can construct a link like https:///forwardMarketToCdap?sourceLink=\"mymaliciousdomain.com/packages/malware\"&targetLink=\"cdap-instance\"", "url": "https://github.com/cdapio/cdap/pull/11825#discussion_r387984284", "createdAt": "2020-03-04T22:56:20Z", "author": {"login": "ajainarayanan"}, "path": "cdap-ui/server/url-helper.js", "diffHunk": "@@ -19,31 +19,63 @@\n const REQUEST_ORIGIN_ROUTER = 'ROUTER';\n const REQUEST_ORIGIN_MARKET = 'MARKET';\n \n+// return market host string from path's query parameter. empty string will be\n+// return if not found.\n+function getMarketHostParam(path) {\n+  const EXTRACT_MARKET_HOST_REGEX = /[?|&]marketHost=([^&]+).*$/;\n+  const matches = path.match(EXTRACT_MARKET_HOST_REGEX);\n+  return matches ? matches[1] : '';\n+}\n+\n+function getMarketUrls(cdapConfig) {\n+  return cdapConfig['market.base.urls'] ? cdapConfig['market.base.urls'].split('+') : [];\n+}\n+\n+function getVerifiedMarketHost(cdapConfig, urlOrPath) {\n+    if (!cdapConfig['market.base.urls']) {\n+      return `${cdapConfig['market.base.url']}`;\n+    }\n+\n+    const marketHost = getMarketHostParam(urlOrPath);\n+    const found = getMarketUrls(cdapConfig).find(element => element === decodeURIComponent(marketHost));\n+    return found ? found : '';", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40d61999d2a35da82751b8f96e10081e51bc83a1"}, "originalPosition": 23}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "79e99d55771e320c843ea89f6dd73901c53ef3d7", "author": {"user": {"login": "Biao", "name": "Biao She"}}, "url": "https://github.com/cdapio/cdap/commit/79e99d55771e320c843ea89f6dd73901c53ef3d7", "committedDate": "2020-03-09T18:58:57Z", "message": "Minor cleanup"}, "afterCommit": {"oid": "d3a841b3f054ab87af3ea0534d376112ff09cc24", "author": {"user": {"login": "Biao", "name": "Biao She"}}, "url": "https://github.com/cdapio/cdap/commit/d3a841b3f054ab87af3ea0534d376112ff09cc24", "committedDate": "2020-03-09T19:49:39Z", "message": "Minor cleanup"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d3a841b3f054ab87af3ea0534d376112ff09cc24", "author": {"user": {"login": "Biao", "name": "Biao She"}}, "url": "https://github.com/cdapio/cdap/commit/d3a841b3f054ab87af3ea0534d376112ff09cc24", "committedDate": "2020-03-09T19:49:39Z", "message": "Minor cleanup"}, "afterCommit": {"oid": "4502dc1e990f1657fb18bb2fb9b2df41db47e06c", "author": {"user": {"login": "Biao", "name": "Biao She"}}, "url": "https://github.com/cdapio/cdap/commit/4502dc1e990f1657fb18bb2fb9b2df41db47e06c", "committedDate": "2020-03-09T19:57:07Z", "message": "Address reviews"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxNjE1MTcz", "url": "https://github.com/cdapio/cdap/pull/11825#pullrequestreview-371615173", "createdAt": "2020-03-10T00:40:46Z", "commit": {"oid": "4502dc1e990f1657fb18bb2fb9b2df41db47e06c"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQwMDo0MDo0N1rOFz95Tg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQwMDo1MzoxNVrOFz-GDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAzNTc5MA==", "bodyText": "Can we fallback to the domain name? If there are too many markets without a /metadata api then it becomes hard to track which is a specific market user is looking for.", "url": "https://github.com/cdapio/cdap/pull/11825#discussion_r390035790", "createdAt": "2020-03-10T00:40:47Z", "author": {"login": "ajainarayanan"}, "path": "cdap-ui/app/cdap/components/Market/index.js", "diffHunk": "@@ -49,12 +56,52 @@ export default class Market extends Component {\n       }\n     });\n \n-    MyMarketApi.list().subscribe(this.getCategories, (err) => {\n-      console.log('Error', err);\n-      MarketAction.setError();\n+    if (hasMultipleMarkets()) {\n+      this.populateMarketNames();\n+      return;\n+    }\n+\n+    this.populateMarketPackages(window.CDAP_CONFIG.marketUrls[0]);\n+  }\n+\n+  populateMarketPackages(marketHost) {\n+    MyMarketApi.list({ marketHost }).subscribe(\n+      (packages) => {\n+        this.getCategories(packages, marketHost);\n+      },\n+      () => {\n+        this.handleMarketConnectionError(marketHost);\n+      }\n+    );\n+  }\n+\n+  populateMarketNames() {\n+    if (!hasMultipleMarkets()) {\n+      return;\n+    }\n+    const markets = window.CDAP_CONFIG.marketUrls;\n+\n+    // Cache all market names from market metadata.\n+    const observables = markets.map((marketHost) =>\n+      MyMarketApi.getMetaData({ marketHost }).catch(() => {\n+        // Fallback to \"Unknown\" as the market name. If the user clicks the unknown\n+        // market, a connection failure UI would most likly appear.\n+        return Observable.of({ marketName: 'Unknown' });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4502dc1e990f1657fb18bb2fb9b2df41db47e06c"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAzOTA1Mg==", "bodyText": "nit: Would we have to verify the host here? Shouldn't this be already done on any market url we get before constructing the url? If we return invalid-market-url I believe express server will still make the call right?", "url": "https://github.com/cdapio/cdap/pull/11825#discussion_r390039052", "createdAt": "2020-03-10T00:53:15Z", "author": {"login": "ajainarayanan"}, "path": "cdap-ui/server/url-helper.js", "diffHunk": "@@ -14,28 +14,57 @@\n  * the License.\n */\n \n+import memoize from 'lodash/memoize';\n+\n export const REQUEST_ORIGIN_ROUTER = 'ROUTER';\n export const REQUEST_ORIGIN_MARKET = 'MARKET';\n \n+function getRouterHost(cdapConfig) {\n+  const routerhost = cdapConfig['router.server.address'],\n+    routerport =\n+      cdapConfig['ssl.external.enabled'] === 'true'\n+        ? cdapConfig['router.ssl.server.port']\n+        : cdapConfig['router.server.port'],\n+    routerprotocol = cdapConfig['ssl.external.enabled'] === 'true' ? 'https' : 'http';\n+  return `${routerprotocol}://${routerhost}:${routerport}`;\n+}\n+\n+function extractMarketUrls(cdapConfig) {\n+  if (!cdapConfig) {\n+    return [];\n+  }\n+  const defaultMarketUrl = cdapConfig['market.base.url'];\n+  if (!cdapConfig['market.base.urls']) {\n+    return [defaultMarketUrl];\n+  }\n+  const marketUrls = cdapConfig['market.base.urls'].split('+');\n+  const filteredMarketUrls = marketUrls.filter(element => element !== defaultMarketUrl); \n+  // Make sure the default CDAP market is the first market.\n+  filteredMarketUrls.splice(0, 0, defaultMarketUrl);\n+  return filteredMarketUrls;\n+}\n+\n+export const getMarketUrls = memoize(extractMarketUrls);\n+\n+export function isVerifiedMarketHost(cdapConfig, url) {\n+  return !!getMarketUrls(cdapConfig).find(element => url.startsWith(element));\n+}\n+\n export function constructUrl(cdapConfig, path, origin = REQUEST_ORIGIN_ROUTER) {\n   if (!cdapConfig) {\n     return null;\n   }\n   path = path && path[0] === '/' ? path.slice(1) : path;\n   if (origin === REQUEST_ORIGIN_MARKET) {\n-    return `${cdapConfig['market.base.url']}/${path}`;\n+    return isVerifiedMarketHost(cdapConfig, path) ? path : 'invalid-market-url';", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4502dc1e990f1657fb18bb2fb9b2df41db47e06c"}, "originalPosition": 47}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxNjIwNDg5", "url": "https://github.com/cdapio/cdap/pull/11825#pullrequestreview-371620489", "createdAt": "2020-03-10T00:59:39Z", "commit": {"oid": "4502dc1e990f1657fb18bb2fb9b2df41db47e06c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQwMDo1OTozOVrOFz-McQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQwMDo1OTozOVrOFz-McQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA0MDY4OQ==", "bodyText": "nit: We can remove these I think", "url": "https://github.com/cdapio/cdap/pull/11825#discussion_r390040689", "createdAt": "2020-03-10T00:59:39Z", "author": {"login": "ajainarayanan"}, "path": "cdap-ui/app/cdap/services/resource-helper/index.js", "diffHunk": "@@ -54,6 +54,8 @@ function createApiFromExactPath(dataSrc, method, type, path, options = {}) {\n   return (params = {}, body, headers) => {\n     let url = buildUrl(path, params);\n \n+    console.log(`createApi path = ${path}`);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4502dc1e990f1657fb18bb2fb9b2df41db47e06c"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4502dc1e990f1657fb18bb2fb9b2df41db47e06c", "author": {"user": {"login": "Biao", "name": "Biao She"}}, "url": "https://github.com/cdapio/cdap/commit/4502dc1e990f1657fb18bb2fb9b2df41db47e06c", "committedDate": "2020-03-09T19:57:07Z", "message": "Address reviews"}, "afterCommit": {"oid": "3b35403bca880f121944a5996a995f386fa4e4bf", "author": {"user": {"login": "Biao", "name": "Biao She"}}, "url": "https://github.com/cdapio/cdap/commit/3b35403bca880f121944a5996a995f386fa4e4bf", "committedDate": "2020-03-10T14:08:40Z", "message": "Address more reviews"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3b35403bca880f121944a5996a995f386fa4e4bf", "author": {"user": {"login": "Biao", "name": "Biao She"}}, "url": "https://github.com/cdapio/cdap/commit/3b35403bca880f121944a5996a995f386fa4e4bf", "committedDate": "2020-03-10T14:08:40Z", "message": "Address more reviews"}, "afterCommit": {"oid": "475c16f08fb086b29476f3da181a1ca2def7970f", "author": {"user": {"login": "Biao", "name": "Biao She"}}, "url": "https://github.com/cdapio/cdap/commit/475c16f08fb086b29476f3da181a1ca2def7970f", "committedDate": "2020-03-10T22:07:16Z", "message": "Add support for multiple market in CDAP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "385371b749128fea4a17b99ced6aedd81305ae94", "author": {"user": {"login": "Biao", "name": "Biao She"}}, "url": "https://github.com/cdapio/cdap/commit/385371b749128fea4a17b99ced6aedd81305ae94", "committedDate": "2020-03-11T12:51:36Z", "message": "Add support for multiple market in CDAP"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "475c16f08fb086b29476f3da181a1ca2def7970f", "author": {"user": {"login": "Biao", "name": "Biao She"}}, "url": "https://github.com/cdapio/cdap/commit/475c16f08fb086b29476f3da181a1ca2def7970f", "committedDate": "2020-03-10T22:07:16Z", "message": "Add support for multiple market in CDAP"}, "afterCommit": {"oid": "385371b749128fea4a17b99ced6aedd81305ae94", "author": {"user": {"login": "Biao", "name": "Biao She"}}, "url": "https://github.com/cdapio/cdap/commit/385371b749128fea4a17b99ced6aedd81305ae94", "committedDate": "2020-03-11T12:51:36Z", "message": "Add support for multiple market in CDAP"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczMTcyMjMw", "url": "https://github.com/cdapio/cdap/pull/11825#pullrequestreview-373172230", "createdAt": "2020-03-11T22:34:04Z", "commit": {"oid": "385371b749128fea4a17b99ced6aedd81305ae94"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1368, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}