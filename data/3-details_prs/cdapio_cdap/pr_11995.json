{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkzMDg0Mzg1", "number": 11995, "title": "[CDAP-16458] Fixing integration tests", "bodyText": "Bugs fixed:\n\nMetadata page 404 test case in page level error suite was flaky because metadata page was rendering first and then after a delay 404 page was showing up.\nRuntime arguments save was not updating the view after opening the arugments modal first time in the tests. It had to be opened twice. This is a timing issue between runtime arguments being propagated through the backend and available for the UI to show.\n\nOther changes:\n\nUpdated runtime arguments tests.\nAdded a loading indicator on opening runtime arguments modal while retrieving the arugments.\nFixed some lint issues.", "createdAt": "2020-03-24T16:00:20Z", "url": "https://github.com/cdapio/cdap/pull/11995", "merged": true, "mergeCommit": {"oid": "9c6d3c265d3ef1f772c7ce52011f66af33cb9dc7"}, "closed": true, "closedAt": "2020-03-31T16:12:52Z", "author": {"login": "itsanudeep"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcQ2zMuAFqTM4MDU2NTAwMw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcS7VCnABqjMxODE0NzA2NjM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwNTY1MDAz", "url": "https://github.com/cdapio/cdap/pull/11995#pullrequestreview-380565003", "createdAt": "2020-03-24T17:59:16Z", "commit": {"oid": "4cc7251346ded169d5d041079642ca6a2f0be398"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxNzo1OToxNlrOF68nWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxNzo1OToyOFrOF68n9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM1NDg0MQ==", "bodyText": "nit: indent this", "url": "https://github.com/cdapio/cdap/pull/11995#discussion_r397354841", "createdAt": "2020-03-24T17:59:16Z", "author": {"login": "elfenheart"}, "path": "cdap-ui/app/tracker/tracker.html", "diffHunk": "@@ -36,18 +36,18 @@\n   ng-keyup=\"onSearch($event)\">\n       <my-global-navbar ng-if=\"!$state.params.iframe\"></my-global-navbar>\n \n-    <main class=\"container\" id=\"app-container\" ng-class=\"{'iframe': $state.params.iframe}\">\n-      <div ng-if=\"!BodyCtrl.pageLevelError\" ui-view></div>\n-      <page404 ng-if=\"BodyCtrl.pageLevelError && BodyCtrl.pageLevelError.errorCode === 404\"\n-      message=\"BodyCtrl.pageLevelError.message\"></page404>\n-      <page500 ng-if=\"BodyCtrl.pageLevelError && BodyCtrl.pageLevelError.errorCode !== 404\"\n-      message=\"BodyCtrl.pageLevelError.message\"></page500>\n+    <main ng-if=\"!BodyCtrl.pageLevelError\" class=\"container\" id=\"app-container\" ng-class=\"{'iframe': $state.params.iframe}\">\n+      <div ui-view></div>\n     </main>\n \n   <div class=\"alerts\" id=\"alerts\"></div>\n   <div ng-if=\"!$state.params.iframe\">\n     <loading-icon></loading-icon>\n     <loading-indicator></loading-indicator>\n+    <page404 ng-if=\"BodyCtrl.pageLevelError && BodyCtrl.pageLevelError.errorCode === 404\"\n+    message=\"BodyCtrl.pageLevelError.message\"></page404>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4cc7251346ded169d5d041079642ca6a2f0be398"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM1NDk5OA==", "bodyText": "nit: indent here too", "url": "https://github.com/cdapio/cdap/pull/11995#discussion_r397354998", "createdAt": "2020-03-24T17:59:28Z", "author": {"login": "elfenheart"}, "path": "cdap-ui/app/tracker/tracker.html", "diffHunk": "@@ -36,18 +36,18 @@\n   ng-keyup=\"onSearch($event)\">\n       <my-global-navbar ng-if=\"!$state.params.iframe\"></my-global-navbar>\n \n-    <main class=\"container\" id=\"app-container\" ng-class=\"{'iframe': $state.params.iframe}\">\n-      <div ng-if=\"!BodyCtrl.pageLevelError\" ui-view></div>\n-      <page404 ng-if=\"BodyCtrl.pageLevelError && BodyCtrl.pageLevelError.errorCode === 404\"\n-      message=\"BodyCtrl.pageLevelError.message\"></page404>\n-      <page500 ng-if=\"BodyCtrl.pageLevelError && BodyCtrl.pageLevelError.errorCode !== 404\"\n-      message=\"BodyCtrl.pageLevelError.message\"></page500>\n+    <main ng-if=\"!BodyCtrl.pageLevelError\" class=\"container\" id=\"app-container\" ng-class=\"{'iframe': $state.params.iframe}\">\n+      <div ui-view></div>\n     </main>\n \n   <div class=\"alerts\" id=\"alerts\"></div>\n   <div ng-if=\"!$state.params.iframe\">\n     <loading-icon></loading-icon>\n     <loading-indicator></loading-indicator>\n+    <page404 ng-if=\"BodyCtrl.pageLevelError && BodyCtrl.pageLevelError.errorCode === 404\"\n+    message=\"BodyCtrl.pageLevelError.message\"></page404>\n+    <page500 ng-if=\"BodyCtrl.pageLevelError && BodyCtrl.pageLevelError.errorCode !== 404\"\n+    message=\"BodyCtrl.pageLevelError.message\"></page500>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4cc7251346ded169d5d041079642ca6a2f0be398"}, "originalPosition": 21}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "51e99b5b174fe44a3285f35c1180e2965f961139", "author": {"user": {"login": "itsanudeep", "name": "Anudeep Katragadda"}}, "url": "https://github.com/cdapio/cdap/commit/51e99b5b174fe44a3285f35c1180e2965f961139", "committedDate": "2020-03-24T22:30:49Z", "message": "saving runtime arguments is synchronus"}, "afterCommit": {"oid": "4ced1172a5fa7f8d9930397b5b7b754563c9ba8a", "author": {"user": {"login": "itsanudeep", "name": "Anudeep Katragadda"}}, "url": "https://github.com/cdapio/cdap/commit/4ced1172a5fa7f8d9930397b5b7b754563c9ba8a", "committedDate": "2020-03-24T22:34:07Z", "message": "saving runtime arguments is synchronus"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwODAxODc4", "url": "https://github.com/cdapio/cdap/pull/11995#pullrequestreview-380801878", "createdAt": "2020-03-25T01:18:53Z", "commit": {"oid": "4ced1172a5fa7f8d9930397b5b7b754563c9ba8a"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwMToxODo1M1rOF7I5cA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwMToyMTozNFrOF7I8Gg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU1NjA4MA==", "bodyText": "Can we add more tests to add/edit/remove runtime arguments and reopening the modeless? We should try to imitate the test cases close to what the users might do.", "url": "https://github.com/cdapio/cdap/pull/11995#discussion_r397556080", "createdAt": "2020-03-25T01:18:53Z", "author": {"login": "ajainarayanan"}, "path": "cdap-ui/cypress/integration/pipeline.runtimeargs.spec.ts", "diffHunk": "@@ -410,4 +410,19 @@ describe('Deploying pipeline with saved runtime arguments', () => {\n     cy.get(dataCy('pipeline-run-btn')).click();\n     cy.get(dataCy('Succeeded'), { timeout: PIPELINE_RUN_TIMEOUT }).should('exist');\n   });\n+\n+  it('should have saved runtime arguments available',()=>{", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ced1172a5fa7f8d9930397b5b7b754563c9ba8a"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU1Njc2Mg==", "bodyText": "How does making this function async fix this issue? This is just a click handler right? As far as I debugged this issue, the store is incorrectly updated with old values when the user saves and closes the modeless.\nThis is a timing issue which I believe is happening every time we close the modeless where we update the preferences using a PUT call but before that we get the runtime arguments from the backend and update the store. So next time we show the modeless it is still the old value.\nI could have missed something but can you add comment as to why this needs to be async and how that fixes the issue?", "url": "https://github.com/cdapio/cdap/pull/11995#discussion_r397556762", "createdAt": "2020-03-25T01:21:34Z", "author": {"login": "ajainarayanan"}, "path": "cdap-ui/app/cdap/components/PipelineDetails/PipelineRuntimeArgsDropdownBtn/RuntimeArgsModeless/index.js", "diffHunk": "@@ -63,22 +63,26 @@ class RuntimeArgsModeless extends PureComponent {\n     });\n   };\n \n-  saveRuntimeArgs = () => {\n+  saveRuntimeArgs = async (e) => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ced1172a5fa7f8d9930397b5b7b754563c9ba8a"}, "originalPosition": 14}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3294385477bcd11ae91ccaf5d39504db6d843d16", "author": {"user": {"login": "itsanudeep", "name": "Anudeep Katragadda"}}, "url": "https://github.com/cdapio/cdap/commit/3294385477bcd11ae91ccaf5d39504db6d843d16", "committedDate": "2020-03-25T16:09:01Z", "message": "checking save btn does not exist i.e modal closed"}, "afterCommit": {"oid": "217aa8096427e660fad0bd59984c533ceb01ffe6", "author": {"user": {"login": "itsanudeep", "name": "Anudeep Katragadda"}}, "url": "https://github.com/cdapio/cdap/commit/217aa8096427e660fad0bd59984c533ceb01ffe6", "committedDate": "2020-03-25T16:46:17Z", "message": "checking run btn is available before clicking"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyMjQ3MzQ5", "url": "https://github.com/cdapio/cdap/pull/11995#pullrequestreview-382247349", "createdAt": "2020-03-26T17:34:41Z", "commit": {"oid": "99b1afdc52e49cd463c0fb8f5de3c3197da4a831"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNzozNDo0MVrOF8SfHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNzozODo1OVrOF8SqrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc2MTc1OA==", "bodyText": "why is preventPropagation needed?", "url": "https://github.com/cdapio/cdap/pull/11995#discussion_r398761758", "createdAt": "2020-03-26T17:34:41Z", "author": {"login": "elfenheart"}, "path": "cdap-ui/app/cdap/components/PipelineDetails/PipelineRuntimeArgsDropdownBtn/RuntimeArgsModeless/index.js", "diffHunk": "@@ -63,22 +67,28 @@ class RuntimeArgsModeless extends PureComponent {\n     });\n   };\n \n-  saveRuntimeArgs = () => {\n+  saveRuntimeArgs = async (e) => {\n+    preventPropagation(e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99b1afdc52e49cd463c0fb8f5de3c3197da4a831"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc2MzU0MQ==", "bodyText": "this is not necessary. Why do you need to convert updatePreference into a promise? it is an observable", "url": "https://github.com/cdapio/cdap/pull/11995#discussion_r398763541", "createdAt": "2020-03-26T17:37:19Z", "author": {"login": "elfenheart"}, "path": "cdap-ui/app/cdap/components/PipelineDetails/PipelineRuntimeArgsDropdownBtn/RuntimeArgsModeless/index.js", "diffHunk": "@@ -63,22 +63,26 @@ class RuntimeArgsModeless extends PureComponent {\n     });\n   };\n \n-  saveRuntimeArgs = () => {\n+  saveRuntimeArgs = async (e) => {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU1Njc2Mg=="}, "originalCommit": {"oid": "4ced1172a5fa7f8d9930397b5b7b754563c9ba8a"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc2NDcxNw==", "bodyText": "why does runtimeArgs have a key that is empty string? that seems like a bug", "url": "https://github.com/cdapio/cdap/pull/11995#discussion_r398764717", "createdAt": "2020-03-26T17:38:59Z", "author": {"login": "elfenheart"}, "path": "cdap-ui/app/cdap/components/PipelineDetails/RunLevelInfo/RunConfigs.js", "diffHunk": "@@ -84,8 +84,12 @@ export default class RunConfigs extends Component {\n \n     let runtimeArgs = objectQuery(this.props.currentRun, 'properties', 'runtimeArgs') || '';\n     try {\n-      runtimeArgs = JSON.parse(runtimeArgs);\n-      delete runtimeArgs[''];\n+      if (runtimeArgs === '') {\n+        runtimeArgs = {};\n+      } else {\n+        runtimeArgs = JSON.parse(runtimeArgs);\n+        delete runtimeArgs[''];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99b1afdc52e49cd463c0fb8f5de3c3197da4a831"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0MzQ5OTk4", "url": "https://github.com/cdapio/cdap/pull/11995#pullrequestreview-384349998", "createdAt": "2020-03-31T01:50:13Z", "commit": {"oid": "f452c98f9d8cbff1bb2a00a89851c444355e33ba"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwMTo1MDoxM1rOF-CbDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwMTo1MDoxM1rOF-CbDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU5NTcyNg==", "bodyText": "nit: typo alidating", "url": "https://github.com/cdapio/cdap/pull/11995#discussion_r400595726", "createdAt": "2020-03-31T01:50:13Z", "author": {"login": "elfenheart"}, "path": "cdap-ui/cypress/integration/pipeline.runtimeargs.spec.ts", "diffHunk": "@@ -364,50 +317,56 @@ describe('Deploying pipeline with saved runtime arguments', () => {\n \n   it('and running it should succeed.', () => {\n     cy.get('.arrow-btn-container').click();\n+    cy.get(dataCy(RUNTIME_ARGS_MODELESS_LOADING_SELECTOR)).should('not.exist');\n     cy.get(dataCy(RUNTIME_ARGS_DEPLOYED_SELECTOR)).should('exist');\n-    cy.get(\n-      `${dataCy(RUNTIME_ARGS_DEPLOYED_SELECTOR)} ${dataCy(0)} ${dataCy(\n-        RUNTIME_ARGS_KEY_SELECTOR\n-      )} input`\n-    ).should('be.disabled');\n-    cy.get(\n-      `${dataCy(RUNTIME_ARGS_DEPLOYED_SELECTOR)} ${dataCy(0)} ${dataCy(\n-        RUNTIME_ARGS_KEY_SELECTOR\n-      )} input`\n-    ).should('have.value', 'source_path');\n-    cy.get(\n-      `${dataCy(RUNTIME_ARGS_DEPLOYED_SELECTOR)} ${dataCy(0)} ${dataCy(\n-        RUNTIME_ARGS_VALUE_SELECTOR\n-      )} input`\n-    ).clear();\n-    cy.get(\n-      `${dataCy(RUNTIME_ARGS_DEPLOYED_SELECTOR)} ${dataCy(0)} ${dataCy(\n-        RUNTIME_ARGS_VALUE_SELECTOR\n-      )}`\n-    ).type(SOURCE_PATH_VAL);\n+    cy.assert_runtime_args_row(0, 'source_path', '', true);\n+    cy.assert_runtime_args_row(1, 'sink_path', '', true);\n+    cy.update_runtime_args_row(0, 'source_path', SOURCE_PATH_VAL, true);\n+    cy.update_runtime_args_row(1, 'sink_path', SINK_PATH_VAL, true);\n+    cy.get(dataCy('save-runtime-args-btn')).click();\n+    cy.get(dataCy('save-runtime-args-btn')).should('not.be.visible');\n+    cy.get(dataCy(\"pipeline-run-btn\")).should('be.visible');\n+    cy.get(dataCy('pipeline-run-btn')).click({ force: true });\n+    cy.get(dataCy('Succeeded'), { timeout: PIPELINE_RUN_TIMEOUT }).should('exist');\n+  });\n \n+  it('should have saved runtime arguments available and alidating other valid actions with runtime arguments', () => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f452c98f9d8cbff1bb2a00a89851c444355e33ba"}, "originalPosition": 179}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f1312a8bb332c659323624e8491f95cb639d47e", "author": {"user": {"login": "itsanudeep", "name": "Anudeep Katragadda"}}, "url": "https://github.com/cdapio/cdap/commit/3f1312a8bb332c659323624e8491f95cb639d47e", "committedDate": "2020-03-31T04:11:27Z", "message": "Fixing UI E2E integeration tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f452c98f9d8cbff1bb2a00a89851c444355e33ba", "author": {"user": {"login": "itsanudeep", "name": "Anudeep Katragadda"}}, "url": "https://github.com/cdapio/cdap/commit/f452c98f9d8cbff1bb2a00a89851c444355e33ba", "committedDate": "2020-03-30T16:06:15Z", "message": "removing promise for updatePreferences"}, "afterCommit": {"oid": "3f1312a8bb332c659323624e8491f95cb639d47e", "author": {"user": {"login": "itsanudeep", "name": "Anudeep Katragadda"}}, "url": "https://github.com/cdapio/cdap/commit/3f1312a8bb332c659323624e8491f95cb639d47e", "committedDate": "2020-03-31T04:11:27Z", "message": "Fixing UI E2E integeration tests"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1189, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}