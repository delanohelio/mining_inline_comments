{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA1Njk1MDUx", "number": 12086, "title": "[CDAP-16236] Reverts the change to remove check for macros before running preview", "bodyText": "JIRA: https://issues.cask.co/browse/CDAP-16236\nBuild: https://builds.cask.co/browse/CDAP-UDUT579-1\nE2E tests: https://builds.cask.co/browse/IT-UPD2141-1\nProblem:\n\nWe accidentally removed the check for macros before running preview. This shouldn't have been merged.\nThis was not caught by e2e tests (even though we had one) because is disabled in e2e testing environment\n\nFix:\n\nRevert the change\nMake tests run locally but skip in distributed environments.\nNote: The majority of change in this PR is in test and not in actual code.\n\nTODO:\n\nMake preview enabled in e2e environments", "createdAt": "2020-04-19T16:42:25Z", "url": "https://github.com/cdapio/cdap/pull/12086", "merged": true, "mergeCommit": {"oid": "c901423a48a24c08c80f1bc43a0741d1e865b35e"}, "closed": true, "closedAt": "2020-04-28T00:37:43Z", "author": {"login": "ajainarayanan"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcZ3GFmgFqTM5NzQ4MTg5NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcb4n3gABqjMyNzgwODA3MDM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NDgxODk1", "url": "https://github.com/cdapio/cdap/pull/12086#pullrequestreview-397481895", "createdAt": "2020-04-21T16:41:49Z", "commit": {"oid": "bca67625f280eee9cf47a475d691e14da0b6d6f6"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNjo0MTo0OVrOGJNvrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNzoxMjo1MlrOGJPMJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjMxNTU2Ng==", "bodyText": "nit: Can we name this something more appropriate? Having empty values is still valid to start a preview, it's just we don't want to 'Run' the preview right away without opening the modeless.", "url": "https://github.com/cdapio/cdap/pull/12086#discussion_r412315566", "createdAt": "2020-04-21T16:41:49Z", "author": {"login": "itsanudeep"}, "path": "cdap-ui/app/hydrator/controllers/create/toppanel-ctrl.js", "diffHunk": "@@ -502,6 +511,11 @@ class HydratorPlusPlusTopPanelCtrl {\n     this.previewStore.dispatch(\n       this.previewActions.setRuntimeArgsForDisplay(_.cloneDeep(this.runtimeArguments))\n     );\n+    this.validToStartPreview = this.isValidToStartPreview();\n+  }\n+\n+  isValidToStartPreview() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bca67625f280eee9cf47a475d691e14da0b6d6f6"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjMyNjA5Ng==", "bodyText": "Can we add a TODO to clean this up when we have preview enabled in bamboo?", "url": "https://github.com/cdapio/cdap/pull/12086#discussion_r412326096", "createdAt": "2020-04-21T16:55:05Z", "author": {"login": "itsanudeep"}, "path": "cdap-ui/cypress/integration/pipeline.runtimeargs.spec.ts", "diffHunk": "@@ -29,16 +33,23 @@ const PREVIEW_SUCCESS_BANNER_MSG =\n const SINK_PATH_VAL = '/tmp/cdap-ui-integration-fixtures';\n const SOURCE_PATH_VAL = 'file:/tmp/cdap-ui-integration-fixtures/airports.csv';\n \n-/* Disabling preview tests for now because our E2E tests don't have preview enabled\n- describe('Creating pipeline with macros ', () => {\n+let skipPreviewTests = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bca67625f280eee9cf47a475d691e14da0b6d6f6"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjMzOTIzNg==", "bodyText": "We were trying to avoid explicit wait statements like these, right? You can use cy.get('[title=\"Airport_source\"').should('exist'); to check if the pipeline is deployed like we do in other tests?", "url": "https://github.com/cdapio/cdap/pull/12086#discussion_r412339236", "createdAt": "2020-04-21T17:12:52Z", "author": {"login": "itsanudeep"}, "path": "cdap-ui/cypress/integration/pipeline.runtimeargs.spec.ts", "diffHunk": "@@ -48,21 +59,22 @@ const SOURCE_PATH_VAL = 'file:/tmp/cdap-ui-integration-fixtures/airports.csv';\n     getArtifactsPoll(headers);\n   });\n \n-  it('should be successful for preview', () => {\n+  it('and providing wrong runtime arguments should fail the pipeline preview.', () => {\n     // Go to Pipelines studio\n     cy.visit('/pipelines/ns/default/studio');\n-    cy.url().should('include', '/studio');\n+    cy.window().then((window) => {\n+      skipPreviewTests = window.CDAP_CONFIG.hydrator.previewEnabled !== true;\n+    });\n+    if (skipPreviewTests) {\n+      skip();\n+    }\n     cy.upload_pipeline(\n       'pipeline_with_macros.json',\n       '#pipeline-import-config-link > input[type=\"file\"]'\n-    ).then(subject => {\n-      expect(subject.length).to.be.eq(1);\n-    });\n-  });\n-\n-  it('and providing wrong runtime arguments should fail the pipeline preview.', () => {\n+    );\n+    cy.wait(10000);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bca67625f280eee9cf47a475d691e14da0b6d6f6"}, "originalPosition": 66}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5MjQxMTUw", "url": "https://github.com/cdapio/cdap/pull/12086#pullrequestreview-399241150", "createdAt": "2020-04-23T15:54:13Z", "commit": {"oid": "ccefd20cee4df56dcf2f77524565239af24d8690"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "412ad40314c01a56cd7622a48ed46bdbba61e060", "author": {"user": {"login": "ajainarayanan", "name": "Ajai"}}, "url": "https://github.com/cdapio/cdap/commit/412ad40314c01a56cd7622a48ed46bdbba61e060", "committedDate": "2020-04-28T00:19:27Z", "message": "[CDAP-16236] Reverts the change to remove check for macros before running preview\n\n - Fixes preview tests to be skipped on environments where preview is disabled\n - Fixes data-cy attribute of run button in preview to be consistent\n - Show runtime arguments if there are unfulfilled macros before running preview"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ccefd20cee4df56dcf2f77524565239af24d8690", "author": {"user": {"login": "ajainarayanan", "name": "Ajai"}}, "url": "https://github.com/cdapio/cdap/commit/ccefd20cee4df56dcf2f77524565239af24d8690", "committedDate": "2020-04-21T20:51:46Z", "message": "Adds todo to enable preview in distributed environment"}, "afterCommit": {"oid": "412ad40314c01a56cd7622a48ed46bdbba61e060", "author": {"user": {"login": "ajainarayanan", "name": "Ajai"}}, "url": "https://github.com/cdapio/cdap/commit/412ad40314c01a56cd7622a48ed46bdbba61e060", "committedDate": "2020-04-28T00:19:27Z", "message": "[CDAP-16236] Reverts the change to remove check for macros before running preview\n\n - Fixes preview tests to be skipped on environments where preview is disabled\n - Fixes data-cy attribute of run button in preview to be consistent\n - Show runtime arguments if there are unfulfilled macros before running preview"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2175, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}