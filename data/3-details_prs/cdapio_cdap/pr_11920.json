{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg0MDc0MzE3", "number": 11920, "title": "CDAP-16356 improve the field lineage compute algorithms", "bodyText": "JIRA: https://issues.cask.co/browse/CDAP-16356\nbuild: https://builds.cask.co/browse/CDAP-DUT7125-1\nThe old algorithm does a lot of repeated computation for the same operation name, introduce a map to remember for each operation name, what is the endpoint field related to it. If next time, the same operation is queried again, the result is already known. This reduces the exponential time complexity to number of the operations.", "createdAt": "2020-03-05T05:24:22Z", "url": "https://github.com/cdapio/cdap/pull/11920", "merged": true, "mergeCommit": {"oid": "dc36f231809dd080d02394a3c2eb25fa797bea30"}, "closed": true, "closedAt": "2020-03-05T10:48:17Z", "author": {"login": "yaojiefeng"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKkqQqABqjMwOTk3MTYxNzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKllgpgBqjMwOTk4NDEzMjU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b0eea8e06b4dd25a82360d2b39728ea87d72b558", "author": {"user": {"login": "yaojiefeng", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/b0eea8e06b4dd25a82360d2b39728ea87d72b558", "committedDate": "2020-03-05T05:23:12Z", "message": "CDAP-16356 improve the field lineage compute algorithms"}, "afterCommit": {"oid": "2ef119f5358fe23fe7e33d68b785509b147ac5be", "author": {"user": {"login": "yaojiefeng", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/2ef119f5358fe23fe7e33d68b785509b147ac5be", "committedDate": "2020-03-05T05:27:49Z", "message": "CDAP-16356 improve the field lineage compute algorithms"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MzExMTg2", "url": "https://github.com/cdapio/cdap/pull/11920#pullrequestreview-369311186", "createdAt": "2020-03-05T05:57:11Z", "commit": {"oid": "2ef119f5358fe23fe7e33d68b785509b147ac5be"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQwNTo1NzoxMVrOFyHOBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQwNTo1OTozNlrOFyHQTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODA5MTM5OA==", "bodyText": "Why need to create a new HashSet?", "url": "https://github.com/cdapio/cdap/pull/11920#discussion_r388091398", "createdAt": "2020-03-05T05:57:11Z", "author": {"login": "chtyim"}, "path": "cdap-data-fabric/src/main/java/io/cdap/cdap/data2/metadata/lineage/field/FieldLineageInfo.java", "diffHunk": "@@ -329,18 +329,30 @@ private long computeChecksum() {\n       computeAndValidateFieldLineageInfo(this.operations);\n     }\n \n+    Map<String, Set<EndPointField>> operationEndPointMap = new HashMap<>();\n     Map<EndPointField, Set<EndPointField>> summary = new HashMap<>();\n     for (WriteOperation write : writeOperations) {\n       List<InputField> inputs = write.getInputs();\n       for (InputField input : inputs) {\n-        computeIncomingSummaryHelper(new EndPointField(write.getDestination(), input.getName()),\n-                                     operationsMap.get(input.getOrigin()), write, summary);\n+        EndPointField dest = new EndPointField(write.getDestination(), input.getName());\n+        if (operationEndPointMap.containsKey(input.getOrigin())) {\n+          summary.put(dest, new HashSet<>(operationEndPointMap.get(input.getOrigin())));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ef119f5358fe23fe7e33d68b785509b147ac5be"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODA5MTc4NA==", "bodyText": "Better not to use continue in this case, but use an else clause for one liner if-else like in here.", "url": "https://github.com/cdapio/cdap/pull/11920#discussion_r388091784", "createdAt": "2020-03-05T05:58:45Z", "author": {"login": "chtyim"}, "path": "cdap-data-fabric/src/main/java/io/cdap/cdap/data2/metadata/lineage/field/FieldLineageInfo.java", "diffHunk": "@@ -329,18 +329,30 @@ private long computeChecksum() {\n       computeAndValidateFieldLineageInfo(this.operations);\n     }\n \n+    Map<String, Set<EndPointField>> operationEndPointMap = new HashMap<>();\n     Map<EndPointField, Set<EndPointField>> summary = new HashMap<>();\n     for (WriteOperation write : writeOperations) {\n       List<InputField> inputs = write.getInputs();\n       for (InputField input : inputs) {\n-        computeIncomingSummaryHelper(new EndPointField(write.getDestination(), input.getName()),\n-                                     operationsMap.get(input.getOrigin()), write, summary);\n+        EndPointField dest = new EndPointField(write.getDestination(), input.getName());\n+        if (operationEndPointMap.containsKey(input.getOrigin())) {\n+          summary.put(dest, new HashSet<>(operationEndPointMap.get(input.getOrigin())));\n+          continue;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ef119f5358fe23fe7e33d68b785509b147ac5be"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODA5MTk4MA==", "bodyText": "Add a timeout here (say 5 seconds), to guard against regression.", "url": "https://github.com/cdapio/cdap/pull/11920#discussion_r388091980", "createdAt": "2020-03-05T05:59:36Z", "author": {"login": "chtyim"}, "path": "cdap-data-fabric/src/test/java/io/cdap/cdap/data2/metadata/lineage/field/FieldLineageInfoTest.java", "diffHunk": "@@ -49,6 +55,51 @@\n     .registerTypeAdapter(Operation.class, new OperationTypeAdapter())\n     .create();\n \n+  @Test", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ef119f5358fe23fe7e33d68b785509b147ac5be"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00f5e6055b65735007dcb1a08ccc6fccdc7a2b4c", "author": {"user": {"login": "yaojiefeng", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/00f5e6055b65735007dcb1a08ccc6fccdc7a2b4c", "committedDate": "2020-03-05T06:32:29Z", "message": "CDAP-16356 improve the field lineage compute algorithms"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fdd5f24f66894fd80817771304eb9265fc6d6e6c", "author": {"user": {"login": "yaojiefeng", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/fdd5f24f66894fd80817771304eb9265fc6d6e6c", "committedDate": "2020-03-05T06:32:02Z", "message": "address comments"}, "afterCommit": {"oid": "00f5e6055b65735007dcb1a08ccc6fccdc7a2b4c", "author": {"user": {"login": "yaojiefeng", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/00f5e6055b65735007dcb1a08ccc6fccdc7a2b4c", "committedDate": "2020-03-05T06:32:29Z", "message": "CDAP-16356 improve the field lineage compute algorithms"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1330, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}