{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgwNjgyNzQw", "number": 11896, "title": "Add a new preferences http handler for internal usage", "bodyText": "Current handler returns Map<String, String>. Creating a new one for internal usage which returns PreferencesDetail that encapsulates the Map along with some other info.\nThis is server side of change in preparation of switching ProfileMetadataMessageProcessor from direct levelDB access to via REST API calls.", "createdAt": "2020-02-27T07:32:44Z", "url": "https://github.com/cdapio/cdap/pull/11896", "merged": true, "mergeCommit": {"oid": "ca1f1719fb8b65ed3ece5859e666269a87b7568e"}, "closed": true, "closedAt": "2020-02-29T02:15:12Z", "author": {"login": "wyzhang"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcIf7wOAFqTM2NTg5NTAzNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcI3LVTAFqTM2NjcwODY5OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1ODk1MDM0", "url": "https://github.com/cdapio/cdap/pull/11896#pullrequestreview-365895034", "createdAt": "2020-02-27T18:26:23Z", "commit": {"oid": "651f95e565b7fd4000e34556298701d71d3bf69b"}, "state": "COMMENTED", "comments": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxODoyNjoyM1rOFvcREQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxODo0OTozNVrOFvdBiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI5MDUxMw==", "bodyText": "style: indentation", "url": "https://github.com/cdapio/cdap/pull/11896#discussion_r385290513", "createdAt": "2020-02-27T18:26:23Z", "author": {"login": "albertshau"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/config/PreferencesService.java", "diffHunk": "@@ -64,15 +65,27 @@ public PreferencesService(MessagingService messagingService,\n     this.transactionRunner = transactionRunner;\n   }\n \n-  private Map<String, String> getConfigProperties(EntityId entityId) {\n+  private PreferencesDetail get(EntityId entityId) {\n     return TransactionRunners.run(transactionRunner, context -> {\n       return new PreferencesTable(context).getPreferences(entityId);\n     });\n   }\n \n+  private PreferencesDetail getResolved(EntityId entityId) {\n+    return TransactionRunners.run(transactionRunner, context -> {\n+        return new PreferencesTable(context).getResolvedPreferences(entityId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "651f95e565b7fd4000e34556298701d71d3bf69b"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI5MTM3MQ==", "bodyText": "can return get(entityId).getProperties()", "url": "https://github.com/cdapio/cdap/pull/11896#discussion_r385291371", "createdAt": "2020-02-27T18:27:59Z", "author": {"login": "albertshau"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/config/PreferencesService.java", "diffHunk": "@@ -64,15 +65,27 @@ public PreferencesService(MessagingService messagingService,\n     this.transactionRunner = transactionRunner;\n   }\n \n-  private Map<String, String> getConfigProperties(EntityId entityId) {\n+  private PreferencesDetail get(EntityId entityId) {\n     return TransactionRunners.run(transactionRunner, context -> {\n       return new PreferencesTable(context).getPreferences(entityId);\n     });\n   }\n \n+  private PreferencesDetail getResolved(EntityId entityId) {\n+    return TransactionRunners.run(transactionRunner, context -> {\n+        return new PreferencesTable(context).getResolvedPreferences(entityId);\n+    });\n+  }\n+\n+  private Map<String, String> getConfigProperties(EntityId entityId) {\n+    return TransactionRunners.run(transactionRunner, context -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "651f95e565b7fd4000e34556298701d71d3bf69b"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI5MjE0OA==", "bodyText": "it doesn't seem like we should have these methods anymore, with callers just getting them from the PreferencesDetail.\nIf this would affect a whole bunch of classes, we can also do this in a separate PR.", "url": "https://github.com/cdapio/cdap/pull/11896#discussion_r385292148", "createdAt": "2020-02-27T18:29:21Z", "author": {"login": "albertshau"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/config/PreferencesService.java", "diffHunk": "@@ -166,58 +179,66 @@ private void deleteConfig(EntityId entityId) {\n   /**\n    * Get instance level preferences\n    */\n-  public Map<String, String> getProperties() {\n-    return getConfigProperties(new InstanceId(\"\"));\n-  }\n+  public Map<String, String> getProperties() { return getConfigProperties(new InstanceId(\"\")); }\n+\n+  public PreferencesDetail getPreferences() { return get(new InstanceId(\"\")); }\n+\n \n   /**\n    * Get namespace level preferences\n    */\n-  public Map<String, String> getProperties(NamespaceId namespaceId) {\n-    return getConfigProperties(namespaceId);\n-  }\n+  public Map<String, String> getProperties(NamespaceId namespaceId) { return getConfigProperties(namespaceId); }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "651f95e565b7fd4000e34556298701d71d3bf69b"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI5MjMyNg==", "bodyText": "style: newline between methods", "url": "https://github.com/cdapio/cdap/pull/11896#discussion_r385292326", "createdAt": "2020-02-27T18:29:43Z", "author": {"login": "albertshau"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/config/PreferencesService.java", "diffHunk": "@@ -166,58 +179,66 @@ private void deleteConfig(EntityId entityId) {\n   /**\n    * Get instance level preferences\n    */\n-  public Map<String, String> getProperties() {\n-    return getConfigProperties(new InstanceId(\"\"));\n-  }\n+  public Map<String, String> getProperties() { return getConfigProperties(new InstanceId(\"\")); }\n+\n+  public PreferencesDetail getPreferences() { return get(new InstanceId(\"\")); }\n+\n \n   /**\n    * Get namespace level preferences\n    */\n-  public Map<String, String> getProperties(NamespaceId namespaceId) {\n-    return getConfigProperties(namespaceId);\n-  }\n+  public Map<String, String> getProperties(NamespaceId namespaceId) { return getConfigProperties(namespaceId); }\n+\n+  public PreferencesDetail getPreferences(NamespaceId namespaceId) { return get(namespaceId); }\n+\n \n   /**\n    * Get app level preferences\n    */\n   public Map<String, String> getProperties(ApplicationId applicationId) {\n     return getConfigProperties(applicationId);\n   }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "651f95e565b7fd4000e34556298701d71d3bf69b"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI5NDEyMQ==", "bodyText": "can you add a javadoc to this method, it's not immediately obvious what merge means", "url": "https://github.com/cdapio/cdap/pull/11896#discussion_r385294121", "createdAt": "2020-02-27T18:33:03Z", "author": {"login": "albertshau"}, "path": "cdap-proto/src/main/java/io/cdap/cdap/proto/PreferencesDetail.java", "diffHunk": "@@ -0,0 +1,109 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.proto;\n+\n+import javax.annotation.Nullable;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+/**\n+ * Represent preferences\n+ */\n+public class PreferencesDetail {\n+  private final Map<String, String> properties;\n+  /**\n+   * Sequence id of operations on the preferences\n+   */\n+  private final Long seqId;\n+  /**\n+   * Whether it is a resolved preferences or not.\n+   */\n+  private boolean resolved;\n+\n+  public static PreferencesDetail merge(PreferencesDetail left, PreferencesDetail right) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "651f95e565b7fd4000e34556298701d71d3bf69b"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI5NTA1Mg==", "bodyText": "by convention, anything that isn't annotated as @Nullable is assumed to be non-null, and in general we try to avoid null values when possible. When would be trying to merge a null?", "url": "https://github.com/cdapio/cdap/pull/11896#discussion_r385295052", "createdAt": "2020-02-27T18:34:52Z", "author": {"login": "albertshau"}, "path": "cdap-proto/src/main/java/io/cdap/cdap/proto/PreferencesDetail.java", "diffHunk": "@@ -0,0 +1,109 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.proto;\n+\n+import javax.annotation.Nullable;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+/**\n+ * Represent preferences\n+ */\n+public class PreferencesDetail {\n+  private final Map<String, String> properties;\n+  /**\n+   * Sequence id of operations on the preferences\n+   */\n+  private final Long seqId;\n+  /**\n+   * Whether it is a resolved preferences or not.\n+   */\n+  private boolean resolved;\n+\n+  public static PreferencesDetail merge(PreferencesDetail left, PreferencesDetail right) {\n+    if (left == null && right == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "651f95e565b7fd4000e34556298701d71d3bf69b"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI5NzMzNA==", "bodyText": "I don't think we should allow seqId to be null, as that isn't a valid representation of stored preferences. It forces the caller of getSeqId() to handle a null, which shouldn't ever be the case", "url": "https://github.com/cdapio/cdap/pull/11896#discussion_r385297334", "createdAt": "2020-02-27T18:39:06Z", "author": {"login": "albertshau"}, "path": "cdap-proto/src/main/java/io/cdap/cdap/proto/PreferencesDetail.java", "diffHunk": "@@ -0,0 +1,109 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.proto;\n+\n+import javax.annotation.Nullable;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+/**\n+ * Represent preferences\n+ */\n+public class PreferencesDetail {\n+  private final Map<String, String> properties;\n+  /**\n+   * Sequence id of operations on the preferences\n+   */\n+  private final Long seqId;\n+  /**\n+   * Whether it is a resolved preferences or not.\n+   */\n+  private boolean resolved;\n+\n+  public static PreferencesDetail merge(PreferencesDetail left, PreferencesDetail right) {\n+    if (left == null && right == null) {\n+      return null;\n+    } else if (left == null) {\n+      return right;\n+    } else if (right == null) {\n+      return left;\n+    }\n+\n+    Map<String, String> properties = new HashMap<>();\n+    properties.putAll(left.getProperties());\n+    properties.putAll(right.getProperties());\n+\n+    Long seqId = null;\n+    Long leftSeqId = left.getSeqId();\n+    Long rightSeqId = right.getSeqId();\n+    if (leftSeqId != null && rightSeqId != null) {\n+      seqId = Long.max(leftSeqId.longValue(), rightSeqId.longValue());\n+    } else if (leftSeqId != null) {\n+      seqId = new Long(leftSeqId.longValue());\n+    } else if (rightSeqId != null) {\n+      seqId = new Long(rightSeqId.longValue());\n+    }\n+\n+    boolean resolved = (left.resolved || right.resolved);\n+    return new PreferencesDetail(properties, seqId, resolved);\n+  }\n+\n+  public PreferencesDetail(Map<String, String> properties, @Nullable Long seqId, boolean resolved) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "651f95e565b7fd4000e34556298701d71d3bf69b"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI5ODIwOQ==", "bodyText": "I believe sendJson will serialize the object to json automatically, which mean you don't need the GSON.toJson()", "url": "https://github.com/cdapio/cdap/pull/11896#discussion_r385298209", "createdAt": "2020-02-27T18:40:51Z", "author": {"login": "albertshau"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/gateway/handlers/PreferencesHttpHandlerInternal.java", "diffHunk": "@@ -0,0 +1,133 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.gateway.handlers;\n+\n+import com.google.gson.Gson;\n+import com.google.inject.Inject;\n+import io.cdap.cdap.common.BadRequestException;\n+import io.cdap.cdap.common.NamespaceNotFoundException;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.namespace.NamespaceQueryAdmin;\n+import io.cdap.cdap.config.PreferencesService;\n+import io.cdap.cdap.gateway.handlers.util.AbstractAppFabricHttpHandler;\n+import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n+import io.cdap.cdap.proto.PreferencesDetail;\n+import io.cdap.cdap.proto.ProgramType;\n+import io.cdap.cdap.proto.id.ApplicationId;\n+import io.cdap.cdap.proto.id.NamespaceId;\n+import io.cdap.cdap.proto.id.ProgramId;\n+import io.cdap.http.HttpResponder;\n+import io.netty.handler.codec.http.HttpRequest;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+\n+import javax.ws.rs.GET;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.PathParam;\n+import javax.ws.rs.QueryParam;\n+\n+/**\n+ * Program Preferences HTTP Handler for internal usage\n+ */\n+@Path(Constants.Gateway.INTERNAL_API_VERSION_3)\n+public class PreferencesHttpHandlerInternal extends AbstractAppFabricHttpHandler {\n+\n+  private static final Gson GSON = new Gson();\n+\n+  private final PreferencesService preferencesService;\n+  private final ApplicationLifecycleService applicationLifecycleService;\n+  private final NamespaceQueryAdmin namespaceQueryAdmin;\n+\n+  @Inject\n+  PreferencesHttpHandlerInternal(PreferencesService preferencesService,\n+                                 ApplicationLifecycleService applicationLifecycleService,\n+                                 NamespaceQueryAdmin namespaceQueryAdmin) {\n+    this.preferencesService = preferencesService;\n+    this.applicationLifecycleService = applicationLifecycleService;\n+    this.namespaceQueryAdmin = namespaceQueryAdmin;\n+  }\n+\n+  @Path(\"/preferences\")\n+  @GET\n+  public void getInstancePreferences(HttpRequest request, HttpResponder responder) {\n+    PreferencesDetail detail = preferencesService.getPreferences();\n+    responder.sendJson(HttpResponseStatus.OK, GSON.toJson(detail, PreferencesDetail.class));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "651f95e565b7fd4000e34556298701d71d3bf69b"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI5OTQwMg==", "bodyText": "this should be returning a 404 if the app exists but the program does not", "url": "https://github.com/cdapio/cdap/pull/11896#discussion_r385299402", "createdAt": "2020-02-27T18:42:59Z", "author": {"login": "albertshau"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/gateway/handlers/PreferencesHttpHandlerInternal.java", "diffHunk": "@@ -0,0 +1,133 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.gateway.handlers;\n+\n+import com.google.gson.Gson;\n+import com.google.inject.Inject;\n+import io.cdap.cdap.common.BadRequestException;\n+import io.cdap.cdap.common.NamespaceNotFoundException;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.namespace.NamespaceQueryAdmin;\n+import io.cdap.cdap.config.PreferencesService;\n+import io.cdap.cdap.gateway.handlers.util.AbstractAppFabricHttpHandler;\n+import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n+import io.cdap.cdap.proto.PreferencesDetail;\n+import io.cdap.cdap.proto.ProgramType;\n+import io.cdap.cdap.proto.id.ApplicationId;\n+import io.cdap.cdap.proto.id.NamespaceId;\n+import io.cdap.cdap.proto.id.ProgramId;\n+import io.cdap.http.HttpResponder;\n+import io.netty.handler.codec.http.HttpRequest;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+\n+import javax.ws.rs.GET;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.PathParam;\n+import javax.ws.rs.QueryParam;\n+\n+/**\n+ * Program Preferences HTTP Handler for internal usage\n+ */\n+@Path(Constants.Gateway.INTERNAL_API_VERSION_3)\n+public class PreferencesHttpHandlerInternal extends AbstractAppFabricHttpHandler {\n+\n+  private static final Gson GSON = new Gson();\n+\n+  private final PreferencesService preferencesService;\n+  private final ApplicationLifecycleService applicationLifecycleService;\n+  private final NamespaceQueryAdmin namespaceQueryAdmin;\n+\n+  @Inject\n+  PreferencesHttpHandlerInternal(PreferencesService preferencesService,\n+                                 ApplicationLifecycleService applicationLifecycleService,\n+                                 NamespaceQueryAdmin namespaceQueryAdmin) {\n+    this.preferencesService = preferencesService;\n+    this.applicationLifecycleService = applicationLifecycleService;\n+    this.namespaceQueryAdmin = namespaceQueryAdmin;\n+  }\n+\n+  @Path(\"/preferences\")\n+  @GET\n+  public void getInstancePreferences(HttpRequest request, HttpResponder responder) {\n+    PreferencesDetail detail = preferencesService.getPreferences();\n+    responder.sendJson(HttpResponseStatus.OK, GSON.toJson(detail, PreferencesDetail.class));\n+  }\n+\n+  @Path(\"/namespaces/{namespace-id}/preferences\")\n+  @GET\n+  public void getNamespacePreferences(HttpRequest request, HttpResponder responder,\n+                                      @PathParam(\"namespace-id\") String namespace, @QueryParam(\"resolved\") boolean resolved) throws Exception {\n+    NamespaceId namespaceId = new NamespaceId(namespace);\n+    if (!namespaceQueryAdmin.exists(namespaceId)) {\n+      throw new NamespaceNotFoundException(namespaceId);\n+    }\n+    PreferencesDetail detail;\n+    if (resolved) {\n+      detail = preferencesService.getResolvedPreferences(namespaceId);\n+    } else {\n+      detail = preferencesService.getPreferences(namespaceId);\n+    }\n+    responder.sendJson(HttpResponseStatus.OK, GSON.toJson(detail, PreferencesDetail.class));\n+  }\n+\n+  @Path(\"/namespaces/{namespace-id}/apps/{application-id}/preferences\")\n+  @GET\n+  public void getApplicationPreferences(HttpRequest request, HttpResponder responder,\n+                                        @PathParam(\"namespace-id\") String namespace, @PathParam(\"application-id\") String appId,\n+                                        @QueryParam(\"resolved\") boolean resolved) throws Exception {\n+    ApplicationId applicationId = new ApplicationId(namespace, appId);\n+    applicationLifecycleService.getAppDetail(applicationId);\n+    PreferencesDetail detail;\n+    if (resolved) {\n+      detail = preferencesService.getResolvedPreferences(applicationId);\n+    } else {\n+      detail = preferencesService.getPreferences(applicationId);\n+    }\n+    responder.sendJson(HttpResponseStatus.OK, GSON.toJson(detail, PreferencesDetail.class));\n+  }\n+\n+  @Path(\"/namespaces/{namespace-id}/apps/{application-id}/{program-type}/{program-id}/preferences\")\n+  @GET\n+  public void getProgramPreferences(HttpRequest request, HttpResponder responder,\n+                                    @PathParam(\"namespace-id\") String namespace, @PathParam(\"application-id\") String appId,\n+                                    @PathParam(\"program-type\") String programType, @PathParam(\"program-id\") String programId,\n+                                    @QueryParam(\"resolved\") boolean resolved) throws Exception {\n+    ProgramId program = new ProgramId(namespace, appId, getProgramType(programType), programId);\n+    applicationLifecycleService.getAppDetail(program.getParent());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "651f95e565b7fd4000e34556298701d71d3bf69b"}, "originalPosition": 110}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTMwMjkyMw==", "bodyText": "I think it's more descriptive to name the method resolve(), with 'parent' and 'child' instead of 'left' and 'right'.", "url": "https://github.com/cdapio/cdap/pull/11896#discussion_r385302923", "createdAt": "2020-02-27T18:49:35Z", "author": {"login": "albertshau"}, "path": "cdap-proto/src/main/java/io/cdap/cdap/proto/PreferencesDetail.java", "diffHunk": "@@ -0,0 +1,109 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.proto;\n+\n+import javax.annotation.Nullable;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+/**\n+ * Represent preferences\n+ */\n+public class PreferencesDetail {\n+  private final Map<String, String> properties;\n+  /**\n+   * Sequence id of operations on the preferences\n+   */\n+  private final Long seqId;\n+  /**\n+   * Whether it is a resolved preferences or not.\n+   */\n+  private boolean resolved;\n+\n+  public static PreferencesDetail merge(PreferencesDetail left, PreferencesDetail right) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI5NDEyMQ=="}, "originalCommit": {"oid": "651f95e565b7fd4000e34556298701d71d3bf69b"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2MDY5MDE2", "url": "https://github.com/cdapio/cdap/pull/11896#pullrequestreview-366069016", "createdAt": "2020-02-27T23:21:42Z", "commit": {"oid": "2f8fddaf1f86482be0fee98da9f4fc3a1dd6ab2a"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QyMzoyMTo0M1rOFvko1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QyMzoyNDowMlrOFvkrpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQyNzY3MQ==", "bodyText": "if it can't be null, it should be a long instead of a Long", "url": "https://github.com/cdapio/cdap/pull/11896#discussion_r385427671", "createdAt": "2020-02-27T23:21:43Z", "author": {"login": "albertshau"}, "path": "cdap-proto/src/main/java/io/cdap/cdap/proto/PreferencesDetail.java", "diffHunk": "@@ -28,55 +27,47 @@\n   private final Map<String, String> properties;\n   /**\n    * Sequence id of operations on the preferences\n+   * Normally this should be > 0. But can be 0 indicating that no preferences have been set on the entity.\n    */\n   private final Long seqId;\n   /**\n    * Whether it is a resolved preferences or not.\n    */\n   private boolean resolved;\n \n-  public static PreferencesDetail merge(PreferencesDetail left, PreferencesDetail right) {\n-    if (left == null && right == null) {\n-      return null;\n-    } else if (left == null) {\n-      return right;\n-    } else if (right == null) {\n-      return left;\n-    }\n-\n+  /**\n+   * Return a resolved preference detail where preferences in {@code parent} take precedence over\n+   * those in {@code child}. The {@code seqId} would be the max of the two.\n+   */\n+  public static PreferencesDetail resolve(PreferencesDetail parent, PreferencesDetail child) {\n     Map<String, String> properties = new HashMap<>();\n-    properties.putAll(left.getProperties());\n-    properties.putAll(right.getProperties());\n+    // Copy child's properties first.\n+    properties.putAll(child.getProperties());\n+    // Add parent's properties and overrides any existing properties in child;\n+    properties.putAll(parent.getProperties());\n \n-    Long seqId = null;\n-    Long leftSeqId = left.getSeqId();\n-    Long rightSeqId = right.getSeqId();\n-    if (leftSeqId != null && rightSeqId != null) {\n-      seqId = Long.max(leftSeqId.longValue(), rightSeqId.longValue());\n-    } else if (leftSeqId != null) {\n-      seqId = new Long(leftSeqId.longValue());\n-    } else if (rightSeqId != null) {\n-      seqId = new Long(rightSeqId.longValue());\n-    }\n+    Long seqId = getMaxSeqId(parent.getSeqId(), child.getSeqId());\n \n-    boolean resolved = (left.resolved || right.resolved);\n-    return new PreferencesDetail(properties, seqId, resolved);\n+    return new PreferencesDetail(properties, seqId, true);\n   }\n \n-  public PreferencesDetail(Map<String, String> properties, @Nullable Long seqId, boolean resolved) {\n+  public PreferencesDetail(Map<String, String> properties, Long seqId, boolean resolved) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f8fddaf1f86482be0fee98da9f4fc3a1dd6ab2a"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQyNzg4OQ==", "bodyText": "there isn't much value in this method, can just call Long.max directly", "url": "https://github.com/cdapio/cdap/pull/11896#discussion_r385427889", "createdAt": "2020-02-27T23:22:23Z", "author": {"login": "albertshau"}, "path": "cdap-proto/src/main/java/io/cdap/cdap/proto/PreferencesDetail.java", "diffHunk": "@@ -105,5 +96,9 @@ public String toString() {\n       \"resolved='\" + resolved +\n       '}';\n   }\n+\n+  public static Long getMaxSeqId(Long left, Long right) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f8fddaf1f86482be0fee98da9f4fc3a1dd6ab2a"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQyODM5MQ==", "bodyText": "I see. Does this cause any issues if preferences are set and then deleted? If the sequence number gets reset in that scenario, it would mean some of the assumptions in that metadata processor are false.", "url": "https://github.com/cdapio/cdap/pull/11896#discussion_r385428391", "createdAt": "2020-02-27T23:24:02Z", "author": {"login": "albertshau"}, "path": "cdap-proto/src/main/java/io/cdap/cdap/proto/PreferencesDetail.java", "diffHunk": "@@ -0,0 +1,109 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.proto;\n+\n+import javax.annotation.Nullable;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+/**\n+ * Represent preferences\n+ */\n+public class PreferencesDetail {\n+  private final Map<String, String> properties;\n+  /**\n+   * Sequence id of operations on the preferences\n+   */\n+  private final Long seqId;\n+  /**\n+   * Whether it is a resolved preferences or not.\n+   */\n+  private boolean resolved;\n+\n+  public static PreferencesDetail merge(PreferencesDetail left, PreferencesDetail right) {\n+    if (left == null && right == null) {\n+      return null;\n+    } else if (left == null) {\n+      return right;\n+    } else if (right == null) {\n+      return left;\n+    }\n+\n+    Map<String, String> properties = new HashMap<>();\n+    properties.putAll(left.getProperties());\n+    properties.putAll(right.getProperties());\n+\n+    Long seqId = null;\n+    Long leftSeqId = left.getSeqId();\n+    Long rightSeqId = right.getSeqId();\n+    if (leftSeqId != null && rightSeqId != null) {\n+      seqId = Long.max(leftSeqId.longValue(), rightSeqId.longValue());\n+    } else if (leftSeqId != null) {\n+      seqId = new Long(leftSeqId.longValue());\n+    } else if (rightSeqId != null) {\n+      seqId = new Long(rightSeqId.longValue());\n+    }\n+\n+    boolean resolved = (left.resolved || right.resolved);\n+    return new PreferencesDetail(properties, seqId, resolved);\n+  }\n+\n+  public PreferencesDetail(Map<String, String> properties, @Nullable Long seqId, boolean resolved) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI5NzMzNA=="}, "originalCommit": {"oid": "651f95e565b7fd4000e34556298701d71d3bf69b"}, "originalPosition": 66}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "02b5e2de3c5d05027220a94a4f6a57822f083fb3", "author": {"user": {"login": "wyzhang", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/02b5e2de3c5d05027220a94a4f6a57822f083fb3", "committedDate": "2020-02-28T01:56:02Z", "message": "Fixing style issues"}, "afterCommit": {"oid": "689fc16e61a10b8ee9c4275d8d345a2faee8f4e8", "author": {"user": {"login": "wyzhang", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/689fc16e61a10b8ee9c4275d8d345a2faee8f4e8", "committedDate": "2020-02-28T18:25:26Z", "message": "Fixing style issues"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2NjEyNDYy", "url": "https://github.com/cdapio/cdap/pull/11896#pullrequestreview-366612462", "createdAt": "2020-02-28T18:53:27Z", "commit": {"oid": "689fc16e61a10b8ee9c4275d8d345a2faee8f4e8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2653681985be9888a9390a24f758ad553f93f495", "author": {"user": {"login": "wyzhang", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/2653681985be9888a9390a24f758ad553f93f495", "committedDate": "2020-02-28T19:42:52Z", "message": "(CDAP-16353) Add a preferences http handler returning PreferencesDetail\n(for internal usage only)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "689fc16e61a10b8ee9c4275d8d345a2faee8f4e8", "author": {"user": {"login": "wyzhang", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/689fc16e61a10b8ee9c4275d8d345a2faee8f4e8", "committedDate": "2020-02-28T18:25:26Z", "message": "Fixing style issues"}, "afterCommit": {"oid": "2653681985be9888a9390a24f758ad553f93f495", "author": {"user": {"login": "wyzhang", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/2653681985be9888a9390a24f758ad553f93f495", "committedDate": "2020-02-28T19:42:52Z", "message": "(CDAP-16353) Add a preferences http handler returning PreferencesDetail\n(for internal usage only)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ba0b8f7295fe3cc6114cbf4291e8e3b3bb48dbd", "author": {"user": {"login": "wyzhang", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/0ba0b8f7295fe3cc6114cbf4291e8e3b3bb48dbd", "committedDate": "2020-02-28T21:17:57Z", "message": "Fixing a bug in preferences merge method (child take precedence over\nparent).\n\nAdding test cases for this case"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2NzA4Njk4", "url": "https://github.com/cdapio/cdap/pull/11896#pullrequestreview-366708698", "createdAt": "2020-02-28T21:54:38Z", "commit": {"oid": "0ba0b8f7295fe3cc6114cbf4291e8e3b3bb48dbd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1301, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}