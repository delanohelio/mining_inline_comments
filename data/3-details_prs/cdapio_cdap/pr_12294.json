{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMyNzMwODkx", "number": 12294, "title": "(CDAP-16918) Added a REST endpoint to export all application details", "bodyText": "A new scanApplications method is added to AppMetadataStore for scanning applications progressively.\nA new scanApplications method is added to Store for scanning all applications with multiple small transactions\nA new createAppDetailsArchive method is added to ApplicationLifecycleService for writing out ZIP archive that contains all application detail json files\nA new class InstanceOperationHttpHandler is added, with a new REST API /v3/export/apps for downloading the ZIP archive through REST. It also contains a SHA-256 digest for content validation.", "createdAt": "2020-06-10T22:17:19Z", "url": "https://github.com/cdapio/cdap/pull/12294", "merged": true, "mergeCommit": {"oid": "3d07e33fce0cc0d8edc880321c31171d87ae9231"}, "closed": true, "closedAt": "2020-06-11T02:34:26Z", "author": {"login": "chtyim"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcqBRnjgBqjM0MzE2NzQwODQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcqEM80ABqjM0MzIwNzAyODI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6cf495433d9940b146adcb431ec9d6bf0f798621", "author": {"user": {"login": "chtyim", "name": "Terence Yim"}}, "url": "https://github.com/cdapio/cdap/commit/6cf495433d9940b146adcb431ec9d6bf0f798621", "committedDate": "2020-06-10T22:12:02Z", "message": "(CDAP-16918) Added REST endpoint to export all applications\n\n- A new instance level endpoint /v3/export/apps is added\n- It exports a ZIP archive that contains all application details in all namespaces"}, "afterCommit": {"oid": "3d09d418ddcada040bdbc0751089558e17f9568d", "author": {"user": {"login": "chtyim", "name": "Terence Yim"}}, "url": "https://github.com/cdapio/cdap/commit/3d09d418ddcada040bdbc0751089558e17f9568d", "committedDate": "2020-06-10T22:19:52Z", "message": "(CDAP-16918) Added REST endpoint to export all applications\n\n- A new instance level endpoint /v3/export/apps is added\n- It exports a ZIP archive that contains all application details in all namespaces"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3d09d418ddcada040bdbc0751089558e17f9568d", "author": {"user": {"login": "chtyim", "name": "Terence Yim"}}, "url": "https://github.com/cdapio/cdap/commit/3d09d418ddcada040bdbc0751089558e17f9568d", "committedDate": "2020-06-10T22:19:52Z", "message": "(CDAP-16918) Added REST endpoint to export all applications\n\n- A new instance level endpoint /v3/export/apps is added\n- It exports a ZIP archive that contains all application details in all namespaces"}, "afterCommit": {"oid": "4a8d1159764b90b0529512621f0acfdce87b7039", "author": {"user": {"login": "chtyim", "name": "Terence Yim"}}, "url": "https://github.com/cdapio/cdap/commit/4a8d1159764b90b0529512621f0acfdce87b7039", "committedDate": "2020-06-10T22:32:24Z", "message": "(CDAP-16918) Added REST endpoint to export all applications\n\n- A new instance level endpoint /v3/export/apps is added\n- It exports a ZIP archive that contains all application details in all namespaces"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4NDczMTUz", "url": "https://github.com/cdapio/cdap/pull/12294#pullrequestreview-428473153", "createdAt": "2020-06-10T22:32:19Z", "commit": {"oid": "3d09d418ddcada040bdbc0751089558e17f9568d"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQyMjozMjoxOVrOGiIeKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQyMjozNDowM1rOGiIgfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ0MzU2MQ==", "bodyText": "if there is a race between 2 RPC calls for export and the tempDir, this would fail right? May be we need to add a random suffix with directory name?", "url": "https://github.com/cdapio/cdap/pull/12294#discussion_r438443561", "createdAt": "2020-06-10T22:32:19Z", "author": {"login": "pandyajay10"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/gateway/handlers/InstanceOperationHttpHandler.java", "diffHunk": "@@ -0,0 +1,69 @@\n+package io.cdap.cdap.gateway.handlers;\n+\n+import com.google.inject.Inject;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.utils.DirUtils;\n+import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n+import io.cdap.http.AbstractHttpHandler;\n+import io.cdap.http.HttpResponder;\n+import io.netty.handler.codec.http.DefaultHttpHeaders;\n+import io.netty.handler.codec.http.HttpHeaderNames;\n+import io.netty.handler.codec.http.HttpRequest;\n+\n+import java.io.File;\n+import java.nio.file.Files;\n+import java.nio.file.StandardOpenOption;\n+import java.security.DigestOutputStream;\n+import java.security.MessageDigest;\n+import java.util.Base64;\n+import java.util.zip.ZipOutputStream;\n+import javax.ws.rs.GET;\n+import javax.ws.rs.Path;\n+\n+/**\n+ * HTTP handler for instance level operations.\n+ */\n+@Path(Constants.Gateway.API_VERSION_3)\n+public class InstanceOperationHttpHandler extends AbstractHttpHandler {\n+\n+  private final CConfiguration cConf;\n+  private final ApplicationLifecycleService lifecycleService;\n+\n+  @Inject\n+  InstanceOperationHttpHandler(CConfiguration cConf, ApplicationLifecycleService lifecycleService) {\n+    this.cConf = cConf;\n+    this.lifecycleService = lifecycleService;\n+  }\n+\n+  /**\n+   * Exports all application details as a ZIP archive file.\n+   */\n+  @GET\n+  @Path(\"/export/apps\")\n+  public void appsExport(HttpRequest request, HttpResponder responder) throws Exception {\n+    File tempDir = new File(cConf.get(Constants.CFG_LOCAL_DATA_DIR),\n+                            cConf.get(Constants.AppFabric.TEMP_DIR)).getAbsoluteFile();\n+    DirUtils.mkdirs(tempDir);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d09d418ddcada040bdbc0751089558e17f9568d"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ0NDE1Ng==", "bodyText": "should the file name also have random string included just in case? although if we have unique directory than that should solve it.", "url": "https://github.com/cdapio/cdap/pull/12294#discussion_r438444156", "createdAt": "2020-06-10T22:34:03Z", "author": {"login": "pandyajay10"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/gateway/handlers/InstanceOperationHttpHandler.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.gateway.handlers;\n+\n+import com.google.inject.Inject;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.utils.DirUtils;\n+import io.cdap.cdap.internal.app.services.ApplicationLifecycleService;\n+import io.cdap.http.AbstractHttpHandler;\n+import io.cdap.http.HttpResponder;\n+import io.netty.handler.codec.http.DefaultHttpHeaders;\n+import io.netty.handler.codec.http.HttpHeaderNames;\n+import io.netty.handler.codec.http.HttpRequest;\n+\n+import java.io.File;\n+import java.nio.file.Files;\n+import java.nio.file.StandardOpenOption;\n+import java.security.DigestOutputStream;\n+import java.security.MessageDigest;\n+import java.util.Base64;\n+import java.util.zip.ZipOutputStream;\n+import javax.ws.rs.GET;\n+import javax.ws.rs.Path;\n+\n+/**\n+ * HTTP handler for instance level operations.\n+ */\n+@Path(Constants.Gateway.API_VERSION_3)\n+public class InstanceOperationHttpHandler extends AbstractHttpHandler {\n+\n+  private final CConfiguration cConf;\n+  private final ApplicationLifecycleService lifecycleService;\n+\n+  @Inject\n+  InstanceOperationHttpHandler(CConfiguration cConf, ApplicationLifecycleService lifecycleService) {\n+    this.cConf = cConf;\n+    this.lifecycleService = lifecycleService;\n+  }\n+\n+  /**\n+   * Exports all application details as a ZIP archive file.\n+   */\n+  @GET\n+  @Path(\"/export/apps\")\n+  public void appsExport(HttpRequest request, HttpResponder responder) throws Exception {\n+    File tempDir = new File(cConf.get(Constants.CFG_LOCAL_DATA_DIR),\n+                            cConf.get(Constants.AppFabric.TEMP_DIR)).getAbsoluteFile();\n+    DirUtils.mkdirs(tempDir);\n+    java.nio.file.Path tmpPath = Files.createTempFile(tempDir.toPath(), \"export\", \".zip\");\n+    try {\n+      MessageDigest digest = MessageDigest.getInstance(\"SHA-256\");\n+      try (ZipOutputStream zipOut = new ZipOutputStream(new DigestOutputStream(\n+        Files.newOutputStream(tmpPath, StandardOpenOption.TRUNCATE_EXISTING), digest))) {\n+\n+        lifecycleService.createAppDetailsArchive(zipOut);\n+      }\n+\n+      responder.sendFile(\n+        tmpPath.toFile(),\n+        new DefaultHttpHeaders()\n+          .add(\"digest\", String.format(\"%s=%s\", digest.getAlgorithm().toLowerCase(),\n+                                       Base64.getEncoder().encodeToString(digest.digest())))\n+          .add(HttpHeaderNames.CONTENT_TYPE, \"application/zip\")\n+          .add(HttpHeaderNames.CONTENT_DISPOSITION, \"attachment; filename=\\\"export.zip\\\"\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a8d1159764b90b0529512621f0acfdce87b7039"}, "originalPosition": 79}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4NTA3NTA4", "url": "https://github.com/cdapio/cdap/pull/12294#pullrequestreview-428507508", "createdAt": "2020-06-11T00:04:44Z", "commit": {"oid": "38c158d75b77b1e89c99cf2aa416d78d8d336685"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a63f2b30af2498f13990e0df2cd0bc312ec7d933", "author": {"user": {"login": "chtyim", "name": "Terence Yim"}}, "url": "https://github.com/cdapio/cdap/commit/a63f2b30af2498f13990e0df2cd0bc312ec7d933", "committedDate": "2020-06-11T01:43:59Z", "message": "(CDAP-16918) Added REST endpoint to export all applications\n\n- A new scanApplications method is added to AppMetadataStore for scanning applications progressively.\n- A new scanApplications method is added to Store for scanning all applications with multiple small transactions\n- A new createAppDetailsArchive method is added to ApplicationLifecycleService for writing out ZIP archive that contains all application detail json files\n- A new class InstanceOperationHttpHandler is added, with a new REST API /v3/export/apps for downloading the ZIP archive through REST. It also contains a SHA-256 digest for content validation."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "38c158d75b77b1e89c99cf2aa416d78d8d336685", "author": {"user": {"login": "chtyim", "name": "Terence Yim"}}, "url": "https://github.com/cdapio/cdap/commit/38c158d75b77b1e89c99cf2aa416d78d8d336685", "committedDate": "2020-06-10T23:30:29Z", "message": "Skip apps in system namespaces in export archive"}, "afterCommit": {"oid": "a63f2b30af2498f13990e0df2cd0bc312ec7d933", "author": {"user": {"login": "chtyim", "name": "Terence Yim"}}, "url": "https://github.com/cdapio/cdap/commit/a63f2b30af2498f13990e0df2cd0bc312ec7d933", "committedDate": "2020-06-11T01:43:59Z", "message": "(CDAP-16918) Added REST endpoint to export all applications\n\n- A new scanApplications method is added to AppMetadataStore for scanning applications progressively.\n- A new scanApplications method is added to Store for scanning all applications with multiple small transactions\n- A new createAppDetailsArchive method is added to ApplicationLifecycleService for writing out ZIP archive that contains all application detail json files\n- A new class InstanceOperationHttpHandler is added, with a new REST API /v3/export/apps for downloading the ZIP archive through REST. It also contains a SHA-256 digest for content validation."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1998, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}