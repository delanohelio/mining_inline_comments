{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM1OTM3ODQy", "number": 12356, "reviewThreads": {"totalCount": 35, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxNzo0NjoxMlrOEGc67g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxODowMzozMFrOERjuXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1MjAwNzUwOnYy", "diffSide": "RIGHT", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/preview/DefaultPreviewRequestQueue.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxNzo0NjoxMlrOGlQeTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQwMjoxNzowNVrOGmF4Cw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcyMDM5OA==", "bodyText": "does this mean if removeFromWaitingState throws error, we will lose that preview request and user has to resubmit?", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r441720398", "createdAt": "2020-06-17T17:46:12Z", "author": {"login": "CuriousVini"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/preview/DefaultPreviewRequestQueue.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.app.preview;\n+\n+import com.google.inject.Inject;\n+import io.cdap.cdap.app.preview.PreviewRequest;\n+import io.cdap.cdap.app.preview.PreviewRequestQueue;\n+import io.cdap.cdap.app.preview.PreviewRequestQueueState;\n+import io.cdap.cdap.app.store.preview.PreviewStore;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.concurrent.ConcurrentLinkedQueue;\n+\n+/**\n+ * Implementation of {@link PreviewRequestQueue} backed by {@link PreviewStore}.\n+ */\n+public class DefaultPreviewRequestQueue implements PreviewRequestQueue {\n+  private final PreviewStore previewStore;\n+  private final ConcurrentLinkedQueue<PreviewRequest> requestQueue;\n+  private int capacity;\n+\n+  @Inject\n+  DefaultPreviewRequestQueue(CConfiguration cConf, PreviewStore previewStore) {\n+    this.previewStore = previewStore;\n+    this.capacity = cConf.getInt(Constants.Preview.WAITING_QUEUE_CAPACITY, 50);\n+    List<PreviewRequest> allInWaitingState = previewStore.getAllInWaitingState();\n+    this.requestQueue = new ConcurrentLinkedQueue<>();\n+    requestQueue.addAll(allInWaitingState);\n+  }\n+\n+  @Override\n+  public Optional<PreviewRequest> poll() {\n+    PreviewRequest previewRequest = requestQueue.poll();\n+    if (previewRequest == null) {\n+      return Optional.empty();\n+    }\n+\n+    previewStore.removeFromWaitingState(previewRequest.getProgram().getParent());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53faf3804ca214a79bc62bb044004ace39578f53"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU5NTMzOQ==", "bodyText": "Removed removeFromWaitingState from API instead doing it in setPreviewRequestPollerInfo method. Also doing poll in the end so as to not loose the request in case any exception.", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r442595339", "createdAt": "2020-06-19T02:17:05Z", "author": {"login": "sagarkapare"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/preview/DefaultPreviewRequestQueue.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.app.preview;\n+\n+import com.google.inject.Inject;\n+import io.cdap.cdap.app.preview.PreviewRequest;\n+import io.cdap.cdap.app.preview.PreviewRequestQueue;\n+import io.cdap.cdap.app.preview.PreviewRequestQueueState;\n+import io.cdap.cdap.app.store.preview.PreviewStore;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.concurrent.ConcurrentLinkedQueue;\n+\n+/**\n+ * Implementation of {@link PreviewRequestQueue} backed by {@link PreviewStore}.\n+ */\n+public class DefaultPreviewRequestQueue implements PreviewRequestQueue {\n+  private final PreviewStore previewStore;\n+  private final ConcurrentLinkedQueue<PreviewRequest> requestQueue;\n+  private int capacity;\n+\n+  @Inject\n+  DefaultPreviewRequestQueue(CConfiguration cConf, PreviewStore previewStore) {\n+    this.previewStore = previewStore;\n+    this.capacity = cConf.getInt(Constants.Preview.WAITING_QUEUE_CAPACITY, 50);\n+    List<PreviewRequest> allInWaitingState = previewStore.getAllInWaitingState();\n+    this.requestQueue = new ConcurrentLinkedQueue<>();\n+    requestQueue.addAll(allInWaitingState);\n+  }\n+\n+  @Override\n+  public Optional<PreviewRequest> poll() {\n+    PreviewRequest previewRequest = requestQueue.poll();\n+    if (previewRequest == null) {\n+      return Optional.empty();\n+    }\n+\n+    previewStore.removeFromWaitingState(previewRequest.getProgram().getParent());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcyMDM5OA=="}, "originalCommit": {"oid": "53faf3804ca214a79bc62bb044004ace39578f53"}, "originalPosition": 55}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1MjAxNTM3OnYy", "diffSide": "RIGHT", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/preview/DefaultPreviewRequestQueue.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxNzo0ODoyNVrOGlQjSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQwMjoxNTo1MFrOGmF2_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcyMTY3Mg==", "bodyText": "should this be final?", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r441721672", "createdAt": "2020-06-17T17:48:25Z", "author": {"login": "CuriousVini"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/preview/DefaultPreviewRequestQueue.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.app.preview;\n+\n+import com.google.inject.Inject;\n+import io.cdap.cdap.app.preview.PreviewRequest;\n+import io.cdap.cdap.app.preview.PreviewRequestQueue;\n+import io.cdap.cdap.app.preview.PreviewRequestQueueState;\n+import io.cdap.cdap.app.store.preview.PreviewStore;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.concurrent.ConcurrentLinkedQueue;\n+\n+/**\n+ * Implementation of {@link PreviewRequestQueue} backed by {@link PreviewStore}.\n+ */\n+public class DefaultPreviewRequestQueue implements PreviewRequestQueue {\n+  private final PreviewStore previewStore;\n+  private final ConcurrentLinkedQueue<PreviewRequest> requestQueue;\n+  private int capacity;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53faf3804ca214a79bc62bb044004ace39578f53"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU5NTA2OQ==", "bodyText": "done.", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r442595069", "createdAt": "2020-06-19T02:15:50Z", "author": {"login": "sagarkapare"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/preview/DefaultPreviewRequestQueue.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.app.preview;\n+\n+import com.google.inject.Inject;\n+import io.cdap.cdap.app.preview.PreviewRequest;\n+import io.cdap.cdap.app.preview.PreviewRequestQueue;\n+import io.cdap.cdap.app.preview.PreviewRequestQueueState;\n+import io.cdap.cdap.app.store.preview.PreviewStore;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.concurrent.ConcurrentLinkedQueue;\n+\n+/**\n+ * Implementation of {@link PreviewRequestQueue} backed by {@link PreviewStore}.\n+ */\n+public class DefaultPreviewRequestQueue implements PreviewRequestQueue {\n+  private final PreviewStore previewStore;\n+  private final ConcurrentLinkedQueue<PreviewRequest> requestQueue;\n+  private int capacity;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcyMTY3Mg=="}, "originalCommit": {"oid": "53faf3804ca214a79bc62bb044004ace39578f53"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1MjA0MDgyOnYy", "diffSide": "RIGHT", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/preview/DefaultPreviewRequestQueue.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxNzo1NToyMlrOGlQzwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQwMjoxNTo0NFrOGmF24g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcyNTg4OQ==", "bodyText": "size is defined by requestQueue.size() where as state is defined by previewStore.getAllInWaitingState(). Can there be any race conditions which can cause different results for these 2 calls?", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r441725889", "createdAt": "2020-06-17T17:55:22Z", "author": {"login": "CuriousVini"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/preview/DefaultPreviewRequestQueue.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.app.preview;\n+\n+import com.google.inject.Inject;\n+import io.cdap.cdap.app.preview.PreviewRequest;\n+import io.cdap.cdap.app.preview.PreviewRequestQueue;\n+import io.cdap.cdap.app.preview.PreviewRequestQueueState;\n+import io.cdap.cdap.app.store.preview.PreviewStore;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.concurrent.ConcurrentLinkedQueue;\n+\n+/**\n+ * Implementation of {@link PreviewRequestQueue} backed by {@link PreviewStore}.\n+ */\n+public class DefaultPreviewRequestQueue implements PreviewRequestQueue {\n+  private final PreviewStore previewStore;\n+  private final ConcurrentLinkedQueue<PreviewRequest> requestQueue;\n+  private int capacity;\n+\n+  @Inject\n+  DefaultPreviewRequestQueue(CConfiguration cConf, PreviewStore previewStore) {\n+    this.previewStore = previewStore;\n+    this.capacity = cConf.getInt(Constants.Preview.WAITING_QUEUE_CAPACITY, 50);\n+    List<PreviewRequest> allInWaitingState = previewStore.getAllInWaitingState();\n+    this.requestQueue = new ConcurrentLinkedQueue<>();\n+    requestQueue.addAll(allInWaitingState);\n+  }\n+\n+  @Override\n+  public Optional<PreviewRequest> poll() {\n+    PreviewRequest previewRequest = requestQueue.poll();\n+    if (previewRequest == null) {\n+      return Optional.empty();\n+    }\n+\n+    previewStore.removeFromWaitingState(previewRequest.getProgram().getParent());\n+    return Optional.of(previewRequest);\n+  }\n+\n+  @Override\n+  public void add(PreviewRequest previewRequest) {\n+    int size = requestQueue.size();\n+    if (size >= capacity) {\n+      throw new IllegalStateException(String.format(\"Preview request waiting queue is full with %d requests.\", size));\n+    }\n+    previewStore.addToWaitingState(previewRequest.getProgram().getParent(), previewRequest.getAppRequest());\n+    requestQueue.add(previewRequest);\n+  }\n+\n+  @Override\n+  public PreviewRequestQueueState getState() {\n+    List<PreviewRequest> allWaiting = previewStore.getAllInWaitingState();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53faf3804ca214a79bc62bb044004ace39578f53"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU5NTA0Mg==", "bodyText": "Actually this should be just requestQueue.size() no need to go to store.", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r442595042", "createdAt": "2020-06-19T02:15:44Z", "author": {"login": "sagarkapare"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/preview/DefaultPreviewRequestQueue.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.app.preview;\n+\n+import com.google.inject.Inject;\n+import io.cdap.cdap.app.preview.PreviewRequest;\n+import io.cdap.cdap.app.preview.PreviewRequestQueue;\n+import io.cdap.cdap.app.preview.PreviewRequestQueueState;\n+import io.cdap.cdap.app.store.preview.PreviewStore;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.concurrent.ConcurrentLinkedQueue;\n+\n+/**\n+ * Implementation of {@link PreviewRequestQueue} backed by {@link PreviewStore}.\n+ */\n+public class DefaultPreviewRequestQueue implements PreviewRequestQueue {\n+  private final PreviewStore previewStore;\n+  private final ConcurrentLinkedQueue<PreviewRequest> requestQueue;\n+  private int capacity;\n+\n+  @Inject\n+  DefaultPreviewRequestQueue(CConfiguration cConf, PreviewStore previewStore) {\n+    this.previewStore = previewStore;\n+    this.capacity = cConf.getInt(Constants.Preview.WAITING_QUEUE_CAPACITY, 50);\n+    List<PreviewRequest> allInWaitingState = previewStore.getAllInWaitingState();\n+    this.requestQueue = new ConcurrentLinkedQueue<>();\n+    requestQueue.addAll(allInWaitingState);\n+  }\n+\n+  @Override\n+  public Optional<PreviewRequest> poll() {\n+    PreviewRequest previewRequest = requestQueue.poll();\n+    if (previewRequest == null) {\n+      return Optional.empty();\n+    }\n+\n+    previewStore.removeFromWaitingState(previewRequest.getProgram().getParent());\n+    return Optional.of(previewRequest);\n+  }\n+\n+  @Override\n+  public void add(PreviewRequest previewRequest) {\n+    int size = requestQueue.size();\n+    if (size >= capacity) {\n+      throw new IllegalStateException(String.format(\"Preview request waiting queue is full with %d requests.\", size));\n+    }\n+    previewStore.addToWaitingState(previewRequest.getProgram().getParent(), previewRequest.getAppRequest());\n+    requestQueue.add(previewRequest);\n+  }\n+\n+  @Override\n+  public PreviewRequestQueueState getState() {\n+    List<PreviewRequest> allWaiting = previewStore.getAllInWaitingState();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcyNTg4OQ=="}, "originalCommit": {"oid": "53faf3804ca214a79bc62bb044004ace39578f53"}, "originalPosition": 71}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1MjA0ODUyOnYy", "diffSide": "RIGHT", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/preview/PreviewRequestPollingService.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxNzo1NzoxOFrOGlQ4qg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxNzo1NzoxOFrOGlQ4qg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcyNzE0Ng==", "bodyText": "would this be added in subsequent PRs? Could you please file a bug for this?", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r441727146", "createdAt": "2020-06-17T17:57:18Z", "author": {"login": "CuriousVini"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/preview/PreviewRequestPollingService.java", "diffHunk": "@@ -0,0 +1,61 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.app.preview;\n+\n+import io.cdap.cdap.app.preview.PreviewRequest;\n+import io.cdap.cdap.app.preview.PreviewRequestPoller;\n+import io.cdap.cdap.app.preview.PreviewRequestQueue;\n+import io.cdap.cdap.app.preview.PreviewRunner;\n+import io.cdap.cdap.common.service.AbstractRetryableScheduledService;\n+import io.cdap.cdap.common.service.RetryStrategies;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Optional;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * Service for polling {@link PreviewRequest}s from {@link PreviewRequestQueue}\n+ */\n+public class PreviewRequestPollingService extends AbstractRetryableScheduledService {\n+  private static final Logger LOG = LoggerFactory.getLogger(PreviewRequestPollingService.class);\n+  private final PreviewRequestPoller previewRequestPoller;\n+  private final PreviewRunner previewRunner;\n+\n+  public PreviewRequestPollingService(PreviewRequestPoller previewRequestPoller, PreviewRunner previewRunner) {\n+    // TODO add polling configs", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53faf3804ca214a79bc62bb044004ace39578f53"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1MjA0ODc5OnYy", "diffSide": "RIGHT", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/preview/PreviewRequestPollingService.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxNzo1NzoyMVrOGlQ40w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQwMjoxNToxOVrOGmF2jA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcyNzE4Nw==", "bodyText": "Could you please file a bug for this?", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r441727187", "createdAt": "2020-06-17T17:57:21Z", "author": {"login": "CuriousVini"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/preview/PreviewRequestPollingService.java", "diffHunk": "@@ -0,0 +1,61 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.app.preview;\n+\n+import io.cdap.cdap.app.preview.PreviewRequest;\n+import io.cdap.cdap.app.preview.PreviewRequestPoller;\n+import io.cdap.cdap.app.preview.PreviewRequestQueue;\n+import io.cdap.cdap.app.preview.PreviewRunner;\n+import io.cdap.cdap.common.service.AbstractRetryableScheduledService;\n+import io.cdap.cdap.common.service.RetryStrategies;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Optional;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * Service for polling {@link PreviewRequest}s from {@link PreviewRequestQueue}\n+ */\n+public class PreviewRequestPollingService extends AbstractRetryableScheduledService {\n+  private static final Logger LOG = LoggerFactory.getLogger(PreviewRequestPollingService.class);\n+  private final PreviewRequestPoller previewRequestPoller;\n+  private final PreviewRunner previewRunner;\n+\n+  public PreviewRequestPollingService(PreviewRequestPoller previewRequestPoller, PreviewRunner previewRunner) {\n+    // TODO add polling configs\n+    super(RetryStrategies.fixDelay(1, TimeUnit.SECONDS));\n+    this.previewRequestPoller = previewRequestPoller;\n+    this.previewRunner = previewRunner;\n+  }\n+\n+  @Override\n+  protected long runTask() {\n+    Optional<PreviewRequest> requestOptional = previewRequestPoller.poll();\n+    if (requestOptional.isPresent()) {\n+      PreviewRequest previewRequest = requestOptional.get();\n+      try {\n+        LOG.info(\"Starting preview for program id {}\", requestOptional.get().getProgram());\n+        previewRunner.startPreview(requestOptional.get());\n+      } catch (Exception e) {\n+        LOG.warn(\"Failed to run preview with program id {}.\", previewRequest.getProgram(), e);\n+      }\n+    }\n+    //TODO change this after adding retry strategy config", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53faf3804ca214a79bc62bb044004ace39578f53"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU5NDk1Ng==", "bodyText": "Removed this class from PR.", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r442594956", "createdAt": "2020-06-19T02:15:19Z", "author": {"login": "sagarkapare"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/preview/PreviewRequestPollingService.java", "diffHunk": "@@ -0,0 +1,61 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.app.preview;\n+\n+import io.cdap.cdap.app.preview.PreviewRequest;\n+import io.cdap.cdap.app.preview.PreviewRequestPoller;\n+import io.cdap.cdap.app.preview.PreviewRequestQueue;\n+import io.cdap.cdap.app.preview.PreviewRunner;\n+import io.cdap.cdap.common.service.AbstractRetryableScheduledService;\n+import io.cdap.cdap.common.service.RetryStrategies;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Optional;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * Service for polling {@link PreviewRequest}s from {@link PreviewRequestQueue}\n+ */\n+public class PreviewRequestPollingService extends AbstractRetryableScheduledService {\n+  private static final Logger LOG = LoggerFactory.getLogger(PreviewRequestPollingService.class);\n+  private final PreviewRequestPoller previewRequestPoller;\n+  private final PreviewRunner previewRunner;\n+\n+  public PreviewRequestPollingService(PreviewRequestPoller previewRequestPoller, PreviewRunner previewRunner) {\n+    // TODO add polling configs\n+    super(RetryStrategies.fixDelay(1, TimeUnit.SECONDS));\n+    this.previewRequestPoller = previewRequestPoller;\n+    this.previewRunner = previewRunner;\n+  }\n+\n+  @Override\n+  protected long runTask() {\n+    Optional<PreviewRequest> requestOptional = previewRequestPoller.poll();\n+    if (requestOptional.isPresent()) {\n+      PreviewRequest previewRequest = requestOptional.get();\n+      try {\n+        LOG.info(\"Starting preview for program id {}\", requestOptional.get().getProgram());\n+        previewRunner.startPreview(requestOptional.get());\n+      } catch (Exception e) {\n+        LOG.warn(\"Failed to run preview with program id {}.\", previewRequest.getProgram(), e);\n+      }\n+    }\n+    //TODO change this after adding retry strategy config", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcyNzE4Nw=="}, "originalCommit": {"oid": "53faf3804ca214a79bc62bb044004ace39578f53"}, "originalPosition": 58}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1MjA2MjQ4OnYy", "diffSide": "RIGHT", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/preview/DefaultPreviewRequestQueue.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxODowMTowNlrOGlRB0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQwMjoxNDo1OVrOGmF2SA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcyOTQ4OQ==", "bodyText": "Can this be Queue< PreviewRequest>?", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r441729489", "createdAt": "2020-06-17T18:01:06Z", "author": {"login": "CuriousVini"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/preview/DefaultPreviewRequestQueue.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.app.preview;\n+\n+import com.google.inject.Inject;\n+import io.cdap.cdap.app.preview.PreviewRequest;\n+import io.cdap.cdap.app.preview.PreviewRequestQueue;\n+import io.cdap.cdap.app.preview.PreviewRequestQueueState;\n+import io.cdap.cdap.app.store.preview.PreviewStore;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.concurrent.ConcurrentLinkedQueue;\n+\n+/**\n+ * Implementation of {@link PreviewRequestQueue} backed by {@link PreviewStore}.\n+ */\n+public class DefaultPreviewRequestQueue implements PreviewRequestQueue {\n+  private final PreviewStore previewStore;\n+  private final ConcurrentLinkedQueue<PreviewRequest> requestQueue;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53faf3804ca214a79bc62bb044004ace39578f53"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU5NDg4OA==", "bodyText": "yes. changed.", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r442594888", "createdAt": "2020-06-19T02:14:59Z", "author": {"login": "sagarkapare"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/preview/DefaultPreviewRequestQueue.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.app.preview;\n+\n+import com.google.inject.Inject;\n+import io.cdap.cdap.app.preview.PreviewRequest;\n+import io.cdap.cdap.app.preview.PreviewRequestQueue;\n+import io.cdap.cdap.app.preview.PreviewRequestQueueState;\n+import io.cdap.cdap.app.store.preview.PreviewStore;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.concurrent.ConcurrentLinkedQueue;\n+\n+/**\n+ * Implementation of {@link PreviewRequestQueue} backed by {@link PreviewStore}.\n+ */\n+public class DefaultPreviewRequestQueue implements PreviewRequestQueue {\n+  private final PreviewStore previewStore;\n+  private final ConcurrentLinkedQueue<PreviewRequest> requestQueue;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcyOTQ4OQ=="}, "originalCommit": {"oid": "53faf3804ca214a79bc62bb044004ace39578f53"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1MjA2NzIyOnYy", "diffSide": "RIGHT", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/PreviewRequestQueue.java", "isResolved": false, "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxODowMjozM1rOGlRE7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxNjoyMjoyMFrOG2SFMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTczMDI4Nw==", "bodyText": "Could you please add javadoc around what is the expected thread safety of this data structure implementation.", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r441730287", "createdAt": "2020-06-17T18:02:33Z", "author": {"login": "CuriousVini"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/PreviewRequestQueue.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.app.preview;\n+\n+import java.util.Optional;\n+\n+/**\n+ * Interface designed for holding {@link PreviewRequest}s that are in WAITING state.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53faf3804ca214a79bc62bb044004ace39578f53"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU5NDg0MA==", "bodyText": "Added doc to the implementation class.", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r442594840", "createdAt": "2020-06-19T02:14:47Z", "author": {"login": "sagarkapare"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/PreviewRequestQueue.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.app.preview;\n+\n+import java.util.Optional;\n+\n+/**\n+ * Interface designed for holding {@link PreviewRequest}s that are in WAITING state.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTczMDI4Nw=="}, "originalCommit": {"oid": "53faf3804ca214a79bc62bb044004ace39578f53"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU0MTkyNw==", "bodyText": "So thread safety is not a contract enforced by this interface?", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r448541927", "createdAt": "2020-07-01T18:25:28Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/PreviewRequestQueue.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.app.preview;\n+\n+import java.util.Optional;\n+\n+/**\n+ * Interface designed for holding {@link PreviewRequest}s that are in WAITING state.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTczMDI4Nw=="}, "originalCommit": {"oid": "53faf3804ca214a79bc62bb044004ace39578f53"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAzNTM4MQ==", "bodyText": "Should this interface enforces all implementations to be thread safe?", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r459035381", "createdAt": "2020-07-22T19:35:38Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/PreviewRequestQueue.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.app.preview;\n+\n+import java.util.Optional;\n+\n+/**\n+ * Interface designed for holding {@link PreviewRequest}s that are in WAITING state.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTczMDI4Nw=="}, "originalCommit": {"oid": "53faf3804ca214a79bc62bb044004ace39578f53"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTE0MTI3Mw==", "bodyText": "Not sure I understand this comment. Did you mean adding ThreadSafe annotation to interface?", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r459141273", "createdAt": "2020-07-22T23:33:24Z", "author": {"login": "sagarkapare"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/PreviewRequestQueue.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.app.preview;\n+\n+import java.util.Optional;\n+\n+/**\n+ * Interface designed for holding {@link PreviewRequest}s that are in WAITING state.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTczMDI4Nw=="}, "originalCommit": {"oid": "53faf3804ca214a79bc62bb044004ace39578f53"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTMxNjkwMw==", "bodyText": "Yes and clearly state that it is a requirement for the implementing class.", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r459316903", "createdAt": "2020-07-23T09:15:07Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/PreviewRequestQueue.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.app.preview;\n+\n+import java.util.Optional;\n+\n+/**\n+ * Interface designed for holding {@link PreviewRequest}s that are in WAITING state.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTczMDI4Nw=="}, "originalCommit": {"oid": "53faf3804ca214a79bc62bb044004ace39578f53"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU3MjUzMA==", "bodyText": "Got it. done.", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r459572530", "createdAt": "2020-07-23T16:22:20Z", "author": {"login": "sagarkapare"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/PreviewRequestQueue.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.app.preview;\n+\n+import java.util.Optional;\n+\n+/**\n+ * Interface designed for holding {@link PreviewRequest}s that are in WAITING state.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTczMDI4Nw=="}, "originalCommit": {"oid": "53faf3804ca214a79bc62bb044004ace39578f53"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5NTY3NDU5OnYy", "diffSide": "RIGHT", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/DefaultPreviewRunnerModule.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxODoyMzo1M1rOGrwxzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QyMjo0Njo1M1rOGuSM7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU0MTEzNA==", "bodyText": "Why expose?", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r448541134", "createdAt": "2020-07-01T18:23:53Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/DefaultPreviewRunnerModule.java", "diffHunk": "@@ -175,6 +178,9 @@ protected void configure() {\n     bind(PreviewStore.class).to(DefaultPreviewStore.class).in(Scopes.SINGLETON);\n     bind(Scheduler.class).to(NoOpScheduler.class);\n \n+    bind(PreviewRequestQueue.class).to(DefaultPreviewRequestQueue.class).in(Scopes.SINGLETON);\n+    expose(PreviewRequestQueue.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e45cf43440f829752fa965938a1e301437ae547"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY1MjU1Ng==", "bodyText": "PreviewManager gets the instance of this class using preview injector and adds request to it, which is why its exposed.", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r448652556", "createdAt": "2020-07-01T22:41:11Z", "author": {"login": "sagarkapare"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/DefaultPreviewRunnerModule.java", "diffHunk": "@@ -175,6 +178,9 @@ protected void configure() {\n     bind(PreviewStore.class).to(DefaultPreviewStore.class).in(Scopes.SINGLETON);\n     bind(Scheduler.class).to(NoOpScheduler.class);\n \n+    bind(PreviewRequestQueue.class).to(DefaultPreviewRequestQueue.class).in(Scopes.SINGLETON);\n+    expose(PreviewRequestQueue.class);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU0MTEzNA=="}, "originalCommit": {"oid": "5e45cf43440f829752fa965938a1e301437ae547"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDM5NTIxNA==", "bodyText": "Shouldn't the queue belongs to the Preview Manager internally? Why the binding is in separate injector?", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r450395214", "createdAt": "2020-07-06T18:08:33Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/DefaultPreviewRunnerModule.java", "diffHunk": "@@ -175,6 +178,9 @@ protected void configure() {\n     bind(PreviewStore.class).to(DefaultPreviewStore.class).in(Scopes.SINGLETON);\n     bind(Scheduler.class).to(NoOpScheduler.class);\n \n+    bind(PreviewRequestQueue.class).to(DefaultPreviewRequestQueue.class).in(Scopes.SINGLETON);\n+    expose(PreviewRequestQueue.class);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU0MTEzNA=="}, "originalCommit": {"oid": "5e45cf43440f829752fa965938a1e301437ae547"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE4NTkwMg==", "bodyText": "Refactoored the guice bindings in the last commit. PTAL. thanks!", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r451185902", "createdAt": "2020-07-07T22:46:53Z", "author": {"login": "sagarkapare"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/DefaultPreviewRunnerModule.java", "diffHunk": "@@ -175,6 +178,9 @@ protected void configure() {\n     bind(PreviewStore.class).to(DefaultPreviewStore.class).in(Scopes.SINGLETON);\n     bind(Scheduler.class).to(NoOpScheduler.class);\n \n+    bind(PreviewRequestQueue.class).to(DefaultPreviewRequestQueue.class).in(Scopes.SINGLETON);\n+    expose(PreviewRequestQueue.class);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU0MTEzNA=="}, "originalCommit": {"oid": "5e45cf43440f829752fa965938a1e301437ae547"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5NTY3NTUwOnYy", "diffSide": "RIGHT", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/DefaultPreviewRunnerModule.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxODoyNDowN1rOGrwyVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QyMjo0NjoyM1rOGuSMRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU0MTI2OA==", "bodyText": "Why need to expose?", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r448541268", "createdAt": "2020-07-01T18:24:07Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/DefaultPreviewRunnerModule.java", "diffHunk": "@@ -188,6 +194,9 @@ protected void configure() {\n \n     bind(PreferencesFetcher.class).toProvider(preferencesFetcherProvider);\n     expose(PreferencesFetcher.class);\n+\n+    bind(PreviewRequestFetcher.class).to(DirectPreviewRequestFetcher.class);\n+    expose(PreviewRequestFetcher.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e45cf43440f829752fa965938a1e301437ae547"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY1MzA4Mg==", "bodyText": "PreviewManager for standalone creates instances of PreviewRunnerService using injector. PreviewRunnerService requires PreviewRequestFetcher which is why its exposed here.", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r448653082", "createdAt": "2020-07-01T22:42:39Z", "author": {"login": "sagarkapare"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/DefaultPreviewRunnerModule.java", "diffHunk": "@@ -188,6 +194,9 @@ protected void configure() {\n \n     bind(PreferencesFetcher.class).toProvider(preferencesFetcherProvider);\n     expose(PreferencesFetcher.class);\n+\n+    bind(PreviewRequestFetcher.class).to(DirectPreviewRequestFetcher.class);\n+    expose(PreviewRequestFetcher.class);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU0MTI2OA=="}, "originalCommit": {"oid": "5e45cf43440f829752fa965938a1e301437ae547"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDM5NjczMg==", "bodyText": "It shouldn't be the PreviewManager to create the runner service in Standalone. Conceptually, the manager and the runner service are two separated services. In distributed, they started in different pod (hence different processes), while in standalone, they are started from Standalone Main independently. We might need a separate service class for starting N number of PreviewRunnerServices, in which that new service is started in StandaloneMain independently of the PreviewManager.", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r450396732", "createdAt": "2020-07-06T18:11:36Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/DefaultPreviewRunnerModule.java", "diffHunk": "@@ -188,6 +194,9 @@ protected void configure() {\n \n     bind(PreferencesFetcher.class).toProvider(preferencesFetcherProvider);\n     expose(PreferencesFetcher.class);\n+\n+    bind(PreviewRequestFetcher.class).to(DirectPreviewRequestFetcher.class);\n+    expose(PreviewRequestFetcher.class);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU0MTI2OA=="}, "originalCommit": {"oid": "5e45cf43440f829752fa965938a1e301437ae547"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE4NTczMw==", "bodyText": "I refactored code to separate the PreviewManager and PreviewRunner interfaces. Basically preview manager had method to get the preview runner. And then all HttpHandler requests were served by PreviewRunner - for example getData(), getStatus() etc. I removed those methods from PreviewRunner and moved to PreviewManager in one commit\nand added separate guice bindings for them in separate commit.", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r451185733", "createdAt": "2020-07-07T22:46:23Z", "author": {"login": "sagarkapare"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/DefaultPreviewRunnerModule.java", "diffHunk": "@@ -188,6 +194,9 @@ protected void configure() {\n \n     bind(PreferencesFetcher.class).toProvider(preferencesFetcherProvider);\n     expose(PreferencesFetcher.class);\n+\n+    bind(PreviewRequestFetcher.class).to(DirectPreviewRequestFetcher.class);\n+    expose(PreviewRequestFetcher.class);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU0MTI2OA=="}, "originalCommit": {"oid": "5e45cf43440f829752fa965938a1e301437ae547"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5NTY4MzI2OnYy", "diffSide": "RIGHT", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/PreviewRequestQueue.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxODoyNjozOVrOGrw3DA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMjozOTowNFrOGr3idQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU0MjQ3Ng==", "bodyText": "Better use byte[] payload here than using JsonObject as the interface", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r448542476", "createdAt": "2020-07-01T18:26:39Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/PreviewRequestQueue.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.app.preview;\n+\n+import com.google.gson.JsonObject;\n+import io.cdap.cdap.proto.id.ApplicationId;\n+\n+import java.util.Optional;\n+import javax.annotation.Nullable;\n+\n+/**\n+ * Interface designed for holding {@link PreviewRequest}s that are in WAITING state.\n+ */\n+public interface PreviewRequestQueue {\n+  /**\n+   * Poll the next available request in the queue.\n+   * @param pollerInfo information about the poller in JSON format\n+   * @return {@code PreviewRequest} if such request is available in the queue\n+   */\n+  Optional<PreviewRequest> poll(@Nullable JsonObject pollerInfo);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e45cf43440f829752fa965938a1e301437ae547"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY1MTg5Mw==", "bodyText": "done.", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r448651893", "createdAt": "2020-07-01T22:39:04Z", "author": {"login": "sagarkapare"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/PreviewRequestQueue.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.app.preview;\n+\n+import com.google.gson.JsonObject;\n+import io.cdap.cdap.proto.id.ApplicationId;\n+\n+import java.util.Optional;\n+import javax.annotation.Nullable;\n+\n+/**\n+ * Interface designed for holding {@link PreviewRequest}s that are in WAITING state.\n+ */\n+public interface PreviewRequestQueue {\n+  /**\n+   * Poll the next available request in the queue.\n+   * @param pollerInfo information about the poller in JSON format\n+   * @return {@code PreviewRequest} if such request is available in the queue\n+   */\n+  Optional<PreviewRequest> poll(@Nullable JsonObject pollerInfo);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU0MjQ3Ng=="}, "originalCommit": {"oid": "5e45cf43440f829752fa965938a1e301437ae547"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5NTY4NTUwOnYy", "diffSide": "RIGHT", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/PreviewRequestQueueState.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxODoyNzoyMlrOGrw4aA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMjozOToxMlrOGr3imw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU0MjgyNA==", "bodyText": "final", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r448542824", "createdAt": "2020-07-01T18:27:22Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/PreviewRequestQueueState.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.app.preview;\n+\n+import com.google.common.base.Objects;\n+\n+/**\n+ * Class representing the state of the preview job queue.\n+ */\n+public class PreviewRequestQueueState {\n+  private long numOfPreviewWaiting;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e45cf43440f829752fa965938a1e301437ae547"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU0MzA5OA==", "bodyText": "Also, call it pendingRequests", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r448543098", "createdAt": "2020-07-01T18:27:55Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/PreviewRequestQueueState.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.app.preview;\n+\n+import com.google.common.base.Objects;\n+\n+/**\n+ * Class representing the state of the preview job queue.\n+ */\n+public class PreviewRequestQueueState {\n+  private long numOfPreviewWaiting;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU0MjgyNA=="}, "originalCommit": {"oid": "5e45cf43440f829752fa965938a1e301437ae547"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU0MzIxNQ==", "bodyText": "BTW, it can be just an int instead of long, right?", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r448543215", "createdAt": "2020-07-01T18:28:08Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/PreviewRequestQueueState.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.app.preview;\n+\n+import com.google.common.base.Objects;\n+\n+/**\n+ * Class representing the state of the preview job queue.\n+ */\n+public class PreviewRequestQueueState {\n+  private long numOfPreviewWaiting;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU0MjgyNA=="}, "originalCommit": {"oid": "5e45cf43440f829752fa965938a1e301437ae547"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY1MTkzMQ==", "bodyText": "fixed.", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r448651931", "createdAt": "2020-07-01T22:39:12Z", "author": {"login": "sagarkapare"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/PreviewRequestQueueState.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.app.preview;\n+\n+import com.google.common.base.Objects;\n+\n+/**\n+ * Class representing the state of the preview job queue.\n+ */\n+public class PreviewRequestQueueState {\n+  private long numOfPreviewWaiting;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU0MjgyNA=="}, "originalCommit": {"oid": "5e45cf43440f829752fa965938a1e301437ae547"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5NTcwNzI5OnYy", "diffSide": "RIGHT", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/PreviewStatus.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxODozNDoyNFrOGrxGJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QyMjo0NToyMlrOGuSK9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU0NjM0MQ==", "bodyText": "What is Acquired state for?", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r448546341", "createdAt": "2020-07-01T18:34:24Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/PreviewStatus.java", "diffHunk": "@@ -29,6 +29,8 @@\n    * Status for the preview\n    */\n   public enum Status {\n+    WAITING(false),\n+    ACQUIRED(false),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e45cf43440f829752fa965938a1e301437ae547"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY1NDU4NQ==", "bodyText": "Preview app goes to the Acquired state once the poller info is written for it. Added this state, so that if the manager restarted before INIT status is received from runner, the application is ignored while building the preview request queue.", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r448654585", "createdAt": "2020-07-01T22:47:24Z", "author": {"login": "sagarkapare"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/PreviewStatus.java", "diffHunk": "@@ -29,6 +29,8 @@\n    * Status for the preview\n    */\n   public enum Status {\n+    WAITING(false),\n+    ACQUIRED(false),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU0NjM0MQ=="}, "originalCommit": {"oid": "5e45cf43440f829752fa965938a1e301437ae547"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDM5ODgxOQ==", "bodyText": "When do we mark a preview as ACQUIRED state? If it is during the poll call, then it means a preview can be in ACQUIRED state and yet no pod is owning it (consider the state is updated on the server, but failed to reach the client). If that happen, what will happen? I assume the preview will get timeout after sometime and marked as killed by timeout.\nIf that's the case, however, we can simply record it as INIT state on poll.", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r450398819", "createdAt": "2020-07-06T18:16:01Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/PreviewStatus.java", "diffHunk": "@@ -29,6 +29,8 @@\n    * Status for the preview\n    */\n   public enum Status {\n+    WAITING(false),\n+    ACQUIRED(false),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU0NjM0MQ=="}, "originalCommit": {"oid": "5e45cf43440f829752fa965938a1e301437ae547"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE4NTM5Ng==", "bodyText": "Removed and using INIT status now.", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r451185396", "createdAt": "2020-07-07T22:45:22Z", "author": {"login": "sagarkapare"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/PreviewStatus.java", "diffHunk": "@@ -29,6 +29,8 @@\n    * Status for the preview\n    */\n   public enum Status {\n+    WAITING(false),\n+    ACQUIRED(false),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU0NjM0MQ=="}, "originalCommit": {"oid": "5e45cf43440f829752fa965938a1e301437ae547"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5NTcxNTk1OnYy", "diffSide": "RIGHT", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/store/preview/PreviewStore.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxODozNzowM1rOGrxLbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMjozODo0OVrOGr3iIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU0NzY5NA==", "bodyText": "Why need a specific method for the waiting state? Shouldn't be the same as other state transition that uses the setPreviewStatus method?", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r448547694", "createdAt": "2020-07-01T18:37:03Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/store/preview/PreviewStore.java", "diffHunk": "@@ -91,4 +92,30 @@\n    */\n   @Nullable\n   PreviewStatus getPreviewStatus(ApplicationId applicationId);\n+\n+  /**\n+   * Adds the preview request for given application id in waiting state.\n+   * @param applicationId the application id corresponding to the request\n+   * @param appRequest preview request configuration\n+   */\n+  void addToWaitingState(ApplicationId applicationId, AppRequest appRequest);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e45cf43440f829752fa965938a1e301437ae547"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY1MTgwOQ==", "bodyText": "Renamed this method to add. This method also sets the status as WAITING since thats the initial status of the preview.", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r448651809", "createdAt": "2020-07-01T22:38:49Z", "author": {"login": "sagarkapare"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/store/preview/PreviewStore.java", "diffHunk": "@@ -91,4 +92,30 @@\n    */\n   @Nullable\n   PreviewStatus getPreviewStatus(ApplicationId applicationId);\n+\n+  /**\n+   * Adds the preview request for given application id in waiting state.\n+   * @param applicationId the application id corresponding to the request\n+   * @param appRequest preview request configuration\n+   */\n+  void addToWaitingState(ApplicationId applicationId, AppRequest appRequest);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU0NzY5NA=="}, "originalCommit": {"oid": "5e45cf43440f829752fa965938a1e301437ae547"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5NTcxNzcyOnYy", "diffSide": "RIGHT", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/store/preview/PreviewStore.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxODozNzozN1rOGrxMkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMjozNTo1MlrOGr3elA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU0Nzk4Nw==", "bodyText": "Why need a special one for waiting state? It should be more generic like getAllInStatus(PreviewState.Status status)", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r448547987", "createdAt": "2020-07-01T18:37:37Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/store/preview/PreviewStore.java", "diffHunk": "@@ -91,4 +92,30 @@\n    */\n   @Nullable\n   PreviewStatus getPreviewStatus(ApplicationId applicationId);\n+\n+  /**\n+   * Adds the preview request for given application id in waiting state.\n+   * @param applicationId the application id corresponding to the request\n+   * @param appRequest preview request configuration\n+   */\n+  void addToWaitingState(ApplicationId applicationId, AppRequest appRequest);\n+\n+  /**\n+   * @return list of all waiting requests in waiting state sorted by submit time\n+   */\n+  List<PreviewRequest> getAllInWaitingState();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e45cf43440f829752fa965938a1e301437ae547"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY1MDkwMA==", "bodyText": "This is called from PreviewRequestQueue implementation to build the in-memory queue in case manager is restarted. This method is special since it returns the list of PreviewRequest.  PreviewRequest is only stored for requests in waiting state.", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r448650900", "createdAt": "2020-07-01T22:35:52Z", "author": {"login": "sagarkapare"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/store/preview/PreviewStore.java", "diffHunk": "@@ -91,4 +92,30 @@\n    */\n   @Nullable\n   PreviewStatus getPreviewStatus(ApplicationId applicationId);\n+\n+  /**\n+   * Adds the preview request for given application id in waiting state.\n+   * @param applicationId the application id corresponding to the request\n+   * @param appRequest preview request configuration\n+   */\n+  void addToWaitingState(ApplicationId applicationId, AppRequest appRequest);\n+\n+  /**\n+   * @return list of all waiting requests in waiting state sorted by submit time\n+   */\n+  List<PreviewRequest> getAllInWaitingState();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU0Nzk4Nw=="}, "originalCommit": {"oid": "5e45cf43440f829752fa965938a1e301437ae547"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5NTcxODM5OnYy", "diffSide": "RIGHT", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/store/preview/PreviewStore.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxODozNzo1MFrOGrxM9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMjoyOTozMlrOGr3WHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU0ODA4Nw==", "bodyText": "Dangling javadoc?", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r448548087", "createdAt": "2020-07-01T18:37:50Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/store/preview/PreviewStore.java", "diffHunk": "@@ -91,4 +92,30 @@\n    */\n   @Nullable\n   PreviewStatus getPreviewStatus(ApplicationId applicationId);\n+\n+  /**\n+   * Adds the preview request for given application id in waiting state.\n+   * @param applicationId the application id corresponding to the request\n+   * @param appRequest preview request configuration\n+   */\n+  void addToWaitingState(ApplicationId applicationId, AppRequest appRequest);\n+\n+  /**\n+   * @return list of all waiting requests in waiting state sorted by submit time\n+   */\n+  List<PreviewRequest> getAllInWaitingState();\n+\n+  /**", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e45cf43440f829752fa965938a1e301437ae547"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY0ODczMw==", "bodyText": "removed.", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r448648733", "createdAt": "2020-07-01T22:29:32Z", "author": {"login": "sagarkapare"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/store/preview/PreviewStore.java", "diffHunk": "@@ -91,4 +92,30 @@\n    */\n   @Nullable\n   PreviewStatus getPreviewStatus(ApplicationId applicationId);\n+\n+  /**\n+   * Adds the preview request for given application id in waiting state.\n+   * @param applicationId the application id corresponding to the request\n+   * @param appRequest preview request configuration\n+   */\n+  void addToWaitingState(ApplicationId applicationId, AppRequest appRequest);\n+\n+  /**\n+   * @return list of all waiting requests in waiting state sorted by submit time\n+   */\n+  List<PreviewRequest> getAllInWaitingState();\n+\n+  /**", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU0ODA4Nw=="}, "originalCommit": {"oid": "5e45cf43440f829752fa965938a1e301437ae547"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5NTcyMTA2OnYy", "diffSide": "RIGHT", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/preview/DefaultPreviewManager.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxODozODozN1rOGrxOlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QyMjo0NDo1NlrOGuSKWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU0ODUwMA==", "bodyText": "The PreviewManager shouldn't be starting this service. Is this only used in standalone?", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r448548500", "createdAt": "2020-07-01T18:38:37Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/preview/DefaultPreviewManager.java", "diffHunk": "@@ -115,13 +119,20 @@\n     this.secureStore = secureStore;\n     this.transactionSystemClient = transactionSystemClient;\n     this.previewDataDir = Paths.get(cConf.get(Constants.CFG_LOCAL_DATA_DIR), \"preview\").toAbsolutePath();\n-    this.maxPreviews = cConf.getInt(Constants.Preview.CACHE_SIZE, 10);\n+    this.maxConcurrentPreviews = cConf.getInt(Constants.Preview.CACHE_SIZE, 10);\n     this.previewRunnerModuleFactory = previewRunnerModuleFactory;\n+    this.previewPollers = new HashSet<>();\n   }\n \n   @Override\n   protected void startUp() throws Exception {\n     previewInjector = createPreviewInjector();\n+    // Create and start the preview poller services.\n+    for (int i = 0; i < maxConcurrentPreviews; i++) {\n+      Service pollerService = previewInjector.getInstance(PreviewRunnerService.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e45cf43440f829752fa965938a1e301437ae547"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYzMjQ3Ng==", "bodyText": "Yes. We will have another preview manager implementation for distributed which wont start these services.", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r448632476", "createdAt": "2020-07-01T21:44:57Z", "author": {"login": "sagarkapare"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/preview/DefaultPreviewManager.java", "diffHunk": "@@ -115,13 +119,20 @@\n     this.secureStore = secureStore;\n     this.transactionSystemClient = transactionSystemClient;\n     this.previewDataDir = Paths.get(cConf.get(Constants.CFG_LOCAL_DATA_DIR), \"preview\").toAbsolutePath();\n-    this.maxPreviews = cConf.getInt(Constants.Preview.CACHE_SIZE, 10);\n+    this.maxConcurrentPreviews = cConf.getInt(Constants.Preview.CACHE_SIZE, 10);\n     this.previewRunnerModuleFactory = previewRunnerModuleFactory;\n+    this.previewPollers = new HashSet<>();\n   }\n \n   @Override\n   protected void startUp() throws Exception {\n     previewInjector = createPreviewInjector();\n+    // Create and start the preview poller services.\n+    for (int i = 0; i < maxConcurrentPreviews; i++) {\n+      Service pollerService = previewInjector.getInstance(PreviewRunnerService.class);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU0ODUwMA=="}, "originalCommit": {"oid": "5e45cf43440f829752fa965938a1e301437ae547"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE4NTI0MQ==", "bodyText": "Moved to separate service PreviewRunnerManager", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r451185241", "createdAt": "2020-07-07T22:44:56Z", "author": {"login": "sagarkapare"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/preview/DefaultPreviewManager.java", "diffHunk": "@@ -115,13 +119,20 @@\n     this.secureStore = secureStore;\n     this.transactionSystemClient = transactionSystemClient;\n     this.previewDataDir = Paths.get(cConf.get(Constants.CFG_LOCAL_DATA_DIR), \"preview\").toAbsolutePath();\n-    this.maxPreviews = cConf.getInt(Constants.Preview.CACHE_SIZE, 10);\n+    this.maxConcurrentPreviews = cConf.getInt(Constants.Preview.CACHE_SIZE, 10);\n     this.previewRunnerModuleFactory = previewRunnerModuleFactory;\n+    this.previewPollers = new HashSet<>();\n   }\n \n   @Override\n   protected void startUp() throws Exception {\n     previewInjector = createPreviewInjector();\n+    // Create and start the preview poller services.\n+    for (int i = 0; i < maxConcurrentPreviews; i++) {\n+      Service pollerService = previewInjector.getInstance(PreviewRunnerService.class);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU0ODUwMA=="}, "originalCommit": {"oid": "5e45cf43440f829752fa965938a1e301437ae547"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5NTcyNjk0OnYy", "diffSide": "RIGHT", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/preview/DefaultPreviewRequestQueue.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxODo0MDozMlrOGrxSRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMjoyOToxOVrOGr3Vzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU0OTQ0NQ==", "bodyText": "Why? This means a misbehaving client can actually causes all preview requests being ignored?", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r448549445", "createdAt": "2020-07-01T18:40:32Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/preview/DefaultPreviewRequestQueue.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.app.preview;\n+\n+import com.google.gson.JsonObject;\n+import com.google.inject.Inject;\n+import io.cdap.cdap.app.preview.PreviewRequest;\n+import io.cdap.cdap.app.preview.PreviewRequestQueue;\n+import io.cdap.cdap.app.preview.PreviewRequestQueueState;\n+import io.cdap.cdap.app.store.preview.PreviewStore;\n+import io.cdap.cdap.common.app.RunIds;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.proto.id.ApplicationId;\n+import net.jcip.annotations.ThreadSafe;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.concurrent.ConcurrentLinkedDeque;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+/**\n+ * Thread-safe implementation of {@link PreviewRequestQueue} backed by {@link PreviewStore}.\n+ */\n+@ThreadSafe\n+public class DefaultPreviewRequestQueue implements PreviewRequestQueue {\n+  private static final Logger LOG = LoggerFactory.getLogger(DefaultPreviewRequestQueue.class);\n+  private final PreviewStore previewStore;\n+  private final ConcurrentLinkedDeque<PreviewRequest> requestQueue;\n+  private final int capacity;\n+  private final long waitTimeOut;\n+  private final AtomicInteger queueSize;\n+\n+  @Inject\n+  DefaultPreviewRequestQueue(CConfiguration cConf, PreviewStore previewStore) {\n+    this.previewStore = previewStore;\n+    this.capacity = cConf.getInt(Constants.Preview.WAITING_QUEUE_CAPACITY, 50);\n+    this.waitTimeOut = cConf.getLong(Constants.Preview.WAITING_QUEUE_TIMEOUT_SECONDS, 60);\n+    this.requestQueue = new ConcurrentLinkedDeque<>();\n+    this.queueSize = new AtomicInteger();\n+    List<PreviewRequest> allInWaitingState = previewStore.getAllInWaitingState();\n+    for (PreviewRequest request : allInWaitingState) {\n+      if (isTimedOut(request)) {\n+        continue;\n+      }\n+      requestQueue.add(request);\n+      queueSize.incrementAndGet();\n+    }\n+  }\n+\n+  @Override\n+  public Optional<PreviewRequest> poll(JsonObject pollerInfo) {\n+    while (true) {\n+      PreviewRequest previewRequest = requestQueue.poll();\n+      if (previewRequest == null) {\n+        return Optional.empty();\n+      }\n+\n+      if (isTimedOut(previewRequest)) {\n+        LOG.warn(\"Preview request wth application id {} is timed out. Ignoring it.\",\n+                 previewRequest.getProgram().getParent());\n+        continue;\n+      }\n+\n+      try {\n+        previewStore.setPreviewRequestPollerInfo(previewRequest.getProgram().getParent(), pollerInfo);\n+      } catch (IllegalArgumentException e) {\n+        LOG.warn(\"Error while setting the poller info for preview request with application id {}. Ignoring the preview\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e45cf43440f829752fa965938a1e301437ae547"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY0ODY1NQ==", "bodyText": "This was added if the poller info is attempted to set but the preview is not in WAITING state (for example when killed by user). Throwing ConflictException from the  setPreviewRequestPollerInfo for this case now to make contract clear. PreviewRequest will be ignored.", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r448648655", "createdAt": "2020-07-01T22:29:19Z", "author": {"login": "sagarkapare"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/preview/DefaultPreviewRequestQueue.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.app.preview;\n+\n+import com.google.gson.JsonObject;\n+import com.google.inject.Inject;\n+import io.cdap.cdap.app.preview.PreviewRequest;\n+import io.cdap.cdap.app.preview.PreviewRequestQueue;\n+import io.cdap.cdap.app.preview.PreviewRequestQueueState;\n+import io.cdap.cdap.app.store.preview.PreviewStore;\n+import io.cdap.cdap.common.app.RunIds;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.proto.id.ApplicationId;\n+import net.jcip.annotations.ThreadSafe;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.concurrent.ConcurrentLinkedDeque;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+/**\n+ * Thread-safe implementation of {@link PreviewRequestQueue} backed by {@link PreviewStore}.\n+ */\n+@ThreadSafe\n+public class DefaultPreviewRequestQueue implements PreviewRequestQueue {\n+  private static final Logger LOG = LoggerFactory.getLogger(DefaultPreviewRequestQueue.class);\n+  private final PreviewStore previewStore;\n+  private final ConcurrentLinkedDeque<PreviewRequest> requestQueue;\n+  private final int capacity;\n+  private final long waitTimeOut;\n+  private final AtomicInteger queueSize;\n+\n+  @Inject\n+  DefaultPreviewRequestQueue(CConfiguration cConf, PreviewStore previewStore) {\n+    this.previewStore = previewStore;\n+    this.capacity = cConf.getInt(Constants.Preview.WAITING_QUEUE_CAPACITY, 50);\n+    this.waitTimeOut = cConf.getLong(Constants.Preview.WAITING_QUEUE_TIMEOUT_SECONDS, 60);\n+    this.requestQueue = new ConcurrentLinkedDeque<>();\n+    this.queueSize = new AtomicInteger();\n+    List<PreviewRequest> allInWaitingState = previewStore.getAllInWaitingState();\n+    for (PreviewRequest request : allInWaitingState) {\n+      if (isTimedOut(request)) {\n+        continue;\n+      }\n+      requestQueue.add(request);\n+      queueSize.incrementAndGet();\n+    }\n+  }\n+\n+  @Override\n+  public Optional<PreviewRequest> poll(JsonObject pollerInfo) {\n+    while (true) {\n+      PreviewRequest previewRequest = requestQueue.poll();\n+      if (previewRequest == null) {\n+        return Optional.empty();\n+      }\n+\n+      if (isTimedOut(previewRequest)) {\n+        LOG.warn(\"Preview request wth application id {} is timed out. Ignoring it.\",\n+                 previewRequest.getProgram().getParent());\n+        continue;\n+      }\n+\n+      try {\n+        previewStore.setPreviewRequestPollerInfo(previewRequest.getProgram().getParent(), pollerInfo);\n+      } catch (IllegalArgumentException e) {\n+        LOG.warn(\"Error while setting the poller info for preview request with application id {}. Ignoring the preview\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU0OTQ0NQ=="}, "originalCommit": {"oid": "5e45cf43440f829752fa965938a1e301437ae547"}, "originalPosition": 85}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5NTcyOTg3OnYy", "diffSide": "RIGHT", "path": "cdap-app-fabric/src/test/java/io/cdap/cdap/internal/app/store/preview/DefaultPreviewStoreTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxODo0MToyOVrOGrxUGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMjoyNDoyOFrOGr3Pog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU0OTkxMw==", "bodyText": "Why use json string to create an AppRequest?? It's better to new the object directly", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r448549913", "createdAt": "2020-07-01T18:41:29Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/test/java/io/cdap/cdap/internal/app/store/preview/DefaultPreviewStoreTest.java", "diffHunk": "@@ -122,4 +127,80 @@ public void testPreviewInfo() throws IOException {\n     Assert.assertEquals(runId, store.getProgramRunId(applicationId));\n     Assert.assertEquals(status, store.getPreviewStatus(applicationId));\n   }\n+\n+  @Test\n+  public void testPreviewWaitingRequests() {\n+    String json = \"{ \\\"id\\\": \\\"runner-1\\\"}\";\n+    JsonObject pollerInfo = new JsonParser().parse(json).getAsJsonObject();\n+\n+    Assert.assertEquals(0, store.getAllInWaitingState().size());\n+\n+    RunId id1 = RunIds.generate();\n+    ApplicationId applicationId = new ApplicationId(\"ns1\", id1.getId());\n+    store.addToWaitingState(applicationId, getAppRequest());\n+    List<PreviewRequest> allWaiting = store.getAllInWaitingState();\n+    Assert.assertEquals(1, allWaiting.size());\n+\n+    AppRequest appRequest = allWaiting.get(0).getAppRequest();\n+    Assert.assertNotNull(appRequest);\n+    Assert.assertNotNull(appRequest.getPreview());\n+    Assert.assertEquals(\"WordCount\", appRequest.getPreview().getProgramName());\n+    store.setPreviewRequestPollerInfo(applicationId, pollerInfo);\n+\n+    Assert.assertEquals(0, store.getAllInWaitingState().size());\n+\n+    // add 2 requests to the queue\n+    ApplicationId applicationId2 = new ApplicationId(\"ns1\", RunIds.generate().getId());\n+    store.addToWaitingState(applicationId2, getAppRequest());\n+    ApplicationId applicationId3 = new ApplicationId(\"ns1\", RunIds.generate().getId());\n+    store.addToWaitingState(applicationId3, getAppRequest());\n+\n+    allWaiting = store.getAllInWaitingState();\n+    Assert.assertEquals(2, allWaiting.size());\n+    Assert.assertEquals(applicationId2, allWaiting.get(0).getProgram().getParent());\n+    Assert.assertEquals(applicationId3, allWaiting.get(1).getProgram().getParent());\n+\n+    store.setPreviewRequestPollerInfo(applicationId2, pollerInfo);\n+    allWaiting = store.getAllInWaitingState();\n+    Assert.assertEquals(1, allWaiting.size());\n+    Assert.assertEquals(applicationId3, allWaiting.get(0).getProgram().getParent());\n+\n+    store.setPreviewRequestPollerInfo(applicationId3, pollerInfo);\n+    allWaiting = store.getAllInWaitingState();\n+    Assert.assertEquals(0, allWaiting.size());\n+  }\n+\n+  private AppRequest getAppRequest() {\n+    String appRequestWithSchedules = \"{\\n\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e45cf43440f829752fa965938a1e301437ae547"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY0NzA3NA==", "bodyText": "fixed.", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r448647074", "createdAt": "2020-07-01T22:24:28Z", "author": {"login": "sagarkapare"}, "path": "cdap-app-fabric/src/test/java/io/cdap/cdap/internal/app/store/preview/DefaultPreviewStoreTest.java", "diffHunk": "@@ -122,4 +127,80 @@ public void testPreviewInfo() throws IOException {\n     Assert.assertEquals(runId, store.getProgramRunId(applicationId));\n     Assert.assertEquals(status, store.getPreviewStatus(applicationId));\n   }\n+\n+  @Test\n+  public void testPreviewWaitingRequests() {\n+    String json = \"{ \\\"id\\\": \\\"runner-1\\\"}\";\n+    JsonObject pollerInfo = new JsonParser().parse(json).getAsJsonObject();\n+\n+    Assert.assertEquals(0, store.getAllInWaitingState().size());\n+\n+    RunId id1 = RunIds.generate();\n+    ApplicationId applicationId = new ApplicationId(\"ns1\", id1.getId());\n+    store.addToWaitingState(applicationId, getAppRequest());\n+    List<PreviewRequest> allWaiting = store.getAllInWaitingState();\n+    Assert.assertEquals(1, allWaiting.size());\n+\n+    AppRequest appRequest = allWaiting.get(0).getAppRequest();\n+    Assert.assertNotNull(appRequest);\n+    Assert.assertNotNull(appRequest.getPreview());\n+    Assert.assertEquals(\"WordCount\", appRequest.getPreview().getProgramName());\n+    store.setPreviewRequestPollerInfo(applicationId, pollerInfo);\n+\n+    Assert.assertEquals(0, store.getAllInWaitingState().size());\n+\n+    // add 2 requests to the queue\n+    ApplicationId applicationId2 = new ApplicationId(\"ns1\", RunIds.generate().getId());\n+    store.addToWaitingState(applicationId2, getAppRequest());\n+    ApplicationId applicationId3 = new ApplicationId(\"ns1\", RunIds.generate().getId());\n+    store.addToWaitingState(applicationId3, getAppRequest());\n+\n+    allWaiting = store.getAllInWaitingState();\n+    Assert.assertEquals(2, allWaiting.size());\n+    Assert.assertEquals(applicationId2, allWaiting.get(0).getProgram().getParent());\n+    Assert.assertEquals(applicationId3, allWaiting.get(1).getProgram().getParent());\n+\n+    store.setPreviewRequestPollerInfo(applicationId2, pollerInfo);\n+    allWaiting = store.getAllInWaitingState();\n+    Assert.assertEquals(1, allWaiting.size());\n+    Assert.assertEquals(applicationId3, allWaiting.get(0).getProgram().getParent());\n+\n+    store.setPreviewRequestPollerInfo(applicationId3, pollerInfo);\n+    allWaiting = store.getAllInWaitingState();\n+    Assert.assertEquals(0, allWaiting.size());\n+  }\n+\n+  private AppRequest getAppRequest() {\n+    String appRequestWithSchedules = \"{\\n\" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU0OTkxMw=="}, "originalCommit": {"oid": "5e45cf43440f829752fa965938a1e301437ae547"}, "originalPosition": 69}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxMzAyMzU2OnYy", "diffSide": "RIGHT", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/preview/DefaultPreviewRunner.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QyMjo1NTo1NVrOGuSY0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QyMjo1NTo1NVrOGuSY0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE4ODk0Ng==", "bodyText": "This change is required because PreviewRunner needs to know the program run id in order to stop it using ProgramLifeCycleService. Previously ProgramRunId was found in PreviewStore, however preview runner will not have access to the PreviewStore which is why we need to preserve it here.", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r451188946", "createdAt": "2020-07-07T22:55:55Z", "author": {"login": "sagarkapare"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/preview/DefaultPreviewRunner.java", "diffHunk": "@@ -134,15 +129,14 @@\n     this.dataTracerFactory = dataTracerFactory;\n     this.namespaceAdmin = namespaceAdmin;\n     this.metricsCollectionService = metricsCollectionService;\n-    this.metricsQueryHelper = metricsQueryHelper;\n     this.programNotificationSubscriberService = programNotificationSubscriberService;\n     this.levelDBTableService = levelDBTableService;\n     this.structuredTableAdmin = structuredTableAdmin;\n     this.structuredTableRegistry = structuredTableRegistry;\n   }\n \n   @Override\n-  public Future<PreviewRequest> startPreview(PreviewRequest previewRequest) throws Exception {\n+  public Map.Entry<Future<PreviewRequest>, ProgramRunId> startPreview(PreviewRequest previewRequest) throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2fb4f241f61d04492f058055dd1ea68979d23352"}, "originalPosition": 67}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2NDI3NDM3OnYy", "diffSide": "RIGHT", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/DefaultPreviewRunnerManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxODowMToyNFrOG1uBKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxOToyMzo0M1rOG1w6Bw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk4MTY3NA==", "bodyText": "Is this class only used in standalone?? Because in distributed mode, we shouldn't have this.", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r458981674", "createdAt": "2020-07-22T18:01:24Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/DefaultPreviewRunnerManager.java", "diffHunk": "@@ -0,0 +1,216 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.app.preview;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.util.concurrent.AbstractIdleService;\n+import com.google.common.util.concurrent.Service;\n+import com.google.inject.AbstractModule;\n+import com.google.inject.Guice;\n+import com.google.inject.Inject;\n+import com.google.inject.Injector;\n+import com.google.inject.Provides;\n+import com.google.inject.name.Named;\n+import com.google.inject.util.Modules;\n+import io.cdap.cdap.api.common.Bytes;\n+import io.cdap.cdap.api.security.store.SecureStore;\n+import io.cdap.cdap.app.guice.ProgramRunnerRuntimeModule;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.conf.SConfiguration;\n+import io.cdap.cdap.common.guice.ConfigModule;\n+import io.cdap.cdap.common.guice.IOModule;\n+import io.cdap.cdap.common.guice.LocalLocationModule;\n+import io.cdap.cdap.common.guice.preview.PreviewDiscoveryRuntimeModule;\n+import io.cdap.cdap.common.utils.Networks;\n+import io.cdap.cdap.config.guice.ConfigStoreModule;\n+import io.cdap.cdap.data.runtime.DataSetServiceModules;\n+import io.cdap.cdap.data.runtime.DataSetsModules;\n+import io.cdap.cdap.data.runtime.preview.PreviewDataModules;\n+import io.cdap.cdap.data2.dataset2.DatasetFramework;\n+import io.cdap.cdap.data2.dataset2.lib.table.leveldb.LevelDBTableService;\n+import io.cdap.cdap.data2.metadata.writer.MetadataServiceClient;\n+import io.cdap.cdap.data2.metadata.writer.NoOpMetadataServiceClient;\n+import io.cdap.cdap.internal.app.preview.PreviewRequestFetcherFactory;\n+import io.cdap.cdap.internal.app.preview.PreviewRunnerService;\n+import io.cdap.cdap.internal.provision.ProvisionerModule;\n+import io.cdap.cdap.logging.guice.LocalLogAppenderModule;\n+import io.cdap.cdap.messaging.guice.MessagingServerRuntimeModule;\n+import io.cdap.cdap.metadata.MetadataReaderWriterModules;\n+import io.cdap.cdap.metrics.guice.MetricsClientRuntimeModule;\n+import io.cdap.cdap.security.auth.context.AuthenticationContextModules;\n+import io.cdap.cdap.security.guice.preview.PreviewSecureStoreModule;\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.tephra.TransactionSystemClient;\n+import org.apache.twill.discovery.DiscoveryService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.IOException;\n+import java.net.InetAddress;\n+import java.net.InetSocketAddress;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.ConcurrentHashMap;\n+\n+/**\n+ * Service for managing {@link PreviewRunnerService}.\n+ */\n+public class DefaultPreviewRunnerManager extends AbstractIdleService implements PreviewRunnerManager {\n+  private static final Logger LOG = LoggerFactory.getLogger(DefaultPreviewRunnerManager.class);\n+\n+  private final CConfiguration previewCConf;\n+  private final Configuration previewHConf;\n+  private final SConfiguration previewSConf;\n+  private final int maxConcurrentPreviews;\n+  private final DiscoveryService discoveryService;\n+  private final DatasetFramework datasetFramework;\n+  private final SecureStore secureStore;\n+  private final TransactionSystemClient transactionSystemClient;\n+  private Injector previewInjector;\n+  private final PreviewRunnerModule previewRunnerModule;\n+  private final Map<String, PreviewRunnerService> previewPollers;\n+  private final LevelDBTableService previewLevelDBTableService;\n+  private final PreviewRequestFetcherFactory previewRequestFetcherFactory;\n+\n+  @Inject\n+  DefaultPreviewRunnerManager(\n+    @Named(PreviewConfigModule.PREVIEW_CCONF) CConfiguration previewCConf,\n+    @Named(PreviewConfigModule.PREVIEW_HCONF) Configuration previewHConf,\n+    @Named(PreviewConfigModule.PREVIEW_SCONF) SConfiguration previewSConf,\n+    SecureStore secureStore, DiscoveryService discoveryService,\n+    @Named(DataSetsModules.BASE_DATASET_FRAMEWORK) DatasetFramework datasetFramework,\n+    TransactionSystemClient transactionSystemClient,\n+    @Named(PreviewConfigModule.PREVIEW_LEVEL_DB) LevelDBTableService previewLevelDBTableService,\n+    PreviewRunnerModule previewRunnerModule, PreviewRequestFetcherFactory previewRequestFetcherFactory) {\n+    this.previewCConf = previewCConf;\n+    this.previewHConf = previewHConf;\n+    this.previewSConf = previewSConf;\n+    this.datasetFramework = datasetFramework;\n+    this.secureStore = secureStore;\n+    this.discoveryService = discoveryService;\n+    this.transactionSystemClient = transactionSystemClient;\n+    this.maxConcurrentPreviews = previewCConf.getInt(Constants.Preview.CACHE_SIZE, 10);\n+    this.previewPollers = new ConcurrentHashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ccd1e522b2d58ba2e2bcd64369044c24c661c6b"}, "originalPosition": 108}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAyODk5OQ==", "bodyText": "For simplicity kept the same class in distributed mode as well. In Distributed mode maxConcurrentPreviews will be set to 1.\nWe can adjust the guice bindings if required in the PR which will have distributed mode changes.", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r459028999", "createdAt": "2020-07-22T19:23:43Z", "author": {"login": "sagarkapare"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/DefaultPreviewRunnerManager.java", "diffHunk": "@@ -0,0 +1,216 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.app.preview;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.util.concurrent.AbstractIdleService;\n+import com.google.common.util.concurrent.Service;\n+import com.google.inject.AbstractModule;\n+import com.google.inject.Guice;\n+import com.google.inject.Inject;\n+import com.google.inject.Injector;\n+import com.google.inject.Provides;\n+import com.google.inject.name.Named;\n+import com.google.inject.util.Modules;\n+import io.cdap.cdap.api.common.Bytes;\n+import io.cdap.cdap.api.security.store.SecureStore;\n+import io.cdap.cdap.app.guice.ProgramRunnerRuntimeModule;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.conf.SConfiguration;\n+import io.cdap.cdap.common.guice.ConfigModule;\n+import io.cdap.cdap.common.guice.IOModule;\n+import io.cdap.cdap.common.guice.LocalLocationModule;\n+import io.cdap.cdap.common.guice.preview.PreviewDiscoveryRuntimeModule;\n+import io.cdap.cdap.common.utils.Networks;\n+import io.cdap.cdap.config.guice.ConfigStoreModule;\n+import io.cdap.cdap.data.runtime.DataSetServiceModules;\n+import io.cdap.cdap.data.runtime.DataSetsModules;\n+import io.cdap.cdap.data.runtime.preview.PreviewDataModules;\n+import io.cdap.cdap.data2.dataset2.DatasetFramework;\n+import io.cdap.cdap.data2.dataset2.lib.table.leveldb.LevelDBTableService;\n+import io.cdap.cdap.data2.metadata.writer.MetadataServiceClient;\n+import io.cdap.cdap.data2.metadata.writer.NoOpMetadataServiceClient;\n+import io.cdap.cdap.internal.app.preview.PreviewRequestFetcherFactory;\n+import io.cdap.cdap.internal.app.preview.PreviewRunnerService;\n+import io.cdap.cdap.internal.provision.ProvisionerModule;\n+import io.cdap.cdap.logging.guice.LocalLogAppenderModule;\n+import io.cdap.cdap.messaging.guice.MessagingServerRuntimeModule;\n+import io.cdap.cdap.metadata.MetadataReaderWriterModules;\n+import io.cdap.cdap.metrics.guice.MetricsClientRuntimeModule;\n+import io.cdap.cdap.security.auth.context.AuthenticationContextModules;\n+import io.cdap.cdap.security.guice.preview.PreviewSecureStoreModule;\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.tephra.TransactionSystemClient;\n+import org.apache.twill.discovery.DiscoveryService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.IOException;\n+import java.net.InetAddress;\n+import java.net.InetSocketAddress;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.ConcurrentHashMap;\n+\n+/**\n+ * Service for managing {@link PreviewRunnerService}.\n+ */\n+public class DefaultPreviewRunnerManager extends AbstractIdleService implements PreviewRunnerManager {\n+  private static final Logger LOG = LoggerFactory.getLogger(DefaultPreviewRunnerManager.class);\n+\n+  private final CConfiguration previewCConf;\n+  private final Configuration previewHConf;\n+  private final SConfiguration previewSConf;\n+  private final int maxConcurrentPreviews;\n+  private final DiscoveryService discoveryService;\n+  private final DatasetFramework datasetFramework;\n+  private final SecureStore secureStore;\n+  private final TransactionSystemClient transactionSystemClient;\n+  private Injector previewInjector;\n+  private final PreviewRunnerModule previewRunnerModule;\n+  private final Map<String, PreviewRunnerService> previewPollers;\n+  private final LevelDBTableService previewLevelDBTableService;\n+  private final PreviewRequestFetcherFactory previewRequestFetcherFactory;\n+\n+  @Inject\n+  DefaultPreviewRunnerManager(\n+    @Named(PreviewConfigModule.PREVIEW_CCONF) CConfiguration previewCConf,\n+    @Named(PreviewConfigModule.PREVIEW_HCONF) Configuration previewHConf,\n+    @Named(PreviewConfigModule.PREVIEW_SCONF) SConfiguration previewSConf,\n+    SecureStore secureStore, DiscoveryService discoveryService,\n+    @Named(DataSetsModules.BASE_DATASET_FRAMEWORK) DatasetFramework datasetFramework,\n+    TransactionSystemClient transactionSystemClient,\n+    @Named(PreviewConfigModule.PREVIEW_LEVEL_DB) LevelDBTableService previewLevelDBTableService,\n+    PreviewRunnerModule previewRunnerModule, PreviewRequestFetcherFactory previewRequestFetcherFactory) {\n+    this.previewCConf = previewCConf;\n+    this.previewHConf = previewHConf;\n+    this.previewSConf = previewSConf;\n+    this.datasetFramework = datasetFramework;\n+    this.secureStore = secureStore;\n+    this.discoveryService = discoveryService;\n+    this.transactionSystemClient = transactionSystemClient;\n+    this.maxConcurrentPreviews = previewCConf.getInt(Constants.Preview.CACHE_SIZE, 10);\n+    this.previewPollers = new ConcurrentHashMap<>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk4MTY3NA=="}, "originalCommit": {"oid": "7ccd1e522b2d58ba2e2bcd64369044c24c661c6b"}, "originalPosition": 108}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2NDI3NTI0OnYy", "diffSide": "RIGHT", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/DefaultPreviewRunnerManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxODowMTo0MFrOG1uBuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxOToxOTowMlrOG1wwAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk4MTgxNg==", "bodyText": "No need to have synchronized keyword", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r458981816", "createdAt": "2020-07-22T18:01:40Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/DefaultPreviewRunnerManager.java", "diffHunk": "@@ -0,0 +1,216 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.app.preview;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.util.concurrent.AbstractIdleService;\n+import com.google.common.util.concurrent.Service;\n+import com.google.inject.AbstractModule;\n+import com.google.inject.Guice;\n+import com.google.inject.Inject;\n+import com.google.inject.Injector;\n+import com.google.inject.Provides;\n+import com.google.inject.name.Named;\n+import com.google.inject.util.Modules;\n+import io.cdap.cdap.api.common.Bytes;\n+import io.cdap.cdap.api.security.store.SecureStore;\n+import io.cdap.cdap.app.guice.ProgramRunnerRuntimeModule;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.conf.SConfiguration;\n+import io.cdap.cdap.common.guice.ConfigModule;\n+import io.cdap.cdap.common.guice.IOModule;\n+import io.cdap.cdap.common.guice.LocalLocationModule;\n+import io.cdap.cdap.common.guice.preview.PreviewDiscoveryRuntimeModule;\n+import io.cdap.cdap.common.utils.Networks;\n+import io.cdap.cdap.config.guice.ConfigStoreModule;\n+import io.cdap.cdap.data.runtime.DataSetServiceModules;\n+import io.cdap.cdap.data.runtime.DataSetsModules;\n+import io.cdap.cdap.data.runtime.preview.PreviewDataModules;\n+import io.cdap.cdap.data2.dataset2.DatasetFramework;\n+import io.cdap.cdap.data2.dataset2.lib.table.leveldb.LevelDBTableService;\n+import io.cdap.cdap.data2.metadata.writer.MetadataServiceClient;\n+import io.cdap.cdap.data2.metadata.writer.NoOpMetadataServiceClient;\n+import io.cdap.cdap.internal.app.preview.PreviewRequestFetcherFactory;\n+import io.cdap.cdap.internal.app.preview.PreviewRunnerService;\n+import io.cdap.cdap.internal.provision.ProvisionerModule;\n+import io.cdap.cdap.logging.guice.LocalLogAppenderModule;\n+import io.cdap.cdap.messaging.guice.MessagingServerRuntimeModule;\n+import io.cdap.cdap.metadata.MetadataReaderWriterModules;\n+import io.cdap.cdap.metrics.guice.MetricsClientRuntimeModule;\n+import io.cdap.cdap.security.auth.context.AuthenticationContextModules;\n+import io.cdap.cdap.security.guice.preview.PreviewSecureStoreModule;\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.tephra.TransactionSystemClient;\n+import org.apache.twill.discovery.DiscoveryService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.IOException;\n+import java.net.InetAddress;\n+import java.net.InetSocketAddress;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.ConcurrentHashMap;\n+\n+/**\n+ * Service for managing {@link PreviewRunnerService}.\n+ */\n+public class DefaultPreviewRunnerManager extends AbstractIdleService implements PreviewRunnerManager {\n+  private static final Logger LOG = LoggerFactory.getLogger(DefaultPreviewRunnerManager.class);\n+\n+  private final CConfiguration previewCConf;\n+  private final Configuration previewHConf;\n+  private final SConfiguration previewSConf;\n+  private final int maxConcurrentPreviews;\n+  private final DiscoveryService discoveryService;\n+  private final DatasetFramework datasetFramework;\n+  private final SecureStore secureStore;\n+  private final TransactionSystemClient transactionSystemClient;\n+  private Injector previewInjector;\n+  private final PreviewRunnerModule previewRunnerModule;\n+  private final Map<String, PreviewRunnerService> previewPollers;\n+  private final LevelDBTableService previewLevelDBTableService;\n+  private final PreviewRequestFetcherFactory previewRequestFetcherFactory;\n+\n+  @Inject\n+  DefaultPreviewRunnerManager(\n+    @Named(PreviewConfigModule.PREVIEW_CCONF) CConfiguration previewCConf,\n+    @Named(PreviewConfigModule.PREVIEW_HCONF) Configuration previewHConf,\n+    @Named(PreviewConfigModule.PREVIEW_SCONF) SConfiguration previewSConf,\n+    SecureStore secureStore, DiscoveryService discoveryService,\n+    @Named(DataSetsModules.BASE_DATASET_FRAMEWORK) DatasetFramework datasetFramework,\n+    TransactionSystemClient transactionSystemClient,\n+    @Named(PreviewConfigModule.PREVIEW_LEVEL_DB) LevelDBTableService previewLevelDBTableService,\n+    PreviewRunnerModule previewRunnerModule, PreviewRequestFetcherFactory previewRequestFetcherFactory) {\n+    this.previewCConf = previewCConf;\n+    this.previewHConf = previewHConf;\n+    this.previewSConf = previewSConf;\n+    this.datasetFramework = datasetFramework;\n+    this.secureStore = secureStore;\n+    this.discoveryService = discoveryService;\n+    this.transactionSystemClient = transactionSystemClient;\n+    this.maxConcurrentPreviews = previewCConf.getInt(Constants.Preview.CACHE_SIZE, 10);\n+    this.previewPollers = new ConcurrentHashMap<>();\n+    this.previewRunnerModule = previewRunnerModule;\n+    this.previewLevelDBTableService = previewLevelDBTableService;\n+    this.previewRequestFetcherFactory = previewRequestFetcherFactory;\n+  }\n+\n+  @Override\n+  protected synchronized void startUp() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ccd1e522b2d58ba2e2bcd64369044c24c661c6b"}, "originalPosition": 115}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAyNjQzMg==", "bodyText": "Fixed.", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r459026432", "createdAt": "2020-07-22T19:19:02Z", "author": {"login": "sagarkapare"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/DefaultPreviewRunnerManager.java", "diffHunk": "@@ -0,0 +1,216 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.app.preview;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.util.concurrent.AbstractIdleService;\n+import com.google.common.util.concurrent.Service;\n+import com.google.inject.AbstractModule;\n+import com.google.inject.Guice;\n+import com.google.inject.Inject;\n+import com.google.inject.Injector;\n+import com.google.inject.Provides;\n+import com.google.inject.name.Named;\n+import com.google.inject.util.Modules;\n+import io.cdap.cdap.api.common.Bytes;\n+import io.cdap.cdap.api.security.store.SecureStore;\n+import io.cdap.cdap.app.guice.ProgramRunnerRuntimeModule;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.conf.SConfiguration;\n+import io.cdap.cdap.common.guice.ConfigModule;\n+import io.cdap.cdap.common.guice.IOModule;\n+import io.cdap.cdap.common.guice.LocalLocationModule;\n+import io.cdap.cdap.common.guice.preview.PreviewDiscoveryRuntimeModule;\n+import io.cdap.cdap.common.utils.Networks;\n+import io.cdap.cdap.config.guice.ConfigStoreModule;\n+import io.cdap.cdap.data.runtime.DataSetServiceModules;\n+import io.cdap.cdap.data.runtime.DataSetsModules;\n+import io.cdap.cdap.data.runtime.preview.PreviewDataModules;\n+import io.cdap.cdap.data2.dataset2.DatasetFramework;\n+import io.cdap.cdap.data2.dataset2.lib.table.leveldb.LevelDBTableService;\n+import io.cdap.cdap.data2.metadata.writer.MetadataServiceClient;\n+import io.cdap.cdap.data2.metadata.writer.NoOpMetadataServiceClient;\n+import io.cdap.cdap.internal.app.preview.PreviewRequestFetcherFactory;\n+import io.cdap.cdap.internal.app.preview.PreviewRunnerService;\n+import io.cdap.cdap.internal.provision.ProvisionerModule;\n+import io.cdap.cdap.logging.guice.LocalLogAppenderModule;\n+import io.cdap.cdap.messaging.guice.MessagingServerRuntimeModule;\n+import io.cdap.cdap.metadata.MetadataReaderWriterModules;\n+import io.cdap.cdap.metrics.guice.MetricsClientRuntimeModule;\n+import io.cdap.cdap.security.auth.context.AuthenticationContextModules;\n+import io.cdap.cdap.security.guice.preview.PreviewSecureStoreModule;\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.tephra.TransactionSystemClient;\n+import org.apache.twill.discovery.DiscoveryService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.IOException;\n+import java.net.InetAddress;\n+import java.net.InetSocketAddress;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.ConcurrentHashMap;\n+\n+/**\n+ * Service for managing {@link PreviewRunnerService}.\n+ */\n+public class DefaultPreviewRunnerManager extends AbstractIdleService implements PreviewRunnerManager {\n+  private static final Logger LOG = LoggerFactory.getLogger(DefaultPreviewRunnerManager.class);\n+\n+  private final CConfiguration previewCConf;\n+  private final Configuration previewHConf;\n+  private final SConfiguration previewSConf;\n+  private final int maxConcurrentPreviews;\n+  private final DiscoveryService discoveryService;\n+  private final DatasetFramework datasetFramework;\n+  private final SecureStore secureStore;\n+  private final TransactionSystemClient transactionSystemClient;\n+  private Injector previewInjector;\n+  private final PreviewRunnerModule previewRunnerModule;\n+  private final Map<String, PreviewRunnerService> previewPollers;\n+  private final LevelDBTableService previewLevelDBTableService;\n+  private final PreviewRequestFetcherFactory previewRequestFetcherFactory;\n+\n+  @Inject\n+  DefaultPreviewRunnerManager(\n+    @Named(PreviewConfigModule.PREVIEW_CCONF) CConfiguration previewCConf,\n+    @Named(PreviewConfigModule.PREVIEW_HCONF) Configuration previewHConf,\n+    @Named(PreviewConfigModule.PREVIEW_SCONF) SConfiguration previewSConf,\n+    SecureStore secureStore, DiscoveryService discoveryService,\n+    @Named(DataSetsModules.BASE_DATASET_FRAMEWORK) DatasetFramework datasetFramework,\n+    TransactionSystemClient transactionSystemClient,\n+    @Named(PreviewConfigModule.PREVIEW_LEVEL_DB) LevelDBTableService previewLevelDBTableService,\n+    PreviewRunnerModule previewRunnerModule, PreviewRequestFetcherFactory previewRequestFetcherFactory) {\n+    this.previewCConf = previewCConf;\n+    this.previewHConf = previewHConf;\n+    this.previewSConf = previewSConf;\n+    this.datasetFramework = datasetFramework;\n+    this.secureStore = secureStore;\n+    this.discoveryService = discoveryService;\n+    this.transactionSystemClient = transactionSystemClient;\n+    this.maxConcurrentPreviews = previewCConf.getInt(Constants.Preview.CACHE_SIZE, 10);\n+    this.previewPollers = new ConcurrentHashMap<>();\n+    this.previewRunnerModule = previewRunnerModule;\n+    this.previewLevelDBTableService = previewLevelDBTableService;\n+    this.previewRequestFetcherFactory = previewRequestFetcherFactory;\n+  }\n+\n+  @Override\n+  protected synchronized void startUp() throws Exception {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk4MTgxNg=="}, "originalCommit": {"oid": "7ccd1e522b2d58ba2e2bcd64369044c24c661c6b"}, "originalPosition": 115}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2NDI3OTI4OnYy", "diffSide": "RIGHT", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/DefaultPreviewRunnerManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxODowMjo0N1rOG1uEOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxODowMjo0N1rOG1uEOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk4MjQ1OA==", "bodyText": "Same here. Is this class only used for Standalone?", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r458982458", "createdAt": "2020-07-22T18:02:47Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/DefaultPreviewRunnerManager.java", "diffHunk": "@@ -0,0 +1,216 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.app.preview;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.util.concurrent.AbstractIdleService;\n+import com.google.common.util.concurrent.Service;\n+import com.google.inject.AbstractModule;\n+import com.google.inject.Guice;\n+import com.google.inject.Inject;\n+import com.google.inject.Injector;\n+import com.google.inject.Provides;\n+import com.google.inject.name.Named;\n+import com.google.inject.util.Modules;\n+import io.cdap.cdap.api.common.Bytes;\n+import io.cdap.cdap.api.security.store.SecureStore;\n+import io.cdap.cdap.app.guice.ProgramRunnerRuntimeModule;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.conf.SConfiguration;\n+import io.cdap.cdap.common.guice.ConfigModule;\n+import io.cdap.cdap.common.guice.IOModule;\n+import io.cdap.cdap.common.guice.LocalLocationModule;\n+import io.cdap.cdap.common.guice.preview.PreviewDiscoveryRuntimeModule;\n+import io.cdap.cdap.common.utils.Networks;\n+import io.cdap.cdap.config.guice.ConfigStoreModule;\n+import io.cdap.cdap.data.runtime.DataSetServiceModules;\n+import io.cdap.cdap.data.runtime.DataSetsModules;\n+import io.cdap.cdap.data.runtime.preview.PreviewDataModules;\n+import io.cdap.cdap.data2.dataset2.DatasetFramework;\n+import io.cdap.cdap.data2.dataset2.lib.table.leveldb.LevelDBTableService;\n+import io.cdap.cdap.data2.metadata.writer.MetadataServiceClient;\n+import io.cdap.cdap.data2.metadata.writer.NoOpMetadataServiceClient;\n+import io.cdap.cdap.internal.app.preview.PreviewRequestFetcherFactory;\n+import io.cdap.cdap.internal.app.preview.PreviewRunnerService;\n+import io.cdap.cdap.internal.provision.ProvisionerModule;\n+import io.cdap.cdap.logging.guice.LocalLogAppenderModule;\n+import io.cdap.cdap.messaging.guice.MessagingServerRuntimeModule;\n+import io.cdap.cdap.metadata.MetadataReaderWriterModules;\n+import io.cdap.cdap.metrics.guice.MetricsClientRuntimeModule;\n+import io.cdap.cdap.security.auth.context.AuthenticationContextModules;\n+import io.cdap.cdap.security.guice.preview.PreviewSecureStoreModule;\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.tephra.TransactionSystemClient;\n+import org.apache.twill.discovery.DiscoveryService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.IOException;\n+import java.net.InetAddress;\n+import java.net.InetSocketAddress;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.ConcurrentHashMap;\n+\n+/**\n+ * Service for managing {@link PreviewRunnerService}.\n+ */\n+public class DefaultPreviewRunnerManager extends AbstractIdleService implements PreviewRunnerManager {\n+  private static final Logger LOG = LoggerFactory.getLogger(DefaultPreviewRunnerManager.class);\n+\n+  private final CConfiguration previewCConf;\n+  private final Configuration previewHConf;\n+  private final SConfiguration previewSConf;\n+  private final int maxConcurrentPreviews;\n+  private final DiscoveryService discoveryService;\n+  private final DatasetFramework datasetFramework;\n+  private final SecureStore secureStore;\n+  private final TransactionSystemClient transactionSystemClient;\n+  private Injector previewInjector;\n+  private final PreviewRunnerModule previewRunnerModule;\n+  private final Map<String, PreviewRunnerService> previewPollers;\n+  private final LevelDBTableService previewLevelDBTableService;\n+  private final PreviewRequestFetcherFactory previewRequestFetcherFactory;\n+\n+  @Inject\n+  DefaultPreviewRunnerManager(\n+    @Named(PreviewConfigModule.PREVIEW_CCONF) CConfiguration previewCConf,\n+    @Named(PreviewConfigModule.PREVIEW_HCONF) Configuration previewHConf,\n+    @Named(PreviewConfigModule.PREVIEW_SCONF) SConfiguration previewSConf,\n+    SecureStore secureStore, DiscoveryService discoveryService,\n+    @Named(DataSetsModules.BASE_DATASET_FRAMEWORK) DatasetFramework datasetFramework,\n+    TransactionSystemClient transactionSystemClient,\n+    @Named(PreviewConfigModule.PREVIEW_LEVEL_DB) LevelDBTableService previewLevelDBTableService,\n+    PreviewRunnerModule previewRunnerModule, PreviewRequestFetcherFactory previewRequestFetcherFactory) {\n+    this.previewCConf = previewCConf;\n+    this.previewHConf = previewHConf;\n+    this.previewSConf = previewSConf;\n+    this.datasetFramework = datasetFramework;\n+    this.secureStore = secureStore;\n+    this.discoveryService = discoveryService;\n+    this.transactionSystemClient = transactionSystemClient;\n+    this.maxConcurrentPreviews = previewCConf.getInt(Constants.Preview.CACHE_SIZE, 10);\n+    this.previewPollers = new ConcurrentHashMap<>();\n+    this.previewRunnerModule = previewRunnerModule;\n+    this.previewLevelDBTableService = previewLevelDBTableService;\n+    this.previewRequestFetcherFactory = previewRequestFetcherFactory;\n+  }\n+\n+  @Override\n+  protected synchronized void startUp() throws Exception {\n+    previewInjector = createPreviewInjector();\n+    // Create and start the preview poller services.\n+    for (int i = 0; i < maxConcurrentPreviews; i++) {\n+      String pollerInfo = UUID.randomUUID().toString();\n+\n+      PreviewRunnerService pollerService = new PreviewRunnerService(\n+        previewCConf, previewInjector.getInstance(PreviewRunner.class),\n+        previewRequestFetcherFactory.create(Bytes.toBytes(pollerInfo)));\n+\n+      pollerService.startAndWait();\n+      previewPollers.put(pollerInfo, pollerService);\n+    }\n+    PreviewRunner runner = previewInjector.getInstance(PreviewRunner.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ccd1e522b2d58ba2e2bcd64369044c24c661c6b"}, "originalPosition": 128}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2NDI4MDUxOnYy", "diffSide": "RIGHT", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/DefaultPreviewRunnerManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxODowMzowNFrOG1uE9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxOToxODo1NVrOG1wv0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk4MjY0Nw==", "bodyText": "Should be logged as warning.", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r458982647", "createdAt": "2020-07-22T18:03:04Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/DefaultPreviewRunnerManager.java", "diffHunk": "@@ -0,0 +1,216 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.app.preview;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.util.concurrent.AbstractIdleService;\n+import com.google.common.util.concurrent.Service;\n+import com.google.inject.AbstractModule;\n+import com.google.inject.Guice;\n+import com.google.inject.Inject;\n+import com.google.inject.Injector;\n+import com.google.inject.Provides;\n+import com.google.inject.name.Named;\n+import com.google.inject.util.Modules;\n+import io.cdap.cdap.api.common.Bytes;\n+import io.cdap.cdap.api.security.store.SecureStore;\n+import io.cdap.cdap.app.guice.ProgramRunnerRuntimeModule;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.conf.SConfiguration;\n+import io.cdap.cdap.common.guice.ConfigModule;\n+import io.cdap.cdap.common.guice.IOModule;\n+import io.cdap.cdap.common.guice.LocalLocationModule;\n+import io.cdap.cdap.common.guice.preview.PreviewDiscoveryRuntimeModule;\n+import io.cdap.cdap.common.utils.Networks;\n+import io.cdap.cdap.config.guice.ConfigStoreModule;\n+import io.cdap.cdap.data.runtime.DataSetServiceModules;\n+import io.cdap.cdap.data.runtime.DataSetsModules;\n+import io.cdap.cdap.data.runtime.preview.PreviewDataModules;\n+import io.cdap.cdap.data2.dataset2.DatasetFramework;\n+import io.cdap.cdap.data2.dataset2.lib.table.leveldb.LevelDBTableService;\n+import io.cdap.cdap.data2.metadata.writer.MetadataServiceClient;\n+import io.cdap.cdap.data2.metadata.writer.NoOpMetadataServiceClient;\n+import io.cdap.cdap.internal.app.preview.PreviewRequestFetcherFactory;\n+import io.cdap.cdap.internal.app.preview.PreviewRunnerService;\n+import io.cdap.cdap.internal.provision.ProvisionerModule;\n+import io.cdap.cdap.logging.guice.LocalLogAppenderModule;\n+import io.cdap.cdap.messaging.guice.MessagingServerRuntimeModule;\n+import io.cdap.cdap.metadata.MetadataReaderWriterModules;\n+import io.cdap.cdap.metrics.guice.MetricsClientRuntimeModule;\n+import io.cdap.cdap.security.auth.context.AuthenticationContextModules;\n+import io.cdap.cdap.security.guice.preview.PreviewSecureStoreModule;\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.tephra.TransactionSystemClient;\n+import org.apache.twill.discovery.DiscoveryService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.IOException;\n+import java.net.InetAddress;\n+import java.net.InetSocketAddress;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.ConcurrentHashMap;\n+\n+/**\n+ * Service for managing {@link PreviewRunnerService}.\n+ */\n+public class DefaultPreviewRunnerManager extends AbstractIdleService implements PreviewRunnerManager {\n+  private static final Logger LOG = LoggerFactory.getLogger(DefaultPreviewRunnerManager.class);\n+\n+  private final CConfiguration previewCConf;\n+  private final Configuration previewHConf;\n+  private final SConfiguration previewSConf;\n+  private final int maxConcurrentPreviews;\n+  private final DiscoveryService discoveryService;\n+  private final DatasetFramework datasetFramework;\n+  private final SecureStore secureStore;\n+  private final TransactionSystemClient transactionSystemClient;\n+  private Injector previewInjector;\n+  private final PreviewRunnerModule previewRunnerModule;\n+  private final Map<String, PreviewRunnerService> previewPollers;\n+  private final LevelDBTableService previewLevelDBTableService;\n+  private final PreviewRequestFetcherFactory previewRequestFetcherFactory;\n+\n+  @Inject\n+  DefaultPreviewRunnerManager(\n+    @Named(PreviewConfigModule.PREVIEW_CCONF) CConfiguration previewCConf,\n+    @Named(PreviewConfigModule.PREVIEW_HCONF) Configuration previewHConf,\n+    @Named(PreviewConfigModule.PREVIEW_SCONF) SConfiguration previewSConf,\n+    SecureStore secureStore, DiscoveryService discoveryService,\n+    @Named(DataSetsModules.BASE_DATASET_FRAMEWORK) DatasetFramework datasetFramework,\n+    TransactionSystemClient transactionSystemClient,\n+    @Named(PreviewConfigModule.PREVIEW_LEVEL_DB) LevelDBTableService previewLevelDBTableService,\n+    PreviewRunnerModule previewRunnerModule, PreviewRequestFetcherFactory previewRequestFetcherFactory) {\n+    this.previewCConf = previewCConf;\n+    this.previewHConf = previewHConf;\n+    this.previewSConf = previewSConf;\n+    this.datasetFramework = datasetFramework;\n+    this.secureStore = secureStore;\n+    this.discoveryService = discoveryService;\n+    this.transactionSystemClient = transactionSystemClient;\n+    this.maxConcurrentPreviews = previewCConf.getInt(Constants.Preview.CACHE_SIZE, 10);\n+    this.previewPollers = new ConcurrentHashMap<>();\n+    this.previewRunnerModule = previewRunnerModule;\n+    this.previewLevelDBTableService = previewLevelDBTableService;\n+    this.previewRequestFetcherFactory = previewRequestFetcherFactory;\n+  }\n+\n+  @Override\n+  protected synchronized void startUp() throws Exception {\n+    previewInjector = createPreviewInjector();\n+    // Create and start the preview poller services.\n+    for (int i = 0; i < maxConcurrentPreviews; i++) {\n+      String pollerInfo = UUID.randomUUID().toString();\n+\n+      PreviewRunnerService pollerService = new PreviewRunnerService(\n+        previewCConf, previewInjector.getInstance(PreviewRunner.class),\n+        previewRequestFetcherFactory.create(Bytes.toBytes(pollerInfo)));\n+\n+      pollerService.startAndWait();\n+      previewPollers.put(pollerInfo, pollerService);\n+    }\n+    PreviewRunner runner = previewInjector.getInstance(PreviewRunner.class);\n+    if (runner instanceof Service) {\n+      ((Service) runner).startAndWait();\n+    }\n+  }\n+\n+  @Override\n+  protected synchronized void shutDown() throws Exception {\n+    PreviewRunner runner = previewInjector.getInstance(PreviewRunner.class);\n+    if (runner instanceof Service) {\n+      stopQuietly((Service) runner);\n+    }\n+\n+    for (Service pollerService : previewPollers.values()) {\n+      stopQuietly(pollerService);\n+    }\n+  }\n+\n+  private void stopQuietly(Service service) {\n+    try {\n+      service.stopAndWait();\n+    } catch (Exception e) {\n+      LOG.debug(\"Error stopping the preview runner.\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ccd1e522b2d58ba2e2bcd64369044c24c661c6b"}, "originalPosition": 150}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAyNjM4Nw==", "bodyText": "+1", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r459026387", "createdAt": "2020-07-22T19:18:55Z", "author": {"login": "sagarkapare"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/DefaultPreviewRunnerManager.java", "diffHunk": "@@ -0,0 +1,216 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.app.preview;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.util.concurrent.AbstractIdleService;\n+import com.google.common.util.concurrent.Service;\n+import com.google.inject.AbstractModule;\n+import com.google.inject.Guice;\n+import com.google.inject.Inject;\n+import com.google.inject.Injector;\n+import com.google.inject.Provides;\n+import com.google.inject.name.Named;\n+import com.google.inject.util.Modules;\n+import io.cdap.cdap.api.common.Bytes;\n+import io.cdap.cdap.api.security.store.SecureStore;\n+import io.cdap.cdap.app.guice.ProgramRunnerRuntimeModule;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.conf.SConfiguration;\n+import io.cdap.cdap.common.guice.ConfigModule;\n+import io.cdap.cdap.common.guice.IOModule;\n+import io.cdap.cdap.common.guice.LocalLocationModule;\n+import io.cdap.cdap.common.guice.preview.PreviewDiscoveryRuntimeModule;\n+import io.cdap.cdap.common.utils.Networks;\n+import io.cdap.cdap.config.guice.ConfigStoreModule;\n+import io.cdap.cdap.data.runtime.DataSetServiceModules;\n+import io.cdap.cdap.data.runtime.DataSetsModules;\n+import io.cdap.cdap.data.runtime.preview.PreviewDataModules;\n+import io.cdap.cdap.data2.dataset2.DatasetFramework;\n+import io.cdap.cdap.data2.dataset2.lib.table.leveldb.LevelDBTableService;\n+import io.cdap.cdap.data2.metadata.writer.MetadataServiceClient;\n+import io.cdap.cdap.data2.metadata.writer.NoOpMetadataServiceClient;\n+import io.cdap.cdap.internal.app.preview.PreviewRequestFetcherFactory;\n+import io.cdap.cdap.internal.app.preview.PreviewRunnerService;\n+import io.cdap.cdap.internal.provision.ProvisionerModule;\n+import io.cdap.cdap.logging.guice.LocalLogAppenderModule;\n+import io.cdap.cdap.messaging.guice.MessagingServerRuntimeModule;\n+import io.cdap.cdap.metadata.MetadataReaderWriterModules;\n+import io.cdap.cdap.metrics.guice.MetricsClientRuntimeModule;\n+import io.cdap.cdap.security.auth.context.AuthenticationContextModules;\n+import io.cdap.cdap.security.guice.preview.PreviewSecureStoreModule;\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.tephra.TransactionSystemClient;\n+import org.apache.twill.discovery.DiscoveryService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.IOException;\n+import java.net.InetAddress;\n+import java.net.InetSocketAddress;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.ConcurrentHashMap;\n+\n+/**\n+ * Service for managing {@link PreviewRunnerService}.\n+ */\n+public class DefaultPreviewRunnerManager extends AbstractIdleService implements PreviewRunnerManager {\n+  private static final Logger LOG = LoggerFactory.getLogger(DefaultPreviewRunnerManager.class);\n+\n+  private final CConfiguration previewCConf;\n+  private final Configuration previewHConf;\n+  private final SConfiguration previewSConf;\n+  private final int maxConcurrentPreviews;\n+  private final DiscoveryService discoveryService;\n+  private final DatasetFramework datasetFramework;\n+  private final SecureStore secureStore;\n+  private final TransactionSystemClient transactionSystemClient;\n+  private Injector previewInjector;\n+  private final PreviewRunnerModule previewRunnerModule;\n+  private final Map<String, PreviewRunnerService> previewPollers;\n+  private final LevelDBTableService previewLevelDBTableService;\n+  private final PreviewRequestFetcherFactory previewRequestFetcherFactory;\n+\n+  @Inject\n+  DefaultPreviewRunnerManager(\n+    @Named(PreviewConfigModule.PREVIEW_CCONF) CConfiguration previewCConf,\n+    @Named(PreviewConfigModule.PREVIEW_HCONF) Configuration previewHConf,\n+    @Named(PreviewConfigModule.PREVIEW_SCONF) SConfiguration previewSConf,\n+    SecureStore secureStore, DiscoveryService discoveryService,\n+    @Named(DataSetsModules.BASE_DATASET_FRAMEWORK) DatasetFramework datasetFramework,\n+    TransactionSystemClient transactionSystemClient,\n+    @Named(PreviewConfigModule.PREVIEW_LEVEL_DB) LevelDBTableService previewLevelDBTableService,\n+    PreviewRunnerModule previewRunnerModule, PreviewRequestFetcherFactory previewRequestFetcherFactory) {\n+    this.previewCConf = previewCConf;\n+    this.previewHConf = previewHConf;\n+    this.previewSConf = previewSConf;\n+    this.datasetFramework = datasetFramework;\n+    this.secureStore = secureStore;\n+    this.discoveryService = discoveryService;\n+    this.transactionSystemClient = transactionSystemClient;\n+    this.maxConcurrentPreviews = previewCConf.getInt(Constants.Preview.CACHE_SIZE, 10);\n+    this.previewPollers = new ConcurrentHashMap<>();\n+    this.previewRunnerModule = previewRunnerModule;\n+    this.previewLevelDBTableService = previewLevelDBTableService;\n+    this.previewRequestFetcherFactory = previewRequestFetcherFactory;\n+  }\n+\n+  @Override\n+  protected synchronized void startUp() throws Exception {\n+    previewInjector = createPreviewInjector();\n+    // Create and start the preview poller services.\n+    for (int i = 0; i < maxConcurrentPreviews; i++) {\n+      String pollerInfo = UUID.randomUUID().toString();\n+\n+      PreviewRunnerService pollerService = new PreviewRunnerService(\n+        previewCConf, previewInjector.getInstance(PreviewRunner.class),\n+        previewRequestFetcherFactory.create(Bytes.toBytes(pollerInfo)));\n+\n+      pollerService.startAndWait();\n+      previewPollers.put(pollerInfo, pollerService);\n+    }\n+    PreviewRunner runner = previewInjector.getInstance(PreviewRunner.class);\n+    if (runner instanceof Service) {\n+      ((Service) runner).startAndWait();\n+    }\n+  }\n+\n+  @Override\n+  protected synchronized void shutDown() throws Exception {\n+    PreviewRunner runner = previewInjector.getInstance(PreviewRunner.class);\n+    if (runner instanceof Service) {\n+      stopQuietly((Service) runner);\n+    }\n+\n+    for (Service pollerService : previewPollers.values()) {\n+      stopQuietly(pollerService);\n+    }\n+  }\n+\n+  private void stopQuietly(Service service) {\n+    try {\n+      service.stopAndWait();\n+    } catch (Exception e) {\n+      LOG.debug(\"Error stopping the preview runner.\", e);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk4MjY0Nw=="}, "originalCommit": {"oid": "7ccd1e522b2d58ba2e2bcd64369044c24c661c6b"}, "originalPosition": 150}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2NDI4Mjk5OnYy", "diffSide": "RIGHT", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/DefaultPreviewRunnerManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxODowMzo0NVrOG1uGmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxOToxODo0N1rOG1wviw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk4MzA2Nw==", "bodyText": "No need to declare msg. Just move the message into the Exception constructor.", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r458983067", "createdAt": "2020-07-22T18:03:45Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/DefaultPreviewRunnerManager.java", "diffHunk": "@@ -0,0 +1,216 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.app.preview;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.util.concurrent.AbstractIdleService;\n+import com.google.common.util.concurrent.Service;\n+import com.google.inject.AbstractModule;\n+import com.google.inject.Guice;\n+import com.google.inject.Inject;\n+import com.google.inject.Injector;\n+import com.google.inject.Provides;\n+import com.google.inject.name.Named;\n+import com.google.inject.util.Modules;\n+import io.cdap.cdap.api.common.Bytes;\n+import io.cdap.cdap.api.security.store.SecureStore;\n+import io.cdap.cdap.app.guice.ProgramRunnerRuntimeModule;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.conf.SConfiguration;\n+import io.cdap.cdap.common.guice.ConfigModule;\n+import io.cdap.cdap.common.guice.IOModule;\n+import io.cdap.cdap.common.guice.LocalLocationModule;\n+import io.cdap.cdap.common.guice.preview.PreviewDiscoveryRuntimeModule;\n+import io.cdap.cdap.common.utils.Networks;\n+import io.cdap.cdap.config.guice.ConfigStoreModule;\n+import io.cdap.cdap.data.runtime.DataSetServiceModules;\n+import io.cdap.cdap.data.runtime.DataSetsModules;\n+import io.cdap.cdap.data.runtime.preview.PreviewDataModules;\n+import io.cdap.cdap.data2.dataset2.DatasetFramework;\n+import io.cdap.cdap.data2.dataset2.lib.table.leveldb.LevelDBTableService;\n+import io.cdap.cdap.data2.metadata.writer.MetadataServiceClient;\n+import io.cdap.cdap.data2.metadata.writer.NoOpMetadataServiceClient;\n+import io.cdap.cdap.internal.app.preview.PreviewRequestFetcherFactory;\n+import io.cdap.cdap.internal.app.preview.PreviewRunnerService;\n+import io.cdap.cdap.internal.provision.ProvisionerModule;\n+import io.cdap.cdap.logging.guice.LocalLogAppenderModule;\n+import io.cdap.cdap.messaging.guice.MessagingServerRuntimeModule;\n+import io.cdap.cdap.metadata.MetadataReaderWriterModules;\n+import io.cdap.cdap.metrics.guice.MetricsClientRuntimeModule;\n+import io.cdap.cdap.security.auth.context.AuthenticationContextModules;\n+import io.cdap.cdap.security.guice.preview.PreviewSecureStoreModule;\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.tephra.TransactionSystemClient;\n+import org.apache.twill.discovery.DiscoveryService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.IOException;\n+import java.net.InetAddress;\n+import java.net.InetSocketAddress;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.ConcurrentHashMap;\n+\n+/**\n+ * Service for managing {@link PreviewRunnerService}.\n+ */\n+public class DefaultPreviewRunnerManager extends AbstractIdleService implements PreviewRunnerManager {\n+  private static final Logger LOG = LoggerFactory.getLogger(DefaultPreviewRunnerManager.class);\n+\n+  private final CConfiguration previewCConf;\n+  private final Configuration previewHConf;\n+  private final SConfiguration previewSConf;\n+  private final int maxConcurrentPreviews;\n+  private final DiscoveryService discoveryService;\n+  private final DatasetFramework datasetFramework;\n+  private final SecureStore secureStore;\n+  private final TransactionSystemClient transactionSystemClient;\n+  private Injector previewInjector;\n+  private final PreviewRunnerModule previewRunnerModule;\n+  private final Map<String, PreviewRunnerService> previewPollers;\n+  private final LevelDBTableService previewLevelDBTableService;\n+  private final PreviewRequestFetcherFactory previewRequestFetcherFactory;\n+\n+  @Inject\n+  DefaultPreviewRunnerManager(\n+    @Named(PreviewConfigModule.PREVIEW_CCONF) CConfiguration previewCConf,\n+    @Named(PreviewConfigModule.PREVIEW_HCONF) Configuration previewHConf,\n+    @Named(PreviewConfigModule.PREVIEW_SCONF) SConfiguration previewSConf,\n+    SecureStore secureStore, DiscoveryService discoveryService,\n+    @Named(DataSetsModules.BASE_DATASET_FRAMEWORK) DatasetFramework datasetFramework,\n+    TransactionSystemClient transactionSystemClient,\n+    @Named(PreviewConfigModule.PREVIEW_LEVEL_DB) LevelDBTableService previewLevelDBTableService,\n+    PreviewRunnerModule previewRunnerModule, PreviewRequestFetcherFactory previewRequestFetcherFactory) {\n+    this.previewCConf = previewCConf;\n+    this.previewHConf = previewHConf;\n+    this.previewSConf = previewSConf;\n+    this.datasetFramework = datasetFramework;\n+    this.secureStore = secureStore;\n+    this.discoveryService = discoveryService;\n+    this.transactionSystemClient = transactionSystemClient;\n+    this.maxConcurrentPreviews = previewCConf.getInt(Constants.Preview.CACHE_SIZE, 10);\n+    this.previewPollers = new ConcurrentHashMap<>();\n+    this.previewRunnerModule = previewRunnerModule;\n+    this.previewLevelDBTableService = previewLevelDBTableService;\n+    this.previewRequestFetcherFactory = previewRequestFetcherFactory;\n+  }\n+\n+  @Override\n+  protected synchronized void startUp() throws Exception {\n+    previewInjector = createPreviewInjector();\n+    // Create and start the preview poller services.\n+    for (int i = 0; i < maxConcurrentPreviews; i++) {\n+      String pollerInfo = UUID.randomUUID().toString();\n+\n+      PreviewRunnerService pollerService = new PreviewRunnerService(\n+        previewCConf, previewInjector.getInstance(PreviewRunner.class),\n+        previewRequestFetcherFactory.create(Bytes.toBytes(pollerInfo)));\n+\n+      pollerService.startAndWait();\n+      previewPollers.put(pollerInfo, pollerService);\n+    }\n+    PreviewRunner runner = previewInjector.getInstance(PreviewRunner.class);\n+    if (runner instanceof Service) {\n+      ((Service) runner).startAndWait();\n+    }\n+  }\n+\n+  @Override\n+  protected synchronized void shutDown() throws Exception {\n+    PreviewRunner runner = previewInjector.getInstance(PreviewRunner.class);\n+    if (runner instanceof Service) {\n+      stopQuietly((Service) runner);\n+    }\n+\n+    for (Service pollerService : previewPollers.values()) {\n+      stopQuietly(pollerService);\n+    }\n+  }\n+\n+  private void stopQuietly(Service service) {\n+    try {\n+      service.stopAndWait();\n+    } catch (Exception e) {\n+      LOG.debug(\"Error stopping the preview runner.\", e);\n+    }\n+  }\n+\n+  @Override\n+  public void stop(byte[] runnerId) throws Exception {\n+    PreviewRunnerService service = previewPollers.get(Bytes.toString(runnerId));\n+    if (service == null) {\n+      String msg = \"Preview run cannot be stopped. Please try stopping again or start new preview run.\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ccd1e522b2d58ba2e2bcd64369044c24c661c6b"}, "originalPosition": 158}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAyNjMxNQ==", "bodyText": "done.", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r459026315", "createdAt": "2020-07-22T19:18:47Z", "author": {"login": "sagarkapare"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/DefaultPreviewRunnerManager.java", "diffHunk": "@@ -0,0 +1,216 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.app.preview;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.util.concurrent.AbstractIdleService;\n+import com.google.common.util.concurrent.Service;\n+import com.google.inject.AbstractModule;\n+import com.google.inject.Guice;\n+import com.google.inject.Inject;\n+import com.google.inject.Injector;\n+import com.google.inject.Provides;\n+import com.google.inject.name.Named;\n+import com.google.inject.util.Modules;\n+import io.cdap.cdap.api.common.Bytes;\n+import io.cdap.cdap.api.security.store.SecureStore;\n+import io.cdap.cdap.app.guice.ProgramRunnerRuntimeModule;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.conf.SConfiguration;\n+import io.cdap.cdap.common.guice.ConfigModule;\n+import io.cdap.cdap.common.guice.IOModule;\n+import io.cdap.cdap.common.guice.LocalLocationModule;\n+import io.cdap.cdap.common.guice.preview.PreviewDiscoveryRuntimeModule;\n+import io.cdap.cdap.common.utils.Networks;\n+import io.cdap.cdap.config.guice.ConfigStoreModule;\n+import io.cdap.cdap.data.runtime.DataSetServiceModules;\n+import io.cdap.cdap.data.runtime.DataSetsModules;\n+import io.cdap.cdap.data.runtime.preview.PreviewDataModules;\n+import io.cdap.cdap.data2.dataset2.DatasetFramework;\n+import io.cdap.cdap.data2.dataset2.lib.table.leveldb.LevelDBTableService;\n+import io.cdap.cdap.data2.metadata.writer.MetadataServiceClient;\n+import io.cdap.cdap.data2.metadata.writer.NoOpMetadataServiceClient;\n+import io.cdap.cdap.internal.app.preview.PreviewRequestFetcherFactory;\n+import io.cdap.cdap.internal.app.preview.PreviewRunnerService;\n+import io.cdap.cdap.internal.provision.ProvisionerModule;\n+import io.cdap.cdap.logging.guice.LocalLogAppenderModule;\n+import io.cdap.cdap.messaging.guice.MessagingServerRuntimeModule;\n+import io.cdap.cdap.metadata.MetadataReaderWriterModules;\n+import io.cdap.cdap.metrics.guice.MetricsClientRuntimeModule;\n+import io.cdap.cdap.security.auth.context.AuthenticationContextModules;\n+import io.cdap.cdap.security.guice.preview.PreviewSecureStoreModule;\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.tephra.TransactionSystemClient;\n+import org.apache.twill.discovery.DiscoveryService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.IOException;\n+import java.net.InetAddress;\n+import java.net.InetSocketAddress;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.ConcurrentHashMap;\n+\n+/**\n+ * Service for managing {@link PreviewRunnerService}.\n+ */\n+public class DefaultPreviewRunnerManager extends AbstractIdleService implements PreviewRunnerManager {\n+  private static final Logger LOG = LoggerFactory.getLogger(DefaultPreviewRunnerManager.class);\n+\n+  private final CConfiguration previewCConf;\n+  private final Configuration previewHConf;\n+  private final SConfiguration previewSConf;\n+  private final int maxConcurrentPreviews;\n+  private final DiscoveryService discoveryService;\n+  private final DatasetFramework datasetFramework;\n+  private final SecureStore secureStore;\n+  private final TransactionSystemClient transactionSystemClient;\n+  private Injector previewInjector;\n+  private final PreviewRunnerModule previewRunnerModule;\n+  private final Map<String, PreviewRunnerService> previewPollers;\n+  private final LevelDBTableService previewLevelDBTableService;\n+  private final PreviewRequestFetcherFactory previewRequestFetcherFactory;\n+\n+  @Inject\n+  DefaultPreviewRunnerManager(\n+    @Named(PreviewConfigModule.PREVIEW_CCONF) CConfiguration previewCConf,\n+    @Named(PreviewConfigModule.PREVIEW_HCONF) Configuration previewHConf,\n+    @Named(PreviewConfigModule.PREVIEW_SCONF) SConfiguration previewSConf,\n+    SecureStore secureStore, DiscoveryService discoveryService,\n+    @Named(DataSetsModules.BASE_DATASET_FRAMEWORK) DatasetFramework datasetFramework,\n+    TransactionSystemClient transactionSystemClient,\n+    @Named(PreviewConfigModule.PREVIEW_LEVEL_DB) LevelDBTableService previewLevelDBTableService,\n+    PreviewRunnerModule previewRunnerModule, PreviewRequestFetcherFactory previewRequestFetcherFactory) {\n+    this.previewCConf = previewCConf;\n+    this.previewHConf = previewHConf;\n+    this.previewSConf = previewSConf;\n+    this.datasetFramework = datasetFramework;\n+    this.secureStore = secureStore;\n+    this.discoveryService = discoveryService;\n+    this.transactionSystemClient = transactionSystemClient;\n+    this.maxConcurrentPreviews = previewCConf.getInt(Constants.Preview.CACHE_SIZE, 10);\n+    this.previewPollers = new ConcurrentHashMap<>();\n+    this.previewRunnerModule = previewRunnerModule;\n+    this.previewLevelDBTableService = previewLevelDBTableService;\n+    this.previewRequestFetcherFactory = previewRequestFetcherFactory;\n+  }\n+\n+  @Override\n+  protected synchronized void startUp() throws Exception {\n+    previewInjector = createPreviewInjector();\n+    // Create and start the preview poller services.\n+    for (int i = 0; i < maxConcurrentPreviews; i++) {\n+      String pollerInfo = UUID.randomUUID().toString();\n+\n+      PreviewRunnerService pollerService = new PreviewRunnerService(\n+        previewCConf, previewInjector.getInstance(PreviewRunner.class),\n+        previewRequestFetcherFactory.create(Bytes.toBytes(pollerInfo)));\n+\n+      pollerService.startAndWait();\n+      previewPollers.put(pollerInfo, pollerService);\n+    }\n+    PreviewRunner runner = previewInjector.getInstance(PreviewRunner.class);\n+    if (runner instanceof Service) {\n+      ((Service) runner).startAndWait();\n+    }\n+  }\n+\n+  @Override\n+  protected synchronized void shutDown() throws Exception {\n+    PreviewRunner runner = previewInjector.getInstance(PreviewRunner.class);\n+    if (runner instanceof Service) {\n+      stopQuietly((Service) runner);\n+    }\n+\n+    for (Service pollerService : previewPollers.values()) {\n+      stopQuietly(pollerService);\n+    }\n+  }\n+\n+  private void stopQuietly(Service service) {\n+    try {\n+      service.stopAndWait();\n+    } catch (Exception e) {\n+      LOG.debug(\"Error stopping the preview runner.\", e);\n+    }\n+  }\n+\n+  @Override\n+  public void stop(byte[] runnerId) throws Exception {\n+    PreviewRunnerService service = previewPollers.get(Bytes.toString(runnerId));\n+    if (service == null) {\n+      String msg = \"Preview run cannot be stopped. Please try stopping again or start new preview run.\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk4MzA2Nw=="}, "originalCommit": {"oid": "7ccd1e522b2d58ba2e2bcd64369044c24c661c6b"}, "originalPosition": 158}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2NDI4NjQyOnYy", "diffSide": "RIGHT", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/DefaultPreviewRunnerManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxODowNDoyOFrOG1uIsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxOToxODo0MFrOG1wvRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk4MzYwMw==", "bodyText": "Should use more specify exception. E.g. NotFoundException, since the given runner id is not found?", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r458983603", "createdAt": "2020-07-22T18:04:28Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/DefaultPreviewRunnerManager.java", "diffHunk": "@@ -0,0 +1,216 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.app.preview;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.util.concurrent.AbstractIdleService;\n+import com.google.common.util.concurrent.Service;\n+import com.google.inject.AbstractModule;\n+import com.google.inject.Guice;\n+import com.google.inject.Inject;\n+import com.google.inject.Injector;\n+import com.google.inject.Provides;\n+import com.google.inject.name.Named;\n+import com.google.inject.util.Modules;\n+import io.cdap.cdap.api.common.Bytes;\n+import io.cdap.cdap.api.security.store.SecureStore;\n+import io.cdap.cdap.app.guice.ProgramRunnerRuntimeModule;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.conf.SConfiguration;\n+import io.cdap.cdap.common.guice.ConfigModule;\n+import io.cdap.cdap.common.guice.IOModule;\n+import io.cdap.cdap.common.guice.LocalLocationModule;\n+import io.cdap.cdap.common.guice.preview.PreviewDiscoveryRuntimeModule;\n+import io.cdap.cdap.common.utils.Networks;\n+import io.cdap.cdap.config.guice.ConfigStoreModule;\n+import io.cdap.cdap.data.runtime.DataSetServiceModules;\n+import io.cdap.cdap.data.runtime.DataSetsModules;\n+import io.cdap.cdap.data.runtime.preview.PreviewDataModules;\n+import io.cdap.cdap.data2.dataset2.DatasetFramework;\n+import io.cdap.cdap.data2.dataset2.lib.table.leveldb.LevelDBTableService;\n+import io.cdap.cdap.data2.metadata.writer.MetadataServiceClient;\n+import io.cdap.cdap.data2.metadata.writer.NoOpMetadataServiceClient;\n+import io.cdap.cdap.internal.app.preview.PreviewRequestFetcherFactory;\n+import io.cdap.cdap.internal.app.preview.PreviewRunnerService;\n+import io.cdap.cdap.internal.provision.ProvisionerModule;\n+import io.cdap.cdap.logging.guice.LocalLogAppenderModule;\n+import io.cdap.cdap.messaging.guice.MessagingServerRuntimeModule;\n+import io.cdap.cdap.metadata.MetadataReaderWriterModules;\n+import io.cdap.cdap.metrics.guice.MetricsClientRuntimeModule;\n+import io.cdap.cdap.security.auth.context.AuthenticationContextModules;\n+import io.cdap.cdap.security.guice.preview.PreviewSecureStoreModule;\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.tephra.TransactionSystemClient;\n+import org.apache.twill.discovery.DiscoveryService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.IOException;\n+import java.net.InetAddress;\n+import java.net.InetSocketAddress;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.ConcurrentHashMap;\n+\n+/**\n+ * Service for managing {@link PreviewRunnerService}.\n+ */\n+public class DefaultPreviewRunnerManager extends AbstractIdleService implements PreviewRunnerManager {\n+  private static final Logger LOG = LoggerFactory.getLogger(DefaultPreviewRunnerManager.class);\n+\n+  private final CConfiguration previewCConf;\n+  private final Configuration previewHConf;\n+  private final SConfiguration previewSConf;\n+  private final int maxConcurrentPreviews;\n+  private final DiscoveryService discoveryService;\n+  private final DatasetFramework datasetFramework;\n+  private final SecureStore secureStore;\n+  private final TransactionSystemClient transactionSystemClient;\n+  private Injector previewInjector;\n+  private final PreviewRunnerModule previewRunnerModule;\n+  private final Map<String, PreviewRunnerService> previewPollers;\n+  private final LevelDBTableService previewLevelDBTableService;\n+  private final PreviewRequestFetcherFactory previewRequestFetcherFactory;\n+\n+  @Inject\n+  DefaultPreviewRunnerManager(\n+    @Named(PreviewConfigModule.PREVIEW_CCONF) CConfiguration previewCConf,\n+    @Named(PreviewConfigModule.PREVIEW_HCONF) Configuration previewHConf,\n+    @Named(PreviewConfigModule.PREVIEW_SCONF) SConfiguration previewSConf,\n+    SecureStore secureStore, DiscoveryService discoveryService,\n+    @Named(DataSetsModules.BASE_DATASET_FRAMEWORK) DatasetFramework datasetFramework,\n+    TransactionSystemClient transactionSystemClient,\n+    @Named(PreviewConfigModule.PREVIEW_LEVEL_DB) LevelDBTableService previewLevelDBTableService,\n+    PreviewRunnerModule previewRunnerModule, PreviewRequestFetcherFactory previewRequestFetcherFactory) {\n+    this.previewCConf = previewCConf;\n+    this.previewHConf = previewHConf;\n+    this.previewSConf = previewSConf;\n+    this.datasetFramework = datasetFramework;\n+    this.secureStore = secureStore;\n+    this.discoveryService = discoveryService;\n+    this.transactionSystemClient = transactionSystemClient;\n+    this.maxConcurrentPreviews = previewCConf.getInt(Constants.Preview.CACHE_SIZE, 10);\n+    this.previewPollers = new ConcurrentHashMap<>();\n+    this.previewRunnerModule = previewRunnerModule;\n+    this.previewLevelDBTableService = previewLevelDBTableService;\n+    this.previewRequestFetcherFactory = previewRequestFetcherFactory;\n+  }\n+\n+  @Override\n+  protected synchronized void startUp() throws Exception {\n+    previewInjector = createPreviewInjector();\n+    // Create and start the preview poller services.\n+    for (int i = 0; i < maxConcurrentPreviews; i++) {\n+      String pollerInfo = UUID.randomUUID().toString();\n+\n+      PreviewRunnerService pollerService = new PreviewRunnerService(\n+        previewCConf, previewInjector.getInstance(PreviewRunner.class),\n+        previewRequestFetcherFactory.create(Bytes.toBytes(pollerInfo)));\n+\n+      pollerService.startAndWait();\n+      previewPollers.put(pollerInfo, pollerService);\n+    }\n+    PreviewRunner runner = previewInjector.getInstance(PreviewRunner.class);\n+    if (runner instanceof Service) {\n+      ((Service) runner).startAndWait();\n+    }\n+  }\n+\n+  @Override\n+  protected synchronized void shutDown() throws Exception {\n+    PreviewRunner runner = previewInjector.getInstance(PreviewRunner.class);\n+    if (runner instanceof Service) {\n+      stopQuietly((Service) runner);\n+    }\n+\n+    for (Service pollerService : previewPollers.values()) {\n+      stopQuietly(pollerService);\n+    }\n+  }\n+\n+  private void stopQuietly(Service service) {\n+    try {\n+      service.stopAndWait();\n+    } catch (Exception e) {\n+      LOG.debug(\"Error stopping the preview runner.\", e);\n+    }\n+  }\n+\n+  @Override\n+  public void stop(byte[] runnerId) throws Exception {\n+    PreviewRunnerService service = previewPollers.get(Bytes.toString(runnerId));\n+    if (service == null) {\n+      String msg = \"Preview run cannot be stopped. Please try stopping again or start new preview run.\";\n+      throw new Exception(msg);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ccd1e522b2d58ba2e2bcd64369044c24c661c6b"}, "originalPosition": 159}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAyNjI0Nw==", "bodyText": "+1", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r459026247", "createdAt": "2020-07-22T19:18:40Z", "author": {"login": "sagarkapare"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/DefaultPreviewRunnerManager.java", "diffHunk": "@@ -0,0 +1,216 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.app.preview;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.util.concurrent.AbstractIdleService;\n+import com.google.common.util.concurrent.Service;\n+import com.google.inject.AbstractModule;\n+import com.google.inject.Guice;\n+import com.google.inject.Inject;\n+import com.google.inject.Injector;\n+import com.google.inject.Provides;\n+import com.google.inject.name.Named;\n+import com.google.inject.util.Modules;\n+import io.cdap.cdap.api.common.Bytes;\n+import io.cdap.cdap.api.security.store.SecureStore;\n+import io.cdap.cdap.app.guice.ProgramRunnerRuntimeModule;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.conf.SConfiguration;\n+import io.cdap.cdap.common.guice.ConfigModule;\n+import io.cdap.cdap.common.guice.IOModule;\n+import io.cdap.cdap.common.guice.LocalLocationModule;\n+import io.cdap.cdap.common.guice.preview.PreviewDiscoveryRuntimeModule;\n+import io.cdap.cdap.common.utils.Networks;\n+import io.cdap.cdap.config.guice.ConfigStoreModule;\n+import io.cdap.cdap.data.runtime.DataSetServiceModules;\n+import io.cdap.cdap.data.runtime.DataSetsModules;\n+import io.cdap.cdap.data.runtime.preview.PreviewDataModules;\n+import io.cdap.cdap.data2.dataset2.DatasetFramework;\n+import io.cdap.cdap.data2.dataset2.lib.table.leveldb.LevelDBTableService;\n+import io.cdap.cdap.data2.metadata.writer.MetadataServiceClient;\n+import io.cdap.cdap.data2.metadata.writer.NoOpMetadataServiceClient;\n+import io.cdap.cdap.internal.app.preview.PreviewRequestFetcherFactory;\n+import io.cdap.cdap.internal.app.preview.PreviewRunnerService;\n+import io.cdap.cdap.internal.provision.ProvisionerModule;\n+import io.cdap.cdap.logging.guice.LocalLogAppenderModule;\n+import io.cdap.cdap.messaging.guice.MessagingServerRuntimeModule;\n+import io.cdap.cdap.metadata.MetadataReaderWriterModules;\n+import io.cdap.cdap.metrics.guice.MetricsClientRuntimeModule;\n+import io.cdap.cdap.security.auth.context.AuthenticationContextModules;\n+import io.cdap.cdap.security.guice.preview.PreviewSecureStoreModule;\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.tephra.TransactionSystemClient;\n+import org.apache.twill.discovery.DiscoveryService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.IOException;\n+import java.net.InetAddress;\n+import java.net.InetSocketAddress;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.ConcurrentHashMap;\n+\n+/**\n+ * Service for managing {@link PreviewRunnerService}.\n+ */\n+public class DefaultPreviewRunnerManager extends AbstractIdleService implements PreviewRunnerManager {\n+  private static final Logger LOG = LoggerFactory.getLogger(DefaultPreviewRunnerManager.class);\n+\n+  private final CConfiguration previewCConf;\n+  private final Configuration previewHConf;\n+  private final SConfiguration previewSConf;\n+  private final int maxConcurrentPreviews;\n+  private final DiscoveryService discoveryService;\n+  private final DatasetFramework datasetFramework;\n+  private final SecureStore secureStore;\n+  private final TransactionSystemClient transactionSystemClient;\n+  private Injector previewInjector;\n+  private final PreviewRunnerModule previewRunnerModule;\n+  private final Map<String, PreviewRunnerService> previewPollers;\n+  private final LevelDBTableService previewLevelDBTableService;\n+  private final PreviewRequestFetcherFactory previewRequestFetcherFactory;\n+\n+  @Inject\n+  DefaultPreviewRunnerManager(\n+    @Named(PreviewConfigModule.PREVIEW_CCONF) CConfiguration previewCConf,\n+    @Named(PreviewConfigModule.PREVIEW_HCONF) Configuration previewHConf,\n+    @Named(PreviewConfigModule.PREVIEW_SCONF) SConfiguration previewSConf,\n+    SecureStore secureStore, DiscoveryService discoveryService,\n+    @Named(DataSetsModules.BASE_DATASET_FRAMEWORK) DatasetFramework datasetFramework,\n+    TransactionSystemClient transactionSystemClient,\n+    @Named(PreviewConfigModule.PREVIEW_LEVEL_DB) LevelDBTableService previewLevelDBTableService,\n+    PreviewRunnerModule previewRunnerModule, PreviewRequestFetcherFactory previewRequestFetcherFactory) {\n+    this.previewCConf = previewCConf;\n+    this.previewHConf = previewHConf;\n+    this.previewSConf = previewSConf;\n+    this.datasetFramework = datasetFramework;\n+    this.secureStore = secureStore;\n+    this.discoveryService = discoveryService;\n+    this.transactionSystemClient = transactionSystemClient;\n+    this.maxConcurrentPreviews = previewCConf.getInt(Constants.Preview.CACHE_SIZE, 10);\n+    this.previewPollers = new ConcurrentHashMap<>();\n+    this.previewRunnerModule = previewRunnerModule;\n+    this.previewLevelDBTableService = previewLevelDBTableService;\n+    this.previewRequestFetcherFactory = previewRequestFetcherFactory;\n+  }\n+\n+  @Override\n+  protected synchronized void startUp() throws Exception {\n+    previewInjector = createPreviewInjector();\n+    // Create and start the preview poller services.\n+    for (int i = 0; i < maxConcurrentPreviews; i++) {\n+      String pollerInfo = UUID.randomUUID().toString();\n+\n+      PreviewRunnerService pollerService = new PreviewRunnerService(\n+        previewCConf, previewInjector.getInstance(PreviewRunner.class),\n+        previewRequestFetcherFactory.create(Bytes.toBytes(pollerInfo)));\n+\n+      pollerService.startAndWait();\n+      previewPollers.put(pollerInfo, pollerService);\n+    }\n+    PreviewRunner runner = previewInjector.getInstance(PreviewRunner.class);\n+    if (runner instanceof Service) {\n+      ((Service) runner).startAndWait();\n+    }\n+  }\n+\n+  @Override\n+  protected synchronized void shutDown() throws Exception {\n+    PreviewRunner runner = previewInjector.getInstance(PreviewRunner.class);\n+    if (runner instanceof Service) {\n+      stopQuietly((Service) runner);\n+    }\n+\n+    for (Service pollerService : previewPollers.values()) {\n+      stopQuietly(pollerService);\n+    }\n+  }\n+\n+  private void stopQuietly(Service service) {\n+    try {\n+      service.stopAndWait();\n+    } catch (Exception e) {\n+      LOG.debug(\"Error stopping the preview runner.\", e);\n+    }\n+  }\n+\n+  @Override\n+  public void stop(byte[] runnerId) throws Exception {\n+    PreviewRunnerService service = previewPollers.get(Bytes.toString(runnerId));\n+    if (service == null) {\n+      String msg = \"Preview run cannot be stopped. Please try stopping again or start new preview run.\";\n+      throw new Exception(msg);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk4MzYwMw=="}, "originalCommit": {"oid": "7ccd1e522b2d58ba2e2bcd64369044c24c661c6b"}, "originalPosition": 159}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2NDMwMjUxOnYy", "diffSide": "RIGHT", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/PreviewManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxODowODozNVrOG1uS0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxOToxODozMlrOG1wvAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk4NjE5NA==", "bodyText": "It says getting RunRecord, but what it returns is just the run id. Shall we rename the method?", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r458986194", "createdAt": "2020-07-22T18:08:35Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/PreviewManager.java", "diffHunk": "@@ -35,10 +43,40 @@\n   ApplicationId start(NamespaceId namespace, AppRequest<?> request) throws Exception;\n \n   /**\n-   * Get the {@link PreviewRunner} responsible for managing the preview.\n-   * @return the {@link PreviewRunner} associated with the preview\n+   * Get the status of the preview.\n+   * @param applicationId id of the preview application for which preview status is to be returned\n+   * @return the status of the preview\n+   * @throws NotFoundException if preview application is not found\n+   */\n+  PreviewStatus getStatus(ApplicationId applicationId) throws NotFoundException;\n+\n+  /**\n+   * Stop the preview run represented by this {@link ApplicationId}.\n+   * @param applicationId id of the preview\n+   * @throws Exception thrown when any error in stopping the preview run\n+   */\n+  void stopPreview(ApplicationId applicationId) throws Exception;\n+\n+  /**\n+   * Get the data associated with the preview run represented by this {@link PreviewRunner}.\n+   * @param applicationId the id of the preview application\n+   * @param tracerName the name of the tracer used for preview\n+   * @return the {@link Map} of properties associated with the tracer for a given preview\n+   */\n+  Map<String, List<JsonElement>> getData(ApplicationId applicationId, String tracerName);\n+\n+  /**\n+   * Get the run record of the program executed as a part of preview.\n+   * @param applicationId the id of the preview application\n+   * @return the {@link ProgramRunId} associated with the preview or {@code null} if there is no run record\n+   */\n+  ProgramRunId getRunRecord(ApplicationId applicationId) throws Exception;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ccd1e522b2d58ba2e2bcd64369044c24c661c6b"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAyNjE3OQ==", "bodyText": "Renamed method.", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r459026179", "createdAt": "2020-07-22T19:18:32Z", "author": {"login": "sagarkapare"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/PreviewManager.java", "diffHunk": "@@ -35,10 +43,40 @@\n   ApplicationId start(NamespaceId namespace, AppRequest<?> request) throws Exception;\n \n   /**\n-   * Get the {@link PreviewRunner} responsible for managing the preview.\n-   * @return the {@link PreviewRunner} associated with the preview\n+   * Get the status of the preview.\n+   * @param applicationId id of the preview application for which preview status is to be returned\n+   * @return the status of the preview\n+   * @throws NotFoundException if preview application is not found\n+   */\n+  PreviewStatus getStatus(ApplicationId applicationId) throws NotFoundException;\n+\n+  /**\n+   * Stop the preview run represented by this {@link ApplicationId}.\n+   * @param applicationId id of the preview\n+   * @throws Exception thrown when any error in stopping the preview run\n+   */\n+  void stopPreview(ApplicationId applicationId) throws Exception;\n+\n+  /**\n+   * Get the data associated with the preview run represented by this {@link PreviewRunner}.\n+   * @param applicationId the id of the preview application\n+   * @param tracerName the name of the tracer used for preview\n+   * @return the {@link Map} of properties associated with the tracer for a given preview\n+   */\n+  Map<String, List<JsonElement>> getData(ApplicationId applicationId, String tracerName);\n+\n+  /**\n+   * Get the run record of the program executed as a part of preview.\n+   * @param applicationId the id of the preview application\n+   * @return the {@link ProgramRunId} associated with the preview or {@code null} if there is no run record\n+   */\n+  ProgramRunId getRunRecord(ApplicationId applicationId) throws Exception;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk4NjE5NA=="}, "originalCommit": {"oid": "7ccd1e522b2d58ba2e2bcd64369044c24c661c6b"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2NDMxMzMzOnYy", "diffSide": "RIGHT", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/PreviewStatus.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxODoxMTo0NlrOG1uZrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxOToxNzozOFrOG1wtFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk4Nzk0OA==", "bodyText": "It's better to use the java.util.Objects then the one from guava.", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r458987948", "createdAt": "2020-07-22T18:11:46Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/PreviewStatus.java", "diffHunk": "@@ -16,9 +16,9 @@\n \n package io.cdap.cdap.app.preview;\n \n+import com.google.common.base.Objects;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ccd1e522b2d58ba2e2bcd64369044c24c661c6b"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAyNTY4NA==", "bodyText": "done.", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r459025684", "createdAt": "2020-07-22T19:17:38Z", "author": {"login": "sagarkapare"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/PreviewStatus.java", "diffHunk": "@@ -16,9 +16,9 @@\n \n package io.cdap.cdap.app.preview;\n \n+import com.google.common.base.Objects;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk4Nzk0OA=="}, "originalCommit": {"oid": "7ccd1e522b2d58ba2e2bcd64369044c24c661c6b"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2NDMzNDQ0OnYy", "diffSide": "RIGHT", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/preview/DefaultPreviewRequestQueue.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxODoxNzo1MVrOG1umuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxOTozNzo1MlrOG1xXgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk5MTI4OQ==", "bodyText": "You can simplify to\nthis.requestQueue = previewStore.getAllInWaitingState().stream()\n  .filter(DefaultPreviewRequestQueue::isValid)\n  .collect(Collectors.toCollection(ConcurrentLinkedDeque::new));\n\nwith the isValid a static method, which basically is flipping the isTimedOut method.", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r458991289", "createdAt": "2020-07-22T18:17:51Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/preview/DefaultPreviewRequestQueue.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.app.preview;\n+\n+import com.google.inject.Inject;\n+import io.cdap.cdap.app.preview.PreviewRequest;\n+import io.cdap.cdap.app.preview.PreviewRequestQueue;\n+import io.cdap.cdap.app.preview.PreviewRequestQueueState;\n+import io.cdap.cdap.app.store.preview.PreviewStore;\n+import io.cdap.cdap.common.ConflictException;\n+import io.cdap.cdap.common.app.RunIds;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.proto.id.ApplicationId;\n+import net.jcip.annotations.ThreadSafe;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.concurrent.ConcurrentLinkedDeque;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+/**\n+ * Thread-safe implementation of {@link PreviewRequestQueue} backed by {@link PreviewStore}.\n+ */\n+@ThreadSafe\n+public class DefaultPreviewRequestQueue implements PreviewRequestQueue {\n+  private static final Logger LOG = LoggerFactory.getLogger(DefaultPreviewRequestQueue.class);\n+  private final PreviewStore previewStore;\n+  private final ConcurrentLinkedDeque<PreviewRequest> requestQueue;\n+  private final int capacity;\n+  private final long waitTimeOut;\n+  private final AtomicInteger queueSize;\n+\n+  @Inject\n+  public DefaultPreviewRequestQueue(CConfiguration cConf, PreviewStore previewStore) {\n+    this.previewStore = previewStore;\n+    this.capacity = cConf.getInt(Constants.Preview.WAITING_QUEUE_CAPACITY, 50);\n+    this.waitTimeOut = cConf.getLong(Constants.Preview.WAITING_QUEUE_TIMEOUT_SECONDS, 60);\n+    this.requestQueue = new ConcurrentLinkedDeque<>();\n+    this.queueSize = new AtomicInteger();\n+    List<PreviewRequest> allInWaitingState = previewStore.getAllInWaitingState();\n+    for (PreviewRequest request : allInWaitingState) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ccd1e522b2d58ba2e2bcd64369044c24c661c6b"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAyNTYxNg==", "bodyText": "isValid also depends on the member field waitTimeOut so couldn't make it static.", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r459025616", "createdAt": "2020-07-22T19:17:30Z", "author": {"login": "sagarkapare"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/preview/DefaultPreviewRequestQueue.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.app.preview;\n+\n+import com.google.inject.Inject;\n+import io.cdap.cdap.app.preview.PreviewRequest;\n+import io.cdap.cdap.app.preview.PreviewRequestQueue;\n+import io.cdap.cdap.app.preview.PreviewRequestQueueState;\n+import io.cdap.cdap.app.store.preview.PreviewStore;\n+import io.cdap.cdap.common.ConflictException;\n+import io.cdap.cdap.common.app.RunIds;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.proto.id.ApplicationId;\n+import net.jcip.annotations.ThreadSafe;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.concurrent.ConcurrentLinkedDeque;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+/**\n+ * Thread-safe implementation of {@link PreviewRequestQueue} backed by {@link PreviewStore}.\n+ */\n+@ThreadSafe\n+public class DefaultPreviewRequestQueue implements PreviewRequestQueue {\n+  private static final Logger LOG = LoggerFactory.getLogger(DefaultPreviewRequestQueue.class);\n+  private final PreviewStore previewStore;\n+  private final ConcurrentLinkedDeque<PreviewRequest> requestQueue;\n+  private final int capacity;\n+  private final long waitTimeOut;\n+  private final AtomicInteger queueSize;\n+\n+  @Inject\n+  public DefaultPreviewRequestQueue(CConfiguration cConf, PreviewStore previewStore) {\n+    this.previewStore = previewStore;\n+    this.capacity = cConf.getInt(Constants.Preview.WAITING_QUEUE_CAPACITY, 50);\n+    this.waitTimeOut = cConf.getLong(Constants.Preview.WAITING_QUEUE_TIMEOUT_SECONDS, 60);\n+    this.requestQueue = new ConcurrentLinkedDeque<>();\n+    this.queueSize = new AtomicInteger();\n+    List<PreviewRequest> allInWaitingState = previewStore.getAllInWaitingState();\n+    for (PreviewRequest request : allInWaitingState) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk5MTI4OQ=="}, "originalCommit": {"oid": "7ccd1e522b2d58ba2e2bcd64369044c24c661c6b"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAzNjU0NA==", "bodyText": "you can pass it in through argument:\n.filter(r -> isValid(r, waitTimeOut))", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r459036544", "createdAt": "2020-07-22T19:37:52Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/preview/DefaultPreviewRequestQueue.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.app.preview;\n+\n+import com.google.inject.Inject;\n+import io.cdap.cdap.app.preview.PreviewRequest;\n+import io.cdap.cdap.app.preview.PreviewRequestQueue;\n+import io.cdap.cdap.app.preview.PreviewRequestQueueState;\n+import io.cdap.cdap.app.store.preview.PreviewStore;\n+import io.cdap.cdap.common.ConflictException;\n+import io.cdap.cdap.common.app.RunIds;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.proto.id.ApplicationId;\n+import net.jcip.annotations.ThreadSafe;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.concurrent.ConcurrentLinkedDeque;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+/**\n+ * Thread-safe implementation of {@link PreviewRequestQueue} backed by {@link PreviewStore}.\n+ */\n+@ThreadSafe\n+public class DefaultPreviewRequestQueue implements PreviewRequestQueue {\n+  private static final Logger LOG = LoggerFactory.getLogger(DefaultPreviewRequestQueue.class);\n+  private final PreviewStore previewStore;\n+  private final ConcurrentLinkedDeque<PreviewRequest> requestQueue;\n+  private final int capacity;\n+  private final long waitTimeOut;\n+  private final AtomicInteger queueSize;\n+\n+  @Inject\n+  public DefaultPreviewRequestQueue(CConfiguration cConf, PreviewStore previewStore) {\n+    this.previewStore = previewStore;\n+    this.capacity = cConf.getInt(Constants.Preview.WAITING_QUEUE_CAPACITY, 50);\n+    this.waitTimeOut = cConf.getLong(Constants.Preview.WAITING_QUEUE_TIMEOUT_SECONDS, 60);\n+    this.requestQueue = new ConcurrentLinkedDeque<>();\n+    this.queueSize = new AtomicInteger();\n+    List<PreviewRequest> allInWaitingState = previewStore.getAllInWaitingState();\n+    for (PreviewRequest request : allInWaitingState) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk5MTI4OQ=="}, "originalCommit": {"oid": "7ccd1e522b2d58ba2e2bcd64369044c24c661c6b"}, "originalPosition": 59}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2NDMzNjY1OnYy", "diffSide": "RIGHT", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/preview/DefaultPreviewRequestQueue.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxODoxODozOFrOG1uoIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxOToxNjowMVrOG1wp4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk5MTY1MQ==", "bodyText": "Why we need to track it separated from the requestQueue.size()? It is better to use the queue size as the only source of truth.", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r458991651", "createdAt": "2020-07-22T18:18:38Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/preview/DefaultPreviewRequestQueue.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.app.preview;\n+\n+import com.google.inject.Inject;\n+import io.cdap.cdap.app.preview.PreviewRequest;\n+import io.cdap.cdap.app.preview.PreviewRequestQueue;\n+import io.cdap.cdap.app.preview.PreviewRequestQueueState;\n+import io.cdap.cdap.app.store.preview.PreviewStore;\n+import io.cdap.cdap.common.ConflictException;\n+import io.cdap.cdap.common.app.RunIds;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.proto.id.ApplicationId;\n+import net.jcip.annotations.ThreadSafe;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.concurrent.ConcurrentLinkedDeque;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+/**\n+ * Thread-safe implementation of {@link PreviewRequestQueue} backed by {@link PreviewStore}.\n+ */\n+@ThreadSafe\n+public class DefaultPreviewRequestQueue implements PreviewRequestQueue {\n+  private static final Logger LOG = LoggerFactory.getLogger(DefaultPreviewRequestQueue.class);\n+  private final PreviewStore previewStore;\n+  private final ConcurrentLinkedDeque<PreviewRequest> requestQueue;\n+  private final int capacity;\n+  private final long waitTimeOut;\n+  private final AtomicInteger queueSize;\n+\n+  @Inject\n+  public DefaultPreviewRequestQueue(CConfiguration cConf, PreviewStore previewStore) {\n+    this.previewStore = previewStore;\n+    this.capacity = cConf.getInt(Constants.Preview.WAITING_QUEUE_CAPACITY, 50);\n+    this.waitTimeOut = cConf.getLong(Constants.Preview.WAITING_QUEUE_TIMEOUT_SECONDS, 60);\n+    this.requestQueue = new ConcurrentLinkedDeque<>();\n+    this.queueSize = new AtomicInteger();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ccd1e522b2d58ba2e2bcd64369044c24c661c6b"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAyNDg2NA==", "bodyText": "fixed. Also made add method as synchronized. Did it in branch but moved that change to this PR.", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r459024864", "createdAt": "2020-07-22T19:16:01Z", "author": {"login": "sagarkapare"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/preview/DefaultPreviewRequestQueue.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.app.preview;\n+\n+import com.google.inject.Inject;\n+import io.cdap.cdap.app.preview.PreviewRequest;\n+import io.cdap.cdap.app.preview.PreviewRequestQueue;\n+import io.cdap.cdap.app.preview.PreviewRequestQueueState;\n+import io.cdap.cdap.app.store.preview.PreviewStore;\n+import io.cdap.cdap.common.ConflictException;\n+import io.cdap.cdap.common.app.RunIds;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.proto.id.ApplicationId;\n+import net.jcip.annotations.ThreadSafe;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.concurrent.ConcurrentLinkedDeque;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+/**\n+ * Thread-safe implementation of {@link PreviewRequestQueue} backed by {@link PreviewStore}.\n+ */\n+@ThreadSafe\n+public class DefaultPreviewRequestQueue implements PreviewRequestQueue {\n+  private static final Logger LOG = LoggerFactory.getLogger(DefaultPreviewRequestQueue.class);\n+  private final PreviewStore previewStore;\n+  private final ConcurrentLinkedDeque<PreviewRequest> requestQueue;\n+  private final int capacity;\n+  private final long waitTimeOut;\n+  private final AtomicInteger queueSize;\n+\n+  @Inject\n+  public DefaultPreviewRequestQueue(CConfiguration cConf, PreviewStore previewStore) {\n+    this.previewStore = previewStore;\n+    this.capacity = cConf.getInt(Constants.Preview.WAITING_QUEUE_CAPACITY, 50);\n+    this.waitTimeOut = cConf.getLong(Constants.Preview.WAITING_QUEUE_TIMEOUT_SECONDS, 60);\n+    this.requestQueue = new ConcurrentLinkedDeque<>();\n+    this.queueSize = new AtomicInteger();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk5MTY1MQ=="}, "originalCommit": {"oid": "7ccd1e522b2d58ba2e2bcd64369044c24c661c6b"}, "originalPosition": 57}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2NDYwMTM2OnYy", "diffSide": "RIGHT", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/DefaultPreviewRunnerManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxOTozMzoxM1rOG1xOGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQyMzozMDo0OVrOG13ttg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAzNDEzNg==", "bodyText": "So where does the metrics go?? Inside the preview runner pod?", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r459034136", "createdAt": "2020-07-22T19:33:13Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/DefaultPreviewRunnerManager.java", "diffHunk": "@@ -0,0 +1,216 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.app.preview;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.util.concurrent.AbstractIdleService;\n+import com.google.common.util.concurrent.Service;\n+import com.google.inject.AbstractModule;\n+import com.google.inject.Guice;\n+import com.google.inject.Inject;\n+import com.google.inject.Injector;\n+import com.google.inject.Provides;\n+import com.google.inject.name.Named;\n+import com.google.inject.util.Modules;\n+import io.cdap.cdap.api.common.Bytes;\n+import io.cdap.cdap.api.security.store.SecureStore;\n+import io.cdap.cdap.app.guice.ProgramRunnerRuntimeModule;\n+import io.cdap.cdap.common.NotFoundException;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.conf.SConfiguration;\n+import io.cdap.cdap.common.guice.ConfigModule;\n+import io.cdap.cdap.common.guice.IOModule;\n+import io.cdap.cdap.common.guice.LocalLocationModule;\n+import io.cdap.cdap.common.guice.preview.PreviewDiscoveryRuntimeModule;\n+import io.cdap.cdap.common.utils.Networks;\n+import io.cdap.cdap.config.guice.ConfigStoreModule;\n+import io.cdap.cdap.data.runtime.DataSetServiceModules;\n+import io.cdap.cdap.data.runtime.DataSetsModules;\n+import io.cdap.cdap.data.runtime.preview.PreviewDataModules;\n+import io.cdap.cdap.data2.dataset2.DatasetFramework;\n+import io.cdap.cdap.data2.dataset2.lib.table.leveldb.LevelDBTableService;\n+import io.cdap.cdap.data2.metadata.writer.MetadataServiceClient;\n+import io.cdap.cdap.data2.metadata.writer.NoOpMetadataServiceClient;\n+import io.cdap.cdap.internal.app.preview.PreviewRequestFetcherFactory;\n+import io.cdap.cdap.internal.app.preview.PreviewRunnerService;\n+import io.cdap.cdap.internal.provision.ProvisionerModule;\n+import io.cdap.cdap.logging.guice.LocalLogAppenderModule;\n+import io.cdap.cdap.messaging.guice.MessagingServerRuntimeModule;\n+import io.cdap.cdap.metadata.MetadataReaderWriterModules;\n+import io.cdap.cdap.metrics.guice.MetricsClientRuntimeModule;\n+import io.cdap.cdap.security.auth.context.AuthenticationContextModules;\n+import io.cdap.cdap.security.guice.preview.PreviewSecureStoreModule;\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.tephra.TransactionSystemClient;\n+import org.apache.twill.discovery.DiscoveryService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.IOException;\n+import java.net.InetAddress;\n+import java.net.InetSocketAddress;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.ConcurrentHashMap;\n+\n+/**\n+ * Service for managing {@link PreviewRunnerService}.\n+ */\n+public class DefaultPreviewRunnerManager extends AbstractIdleService implements PreviewRunnerManager {\n+  private static final Logger LOG = LoggerFactory.getLogger(DefaultPreviewRunnerManager.class);\n+\n+  private final CConfiguration previewCConf;\n+  private final Configuration previewHConf;\n+  private final SConfiguration previewSConf;\n+  private final int maxConcurrentPreviews;\n+  private final DiscoveryService discoveryService;\n+  private final DatasetFramework datasetFramework;\n+  private final SecureStore secureStore;\n+  private final TransactionSystemClient transactionSystemClient;\n+  private Injector previewInjector;\n+  private final PreviewRunnerModule previewRunnerModule;\n+  private final Map<String, PreviewRunnerService> previewPollers;\n+  private final LevelDBTableService previewLevelDBTableService;\n+  private final PreviewRequestFetcherFactory previewRequestFetcherFactory;\n+\n+  @Inject\n+  DefaultPreviewRunnerManager(\n+    @Named(PreviewConfigModule.PREVIEW_CCONF) CConfiguration previewCConf,\n+    @Named(PreviewConfigModule.PREVIEW_HCONF) Configuration previewHConf,\n+    @Named(PreviewConfigModule.PREVIEW_SCONF) SConfiguration previewSConf,\n+    SecureStore secureStore, DiscoveryService discoveryService,\n+    @Named(DataSetsModules.BASE_DATASET_FRAMEWORK) DatasetFramework datasetFramework,\n+    TransactionSystemClient transactionSystemClient,\n+    @Named(PreviewConfigModule.PREVIEW_LEVEL_DB) LevelDBTableService previewLevelDBTableService,\n+    PreviewRunnerModule previewRunnerModule, PreviewRequestFetcherFactory previewRequestFetcherFactory) {\n+    this.previewCConf = previewCConf;\n+    this.previewHConf = previewHConf;\n+    this.previewSConf = previewSConf;\n+    this.datasetFramework = datasetFramework;\n+    this.secureStore = secureStore;\n+    this.discoveryService = discoveryService;\n+    this.transactionSystemClient = transactionSystemClient;\n+    this.maxConcurrentPreviews = previewCConf.getInt(Constants.Preview.CACHE_SIZE, 10);\n+    this.previewPollers = new ConcurrentHashMap<>();\n+    this.previewRunnerModule = previewRunnerModule;\n+    this.previewLevelDBTableService = previewLevelDBTableService;\n+    this.previewRequestFetcherFactory = previewRequestFetcherFactory;\n+  }\n+\n+  @Override\n+  protected void startUp() throws Exception {\n+    previewInjector = createPreviewInjector();\n+    // Create and start the preview poller services.\n+    for (int i = 0; i < maxConcurrentPreviews; i++) {\n+      String pollerInfo = UUID.randomUUID().toString();\n+\n+      PreviewRunnerService pollerService = new PreviewRunnerService(\n+        previewCConf, previewInjector.getInstance(PreviewRunner.class),\n+        previewRequestFetcherFactory.create(Bytes.toBytes(pollerInfo)));\n+\n+      pollerService.startAndWait();\n+      previewPollers.put(pollerInfo, pollerService);\n+    }\n+    PreviewRunner runner = previewInjector.getInstance(PreviewRunner.class);\n+    if (runner instanceof Service) {\n+      ((Service) runner).startAndWait();\n+    }\n+  }\n+\n+  @Override\n+  protected void shutDown() throws Exception {\n+    PreviewRunner runner = previewInjector.getInstance(PreviewRunner.class);\n+    if (runner instanceof Service) {\n+      stopQuietly((Service) runner);\n+    }\n+\n+    for (Service pollerService : previewPollers.values()) {\n+      stopQuietly(pollerService);\n+    }\n+  }\n+\n+  private void stopQuietly(Service service) {\n+    try {\n+      service.stopAndWait();\n+    } catch (Exception e) {\n+      LOG.warn(\"Error stopping the preview runner.\", e);\n+    }\n+  }\n+\n+  @Override\n+  public void stop(byte[] runnerId) throws Exception {\n+    PreviewRunnerService service = previewPollers.get(Bytes.toString(runnerId));\n+    if (service == null) {\n+      throw new NotFoundException(\"Preview run cannot be stopped. Please try stopping again or start new preview run.\");\n+    }\n+    service.stopAndWait();\n+    String newRunnerId = UUID.randomUUID().toString();\n+    PreviewRunnerService newService = new PreviewRunnerService(\n+      previewCConf, previewInjector.getInstance(PreviewRunner.class),\n+      previewRequestFetcherFactory.create(Bytes.toBytes(newRunnerId)));\n+    newService.startAndWait();\n+    previewPollers.put(newRunnerId, newService);\n+  }\n+\n+  /**\n+   * Create injector for the given application id.\n+   */\n+  @VisibleForTesting\n+  Injector createPreviewInjector() throws IOException {\n+    return Guice.createInjector(\n+      new ConfigModule(previewCConf, previewHConf, previewSConf),\n+      new IOModule(),\n+      new AuthenticationContextModules().getMasterModule(),\n+      new PreviewSecureStoreModule(secureStore),\n+      new PreviewDiscoveryRuntimeModule(discoveryService),\n+      new LocalLocationModule(),\n+      new ConfigStoreModule(),\n+      previewRunnerModule,\n+      new ProgramRunnerRuntimeModule().getStandaloneModules(),\n+      new PreviewDataModules().getDataFabricModule(transactionSystemClient, previewLevelDBTableService),\n+      new PreviewDataModules().getDataSetsModule(datasetFramework),\n+      new DataSetServiceModules().getStandaloneModules(),\n+      // Use the in-memory module for metrics collection, which metrics still get persisted to dataset, but\n+      // save threads for reading metrics from TMS, as there won't be metrics in TMS.\n+      new MetricsClientRuntimeModule().getInMemoryModules(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9cbf63e82a4a7bffaf80c62e9242bbd5763fb1b1"}, "originalPosition": 190}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTE0MDUzNA==", "bodyText": "Currently yes. Will add this change in separate PR.", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r459140534", "createdAt": "2020-07-22T23:30:49Z", "author": {"login": "sagarkapare"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/DefaultPreviewRunnerManager.java", "diffHunk": "@@ -0,0 +1,216 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.app.preview;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.util.concurrent.AbstractIdleService;\n+import com.google.common.util.concurrent.Service;\n+import com.google.inject.AbstractModule;\n+import com.google.inject.Guice;\n+import com.google.inject.Inject;\n+import com.google.inject.Injector;\n+import com.google.inject.Provides;\n+import com.google.inject.name.Named;\n+import com.google.inject.util.Modules;\n+import io.cdap.cdap.api.common.Bytes;\n+import io.cdap.cdap.api.security.store.SecureStore;\n+import io.cdap.cdap.app.guice.ProgramRunnerRuntimeModule;\n+import io.cdap.cdap.common.NotFoundException;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.conf.SConfiguration;\n+import io.cdap.cdap.common.guice.ConfigModule;\n+import io.cdap.cdap.common.guice.IOModule;\n+import io.cdap.cdap.common.guice.LocalLocationModule;\n+import io.cdap.cdap.common.guice.preview.PreviewDiscoveryRuntimeModule;\n+import io.cdap.cdap.common.utils.Networks;\n+import io.cdap.cdap.config.guice.ConfigStoreModule;\n+import io.cdap.cdap.data.runtime.DataSetServiceModules;\n+import io.cdap.cdap.data.runtime.DataSetsModules;\n+import io.cdap.cdap.data.runtime.preview.PreviewDataModules;\n+import io.cdap.cdap.data2.dataset2.DatasetFramework;\n+import io.cdap.cdap.data2.dataset2.lib.table.leveldb.LevelDBTableService;\n+import io.cdap.cdap.data2.metadata.writer.MetadataServiceClient;\n+import io.cdap.cdap.data2.metadata.writer.NoOpMetadataServiceClient;\n+import io.cdap.cdap.internal.app.preview.PreviewRequestFetcherFactory;\n+import io.cdap.cdap.internal.app.preview.PreviewRunnerService;\n+import io.cdap.cdap.internal.provision.ProvisionerModule;\n+import io.cdap.cdap.logging.guice.LocalLogAppenderModule;\n+import io.cdap.cdap.messaging.guice.MessagingServerRuntimeModule;\n+import io.cdap.cdap.metadata.MetadataReaderWriterModules;\n+import io.cdap.cdap.metrics.guice.MetricsClientRuntimeModule;\n+import io.cdap.cdap.security.auth.context.AuthenticationContextModules;\n+import io.cdap.cdap.security.guice.preview.PreviewSecureStoreModule;\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.tephra.TransactionSystemClient;\n+import org.apache.twill.discovery.DiscoveryService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.IOException;\n+import java.net.InetAddress;\n+import java.net.InetSocketAddress;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.ConcurrentHashMap;\n+\n+/**\n+ * Service for managing {@link PreviewRunnerService}.\n+ */\n+public class DefaultPreviewRunnerManager extends AbstractIdleService implements PreviewRunnerManager {\n+  private static final Logger LOG = LoggerFactory.getLogger(DefaultPreviewRunnerManager.class);\n+\n+  private final CConfiguration previewCConf;\n+  private final Configuration previewHConf;\n+  private final SConfiguration previewSConf;\n+  private final int maxConcurrentPreviews;\n+  private final DiscoveryService discoveryService;\n+  private final DatasetFramework datasetFramework;\n+  private final SecureStore secureStore;\n+  private final TransactionSystemClient transactionSystemClient;\n+  private Injector previewInjector;\n+  private final PreviewRunnerModule previewRunnerModule;\n+  private final Map<String, PreviewRunnerService> previewPollers;\n+  private final LevelDBTableService previewLevelDBTableService;\n+  private final PreviewRequestFetcherFactory previewRequestFetcherFactory;\n+\n+  @Inject\n+  DefaultPreviewRunnerManager(\n+    @Named(PreviewConfigModule.PREVIEW_CCONF) CConfiguration previewCConf,\n+    @Named(PreviewConfigModule.PREVIEW_HCONF) Configuration previewHConf,\n+    @Named(PreviewConfigModule.PREVIEW_SCONF) SConfiguration previewSConf,\n+    SecureStore secureStore, DiscoveryService discoveryService,\n+    @Named(DataSetsModules.BASE_DATASET_FRAMEWORK) DatasetFramework datasetFramework,\n+    TransactionSystemClient transactionSystemClient,\n+    @Named(PreviewConfigModule.PREVIEW_LEVEL_DB) LevelDBTableService previewLevelDBTableService,\n+    PreviewRunnerModule previewRunnerModule, PreviewRequestFetcherFactory previewRequestFetcherFactory) {\n+    this.previewCConf = previewCConf;\n+    this.previewHConf = previewHConf;\n+    this.previewSConf = previewSConf;\n+    this.datasetFramework = datasetFramework;\n+    this.secureStore = secureStore;\n+    this.discoveryService = discoveryService;\n+    this.transactionSystemClient = transactionSystemClient;\n+    this.maxConcurrentPreviews = previewCConf.getInt(Constants.Preview.CACHE_SIZE, 10);\n+    this.previewPollers = new ConcurrentHashMap<>();\n+    this.previewRunnerModule = previewRunnerModule;\n+    this.previewLevelDBTableService = previewLevelDBTableService;\n+    this.previewRequestFetcherFactory = previewRequestFetcherFactory;\n+  }\n+\n+  @Override\n+  protected void startUp() throws Exception {\n+    previewInjector = createPreviewInjector();\n+    // Create and start the preview poller services.\n+    for (int i = 0; i < maxConcurrentPreviews; i++) {\n+      String pollerInfo = UUID.randomUUID().toString();\n+\n+      PreviewRunnerService pollerService = new PreviewRunnerService(\n+        previewCConf, previewInjector.getInstance(PreviewRunner.class),\n+        previewRequestFetcherFactory.create(Bytes.toBytes(pollerInfo)));\n+\n+      pollerService.startAndWait();\n+      previewPollers.put(pollerInfo, pollerService);\n+    }\n+    PreviewRunner runner = previewInjector.getInstance(PreviewRunner.class);\n+    if (runner instanceof Service) {\n+      ((Service) runner).startAndWait();\n+    }\n+  }\n+\n+  @Override\n+  protected void shutDown() throws Exception {\n+    PreviewRunner runner = previewInjector.getInstance(PreviewRunner.class);\n+    if (runner instanceof Service) {\n+      stopQuietly((Service) runner);\n+    }\n+\n+    for (Service pollerService : previewPollers.values()) {\n+      stopQuietly(pollerService);\n+    }\n+  }\n+\n+  private void stopQuietly(Service service) {\n+    try {\n+      service.stopAndWait();\n+    } catch (Exception e) {\n+      LOG.warn(\"Error stopping the preview runner.\", e);\n+    }\n+  }\n+\n+  @Override\n+  public void stop(byte[] runnerId) throws Exception {\n+    PreviewRunnerService service = previewPollers.get(Bytes.toString(runnerId));\n+    if (service == null) {\n+      throw new NotFoundException(\"Preview run cannot be stopped. Please try stopping again or start new preview run.\");\n+    }\n+    service.stopAndWait();\n+    String newRunnerId = UUID.randomUUID().toString();\n+    PreviewRunnerService newService = new PreviewRunnerService(\n+      previewCConf, previewInjector.getInstance(PreviewRunner.class),\n+      previewRequestFetcherFactory.create(Bytes.toBytes(newRunnerId)));\n+    newService.startAndWait();\n+    previewPollers.put(newRunnerId, newService);\n+  }\n+\n+  /**\n+   * Create injector for the given application id.\n+   */\n+  @VisibleForTesting\n+  Injector createPreviewInjector() throws IOException {\n+    return Guice.createInjector(\n+      new ConfigModule(previewCConf, previewHConf, previewSConf),\n+      new IOModule(),\n+      new AuthenticationContextModules().getMasterModule(),\n+      new PreviewSecureStoreModule(secureStore),\n+      new PreviewDiscoveryRuntimeModule(discoveryService),\n+      new LocalLocationModule(),\n+      new ConfigStoreModule(),\n+      previewRunnerModule,\n+      new ProgramRunnerRuntimeModule().getStandaloneModules(),\n+      new PreviewDataModules().getDataFabricModule(transactionSystemClient, previewLevelDBTableService),\n+      new PreviewDataModules().getDataSetsModule(datasetFramework),\n+      new DataSetServiceModules().getStandaloneModules(),\n+      // Use the in-memory module for metrics collection, which metrics still get persisted to dataset, but\n+      // save threads for reading metrics from TMS, as there won't be metrics in TMS.\n+      new MetricsClientRuntimeModule().getInMemoryModules(),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAzNDEzNg=="}, "originalCommit": {"oid": "9cbf63e82a4a7bffaf80c62e9242bbd5763fb1b1"}, "originalPosition": 190}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2NDYxMDY5OnYy", "diffSide": "RIGHT", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/PreviewRunnerManagerModule.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxOTozNjowNVrOG1xT4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQyMzoyOToyOFrOG13sAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAzNTYxNw==", "bodyText": "Missing javadoc.", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r459035617", "createdAt": "2020-07-22T19:36:05Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/PreviewRunnerManagerModule.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Copyright \u00a9 2016-2019 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.app.preview;\n+\n+import com.google.inject.PrivateModule;\n+import com.google.inject.Provides;\n+import com.google.inject.Scopes;\n+import com.google.inject.Singleton;\n+import com.google.inject.name.Names;\n+import io.cdap.cdap.data.runtime.DataSetsModules;\n+import io.cdap.cdap.data2.datafabric.dataset.RemoteDatasetFramework;\n+import io.cdap.cdap.data2.dataset2.DatasetDefinitionRegistryFactory;\n+import io.cdap.cdap.data2.dataset2.DatasetFramework;\n+import io.cdap.cdap.data2.dataset2.DefaultDatasetDefinitionRegistryFactory;\n+import io.cdap.cdap.internal.app.preview.DirectPreviewRequestFetcherFactory;\n+import io.cdap.cdap.internal.app.preview.PreviewRequestFetcherFactory;\n+import io.cdap.cdap.internal.app.preview.PreviewRunnerServiceStopper;\n+\n+/**\n+ *", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9cbf63e82a4a7bffaf80c62e9242bbd5763fb1b1"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTE0MDA5OA==", "bodyText": "fixed.", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r459140098", "createdAt": "2020-07-22T23:29:28Z", "author": {"login": "sagarkapare"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/PreviewRunnerManagerModule.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Copyright \u00a9 2016-2019 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.app.preview;\n+\n+import com.google.inject.PrivateModule;\n+import com.google.inject.Provides;\n+import com.google.inject.Scopes;\n+import com.google.inject.Singleton;\n+import com.google.inject.name.Names;\n+import io.cdap.cdap.data.runtime.DataSetsModules;\n+import io.cdap.cdap.data2.datafabric.dataset.RemoteDatasetFramework;\n+import io.cdap.cdap.data2.dataset2.DatasetDefinitionRegistryFactory;\n+import io.cdap.cdap.data2.dataset2.DatasetFramework;\n+import io.cdap.cdap.data2.dataset2.DefaultDatasetDefinitionRegistryFactory;\n+import io.cdap.cdap.internal.app.preview.DirectPreviewRequestFetcherFactory;\n+import io.cdap.cdap.internal.app.preview.PreviewRequestFetcherFactory;\n+import io.cdap.cdap.internal.app.preview.PreviewRunnerServiceStopper;\n+\n+/**\n+ *", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAzNTYxNw=="}, "originalCommit": {"oid": "9cbf63e82a4a7bffaf80c62e9242bbd5763fb1b1"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2NDYzNTIxOnYy", "diffSide": "RIGHT", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/preview/DefaultPreviewRequestQueue.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxOTo0MzoxM1rOG1xjKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQyMzoyOToxOVrOG13r0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAzOTUzMQ==", "bodyText": "Shouldn't synchronize the whole method. You can use a BlockingDeque to limit the capacity so that it can never grow beyond a given size in a concurrent safe way.", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r459039531", "createdAt": "2020-07-22T19:43:13Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/preview/DefaultPreviewRequestQueue.java", "diffHunk": "@@ -0,0 +1,128 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.app.preview;\n+\n+import com.google.inject.Inject;\n+import io.cdap.cdap.app.preview.PreviewRequest;\n+import io.cdap.cdap.app.preview.PreviewRequestQueue;\n+import io.cdap.cdap.app.preview.PreviewRequestQueueState;\n+import io.cdap.cdap.app.store.preview.PreviewStore;\n+import io.cdap.cdap.common.ConflictException;\n+import io.cdap.cdap.common.app.RunIds;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.proto.id.ApplicationId;\n+import net.jcip.annotations.ThreadSafe;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.concurrent.ConcurrentLinkedDeque;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * Thread-safe implementation of {@link PreviewRequestQueue} backed by {@link PreviewStore}.\n+ */\n+@ThreadSafe\n+public class DefaultPreviewRequestQueue implements PreviewRequestQueue {\n+  private static final Logger LOG = LoggerFactory.getLogger(DefaultPreviewRequestQueue.class);\n+  private final PreviewStore previewStore;\n+  private final ConcurrentLinkedDeque<PreviewRequest> requestQueue;\n+  private final int capacity;\n+  private final long waitTimeOut;\n+\n+  @Inject\n+  public DefaultPreviewRequestQueue(CConfiguration cConf, PreviewStore previewStore) {\n+    this.previewStore = previewStore;\n+    this.capacity = cConf.getInt(Constants.Preview.WAITING_QUEUE_CAPACITY, 50);\n+    this.waitTimeOut = cConf.getLong(Constants.Preview.WAITING_QUEUE_TIMEOUT_SECONDS, 60);\n+    this.requestQueue = new ConcurrentLinkedDeque<>();\n+    List<PreviewRequest> allInWaitingState = previewStore.getAllInWaitingState();\n+    for (PreviewRequest request : allInWaitingState) {\n+      if (isTimedOut(request)) {\n+        continue;\n+      }\n+      requestQueue.add(request);\n+    }\n+  }\n+\n+  @Override\n+  public Optional<PreviewRequest> poll(byte[] pollerInfo) {\n+    while (true) {\n+      PreviewRequest previewRequest = requestQueue.poll();\n+      if (previewRequest == null) {\n+        return Optional.empty();\n+      }\n+\n+      if (isTimedOut(previewRequest)) {\n+        LOG.warn(\"Preview request wth application id {} is timed out. Ignoring it.\",\n+                 previewRequest.getProgram().getParent());\n+        continue;\n+      }\n+\n+      try {\n+        previewStore.setPreviewRequestPollerInfo(previewRequest.getProgram().getParent(), pollerInfo);\n+      } catch (ConflictException e) {\n+        LOG.debug(\"Preview application with id {} is not present in WAITING state. Ignoring the preview.\",\n+                  previewRequest.getProgram().getParent());\n+        continue;\n+      } catch (Exception e) {\n+        LOG.warn(\"Error while setting the poller info for preview request with application id {}. Trying again\",\n+                 previewRequest.getProgram().getParent(), e);\n+        requestQueue.addFirst(previewRequest);\n+        continue;\n+      }\n+\n+      return Optional.of(previewRequest);\n+    }\n+  }\n+\n+  @Override\n+  public synchronized void add(PreviewRequest previewRequest) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9cbf63e82a4a7bffaf80c62e9242bbd5763fb1b1"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTE0MDA0OQ==", "bodyText": "done.", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r459140049", "createdAt": "2020-07-22T23:29:19Z", "author": {"login": "sagarkapare"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/preview/DefaultPreviewRequestQueue.java", "diffHunk": "@@ -0,0 +1,128 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.app.preview;\n+\n+import com.google.inject.Inject;\n+import io.cdap.cdap.app.preview.PreviewRequest;\n+import io.cdap.cdap.app.preview.PreviewRequestQueue;\n+import io.cdap.cdap.app.preview.PreviewRequestQueueState;\n+import io.cdap.cdap.app.store.preview.PreviewStore;\n+import io.cdap.cdap.common.ConflictException;\n+import io.cdap.cdap.common.app.RunIds;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.proto.id.ApplicationId;\n+import net.jcip.annotations.ThreadSafe;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.concurrent.ConcurrentLinkedDeque;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * Thread-safe implementation of {@link PreviewRequestQueue} backed by {@link PreviewStore}.\n+ */\n+@ThreadSafe\n+public class DefaultPreviewRequestQueue implements PreviewRequestQueue {\n+  private static final Logger LOG = LoggerFactory.getLogger(DefaultPreviewRequestQueue.class);\n+  private final PreviewStore previewStore;\n+  private final ConcurrentLinkedDeque<PreviewRequest> requestQueue;\n+  private final int capacity;\n+  private final long waitTimeOut;\n+\n+  @Inject\n+  public DefaultPreviewRequestQueue(CConfiguration cConf, PreviewStore previewStore) {\n+    this.previewStore = previewStore;\n+    this.capacity = cConf.getInt(Constants.Preview.WAITING_QUEUE_CAPACITY, 50);\n+    this.waitTimeOut = cConf.getLong(Constants.Preview.WAITING_QUEUE_TIMEOUT_SECONDS, 60);\n+    this.requestQueue = new ConcurrentLinkedDeque<>();\n+    List<PreviewRequest> allInWaitingState = previewStore.getAllInWaitingState();\n+    for (PreviewRequest request : allInWaitingState) {\n+      if (isTimedOut(request)) {\n+        continue;\n+      }\n+      requestQueue.add(request);\n+    }\n+  }\n+\n+  @Override\n+  public Optional<PreviewRequest> poll(byte[] pollerInfo) {\n+    while (true) {\n+      PreviewRequest previewRequest = requestQueue.poll();\n+      if (previewRequest == null) {\n+        return Optional.empty();\n+      }\n+\n+      if (isTimedOut(previewRequest)) {\n+        LOG.warn(\"Preview request wth application id {} is timed out. Ignoring it.\",\n+                 previewRequest.getProgram().getParent());\n+        continue;\n+      }\n+\n+      try {\n+        previewStore.setPreviewRequestPollerInfo(previewRequest.getProgram().getParent(), pollerInfo);\n+      } catch (ConflictException e) {\n+        LOG.debug(\"Preview application with id {} is not present in WAITING state. Ignoring the preview.\",\n+                  previewRequest.getProgram().getParent());\n+        continue;\n+      } catch (Exception e) {\n+        LOG.warn(\"Error while setting the poller info for preview request with application id {}. Trying again\",\n+                 previewRequest.getProgram().getParent(), e);\n+        requestQueue.addFirst(previewRequest);\n+        continue;\n+      }\n+\n+      return Optional.of(previewRequest);\n+    }\n+  }\n+\n+  @Override\n+  public synchronized void add(PreviewRequest previewRequest) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAzOTUzMQ=="}, "originalCommit": {"oid": "9cbf63e82a4a7bffaf80c62e9242bbd5763fb1b1"}, "originalPosition": 96}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2NDY0MTU3OnYy", "diffSide": "RIGHT", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/preview/DefaultPreviewRequestQueue.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxOTo0NToxM1rOG1xnQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQyMzoyOTowOVrOG13rnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA0MDU3Ng==", "bodyText": "Under concurrent condition, this is possible for the queue to grow beyond the allowed size. Better use BlockingDeque and not to add it back, but rather retry locally for calling the setPreviewRequestPollerInfo method (probably with a RetryStrategy to avoid infinite retry like the logic in here).", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r459040576", "createdAt": "2020-07-22T19:45:13Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/preview/DefaultPreviewRequestQueue.java", "diffHunk": "@@ -0,0 +1,128 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.app.preview;\n+\n+import com.google.inject.Inject;\n+import io.cdap.cdap.app.preview.PreviewRequest;\n+import io.cdap.cdap.app.preview.PreviewRequestQueue;\n+import io.cdap.cdap.app.preview.PreviewRequestQueueState;\n+import io.cdap.cdap.app.store.preview.PreviewStore;\n+import io.cdap.cdap.common.ConflictException;\n+import io.cdap.cdap.common.app.RunIds;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.proto.id.ApplicationId;\n+import net.jcip.annotations.ThreadSafe;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.concurrent.ConcurrentLinkedDeque;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * Thread-safe implementation of {@link PreviewRequestQueue} backed by {@link PreviewStore}.\n+ */\n+@ThreadSafe\n+public class DefaultPreviewRequestQueue implements PreviewRequestQueue {\n+  private static final Logger LOG = LoggerFactory.getLogger(DefaultPreviewRequestQueue.class);\n+  private final PreviewStore previewStore;\n+  private final ConcurrentLinkedDeque<PreviewRequest> requestQueue;\n+  private final int capacity;\n+  private final long waitTimeOut;\n+\n+  @Inject\n+  public DefaultPreviewRequestQueue(CConfiguration cConf, PreviewStore previewStore) {\n+    this.previewStore = previewStore;\n+    this.capacity = cConf.getInt(Constants.Preview.WAITING_QUEUE_CAPACITY, 50);\n+    this.waitTimeOut = cConf.getLong(Constants.Preview.WAITING_QUEUE_TIMEOUT_SECONDS, 60);\n+    this.requestQueue = new ConcurrentLinkedDeque<>();\n+    List<PreviewRequest> allInWaitingState = previewStore.getAllInWaitingState();\n+    for (PreviewRequest request : allInWaitingState) {\n+      if (isTimedOut(request)) {\n+        continue;\n+      }\n+      requestQueue.add(request);\n+    }\n+  }\n+\n+  @Override\n+  public Optional<PreviewRequest> poll(byte[] pollerInfo) {\n+    while (true) {\n+      PreviewRequest previewRequest = requestQueue.poll();\n+      if (previewRequest == null) {\n+        return Optional.empty();\n+      }\n+\n+      if (isTimedOut(previewRequest)) {\n+        LOG.warn(\"Preview request wth application id {} is timed out. Ignoring it.\",\n+                 previewRequest.getProgram().getParent());\n+        continue;\n+      }\n+\n+      try {\n+        previewStore.setPreviewRequestPollerInfo(previewRequest.getProgram().getParent(), pollerInfo);\n+      } catch (ConflictException e) {\n+        LOG.debug(\"Preview application with id {} is not present in WAITING state. Ignoring the preview.\",\n+                  previewRequest.getProgram().getParent());\n+        continue;\n+      } catch (Exception e) {\n+        LOG.warn(\"Error while setting the poller info for preview request with application id {}. Trying again\",\n+                 previewRequest.getProgram().getParent(), e);\n+        requestQueue.addFirst(previewRequest);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9cbf63e82a4a7bffaf80c62e9242bbd5763fb1b1"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTEzOTk5Ng==", "bodyText": "Good idea. Using BlockingDeque.", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r459139996", "createdAt": "2020-07-22T23:29:09Z", "author": {"login": "sagarkapare"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/preview/DefaultPreviewRequestQueue.java", "diffHunk": "@@ -0,0 +1,128 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.app.preview;\n+\n+import com.google.inject.Inject;\n+import io.cdap.cdap.app.preview.PreviewRequest;\n+import io.cdap.cdap.app.preview.PreviewRequestQueue;\n+import io.cdap.cdap.app.preview.PreviewRequestQueueState;\n+import io.cdap.cdap.app.store.preview.PreviewStore;\n+import io.cdap.cdap.common.ConflictException;\n+import io.cdap.cdap.common.app.RunIds;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.proto.id.ApplicationId;\n+import net.jcip.annotations.ThreadSafe;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.concurrent.ConcurrentLinkedDeque;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * Thread-safe implementation of {@link PreviewRequestQueue} backed by {@link PreviewStore}.\n+ */\n+@ThreadSafe\n+public class DefaultPreviewRequestQueue implements PreviewRequestQueue {\n+  private static final Logger LOG = LoggerFactory.getLogger(DefaultPreviewRequestQueue.class);\n+  private final PreviewStore previewStore;\n+  private final ConcurrentLinkedDeque<PreviewRequest> requestQueue;\n+  private final int capacity;\n+  private final long waitTimeOut;\n+\n+  @Inject\n+  public DefaultPreviewRequestQueue(CConfiguration cConf, PreviewStore previewStore) {\n+    this.previewStore = previewStore;\n+    this.capacity = cConf.getInt(Constants.Preview.WAITING_QUEUE_CAPACITY, 50);\n+    this.waitTimeOut = cConf.getLong(Constants.Preview.WAITING_QUEUE_TIMEOUT_SECONDS, 60);\n+    this.requestQueue = new ConcurrentLinkedDeque<>();\n+    List<PreviewRequest> allInWaitingState = previewStore.getAllInWaitingState();\n+    for (PreviewRequest request : allInWaitingState) {\n+      if (isTimedOut(request)) {\n+        continue;\n+      }\n+      requestQueue.add(request);\n+    }\n+  }\n+\n+  @Override\n+  public Optional<PreviewRequest> poll(byte[] pollerInfo) {\n+    while (true) {\n+      PreviewRequest previewRequest = requestQueue.poll();\n+      if (previewRequest == null) {\n+        return Optional.empty();\n+      }\n+\n+      if (isTimedOut(previewRequest)) {\n+        LOG.warn(\"Preview request wth application id {} is timed out. Ignoring it.\",\n+                 previewRequest.getProgram().getParent());\n+        continue;\n+      }\n+\n+      try {\n+        previewStore.setPreviewRequestPollerInfo(previewRequest.getProgram().getParent(), pollerInfo);\n+      } catch (ConflictException e) {\n+        LOG.debug(\"Preview application with id {} is not present in WAITING state. Ignoring the preview.\",\n+                  previewRequest.getProgram().getParent());\n+        continue;\n+      } catch (Exception e) {\n+        LOG.warn(\"Error while setting the poller info for preview request with application id {}. Trying again\",\n+                 previewRequest.getProgram().getParent(), e);\n+        requestQueue.addFirst(previewRequest);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA0MDU3Ng=="}, "originalCommit": {"oid": "9cbf63e82a4a7bffaf80c62e9242bbd5763fb1b1"}, "originalPosition": 87}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2NjQ5MjY3OnYy", "diffSide": "RIGHT", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/preview/DefaultPreviewRequestQueue.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QwOToxOTozN1rOG2Cnlw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxNjoyMTo0N1rOG2SD0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTMxOTE5MQ==", "bodyText": "When this happen, the preview request is not ignored but getting returned instead. The retry callable should return the previewRequest if it persisted successfully, or null if conflict, so that you can break the loop based on the value.", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r459319191", "createdAt": "2020-07-23T09:19:37Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/preview/DefaultPreviewRequestQueue.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.app.preview;\n+\n+import com.google.inject.Inject;\n+import io.cdap.cdap.app.preview.PreviewRequest;\n+import io.cdap.cdap.app.preview.PreviewRequestQueue;\n+import io.cdap.cdap.app.preview.PreviewRequestQueueState;\n+import io.cdap.cdap.app.store.preview.PreviewStore;\n+import io.cdap.cdap.common.ConflictException;\n+import io.cdap.cdap.common.app.RunIds;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.service.Retries;\n+import io.cdap.cdap.common.service.RetryStrategies;\n+import io.cdap.cdap.common.service.RetryStrategy;\n+import io.cdap.cdap.proto.id.ApplicationId;\n+import net.jcip.annotations.ThreadSafe;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Optional;\n+import java.util.concurrent.BlockingDeque;\n+import java.util.concurrent.LinkedBlockingDeque;\n+import java.util.concurrent.TimeUnit;\n+import java.util.function.Supplier;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Thread-safe implementation of {@link PreviewRequestQueue} backed by {@link PreviewStore}.\n+ */\n+@ThreadSafe\n+public class DefaultPreviewRequestQueue implements PreviewRequestQueue {\n+  private static final Logger LOG = LoggerFactory.getLogger(DefaultPreviewRequestQueue.class);\n+  private final PreviewStore previewStore;\n+  private final BlockingDeque<PreviewRequest> requestQueue;\n+  private final int capacity;\n+  private final long waitTimeOut;\n+  private final RetryStrategy retryStrategy;\n+\n+  @Inject\n+  public DefaultPreviewRequestQueue(CConfiguration cConf, PreviewStore previewStore) {\n+    this.previewStore = previewStore;\n+    this.capacity = cConf.getInt(Constants.Preview.WAITING_QUEUE_CAPACITY, 50);\n+    this.waitTimeOut = cConf.getLong(Constants.Preview.WAITING_QUEUE_TIMEOUT_SECONDS, 60);\n+    this.retryStrategy = RetryStrategies.fromConfiguration(cConf, \"system.preview.store.update.\");\n+    this.requestQueue = previewStore.getAllInWaitingState().stream()\n+      .filter(r -> isValid(r, waitTimeOut))\n+      .collect(Collectors.toCollection(() -> new LinkedBlockingDeque<>(capacity)));\n+  }\n+\n+  @Override\n+  public Optional<PreviewRequest> poll(byte[] pollerInfo) {\n+    while (true) {\n+      PreviewRequest previewRequest = requestQueue.poll();\n+      if (previewRequest == null) {\n+        return Optional.empty();\n+      }\n+\n+      if (!isValid(previewRequest, waitTimeOut)) {\n+        LOG.warn(\"Preview request wth application id {} is timed out. Ignoring it.\",\n+                 previewRequest.getProgram().getParent());\n+        continue;\n+      }\n+\n+      try {\n+        Retries.callWithRetries((Retries.Callable<Void, Exception>) () -> {\n+          try {\n+            previewStore.setPreviewRequestPollerInfo(previewRequest.getProgram().getParent(), pollerInfo);\n+          } catch (ConflictException e) {\n+            LOG.debug(\"Preview application with id {} is not present in WAITING state. Ignoring the preview.\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55e408a619db5a883d9936dc88f194edd1b7f866"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU3MjE3Nw==", "bodyText": "Fixed.", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r459572177", "createdAt": "2020-07-23T16:21:47Z", "author": {"login": "sagarkapare"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/preview/DefaultPreviewRequestQueue.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.app.preview;\n+\n+import com.google.inject.Inject;\n+import io.cdap.cdap.app.preview.PreviewRequest;\n+import io.cdap.cdap.app.preview.PreviewRequestQueue;\n+import io.cdap.cdap.app.preview.PreviewRequestQueueState;\n+import io.cdap.cdap.app.store.preview.PreviewStore;\n+import io.cdap.cdap.common.ConflictException;\n+import io.cdap.cdap.common.app.RunIds;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.service.Retries;\n+import io.cdap.cdap.common.service.RetryStrategies;\n+import io.cdap.cdap.common.service.RetryStrategy;\n+import io.cdap.cdap.proto.id.ApplicationId;\n+import net.jcip.annotations.ThreadSafe;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Optional;\n+import java.util.concurrent.BlockingDeque;\n+import java.util.concurrent.LinkedBlockingDeque;\n+import java.util.concurrent.TimeUnit;\n+import java.util.function.Supplier;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Thread-safe implementation of {@link PreviewRequestQueue} backed by {@link PreviewStore}.\n+ */\n+@ThreadSafe\n+public class DefaultPreviewRequestQueue implements PreviewRequestQueue {\n+  private static final Logger LOG = LoggerFactory.getLogger(DefaultPreviewRequestQueue.class);\n+  private final PreviewStore previewStore;\n+  private final BlockingDeque<PreviewRequest> requestQueue;\n+  private final int capacity;\n+  private final long waitTimeOut;\n+  private final RetryStrategy retryStrategy;\n+\n+  @Inject\n+  public DefaultPreviewRequestQueue(CConfiguration cConf, PreviewStore previewStore) {\n+    this.previewStore = previewStore;\n+    this.capacity = cConf.getInt(Constants.Preview.WAITING_QUEUE_CAPACITY, 50);\n+    this.waitTimeOut = cConf.getLong(Constants.Preview.WAITING_QUEUE_TIMEOUT_SECONDS, 60);\n+    this.retryStrategy = RetryStrategies.fromConfiguration(cConf, \"system.preview.store.update.\");\n+    this.requestQueue = previewStore.getAllInWaitingState().stream()\n+      .filter(r -> isValid(r, waitTimeOut))\n+      .collect(Collectors.toCollection(() -> new LinkedBlockingDeque<>(capacity)));\n+  }\n+\n+  @Override\n+  public Optional<PreviewRequest> poll(byte[] pollerInfo) {\n+    while (true) {\n+      PreviewRequest previewRequest = requestQueue.poll();\n+      if (previewRequest == null) {\n+        return Optional.empty();\n+      }\n+\n+      if (!isValid(previewRequest, waitTimeOut)) {\n+        LOG.warn(\"Preview request wth application id {} is timed out. Ignoring it.\",\n+                 previewRequest.getProgram().getParent());\n+        continue;\n+      }\n+\n+      try {\n+        Retries.callWithRetries((Retries.Callable<Void, Exception>) () -> {\n+          try {\n+            previewStore.setPreviewRequestPollerInfo(previewRequest.getProgram().getParent(), pollerInfo);\n+          } catch (ConflictException e) {\n+            LOG.debug(\"Preview application with id {} is not present in WAITING state. Ignoring the preview.\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTMxOTE5MQ=="}, "originalCommit": {"oid": "55e408a619db5a883d9936dc88f194edd1b7f866"}, "originalPosition": 85}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2ODQ2NTU3OnYy", "diffSide": "RIGHT", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/PreviewRequestQueueState.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxODowMzozMFrOG2Vtfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxODozMzoyMFrOG2WvHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTYzMTk5OA==", "bodyText": "Use java.util.Objects instead.", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r459631998", "createdAt": "2020-07-23T18:03:30Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/PreviewRequestQueueState.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.app.preview;\n+\n+import com.google.common.base.Objects;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "773dd37a1e41df816c2243c3223e3fb4d2d2d1dd"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY0ODc5Ng==", "bodyText": "fixed.", "url": "https://github.com/cdapio/cdap/pull/12356#discussion_r459648796", "createdAt": "2020-07-23T18:33:20Z", "author": {"login": "sagarkapare"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/PreviewRequestQueueState.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.app.preview;\n+\n+import com.google.common.base.Objects;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTYzMTk5OA=="}, "originalCommit": {"oid": "773dd37a1e41df816c2243c3223e3fb4d2d2d1dd"}, "originalPosition": 19}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3289, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}