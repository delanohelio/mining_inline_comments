{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM1OTgwMjM4", "number": 12357, "title": "[CDAP-16891] Upgrading pipeline drafts", "bodyText": "JIRA: https://issues.cask.co/browse/CDAP-16891\nOpening an incompatible pipeline that's saved as draft would take users through the import workflow to fix any issues they have with their pipeline.", "createdAt": "2020-06-17T17:00:07Z", "url": "https://github.com/cdapio/cdap/pull/12357", "merged": true, "mergeCommit": {"oid": "24d6c863f0c1b8ac5997fe640cd48c2ab6c3c5f8"}, "closed": true, "closedAt": "2020-06-18T07:22:19Z", "author": {"login": "itsanudeep"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcsOLhEAFqTQzMjY2MzkyMw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcsW3jAABqjM0NTYzMTUyMTE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyNjYzOTIz", "url": "https://github.com/cdapio/cdap/pull/12357#pullrequestreview-432663923", "createdAt": "2020-06-17T18:26:27Z", "commit": {"oid": "34c09f1e06f6046813e22765ef650aa34337dcd8"}, "state": "COMMENTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxODoyNjoyN1rOGlR5Lg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxODoyOToyN1rOGlR_rA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc0MzY2Mg==", "bodyText": "nit: space after if. Aren't this being caught by linter? are you running gulp watch?", "url": "https://github.com/cdapio/cdap/pull/12357#discussion_r441743662", "createdAt": "2020-06-17T18:26:27Z", "author": {"login": "elfenheart"}, "path": "cdap-ui/app/hydrator/controllers/create/create-studio-ctrl.js", "diffHunk": "@@ -76,6 +76,9 @@ class HydratorPlusPlusStudioCtrl {\n       let config = {};\n       config.artifact = artifact;\n       HydratorPlusPlusConfigActions.initializeConfigStore(config);\n+      if(rConfig.upgrade){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34c09f1e06f6046813e22765ef650aa34337dcd8"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc0MzkxNw==", "bodyText": "nit space after bracket", "url": "https://github.com/cdapio/cdap/pull/12357#discussion_r441743917", "createdAt": "2020-06-17T18:26:55Z", "author": {"login": "elfenheart"}, "path": "cdap-ui/app/hydrator/routes.js", "diffHunk": "@@ -106,9 +106,9 @@ angular.module(PKG.name + '.feature.hydrator')\n                 if (isVersionInRange) {\n                   $stateParams.data.artifact.version = rCDAPVersion;\n                 } else {\n-                  defer.resolve(false);\n+                  defer.resolve({ valid: false });\n                 }\n-                defer.resolve($stateParams.data);\n+                defer.resolve({config: $stateParams.data, valid: true});", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34c09f1e06f6046813e22765ef650aa34337dcd8"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc0NDA4OQ==", "bodyText": "space after ()", "url": "https://github.com/cdapio/cdap/pull/12357#discussion_r441744089", "createdAt": "2020-06-17T18:27:14Z", "author": {"login": "elfenheart"}, "path": "cdap-ui/app/hydrator/services/hydrator-upgrade-service.js", "diffHunk": "@@ -287,6 +287,9 @@ class HydratorUpgradeService {\n       resolve: {\n         rPipelineConfig: function () {\n           return jsonData;\n+        },\n+        rIsImport: function(){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34c09f1e06f6046813e22765ef650aa34337dcd8"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc0NDI3NA==", "bodyText": "space after bracket", "url": "https://github.com/cdapio/cdap/pull/12357#discussion_r441744274", "createdAt": "2020-06-17T18:27:32Z", "author": {"login": "elfenheart"}, "path": "cdap-ui/app/hydrator/templates/create/pipeline-upgrade-modal.html", "diffHunk": "@@ -15,7 +15,8 @@\n -->\n \n <div class=\"modal-header\">\n-  <h3 class=\"modal-title pull-left\">Import Pipeline</h3>\n+  <h3 class=\"modal-title pull-left\" data-cy=\"upgrade-modal-header\">\n+    {{PipelineUpgradeController.isUpgrade ? \"Import Pipeline\" : \"Upgrade Pipeline\"}}</h3>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34c09f1e06f6046813e22765ef650aa34337dcd8"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc0NDMyMw==", "bodyText": "space after bracket", "url": "https://github.com/cdapio/cdap/pull/12357#discussion_r441744323", "createdAt": "2020-06-17T18:27:37Z", "author": {"login": "elfenheart"}, "path": "cdap-ui/app/hydrator/templates/create/pipeline-upgrade-modal.html", "diffHunk": "@@ -35,9 +37,10 @@ <h3 class=\"text-xs-center\">\n <div\n   class=\"modal-body\"\n   ng-if=\"!PipelineUpgradeController.loading\"\n+  data-cy=\"upgrade-modal-body\"\n >\n   <h4 ng-if=\"PipelineUpgradeController.missingArtifactStages.length > 0 || PipelineUpgradeController.problematicStages.length > 0 || PipelineUpgradeController.problematicPostRunActions.length > 0 || PipelineUpgradeController.missingArtifactPostRunActions.length > 0\">\n-    Your pipeline cannot be imported because of the following issues:\n+    {{PipelineUpgradeController.isUpgrade ? \"Your pipeline cannot be imported because of the following issues:\" : \"Your pipeline has the following issues:\"}}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34c09f1e06f6046813e22765ef650aa34337dcd8"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc0NDYwMA==", "bodyText": "space after bracket", "url": "https://github.com/cdapio/cdap/pull/12357#discussion_r441744600", "createdAt": "2020-06-17T18:28:04Z", "author": {"login": "elfenheart"}, "path": "cdap-ui/cypress/helpers.ts", "diffHunk": "@@ -117,4 +119,22 @@ function deployAndTestPipeline(filename, pipelineName, done) {\n     .then(() => done());\n }\n \n-export { loginIfRequired, getArtifactsPoll, deployAndTestPipeline, getSessionToken };\n+function dataCy(property) {\n+  return `[data-cy=\"${property}\"]`;\n+}\n+\n+function generateDraftFromPipeline(pipeline) {\n+  return cy.fixture(pipeline).then(pipeline1 => {\n+    const draftId = uuidV4();\n+    const pipelineName = `${pipeline1.name}-${Date.now()}`;\n+    pipeline1['__ui__'] = {draftId, lastSaved: '2019-06-10T16:57:34.559Z'};", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34c09f1e06f6046813e22765ef650aa34337dcd8"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc0NDY0Nw==", "bodyText": "remove", "url": "https://github.com/cdapio/cdap/pull/12357#discussion_r441744647", "createdAt": "2020-06-17T18:28:11Z", "author": {"login": "elfenheart"}, "path": "cdap-ui/cypress/helpers.ts", "diffHunk": "@@ -117,4 +119,22 @@ function deployAndTestPipeline(filename, pipelineName, done) {\n     .then(() => done());\n }\n \n-export { loginIfRequired, getArtifactsPoll, deployAndTestPipeline, getSessionToken };\n+function dataCy(property) {\n+  return `[data-cy=\"${property}\"]`;\n+}\n+\n+function generateDraftFromPipeline(pipeline) {\n+  return cy.fixture(pipeline).then(pipeline1 => {\n+    const draftId = uuidV4();\n+    const pipelineName = `${pipeline1.name}-${Date.now()}`;\n+    pipeline1['__ui__'] = {draftId, lastSaved: '2019-06-10T16:57:34.559Z'};\n+    pipeline1.name = pipelineName;\n+    const pipelineDraft = {\n+      'hydratorDrafts': {'default': {[draftId]: pipeline1}}\n+    };\n+    console.log(\"draftid\",pipeline1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34c09f1e06f6046813e22765ef650aa34337dcd8"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc0NDc2MA==", "bodyText": "unnecessary quotes", "url": "https://github.com/cdapio/cdap/pull/12357#discussion_r441744760", "createdAt": "2020-06-17T18:28:25Z", "author": {"login": "elfenheart"}, "path": "cdap-ui/cypress/helpers.ts", "diffHunk": "@@ -117,4 +119,22 @@ function deployAndTestPipeline(filename, pipelineName, done) {\n     .then(() => done());\n }\n \n-export { loginIfRequired, getArtifactsPoll, deployAndTestPipeline, getSessionToken };\n+function dataCy(property) {\n+  return `[data-cy=\"${property}\"]`;\n+}\n+\n+function generateDraftFromPipeline(pipeline) {\n+  return cy.fixture(pipeline).then(pipeline1 => {\n+    const draftId = uuidV4();\n+    const pipelineName = `${pipeline1.name}-${Date.now()}`;\n+    pipeline1['__ui__'] = {draftId, lastSaved: '2019-06-10T16:57:34.559Z'};\n+    pipeline1.name = pipelineName;\n+    const pipelineDraft = {\n+      'hydratorDrafts': {'default': {[draftId]: pipeline1}}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34c09f1e06f6046813e22765ef650aa34337dcd8"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc0NTA0MA==", "bodyText": "lastSaved Date.now()", "url": "https://github.com/cdapio/cdap/pull/12357#discussion_r441745040", "createdAt": "2020-06-17T18:28:56Z", "author": {"login": "elfenheart"}, "path": "cdap-ui/cypress/helpers.ts", "diffHunk": "@@ -117,4 +119,22 @@ function deployAndTestPipeline(filename, pipelineName, done) {\n     .then(() => done());\n }\n \n-export { loginIfRequired, getArtifactsPoll, deployAndTestPipeline, getSessionToken };\n+function dataCy(property) {\n+  return `[data-cy=\"${property}\"]`;\n+}\n+\n+function generateDraftFromPipeline(pipeline) {\n+  return cy.fixture(pipeline).then(pipeline1 => {\n+    const draftId = uuidV4();\n+    const pipelineName = `${pipeline1.name}-${Date.now()}`;\n+    pipeline1['__ui__'] = {draftId, lastSaved: '2019-06-10T16:57:34.559Z'};", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc0NDYwMA=="}, "originalCommit": {"oid": "34c09f1e06f6046813e22765ef650aa34337dcd8"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc0NTIyMA==", "bodyText": "make quotes consistent with single quotes", "url": "https://github.com/cdapio/cdap/pull/12357#discussion_r441745220", "createdAt": "2020-06-17T18:29:17Z", "author": {"login": "elfenheart"}, "path": "cdap-ui/cypress/integration/pipeline.upgrade.spec.ts", "diffHunk": "@@ -70,4 +72,25 @@ describe('Pipeline Upgrade should work fine', () => {\n       cy.contains('Hub');\n     });\n   });\n+\n+  it(\"should upgrade pipelines that are saved in drafts\", () => {\n+\n+    generateDraftFromPipeline('pipeline1.json').then(({ pipelineDraft, pipelineName }) => {\n+      cy.upload_draft_via_api(headers, pipelineDraft);\n+      cy.visit(\"/cdap/ns/default/pipelines/drafts\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34c09f1e06f6046813e22765ef650aa34337dcd8"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc0NTMyNA==", "bodyText": "space after brackets", "url": "https://github.com/cdapio/cdap/pull/12357#discussion_r441745324", "createdAt": "2020-06-17T18:29:27Z", "author": {"login": "elfenheart"}, "path": "cdap-ui/cypress/integration/pipeline.upgrade.spec.ts", "diffHunk": "@@ -15,6 +15,8 @@\n  */\n \n import * as Helpers from '../helpers';\n+import {dataCy, generateDraftFromPipeline} from '../helpers';", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34c09f1e06f6046813e22765ef650aa34337dcd8"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyNzkwNzI2", "url": "https://github.com/cdapio/cdap/pull/12357#pullrequestreview-432790726", "createdAt": "2020-06-17T21:30:05Z", "commit": {"oid": "06344c9f48992a42a59ab71f0af7990647d6db09"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QyMTozMDowNlrOGlYGlg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QyMTozMDowNlrOGlYGlg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg0NTM5OA==", "bodyText": "not sure why my comment disappeared on this one..\nWhy is valid: false in here? what is considered valid? If you already have a flag for upgrade, can we just simply use that instead of adding another flag?", "url": "https://github.com/cdapio/cdap/pull/12357#discussion_r441845398", "createdAt": "2020-06-17T21:30:06Z", "author": {"login": "elfenheart"}, "path": "cdap-ui/app/hydrator/routes.js", "diffHunk": "@@ -125,52 +128,52 @@ angular.module(PKG.name + '.feature.hydrator')\n                       if (isVersionInRange) {\n                         draft.artifact.version = rCDAPVersion;\n                       } else {\n-                        defer.resolve(false);\n+                        defer.resolve({ valid: false, config: draft, upgrade: true });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06344c9f48992a42a59ab71f0af7990647d6db09"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyODYyMzI5", "url": "https://github.com/cdapio/cdap/pull/12357#pullrequestreview-432862329", "createdAt": "2020-06-18T00:28:31Z", "commit": {"oid": "06344c9f48992a42a59ab71f0af7990647d6db09"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwMDoyODozMVrOGlbp-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwMDoyODozMVrOGlbp-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTkwMzYwOA==", "bodyText": "why do we only want to delete this on import?", "url": "https://github.com/cdapio/cdap/pull/12357#discussion_r441903608", "createdAt": "2020-06-18T00:28:31Z", "author": {"login": "elfenheart"}, "path": "cdap-ui/app/hydrator/controllers/create/partials/pipelineupgrade-modal-ctrl.js", "diffHunk": "@@ -147,7 +148,7 @@ angular.module(PKG.name + '.feature.hydrator')\n       newConfig.config.stages = stages;\n       newConfig.config.postActions = postActions;\n \n-      if (newConfig.__ui__) {\n+      if (newConfig.__ui__ && this.isImport) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06344c9f48992a42a59ab71f0af7990647d6db09"}, "originalPosition": 22}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "06344c9f48992a42a59ab71f0af7990647d6db09", "author": {"user": {"login": "itsanudeep", "name": "Anudeep Katragadda"}}, "url": "https://github.com/cdapio/cdap/commit/06344c9f48992a42a59ab71f0af7990647d6db09", "committedDate": "2020-06-17T21:11:34Z", "message": "new draft for pipeline"}, "afterCommit": {"oid": "0cbfbe39ccf52f22ad9c10cb2d29168ae4979921", "author": {"user": {"login": "itsanudeep", "name": "Anudeep Katragadda"}}, "url": "https://github.com/cdapio/cdap/commit/0cbfbe39ccf52f22ad9c10cb2d29168ae4979921", "committedDate": "2020-06-18T00:35:28Z", "message": "rebasing and modal title change"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyOTI3MzIz", "url": "https://github.com/cdapio/cdap/pull/12357#pullrequestreview-432927323", "createdAt": "2020-06-18T04:09:48Z", "commit": {"oid": "21a133877d15f4d682d529185b5c2f19fc7a0d37"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyOTMzNDUy", "url": "https://github.com/cdapio/cdap/pull/12357#pullrequestreview-432933452", "createdAt": "2020-06-18T04:32:19Z", "commit": {"oid": "21a133877d15f4d682d529185b5c2f19fc7a0d37"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "098e40b3702bc2ee26c8145294c8eddbcf54a133", "author": {"user": {"login": "itsanudeep", "name": "Anudeep Katragadda"}}, "url": "https://github.com/cdapio/cdap/commit/098e40b3702bc2ee26c8145294c8eddbcf54a133", "committedDate": "2020-06-18T04:36:58Z", "message": "upgrading drafts"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "21a133877d15f4d682d529185b5c2f19fc7a0d37", "author": {"user": {"login": "itsanudeep", "name": "Anudeep Katragadda"}}, "url": "https://github.com/cdapio/cdap/commit/21a133877d15f4d682d529185b5c2f19fc7a0d37", "committedDate": "2020-06-18T03:02:13Z", "message": "close runtime arguments modal after saving the args"}, "afterCommit": {"oid": "098e40b3702bc2ee26c8145294c8eddbcf54a133", "author": {"user": {"login": "itsanudeep", "name": "Anudeep Katragadda"}}, "url": "https://github.com/cdapio/cdap/commit/098e40b3702bc2ee26c8145294c8eddbcf54a133", "committedDate": "2020-06-18T04:36:58Z", "message": "upgrading drafts"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1898, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}