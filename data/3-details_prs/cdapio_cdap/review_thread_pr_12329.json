{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM0NzgxODkz", "number": 12329, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQyMDo1MzoxNVrOEFsVCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwNTowMjoxNFrOEFyEQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0NDA0NjE5OnYy", "diffSide": "RIGHT", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/gateway/handlers/AppLifecycleHttpHandler.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQyMDo1MzoxNVrOGkCWRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQyMTowMjoyMFrOGkCo3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ0MDM4OQ==", "bodyText": "Why not just the List to deserialize?", "url": "https://github.com/cdapio/cdap/pull/12329#discussion_r440440389", "createdAt": "2020-06-15T20:53:15Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/gateway/handlers/AppLifecycleHttpHandler.java", "diffHunk": "@@ -542,6 +542,41 @@ public void getApplicationDetails(FullHttpRequest request, HttpResponder respond\n     }\n   }\n \n+    /**\n+   * Decodes request coming from the {@link #upgradeApplications(FullHttpRequest, HttpResponder, String, Set, boolean)} call.\n+   */\n+  private List<ApplicationId> decodeAndValidateBatchApplicationRecord(NamespaceId namespaceId,\n+                                                                      FullHttpRequest request)\n+    throws BadRequestException {\n+    try {\n+      List<ApplicationId> result = new ArrayList<>();\n+      JsonArray array = DECODE_GSON.fromJson(request.content().toString(StandardCharsets.UTF_8), JsonArray.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94620832a799a1b16e4a62b3a265eb0e457a4f24"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ0NTE1MQ==", "bodyText": "i mean List<ApplicationRecord>", "url": "https://github.com/cdapio/cdap/pull/12329#discussion_r440445151", "createdAt": "2020-06-15T21:02:20Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/gateway/handlers/AppLifecycleHttpHandler.java", "diffHunk": "@@ -542,6 +542,41 @@ public void getApplicationDetails(FullHttpRequest request, HttpResponder respond\n     }\n   }\n \n+    /**\n+   * Decodes request coming from the {@link #upgradeApplications(FullHttpRequest, HttpResponder, String, Set, boolean)} call.\n+   */\n+  private List<ApplicationId> decodeAndValidateBatchApplicationRecord(NamespaceId namespaceId,\n+                                                                      FullHttpRequest request)\n+    throws BadRequestException {\n+    try {\n+      List<ApplicationId> result = new ArrayList<>();\n+      JsonArray array = DECODE_GSON.fromJson(request.content().toString(StandardCharsets.UTF_8), JsonArray.class);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ0MDM4OQ=="}, "originalCommit": {"oid": "94620832a799a1b16e4a62b3a265eb0e457a4f24"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0NDk4MzY1OnYy", "diffSide": "RIGHT", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/gateway/handlers/AppLifecycleHttpHandler.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwNTowMDozNVrOGkLSzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwNToxNDo0MFrOGkLhFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU4Njk1OA==", "bodyText": "Why not just pass e to ApplicationUpdateDetail directly?", "url": "https://github.com/cdapio/cdap/pull/12329#discussion_r440586958", "createdAt": "2020-06-16T05:00:35Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/gateway/handlers/AppLifecycleHttpHandler.java", "diffHunk": "@@ -448,20 +449,21 @@ public void upgradeApplications(FullHttpRequest request, HttpResponder responder\n     // TODO: (CDAP-16910) Improve batch API performance as each application upgrade is an event independent of each\n     //  other.\n \n-    List<ApplicationId> appIds = decodeAndValidateBatchApplication(validateNamespace(namespaceId), request);\n+    List<ApplicationId> appIds = decodeAndValidateBatchApplicationRecord(validateNamespace(namespaceId), request);\n     Set<ArtifactScope> allowedArtifactScopes = getArtifactScopes(artifactScopes);\n     List<ApplicationUpdateDetail> details = new ArrayList<>();\n     for (ApplicationId appId : appIds) {\n       ApplicationUpdateDetail updateDetail;\n       try {\n-        applicationLifecycleService.upgradeApplication(appId, createProgramTerminator(), allowedArtifactScopes,\n-                                                       allowSnapshot);\n-        updateDetail = new ApplicationUpdateDetail(appId, \"upgrade successful.\");\n+        applicationLifecycleService.upgradeApplication(appId, allowedArtifactScopes, allowSnapshot);\n+        updateDetail = new ApplicationUpdateDetail(appId);\n       } catch (UnsupportedOperationException e) {\n         String errorMessage = String.format(\"Application %s does not support upgrade.\", appId);\n-        updateDetail = new ApplicationUpdateDetail(appId, errorMessage);\n-      } catch (InvalidArtifactException | NotFoundException e) {\n-        updateDetail = new ApplicationUpdateDetail(appId, e.getMessage());\n+        updateDetail = new ApplicationUpdateDetail(appId, new NotImplementedException(errorMessage));\n+      } catch (NotFoundException e) {\n+        updateDetail = new ApplicationUpdateDetail(appId, new NotFoundException(appId));\n+      } catch (InvalidArtifactException e) {\n+        updateDetail = new ApplicationUpdateDetail(appId, new InvalidArtifactException(e.getMessage()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "70e31c1628dbb5204526bd8719b6f1cd1940fd31"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU5MDYxNQ==", "bodyText": "aah.. I was trying something else then didnt change this back. Thanks for noticing.", "url": "https://github.com/cdapio/cdap/pull/12329#discussion_r440590615", "createdAt": "2020-06-16T05:14:40Z", "author": {"login": "pandyajay10"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/gateway/handlers/AppLifecycleHttpHandler.java", "diffHunk": "@@ -448,20 +449,21 @@ public void upgradeApplications(FullHttpRequest request, HttpResponder responder\n     // TODO: (CDAP-16910) Improve batch API performance as each application upgrade is an event independent of each\n     //  other.\n \n-    List<ApplicationId> appIds = decodeAndValidateBatchApplication(validateNamespace(namespaceId), request);\n+    List<ApplicationId> appIds = decodeAndValidateBatchApplicationRecord(validateNamespace(namespaceId), request);\n     Set<ArtifactScope> allowedArtifactScopes = getArtifactScopes(artifactScopes);\n     List<ApplicationUpdateDetail> details = new ArrayList<>();\n     for (ApplicationId appId : appIds) {\n       ApplicationUpdateDetail updateDetail;\n       try {\n-        applicationLifecycleService.upgradeApplication(appId, createProgramTerminator(), allowedArtifactScopes,\n-                                                       allowSnapshot);\n-        updateDetail = new ApplicationUpdateDetail(appId, \"upgrade successful.\");\n+        applicationLifecycleService.upgradeApplication(appId, allowedArtifactScopes, allowSnapshot);\n+        updateDetail = new ApplicationUpdateDetail(appId);\n       } catch (UnsupportedOperationException e) {\n         String errorMessage = String.format(\"Application %s does not support upgrade.\", appId);\n-        updateDetail = new ApplicationUpdateDetail(appId, errorMessage);\n-      } catch (InvalidArtifactException | NotFoundException e) {\n-        updateDetail = new ApplicationUpdateDetail(appId, e.getMessage());\n+        updateDetail = new ApplicationUpdateDetail(appId, new NotImplementedException(errorMessage));\n+      } catch (NotFoundException e) {\n+        updateDetail = new ApplicationUpdateDetail(appId, new NotFoundException(appId));\n+      } catch (InvalidArtifactException e) {\n+        updateDetail = new ApplicationUpdateDetail(appId, new InvalidArtifactException(e.getMessage()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU4Njk1OA=="}, "originalCommit": {"oid": "70e31c1628dbb5204526bd8719b6f1cd1940fd31"}, "originalPosition": 66}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0NDk4NDA3OnYy", "diffSide": "RIGHT", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/gateway/handlers/AppLifecycleHttpHandler.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwNTowMDo1MVrOGkLTEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwNToxNDo1NFrOGkLhTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU4NzAyNQ==", "bodyText": "Can you just pass in e?", "url": "https://github.com/cdapio/cdap/pull/12329#discussion_r440587025", "createdAt": "2020-06-16T05:00:51Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/gateway/handlers/AppLifecycleHttpHandler.java", "diffHunk": "@@ -448,20 +449,21 @@ public void upgradeApplications(FullHttpRequest request, HttpResponder responder\n     // TODO: (CDAP-16910) Improve batch API performance as each application upgrade is an event independent of each\n     //  other.\n \n-    List<ApplicationId> appIds = decodeAndValidateBatchApplication(validateNamespace(namespaceId), request);\n+    List<ApplicationId> appIds = decodeAndValidateBatchApplicationRecord(validateNamespace(namespaceId), request);\n     Set<ArtifactScope> allowedArtifactScopes = getArtifactScopes(artifactScopes);\n     List<ApplicationUpdateDetail> details = new ArrayList<>();\n     for (ApplicationId appId : appIds) {\n       ApplicationUpdateDetail updateDetail;\n       try {\n-        applicationLifecycleService.upgradeApplication(appId, createProgramTerminator(), allowedArtifactScopes,\n-                                                       allowSnapshot);\n-        updateDetail = new ApplicationUpdateDetail(appId, \"upgrade successful.\");\n+        applicationLifecycleService.upgradeApplication(appId, allowedArtifactScopes, allowSnapshot);\n+        updateDetail = new ApplicationUpdateDetail(appId);\n       } catch (UnsupportedOperationException e) {\n         String errorMessage = String.format(\"Application %s does not support upgrade.\", appId);\n-        updateDetail = new ApplicationUpdateDetail(appId, errorMessage);\n-      } catch (InvalidArtifactException | NotFoundException e) {\n-        updateDetail = new ApplicationUpdateDetail(appId, e.getMessage());\n+        updateDetail = new ApplicationUpdateDetail(appId, new NotImplementedException(errorMessage));\n+      } catch (NotFoundException e) {\n+        updateDetail = new ApplicationUpdateDetail(appId, new NotFoundException(appId));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "70e31c1628dbb5204526bd8719b6f1cd1940fd31"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU5MDY3MQ==", "bodyText": "aah.. I was trying something else forgot to change this back. Thanks for noticing.", "url": "https://github.com/cdapio/cdap/pull/12329#discussion_r440590671", "createdAt": "2020-06-16T05:14:54Z", "author": {"login": "pandyajay10"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/gateway/handlers/AppLifecycleHttpHandler.java", "diffHunk": "@@ -448,20 +449,21 @@ public void upgradeApplications(FullHttpRequest request, HttpResponder responder\n     // TODO: (CDAP-16910) Improve batch API performance as each application upgrade is an event independent of each\n     //  other.\n \n-    List<ApplicationId> appIds = decodeAndValidateBatchApplication(validateNamespace(namespaceId), request);\n+    List<ApplicationId> appIds = decodeAndValidateBatchApplicationRecord(validateNamespace(namespaceId), request);\n     Set<ArtifactScope> allowedArtifactScopes = getArtifactScopes(artifactScopes);\n     List<ApplicationUpdateDetail> details = new ArrayList<>();\n     for (ApplicationId appId : appIds) {\n       ApplicationUpdateDetail updateDetail;\n       try {\n-        applicationLifecycleService.upgradeApplication(appId, createProgramTerminator(), allowedArtifactScopes,\n-                                                       allowSnapshot);\n-        updateDetail = new ApplicationUpdateDetail(appId, \"upgrade successful.\");\n+        applicationLifecycleService.upgradeApplication(appId, allowedArtifactScopes, allowSnapshot);\n+        updateDetail = new ApplicationUpdateDetail(appId);\n       } catch (UnsupportedOperationException e) {\n         String errorMessage = String.format(\"Application %s does not support upgrade.\", appId);\n-        updateDetail = new ApplicationUpdateDetail(appId, errorMessage);\n-      } catch (InvalidArtifactException | NotFoundException e) {\n-        updateDetail = new ApplicationUpdateDetail(appId, e.getMessage());\n+        updateDetail = new ApplicationUpdateDetail(appId, new NotImplementedException(errorMessage));\n+      } catch (NotFoundException e) {\n+        updateDetail = new ApplicationUpdateDetail(appId, new NotFoundException(appId));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU4NzAyNQ=="}, "originalCommit": {"oid": "70e31c1628dbb5204526bd8719b6f1cd1940fd31"}, "originalPosition": 64}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0NDk4NjI3OnYy", "diffSide": "RIGHT", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/services/ApplicationLifecycleService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwNTowMjoxNFrOGkLUXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwNToxNjoxMlrOGkLimQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU4NzM1OQ==", "bodyText": "Shall we just remove the terminator in the updateApplicationInternal method? Is it still needed?", "url": "https://github.com/cdapio/cdap/pull/12329#discussion_r440587359", "createdAt": "2020-06-16T05:02:14Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/services/ApplicationLifecycleService.java", "diffHunk": "@@ -509,7 +506,7 @@ public void upgradeApplication(ApplicationId appId, ProgramTerminator programTer\n     Id.Artifact newArtifact = Id.Artifact.fromEntityId(Artifacts.toProtoArtifactId(appId.getParent(), newArtifactId));\n     ArtifactDetail newArtifactDetail = artifactRepository.getArtifact(newArtifact);\n \n-    updateApplicationInternal(appId, currentSpec.getConfiguration(), programTerminator, newArtifactDetail,\n+    updateApplicationInternal(appId, currentSpec.getConfiguration(), programId -> { }, newArtifactDetail,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "70e31c1628dbb5204526bd8719b6f1cd1940fd31"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU5MTAwMQ==", "bodyText": "I kept it so that any \"update\" usage in future can use it for their purpose. For upgrade, we dont want to terminate jobs but may be for other kind \"updates\" we might want to so I kept it for now (also it is similar to current \"Update\" API which updates config in place).", "url": "https://github.com/cdapio/cdap/pull/12329#discussion_r440591001", "createdAt": "2020-06-16T05:16:12Z", "author": {"login": "pandyajay10"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/services/ApplicationLifecycleService.java", "diffHunk": "@@ -509,7 +506,7 @@ public void upgradeApplication(ApplicationId appId, ProgramTerminator programTer\n     Id.Artifact newArtifact = Id.Artifact.fromEntityId(Artifacts.toProtoArtifactId(appId.getParent(), newArtifactId));\n     ArtifactDetail newArtifactDetail = artifactRepository.getArtifact(newArtifact);\n \n-    updateApplicationInternal(appId, currentSpec.getConfiguration(), programTerminator, newArtifactDetail,\n+    updateApplicationInternal(appId, currentSpec.getConfiguration(), programId -> { }, newArtifactDetail,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU4NzM1OQ=="}, "originalCommit": {"oid": "70e31c1628dbb5204526bd8719b6f1cd1940fd31"}, "originalPosition": 24}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3403, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}