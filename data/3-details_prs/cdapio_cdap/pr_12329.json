{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM0NzgxODkz", "number": 12329, "title": "[CDAP-16835] Change Batch Upgrade REST API to take in list of ApplicationRecords", "bodyText": "Changes included in this PR:\n\n\nChange Upgrade REST API to take in list of Record similar to ApplicationRecord class. The usecase would be that, users would just be calling /namespace//apps API to get all apps in a namespace and than upgrade them using the same response from /apps API.\n\n\nHot fix for bug CDAP-16984 related to UI for not being able to show Joiner properties if label tag is not there. For now, adding back \"label\" tag. In future, once UI fixes this issue, we can remove it.\n\n\nDo not stop pipeline during upgrade.\n\n\nFix status codes and error messages for failures during upgrade.\n\n\nhttps://builds.cask.co/browse/CDAP-DUT7247", "createdAt": "2020-06-15T20:50:42Z", "url": "https://github.com/cdapio/cdap/pull/12329", "merged": true, "mergeCommit": {"oid": "fed2bff1c5e78023eb0a0167f269b34073902cc7"}, "closed": true, "closedAt": "2020-06-16T06:30:51Z", "author": {"login": "pandyajay10"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcrnB8ngFqTQzMDk4NTE1Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcruyvigBqjM0NDczMzA3NjE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwOTg1MTUy", "url": "https://github.com/cdapio/cdap/pull/12329#pullrequestreview-430985152", "createdAt": "2020-06-15T20:53:14Z", "commit": {"oid": "94620832a799a1b16e4a62b3a265eb0e457a4f24"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQyMDo1MzoxNVrOGkCWRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQyMDo1MzoxNVrOGkCWRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ0MDM4OQ==", "bodyText": "Why not just the List to deserialize?", "url": "https://github.com/cdapio/cdap/pull/12329#discussion_r440440389", "createdAt": "2020-06-15T20:53:15Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/gateway/handlers/AppLifecycleHttpHandler.java", "diffHunk": "@@ -542,6 +542,41 @@ public void getApplicationDetails(FullHttpRequest request, HttpResponder respond\n     }\n   }\n \n+    /**\n+   * Decodes request coming from the {@link #upgradeApplications(FullHttpRequest, HttpResponder, String, Set, boolean)} call.\n+   */\n+  private List<ApplicationId> decodeAndValidateBatchApplicationRecord(NamespaceId namespaceId,\n+                                                                      FullHttpRequest request)\n+    throws BadRequestException {\n+    try {\n+      List<ApplicationId> result = new ArrayList<>();\n+      JsonArray array = DECODE_GSON.fromJson(request.content().toString(StandardCharsets.UTF_8), JsonArray.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94620832a799a1b16e4a62b3a265eb0e457a4f24"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxMTYwNDY4", "url": "https://github.com/cdapio/cdap/pull/12329#pullrequestreview-431160468", "createdAt": "2020-06-16T05:00:35Z", "commit": {"oid": "70e31c1628dbb5204526bd8719b6f1cd1940fd31"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwNTowMDozNVrOGkLSzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwNTowMjoxNFrOGkLUXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU4Njk1OA==", "bodyText": "Why not just pass e to ApplicationUpdateDetail directly?", "url": "https://github.com/cdapio/cdap/pull/12329#discussion_r440586958", "createdAt": "2020-06-16T05:00:35Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/gateway/handlers/AppLifecycleHttpHandler.java", "diffHunk": "@@ -448,20 +449,21 @@ public void upgradeApplications(FullHttpRequest request, HttpResponder responder\n     // TODO: (CDAP-16910) Improve batch API performance as each application upgrade is an event independent of each\n     //  other.\n \n-    List<ApplicationId> appIds = decodeAndValidateBatchApplication(validateNamespace(namespaceId), request);\n+    List<ApplicationId> appIds = decodeAndValidateBatchApplicationRecord(validateNamespace(namespaceId), request);\n     Set<ArtifactScope> allowedArtifactScopes = getArtifactScopes(artifactScopes);\n     List<ApplicationUpdateDetail> details = new ArrayList<>();\n     for (ApplicationId appId : appIds) {\n       ApplicationUpdateDetail updateDetail;\n       try {\n-        applicationLifecycleService.upgradeApplication(appId, createProgramTerminator(), allowedArtifactScopes,\n-                                                       allowSnapshot);\n-        updateDetail = new ApplicationUpdateDetail(appId, \"upgrade successful.\");\n+        applicationLifecycleService.upgradeApplication(appId, allowedArtifactScopes, allowSnapshot);\n+        updateDetail = new ApplicationUpdateDetail(appId);\n       } catch (UnsupportedOperationException e) {\n         String errorMessage = String.format(\"Application %s does not support upgrade.\", appId);\n-        updateDetail = new ApplicationUpdateDetail(appId, errorMessage);\n-      } catch (InvalidArtifactException | NotFoundException e) {\n-        updateDetail = new ApplicationUpdateDetail(appId, e.getMessage());\n+        updateDetail = new ApplicationUpdateDetail(appId, new NotImplementedException(errorMessage));\n+      } catch (NotFoundException e) {\n+        updateDetail = new ApplicationUpdateDetail(appId, new NotFoundException(appId));\n+      } catch (InvalidArtifactException e) {\n+        updateDetail = new ApplicationUpdateDetail(appId, new InvalidArtifactException(e.getMessage()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "70e31c1628dbb5204526bd8719b6f1cd1940fd31"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU4NzAyNQ==", "bodyText": "Can you just pass in e?", "url": "https://github.com/cdapio/cdap/pull/12329#discussion_r440587025", "createdAt": "2020-06-16T05:00:51Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/gateway/handlers/AppLifecycleHttpHandler.java", "diffHunk": "@@ -448,20 +449,21 @@ public void upgradeApplications(FullHttpRequest request, HttpResponder responder\n     // TODO: (CDAP-16910) Improve batch API performance as each application upgrade is an event independent of each\n     //  other.\n \n-    List<ApplicationId> appIds = decodeAndValidateBatchApplication(validateNamespace(namespaceId), request);\n+    List<ApplicationId> appIds = decodeAndValidateBatchApplicationRecord(validateNamespace(namespaceId), request);\n     Set<ArtifactScope> allowedArtifactScopes = getArtifactScopes(artifactScopes);\n     List<ApplicationUpdateDetail> details = new ArrayList<>();\n     for (ApplicationId appId : appIds) {\n       ApplicationUpdateDetail updateDetail;\n       try {\n-        applicationLifecycleService.upgradeApplication(appId, createProgramTerminator(), allowedArtifactScopes,\n-                                                       allowSnapshot);\n-        updateDetail = new ApplicationUpdateDetail(appId, \"upgrade successful.\");\n+        applicationLifecycleService.upgradeApplication(appId, allowedArtifactScopes, allowSnapshot);\n+        updateDetail = new ApplicationUpdateDetail(appId);\n       } catch (UnsupportedOperationException e) {\n         String errorMessage = String.format(\"Application %s does not support upgrade.\", appId);\n-        updateDetail = new ApplicationUpdateDetail(appId, errorMessage);\n-      } catch (InvalidArtifactException | NotFoundException e) {\n-        updateDetail = new ApplicationUpdateDetail(appId, e.getMessage());\n+        updateDetail = new ApplicationUpdateDetail(appId, new NotImplementedException(errorMessage));\n+      } catch (NotFoundException e) {\n+        updateDetail = new ApplicationUpdateDetail(appId, new NotFoundException(appId));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "70e31c1628dbb5204526bd8719b6f1cd1940fd31"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU4NzM1OQ==", "bodyText": "Shall we just remove the terminator in the updateApplicationInternal method? Is it still needed?", "url": "https://github.com/cdapio/cdap/pull/12329#discussion_r440587359", "createdAt": "2020-06-16T05:02:14Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/services/ApplicationLifecycleService.java", "diffHunk": "@@ -509,7 +506,7 @@ public void upgradeApplication(ApplicationId appId, ProgramTerminator programTer\n     Id.Artifact newArtifact = Id.Artifact.fromEntityId(Artifacts.toProtoArtifactId(appId.getParent(), newArtifactId));\n     ArtifactDetail newArtifactDetail = artifactRepository.getArtifact(newArtifact);\n \n-    updateApplicationInternal(appId, currentSpec.getConfiguration(), programTerminator, newArtifactDetail,\n+    updateApplicationInternal(appId, currentSpec.getConfiguration(), programId -> { }, newArtifactDetail,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "70e31c1628dbb5204526bd8719b6f1cd1940fd31"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxMTc3ODI3", "url": "https://github.com/cdapio/cdap/pull/12329#pullrequestreview-431177827", "createdAt": "2020-06-16T05:50:57Z", "commit": {"oid": "83d3c3b8f58cf6b26d507b071fea2ac716484acd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b88e3c9fc798d0076076567a055f7eef4a249bc", "author": {"user": null}, "url": "https://github.com/cdapio/cdap/commit/6b88e3c9fc798d0076076567a055f7eef4a249bc", "committedDate": "2020-06-16T05:54:20Z", "message": "Change Batch Upgrade REST API to take in list of ApplicationRecords.\nChange ApplicationUpdateDetail API. Change error code for upgrade response. Introduce \"label\" in ETLStage for compatibility."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "83d3c3b8f58cf6b26d507b071fea2ac716484acd", "author": {"user": null}, "url": "https://github.com/cdapio/cdap/commit/83d3c3b8f58cf6b26d507b071fea2ac716484acd", "committedDate": "2020-06-16T05:16:35Z", "message": "Fixing checkstyle 2"}, "afterCommit": {"oid": "6b88e3c9fc798d0076076567a055f7eef4a249bc", "author": {"user": null}, "url": "https://github.com/cdapio/cdap/commit/6b88e3c9fc798d0076076567a055f7eef4a249bc", "committedDate": "2020-06-16T05:54:20Z", "message": "Change Batch Upgrade REST API to take in list of ApplicationRecords.\nChange ApplicationUpdateDetail API. Change error code for upgrade response. Introduce \"label\" in ETLStage for compatibility."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2025, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}