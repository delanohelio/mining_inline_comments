{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI3MzczMDA0", "number": 12250, "title": "[CDAP-16873] Add metrics writer module ", "bodyText": "", "createdAt": "2020-06-03T18:17:52Z", "url": "https://github.com/cdapio/cdap/pull/12250", "merged": true, "mergeCommit": {"oid": "7d5fc491fa095f8febe68abe867622832f9cafe3"}, "closed": true, "closedAt": "2020-06-12T03:21:36Z", "author": {"login": "rmstar"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpZRrngFqTQyNjY5Mjg0Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcqYYbHABqjM0MzY1MzIzMjQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2NjkyODQ3", "url": "https://github.com/cdapio/cdap/pull/12250#pullrequestreview-426692847", "createdAt": "2020-06-08T23:40:03Z", "commit": {"oid": "720d59598f1b84d5aba1b55ef91f25e97ac0828f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQyMzo0MDowM1rOGgz8wQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQyMzo0MDowM1rOGgz8wQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA1ODc1Mw==", "bodyText": "When the MetricsWriter.initialize will be called? I would suggest called them in the startUp method of this service (including the default one, the call should move there).", "url": "https://github.com/cdapio/cdap/pull/12250#discussion_r437058753", "createdAt": "2020-06-08T23:40:03Z", "author": {"login": "chtyim"}, "path": "cdap-watchdog/src/main/java/io/cdap/cdap/metrics/process/MessagingMetricsProcessorManagerService.java", "diffHunk": "@@ -74,6 +79,10 @@\n     metricsWriter.initialize(metricsContext);\n     this.metricsWriters.add(metricsWriter);\n \n+    for (Map.Entry<String, MetricsWriter> metricsWriterEntry : metricsWriterProvider.loadMetricsWriters().entrySet()) {\n+      this.metricsWriters.add(metricsWriterEntry.getValue());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "720d59598f1b84d5aba1b55ef91f25e97ac0828f"}, "originalPosition": 46}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4NDY4MTY1", "url": "https://github.com/cdapio/cdap/pull/12250#pullrequestreview-428468165", "createdAt": "2020-06-10T22:20:53Z", "commit": {"oid": "17753a74c97ff5d502670b96b5d4182eb59badbf"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQyMjoyMDo1NFrOGiIOnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQyMjoyMjo0MFrOGiIRCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQzOTU4MA==", "bodyText": "We only need this in the MetricsServiceMain instead of all service main, right?", "url": "https://github.com/cdapio/cdap/pull/12250#discussion_r438439580", "createdAt": "2020-06-10T22:20:54Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/master/environment/k8s/AbstractServiceMain.java", "diffHunk": "@@ -163,6 +164,7 @@ public final void init(String[] args) throws Exception {\n     modules.add(new ConfigModule(cConf, hConf, sConf));\n     modules.add(new IOModule());\n     modules.add(new MetricsClientRuntimeModule().getDistributedModules());\n+    modules.add(new MetricsWriterModule());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17753a74c97ff5d502670b96b5d4182eb59badbf"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ0MDIwMQ==", "bodyText": "So I only see the MetricsWriter being added, but the initialize is not getting called?", "url": "https://github.com/cdapio/cdap/pull/12250#discussion_r438440201", "createdAt": "2020-06-10T22:22:40Z", "author": {"login": "chtyim"}, "path": "cdap-watchdog/src/main/java/io/cdap/cdap/metrics/process/MessagingMetricsProcessorManagerService.java", "diffHunk": "@@ -74,6 +79,10 @@\n     metricsWriter.initialize(metricsContext);\n     this.metricsWriters.add(metricsWriter);\n \n+    for (Map.Entry<String, MetricsWriter> metricsWriterEntry : metricsWriterProvider.loadMetricsWriters().entrySet()) {\n+      this.metricsWriters.add(metricsWriterEntry.getValue());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA1ODc1Mw=="}, "originalCommit": {"oid": "720d59598f1b84d5aba1b55ef91f25e97ac0828f"}, "originalPosition": 46}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4NTU2MDU0", "url": "https://github.com/cdapio/cdap/pull/12250#pullrequestreview-428556054", "createdAt": "2020-06-11T02:46:14Z", "commit": {"oid": "147729438b54b8a5c3b3243fe5c7ed3f8596a579"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQwMjo0NjoxNFrOGiMrAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQwMjo0NjoxNFrOGiMrAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODUxMjM4NA==", "bodyText": "The MetricsWriter also implements Closeable. So you have to close them on the shutDown method.", "url": "https://github.com/cdapio/cdap/pull/12250#discussion_r438512384", "createdAt": "2020-06-11T02:46:14Z", "author": {"login": "chtyim"}, "path": "cdap-watchdog/src/main/java/io/cdap/cdap/metrics/process/MessagingMetricsProcessorManagerService.java", "diffHunk": "@@ -64,33 +78,53 @@\n                                           SchemaGenerator schemaGenerator,\n                                           DatumReaderFactory readerFactory,\n                                           MetricStore metricStore,\n+                                          MetricsWriterProvider metricsWriterProvider,\n                                           Set<Integer> topicNumbers,\n                                           MetricsContext metricsContext,\n                                           long metricsProcessIntervalMillis,\n                                           int instanceId) {\n     this.metricsWriters = new ArrayList<>();\n     this.metricsProcessorServices = new ArrayList<>();\n+    this.cConf = cConf;\n+    this.metricDatasetFactory = metricDatasetFactory;\n+    this.messagingService = messagingService;\n+    this.schemaGenerator = schemaGenerator;\n+    this.readerFactory = readerFactory;\n+    this.metricStore = metricStore;\n+    this.metricsWriterProvider = metricsWriterProvider;\n+    this.topicNumbers = topicNumbers;\n+    this.metricsContext = metricsContext;\n+    this.metricsProcessIntervalMillis = metricsProcessIntervalMillis;\n+    this.instanceId = instanceId;\n+  }\n+\n+  @Override\n+  protected void startUp() throws Exception {\n     MetricStoreMetricsWriter metricsWriter = new MetricStoreMetricsWriter(metricStore);\n     metricsWriter.initialize(metricsContext);\n     this.metricsWriters.add(metricsWriter);\n \n+    for (Map.Entry<String, MetricsWriter> metricsWriterEntry : metricsWriterProvider.loadMetricsWriters().entrySet()) {\n+      MetricsWriter writer = metricsWriterEntry.getValue();\n+      this.metricsWriters.add(writer);\n+      writer.initialize(metricsContext);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "147729438b54b8a5c3b3243fe5c7ed3f8596a579"}, "originalPosition": 84}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bfa2239e52115fdd0a28048a50f4fe52048502f5", "author": {"user": {"login": "rmstar", "name": "Prashant Jaikumar"}}, "url": "https://github.com/cdapio/cdap/commit/bfa2239e52115fdd0a28048a50f4fe52048502f5", "committedDate": "2020-06-11T05:26:18Z", "message": "close metric writers"}, "afterCommit": {"oid": "ec8fd551593c86cc4d14ec08ad3992fd3c396539", "author": {"user": {"login": "rmstar", "name": "Prashant Jaikumar"}}, "url": "https://github.com/cdapio/cdap/commit/ec8fd551593c86cc4d14ec08ad3992fd3c396539", "committedDate": "2020-06-11T05:28:05Z", "message": "[CDAP-16873] Add metrics writer module."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9deb283f612a9b0453d1f84dd5e288160826a946", "author": {"user": {"login": "rmstar", "name": "Prashant Jaikumar"}}, "url": "https://github.com/cdapio/cdap/commit/9deb283f612a9b0453d1f84dd5e288160826a946", "committedDate": "2020-06-12T01:14:57Z", "message": "[CDAP-16873] Add metrics writer module."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "413d26af2809c85de6916c4aeacff25448a463fc", "author": {"user": {"login": "rmstar", "name": "Prashant Jaikumar"}}, "url": "https://github.com/cdapio/cdap/commit/413d26af2809c85de6916c4aeacff25448a463fc", "committedDate": "2020-06-12T00:02:03Z", "message": "fixed TwillRunnableTest"}, "afterCommit": {"oid": "9deb283f612a9b0453d1f84dd5e288160826a946", "author": {"user": {"login": "rmstar", "name": "Prashant Jaikumar"}}, "url": "https://github.com/cdapio/cdap/commit/9deb283f612a9b0453d1f84dd5e288160826a946", "committedDate": "2020-06-12T01:14:57Z", "message": "[CDAP-16873] Add metrics writer module."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1970, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}