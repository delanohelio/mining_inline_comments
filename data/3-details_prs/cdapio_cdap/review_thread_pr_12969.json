{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQzMTQxMDQx", "number": 12969, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMFQwMzowMTo0MlrOFM4J_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMFQwMzoxMzoyNFrOFM4NNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ5MDQ3Mjk0OnYy", "diffSide": "RIGHT", "path": "cdap-common/src/main/java/io/cdap/cdap/common/conf/Constants.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMFQwMzowMTo0MlrOIQ0IBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMFQwMzowMTo0MlrOIQ0IBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDUwMjE1MQ==", "bodyText": "Please follow the naming convention to use \"authentication\".", "url": "https://github.com/cdapio/cdap/pull/12969#discussion_r554502151", "createdAt": "2021-01-10T03:01:42Z", "author": {"login": "chtyim"}, "path": "cdap-common/src/main/java/io/cdap/cdap/common/conf/Constants.java", "diffHunk": "@@ -122,6 +122,7 @@\n     public static final String EXPLORE_HTTP_USER_SERVICE = \"explore.service\";\n     public static final String MESSAGING_SERVICE = \"messaging.service\";\n     public static final String RUNTIME = \"runtime\";\n+    public static final String AUTHENTICATION = \"Authentication\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aaa465910fed4afeff95fab47e97270055860843"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ5MDQ3Mzk3OnYy", "diffSide": "RIGHT", "path": "cdap-master/src/main/java/io/cdap/cdap/master/environment/k8s/AuthenticationServiceMain.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMFQwMzowMzoyMlrOIQ0Idw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMFQwMzowMzoyMlrOIQ0Idw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDUwMjI2Mw==", "bodyText": "Generally the long arguments are aligned like this in the rest of the code base:\nprotected List<Module> getServiceModules(MasterEnvironment masterEnv, \n                                         EnvironmentOptions options, \n                                         CConfiguration cConf) {", "url": "https://github.com/cdapio/cdap/pull/12969#discussion_r554502263", "createdAt": "2021-01-10T03:03:22Z", "author": {"login": "chtyim"}, "path": "cdap-master/src/main/java/io/cdap/cdap/master/environment/k8s/AuthenticationServiceMain.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Copyright \u00a9 2019 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.master.environment.k8s;\n+\n+import com.google.common.base.Throwables;\n+import com.google.common.util.concurrent.AbstractService;\n+import com.google.common.util.concurrent.Futures;\n+import com.google.common.util.concurrent.Service;\n+import com.google.inject.Injector;\n+import com.google.inject.Module;\n+import io.cdap.cdap.common.ServiceBindException;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.guice.ZKClientModule;\n+import io.cdap.cdap.common.logging.LoggingContext;\n+import io.cdap.cdap.common.logging.ServiceLoggingContext;\n+import io.cdap.cdap.master.spi.environment.MasterEnvironment;\n+import io.cdap.cdap.master.spi.environment.MasterEnvironmentContext;\n+import io.cdap.cdap.messaging.MessagingService;\n+import io.cdap.cdap.messaging.guice.MessagingClientModule;\n+import io.cdap.cdap.proto.id.NamespaceId;\n+import io.cdap.cdap.security.guice.SecurityModules;\n+import io.cdap.cdap.security.impersonation.SecurityUtil;\n+import io.cdap.cdap.security.server.ExternalAuthenticationServer;\n+import org.apache.twill.internal.Services;\n+import org.apache.twill.zookeeper.ZKClientService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * The main class responsible for Authentication  .\n+ */\n+public class AuthenticationServiceMain extends AbstractServiceMain<EnvironmentOptions> {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(AuthenticationServiceMain.class);\n+\n+  public static void main(String[] args) throws Exception {\n+    main(AuthenticationServiceMain.class, args);\n+  }\n+\n+  @Override\n+  protected List<Module> getServiceModules(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aaa465910fed4afeff95fab47e97270055860843"}, "originalPosition": 60}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ5MDQ3NTc0OnYy", "diffSide": "RIGHT", "path": "cdap-master/src/main/java/io/cdap/cdap/master/environment/k8s/AuthenticationServiceMain.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMFQwMzowNToxMVrOIQ0JNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMFQwMzowNToxMVrOIQ0JNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDUwMjQ1Mg==", "bodyText": "Remove unnecessary empty lines", "url": "https://github.com/cdapio/cdap/pull/12969#discussion_r554502452", "createdAt": "2021-01-10T03:05:11Z", "author": {"login": "chtyim"}, "path": "cdap-master/src/main/java/io/cdap/cdap/master/environment/k8s/AuthenticationServiceMain.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Copyright \u00a9 2019 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.master.environment.k8s;\n+\n+import com.google.common.base.Throwables;\n+import com.google.common.util.concurrent.AbstractService;\n+import com.google.common.util.concurrent.Futures;\n+import com.google.common.util.concurrent.Service;\n+import com.google.inject.Injector;\n+import com.google.inject.Module;\n+import io.cdap.cdap.common.ServiceBindException;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.guice.ZKClientModule;\n+import io.cdap.cdap.common.logging.LoggingContext;\n+import io.cdap.cdap.common.logging.ServiceLoggingContext;\n+import io.cdap.cdap.master.spi.environment.MasterEnvironment;\n+import io.cdap.cdap.master.spi.environment.MasterEnvironmentContext;\n+import io.cdap.cdap.messaging.MessagingService;\n+import io.cdap.cdap.messaging.guice.MessagingClientModule;\n+import io.cdap.cdap.proto.id.NamespaceId;\n+import io.cdap.cdap.security.guice.SecurityModules;\n+import io.cdap.cdap.security.impersonation.SecurityUtil;\n+import io.cdap.cdap.security.server.ExternalAuthenticationServer;\n+import org.apache.twill.internal.Services;\n+import org.apache.twill.zookeeper.ZKClientService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * The main class responsible for Authentication  .\n+ */\n+public class AuthenticationServiceMain extends AbstractServiceMain<EnvironmentOptions> {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(AuthenticationServiceMain.class);\n+\n+  public static void main(String[] args) throws Exception {\n+    main(AuthenticationServiceMain.class, args);\n+  }\n+\n+  @Override\n+  protected List<Module> getServiceModules(\n+      MasterEnvironment masterEnv, EnvironmentOptions options, CConfiguration cConf) {\n+    return Arrays.asList(\n+        getDataFabricModule(),\n+        new ZKClientModule(),\n+        new SecurityModules().getDistributedModules(),\n+        new MessagingClientModule());\n+  }\n+\n+  @Override\n+  protected void addServices(\n+      Injector injector, List<? super Service> services, List<? super AutoCloseable> closeableResources,\n+      MasterEnvironment masterEnv, MasterEnvironmentContext masterEnvContext, EnvironmentOptions options) {\n+\n+    MessagingService messagingService = injector.getInstance(MessagingService.class);\n+    if (messagingService instanceof Service) {\n+      services.add((Service) messagingService);\n+    }\n+\n+    CConfiguration configuration = injector.getInstance(CConfiguration.class);\n+\n+    if (configuration.getBoolean(Constants.Security.ENABLED)) {\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aaa465910fed4afeff95fab47e97270055860843"}, "originalPosition": 82}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ5MDQ3NjA3OnYy", "diffSide": "RIGHT", "path": "cdap-master/src/main/java/io/cdap/cdap/master/environment/k8s/AuthenticationServiceMain.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMFQwMzowNTo0NFrOIQ0JWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xOVQyMTozNjozN1rOIWi90Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDUwMjQ5MA==", "bodyText": "Ideally in k8s environment, we should use ZK for the key store, but instead using k8s secrets. Please open a follow up JIRA for that change. We'll need to update the MasterEnvironment to provide an abstraction for secure store.", "url": "https://github.com/cdapio/cdap/pull/12969#discussion_r554502490", "createdAt": "2021-01-10T03:05:44Z", "author": {"login": "chtyim"}, "path": "cdap-master/src/main/java/io/cdap/cdap/master/environment/k8s/AuthenticationServiceMain.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Copyright \u00a9 2019 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.master.environment.k8s;\n+\n+import com.google.common.base.Throwables;\n+import com.google.common.util.concurrent.AbstractService;\n+import com.google.common.util.concurrent.Futures;\n+import com.google.common.util.concurrent.Service;\n+import com.google.inject.Injector;\n+import com.google.inject.Module;\n+import io.cdap.cdap.common.ServiceBindException;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.guice.ZKClientModule;\n+import io.cdap.cdap.common.logging.LoggingContext;\n+import io.cdap.cdap.common.logging.ServiceLoggingContext;\n+import io.cdap.cdap.master.spi.environment.MasterEnvironment;\n+import io.cdap.cdap.master.spi.environment.MasterEnvironmentContext;\n+import io.cdap.cdap.messaging.MessagingService;\n+import io.cdap.cdap.messaging.guice.MessagingClientModule;\n+import io.cdap.cdap.proto.id.NamespaceId;\n+import io.cdap.cdap.security.guice.SecurityModules;\n+import io.cdap.cdap.security.impersonation.SecurityUtil;\n+import io.cdap.cdap.security.server.ExternalAuthenticationServer;\n+import org.apache.twill.internal.Services;\n+import org.apache.twill.zookeeper.ZKClientService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * The main class responsible for Authentication  .\n+ */\n+public class AuthenticationServiceMain extends AbstractServiceMain<EnvironmentOptions> {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(AuthenticationServiceMain.class);\n+\n+  public static void main(String[] args) throws Exception {\n+    main(AuthenticationServiceMain.class, args);\n+  }\n+\n+  @Override\n+  protected List<Module> getServiceModules(\n+      MasterEnvironment masterEnv, EnvironmentOptions options, CConfiguration cConf) {\n+    return Arrays.asList(\n+        getDataFabricModule(),\n+        new ZKClientModule(),\n+        new SecurityModules().getDistributedModules(),\n+        new MessagingClientModule());\n+  }\n+\n+  @Override\n+  protected void addServices(\n+      Injector injector, List<? super Service> services, List<? super AutoCloseable> closeableResources,\n+      MasterEnvironment masterEnv, MasterEnvironmentContext masterEnvContext, EnvironmentOptions options) {\n+\n+    MessagingService messagingService = injector.getInstance(MessagingService.class);\n+    if (messagingService instanceof Service) {\n+      services.add((Service) messagingService);\n+    }\n+\n+    CConfiguration configuration = injector.getInstance(CConfiguration.class);\n+\n+    if (configuration.getBoolean(Constants.Security.ENABLED)) {\n+\n+      services.add(new AbstractService() {\n+\n+        @Override\n+        protected void doStart() {\n+\n+          ZKClientService zkClientService = injector.getInstance(ZKClientService.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aaa465910fed4afeff95fab47e97270055860843"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDUxMjQ2NQ==", "bodyText": "Created - https://cdap.atlassian.net/browse/CDAP-17618", "url": "https://github.com/cdapio/cdap/pull/12969#discussion_r560512465", "createdAt": "2021-01-19T21:36:37Z", "author": {"login": "edvinas-maciulis"}, "path": "cdap-master/src/main/java/io/cdap/cdap/master/environment/k8s/AuthenticationServiceMain.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Copyright \u00a9 2019 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.master.environment.k8s;\n+\n+import com.google.common.base.Throwables;\n+import com.google.common.util.concurrent.AbstractService;\n+import com.google.common.util.concurrent.Futures;\n+import com.google.common.util.concurrent.Service;\n+import com.google.inject.Injector;\n+import com.google.inject.Module;\n+import io.cdap.cdap.common.ServiceBindException;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.guice.ZKClientModule;\n+import io.cdap.cdap.common.logging.LoggingContext;\n+import io.cdap.cdap.common.logging.ServiceLoggingContext;\n+import io.cdap.cdap.master.spi.environment.MasterEnvironment;\n+import io.cdap.cdap.master.spi.environment.MasterEnvironmentContext;\n+import io.cdap.cdap.messaging.MessagingService;\n+import io.cdap.cdap.messaging.guice.MessagingClientModule;\n+import io.cdap.cdap.proto.id.NamespaceId;\n+import io.cdap.cdap.security.guice.SecurityModules;\n+import io.cdap.cdap.security.impersonation.SecurityUtil;\n+import io.cdap.cdap.security.server.ExternalAuthenticationServer;\n+import org.apache.twill.internal.Services;\n+import org.apache.twill.zookeeper.ZKClientService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * The main class responsible for Authentication  .\n+ */\n+public class AuthenticationServiceMain extends AbstractServiceMain<EnvironmentOptions> {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(AuthenticationServiceMain.class);\n+\n+  public static void main(String[] args) throws Exception {\n+    main(AuthenticationServiceMain.class, args);\n+  }\n+\n+  @Override\n+  protected List<Module> getServiceModules(\n+      MasterEnvironment masterEnv, EnvironmentOptions options, CConfiguration cConf) {\n+    return Arrays.asList(\n+        getDataFabricModule(),\n+        new ZKClientModule(),\n+        new SecurityModules().getDistributedModules(),\n+        new MessagingClientModule());\n+  }\n+\n+  @Override\n+  protected void addServices(\n+      Injector injector, List<? super Service> services, List<? super AutoCloseable> closeableResources,\n+      MasterEnvironment masterEnv, MasterEnvironmentContext masterEnvContext, EnvironmentOptions options) {\n+\n+    MessagingService messagingService = injector.getInstance(MessagingService.class);\n+    if (messagingService instanceof Service) {\n+      services.add((Service) messagingService);\n+    }\n+\n+    CConfiguration configuration = injector.getInstance(CConfiguration.class);\n+\n+    if (configuration.getBoolean(Constants.Security.ENABLED)) {\n+\n+      services.add(new AbstractService() {\n+\n+        @Override\n+        protected void doStart() {\n+\n+          ZKClientService zkClientService = injector.getInstance(ZKClientService.class);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDUwMjQ5MA=="}, "originalCommit": {"oid": "aaa465910fed4afeff95fab47e97270055860843"}, "originalPosition": 88}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ5MDQ3NzczOnYy", "diffSide": "RIGHT", "path": "cdap-master/src/main/java/io/cdap/cdap/master/environment/k8s/AuthenticationServiceMain.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMFQwMzowNzozMlrOIQ0KDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xOVQyMTo1MDoxM1rOIWjZ0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDUwMjY2OQ==", "bodyText": "So if it fails to connect to ZK, there is just logging but not failing the pod? Is that an intended behavior?", "url": "https://github.com/cdapio/cdap/pull/12969#discussion_r554502669", "createdAt": "2021-01-10T03:07:32Z", "author": {"login": "chtyim"}, "path": "cdap-master/src/main/java/io/cdap/cdap/master/environment/k8s/AuthenticationServiceMain.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Copyright \u00a9 2019 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.master.environment.k8s;\n+\n+import com.google.common.base.Throwables;\n+import com.google.common.util.concurrent.AbstractService;\n+import com.google.common.util.concurrent.Futures;\n+import com.google.common.util.concurrent.Service;\n+import com.google.inject.Injector;\n+import com.google.inject.Module;\n+import io.cdap.cdap.common.ServiceBindException;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.guice.ZKClientModule;\n+import io.cdap.cdap.common.logging.LoggingContext;\n+import io.cdap.cdap.common.logging.ServiceLoggingContext;\n+import io.cdap.cdap.master.spi.environment.MasterEnvironment;\n+import io.cdap.cdap.master.spi.environment.MasterEnvironmentContext;\n+import io.cdap.cdap.messaging.MessagingService;\n+import io.cdap.cdap.messaging.guice.MessagingClientModule;\n+import io.cdap.cdap.proto.id.NamespaceId;\n+import io.cdap.cdap.security.guice.SecurityModules;\n+import io.cdap.cdap.security.impersonation.SecurityUtil;\n+import io.cdap.cdap.security.server.ExternalAuthenticationServer;\n+import org.apache.twill.internal.Services;\n+import org.apache.twill.zookeeper.ZKClientService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * The main class responsible for Authentication  .\n+ */\n+public class AuthenticationServiceMain extends AbstractServiceMain<EnvironmentOptions> {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(AuthenticationServiceMain.class);\n+\n+  public static void main(String[] args) throws Exception {\n+    main(AuthenticationServiceMain.class, args);\n+  }\n+\n+  @Override\n+  protected List<Module> getServiceModules(\n+      MasterEnvironment masterEnv, EnvironmentOptions options, CConfiguration cConf) {\n+    return Arrays.asList(\n+        getDataFabricModule(),\n+        new ZKClientModule(),\n+        new SecurityModules().getDistributedModules(),\n+        new MessagingClientModule());\n+  }\n+\n+  @Override\n+  protected void addServices(\n+      Injector injector, List<? super Service> services, List<? super AutoCloseable> closeableResources,\n+      MasterEnvironment masterEnv, MasterEnvironmentContext masterEnvContext, EnvironmentOptions options) {\n+\n+    MessagingService messagingService = injector.getInstance(MessagingService.class);\n+    if (messagingService instanceof Service) {\n+      services.add((Service) messagingService);\n+    }\n+\n+    CConfiguration configuration = injector.getInstance(CConfiguration.class);\n+\n+    if (configuration.getBoolean(Constants.Security.ENABLED)) {\n+\n+      services.add(new AbstractService() {\n+\n+        @Override\n+        protected void doStart() {\n+\n+          ZKClientService zkClientService = injector.getInstance(ZKClientService.class);\n+          ExternalAuthenticationServer authServer = injector.getInstance(ExternalAuthenticationServer.class);\n+\n+          try {\n+            LOG.info(\"Starting AuthenticationServer.\");\n+\n+            // Enable Kerberos login\n+            SecurityUtil.enableKerberosLogin(configuration);\n+\n+            io.cdap.cdap.common.service.Services.startAndWait(\n+                zkClientService,\n+                configuration.getLong(\n+                    Constants.Zookeeper.CLIENT_STARTUP_TIMEOUT_MILLIS),\n+                TimeUnit.MILLISECONDS,\n+                String.format(\n+                    \"Connection timed out while trying to start \" +\n+                        \"ZooKeeper client. Please verify that the \" +\n+                        \"ZooKeeper quorum settings are correct in \" +\n+                        \"cdap-site.xml. Currently configured as: %s\",\n+                    configuration.get(Constants.Zookeeper.QUORUM)));\n+            authServer.startAndWait();\n+\n+            notifyStarted();\n+          } catch (Exception e) {\n+            Throwable rootCause = Throwables.getRootCause(e);\n+            if (rootCause instanceof ServiceBindException) {\n+              LOG.error(\"Failed to start Authentication Server: {}\", rootCause.getMessage());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aaa465910fed4afeff95fab47e97270055860843"}, "originalPosition": 114}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDUxOTYzNA==", "bodyText": "Added System.exit(1).", "url": "https://github.com/cdapio/cdap/pull/12969#discussion_r560519634", "createdAt": "2021-01-19T21:50:13Z", "author": {"login": "edvinas-maciulis"}, "path": "cdap-master/src/main/java/io/cdap/cdap/master/environment/k8s/AuthenticationServiceMain.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Copyright \u00a9 2019 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.master.environment.k8s;\n+\n+import com.google.common.base.Throwables;\n+import com.google.common.util.concurrent.AbstractService;\n+import com.google.common.util.concurrent.Futures;\n+import com.google.common.util.concurrent.Service;\n+import com.google.inject.Injector;\n+import com.google.inject.Module;\n+import io.cdap.cdap.common.ServiceBindException;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.guice.ZKClientModule;\n+import io.cdap.cdap.common.logging.LoggingContext;\n+import io.cdap.cdap.common.logging.ServiceLoggingContext;\n+import io.cdap.cdap.master.spi.environment.MasterEnvironment;\n+import io.cdap.cdap.master.spi.environment.MasterEnvironmentContext;\n+import io.cdap.cdap.messaging.MessagingService;\n+import io.cdap.cdap.messaging.guice.MessagingClientModule;\n+import io.cdap.cdap.proto.id.NamespaceId;\n+import io.cdap.cdap.security.guice.SecurityModules;\n+import io.cdap.cdap.security.impersonation.SecurityUtil;\n+import io.cdap.cdap.security.server.ExternalAuthenticationServer;\n+import org.apache.twill.internal.Services;\n+import org.apache.twill.zookeeper.ZKClientService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * The main class responsible for Authentication  .\n+ */\n+public class AuthenticationServiceMain extends AbstractServiceMain<EnvironmentOptions> {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(AuthenticationServiceMain.class);\n+\n+  public static void main(String[] args) throws Exception {\n+    main(AuthenticationServiceMain.class, args);\n+  }\n+\n+  @Override\n+  protected List<Module> getServiceModules(\n+      MasterEnvironment masterEnv, EnvironmentOptions options, CConfiguration cConf) {\n+    return Arrays.asList(\n+        getDataFabricModule(),\n+        new ZKClientModule(),\n+        new SecurityModules().getDistributedModules(),\n+        new MessagingClientModule());\n+  }\n+\n+  @Override\n+  protected void addServices(\n+      Injector injector, List<? super Service> services, List<? super AutoCloseable> closeableResources,\n+      MasterEnvironment masterEnv, MasterEnvironmentContext masterEnvContext, EnvironmentOptions options) {\n+\n+    MessagingService messagingService = injector.getInstance(MessagingService.class);\n+    if (messagingService instanceof Service) {\n+      services.add((Service) messagingService);\n+    }\n+\n+    CConfiguration configuration = injector.getInstance(CConfiguration.class);\n+\n+    if (configuration.getBoolean(Constants.Security.ENABLED)) {\n+\n+      services.add(new AbstractService() {\n+\n+        @Override\n+        protected void doStart() {\n+\n+          ZKClientService zkClientService = injector.getInstance(ZKClientService.class);\n+          ExternalAuthenticationServer authServer = injector.getInstance(ExternalAuthenticationServer.class);\n+\n+          try {\n+            LOG.info(\"Starting AuthenticationServer.\");\n+\n+            // Enable Kerberos login\n+            SecurityUtil.enableKerberosLogin(configuration);\n+\n+            io.cdap.cdap.common.service.Services.startAndWait(\n+                zkClientService,\n+                configuration.getLong(\n+                    Constants.Zookeeper.CLIENT_STARTUP_TIMEOUT_MILLIS),\n+                TimeUnit.MILLISECONDS,\n+                String.format(\n+                    \"Connection timed out while trying to start \" +\n+                        \"ZooKeeper client. Please verify that the \" +\n+                        \"ZooKeeper quorum settings are correct in \" +\n+                        \"cdap-site.xml. Currently configured as: %s\",\n+                    configuration.get(Constants.Zookeeper.QUORUM)));\n+            authServer.startAndWait();\n+\n+            notifyStarted();\n+          } catch (Exception e) {\n+            Throwable rootCause = Throwables.getRootCause(e);\n+            if (rootCause instanceof ServiceBindException) {\n+              LOG.error(\"Failed to start Authentication Server: {}\", rootCause.getMessage());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDUwMjY2OQ=="}, "originalCommit": {"oid": "aaa465910fed4afeff95fab47e97270055860843"}, "originalPosition": 114}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ5MDQ3ODk5OnYy", "diffSide": "RIGHT", "path": "cdap-master/src/main/java/io/cdap/cdap/master/environment/k8s/AuthenticationServiceMain.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMFQwMzowOToyOFrOIQ0KoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yM1QyMjowNzo1NlrOIZHVAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDUwMjgxNw==", "bodyText": "It's not good to assume that the ZKClientService is a singleton binding.", "url": "https://github.com/cdapio/cdap/pull/12969#discussion_r554502817", "createdAt": "2021-01-10T03:09:28Z", "author": {"login": "chtyim"}, "path": "cdap-master/src/main/java/io/cdap/cdap/master/environment/k8s/AuthenticationServiceMain.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Copyright \u00a9 2019 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.master.environment.k8s;\n+\n+import com.google.common.base.Throwables;\n+import com.google.common.util.concurrent.AbstractService;\n+import com.google.common.util.concurrent.Futures;\n+import com.google.common.util.concurrent.Service;\n+import com.google.inject.Injector;\n+import com.google.inject.Module;\n+import io.cdap.cdap.common.ServiceBindException;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.guice.ZKClientModule;\n+import io.cdap.cdap.common.logging.LoggingContext;\n+import io.cdap.cdap.common.logging.ServiceLoggingContext;\n+import io.cdap.cdap.master.spi.environment.MasterEnvironment;\n+import io.cdap.cdap.master.spi.environment.MasterEnvironmentContext;\n+import io.cdap.cdap.messaging.MessagingService;\n+import io.cdap.cdap.messaging.guice.MessagingClientModule;\n+import io.cdap.cdap.proto.id.NamespaceId;\n+import io.cdap.cdap.security.guice.SecurityModules;\n+import io.cdap.cdap.security.impersonation.SecurityUtil;\n+import io.cdap.cdap.security.server.ExternalAuthenticationServer;\n+import org.apache.twill.internal.Services;\n+import org.apache.twill.zookeeper.ZKClientService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * The main class responsible for Authentication  .\n+ */\n+public class AuthenticationServiceMain extends AbstractServiceMain<EnvironmentOptions> {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(AuthenticationServiceMain.class);\n+\n+  public static void main(String[] args) throws Exception {\n+    main(AuthenticationServiceMain.class, args);\n+  }\n+\n+  @Override\n+  protected List<Module> getServiceModules(\n+      MasterEnvironment masterEnv, EnvironmentOptions options, CConfiguration cConf) {\n+    return Arrays.asList(\n+        getDataFabricModule(),\n+        new ZKClientModule(),\n+        new SecurityModules().getDistributedModules(),\n+        new MessagingClientModule());\n+  }\n+\n+  @Override\n+  protected void addServices(\n+      Injector injector, List<? super Service> services, List<? super AutoCloseable> closeableResources,\n+      MasterEnvironment masterEnv, MasterEnvironmentContext masterEnvContext, EnvironmentOptions options) {\n+\n+    MessagingService messagingService = injector.getInstance(MessagingService.class);\n+    if (messagingService instanceof Service) {\n+      services.add((Service) messagingService);\n+    }\n+\n+    CConfiguration configuration = injector.getInstance(CConfiguration.class);\n+\n+    if (configuration.getBoolean(Constants.Security.ENABLED)) {\n+\n+      services.add(new AbstractService() {\n+\n+        @Override\n+        protected void doStart() {\n+\n+          ZKClientService zkClientService = injector.getInstance(ZKClientService.class);\n+          ExternalAuthenticationServer authServer = injector.getInstance(ExternalAuthenticationServer.class);\n+\n+          try {\n+            LOG.info(\"Starting AuthenticationServer.\");\n+\n+            // Enable Kerberos login\n+            SecurityUtil.enableKerberosLogin(configuration);\n+\n+            io.cdap.cdap.common.service.Services.startAndWait(\n+                zkClientService,\n+                configuration.getLong(\n+                    Constants.Zookeeper.CLIENT_STARTUP_TIMEOUT_MILLIS),\n+                TimeUnit.MILLISECONDS,\n+                String.format(\n+                    \"Connection timed out while trying to start \" +\n+                        \"ZooKeeper client. Please verify that the \" +\n+                        \"ZooKeeper quorum settings are correct in \" +\n+                        \"cdap-site.xml. Currently configured as: %s\",\n+                    configuration.get(Constants.Zookeeper.QUORUM)));\n+            authServer.startAndWait();\n+\n+            notifyStarted();\n+          } catch (Exception e) {\n+            Throwable rootCause = Throwables.getRootCause(e);\n+            if (rootCause instanceof ServiceBindException) {\n+              LOG.error(\"Failed to start Authentication Server: {}\", rootCause.getMessage());\n+            } else {\n+              LOG.error(\"Failed to start Authentication Server\", e);\n+            }\n+          }\n+        }\n+\n+        @Override\n+        protected void doStop() {\n+\n+          ZKClientService zkClientService = injector.getInstance(ZKClientService.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aaa465910fed4afeff95fab47e97270055860843"}, "originalPosition": 124}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDUxODI4Nw==", "bodyText": "ZKClientModule defines it as a singleton. I do understand that it is done in separate place.\nInjector does not provide a way to access all instances - I have been researching in that space. Is the code bellow is the way you are thinking all instances should be retrieved?\n     for (Key<?> key : injector.getAllBindings().keySet()) {\n          if (YourInterface.class.isAssignableFrom(key.getTypeLiteral().getRawType())) {\n           YourInterface yourInterface = (YourInterface) injector.getInstance(key);\n           allYourInterfaces.add(yourInterface);\n      }\n\nisAssignableFrom method matches all subclasses - in this situation we could just use ==\nSource: https://stackoverflow.com/questions/6085200/how-to-get-all-implementors-subclasses-of-an-interface-with-guice/40558788\nIs that how you see it?", "url": "https://github.com/cdapio/cdap/pull/12969#discussion_r560518287", "createdAt": "2021-01-19T21:47:38Z", "author": {"login": "edvinas-maciulis"}, "path": "cdap-master/src/main/java/io/cdap/cdap/master/environment/k8s/AuthenticationServiceMain.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Copyright \u00a9 2019 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.master.environment.k8s;\n+\n+import com.google.common.base.Throwables;\n+import com.google.common.util.concurrent.AbstractService;\n+import com.google.common.util.concurrent.Futures;\n+import com.google.common.util.concurrent.Service;\n+import com.google.inject.Injector;\n+import com.google.inject.Module;\n+import io.cdap.cdap.common.ServiceBindException;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.guice.ZKClientModule;\n+import io.cdap.cdap.common.logging.LoggingContext;\n+import io.cdap.cdap.common.logging.ServiceLoggingContext;\n+import io.cdap.cdap.master.spi.environment.MasterEnvironment;\n+import io.cdap.cdap.master.spi.environment.MasterEnvironmentContext;\n+import io.cdap.cdap.messaging.MessagingService;\n+import io.cdap.cdap.messaging.guice.MessagingClientModule;\n+import io.cdap.cdap.proto.id.NamespaceId;\n+import io.cdap.cdap.security.guice.SecurityModules;\n+import io.cdap.cdap.security.impersonation.SecurityUtil;\n+import io.cdap.cdap.security.server.ExternalAuthenticationServer;\n+import org.apache.twill.internal.Services;\n+import org.apache.twill.zookeeper.ZKClientService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * The main class responsible for Authentication  .\n+ */\n+public class AuthenticationServiceMain extends AbstractServiceMain<EnvironmentOptions> {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(AuthenticationServiceMain.class);\n+\n+  public static void main(String[] args) throws Exception {\n+    main(AuthenticationServiceMain.class, args);\n+  }\n+\n+  @Override\n+  protected List<Module> getServiceModules(\n+      MasterEnvironment masterEnv, EnvironmentOptions options, CConfiguration cConf) {\n+    return Arrays.asList(\n+        getDataFabricModule(),\n+        new ZKClientModule(),\n+        new SecurityModules().getDistributedModules(),\n+        new MessagingClientModule());\n+  }\n+\n+  @Override\n+  protected void addServices(\n+      Injector injector, List<? super Service> services, List<? super AutoCloseable> closeableResources,\n+      MasterEnvironment masterEnv, MasterEnvironmentContext masterEnvContext, EnvironmentOptions options) {\n+\n+    MessagingService messagingService = injector.getInstance(MessagingService.class);\n+    if (messagingService instanceof Service) {\n+      services.add((Service) messagingService);\n+    }\n+\n+    CConfiguration configuration = injector.getInstance(CConfiguration.class);\n+\n+    if (configuration.getBoolean(Constants.Security.ENABLED)) {\n+\n+      services.add(new AbstractService() {\n+\n+        @Override\n+        protected void doStart() {\n+\n+          ZKClientService zkClientService = injector.getInstance(ZKClientService.class);\n+          ExternalAuthenticationServer authServer = injector.getInstance(ExternalAuthenticationServer.class);\n+\n+          try {\n+            LOG.info(\"Starting AuthenticationServer.\");\n+\n+            // Enable Kerberos login\n+            SecurityUtil.enableKerberosLogin(configuration);\n+\n+            io.cdap.cdap.common.service.Services.startAndWait(\n+                zkClientService,\n+                configuration.getLong(\n+                    Constants.Zookeeper.CLIENT_STARTUP_TIMEOUT_MILLIS),\n+                TimeUnit.MILLISECONDS,\n+                String.format(\n+                    \"Connection timed out while trying to start \" +\n+                        \"ZooKeeper client. Please verify that the \" +\n+                        \"ZooKeeper quorum settings are correct in \" +\n+                        \"cdap-site.xml. Currently configured as: %s\",\n+                    configuration.get(Constants.Zookeeper.QUORUM)));\n+            authServer.startAndWait();\n+\n+            notifyStarted();\n+          } catch (Exception e) {\n+            Throwable rootCause = Throwables.getRootCause(e);\n+            if (rootCause instanceof ServiceBindException) {\n+              LOG.error(\"Failed to start Authentication Server: {}\", rootCause.getMessage());\n+            } else {\n+              LOG.error(\"Failed to start Authentication Server\", e);\n+            }\n+          }\n+        }\n+\n+        @Override\n+        protected void doStop() {\n+\n+          ZKClientService zkClientService = injector.getInstance(ZKClientService.class);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDUwMjgxNw=="}, "originalCommit": {"oid": "aaa465910fed4afeff95fab47e97270055860843"}, "originalPosition": 124}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjAzNjU1OQ==", "bodyText": "What I meant was instead of relying on the binding being singleton,  it is better to just get the instance once and hold the instance in a field so that it is for sure it is the same instance.", "url": "https://github.com/cdapio/cdap/pull/12969#discussion_r562036559", "createdAt": "2021-01-21T16:50:34Z", "author": {"login": "chtyim"}, "path": "cdap-master/src/main/java/io/cdap/cdap/master/environment/k8s/AuthenticationServiceMain.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Copyright \u00a9 2019 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.master.environment.k8s;\n+\n+import com.google.common.base.Throwables;\n+import com.google.common.util.concurrent.AbstractService;\n+import com.google.common.util.concurrent.Futures;\n+import com.google.common.util.concurrent.Service;\n+import com.google.inject.Injector;\n+import com.google.inject.Module;\n+import io.cdap.cdap.common.ServiceBindException;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.guice.ZKClientModule;\n+import io.cdap.cdap.common.logging.LoggingContext;\n+import io.cdap.cdap.common.logging.ServiceLoggingContext;\n+import io.cdap.cdap.master.spi.environment.MasterEnvironment;\n+import io.cdap.cdap.master.spi.environment.MasterEnvironmentContext;\n+import io.cdap.cdap.messaging.MessagingService;\n+import io.cdap.cdap.messaging.guice.MessagingClientModule;\n+import io.cdap.cdap.proto.id.NamespaceId;\n+import io.cdap.cdap.security.guice.SecurityModules;\n+import io.cdap.cdap.security.impersonation.SecurityUtil;\n+import io.cdap.cdap.security.server.ExternalAuthenticationServer;\n+import org.apache.twill.internal.Services;\n+import org.apache.twill.zookeeper.ZKClientService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * The main class responsible for Authentication  .\n+ */\n+public class AuthenticationServiceMain extends AbstractServiceMain<EnvironmentOptions> {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(AuthenticationServiceMain.class);\n+\n+  public static void main(String[] args) throws Exception {\n+    main(AuthenticationServiceMain.class, args);\n+  }\n+\n+  @Override\n+  protected List<Module> getServiceModules(\n+      MasterEnvironment masterEnv, EnvironmentOptions options, CConfiguration cConf) {\n+    return Arrays.asList(\n+        getDataFabricModule(),\n+        new ZKClientModule(),\n+        new SecurityModules().getDistributedModules(),\n+        new MessagingClientModule());\n+  }\n+\n+  @Override\n+  protected void addServices(\n+      Injector injector, List<? super Service> services, List<? super AutoCloseable> closeableResources,\n+      MasterEnvironment masterEnv, MasterEnvironmentContext masterEnvContext, EnvironmentOptions options) {\n+\n+    MessagingService messagingService = injector.getInstance(MessagingService.class);\n+    if (messagingService instanceof Service) {\n+      services.add((Service) messagingService);\n+    }\n+\n+    CConfiguration configuration = injector.getInstance(CConfiguration.class);\n+\n+    if (configuration.getBoolean(Constants.Security.ENABLED)) {\n+\n+      services.add(new AbstractService() {\n+\n+        @Override\n+        protected void doStart() {\n+\n+          ZKClientService zkClientService = injector.getInstance(ZKClientService.class);\n+          ExternalAuthenticationServer authServer = injector.getInstance(ExternalAuthenticationServer.class);\n+\n+          try {\n+            LOG.info(\"Starting AuthenticationServer.\");\n+\n+            // Enable Kerberos login\n+            SecurityUtil.enableKerberosLogin(configuration);\n+\n+            io.cdap.cdap.common.service.Services.startAndWait(\n+                zkClientService,\n+                configuration.getLong(\n+                    Constants.Zookeeper.CLIENT_STARTUP_TIMEOUT_MILLIS),\n+                TimeUnit.MILLISECONDS,\n+                String.format(\n+                    \"Connection timed out while trying to start \" +\n+                        \"ZooKeeper client. Please verify that the \" +\n+                        \"ZooKeeper quorum settings are correct in \" +\n+                        \"cdap-site.xml. Currently configured as: %s\",\n+                    configuration.get(Constants.Zookeeper.QUORUM)));\n+            authServer.startAndWait();\n+\n+            notifyStarted();\n+          } catch (Exception e) {\n+            Throwable rootCause = Throwables.getRootCause(e);\n+            if (rootCause instanceof ServiceBindException) {\n+              LOG.error(\"Failed to start Authentication Server: {}\", rootCause.getMessage());\n+            } else {\n+              LOG.error(\"Failed to start Authentication Server\", e);\n+            }\n+          }\n+        }\n+\n+        @Override\n+        protected void doStop() {\n+\n+          ZKClientService zkClientService = injector.getInstance(ZKClientService.class);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDUwMjgxNw=="}, "originalCommit": {"oid": "aaa465910fed4afeff95fab47e97270055860843"}, "originalPosition": 124}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzIwNTM3OQ==", "bodyText": "Thanks, makes sense. I have updated code.", "url": "https://github.com/cdapio/cdap/pull/12969#discussion_r563205379", "createdAt": "2021-01-23T22:07:56Z", "author": {"login": "edvinas-maciulis"}, "path": "cdap-master/src/main/java/io/cdap/cdap/master/environment/k8s/AuthenticationServiceMain.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Copyright \u00a9 2019 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.master.environment.k8s;\n+\n+import com.google.common.base.Throwables;\n+import com.google.common.util.concurrent.AbstractService;\n+import com.google.common.util.concurrent.Futures;\n+import com.google.common.util.concurrent.Service;\n+import com.google.inject.Injector;\n+import com.google.inject.Module;\n+import io.cdap.cdap.common.ServiceBindException;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.guice.ZKClientModule;\n+import io.cdap.cdap.common.logging.LoggingContext;\n+import io.cdap.cdap.common.logging.ServiceLoggingContext;\n+import io.cdap.cdap.master.spi.environment.MasterEnvironment;\n+import io.cdap.cdap.master.spi.environment.MasterEnvironmentContext;\n+import io.cdap.cdap.messaging.MessagingService;\n+import io.cdap.cdap.messaging.guice.MessagingClientModule;\n+import io.cdap.cdap.proto.id.NamespaceId;\n+import io.cdap.cdap.security.guice.SecurityModules;\n+import io.cdap.cdap.security.impersonation.SecurityUtil;\n+import io.cdap.cdap.security.server.ExternalAuthenticationServer;\n+import org.apache.twill.internal.Services;\n+import org.apache.twill.zookeeper.ZKClientService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * The main class responsible for Authentication  .\n+ */\n+public class AuthenticationServiceMain extends AbstractServiceMain<EnvironmentOptions> {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(AuthenticationServiceMain.class);\n+\n+  public static void main(String[] args) throws Exception {\n+    main(AuthenticationServiceMain.class, args);\n+  }\n+\n+  @Override\n+  protected List<Module> getServiceModules(\n+      MasterEnvironment masterEnv, EnvironmentOptions options, CConfiguration cConf) {\n+    return Arrays.asList(\n+        getDataFabricModule(),\n+        new ZKClientModule(),\n+        new SecurityModules().getDistributedModules(),\n+        new MessagingClientModule());\n+  }\n+\n+  @Override\n+  protected void addServices(\n+      Injector injector, List<? super Service> services, List<? super AutoCloseable> closeableResources,\n+      MasterEnvironment masterEnv, MasterEnvironmentContext masterEnvContext, EnvironmentOptions options) {\n+\n+    MessagingService messagingService = injector.getInstance(MessagingService.class);\n+    if (messagingService instanceof Service) {\n+      services.add((Service) messagingService);\n+    }\n+\n+    CConfiguration configuration = injector.getInstance(CConfiguration.class);\n+\n+    if (configuration.getBoolean(Constants.Security.ENABLED)) {\n+\n+      services.add(new AbstractService() {\n+\n+        @Override\n+        protected void doStart() {\n+\n+          ZKClientService zkClientService = injector.getInstance(ZKClientService.class);\n+          ExternalAuthenticationServer authServer = injector.getInstance(ExternalAuthenticationServer.class);\n+\n+          try {\n+            LOG.info(\"Starting AuthenticationServer.\");\n+\n+            // Enable Kerberos login\n+            SecurityUtil.enableKerberosLogin(configuration);\n+\n+            io.cdap.cdap.common.service.Services.startAndWait(\n+                zkClientService,\n+                configuration.getLong(\n+                    Constants.Zookeeper.CLIENT_STARTUP_TIMEOUT_MILLIS),\n+                TimeUnit.MILLISECONDS,\n+                String.format(\n+                    \"Connection timed out while trying to start \" +\n+                        \"ZooKeeper client. Please verify that the \" +\n+                        \"ZooKeeper quorum settings are correct in \" +\n+                        \"cdap-site.xml. Currently configured as: %s\",\n+                    configuration.get(Constants.Zookeeper.QUORUM)));\n+            authServer.startAndWait();\n+\n+            notifyStarted();\n+          } catch (Exception e) {\n+            Throwable rootCause = Throwables.getRootCause(e);\n+            if (rootCause instanceof ServiceBindException) {\n+              LOG.error(\"Failed to start Authentication Server: {}\", rootCause.getMessage());\n+            } else {\n+              LOG.error(\"Failed to start Authentication Server\", e);\n+            }\n+          }\n+        }\n+\n+        @Override\n+        protected void doStop() {\n+\n+          ZKClientService zkClientService = injector.getInstance(ZKClientService.class);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDUwMjgxNw=="}, "originalCommit": {"oid": "aaa465910fed4afeff95fab47e97270055860843"}, "originalPosition": 124}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ5MDQ3OTM4OnYy", "diffSide": "RIGHT", "path": "cdap-master/src/main/java/io/cdap/cdap/master/environment/k8s/AuthenticationServiceMain.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMFQwMzowOTo1OFrOIQ0KzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yM1QyMjowODoxMlrOIZHVDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDUwMjg2MA==", "bodyText": "Same as above", "url": "https://github.com/cdapio/cdap/pull/12969#discussion_r554502860", "createdAt": "2021-01-10T03:09:58Z", "author": {"login": "chtyim"}, "path": "cdap-master/src/main/java/io/cdap/cdap/master/environment/k8s/AuthenticationServiceMain.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Copyright \u00a9 2019 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.master.environment.k8s;\n+\n+import com.google.common.base.Throwables;\n+import com.google.common.util.concurrent.AbstractService;\n+import com.google.common.util.concurrent.Futures;\n+import com.google.common.util.concurrent.Service;\n+import com.google.inject.Injector;\n+import com.google.inject.Module;\n+import io.cdap.cdap.common.ServiceBindException;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.guice.ZKClientModule;\n+import io.cdap.cdap.common.logging.LoggingContext;\n+import io.cdap.cdap.common.logging.ServiceLoggingContext;\n+import io.cdap.cdap.master.spi.environment.MasterEnvironment;\n+import io.cdap.cdap.master.spi.environment.MasterEnvironmentContext;\n+import io.cdap.cdap.messaging.MessagingService;\n+import io.cdap.cdap.messaging.guice.MessagingClientModule;\n+import io.cdap.cdap.proto.id.NamespaceId;\n+import io.cdap.cdap.security.guice.SecurityModules;\n+import io.cdap.cdap.security.impersonation.SecurityUtil;\n+import io.cdap.cdap.security.server.ExternalAuthenticationServer;\n+import org.apache.twill.internal.Services;\n+import org.apache.twill.zookeeper.ZKClientService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * The main class responsible for Authentication  .\n+ */\n+public class AuthenticationServiceMain extends AbstractServiceMain<EnvironmentOptions> {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(AuthenticationServiceMain.class);\n+\n+  public static void main(String[] args) throws Exception {\n+    main(AuthenticationServiceMain.class, args);\n+  }\n+\n+  @Override\n+  protected List<Module> getServiceModules(\n+      MasterEnvironment masterEnv, EnvironmentOptions options, CConfiguration cConf) {\n+    return Arrays.asList(\n+        getDataFabricModule(),\n+        new ZKClientModule(),\n+        new SecurityModules().getDistributedModules(),\n+        new MessagingClientModule());\n+  }\n+\n+  @Override\n+  protected void addServices(\n+      Injector injector, List<? super Service> services, List<? super AutoCloseable> closeableResources,\n+      MasterEnvironment masterEnv, MasterEnvironmentContext masterEnvContext, EnvironmentOptions options) {\n+\n+    MessagingService messagingService = injector.getInstance(MessagingService.class);\n+    if (messagingService instanceof Service) {\n+      services.add((Service) messagingService);\n+    }\n+\n+    CConfiguration configuration = injector.getInstance(CConfiguration.class);\n+\n+    if (configuration.getBoolean(Constants.Security.ENABLED)) {\n+\n+      services.add(new AbstractService() {\n+\n+        @Override\n+        protected void doStart() {\n+\n+          ZKClientService zkClientService = injector.getInstance(ZKClientService.class);\n+          ExternalAuthenticationServer authServer = injector.getInstance(ExternalAuthenticationServer.class);\n+\n+          try {\n+            LOG.info(\"Starting AuthenticationServer.\");\n+\n+            // Enable Kerberos login\n+            SecurityUtil.enableKerberosLogin(configuration);\n+\n+            io.cdap.cdap.common.service.Services.startAndWait(\n+                zkClientService,\n+                configuration.getLong(\n+                    Constants.Zookeeper.CLIENT_STARTUP_TIMEOUT_MILLIS),\n+                TimeUnit.MILLISECONDS,\n+                String.format(\n+                    \"Connection timed out while trying to start \" +\n+                        \"ZooKeeper client. Please verify that the \" +\n+                        \"ZooKeeper quorum settings are correct in \" +\n+                        \"cdap-site.xml. Currently configured as: %s\",\n+                    configuration.get(Constants.Zookeeper.QUORUM)));\n+            authServer.startAndWait();\n+\n+            notifyStarted();\n+          } catch (Exception e) {\n+            Throwable rootCause = Throwables.getRootCause(e);\n+            if (rootCause instanceof ServiceBindException) {\n+              LOG.error(\"Failed to start Authentication Server: {}\", rootCause.getMessage());\n+            } else {\n+              LOG.error(\"Failed to start Authentication Server\", e);\n+            }\n+          }\n+        }\n+\n+        @Override\n+        protected void doStop() {\n+\n+          ZKClientService zkClientService = injector.getInstance(ZKClientService.class);\n+          ExternalAuthenticationServer authServer = injector.getInstance(ExternalAuthenticationServer.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aaa465910fed4afeff95fab47e97270055860843"}, "originalPosition": 125}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDUxODU2Mg==", "bodyText": "Will address depending on the outcome from above", "url": "https://github.com/cdapio/cdap/pull/12969#discussion_r560518562", "createdAt": "2021-01-19T21:48:09Z", "author": {"login": "edvinas-maciulis"}, "path": "cdap-master/src/main/java/io/cdap/cdap/master/environment/k8s/AuthenticationServiceMain.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Copyright \u00a9 2019 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.master.environment.k8s;\n+\n+import com.google.common.base.Throwables;\n+import com.google.common.util.concurrent.AbstractService;\n+import com.google.common.util.concurrent.Futures;\n+import com.google.common.util.concurrent.Service;\n+import com.google.inject.Injector;\n+import com.google.inject.Module;\n+import io.cdap.cdap.common.ServiceBindException;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.guice.ZKClientModule;\n+import io.cdap.cdap.common.logging.LoggingContext;\n+import io.cdap.cdap.common.logging.ServiceLoggingContext;\n+import io.cdap.cdap.master.spi.environment.MasterEnvironment;\n+import io.cdap.cdap.master.spi.environment.MasterEnvironmentContext;\n+import io.cdap.cdap.messaging.MessagingService;\n+import io.cdap.cdap.messaging.guice.MessagingClientModule;\n+import io.cdap.cdap.proto.id.NamespaceId;\n+import io.cdap.cdap.security.guice.SecurityModules;\n+import io.cdap.cdap.security.impersonation.SecurityUtil;\n+import io.cdap.cdap.security.server.ExternalAuthenticationServer;\n+import org.apache.twill.internal.Services;\n+import org.apache.twill.zookeeper.ZKClientService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * The main class responsible for Authentication  .\n+ */\n+public class AuthenticationServiceMain extends AbstractServiceMain<EnvironmentOptions> {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(AuthenticationServiceMain.class);\n+\n+  public static void main(String[] args) throws Exception {\n+    main(AuthenticationServiceMain.class, args);\n+  }\n+\n+  @Override\n+  protected List<Module> getServiceModules(\n+      MasterEnvironment masterEnv, EnvironmentOptions options, CConfiguration cConf) {\n+    return Arrays.asList(\n+        getDataFabricModule(),\n+        new ZKClientModule(),\n+        new SecurityModules().getDistributedModules(),\n+        new MessagingClientModule());\n+  }\n+\n+  @Override\n+  protected void addServices(\n+      Injector injector, List<? super Service> services, List<? super AutoCloseable> closeableResources,\n+      MasterEnvironment masterEnv, MasterEnvironmentContext masterEnvContext, EnvironmentOptions options) {\n+\n+    MessagingService messagingService = injector.getInstance(MessagingService.class);\n+    if (messagingService instanceof Service) {\n+      services.add((Service) messagingService);\n+    }\n+\n+    CConfiguration configuration = injector.getInstance(CConfiguration.class);\n+\n+    if (configuration.getBoolean(Constants.Security.ENABLED)) {\n+\n+      services.add(new AbstractService() {\n+\n+        @Override\n+        protected void doStart() {\n+\n+          ZKClientService zkClientService = injector.getInstance(ZKClientService.class);\n+          ExternalAuthenticationServer authServer = injector.getInstance(ExternalAuthenticationServer.class);\n+\n+          try {\n+            LOG.info(\"Starting AuthenticationServer.\");\n+\n+            // Enable Kerberos login\n+            SecurityUtil.enableKerberosLogin(configuration);\n+\n+            io.cdap.cdap.common.service.Services.startAndWait(\n+                zkClientService,\n+                configuration.getLong(\n+                    Constants.Zookeeper.CLIENT_STARTUP_TIMEOUT_MILLIS),\n+                TimeUnit.MILLISECONDS,\n+                String.format(\n+                    \"Connection timed out while trying to start \" +\n+                        \"ZooKeeper client. Please verify that the \" +\n+                        \"ZooKeeper quorum settings are correct in \" +\n+                        \"cdap-site.xml. Currently configured as: %s\",\n+                    configuration.get(Constants.Zookeeper.QUORUM)));\n+            authServer.startAndWait();\n+\n+            notifyStarted();\n+          } catch (Exception e) {\n+            Throwable rootCause = Throwables.getRootCause(e);\n+            if (rootCause instanceof ServiceBindException) {\n+              LOG.error(\"Failed to start Authentication Server: {}\", rootCause.getMessage());\n+            } else {\n+              LOG.error(\"Failed to start Authentication Server\", e);\n+            }\n+          }\n+        }\n+\n+        @Override\n+        protected void doStop() {\n+\n+          ZKClientService zkClientService = injector.getInstance(ZKClientService.class);\n+          ExternalAuthenticationServer authServer = injector.getInstance(ExternalAuthenticationServer.class);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDUwMjg2MA=="}, "originalCommit": {"oid": "aaa465910fed4afeff95fab47e97270055860843"}, "originalPosition": 125}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzIwNTM5MA==", "bodyText": "Updated. Thanks!", "url": "https://github.com/cdapio/cdap/pull/12969#discussion_r563205390", "createdAt": "2021-01-23T22:08:12Z", "author": {"login": "edvinas-maciulis"}, "path": "cdap-master/src/main/java/io/cdap/cdap/master/environment/k8s/AuthenticationServiceMain.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Copyright \u00a9 2019 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.master.environment.k8s;\n+\n+import com.google.common.base.Throwables;\n+import com.google.common.util.concurrent.AbstractService;\n+import com.google.common.util.concurrent.Futures;\n+import com.google.common.util.concurrent.Service;\n+import com.google.inject.Injector;\n+import com.google.inject.Module;\n+import io.cdap.cdap.common.ServiceBindException;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.guice.ZKClientModule;\n+import io.cdap.cdap.common.logging.LoggingContext;\n+import io.cdap.cdap.common.logging.ServiceLoggingContext;\n+import io.cdap.cdap.master.spi.environment.MasterEnvironment;\n+import io.cdap.cdap.master.spi.environment.MasterEnvironmentContext;\n+import io.cdap.cdap.messaging.MessagingService;\n+import io.cdap.cdap.messaging.guice.MessagingClientModule;\n+import io.cdap.cdap.proto.id.NamespaceId;\n+import io.cdap.cdap.security.guice.SecurityModules;\n+import io.cdap.cdap.security.impersonation.SecurityUtil;\n+import io.cdap.cdap.security.server.ExternalAuthenticationServer;\n+import org.apache.twill.internal.Services;\n+import org.apache.twill.zookeeper.ZKClientService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * The main class responsible for Authentication  .\n+ */\n+public class AuthenticationServiceMain extends AbstractServiceMain<EnvironmentOptions> {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(AuthenticationServiceMain.class);\n+\n+  public static void main(String[] args) throws Exception {\n+    main(AuthenticationServiceMain.class, args);\n+  }\n+\n+  @Override\n+  protected List<Module> getServiceModules(\n+      MasterEnvironment masterEnv, EnvironmentOptions options, CConfiguration cConf) {\n+    return Arrays.asList(\n+        getDataFabricModule(),\n+        new ZKClientModule(),\n+        new SecurityModules().getDistributedModules(),\n+        new MessagingClientModule());\n+  }\n+\n+  @Override\n+  protected void addServices(\n+      Injector injector, List<? super Service> services, List<? super AutoCloseable> closeableResources,\n+      MasterEnvironment masterEnv, MasterEnvironmentContext masterEnvContext, EnvironmentOptions options) {\n+\n+    MessagingService messagingService = injector.getInstance(MessagingService.class);\n+    if (messagingService instanceof Service) {\n+      services.add((Service) messagingService);\n+    }\n+\n+    CConfiguration configuration = injector.getInstance(CConfiguration.class);\n+\n+    if (configuration.getBoolean(Constants.Security.ENABLED)) {\n+\n+      services.add(new AbstractService() {\n+\n+        @Override\n+        protected void doStart() {\n+\n+          ZKClientService zkClientService = injector.getInstance(ZKClientService.class);\n+          ExternalAuthenticationServer authServer = injector.getInstance(ExternalAuthenticationServer.class);\n+\n+          try {\n+            LOG.info(\"Starting AuthenticationServer.\");\n+\n+            // Enable Kerberos login\n+            SecurityUtil.enableKerberosLogin(configuration);\n+\n+            io.cdap.cdap.common.service.Services.startAndWait(\n+                zkClientService,\n+                configuration.getLong(\n+                    Constants.Zookeeper.CLIENT_STARTUP_TIMEOUT_MILLIS),\n+                TimeUnit.MILLISECONDS,\n+                String.format(\n+                    \"Connection timed out while trying to start \" +\n+                        \"ZooKeeper client. Please verify that the \" +\n+                        \"ZooKeeper quorum settings are correct in \" +\n+                        \"cdap-site.xml. Currently configured as: %s\",\n+                    configuration.get(Constants.Zookeeper.QUORUM)));\n+            authServer.startAndWait();\n+\n+            notifyStarted();\n+          } catch (Exception e) {\n+            Throwable rootCause = Throwables.getRootCause(e);\n+            if (rootCause instanceof ServiceBindException) {\n+              LOG.error(\"Failed to start Authentication Server: {}\", rootCause.getMessage());\n+            } else {\n+              LOG.error(\"Failed to start Authentication Server\", e);\n+            }\n+          }\n+        }\n+\n+        @Override\n+        protected void doStop() {\n+\n+          ZKClientService zkClientService = injector.getInstance(ZKClientService.class);\n+          ExternalAuthenticationServer authServer = injector.getInstance(ExternalAuthenticationServer.class);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDUwMjg2MA=="}, "originalCommit": {"oid": "aaa465910fed4afeff95fab47e97270055860843"}, "originalPosition": 125}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ5MDQ4MTE2OnYy", "diffSide": "RIGHT", "path": "cdap-master/src/main/java/io/cdap/cdap/master/environment/k8s/AuthenticationServiceMain.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMFQwMzoxMzoyNFrOIQ0LnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xOVQyMTo0MjoyMFrOIWjJ6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDUwMzA2OA==", "bodyText": "I don't quite get the idea of this service. It seems like both the ZKClientService and the ExternalAuthenticationServer has been started/stopped twice since they are also added in line 134, 135", "url": "https://github.com/cdapio/cdap/pull/12969#discussion_r554503068", "createdAt": "2021-01-10T03:13:24Z", "author": {"login": "chtyim"}, "path": "cdap-master/src/main/java/io/cdap/cdap/master/environment/k8s/AuthenticationServiceMain.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Copyright \u00a9 2019 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.master.environment.k8s;\n+\n+import com.google.common.base.Throwables;\n+import com.google.common.util.concurrent.AbstractService;\n+import com.google.common.util.concurrent.Futures;\n+import com.google.common.util.concurrent.Service;\n+import com.google.inject.Injector;\n+import com.google.inject.Module;\n+import io.cdap.cdap.common.ServiceBindException;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.guice.ZKClientModule;\n+import io.cdap.cdap.common.logging.LoggingContext;\n+import io.cdap.cdap.common.logging.ServiceLoggingContext;\n+import io.cdap.cdap.master.spi.environment.MasterEnvironment;\n+import io.cdap.cdap.master.spi.environment.MasterEnvironmentContext;\n+import io.cdap.cdap.messaging.MessagingService;\n+import io.cdap.cdap.messaging.guice.MessagingClientModule;\n+import io.cdap.cdap.proto.id.NamespaceId;\n+import io.cdap.cdap.security.guice.SecurityModules;\n+import io.cdap.cdap.security.impersonation.SecurityUtil;\n+import io.cdap.cdap.security.server.ExternalAuthenticationServer;\n+import org.apache.twill.internal.Services;\n+import org.apache.twill.zookeeper.ZKClientService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * The main class responsible for Authentication  .\n+ */\n+public class AuthenticationServiceMain extends AbstractServiceMain<EnvironmentOptions> {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(AuthenticationServiceMain.class);\n+\n+  public static void main(String[] args) throws Exception {\n+    main(AuthenticationServiceMain.class, args);\n+  }\n+\n+  @Override\n+  protected List<Module> getServiceModules(\n+      MasterEnvironment masterEnv, EnvironmentOptions options, CConfiguration cConf) {\n+    return Arrays.asList(\n+        getDataFabricModule(),\n+        new ZKClientModule(),\n+        new SecurityModules().getDistributedModules(),\n+        new MessagingClientModule());\n+  }\n+\n+  @Override\n+  protected void addServices(\n+      Injector injector, List<? super Service> services, List<? super AutoCloseable> closeableResources,\n+      MasterEnvironment masterEnv, MasterEnvironmentContext masterEnvContext, EnvironmentOptions options) {\n+\n+    MessagingService messagingService = injector.getInstance(MessagingService.class);\n+    if (messagingService instanceof Service) {\n+      services.add((Service) messagingService);\n+    }\n+\n+    CConfiguration configuration = injector.getInstance(CConfiguration.class);\n+\n+    if (configuration.getBoolean(Constants.Security.ENABLED)) {\n+\n+      services.add(new AbstractService() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aaa465910fed4afeff95fab47e97270055860843"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDUxNTU2MQ==", "bodyText": "Good point, updated.", "url": "https://github.com/cdapio/cdap/pull/12969#discussion_r560515561", "createdAt": "2021-01-19T21:42:20Z", "author": {"login": "edvinas-maciulis"}, "path": "cdap-master/src/main/java/io/cdap/cdap/master/environment/k8s/AuthenticationServiceMain.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Copyright \u00a9 2019 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.master.environment.k8s;\n+\n+import com.google.common.base.Throwables;\n+import com.google.common.util.concurrent.AbstractService;\n+import com.google.common.util.concurrent.Futures;\n+import com.google.common.util.concurrent.Service;\n+import com.google.inject.Injector;\n+import com.google.inject.Module;\n+import io.cdap.cdap.common.ServiceBindException;\n+import io.cdap.cdap.common.conf.CConfiguration;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.guice.ZKClientModule;\n+import io.cdap.cdap.common.logging.LoggingContext;\n+import io.cdap.cdap.common.logging.ServiceLoggingContext;\n+import io.cdap.cdap.master.spi.environment.MasterEnvironment;\n+import io.cdap.cdap.master.spi.environment.MasterEnvironmentContext;\n+import io.cdap.cdap.messaging.MessagingService;\n+import io.cdap.cdap.messaging.guice.MessagingClientModule;\n+import io.cdap.cdap.proto.id.NamespaceId;\n+import io.cdap.cdap.security.guice.SecurityModules;\n+import io.cdap.cdap.security.impersonation.SecurityUtil;\n+import io.cdap.cdap.security.server.ExternalAuthenticationServer;\n+import org.apache.twill.internal.Services;\n+import org.apache.twill.zookeeper.ZKClientService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * The main class responsible for Authentication  .\n+ */\n+public class AuthenticationServiceMain extends AbstractServiceMain<EnvironmentOptions> {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(AuthenticationServiceMain.class);\n+\n+  public static void main(String[] args) throws Exception {\n+    main(AuthenticationServiceMain.class, args);\n+  }\n+\n+  @Override\n+  protected List<Module> getServiceModules(\n+      MasterEnvironment masterEnv, EnvironmentOptions options, CConfiguration cConf) {\n+    return Arrays.asList(\n+        getDataFabricModule(),\n+        new ZKClientModule(),\n+        new SecurityModules().getDistributedModules(),\n+        new MessagingClientModule());\n+  }\n+\n+  @Override\n+  protected void addServices(\n+      Injector injector, List<? super Service> services, List<? super AutoCloseable> closeableResources,\n+      MasterEnvironment masterEnv, MasterEnvironmentContext masterEnvContext, EnvironmentOptions options) {\n+\n+    MessagingService messagingService = injector.getInstance(MessagingService.class);\n+    if (messagingService instanceof Service) {\n+      services.add((Service) messagingService);\n+    }\n+\n+    CConfiguration configuration = injector.getInstance(CConfiguration.class);\n+\n+    if (configuration.getBoolean(Constants.Security.ENABLED)) {\n+\n+      services.add(new AbstractService() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDUwMzA2OA=="}, "originalCommit": {"oid": "aaa465910fed4afeff95fab47e97270055860843"}, "originalPosition": 83}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2590, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}