{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU0Nzk5NDM0", "number": 12481, "title": "(CDAP-17095) Add support for Distribution in AutoJoiner API", "bodyText": "", "createdAt": "2020-07-21T23:36:19Z", "url": "https://github.com/cdapio/cdap/pull/12481", "merged": true, "mergeCommit": {"oid": "4d7292cd0c60589a6c9d009b9c2e1be39706fb61"}, "closed": true, "closedAt": "2020-07-27T23:19:53Z", "author": {"login": "MEseifan"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3PeEQAFqTQ1MjkwNDA0NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5KFiiABqjM1OTE5NTU1MDA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyOTA0MDQ0", "url": "https://github.com/cdapio/cdap/pull/12481#pullrequestreview-452904044", "createdAt": "2020-07-21T23:48:59Z", "commit": {"oid": "ff1af39d142a30dca205c996568d0b53e77fd23e"}, "state": "COMMENTED", "comments": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQyMzo0ODo1OVrOG1NvHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwMDoxMzoxMlrOG1OLhg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1Mjc2NA==", "bodyText": "Integer -> int, since we don't want it to ever be null", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r458452764", "createdAt": "2020-07-21T23:48:59Z", "author": {"login": "albertshau"}, "path": "cdap-app-templates/cdap-etl/cdap-etl-api/src/main/java/io/cdap/cdap/etl/api/join/JoinDefinition.java", "diffHunk": "@@ -121,11 +129,25 @@ public Builder setOutputSchemaName(@Nullable String name) {\n       return this;\n     }\n \n+    /**\n+     * Set the distribution factor and stage name of the skewed stage. This should be set if the join being performed\n+     * is skewed (ie. joining a large dataset with a small dataset) and the \"small\" dataset is too large to broadcast.\n+     *\n+     * @param size      The number of distributions to split each key into. Note that the smaller dataset will grow by\n+     *                  this factor, values greater than 20 are not recommended\n+     * @param stageName The name of the input stage that contains the skewed data\n+     * @return\n+     */\n+    public Builder setDistributionFactor(Integer size, String stageName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff1af39d142a30dca205c996568d0b53e77fd23e"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1MzAwNQ==", "bodyText": "Integer -> int", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r458453005", "createdAt": "2020-07-21T23:49:42Z", "author": {"login": "albertshau"}, "path": "cdap-app-templates/cdap-etl/cdap-etl-api/src/main/java/io/cdap/cdap/etl/api/join/JoinDistribution.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.etl.api.join;\n+\n+import io.cdap.cdap.etl.api.join.error.JoinError;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.List;\n+\n+/**\n+ * Join distribution settings for salting/exploding datasets to resolve skew\n+ */\n+public class JoinDistribution {\n+\n+  private final Integer distributionFactor;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff1af39d142a30dca205c996568d0b53e77fd23e"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1MzA4Ng==", "bodyText": "add space after )", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r458453086", "createdAt": "2020-07-21T23:49:57Z", "author": {"login": "albertshau"}, "path": "cdap-app-templates/cdap-etl/cdap-etl-api/src/main/java/io/cdap/cdap/etl/api/join/JoinDistribution.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.etl.api.join;\n+\n+import io.cdap.cdap.etl.api.join.error.JoinError;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.List;\n+\n+/**\n+ * Join distribution settings for salting/exploding datasets to resolve skew\n+ */\n+public class JoinDistribution {\n+\n+  private final Integer distributionFactor;\n+  private final String skewedStageName;\n+\n+  public JoinDistribution(Integer distributionFactor, String skewedStageName) {\n+    this.distributionFactor = distributionFactor;\n+    this.skewedStageName = skewedStageName;\n+  }\n+\n+  public Integer getDistributionFactor() {\n+    return distributionFactor;\n+  }\n+\n+  public String getSkewedStageName() {\n+    return skewedStageName;\n+  }\n+\n+  public Collection<JoinError> validate(Collection<String> stageNames) {\n+    List<JoinError> errors = new ArrayList<>();\n+\n+    if (stageNames.size() > 2) {\n+      errors.add(new JoinError(\"Only two stages can be specified if a distribution factor is specified\"));\n+    }\n+\n+    if (distributionFactor == null || skewedStageName == null) {\n+      errors.add(new JoinError(\"Distribution factor requires both size and skewed stage name to be defined\"));\n+    }\n+\n+    if (distributionFactor!= null && distributionFactor < 1){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff1af39d142a30dca205c996568d0b53e77fd23e"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1MzYzOA==", "bodyText": "this doesn't look like it belongs here, as these strings are a spark implementation detail.", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r458453638", "createdAt": "2020-07-21T23:51:39Z", "author": {"login": "albertshau"}, "path": "cdap-app-templates/cdap-etl/cdap-etl-api/src/main/java/io/cdap/cdap/etl/api/join/JoinDistribution.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.etl.api.join;\n+\n+import io.cdap.cdap.etl.api.join.error.JoinError;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.List;\n+\n+/**\n+ * Join distribution settings for salting/exploding datasets to resolve skew\n+ */\n+public class JoinDistribution {\n+\n+  private final Integer distributionFactor;\n+  private final String skewedStageName;\n+\n+  public JoinDistribution(Integer distributionFactor, String skewedStageName) {\n+    this.distributionFactor = distributionFactor;\n+    this.skewedStageName = skewedStageName;\n+  }\n+\n+  public Integer getDistributionFactor() {\n+    return distributionFactor;\n+  }\n+\n+  public String getSkewedStageName() {\n+    return skewedStageName;\n+  }\n+\n+  public Collection<JoinError> validate(Collection<String> stageNames) {\n+    List<JoinError> errors = new ArrayList<>();\n+\n+    if (stageNames.size() > 2) {\n+      errors.add(new JoinError(\"Only two stages can be specified if a distribution factor is specified\"));\n+    }\n+\n+    if (distributionFactor == null || skewedStageName == null) {\n+      errors.add(new JoinError(\"Distribution factor requires both size and skewed stage name to be defined\"));\n+    }\n+\n+    if (distributionFactor!= null && distributionFactor < 1){\n+      errors.add(new JoinError(\"Distribution size must be greater than 0\"));\n+    }\n+\n+    //If skewedStageName does not match any of the names in stages\n+    if (skewedStageName != null && !stageNames.contains(skewedStageName)) {\n+      errors.add(new JoinError(\n+        String.format(\"Skewed stage name '%s' does not match any of the specified stages\", skewedStageName\n+        )));\n+    }\n+    return errors;\n+  }\n+\n+  public static List<String> getSupportedJoinTypes(){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff1af39d142a30dca205c996568d0b53e77fd23e"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1NDUzNA==", "bodyText": "nit: can be specified -> can be joined", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r458454534", "createdAt": "2020-07-21T23:54:29Z", "author": {"login": "albertshau"}, "path": "cdap-app-templates/cdap-etl/cdap-etl-api/src/main/java/io/cdap/cdap/etl/api/join/JoinDistribution.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.etl.api.join;\n+\n+import io.cdap.cdap.etl.api.join.error.JoinError;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.List;\n+\n+/**\n+ * Join distribution settings for salting/exploding datasets to resolve skew\n+ */\n+public class JoinDistribution {\n+\n+  private final Integer distributionFactor;\n+  private final String skewedStageName;\n+\n+  public JoinDistribution(Integer distributionFactor, String skewedStageName) {\n+    this.distributionFactor = distributionFactor;\n+    this.skewedStageName = skewedStageName;\n+  }\n+\n+  public Integer getDistributionFactor() {\n+    return distributionFactor;\n+  }\n+\n+  public String getSkewedStageName() {\n+    return skewedStageName;\n+  }\n+\n+  public Collection<JoinError> validate(Collection<String> stageNames) {\n+    List<JoinError> errors = new ArrayList<>();\n+\n+    if (stageNames.size() > 2) {\n+      errors.add(new JoinError(\"Only two stages can be specified if a distribution factor is specified\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98597b426c327030b458967e156a33c67c4856a6"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1NDc3MQ==", "bodyText": "should also check that this is an inner or left outer join, which just means checking that the skewed stage is required. Should also check that neither stage is being broadcast, as there is no point salting if a broadcast is done. You'll have to change the input to be the JoinStages instead of just the names.", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r458454771", "createdAt": "2020-07-21T23:55:12Z", "author": {"login": "albertshau"}, "path": "cdap-app-templates/cdap-etl/cdap-etl-api/src/main/java/io/cdap/cdap/etl/api/join/JoinDistribution.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.etl.api.join;\n+\n+import io.cdap.cdap.etl.api.join.error.JoinError;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.List;\n+\n+/**\n+ * Join distribution settings for salting/exploding datasets to resolve skew\n+ */\n+public class JoinDistribution {\n+\n+  private final Integer distributionFactor;\n+  private final String skewedStageName;\n+\n+  public JoinDistribution(Integer distributionFactor, String skewedStageName) {\n+    this.distributionFactor = distributionFactor;\n+    this.skewedStageName = skewedStageName;\n+  }\n+\n+  public Integer getDistributionFactor() {\n+    return distributionFactor;\n+  }\n+\n+  public String getSkewedStageName() {\n+    return skewedStageName;\n+  }\n+\n+  public Collection<JoinError> validate(Collection<String> stageNames) {\n+    List<JoinError> errors = new ArrayList<>();\n+\n+    if (stageNames.size() > 2) {\n+      errors.add(new JoinError(\"Only two stages can be specified if a distribution factor is specified\"));\n+    }\n+\n+    if (distributionFactor == null || skewedStageName == null) {\n+      errors.add(new JoinError(\"Distribution factor requires both size and skewed stage name to be defined\"));\n+    }\n+\n+    if (distributionFactor != null && distributionFactor < 1) {\n+      errors.add(new JoinError(\"Distribution size must be greater than 0\"));\n+    }\n+\n+    //If skewedStageName does not match any of the names in stages\n+    if (skewedStageName != null && !stageNames.contains(skewedStageName)) {\n+      errors.add(new JoinError(\n+        String.format(\"Skewed stage name '%s' does not match any of the specified stages\", skewedStageName\n+        )));\n+    }\n+    return errors;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98597b426c327030b458967e156a33c67c4856a6"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1NTM2NQ==", "bodyText": "this fits better in the spark code, as \"inner\" and \"leftouter\" are the string values used by spark and not used anywhere by this class.", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r458455365", "createdAt": "2020-07-21T23:57:01Z", "author": {"login": "albertshau"}, "path": "cdap-app-templates/cdap-etl/cdap-etl-api/src/main/java/io/cdap/cdap/etl/api/join/JoinDistribution.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.etl.api.join;\n+\n+import io.cdap.cdap.etl.api.join.error.JoinError;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.List;\n+\n+/**\n+ * Join distribution settings for salting/exploding datasets to resolve skew\n+ */\n+public class JoinDistribution {\n+\n+  private final Integer distributionFactor;\n+  private final String skewedStageName;\n+\n+  public JoinDistribution(Integer distributionFactor, String skewedStageName) {\n+    this.distributionFactor = distributionFactor;\n+    this.skewedStageName = skewedStageName;\n+  }\n+\n+  public Integer getDistributionFactor() {\n+    return distributionFactor;\n+  }\n+\n+  public String getSkewedStageName() {\n+    return skewedStageName;\n+  }\n+\n+  public Collection<JoinError> validate(Collection<String> stageNames) {\n+    List<JoinError> errors = new ArrayList<>();\n+\n+    if (stageNames.size() > 2) {\n+      errors.add(new JoinError(\"Only two stages can be specified if a distribution factor is specified\"));\n+    }\n+\n+    if (distributionFactor == null || skewedStageName == null) {\n+      errors.add(new JoinError(\"Distribution factor requires both size and skewed stage name to be defined\"));\n+    }\n+\n+    if (distributionFactor != null && distributionFactor < 1) {\n+      errors.add(new JoinError(\"Distribution size must be greater than 0\"));\n+    }\n+\n+    //If skewedStageName does not match any of the names in stages\n+    if (skewedStageName != null && !stageNames.contains(skewedStageName)) {\n+      errors.add(new JoinError(\n+        String.format(\"Skewed stage name '%s' does not match any of the specified stages\", skewedStageName\n+        )));\n+    }\n+    return errors;\n+  }\n+\n+  public static List<String> getSupportedJoinTypes() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98597b426c327030b458967e156a33c67c4856a6"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1NTQ5Ng==", "bodyText": "annotate as nullable", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r458455496", "createdAt": "2020-07-21T23:57:30Z", "author": {"login": "albertshau"}, "path": "cdap-app-templates/cdap-etl/hydrator-spark-core-base/src/main/java/io/cdap/cdap/etl/spark/join/JoinRequest.java", "diffHunk": "@@ -36,10 +37,11 @@\n   private final Schema outputSchema;\n   private final List<JoinCollection> toJoin;\n   private final Integer numPartitions;\n+  private final JoinDistribution distribution;\n \n   public JoinRequest(String stageName, String leftStage, List<String> leftKey, Schema leftSchema, boolean leftRequired,\n                      boolean nullSafe, List<JoinField> fields, Schema outputSchema, List<JoinCollection> toJoin,\n-                     @Nullable Integer numPartitions) {\n+                     @Nullable Integer numPartitions, JoinDistribution distribution) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98597b426c327030b458967e156a33c67c4856a6"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1NTUxNA==", "bodyText": "annotate as nullable", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r458455514", "createdAt": "2020-07-21T23:57:33Z", "author": {"login": "albertshau"}, "path": "cdap-app-templates/cdap-etl/hydrator-spark-core-base/src/main/java/io/cdap/cdap/etl/spark/join/JoinRequest.java", "diffHunk": "@@ -50,6 +52,11 @@ public JoinRequest(String stageName, String leftStage, List<String> leftKey, Sch\n     this.outputSchema = outputSchema;\n     this.toJoin = toJoin;\n     this.numPartitions = numPartitions;\n+    this.distribution = distribution;\n+  }\n+\n+  public JoinDistribution getDistribution() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98597b426c327030b458967e156a33c67c4856a6"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1NTk3OQ==", "bodyText": "does the hardcoded udf name cause an issue if there are multiple salted joins that use different distribution factors?", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r458455979", "createdAt": "2020-07-21T23:59:13Z", "author": {"login": "albertshau"}, "path": "cdap-app-templates/cdap-etl/hydrator-spark-core/src/main/java/io/cdap/cdap/etl/spark/batch/RDDCollection.java", "diffHunk": "@@ -123,6 +126,54 @@ public RDDCollection(JavaSparkExecutionContext sec, JavaSparkContext jsc, SQLCon\n       }\n       seenRequired = seenRequired || toJoin.isRequired();\n \n+      // UUID for salt column name to avoid name collisions\n+      String saltColumn = UUID.randomUUID().toString();\n+      if (joinRequest.isDistributionEnabled() && JoinDistribution.getSupportedJoinTypes().contains(joinType)) {\n+\n+        final String SALT_UDF = \"salt\";\n+        final String PREPARE_EXPLODE_UDF = \"prepare_explode\";\n+\n+        //Array of [0,distributionFactor) to be used in the PrepareExplode step\n+        Integer[] numbers =\n+          IntStream.range(0, joinRequest.getDistribution().getDistributionFactor()).boxed().toArray(Integer[]::new);\n+\n+        // Register UserDefinedFunctions for use later\n+        sqlContext.udf().register(PREPARE_EXPLODE_UDF, prepareExplodeUDF(numbers),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98597b426c327030b458967e156a33c67c4856a6"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1NjUxMA==", "bodyText": "capitalized variables should be static (I thought checkstyle would complain about this?)", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r458456510", "createdAt": "2020-07-22T00:01:00Z", "author": {"login": "albertshau"}, "path": "cdap-app-templates/cdap-etl/hydrator-spark-core/src/main/java/io/cdap/cdap/etl/spark/batch/RDDCollection.java", "diffHunk": "@@ -123,6 +126,54 @@ public RDDCollection(JavaSparkExecutionContext sec, JavaSparkContext jsc, SQLCon\n       }\n       seenRequired = seenRequired || toJoin.isRequired();\n \n+      // UUID for salt column name to avoid name collisions\n+      String saltColumn = UUID.randomUUID().toString();\n+      if (joinRequest.isDistributionEnabled() && JoinDistribution.getSupportedJoinTypes().contains(joinType)) {\n+\n+        final String SALT_UDF = \"salt\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98597b426c327030b458967e156a33c67c4856a6"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1NzAyOA==", "bodyText": "it may be more straightforward to map the RDDs before changing them to DataFrames instead of using UDFs.", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r458457028", "createdAt": "2020-07-22T00:02:38Z", "author": {"login": "albertshau"}, "path": "cdap-app-templates/cdap-etl/hydrator-spark-core/src/main/java/io/cdap/cdap/etl/spark/batch/RDDCollection.java", "diffHunk": "@@ -123,6 +126,54 @@ public RDDCollection(JavaSparkExecutionContext sec, JavaSparkContext jsc, SQLCon\n       }\n       seenRequired = seenRequired || toJoin.isRequired();\n \n+      // UUID for salt column name to avoid name collisions\n+      String saltColumn = UUID.randomUUID().toString();\n+      if (joinRequest.isDistributionEnabled() && JoinDistribution.getSupportedJoinTypes().contains(joinType)) {\n+\n+        final String SALT_UDF = \"salt\";\n+        final String PREPARE_EXPLODE_UDF = \"prepare_explode\";\n+\n+        //Array of [0,distributionFactor) to be used in the PrepareExplode step\n+        Integer[] numbers =\n+          IntStream.range(0, joinRequest.getDistribution().getDistributionFactor()).boxed().toArray(Integer[]::new);\n+\n+        // Register UserDefinedFunctions for use later\n+        sqlContext.udf().register(PREPARE_EXPLODE_UDF, prepareExplodeUDF(numbers),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1NTk3OQ=="}, "originalCommit": {"oid": "98597b426c327030b458967e156a33c67c4856a6"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1NzI5MQ==", "bodyText": "don't need to be final", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r458457291", "createdAt": "2020-07-22T00:03:35Z", "author": {"login": "albertshau"}, "path": "cdap-app-templates/cdap-etl/hydrator-spark-core/src/main/java/io/cdap/cdap/etl/spark/batch/RDDCollection.java", "diffHunk": "@@ -123,6 +126,54 @@ public RDDCollection(JavaSparkExecutionContext sec, JavaSparkContext jsc, SQLCon\n       }\n       seenRequired = seenRequired || toJoin.isRequired();\n \n+      // UUID for salt column name to avoid name collisions\n+      String saltColumn = UUID.randomUUID().toString();\n+      if (joinRequest.isDistributionEnabled() && JoinDistribution.getSupportedJoinTypes().contains(joinType)) {\n+\n+        final String saltUDF = \"salt\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "81e9240e907c036f15eaaaf0c7529d4bf1498a18"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1NzQ3OA==", "bodyText": "is the name supposed to be unique? Seems like there would be issues if multiple salted joins are in the same pipeline, but they both use different distribution factors.", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r458457478", "createdAt": "2020-07-22T00:04:10Z", "author": {"login": "albertshau"}, "path": "cdap-app-templates/cdap-etl/hydrator-spark-core/src/main/java/io/cdap/cdap/etl/spark/batch/RDDCollection.java", "diffHunk": "@@ -123,6 +126,54 @@ public RDDCollection(JavaSparkExecutionContext sec, JavaSparkContext jsc, SQLCon\n       }\n       seenRequired = seenRequired || toJoin.isRequired();\n \n+      // UUID for salt column name to avoid name collisions\n+      String saltColumn = UUID.randomUUID().toString();\n+      if (joinRequest.isDistributionEnabled() && JoinDistribution.getSupportedJoinTypes().contains(joinType)) {\n+\n+        final String saltUDF = \"salt\";\n+        final String prepareExplodeUDF = \"prepare_explode\";\n+\n+        //Array of [0,distributionFactor) to be used in the PrepareExplode step\n+        Integer[] numbers =\n+          IntStream.range(0, joinRequest.getDistribution().getDistributionFactor()).boxed().toArray(Integer[]::new);\n+\n+        // Register UserDefinedFunctions for use later\n+        sqlContext.udf().register(prepareExplodeUDF, prepareExplodeUDF(numbers),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "81e9240e907c036f15eaaaf0c7529d4bf1498a18"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1ODYyNQ==", "bodyText": "shouldn't ignore case, stage names are case sensitive.", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r458458625", "createdAt": "2020-07-22T00:08:05Z", "author": {"login": "albertshau"}, "path": "cdap-app-templates/cdap-etl/hydrator-spark-core/src/main/java/io/cdap/cdap/etl/spark/batch/RDDCollection.java", "diffHunk": "@@ -123,6 +126,54 @@ public RDDCollection(JavaSparkExecutionContext sec, JavaSparkContext jsc, SQLCon\n       }\n       seenRequired = seenRequired || toJoin.isRequired();\n \n+      // UUID for salt column name to avoid name collisions\n+      String saltColumn = UUID.randomUUID().toString();\n+      if (joinRequest.isDistributionEnabled() && JoinDistribution.getSupportedJoinTypes().contains(joinType)) {\n+\n+        final String saltUDF = \"salt\";\n+        final String prepareExplodeUDF = \"prepare_explode\";\n+\n+        //Array of [0,distributionFactor) to be used in the PrepareExplode step\n+        Integer[] numbers =\n+          IntStream.range(0, joinRequest.getDistribution().getDistributionFactor()).boxed().toArray(Integer[]::new);\n+\n+        // Register UserDefinedFunctions for use later\n+        sqlContext.udf().register(prepareExplodeUDF, prepareExplodeUDF(numbers),\n+                                  DataTypes.createArrayType(DataTypes.IntegerType));\n+        sqlContext.udf().register(saltUDF, saltUDF(joinRequest.getDistribution().getDistributionFactor()),\n+                                  DataTypes.IntegerType);\n+\n+        // Assign the correct UFD to each side depending on the skew\n+        boolean isLeftStageSkewed =\n+          joinRequest.getLeftStage().equalsIgnoreCase(joinRequest.getDistribution().getSkewedStageName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "81e9240e907c036f15eaaaf0c7529d4bf1498a18"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1ODc5NA==", "bodyText": "could this be done without a UDF? maybe using a combination of rand, multiplication, and floor?", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r458458794", "createdAt": "2020-07-22T00:08:48Z", "author": {"login": "albertshau"}, "path": "cdap-app-templates/cdap-etl/hydrator-spark-core/src/main/java/io/cdap/cdap/etl/spark/batch/RDDCollection.java", "diffHunk": "@@ -123,6 +126,54 @@ public RDDCollection(JavaSparkExecutionContext sec, JavaSparkContext jsc, SQLCon\n       }\n       seenRequired = seenRequired || toJoin.isRequired();\n \n+      // UUID for salt column name to avoid name collisions\n+      String saltColumn = UUID.randomUUID().toString();\n+      if (joinRequest.isDistributionEnabled() && JoinDistribution.getSupportedJoinTypes().contains(joinType)) {\n+\n+        final String saltUDF = \"salt\";\n+        final String prepareExplodeUDF = \"prepare_explode\";\n+\n+        //Array of [0,distributionFactor) to be used in the PrepareExplode step\n+        Integer[] numbers =\n+          IntStream.range(0, joinRequest.getDistribution().getDistributionFactor()).boxed().toArray(Integer[]::new);\n+\n+        // Register UserDefinedFunctions for use later\n+        sqlContext.udf().register(prepareExplodeUDF, prepareExplodeUDF(numbers),\n+                                  DataTypes.createArrayType(DataTypes.IntegerType));\n+        sqlContext.udf().register(saltUDF, saltUDF(joinRequest.getDistribution().getDistributionFactor()),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "81e9240e907c036f15eaaaf0c7529d4bf1498a18"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1OTQwNA==", "bodyText": "could this be done without a UDF? If there's a way to give a constant value followed by an explode?", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r458459404", "createdAt": "2020-07-22T00:10:47Z", "author": {"login": "albertshau"}, "path": "cdap-app-templates/cdap-etl/hydrator-spark-core/src/main/java/io/cdap/cdap/etl/spark/batch/RDDCollection.java", "diffHunk": "@@ -123,6 +126,54 @@ public RDDCollection(JavaSparkExecutionContext sec, JavaSparkContext jsc, SQLCon\n       }\n       seenRequired = seenRequired || toJoin.isRequired();\n \n+      // UUID for salt column name to avoid name collisions\n+      String saltColumn = UUID.randomUUID().toString();\n+      if (joinRequest.isDistributionEnabled() && JoinDistribution.getSupportedJoinTypes().contains(joinType)) {\n+\n+        final String saltUDF = \"salt\";\n+        final String prepareExplodeUDF = \"prepare_explode\";\n+\n+        //Array of [0,distributionFactor) to be used in the PrepareExplode step\n+        Integer[] numbers =\n+          IntStream.range(0, joinRequest.getDistribution().getDistributionFactor()).boxed().toArray(Integer[]::new);\n+\n+        // Register UserDefinedFunctions for use later\n+        sqlContext.udf().register(prepareExplodeUDF, prepareExplodeUDF(numbers),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1NzQ3OA=="}, "originalCommit": {"oid": "81e9240e907c036f15eaaaf0c7529d4bf1498a18"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1OTgzMA==", "bodyText": "JoinDistribution should validate the join type earlier, which will let you remove the type check.", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r458459830", "createdAt": "2020-07-22T00:12:18Z", "author": {"login": "albertshau"}, "path": "cdap-app-templates/cdap-etl/hydrator-spark-core/src/main/java/io/cdap/cdap/etl/spark/batch/RDDCollection.java", "diffHunk": "@@ -131,11 +182,20 @@ public RDDCollection(JavaSparkExecutionContext sec, JavaSparkContext jsc, SQLCon\n       // which allows us to use a different number of partitions per joiner instead of using the global\n       // spark.sql.shuffle.partitions setting in the spark conf\n       if (joinPartitions != null && !toJoin.isBroadcast()) {\n-        right = partitionOnKey(right, toJoin.getKey(), joinRequest.isNullSafe(), sparkSchema, joinPartitions);\n+        List<String> rightKeys = new ArrayList<>(toJoin.getKey());\n+        List<String> leftKeys = new ArrayList<>(joinRequest.getLeftKey());\n+\n+        // If distribution is enabled we need to add it to the partition keys to ensure we end up with the desired\n+        // number of partitions\n+        if (joinRequest.isDistributionEnabled() && JoinDistribution.getSupportedJoinTypes().contains(joinType)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "81e9240e907c036f15eaaaf0c7529d4bf1498a18"}, "originalPosition": 115}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1OTk4OQ==", "bodyText": "unintended newline?", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r458459989", "createdAt": "2020-07-22T00:13:00Z", "author": {"login": "albertshau"}, "path": "cdap-app-templates/cdap-etl/hydrator-spark-core/src/main/java/io/cdap/cdap/etl/spark/batch/RDDCollection.java", "diffHunk": "@@ -171,14 +231,16 @@ followed by (TMP1 inner join C on TMP1.B.id = C.id) as OUT\n \n     // select and alias fields in the expected order\n     List<Column> outputColumns = new ArrayList<>(joinRequest.getFields().size());\n-    for (JoinField field : joinRequest.getFields()) {\n+    for (\n+      JoinField field : joinRequest.getFields()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "81e9240e907c036f15eaaaf0c7529d4bf1498a18"}, "originalPosition": 134}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ2MDAzOA==", "bodyText": "unintended new space?", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r458460038", "createdAt": "2020-07-22T00:13:12Z", "author": {"login": "albertshau"}, "path": "cdap-app-templates/cdap-etl/hydrator-test/src/main/java/io/cdap/cdap/etl/mock/batch/joiner/MockAutoJoiner.java", "diffHunk": "@@ -59,7 +60,7 @@\n   public static final PluginClass PLUGIN_CLASS = getPluginClass();\n   private static final Gson GSON = new Gson();\n   private static final Type LIST = new TypeToken<List<String>>() { }.getType();\n-  private static final Type SELECT_TYPE = new TypeToken<List<JoinField>>() { }.getType();\n+  private static final Type SELECT_TYPE = new TypeToken<List<JoinField>>() {  }.getType();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "81e9240e907c036f15eaaaf0c7529d4bf1498a18"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzNzI0MDA0", "url": "https://github.com/cdapio/cdap/pull/12481#pullrequestreview-453724004", "createdAt": "2020-07-22T22:17:23Z", "commit": {"oid": "d118de2437020318d2b504356837765a3fbe0457"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQyMjoxNzoyNFrOG12KRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQyMjoxODo0NFrOG12MXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTExNTA3Nw==", "bodyText": "This check can be combined with previous one:\nJoinStage leftStage = stages.stream().filter(s -> s.getStageName().equals(skewedStageName)).findFirst().orElse(null);\n\nif (leftStage == null) {\n  errors.add(new JoinError(\n        String.format(\"Skewed stage name '%s' does not match any of the specified stages\", skewedStageName\n        )));\n} else if (!leftStage.isRequired()) {\n  ...\n}", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r459115077", "createdAt": "2020-07-22T22:17:24Z", "author": {"login": "chtyim"}, "path": "cdap-app-templates/cdap-etl/cdap-etl-api/src/main/java/io/cdap/cdap/etl/api/join/JoinDistribution.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.etl.api.join;\n+\n+import io.cdap.cdap.etl.api.join.error.JoinError;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Join distribution settings for salting/exploding datasets to resolve skew\n+ */\n+public class JoinDistribution {\n+\n+  private final int distributionFactor;\n+  private final String skewedStageName;\n+\n+  public JoinDistribution(Integer distributionFactor, String skewedStageName) {\n+    this.distributionFactor = distributionFactor;\n+    this.skewedStageName = skewedStageName;\n+  }\n+\n+  public int getDistributionFactor() {\n+    return distributionFactor;\n+  }\n+\n+  public String getSkewedStageName() {\n+    return skewedStageName;\n+  }\n+\n+  public Collection<JoinError> validate(List<JoinStage> stages) {\n+    List<JoinError> errors = new ArrayList<>();\n+\n+    if (stages.size() > 2) {\n+      errors.add(new JoinError(\"Only two stages can be joined if a distribution factor is specified\"));\n+    }\n+\n+    if (skewedStageName == null) {\n+      errors.add(new JoinError(\"Distribution requires skewed stage name to be defined\"));\n+    }\n+\n+    if (distributionFactor < 1) {\n+      errors.add(new JoinError(\"Distribution size must be greater than 0\"));\n+    }\n+\n+    //If skewedStageName does not match any of the names in stages\n+    List<String> stageNames = stages.stream().map(JoinStage::getStageName).collect(Collectors.toList());\n+    if (skewedStageName != null && !stageNames.contains(skewedStageName)) {\n+      errors.add(new JoinError(\n+        String.format(\"Skewed stage name '%s' does not match any of the specified stages\", skewedStageName\n+        )));\n+    }\n+\n+    JoinStage leftStage = stages.stream().filter(s -> s.getStageName().equals(skewedStageName)).findFirst().get();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d118de2437020318d2b504356837765a3fbe0457"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTExNTYxNA==", "bodyText": "Use if (stages.stream().anyMatch(JoinStage::isBroadcast))", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r459115614", "createdAt": "2020-07-22T22:18:44Z", "author": {"login": "chtyim"}, "path": "cdap-app-templates/cdap-etl/cdap-etl-api/src/main/java/io/cdap/cdap/etl/api/join/JoinDistribution.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.etl.api.join;\n+\n+import io.cdap.cdap.etl.api.join.error.JoinError;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Join distribution settings for salting/exploding datasets to resolve skew\n+ */\n+public class JoinDistribution {\n+\n+  private final int distributionFactor;\n+  private final String skewedStageName;\n+\n+  public JoinDistribution(Integer distributionFactor, String skewedStageName) {\n+    this.distributionFactor = distributionFactor;\n+    this.skewedStageName = skewedStageName;\n+  }\n+\n+  public int getDistributionFactor() {\n+    return distributionFactor;\n+  }\n+\n+  public String getSkewedStageName() {\n+    return skewedStageName;\n+  }\n+\n+  public Collection<JoinError> validate(List<JoinStage> stages) {\n+    List<JoinError> errors = new ArrayList<>();\n+\n+    if (stages.size() > 2) {\n+      errors.add(new JoinError(\"Only two stages can be joined if a distribution factor is specified\"));\n+    }\n+\n+    if (skewedStageName == null) {\n+      errors.add(new JoinError(\"Distribution requires skewed stage name to be defined\"));\n+    }\n+\n+    if (distributionFactor < 1) {\n+      errors.add(new JoinError(\"Distribution size must be greater than 0\"));\n+    }\n+\n+    //If skewedStageName does not match any of the names in stages\n+    List<String> stageNames = stages.stream().map(JoinStage::getStageName).collect(Collectors.toList());\n+    if (skewedStageName != null && !stageNames.contains(skewedStageName)) {\n+      errors.add(new JoinError(\n+        String.format(\"Skewed stage name '%s' does not match any of the specified stages\", skewedStageName\n+        )));\n+    }\n+\n+    JoinStage leftStage = stages.stream().filter(s -> s.getStageName().equals(skewedStageName)).findFirst().get();\n+    if (!leftStage.isRequired()) {\n+      errors.add(new JoinError(\"Distribution only supports inner or left outer joins, the skewed side of the join \" +\n+                                 \"must be required\"));\n+    }\n+\n+    if (stages.get(0).isBroadcast() || stages.get(1).isBroadcast()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d118de2437020318d2b504356837765a3fbe0457"}, "originalPosition": 76}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dcfdaed1491fb10cd0098e5e430f44e5c66ba4fb", "author": {"user": {"login": "MEseifan", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/dcfdaed1491fb10cd0098e5e430f44e5c66ba4fb", "committedDate": "2020-07-23T00:01:48Z", "message": "Addressed more comments"}, "afterCommit": {"oid": "ea98bed5d7cb76fa7ceb0558aeba4022acf296e8", "author": {"user": {"login": "MEseifan", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/ea98bed5d7cb76fa7ceb0558aeba4022acf296e8", "committedDate": "2020-07-23T21:49:51Z", "message": "(CDAP-17095) Add support for Distribution in AutoJoiner API"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2MDAyMzU1", "url": "https://github.com/cdapio/cdap/pull/12481#pullrequestreview-456002355", "createdAt": "2020-07-27T17:46:52Z", "commit": {"oid": "ea98bed5d7cb76fa7ceb0558aeba4022acf296e8"}, "state": "APPROVED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxNzo0Njo1M1rOG3tBfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxNzo1NTo0OVrOG3tV9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA2MjUyNw==", "bodyText": "can you add a line about how the given stage must be a required stage, and no stage should be broadcast.", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r461062527", "createdAt": "2020-07-27T17:46:53Z", "author": {"login": "albertshau"}, "path": "cdap-app-templates/cdap-etl/cdap-etl-api/src/main/java/io/cdap/cdap/etl/api/join/JoinDefinition.java", "diffHunk": "@@ -121,11 +129,25 @@ public Builder setOutputSchemaName(@Nullable String name) {\n       return this;\n     }\n \n+    /**\n+     * Set the distribution factor and stage name of the skewed stage. This should be set if the join being performed\n+     * is skewed (ie. joining a large dataset with a small dataset) and the \"small\" dataset is too large to broadcast.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea98bed5d7cb76fa7ceb0558aeba4022acf296e8"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA2Mjk3Nw==", "bodyText": "indentation", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r461062977", "createdAt": "2020-07-27T17:47:39Z", "author": {"login": "albertshau"}, "path": "cdap-app-templates/cdap-etl/cdap-etl-api/src/main/java/io/cdap/cdap/etl/api/join/JoinDistribution.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.etl.api.join;\n+\n+import io.cdap.cdap.etl.api.join.error.JoinError;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.List;\n+\n+/**\n+ * Join distribution settings for salting/exploding datasets to resolve skew\n+ */\n+public class JoinDistribution {\n+\n+  private final int distributionFactor;\n+  private final String skewedStageName;\n+\n+  public JoinDistribution(Integer distributionFactor, String skewedStageName) {\n+    this.distributionFactor = distributionFactor;\n+    this.skewedStageName = skewedStageName;\n+  }\n+\n+  public int getDistributionFactor() {\n+    return distributionFactor;\n+  }\n+\n+  public String getSkewedStageName() {\n+    return skewedStageName;\n+  }\n+\n+  public Collection<JoinError> validate(List<JoinStage> stages) {\n+    List<JoinError> errors = new ArrayList<>();\n+\n+    if (stages.size() > 2) {\n+      errors.add(new JoinError(\"Only two stages can be joined if a distribution factor is specified\"));\n+    }\n+\n+    if (skewedStageName == null) {\n+      errors.add(new JoinError(\"Distribution requires skewed stage name to be defined\"));\n+    }\n+\n+    if (distributionFactor < 1) {\n+      errors.add(new JoinError(\"Distribution size must be greater than 0\"));\n+    }\n+\n+    //If skewedStageName does not match any of the names in stages\n+    JoinStage leftStage = stages.stream().filter(s -> s.getStageName().equals(skewedStageName)).findFirst()\n+                                .orElse(null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea98bed5d7cb76fa7ceb0558aeba4022acf296e8"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA2MzUwNg==", "bodyText": "include the stage name in the message, similar to what you have above.", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r461063506", "createdAt": "2020-07-27T17:48:39Z", "author": {"login": "albertshau"}, "path": "cdap-app-templates/cdap-etl/cdap-etl-api/src/main/java/io/cdap/cdap/etl/api/join/JoinDistribution.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.etl.api.join;\n+\n+import io.cdap.cdap.etl.api.join.error.JoinError;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.List;\n+\n+/**\n+ * Join distribution settings for salting/exploding datasets to resolve skew\n+ */\n+public class JoinDistribution {\n+\n+  private final int distributionFactor;\n+  private final String skewedStageName;\n+\n+  public JoinDistribution(Integer distributionFactor, String skewedStageName) {\n+    this.distributionFactor = distributionFactor;\n+    this.skewedStageName = skewedStageName;\n+  }\n+\n+  public int getDistributionFactor() {\n+    return distributionFactor;\n+  }\n+\n+  public String getSkewedStageName() {\n+    return skewedStageName;\n+  }\n+\n+  public Collection<JoinError> validate(List<JoinStage> stages) {\n+    List<JoinError> errors = new ArrayList<>();\n+\n+    if (stages.size() > 2) {\n+      errors.add(new JoinError(\"Only two stages can be joined if a distribution factor is specified\"));\n+    }\n+\n+    if (skewedStageName == null) {\n+      errors.add(new JoinError(\"Distribution requires skewed stage name to be defined\"));\n+    }\n+\n+    if (distributionFactor < 1) {\n+      errors.add(new JoinError(\"Distribution size must be greater than 0\"));\n+    }\n+\n+    //If skewedStageName does not match any of the names in stages\n+    JoinStage leftStage = stages.stream().filter(s -> s.getStageName().equals(skewedStageName)).findFirst()\n+                                .orElse(null);\n+\n+    if (leftStage == null) {\n+      errors.add(new JoinError(\n+        String.format(\"Skewed stage name '%s' does not match any of the specified stages\", skewedStageName\n+        )));\n+    } else if (!leftStage.isRequired()) {\n+      errors.add(new JoinError(\"Distribution only supports inner or left outer joins, the skewed side of the join \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea98bed5d7cb76fa7ceb0558aeba4022acf296e8"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA2NTAyMQ==", "bodyText": "nit: stage name -> stage", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r461065021", "createdAt": "2020-07-27T17:51:10Z", "author": {"login": "albertshau"}, "path": "cdap-app-templates/cdap-etl/cdap-etl-api/src/main/java/io/cdap/cdap/etl/api/join/JoinDistribution.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.etl.api.join;\n+\n+import io.cdap.cdap.etl.api.join.error.JoinError;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.List;\n+\n+/**\n+ * Join distribution settings for salting/exploding datasets to resolve skew\n+ */\n+public class JoinDistribution {\n+\n+  private final int distributionFactor;\n+  private final String skewedStageName;\n+\n+  public JoinDistribution(Integer distributionFactor, String skewedStageName) {\n+    this.distributionFactor = distributionFactor;\n+    this.skewedStageName = skewedStageName;\n+  }\n+\n+  public int getDistributionFactor() {\n+    return distributionFactor;\n+  }\n+\n+  public String getSkewedStageName() {\n+    return skewedStageName;\n+  }\n+\n+  public Collection<JoinError> validate(List<JoinStage> stages) {\n+    List<JoinError> errors = new ArrayList<>();\n+\n+    if (stages.size() > 2) {\n+      errors.add(new JoinError(\"Only two stages can be joined if a distribution factor is specified\"));\n+    }\n+\n+    if (skewedStageName == null) {\n+      errors.add(new JoinError(\"Distribution requires skewed stage name to be defined\"));\n+    }\n+\n+    if (distributionFactor < 1) {\n+      errors.add(new JoinError(\"Distribution size must be greater than 0\"));\n+    }\n+\n+    //If skewedStageName does not match any of the names in stages\n+    JoinStage leftStage = stages.stream().filter(s -> s.getStageName().equals(skewedStageName)).findFirst()\n+                                .orElse(null);\n+\n+    if (leftStage == null) {\n+      errors.add(new JoinError(\n+        String.format(\"Skewed stage name '%s' does not match any of the specified stages\", skewedStageName", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea98bed5d7cb76fa7ceb0558aeba4022acf296e8"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA2NTY4Mw==", "bodyText": "nit: is not needed -> cannot be used\n\"is not needed\" sounds like a warning that can be ignored, whereas here we are failing.", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r461065683", "createdAt": "2020-07-27T17:52:19Z", "author": {"login": "albertshau"}, "path": "cdap-app-templates/cdap-etl/cdap-etl-api/src/main/java/io/cdap/cdap/etl/api/join/JoinDistribution.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.etl.api.join;\n+\n+import io.cdap.cdap.etl.api.join.error.JoinError;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.List;\n+\n+/**\n+ * Join distribution settings for salting/exploding datasets to resolve skew\n+ */\n+public class JoinDistribution {\n+\n+  private final int distributionFactor;\n+  private final String skewedStageName;\n+\n+  public JoinDistribution(Integer distributionFactor, String skewedStageName) {\n+    this.distributionFactor = distributionFactor;\n+    this.skewedStageName = skewedStageName;\n+  }\n+\n+  public int getDistributionFactor() {\n+    return distributionFactor;\n+  }\n+\n+  public String getSkewedStageName() {\n+    return skewedStageName;\n+  }\n+\n+  public Collection<JoinError> validate(List<JoinStage> stages) {\n+    List<JoinError> errors = new ArrayList<>();\n+\n+    if (stages.size() > 2) {\n+      errors.add(new JoinError(\"Only two stages can be joined if a distribution factor is specified\"));\n+    }\n+\n+    if (skewedStageName == null) {\n+      errors.add(new JoinError(\"Distribution requires skewed stage name to be defined\"));\n+    }\n+\n+    if (distributionFactor < 1) {\n+      errors.add(new JoinError(\"Distribution size must be greater than 0\"));\n+    }\n+\n+    //If skewedStageName does not match any of the names in stages\n+    JoinStage leftStage = stages.stream().filter(s -> s.getStageName().equals(skewedStageName)).findFirst()\n+                                .orElse(null);\n+\n+    if (leftStage == null) {\n+      errors.add(new JoinError(\n+        String.format(\"Skewed stage name '%s' does not match any of the specified stages\", skewedStageName\n+        )));\n+    } else if (!leftStage.isRequired()) {\n+      errors.add(new JoinError(\"Distribution only supports inner or left outer joins, the skewed side of the join \" +\n+                                 \"must be required\"));\n+    }\n+\n+    if (stages.stream().anyMatch(JoinStage::isBroadcast)) {\n+      errors.add(new JoinError(\"Distribution is not needed if either stage will be broadcast\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea98bed5d7cb76fa7ceb0558aeba4022acf296e8"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA2NzA4Nw==", "bodyText": "we may want to use more specific errors than JoinError. The idea being that the plugin should be able to examine the error and figure out what property it needs to highlight as a problem during validation. It's ok to revisit this later, after seeing what the plugin would need.", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r461067087", "createdAt": "2020-07-27T17:54:41Z", "author": {"login": "albertshau"}, "path": "cdap-app-templates/cdap-etl/cdap-etl-api/src/main/java/io/cdap/cdap/etl/api/join/JoinDistribution.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.etl.api.join;\n+\n+import io.cdap.cdap.etl.api.join.error.JoinError;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.List;\n+\n+/**\n+ * Join distribution settings for salting/exploding datasets to resolve skew\n+ */\n+public class JoinDistribution {\n+\n+  private final int distributionFactor;\n+  private final String skewedStageName;\n+\n+  public JoinDistribution(Integer distributionFactor, String skewedStageName) {\n+    this.distributionFactor = distributionFactor;\n+    this.skewedStageName = skewedStageName;\n+  }\n+\n+  public int getDistributionFactor() {\n+    return distributionFactor;\n+  }\n+\n+  public String getSkewedStageName() {\n+    return skewedStageName;\n+  }\n+\n+  public Collection<JoinError> validate(List<JoinStage> stages) {\n+    List<JoinError> errors = new ArrayList<>();\n+\n+    if (stages.size() > 2) {\n+      errors.add(new JoinError(\"Only two stages can be joined if a distribution factor is specified\"));\n+    }\n+\n+    if (skewedStageName == null) {\n+      errors.add(new JoinError(\"Distribution requires skewed stage name to be defined\"));\n+    }\n+\n+    if (distributionFactor < 1) {\n+      errors.add(new JoinError(\"Distribution size must be greater than 0\"));\n+    }\n+\n+    //If skewedStageName does not match any of the names in stages\n+    JoinStage leftStage = stages.stream().filter(s -> s.getStageName().equals(skewedStageName)).findFirst()\n+                                .orElse(null);\n+\n+    if (leftStage == null) {\n+      errors.add(new JoinError(\n+        String.format(\"Skewed stage name '%s' does not match any of the specified stages\", skewedStageName\n+        )));\n+    } else if (!leftStage.isRequired()) {\n+      errors.add(new JoinError(\"Distribution only supports inner or left outer joins, the skewed side of the join \" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA2MzUwNg=="}, "originalCommit": {"oid": "ea98bed5d7cb76fa7ceb0558aeba4022acf296e8"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA2Nzc2NQ==", "bodyText": "style: IDE settings seem to be off, method calls should be indented, not aligned to the previous line", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r461067765", "createdAt": "2020-07-27T17:55:49Z", "author": {"login": "albertshau"}, "path": "cdap-app-templates/cdap-etl/hydrator-spark-core/src/main/java/io/cdap/cdap/etl/spark/batch/RDDCollection.java", "diffHunk": "@@ -72,8 +80,8 @@ public RDDCollection(JavaSparkExecutionContext sec, JavaSparkContext jsc, SQLCon\n     collections.put(joinRequest.getLeftStage(), left);\n \n     List<Column> leftJoinColumns = joinRequest.getLeftKey().stream()\n-      .map(left::col)\n-      .collect(Collectors.toList());\n+                                              .map(left::col)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea98bed5d7cb76fa7ceb0558aeba4022acf296e8"}, "originalPosition": 31}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ea98bed5d7cb76fa7ceb0558aeba4022acf296e8", "author": {"user": {"login": "MEseifan", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/ea98bed5d7cb76fa7ceb0558aeba4022acf296e8", "committedDate": "2020-07-23T21:49:51Z", "message": "(CDAP-17095) Add support for Distribution in AutoJoiner API"}, "afterCommit": {"oid": "1c7e90218275bf8d7f9aafa6672c8604a710e230", "author": {"user": {"login": "MEseifan", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/1c7e90218275bf8d7f9aafa6672c8604a710e230", "committedDate": "2020-07-27T21:30:51Z", "message": "Addressed comments, added new error types and added distribution to spark 2"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2MTUyMjg1", "url": "https://github.com/cdapio/cdap/pull/12481#pullrequestreview-456152285", "createdAt": "2020-07-27T21:35:08Z", "commit": {"oid": "1c7e90218275bf8d7f9aafa6672c8604a710e230"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QyMTozNTowOVrOG30cXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QyMTo0MTozN1rOG30oNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE4NDA5NQ==", "bodyText": "indentation", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r461184095", "createdAt": "2020-07-27T21:35:09Z", "author": {"login": "albertshau"}, "path": "cdap-app-templates/cdap-etl/cdap-etl-api/src/main/java/io/cdap/cdap/etl/api/join/JoinDefinition.java", "diffHunk": "@@ -161,20 +186,24 @@ public JoinDefinition build() {\n         validateSchemaCompatibility(generatedOutputSchema, outputSchema, errors);\n       }\n \n+      if (distribution != null) {\n+        errors.addAll(distribution.validate(stages));\n+      }\n+\n       if (!errors.isEmpty()) {\n         throw new InvalidJoinException(errors);\n       }\n \n       return new JoinDefinition(selectedFields, stages, condition,\n-                                outputSchema == null ? generatedOutputSchema : outputSchema);\n+                                outputSchema == null ? generatedOutputSchema : outputSchema, distribution);\n     }\n \n     @Nullable\n     private Schema getOutputSchema(List<JoinError> errors) {\n       Set<String> outputFieldNames = new HashSet<>();\n       List<Schema.Field> outputFields = new ArrayList<>(selectedFields.size());\n       Map<String, JoinStage> stageMap = stages.stream()\n-        .collect(Collectors.toMap(JoinStage::getStageName, s -> s));\n+                                              .collect(Collectors.toMap(JoinStage::getStageName, s -> s));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c7e90218275bf8d7f9aafa6672c8604a710e230"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE4NjYxMA==", "bodyText": "should this also be a DistributionStageError?", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r461186610", "createdAt": "2020-07-27T21:40:28Z", "author": {"login": "albertshau"}, "path": "cdap-app-templates/cdap-etl/cdap-etl-api/src/main/java/io/cdap/cdap/etl/api/join/JoinDistribution.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.etl.api.join;\n+\n+import io.cdap.cdap.etl.api.join.error.DistributionSizeError;\n+import io.cdap.cdap.etl.api.join.error.DistributionStageError;\n+import io.cdap.cdap.etl.api.join.error.JoinError;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.List;\n+\n+/**\n+ * Join distribution settings for salting/exploding datasets to resolve skew\n+ */\n+public class JoinDistribution {\n+\n+  private final int distributionFactor;\n+  private final String skewedStageName;\n+\n+  public JoinDistribution(Integer distributionFactor, String skewedStageName) {\n+    this.distributionFactor = distributionFactor;\n+    this.skewedStageName = skewedStageName;\n+  }\n+\n+  public int getDistributionFactor() {\n+    return distributionFactor;\n+  }\n+\n+  public String getSkewedStageName() {\n+    return skewedStageName;\n+  }\n+\n+  public Collection<JoinError> validate(List<JoinStage> stages) {\n+    List<JoinError> errors = new ArrayList<>();\n+\n+    if (stages.size() > 2) {\n+      errors.add(new JoinError(\"Only two stages can be joined if a distribution factor is specified\"));\n+    }\n+\n+    if (skewedStageName == null) {\n+      errors.add(new DistributionStageError(\"Distribution requires skewed stage name to be defined\"));\n+    }\n+\n+    if (distributionFactor < 1) {\n+      errors.add(new DistributionSizeError(\"Distribution size must be greater than 0\"));\n+    }\n+\n+    //If skewedStageName does not match any of the names in stages\n+    JoinStage leftStage = stages.stream().filter(s -> s.getStageName().equals(skewedStageName)).findFirst()\n+      .orElse(null);\n+\n+    if (leftStage == null) {\n+      errors.add(new DistributionStageError(\n+        String.format(\"Skewed stage '%s' does not match any of the specified stages\", skewedStageName\n+        )));\n+    } else if (!leftStage.isRequired()) {\n+      errors.add(new JoinError(String.format(\"Distribution only supports inner or left outer joins, the skewed \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c7e90218275bf8d7f9aafa6672c8604a710e230"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE4NzEyNg==", "bodyText": "this one seems like it should have its own type, as the plugin would want to highlight the broadcast property in this situation.", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r461187126", "createdAt": "2020-07-27T21:41:37Z", "author": {"login": "albertshau"}, "path": "cdap-app-templates/cdap-etl/cdap-etl-api/src/main/java/io/cdap/cdap/etl/api/join/JoinDistribution.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.etl.api.join;\n+\n+import io.cdap.cdap.etl.api.join.error.DistributionSizeError;\n+import io.cdap.cdap.etl.api.join.error.DistributionStageError;\n+import io.cdap.cdap.etl.api.join.error.JoinError;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.List;\n+\n+/**\n+ * Join distribution settings for salting/exploding datasets to resolve skew\n+ */\n+public class JoinDistribution {\n+\n+  private final int distributionFactor;\n+  private final String skewedStageName;\n+\n+  public JoinDistribution(Integer distributionFactor, String skewedStageName) {\n+    this.distributionFactor = distributionFactor;\n+    this.skewedStageName = skewedStageName;\n+  }\n+\n+  public int getDistributionFactor() {\n+    return distributionFactor;\n+  }\n+\n+  public String getSkewedStageName() {\n+    return skewedStageName;\n+  }\n+\n+  public Collection<JoinError> validate(List<JoinStage> stages) {\n+    List<JoinError> errors = new ArrayList<>();\n+\n+    if (stages.size() > 2) {\n+      errors.add(new JoinError(\"Only two stages can be joined if a distribution factor is specified\"));\n+    }\n+\n+    if (skewedStageName == null) {\n+      errors.add(new DistributionStageError(\"Distribution requires skewed stage name to be defined\"));\n+    }\n+\n+    if (distributionFactor < 1) {\n+      errors.add(new DistributionSizeError(\"Distribution size must be greater than 0\"));\n+    }\n+\n+    //If skewedStageName does not match any of the names in stages\n+    JoinStage leftStage = stages.stream().filter(s -> s.getStageName().equals(skewedStageName)).findFirst()\n+      .orElse(null);\n+\n+    if (leftStage == null) {\n+      errors.add(new DistributionStageError(\n+        String.format(\"Skewed stage '%s' does not match any of the specified stages\", skewedStageName\n+        )));\n+    } else if (!leftStage.isRequired()) {\n+      errors.add(new JoinError(String.format(\"Distribution only supports inner or left outer joins, the skewed \" +\n+        \"stage '%s' must be required\", skewedStageName)));\n+    }\n+\n+    if (stages.stream().anyMatch(JoinStage::isBroadcast)) {\n+      errors.add(new JoinError(\"Distribution cannot be used if either stage will be broadcast\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c7e90218275bf8d7f9aafa6672c8604a710e230"}, "originalPosition": 77}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2MTgwNjc4", "url": "https://github.com/cdapio/cdap/pull/12481#pullrequestreview-456180678", "createdAt": "2020-07-27T22:32:38Z", "commit": {"oid": "d46e148197e68884a669dad26dcb06f111759bd4"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QyMjozMjozOVrOG3156Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QyMjozMjozOVrOG3156Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIwODA0MQ==", "bodyText": "nit: move to previous line to have consistent style", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r461208041", "createdAt": "2020-07-27T22:32:39Z", "author": {"login": "albertshau"}, "path": "cdap-app-templates/cdap-etl/cdap-etl-api/src/main/java/io/cdap/cdap/etl/api/join/JoinDistribution.java", "diffHunk": "@@ -0,0 +1,84 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.etl.api.join;\n+\n+import io.cdap.cdap.etl.api.join.error.BroadcastError;\n+import io.cdap.cdap.etl.api.join.error.DistributionSizeError;\n+import io.cdap.cdap.etl.api.join.error.DistributionStageError;\n+import io.cdap.cdap.etl.api.join.error.JoinError;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.List;\n+\n+/**\n+ * Join distribution settings for salting/exploding datasets to resolve skew\n+ */\n+public class JoinDistribution {\n+\n+  private final int distributionFactor;\n+  private final String skewedStageName;\n+\n+  public JoinDistribution(Integer distributionFactor, String skewedStageName) {\n+    this.distributionFactor = distributionFactor;\n+    this.skewedStageName = skewedStageName;\n+  }\n+\n+  public int getDistributionFactor() {\n+    return distributionFactor;\n+  }\n+\n+  public String getSkewedStageName() {\n+    return skewedStageName;\n+  }\n+\n+  public Collection<JoinError> validate(List<JoinStage> stages) {\n+    List<JoinError> errors = new ArrayList<>();\n+\n+    if (stages.size() > 2) {\n+      errors.add(new JoinError(\"Only two stages can be joined if a distribution factor is specified\"));\n+    }\n+\n+    if (skewedStageName == null) {\n+      errors.add(new DistributionStageError(\"Distribution requires skewed stage name to be defined\"));\n+    }\n+\n+    if (distributionFactor < 1) {\n+      errors.add(new DistributionSizeError(\"Distribution size must be greater than 0\"));\n+    }\n+\n+    //If skewedStageName does not match any of the names in stages\n+    JoinStage leftStage = stages.stream().filter(s -> s.getStageName().equals(skewedStageName)).findFirst()\n+      .orElse(null);\n+\n+    if (leftStage == null) {\n+      errors.add(new DistributionStageError(\n+        String.format(\"Skewed stage '%s' does not match any of the specified stages\", skewedStageName\n+        )));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d46e148197e68884a669dad26dcb06f111759bd4"}, "originalPosition": 71}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2c7d8068451fab859f531c441c89ed531bbcd6f", "author": {"user": {"login": "MEseifan", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/c2c7d8068451fab859f531c441c89ed531bbcd6f", "committedDate": "2020-07-27T23:04:35Z", "message": "(CDAP-17095) Add support for Distribution in AutoJoiner API"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d46e148197e68884a669dad26dcb06f111759bd4", "author": {"user": {"login": "MEseifan", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/d46e148197e68884a669dad26dcb06f111759bd4", "committedDate": "2020-07-27T22:04:45Z", "message": "Checkstyle"}, "afterCommit": {"oid": "c2c7d8068451fab859f531c441c89ed531bbcd6f", "author": {"user": {"login": "MEseifan", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/c2c7d8068451fab859f531c441c89ed531bbcd6f", "committedDate": "2020-07-27T23:04:35Z", "message": "(CDAP-17095) Add support for Distribution in AutoJoiner API"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1842, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}