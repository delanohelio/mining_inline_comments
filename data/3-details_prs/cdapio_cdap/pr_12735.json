{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc1NjI4NDY3", "number": 12735, "title": "(CDAP-17218) Launch Preview Runner pods using TwillRunner", "bodyText": "This is an implementation for 6.2+ branch that uses TwillRunner to launch preview runner pods, instead of hardcoded way as in 6.1.\nThere is no change in functionalities as compare to 6.1, except there is an addition call to kill its own pod on preview runner termination to avoid going into CrashLoopBackOff delay.", "createdAt": "2020-08-28T20:31:29Z", "url": "https://github.com/cdapio/cdap/pull/12735", "merged": true, "mergeCommit": {"oid": "d9833a02a305b3511b4a038736cb89e68b7fe97c"}, "closed": true, "closedAt": "2020-09-01T20:22:24Z", "author": {"login": "chtyim"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdDkbjQgBqjM3MDYyNjg0ODI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdEq8M1ABqjM3MTYwODEzMzA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6e6b9d84ae765cc25489aae14312103867fe37ef", "author": {"user": {"login": "chtyim", "name": "Terence Yim"}}, "url": "https://github.com/cdapio/cdap/commit/6e6b9d84ae765cc25489aae14312103867fe37ef", "committedDate": "2020-08-28T20:29:17Z", "message": "Distributed Preview runner via k8s twill"}, "afterCommit": {"oid": "cd7756f6f7e2d91b8ecd4cdb2381d2af7e5c93ce", "author": {"user": {"login": "chtyim", "name": "Terence Yim"}}, "url": "https://github.com/cdapio/cdap/commit/cd7756f6f7e2d91b8ecd4cdb2381d2af7e5c93ce", "committedDate": "2020-08-29T07:25:23Z", "message": "Distributed Preview runner via k8s twill"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ec17cabc160223a09631d1b831d62ed2a19483e6", "author": {"user": {"login": "chtyim", "name": "Terence Yim"}}, "url": "https://github.com/cdapio/cdap/commit/ec17cabc160223a09631d1b831d62ed2a19483e6", "committedDate": "2020-08-30T00:54:37Z", "message": "Added setting of priority class for preview runner"}, "afterCommit": {"oid": "bacdac5a7b749481bfc4023dd5248861bb590114", "author": {"user": {"login": "chtyim", "name": "Terence Yim"}}, "url": "https://github.com/cdapio/cdap/commit/bacdac5a7b749481bfc4023dd5248861bb590114", "committedDate": "2020-08-31T06:39:27Z", "message": "Added setting of priority class for preview runner"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4MDg3NDM3", "url": "https://github.com/cdapio/cdap/pull/12735#pullrequestreview-478087437", "createdAt": "2020-08-29T01:36:19Z", "commit": {"oid": "6e6b9d84ae765cc25489aae14312103867fe37ef"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOVQwMTozNjoxOVrOHJX73A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxNjozNToxNVrOHK_GjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU5MTM4OA==", "bodyText": "2016-2020?", "url": "https://github.com/cdapio/cdap/pull/12735#discussion_r479591388", "createdAt": "2020-08-29T01:36:19Z", "author": {"login": "sagarkapare"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/PreviewRunnerModule.java", "diffHunk": "@@ -1,5 +1,5 @@\n /*\n- * Copyright \u00a9 2020 Cask Data, Inc.\n+ * Copyright \u00a9 2016-2019 Cask Data, Inc.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e6b9d84ae765cc25489aae14312103867fe37ef"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTI3Nzg1MQ==", "bodyText": "Should the application name be \"PreviewRunner\"?", "url": "https://github.com/cdapio/cdap/pull/12735#discussion_r481277851", "createdAt": "2020-09-01T16:28:36Z", "author": {"login": "sagarkapare"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/preview/PreviewRunnerTwillApplication.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.internal.app.preview;\n+\n+import io.cdap.cdap.common.conf.Constants;\n+import org.apache.twill.api.ResourceSpecification;\n+import org.apache.twill.api.TwillApplication;\n+import org.apache.twill.api.TwillSpecification;\n+\n+import java.net.URI;\n+\n+/**\n+ * The {@link TwillApplication} for launch preview runner.\n+ */\n+public class PreviewRunnerTwillApplication implements TwillApplication {\n+\n+  private final URI cConfFileURI;\n+  private final URI hConfFileURI;\n+  private final ResourceSpecification resourceSpec;\n+\n+  public PreviewRunnerTwillApplication(URI cConfFileURI, URI hConfFileURI, ResourceSpecification resourceSpec) {\n+    this.cConfFileURI = cConfFileURI;\n+    this.hConfFileURI = hConfFileURI;\n+    this.resourceSpec = resourceSpec;\n+  }\n+\n+  @Override\n+  public TwillSpecification configure() {\n+    return TwillSpecification.Builder.with()\n+      .setName(Constants.Service.PREVIEW_HTTP)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bacdac5a7b749481bfc4023dd5248861bb590114"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTI4MTE1MA==", "bodyText": "Can UID be null?", "url": "https://github.com/cdapio/cdap/pull/12735#discussion_r481281150", "createdAt": "2020-09-01T16:34:23Z", "author": {"login": "sagarkapare"}, "path": "cdap-kubernetes/src/main/java/io/cdap/cdap/k8s/runtime/KubeTwillContext.java", "diffHunk": "@@ -190,6 +197,12 @@ public void close() {\n     }\n   }\n \n+  @Nullable", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bacdac5a7b749481bfc4023dd5248861bb590114"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTI4MTY3Nw==", "bodyText": "This comment is no longer valid now right?", "url": "https://github.com/cdapio/cdap/pull/12735#discussion_r481281677", "createdAt": "2020-09-01T16:35:15Z", "author": {"login": "sagarkapare"}, "path": "cdap-kubernetes/src/main/java/io/cdap/cdap/k8s/runtime/KubeTwillController.java", "diffHunk": "@@ -145,6 +146,31 @@ public ResourceReport getResourceReport() {\n     return doRestartInstances(runnable, instanceIds);\n   }\n \n+  @Override\n+  public Future<String> restartInstance(String runnable, int instanceId, String uid) {\n+    CompletableFuture<String> resultFuture = new CompletableFuture<>();\n+    CoreV1Api api = new CoreV1Api(apiClient);\n+\n+    // Only support for stateful set for now\n+    if (!V1StatefulSet.class.equals(resourceType)) {\n+      resultFuture.completeExceptionally(\n+        new UnsupportedOperationException(\"Instance restart by instance id is only supported for statefulsets\"));\n+      return resultFuture;\n+    }\n+\n+    // pod uid is passed as \"runnable\" parameter to the method.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bacdac5a7b749481bfc4023dd5248861bb590114"}, "originalPosition": 48}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ffd0c11271294c26fbf2e14580f4d58bde8e350e", "author": {"user": {"login": "chtyim", "name": "Terence Yim"}}, "url": "https://github.com/cdapio/cdap/commit/ffd0c11271294c26fbf2e14580f4d58bde8e350e", "committedDate": "2020-09-01T17:31:42Z", "message": "(CDAP-17218) Launch Preview Runner Using TwillRunner\n\n- Introduced PreviewRunnerTwillApplication and PreviewRunnerTwillRunnable\n  for starting multiple instances of preview runners in the cluster\n- Fixed preview level db binding to correctly use the preview local data directory\n  instead of using the regular data directory\n- Refactoring of preview related Guice bindings"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f945f45224ff09d91bf7f6bee1a8b183cdd9e082", "author": {"user": {"login": "chtyim", "name": "Terence Yim"}}, "url": "https://github.com/cdapio/cdap/commit/f945f45224ff09d91bf7f6bee1a8b183cdd9e082", "committedDate": "2020-09-01T17:12:04Z", "message": "Address comments"}, "afterCommit": {"oid": "ffd0c11271294c26fbf2e14580f4d58bde8e350e", "author": {"user": {"login": "chtyim", "name": "Terence Yim"}}, "url": "https://github.com/cdapio/cdap/commit/ffd0c11271294c26fbf2e14580f4d58bde8e350e", "committedDate": "2020-09-01T17:31:42Z", "message": "(CDAP-17218) Launch Preview Runner Using TwillRunner\n\n- Introduced PreviewRunnerTwillApplication and PreviewRunnerTwillRunnable\n  for starting multiple instances of preview runners in the cluster\n- Fixed preview level db binding to correctly use the preview local data directory\n  instead of using the regular data directory\n- Refactoring of preview related Guice bindings"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1744, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}