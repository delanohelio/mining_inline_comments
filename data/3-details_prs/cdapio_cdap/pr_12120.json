{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA4NzIxOTg5", "number": 12120, "title": "[CDAP-16656] Improve performance of schema editor", "bodyText": "By default collapses nested schema to avoid rendering the entire tree\nImplements lazy loading for schema editor\nImplement lazy loading for sqlSelectorWidget when opened in joiner\n\nJIRA: https://issues.cask.co/browse/CDAP-16656\nBuild: https://builds.cask.co/browse/CDAP-URUT235-1", "createdAt": "2020-04-24T19:17:55Z", "url": "https://github.com/cdapio/cdap/pull/12120", "merged": true, "mergeCommit": {"oid": "0475d8b8864287af931fc78ab2faab4fbaf1e5ff"}, "closed": true, "closedAt": "2020-05-05T14:40:19Z", "author": {"login": "ajainarayanan"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABccJUrzAFqTQwMjE1ODQ2OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcdV4azgBqjMyOTU4Mzg4ODY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyMTU4NDY4", "url": "https://github.com/cdapio/cdap/pull/12120#pullrequestreview-402158468", "createdAt": "2020-04-28T19:47:41Z", "commit": {"oid": "b04068ba68052e106ca503e12b0601e18881c65d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxOTo0Nzo0MlrOGNkOZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxOTo0Nzo0MlrOGNkOZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjg3ODE4MQ==", "bodyText": "I assume the 50 here is coming from DEFAULT_FIELD_WINDOW_SIZE? If yes, can we use the variable here instead?", "url": "https://github.com/cdapio/cdap/pull/12120#discussion_r416878181", "createdAt": "2020-04-28T19:47:42Z", "author": {"login": "yukiej"}, "path": "cdap-ui/app/cdap/components/AbstractWidget/SqlSelectorWidget/SchemaContainer.tsx", "diffHunk": "@@ -171,6 +188,105 @@ class SchemaContainer extends React.Component<ISchemaContainerProps, ISchemaCont\n     return validationError;\n   }\n \n+  private componentID = `sql-fields-${uuidV4()}`;\n+\n+  private io = new IntersectionObserver(\n+    (entries) => {\n+      let lastVisibleElement = this.state.fieldWindowSize;\n+      for (const entry of entries) {\n+        let id = entry.target.getAttribute('id');\n+        id = id.split('-').pop();\n+        const idInt = parseInt(id, 10);\n+        if (entry.isIntersecting) {\n+          lastVisibleElement =\n+            idInt + 50 > this.state.fieldWindowSize ? idInt + DEFAULT_FIELD_WINDOW_SIZE : idInt;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b04068ba68052e106ca503e12b0601e18881c65d"}, "originalPosition": 61}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyMTU4OTk1", "url": "https://github.com/cdapio/cdap/pull/12120#pullrequestreview-402158995", "createdAt": "2020-04-28T19:48:28Z", "commit": {"oid": "b04068ba68052e106ca503e12b0601e18881c65d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxOTo0ODoyOFrOGNkQCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxOTo0ODoyOFrOGNkQCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjg3ODYwMA==", "bodyText": "Where is 100 coming from here?", "url": "https://github.com/cdapio/cdap/pull/12120#discussion_r416878600", "createdAt": "2020-04-28T19:48:28Z", "author": {"login": "yukiej"}, "path": "cdap-ui/app/directives/complex-schema/complex-schema.js", "diffHunk": "@@ -25,6 +25,74 @@ function ComplexSchemaController (avsc, SCHEMA_TYPES, $scope, uuid, $timeout, Sc\n   let timeout;\n   let addFieldTimeout;\n   vm.emptySchema = false;\n+  // lazy loading parameters\n+  $scope.id = uuid.v4();\n+  $scope.lazyLoadedParsedSchema = [];\n+  vm.windowSize = 50;\n+  vm.DEFAULT_WINDOW_SIZE = 50;\n+  vm.lazyloading = false;\n+\n+  $scope.$watch('domLoaded', () => {\n+    /*\n+      Wait for the dom to be loaded\n+      Equivalent of componentDidMount :sigh:\n+    */\n+    if (!$scope.domLoaded) {\n+      return;\n+    }\n+    /*\n+      For some reason if the dom is loaded but none of the fields are\n+      rendered we don't need to do anything.\n+    */\n+    const fields = document.querySelectorAll(`#schema-container-${$scope.id} .field-row`);\n+    if (!fields.length) {\n+      return;\n+    }\n+    vm.io = new IntersectionObserver(\n+      (entries) => {\n+        let lastVisibleElement = vm.windowSize;\n+        for (const entry of entries) {\n+          const id = entry.target.getAttribute('lazyload-id');\n+          const numID = parseInt(id, 10);\n+          if (entry.isIntersecting) {\n+            lastVisibleElement = numID + 100 > vm.windowSize ? numID + vm.DEFAULT_WINDOW_SIZE : numID;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b04068ba68052e106ca503e12b0601e18881c65d"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyMTYwNjY0", "url": "https://github.com/cdapio/cdap/pull/12120#pullrequestreview-402160664", "createdAt": "2020-04-28T19:50:56Z", "commit": {"oid": "b04068ba68052e106ca503e12b0601e18881c65d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxOTo1MDo1NlrOGNkVjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxOTo1MDo1NlrOGNkVjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjg4MDAxNQ==", "bodyText": "maybe say !vm.initCollapse instead for conciseness?", "url": "https://github.com/cdapio/cdap/pull/12120#discussion_r416880015", "createdAt": "2020-04-28T19:50:56Z", "author": {"login": "yukiej"}, "path": "cdap-ui/app/directives/complex-schema/embedded-schema-selector/embedded-schema-selector.js", "diffHunk": "@@ -24,13 +24,14 @@ angular.module(PKG.name+'.commons')\n       displayType: '=',\n       index: '=',\n       parentFormatOutput: '&',\n-      isDisabled: '='\n+      isDisabled: '=',\n+      initCollapse: '='\n     },\n     bindToController: true,\n     controller: function (SchemaHelper) {\n       var vm = this;\n       vm.checkComplexType = SchemaHelper.checkComplexType;\n-      vm.expanded = true;\n+      vm.expanded = vm.initCollapse === true ? false : true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b04068ba68052e106ca503e12b0601e18881c65d"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyMzM3MjU1", "url": "https://github.com/cdapio/cdap/pull/12120#pullrequestreview-402337255", "createdAt": "2020-04-29T02:55:46Z", "commit": {"oid": "f47b770b76be2b15c62ce39d3416468e4fc2e605"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c06ad0ae686c386816ca647797798e053516b17", "author": {"user": {"login": "elfenheart", "name": "Edwin Elia"}}, "url": "https://github.com/cdapio/cdap/commit/6c06ad0ae686c386816ca647797798e053516b17", "committedDate": "2020-05-02T12:59:18Z", "message": "[CDAP-16656] Improve performance of schema editor\n\n - Default to collapse schema at all levels to minimize load on rendering\n - Converts ng-show to ng-if in input schema to avoid rendering schema hidden inside accordion\n - Adds lazy loading to schema editor\n - Adds lazyloading to sqlselectwidget"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "436e0c3dcbdece74d53d066a328b4de2d88697de", "author": {"user": {"login": "ajainarayanan", "name": "Ajai"}}, "url": "https://github.com/cdapio/cdap/commit/436e0c3dcbdece74d53d066a328b4de2d88697de", "committedDate": "2020-05-01T05:07:50Z", "message": "Fixes schema editor to open complex schema when user manually types in"}, "afterCommit": {"oid": "6c06ad0ae686c386816ca647797798e053516b17", "author": {"user": {"login": "elfenheart", "name": "Edwin Elia"}}, "url": "https://github.com/cdapio/cdap/commit/6c06ad0ae686c386816ca647797798e053516b17", "committedDate": "2020-05-02T12:59:18Z", "message": "[CDAP-16656] Improve performance of schema editor\n\n - Default to collapse schema at all levels to minimize load on rendering\n - Converts ng-show to ng-if in input schema to avoid rendering schema hidden inside accordion\n - Adds lazy loading to schema editor\n - Adds lazyloading to sqlselectwidget"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2195, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}