{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU1OTU0NTA3", "number": 12492, "title": "[CDAP-17107] CDAP WorkflowDriver and CustomActionExecutor Exception Wrapping", "bodyText": "Prevent CDAP WorkflowDriver and CustomActionExecutor from unwrapping exceptions via Throwables.rootCause(). See CDAP-17107.", "createdAt": "2020-07-23T21:12:06Z", "url": "https://github.com/cdapio/cdap/pull/12492", "merged": true, "mergeCommit": {"oid": "8babbc803456792f6cccfab05199ecfb1def13b5"}, "closed": true, "closedAt": "2020-07-25T21:18:05Z", "author": {"login": "dli357"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc32LbCAFqTQ1NDUwMTc5Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc4dBvDgBqjM1ODY0Nzg4MDc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0NTAxNzk2", "url": "https://github.com/cdapio/cdap/pull/12492#pullrequestreview-454501796", "createdAt": "2020-07-23T21:17:28Z", "commit": {"oid": "feeeb098cee9538e49be8adf452596fd35cfc68b"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QyMToxNzoyOVrOG2b45g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QyMToxOToxMVrOG2b76w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTczMzIyMg==", "bodyText": "is the exception here the direct one thrown by the custom action itself? Or does it get wrapped somehow?", "url": "https://github.com/cdapio/cdap/pull/12492#discussion_r459733222", "createdAt": "2020-07-23T21:17:29Z", "author": {"login": "albertshau"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/runtime/workflow/CustomActionExecutor.java", "diffHunk": "@@ -86,7 +86,7 @@ void execute() throws Exception {\n       customActionContext.setState(new ProgramState(ProgramStatus.COMPLETED, null));\n \n     } catch (Throwable t) {\n-      customActionContext.setState(new ProgramState(ProgramStatus.FAILED, Throwables.getRootCause(t).getMessage()));\n+      customActionContext.setState(new ProgramState(ProgramStatus.FAILED, t.getMessage()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "feeeb098cee9538e49be8adf452596fd35cfc68b"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTczMzk5NQ==", "bodyText": "similar question here, what gets thrown by executeNode? It seems like there is some sort of wrapping going on, since it is looking for an InterruptedException as the root cause.\nAsking since it would be good to also remove extra wrapping if it is happening.", "url": "https://github.com/cdapio/cdap/pull/12492#discussion_r459733995", "createdAt": "2020-07-23T21:19:11Z", "author": {"login": "albertshau"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/runtime/workflow/WorkflowDriver.java", "diffHunk": "@@ -640,8 +640,8 @@ private void executeAll(Iterator<WorkflowNode> iterator, ApplicationSpecificatio\n           workflowContext.setState(new ProgramState(ProgramStatus.KILLED, rootCause.getMessage()));\n           break;\n         }\n-        workflowContext.setState(new ProgramState(ProgramStatus.FAILED, rootCause.getMessage()));\n-        throw Throwables.propagate(rootCause);\n+        workflowContext.setState(new ProgramState(ProgramStatus.FAILED, t.getMessage()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "feeeb098cee9538e49be8adf452596fd35cfc68b"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0NTI3MDE4", "url": "https://github.com/cdapio/cdap/pull/12492#pullrequestreview-454527018", "createdAt": "2020-07-23T22:04:30Z", "commit": {"oid": "feeeb098cee9538e49be8adf452596fd35cfc68b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QyMjowNDozMFrOG2dJ8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QyMjowNDozMFrOG2dJ8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc1Mzk3MA==", "bodyText": "If it doesn't change a bunch of things, would be better to throw the exception directly like it does in the action code, instead of wrapping it in a runtime exception.", "url": "https://github.com/cdapio/cdap/pull/12492#discussion_r459753970", "createdAt": "2020-07-23T22:04:30Z", "author": {"login": "albertshau"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/runtime/workflow/WorkflowDriver.java", "diffHunk": "@@ -640,8 +640,8 @@ private void executeAll(Iterator<WorkflowNode> iterator, ApplicationSpecificatio\n           workflowContext.setState(new ProgramState(ProgramStatus.KILLED, rootCause.getMessage()));\n           break;\n         }\n-        workflowContext.setState(new ProgramState(ProgramStatus.FAILED, rootCause.getMessage()));\n-        throw Throwables.propagate(rootCause);\n+        workflowContext.setState(new ProgramState(ProgramStatus.FAILED, t.getMessage()));\n+        throw Throwables.propagate(t);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "feeeb098cee9538e49be8adf452596fd35cfc68b"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0NjAwMDgx", "url": "https://github.com/cdapio/cdap/pull/12492#pullrequestreview-454600081", "createdAt": "2020-07-24T02:02:46Z", "commit": {"oid": "21ec34b4f8761faff9f43a58b40493fa64bba388"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwMjowMjo0NlrOG2hKPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwMjoxMjozMlrOG2hR_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTgxOTU4MQ==", "bodyText": "It is problematic in either case. Usually the actual message is hidden deep inside the root cause. However, contextual information is available in intermediate wrapping exceptions. Since we are not recording the whole exception stacktrace, but instead just a String message. It is better to concatenate the message in some meaningful way across the exception chain (some messages along the chain could be null, especially the one coming from Java itself).", "url": "https://github.com/cdapio/cdap/pull/12492#discussion_r459819581", "createdAt": "2020-07-24T02:02:46Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/runtime/workflow/CustomActionExecutor.java", "diffHunk": "@@ -86,7 +86,7 @@ void execute() throws Exception {\n       customActionContext.setState(new ProgramState(ProgramStatus.COMPLETED, null));\n \n     } catch (Throwable t) {\n-      customActionContext.setState(new ProgramState(ProgramStatus.FAILED, Throwables.getRootCause(t).getMessage()));\n+      customActionContext.setState(new ProgramState(ProgramStatus.FAILED, t.getMessage()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "21ec34b4f8761faff9f43a58b40493fa64bba388"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTgxOTY2Nw==", "bodyText": "Same suggestion as above.", "url": "https://github.com/cdapio/cdap/pull/12492#discussion_r459819667", "createdAt": "2020-07-24T02:03:12Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/runtime/workflow/WorkflowDriver.java", "diffHunk": "@@ -640,8 +641,8 @@ private void executeAll(Iterator<WorkflowNode> iterator, ApplicationSpecificatio\n           workflowContext.setState(new ProgramState(ProgramStatus.KILLED, rootCause.getMessage()));\n           break;\n         }\n-        workflowContext.setState(new ProgramState(ProgramStatus.FAILED, rootCause.getMessage()));\n-        throw Throwables.propagate(rootCause);\n+        workflowContext.setState(new ProgramState(ProgramStatus.FAILED, t.getMessage()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "21ec34b4f8761faff9f43a58b40493fa64bba388"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTgyMTU2NQ==", "bodyText": "This is a good change. Wrapping is unnecessary in all private method.", "url": "https://github.com/cdapio/cdap/pull/12492#discussion_r459821565", "createdAt": "2020-07-24T02:12:32Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/runtime/workflow/WorkflowDriver.java", "diffHunk": "@@ -640,8 +641,8 @@ private void executeAll(Iterator<WorkflowNode> iterator, ApplicationSpecificatio\n           workflowContext.setState(new ProgramState(ProgramStatus.KILLED, rootCause.getMessage()));\n           break;\n         }\n-        workflowContext.setState(new ProgramState(ProgramStatus.FAILED, rootCause.getMessage()));\n-        throw Throwables.propagate(rootCause);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "21ec34b4f8761faff9f43a58b40493fa64bba388"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1MTAyNzU4", "url": "https://github.com/cdapio/cdap/pull/12492#pullrequestreview-455102758", "createdAt": "2020-07-24T18:33:09Z", "commit": {"oid": "da26547f499dbe4c01d1eaf4bbef9c97229c907e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQxODozMzoxMFrOG25uUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQxODozMzoxMFrOG25uUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIyMjAzNQ==", "bodyText": "Can you refactor this logic into some helper function? Maybe you can add a Exceptions util class in cdap-common under the io.cdap.cdap.common.lang package.", "url": "https://github.com/cdapio/cdap/pull/12492#discussion_r460222035", "createdAt": "2020-07-24T18:33:10Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/runtime/workflow/WorkflowDriver.java", "diffHunk": "@@ -640,8 +641,21 @@ private void executeAll(Iterator<WorkflowNode> iterator, ApplicationSpecificatio\n           workflowContext.setState(new ProgramState(ProgramStatus.KILLED, rootCause.getMessage()));\n           break;\n         }\n-        workflowContext.setState(new ProgramState(ProgramStatus.FAILED, rootCause.getMessage()));\n-        throw Throwables.propagate(rootCause);\n+        StringBuilder contextFailMessage = new StringBuilder();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "da26547f499dbe4c01d1eaf4bbef9c97229c907e"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1MzAxNzg1", "url": "https://github.com/cdapio/cdap/pull/12492#pullrequestreview-455301785", "createdAt": "2020-07-25T18:29:40Z", "commit": {"oid": "b4a43c6680f45c352e2a22bb14c6968e1363ce45"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b4a43c6680f45c352e2a22bb14c6968e1363ce45", "author": {"user": {"login": "dli357", "name": "Dennis Li"}}, "url": "https://github.com/cdapio/cdap/commit/b4a43c6680f45c352e2a22bb14c6968e1363ce45", "committedDate": "2020-07-24T20:00:03Z", "message": "Added copyright headers"}, "afterCommit": {"oid": "29e8fca4c3a24ef24d26286419e70c1d4a8f6d06", "author": {"user": {"login": "dli357", "name": "Dennis Li"}}, "url": "https://github.com/cdapio/cdap/commit/29e8fca4c3a24ef24d26286419e70c1d4a8f6d06", "committedDate": "2020-07-25T18:33:03Z", "message": "[CDAP-17107] Prevent CDAP WorkflowDriver and CustomActionExecutor from unwrapping exceptions\n\n[CDAP-17107] Removed exception wrapping in executeAll()\n\n[CDAP-17107] Extended context failure message to include entire exception chain\n\n[CDAP-17107] Moved exception condensing logic to helper method, add unit tests\n\nAdded copyright headers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ad921f8d5e4cf9dac18cb08021e720cca5be79c", "author": {"user": {"login": "dli357", "name": "Dennis Li"}}, "url": "https://github.com/cdapio/cdap/commit/8ad921f8d5e4cf9dac18cb08021e720cca5be79c", "committedDate": "2020-07-25T18:34:45Z", "message": "[CDAP-17107] Prevent CDAP WorkflowDriver and CustomActionExecutor from unwrapping exceptions\n\n[CDAP-17107] Removed exception wrapping in executeAll()\n\n[CDAP-17107] Extended context failure message to include entire exception chain\n\n[CDAP-17107] Moved exception condensing logic to helper method, add unit tests\n\nAdded copyright headers"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "29e8fca4c3a24ef24d26286419e70c1d4a8f6d06", "author": {"user": {"login": "dli357", "name": "Dennis Li"}}, "url": "https://github.com/cdapio/cdap/commit/29e8fca4c3a24ef24d26286419e70c1d4a8f6d06", "committedDate": "2020-07-25T18:33:03Z", "message": "[CDAP-17107] Prevent CDAP WorkflowDriver and CustomActionExecutor from unwrapping exceptions\n\n[CDAP-17107] Removed exception wrapping in executeAll()\n\n[CDAP-17107] Extended context failure message to include entire exception chain\n\n[CDAP-17107] Moved exception condensing logic to helper method, add unit tests\n\nAdded copyright headers"}, "afterCommit": {"oid": "8ad921f8d5e4cf9dac18cb08021e720cca5be79c", "author": {"user": {"login": "dli357", "name": "Dennis Li"}}, "url": "https://github.com/cdapio/cdap/commit/8ad921f8d5e4cf9dac18cb08021e720cca5be79c", "committedDate": "2020-07-25T18:34:45Z", "message": "[CDAP-17107] Prevent CDAP WorkflowDriver and CustomActionExecutor from unwrapping exceptions\n\n[CDAP-17107] Removed exception wrapping in executeAll()\n\n[CDAP-17107] Extended context failure message to include entire exception chain\n\n[CDAP-17107] Moved exception condensing logic to helper method, add unit tests\n\nAdded copyright headers"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1855, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}