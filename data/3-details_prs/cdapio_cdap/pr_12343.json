{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM1MzQxOTQz", "number": 12343, "title": "CDAP-16987 Keep single store for all preview runs owned by PreviewManager.", "bodyText": "JIRA: https://issues.cask.co/browse/CDAP-16987\nRemoved appInjector cache from the PreviewManager.\nPassing applicationId to the preview runner methods to fetch data corresponding to the given application.", "createdAt": "2020-06-16T16:44:00Z", "url": "https://github.com/cdapio/cdap/pull/12343", "merged": true, "mergeCommit": {"oid": "7576da78eca71f20a8a337b17007ab1ff9fbfc9d"}, "closed": true, "closedAt": "2020-06-18T01:22:58Z", "author": {"login": "sagarkapare"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcr479WAFqTQzMTc0Njg2Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcsSYkygBqjM0NTU3NTYzNjA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxNzQ2ODY3", "url": "https://github.com/cdapio/cdap/pull/12343#pullrequestreview-431746867", "createdAt": "2020-06-16T17:44:59Z", "commit": {"oid": "9f85d70f1af366e42ca034d07cf4df9310fb079e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNzo0NTowMFrOGkmZSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNzo0NTowMFrOGkmZSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAzMDk4Nw==", "bodyText": "Removed this test case since the appInjector limit is removed now. Will add similar test case for preview job queue capacity.", "url": "https://github.com/cdapio/cdap/pull/12343#discussion_r441030987", "createdAt": "2020-06-16T17:45:00Z", "author": {"login": "sagarkapare"}, "path": "cdap-app-fabric/src/test/java/io/cdap/cdap/internal/app/preview/PreviewManagerTest.java", "diffHunk": "@@ -169,19 +169,6 @@ public void finish() {\n     txManager.stopAndWait();\n   }\n \n-  @Test(expected = IllegalStateException.class)\n-  public void testLimit() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f85d70f1af366e42ca034d07cf4df9310fb079e"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "022a3f7e7837dc51cee1ecdf70a86aa3d4019132", "author": {"user": {"login": "sagarkapare", "name": "sagarkapare"}}, "url": "https://github.com/cdapio/cdap/commit/022a3f7e7837dc51cee1ecdf70a86aa3d4019132", "committedDate": "2020-06-16T23:02:22Z", "message": "Removed instance level state."}, "afterCommit": {"oid": "01a591b3051397b87d0982a9e2746ce392fd6b34", "author": {"user": {"login": "sagarkapare", "name": "sagarkapare"}}, "url": "https://github.com/cdapio/cdap/commit/01a591b3051397b87d0982a9e2746ce392fd6b34", "committedDate": "2020-06-17T05:13:21Z", "message": "CDAP-16987 Keep single store for all preview runs owned by PreviewManager."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyNTQ1MzEy", "url": "https://github.com/cdapio/cdap/pull/12343#pullrequestreview-432545312", "createdAt": "2020-06-17T15:55:43Z", "commit": {"oid": "01a591b3051397b87d0982a9e2746ce392fd6b34"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxNTo1NTo0M1rOGlMYxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxNjowMDoyNlrOGlMk5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY1MzQ0Nw==", "bodyText": "why do we need to get the status here? Is it just for validation?", "url": "https://github.com/cdapio/cdap/pull/12343#discussion_r441653447", "createdAt": "2020-06-17T15:55:43Z", "author": {"login": "yaojiefeng"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/gateway/handlers/preview/PreviewHttpHandler.java", "diffHunk": "@@ -134,18 +132,21 @@ public void getData(HttpRequest request, HttpResponder responder,\n                       @PathParam(\"namespace-id\") String namespaceId,\n                       @PathParam(\"preview-id\") String previewId,\n                       @PathParam(\"tracer-id\") String tracerId) throws Exception {\n-    NamespaceId namespace = new NamespaceId(namespaceId);\n-    ApplicationId application = namespace.app(previewId);\n-    responder.sendJson(HttpResponseStatus.OK, GSON.toJson(previewManager.getRunner(application).getData(tracerId)));\n+    // Check if valid application Id\n+    ApplicationId application = new ApplicationId(namespaceId, previewId);\n+    previewManager.getRunner().getStatus(application);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01a591b3051397b87d0982a9e2746ce392fd6b34"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY1MzUwOQ==", "bodyText": "same here", "url": "https://github.com/cdapio/cdap/pull/12343#discussion_r441653509", "createdAt": "2020-06-17T15:55:47Z", "author": {"login": "yaojiefeng"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/gateway/handlers/preview/PreviewHttpHandler.java", "diffHunk": "@@ -134,18 +132,21 @@ public void getData(HttpRequest request, HttpResponder responder,\n                       @PathParam(\"namespace-id\") String namespaceId,\n                       @PathParam(\"preview-id\") String previewId,\n                       @PathParam(\"tracer-id\") String tracerId) throws Exception {\n-    NamespaceId namespace = new NamespaceId(namespaceId);\n-    ApplicationId application = namespace.app(previewId);\n-    responder.sendJson(HttpResponseStatus.OK, GSON.toJson(previewManager.getRunner(application).getData(tracerId)));\n+    // Check if valid application Id\n+    ApplicationId application = new ApplicationId(namespaceId, previewId);\n+    previewManager.getRunner().getStatus(application);\n+    responder.sendJson(HttpResponseStatus.OK, GSON.toJson(previewManager.getRunner().getData(application, tracerId)));\n   }\n \n   @POST\n   @Path(\"/previews/{preview-id}/tracers\")\n   public void getTracersData(FullHttpRequest request, HttpResponder responder,\n                              @PathParam(\"namespace-id\") String namespaceId,\n                              @PathParam(\"preview-id\") String previewId) throws Exception {\n-    NamespaceId namespace = new NamespaceId(namespaceId);\n-    ApplicationId application = namespace.app(previewId);\n+    // Check if valid application Id\n+    ApplicationId application = new ApplicationId(namespaceId, previewId);\n+    previewManager.getRunner().getStatus(application);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01a591b3051397b87d0982a9e2746ce392fd6b34"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY1NDMxMg==", "bodyText": "This part of code occurs 4 times, better to extract a method for it", "url": "https://github.com/cdapio/cdap/pull/12343#discussion_r441654312", "createdAt": "2020-06-17T15:56:58Z", "author": {"login": "yaojiefeng"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/gateway/handlers/preview/PreviewHttpHandler.java", "diffHunk": "@@ -240,7 +233,11 @@ public void search(HttpRequest request, HttpResponder responder,\n                      @PathParam(\"preview-id\") String previewId,\n                      @QueryParam(\"target\") String target,\n                      @QueryParam(\"tag\") List<String> tags) throws Exception {\n-    MetricsQueryHelper helper = getMetricsQueryHelper(namespaceId, previewId);\n+    // Check if valid application id\n+    ApplicationId applicationId = new ApplicationId(namespaceId, previewId);\n+    previewManager.getRunner().getStatus(applicationId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01a591b3051397b87d0982a9e2746ce392fd6b34"}, "originalPosition": 130}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY1NjU1MA==", "bodyText": "Question - here if the preview service gets restarted, is there a way to restore the previous preview runs? Previously when using a map, we will scan the folder names to restore the previous runs, how is this part of logic get handled now?", "url": "https://github.com/cdapio/cdap/pull/12343#discussion_r441656550", "createdAt": "2020-06-17T16:00:26Z", "author": {"login": "yaojiefeng"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/preview/DefaultPreviewManager.java", "diffHunk": "@@ -106,9 +97,9 @@\n   private final DatasetFramework datasetFramework;\n   private final SecureStore secureStore;\n   private final TransactionSystemClient transactionSystemClient;\n-  private final ConcurrentMap<ApplicationId, Injector> appInjectors;\n   private final Path previewDataDir;\n   private final PreviewRunnerModuleFactory previewRunnerModuleFactory;\n+  private Injector previewInjector;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01a591b3051397b87d0982a9e2746ce392fd6b34"}, "originalPosition": 45}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyNzI4OTY5", "url": "https://github.com/cdapio/cdap/pull/12343#pullrequestreview-432728969", "createdAt": "2020-06-17T19:57:33Z", "commit": {"oid": "90c9c424d9ca9df84e2335a09c71b6a8b6be547e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyNzgzOTQw", "url": "https://github.com/cdapio/cdap/pull/12343#pullrequestreview-432783940", "createdAt": "2020-06-17T21:18:39Z", "commit": {"oid": "90c9c424d9ca9df84e2335a09c71b6a8b6be547e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QyMToxODozOVrOGlXyEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QyMToxODozOVrOGlXyEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg0MDE0NA==", "bodyText": "Seems like this is not used anymore? Are we not enforcing max concurrent runs?", "url": "https://github.com/cdapio/cdap/pull/12343#discussion_r441840144", "createdAt": "2020-06-17T21:18:39Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/preview/DefaultPreviewManager.java", "diffHunk": "@@ -124,173 +115,58 @@\n     this.secureStore = secureStore;\n     this.transactionSystemClient = transactionSystemClient;\n     this.previewDataDir = Paths.get(cConf.get(Constants.CFG_LOCAL_DATA_DIR), \"preview\").toAbsolutePath();\n-    this.appInjectors = new ConcurrentHashMap<>();\n     this.maxPreviews = cConf.getInt(Constants.Preview.PREVIEW_CACHE_SIZE, 10);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "90c9c424d9ca9df84e2335a09c71b6a8b6be547e"}, "originalPosition": 54}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d98673d2f556d522ea2c0411c03efda3892e7d4", "author": {"user": {"login": "sagarkapare", "name": "sagarkapare"}}, "url": "https://github.com/cdapio/cdap/commit/2d98673d2f556d522ea2c0411c03efda3892e7d4", "committedDate": "2020-06-17T23:23:33Z", "message": "CDAP-16987 Keep single store for all preview runs owned by PreviewManager."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "90c9c424d9ca9df84e2335a09c71b6a8b6be547e", "author": {"user": {"login": "sagarkapare", "name": "sagarkapare"}}, "url": "https://github.com/cdapio/cdap/commit/90c9c424d9ca9df84e2335a09c71b6a8b6be547e", "committedDate": "2020-06-17T19:22:06Z", "message": "Addressed comments."}, "afterCommit": {"oid": "2d98673d2f556d522ea2c0411c03efda3892e7d4", "author": {"user": {"login": "sagarkapare", "name": "sagarkapare"}}, "url": "https://github.com/cdapio/cdap/commit/2d98673d2f556d522ea2c0411c03efda3892e7d4", "committedDate": "2020-06-17T23:23:33Z", "message": "CDAP-16987 Keep single store for all preview runs owned by PreviewManager."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1885, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}