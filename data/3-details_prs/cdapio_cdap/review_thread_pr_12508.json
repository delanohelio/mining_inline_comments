{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU3NDA3Mjcz", "number": 12508, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwOToxMDo0NFrOESuU8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwMDo1NjowMVrOETerSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4MDY4ODQ5OnYy", "diffSide": "RIGHT", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/services/ProgramNotificationSubscriberService.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwOToxMDo0NFrOG4Dyng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNjo0Mzo0NVrOG4qteg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQzNTU1MA==", "bodyText": "The recordProgramProvisioned method call already returns the latest RunRecordMeta being recorded. You shouldn't need to read it again.", "url": "https://github.com/cdapio/cdap/pull/12508#discussion_r461435550", "createdAt": "2020-07-28T09:10:44Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/services/ProgramNotificationSubscriberService.java", "diffHunk": "@@ -536,6 +536,37 @@ private void writeToHeartBeatTable(@Nullable RunRecordDetail recordedRunRecord,\n         // Publish the program STARTING state before starting the program\n         programStateWriter.start(programRunId, newProgramOptions, null, programDescriptor);\n \n+        long provisioningTime = System.currentTimeMillis() / 1000 -\n+          RunIds.getTime(programRunId.getRun(), TimeUnit.SECONDS);\n+        // emit provisioning time metric\n+        ProfileId profileId = null;\n+        try {\n+          RunRecordDetail runRecordMeta = appMetadataStore.getRun(programRunId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56591b29c9722f2e21edd6b2b22c61bf7693cb43"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA3MzIxMA==", "bodyText": "removed, as it's not needed.", "url": "https://github.com/cdapio/cdap/pull/12508#discussion_r462073210", "createdAt": "2020-07-29T06:43:45Z", "author": {"login": "rmstar"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/services/ProgramNotificationSubscriberService.java", "diffHunk": "@@ -536,6 +536,37 @@ private void writeToHeartBeatTable(@Nullable RunRecordDetail recordedRunRecord,\n         // Publish the program STARTING state before starting the program\n         programStateWriter.start(programRunId, newProgramOptions, null, programDescriptor);\n \n+        long provisioningTime = System.currentTimeMillis() / 1000 -\n+          RunIds.getTime(programRunId.getRun(), TimeUnit.SECONDS);\n+        // emit provisioning time metric\n+        ProfileId profileId = null;\n+        try {\n+          RunRecordDetail runRecordMeta = appMetadataStore.getRun(programRunId);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQzNTU1MA=="}, "originalCommit": {"oid": "56591b29c9722f2e21edd6b2b22c61bf7693cb43"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4MDY5NTE1OnYy", "diffSide": "RIGHT", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/services/ProgramNotificationSubscriberService.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwOToxMTo0NlrOG4D2gQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNjo0MjozN1rOG4qrtw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQzNjU0NQ==", "bodyText": "In fact, the profileId, should already be in the systemArgs variable. You don't need the run record at all", "url": "https://github.com/cdapio/cdap/pull/12508#discussion_r461436545", "createdAt": "2020-07-28T09:11:46Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/services/ProgramNotificationSubscriberService.java", "diffHunk": "@@ -536,6 +536,37 @@ private void writeToHeartBeatTable(@Nullable RunRecordDetail recordedRunRecord,\n         // Publish the program STARTING state before starting the program\n         programStateWriter.start(programRunId, newProgramOptions, null, programDescriptor);\n \n+        long provisioningTime = System.currentTimeMillis() / 1000 -\n+          RunIds.getTime(programRunId.getRun(), TimeUnit.SECONDS);\n+        // emit provisioning time metric\n+        ProfileId profileId = null;\n+        try {\n+          RunRecordDetail runRecordMeta = appMetadataStore.getRun(programRunId);\n+          profileId = SystemArguments", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56591b29c9722f2e21edd6b2b22c61bf7693cb43"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA3Mjc1OQ==", "bodyText": "fixed.", "url": "https://github.com/cdapio/cdap/pull/12508#discussion_r462072759", "createdAt": "2020-07-29T06:42:37Z", "author": {"login": "rmstar"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/services/ProgramNotificationSubscriberService.java", "diffHunk": "@@ -536,6 +536,37 @@ private void writeToHeartBeatTable(@Nullable RunRecordDetail recordedRunRecord,\n         // Publish the program STARTING state before starting the program\n         programStateWriter.start(programRunId, newProgramOptions, null, programDescriptor);\n \n+        long provisioningTime = System.currentTimeMillis() / 1000 -\n+          RunIds.getTime(programRunId.getRun(), TimeUnit.SECONDS);\n+        // emit provisioning time metric\n+        ProfileId profileId = null;\n+        try {\n+          RunRecordDetail runRecordMeta = appMetadataStore.getRun(programRunId);\n+          profileId = SystemArguments", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQzNjU0NQ=="}, "originalCommit": {"oid": "56591b29c9722f2e21edd6b2b22c61bf7693cb43"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4MDY5NzI3OnYy", "diffSide": "RIGHT", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/services/ProgramNotificationSubscriberService.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwOToxMjowNFrOG4D3lg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNjo0Mjo0NFrOG4qr5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQzNjgyMg==", "bodyText": "move this to a private function to have better separation of concern", "url": "https://github.com/cdapio/cdap/pull/12508#discussion_r461436822", "createdAt": "2020-07-28T09:12:04Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/services/ProgramNotificationSubscriberService.java", "diffHunk": "@@ -536,6 +536,37 @@ private void writeToHeartBeatTable(@Nullable RunRecordDetail recordedRunRecord,\n         // Publish the program STARTING state before starting the program\n         programStateWriter.start(programRunId, newProgramOptions, null, programDescriptor);\n \n+        long provisioningTime = System.currentTimeMillis() / 1000 -\n+          RunIds.getTime(programRunId.getRun(), TimeUnit.SECONDS);\n+        // emit provisioning time metric\n+        ProfileId profileId = null;\n+        try {\n+          RunRecordDetail runRecordMeta = appMetadataStore.getRun(programRunId);\n+          profileId = SystemArguments\n+            .getProfileIdFromArgs(programRunId.getNamespaceId(),\n+              runRecordMeta.getSystemArgs()).orElse(null);\n+        } catch (IOException e) {\n+          LOG.error(\"Failed to get run record\", e);\n+        }\n+\n+        if (profileId != null) {\n+          Map<String, String> args = programOptions.getArguments().asMap();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56591b29c9722f2e21edd6b2b22c61bf7693cb43"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA3MjgwNQ==", "bodyText": "done.", "url": "https://github.com/cdapio/cdap/pull/12508#discussion_r462072805", "createdAt": "2020-07-29T06:42:44Z", "author": {"login": "rmstar"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/services/ProgramNotificationSubscriberService.java", "diffHunk": "@@ -536,6 +536,37 @@ private void writeToHeartBeatTable(@Nullable RunRecordDetail recordedRunRecord,\n         // Publish the program STARTING state before starting the program\n         programStateWriter.start(programRunId, newProgramOptions, null, programDescriptor);\n \n+        long provisioningTime = System.currentTimeMillis() / 1000 -\n+          RunIds.getTime(programRunId.getRun(), TimeUnit.SECONDS);\n+        // emit provisioning time metric\n+        ProfileId profileId = null;\n+        try {\n+          RunRecordDetail runRecordMeta = appMetadataStore.getRun(programRunId);\n+          profileId = SystemArguments\n+            .getProfileIdFromArgs(programRunId.getNamespaceId(),\n+              runRecordMeta.getSystemArgs()).orElse(null);\n+        } catch (IOException e) {\n+          LOG.error(\"Failed to get run record\", e);\n+        }\n+\n+        if (profileId != null) {\n+          Map<String, String> args = programOptions.getArguments().asMap();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQzNjgyMg=="}, "originalCommit": {"oid": "56591b29c9722f2e21edd6b2b22c61bf7693cb43"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4MDcwMjU2OnYy", "diffSide": "RIGHT", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/services/ProgramNotificationSubscriberService.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwOToxMzoyOFrOG4D6zA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNjo0MzowMlrOG4qsYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQzNzY0NA==", "bodyText": "Misalign. Line break in argument should be aligned to the beginning of the method call:\nmetricsCollectionService.getContext(tags).gauge(Constants.Metrics.Program.PROGRAM_PROVISIONING_DELAY_SECONDS,\n                                                provisioningTime);", "url": "https://github.com/cdapio/cdap/pull/12508#discussion_r461437644", "createdAt": "2020-07-28T09:13:28Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/services/ProgramNotificationSubscriberService.java", "diffHunk": "@@ -536,6 +536,37 @@ private void writeToHeartBeatTable(@Nullable RunRecordDetail recordedRunRecord,\n         // Publish the program STARTING state before starting the program\n         programStateWriter.start(programRunId, newProgramOptions, null, programDescriptor);\n \n+        long provisioningTime = System.currentTimeMillis() / 1000 -\n+          RunIds.getTime(programRunId.getRun(), TimeUnit.SECONDS);\n+        // emit provisioning time metric\n+        ProfileId profileId = null;\n+        try {\n+          RunRecordDetail runRecordMeta = appMetadataStore.getRun(programRunId);\n+          profileId = SystemArguments\n+            .getProfileIdFromArgs(programRunId.getNamespaceId(),\n+              runRecordMeta.getSystemArgs()).orElse(null);\n+        } catch (IOException e) {\n+          LOG.error(\"Failed to get run record\", e);\n+        }\n+\n+        if (profileId != null) {\n+          Map<String, String> args = programOptions.getArguments().asMap();\n+          String provisioner = SystemArguments.getProfileProvisioner(args);\n+\n+          Map<String, String> tags = ImmutableMap.<String, String>builder()\n+            .put(Constants.Metrics.Tag.PROFILE_SCOPE, profileId.getScope().name())\n+            .put(Constants.Metrics.Tag.PROFILE, profileId.getProfile())\n+            .put(Constants.Metrics.Tag.NAMESPACE, programRunId.getNamespace())\n+            .put(Constants.Metrics.Tag.PROGRAM_TYPE, programRunId.getType().getPrettyName())\n+            .put(Constants.Metrics.Tag.APP, programRunId.getApplication())\n+            .put(Constants.Metrics.Tag.PROGRAM, programRunId.getProgram())\n+            .put(Constants.Metrics.Tag.PROVISIONER, provisioner)\n+            .put(Constants.Metrics.Tag.RUN_ID, programRunId.getRun())\n+            .build();\n+          metricsCollectionService.getContext(tags).gauge(Constants.Metrics.Program.PROGRAM_PROVISIONING_DELAY_SECONDS,\n+            provisioningTime);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56591b29c9722f2e21edd6b2b22c61bf7693cb43"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA3MjkyOA==", "bodyText": "fixed.", "url": "https://github.com/cdapio/cdap/pull/12508#discussion_r462072928", "createdAt": "2020-07-29T06:43:02Z", "author": {"login": "rmstar"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/services/ProgramNotificationSubscriberService.java", "diffHunk": "@@ -536,6 +536,37 @@ private void writeToHeartBeatTable(@Nullable RunRecordDetail recordedRunRecord,\n         // Publish the program STARTING state before starting the program\n         programStateWriter.start(programRunId, newProgramOptions, null, programDescriptor);\n \n+        long provisioningTime = System.currentTimeMillis() / 1000 -\n+          RunIds.getTime(programRunId.getRun(), TimeUnit.SECONDS);\n+        // emit provisioning time metric\n+        ProfileId profileId = null;\n+        try {\n+          RunRecordDetail runRecordMeta = appMetadataStore.getRun(programRunId);\n+          profileId = SystemArguments\n+            .getProfileIdFromArgs(programRunId.getNamespaceId(),\n+              runRecordMeta.getSystemArgs()).orElse(null);\n+        } catch (IOException e) {\n+          LOG.error(\"Failed to get run record\", e);\n+        }\n+\n+        if (profileId != null) {\n+          Map<String, String> args = programOptions.getArguments().asMap();\n+          String provisioner = SystemArguments.getProfileProvisioner(args);\n+\n+          Map<String, String> tags = ImmutableMap.<String, String>builder()\n+            .put(Constants.Metrics.Tag.PROFILE_SCOPE, profileId.getScope().name())\n+            .put(Constants.Metrics.Tag.PROFILE, profileId.getProfile())\n+            .put(Constants.Metrics.Tag.NAMESPACE, programRunId.getNamespace())\n+            .put(Constants.Metrics.Tag.PROGRAM_TYPE, programRunId.getType().getPrettyName())\n+            .put(Constants.Metrics.Tag.APP, programRunId.getApplication())\n+            .put(Constants.Metrics.Tag.PROGRAM, programRunId.getProgram())\n+            .put(Constants.Metrics.Tag.PROVISIONER, provisioner)\n+            .put(Constants.Metrics.Tag.RUN_ID, programRunId.getRun())\n+            .build();\n+          metricsCollectionService.getContext(tags).gauge(Constants.Metrics.Program.PROGRAM_PROVISIONING_DELAY_SECONDS,\n+            provisioningTime);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQzNzY0NA=="}, "originalCommit": {"oid": "56591b29c9722f2e21edd6b2b22c61bf7693cb43"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4ODYxMDAyOnYy", "diffSide": "RIGHT", "path": "cdap-common/src/main/java/io/cdap/cdap/common/conf/Constants.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwMDo1NjowMVrOG5PQmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwMDo1OTo0OFrOG5PUVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY3MjAyNQ==", "bodyText": "Is this only for unit test? If it is, define it in the test class", "url": "https://github.com/cdapio/cdap/pull/12508#discussion_r462672025", "createdAt": "2020-07-30T00:56:01Z", "author": {"login": "chtyim"}, "path": "cdap-common/src/main/java/io/cdap/cdap/common/conf/Constants.java", "diffHunk": "@@ -775,6 +776,7 @@\n       public static final String PROGRAM_KILLED_RUNS = \"program.killed.runs\";\n       public static final String PROGRAM_REJECTED_RUNS = \"program.rejected.runs\";\n       public static final String PROGRAM_NODE_MINUTES = \"program.node.minutes\";\n+      public static final String PROGRAM_PROVISIONING_DELAY_SECONDS = \"program.provisioning.delay.seconds\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b10af495686353b1ab4a76811e37bcd5d7109f87"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY3Mjk4MA==", "bodyText": "It's not only for tests. This metric will be read by the metrics writer extension and published to stackdriver.", "url": "https://github.com/cdapio/cdap/pull/12508#discussion_r462672980", "createdAt": "2020-07-30T00:59:48Z", "author": {"login": "rmstar"}, "path": "cdap-common/src/main/java/io/cdap/cdap/common/conf/Constants.java", "diffHunk": "@@ -775,6 +776,7 @@\n       public static final String PROGRAM_KILLED_RUNS = \"program.killed.runs\";\n       public static final String PROGRAM_REJECTED_RUNS = \"program.rejected.runs\";\n       public static final String PROGRAM_NODE_MINUTES = \"program.node.minutes\";\n+      public static final String PROGRAM_PROVISIONING_DELAY_SECONDS = \"program.provisioning.delay.seconds\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY3MjAyNQ=="}, "originalCommit": {"oid": "b10af495686353b1ab4a76811e37bcd5d7109f87"}, "originalPosition": 12}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3260, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}