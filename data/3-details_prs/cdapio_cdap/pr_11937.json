{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1ODMwODk2", "number": 11937, "title": "(CDAP-16243) Added upgrade mechanism System Apps managed by SystemAppManagementService", "bodyText": "Changes includes:\n\nStart SystemAppManagementService only after BootStrap steps are run due to dependency on metadata and load system artifacts steps.\nForce restart programs running for a system app when ENABLE_ step is run for it to make sure programs are running with latest system artifacts and arguments. This is safe to do as system apps are stateless and we already restart them while upgrading an instance of CDAP.\n\nTESTS: Tested using unit tests.", "createdAt": "2020-03-09T21:37:03Z", "url": "https://github.com/cdapio/cdap/pull/11937", "merged": true, "mergeCommit": {"oid": "849aab7e3bd511cf7cfde86a96985c50b3a45d8c"}, "closed": true, "closedAt": "2020-03-10T00:05:49Z", "author": {"login": "pandyajay10"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcME03MAH2gAyMzg1ODMwODk2OjI3ZjcxMzFlNWIwMTYwM2U4ODdhZjNjMGFkNWY5NjUxMGVmNGVlMjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMHAwUAFqTM3MTYwNDIyMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "27f7131e5b01603e887af3c0ad5f96510ef4ee28", "author": {"user": null}, "url": "https://github.com/cdapio/cdap/commit/27f7131e5b01603e887af3c0ad5f96510ef4ee28", "committedDate": "2020-03-09T21:30:32Z", "message": "Support force upgrade for system applications in CDAP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e711c946ef0adb6a3814da97487633bd8db8d6e", "author": {"user": null}, "url": "https://github.com/cdapio/cdap/commit/4e711c946ef0adb6a3814da97487633bd8db8d6e", "committedDate": "2020-03-09T21:41:55Z", "message": "Fixing unitended changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4bbe783498e3c87f0be964c47dc526944eb69c4", "author": {"user": null}, "url": "https://github.com/cdapio/cdap/commit/a4bbe783498e3c87f0be964c47dc526944eb69c4", "committedDate": "2020-03-09T21:53:14Z", "message": "Adding a TODO"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxNTUzMDEw", "url": "https://github.com/cdapio/cdap/pull/11937#pullrequestreview-371553010", "createdAt": "2020-03-09T21:49:30Z", "commit": {"oid": "4e711c946ef0adb6a3814da97487633bd8db8d6e"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQyMTo1NDoyN1rOFz6sbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQyMTo1Nzo1NlrOFz6ySQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk4MzM0Mg==", "bodyText": "don't need to document exceptions in a unit test case.", "url": "https://github.com/cdapio/cdap/pull/11937#discussion_r389983342", "createdAt": "2020-03-09T21:54:27Z", "author": {"login": "albertshau"}, "path": "cdap-app-fabric/src/test/java/io/cdap/cdap/internal/sysapp/SystemAppManagementServiceTest.java", "diffHunk": "@@ -123,4 +124,45 @@ public void testSystemAppManagementServiceE2E() throws Exception {\n     waitState(serviceId1, RUNNING);\n     Assert.assertEquals(RUNNING, getProgramStatus(serviceId1));\n   }\n+\n+  /**\n+   * Tests SystemAppManagementService's upgrade method end to end by running this scenario:\n+   * 1. Creates a system app config for an application into corresponding directory with artifact version VERSION1.\n+   * 2. Successfully read and load the config.\n+   * 3. Runs all steps to enable a system app , tests SystemAppEnableExecutor.\n+   * 4. Deploys the VERSION1 app and runs all programs corresponding to the app.\n+   * 6. Updates system app config with app version upgraded to VERSION2.\n+   * 7. On restart of SystemAppManagementService, app should kill old running programs and start program again.\n+   * @throws Exception", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e711c946ef0adb6a3814da97487633bd8db8d6e"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk4NDg0MQ==", "bodyText": "I believe this can also throw a ConflictException if the program is already stopped. If so, it will be caught, then ignored and the program will never be started.\nShould wrap this in a try-catch as well, ignore the conflict, and move on to running it.", "url": "https://github.com/cdapio/cdap/pull/11937#discussion_r389984841", "createdAt": "2020-03-09T21:57:56Z", "author": {"login": "albertshau"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java", "diffHunk": "@@ -136,11 +136,13 @@ private ApplicationWithPrograms deploySystemApp(Arguments arguments) throws Exce\n \n   private void startProgram(ProgramId programId) throws Exception {\n     try {\n-      // TODO(CDAP-16243): Restart program if the application has changed.\n-      // do nothing if the program is already running\n       ProgramStatus currentStatus = programLifecycleService.getProgramStatus(programId);\n-      if (currentStatus != ProgramStatus.STOPPED) {\n-        return;\n+      // If a system app is already running, it needs to be restarted as app artifact/arguments might have changed.\n+      // Restart should trigger running programs with latest version.\n+      // TODO(CDAP-16243): Find smarter way to trigger restart of programs rather than always restarting. May be\n+      //                   checking if artifact version has changed would be a good start.\n+      if (currentStatus == ProgramStatus.RUNNING) {\n+        programLifecycleService.stop(programId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4bbe783498e3c87f0be964c47dc526944eb69c4"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ab02211c9f885d2f6c9fc9ed91c7fbbfa5143fa", "author": {"user": null}, "url": "https://github.com/cdapio/cdap/commit/8ab02211c9f885d2f6c9fc9ed91c7fbbfa5143fa", "committedDate": "2020-03-09T23:24:22Z", "message": "Resolving comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6de8a19e0bbd2310d288f26c366366afeb342a2f", "author": {"user": null}, "url": "https://github.com/cdapio/cdap/commit/6de8a19e0bbd2310d288f26c366366afeb342a2f", "committedDate": "2020-03-09T23:47:23Z", "message": "Stylecheck fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxNjA0MjIz", "url": "https://github.com/cdapio/cdap/pull/11937#pullrequestreview-371604223", "createdAt": "2020-03-10T00:03:20Z", "commit": {"oid": "6de8a19e0bbd2310d288f26c366366afeb342a2f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2222, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}