{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYzODEyMTc5", "number": 12576, "reviewThreads": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwNjoyODowMlrOEVrzkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QyMToxOToyOFrOEWW1AQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxMTczMjY3OnYy", "diffSide": "LEFT", "path": "cdap-kubernetes/src/main/java/io/cdap/cdap/k8s/common/DeploymentMetaProvider.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwNjoyODowMlrOG8k90g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwNjoyODowMlrOG8k90g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE3MzM5NA==", "bodyText": "Removed these files specific to Deployment and StatefulSet. Took corresponding changes from #12522", "url": "https://github.com/cdapio/cdap/pull/12576#discussion_r466173394", "createdAt": "2020-08-06T06:28:02Z", "author": {"login": "sagarkapare"}, "path": "cdap-kubernetes/src/main/java/io/cdap/cdap/k8s/common/DeploymentMetaProvider.java", "diffHunk": "@@ -1,56 +0,0 @@\n-/*", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a47358fbb7d127d765deeb453f632843ba056f1"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxMTczNDExOnYy", "diffSide": "RIGHT", "path": "cdap-kubernetes/src/main/java/io/cdap/cdap/k8s/runtime/AbstractKubeTwillPreparer.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwNjoyODozN1rOG8k-qA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwNjoyODozN1rOG8k-qA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE3MzYwOA==", "bodyText": "Changes in this file are taken from #12522", "url": "https://github.com/cdapio/cdap/pull/12576#discussion_r466173608", "createdAt": "2020-08-06T06:28:37Z", "author": {"login": "sagarkapare"}, "path": "cdap-kubernetes/src/main/java/io/cdap/cdap/k8s/runtime/AbstractKubeTwillPreparer.java", "diffHunk": "@@ -16,16 +16,20 @@\n \n package io.cdap.cdap.k8s.runtime;\n \n+import com.google.common.hash.Hashing;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a47358fbb7d127d765deeb453f632843ba056f1"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxMTczNDk2OnYy", "diffSide": "RIGHT", "path": "cdap-kubernetes/src/main/java/io/cdap/cdap/k8s/runtime/ApiCallbackAdapter.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwNjoyODo1OFrOG8k_LA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwNjoyODo1OFrOG8k_LA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE3Mzc0MA==", "bodyText": "This file is copied from #12522", "url": "https://github.com/cdapio/cdap/pull/12576#discussion_r466173740", "createdAt": "2020-08-06T06:28:58Z", "author": {"login": "sagarkapare"}, "path": "cdap-kubernetes/src/main/java/io/cdap/cdap/k8s/runtime/ApiCallbackAdapter.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a47358fbb7d127d765deeb453f632843ba056f1"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxMTczNTc5OnYy", "diffSide": "RIGHT", "path": "cdap-kubernetes/src/main/java/io/cdap/cdap/k8s/runtime/AppResourceWatcherThread.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwNjoyOToyMFrOG8k_qw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwNjoyOToyMFrOG8k_qw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE3Mzg2Nw==", "bodyText": "This class is also taken from #12522", "url": "https://github.com/cdapio/cdap/pull/12576#discussion_r466173867", "createdAt": "2020-08-06T06:29:20Z", "author": {"login": "sagarkapare"}, "path": "cdap-kubernetes/src/main/java/io/cdap/cdap/k8s/runtime/AppResourceWatcherThread.java", "diffHunk": "@@ -0,0 +1,160 @@\n+/*", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a47358fbb7d127d765deeb453f632843ba056f1"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxMTczOTcyOnYy", "diffSide": "RIGHT", "path": "cdap-kubernetes/src/main/java/io/cdap/cdap/k8s/runtime/KubeTwillController.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwNjozMDo1MlrOG8lCAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwNjozMDo1MlrOG8lCAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE3NDQ2NQ==", "bodyText": "Changes are taken from #12522 Except while deleting pod in the statefulset making sure that the uid matches with the one received from poller info so that we dont accidentally delete the pod running some other preview.", "url": "https://github.com/cdapio/cdap/pull/12576#discussion_r466174465", "createdAt": "2020-08-06T06:30:52Z", "author": {"login": "sagarkapare"}, "path": "cdap-kubernetes/src/main/java/io/cdap/cdap/k8s/runtime/KubeTwillController.java", "diffHunk": "@@ -262,35 +287,169 @@ public TerminationStatus getTerminationStatus() {\n   }\n \n   /**\n-   * Allows more succinct creation of ApiCallback.\n+   * Creates a label selector that matches all labels in the meta object.\n+   */\n+  private String getLabelSelector() {\n+    return meta.getLabels().entrySet().stream()\n+      .map(e -> String.format(\"%s=%s\", e.getKey(), e.getValue()))\n+      .collect(Collectors.joining(\",\"));\n+  }\n+\n+  /**\n+   * Restarts the given set of instances. This method currently only supports restart of stateful set.\n+   *\n+   * @param runnable name of the runnable to restart. This is currently unused\n+   * @param instanceIds the set of instance ids to restart\n+   * @return a {@link CompletableFuture} that will complete when the delete operation completed\n    */\n-  private static class CallbackAdapter implements ApiCallback<V1Status> {\n-    private final Consumer<ApiException> onFailure;\n-    private final Runnable onSuccess;\n+  private CompletableFuture<String> doRestartInstances(String runnable, Set<Integer> instanceIds) {\n+    CompletableFuture<String> resultFuture = new CompletableFuture<>();\n+    CoreV1Api api = new CoreV1Api(apiClient);\n+\n+    // Only support for stateful set for now\n+    if (!V1StatefulSet.class.equals(resourceType)) {\n+      resultFuture.completeExceptionally(\n+        new UnsupportedOperationException(\"Instance restart by instance id is only supported for statefulsets\"));\n+      return resultFuture;\n+    }\n \n-    CallbackAdapter(Consumer<ApiException> onFailure, Runnable onSuccess) {\n-      this.onFailure = onFailure;\n-      this.onSuccess = onSuccess;\n+    if (instanceIds.size() > 1) {\n+      resultFuture.completeExceptionally(\n+        new UnsupportedOperationException(\"Only one instance can be restarted at a time.\"));\n+      return resultFuture;\n     }\n \n-    @Override\n-    public void onFailure(ApiException e, int i, Map<String, List<String>> map) {\n-      onFailure.accept(e);\n+    int instanceId = instanceIds.iterator().next();\n+    V1DeleteOptions deleteOptions = new V1DeleteOptions().preconditions(new V1Preconditions().uid(runnable));\n+\n+    String podName = String.format(\"%s-%d\", meta.getName(), instanceId);\n+    LOG.debug(\"Deleting pod with name {}\", podName);\n+\n+    try {\n+      api.deleteNamespacedPodAsync(podName, kubeNamespace, null, deleteOptions, null, null, null, null,\n+                                   createCallbackFutureAdapter(resultFuture, r -> runnable));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a47358fbb7d127d765deeb453f632843ba056f1"}, "originalPosition": 242}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxMTc0MTUzOnYy", "diffSide": "RIGHT", "path": "cdap-kubernetes/src/main/java/io/cdap/cdap/k8s/runtime/KubeTwillRunnerService.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwNjozMTo0NFrOG8lDIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwNjozMTo0NFrOG8lDIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE3NDc1NA==", "bodyText": "Changes in this class are from #12522 adapted for working with release 6.1", "url": "https://github.com/cdapio/cdap/pull/12576#discussion_r466174754", "createdAt": "2020-08-06T06:31:44Z", "author": {"login": "sagarkapare"}, "path": "cdap-kubernetes/src/main/java/io/cdap/cdap/k8s/runtime/KubeTwillRunnerService.java", "diffHunk": "@@ -16,18 +16,18 @@\n \n package io.cdap.cdap.k8s.runtime;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a47358fbb7d127d765deeb453f632843ba056f1"}, "originalPosition": 2}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxMTc1MTQ3OnYy", "diffSide": "RIGHT", "path": "cdap-kubernetes/src/main/java/io/cdap/cdap/k8s/runtime/StatefulSetTwillPreparer.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwNjozNTozNlrOG8lI6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwMDoyNDoyMVrOG-kIsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE3NjIzNQ==", "bodyText": "Setting up the owner reference for the preview runner statefulset as the preview manager pod so that when that pod gets deleted we recreate stateful sets.", "url": "https://github.com/cdapio/cdap/pull/12576#discussion_r466176235", "createdAt": "2020-08-06T06:35:36Z", "author": {"login": "sagarkapare"}, "path": "cdap-kubernetes/src/main/java/io/cdap/cdap/k8s/runtime/StatefulSetTwillPreparer.java", "diffHunk": "@@ -68,46 +69,51 @@\n   private final PodInfo podInfo;\n   private final Map<String, String> cConf;\n \n-  StatefulSetTwillPreparer(ApiClient apiClient, String kubeNamespace, PodInfo podInfo, TwillSpecification spec,\n-                           RunId twillRunId, V1ObjectMeta resourceMeta, Map<String, String> cConf,\n-                           KubeTwillControllerFactory controllerFactory) {\n-    super(apiClient, kubeNamespace, podInfo, spec, twillRunId, resourceMeta, cConf, controllerFactory);\n+  StatefulSetTwillPreparer(Map<String, String> cConf, ApiClient apiClient, String kubeNamespace, PodInfo podInfo,\n+                           TwillSpecification spec, RunId twillRunId, String resourcePrefix,\n+                           Map<String, String> extraLabels, KubeTwillControllerFactory controllerFactory) {\n+    super(cConf, apiClient, kubeNamespace, podInfo, spec, twillRunId, resourcePrefix, extraLabels, V1StatefulSet.class,\n+          controllerFactory);\n     this.podInfo = podInfo;\n     this.cConf = cConf;\n   }\n \n   @Override\n-  protected void createKubeResources(V1ObjectMeta resourceMeta, V1ResourceRequirements resourceRequirements,\n-                                     List<V1EnvVar> envVars, long timeout,\n-                                     TimeUnit timeoutUnit) throws IOException, ApiException {\n+  protected V1ObjectMeta createKubeResources(V1ObjectMeta resourceMeta, V1ResourceRequirements resourceRequirements,\n+                                             List<V1EnvVar> envVars, long timeout, TimeUnit timeoutUnit)\n+    throws IOException, ApiException {\n     AppsV1Api appsApi = new AppsV1Api(getApiClient());\n     V1StatefulSet statefulSet = createStatefulSet(resourceMeta, resourceRequirements, envVars,\n                                                   timeoutUnit.toMillis(timeout));\n     LOG.info(\"Creating StatefulSet with spec to K8s {}\", getApiClient().getJSON().serialize(statefulSet));\n     try {\n-      appsApi.createNamespacedStatefulSet(getKubeNamespace(), statefulSet, \"true\", null, null);\n+      statefulSet = appsApi.createNamespacedStatefulSet(getKubeNamespace(), statefulSet, \"true\", null, null);\n     } catch (ApiException e) {\n       if (e.getCode() != HttpURLConnection.HTTP_CONFLICT) {\n         throw e;\n       }\n     }\n     LOG.info(\"Created StatefulSet with spec to K8s {}\", getApiClient().getJSON().serialize(statefulSet));\n+    return statefulSet.getMetadata();\n   }\n \n   private V1StatefulSet createStatefulSet(V1ObjectMeta resourceMeta, V1ResourceRequirements resourceRequirements,\n                                           List<V1EnvVar> envVars, long startTimeoutMillis) {\n+    // Update owner reference for the statefulset to be current pod\n+    // so that pod deletion triggers deletion of statefulsets too.\n+    V1OwnerReference ownerReference = new V1OwnerReference()\n+      .apiVersion(podInfo.getApiVersion())\n+      .kind(podInfo.getKind())\n+      .name(podInfo.getName())\n+      .uid(podInfo.getUid())\n+      .blockOwnerDeletion(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a47358fbb7d127d765deeb453f632843ba056f1"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM5Njk5Mw==", "bodyText": "Why the owner is the pod?? If the pod deleted then the runner statefulset will be deleted?? If that what you wanted? If the pod is deleted manually to force a restart, the preview runners statefulset will be deleted too?", "url": "https://github.com/cdapio/cdap/pull/12576#discussion_r467396993", "createdAt": "2020-08-08T08:40:11Z", "author": {"login": "chtyim"}, "path": "cdap-kubernetes/src/main/java/io/cdap/cdap/k8s/runtime/StatefulSetTwillPreparer.java", "diffHunk": "@@ -68,46 +69,51 @@\n   private final PodInfo podInfo;\n   private final Map<String, String> cConf;\n \n-  StatefulSetTwillPreparer(ApiClient apiClient, String kubeNamespace, PodInfo podInfo, TwillSpecification spec,\n-                           RunId twillRunId, V1ObjectMeta resourceMeta, Map<String, String> cConf,\n-                           KubeTwillControllerFactory controllerFactory) {\n-    super(apiClient, kubeNamespace, podInfo, spec, twillRunId, resourceMeta, cConf, controllerFactory);\n+  StatefulSetTwillPreparer(Map<String, String> cConf, ApiClient apiClient, String kubeNamespace, PodInfo podInfo,\n+                           TwillSpecification spec, RunId twillRunId, String resourcePrefix,\n+                           Map<String, String> extraLabels, KubeTwillControllerFactory controllerFactory) {\n+    super(cConf, apiClient, kubeNamespace, podInfo, spec, twillRunId, resourcePrefix, extraLabels, V1StatefulSet.class,\n+          controllerFactory);\n     this.podInfo = podInfo;\n     this.cConf = cConf;\n   }\n \n   @Override\n-  protected void createKubeResources(V1ObjectMeta resourceMeta, V1ResourceRequirements resourceRequirements,\n-                                     List<V1EnvVar> envVars, long timeout,\n-                                     TimeUnit timeoutUnit) throws IOException, ApiException {\n+  protected V1ObjectMeta createKubeResources(V1ObjectMeta resourceMeta, V1ResourceRequirements resourceRequirements,\n+                                             List<V1EnvVar> envVars, long timeout, TimeUnit timeoutUnit)\n+    throws IOException, ApiException {\n     AppsV1Api appsApi = new AppsV1Api(getApiClient());\n     V1StatefulSet statefulSet = createStatefulSet(resourceMeta, resourceRequirements, envVars,\n                                                   timeoutUnit.toMillis(timeout));\n     LOG.info(\"Creating StatefulSet with spec to K8s {}\", getApiClient().getJSON().serialize(statefulSet));\n     try {\n-      appsApi.createNamespacedStatefulSet(getKubeNamespace(), statefulSet, \"true\", null, null);\n+      statefulSet = appsApi.createNamespacedStatefulSet(getKubeNamespace(), statefulSet, \"true\", null, null);\n     } catch (ApiException e) {\n       if (e.getCode() != HttpURLConnection.HTTP_CONFLICT) {\n         throw e;\n       }\n     }\n     LOG.info(\"Created StatefulSet with spec to K8s {}\", getApiClient().getJSON().serialize(statefulSet));\n+    return statefulSet.getMetadata();\n   }\n \n   private V1StatefulSet createStatefulSet(V1ObjectMeta resourceMeta, V1ResourceRequirements resourceRequirements,\n                                           List<V1EnvVar> envVars, long startTimeoutMillis) {\n+    // Update owner reference for the statefulset to be current pod\n+    // so that pod deletion triggers deletion of statefulsets too.\n+    V1OwnerReference ownerReference = new V1OwnerReference()\n+      .apiVersion(podInfo.getApiVersion())\n+      .kind(podInfo.getKind())\n+      .name(podInfo.getName())\n+      .uid(podInfo.getUid())\n+      .blockOwnerDeletion(true);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE3NjIzNQ=="}, "originalCommit": {"oid": "0a47358fbb7d127d765deeb453f632843ba056f1"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE3NjUxNA==", "bodyText": "Yes this is done intentionally. Preview runner statefulset does not store any state anyway. Deleting the runners when preview manager deleted make sure both are running with same version of the code. Also in absence of this deletion, preview manager can create new statefulset for runner and pods from which can try polling for preview request for short amount of time.", "url": "https://github.com/cdapio/cdap/pull/12576#discussion_r468176514", "createdAt": "2020-08-10T20:47:20Z", "author": {"login": "sagarkapare"}, "path": "cdap-kubernetes/src/main/java/io/cdap/cdap/k8s/runtime/StatefulSetTwillPreparer.java", "diffHunk": "@@ -68,46 +69,51 @@\n   private final PodInfo podInfo;\n   private final Map<String, String> cConf;\n \n-  StatefulSetTwillPreparer(ApiClient apiClient, String kubeNamespace, PodInfo podInfo, TwillSpecification spec,\n-                           RunId twillRunId, V1ObjectMeta resourceMeta, Map<String, String> cConf,\n-                           KubeTwillControllerFactory controllerFactory) {\n-    super(apiClient, kubeNamespace, podInfo, spec, twillRunId, resourceMeta, cConf, controllerFactory);\n+  StatefulSetTwillPreparer(Map<String, String> cConf, ApiClient apiClient, String kubeNamespace, PodInfo podInfo,\n+                           TwillSpecification spec, RunId twillRunId, String resourcePrefix,\n+                           Map<String, String> extraLabels, KubeTwillControllerFactory controllerFactory) {\n+    super(cConf, apiClient, kubeNamespace, podInfo, spec, twillRunId, resourcePrefix, extraLabels, V1StatefulSet.class,\n+          controllerFactory);\n     this.podInfo = podInfo;\n     this.cConf = cConf;\n   }\n \n   @Override\n-  protected void createKubeResources(V1ObjectMeta resourceMeta, V1ResourceRequirements resourceRequirements,\n-                                     List<V1EnvVar> envVars, long timeout,\n-                                     TimeUnit timeoutUnit) throws IOException, ApiException {\n+  protected V1ObjectMeta createKubeResources(V1ObjectMeta resourceMeta, V1ResourceRequirements resourceRequirements,\n+                                             List<V1EnvVar> envVars, long timeout, TimeUnit timeoutUnit)\n+    throws IOException, ApiException {\n     AppsV1Api appsApi = new AppsV1Api(getApiClient());\n     V1StatefulSet statefulSet = createStatefulSet(resourceMeta, resourceRequirements, envVars,\n                                                   timeoutUnit.toMillis(timeout));\n     LOG.info(\"Creating StatefulSet with spec to K8s {}\", getApiClient().getJSON().serialize(statefulSet));\n     try {\n-      appsApi.createNamespacedStatefulSet(getKubeNamespace(), statefulSet, \"true\", null, null);\n+      statefulSet = appsApi.createNamespacedStatefulSet(getKubeNamespace(), statefulSet, \"true\", null, null);\n     } catch (ApiException e) {\n       if (e.getCode() != HttpURLConnection.HTTP_CONFLICT) {\n         throw e;\n       }\n     }\n     LOG.info(\"Created StatefulSet with spec to K8s {}\", getApiClient().getJSON().serialize(statefulSet));\n+    return statefulSet.getMetadata();\n   }\n \n   private V1StatefulSet createStatefulSet(V1ObjectMeta resourceMeta, V1ResourceRequirements resourceRequirements,\n                                           List<V1EnvVar> envVars, long startTimeoutMillis) {\n+    // Update owner reference for the statefulset to be current pod\n+    // so that pod deletion triggers deletion of statefulsets too.\n+    V1OwnerReference ownerReference = new V1OwnerReference()\n+      .apiVersion(podInfo.getApiVersion())\n+      .kind(podInfo.getKind())\n+      .name(podInfo.getName())\n+      .uid(podInfo.getUid())\n+      .blockOwnerDeletion(true);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE3NjIzNQ=="}, "originalCommit": {"oid": "0a47358fbb7d127d765deeb453f632843ba056f1"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI0MjQ3NQ==", "bodyText": "So, this means if the preview manager pod get restarted due to failure node or OOM, then it kills all running previews? Seems like not a very good design.", "url": "https://github.com/cdapio/cdap/pull/12576#discussion_r468242475", "createdAt": "2020-08-10T23:35:09Z", "author": {"login": "chtyim"}, "path": "cdap-kubernetes/src/main/java/io/cdap/cdap/k8s/runtime/StatefulSetTwillPreparer.java", "diffHunk": "@@ -68,46 +69,51 @@\n   private final PodInfo podInfo;\n   private final Map<String, String> cConf;\n \n-  StatefulSetTwillPreparer(ApiClient apiClient, String kubeNamespace, PodInfo podInfo, TwillSpecification spec,\n-                           RunId twillRunId, V1ObjectMeta resourceMeta, Map<String, String> cConf,\n-                           KubeTwillControllerFactory controllerFactory) {\n-    super(apiClient, kubeNamespace, podInfo, spec, twillRunId, resourceMeta, cConf, controllerFactory);\n+  StatefulSetTwillPreparer(Map<String, String> cConf, ApiClient apiClient, String kubeNamespace, PodInfo podInfo,\n+                           TwillSpecification spec, RunId twillRunId, String resourcePrefix,\n+                           Map<String, String> extraLabels, KubeTwillControllerFactory controllerFactory) {\n+    super(cConf, apiClient, kubeNamespace, podInfo, spec, twillRunId, resourcePrefix, extraLabels, V1StatefulSet.class,\n+          controllerFactory);\n     this.podInfo = podInfo;\n     this.cConf = cConf;\n   }\n \n   @Override\n-  protected void createKubeResources(V1ObjectMeta resourceMeta, V1ResourceRequirements resourceRequirements,\n-                                     List<V1EnvVar> envVars, long timeout,\n-                                     TimeUnit timeoutUnit) throws IOException, ApiException {\n+  protected V1ObjectMeta createKubeResources(V1ObjectMeta resourceMeta, V1ResourceRequirements resourceRequirements,\n+                                             List<V1EnvVar> envVars, long timeout, TimeUnit timeoutUnit)\n+    throws IOException, ApiException {\n     AppsV1Api appsApi = new AppsV1Api(getApiClient());\n     V1StatefulSet statefulSet = createStatefulSet(resourceMeta, resourceRequirements, envVars,\n                                                   timeoutUnit.toMillis(timeout));\n     LOG.info(\"Creating StatefulSet with spec to K8s {}\", getApiClient().getJSON().serialize(statefulSet));\n     try {\n-      appsApi.createNamespacedStatefulSet(getKubeNamespace(), statefulSet, \"true\", null, null);\n+      statefulSet = appsApi.createNamespacedStatefulSet(getKubeNamespace(), statefulSet, \"true\", null, null);\n     } catch (ApiException e) {\n       if (e.getCode() != HttpURLConnection.HTTP_CONFLICT) {\n         throw e;\n       }\n     }\n     LOG.info(\"Created StatefulSet with spec to K8s {}\", getApiClient().getJSON().serialize(statefulSet));\n+    return statefulSet.getMetadata();\n   }\n \n   private V1StatefulSet createStatefulSet(V1ObjectMeta resourceMeta, V1ResourceRequirements resourceRequirements,\n                                           List<V1EnvVar> envVars, long startTimeoutMillis) {\n+    // Update owner reference for the statefulset to be current pod\n+    // so that pod deletion triggers deletion of statefulsets too.\n+    V1OwnerReference ownerReference = new V1OwnerReference()\n+      .apiVersion(podInfo.getApiVersion())\n+      .kind(podInfo.getKind())\n+      .name(podInfo.getName())\n+      .uid(podInfo.getUid())\n+      .blockOwnerDeletion(true);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE3NjIzNQ=="}, "originalCommit": {"oid": "0a47358fbb7d127d765deeb453f632843ba056f1"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI1Njk0Nw==", "bodyText": "As discussed offline filed an improvement here - https://issues.cask.co/browse/CDAP-17188", "url": "https://github.com/cdapio/cdap/pull/12576#discussion_r468256947", "createdAt": "2020-08-11T00:24:21Z", "author": {"login": "sagarkapare"}, "path": "cdap-kubernetes/src/main/java/io/cdap/cdap/k8s/runtime/StatefulSetTwillPreparer.java", "diffHunk": "@@ -68,46 +69,51 @@\n   private final PodInfo podInfo;\n   private final Map<String, String> cConf;\n \n-  StatefulSetTwillPreparer(ApiClient apiClient, String kubeNamespace, PodInfo podInfo, TwillSpecification spec,\n-                           RunId twillRunId, V1ObjectMeta resourceMeta, Map<String, String> cConf,\n-                           KubeTwillControllerFactory controllerFactory) {\n-    super(apiClient, kubeNamespace, podInfo, spec, twillRunId, resourceMeta, cConf, controllerFactory);\n+  StatefulSetTwillPreparer(Map<String, String> cConf, ApiClient apiClient, String kubeNamespace, PodInfo podInfo,\n+                           TwillSpecification spec, RunId twillRunId, String resourcePrefix,\n+                           Map<String, String> extraLabels, KubeTwillControllerFactory controllerFactory) {\n+    super(cConf, apiClient, kubeNamespace, podInfo, spec, twillRunId, resourcePrefix, extraLabels, V1StatefulSet.class,\n+          controllerFactory);\n     this.podInfo = podInfo;\n     this.cConf = cConf;\n   }\n \n   @Override\n-  protected void createKubeResources(V1ObjectMeta resourceMeta, V1ResourceRequirements resourceRequirements,\n-                                     List<V1EnvVar> envVars, long timeout,\n-                                     TimeUnit timeoutUnit) throws IOException, ApiException {\n+  protected V1ObjectMeta createKubeResources(V1ObjectMeta resourceMeta, V1ResourceRequirements resourceRequirements,\n+                                             List<V1EnvVar> envVars, long timeout, TimeUnit timeoutUnit)\n+    throws IOException, ApiException {\n     AppsV1Api appsApi = new AppsV1Api(getApiClient());\n     V1StatefulSet statefulSet = createStatefulSet(resourceMeta, resourceRequirements, envVars,\n                                                   timeoutUnit.toMillis(timeout));\n     LOG.info(\"Creating StatefulSet with spec to K8s {}\", getApiClient().getJSON().serialize(statefulSet));\n     try {\n-      appsApi.createNamespacedStatefulSet(getKubeNamespace(), statefulSet, \"true\", null, null);\n+      statefulSet = appsApi.createNamespacedStatefulSet(getKubeNamespace(), statefulSet, \"true\", null, null);\n     } catch (ApiException e) {\n       if (e.getCode() != HttpURLConnection.HTTP_CONFLICT) {\n         throw e;\n       }\n     }\n     LOG.info(\"Created StatefulSet with spec to K8s {}\", getApiClient().getJSON().serialize(statefulSet));\n+    return statefulSet.getMetadata();\n   }\n \n   private V1StatefulSet createStatefulSet(V1ObjectMeta resourceMeta, V1ResourceRequirements resourceRequirements,\n                                           List<V1EnvVar> envVars, long startTimeoutMillis) {\n+    // Update owner reference for the statefulset to be current pod\n+    // so that pod deletion triggers deletion of statefulsets too.\n+    V1OwnerReference ownerReference = new V1OwnerReference()\n+      .apiVersion(podInfo.getApiVersion())\n+      .kind(podInfo.getKind())\n+      .name(podInfo.getName())\n+      .uid(podInfo.getUid())\n+      .blockOwnerDeletion(true);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE3NjIzNQ=="}, "originalCommit": {"oid": "0a47358fbb7d127d765deeb453f632843ba056f1"}, "originalPosition": 57}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxMTc1MjgwOnYy", "diffSide": "LEFT", "path": "cdap-kubernetes/src/main/java/io/cdap/cdap/master/environment/k8s/KubeMasterEnvironment.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwNjozNjowNVrOG8lJtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwNjozNjowNVrOG8lJtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE3NjQzNw==", "bodyText": "Removed pod killer task as we no longer execute user code in preview manager pod.", "url": "https://github.com/cdapio/cdap/pull/12576#discussion_r466176437", "createdAt": "2020-08-06T06:36:05Z", "author": {"login": "sagarkapare"}, "path": "cdap-kubernetes/src/main/java/io/cdap/cdap/master/environment/k8s/KubeMasterEnvironment.java", "diffHunk": "@@ -125,30 +119,6 @@ public void initialize(MasterEnvironmentContext context) throws IOException, Api\n     discoveryService = new KubeDiscoveryService(namespace, \"cdap-\" + instanceName + \"-\", podLabels,\n                                                 podInfo.getOwnerReferences());\n \n-    // Optionally creates the pod killer task\n-    String podKillerSelector = conf.getOrDefault(POD_KILLER_SELECTOR, DEFAULT_POD_KILLER_SELECTOR);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a47358fbb7d127d765deeb453f632843ba056f1"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxMTc2MDM3OnYy", "diffSide": "RIGHT", "path": "cdap-master/src/test/java/io/cdap/cdap/master/environment/k8s/PreviewServiceMainTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwNjozOTowM1rOG8lOIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwNjozOTowM1rOG8lOIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE3NzU2OQ==", "bodyText": "Ignoring PreviewServiceMainTest case for now. Will file a bug to add it back with refactoring. Its bit tricky to run both PreviewServiceMain and PreviewRunnerMain in test case and have shared level db database.", "url": "https://github.com/cdapio/cdap/pull/12576#discussion_r466177569", "createdAt": "2020-08-06T06:39:03Z", "author": {"login": "sagarkapare"}, "path": "cdap-master/src/test/java/io/cdap/cdap/master/environment/k8s/PreviewServiceMainTest.java", "diffHunk": "@@ -56,7 +57,7 @@\n public class PreviewServiceMainTest extends MasterServiceMainTestBase {\n   private static final Gson GSON = new Gson();\n \n-  @Test\n+  @Ignore", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a47358fbb7d127d765deeb453f632843ba056f1"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxMjAzNzAyOnYy", "diffSide": "RIGHT", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/DefaultPreviewRunnerManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwODowMjoyOFrOG8ny8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxNzoxOToyM1rOG9hw3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjIxOTc2MA==", "bodyText": "Group final fields together", "url": "https://github.com/cdapio/cdap/pull/12576#discussion_r466219760", "createdAt": "2020-08-06T08:02:28Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/DefaultPreviewRunnerManager.java", "diffHunk": "@@ -89,6 +89,7 @@\n   private final LevelDBTableService previewLevelDBTableService;\n   private final PreviewRunnerServiceFactory previewRunnerServiceFactory;\n   private PreviewRunner runner;\n+  private final PreviewRunnerSystemTerminator previewRunnerSystemTerminator;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a47358fbb7d127d765deeb453f632843ba056f1"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE2OTUwMg==", "bodyText": "removed PreviewRunnerSystemTerminator", "url": "https://github.com/cdapio/cdap/pull/12576#discussion_r467169502", "createdAt": "2020-08-07T17:19:23Z", "author": {"login": "sagarkapare"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/DefaultPreviewRunnerManager.java", "diffHunk": "@@ -89,6 +89,7 @@\n   private final LevelDBTableService previewLevelDBTableService;\n   private final PreviewRunnerServiceFactory previewRunnerServiceFactory;\n   private PreviewRunner runner;\n+  private final PreviewRunnerSystemTerminator previewRunnerSystemTerminator;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjIxOTc2MA=="}, "originalCommit": {"oid": "0a47358fbb7d127d765deeb453f632843ba056f1"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxNjUyOTYzOnYy", "diffSide": "RIGHT", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/PreviewRunnerSystemTerminator.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwOToxNjowM1rOG9StRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxNzoxOTowNlrOG9hwSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkyMjgyMQ==", "bodyText": "Shouldn't need this interface. In the PreviewRunnerMain, when adding the PreviewRunnerManager to the core service, add a listener such that on the Service completion, call System.exit(0);", "url": "https://github.com/cdapio/cdap/pull/12576#discussion_r466922821", "createdAt": "2020-08-07T09:16:03Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/PreviewRunnerSystemTerminator.java", "diffHunk": "@@ -14,12 +14,14 @@\n  * the License.\n  */\n \n-package io.cdap.cdap.k8s.common;\n+package io.cdap.cdap.app.preview;\n \n /**\n- * Enum representing Kubernetes resource types which can be run as twill applications on the Kubernetes cluster.\n+ * Interface to terminate the preview runner system when no more preview runners are available.\n  */\n-public enum KubeResourceType {\n-  DEPLOYMENT,\n-  STATEFULSET\n+public interface PreviewRunnerSystemTerminator {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a47358fbb7d127d765deeb453f632843ba056f1"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE2OTM1NA==", "bodyText": "done.", "url": "https://github.com/cdapio/cdap/pull/12576#discussion_r467169354", "createdAt": "2020-08-07T17:19:06Z", "author": {"login": "sagarkapare"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/PreviewRunnerSystemTerminator.java", "diffHunk": "@@ -14,12 +14,14 @@\n  * the License.\n  */\n \n-package io.cdap.cdap.k8s.common;\n+package io.cdap.cdap.app.preview;\n \n /**\n- * Enum representing Kubernetes resource types which can be run as twill applications on the Kubernetes cluster.\n+ * Interface to terminate the preview runner system when no more preview runners are available.\n  */\n-public enum KubeResourceType {\n-  DEPLOYMENT,\n-  STATEFULSET\n+public interface PreviewRunnerSystemTerminator {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkyMjgyMQ=="}, "originalCommit": {"oid": "0a47358fbb7d127d765deeb453f632843ba056f1"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxNjUzMTY0OnYy", "diffSide": "LEFT", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/DefaultPreviewRunnerManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwOToxNjo0M1rOG9SujA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxNzoxODo1OFrOG9hwFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkyMzE0OA==", "bodyText": "Should just call stop(). The use of terminator is unnecessary", "url": "https://github.com/cdapio/cdap/pull/12576#discussion_r466923148", "createdAt": "2020-08-07T09:16:43Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/DefaultPreviewRunnerManager.java", "diffHunk": "@@ -133,7 +136,8 @@ public void terminated(State from) {\n           previewRunnerServices.remove(pollerService);\n           if (previewRunnerServices.isEmpty()) {\n             try {\n-              stop();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a47358fbb7d127d765deeb453f632843ba056f1"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE2OTMwMA==", "bodyText": "done.", "url": "https://github.com/cdapio/cdap/pull/12576#discussion_r467169300", "createdAt": "2020-08-07T17:18:58Z", "author": {"login": "sagarkapare"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/DefaultPreviewRunnerManager.java", "diffHunk": "@@ -133,7 +136,8 @@ public void terminated(State from) {\n           previewRunnerServices.remove(pollerService);\n           if (previewRunnerServices.isEmpty()) {\n             try {\n-              stop();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkyMzE0OA=="}, "originalCommit": {"oid": "0a47358fbb7d127d765deeb453f632843ba056f1"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxNjU1MTYxOnYy", "diffSide": "RIGHT", "path": "cdap-kubernetes/src/main/java/io/cdap/cdap/k8s/runtime/KubeTwillController.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwOToyMjo0M1rOG9S6dg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxNzoxODo1MlrOG9hv1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkyNjE5OA==", "bodyText": "Add a comment here since the \"runnable\" is not the runnable name, but rather overloaded to carry the pod uid. This a hacky use of the runnable name.", "url": "https://github.com/cdapio/cdap/pull/12576#discussion_r466926198", "createdAt": "2020-08-07T09:22:43Z", "author": {"login": "chtyim"}, "path": "cdap-kubernetes/src/main/java/io/cdap/cdap/k8s/runtime/KubeTwillController.java", "diffHunk": "@@ -262,35 +287,169 @@ public TerminationStatus getTerminationStatus() {\n   }\n \n   /**\n-   * Allows more succinct creation of ApiCallback.\n+   * Creates a label selector that matches all labels in the meta object.\n+   */\n+  private String getLabelSelector() {\n+    return meta.getLabels().entrySet().stream()\n+      .map(e -> String.format(\"%s=%s\", e.getKey(), e.getValue()))\n+      .collect(Collectors.joining(\",\"));\n+  }\n+\n+  /**\n+   * Restarts the given set of instances. This method currently only supports restart of stateful set.\n+   *\n+   * @param runnable name of the runnable to restart. This is currently unused\n+   * @param instanceIds the set of instance ids to restart\n+   * @return a {@link CompletableFuture} that will complete when the delete operation completed\n    */\n-  private static class CallbackAdapter implements ApiCallback<V1Status> {\n-    private final Consumer<ApiException> onFailure;\n-    private final Runnable onSuccess;\n+  private CompletableFuture<String> doRestartInstances(String runnable, Set<Integer> instanceIds) {\n+    CompletableFuture<String> resultFuture = new CompletableFuture<>();\n+    CoreV1Api api = new CoreV1Api(apiClient);\n+\n+    // Only support for stateful set for now\n+    if (!V1StatefulSet.class.equals(resourceType)) {\n+      resultFuture.completeExceptionally(\n+        new UnsupportedOperationException(\"Instance restart by instance id is only supported for statefulsets\"));\n+      return resultFuture;\n+    }\n \n-    CallbackAdapter(Consumer<ApiException> onFailure, Runnable onSuccess) {\n-      this.onFailure = onFailure;\n-      this.onSuccess = onSuccess;\n+    if (instanceIds.size() > 1) {\n+      resultFuture.completeExceptionally(\n+        new UnsupportedOperationException(\"Only one instance can be restarted at a time.\"));\n+      return resultFuture;\n     }\n \n-    @Override\n-    public void onFailure(ApiException e, int i, Map<String, List<String>> map) {\n-      onFailure.accept(e);\n+    int instanceId = instanceIds.iterator().next();\n+    V1DeleteOptions deleteOptions = new V1DeleteOptions().preconditions(new V1Preconditions().uid(runnable));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a47358fbb7d127d765deeb453f632843ba056f1"}, "originalPosition": 235}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE2OTIzNw==", "bodyText": "Added comment.", "url": "https://github.com/cdapio/cdap/pull/12576#discussion_r467169237", "createdAt": "2020-08-07T17:18:52Z", "author": {"login": "sagarkapare"}, "path": "cdap-kubernetes/src/main/java/io/cdap/cdap/k8s/runtime/KubeTwillController.java", "diffHunk": "@@ -262,35 +287,169 @@ public TerminationStatus getTerminationStatus() {\n   }\n \n   /**\n-   * Allows more succinct creation of ApiCallback.\n+   * Creates a label selector that matches all labels in the meta object.\n+   */\n+  private String getLabelSelector() {\n+    return meta.getLabels().entrySet().stream()\n+      .map(e -> String.format(\"%s=%s\", e.getKey(), e.getValue()))\n+      .collect(Collectors.joining(\",\"));\n+  }\n+\n+  /**\n+   * Restarts the given set of instances. This method currently only supports restart of stateful set.\n+   *\n+   * @param runnable name of the runnable to restart. This is currently unused\n+   * @param instanceIds the set of instance ids to restart\n+   * @return a {@link CompletableFuture} that will complete when the delete operation completed\n    */\n-  private static class CallbackAdapter implements ApiCallback<V1Status> {\n-    private final Consumer<ApiException> onFailure;\n-    private final Runnable onSuccess;\n+  private CompletableFuture<String> doRestartInstances(String runnable, Set<Integer> instanceIds) {\n+    CompletableFuture<String> resultFuture = new CompletableFuture<>();\n+    CoreV1Api api = new CoreV1Api(apiClient);\n+\n+    // Only support for stateful set for now\n+    if (!V1StatefulSet.class.equals(resourceType)) {\n+      resultFuture.completeExceptionally(\n+        new UnsupportedOperationException(\"Instance restart by instance id is only supported for statefulsets\"));\n+      return resultFuture;\n+    }\n \n-    CallbackAdapter(Consumer<ApiException> onFailure, Runnable onSuccess) {\n-      this.onFailure = onFailure;\n-      this.onSuccess = onSuccess;\n+    if (instanceIds.size() > 1) {\n+      resultFuture.completeExceptionally(\n+        new UnsupportedOperationException(\"Only one instance can be restarted at a time.\"));\n+      return resultFuture;\n     }\n \n-    @Override\n-    public void onFailure(ApiException e, int i, Map<String, List<String>> map) {\n-      onFailure.accept(e);\n+    int instanceId = instanceIds.iterator().next();\n+    V1DeleteOptions deleteOptions = new V1DeleteOptions().preconditions(new V1Preconditions().uid(runnable));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkyNjE5OA=="}, "originalCommit": {"oid": "0a47358fbb7d127d765deeb453f632843ba056f1"}, "originalPosition": 235}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxNjU1Njk5OnYy", "diffSide": "RIGHT", "path": "cdap-kubernetes/src/main/java/io/cdap/cdap/master/environment/k8s/KubeMasterEnvironment.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwOToyNDoyMVrOG9S96g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxNzoxODo0NFrOG9hvpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkyNzA4Mg==", "bodyText": "Just remove this method. The parent is already having a default implementation that returns an Optional.empty()", "url": "https://github.com/cdapio/cdap/pull/12576#discussion_r466927082", "createdAt": "2020-08-07T09:24:21Z", "author": {"login": "chtyim"}, "path": "cdap-kubernetes/src/main/java/io/cdap/cdap/master/environment/k8s/KubeMasterEnvironment.java", "diffHunk": "@@ -182,7 +152,7 @@ public String getName() {\n \n   @Override\n   public Optional<MasterEnvironmentTask> getTask() {\n-    return Optional.ofNullable(podKillerTask);\n+    return Optional.empty();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a47358fbb7d127d765deeb453f632843ba056f1"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE2OTE4OQ==", "bodyText": "+1", "url": "https://github.com/cdapio/cdap/pull/12576#discussion_r467169189", "createdAt": "2020-08-07T17:18:44Z", "author": {"login": "sagarkapare"}, "path": "cdap-kubernetes/src/main/java/io/cdap/cdap/master/environment/k8s/KubeMasterEnvironment.java", "diffHunk": "@@ -182,7 +152,7 @@ public String getName() {\n \n   @Override\n   public Optional<MasterEnvironmentTask> getTask() {\n-    return Optional.ofNullable(podKillerTask);\n+    return Optional.empty();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkyNzA4Mg=="}, "originalCommit": {"oid": "0a47358fbb7d127d765deeb453f632843ba056f1"}, "originalPosition": 67}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxNjU2MDU0OnYy", "diffSide": "RIGHT", "path": "cdap-master/src/main/java/io/cdap/cdap/master/environment/k8s/DistributedPreviewRunnerServiceStopper.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwOToyNToyNVrOG9S_-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxNzoxODozNFrOG9hvXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkyNzYwOQ==", "bodyText": "Have it one one line", "url": "https://github.com/cdapio/cdap/pull/12576#discussion_r466927609", "createdAt": "2020-08-07T09:25:25Z", "author": {"login": "chtyim"}, "path": "cdap-master/src/main/java/io/cdap/cdap/master/environment/k8s/DistributedPreviewRunnerServiceStopper.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.master.environment.k8s;\n+\n+import com.google.common.util.concurrent.Futures;\n+import com.google.gson.Gson;\n+import com.google.inject.Inject;\n+import com.google.inject.name.Named;\n+import io.cdap.cdap.api.common.Bytes;\n+import io.cdap.cdap.app.preview.PreviewConfigModule;\n+import io.cdap.cdap.app.store.preview.PreviewStore;\n+import io.cdap.cdap.data2.dataset2.lib.table.leveldb.LevelDBTableService;\n+import io.cdap.cdap.internal.app.preview.PreviewRunStopper;\n+import io.cdap.cdap.internal.app.runtime.k8s.PreviewRequestPollerInfo;\n+import io.cdap.cdap.internal.app.store.preview.DefaultPreviewStore;\n+import io.cdap.cdap.proto.id.ApplicationId;\n+import org.apache.twill.api.TwillController;\n+import org.apache.twill.api.TwillRunnerService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Iterator;\n+\n+/**\n+ * Implementation of {@link PreviewRunStopper} in k8s environment.\n+ */\n+public class DistributedPreviewRunnerServiceStopper implements PreviewRunStopper {\n+  private static final Gson GSON = new Gson();\n+  private static final Logger LOG = LoggerFactory.getLogger(DistributedPreviewRunnerServiceStopper.class);\n+  private final PreviewStore previewStore;\n+  private final TwillRunnerService twillRunnerService;\n+\n+  @Inject\n+  DistributedPreviewRunnerServiceStopper(\n+    @Named(PreviewConfigModule.PREVIEW_LEVEL_DB) LevelDBTableService previewLevelDBTableService,\n+    TwillRunnerService twillRunnerService) {\n+    this.previewStore = new DefaultPreviewStore(previewLevelDBTableService);\n+    this.twillRunnerService = twillRunnerService;\n+  }\n+\n+  @Override\n+  public void stop(ApplicationId previewApp) throws Exception {\n+    byte[] pollerInfo = previewStore.getPreviewRequestPollerInfo(previewApp);\n+    if (pollerInfo == null) {\n+      // should not happen\n+      throw new IllegalStateException(\"Preview cannot be stopped. Please try stopping again or run the new preview.\");\n+    }\n+    String pInfo = Bytes.toString(pollerInfo);\n+    PreviewRequestPollerInfo previewRequestPollerInfo = GSON.fromJson(pInfo, PreviewRequestPollerInfo.class);\n+    Iterator<TwillController> controllers\n+      = twillRunnerService.lookup(\"preview-runner\").iterator();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a47358fbb7d127d765deeb453f632843ba056f1"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE2OTExOQ==", "bodyText": "done.", "url": "https://github.com/cdapio/cdap/pull/12576#discussion_r467169119", "createdAt": "2020-08-07T17:18:34Z", "author": {"login": "sagarkapare"}, "path": "cdap-master/src/main/java/io/cdap/cdap/master/environment/k8s/DistributedPreviewRunnerServiceStopper.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.master.environment.k8s;\n+\n+import com.google.common.util.concurrent.Futures;\n+import com.google.gson.Gson;\n+import com.google.inject.Inject;\n+import com.google.inject.name.Named;\n+import io.cdap.cdap.api.common.Bytes;\n+import io.cdap.cdap.app.preview.PreviewConfigModule;\n+import io.cdap.cdap.app.store.preview.PreviewStore;\n+import io.cdap.cdap.data2.dataset2.lib.table.leveldb.LevelDBTableService;\n+import io.cdap.cdap.internal.app.preview.PreviewRunStopper;\n+import io.cdap.cdap.internal.app.runtime.k8s.PreviewRequestPollerInfo;\n+import io.cdap.cdap.internal.app.store.preview.DefaultPreviewStore;\n+import io.cdap.cdap.proto.id.ApplicationId;\n+import org.apache.twill.api.TwillController;\n+import org.apache.twill.api.TwillRunnerService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Iterator;\n+\n+/**\n+ * Implementation of {@link PreviewRunStopper} in k8s environment.\n+ */\n+public class DistributedPreviewRunnerServiceStopper implements PreviewRunStopper {\n+  private static final Gson GSON = new Gson();\n+  private static final Logger LOG = LoggerFactory.getLogger(DistributedPreviewRunnerServiceStopper.class);\n+  private final PreviewStore previewStore;\n+  private final TwillRunnerService twillRunnerService;\n+\n+  @Inject\n+  DistributedPreviewRunnerServiceStopper(\n+    @Named(PreviewConfigModule.PREVIEW_LEVEL_DB) LevelDBTableService previewLevelDBTableService,\n+    TwillRunnerService twillRunnerService) {\n+    this.previewStore = new DefaultPreviewStore(previewLevelDBTableService);\n+    this.twillRunnerService = twillRunnerService;\n+  }\n+\n+  @Override\n+  public void stop(ApplicationId previewApp) throws Exception {\n+    byte[] pollerInfo = previewStore.getPreviewRequestPollerInfo(previewApp);\n+    if (pollerInfo == null) {\n+      // should not happen\n+      throw new IllegalStateException(\"Preview cannot be stopped. Please try stopping again or run the new preview.\");\n+    }\n+    String pInfo = Bytes.toString(pollerInfo);\n+    PreviewRequestPollerInfo previewRequestPollerInfo = GSON.fromJson(pInfo, PreviewRequestPollerInfo.class);\n+    Iterator<TwillController> controllers\n+      = twillRunnerService.lookup(\"preview-runner\").iterator();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkyNzYwOQ=="}, "originalCommit": {"oid": "0a47358fbb7d127d765deeb453f632843ba056f1"}, "originalPosition": 65}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxODc4MTQ1OnYy", "diffSide": "RIGHT", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/runtime/k8s/PreviewRunnerMain.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QyMToxOToyOFrOG9oGlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QyMjoyNjoyMlrOG9qdNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzI3MzM2NA==", "bodyText": "Always provide a charset when turning bytes to string", "url": "https://github.com/cdapio/cdap/pull/12576#discussion_r467273364", "createdAt": "2020-08-07T21:19:28Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/runtime/k8s/PreviewRunnerMain.java", "diffHunk": "@@ -17,47 +17,137 @@\n package io.cdap.cdap.internal.app.runtime.k8s;\n \n import com.google.common.util.concurrent.Service;\n+import com.google.gson.Gson;\n+import com.google.inject.AbstractModule;\n import com.google.inject.Injector;\n import com.google.inject.Module;\n+import io.cdap.cdap.api.common.Bytes;\n+import io.cdap.cdap.app.guice.AppFabricServiceRuntimeModule;\n+import io.cdap.cdap.app.guice.AuthorizationModule;\n+import io.cdap.cdap.app.guice.ProgramRunnerRuntimeModule;\n+import io.cdap.cdap.app.guice.UnsupportedExploreClient;\n+import io.cdap.cdap.app.preview.PreviewRunnerManager;\n+import io.cdap.cdap.app.preview.PreviewRunnerManagerModule;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.guice.DFSLocationModule;\n import io.cdap.cdap.common.logging.LoggingContext;\n+import io.cdap.cdap.common.logging.ServiceLoggingContext;\n+import io.cdap.cdap.data.runtime.DataSetServiceModules;\n+import io.cdap.cdap.data.runtime.DataSetsModules;\n+import io.cdap.cdap.data2.audit.AuditModule;\n+import io.cdap.cdap.explore.client.ExploreClient;\n+import io.cdap.cdap.internal.app.preview.PreviewRequestPollerInfoProvider;\n import io.cdap.cdap.master.environment.k8s.AbstractServiceMain;\n import io.cdap.cdap.master.spi.environment.MasterEnvironment;\n import io.cdap.cdap.master.spi.environment.MasterEnvironmentContext;\n+import io.cdap.cdap.messaging.guice.MessagingClientModule;\n+import io.cdap.cdap.metadata.MetadataReaderWriterModules;\n+import io.cdap.cdap.metadata.MetadataServiceModule;\n+import io.cdap.cdap.metrics.guice.MetricsStoreModule;\n+import io.cdap.cdap.proto.id.NamespaceId;\n+import io.cdap.cdap.security.authorization.AuthorizationEnforcementModule;\n+import io.cdap.cdap.security.guice.SecureStoreClientModule;\n+import org.apache.twill.internal.ServiceListenerAdapter;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n-import java.util.Collections;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.util.Arrays;\n import java.util.List;\n import javax.annotation.Nullable;\n \n-\n /**\n  * The main class to run the preview runner. Preview runner will run in its own pod.\n  */\n public class PreviewRunnerMain extends AbstractServiceMain<PreviewRunnerOptions> {\n+  private static final Gson GSON = new Gson();\n+  private static final Logger LOG = LoggerFactory.getLogger(PreviewRunnerMain.class);\n+  private PreviewRequestPollerInfo previewRequestPollerInfo;\n \n   /**\n    * Main entry point\n    */\n   public static void main(String[] args) throws Exception {\n-    System.out.println(\"In the preview runner main\");\n-    Thread.sleep(120000);\n-    System.out.println(\"Preview runner main done\");\n+    main(PreviewRunnerMain.class, args);\n   }\n \n   @Override\n   protected List<Module> getServiceModules(MasterEnvironment masterEnv, PreviewRunnerOptions options) {\n-    return Collections.emptyList();\n+    return Arrays.asList(\n+      new PreviewRunnerManagerModule().getDistributedModules(),\n+      new DataSetServiceModules().getStandaloneModules(),\n+      new DataSetsModules().getStandaloneModules(),\n+      new AppFabricServiceRuntimeModule().getStandaloneModules(),\n+      new ProgramRunnerRuntimeModule().getStandaloneModules(),\n+      new MetricsStoreModule(),\n+      new MessagingClientModule(),\n+      new AuditModule(),\n+      new SecureStoreClientModule(),\n+      new MetadataReaderWriterModules().getStandaloneModules(),\n+      getDataFabricModule(),\n+      new DFSLocationModule(),\n+      new MetadataServiceModule(),\n+      new AuthorizationModule(),\n+      new AuthorizationEnforcementModule().getMasterModule(),\n+      new AbstractModule() {\n+        @Override\n+        protected void configure() {\n+          bind(ExploreClient.class).to(UnsupportedExploreClient.class);\n+          bind(PreviewRequestPollerInfoProvider.class).toInstance(\n+            () -> Bytes.toBytes(GSON.toJson(previewRequestPollerInfo)));\n+        }\n+      }\n+    );\n   }\n \n   @Override\n   protected void addServices(Injector injector, List<? super Service> services,\n                              List<? super AutoCloseable> closeableResources, MasterEnvironment masterEnv,\n                              MasterEnvironmentContext masterEnvContext, PreviewRunnerOptions options) {\n+    Service previewRunnerManager = (Service) injector.getInstance(PreviewRunnerManager.class);\n+    previewRunnerManager.addListener(new ServiceListenerAdapter() {\n+      @Override\n+      public void terminated(Service.State from) {\n+        terminate();\n+      }\n+\n+      @Override\n+      public void failed(Service.State from, Throwable failure) {\n+        terminate();\n+      }\n \n+      private void terminate() {\n+        System.exit(0);\n+      }\n+    }, command -> {\n+      Thread thread = new Thread(command, \"PreviewRunnerMainTerminator\");\n+      thread.setDaemon(true);\n+      thread.start();\n+    });\n+    services.add(previewRunnerManager);\n   }\n \n   @Nullable\n   @Override\n   protected LoggingContext getLoggingContext(PreviewRunnerOptions options) {\n-    return null;\n+    String instanceName = readFile(options.getInstanceNameFilePath());\n+    String instanceUid = readFile(options.getInstanceUidFilePath());\n+    LOG.info(\"Instance name: {}, Instance UID: {}\", instanceName, instanceUid);\n+    previewRequestPollerInfo = new PreviewRequestPollerInfo(instanceName, instanceUid);\n+    LOG.info(\"Instance id: {}, Instance UID: {}\", previewRequestPollerInfo.getInstanceId(),\n+             previewRequestPollerInfo.getInstanceUid());\n+    return new ServiceLoggingContext(NamespaceId.SYSTEM.getNamespace(),\n+                                     Constants.Logging.COMPONENT_NAME,\n+                                     Constants.Service.PREVIEW_HTTP);\n+  }\n+\n+  private static String readFile(String fileName) {\n+    try {\n+      return new String(Files.readAllBytes(Paths.get(fileName)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "60296327dd81ce7c9ee68dbce773b845c89d077e"}, "originalPosition": 139}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzMxMTkyNg==", "bodyText": "Using Bytes.toString() now to use UTF_8 encoding.", "url": "https://github.com/cdapio/cdap/pull/12576#discussion_r467311926", "createdAt": "2020-08-07T22:26:22Z", "author": {"login": "sagarkapare"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/runtime/k8s/PreviewRunnerMain.java", "diffHunk": "@@ -17,47 +17,137 @@\n package io.cdap.cdap.internal.app.runtime.k8s;\n \n import com.google.common.util.concurrent.Service;\n+import com.google.gson.Gson;\n+import com.google.inject.AbstractModule;\n import com.google.inject.Injector;\n import com.google.inject.Module;\n+import io.cdap.cdap.api.common.Bytes;\n+import io.cdap.cdap.app.guice.AppFabricServiceRuntimeModule;\n+import io.cdap.cdap.app.guice.AuthorizationModule;\n+import io.cdap.cdap.app.guice.ProgramRunnerRuntimeModule;\n+import io.cdap.cdap.app.guice.UnsupportedExploreClient;\n+import io.cdap.cdap.app.preview.PreviewRunnerManager;\n+import io.cdap.cdap.app.preview.PreviewRunnerManagerModule;\n+import io.cdap.cdap.common.conf.Constants;\n+import io.cdap.cdap.common.guice.DFSLocationModule;\n import io.cdap.cdap.common.logging.LoggingContext;\n+import io.cdap.cdap.common.logging.ServiceLoggingContext;\n+import io.cdap.cdap.data.runtime.DataSetServiceModules;\n+import io.cdap.cdap.data.runtime.DataSetsModules;\n+import io.cdap.cdap.data2.audit.AuditModule;\n+import io.cdap.cdap.explore.client.ExploreClient;\n+import io.cdap.cdap.internal.app.preview.PreviewRequestPollerInfoProvider;\n import io.cdap.cdap.master.environment.k8s.AbstractServiceMain;\n import io.cdap.cdap.master.spi.environment.MasterEnvironment;\n import io.cdap.cdap.master.spi.environment.MasterEnvironmentContext;\n+import io.cdap.cdap.messaging.guice.MessagingClientModule;\n+import io.cdap.cdap.metadata.MetadataReaderWriterModules;\n+import io.cdap.cdap.metadata.MetadataServiceModule;\n+import io.cdap.cdap.metrics.guice.MetricsStoreModule;\n+import io.cdap.cdap.proto.id.NamespaceId;\n+import io.cdap.cdap.security.authorization.AuthorizationEnforcementModule;\n+import io.cdap.cdap.security.guice.SecureStoreClientModule;\n+import org.apache.twill.internal.ServiceListenerAdapter;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n-import java.util.Collections;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.util.Arrays;\n import java.util.List;\n import javax.annotation.Nullable;\n \n-\n /**\n  * The main class to run the preview runner. Preview runner will run in its own pod.\n  */\n public class PreviewRunnerMain extends AbstractServiceMain<PreviewRunnerOptions> {\n+  private static final Gson GSON = new Gson();\n+  private static final Logger LOG = LoggerFactory.getLogger(PreviewRunnerMain.class);\n+  private PreviewRequestPollerInfo previewRequestPollerInfo;\n \n   /**\n    * Main entry point\n    */\n   public static void main(String[] args) throws Exception {\n-    System.out.println(\"In the preview runner main\");\n-    Thread.sleep(120000);\n-    System.out.println(\"Preview runner main done\");\n+    main(PreviewRunnerMain.class, args);\n   }\n \n   @Override\n   protected List<Module> getServiceModules(MasterEnvironment masterEnv, PreviewRunnerOptions options) {\n-    return Collections.emptyList();\n+    return Arrays.asList(\n+      new PreviewRunnerManagerModule().getDistributedModules(),\n+      new DataSetServiceModules().getStandaloneModules(),\n+      new DataSetsModules().getStandaloneModules(),\n+      new AppFabricServiceRuntimeModule().getStandaloneModules(),\n+      new ProgramRunnerRuntimeModule().getStandaloneModules(),\n+      new MetricsStoreModule(),\n+      new MessagingClientModule(),\n+      new AuditModule(),\n+      new SecureStoreClientModule(),\n+      new MetadataReaderWriterModules().getStandaloneModules(),\n+      getDataFabricModule(),\n+      new DFSLocationModule(),\n+      new MetadataServiceModule(),\n+      new AuthorizationModule(),\n+      new AuthorizationEnforcementModule().getMasterModule(),\n+      new AbstractModule() {\n+        @Override\n+        protected void configure() {\n+          bind(ExploreClient.class).to(UnsupportedExploreClient.class);\n+          bind(PreviewRequestPollerInfoProvider.class).toInstance(\n+            () -> Bytes.toBytes(GSON.toJson(previewRequestPollerInfo)));\n+        }\n+      }\n+    );\n   }\n \n   @Override\n   protected void addServices(Injector injector, List<? super Service> services,\n                              List<? super AutoCloseable> closeableResources, MasterEnvironment masterEnv,\n                              MasterEnvironmentContext masterEnvContext, PreviewRunnerOptions options) {\n+    Service previewRunnerManager = (Service) injector.getInstance(PreviewRunnerManager.class);\n+    previewRunnerManager.addListener(new ServiceListenerAdapter() {\n+      @Override\n+      public void terminated(Service.State from) {\n+        terminate();\n+      }\n+\n+      @Override\n+      public void failed(Service.State from, Throwable failure) {\n+        terminate();\n+      }\n \n+      private void terminate() {\n+        System.exit(0);\n+      }\n+    }, command -> {\n+      Thread thread = new Thread(command, \"PreviewRunnerMainTerminator\");\n+      thread.setDaemon(true);\n+      thread.start();\n+    });\n+    services.add(previewRunnerManager);\n   }\n \n   @Nullable\n   @Override\n   protected LoggingContext getLoggingContext(PreviewRunnerOptions options) {\n-    return null;\n+    String instanceName = readFile(options.getInstanceNameFilePath());\n+    String instanceUid = readFile(options.getInstanceUidFilePath());\n+    LOG.info(\"Instance name: {}, Instance UID: {}\", instanceName, instanceUid);\n+    previewRequestPollerInfo = new PreviewRequestPollerInfo(instanceName, instanceUid);\n+    LOG.info(\"Instance id: {}, Instance UID: {}\", previewRequestPollerInfo.getInstanceId(),\n+             previewRequestPollerInfo.getInstanceUid());\n+    return new ServiceLoggingContext(NamespaceId.SYSTEM.getNamespace(),\n+                                     Constants.Logging.COMPONENT_NAME,\n+                                     Constants.Service.PREVIEW_HTTP);\n+  }\n+\n+  private static String readFile(String fileName) {\n+    try {\n+      return new String(Files.readAllBytes(Paths.get(fileName)));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzI3MzM2NA=="}, "originalCommit": {"oid": "60296327dd81ce7c9ee68dbce773b845c89d077e"}, "originalPosition": 139}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3160, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}