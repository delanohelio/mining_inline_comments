{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU1ODE5NTc1", "number": 12488, "title": "[CDAP-16414] Handling graphQL errors in pipeline list view", "bodyText": "Jira: https://issues.cask.co/browse/CDAP-16414\nCurrently, graphQL errors in pipeline list view are shown as strings, this PR is to utilize one of the error components we have.\n\nWill show page level error when call to retrieve pipelines fails (considered high priority failure on this page).\nWill show error banner when we are unable to retrieve other information for the page like total runs, next run etc.\nWhen multiple of these smaller services fail, we show a page level error.", "createdAt": "2020-07-23T16:16:12Z", "url": "https://github.com/cdapio/cdap/pull/12488", "merged": true, "mergeCommit": {"oid": "e642db2cdae41ac5205cf64fccfb1990b730d600"}, "closed": true, "closedAt": "2020-07-29T17:35:31Z", "author": {"login": "itsanudeep"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3zmeZAFqTQ1NDM4MzYxNw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5uAYggBqjM1OTk5NjgyMDY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0MzgzNjE3", "url": "https://github.com/cdapio/cdap/pull/12488#pullrequestreview-454383617", "createdAt": "2020-07-23T18:17:02Z", "commit": {"oid": "e45ac92e04fbc8683d31ec73b0da6c4b95860caf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxODoxNzowMlrOG2WL0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxODoxNzowMlrOG2WL0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTYzOTc2Mg==", "bodyText": "Is the condition above correct? If I'm reading the condition correctly, errorsByOrigin['network'] will always be undefined here.", "url": "https://github.com/cdapio/cdap/pull/12488#discussion_r459639762", "createdAt": "2020-07-23T18:17:02Z", "author": {"login": "njbriggs"}, "path": "cdap-ui/app/cdap/services/helpers.js", "diffHunk": "@@ -489,6 +489,37 @@ function connectWithStore(store, WrappedComponent, ...args) {\n     return <ConnectedWrappedComponent {...props} store={store} />;\n   };\n }\n+/**\n+ * This function formats the graphQl errors by error type\n+ * { errorType: ['message1', 'message2'] ....} will be\n+ * the format of categorized errors.\n+ */\n+function categorizeGraphQlErrors(error) {\n+  const GENERIC_ERROR_ORIGIN = 'generic';\n+  const graphQLErrors = objectQuery(error, 'graphQLErrors') || [];\n+  const networkErrors = objectQuery(error, 'networkError') || [];\n+  const errorsByOrigin = {};\n+  if (graphQLErrors.length === 0 && networkErrors.length === 0 && error) {\n+    errorsByOrigin[GENERIC_ERROR_ORIGIN] = error.message;\n+  }\n+  graphQLErrors.forEach(error => {\n+    const errorOrigin = objectQuery(error, 'extensions', 'exception', 'errorOrigin') || GENERIC_ERROR_ORIGIN;\n+    if (errorsByOrigin.hasOwnProperty(errorOrigin)) {\n+      errorsByOrigin[errorOrigin] = [error.message];\n+    }\n+    else {\n+      errorsByOrigin[errorOrigin].push([error.message]);\n+    }\n+  });\n+  networkErrors.forEach(error => {\n+    if (errorsByOrigin.hasOwnProperty('network')) {\n+      errorsByOrigin['network'] = [error.message];\n+    } else {\n+      errorsByOrigin['network'].push([error.message]);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e45ac92e04fbc8683d31ec73b0da6c4b95860caf"}, "originalPosition": 30}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e45ac92e04fbc8683d31ec73b0da6c4b95860caf", "author": {"user": {"login": "itsanudeep", "name": "Anudeep Katragadda"}}, "url": "https://github.com/cdapio/cdap/commit/e45ac92e04fbc8683d31ec73b0da6c4b95860caf", "committedDate": "2020-07-23T16:15:05Z", "message": "graphql error handling for pipelines list page"}, "afterCommit": {"oid": "15d5de7a88a63fa5837f0d694077c637f5cdeb18", "author": {"user": {"login": "itsanudeep", "name": "Anudeep Katragadda"}}, "url": "https://github.com/cdapio/cdap/commit/15d5de7a88a63fa5837f0d694077c637f5cdeb18", "committedDate": "2020-07-23T18:33:32Z", "message": "graphql error handling for pipelines list page"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0NDQ3NjEy", "url": "https://github.com/cdapio/cdap/pull/12488#pullrequestreview-454447612", "createdAt": "2020-07-23T19:51:43Z", "commit": {"oid": "15d5de7a88a63fa5837f0d694077c637f5cdeb18"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1OTg2MjQ0", "url": "https://github.com/cdapio/cdap/pull/12488#pullrequestreview-455986244", "createdAt": "2020-07-27T17:24:40Z", "commit": {"oid": "15d5de7a88a63fa5837f0d694077c637f5cdeb18"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxNzoyNDo0MVrOG3sPtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxNzoyNDo0MVrOG3sPtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA0OTc4MQ==", "bodyText": "nit: can you validate this message with @leacd ?\nI think its a bit better to say Multiple services encountered some issues retrieving pipelines.....", "url": "https://github.com/cdapio/cdap/pull/12488#discussion_r461049781", "createdAt": "2020-07-27T17:24:41Z", "author": {"login": "elfenheart"}, "path": "cdap-ui/app/cdap/text/text-en.yaml", "diffHunk": "@@ -2145,6 +2145,7 @@ features:\n         1: \"pipeline \"\n         _: \"pipelines \"\n     DeployedPipelineView:\n+      graphQLMultipleServicesDown: Multiple services ran into issues when trying to retrieve list of pipelines. Please try again later.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15d5de7a88a63fa5837f0d694077c637f5cdeb18"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2MDA5MDE2", "url": "https://github.com/cdapio/cdap/pull/12488#pullrequestreview-456009016", "createdAt": "2020-07-27T17:56:02Z", "commit": {"oid": "15d5de7a88a63fa5837f0d694077c637f5cdeb18"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxNzo1NjowM1rOG3tWfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxNzo1NjowM1rOG3tWfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA2NzkwMQ==", "bodyText": "Don't think we should hardcode 500 here. We might have 403 or 401 errors tomorrow which should not converted. Can we get the status code from the request response?", "url": "https://github.com/cdapio/cdap/pull/12488#discussion_r461067901", "createdAt": "2020-07-27T17:56:03Z", "author": {"login": "ajainarayanan"}, "path": "cdap-ui/graphql/resolvers-common.js", "diffHunk": "@@ -41,14 +41,24 @@ export function requestPromiseWrapper(options, token, bodyModifiersFn) {\n   return new Promise((resolve, reject) => {\n     request(options, (err, response, body) => {\n       if (err) {\n-        const error =  new ApolloError(err, '500');\n-        return reject(error);\n+        let exception;\n+        if (typeof errorModifiersFn === 'function') {\n+          exception = errorModifiersFn(err, '500');", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15d5de7a88a63fa5837f0d694077c637f5cdeb18"}, "originalPosition": 17}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "15d5de7a88a63fa5837f0d694077c637f5cdeb18", "author": {"user": {"login": "itsanudeep", "name": "Anudeep Katragadda"}}, "url": "https://github.com/cdapio/cdap/commit/15d5de7a88a63fa5837f0d694077c637f5cdeb18", "committedDate": "2020-07-23T18:33:32Z", "message": "graphql error handling for pipelines list page"}, "afterCommit": {"oid": "457d7c9fdccb8e9f4ea876e7596ca1a4e25b5834", "author": {"user": {"login": "itsanudeep", "name": "Anudeep Katragadda"}}, "url": "https://github.com/cdapio/cdap/commit/457d7c9fdccb8e9f4ea876e7596ca1a4e25b5834", "committedDate": "2020-07-28T16:04:00Z", "message": "use statusCode"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8475bb610a381ca92de02d5a78e564fd118ef05e", "author": {"user": {"login": "itsanudeep", "name": "Anudeep Katragadda"}}, "url": "https://github.com/cdapio/cdap/commit/8475bb610a381ca92de02d5a78e564fd118ef05e", "committedDate": "2020-07-29T16:55:21Z", "message": "graphql error handling for pipelines list page"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "32bd629c38149737090cc94a5a88cc3e55e6923b", "author": {"user": {"login": "itsanudeep", "name": "Anudeep Katragadda"}}, "url": "https://github.com/cdapio/cdap/commit/32bd629c38149737090cc94a5a88cc3e55e6923b", "committedDate": "2020-07-28T20:11:41Z", "message": "update error description"}, "afterCommit": {"oid": "8475bb610a381ca92de02d5a78e564fd118ef05e", "author": {"user": {"login": "itsanudeep", "name": "Anudeep Katragadda"}}, "url": "https://github.com/cdapio/cdap/commit/8475bb610a381ca92de02d5a78e564fd118ef05e", "committedDate": "2020-07-29T16:55:21Z", "message": "graphql error handling for pipelines list page"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1850, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}