{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDExOTk2NDg0", "number": 12137, "title": "(CDAP-16730) Set correct -xmx for pods in k8s to run programs", "bodyText": "Bug:\nWe have introduced a multiplier to determine the actual CPU and RAM\nto request for creating the pod to run a program. But we fail to\nset the correct -xmx based on the RAM requested for the pod.\nThis change\n\nSet memory requested to be memory * multiplier\nSet xmx to be memory * multiplier * 0.8\nwhere memory is the requested memroy by the program, we may allocate\nmore or less depending on the setting of multplier which depends on\nthe k8s cluster size.", "createdAt": "2020-05-01T05:56:26Z", "url": "https://github.com/cdapio/cdap/pull/12137", "merged": true, "mergeCommit": {"oid": "c4c84c8e4c1965c015c7f50398e7b9e464dfd345"}, "closed": true, "closedAt": "2020-05-02T08:11:52Z", "author": {"login": "wyzhang"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcc93O7AFqTQwNDA3NzQ2Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcdRRVEABqjMyOTUwODY3MzI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0MDc3NDYy", "url": "https://github.com/cdapio/cdap/pull/12137#pullrequestreview-404077462", "createdAt": "2020-05-01T09:00:07Z", "commit": {"oid": "5eb4b1912383931535cc9537969b2f6a41367b93"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQwOTowMDowOFrOGPFWdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQwOTowMDowOFrOGPFWdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQ2OTQ5Mg==", "bodyText": "We have two keys in the cdap-site.xml to control non-heap memory, twill.java.heap.memory.ratio and twill.java.reserved.memory.mb. You can get those through the MasterEnvironmentContext.getConfigurations() method. You can refer to the org.apache.twill.internal.utils.Resources.computeMaxHeapSize method on how it computes the xmx.", "url": "https://github.com/cdapio/cdap/pull/12137#discussion_r418469492", "createdAt": "2020-05-01T09:00:08Z", "author": {"login": "chtyim"}, "path": "cdap-kubernetes/src/main/java/io/cdap/cdap/k8s/runtime/KubeTwillPreparer.java", "diffHunk": "@@ -87,6 +87,7 @@\n   private static final String CPU_MULTIPLIER = \"master.environment.k8s.container.cpu.multiplier\";\n   private static final String MEMORY_MULTIPLIER = \"master.environment.k8s.container.memory.multiplier\";\n   private static final String DEFAULT_MULTIPLIER = \"1.0\";\n+  private static final double MEMORY_MAX_HEAP_SIZE_FRACTION = 0.8;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5eb4b1912383931535cc9537969b2f6a41367b93"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7e7f056c27cd8ee4055f97dc4b82ac9d6d22b5f6", "author": {"user": {"login": "wyzhang", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/7e7f056c27cd8ee4055f97dc4b82ac9d6d22b5f6", "committedDate": "2020-05-02T01:08:08Z", "message": "address comments"}, "afterCommit": {"oid": "320fb687b88e5f9e127310774c5f8840b741fff8", "author": {"user": {"login": "wyzhang", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/320fb687b88e5f9e127310774c5f8840b741fff8", "committedDate": "2020-05-02T04:06:41Z", "message": "address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0NTAwNjMy", "url": "https://github.com/cdapio/cdap/pull/12137#pullrequestreview-404500632", "createdAt": "2020-05-02T04:55:49Z", "commit": {"oid": "320fb687b88e5f9e127310774c5f8840b741fff8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMlQwNDo1NTo0OVrOGPfatA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMlQwNDo1NTo0OVrOGPfatA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODg5NjU2NA==", "bodyText": "twill-core has quite a lot of dependencies. If you are only using one class, better to exclude all the dependencies. The Resources class in Twill has no dependency on non JDK classes", "url": "https://github.com/cdapio/cdap/pull/12137#discussion_r418896564", "createdAt": "2020-05-02T04:55:49Z", "author": {"login": "chtyim"}, "path": "cdap-kubernetes/pom.xml", "diffHunk": "@@ -76,6 +76,10 @@\n       <artifactId>logback-core</artifactId>\n       <scope>test</scope>\n     </dependency>\n+    <dependency>\n+      <groupId>org.apache.twill</groupId>\n+      <artifactId>twill-core</artifactId>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "320fb687b88e5f9e127310774c5f8840b741fff8"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0NTA2MjE5", "url": "https://github.com/cdapio/cdap/pull/12137#pullrequestreview-404506219", "createdAt": "2020-05-02T06:59:39Z", "commit": {"oid": "7d89205864deacebd78cb7c7e0f3be37fbc4c0c2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a9524c709018a83582d9e85acba7e4482fa1750", "author": {"user": {"login": "wyzhang", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/5a9524c709018a83582d9e85acba7e4482fa1750", "committedDate": "2020-05-02T07:34:57Z", "message": "(CDAP-16730) Set correct -xmx for pods in k8s to run programs\n\nBug:\nWe have introduced a multiplier to determine the actual CPU and RAM\nto request for creating the pod to run a program. But we fail to\nset the correct -xmx based on the RAM requested for the pod.\n\nThis change\n- Set memory requested to be memory * multiplier\n- Set xmx using org.apache.twill.internal.utils.Resources.computeMaxHeapSiz\n  based on the memory request size"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7d89205864deacebd78cb7c7e0f3be37fbc4c0c2", "author": {"user": {"login": "wyzhang", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/7d89205864deacebd78cb7c7e0f3be37fbc4c0c2", "committedDate": "2020-05-02T06:40:12Z", "message": "address comment"}, "afterCommit": {"oid": "5a9524c709018a83582d9e85acba7e4482fa1750", "author": {"user": {"login": "wyzhang", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/5a9524c709018a83582d9e85acba7e4482fa1750", "committedDate": "2020-05-02T07:34:57Z", "message": "(CDAP-16730) Set correct -xmx for pods in k8s to run programs\n\nBug:\nWe have introduced a multiplier to determine the actual CPU and RAM\nto request for creating the pod to run a program. But we fail to\nset the correct -xmx based on the RAM requested for the pod.\n\nThis change\n- Set memory requested to be memory * multiplier\n- Set xmx using org.apache.twill.internal.utils.Resources.computeMaxHeapSiz\n  based on the memory request size"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2039, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}