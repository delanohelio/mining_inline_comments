{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEyNTgxNTky", "number": 12830, "title": "(CDAP-17276) Save accelerator annotation as system metadata", "bodyText": "Save accelerator annotation as system metadata when application is deployed.\nAccelerators from all plugins and application are consolidated and added as a comma separated list\nDeleting the application removes the metadata\nUser cannot delete the metadata since the API for deleting system metadata is not exposed", "createdAt": "2020-10-29T21:30:19Z", "url": "https://github.com/cdapio/cdap/pull/12830", "merged": true, "mergeCommit": {"oid": "0e1b8ae060b48015e8d3b0f94a97ed8e280e36af"}, "closed": true, "closedAt": "2020-10-30T22:22:53Z", "author": {"login": "greeshmaswaminathan"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXaV9wgBqjM5Mzg3ODU4MDc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXuQYQgFqTUyMTA2MjcxOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "52f009a43cda3b098c6fddcffd37e970f5f0081c", "author": {"user": {"login": "greeshmaswaminathan", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/52f009a43cda3b098c6fddcffd37e970f5f0081c", "committedDate": "2020-10-29T21:13:58Z", "message": "(CDAP-17276) Save accelerator annotation as system metadata when application is deployed."}, "afterCommit": {"oid": "8edacdfb0123fa1b519f6ab2bde9ac98ba0fa9c3", "author": {"user": {"login": "greeshmaswaminathan", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/8edacdfb0123fa1b519f6ab2bde9ac98ba0fa9c3", "committedDate": "2020-10-29T22:58:35Z", "message": "(CDAP-17276) Save accelerator annotation as system metadata when application is deployed."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwMzI0MjM4", "url": "https://github.com/cdapio/cdap/pull/12830#pullrequestreview-520324238", "createdAt": "2020-10-30T01:39:40Z", "commit": {"oid": "8edacdfb0123fa1b519f6ab2bde9ac98ba0fa9c3"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQwMTozOTo0MFrOHq1W_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQwMTo0NDoxNFrOHq1nkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDY3NjQ3OQ==", "bodyText": "Have one function per line to have a cleaner look:\nappSpec.getPlugins().values().stream()\n  .map(Plugin::getPluginClass)\n  .map(PluginClass::getRequirements)\n  .map(Requirements::getAccelerators)\n  .flatMap(Set::stream)\n  .collect(Collectors.toSet());", "url": "https://github.com/cdapio/cdap/pull/12830#discussion_r514676479", "createdAt": "2020-10-30T01:39:40Z", "author": {"login": "chtyim"}, "path": "cdap-data-fabric/src/main/java/io/cdap/cdap/data2/metadata/system/AppSystemMetadataWriter.java", "diffHunk": "@@ -72,9 +78,27 @@ public AppSystemMetadataWriter(MetadataServiceClient metadataServiceClient, Appl\n         existingPluginClasses.add(plugin.getPluginClass());\n       }\n     }\n+    addAccelerators(appSpec, applicationClass, properties);\n     return properties.build();\n   }\n \n+  private void addAccelerators(ApplicationSpecification appSpec,\n+                               ApplicationClass applicationClass,\n+                               ImmutableMap.Builder<String, String> properties) {\n+    //add from all plugins\n+    Set<String> acceleratorSet = appSpec.getPlugins().values().stream().map(Plugin::getPluginClass)\n+      .map(PluginClass::getRequirements).map(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8edacdfb0123fa1b519f6ab2bde9ac98ba0fa9c3"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDY3Njk2MA==", "bodyText": "It won't be null, right?", "url": "https://github.com/cdapio/cdap/pull/12830#discussion_r514676960", "createdAt": "2020-10-30T01:40:08Z", "author": {"login": "chtyim"}, "path": "cdap-data-fabric/src/main/java/io/cdap/cdap/data2/metadata/system/AppSystemMetadataWriter.java", "diffHunk": "@@ -72,9 +78,27 @@ public AppSystemMetadataWriter(MetadataServiceClient metadataServiceClient, Appl\n         existingPluginClasses.add(plugin.getPluginClass());\n       }\n     }\n+    addAccelerators(appSpec, applicationClass, properties);\n     return properties.build();\n   }\n \n+  private void addAccelerators(ApplicationSpecification appSpec,\n+                               ApplicationClass applicationClass,\n+                               ImmutableMap.Builder<String, String> properties) {\n+    //add from all plugins\n+    Set<String> acceleratorSet = appSpec.getPlugins().values().stream().map(Plugin::getPluginClass)\n+      .map(PluginClass::getRequirements).map(\n+        Requirements::getAccelerators).flatMap(Set::stream)\n+      .collect(Collectors.toSet());\n+    //add from application\n+    acceleratorSet.addAll(applicationClass.getRequirements().getAccelerators());\n+    String acceleratorsValue = String.join(\",\", acceleratorSet);\n+    if (acceleratorsValue == null || acceleratorsValue.isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8edacdfb0123fa1b519f6ab2bde9ac98ba0fa9c3"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDY4MDcyMQ==", "bodyText": "Have it on one line. programId -> { }", "url": "https://github.com/cdapio/cdap/pull/12830#discussion_r514680721", "createdAt": "2020-10-30T01:44:14Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/test/java/io/cdap/cdap/internal/app/services/ApplicationLifecycleServiceTest.java", "diffHunk": "@@ -128,6 +148,34 @@ public void testAppDeletionMultipleNS() throws Exception {\n     deleteAppAndData(testNSAppId);\n   }\n \n+  @Test\n+  public void testAcceleratorMetaDataDeletion() throws Exception {\n+    Id.Artifact artifactId = Id.Artifact\n+      .from(Id.Namespace.DEFAULT, AppWithWorkflow.class.getSimpleName(), \"1.0.0-SNAPSHOT\");\n+    Location appJar = AppJarHelper.createDeploymentJar(locationFactory, AppWithWorkflow.class);\n+    File appJarFile = new File(tmpFolder.newFolder(),\n+                               String.format(\"%s-%s.jar\", artifactId.getName(), artifactId.getVersion().getVersion()));\n+    Files.copy(Locations.newInputSupplier(appJar), appJarFile);\n+    appJar.delete();\n+\n+    //deploy app\n+    applicationLifecycleService\n+      .deployAppAndArtifact(NamespaceId.DEFAULT, AppWithWorkflow.class.getSimpleName(), artifactId, appJarFile, null,\n+                            null, programId -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8edacdfb0123fa1b519f6ab2bde9ac98ba0fa9c3"}, "originalPosition": 89}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwNDA3ODY1", "url": "https://github.com/cdapio/cdap/pull/12830#pullrequestreview-520407865", "createdAt": "2020-10-30T06:42:13Z", "commit": {"oid": "8edacdfb0123fa1b519f6ab2bde9ac98ba0fa9c3"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQwNjo0MjoxNFrOHrC66g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQwNjo0MzozM1rOHrC8JA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDg5ODY2Ng==", "bodyText": "Should we use a constant here instead of hard-coded string?", "url": "https://github.com/cdapio/cdap/pull/12830#discussion_r514898666", "createdAt": "2020-10-30T06:42:14Z", "author": {"login": "wyzhang"}, "path": "cdap-data-fabric/src/main/java/io/cdap/cdap/data2/metadata/system/AppSystemMetadataWriter.java", "diffHunk": "@@ -72,9 +78,27 @@ public AppSystemMetadataWriter(MetadataServiceClient metadataServiceClient, Appl\n         existingPluginClasses.add(plugin.getPluginClass());\n       }\n     }\n+    addAccelerators(appSpec, applicationClass, properties);\n     return properties.build();\n   }\n \n+  private void addAccelerators(ApplicationSpecification appSpec,\n+                               ApplicationClass applicationClass,\n+                               ImmutableMap.Builder<String, String> properties) {\n+    //add from all plugins\n+    Set<String> acceleratorSet = appSpec.getPlugins().values().stream().map(Plugin::getPluginClass)\n+      .map(PluginClass::getRequirements).map(\n+        Requirements::getAccelerators).flatMap(Set::stream)\n+      .collect(Collectors.toSet());\n+    //add from application\n+    acceleratorSet.addAll(applicationClass.getRequirements().getAccelerators());\n+    String acceleratorsValue = String.join(\",\", acceleratorSet);\n+    if (acceleratorsValue == null || acceleratorsValue.isEmpty()) {\n+      return;\n+    }\n+    properties.put(\"accelerator\", acceleratorsValue);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8edacdfb0123fa1b519f6ab2bde9ac98ba0fa9c3"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDg5ODgzMg==", "bodyText": "Move this after acceleratorValue emptiness check.", "url": "https://github.com/cdapio/cdap/pull/12830#discussion_r514898832", "createdAt": "2020-10-30T06:42:56Z", "author": {"login": "wyzhang"}, "path": "cdap-data-fabric/src/main/java/io/cdap/cdap/data2/metadata/system/AppSystemMetadataWriter.java", "diffHunk": "@@ -72,9 +78,27 @@ public AppSystemMetadataWriter(MetadataServiceClient metadataServiceClient, Appl\n         existingPluginClasses.add(plugin.getPluginClass());\n       }\n     }\n+    addAccelerators(appSpec, applicationClass, properties);\n     return properties.build();\n   }\n \n+  private void addAccelerators(ApplicationSpecification appSpec,\n+                               ApplicationClass applicationClass,\n+                               ImmutableMap.Builder<String, String> properties) {\n+    //add from all plugins\n+    Set<String> acceleratorSet = appSpec.getPlugins().values().stream().map(Plugin::getPluginClass)\n+      .map(PluginClass::getRequirements).map(\n+        Requirements::getAccelerators).flatMap(Set::stream)\n+      .collect(Collectors.toSet());\n+    //add from application\n+    acceleratorSet.addAll(applicationClass.getRequirements().getAccelerators());\n+    String acceleratorsValue = String.join(\",\", acceleratorSet);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8edacdfb0123fa1b519f6ab2bde9ac98ba0fa9c3"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDg5ODk4MA==", "bodyText": "Maybe avoid hard-coded string?", "url": "https://github.com/cdapio/cdap/pull/12830#discussion_r514898980", "createdAt": "2020-10-30T06:43:33Z", "author": {"login": "wyzhang"}, "path": "cdap-app-fabric/src/test/java/io/cdap/cdap/internal/app/services/ApplicationLifecycleServiceTest.java", "diffHunk": "@@ -128,6 +148,34 @@ public void testAppDeletionMultipleNS() throws Exception {\n     deleteAppAndData(testNSAppId);\n   }\n \n+  @Test\n+  public void testAcceleratorMetaDataDeletion() throws Exception {\n+    Id.Artifact artifactId = Id.Artifact\n+      .from(Id.Namespace.DEFAULT, AppWithWorkflow.class.getSimpleName(), \"1.0.0-SNAPSHOT\");\n+    Location appJar = AppJarHelper.createDeploymentJar(locationFactory, AppWithWorkflow.class);\n+    File appJarFile = new File(tmpFolder.newFolder(),\n+                               String.format(\"%s-%s.jar\", artifactId.getName(), artifactId.getVersion().getVersion()));\n+    Files.copy(Locations.newInputSupplier(appJar), appJarFile);\n+    appJar.delete();\n+\n+    //deploy app\n+    applicationLifecycleService\n+      .deployAppAndArtifact(NamespaceId.DEFAULT, AppWithWorkflow.class.getSimpleName(), artifactId, appJarFile, null,\n+                            null, programId -> {\n+        }, true);\n+    //Check for the accelerator metadata\n+    ApplicationId appId = NamespaceId.DEFAULT.app(AppWithWorkflow.class.getSimpleName());\n+    Assert.assertEquals(false, metadataStorage.read(new Read(appId.toMetadataEntity(),\n+                                                             MetadataScope.SYSTEM, MetadataKind.PROPERTY)).isEmpty());\n+    Map<String, String> metadataProperties = metadataStorage\n+      .read(new Read(appId.toMetadataEntity())).getProperties(MetadataScope.SYSTEM);\n+    Assert.assertEquals(\"cdc\", metadataProperties.get(\"accelerator\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8edacdfb0123fa1b519f6ab2bde9ac98ba0fa9c3"}, "originalPosition": 97}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9890dab02c6c90b7c1ecfcf6c5ad64b062569411", "author": {"user": {"login": "greeshmaswaminathan", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/9890dab02c6c90b7c1ecfcf6c5ad64b062569411", "committedDate": "2020-10-30T20:10:08Z", "message": "(CDAP-17276) Save accelerator annotation as system metadata when application is deployed."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8edacdfb0123fa1b519f6ab2bde9ac98ba0fa9c3", "author": {"user": {"login": "greeshmaswaminathan", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/8edacdfb0123fa1b519f6ab2bde9ac98ba0fa9c3", "committedDate": "2020-10-29T22:58:35Z", "message": "(CDAP-17276) Save accelerator annotation as system metadata when application is deployed."}, "afterCommit": {"oid": "9890dab02c6c90b7c1ecfcf6c5ad64b062569411", "author": {"user": {"login": "greeshmaswaminathan", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/9890dab02c6c90b7c1ecfcf6c5ad64b062569411", "committedDate": "2020-10-30T20:10:08Z", "message": "(CDAP-17276) Save accelerator annotation as system metadata when application is deployed."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxMDEyNDgz", "url": "https://github.com/cdapio/cdap/pull/12830#pullrequestreview-521012483", "createdAt": "2020-10-30T20:29:45Z", "commit": {"oid": "9890dab02c6c90b7c1ecfcf6c5ad64b062569411"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxMDYyNzE4", "url": "https://github.com/cdapio/cdap/pull/12830#pullrequestreview-521062718", "createdAt": "2020-10-30T22:09:19Z", "commit": {"oid": "9890dab02c6c90b7c1ecfcf6c5ad64b062569411"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQyMjowOToyMFrOHrhxSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQyMjowOToyMFrOHrhxSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQwNDEwNw==", "bodyText": "no need to use fully qualified name.", "url": "https://github.com/cdapio/cdap/pull/12830#discussion_r515404107", "createdAt": "2020-10-30T22:09:20Z", "author": {"login": "chtyim"}, "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/deploy/pipeline/AppDeploymentInfo.java", "diffHunk": "@@ -88,10 +89,10 @@ public NamespaceId getNamespaceId() {\n   }\n \n   /**\n-   * Returns the class name of the {@link Application}.\n+   * Returns the {@link io.cdap.cdap.api.artifact.ApplicationClass} associated with this {@link Application}.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9890dab02c6c90b7c1ecfcf6c5ad64b062569411"}, "originalPosition": 46}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1720, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}