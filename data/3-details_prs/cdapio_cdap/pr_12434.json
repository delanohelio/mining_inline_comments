{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyOTgxODM5", "number": 12434, "title": "[CDAP-17015] Update Preview UI to handle queued preview runs", "bodyText": "JIRA: https://issues.cask.co/browse/CDAP-17015\nBuild: https://builds.cask.co/browse/CDAP-UDUT810\nThe preview status API has two new statuses: ACQUIRED and WAITING. WAITING is for when the run has been queued, and ACQUIRED is when the run has been taken off the queue and is about to be run. The updated behavior is:\n\nWhen the user clicks \"Run\", the timer will start (assuming no error from the backend).\nAt this time, the text under the timer will also change from \u201cDuration\u201d to either \u201cN Pending\u201d where (N  is the number of runs ahead in the queue) or \u201cRunning\u201d if the run has started.\nIf the user hovers over the \u201cN Pending\u201d text, they will see a slightly longer status update, i.e. \u201cN runs ahead in the queue.\u201d\n\nAlso did some minor refactoring of the existing Preview code and made small fixes to the Alert component to have consistent timeout between React and Angular and work properly for the \"info\" banner (which is not currently used anywhere).", "createdAt": "2020-07-01T20:50:23Z", "url": "https://github.com/cdapio/cdap/pull/12434", "merged": true, "mergeCommit": {"oid": "d8c0f197cf7132f002fc555535f513b08e75d7f2"}, "closed": true, "closedAt": "2020-08-18T01:52:59Z", "author": {"login": "yukiej"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcwwx75ABqjM1MDQyNDIwMTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc_8xcKgBqjM2NjQxODM3ODQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "627a5979714ef0a64462aebd97ac471afdf6304e", "author": {"user": {"login": "yukiej", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/627a5979714ef0a64462aebd97ac471afdf6304e", "committedDate": "2020-07-01T20:40:11Z", "message": "Add error message extracting helper function to myHelpers and clean up top panel ctrl"}, "afterCommit": {"oid": "a89df0130aa4dd6393fbd47f814f344c0472c321", "author": {"user": {"login": "yukiej", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/a89df0130aa4dd6393fbd47f814f344c0472c321", "committedDate": "2020-07-01T21:03:38Z", "message": "Add error message extracting helper function to myHelpers and clean up top panel ctrl"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a89df0130aa4dd6393fbd47f814f344c0472c321", "author": {"user": {"login": "yukiej", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/a89df0130aa4dd6393fbd47f814f344c0472c321", "committedDate": "2020-07-01T21:03:38Z", "message": "Add error message extracting helper function to myHelpers and clean up top panel ctrl"}, "afterCommit": {"oid": "c2df23fbd0cbb19f796b7be9911f105909cd7b60", "author": {"user": {"login": "yukiej", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/c2df23fbd0cbb19f796b7be9911f105909cd7b60", "committedDate": "2020-07-01T21:10:08Z", "message": "Add helper functions for setting timer label, title, and start time and for extracting error messages"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c2df23fbd0cbb19f796b7be9911f105909cd7b60", "author": {"user": {"login": "yukiej", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/c2df23fbd0cbb19f796b7be9911f105909cd7b60", "committedDate": "2020-07-01T21:10:08Z", "message": "Add helper functions for setting timer label, title, and start time and for extracting error messages"}, "afterCommit": {"oid": "fe105311b2585a874aa13141fe0566bd6c32bff5", "author": {"user": {"login": "yukiej", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/fe105311b2585a874aa13141fe0566bd6c32bff5", "committedDate": "2020-07-01T21:34:21Z", "message": "Add helper functions for setting timer label, title, and start time\n\nAdd error message extracting helper function to myHelpers and clean up top panel ctrl"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMjY2NDE0", "url": "https://github.com/cdapio/cdap/pull/12434#pullrequestreview-441266414", "createdAt": "2020-07-01T23:59:27Z", "commit": {"oid": "fe105311b2585a874aa13141fe0566bd6c32bff5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMzo1OToyN1rOGr4_1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMzo1OToyN1rOGr4_1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY3NTc5Nw==", "bodyText": "I18n?", "url": "https://github.com/cdapio/cdap/pull/12434#discussion_r448675797", "createdAt": "2020-07-01T23:59:27Z", "author": {"login": "njbriggs"}, "path": "cdap-ui/app/hydrator/controllers/create/toppanel-ctrl.js", "diffHunk": "@@ -294,10 +304,36 @@ class HydratorPlusPlusTopPanelCtrl {\n     seconds = seconds < 10 ? '0' + seconds : seconds;\n     minutes = minutes < 10 ? '0' + minutes : minutes;\n \n+    this.setDisplayDuration(minutes, seconds);\n+  }\n+\n+  setDisplayDuration(minutes, seconds) {\n     this.displayDuration = {\n-      minutes: minutes,\n-      seconds: seconds\n-    };\n+      minutes: !minutes ? '--' : minutes,\n+      seconds: !seconds ? '--' : seconds,\n+    }\n+  }\n+\n+  updateTimerLabelAndTitle(res) {\n+    // set default\n+    if (!res) {\n+      this.timerLabel = 'Duration';\n+      this.queueStatus = '';\n+      return;\n+    }\n+\n+    const { WAITING, ACQUIRED, INIT, RUNNING } = window.CaskCommon.PREVIEW_STATUS;\n+    if (res.status === WAITING) {\n+      const runsAheadInQueue = res.positionInWaitingQueue;\n+      this.queueStatus = `${runsAheadInQueue} ${runsAheadInQueue === 1? 'run' : 'runs'} ahead in queue`;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe105311b2585a874aa13141fe0566bd6c32bff5"}, "originalPosition": 77}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0Mzg5MTQ0", "url": "https://github.com/cdapio/cdap/pull/12434#pullrequestreview-444389144", "createdAt": "2020-07-08T03:34:24Z", "commit": {"oid": "fe105311b2585a874aa13141fe0566bd6c32bff5"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwMzozNDoyNFrOGuW4NA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwMzozNzowOVrOGuW7Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI2MjUxNg==", "bodyText": "Could we have enum for this?", "url": "https://github.com/cdapio/cdap/pull/12434#discussion_r451262516", "createdAt": "2020-07-08T03:34:24Z", "author": {"login": "jennac3"}, "path": "cdap-ui/app/cdap/components/Alert/index.js", "diffHunk": "@@ -61,12 +58,16 @@ export default class Alert extends Component {\n         element,\n       });\n     }\n-    if (this.state.type === 'success') {\n-      clearTimeout(this.successTimeout);\n-      this.successTimeout = setTimeout(this.onClose, SUCCESS_CLOSE_TIMEOUT);\n-    }\n+    this.resetTimeout();\n   }\n \n+  resetTimeout = () => {\n+    if (this.state.type === 'success' || this.state.type === 'info') {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe105311b2585a874aa13141fe0566bd6c32bff5"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI2MjUzNA==", "bodyText": "Could we have enum for this?", "url": "https://github.com/cdapio/cdap/pull/12434#discussion_r451262534", "createdAt": "2020-07-08T03:34:29Z", "author": {"login": "jennac3"}, "path": "cdap-ui/app/services/alert-on-valium/alert-on-valium.js", "diffHunk": "@@ -19,14 +19,14 @@ angular.module(PKG.name + '.services')\n     var isAnAlertOpened = false,\n         alertObj;\n \n-    var SUCCESS_ALERT_DURATION = 4; // duration amount in seconds\n+    var SUCCESS_ALERT_DURATION = 3; // duration amount in seconds\n \n     function show(obj) {\n       if (alertObj) {\n         alertObj.hide();\n       }\n \n-      obj.duration = obj.type === 'success' ? SUCCESS_ALERT_DURATION : false;\n+      obj.duration = obj.type === 'success' || obj.type === 'info' ? SUCCESS_ALERT_DURATION : false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe105311b2585a874aa13141fe0566bd6c32bff5"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI2Mjg2Mg==", "bodyText": "Is this intended to be \"{{HydratorPlusPlusTopPanelCtrl.queueStatus}}\"? Could it be perhaps {{HydratorPlusPlusTopPanelCtrl.queueStatus}} instead?", "url": "https://github.com/cdapio/cdap/pull/12434#discussion_r451262862", "createdAt": "2020-07-08T03:35:43Z", "author": {"login": "jennac3"}, "path": "cdap-ui/app/hydrator/templates/create/toppanel.html", "diffHunk": "@@ -232,12 +232,12 @@\n         </div>\n       </div>\n     </div>\n-    <div class=\"btn run-time\">\n+    <div class=\"btn run-time\" title=\"{{HydratorPlusPlusTopPanelCtrl.queueStatus}}\">", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe105311b2585a874aa13141fe0566bd6c32bff5"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI2MzI4Ng==", "bodyText": "Could we use PREVIEW_STATUS for 'Running' and 'Duration'?", "url": "https://github.com/cdapio/cdap/pull/12434#discussion_r451263286", "createdAt": "2020-07-08T03:37:09Z", "author": {"login": "jennac3"}, "path": "cdap-ui/app/hydrator/controllers/create/toppanel-ctrl.js", "diffHunk": "@@ -294,10 +304,36 @@ class HydratorPlusPlusTopPanelCtrl {\n     seconds = seconds < 10 ? '0' + seconds : seconds;\n     minutes = minutes < 10 ? '0' + minutes : minutes;\n \n+    this.setDisplayDuration(minutes, seconds);\n+  }\n+\n+  setDisplayDuration(minutes, seconds) {\n     this.displayDuration = {\n-      minutes: minutes,\n-      seconds: seconds\n-    };\n+      minutes: !minutes ? '--' : minutes,\n+      seconds: !seconds ? '--' : seconds,\n+    }\n+  }\n+\n+  updateTimerLabelAndTitle(res) {\n+    // set default\n+    if (!res) {\n+      this.timerLabel = 'Duration';\n+      this.queueStatus = '';\n+      return;\n+    }\n+\n+    const { WAITING, ACQUIRED, INIT, RUNNING } = window.CaskCommon.PREVIEW_STATUS;\n+    if (res.status === WAITING) {\n+      const runsAheadInQueue = res.positionInWaitingQueue;\n+      this.queueStatus = `${runsAheadInQueue} ${runsAheadInQueue === 1? 'run' : 'runs'} ahead in queue`;\n+      this.timerLabel = `${runsAheadInQueue} Pending`;\n+    } else if ([ ACQUIRED, INIT, RUNNING ].includes(res.status) && this.loadingLabel !== 'Stopping') {\n+      this.timerLabel = 'Running';", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe105311b2585a874aa13141fe0566bd6c32bff5"}, "originalPosition": 80}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3NDg1NzIz", "url": "https://github.com/cdapio/cdap/pull/12434#pullrequestreview-447485723", "createdAt": "2020-07-13T18:12:15Z", "commit": {"oid": "f9767acc48d9dcfef882291d9a64bda0ce40e6c6"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxODoxMjoxNVrOGw0Ctw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxODoyMDoxM1rOGw0UtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzgzNzQ5NQ==", "bodyText": "Since this is purely used in Alert component can we co-locate this with Alert component?\nWould be better if we convert the Alert to typescript and add the enum to the same class as a static variable. That way components using Alert don't need to import this as an extra they can just use it as a static variable.", "url": "https://github.com/cdapio/cdap/pull/12434#discussion_r453837495", "createdAt": "2020-07-13T18:12:15Z", "author": {"login": "ajainarayanan"}, "path": "cdap-ui/app/cdap/services/AlertStatus.ts", "diffHunk": "@@ -0,0 +1,23 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+enum ALERT_STATUS {\n+  Success = 'success',", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9767acc48d9dcfef882291d9a64bda0ce40e6c6"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg0MjEwMQ==", "bodyText": "We don't have a complete story on i18n. We need to rethink how we do i18n. Right now we have a yaml file that we build and ship along with code which takes the away the benefit of i18n (since we can change the language. If we need to we then have to generate a new build). We will have to revisit i18n once we migrate the entirety of angular to react.", "url": "https://github.com/cdapio/cdap/pull/12434#discussion_r453842101", "createdAt": "2020-07-13T18:20:13Z", "author": {"login": "ajainarayanan"}, "path": "cdap-ui/app/hydrator/controllers/create/toppanel-ctrl.js", "diffHunk": "@@ -294,10 +304,36 @@ class HydratorPlusPlusTopPanelCtrl {\n     seconds = seconds < 10 ? '0' + seconds : seconds;\n     minutes = minutes < 10 ? '0' + minutes : minutes;\n \n+    this.setDisplayDuration(minutes, seconds);\n+  }\n+\n+  setDisplayDuration(minutes, seconds) {\n     this.displayDuration = {\n-      minutes: minutes,\n-      seconds: seconds\n-    };\n+      minutes: !minutes ? '--' : minutes,\n+      seconds: !seconds ? '--' : seconds,\n+    }\n+  }\n+\n+  updateTimerLabelAndTitle(res) {\n+    // set default\n+    if (!res) {\n+      this.timerLabel = 'Duration';\n+      this.queueStatus = '';\n+      return;\n+    }\n+\n+    const { WAITING, ACQUIRED, INIT, RUNNING } = window.CaskCommon.PREVIEW_STATUS;\n+    if (res.status === WAITING) {\n+      const runsAheadInQueue = res.positionInWaitingQueue;\n+      this.queueStatus = `${runsAheadInQueue} ${runsAheadInQueue === 1? 'run' : 'runs'} ahead in queue`;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY3NTc5Nw=="}, "originalCommit": {"oid": "fe105311b2585a874aa13141fe0566bd6c32bff5"}, "originalPosition": 77}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f9767acc48d9dcfef882291d9a64bda0ce40e6c6", "author": {"user": {"login": "yukiej", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/f9767acc48d9dcfef882291d9a64bda0ce40e6c6", "committedDate": "2020-07-10T18:39:52Z", "message": "Address feedback"}, "afterCommit": {"oid": "8e38cbaadae2353bcb68ef4b623d3a90839ed7d9", "author": {"user": {"login": "yukiej", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/8e38cbaadae2353bcb68ef4b623d3a90839ed7d9", "committedDate": "2020-07-20T20:57:57Z", "message": "Update preview statuses and button messaging to include WAITING and ACQUIRED"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxOTU2ODcy", "url": "https://github.com/cdapio/cdap/pull/12434#pullrequestreview-451956872", "createdAt": "2020-07-20T21:02:06Z", "commit": {"oid": "8e38cbaadae2353bcb68ef4b623d3a90839ed7d9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8e38cbaadae2353bcb68ef4b623d3a90839ed7d9", "author": {"user": {"login": "yukiej", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/8e38cbaadae2353bcb68ef4b623d3a90839ed7d9", "committedDate": "2020-07-20T20:57:57Z", "message": "Update preview statuses and button messaging to include WAITING and ACQUIRED"}, "afterCommit": {"oid": "f6ff517a472cbdee4e76b1f3090732133f0c9874", "author": {"user": {"login": "yukiej", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/f6ff517a472cbdee4e76b1f3090732133f0c9874", "committedDate": "2020-08-17T20:16:34Z", "message": "Update preview statuses and button messaging to include WAITING and ACQUIRED"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f6ff517a472cbdee4e76b1f3090732133f0c9874", "author": {"user": {"login": "yukiej", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/f6ff517a472cbdee4e76b1f3090732133f0c9874", "committedDate": "2020-08-17T20:16:34Z", "message": "Update preview statuses and button messaging to include WAITING and ACQUIRED"}, "afterCommit": {"oid": "f320167677a4f1d0a4b7dbb1107df99e009c9d9f", "author": {"user": {"login": "yukiej", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/f320167677a4f1d0a4b7dbb1107df99e009c9d9f", "committedDate": "2020-08-17T22:34:12Z", "message": "Update preview statuses and button messaging to include WAITING and ACQUIRED"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9cf73bc35b721d409b4acfbfaf02acc07e539eed", "author": {"user": {"login": "yukiej", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/9cf73bc35b721d409b4acfbfaf02acc07e539eed", "committedDate": "2020-08-18T01:30:56Z", "message": "Update alert component to handle info case"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70af6a87ce1a7b75e5c1387fe3949754c9abfd09", "author": {"user": {"login": "yukiej", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/70af6a87ce1a7b75e5c1387fe3949754c9abfd09", "committedDate": "2020-08-18T01:30:57Z", "message": "Update preview statuses and button messaging to include WAITING and ACQUIRED"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f320167677a4f1d0a4b7dbb1107df99e009c9d9f", "author": {"user": {"login": "yukiej", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/f320167677a4f1d0a4b7dbb1107df99e009c9d9f", "committedDate": "2020-08-17T22:34:12Z", "message": "Update preview statuses and button messaging to include WAITING and ACQUIRED"}, "afterCommit": {"oid": "70af6a87ce1a7b75e5c1387fe3949754c9abfd09", "author": {"user": {"login": "yukiej", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/70af6a87ce1a7b75e5c1387fe3949754c9abfd09", "committedDate": "2020-08-18T01:30:57Z", "message": "Update preview statuses and button messaging to include WAITING and ACQUIRED"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1946, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}