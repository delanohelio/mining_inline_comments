{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI1MjQ2Mjk5", "number": 12228, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxOToyOToyNFrOEBAtkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxOTozMTo1MVrOEBAwHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5NDk1Njk5OnYy", "diffSide": "RIGHT", "path": "cdap-app-templates/cdap-etl/cdap-etl-core/src/main/java/io/cdap/cdap/etl/common/plugin/JoinerBridge.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxOToyOToyNFrOGcpW2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQyMTozMDoyMVrOGcsnhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY5MDkwNg==", "bodyText": "Any reason we changed this? Since AutoJoin only supports StructuredRecord, it is cleaner to just keep it here to avoid the unnecessary type cast changes in the class", "url": "https://github.com/cdapio/cdap/pull/12228#discussion_r432690906", "createdAt": "2020-05-29T19:29:24Z", "author": {"login": "yaojiefeng"}, "path": "cdap-app-templates/cdap-etl/cdap-etl-core/src/main/java/io/cdap/cdap/etl/common/plugin/JoinerBridge.java", "diffHunk": "@@ -38,8 +38,10 @@\n \n /**\n  * An implementation of {@link BatchJoiner} using a {@link BatchAutoJoiner}.\n+ *\n+ * @param <INPUT_RECORD> type of input record\n  */\n-public class JoinerBridge extends BatchJoiner<StructuredRecord, StructuredRecord, StructuredRecord> {\n+public class JoinerBridge<INPUT_RECORD> extends BatchJoiner<StructuredRecord, INPUT_RECORD, StructuredRecord> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d363e78eb0372e797cd8a28e4850183ef142819"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc0NDMyNA==", "bodyText": "had to change this due to the generics in JoinOn and JoinMerge transforms. It shouldn't functionally change anything.\nIdeally we would remove the generics from most of our plugin APIs and standardize on StructuredRecord, but that would be a backwards incompatible change.", "url": "https://github.com/cdapio/cdap/pull/12228#discussion_r432744324", "createdAt": "2020-05-29T21:30:21Z", "author": {"login": "albertshau"}, "path": "cdap-app-templates/cdap-etl/cdap-etl-core/src/main/java/io/cdap/cdap/etl/common/plugin/JoinerBridge.java", "diffHunk": "@@ -38,8 +38,10 @@\n \n /**\n  * An implementation of {@link BatchJoiner} using a {@link BatchAutoJoiner}.\n+ *\n+ * @param <INPUT_RECORD> type of input record\n  */\n-public class JoinerBridge extends BatchJoiner<StructuredRecord, StructuredRecord, StructuredRecord> {\n+public class JoinerBridge<INPUT_RECORD> extends BatchJoiner<StructuredRecord, INPUT_RECORD, StructuredRecord> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY5MDkwNg=="}, "originalCommit": {"oid": "4d363e78eb0372e797cd8a28e4850183ef142819"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5NDk1ODYwOnYy", "diffSide": "RIGHT", "path": "cdap-app-templates/cdap-etl/hydrator-spark-core-base/src/main/java/io/cdap/cdap/etl/spark/SparkPipelineRunner.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxOToyOTo1OFrOGcpXyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxOToyOTo1OFrOGcpXyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY5MTE0NQ==", "bodyText": "nit - extra line", "url": "https://github.com/cdapio/cdap/pull/12228#discussion_r432691145", "createdAt": "2020-05-29T19:29:58Z", "author": {"login": "yaojiefeng"}, "path": "cdap-app-templates/cdap-etl/hydrator-spark-core-base/src/main/java/io/cdap/cdap/etl/spark/SparkPipelineRunner.java", "diffHunk": "@@ -359,6 +332,39 @@ public void runPipeline(PipelinePhase pipelinePhase, String sourcePluginType,\n     }\n   }\n \n+  protected SparkCollection<Object> handleJoin(Map<String, SparkCollection<Object>> inputDataCollections,\n+                                               PipelinePhase pipelinePhase, PluginFunctionContext pluginFunctionContext,\n+                                               StageSpec stageSpec, Object plugin, Integer numPartitions,\n+                                               StageStatisticsCollector collector) throws Exception {\n+    String stageName = stageSpec.getName();\n+    if (plugin instanceof BatchJoiner) {\n+      BatchJoiner<Object, Object, Object> joiner = (BatchJoiner<Object, Object, Object>) plugin;\n+      BatchJoinerRuntimeContext joinerRuntimeContext = pluginFunctionContext.createBatchRuntimeContext();\n+      joiner.initialize(joinerRuntimeContext);\n+\n+      return handleJoin(joiner, inputDataCollections, stageSpec, numPartitions, collector).cache();\n+    } else if (plugin instanceof AutoJoiner) {\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d363e78eb0372e797cd8a28e4850183ef142819"}, "originalPosition": 57}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5NDk2MDk1OnYy", "diffSide": "RIGHT", "path": "cdap-app-templates/cdap-etl/cdap-data-streams/src/main/java/io/cdap/cdap/datastreams/SparkStreamingPipelineRunner.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxOTozMDo0NlrOGcpZNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQyMToyODo1OVrOGcslmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY5MTUwOA==", "bodyText": "Do we need the check here? I remember we have some earlier validation before we get here", "url": "https://github.com/cdapio/cdap/pull/12228#discussion_r432691508", "createdAt": "2020-05-29T19:30:46Z", "author": {"login": "yaojiefeng"}, "path": "cdap-app-templates/cdap-etl/cdap-data-streams/src/main/java/io/cdap/cdap/datastreams/SparkStreamingPipelineRunner.java", "diffHunk": "@@ -123,4 +135,43 @@ public SparkStreamingPipelineRunner(JavaSparkExecutionContext sec, JavaStreaming\n     JavaDStream<Object> result = pairDStream.transform(new DynamicJoinMerge<>(dynamicDriverContext));\n     return new DStreamCollection<>(sec, result);\n   }\n+\n+  @Override\n+  protected SparkCollection<Object> handleJoin(Map<String, SparkCollection<Object>> inputDataCollections,\n+                                               PipelinePhase pipelinePhase, PluginFunctionContext pluginFunctionContext,\n+                                               StageSpec stageSpec, Object plugin, Integer numPartitions,\n+                                               StageStatisticsCollector collector) throws Exception {\n+    String stageName = stageSpec.getName();\n+    BatchJoiner<?, ?, ?> joiner;\n+    if (plugin instanceof BatchAutoJoiner) {\n+      BatchAutoJoiner autoJoiner = (BatchAutoJoiner) plugin;\n+\n+      Map<String, JoinStage> inputStages = new HashMap<>();\n+      for (String inputStageName : pipelinePhase.getStageInputs(stageName)) {\n+        StageSpec inputStageSpec = pipelinePhase.getStage(inputStageName);\n+        inputStages.put(inputStageName,\n+                        JoinStage.builder(inputStageName, inputStageSpec.getOutputSchema()).build());\n+      }\n+      AutoJoinerContext autoJoinerContext = new DefaultAutoJoinerContext(inputStages);\n+\n+      JoinDefinition joinDefinition = autoJoiner.define(autoJoinerContext);\n+      if (joinDefinition == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d363e78eb0372e797cd8a28e4850183ef142819"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc0MzgzMw==", "bodyText": "it is checked at prepare time for batch runs, but that part is not run for streaming pipelines.", "url": "https://github.com/cdapio/cdap/pull/12228#discussion_r432743833", "createdAt": "2020-05-29T21:28:59Z", "author": {"login": "albertshau"}, "path": "cdap-app-templates/cdap-etl/cdap-data-streams/src/main/java/io/cdap/cdap/datastreams/SparkStreamingPipelineRunner.java", "diffHunk": "@@ -123,4 +135,43 @@ public SparkStreamingPipelineRunner(JavaSparkExecutionContext sec, JavaStreaming\n     JavaDStream<Object> result = pairDStream.transform(new DynamicJoinMerge<>(dynamicDriverContext));\n     return new DStreamCollection<>(sec, result);\n   }\n+\n+  @Override\n+  protected SparkCollection<Object> handleJoin(Map<String, SparkCollection<Object>> inputDataCollections,\n+                                               PipelinePhase pipelinePhase, PluginFunctionContext pluginFunctionContext,\n+                                               StageSpec stageSpec, Object plugin, Integer numPartitions,\n+                                               StageStatisticsCollector collector) throws Exception {\n+    String stageName = stageSpec.getName();\n+    BatchJoiner<?, ?, ?> joiner;\n+    if (plugin instanceof BatchAutoJoiner) {\n+      BatchAutoJoiner autoJoiner = (BatchAutoJoiner) plugin;\n+\n+      Map<String, JoinStage> inputStages = new HashMap<>();\n+      for (String inputStageName : pipelinePhase.getStageInputs(stageName)) {\n+        StageSpec inputStageSpec = pipelinePhase.getStage(inputStageName);\n+        inputStages.put(inputStageName,\n+                        JoinStage.builder(inputStageName, inputStageSpec.getOutputSchema()).build());\n+      }\n+      AutoJoinerContext autoJoinerContext = new DefaultAutoJoinerContext(inputStages);\n+\n+      JoinDefinition joinDefinition = autoJoiner.define(autoJoinerContext);\n+      if (joinDefinition == null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY5MTUwOA=="}, "originalCommit": {"oid": "4d363e78eb0372e797cd8a28e4850183ef142819"}, "originalPosition": 55}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5NDk2MzUxOnYy", "diffSide": "RIGHT", "path": "cdap-app-templates/cdap-etl/hydrator-spark-core-base/src/main/java/io/cdap/cdap/etl/spark/function/JoinMergeFunction.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxOTozMTo1MVrOGcpa7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQyMTozMToxNVrOGcsoyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY5MTk1MQ==", "bodyText": "Have seen this logic in multiple places, do you think it is possible to have an utility class for this logic?", "url": "https://github.com/cdapio/cdap/pull/12228#discussion_r432691951", "createdAt": "2020-05-29T19:31:51Z", "author": {"login": "yaojiefeng"}, "path": "cdap-app-templates/cdap-etl/hydrator-spark-core-base/src/main/java/io/cdap/cdap/etl/spark/function/JoinMergeFunction.java", "diffHunk": "@@ -64,6 +66,28 @@ public JoinMergeFunction(PluginFunctionContext pluginFunctionContext) {\n     return emitter.getEntries();\n   }\n \n+  private <K, V, O> BatchJoiner<K, V, O> createInitializedJoiner() throws Exception {\n+    Object plugin = pluginFunctionContext.createPlugin();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d363e78eb0372e797cd8a28e4850183ef142819"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc0NDY1MQ==", "bodyText": "it's slightly different in each place unfortunately. for example, some places it looks at the join condition in order to figure out if certain keys need to be filtered out.", "url": "https://github.com/cdapio/cdap/pull/12228#discussion_r432744651", "createdAt": "2020-05-29T21:31:15Z", "author": {"login": "albertshau"}, "path": "cdap-app-templates/cdap-etl/hydrator-spark-core-base/src/main/java/io/cdap/cdap/etl/spark/function/JoinMergeFunction.java", "diffHunk": "@@ -64,6 +66,28 @@ public JoinMergeFunction(PluginFunctionContext pluginFunctionContext) {\n     return emitter.getEntries();\n   }\n \n+  private <K, V, O> BatchJoiner<K, V, O> createInitializedJoiner() throws Exception {\n+    Object plugin = pluginFunctionContext.createPlugin();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY5MTk1MQ=="}, "originalCommit": {"oid": "4d363e78eb0372e797cd8a28e4850183ef142819"}, "originalPosition": 32}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2695, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}