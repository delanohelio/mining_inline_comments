{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkyNjU2ODA0", "number": 11991, "title": "CDAP-16239 include context in plugin config creation error", "bodyText": "When the plugin config cannot be created because there are\nmissing properties or invalid properties, include which properties\nare invalid in the error message.\nAlso fixed a bug where a given property with a null value was\nincorrectly not counted as a missing property.", "createdAt": "2020-03-23T21:50:06Z", "url": "https://github.com/cdapio/cdap/pull/11991", "merged": true, "mergeCommit": {"oid": "4d25c3cc19b63cc83959e7eae658c1e82b507508"}, "closed": true, "closedAt": "2020-04-09T20:38:55Z", "author": {"login": "albertshau"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcQlk-ugFqTM3OTg1MTY4Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcV33figFqTM5MDU3MzMzNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5ODUxNjgy", "url": "https://github.com/cdapio/cdap/pull/11991#pullrequestreview-379851682", "createdAt": "2020-03-23T21:55:45Z", "commit": {"oid": "1bb9c778bd2523fb532097a001f8a68722b8fe8a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1bb9c778bd2523fb532097a001f8a68722b8fe8a", "author": {"user": {"login": "albertshau", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/1bb9c778bd2523fb532097a001f8a68722b8fe8a", "committedDate": "2020-03-23T21:23:55Z", "message": "CDAP-16239 include context in plugin config creation error\n\nWhen the plugin config cannot be created because there are\nmissing properties or invalid properties, include which properties\nare invalid in the error message.\n\nAlso fixed a bug where a given property with a null value was\nincorrectly not counted as a missing property."}, "afterCommit": {"oid": "99e37ff16c17a3cba44bbe19a11de7270c1ab0d4", "author": {"user": {"login": "albertshau", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/99e37ff16c17a3cba44bbe19a11de7270c1ab0d4", "committedDate": "2020-03-24T00:23:55Z", "message": "CDAP-16239 include context in plugin config creation error\n\nWhen the plugin config cannot be created because there are\nmissing properties or invalid properties, include which properties\nare invalid in the error message.\n\nAlso fixed a bug where a given property with a null value was\nincorrectly not counted as a missing property."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3NzY4MDA1", "url": "https://github.com/cdapio/cdap/pull/11991#pullrequestreview-387768005", "createdAt": "2020-04-04T23:48:54Z", "commit": {"oid": "99e37ff16c17a3cba44bbe19a11de7270c1ab0d4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNFQyMzo0ODo1NFrOGA4kgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNFQyMzo0ODo1NFrOGA4kgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzU4MDAzNA==", "bodyText": "It's better to include the plugin name as well.", "url": "https://github.com/cdapio/cdap/pull/11991#discussion_r403580034", "createdAt": "2020-04-04T23:48:54Z", "author": {"login": "chtyim"}, "path": "cdap-api/src/main/java/io/cdap/cdap/api/plugin/InvalidPluginConfigException.java", "diffHunk": "@@ -57,4 +57,26 @@ public InvalidPluginConfigException(String message, Set<String> missingPropertie\n   public Set<InvalidPluginProperty> getInvalidProperties() {\n     return invalidProperties;\n   }\n+\n+  private static String generateErrorMessage(String baseMessage, Set<String> missingProperties,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99e37ff16c17a3cba44bbe19a11de7270c1ab0d4"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3NzY4MTY4", "url": "https://github.com/cdapio/cdap/pull/11991#pullrequestreview-387768168", "createdAt": "2020-04-04T23:52:31Z", "commit": {"oid": "99e37ff16c17a3cba44bbe19a11de7270c1ab0d4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNFQyMzo1MjozMVrOGA4qyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNFQyMzo1MjozMVrOGA4qyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzU4MTY0MA==", "bodyText": "Also, invalid property is caused by an exception when trying to set the field. So it'll be good if this exception can carry those as suppressed causes.", "url": "https://github.com/cdapio/cdap/pull/11991#discussion_r403581640", "createdAt": "2020-04-04T23:52:31Z", "author": {"login": "chtyim"}, "path": "cdap-api/src/main/java/io/cdap/cdap/api/plugin/InvalidPluginConfigException.java", "diffHunk": "@@ -57,4 +57,26 @@ public InvalidPluginConfigException(String message, Set<String> missingPropertie\n   public Set<InvalidPluginProperty> getInvalidProperties() {\n     return invalidProperties;\n   }\n+\n+  private static String generateErrorMessage(String baseMessage, Set<String> missingProperties,\n+                                             Set<InvalidPluginProperty> invalidProperties) {\n+    if (missingProperties.isEmpty() && invalidProperties.isEmpty()) {\n+      return baseMessage;\n+    }\n+\n+    StringBuilder errorMessage = new StringBuilder(baseMessage);\n+    if (missingProperties.size() == 1) {\n+      errorMessage.append(String.format(\" Required property '%s' is missing.\", missingProperties.iterator().next()));\n+    } else if (missingProperties.size() > 1) {\n+      errorMessage.append(String.format(\" Required properties '%s' are missing.\",\n+                                        String.join(\", \", missingProperties)));\n+    }\n+\n+    for (InvalidPluginProperty invalidProperty : invalidProperties) {\n+      errorMessage.append(String.format(\" '%s' is invalid: %s.\",\n+                                        invalidProperty.getName(), invalidProperty.getErrorMessage()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99e37ff16c17a3cba44bbe19a11de7270c1ab0d4"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwNTAwNDk1", "url": "https://github.com/cdapio/cdap/pull/11991#pullrequestreview-390500495", "createdAt": "2020-04-09T05:30:59Z", "commit": {"oid": "b86a1305aab5de3195d496080ec38baa7aa53e7b"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwNTozMDo1OVrOGDKH4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwNTozMDo1OVrOGDKH4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk2NDc2OA==", "bodyText": "A better wait is to use map:\ninvalidProperties.stream()\n  .map(InvalidPluginProperty::getCause)\n  .filter(Objects::nonNull)\n  .forEach(this::addSuppressed)", "url": "https://github.com/cdapio/cdap/pull/11991#discussion_r405964768", "createdAt": "2020-04-09T05:30:59Z", "author": {"login": "chtyim"}, "path": "cdap-api/src/main/java/io/cdap/cdap/api/plugin/InvalidPluginConfigException.java", "diffHunk": "@@ -27,20 +27,23 @@\n  * the property type specified by the PluginConfig is incompatible with the value provided in the PluginProperties.\n  */\n public class InvalidPluginConfigException extends RuntimeException {\n-  private Set<String> missingProperties;\n-  private Set<InvalidPluginProperty> invalidProperties;\n+  private final Set<String> missingProperties;\n+  private final Set<InvalidPluginProperty> invalidProperties;\n \n   public InvalidPluginConfigException(String message, Throwable cause) {\n     super(message, cause);\n     this.missingProperties = Collections.emptySet();\n     this.invalidProperties = Collections.emptySet();\n   }\n \n-  public InvalidPluginConfigException(String message, Set<String> missingProperties,\n+  public InvalidPluginConfigException(PluginClass pluginClass, Set<String> missingProperties,\n                                       Set<InvalidPluginProperty> invalidProperties) {\n-    super(message);\n+    super(generateErrorMessage(pluginClass, missingProperties, invalidProperties));\n     this.missingProperties = Collections.unmodifiableSet(new HashSet<>(missingProperties));\n     this.invalidProperties = Collections.unmodifiableSet(new HashSet<>(invalidProperties));\n+    invalidProperties.stream()\n+      .filter(p -> p.getCause() != null)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b86a1305aab5de3195d496080ec38baa7aa53e7b"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9812a37e1c91c1c03812d0e7e66d4075946d0947", "author": {"user": {"login": "albertshau", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/9812a37e1c91c1c03812d0e7e66d4075946d0947", "committedDate": "2020-04-09T07:59:17Z", "message": "CDAP-16239 include context in plugin config creation error\n\nWhen the plugin config cannot be created because there are\nmissing properties or invalid properties, include which properties\nare invalid in the error message.\n\nAlso fixed a bug where a given property with a null value was\nincorrectly not counted as a missing property."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b86a1305aab5de3195d496080ec38baa7aa53e7b", "author": {"user": {"login": "albertshau", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/b86a1305aab5de3195d496080ec38baa7aa53e7b", "committedDate": "2020-04-08T23:34:35Z", "message": "CDAP-16239 include causes for invalid plugin properties\n\nInclude causes of invalid plugin properties as suppressed exceptions\nwhen the plugin config can't be created. Also include the plugin\ntype and name in the error message."}, "afterCommit": {"oid": "9812a37e1c91c1c03812d0e7e66d4075946d0947", "author": {"user": {"login": "albertshau", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/9812a37e1c91c1c03812d0e7e66d4075946d0947", "committedDate": "2020-04-09T07:59:17Z", "message": "CDAP-16239 include context in plugin config creation error\n\nWhen the plugin config cannot be created because there are\nmissing properties or invalid properties, include which properties\nare invalid in the error message.\n\nAlso fixed a bug where a given property with a null value was\nincorrectly not counted as a missing property."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwNTczMzM1", "url": "https://github.com/cdapio/cdap/pull/11991#pullrequestreview-390573335", "createdAt": "2020-04-09T08:03:53Z", "commit": {"oid": "9812a37e1c91c1c03812d0e7e66d4075946d0947"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1186, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}