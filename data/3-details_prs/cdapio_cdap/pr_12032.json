{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk3OTQzMzAw", "number": 12032, "title": "(CDAP-16353) Support preview to run with non-sharing local level DB.", "bodyText": "Why:\nAllow preview to run with its own local levelDB. This allows us to\ndeploy cdap in a distributed fashion without shared underlying\nstorage when storage impl is NOSQL.\n\nWhat:\nThis change allow preview to run with local levelDB when data storage\nis NOSQL. It achieves this by binding interface to local vs remote\nimplementation dynamically depending on storage implementation config.\n\nThe crux of the change is in DefaultPreviewRunnerModule where we bind\nfollowing interfaces to local impl for SQL and remote for NOSQL\n* ArtifactRepositoryReader\n* PluginFinder\n* PreferencesFetcher\n\nChanges in tests:\n* Starting AppFabric in TestBase (required by PreviewDataPipelineTest) as\n  we use NOSQL in unit tests, therefore bindings use remote impls for\n  above interfaces and need to talk to AppFabric\n* PreviewServiceMainTest now no longer needs to workaround the issue of\n  non-sharing local levelDB (previously it needs to shutdown AppFabric\n  before starting preview so as to have levelDB state updated by AppFabric\n  to be visible to preview in order for it to work)\n* Extend PreviewServiceMainTest with a new test case where app has plugin\n  (in order to cover plugin finder code path in preview), thus better\n  test coverage.", "createdAt": "2020-04-03T05:22:06Z", "url": "https://github.com/cdapio/cdap/pull/12032", "merged": true, "mergeCommit": {"oid": "b4e3b9968bb9a5c5d004aa4e5cb5d0c0ee50df64"}, "closed": true, "closedAt": "2020-04-06T05:48:37Z", "author": {"login": "wyzhang"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcT6QhZgFqTM4Njk0ODE3OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcU396JABqjMyMDM2OTMwNDM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2OTQ4MTc4", "url": "https://github.com/cdapio/cdap/pull/12032#pullrequestreview-386948178", "createdAt": "2020-04-03T05:38:33Z", "commit": {"oid": "be15f9c04eddb7f7a49755b89ce660003f287d1d"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwNTozODozM1rOGAFtgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwNTo0MzowNVrOGAFyJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc0Njc1NA==", "bodyText": "nice that we don't need this anymore", "url": "https://github.com/cdapio/cdap/pull/12032#discussion_r402746754", "createdAt": "2020-04-03T05:38:33Z", "author": {"login": "albertshau"}, "path": "cdap-master/src/test/java/io/cdap/cdap/master/environment/k8s/PreviewServiceMainTest.java", "diffHunk": "@@ -39,82 +42,223 @@\n import org.apache.twill.filesystem.LocalLocationFactory;\n import org.apache.twill.filesystem.Location;\n import org.apache.twill.filesystem.LocationFactory;\n+import org.junit.After;\n import org.junit.Assert;\n import org.junit.Test;\n \n+import java.io.IOException;\n import java.io.InputStream;\n+import java.lang.reflect.Type;\n import java.net.HttpURLConnection;\n+import java.net.MalformedURLException;\n import java.net.URL;\n import java.util.Collections;\n import java.util.List;\n import java.util.Map;\n import java.util.concurrent.TimeUnit;\n+import java.util.jar.Manifest;\n \n /**\n  * Unit test for {@link AppFabricServiceMain}.\n  */\n public class PreviewServiceMainTest extends MasterServiceMainTestBase {\n   private static final Gson GSON = new Gson();\n \n-  @Test\n-  public void testPreviewService() throws Exception {\n+  private static final Type ARTIFACT_SUMMARY_LIST = new TypeToken<List<ArtifactSummary>>() { }.getType();\n+\n+  @After\n+  public void after() throws IOException {\n+    deleteAllArtifact();\n+  }\n \n-    // Deploy the app artifact\n+  @Test\n+  public void testPreviewSimpleApp() throws Exception {\n+    // Build the app\n     LocationFactory locationFactory = new LocalLocationFactory(TEMP_FOLDER.newFolder());\n     Location appJar = AppJarHelper.createDeploymentJar(locationFactory, PreviewTestApp.class);\n \n+    // Deploy the app\n     String artifactName = PreviewTestApp.class.getSimpleName();\n     String artifactVersion = \"1.0.0-SNAPSHOT\";\n+    deployArtifact(appJar, artifactName, artifactVersion);\n \n-    HttpRequestConfig requestConfig = new HttpRequestConfig(0, 0, false);\n-    URL url = getRouterBaseURI().resolve(String.format(\"/v3/namespaces/default/artifacts/%s\", artifactName)).toURL();\n-    HttpResponse response = HttpRequests.execute(\n-      HttpRequest.post(url)\n-        .withBody((ContentProvider<? extends InputStream>) appJar::getInputStream)\n-        .addHeader(\"Artifact-Version\", artifactVersion)\n-        .build(), requestConfig);\n-    Assert.assertEquals(HttpURLConnection.HTTP_OK, response.getResponseCode());\n+    // Start the preview service main, which will use its own local datadir, thus should fetch artifact location\n+    // from appFabric when running a preview\n+    startService(PreviewServiceMain.class);\n \n-    // have to stop AppFabric so that Preview can share the same leveldb table", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be15f9c04eddb7f7a49755b89ce660003f287d1d"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc0Nzk0Mw==", "bodyText": "not really sure how things were working before if app fabric was never getting started before. Unless I'm missing something, it doesn't seem like the changes in this PR would affect TestBase?", "url": "https://github.com/cdapio/cdap/pull/12032#discussion_r402747943", "createdAt": "2020-04-03T05:43:05Z", "author": {"login": "albertshau"}, "path": "cdap-unit-test/src/main/java/io/cdap/cdap/test/TestBase.java", "diffHunk": "@@ -369,6 +371,8 @@ protected void configure() {\n     provisioningService = injector.getInstance(ProvisioningService.class);\n     provisioningService.startAndWait();\n     metadataSubscriberService.startAndWait();\n+    appFabricServer = injector.getInstance(AppFabricServer.class);\n+    appFabricServer.startAndWait();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be15f9c04eddb7f7a49755b89ce660003f287d1d"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3NDE1MjM3", "url": "https://github.com/cdapio/cdap/pull/12032#pullrequestreview-387415237", "createdAt": "2020-04-03T16:40:58Z", "commit": {"oid": "a2f9c57b359d7d9366fcc0d9126bac9334e02f98"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a9acce795ee2e28d6fb93c973d9c5196bfad86f0", "author": {"user": {"login": "wyzhang", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/a9acce795ee2e28d6fb93c973d9c5196bfad86f0", "committedDate": "2020-04-04T23:11:54Z", "message": "update test"}, "afterCommit": {"oid": "00f4a0d3065803b8eeb25ff81504de7198e11aa5", "author": {"user": {"login": "wyzhang", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/00f4a0d3065803b8eeb25ff81504de7198e11aa5", "committedDate": "2020-04-05T06:20:43Z", "message": "(CDAP-16353) Support preview to run with non-sharing local level DB.\n\nWhy:\nAllow preview to run with its own local levelDB. This allows us to\ndeploy cdap in a dsitributed fashion without shared underlyihg\nstorage when storage impl is NOSQL.\n\nWhat:\nThis change allow preview to run with local levelDB when data storage\nis NOSQL. It achieves this by binding interface to local vs remote\nimplementation dynamically depending on storage impelementation config.\n\nThe crux of the chagne is in DefaultPreviewRunnerModule where we bind\nfollowing interafces to local impl for SQL and remote for NOSQL\n* ArtifactRepositoryReader\n* PluginFinder\n* PreferencesFetcher\n\nChanges in tests:\n* Starting AppFabric in TestBase (required by PreviewDataPipelineTest) as\n  we use NOSQL in unit tests, therefore bindings use remote impls for\n  above interafces and need to talk to AppFabric\n* PreviewServiceMainTest now no longer needs to workaround the issue of\n  non-sharing local levelDB (previously it needs to shutdown AppFabric\n  before starting preview so as to have levelDB state updated by AppFabric\n  to be visible to preview in order for it to work)\n* Extend PreviewServiceMainTest with a new test case where app has plugin\n  (in order to cover plugin finder code path in preview), thus better\n  test coverage."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "00f4a0d3065803b8eeb25ff81504de7198e11aa5", "author": {"user": {"login": "wyzhang", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/00f4a0d3065803b8eeb25ff81504de7198e11aa5", "committedDate": "2020-04-05T06:20:43Z", "message": "(CDAP-16353) Support preview to run with non-sharing local level DB.\n\nWhy:\nAllow preview to run with its own local levelDB. This allows us to\ndeploy cdap in a dsitributed fashion without shared underlyihg\nstorage when storage impl is NOSQL.\n\nWhat:\nThis change allow preview to run with local levelDB when data storage\nis NOSQL. It achieves this by binding interface to local vs remote\nimplementation dynamically depending on storage impelementation config.\n\nThe crux of the chagne is in DefaultPreviewRunnerModule where we bind\nfollowing interafces to local impl for SQL and remote for NOSQL\n* ArtifactRepositoryReader\n* PluginFinder\n* PreferencesFetcher\n\nChanges in tests:\n* Starting AppFabric in TestBase (required by PreviewDataPipelineTest) as\n  we use NOSQL in unit tests, therefore bindings use remote impls for\n  above interafces and need to talk to AppFabric\n* PreviewServiceMainTest now no longer needs to workaround the issue of\n  non-sharing local levelDB (previously it needs to shutdown AppFabric\n  before starting preview so as to have levelDB state updated by AppFabric\n  to be visible to preview in order for it to work)\n* Extend PreviewServiceMainTest with a new test case where app has plugin\n  (in order to cover plugin finder code path in preview), thus better\n  test coverage."}, "afterCommit": {"oid": "d0128ba929cf02510a78e904051f6b07019d5ba5", "author": {"user": {"login": "wyzhang", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/d0128ba929cf02510a78e904051f6b07019d5ba5", "committedDate": "2020-04-05T06:24:14Z", "message": "(CDAP-16353) Support preview to run with non-sharing local level DB.\n\nWhy:\nAllow preview to run with its own local levelDB. This allows us to\ndeploy cdap in a dsitributed fashion without shared underlyihg\nstorage when storage impl is NOSQL.\n\nWhat:\nThis change allow preview to run with local levelDB when data storage\nis NOSQL. It achieves this by binding interface to local vs remote\nimplementation dynamically depending on storage impelementation config.\n\nThe crux of the chagne is in DefaultPreviewRunnerModule where we bind\nfollowing interafces to local impl for SQL and remote for NOSQL\n* ArtifactRepositoryReader\n* PluginFinder\n* PreferencesFetcher\n\nChanges in tests:\n* Starting AppFabric in TestBase (required by PreviewDataPipelineTest) as\n  we use NOSQL in unit tests, therefore bindings use remote impls for\n  above interafces and need to talk to AppFabric\n* PreviewServiceMainTest now no longer needs to workaround the issue of\n  non-sharing local levelDB (previously it needs to shutdown AppFabric\n  before starting preview so as to have levelDB state updated by AppFabric\n  to be visible to preview in order for it to work)\n* Extend PreviewServiceMainTest with a new test case where app has plugin\n  (in order to cover plugin finder code path in preview), thus better\n  test coverage."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ecd324ff66cecd1ac351fb5f0348395852a11062", "author": {"user": {"login": "wyzhang", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/ecd324ff66cecd1ac351fb5f0348395852a11062", "committedDate": "2020-04-06T05:35:46Z", "message": "(CDAP-16353) Support preview to run with non-sharing local level DB.\n\nWhy:\nAllow preview to run with its own local levelDB. This allows us to\ndeploy cdap in a dsitributed fashion without shared underlyihg\nstorage when storage impl is NOSQL.\n\nWhat:\nThis change allow preview to run with local levelDB when data storage\nis NOSQL. It achieves this by binding interface to local vs remote\nimplementation dynamically depending on storage impelementation config.\n\nThe crux of the chagne is in DefaultPreviewRunnerModule where we bind\nfollowing interafces to local impl for SQL and remote for NOSQL\n* ArtifactRepositoryReader\n* PluginFinder\n* PreferencesFetcher\n\nChanges in tests:\n* Starting AppFabric in TestBase (required by PreviewDataPipelineTest) as\n  we use NOSQL in unit tests, therefore bindings use remote impls for\n  above interafces and need to talk to AppFabric\n* PreviewServiceMainTest now no longer needs to workaround the issue of\n  non-sharing local levelDB (previously it needs to shutdown AppFabric\n  before starting preview so as to have levelDB state updated by AppFabric\n  to be visible to preview in order for it to work)\n* Extend PreviewServiceMainTest with a new test case where app has plugin\n  (in order to cover plugin finder code path in preview), thus better\n  test coverage."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "00e998a3afcdd26c706edd040e5eda10576c485a", "author": {"user": {"login": "wyzhang", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/00e998a3afcdd26c706edd040e5eda10576c485a", "committedDate": "2020-04-05T22:42:55Z", "message": "fixing test breakage"}, "afterCommit": {"oid": "ecd324ff66cecd1ac351fb5f0348395852a11062", "author": {"user": {"login": "wyzhang", "name": null}}, "url": "https://github.com/cdapio/cdap/commit/ecd324ff66cecd1ac351fb5f0348395852a11062", "committedDate": "2020-04-06T05:35:46Z", "message": "(CDAP-16353) Support preview to run with non-sharing local level DB.\n\nWhy:\nAllow preview to run with its own local levelDB. This allows us to\ndeploy cdap in a dsitributed fashion without shared underlyihg\nstorage when storage impl is NOSQL.\n\nWhat:\nThis change allow preview to run with local levelDB when data storage\nis NOSQL. It achieves this by binding interface to local vs remote\nimplementation dynamically depending on storage impelementation config.\n\nThe crux of the chagne is in DefaultPreviewRunnerModule where we bind\nfollowing interafces to local impl for SQL and remote for NOSQL\n* ArtifactRepositoryReader\n* PluginFinder\n* PreferencesFetcher\n\nChanges in tests:\n* Starting AppFabric in TestBase (required by PreviewDataPipelineTest) as\n  we use NOSQL in unit tests, therefore bindings use remote impls for\n  above interafces and need to talk to AppFabric\n* PreviewServiceMainTest now no longer needs to workaround the issue of\n  non-sharing local levelDB (previously it needs to shutdown AppFabric\n  before starting preview so as to have levelDB state updated by AppFabric\n  to be visible to preview in order for it to work)\n* Extend PreviewServiceMainTest with a new test case where app has plugin\n  (in order to cover plugin finder code path in preview), thus better\n  test coverage."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1214, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}