{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY2MDY1NTk5", "number": 11825, "reviewThreads": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMjoyODo0MVrODlOeLA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQwMDo1OTozOVrODmgw_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMzYxMDA0OnYy", "diffSide": "RIGHT", "path": "cdap-ui/app/cdap/api/market.js", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMjoyODo0MVrOFx__8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxNTo1NzoxMVrOFyZT8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3MzEwNQ==", "bodyText": "Why is the function returning empty string? This should be undefined if UI is trying fetch an asset form an unknown market right.", "url": "https://github.com/cdapio/cdap/pull/11825#discussion_r387973105", "createdAt": "2020-03-04T22:28:41Z", "author": {"login": "ajainarayanan"}, "path": "cdap-ui/app/cdap/api/market.js", "diffHunk": "@@ -19,14 +19,21 @@ import { apiCreatorAbsPath } from 'services/resource-helper';\n \n let dataSrc = DataSourceConfigurer.getInstance();\n const basepath = window.CDAP_CONFIG.marketUrl;\n+const basepaths = window.CDAP_CONFIG.marketUrls;\n // FIXME (CDAP-14836): Right now this is scattered across node and client. Need to consolidate this.\n const REQUEST_TYPE_MARKET = 'MARKET';\n const requestOptions = {\n   requestOrigin: REQUEST_TYPE_MARKET,\n };\n \n+function getVerifiedMarketBaseUrl(url) {\n+  const found = basepaths.find((element) => element === decodeURIComponent(url));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40d61999d2a35da82751b8f96e10081e51bc83a1"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3MzM2OA==", "bodyText": "nit: the input is also not url. It should be host. We are checking the host of the url to talk to right.", "url": "https://github.com/cdapio/cdap/pull/11825#discussion_r387973368", "createdAt": "2020-03-04T22:29:18Z", "author": {"login": "ajainarayanan"}, "path": "cdap-ui/app/cdap/api/market.js", "diffHunk": "@@ -19,14 +19,21 @@ import { apiCreatorAbsPath } from 'services/resource-helper';\n \n let dataSrc = DataSourceConfigurer.getInstance();\n const basepath = window.CDAP_CONFIG.marketUrl;\n+const basepaths = window.CDAP_CONFIG.marketUrls;\n // FIXME (CDAP-14836): Right now this is scattered across node and client. Need to consolidate this.\n const REQUEST_TYPE_MARKET = 'MARKET';\n const requestOptions = {\n   requestOrigin: REQUEST_TYPE_MARKET,\n };\n \n+function getVerifiedMarketBaseUrl(url) {\n+  const found = basepaths.find((element) => element === decodeURIComponent(url));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3MzEwNQ=="}, "originalCommit": {"oid": "40d61999d2a35da82751b8f96e10081e51bc83a1"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM4NzgyNw==", "bodyText": "No strong opinion on using empty string. I originally use it to make the return type more predictable (string instead of string|undefined). But I can definitely switch to undefined if it is preferred.\nRename url to host sounds good to me. But just to make sure that we are on the same page, we don't restrict the market host to only has host portion of the final URL, right? Our market place host url will definitely contains path in addition to host.", "url": "https://github.com/cdapio/cdap/pull/11825#discussion_r388387827", "createdAt": "2020-03-05T15:57:11Z", "author": {"login": "Biao"}, "path": "cdap-ui/app/cdap/api/market.js", "diffHunk": "@@ -19,14 +19,21 @@ import { apiCreatorAbsPath } from 'services/resource-helper';\n \n let dataSrc = DataSourceConfigurer.getInstance();\n const basepath = window.CDAP_CONFIG.marketUrl;\n+const basepaths = window.CDAP_CONFIG.marketUrls;\n // FIXME (CDAP-14836): Right now this is scattered across node and client. Need to consolidate this.\n const REQUEST_TYPE_MARKET = 'MARKET';\n const requestOptions = {\n   requestOrigin: REQUEST_TYPE_MARKET,\n };\n \n+function getVerifiedMarketBaseUrl(url) {\n+  const found = basepaths.find((element) => element === decodeURIComponent(url));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3MzEwNQ=="}, "originalCommit": {"oid": "40d61999d2a35da82751b8f96e10081e51bc83a1"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMzYxODU4OnYy", "diffSide": "RIGHT", "path": "cdap-ui/app/cdap/api/market.js", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMjozMTo1N1rOFyAFWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxNjo1MjoyMlrOFyblyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3NDQ4OQ==", "bodyText": "There could also be a case where basepaths could be empty right? If the user doesn't provide multiple market urls the property would be empty and we need to fallback to basepath", "url": "https://github.com/cdapio/cdap/pull/11825#discussion_r387974489", "createdAt": "2020-03-04T22:31:57Z", "author": {"login": "ajainarayanan"}, "path": "cdap-ui/app/cdap/api/market.js", "diffHunk": "@@ -35,11 +42,27 @@ export const MyMarketApi = {\n     `/packages/:packageName/:version/spec.json`,\n     requestOptions\n   ),\n-  getCategoryIcon: (category) => {\n-    return `${basepath}/categories/${category}/icon.png`;\n+  getCategoryIcon: (category, marketHost) => {\n+    if (basepaths.length === 0) {\n+      return `${basepath}/categories/${category}/icon.png`;\n+    }\n+\n+    if (marketHost) {\n+      const verifiedMarketHost = getVerifiedMarketBaseUrl(marketHost);\n+      return `${verifiedMarketHost}/categories/${category}/icon.png`;\n+    }\n+    return `${basepaths[0].url}/categories/${category}/icon.png`;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40d61999d2a35da82751b8f96e10081e51bc83a1"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3NTYzNA==", "bodyText": "Also assuming the default market would be at 0 index might not be valid all the time. The user can always change the order.", "url": "https://github.com/cdapio/cdap/pull/11825#discussion_r387975634", "createdAt": "2020-03-04T22:34:36Z", "author": {"login": "ajainarayanan"}, "path": "cdap-ui/app/cdap/api/market.js", "diffHunk": "@@ -35,11 +42,27 @@ export const MyMarketApi = {\n     `/packages/:packageName/:version/spec.json`,\n     requestOptions\n   ),\n-  getCategoryIcon: (category) => {\n-    return `${basepath}/categories/${category}/icon.png`;\n+  getCategoryIcon: (category, marketHost) => {\n+    if (basepaths.length === 0) {\n+      return `${basepath}/categories/${category}/icon.png`;\n+    }\n+\n+    if (marketHost) {\n+      const verifiedMarketHost = getVerifiedMarketBaseUrl(marketHost);\n+      return `${verifiedMarketHost}/categories/${category}/icon.png`;\n+    }\n+    return `${basepaths[0].url}/categories/${category}/icon.png`;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3NDQ4OQ=="}, "originalCommit": {"oid": "40d61999d2a35da82751b8f96e10081e51bc83a1"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQyNTE2Mw==", "bodyText": "I thought we want to remove basepath once all instances migrate to the new pattern. If it is not the case, I can switch to basepath.", "url": "https://github.com/cdapio/cdap/pull/11825#discussion_r388425163", "createdAt": "2020-03-05T16:52:22Z", "author": {"login": "Biao"}, "path": "cdap-ui/app/cdap/api/market.js", "diffHunk": "@@ -35,11 +42,27 @@ export const MyMarketApi = {\n     `/packages/:packageName/:version/spec.json`,\n     requestOptions\n   ),\n-  getCategoryIcon: (category) => {\n-    return `${basepath}/categories/${category}/icon.png`;\n+  getCategoryIcon: (category, marketHost) => {\n+    if (basepaths.length === 0) {\n+      return `${basepath}/categories/${category}/icon.png`;\n+    }\n+\n+    if (marketHost) {\n+      const verifiedMarketHost = getVerifiedMarketBaseUrl(marketHost);\n+      return `${verifiedMarketHost}/categories/${category}/icon.png`;\n+    }\n+    return `${basepaths[0].url}/categories/${category}/icon.png`;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3NDQ4OQ=="}, "originalCommit": {"oid": "40d61999d2a35da82751b8f96e10081e51bc83a1"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMzYzNjE5OnYy", "diffSide": "RIGHT", "path": "cdap-ui/app/cdap/components/CaskWizards/LicenseStep/index.js", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMjozOTowMlrOFyAQmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNDowNDozOFrOF0QPdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3NzM3MQ==", "bodyText": "This might look a little unconventional, we are passing the path as main url and the host as query parameter. We can define the market host to be a url param, so that when we make a call to the Nodejs it already has the full url to talk to.\nFor instance in api/market.js we can define,\n{\n...\ngetSampleData: apiCreateorAbsPath(\n  dataSrc,\n  'GET',\n  'REQUEST',\n  ':host/packages/:entityName/:entityVersion/:filename',\n   requestOptions\n),\n...\n\nThis still makes the call to getSampleData the same, but the host is actually added and we send a valid market url.", "url": "https://github.com/cdapio/cdap/pull/11825#discussion_r387977371", "createdAt": "2020-03-04T22:39:02Z", "author": {"login": "ajainarayanan"}, "path": "cdap-ui/app/cdap/components/CaskWizards/LicenseStep/index.js", "diffHunk": "@@ -30,9 +31,11 @@ export default class LicenseStep extends Component {\n   }\n   componentWillMount() {\n     let { entityName, entityVersion, licenseFileName } = this.props;\n+    const marketHost = MarketStore.getState().selectedMarketHost;\n     let params = {\n       entityName,\n       entityVersion,\n+      marketHost,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40d61999d2a35da82751b8f96e10081e51bc83a1"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQwMTgzNQ==", "bodyText": "This might look a little unconventional, we are passing the path as main url and the host as query parameter. We can define the market host to be a url param, so that when we make a call to the Nodejs it already has the full url to talk to.\nFor instance in api/market.js we can define,\n{\n...\ngetSampleData: apiCreateorAbsPath(\n  dataSrc,\n  'GET',\n  'REQUEST',\n  ':host/packages/:entityName/:entityVersion/:filename',\n   requestOptions\n),\n...\n\nThis still makes the call to getSampleData the same, but the host is actually added and we send a valid market url.\n\nIt would mean that the full url is passed which I thought we want to avoid due to security reason? Or perhaps I understand it wrong. We are exposing the host in the query parameter anyway.\nAn alternative is passing the index of the market host? We then use the index as key to fetch the real host on nodejs side.\nPlease let me know whats your preference.", "url": "https://github.com/cdapio/cdap/pull/11825#discussion_r388401835", "createdAt": "2020-03-05T16:16:58Z", "author": {"login": "Biao"}, "path": "cdap-ui/app/cdap/components/CaskWizards/LicenseStep/index.js", "diffHunk": "@@ -30,9 +31,11 @@ export default class LicenseStep extends Component {\n   }\n   componentWillMount() {\n     let { entityName, entityVersion, licenseFileName } = this.props;\n+    const marketHost = MarketStore.getState().selectedMarketHost;\n     let params = {\n       entityName,\n       entityVersion,\n+      marketHost,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3NzM3MQ=="}, "originalCommit": {"oid": "40d61999d2a35da82751b8f96e10081e51bc83a1"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDMzNjM3NQ==", "bodyText": "Switched to use :marketHost", "url": "https://github.com/cdapio/cdap/pull/11825#discussion_r390336375", "createdAt": "2020-03-10T14:04:38Z", "author": {"login": "Biao"}, "path": "cdap-ui/app/cdap/components/CaskWizards/LicenseStep/index.js", "diffHunk": "@@ -30,9 +31,11 @@ export default class LicenseStep extends Component {\n   }\n   componentWillMount() {\n     let { entityName, entityVersion, licenseFileName } = this.props;\n+    const marketHost = MarketStore.getState().selectedMarketHost;\n     let params = {\n       entityName,\n       entityVersion,\n+      marketHost,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3NzM3MQ=="}, "originalCommit": {"oid": "40d61999d2a35da82751b8f96e10081e51bc83a1"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMzYzODg5OnYy", "diffSide": "RIGHT", "path": "cdap-ui/app/cdap/components/CaskWizards/OneStepDeploy/OneStepDeployPlugin.js", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMjo0MDoxM1rOFyASVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMjo0MDoxM1rOFyASVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3NzgxNQ==", "bodyText": "Correspondingly we will change the matketPath directly to be full url instead of passing an additional marketHost as query parameter.", "url": "https://github.com/cdapio/cdap/pull/11825#discussion_r387977815", "createdAt": "2020-03-04T22:40:13Z", "author": {"login": "ajainarayanan"}, "path": "cdap-ui/app/cdap/components/CaskWizards/OneStepDeploy/OneStepDeployPlugin.js", "diffHunk": "@@ -129,6 +133,7 @@ export default class OneStepDeployPlugin extends Component {\n         }\n \n         let fetchUrl = `/forwardMarketToCdap?source=${marketPath}&target=${cdapPath}`;\n+        fetchUrl += marketHost ? `&marketHost=${encodeURIComponent(marketHost)}` : '';", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40d61999d2a35da82751b8f96e10081e51bc83a1"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMzY0NzIzOnYy", "diffSide": "RIGHT", "path": "cdap-ui/app/cdap/components/Market/index.js", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMjo0MzoyOVrOFyAXfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxNjozMToyN1rOFyawUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3OTEzMw==", "bodyText": "nit: Remove?", "url": "https://github.com/cdapio/cdap/pull/11825#discussion_r387979133", "createdAt": "2020-03-04T22:43:29Z", "author": {"login": "ajainarayanan"}, "path": "cdap-ui/app/cdap/components/Market/index.js", "diffHunk": "@@ -49,12 +60,52 @@ export default class Market extends Component {\n       }\n     });\n \n-    MyMarketApi.list().subscribe(this.getCategories, (err) => {\n-      console.log('Error', err);\n-      MarketAction.setError();\n+    if (!enableMultipleHub()) {\n+      MyMarketApi.list().subscribe(this.getCategories, (err) => {\n+        this.handleMarketConnectionError(err);\n+      });\n+      return;\n+    }\n+\n+    this.populateMultipleMarkets();\n+  }\n+\n+  populateMultipleMarkets() {\n+    if (!enableMultipleHub()) {\n+      return;\n+    }\n+    const markets = window.CDAP_CONFIG.marketUrls;\n+\n+    // Cache all market names from market metadata.\n+    const observables = markets.map((marketHost) =>\n+      MyMarketApi.getMetaData({ marketHost }).catch(() => {\n+        // Fallback to \"Unknown\" as the market name. If the user clicks the unknown\n+        // market, a connection failure UI would most likly appear.\n+        return Observable.of({ marketName: 'Unknown' });\n+      })\n+    );\n+    Observable.forkJoin(observables).subscribe((marketMetas) => {\n+      const marketNames = marketMetas.map((marketMeta) => marketMeta.marketName);\n+      this.setState({ marketNames }, () => {\n+        const marketHost = markets[0];\n+        MyMarketApi.list({ marketHost }).subscribe(\n+          (packages) => {\n+            this.getCategories(packages, marketHost);\n+          },\n+          (err) => {\n+            this.handleMarketConnectionError(err, marketHost);\n+          }\n+        );\n+      });\n     });\n   }\n \n+  handleMarketConnectionError(e, marketHost) {\n+    console.log(e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40d61999d2a35da82751b8f96e10081e51bc83a1"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQxMTQ3Mw==", "bodyText": "sg. But just want to double confirm as it was in the original error handling code path.", "url": "https://github.com/cdapio/cdap/pull/11825#discussion_r388411473", "createdAt": "2020-03-05T16:31:27Z", "author": {"login": "Biao"}, "path": "cdap-ui/app/cdap/components/Market/index.js", "diffHunk": "@@ -49,12 +60,52 @@ export default class Market extends Component {\n       }\n     });\n \n-    MyMarketApi.list().subscribe(this.getCategories, (err) => {\n-      console.log('Error', err);\n-      MarketAction.setError();\n+    if (!enableMultipleHub()) {\n+      MyMarketApi.list().subscribe(this.getCategories, (err) => {\n+        this.handleMarketConnectionError(err);\n+      });\n+      return;\n+    }\n+\n+    this.populateMultipleMarkets();\n+  }\n+\n+  populateMultipleMarkets() {\n+    if (!enableMultipleHub()) {\n+      return;\n+    }\n+    const markets = window.CDAP_CONFIG.marketUrls;\n+\n+    // Cache all market names from market metadata.\n+    const observables = markets.map((marketHost) =>\n+      MyMarketApi.getMetaData({ marketHost }).catch(() => {\n+        // Fallback to \"Unknown\" as the market name. If the user clicks the unknown\n+        // market, a connection failure UI would most likly appear.\n+        return Observable.of({ marketName: 'Unknown' });\n+      })\n+    );\n+    Observable.forkJoin(observables).subscribe((marketMetas) => {\n+      const marketNames = marketMetas.map((marketMeta) => marketMeta.marketName);\n+      this.setState({ marketNames }, () => {\n+        const marketHost = markets[0];\n+        MyMarketApi.list({ marketHost }).subscribe(\n+          (packages) => {\n+            this.getCategories(packages, marketHost);\n+          },\n+          (err) => {\n+            this.handleMarketConnectionError(err, marketHost);\n+          }\n+        );\n+      });\n     });\n   }\n \n+  handleMarketConnectionError(e, marketHost) {\n+    console.log(e);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3OTEzMw=="}, "originalCommit": {"oid": "40d61999d2a35da82751b8f96e10081e51bc83a1"}, "originalPosition": 76}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMzY1NzY4OnYy", "diffSide": "RIGHT", "path": "cdap-ui/app/cdap/components/Market/store/market-store.js", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMjo0NzozMVrOFyAd8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxNjo0NTowM1rOFybS7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk4MDc4NQ==", "bodyText": "This should also be the window.CDAP_CONFIG.marketBaseUrl. We cannot assume the market 0 index will be the default.", "url": "https://github.com/cdapio/cdap/pull/11825#discussion_r387980785", "createdAt": "2020-03-04T22:47:31Z", "author": {"login": "ajainarayanan"}, "path": "cdap-ui/app/cdap/components/Market/store/market-store.js", "diffHunk": "@@ -21,8 +21,13 @@ import Version from 'services/VersionRange/Version';\n import VersionStore from 'services/VersionStore';\n import isNil from 'lodash/isNil';\n \n+function getDefaultMarketHost() {\n+  return window.CDAP_CONFIG.marketUrls.length > 0 ? window.CDAP_CONFIG.marketUrls[0] : '';", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40d61999d2a35da82751b8f96e10081e51bc83a1"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk4MTc2NQ==", "bodyText": "One solution would be to check if there is list of markets passed on and find the host that we host (marketBaseUrl). If there is no list then we should fallback to marketBaseUrl which will always be passed.\nThis assumes that we always set marketBaseUrl to be cdap default market.", "url": "https://github.com/cdapio/cdap/pull/11825#discussion_r387981765", "createdAt": "2020-03-04T22:50:04Z", "author": {"login": "ajainarayanan"}, "path": "cdap-ui/app/cdap/components/Market/store/market-store.js", "diffHunk": "@@ -21,8 +21,13 @@ import Version from 'services/VersionRange/Version';\n import VersionStore from 'services/VersionStore';\n import isNil from 'lodash/isNil';\n \n+function getDefaultMarketHost() {\n+  return window.CDAP_CONFIG.marketUrls.length > 0 ? window.CDAP_CONFIG.marketUrls[0] : '';", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk4MDc4NQ=="}, "originalCommit": {"oid": "40d61999d2a35da82751b8f96e10081e51bc83a1"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk4MjE1NA==", "bodyText": "This prompted, we should have a fallback to handle when user removes all market urls. We should the very least say no markets specified. We don't have to address it in this JIRA but we can come back to it later.", "url": "https://github.com/cdapio/cdap/pull/11825#discussion_r387982154", "createdAt": "2020-03-04T22:50:56Z", "author": {"login": "ajainarayanan"}, "path": "cdap-ui/app/cdap/components/Market/store/market-store.js", "diffHunk": "@@ -21,8 +21,13 @@ import Version from 'services/VersionRange/Version';\n import VersionStore from 'services/VersionStore';\n import isNil from 'lodash/isNil';\n \n+function getDefaultMarketHost() {\n+  return window.CDAP_CONFIG.marketUrls.length > 0 ? window.CDAP_CONFIG.marketUrls[0] : '';", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk4MDc4NQ=="}, "originalCommit": {"oid": "40d61999d2a35da82751b8f96e10081e51bc83a1"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQyMDMzMg==", "bodyText": "One solution would be to check if there is list of markets passed on and find the host that we host (marketBaseUrl). If there is no list then we should fallback to marketBaseUrl which will always be passed.\nThis assumes that we always set marketBaseUrl to be cdap default market.\n\nCould you give me a little bit more information on what do we want to achieve with the propose design? If a malicious user can modify marketBaseUrls, the same user can easily modify marketBaseUrl to defeat the proposed design.\nAre they trying to make their hub the first one to show up and we want the CDAP hub be the first one to show up?", "url": "https://github.com/cdapio/cdap/pull/11825#discussion_r388420332", "createdAt": "2020-03-05T16:45:03Z", "author": {"login": "Biao"}, "path": "cdap-ui/app/cdap/components/Market/store/market-store.js", "diffHunk": "@@ -21,8 +21,13 @@ import Version from 'services/VersionRange/Version';\n import VersionStore from 'services/VersionStore';\n import isNil from 'lodash/isNil';\n \n+function getDefaultMarketHost() {\n+  return window.CDAP_CONFIG.marketUrls.length > 0 ? window.CDAP_CONFIG.marketUrls[0] : '';", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk4MDc4NQ=="}, "originalCommit": {"oid": "40d61999d2a35da82751b8f96e10081e51bc83a1"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMzY3OTY4OnYy", "diffSide": "RIGHT", "path": "cdap-ui/server/url-helper.js", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMjo1NjoyMFrOFyArnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxNzowNjo1M1rOFycK6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk4NDI4NA==", "bodyText": "This should check if the sourceLink is a valid market url and return undefined.\nThe consumer (/forwardMarketToCdap) API should send a 403 response denying the request.\nAs an attacker I can construct a link like https:///forwardMarketToCdap?sourceLink=\"mymaliciousdomain.com/packages/malware\"&targetLink=\"cdap-instance\"", "url": "https://github.com/cdapio/cdap/pull/11825#discussion_r387984284", "createdAt": "2020-03-04T22:56:20Z", "author": {"login": "ajainarayanan"}, "path": "cdap-ui/server/url-helper.js", "diffHunk": "@@ -19,31 +19,63 @@\n const REQUEST_ORIGIN_ROUTER = 'ROUTER';\n const REQUEST_ORIGIN_MARKET = 'MARKET';\n \n+// return market host string from path's query parameter. empty string will be\n+// return if not found.\n+function getMarketHostParam(path) {\n+  const EXTRACT_MARKET_HOST_REGEX = /[?|&]marketHost=([^&]+).*$/;\n+  const matches = path.match(EXTRACT_MARKET_HOST_REGEX);\n+  return matches ? matches[1] : '';\n+}\n+\n+function getMarketUrls(cdapConfig) {\n+  return cdapConfig['market.base.urls'] ? cdapConfig['market.base.urls'].split('+') : [];\n+}\n+\n+function getVerifiedMarketHost(cdapConfig, urlOrPath) {\n+    if (!cdapConfig['market.base.urls']) {\n+      return `${cdapConfig['market.base.url']}`;\n+    }\n+\n+    const marketHost = getMarketHostParam(urlOrPath);\n+    const found = getMarketUrls(cdapConfig).find(element => element === decodeURIComponent(marketHost));\n+    return found ? found : '';", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40d61999d2a35da82751b8f96e10081e51bc83a1"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQzNDY2Nw==", "bodyText": "I am not entirely sure I understand this comment. Currently the sourceLink doesn't contain a host, it gets the host from marketHost parameter which should be validated by line 40.\nIf you are referring to switch to fullpath for all request, I think we just need to change line 40 to something like this:\nreturn getMarketUrls(cdapConfig).find(e => urlOrPath.startsWith(e));\nPlease let me know IIUC. I might have missed something obvious.", "url": "https://github.com/cdapio/cdap/pull/11825#discussion_r388434667", "createdAt": "2020-03-05T17:06:53Z", "author": {"login": "Biao"}, "path": "cdap-ui/server/url-helper.js", "diffHunk": "@@ -19,31 +19,63 @@\n const REQUEST_ORIGIN_ROUTER = 'ROUTER';\n const REQUEST_ORIGIN_MARKET = 'MARKET';\n \n+// return market host string from path's query parameter. empty string will be\n+// return if not found.\n+function getMarketHostParam(path) {\n+  const EXTRACT_MARKET_HOST_REGEX = /[?|&]marketHost=([^&]+).*$/;\n+  const matches = path.match(EXTRACT_MARKET_HOST_REGEX);\n+  return matches ? matches[1] : '';\n+}\n+\n+function getMarketUrls(cdapConfig) {\n+  return cdapConfig['market.base.urls'] ? cdapConfig['market.base.urls'].split('+') : [];\n+}\n+\n+function getVerifiedMarketHost(cdapConfig, urlOrPath) {\n+    if (!cdapConfig['market.base.urls']) {\n+      return `${cdapConfig['market.base.url']}`;\n+    }\n+\n+    const marketHost = getMarketHostParam(urlOrPath);\n+    const found = getMarketUrls(cdapConfig).find(element => element === decodeURIComponent(marketHost));\n+    return found ? found : '';", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk4NDI4NA=="}, "originalCommit": {"oid": "40d61999d2a35da82751b8f96e10081e51bc83a1"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxNzA2MDUzOnYy", "diffSide": "RIGHT", "path": "cdap-ui/app/cdap/components/Market/index.js", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQwMDo0MDo0N1rOFz95Tg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNDowNTozMVrOF0QRrA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAzNTc5MA==", "bodyText": "Can we fallback to the domain name? If there are too many markets without a /metadata api then it becomes hard to track which is a specific market user is looking for.", "url": "https://github.com/cdapio/cdap/pull/11825#discussion_r390035790", "createdAt": "2020-03-10T00:40:47Z", "author": {"login": "ajainarayanan"}, "path": "cdap-ui/app/cdap/components/Market/index.js", "diffHunk": "@@ -49,12 +56,52 @@ export default class Market extends Component {\n       }\n     });\n \n-    MyMarketApi.list().subscribe(this.getCategories, (err) => {\n-      console.log('Error', err);\n-      MarketAction.setError();\n+    if (hasMultipleMarkets()) {\n+      this.populateMarketNames();\n+      return;\n+    }\n+\n+    this.populateMarketPackages(window.CDAP_CONFIG.marketUrls[0]);\n+  }\n+\n+  populateMarketPackages(marketHost) {\n+    MyMarketApi.list({ marketHost }).subscribe(\n+      (packages) => {\n+        this.getCategories(packages, marketHost);\n+      },\n+      () => {\n+        this.handleMarketConnectionError(marketHost);\n+      }\n+    );\n+  }\n+\n+  populateMarketNames() {\n+    if (!hasMultipleMarkets()) {\n+      return;\n+    }\n+    const markets = window.CDAP_CONFIG.marketUrls;\n+\n+    // Cache all market names from market metadata.\n+    const observables = markets.map((marketHost) =>\n+      MyMarketApi.getMetaData({ marketHost }).catch(() => {\n+        // Fallback to \"Unknown\" as the market name. If the user clicks the unknown\n+        // market, a connection failure UI would most likly appear.\n+        return Observable.of({ marketName: 'Unknown' });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4502dc1e990f1657fb18bb2fb9b2df41db47e06c"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDMzNjk0MA==", "bodyText": "Discussed yesterday. I have switched to use market base url for now. let me know if it is acceptable as a short term solution.", "url": "https://github.com/cdapio/cdap/pull/11825#discussion_r390336940", "createdAt": "2020-03-10T14:05:31Z", "author": {"login": "Biao"}, "path": "cdap-ui/app/cdap/components/Market/index.js", "diffHunk": "@@ -49,12 +56,52 @@ export default class Market extends Component {\n       }\n     });\n \n-    MyMarketApi.list().subscribe(this.getCategories, (err) => {\n-      console.log('Error', err);\n-      MarketAction.setError();\n+    if (hasMultipleMarkets()) {\n+      this.populateMarketNames();\n+      return;\n+    }\n+\n+    this.populateMarketPackages(window.CDAP_CONFIG.marketUrls[0]);\n+  }\n+\n+  populateMarketPackages(marketHost) {\n+    MyMarketApi.list({ marketHost }).subscribe(\n+      (packages) => {\n+        this.getCategories(packages, marketHost);\n+      },\n+      () => {\n+        this.handleMarketConnectionError(marketHost);\n+      }\n+    );\n+  }\n+\n+  populateMarketNames() {\n+    if (!hasMultipleMarkets()) {\n+      return;\n+    }\n+    const markets = window.CDAP_CONFIG.marketUrls;\n+\n+    // Cache all market names from market metadata.\n+    const observables = markets.map((marketHost) =>\n+      MyMarketApi.getMetaData({ marketHost }).catch(() => {\n+        // Fallback to \"Unknown\" as the market name. If the user clicks the unknown\n+        // market, a connection failure UI would most likly appear.\n+        return Observable.of({ marketName: 'Unknown' });", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAzNTc5MA=="}, "originalCommit": {"oid": "4502dc1e990f1657fb18bb2fb9b2df41db47e06c"}, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxNzA4MjQ3OnYy", "diffSide": "RIGHT", "path": "cdap-ui/server/url-helper.js", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQwMDo1MzoxNVrOFz-GDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQwMjo1ODozMFrOFz_8rQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAzOTA1Mg==", "bodyText": "nit: Would we have to verify the host here? Shouldn't this be already done on any market url we get before constructing the url? If we return invalid-market-url I believe express server will still make the call right?", "url": "https://github.com/cdapio/cdap/pull/11825#discussion_r390039052", "createdAt": "2020-03-10T00:53:15Z", "author": {"login": "ajainarayanan"}, "path": "cdap-ui/server/url-helper.js", "diffHunk": "@@ -14,28 +14,57 @@\n  * the License.\n */\n \n+import memoize from 'lodash/memoize';\n+\n export const REQUEST_ORIGIN_ROUTER = 'ROUTER';\n export const REQUEST_ORIGIN_MARKET = 'MARKET';\n \n+function getRouterHost(cdapConfig) {\n+  const routerhost = cdapConfig['router.server.address'],\n+    routerport =\n+      cdapConfig['ssl.external.enabled'] === 'true'\n+        ? cdapConfig['router.ssl.server.port']\n+        : cdapConfig['router.server.port'],\n+    routerprotocol = cdapConfig['ssl.external.enabled'] === 'true' ? 'https' : 'http';\n+  return `${routerprotocol}://${routerhost}:${routerport}`;\n+}\n+\n+function extractMarketUrls(cdapConfig) {\n+  if (!cdapConfig) {\n+    return [];\n+  }\n+  const defaultMarketUrl = cdapConfig['market.base.url'];\n+  if (!cdapConfig['market.base.urls']) {\n+    return [defaultMarketUrl];\n+  }\n+  const marketUrls = cdapConfig['market.base.urls'].split('+');\n+  const filteredMarketUrls = marketUrls.filter(element => element !== defaultMarketUrl); \n+  // Make sure the default CDAP market is the first market.\n+  filteredMarketUrls.splice(0, 0, defaultMarketUrl);\n+  return filteredMarketUrls;\n+}\n+\n+export const getMarketUrls = memoize(extractMarketUrls);\n+\n+export function isVerifiedMarketHost(cdapConfig, url) {\n+  return !!getMarketUrls(cdapConfig).find(element => url.startsWith(element));\n+}\n+\n export function constructUrl(cdapConfig, path, origin = REQUEST_ORIGIN_ROUTER) {\n   if (!cdapConfig) {\n     return null;\n   }\n   path = path && path[0] === '/' ? path.slice(1) : path;\n   if (origin === REQUEST_ORIGIN_MARKET) {\n-    return `${cdapConfig['market.base.url']}/${path}`;\n+    return isVerifiedMarketHost(cdapConfig, path) ? path : 'invalid-market-url';", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4502dc1e990f1657fb18bb2fb9b2df41db47e06c"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA2OTQyMQ==", "bodyText": "You are right, it is not necessary. I was just adding another layer of safe net. I have removed it to be less confusing.", "url": "https://github.com/cdapio/cdap/pull/11825#discussion_r390069421", "createdAt": "2020-03-10T02:58:30Z", "author": {"login": "Biao"}, "path": "cdap-ui/server/url-helper.js", "diffHunk": "@@ -14,28 +14,57 @@\n  * the License.\n */\n \n+import memoize from 'lodash/memoize';\n+\n export const REQUEST_ORIGIN_ROUTER = 'ROUTER';\n export const REQUEST_ORIGIN_MARKET = 'MARKET';\n \n+function getRouterHost(cdapConfig) {\n+  const routerhost = cdapConfig['router.server.address'],\n+    routerport =\n+      cdapConfig['ssl.external.enabled'] === 'true'\n+        ? cdapConfig['router.ssl.server.port']\n+        : cdapConfig['router.server.port'],\n+    routerprotocol = cdapConfig['ssl.external.enabled'] === 'true' ? 'https' : 'http';\n+  return `${routerprotocol}://${routerhost}:${routerport}`;\n+}\n+\n+function extractMarketUrls(cdapConfig) {\n+  if (!cdapConfig) {\n+    return [];\n+  }\n+  const defaultMarketUrl = cdapConfig['market.base.url'];\n+  if (!cdapConfig['market.base.urls']) {\n+    return [defaultMarketUrl];\n+  }\n+  const marketUrls = cdapConfig['market.base.urls'].split('+');\n+  const filteredMarketUrls = marketUrls.filter(element => element !== defaultMarketUrl); \n+  // Make sure the default CDAP market is the first market.\n+  filteredMarketUrls.splice(0, 0, defaultMarketUrl);\n+  return filteredMarketUrls;\n+}\n+\n+export const getMarketUrls = memoize(extractMarketUrls);\n+\n+export function isVerifiedMarketHost(cdapConfig, url) {\n+  return !!getMarketUrls(cdapConfig).find(element => url.startsWith(element));\n+}\n+\n export function constructUrl(cdapConfig, path, origin = REQUEST_ORIGIN_ROUTER) {\n   if (!cdapConfig) {\n     return null;\n   }\n   path = path && path[0] === '/' ? path.slice(1) : path;\n   if (origin === REQUEST_ORIGIN_MARKET) {\n-    return `${cdapConfig['market.base.url']}/${path}`;\n+    return isVerifiedMarketHost(cdapConfig, path) ? path : 'invalid-market-url';", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAzOTA1Mg=="}, "originalCommit": {"oid": "4502dc1e990f1657fb18bb2fb9b2df41db47e06c"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxNzA5MzA5OnYy", "diffSide": "RIGHT", "path": "cdap-ui/app/cdap/services/resource-helper/index.js", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQwMDo1OTozOVrOFz-McQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQwMjo1ODo1M1rOFz_9Kw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA0MDY4OQ==", "bodyText": "nit: We can remove these I think", "url": "https://github.com/cdapio/cdap/pull/11825#discussion_r390040689", "createdAt": "2020-03-10T00:59:39Z", "author": {"login": "ajainarayanan"}, "path": "cdap-ui/app/cdap/services/resource-helper/index.js", "diffHunk": "@@ -54,6 +54,8 @@ function createApiFromExactPath(dataSrc, method, type, path, options = {}) {\n   return (params = {}, body, headers) => {\n     let url = buildUrl(path, params);\n \n+    console.log(`createApi path = ${path}`);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4502dc1e990f1657fb18bb2fb9b2df41db47e06c"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA2OTU0Nw==", "bodyText": "done", "url": "https://github.com/cdapio/cdap/pull/11825#discussion_r390069547", "createdAt": "2020-03-10T02:58:53Z", "author": {"login": "Biao"}, "path": "cdap-ui/app/cdap/services/resource-helper/index.js", "diffHunk": "@@ -54,6 +54,8 @@ function createApiFromExactPath(dataSrc, method, type, path, options = {}) {\n   return (params = {}, body, headers) => {\n     let url = buildUrl(path, params);\n \n+    console.log(`createApi path = ${path}`);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA0MDY4OQ=="}, "originalCommit": {"oid": "4502dc1e990f1657fb18bb2fb9b2df41db47e06c"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3029, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}