{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcwNDcxODU5", "number": 6054, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxNDozMjozNlrOEaj_bg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxNzoxMToyNlrOEaoWSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk2Mjg4MTEwOnYy", "diffSide": "RIGHT", "path": "ksqldb-serde/src/main/java/io/confluent/ksql/serde/protobuf/ProtobufFormat.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxNDozMjozNlrOHEEdgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQyMzozNzoxMFrOHEWsvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAyOTQ0MA==", "bodyText": "How come ProtobufFormat has WRAP_SINGLES in its set of supported features, but the Kafka and delimited formats have the empty supported feature sets? Seems inconsistent in that I'd expect Kafka and delimited to have UNWRAP_SINGLES in their supported feature sets to parallel this.", "url": "https://github.com/confluentinc/ksql/pull/6054#discussion_r474029440", "createdAt": "2020-08-20T14:32:36Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-serde/src/main/java/io/confluent/ksql/serde/protobuf/ProtobufFormat.java", "diffHunk": "@@ -16,17 +16,24 @@\n package io.confluent.ksql.serde.protobuf;\n \n import com.google.common.collect.ImmutableMap;\n+import com.google.common.collect.ImmutableSet;\n import io.confluent.connect.protobuf.ProtobufData;\n import io.confluent.connect.protobuf.ProtobufDataConfig;\n import io.confluent.kafka.schemaregistry.ParsedSchema;\n import io.confluent.kafka.schemaregistry.protobuf.ProtobufSchema;\n import io.confluent.ksql.serde.FormatInfo;\n import io.confluent.ksql.serde.KsqlSerdeFactory;\n+import io.confluent.ksql.serde.SerdeFeature;\n import io.confluent.ksql.serde.connect.ConnectFormat;\n+import java.util.Set;\n import org.apache.kafka.connect.data.Schema;\n \n public class ProtobufFormat extends ConnectFormat {\n \n+  private static final Set<SerdeFeature> SUPPORTED_FEATURES = ImmutableSet.of(\n+      SerdeFeature.WRAP_SINGLES", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9080ec8549ac352e1242f9a31164e1cad83ecc97"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMyODI1NQ==", "bodyText": "The next PR will add UNWRAP_SINGLES for KAFKA and DELIMITED, it's just not possible right now due to some other issues that are best kept to their own PR.", "url": "https://github.com/confluentinc/ksql/pull/6054#discussion_r474328255", "createdAt": "2020-08-20T23:37:10Z", "author": {"login": "big-andy-coates"}, "path": "ksqldb-serde/src/main/java/io/confluent/ksql/serde/protobuf/ProtobufFormat.java", "diffHunk": "@@ -16,17 +16,24 @@\n package io.confluent.ksql.serde.protobuf;\n \n import com.google.common.collect.ImmutableMap;\n+import com.google.common.collect.ImmutableSet;\n import io.confluent.connect.protobuf.ProtobufData;\n import io.confluent.connect.protobuf.ProtobufDataConfig;\n import io.confluent.kafka.schemaregistry.ParsedSchema;\n import io.confluent.kafka.schemaregistry.protobuf.ProtobufSchema;\n import io.confluent.ksql.serde.FormatInfo;\n import io.confluent.ksql.serde.KsqlSerdeFactory;\n+import io.confluent.ksql.serde.SerdeFeature;\n import io.confluent.ksql.serde.connect.ConnectFormat;\n+import java.util.Set;\n import org.apache.kafka.connect.data.Schema;\n \n public class ProtobufFormat extends ConnectFormat {\n \n+  private static final Set<SerdeFeature> SUPPORTED_FEATURES = ImmutableSet.of(\n+      SerdeFeature.WRAP_SINGLES", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAyOTQ0MA=="}, "originalCommit": {"oid": "9080ec8549ac352e1242f9a31164e1cad83ecc97"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk2Mjg5MTM3OnYy", "diffSide": "RIGHT", "path": "docs/operate-and-deploy/installation/server-config/config-reference.md", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxNDozNDo0OVrOHEEj-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQyMzozOToxMFrOHEWu6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAzMTA5Nw==", "bodyText": "It doesn't look like the docs specify what the default value for each format is.\nAlso, where is the default added in the code right now? Is it hard-coded to be wrapped (if SerdeOptions is empty) somewhere in the planner?", "url": "https://github.com/confluentinc/ksql/pull/6054#discussion_r474031097", "createdAt": "2020-08-20T14:34:49Z", "author": {"login": "vcrfxia"}, "path": "docs/operate-and-deploy/installation/server-config/config-reference.md", "diffHunk": "@@ -320,10 +321,10 @@ For more information, refer to the\n [CREATE STREAM AS SELECT](../../../developer-guide/ksqldb-reference/create-stream-as-select.md)\n statements.\n \n-!!! note\n-\t The `DELIMITED` format is not affected by the\n-    `ksql.persistence.ensure.value.is.struct` setting, because it has no\n-    concept of an outer record or structure.\n+ !!! note\n+   Not all formats support wrapping and unwrapping. If you use a format that does not support\n+   the default value you set, the format will ignore the setting. For information on which formats", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9080ec8549ac352e1242f9a31164e1cad83ecc97"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMyODgwOA==", "bodyText": "It doesn't look like the docs specify what the default value for each format is.\n\nYep, that's on my todo list - next PR!\n\nAlso, where is the default added in the code right now? Is it hard-coded to be wrapped (if SerdeOptions is empty) somewhere in the planner?\n\nIf the user doesn't supply the option then nothing is stored in the plan.  Currently, this defaults to wrapped, (code in GenericRowSerde and GenericKeySerde), but the next PR will change this, so that the format sets the default.", "url": "https://github.com/confluentinc/ksql/pull/6054#discussion_r474328808", "createdAt": "2020-08-20T23:39:10Z", "author": {"login": "big-andy-coates"}, "path": "docs/operate-and-deploy/installation/server-config/config-reference.md", "diffHunk": "@@ -320,10 +321,10 @@ For more information, refer to the\n [CREATE STREAM AS SELECT](../../../developer-guide/ksqldb-reference/create-stream-as-select.md)\n statements.\n \n-!!! note\n-\t The `DELIMITED` format is not affected by the\n-    `ksql.persistence.ensure.value.is.struct` setting, because it has no\n-    concept of an outer record or structure.\n+ !!! note\n+   Not all formats support wrapping and unwrapping. If you use a format that does not support\n+   the default value you set, the format will ignore the setting. For information on which formats", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAzMTA5Nw=="}, "originalCommit": {"oid": "9080ec8549ac352e1242f9a31164e1cad83ecc97"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk2Mjg5OTAwOnYy", "diffSide": "RIGHT", "path": "ksqldb-common/src/main/java/io/confluent/ksql/serde/SerdeOption.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxNDozNjozMlrOHEEoug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQwMDozODowM1rOHEXugw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAzMjMxNA==", "bodyText": "The mapping between SerdeOption and SerdeFeature always be 1-to-1, right? What's the purpose of having SerdeOption wrap SerdeFeature?", "url": "https://github.com/confluentinc/ksql/pull/6054#discussion_r474032314", "createdAt": "2020-08-20T14:36:32Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-common/src/main/java/io/confluent/ksql/serde/SerdeOption.java", "diffHunk": "@@ -16,29 +16,42 @@\n package io.confluent.ksql.serde;\n \n import com.fasterxml.jackson.annotation.JsonCreator;\n-import com.google.common.collect.ImmutableSet;\n-import java.util.Set;\n+import java.util.Objects;\n \n public enum SerdeOption {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9080ec8549ac352e1242f9a31164e1cad83ecc97"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMzMDg1Mg==", "bodyText": "My bad, I didn't really explain the intent here!\nThe PR was raised because the current system, where we only have UNWRAP_SINGLE_VALUES as a SerdeOption, isn't enough to express having some formats that don't support wrapping, e.g. KAFKA, some that only support wrapping, e.g. PROTOBUF, and some that support both.  Hence adding the WRAP_SINGLE_VALUES to the enum.\nThe use of SerdeFeature will become apparent in the next PR.  SerdeFeatures will be passed to the Serde along with the schema so that they can do what's needed.\n\nThe mapping between SerdeOption and SerdeFeature always be 1-to-1, right?\n\nNo, when we add WRAP_SINGLE_KEY and UNWRAP_SINGLE_KEY they'll also use SerdeFeature.WRAP_SINGLES and SerdeFeature.UNWRAP_SINGLES.  (This is needed for KLIP-33, which is why I'm working on it).\nOnce this is done, we'll have SerdeOptions, which sets at a topic schema level what options are on and which is serialized as part of the query plan, and SerdeFeatures which control the same at the key/value level and are passed to serde instances.\nIn the future it may be possible to do away with SerdeOption in favour of just using SerdeFeatures tracked at the key and value level, but that's a bigger change, and isn't trivial, as it's ingrained in the plan and in the code.\nHope that helps explain the why of this PR.", "url": "https://github.com/confluentinc/ksql/pull/6054#discussion_r474330852", "createdAt": "2020-08-20T23:46:17Z", "author": {"login": "big-andy-coates"}, "path": "ksqldb-common/src/main/java/io/confluent/ksql/serde/SerdeOption.java", "diffHunk": "@@ -16,29 +16,42 @@\n package io.confluent.ksql.serde;\n \n import com.fasterxml.jackson.annotation.JsonCreator;\n-import com.google.common.collect.ImmutableSet;\n-import java.util.Set;\n+import java.util.Objects;\n \n public enum SerdeOption {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAzMjMxNA=="}, "originalCommit": {"oid": "9080ec8549ac352e1242f9a31164e1cad83ecc97"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM0NTA5MQ==", "bodyText": "Super helpful. Thanks, Andy!", "url": "https://github.com/confluentinc/ksql/pull/6054#discussion_r474345091", "createdAt": "2020-08-21T00:38:03Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-common/src/main/java/io/confluent/ksql/serde/SerdeOption.java", "diffHunk": "@@ -16,29 +16,42 @@\n package io.confluent.ksql.serde;\n \n import com.fasterxml.jackson.annotation.JsonCreator;\n-import com.google.common.collect.ImmutableSet;\n-import java.util.Set;\n+import java.util.Objects;\n \n public enum SerdeOption {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAzMjMxNA=="}, "originalCommit": {"oid": "9080ec8549ac352e1242f9a31164e1cad83ecc97"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk2MzU4OTI4OnYy", "diffSide": "RIGHT", "path": "docs/operate-and-deploy/installation/server-config/config-reference.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxNzowOTo0M1rOHELe-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxNzowOTo0M1rOHELe-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE0NDUwNw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            When set to the `true` ksqlDB serializes the column value nested within a JSON object, Avro record,\n          \n          \n            \n            When set to `true`, ksqlDB serializes the column value nested within a JSON object, Avro record,", "url": "https://github.com/confluentinc/ksql/pull/6054#discussion_r474144507", "createdAt": "2020-08-20T17:09:43Z", "author": {"login": "JimGalasyn"}, "path": "docs/operate-and-deploy/installation/server-config/config-reference.md", "diffHunk": "@@ -274,10 +274,12 @@ not supplied explicitly in [CREATE TABLE](../../../developer-guide/ksqldb-refere\n [CREATE STREAM AS SELECT](../../../developer-guide/ksqldb-reference/create-stream-as-select.md)\n statements.\n \n-When set to the default value, `true`, ksqlDB serializes the column value\n-nested with a JSON object, Avro record, or Protobuf message, depending on the\n-format in use. When set to `false`, ksqlDB persists the column value without any\n-nesting.\n+If not set and no explicit value is provided in the statement, the value format's default wrapping \n+is used.\n+\n+When set to the `true` ksqlDB serializes the column value nested within a JSON object, Avro record,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9080ec8549ac352e1242f9a31164e1cad83ecc97"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk2MzU5MzQ4OnYy", "diffSide": "RIGHT", "path": "docs/operate-and-deploy/installation/server-config/config-reference.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxNzoxMDo1OFrOHELhqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxNzoxMDo1OFrOHELhqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE0NTE5Mg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               Not all formats support wrapping and unwrapping. If you use a format that does not support\n          \n          \n            \n               Not all formats support wrapping and unwrapping. If you use a format that doesn't support", "url": "https://github.com/confluentinc/ksql/pull/6054#discussion_r474145192", "createdAt": "2020-08-20T17:10:58Z", "author": {"login": "JimGalasyn"}, "path": "docs/operate-and-deploy/installation/server-config/config-reference.md", "diffHunk": "@@ -320,10 +321,10 @@ For more information, refer to the\n [CREATE STREAM AS SELECT](../../../developer-guide/ksqldb-reference/create-stream-as-select.md)\n statements.\n \n-!!! note\n-\t The `DELIMITED` format is not affected by the\n-    `ksql.persistence.ensure.value.is.struct` setting, because it has no\n-    concept of an outer record or structure.\n+ !!! note\n+   Not all formats support wrapping and unwrapping. If you use a format that does not support", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9080ec8549ac352e1242f9a31164e1cad83ecc97"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk2MzU5NDk2OnYy", "diffSide": "RIGHT", "path": "docs/operate-and-deploy/installation/server-config/config-reference.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxNzoxMToyNlrOHELimQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxNzoxMToyNlrOHELimQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE0NTQzMw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               the default value you set, the format will ignore the setting. For information on which formats\n          \n          \n            \n               the default value you set, the format ignores the setting. For information on which formats", "url": "https://github.com/confluentinc/ksql/pull/6054#discussion_r474145433", "createdAt": "2020-08-20T17:11:26Z", "author": {"login": "JimGalasyn"}, "path": "docs/operate-and-deploy/installation/server-config/config-reference.md", "diffHunk": "@@ -320,10 +321,10 @@ For more information, refer to the\n [CREATE STREAM AS SELECT](../../../developer-guide/ksqldb-reference/create-stream-as-select.md)\n statements.\n \n-!!! note\n-\t The `DELIMITED` format is not affected by the\n-    `ksql.persistence.ensure.value.is.struct` setting, because it has no\n-    concept of an outer record or structure.\n+ !!! note\n+   Not all formats support wrapping and unwrapping. If you use a format that does not support\n+   the default value you set, the format will ignore the setting. For information on which formats", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9080ec8549ac352e1242f9a31164e1cad83ecc97"}, "originalPosition": 37}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2914, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}