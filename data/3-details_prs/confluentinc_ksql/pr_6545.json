{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEyNTI2NDk0", "number": 6545, "title": "feat: add constraint to deny drop sources referenced by other CREATE_AS sources", "bodyText": "Description\nThis is partial implementation of feat: terminate persistent query on DROP command\nThe first commit of this PR was already reviewed in the above PR (#6143). This PR only adds extra work to:\n\nReturn DROP source constraints from DESCRIBE EXTENDED\nDrop sources in order for Rest QTT cleanup methods\n\nThe change for this PR adds a constraint to a source to not delete it if it is referenced by another source. For instance:\nksql> create stream t1(id int) with (kafka_topic='t1');\nksql> create stream s1 as select * from t1;\nksql> terminate CSAS_S1_9;\n\nksql> drop stream t1;\nCannot drop T1.\nThe following streams and/or tables read from this source: [S1].\nYou need to drop them before dropping T1.\n\nksql> describe extended t1;\n...\nSources that have a DROP constraint on this source\n--------------------------------------------------\nS1\n...\n\nEven if queries are terminated, the stream or table cannot be deleted until all sources that reference to it are deleted. This is a common approach in other DBs, which could keep constraints and references on tables thus avoiding deleting them leaving tables with an invalid link.\nThis feature was asked by #6143. The main reason of splitting the PR is for easy review the rest of the commits.\nCommit #1 is already reviewed and approved. If you want you can review again, but you can opt-out, and review only Commit #2 and Commit #3, which add the list to the DESCRIBE EXTENDED and fixes the RQTT tests. The rest of the commits are just fixing a couple of tests.\nTesting done\nDescribe the testing strategy. Unit and integration tests are expected for any behavior changes.\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-10-29T19:51:49Z", "url": "https://github.com/confluentinc/ksql/pull/6545", "merged": true, "mergeCommit": {"oid": "28835a42e99340d05a078a73abc84de5aa0a4f21"}, "closed": true, "closedAt": "2020-11-05T17:59:17Z", "author": {"login": "spena"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXTZhbAH2gAyNTEyNTI2NDk0OjJkNTRhYjNhMGRhYjBmMTk1OWY4YmNmNzY1ZmFjN2I1NjRjMzNjZDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZUwukAH2gAyNTEyNTI2NDk0OjRkYjQ5ZTBkYmU2M2ZmNTc5NTkxNTMyZTc0NDk0NThmM2MxNzVjZjg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2d54ab3a0dab0f1959f8bcf765fac7b564c33cd8", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/2d54ab3a0dab0f1959f8bcf765fac7b564c33cd8", "committedDate": "2020-10-29T14:53:34Z", "message": "feat: add constraint to no drop sources referenced by other CREATE_AS sources"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66be896727054b0e22c0e98c0dcadb8acbc95fc5", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/66be896727054b0e22c0e98c0dcadb8acbc95fc5", "committedDate": "2020-10-29T16:34:37Z", "message": "feat: return DROP source constraints from DESCRIBE EXTENDED"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3d67f2f7829b5cc8926c5d8cdc94db58385daa0", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/a3d67f2f7829b5cc8926c5d8cdc94db58385daa0", "committedDate": "2020-10-29T19:19:08Z", "message": "chore: drop sources in order for Rest QTT cleanup methods"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1fc508f810b63c847ef21b4a9dc3146b8e00a040", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/1fc508f810b63c847ef21b4a9dc3146b8e00a040", "committedDate": "2020-10-29T19:34:15Z", "message": "chore: fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ca7780d3246ecc966d135b993bf46414f86dfe9", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/1ca7780d3246ecc966d135b993bf46414f86dfe9", "committedDate": "2020-10-29T20:40:57Z", "message": "chore: add sourceConstraints() to API client"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyOTEyNzU2", "url": "https://github.com/confluentinc/ksql/pull/6545#pullrequestreview-522912756", "createdAt": "2020-11-03T22:13:25Z", "commit": {"oid": "66be896727054b0e22c0e98c0dcadb8acbc95fc5"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QyMjoxMzoyNVrOHtCVgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QyMjoyNDo1OFrOHtCpKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk4NjI0MA==", "bodyText": "what happens if we get old response with new CLI and vice versa?", "url": "https://github.com/confluentinc/ksql/pull/6545#discussion_r516986240", "createdAt": "2020-11-03T22:13:25Z", "author": {"login": "agavra"}, "path": "ksqldb-rest-model/src/main/java/io/confluent/ksql/rest/entity/SourceDescription.java", "diffHunk": "@@ -68,7 +69,9 @@ public SourceDescription(\n       @JsonProperty(\"partitions\") final int partitions,\n       @JsonProperty(\"replication\") final int replication,\n       @JsonProperty(\"statement\") final String statement,\n-      @JsonProperty(\"queryOffsetSummaries\") final List<QueryOffsetSummary> queryOffsetSummaries) {\n+      @JsonProperty(\"queryOffsetSummaries\") final List<QueryOffsetSummary> queryOffsetSummaries,\n+      @JsonProperty(\"sourceConstraints\") final List<String> sourceConstraints", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66be896727054b0e22c0e98c0dcadb8acbc95fc5"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk5MTI3Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * Returns a list of sources that have a DROP constraint reference on this source. This DROP\n          \n          \n            \n               * constraint does not allow to delete this source after all referenced sources are deleted.\n          \n          \n            \n               * Returns a list of sources that have a DROP constraint reference on this source. This source\n          \n          \n            \n               * cannot be dropped until all sources returned by this method are deleted.", "url": "https://github.com/confluentinc/ksql/pull/6545#discussion_r516991273", "createdAt": "2020-11-03T22:24:58Z", "author": {"login": "agavra"}, "path": "ksqldb-api-client/src/main/java/io/confluent/ksql/api/client/SourceDescription.java", "diffHunk": "@@ -85,4 +85,11 @@\n    */\n   String sqlStatement();\n \n+  /**\n+   * Returns a list of sources that have a DROP constraint reference on this source. This DROP\n+   * constraint does not allow to delete this source after all referenced sources are deleted.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ca7780d3246ecc966d135b993bf46414f86dfe9"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22290faba89a2a6ea23ae25065974d864cde7925", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/22290faba89a2a6ea23ae25065974d864cde7925", "committedDate": "2020-11-04T20:27:16Z", "message": "Update comment in SourceDescription\n\nCo-authored-by: Almog Gavra <almog@confluent.io>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4db49e0dbe63ff579591532e7449458f3c175cf8", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/4db49e0dbe63ff579591532e7449458f3c175cf8", "committedDate": "2020-11-04T21:36:40Z", "message": "chore: add recover test to verify DROP will work from an upgrade"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4597, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}