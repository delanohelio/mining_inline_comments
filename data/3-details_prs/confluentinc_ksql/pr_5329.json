{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE1ODUyOTQx", "number": 5329, "title": "test(client): additional test coverage for push+pull query support", "bodyText": "Description\nThis PR is stacked on #5327 -- only the new commits should be reviewed.\nThis PR adds some additional test coverage for the Java client. The four new commits, in order:\n\nAdd tests for TLS mutual auth. Cleans up existing TLS test to avoid use of trustAll.\nAdd tests for StreamedQueryResult#isComplete() and fixes a bug to get the tests passing\nAdd tests for streamQuery() on a push query with limit clause\nAdd integration test equivalent of the unit tests in StreamedQueryResultImplTest, based on #5200 (comment)\n\nMore test coverage coming in a future PR.\nTesting done\nTests pass.\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-05-11T04:02:31Z", "url": "https://github.com/confluentinc/ksql/pull/5329", "merged": true, "mergeCommit": {"oid": "16f096b8788d1e973f92fc7c552701f1029e5d95"}, "closed": true, "closedAt": "2020-05-12T19:33:40Z", "author": {"login": "vcrfxia"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcftdLcAH2gAyNDE1ODUyOTQxOmI4ZmEwNzc2YWI1MDNkMDU4Y2JmNTZiNWRhOTQ5NjZjNjRlM2E3Yzg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcgYIaRAH2gAyNDE1ODUyOTQxOmNiYzQ5OGFkNzhkZTAwMjQzNjMzMmVjZGRiOTY2NGQ4YjhlOWU5NWM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b8fa0776ab503d058cbf56b5da94966c64e3a7c8", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/b8fa0776ab503d058cbf56b5da94966c64e3a7c8", "committedDate": "2020-05-09T21:35:20Z", "message": "chore: introduce ColumnType"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ecd2bb834dc04566f8a8ecfd4b6708657eadd7ef", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/ecd2bb834dc04566f8a8ecfd4b6708657eadd7ef", "committedDate": "2020-05-09T21:35:21Z", "message": "chore: introduce KsqlObject and KsqlArray"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99ab24956b5f229e25d2c95923fbf4d6d0c28bf6", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/99ab24956b5f229e25d2c95923fbf4d6d0c28bf6", "committedDate": "2020-05-09T21:35:43Z", "message": "refactor: rename Row#getObject() to Row#getValue()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4ed9555661fb350d9ddce43cdd3974b5a7202db", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/d4ed9555661fb350d9ddce43cdd3974b5a7202db", "committedDate": "2020-05-09T21:49:11Z", "message": "refactor: rename QueryResult to StreamedQueryResult"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0331e3c56ad856cd3c0e7e3f47c8576c59758a9", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/c0331e3c56ad856cd3c0e7e3f47c8576c59758a9", "committedDate": "2020-05-09T22:01:22Z", "message": "chore: add BatchedQueryResult"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "255d17e89eee77c29970a6f5143371f58f7f50b3", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/255d17e89eee77c29970a6f5143371f58f7f50b3", "committedDate": "2020-05-10T17:42:06Z", "message": "test: add test for tls mutual auth"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14fffae3cb122d9c62d323a06be4c777f3c6fe46", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/14fffae3cb122d9c62d323a06be4c777f3c6fe46", "committedDate": "2020-05-10T22:41:47Z", "message": "fix: add test for StreamedQueryResult#isComplete()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78995671b098ef0df831bee0fc050f7663e901c3", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/78995671b098ef0df831bee0fc050f7663e901c3", "committedDate": "2020-05-10T23:42:14Z", "message": "test: add test for streaming push query with limit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00228ef27feb1b11e29e35e43f01f4cff72d84e5", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/00228ef27feb1b11e29e35e43f01f4cff72d84e5", "committedDate": "2020-05-10T23:58:40Z", "message": "test: integration test equivalents of StreamedQueryResultImplTest"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5MDc1NDQx", "url": "https://github.com/confluentinc/ksql/pull/5329#pullrequestreview-409075441", "createdAt": "2020-05-11T11:09:09Z", "commit": {"oid": "00228ef27feb1b11e29e35e43f01f4cff72d84e5"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQxMTowOTowOVrOGTXp4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQxMTowOTowOVrOGTXp4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk2MzY4MA==", "bodyText": "Would be nice to add a couple of tests which do the following:\n\nTerminate the connection from the server side and verify that the query results is completed on the client\nEnds the response (before limit) on the server side and verify that the query result is complete on client.", "url": "https://github.com/confluentinc/ksql/pull/5329#discussion_r422963680", "createdAt": "2020-05-11T11:09:09Z", "author": {"login": "purplefox"}, "path": "ksqldb-api-client/src/test/java/io/confluent/ksql/api/client/ClientTest.java", "diffHunk": "@@ -168,10 +223,42 @@ public void shouldHandleErrorResponseFromStreamQuery() {\n     );\n \n     // Then\n+    assertThat(e.getCause(), instanceOf(KsqlRestClientException.class));\n     assertThat(e.getCause().getMessage(), containsString(\"Received 400 response from server\"));\n     assertThat(e.getCause().getMessage(), containsString(\"invalid query blah\"));\n   }\n \n+  @Test\n+  public void shouldFailPollStreamedQueryResultIfSubscribed() throws Exception {\n+    // Given\n+    final StreamedQueryResult streamedQueryResult =\n+        javaClient.streamQuery(DEFAULT_PUSH_QUERY, DEFAULT_PUSH_QUERY_REQUEST_PROPERTIES).get();\n+    streamedQueryResult.subscribe(new TestSubscriber<>());\n+\n+    // When\n+    final Exception e = assertThrows(IllegalStateException.class, streamedQueryResult::poll);\n+\n+    // Then\n+    assertThat(e.getMessage(), containsString(\"Cannot poll if subscriber has been set\"));\n+  }\n+\n+  @Test\n+  public void shouldFailSubscribeStreamedQueryResultIfPolling() throws Exception {\n+    // Given\n+    final StreamedQueryResult streamedQueryResult =\n+        javaClient.streamQuery(DEFAULT_PUSH_QUERY, DEFAULT_PUSH_QUERY_REQUEST_PROPERTIES).get();\n+    streamedQueryResult.poll(1, TimeUnit.NANOSECONDS);\n+\n+    // When\n+    final Exception e = assertThrows(\n+        IllegalStateException.class,\n+        () -> streamedQueryResult.subscribe(new TestSubscriber<>())\n+    );\n+\n+    // Then\n+    assertThat(e.getMessage(), containsString(\"Cannot set subscriber if polling\"));\n+  }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00228ef27feb1b11e29e35e43f01f4cff72d84e5"}, "originalPosition": 162}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3731a9ed185e912b32a1d6012929b48747586272", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/3731a9ed185e912b32a1d6012929b48747586272", "committedDate": "2020-05-11T23:07:58Z", "message": "Merge branch 'master' into java-client-test-coverage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cbc498ad78de002436332ecddb9664d8b8e9e95c", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/cbc498ad78de002436332ecddb9664d8b8e9e95c", "committedDate": "2020-05-11T23:18:34Z", "message": "test: remove racy checks"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4737, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}