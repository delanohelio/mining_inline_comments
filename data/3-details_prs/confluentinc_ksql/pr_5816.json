{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ3ODY3ODA3", "number": 5816, "title": "feat(client): return query ID when persistent query started via Java client", "bodyText": "Description\nThis PR is stacked on #5775 and #5814 -- only the latest commit (feat(client): return query ID when persistent query started via Java client) needs to be reviewed.\nThis PR uses the new query ID field added to CommandStatusEntity in #5814 to return the query ID for persistent queries started with the executeStatement() method of the Java client. This is useful so client apps can easily terminate new persistent queries. The javadocs on the new ExecuteStatementResult interface explain the new behavior in more detail.\nTesting done\nAdded unit and integration tests.\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-07-12T08:19:09Z", "url": "https://github.com/confluentinc/ksql/pull/5816", "merged": true, "mergeCommit": {"oid": "a8da70baee4b8ffa509037b168fb7b04cc7ac152"}, "closed": true, "closedAt": "2020-07-15T07:04:02Z", "author": {"login": "vcrfxia"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc0jxyQAFqTQ0NzM5Mzg0OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc1DLqFgH2gAyNDQ3ODY3ODA3OjQ5N2NiY2EzMDcyMmMwZWE1MTE0MTZiOWZlMjIxZmQ3MTczMWE4ZjM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3MzkzODQ5", "url": "https://github.com/confluentinc/ksql/pull/5816#pullrequestreview-447393849", "createdAt": "2020-07-13T16:07:55Z", "commit": {"oid": "c2a032ec529494ee99a8673d62e3cfddf1088a85"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNjowNzo1NlrOGwveIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNjowOTo1NVrOGwvi5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc2MjU5Mg==", "bodyText": "In that case can we fail the CompletableFuture?", "url": "https://github.com/confluentinc/ksql/pull/5816#discussion_r453762592", "createdAt": "2020-07-13T16:07:56Z", "author": {"login": "purplefox"}, "path": "ksqldb-api-client/src/main/java/io/confluent/ksql/api/client/ExecuteStatementResult.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"); you may not use\n+ * this file except in compliance with the License.  You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.api.client;\n+\n+import java.util.Optional;\n+\n+/**\n+ * The result of executing a 'CREATE', 'CREATE ... AS * SELECT', 'DROP', 'TERMINATE', or 'INSERT\n+ * INTO ... AS SELECT' statement on the ksqlDB server.\n+ */\n+public interface ExecuteStatementResult {\n+\n+  /**\n+   * Returns the ID of a newly started persistent query, if applicable. The return value is empty\n+   * for all statements other than 'CREATE ... AS * SELECT' and 'INSERT * INTO ... AS SELECT'\n+   * statements, as only these statements start persistent queries. For statements that start\n+   * persistent queries, the return value may still be empty if either:\n+   *\n+   * <p><ul>\n+   *   <li> The statement was not executed on the server by the time the server response was sent.\n+   *   This typically does not happen under normal server operation, but may happen if the ksqlDB\n+   *   server's command runner thread is stuck, or if the configured value for\n+   *   {@code ksql.server.command.response.timeout.ms} is too low", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2a032ec529494ee99a8673d62e3cfddf1088a85"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc2MzgxNA==", "bodyText": "I think you can replace this with Optional.ofNullable(commandStatus.getString(\"queryId\"));", "url": "https://github.com/confluentinc/ksql/pull/5816#discussion_r453763814", "createdAt": "2020-07-13T16:09:55Z", "author": {"login": "purplefox"}, "path": "ksqldb-api-client/src/main/java/io/confluent/ksql/api/client/impl/DdlDmlResponseHandlers.java", "diffHunk": "@@ -33,14 +35,24 @@ private DdlDmlResponseHandlers() {\n \n   static void handleExecuteStatementResponse(\n       final JsonObject ksqlEntity,\n-      final CompletableFuture<Void> cf\n+      final CompletableFuture<ExecuteStatementResult> cf\n   ) {\n     if (!isCommandStatusEntity(ksqlEntity)) {\n       handleUnexpectedEntity(ksqlEntity, cf);\n       return;\n     }\n \n-    cf.complete(null);\n+    try {\n+      final JsonObject commandStatus = ksqlEntity.getJsonObject(\"commandStatus\");\n+      final Optional<String> queryId = commandStatus.getString(\"queryId\") != null", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2a032ec529494ee99a8673d62e3cfddf1088a85"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4a540a4abf41828842b5aa61eb999d12058907c", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/f4a540a4abf41828842b5aa61eb999d12058907c", "committedDate": "2020-07-15T01:23:12Z", "message": "feat(client): return query ID when persistent query started via Java client"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "271b1fcf4e8e241e6fdf751f5bb3b926296bcee1", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/271b1fcf4e8e241e6fdf751f5bb3b926296bcee1", "committedDate": "2020-07-15T01:26:07Z", "message": "chore: feedback"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c2a032ec529494ee99a8673d62e3cfddf1088a85", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/c2a032ec529494ee99a8673d62e3cfddf1088a85", "committedDate": "2020-07-12T08:15:06Z", "message": "feat(client): return query ID when persistent query started via Java client"}, "afterCommit": {"oid": "271b1fcf4e8e241e6fdf751f5bb3b926296bcee1", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/271b1fcf4e8e241e6fdf751f5bb3b926296bcee1", "committedDate": "2020-07-15T01:26:07Z", "message": "chore: feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "497cbca30722c0ea511416b9fe221fd71731a8f3", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/497cbca30722c0ea511416b9fe221fd71731a8f3", "committedDate": "2020-07-15T04:46:31Z", "message": "Merge branch 'master' into java-client-dxl-query-id"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4833, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}