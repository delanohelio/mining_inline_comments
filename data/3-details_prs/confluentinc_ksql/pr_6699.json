{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMwNjM5MjI1", "number": 6699, "title": "fix: Fixes bug in latests-by-offset when using nulls and sessions windows", "bodyText": "Description\nFixes: #6557\nTesting done\nAdded extra tests for ignoring nulls when merging\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-12-01T23:30:58Z", "url": "https://github.com/confluentinc/ksql/pull/6699", "merged": true, "mergeCommit": {"oid": "8ff52ca3e178c55e285e74f806d12f9d7f8f921c"}, "closed": true, "closedAt": "2020-12-05T03:20:13Z", "author": {"login": "vpapavas"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdiCikrAH2gAyNTMwNjM5MjI1OjhiZWZiOWFhODAxOWM0ZmY5N2U4ZTBhMzA4NGE2NGU3NzhmNGQxNWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdi_YKIAH2gAyNTMwNjM5MjI1OjE1Mzg5ZDNiMWJjNDUwNmY4NjBkOTQwM2FiZGVjOTBmOWI3MmM1MjA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8befb9aa8019c4ff97e8e0a3084a64e778f4d15a", "author": {"user": {"login": "vpapavas", "name": "Vicky Papavasileiou"}}, "url": "https://github.com/confluentinc/ksql/commit/8befb9aa8019c4ff97e8e0a3084a64e778f4d15a", "committedDate": "2020-12-01T23:28:14Z", "message": "fix: ignore nulls when merging session windows, if specified"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d917459b00d8daf3650b07e443db44de71dd826d", "author": {"user": {"login": "vpapavas", "name": "Vicky Papavasileiou"}}, "url": "https://github.com/confluentinc/ksql/commit/d917459b00d8daf3650b07e443db44de71dd826d", "committedDate": "2020-12-01T23:28:19Z", "message": "fix: ignore nulls when merging session windows, if specified"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c88e17d8db8434b468d50745002b771a7ab4662", "author": {"user": {"login": "vpapavas", "name": "Vicky Papavasileiou"}}, "url": "https://github.com/confluentinc/ksql/commit/5c88e17d8db8434b468d50745002b771a7ab4662", "committedDate": "2020-12-02T00:31:39Z", "message": "fix compilation error"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyNDE4NDMz", "url": "https://github.com/confluentinc/ksql/pull/6699#pullrequestreview-542418433", "createdAt": "2020-12-02T00:58:27Z", "commit": {"oid": "5c88e17d8db8434b468d50745002b771a7ab4662"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwMDo1ODoyN1rOH9GA5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwMTowMDoyOVrOH9GEOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzgyMzcxOQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    // Deal with overflow - we assume if one is positive and the other negative then the\n          \n          \n            \n                    // sequence has overflowed - in which case the latest is the one with the smallest sequence\n          \n          \n            \n                    final long sequence1 = struct1.getInt64(SEQ_FIELD);\n          \n          \n            \n                    final long sequence2 = struct2.getInt64(SEQ_FIELD);\n          \n          \n            \n                    if (sequence1 < 0 && sequence2 >= 0) {\n          \n          \n            \n                      return 1;\n          \n          \n            \n                    } else if (sequence2 < 0 && sequence1 >= 0) {\n          \n          \n            \n                      return -1;\n          \n          \n            \n                    } else {\n          \n          \n            \n                      return Long.compare(sequence1, sequence2);\n          \n          \n            \n                    }\n          \n          \n            \n                    return INTERMEDIATE_STRUCT_COMPARATOR.compare(struct1, struct2);", "url": "https://github.com/confluentinc/ksql/pull/6699#discussion_r533823719", "createdAt": "2020-12-02T00:58:27Z", "author": {"login": "agavra"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/function/udaf/offset/KudafByOffsetUtils.java", "diffHunk": "@@ -64,6 +64,29 @@\n     }\n   };\n \n+  static final Comparator<Struct> INTERMEDIATE_STRUCT_COMPARATOR_IGNORE_NULLS =\n+      (struct1, struct2) -> {\n+        // Ignore nulls: If one of the structs has a null value, then return the other irrespective\n+        // of sequence.\n+        if (struct1.get(VAL_FIELD) == null) {\n+          return -1;\n+        } else if (struct2.get(VAL_FIELD) == null) {\n+          return 1;\n+        }\n+\n+        // Deal with overflow - we assume if one is positive and the other negative then the\n+        // sequence has overflowed - in which case the latest is the one with the smallest sequence\n+        final long sequence1 = struct1.getInt64(SEQ_FIELD);\n+        final long sequence2 = struct2.getInt64(SEQ_FIELD);\n+        if (sequence1 < 0 && sequence2 >= 0) {\n+          return 1;\n+        } else if (sequence2 < 0 && sequence1 >= 0) {\n+          return -1;\n+        } else {\n+          return Long.compare(sequence1, sequence2);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c88e17d8db8434b468d50745002b771a7ab4662"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzgyNDA5Mg==", "bodyText": "nit: makes sense to make this decision once instead of every time we call merge", "url": "https://github.com/confluentinc/ksql/pull/6699#discussion_r533824092", "createdAt": "2020-12-02T00:59:18Z", "author": {"login": "agavra"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/function/udaf/offset/LatestByOffset.java", "diffHunk": "@@ -220,7 +222,13 @@ public Struct aggregate(final T current, final Struct aggregate) {\n       public Struct merge(final Struct aggOne, final Struct aggTwo) {\n         // When merging we need some way of evaluating the \"latest' one.\n         // We do this by keeping track of the sequence of when it was originally processed\n-        if (INTERMEDIATE_STRUCT_COMPARATOR.compare(aggOne, aggTwo) >= 0) {\n+        final Comparator<Struct> comparator;\n+        if (ignoreNulls) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c88e17d8db8434b468d50745002b771a7ab4662"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzgyNDU2OA==", "bodyText": "nit: what if they're both null? then we should probably return 0 (I don't think it'll make a difference, but better to be correct)", "url": "https://github.com/confluentinc/ksql/pull/6699#discussion_r533824568", "createdAt": "2020-12-02T01:00:29Z", "author": {"login": "agavra"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/function/udaf/offset/KudafByOffsetUtils.java", "diffHunk": "@@ -64,6 +64,29 @@\n     }\n   };\n \n+  static final Comparator<Struct> INTERMEDIATE_STRUCT_COMPARATOR_IGNORE_NULLS =\n+      (struct1, struct2) -> {\n+        // Ignore nulls: If one of the structs has a null value, then return the other irrespective\n+        // of sequence.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c88e17d8db8434b468d50745002b771a7ab4662"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e400153df72a77c3977177e87567bc52fbeb087", "author": {"user": {"login": "vpapavas", "name": "Vicky Papavasileiou"}}, "url": "https://github.com/confluentinc/ksql/commit/1e400153df72a77c3977177e87567bc52fbeb087", "committedDate": "2020-12-04T01:04:24Z", "message": "address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff6521eb2d34c18c67c6c530b190ddd99db69822", "author": {"user": {"login": "vpapavas", "name": "Vicky Papavasileiou"}}, "url": "https://github.com/confluentinc/ksql/commit/ff6521eb2d34c18c67c6c530b190ddd99db69822", "committedDate": "2020-12-04T01:38:54Z", "message": "address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1MTIxNDUw", "url": "https://github.com/confluentinc/ksql/pull/6699#pullrequestreview-545121450", "createdAt": "2020-12-04T16:42:12Z", "commit": {"oid": "ff6521eb2d34c18c67c6c530b190ddd99db69822"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxNjo0MjoxM1rOH_Y9xw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxNjo0NDowOVrOH_ZCwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjIzMTM2Nw==", "bodyText": "this condition will never be hit - it needs to be the first in the if/else branches", "url": "https://github.com/confluentinc/ksql/pull/6699#discussion_r536231367", "createdAt": "2020-12-04T16:42:13Z", "author": {"login": "agavra"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/function/udaf/offset/KudafByOffsetUtils.java", "diffHunk": "@@ -64,6 +64,21 @@\n     }\n   };\n \n+  static final Comparator<Struct> INTERMEDIATE_STRUCT_COMPARATOR_IGNORE_NULLS =\n+      (struct1, struct2) -> {\n+        // Ignore nulls: If one of the structs has a null value, then return the other irrespective\n+        // of sequence.\n+        if (struct1.get(VAL_FIELD) == null) {\n+          return -1;\n+        } else if (struct2.get(VAL_FIELD) == null) {\n+          return 1;\n+        } else if (struct1.get(VAL_FIELD) == null && struct2.get(VAL_FIELD) == null) {\n+          return 0;\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff6521eb2d34c18c67c6c530b190ddd99db69822"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjIzMjY0MQ==", "bodyText": "we should not be relying on static state - if people create two different latest by offests (one to ignore nulls and one not to) whichever is created second will override the comparator for the first. Instead, it should be created when latestN method is called as a local variable and referenced in the anonymous class\nIn general, if you see code with static, non-final state it's probably a bug and best to avoid.", "url": "https://github.com/confluentinc/ksql/pull/6699#discussion_r536232641", "createdAt": "2020-12-04T16:44:09Z", "author": {"login": "agavra"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/function/udaf/offset/LatestByOffset.java", "diffHunk": "@@ -50,6 +52,7 @@ private LatestByOffset() {\n   }\n \n   static AtomicLong sequence = new AtomicLong();\n+  private static Comparator<Struct> comparator;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff6521eb2d34c18c67c6c530b190ddd99db69822"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "897a4c99df2bbbb773233a15bf9483c4635252aa", "author": {"user": {"login": "vpapavas", "name": "Vicky Papavasileiou"}}, "url": "https://github.com/confluentinc/ksql/commit/897a4c99df2bbbb773233a15bf9483c4635252aa", "committedDate": "2020-12-04T19:24:44Z", "message": "Trigger Build"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f5329ff8c5f7ea167f5e8d9ebc3ee7a90732a27", "author": {"user": {"login": "vpapavas", "name": "Vicky Papavasileiou"}}, "url": "https://github.com/confluentinc/ksql/commit/6f5329ff8c5f7ea167f5e8d9ebc3ee7a90732a27", "committedDate": "2020-12-04T20:10:49Z", "message": "address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15389d3b1bc4506f860d9403abdec90f9b72c520", "author": {"user": {"login": "vpapavas", "name": "Vicky Papavasileiou"}}, "url": "https://github.com/confluentinc/ksql/commit/15389d3b1bc4506f860d9403abdec90f9b72c520", "committedDate": "2020-12-04T22:21:04Z", "message": "add plans"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4561, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}