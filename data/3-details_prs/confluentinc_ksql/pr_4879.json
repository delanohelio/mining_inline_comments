{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkyODk4NDE0", "number": 4879, "title": "refactor: correct optionals and remove empties from query plans", "bodyText": "Description\nThis commit cleans up some properties that are marked both required and of type Optional, and others that are collections that are required but can be empty, in the types used to create ksqlDB's execution plans.\nThese changes remove a lot of noise from the plans, e.g. properties set to null or to empty collections [] and {}.\nThe saved historical plans have not be re-written. These changes will only be applied going forward and are backwards compatible.\nTesting done\nusual\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-03-24T10:16:57Z", "url": "https://github.com/confluentinc/ksql/pull/4879", "merged": true, "mergeCommit": {"oid": "e16ef101873488422ed0b09a2ce3e07525cf1654"}, "closed": true, "closedAt": "2020-03-27T12:07:48Z", "author": {"login": "big-andy-coates"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcQwK_TgH2gAyMzkyODk4NDE0OmFjZDkwNmQ2MTAwMDgxMTI5NjE5MjgyMGI3YTdiN2ZjYzYwOWM2NGI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcRetcZgH2gAyMzkyODk4NDE0OjQzMzkxZDFhZDA2ZGJlNDBiNTYxYjNiNjRlNmM2YmE3ZjljNzY2NWE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "acd906d61000811296192820b7a7b7fcc609c64b", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/acd906d61000811296192820b7a7b7fcc609c64b", "committedDate": "2020-03-24T10:16:19Z", "message": "refactor: correct optionals and remove empties from query plans\n\nThis commit cleans up some properties that are marked both `required` and of type `Optional`, and others that are collections that are `required` but can be empty, in the types used to create ksqlDB's execution plans.\n\nThese changes remove a lot of noise from the plans, e.g. properties set to `null` or to empty collections `[]` and `{}`.\n\nThe saved historical plans have not be re-written. These changes will only be applied going forward and are backwards compatible."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMTY5MDE1", "url": "https://github.com/confluentinc/ksql/pull/4879#pullrequestreview-380169015", "createdAt": "2020-03-24T10:17:38Z", "commit": {"oid": "acd906d61000811296192820b7a7b7fcc609c64b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMDoxNzozOFrOF6pe0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMDoxNzozOFrOF6pe0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA0MTM2Mg==", "bodyText": "Removed include = As.PROPERTY as that's the default.", "url": "https://github.com/confluentinc/ksql/pull/4879#discussion_r397041362", "createdAt": "2020-03-24T10:17:38Z", "author": {"login": "big-andy-coates"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/engine/KsqlPlan.java", "diffHunk": "@@ -18,18 +18,15 @@\n import com.fasterxml.jackson.annotation.JsonSubTypes;\n import com.fasterxml.jackson.annotation.JsonSubTypes.Type;\n import com.fasterxml.jackson.annotation.JsonTypeInfo;\n-import com.fasterxml.jackson.annotation.JsonTypeInfo.As;\n import io.confluent.ksql.execution.ddl.commands.DdlCommand;\n import java.util.Optional;\n \n-@JsonTypeInfo(\n-    use = JsonTypeInfo.Id.NAME,\n-    include = As.PROPERTY\n-)\n+@JsonTypeInfo(use = JsonTypeInfo.Id.NAME)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "acd906d61000811296192820b7a7b7fcc609c64b"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMTY5NTQw", "url": "https://github.com/confluentinc/ksql/pull/4879#pullrequestreview-380169540", "createdAt": "2020-03-24T10:18:24Z", "commit": {"oid": "acd906d61000811296192820b7a7b7fcc609c64b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMDoxODoyNFrOF6pgkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMDoxODoyNFrOF6pgkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA0MTgwOQ==", "bodyText": "This configures Jackson to exclude null, Optional.empty() and empty collections when serializing.", "url": "https://github.com/confluentinc/ksql/pull/4879#discussion_r397041809", "createdAt": "2020-03-24T10:18:24Z", "author": {"login": "big-andy-coates"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/execution/json/PlanJsonMapper.java", "diffHunk": "@@ -45,6 +46,7 @@ public static ObjectMapper create() {\n     mapper.enable(DeserializationFeature.FAIL_ON_NULL_FOR_PRIMITIVES);\n     mapper.enable(DeserializationFeature.FAIL_ON_NULL_CREATOR_PROPERTIES);\n     mapper.enable(DeserializationFeature.FAIL_ON_INVALID_SUBTYPE);\n+    mapper.setSerializationInclusion(Include.NON_EMPTY);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "acd906d61000811296192820b7a7b7fcc609c64b"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMTY5NjE1", "url": "https://github.com/confluentinc/ksql/pull/4879#pullrequestreview-380169615", "createdAt": "2020-03-24T10:18:28Z", "commit": {"oid": "acd906d61000811296192820b7a7b7fcc609c64b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMDoxODoyOFrOF6pgwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMDoxODoyOFrOF6pgwA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA0MTg1Ng==", "bodyText": "Removed include = As.PROPERTY as that's the default.", "url": "https://github.com/confluentinc/ksql/pull/4879#discussion_r397041856", "createdAt": "2020-03-24T10:18:28Z", "author": {"login": "big-andy-coates"}, "path": "ksqldb-execution/src/main/java/io/confluent/ksql/execution/plan/ExecutionStep.java", "diffHunk": "@@ -18,14 +18,10 @@\n import com.fasterxml.jackson.annotation.JsonSubTypes;\n import com.fasterxml.jackson.annotation.JsonSubTypes.Type;\n import com.fasterxml.jackson.annotation.JsonTypeInfo;\n-import com.fasterxml.jackson.annotation.JsonTypeInfo.As;\n import com.google.errorprone.annotations.Immutable;\n import java.util.List;\n \n-@JsonTypeInfo(\n-    use = JsonTypeInfo.Id.NAME,\n-    include = As.PROPERTY\n-)\n+@JsonTypeInfo(use = JsonTypeInfo.Id.NAME)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "acd906d61000811296192820b7a7b7fcc609c64b"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMTcwMjYy", "url": "https://github.com/confluentinc/ksql/pull/4879#pullrequestreview-380170262", "createdAt": "2020-03-24T10:19:21Z", "commit": {"oid": "acd906d61000811296192820b7a7b7fcc609c64b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMDoxOToyMlrOF6piqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMDoxOToyMlrOF6piqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA0MjM0NQ==", "bodyText": "Removed required as its acceptable for this set to be empty, (it generally is).\nWhen empty, it is no longer serialized to the JSON, hence it is now Optional.", "url": "https://github.com/confluentinc/ksql/pull/4879#discussion_r397042345", "createdAt": "2020-03-24T10:19:22Z", "author": {"login": "big-andy-coates"}, "path": "ksqldb-execution/src/main/java/io/confluent/ksql/execution/plan/Formats.java", "diffHunk": "@@ -35,10 +36,13 @@\n   public Formats(\n       @JsonProperty(value = \"keyFormat\", required = true) final FormatInfo keyFormat,\n       @JsonProperty(value = \"valueFormat\", required = true) final FormatInfo valueFormat,\n-      @JsonProperty(value = \"options\", required = true) final Set<SerdeOption> options) {\n+      @JsonProperty(value = \"options\") final Optional<Set<SerdeOption>> options", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "acd906d61000811296192820b7a7b7fcc609c64b"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMTcwNjI0", "url": "https://github.com/confluentinc/ksql/pull/4879#pullrequestreview-380170624", "createdAt": "2020-03-24T10:19:52Z", "commit": {"oid": "acd906d61000811296192820b7a7b7fcc609c64b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMDoxOTo1MlrOF6pjyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMDoxOTo1MlrOF6pjyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA0MjYzNA==", "bodyText": "No longer required, as set on the ObjectMapper.", "url": "https://github.com/confluentinc/ksql/pull/4879#discussion_r397042634", "createdAt": "2020-03-24T10:19:52Z", "author": {"login": "big-andy-coates"}, "path": "ksqldb-execution/src/main/java/io/confluent/ksql/execution/plan/StreamSink.java", "diffHunk": "@@ -24,7 +22,6 @@\n import java.util.Objects;\n import java.util.Optional;\n \n-@JsonInclude(Include.NON_ABSENT)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "acd906d61000811296192820b7a7b7fcc609c64b"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMTcwNzAx", "url": "https://github.com/confluentinc/ksql/pull/4879#pullrequestreview-380170701", "createdAt": "2020-03-24T10:19:58Z", "commit": {"oid": "acd906d61000811296192820b7a7b7fcc609c64b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMDoxOTo1OFrOF6pkAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMDoxOTo1OFrOF6pkAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA0MjY5MA==", "bodyText": "No longer required, as set on the ObjectMapper.", "url": "https://github.com/confluentinc/ksql/pull/4879#discussion_r397042690", "createdAt": "2020-03-24T10:19:58Z", "author": {"login": "big-andy-coates"}, "path": "ksqldb-execution/src/main/java/io/confluent/ksql/execution/plan/TableSink.java", "diffHunk": "@@ -25,7 +23,6 @@\n import java.util.Objects;\n import java.util.Optional;\n \n-@JsonInclude(Include.NON_ABSENT)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "acd906d61000811296192820b7a7b7fcc609c64b"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMTcxMDQ1", "url": "https://github.com/confluentinc/ksql/pull/4879#pullrequestreview-380171045", "createdAt": "2020-03-24T10:20:27Z", "commit": {"oid": "acd906d61000811296192820b7a7b7fcc609c64b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMDoyMDoyN1rOF6plGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMDoyMDoyN1rOF6plGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA0Mjk3MQ==", "bodyText": "Moved all 'PlannedXXXXXinto the existingplanned` package.", "url": "https://github.com/confluentinc/ksql/pull/4879#discussion_r397042971", "createdAt": "2020-03-24T10:20:27Z", "author": {"login": "big-andy-coates"}, "path": "ksqldb-functional-tests/src/test/java/io/confluent/ksql/test/planned/PlannedTestGeneratorTest.java", "diffHunk": "@@ -13,10 +13,9 @@\n  * specific language governing permissions and limitations under the License.\n  */\n \n-package io.confluent.ksql.test;\n+package io.confluent.ksql.test.planned;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "acd906d61000811296192820b7a7b7fcc609c64b"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMTcxOTk5", "url": "https://github.com/confluentinc/ksql/pull/4879#pullrequestreview-380171999", "createdAt": "2020-03-24T10:21:46Z", "commit": {"oid": "acd906d61000811296192820b7a7b7fcc609c64b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMDoyMTo0NlrOF6pn_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMDoyMTo0NlrOF6pn_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA0MzcwOA==", "bodyText": "Inlined these as it means:\n\nDon't need to add new accessors here when new accessors are added to either TestCaseSpecNode or TestCasePlanNode, i.e. cleaner, more stable API.\nMakes it easier to access TestCaseSpecNode or TestCasePlanNode from the rewriter code.", "url": "https://github.com/confluentinc/ksql/pull/4879#discussion_r397043708", "createdAt": "2020-03-24T10:21:46Z", "author": {"login": "big-andy-coates"}, "path": "ksqldb-functional-tests/src/test/java/io/confluent/ksql/test/planned/TestCasePlan.java", "diffHunk": "@@ -56,43 +57,15 @@\n     this.topology = Objects.requireNonNull(topology, \"topology\");\n   }\n \n-  public List<KsqlPlan> getPlan() {\n-    return planNode.getPlan();\n-  }\n-\n-  public long getTimestamp() {\n-    return specNode.getTimestamp();\n-  }\n-\n-  public Map<String, String> getConfigs() {\n-    return planNode.getConfigs();\n-  }\n-\n-  public Map<String, String> getSchemas() {\n-    return specNode.getSchemas();\n-  }\n-", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "acd906d61000811296192820b7a7b7fcc609c64b"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMTczMDAw", "url": "https://github.com/confluentinc/ksql/pull/4879#pullrequestreview-380173000", "createdAt": "2020-03-24T10:23:06Z", "commit": {"oid": "acd906d61000811296192820b7a7b7fcc609c64b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMDoyMzowN1rOF6prNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMDoyMzowN1rOF6prNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA0NDUzMw==", "bodyText": "This is a single, example, rewritten plan.  I've included this to demonstrate the differences between existing plans and ones that will be written from now on.  All other historical plans have been left untouched, as these represent the plans that will be in the command topics of clusters out in the wild.", "url": "https://github.com/confluentinc/ksql/pull/4879#discussion_r397044533", "createdAt": "2020-03-24T10:23:07Z", "author": {"login": "big-andy-coates"}, "path": "ksqldb-functional-tests/src/test/resources/historical_plans/average_-_calculate_average_in_select/5.5.0_1579766275923/plan.json", "diffHunk": "@@ -7,22 +7,16 @@\n       \"sourceName\" : \"TEST\",\n       \"schema\" : \"`ROWKEY` BIGINT KEY, `ID` BIGINT, `NAME` STRING, `VALUE` BIGINT\",\n       \"keyField\" : \"ID\",\n-      \"timestampColumn\" : null,\n       \"topicName\" : \"test_topic\",\n       \"formats\" : {\n         \"keyFormat\" : {\n-          \"format\" : \"KAFKA\",\n-          \"properties\" : { }\n+          \"format\" : \"KAFKA\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "acd906d61000811296192820b7a7b7fcc609c64b"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f22445c5c8e227dff5d2813f0621b17fe0b35355", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/f22445c5c8e227dff5d2813f0621b17fe0b35355", "committedDate": "2020-03-24T12:30:25Z", "message": "chore: fix tests by ALWAYS including config values"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxMDc2NTQ0", "url": "https://github.com/confluentinc/ksql/pull/4879#pullrequestreview-381076544", "createdAt": "2020-03-25T11:51:25Z", "commit": {"oid": "f22445c5c8e227dff5d2813f0621b17fe0b35355"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxNjMxNjY2", "url": "https://github.com/confluentinc/ksql/pull/4879#pullrequestreview-381631666", "createdAt": "2020-03-26T00:37:57Z", "commit": {"oid": "f22445c5c8e227dff5d2813f0621b17fe0b35355"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82cd2a1ee344cedd30a772e3f3a7b1a5bbe6b856", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/82cd2a1ee344cedd30a772e3f3a7b1a5bbe6b856", "committedDate": "2020-03-26T01:11:11Z", "message": "chore: fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32dd3834b2de57ac328ebf7b8918fd8a27aac8be", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/32dd3834b2de57ac328ebf7b8918fd8a27aac8be", "committedDate": "2020-03-26T11:11:48Z", "message": "chore: fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3365427ef1b013cd4690b3e931dcd421450eedca", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/3365427ef1b013cd4690b3e931dcd421450eedca", "committedDate": "2020-03-26T16:29:05Z", "message": "Merge branch 'master' into query_planbs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43391d1ad06dbe40b561b3b64e6c6ba7f9c7665a", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/43391d1ad06dbe40b561b3b64e6c6ba7f9c7665a", "committedDate": "2020-03-26T16:29:35Z", "message": "chore: merge from master"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4918, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}