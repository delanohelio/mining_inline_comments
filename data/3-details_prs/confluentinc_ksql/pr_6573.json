{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE1NTAyMDAw", "number": 6573, "title": "fix: cannot reference variables in DEFINE statement", "bodyText": "Description\nIssue: Variables cannot be referenced in the DEFINE statement. i.e.\nksql> define env = 'qa';\nksql> define topicName = 'topic_${env}';\nksql> show variables;\n\n Variable Name | Value    \n--------------------------\n env           | qa       \n topicName     | topic_${env}\n--------------------------\n\nThis PR fixes the above issue by looking at the VariableValueContext in the VariableSubstitutor, and replace any variables referenced there.\nExample:\nksql> define env = 'qa';\nksql> define topicName = 'topic_${env}';\nksql> show variables;\n\n Variable Name | Value    \n--------------------------\n env           | qa       \n topicName     | topic_qa \n--------------------------\n\nTesting done\nAdded unit tests\nVerified manually\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-11-04T16:34:18Z", "url": "https://github.com/confluentinc/ksql/pull/6573", "merged": true, "mergeCommit": {"oid": "ee31fde6fa98ce2ab4581487d2d962bc793f3e88"}, "closed": true, "closedAt": "2020-11-16T17:59:26Z", "author": {"login": "spena"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZkIvIABqjM5NjI5OTMzOTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABddIGNsAFqTUzMTUyNzAxMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d44baec1da8fb7b3b4b7d8aeca805ba6bfb18b22", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/d44baec1da8fb7b3b4b7d8aeca805ba6bfb18b22", "committedDate": "2020-11-04T16:31:10Z", "message": "fix: cannot reference variables in DEFINE statement"}, "afterCommit": {"oid": "6712abce98e9e8de3f71867716b9c9785bdeb719", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/6712abce98e9e8de3f71867716b9c9785bdeb719", "committedDate": "2020-11-05T15:31:19Z", "message": "fix: cannot reference variables in DEFINE statement"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0NDE5MzQ5", "url": "https://github.com/confluentinc/ksql/pull/6573#pullrequestreview-524419349", "createdAt": "2020-11-05T16:07:01Z", "commit": {"oid": "ca9884ae54066337c8add1acae1c53ced5dc36ae"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxNjowNzowMlrOHuKjqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxNjowNzowMlrOHuKjqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE2OTUxNA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            If you want to escape a variable reference, so it is not substituted, then use double `$$` characters.\n          \n          \n            \n            To escape a variable reference, so it isn't substituted, use double dollar-sign characters, `$$`. The following example shows how to escape a variable named `format`.", "url": "https://github.com/confluentinc/ksql/pull/6573#discussion_r518169514", "createdAt": "2020-11-05T16:07:02Z", "author": {"login": "JimGalasyn"}, "path": "docs/developer-guide/variable-substitution.md", "diffHunk": "@@ -86,6 +86,16 @@ ksqlDB doesn't add single-quotes to values during variable substitution. Also, y\n !!! note\n     Variables are case-insensitive. A reference to `${replicas}` is the same as `${REPLICAS}`.\n \n+Escape substitution variables\n+-----------------------------\n+\n+If you want to escape a variable reference, so it is not substituted, then use double `$$` characters.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca9884ae54066337c8add1acae1c53ced5dc36ae"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0NDE5OTUw", "url": "https://github.com/confluentinc/ksql/pull/6573#pullrequestreview-524419950", "createdAt": "2020-11-05T16:07:37Z", "commit": {"oid": "ca9884ae54066337c8add1acae1c53ced5dc36ae"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxNjowNzozN1rOHuKlaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxNjowNzozN1rOHuKlaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE2OTk2Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            The above query will become `SELECT '${format}' FROM stream`\n          \n          \n            \n            ksqlDB converts the previous query to `SELECT '${format}' FROM stream`.", "url": "https://github.com/confluentinc/ksql/pull/6573#discussion_r518169963", "createdAt": "2020-11-05T16:07:37Z", "author": {"login": "JimGalasyn"}, "path": "docs/developer-guide/variable-substitution.md", "diffHunk": "@@ -86,6 +86,16 @@ ksqlDB doesn't add single-quotes to values during variable substitution. Also, y\n !!! note\n     Variables are case-insensitive. A reference to `${replicas}` is the same as `${REPLICAS}`.\n \n+Escape substitution variables\n+-----------------------------\n+\n+If you want to escape a variable reference, so it is not substituted, then use double `$$` characters.\n+```\n+DEFINE format = 'AVRO';\n+SELECT '$${format}' FROM stream;\n+```\n+The above query will become `SELECT '${format}' FROM stream`", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca9884ae54066337c8add1acae1c53ced5dc36ae"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0NDIwMzI1", "url": "https://github.com/confluentinc/ksql/pull/6573#pullrequestreview-524420325", "createdAt": "2020-11-05T16:08:01Z", "commit": {"oid": "ca9884ae54066337c8add1acae1c53ced5dc36ae"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "989013d3443e4edbd073ae5a4cc9ab9bbf4ba14a", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/989013d3443e4edbd073ae5a4cc9ab9bbf4ba14a", "committedDate": "2020-11-10T18:39:48Z", "message": "fix: cannot reference variables in DEFINE statement"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dcfb41abaaad1f546fd61397c145502e8b5f1227", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/dcfb41abaaad1f546fd61397c145502e8b5f1227", "committedDate": "2020-11-10T18:39:48Z", "message": "test: add test to check escaped variable references"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "091e22965094ac9953506955365c5217209f02d4", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/091e22965094ac9953506955365c5217209f02d4", "committedDate": "2020-11-10T18:39:48Z", "message": "docs: update docs to show how to escape variables"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eeab91a18b5933f9152ed997c57981a7057c892e", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/eeab91a18b5933f9152ed997c57981a7057c892e", "committedDate": "2020-11-10T18:39:48Z", "message": "test: add more tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "64e29379a6f841aa0f603fd58269f15af9db2ba7", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/64e29379a6f841aa0f603fd58269f15af9db2ba7", "committedDate": "2020-11-05T21:50:28Z", "message": "docs: Apply Jim's suggestions\n\nCo-authored-by: Jim Galasyn <jim.galasyn@confluent.io>"}, "afterCommit": {"oid": "eeab91a18b5933f9152ed997c57981a7057c892e", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/eeab91a18b5933f9152ed997c57981a7057c892e", "committedDate": "2020-11-10T18:39:48Z", "message": "test: add more tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxNTI3MDEy", "url": "https://github.com/confluentinc/ksql/pull/6573#pullrequestreview-531527012", "createdAt": "2020-11-16T17:07:04Z", "commit": {"oid": "eeab91a18b5933f9152ed997c57981a7057c892e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4602, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}