{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM3MjA3NzUx", "number": 5653, "title": "test: Pull queries correctness tests", "bodyText": "Description\nChanges PullQueryRoutingFunctionalTest to avoid artificial message sending and instead sets the servers up realistically, with the exception of faulty kafka and ksql clients to simulate network partitions/dead servers.\nAlso, adds the endpoint of the replying node to the pull query response so that the caller can know precisely which node answered the response.\nTesting done\nmvn package\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-06-19T16:56:45Z", "url": "https://github.com/confluentinc/ksql/pull/5653", "merged": true, "mergeCommit": {"oid": "1caff98f3d706b8e0e70ea77e8c9e8d21ea10f7a"}, "closed": true, "closedAt": "2020-06-30T16:13:06Z", "author": {"login": "AlanConfluent"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcs3OykgFqTQzNDI2NTgyMw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwKESjgH2gAyNDM3MjA3NzUxOmQ4Yjc2M2ZlOGY2NjQxYzg0NWNjYzVhNjkxOWU5YmEzMWFhOTA0YjQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0MjY1ODIz", "url": "https://github.com/confluentinc/ksql/pull/5653#pullrequestreview-434265823", "createdAt": "2020-06-19T18:19:40Z", "commit": {"oid": "017b125d99683436858e8bdd873b0b3f71a855f7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxODoxOTo0MFrOGmdojw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxODoxOTo0MFrOGmdojw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk4NDU5MQ==", "bodyText": "I feel like it would be better to add a keyword to the query itself, like DEBUG instead of using a server config. This way, we have a control know per pull query and we can add more debug information in the future, like amount of lag, or routing information, etc.", "url": "https://github.com/confluentinc/ksql/pull/5653#discussion_r442984591", "createdAt": "2020-06-19T18:19:40Z", "author": {"login": "vpapavas"}, "path": "ksqldb-common/src/main/java/io/confluent/ksql/util/KsqlConfig.java", "diffHunk": "@@ -215,6 +215,13 @@\n   public static final String KSQL_QUERY_PULL_MAX_QPS_DOC = \"The maximum qps allowed for pull \"\n       + \"queries. Once the limit is hit, queries will fail immediately\";\n \n+  public static final String KSQL_QUERY_PULL_SET_REPLYING_HOST_CONFIG =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "017b125d99683436858e8bdd873b0b3f71a855f7"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0MjY3OTA5", "url": "https://github.com/confluentinc/ksql/pull/5653#pullrequestreview-434267909", "createdAt": "2020-06-19T18:23:46Z", "commit": {"oid": "017b125d99683436858e8bdd873b0b3f71a855f7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxODoyMzo0NlrOGmdvPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxODoyMzo0NlrOGmdvPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk4NjMwMQ==", "bodyText": "I think it makes sense to have a new type of response, that consists of the debug information and the list of rows. Basically, make it a class so that we can add more debug info in the future", "url": "https://github.com/confluentinc/ksql/pull/5653#discussion_r442986301", "createdAt": "2020-06-19T18:23:46Z", "author": {"login": "vpapavas"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/services/DefaultKsqlClient.java", "diffHunk": "@@ -102,14 +103,14 @@\n         .target(serverEndPoint)\n         .properties(configOverrides);\n \n-    final RestResponse<List<StreamedRow>> resp = getTarget(target, authHeader)\n+    final RestResponse<Pair<Optional<URI>, List<StreamedRow>>> resp = getTarget(target, authHeader)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "017b125d99683436858e8bdd873b0b3f71a855f7"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0MjcyNzEx", "url": "https://github.com/confluentinc/ksql/pull/5653#pullrequestreview-434272711", "createdAt": "2020-06-19T18:33:08Z", "commit": {"oid": "017b125d99683436858e8bdd873b0b3f71a855f7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxODozMzowOFrOGmd9ow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxODozMzowOFrOGmd9ow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk4OTk4Nw==", "bodyText": "This stops all incoming/outgoing traffic to simulate that a node is dead? Does it actually cause rebalancing?", "url": "https://github.com/confluentinc/ksql/pull/5653#discussion_r442989987", "createdAt": "2020-06-19T18:33:08Z", "author": {"login": "vpapavas"}, "path": "ksqldb-rest-app/src/test/java/io/confluent/ksql/rest/integration/PullQueryRoutingFunctionalTest.java", "diffHunk": "@@ -480,5 +553,94 @@ private String extractQueryId(final String outputString) {\n     assertThat(\"Could not find query id in: \" + outputString, matcher.find());\n     return matcher.group(1);\n   }\n+\n+  public static class TestApp {\n+\n+    private final KsqlHostInfoEntity host;\n+    private final TestKsqlRestApp app;\n+    private final Shutoffs shutoffs;\n+\n+    public TestApp(KsqlHostInfoEntity host, TestKsqlRestApp app, Shutoffs shutoffs) {\n+      this.host = host;\n+      this.app = app;\n+      this.shutoffs = shutoffs;\n+    }\n+\n+    public KsqlHostInfoEntity getHost() {\n+      return host;\n+    }\n+\n+    public TestKsqlRestApp getApp() {\n+      return app;\n+    }\n+\n+    public Shutoffs getShutoffs() {\n+      return shutoffs;\n+    }\n+  }\n+\n+  public static class Shutoffs {\n+    private final AtomicBoolean ksqlOutgoing = new AtomicBoolean(false);\n+    private final AtomicBoolean kafkaIncoming = new AtomicBoolean(false);\n+\n+    public void shutOffAll() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "017b125d99683436858e8bdd873b0b3f71a855f7"}, "originalPosition": 580}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1MzUyMTI0", "url": "https://github.com/confluentinc/ksql/pull/5653#pullrequestreview-435352124", "createdAt": "2020-06-23T00:02:14Z", "commit": {"oid": "6a91385170efc9ce5bd6b3ca3df68f08713a0bd6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3fe1fee53181117886df9b776a69febc541e651e", "author": {"user": {"login": "AlanConfluent", "name": "Alan Sheinberg"}}, "url": "https://github.com/confluentinc/ksql/commit/3fe1fee53181117886df9b776a69febc541e651e", "committedDate": "2020-06-29T23:13:10Z", "message": "pull queries correctness test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e256953f704b4379c3ba7bc10d3c0018351a354c", "author": {"user": {"login": "AlanConfluent", "name": "Alan Sheinberg"}}, "url": "https://github.com/confluentinc/ksql/commit/e256953f704b4379c3ba7bc10d3c0018351a354c", "committedDate": "2020-06-29T23:13:11Z", "message": "Gets everything working"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "941a2c351884f7a6a834d68b97d44d9f4fb3e611", "author": {"user": {"login": "AlanConfluent", "name": "Alan Sheinberg"}}, "url": "https://github.com/confluentinc/ksql/commit/941a2c351884f7a6a834d68b97d44d9f4fb3e611", "committedDate": "2020-06-29T23:13:11Z", "message": "Gets things in better order"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b49132d016c8d4fb32fbb775f186a00809b33f55", "author": {"user": {"login": "AlanConfluent", "name": "Alan Sheinberg"}}, "url": "https://github.com/confluentinc/ksql/commit/b49132d016c8d4fb32fbb775f186a00809b33f55", "committedDate": "2020-06-29T23:13:12Z", "message": "Fix lint errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e70c3544da4ef4675821405291f6c6969ded21a8", "author": {"user": {"login": "AlanConfluent", "name": "Alan Sheinberg"}}, "url": "https://github.com/confluentinc/ksql/commit/e70c3544da4ef4675821405291f6c6969ded21a8", "committedDate": "2020-06-29T23:13:12Z", "message": "Remove log"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ce5c03ba9b5a969bdab1a0bb84fe87b26de79fd", "author": {"user": {"login": "AlanConfluent", "name": "Alan Sheinberg"}}, "url": "https://github.com/confluentinc/ksql/commit/1ce5c03ba9b5a969bdab1a0bb84fe87b26de79fd", "committedDate": "2020-06-29T23:14:57Z", "message": "Feedback"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6a91385170efc9ce5bd6b3ca3df68f08713a0bd6", "author": {"user": {"login": "AlanConfluent", "name": "Alan Sheinberg"}}, "url": "https://github.com/confluentinc/ksql/commit/6a91385170efc9ce5bd6b3ca3df68f08713a0bd6", "committedDate": "2020-06-19T22:58:03Z", "message": "Feedback"}, "afterCommit": {"oid": "1ce5c03ba9b5a969bdab1a0bb84fe87b26de79fd", "author": {"user": {"login": "AlanConfluent", "name": "Alan Sheinberg"}}, "url": "https://github.com/confluentinc/ksql/commit/1ce5c03ba9b5a969bdab1a0bb84fe87b26de79fd", "committedDate": "2020-06-29T23:14:57Z", "message": "Feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af015f48f917f922926a77f4e794e3faae0bbb56", "author": {"user": {"login": "AlanConfluent", "name": "Alan Sheinberg"}}, "url": "https://github.com/confluentinc/ksql/commit/af015f48f917f922926a77f4e794e3faae0bbb56", "committedDate": "2020-06-29T23:42:31Z", "message": "Bad merge"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8b763fe8f6641c845ccc5a6919e9ba31aa904b4", "author": {"user": {"login": "AlanConfluent", "name": "Alan Sheinberg"}}, "url": "https://github.com/confluentinc/ksql/commit/d8b763fe8f6641c845ccc5a6919e9ba31aa904b4", "committedDate": "2020-06-29T23:58:11Z", "message": "Bad merge part 2"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 236, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}