{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg4MjkzMTk2", "number": 6240, "title": "feat: surface error to user when command topic deleted while server running", "bodyText": "Description\nStacked on top of #6164\nIf the command topic is deleted currently, the command topic consumer in the CommandRunner thread continues to poll the non-existent topic, spamming logs with\nWARN [Consumer clientId=consumer-null-1, groupId=null] Received unknown topic or partition error in fetch for partition _confluent-ksql-default__command_topic-0\n\nPR changes it so that if the command topic doesn't exist, the server enters DEGRADED state and adds warnings to all api requests sent to the /ksql that the command topic was deleted.\nAlso added a new CommandRunnerDegradedReason category to expose this reason in the server metrics.\nTesting done\nStarted up the server, deleted the command topic\nksql> show streams;\n\n Stream Name         | Kafka Topic                 | Format \n------------------------------------------------------------\n KSQL_PROCESSING_LOG | default_ksql_processing_log | JSON   \n------------------------------------------------------------\nWARNING: The server has detected corruption in the command topic due to modifications performed on it.\nDDL statements will not be processed any further.\nIf a backup of the command topic is available, restore the command topic using the backup file.\nA server restart is required to restore full functionality\n\nUsed jconsole to verify the command runner status is DEGRADED and the reason is COMMAND_TOPIC_DELETED\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-09-16T23:16:18Z", "url": "https://github.com/confluentinc/ksql/pull/6240", "merged": true, "mergeCommit": {"oid": "c5d6b56a3188f100ea473ef8f13959da79d1c79e"}, "closed": true, "closedAt": "2020-09-23T06:11:29Z", "author": {"login": "stevenpyzhang"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdJ1EsdgBqjM3NzkyODkyMzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLlROLABqjM3OTYyMzg0NzY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "42da1ea9aa8de7092d9e5624c0c094e2ef7ee7c7", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/42da1ea9aa8de7092d9e5624c0c094e2ef7ee7c7", "committedDate": "2020-09-17T18:11:45Z", "message": "add test"}, "afterCommit": {"oid": "3f33250f2dbed4370eb0ee4514f5be9f4555d5e7", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/3f33250f2dbed4370eb0ee4514f5be9f4555d5e7", "committedDate": "2020-09-17T18:12:24Z", "message": "feat: surface error to user when command topic deleted while server running"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3f33250f2dbed4370eb0ee4514f5be9f4555d5e7", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/3f33250f2dbed4370eb0ee4514f5be9f4555d5e7", "committedDate": "2020-09-17T18:12:24Z", "message": "feat: surface error to user when command topic deleted while server running"}, "afterCommit": {"oid": "39235d4ee23b29fcf6b79bb7d2f82eba4f21c2ec", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/39235d4ee23b29fcf6b79bb7d2f82eba4f21c2ec", "committedDate": "2020-09-18T21:19:47Z", "message": "feat: surface error to user when command topic deleted while server running"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "39235d4ee23b29fcf6b79bb7d2f82eba4f21c2ec", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/39235d4ee23b29fcf6b79bb7d2f82eba4f21c2ec", "committedDate": "2020-09-18T21:19:47Z", "message": "feat: surface error to user when command topic deleted while server running"}, "afterCommit": {"oid": "059b68f6a0f7e58865dce0009bcb2b4c3a3af958", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/059b68f6a0f7e58865dce0009bcb2b4c3a3af958", "committedDate": "2020-09-18T21:21:01Z", "message": "feat: surface error to user when command topic deleted while server running"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e06bfc99fa013c42da60acbf6e6c0d1c7d759b4", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/2e06bfc99fa013c42da60acbf6e6c0d1c7d759b4", "committedDate": "2020-09-21T04:56:49Z", "message": "test commit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "53a47a9a48ad3aa544a908ebb4b26ced31b8385b", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/53a47a9a48ad3aa544a908ebb4b26ced31b8385b", "committedDate": "2020-09-21T04:56:50Z", "message": "refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "085317d3dff1f386e8f1260716d0a2e6abd343b2", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/085317d3dff1f386e8f1260716d0a2e6abd343b2", "committedDate": "2020-09-21T04:57:40Z", "message": "test commit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "deb88e15c93f03161dccbd45bc424d17fbe05f0f", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/deb88e15c93f03161dccbd45bc424d17fbe05f0f", "committedDate": "2020-09-21T04:57:40Z", "message": "refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "04bf50f4fb7a371f61abf983aaadde99dcd918a2", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/04bf50f4fb7a371f61abf983aaadde99dcd918a2", "committedDate": "2020-09-21T04:57:41Z", "message": "feat: surface error to user when command topic deleted while server running"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "059b68f6a0f7e58865dce0009bcb2b4c3a3af958", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/059b68f6a0f7e58865dce0009bcb2b4c3a3af958", "committedDate": "2020-09-18T21:21:01Z", "message": "feat: surface error to user when command topic deleted while server running"}, "afterCommit": {"oid": "04bf50f4fb7a371f61abf983aaadde99dcd918a2", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/04bf50f4fb7a371f61abf983aaadde99dcd918a2", "committedDate": "2020-09-21T04:57:41Z", "message": "feat: surface error to user when command topic deleted while server running"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98e60fad32c9fee69d48c3033851d83f01d6b5f6", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/98e60fad32c9fee69d48c3033851d83f01d6b5f6", "committedDate": "2020-09-21T21:26:19Z", "message": "feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e8a7e23fb4593c05af86d1809b6389b37a660af", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/6e8a7e23fb4593c05af86d1809b6389b37a660af", "committedDate": "2020-09-21T22:33:42Z", "message": "refactor logic in CommandRunner"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f1cbfa9f6c2bf1247cf029317fc0ba8c774360e", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/7f1cbfa9f6c2bf1247cf029317fc0ba8c774360e", "committedDate": "2020-09-21T22:59:45Z", "message": "Merge branch 'fail-backup-corruption' into command-topic-deleted"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f63c88c8e5192d66805852980ae1a4c74bb5b4ab", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/f63c88c8e5192d66805852980ae1a4c74bb5b4ab", "committedDate": "2020-09-22T00:23:31Z", "message": "Merge branch 'master' into command-topic-deleted"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d66b3173fc168da504ab20d9eeb48203c5647aa", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/2d66b3173fc168da504ab20d9eeb48203c5647aa", "committedDate": "2020-09-22T20:21:16Z", "message": "Merge branch 'master' into command-topic-deleted"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "812a4ebc83d14e8ab7b983bc4b26c9c18cc37eb1", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/812a4ebc83d14e8ab7b983bc4b26c9c18cc37eb1", "committedDate": "2020-09-22T20:13:52Z", "message": "Merge branch 'master' into command-topic-deleted"}, "afterCommit": {"oid": "2d66b3173fc168da504ab20d9eeb48203c5647aa", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/2d66b3173fc168da504ab20d9eeb48203c5647aa", "committedDate": "2020-09-22T20:21:16Z", "message": "Merge branch 'master' into command-topic-deleted"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzODM3NjYy", "url": "https://github.com/confluentinc/ksql/pull/6240#pullrequestreview-493837662", "createdAt": "2020-09-22T20:52:39Z", "commit": {"oid": "2d66b3173fc168da504ab20d9eeb48203c5647aa"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMDo1Mjo0MFrOHWL9DQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMTowMjoyNlrOHWMRUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAyNjU3Mw==", "bodyText": "I remember a discussion on the design doc indicated that maybe we don't want to differentiate between corrupted and deleted. What was the decision on that? (also good to document it here for posterity)", "url": "https://github.com/confluentinc/ksql/pull/6240#discussion_r493026573", "createdAt": "2020-09-22T20:52:40Z", "author": {"login": "agavra"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/computation/CommandRunner.java", "diffHunk": "@@ -91,8 +96,9 @@\n \n   public enum CommandRunnerDegradedReason {\n     NONE(errors -> \"\"),\n-    CORRUPTED(Errors:: commandRunnerDegradedBackupCorruptedErrorMessage),\n-    INCOMPATIBLE_COMMAND(Errors:: commandRunnerDegradedIncompatibleCommandsErrorMessage);\n+    CORRUPTED(Errors::commandRunnerDegradedBackupCorruptedErrorMessage),\n+    INCOMPATIBLE_COMMAND(Errors::commandRunnerDegradedIncompatibleCommandsErrorMessage),\n+    COMMAND_TOPIC_DELETED(Errors::commandRunnerDegradedCommandTopicDeletedErrorMessage);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d66b3173fc168da504ab20d9eeb48203c5647aa"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAzMTE2OA==", "bodyText": "we can save this for another PR, but I think it makes sense to have this method return some status then to set a ton of flags and check them in the main loop", "url": "https://github.com/confluentinc/ksql/pull/6240#discussion_r493031168", "createdAt": "2020-09-22T21:01:09Z", "author": {"login": "agavra"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/computation/CommandRunner.java", "diffHunk": "@@ -289,6 +302,9 @@ void fetchAndRunCommands() {\n     lastPollTime.set(clock.instant());\n     final List<QueuedCommand> commands = commandStore.getNewCommands(NEW_CMDS_TIMEOUT);\n     if (commands.isEmpty()) {\n+      if (!commandTopicExists.get()) {\n+        commandTopicDeleted = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d66b3173fc168da504ab20d9eeb48203c5647aa"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAzMTU1NQ==", "bodyText": "does offset reset always mean command topic deleted? it could mean the retention was configured incorrectly perhaps?", "url": "https://github.com/confluentinc/ksql/pull/6240#discussion_r493031555", "createdAt": "2020-09-22T21:01:57Z", "author": {"login": "agavra"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/computation/CommandRunner.java", "diffHunk": "@@ -437,6 +460,13 @@ public void run() {\n         if (!closed) {\n           throw wue;\n         }\n+      } catch (final OffsetOutOfRangeException e) {\n+        LOG.warn(\"The command topic offset was reset. CommandRunner thread exiting.\");\n+        state = new Status(\n+            CommandRunnerStatus.DEGRADED,\n+            CommandRunnerDegradedReason.COMMAND_TOPIC_DELETED", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d66b3173fc168da504ab20d9eeb48203c5647aa"}, "originalPosition": 124}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAzMTc2Mw==", "bodyText": "missing @Test annotation?", "url": "https://github.com/confluentinc/ksql/pull/6240#discussion_r493031763", "createdAt": "2020-09-22T21:02:26Z", "author": {"login": "agavra"}, "path": "ksqldb-rest-app/src/test/java/io/confluent/ksql/rest/server/computation/CommandRunnerTest.java", "diffHunk": "@@ -524,6 +549,25 @@ public void shouldCloseEarlyWhenSerializationExceptionInFetch() throws Exception\n     inOrder.verify(commandStore).close();\n   }\n \n+  public void shouldCloseEarlyWhenOffsetOutOfRangeException() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d66b3173fc168da504ab20d9eeb48203c5647aa"}, "originalPosition": 78}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ec87c075a61ef906bd12b387217de12f45f2cef", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/1ec87c075a61ef906bd12b387217de12f45f2cef", "committedDate": "2020-09-22T21:48:29Z", "message": "update error messages"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzOTA0ODUz", "url": "https://github.com/confluentinc/ksql/pull/6240#pullrequestreview-493904853", "createdAt": "2020-09-22T23:06:07Z", "commit": {"oid": "1ec87c075a61ef906bd12b387217de12f45f2cef"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMzowNjowN1rOHWPUqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMzowNjowN1rOHWPUqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA4MTc3MA==", "bodyText": "How is this different than corrupted? We're leaking an implementation detail of how we detect corruption here. The underlying condition is the same - the command topic isn't in the state that the system expects.", "url": "https://github.com/confluentinc/ksql/pull/6240#discussion_r493081770", "createdAt": "2020-09-22T23:06:07Z", "author": {"login": "rodesai"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/computation/CommandRunner.java", "diffHunk": "@@ -91,8 +96,10 @@\n \n   public enum CommandRunnerDegradedReason {\n     NONE(errors -> \"\"),\n-    CORRUPTED(Errors:: commandRunnerDegradedBackupCorruptedErrorMessage),\n-    INCOMPATIBLE_COMMAND(Errors:: commandRunnerDegradedIncompatibleCommandsErrorMessage);\n+    CORRUPTED(Errors::commandRunnerDegradedBackupCorruptedErrorMessage),\n+    INCOMPATIBLE_COMMAND(Errors::commandRunnerDegradedIncompatibleCommandsErrorMessage),\n+    COMMAND_TOPIC_DELETED_OR_MODIFIED(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ec87c075a61ef906bd12b387217de12f45f2cef"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0368e77d39ca15908756509d2cc4e5c0efa7fbd3", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/0368e77d39ca15908756509d2cc4e5c0efa7fbd3", "committedDate": "2020-09-23T04:55:32Z", "message": "combine corrupted and command topic missing degraded reason"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1445238434c4a4edcec5385191400ee9d8cff777", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/1445238434c4a4edcec5385191400ee9d8cff777", "committedDate": "2020-09-23T04:49:38Z", "message": "combine corrupted and command topic missing degraded reason"}, "afterCommit": {"oid": "0368e77d39ca15908756509d2cc4e5c0efa7fbd3", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/0368e77d39ca15908756509d2cc4e5c0efa7fbd3", "committedDate": "2020-09-23T04:55:32Z", "message": "combine corrupted and command topic missing degraded reason"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4658, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}