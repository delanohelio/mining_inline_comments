{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY5MDEzMjE2", "number": 6036, "title": "feat: Support for IF EXISTS on CREATE CONNECTOR", "bodyText": "Fixes #5992\nDescription\nAdded IF EXISTS to the create connector portion of the grammar and made necessary code changes ,\nBasically added a check in ConnectExecutor , to call /connectors endpoint and find if connector is already created\nTesting done\nAdded unit tests and did manual testing\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-08-17T18:58:35Z", "url": "https://github.com/confluentinc/ksql/pull/6036", "merged": true, "mergeCommit": {"oid": "8466197627bd6f15616c7668180111380e073dcc"}, "closed": true, "closedAt": "2020-09-11T10:22:54Z", "author": {"login": "hemantgs"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc_4zcTgFqTQ2ODgyNTUzNg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHyrW5gFqTQ4NjY4MzYyOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4ODI1NTM2", "url": "https://github.com/confluentinc/ksql/pull/6036#pullrequestreview-468825536", "createdAt": "2020-08-17T20:54:11Z", "commit": {"oid": "d2caca1ebb633f3b304b5abf4cbc68af40c02cba"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5MTM4MjYz", "url": "https://github.com/confluentinc/ksql/pull/6036#pullrequestreview-469138263", "createdAt": "2020-08-18T09:10:53Z", "commit": {"oid": "d2caca1ebb633f3b304b5abf4cbc68af40c02cba"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwOToxMDo1M1rOHCKpHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwOToyMToyMlrOHCLBnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjAzMzU2Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            CREATE SOURCE | SINK CONNECTOR connector_name [IF EXISTS] WITH( property_name = expression [, ...]);\n          \n          \n            \n            CREATE SOURCE | SINK CONNECTOR connector_name [IF NOT EXISTS] WITH( property_name = expression [, ...]);", "url": "https://github.com/confluentinc/ksql/pull/6036#discussion_r472033566", "createdAt": "2020-08-18T09:10:53Z", "author": {"login": "big-andy-coates"}, "path": "docs/developer-guide/ksqldb-reference/create-connector.md", "diffHunk": "@@ -13,7 +13,7 @@ Synopsis\n --------\r\n \r\n ```sql\r\n-CREATE SOURCE | SINK CONNECTOR connector_name WITH( property_name = expression [, ...]);\r\n+CREATE SOURCE | SINK CONNECTOR connector_name [IF EXISTS] WITH( property_name = expression [, ...]);\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2caca1ebb633f3b304b5abf4cbc68af40c02cba"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjAzMzcyNA==", "bodyText": "Note sure why this talks about types and them not existing. Isn't this about connectors that do exist?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            If the IF EXISTS clause is present, the statement doesn't fail if the\n          \n          \n            \n            type doesn't exist.\n          \n          \n            \n            \n          \n          \n            \n            If the `IF NOT EXISTS` clause is present, the statement does nothing if a connector with the supplied name already exists.\n          \n          \n            \n            \n          \n      \n    \n    \n  \n\n??", "url": "https://github.com/confluentinc/ksql/pull/6036#discussion_r472033724", "createdAt": "2020-08-18T09:11:11Z", "author": {"login": "big-andy-coates"}, "path": "docs/developer-guide/ksqldb-reference/create-connector.md", "diffHunk": "@@ -24,6 +24,9 @@ configuration passed in the WITH clause. Some connectors have ksqlDB templates\n that simplify configuring them. For more information, see\r\n [Natively Supported Connectors](../../concepts/connectors.md#natively-supported-connectors).\r\n \r\n+If the IF EXISTS clause is present, the statement doesn't fail if the\r\n+type doesn't exist.\r\n+\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2caca1ebb633f3b304b5abf4cbc68af40c02cba"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjAzNDg4OQ==", "bodyText": "Needs adding to hashCode, equals and toString.", "url": "https://github.com/confluentinc/ksql/pull/6036#discussion_r472034889", "createdAt": "2020-08-18T09:13:07Z", "author": {"login": "big-andy-coates"}, "path": "ksqldb-parser/src/main/java/io/confluent/ksql/parser/tree/CreateConnector.java", "diffHunk": "@@ -34,32 +34,41 @@\n   private final String name;\n   private final ImmutableMap<String, Literal> config;\n   private final Type type;\n+  private final boolean notExists;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2caca1ebb633f3b304b5abf4cbc68af40c02cba"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjAzNTc2OA==", "bodyText": "Please add test case on the end:\n.addEqualityGroup(\n   new CreateConnector(NAME, CONFIG, CreateConnector.Type.SINK, true)\n)\nThis would have found the bug of not having this new field in hashCode and equals :D", "url": "https://github.com/confluentinc/ksql/pull/6036#discussion_r472035768", "createdAt": "2020-08-18T09:14:31Z", "author": {"login": "big-andy-coates"}, "path": "ksqldb-parser/src/test/java/io/confluent/ksql/parser/tree/CreateConnectorTest.java", "diffHunk": "@@ -39,18 +39,18 @@\n   public void testEquals() {\n     new EqualsTester()\n         .addEqualityGroup(\n-            new CreateConnector(Optional.of(SOME_LOCATION), NAME, CONFIG, CreateConnector.Type.SOURCE),\n-            new CreateConnector(Optional.of(OTHER_LOCATION), NAME, CONFIG, CreateConnector.Type.SOURCE),\n-            new CreateConnector(NAME, CONFIG, CreateConnector.Type.SOURCE)\n+            new CreateConnector(Optional.of(SOME_LOCATION), NAME, CONFIG, CreateConnector.Type.SOURCE,false),\n+            new CreateConnector(Optional.of(OTHER_LOCATION), NAME, CONFIG, CreateConnector.Type.SOURCE,false),\n+            new CreateConnector(NAME, CONFIG, CreateConnector.Type.SOURCE,false)\n         )\n         .addEqualityGroup(\n-            new CreateConnector(OTHER_NAME, CONFIG, CreateConnector.Type.SOURCE)\n+            new CreateConnector(OTHER_NAME, CONFIG, CreateConnector.Type.SOURCE,false)\n         )\n         .addEqualityGroup(\n-            new CreateConnector(NAME, OTHER_CONFIG, CreateConnector.Type.SOURCE)\n+            new CreateConnector(NAME, OTHER_CONFIG, CreateConnector.Type.SOURCE,false)\n         )\n         .addEqualityGroup(\n-            new CreateConnector(NAME, CONFIG, CreateConnector.Type.SINK)\n+            new CreateConnector(NAME, CONFIG, CreateConnector.Type.SINK,false)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2caca1ebb633f3b304b5abf4cbc68af40c02cba"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjAzNTk3MA==", "bodyText": "nit: code style: need space after ,:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        new CreateConnector(Optional.of(SOME_LOCATION), NAME, CONFIG, CreateConnector.Type.SOURCE,false),\n          \n          \n            \n                        new CreateConnector(Optional.of(SOME_LOCATION), NAME, CONFIG, CreateConnector.Type.SOURCE, false),\n          \n      \n    \n    \n  \n\nSame for others below.", "url": "https://github.com/confluentinc/ksql/pull/6036#discussion_r472035970", "createdAt": "2020-08-18T09:14:51Z", "author": {"login": "big-andy-coates"}, "path": "ksqldb-parser/src/test/java/io/confluent/ksql/parser/tree/CreateConnectorTest.java", "diffHunk": "@@ -39,18 +39,18 @@\n   public void testEquals() {\n     new EqualsTester()\n         .addEqualityGroup(\n-            new CreateConnector(Optional.of(SOME_LOCATION), NAME, CONFIG, CreateConnector.Type.SOURCE),\n-            new CreateConnector(Optional.of(OTHER_LOCATION), NAME, CONFIG, CreateConnector.Type.SOURCE),\n-            new CreateConnector(NAME, CONFIG, CreateConnector.Type.SOURCE)\n+            new CreateConnector(Optional.of(SOME_LOCATION), NAME, CONFIG, CreateConnector.Type.SOURCE,false),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2caca1ebb633f3b304b5abf4cbc68af40c02cba"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjAzODU0Ng==", "bodyText": "bug: doesn't this need to be reversed?   This returns true if the user included IF NOT EXIST in the statement.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (createConnector.isNotExists()) {\n          \n          \n            \n                if (!createConnector.isNotExists()) {", "url": "https://github.com/confluentinc/ksql/pull/6036#discussion_r472038546", "createdAt": "2020-08-18T09:19:13Z", "author": {"login": "big-andy-coates"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/execution/ConnectExecutor.java", "diffHunk": "@@ -62,4 +68,30 @@ private ConnectExecutor() { }\n     return response.error()\n         .map(err -> new ErrorEntity(statement.getStatementText(), err));\n   }\n+\n+  private static void throwIfConnectorIsDuplicate(final CreateConnector createConnector,\n+      final ConnectClient client) {\n+    if (createConnector.isNotExists()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2caca1ebb633f3b304b5abf4cbc68af40c02cba"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjAzOTgzNg==", "bodyText": "The Optional<String> return value of this is not needed. A simple boolean would suffice.  Also, it looks like you're ignoring any connect error.  If the response returns an error we probably want to bubble that up, right?   The code handles errors by doing this:\nreturn response.error()\n        .map(err -> new ErrorEntity(statement.getStatementText(), err));\nYou'll need to do something similar if the connectors call fails.  You could do this by throwing an exception that holds the ErrorEntity, or by combining checkConnectorExists and throwIfConnectorIsDuplicate together and have throwIfConnectorIsDuplicate return an Optional<ErrorEntity>. Either works.", "url": "https://github.com/confluentinc/ksql/pull/6036#discussion_r472039836", "createdAt": "2020-08-18T09:21:22Z", "author": {"login": "big-andy-coates"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/execution/ConnectExecutor.java", "diffHunk": "@@ -62,4 +68,30 @@ private ConnectExecutor() { }\n     return response.error()\n         .map(err -> new ErrorEntity(statement.getStatementText(), err));\n   }\n+\n+  private static void throwIfConnectorIsDuplicate(final CreateConnector createConnector,\n+      final ConnectClient client) {\n+    if (createConnector.isNotExists()) {\n+      checkConnectorExists(client, createConnector)\n+          .ifPresent(connector -> {\n+            throw new KsqlException(String.format(\n+                \"Cannot add connector '%s': A connector with the same name already exists\",\n+                connector));\n+          });\n+    }\n+  }\n+\n+  private static Optional<String> checkConnectorExists(final ConnectClient client,\n+      final CreateConnector createConnector) {\n+    final ConnectResponse<List<String>> connectorsResponse = client.connectors();\n+    if (connectorsResponse.datum().isPresent()) {\n+      return connectorsResponse.datum()\n+          .get()\n+          .stream()\n+          .filter(connector -> StringUtils.equalsIgnoreCase(createConnector.getName(), connector))\n+          .findAny();\n+    }\n+    return Optional.empty();\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2caca1ebb633f3b304b5abf4cbc68af40c02cba"}, "originalPosition": 55}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d2caca1ebb633f3b304b5abf4cbc68af40c02cba", "author": {"user": {"login": "hemantgs", "name": null}}, "url": "https://github.com/confluentinc/ksql/commit/d2caca1ebb633f3b304b5abf4cbc68af40c02cba", "committedDate": "2020-08-17T18:48:09Z", "message": "feat: Support for IF EXISTS on CREATE CONNECTOR\n\nAdded doc changes"}, "afterCommit": {"oid": "131980eeb9d99bef98b2d6ada9c3b3b75e3f25cb", "author": {"user": {"login": "hemantgs", "name": null}}, "url": "https://github.com/confluentinc/ksql/commit/131980eeb9d99bef98b2d6ada9c3b3b75e3f25cb", "committedDate": "2020-08-18T12:01:13Z", "message": "feat: Support for IF NOT EXISTS on CREATE CONNECTOR\n\nAdded doc changes\n\nReworked error handling"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwNjg3Njc5", "url": "https://github.com/confluentinc/ksql/pull/6036#pullrequestreview-470687679", "createdAt": "2020-08-19T17:26:46Z", "commit": {"oid": "131980eeb9d99bef98b2d6ada9c3b3b75e3f25cb"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNzoyNjo0NlrOHDSBBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNzo1NDoxOVrOHDS-MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIwMjk1MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            CREATE SOURCE | SINK CONNECTOR connector_name [IF NOT EXISTS] WITH( property_name = expression [, ...]);\n          \n          \n            \n            CREATE SOURCE | SINK CONNECTOR [IF NOT EXISTS] connector_name WITH( property_name = expression [, ...]);", "url": "https://github.com/confluentinc/ksql/pull/6036#discussion_r473202950", "createdAt": "2020-08-19T17:26:46Z", "author": {"login": "spena"}, "path": "docs/developer-guide/ksqldb-reference/create-connector.md", "diffHunk": "@@ -13,7 +13,7 @@ Synopsis\n --------\r\n \r\n ```sql\r\n-CREATE SOURCE | SINK CONNECTOR connector_name WITH( property_name = expression [, ...]);\r\n+CREATE SOURCE | SINK CONNECTOR connector_name [IF NOT EXISTS] WITH( property_name = expression [, ...]);\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "131980eeb9d99bef98b2d6ada9c3b3b75e3f25cb"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIwNDQwMg==", "bodyText": "Contrary, if the IF NOT EXISTS clause is present, the statement doesn't fail if the connector already exists.", "url": "https://github.com/confluentinc/ksql/pull/6036#discussion_r473204402", "createdAt": "2020-08-19T17:29:29Z", "author": {"login": "spena"}, "path": "docs/developer-guide/ksqldb-reference/create-connector.md", "diffHunk": "@@ -24,6 +24,9 @@ configuration passed in the WITH clause. Some connectors have ksqlDB templates\n that simplify configuring them. For more information, see\r\n [Natively Supported Connectors](../../concepts/connectors.md#natively-supported-connectors).\r\n \r\n+If the IF NOT EXISTS clause is present, the statement will fail if a connector with the supplied name\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "131980eeb9d99bef98b2d6ada9c3b3b75e3f25cb"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIxODYwOQ==", "bodyText": "If the IF NOT EXISTS is set, then it should not cause an error if the connector already exists. Btw, I found out the CREATE STREAM|TABLE IF NOT EXISTS does not work as expected either (#6050).", "url": "https://github.com/confluentinc/ksql/pull/6036#discussion_r473218609", "createdAt": "2020-08-19T17:54:19Z", "author": {"login": "spena"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/execution/ConnectExecutor.java", "diffHunk": "@@ -62,4 +68,30 @@ private ConnectExecutor() { }\n     return response.error()\n         .map(err -> new ErrorEntity(statement.getStatementText(), err));\n   }\n+\n+  private static void throwIfConnectorIsDuplicate(final CreateConnector createConnector,\n+      final ConnectClient client) {\n+    if (createConnector.isNotExists()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjAzODU0Ng=="}, "originalCommit": {"oid": "d2caca1ebb633f3b304b5abf4cbc68af40c02cba"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyMzU3NDE5", "url": "https://github.com/confluentinc/ksql/pull/6036#pullrequestreview-472357419", "createdAt": "2020-08-21T09:50:39Z", "commit": {"oid": "131980eeb9d99bef98b2d6ada9c3b3b75e3f25cb"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQwOTo1MDozOVrOHEm8dA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQxMDowMjoyOVrOHEnYUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDU5NDQyMA==", "bodyText": "The default functionality, without IF NOT EXISTS would be to fail if a connector with the same name already exists.  (I'm assuming the Connect API would return some kind of 'already exists' error). Adding the IF NOT EXISTS syntax should mean it does NOT fail if the connector exists, instead it should be a no-op.  Hence the logic should be:\nvoid create(...) {\n\n   if (stmt.ifNotExists() && connectorExists(stmt.connectorName()) {\n      // Connector exists already:\n      return;\n   }\n\n   addConnector(stmt);\n}\nOf course, this would suffer from a race condition: the connector could be added by another system between the connectorExists check and the addConnector call.  So really, we also need the addConnector call to gracefully handle the already exists error we get back from the Connect client, and if we're handling than, is there really any point in the connectExists call?   Hence the code could just be:\nvoid create(...) {\n   final ConnectResponse<ConnectorInfo> response = client.create(...);\n   if (response.datum().isPresent()) {\n      return success(...);\n   }\n\n   if (stmt.ifNotExists()) {\n      // somehow determine if the error was because the connector already existed with that name\n      // hopefully this is possible by looking at the http status code, maybe its 409. Not sure.\n      // Otherwise, we'd have to search the error message, which is brittle and we'd need an integration\n      // test to ensure changes to Connect error message don't break this: \n      if (isAlreadyExisttsError(response)) {\n         return alreadyExists(...);\n      }\n   }\n\n   return response.error() \n        .map(err -> new ErrorEntity(statement.getStatementText(), err));\t        .map(err -> new ErrorEntity(statement.getStatementText(), err));\nNote, that's just pseudo code. I've no idea what the client does if the connector already exists.\nNote2:it might help if the method isNotExists was renamed to onlyIfNotExists or ifNotExists or reversed and named ignoreIfExists, as isNotExists is .... confusing... at least to me.", "url": "https://github.com/confluentinc/ksql/pull/6036#discussion_r474594420", "createdAt": "2020-08-21T09:50:39Z", "author": {"login": "big-andy-coates"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/execution/ConnectExecutor.java", "diffHunk": "@@ -62,4 +68,30 @@ private ConnectExecutor() { }\n     return response.error()\n         .map(err -> new ErrorEntity(statement.getStatementText(), err));\n   }\n+\n+  private static void throwIfConnectorIsDuplicate(final CreateConnector createConnector,\n+      final ConnectClient client) {\n+    if (createConnector.isNotExists()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjAzODU0Ng=="}, "originalCommit": {"oid": "d2caca1ebb633f3b304b5abf4cbc68af40c02cba"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDU5NjEzNQ==", "bodyText": "nit: only need one new equality group.  Each equality group should change one param only, compared to the first equality group.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    .addEqualityGroup(\n          \n          \n            \n                        new CreateConnector(NAME, CONFIG, CreateConnector.Type.SINK, true)\n          \n          \n            \n                    )\n          \n          \n            \n                    .addEqualityGroup(\n          \n          \n            \n                        new CreateConnector(NAME, CONFIG, CreateConnector.Type.SOURCE, true)\n          \n          \n            \n                    .addEqualityGroup(\n          \n          \n            \n                        new CreateConnector(NAME, CONFIG, CreateConnector.Type.SOURCE, true)", "url": "https://github.com/confluentinc/ksql/pull/6036#discussion_r474596135", "createdAt": "2020-08-21T09:52:22Z", "author": {"login": "big-andy-coates"}, "path": "ksqldb-parser/src/test/java/io/confluent/ksql/parser/tree/CreateConnectorTest.java", "diffHunk": "@@ -39,18 +39,24 @@\n   public void testEquals() {\n     new EqualsTester()\n         .addEqualityGroup(\n-            new CreateConnector(Optional.of(SOME_LOCATION), NAME, CONFIG, CreateConnector.Type.SOURCE),\n-            new CreateConnector(Optional.of(OTHER_LOCATION), NAME, CONFIG, CreateConnector.Type.SOURCE),\n-            new CreateConnector(NAME, CONFIG, CreateConnector.Type.SOURCE)\n+            new CreateConnector(Optional.of(SOME_LOCATION), NAME, CONFIG, CreateConnector.Type.SOURCE, false),\n+            new CreateConnector(Optional.of(OTHER_LOCATION), NAME, CONFIG, CreateConnector.Type.SOURCE, false),\n+            new CreateConnector(NAME, CONFIG, CreateConnector.Type.SOURCE, false)\n         )\n         .addEqualityGroup(\n-            new CreateConnector(OTHER_NAME, CONFIG, CreateConnector.Type.SOURCE)\n+            new CreateConnector(OTHER_NAME, CONFIG, CreateConnector.Type.SOURCE, false)\n         )\n         .addEqualityGroup(\n-            new CreateConnector(NAME, OTHER_CONFIG, CreateConnector.Type.SOURCE)\n+            new CreateConnector(NAME, OTHER_CONFIG, CreateConnector.Type.SOURCE, false)\n         )\n         .addEqualityGroup(\n-            new CreateConnector(NAME, CONFIG, CreateConnector.Type.SINK)\n+            new CreateConnector(NAME, CONFIG, CreateConnector.Type.SINK, false)\n+        )\n+        .addEqualityGroup(\n+            new CreateConnector(NAME, CONFIG, CreateConnector.Type.SINK, true)\n+        )\n+        .addEqualityGroup(\n+            new CreateConnector(NAME, CONFIG, CreateConnector.Type.SOURCE, true)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "131980eeb9d99bef98b2d6ada9c3b3b75e3f25cb"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDYwMTUxNA==", "bodyText": "I'm not sure we want to throw an exception here. I think we need to return an ErrorEntity from the execute method - as the existing code does on an error.", "url": "https://github.com/confluentinc/ksql/pull/6036#discussion_r474601514", "createdAt": "2020-08-21T10:02:23Z", "author": {"login": "big-andy-coates"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/execution/ConnectExecutor.java", "diffHunk": "@@ -62,4 +68,30 @@ private ConnectExecutor() { }\n     return response.error()\n         .map(err -> new ErrorEntity(statement.getStatementText(), err));\n   }\n+\n+  private static void throwIfConnectorIsDuplicate(\n+      final CreateConnector createConnector,\n+      final ConnectClient client,\n+      final ConfiguredStatement<CreateConnector> statement\n+  ) {\n+    if (createConnector.isNotExists()) {\n+\n+      final ConnectResponse<List<String>> connectorsResponse = client.connectors();\n+\n+      connectorsResponse.error().ifPresent(err -> {\n+        throw new KsqlException(new ErrorEntity(statement.getStatementText(), err).toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "131980eeb9d99bef98b2d6ada9c3b3b75e3f25cb"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDYwMTU1NA==", "bodyText": "as above, I'm not sure we want to throw an exception here. I think we need to return an ErrorEntity from the execute method - as the existing code does on an error.", "url": "https://github.com/confluentinc/ksql/pull/6036#discussion_r474601554", "createdAt": "2020-08-21T10:02:29Z", "author": {"login": "big-andy-coates"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/execution/ConnectExecutor.java", "diffHunk": "@@ -62,4 +68,30 @@ private ConnectExecutor() { }\n     return response.error()\n         .map(err -> new ErrorEntity(statement.getStatementText(), err));\n   }\n+\n+  private static void throwIfConnectorIsDuplicate(\n+      final CreateConnector createConnector,\n+      final ConnectClient client,\n+      final ConfiguredStatement<CreateConnector> statement\n+  ) {\n+    if (createConnector.isNotExists()) {\n+\n+      final ConnectResponse<List<String>> connectorsResponse = client.connectors();\n+\n+      connectorsResponse.error().ifPresent(err -> {\n+        throw new KsqlException(new ErrorEntity(statement.getStatementText(), err).toString());\n+      });\n+\n+      connectorsResponse.datum()\n+          .get()\n+          .stream()\n+          .filter(connector -> StringUtils.equalsIgnoreCase(createConnector.getName(), connector))\n+          .findAny()\n+          .ifPresent(connector -> {\n+            throw new KsqlException(String.format(\n+                \"Cannot add connector '%s': A connector with the same name already exists\",\n+                connector));\n+          });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "131980eeb9d99bef98b2d6ada9c3b3b75e3f25cb"}, "originalPosition": 54}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "131980eeb9d99bef98b2d6ada9c3b3b75e3f25cb", "author": {"user": {"login": "hemantgs", "name": null}}, "url": "https://github.com/confluentinc/ksql/commit/131980eeb9d99bef98b2d6ada9c3b3b75e3f25cb", "committedDate": "2020-08-18T12:01:13Z", "message": "feat: Support for IF NOT EXISTS on CREATE CONNECTOR\n\nAdded doc changes\n\nReworked error handling"}, "afterCommit": {"oid": "11e664dde6f943fd7f2f41210a28027923c3f74b", "author": {"user": {"login": "hemantgs", "name": null}}, "url": "https://github.com/confluentinc/ksql/commit/11e664dde6f943fd7f2f41210a28027923c3f74b", "committedDate": "2020-08-25T15:56:49Z", "message": "feat: Support for IF NOT EXISTS on CREATE CONNECTOR\n\nAdded doc changes\n\nReworked error handling\n\nFixed review comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "11e664dde6f943fd7f2f41210a28027923c3f74b", "author": {"user": {"login": "hemantgs", "name": null}}, "url": "https://github.com/confluentinc/ksql/commit/11e664dde6f943fd7f2f41210a28027923c3f74b", "committedDate": "2020-08-25T15:56:49Z", "message": "feat: Support for IF NOT EXISTS on CREATE CONNECTOR\n\nAdded doc changes\n\nReworked error handling\n\nFixed review comments"}, "afterCommit": {"oid": "87a57929f92fc93ee2993126fa7a54495fa3b7d4", "author": {"user": {"login": "hemantgs", "name": null}}, "url": "https://github.com/confluentinc/ksql/commit/87a57929f92fc93ee2993126fa7a54495fa3b7d4", "committedDate": "2020-08-25T15:58:31Z", "message": "feat: Support for IF NOT EXISTS on CREATE CONNECTOR\n\nAdded doc changes\n\nReworked error handling\n\nFixed review comments\n\nTypo fixed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0Njc3ODg4", "url": "https://github.com/confluentinc/ksql/pull/6036#pullrequestreview-474677888", "createdAt": "2020-08-25T17:00:57Z", "commit": {"oid": "87a57929f92fc93ee2993126fa7a54495fa3b7d4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNzowMDo1N1rOHGhWiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNzowMDo1N1rOHGhWiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU5OTk0Nw==", "bodyText": "I think we should check if the connector exists before attempting to call the client.create, and only if ifNotExists is true. I noticed the client.create() code retries up to 3 times in the following cases:\n.retryIfResult(\n              result -> result == null\n                  || result.httpCode() >= HttpStatus.SC_INTERNAL_SERVER_ERROR\n                  || result.httpCode() == HttpStatus.SC_CONFLICT)\n\nThere's no need to retry if the connector exists, right? Better just check if it exists to keep this command faster, then return the WarningEntity, otherwise try the create.", "url": "https://github.com/confluentinc/ksql/pull/6036#discussion_r476599947", "createdAt": "2020-08-25T17:00:57Z", "author": {"login": "spena"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/execution/ConnectExecutor.java", "diffHunk": "@@ -59,6 +62,11 @@ private ConnectExecutor() { }\n       );\n     }\n \n+    if (createConnector.ifNotExists() && response.httpCode() == HttpStatus.SC_CONFLICT) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "87a57929f92fc93ee2993126fa7a54495fa3b7d4"}, "originalPosition": 25}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "87a57929f92fc93ee2993126fa7a54495fa3b7d4", "author": {"user": {"login": "hemantgs", "name": null}}, "url": "https://github.com/confluentinc/ksql/commit/87a57929f92fc93ee2993126fa7a54495fa3b7d4", "committedDate": "2020-08-25T15:58:31Z", "message": "feat: Support for IF NOT EXISTS on CREATE CONNECTOR\n\nAdded doc changes\n\nReworked error handling\n\nFixed review comments\n\nTypo fixed"}, "afterCommit": {"oid": "c2b023cc6e463f6423fa5f80e10ea2450de0813d", "author": {"user": {"login": "hemantgs", "name": null}}, "url": "https://github.com/confluentinc/ksql/commit/c2b023cc6e463f6423fa5f80e10ea2450de0813d", "committedDate": "2020-08-25T18:52:14Z", "message": "feat: Support for IF NOT EXISTS on CREATE CONNECTOR\n\nAdded doc changes\n\nReworked error handling\n\nFixed review comments\n\nTypo fixed\n\nreview comments fixed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5ODU2ODgy", "url": "https://github.com/confluentinc/ksql/pull/6036#pullrequestreview-479856882", "createdAt": "2020-09-01T15:22:13Z", "commit": {"oid": "c2b023cc6e463f6423fa5f80e10ea2450de0813d"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxNToyMjoxNFrOHK7wnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxNToyNTo1M1rOHK76XQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTIyNjkwOA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                return null;\n          \n          \n            \n                return Optional.empty();", "url": "https://github.com/confluentinc/ksql/pull/6036#discussion_r481226908", "createdAt": "2020-09-01T15:22:14Z", "author": {"login": "big-andy-coates"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/execution/ConnectExecutor.java", "diffHunk": "@@ -59,7 +71,43 @@ private ConnectExecutor() { }\n       );\n     }\n \n+    if (createConnector.ifNotExists() && response.httpCode() == HttpStatus.SC_CONFLICT) {\n+      return Optional.of(new WarningEntity(statement.getStatementText(),\n+          String.format(\"Connector %s already exists\", createConnector.getName())));\n+    }\n+\n     return response.error()\n         .map(err -> new ErrorEntity(statement.getStatementText(), err));\n   }\n+\n+  private static Optional<KsqlEntity> handleIfNotExists(\n+      final ConfiguredStatement<CreateConnector> statement,\n+      final CreateConnector createConnector,\n+      final ConnectClient client) {\n+    if (createConnector.ifNotExists()) {\n+      final ConnectResponse<List<String>> connectorsResponse = client.connectors();\n+      if (connectorsResponse.error().isPresent()) {\n+        return connectorsResponse.error()\n+            .map(err -> new ErrorEntity(statement.getStatementText(), err));\n+      }\n+\n+      if (checkIfConnectorExists(createConnector, connectorsResponse)) {\n+        return Optional.of(new WarningEntity(statement.getStatementText(),\n+            String.format(\"Connector %s already exists\", createConnector.getName())));\n+      }\n+    }\n+    return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2b023cc6e463f6423fa5f80e10ea2450de0813d"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTIyNzEzMA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (connectorsResponse != null) {\n          \n          \n            \n                if (connectorsResponse.isPresent()) {", "url": "https://github.com/confluentinc/ksql/pull/6036#discussion_r481227130", "createdAt": "2020-09-01T15:22:35Z", "author": {"login": "big-andy-coates"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/execution/ConnectExecutor.java", "diffHunk": "@@ -43,6 +49,12 @@ private ConnectExecutor() { }\n     final CreateConnector createConnector = statement.getStatement();\n     final ConnectClient client = serviceContext.getConnectClient();\n \n+    final Optional<KsqlEntity> connectorsResponse = handleIfNotExists(\n+        statement, createConnector, client);\n+    if (connectorsResponse != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2b023cc6e463f6423fa5f80e10ea2450de0813d"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTIyOTQwNQ==", "bodyText": "Should be sufficient to check if the connector now exists, e.g .\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (createConnector.ifNotExists() && response.httpCode() == HttpStatus.SC_CONFLICT) {\n          \n          \n            \n                  return Optional.of(new WarningEntity(statement.getStatementText(),\n          \n          \n            \n                      String.format(\"Connector %s already exists\", createConnector.getName())));\n          \n          \n            \n                }\n          \n          \n            \n                if (createConnector.ifNotExists()) {\n          \n          \n            \n                  // Check again to see if above call failed because someone else created the same connector:\n          \n          \n            \n                  final Optional<KsqlEntity> connectorsResponse = handleIfNotExists(statement, createConnector, client);\n          \n          \n            \n                  if (connectorsResponse.isPresent()) {\n          \n          \n            \n                     return connectorsResponse.get();\n          \n          \n            \n                  }\n          \n          \n            \n                }", "url": "https://github.com/confluentinc/ksql/pull/6036#discussion_r481229405", "createdAt": "2020-09-01T15:25:53Z", "author": {"login": "big-andy-coates"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/execution/ConnectExecutor.java", "diffHunk": "@@ -59,7 +71,43 @@ private ConnectExecutor() { }\n       );\n     }\n \n+    if (createConnector.ifNotExists() && response.httpCode() == HttpStatus.SC_CONFLICT) {\n+      return Optional.of(new WarningEntity(statement.getStatementText(),\n+          String.format(\"Connector %s already exists\", createConnector.getName())));\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2b023cc6e463f6423fa5f80e10ea2450de0813d"}, "originalPosition": 44}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9ff4150ca118ee0c2717f21721cde2ffa817904", "author": {"user": {"login": "hemantgs", "name": null}}, "url": "https://github.com/confluentinc/ksql/commit/d9ff4150ca118ee0c2717f21721cde2ffa817904", "committedDate": "2020-09-02T15:28:32Z", "message": "feat: Support for IF NOT EXISTS on CREATE CONNECTOR\n\nAdded doc changes\n\nReworked error handling\n\nFixed review comments\n\nTypo fixed\n\nreview comments fixed\n\nAdded integration tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c2b023cc6e463f6423fa5f80e10ea2450de0813d", "author": {"user": {"login": "hemantgs", "name": null}}, "url": "https://github.com/confluentinc/ksql/commit/c2b023cc6e463f6423fa5f80e10ea2450de0813d", "committedDate": "2020-08-25T18:52:14Z", "message": "feat: Support for IF NOT EXISTS on CREATE CONNECTOR\n\nAdded doc changes\n\nReworked error handling\n\nFixed review comments\n\nTypo fixed\n\nreview comments fixed"}, "afterCommit": {"oid": "d9ff4150ca118ee0c2717f21721cde2ffa817904", "author": {"user": {"login": "hemantgs", "name": null}}, "url": "https://github.com/confluentinc/ksql/commit/d9ff4150ca118ee0c2717f21721cde2ffa817904", "committedDate": "2020-09-02T15:28:32Z", "message": "feat: Support for IF NOT EXISTS on CREATE CONNECTOR\n\nAdded doc changes\n\nReworked error handling\n\nFixed review comments\n\nTypo fixed\n\nreview comments fixed\n\nAdded integration tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2NjgzNjI4", "url": "https://github.com/confluentinc/ksql/pull/6036#pullrequestreview-486683628", "createdAt": "2020-09-11T10:17:19Z", "commit": {"oid": "d9ff4150ca118ee0c2717f21721cde2ffa817904"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4698, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}