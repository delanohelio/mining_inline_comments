{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk3NTAxMzE0", "number": 4977, "title": "fix: generated aliases for struct field access no longer require quoting", "bodyText": "Description\nfixes: #4911\nWith this change there will no longer be the need to quote the column names generated for struct fields, unless the struct field name itself requires quoting. For example:\nSELECT someStruct->mapOfStructsField['someKey']->arrayOfStructsFields[10]->someField FROM FOO;\nPreviously the above would generate a column name that would require quoting to be used: SOMESTRUCT__MAPOFSTRUCTSFIELD['someKey']__ARRAYOFSTRUCTSFIELD[10]__SOMEFIELD. It will now generate the name SOMEFIELD.\nBREAKING CHANGE: This commit changes the system generated column name for any columns in projections that are struct field dereferences. Previously, the full path was used when generating the name, now only the final field name is used. For example, SELECT someStruct->someField, ... would previously of generated a column name of SOMESTRUCT__SOMEFIELD, and will now generate a name of SOMEFIELD. Generated column names may have a numeric appended to the end to ensure uniqueness, for example SOMEFIELD_2.\nNote: it is recommended that you do not rely on system generated column names for production systems as there naming may change between releases. Providing an explict alias ensures consistent naming across releases. For example, SELECT someStruct->someField AS someField.\nBackwards compatibility: existing running queries will not be affected by this change: they will continue to run with the same column names. Any statements executed after the upgrade will use the new names where no explicit alias is provided. Add explicit aliases to your statements if you require the old names, for example: SELECT someStruct->someField AS SOMESTRUCT__SOMEFIELD, ...\nReviewing notes:\nCommits:\n\nProd code changes.\nTest code changes.\nHistorical plans changes: the only change is the name of the generated column names.\n\nFor the prod changes I'd suggest take a look at the following in this rough order:\n\nI've added a new ColumnAliasGenerate interface.\nI've updated ColumnNames to return the above from columnAliasGenerator. Internally, there's a new StructFieldAliasGenerator class which is responsible for ensuring, (to a point), that generated aliases for struct field access are unique.  Please take a look at the unit test for this class and see if you can think of any test cases I've missed!  This is the bit of the code that is most likely to have unforeseen edge cases!!!\nI've wired in the new ColumnAliasGenerate where ever the old ColumnNames.columnAliasGenerator or ColumnNames. generatedStructFieldColumnName was being used: the new interface does both.\n\nTesting done\nUsual.\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-04-02T10:50:39Z", "url": "https://github.com/confluentinc/ksql/pull/4977", "merged": true, "mergeCommit": {"oid": "2002458f6b668b7b17b05b192a7cc3fab0a23b20"}, "closed": true, "closedAt": "2020-04-07T11:03:20Z", "author": {"login": "big-andy-coates"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcTp82egH2gAyMzk3NTAxMzE0OmIxNmI4ZDU5MDdiMmI5YmU5M2Y0NmYwNmMzMmNjNDJjNDMyODg3YmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcVQWwrAH2gAyMzk3NTAxMzE0OjVlZmUxZjNiNGI4ODhjYjM2OGVmYjQyZTYxYWZmZGRkZDFlOGY4YmU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b16b8d5907b2b9be93f46f06c32cc42c432887bd", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/b16b8d5907b2b9be93f46f06c32cc42c432887bd", "committedDate": "2020-04-02T10:43:13Z", "message": "fix: generated aliases for struct field access no longer require quoting\n\nfixes: https://github.com/confluentinc/ksql/issues/4911\n\nWith this change there will no longer be the need to quote the column names generated for struct fields, unless the struct field name itself requires quoting. For example:\n\n```sql\nSELECT someStruct->mapOfStructsField['someKey']->arrayOfStructsFields[10]->someField FROM FOO;\n```\n\nPreviously the above would generate a column name that would require quoting to be used: `SOMESTRUCT__MAPOFSTRUCTSFIELD['someKey']__ARRAYOFSTRUCTSFIELD[10]__SOMEFIELD`. It will now generate the name `SOMEFIELD`.\n\nBREAKING CHANGE: This commit changes the system generated column name for any columns in projections that are struct field dereferences. Previously, the full path was used when generating the name, now only the final field name is used. For example, `SELECT someStruct->someField, ...` would previously of generated a column name of `SOMESTRUCT__SOMEFIELD`, and will now generate a name of `SOMEFIELD`. Generated column names may have a numeric appended to the end to ensure uniqueness, for example `SOMEFIELD_2`.\n\nNote: it is recommended that you do not rely on system generated column names for production systems as there naming may change between releases. Providing an explict alias ensures consistent naming across releases. For example, `SELECT someStruct->someField AS someField`.\n\nBackwards compatibility: existing running queries will not be affected by this change: they will continue to run with the same column names. Any statements executed after the upgrade will use the new names where no explicit alias is provided. Add explicit aliases to your statements if you require the old names, for example: `SELECT someStruct->someField AS SOMESTRUCT__SOMEFIELD, ...`"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0af1f411aba82e88d9e166e133fde70ca68f6b63", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/0af1f411aba82e88d9e166e133fde70ca68f6b63", "committedDate": "2020-04-02T10:44:38Z", "message": "chore: updated tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e029bee60fcb4a66d08cdd7409a4daeb4e8202c", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/1e029bee60fcb4a66d08cdd7409a4daeb4e8202c", "committedDate": "2020-04-02T10:44:52Z", "message": "chore: updated historical plans"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2MzE0NDE2", "url": "https://github.com/confluentinc/ksql/pull/4977#pullrequestreview-386314416", "createdAt": "2020-04-02T10:54:19Z", "commit": {"oid": "1e029bee60fcb4a66d08cdd7409a4daeb4e8202c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxMDo1NDoxOVrOF_l11w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxMDo1NDoxOVrOF_l11w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjIyNDU5OQ==", "bodyText": "This hasn't been deleted. Git just hasn't picked up the file move...", "url": "https://github.com/confluentinc/ksql/pull/4977#discussion_r402224599", "createdAt": "2020-04-02T10:54:19Z", "author": {"login": "big-andy-coates"}, "path": "ksqldb-common/src/test/java/io/confluent/ksql/name/ColumnNamesTest.java", "diffHunk": "@@ -1,90 +0,0 @@\n-/*\n- * Copyright 2020 Confluent Inc.\n- *\n- * Licensed under the Confluent Community License (the \"License\"); you may not use\n- * this file except in compliance with the License.  You may obtain a copy of the\n- * License at\n- *\n- * http://www.confluent.io/confluent-community-license\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n- * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n- * specific language governing permissions and limitations under the License.\n- */\n-\n-package io.confluent.ksql.name;\n-\n-import static org.hamcrest.MatcherAssert.assertThat;\n-import static org.hamcrest.Matchers.contains;\n-import static org.hamcrest.Matchers.is;\n-import static org.junit.Assert.assertThrows;\n-\n-import com.google.common.collect.ImmutableSet;\n-import io.confluent.ksql.name.ColumnNames.AliasGenerator;\n-import io.confluent.ksql.schema.ksql.LogicalSchema;\n-import io.confluent.ksql.schema.ksql.types.SqlTypes;\n-import io.confluent.ksql.util.KsqlException;\n-import java.util.List;\n-import java.util.function.Supplier;\n-import java.util.stream.Collectors;\n-import java.util.stream.IntStream;\n-import java.util.stream.Stream;\n-import org.junit.Test;\n-\n-public class ColumnNamesTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e029bee60fcb4a66d08cdd7409a4daeb4e8202c"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NDExMjUx", "url": "https://github.com/confluentinc/ksql/pull/4977#pullrequestreview-388411251", "createdAt": "2020-04-06T16:19:53Z", "commit": {"oid": "b16b8d5907b2b9be93f46f06c32cc42c432887bd"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxNjoxOTo1M1rOGBfoPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxNjoxOTo1M1rOGBfoPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIxOTk2NQ==", "bodyText": "can we have a comment explaining the regex? also instead of relying on ?: and indexed groups we should take advantages of named groups (https://docs.oracle.com/javase/7/docs/api/java/util/regex/Matcher.html#group%28java.lang.String%29)", "url": "https://github.com/confluentinc/ksql/pull/4977#discussion_r404219965", "createdAt": "2020-04-06T16:19:53Z", "author": {"login": "agavra"}, "path": "ksqldb-execution/src/main/java/io/confluent/ksql/name/ColumnNames.java", "diffHunk": "@@ -17,28 +17,30 @@\n \n import com.google.common.annotations.VisibleForTesting;\n import com.google.common.collect.ImmutableSet;\n+import com.google.common.collect.Sets;\n+import io.confluent.ksql.execution.expression.tree.DereferenceExpression;\n+import io.confluent.ksql.execution.expression.tree.Expression;\n import io.confluent.ksql.schema.ksql.Column;\n import io.confluent.ksql.schema.ksql.LogicalSchema;\n-import io.confluent.ksql.util.KsqlConstants;\n import io.confluent.ksql.util.KsqlException;\n+import java.util.HashMap;\n import java.util.List;\n-import java.util.OptionalInt;\n+import java.util.Map;\n+import java.util.Map.Entry;\n+import java.util.Objects;\n import java.util.Set;\n-import java.util.function.Supplier;\n import java.util.regex.Matcher;\n import java.util.regex.Pattern;\n import java.util.stream.Collectors;\n-import java.util.stream.IntStream;\n import java.util.stream.Stream;\n \n public final class ColumnNames {\n \n   private static final String AGGREGATE_COLUMN_PREFIX = \"KSQL_AGG_VARIABLE_\";\n-  private static final String GENERATED_ALIAS_PREFIX = \"KSQL_COL_\";\n+  private static final String GENERATED_ALIAS_PREFIX = \"KSQL_COL\";\n   private static final String SYNTHESISED_COLUMN_PREFIX = \"KSQL_SYNTH_\";\n \n-  private static final Pattern GENERATED_ALIAS_PATTERN = Pattern\n-      .compile(GENERATED_ALIAS_PREFIX + \"(\\\\d+)\");\n+  private static final Pattern NUMBERED_COLUMN_PATTERN = Pattern.compile(\"(.*?)?(?:_(\\\\d+))?\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b16b8d5907b2b9be93f46f06c32cc42c432887bd"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5efe1f3b4b888cb368efb42e61affdddd1e8f8be", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/5efe1f3b4b888cb368efb42e61affdddd1e8f8be", "committedDate": "2020-04-07T10:01:50Z", "message": "chore: almog's requested changes"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4972, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}