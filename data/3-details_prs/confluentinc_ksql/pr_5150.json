{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA3ODUxNDM1", "number": 5150, "title": "feat: klip-14 - rowtime as pseduocolumn", "bodyText": "Description\nfixes: #3734\nimplements KLIP 14 - ROWTIME as Pseudocolumn\nBREAKING CHANGE:\nSelect star, i.e. select *, no longer expands to include ROWTIME column(s). Instead, ROWTIME is only included in the results of queries if explicitly included in the projection, e.g. select rowtime, *.\nThis only affects new statements. Any view previously created via a CREATE STREAM AS SELECT or CREATE TABLE AS SELECT statement is unaffected.\nReviewing notes:\nPR broken down into separate commits:\n\nProd changes\nTest changes\nHistorical plan updates\nDoc changes\nUpdate to KLIP-14\n\nTesting done\nusual.\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-04-23T11:22:47Z", "url": "https://github.com/confluentinc/ksql/pull/5150", "merged": true, "mergeCommit": {"oid": "d541420acf61f0e0e7b25d91120886007dbdae01"}, "closed": true, "closedAt": "2020-04-23T23:52:57Z", "author": {"login": "big-andy-coates"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcabClDAH2gAyNDA3ODUxNDM1OmYyMzhhYzM5NWNiMTgyYTQ2YTA3YWIzNjU1ZTQ3NzJkMjlhNjQzYzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcakvCCAH2gAyNDA3ODUxNDM1OjllNzU3ODkzZDkyNzAxOTJhYjNiMzJjMjE2YWQ4ZGQ4ZTJkZTIwN2Y=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f238ac395cb182a46a07ab3655e4772d29a643c1", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/f238ac395cb182a46a07ab3655e4772d29a643c1", "committedDate": "2020-04-23T11:18:22Z", "message": "feat: ROWTIME as psuedo column\n\nfixes: https://github.com/confluentinc/ksql/issues/3734\n\nimplements [KLIP 14 - ROWTIME as Pseudocolumn](https://github.com/confluentinc/ksql/blob/master/design-proposals/klip-14-rowtime-as-pseudocolumn.md)\n\nBREAKING CHANGE:\n\nSelect star, i.e. `select *`, no longer expands to include `ROWTIME` column(s). Instead, `ROWTIME` is only included in the results of queries if explicitly included in the projection, e.g. `select rowtime, *`.\n\nThis only affects new statements. Any view previously created via a `CREATE STREAM AS SELECT` or `CREATE TABLE AS SELECT` statement is unaffected."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0cbeadea42566d0b78632c8e6eca401290394da3", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/0cbeadea42566d0b78632c8e6eca401290394da3", "committedDate": "2020-04-23T11:19:03Z", "message": "tests: test changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e085d77473c62ed6b3f97d89fc7f033213def010", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/e085d77473c62ed6b3f97d89fc7f033213def010", "committedDate": "2020-04-23T11:19:18Z", "message": "test: historical test plans"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7335f3dc44734d1300e5ca26b2959c370b40829", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/f7335f3dc44734d1300e5ca26b2959c370b40829", "committedDate": "2020-04-23T11:19:28Z", "message": "docs: doc updates"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "53c1d989df40e84e7ee3646017e93cfbfc98c450", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/53c1d989df40e84e7ee3646017e93cfbfc98c450", "committedDate": "2020-04-23T11:20:37Z", "message": "docs: klip update"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5MDAzNjYx", "url": "https://github.com/confluentinc/ksql/pull/5150#pullrequestreview-399003661", "createdAt": "2020-04-23T11:23:49Z", "commit": {"oid": "f238ac395cb182a46a07ab3655e4772d29a643c1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxMToyMzo0OVrOGKkTCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxMToyMzo0OVrOGKkTCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzczMzY0MA==", "bodyText": "Kept SYSTEM around for now, so that using a later CLI with old server doesn't result in a deserialization error.\nNot strictly necessary, but simple to do.", "url": "https://github.com/confluentinc/ksql/pull/5150#discussion_r413733640", "createdAt": "2020-04-23T11:23:49Z", "author": {"login": "big-andy-coates"}, "path": "ksqldb-rest-model/src/main/java/io/confluent/ksql/rest/entity/FieldInfo.java", "diffHunk": "@@ -30,7 +30,8 @@\n public class FieldInfo {\n \n   public enum FieldType {\n-    SYSTEM, KEY\n+    SYSTEM, // To be removed in the future. 0.9 saw this value no longer used.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f238ac395cb182a46a07ab3655e4772d29a643c1"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5MDAzOTMx", "url": "https://github.com/confluentinc/ksql/pull/5150#pullrequestreview-399003931", "createdAt": "2020-04-23T11:24:13Z", "commit": {"oid": "f238ac395cb182a46a07ab3655e4772d29a643c1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxMToyNDoxM1rOGKkT8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxMToyNDoxM1rOGKkT8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzczMzg3Mw==", "bodyText": "This filters ROWTIME from the schema returned by DESCRIBE etc.", "url": "https://github.com/confluentinc/ksql/pull/5150#discussion_r413733873", "createdAt": "2020-04-23T11:24:13Z", "author": {"login": "big-andy-coates"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/util/EntityUtil.java", "diffHunk": "@@ -39,6 +40,7 @@ private EntityUtil() {\n \n   public static List<FieldInfo> buildSourceSchemaEntity(final LogicalSchema schema) {\n     final List<FieldInfo> allFields = schema.columns().stream()\n+        .filter(f -> f.namespace() != Namespace.META)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f238ac395cb182a46a07ab3655e4772d29a643c1"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5MDA0MTkw", "url": "https://github.com/confluentinc/ksql/pull/5150#pullrequestreview-399004190", "createdAt": "2020-04-23T11:24:38Z", "commit": {"oid": "f238ac395cb182a46a07ab3655e4772d29a643c1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxMToyNDozOVrOGKkU3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxMToyNDozOVrOGKkU3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzczNDEwOQ==", "bodyText": "These changes remove ROWTIME from pull queries that use select *.", "url": "https://github.com/confluentinc/ksql/pull/5150#discussion_r413734109", "createdAt": "2020-04-23T11:24:39Z", "author": {"login": "big-andy-coates"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/entity/TableRowsEntityFactory.java", "diffHunk": "@@ -55,7 +55,6 @@ public static LogicalSchema buildSchema(\n     }\n \n     return builder\n-        .valueColumns(schema.metadata())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f238ac395cb182a46a07ab3655e4772d29a643c1"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5MDA0NTk3", "url": "https://github.com/confluentinc/ksql/pull/5150#pullrequestreview-399004597", "createdAt": "2020-04-23T11:25:16Z", "commit": {"oid": "f238ac395cb182a46a07ab3655e4772d29a643c1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxMToyNToxN1rOGKkWLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxMToyNToxN1rOGKkWLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzczNDQ0NQ==", "bodyText": "This change excludes ROWTIME from push / persistent queries that use * in the projection.", "url": "https://github.com/confluentinc/ksql/pull/5150#discussion_r413734445", "createdAt": "2020-04-23T11:25:17Z", "author": {"login": "big-andy-coates"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/planner/plan/DataSourceNode.java", "diffHunk": "@@ -140,19 +139,26 @@ private static LogicalSchema buildSchema(final DataSource dataSource) {\n         .withMetaAndKeyColsInValue(dataSource.getKsqlTopic().getKeyFormat().isWindowed());\n   }\n \n+  @SuppressWarnings(\"UnstableApiUsage\")\n   private static Stream<ColumnName> orderColumns(\n       final List<Column> columns,\n       final LogicalSchema schema\n   ) {\n-    // When doing a `select *` system and key columns should be at the front of the column list\n+    // When doing a `select *` key columns should be at the front of the column list\n     // but are added at the back during processing for performance reasons.\n     // Switch them around here:\n-    final Map<Boolean, List<Column>> partitioned = columns.stream().collect(Collectors\n-        .groupingBy(c -> SchemaUtil.isSystemColumn(c.name()) || schema.isKeyColumn(c.name())));\n+    final Stream<Column> keys = columns.stream()\n+        .filter(c -> schema.isKeyColumn(c.name()));\n \n-    final List<Column> all = partitioned.get(true);\n-    all.addAll(partitioned.get(false));\n-    return all.stream().map(Column::name);\n+    final Stream<Column> windowBounds = columns.stream()\n+        .filter(c -> SchemaUtil.isWindowBound(c.name()));\n+\n+    final Stream<Column> values = columns.stream()\n+        .filter(c -> !SchemaUtil.isWindowBound(c.name()))\n+        .filter(c -> !schema.isKeyColumn(c.name()))\n+        .filter(c -> !schema.isMetaColumn(c.name()));\n+\n+    return Streams.concat(keys, windowBounds, values).map(Column::name);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f238ac395cb182a46a07ab3655e4772d29a643c1"}, "originalPosition": 47}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9fcca7e2a1578b2ab10039f44bacaf54dd43799", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/d9fcca7e2a1578b2ab10039f44bacaf54dd43799", "committedDate": "2020-04-23T11:27:06Z", "message": "chore: merge from master\n\nConflicting files\nksqldb-rest-app/src/test/java/io/confluent/ksql/rest/server/resources/streaming/WebSocketSubscriberTest.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9046e358382c9b763a170765d75ae517410d53b7", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/9046e358382c9b763a170765d75ae517410d53b7", "committedDate": "2020-04-23T20:16:54Z", "message": "chore: merge from master\n\nConflicting files\nksqldb-engine/src/test/java/io/confluent/ksql/planner/plan/DataSourceNodeTest.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5NDQ3MTE4", "url": "https://github.com/confluentinc/ksql/pull/5150#pullrequestreview-399447118", "createdAt": "2020-04-23T20:22:23Z", "commit": {"oid": "9046e358382c9b763a170765d75ae517410d53b7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5NDk0NjA0", "url": "https://github.com/confluentinc/ksql/pull/5150#pullrequestreview-399494604", "createdAt": "2020-04-23T21:36:20Z", "commit": {"oid": "9046e358382c9b763a170765d75ae517410d53b7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1987092164ba09a43eb3aa3a64953d4dd93aa830", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/1987092164ba09a43eb3aa3a64953d4dd93aa830", "committedDate": "2020-04-23T22:32:57Z", "message": "Merge branch 'master' into drop_rowtime_from_select_star"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e757893d9270192ab3b32c216ad8dd8e2de207f", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/9e757893d9270192ab3b32c216ad8dd8e2de207f", "committedDate": "2020-04-23T22:36:04Z", "message": "chore: fix compiler warning"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4891, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}