{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU3MzQwMDU2", "number": 5883, "title": "fix: close query on invalid use of HTTP/2 with /query endpoint", "bodyText": "Description\nFixes #5881.\nThe bug is that the close callback passed to the QueryStreamWriter/TopicStreamWriter sets a flag (connectionClosed) that causes the write() loop to end and close the underlying Kafka Streams app/Kafka consumer, but when HTTP/2 is used, write() is never called so this doesn't happen even though the connectionClosed flag is set. This PR fixes the bug by introducing a new method, closeWithoutWrite(), that directly closes the underlying Kafka Streams app/Kafka consumer and is called when the 405 response is returned (upon discovering an HTTP/2 request to the /query endpoint for a request type that requires an HTTP streaming response).\nTesting done\nManual + integration tests.\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-07-27T18:51:54Z", "url": "https://github.com/confluentinc/ksql/pull/5883", "merged": true, "mergeCommit": {"oid": "bcab1166bd64818c701a956c0d34a00ec2d4e7dd"}, "closed": true, "closedAt": "2020-07-27T22:50:26Z", "author": {"login": "vcrfxia"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5GM8YAH2gAyNDU3MzQwMDU2OmYwZTEwYmE4ZTk3MDljYTJkOWQ5N2I2YjgyMjAwY2U3OWJmZWIyMTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5HapCAH2gAyNDU3MzQwMDU2OmI2NTU1YWFiYjdmYjIzOGU4YWM3ODNiZjhlN2Y3MTUzNTcwOWEyMzI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f0e10ba8e9709ca2d9d97b6b82200ce79bfeb215", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/f0e10ba8e9709ca2d9d97b6b82200ce79bfeb215", "committedDate": "2020-07-27T18:33:20Z", "message": "fix: close query on invalid use of HTTP/2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ed8ba06245de450341bceb817b9ec431b97aaf3", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/4ed8ba06245de450341bceb817b9ec431b97aaf3", "committedDate": "2020-07-27T19:25:25Z", "message": "chore: call close from write"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2MDgzODcy", "url": "https://github.com/confluentinc/ksql/pull/5883#pullrequestreview-456083872", "createdAt": "2020-07-27T19:47:27Z", "commit": {"oid": "4ed8ba06245de450341bceb817b9ec431b97aaf3"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxOTo0NzoyN1rOG3xCyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxOTo0ODoyNFrOG3xEqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTEyODM5NQ==", "bodyText": "did you mean to change this to close?", "url": "https://github.com/confluentinc/ksql/pull/5883#discussion_r461128395", "createdAt": "2020-07-27T19:47:27Z", "author": {"login": "agavra"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/OldApiUtils.java", "diffHunk": "@@ -89,15 +89,16 @@ static void handleOldApiResponse(final Server server, final RoutingContext routi\n     // a plain String, other times it's an object that needs to be JSON encoded, other times\n     // it represents a stream.\n     if (endpointResponse.getEntity() instanceof StreamingOutput) {\n+      final StreamingOutput streamingOutput = (StreamingOutput) endpointResponse.getEntity();\n       if (routingContext.request().version() == HttpVersion.HTTP_2) {\n         // The old /query endpoint uses chunked encoding which is not supported in HTTP2\n         routingContext.response().setStatusCode(METHOD_NOT_ALLOWED.code())\n             .setStatusMessage(\"The /query endpoint is not available using HTTP2\").end();\n+        streamingOutput.closeWithoutWrite();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ed8ba06245de450341bceb817b9ec431b97aaf3"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTEyODY4OA==", "bodyText": "nit, we should instead have this implement AutoCloseable", "url": "https://github.com/confluentinc/ksql/pull/5883#discussion_r461128688", "createdAt": "2020-07-27T19:48:03Z", "author": {"login": "agavra"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/StreamingOutput.java", "diffHunk": "@@ -21,4 +21,7 @@\n public interface StreamingOutput {\n \n   void write(OutputStream output) throws IOException;\n+\n+  void close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ed8ba06245de450341bceb817b9ec431b97aaf3"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTEyODg3NA==", "bodyText": "synchronized?", "url": "https://github.com/confluentinc/ksql/pull/5883#discussion_r461128874", "createdAt": "2020-07-27T19:48:24Z", "author": {"login": "agavra"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/resources/streaming/TopicStreamWriter.java", "diffHunk": "@@ -137,7 +138,15 @@ public void write(final OutputStream out) {\n       log.error(\"Exception encountered while writing to output stream\", exception);\n       outputException(out, exception);\n     } finally {\n+      close();\n+    }\n+  }\n+\n+  @Override\n+  public void close() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ed8ba06245de450341bceb817b9ec431b97aaf3"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6555aabb7fb238e8ac783bf8e7f71535709a232", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/b6555aabb7fb238e8ac783bf8e7f71535709a232", "committedDate": "2020-07-27T19:58:12Z", "message": "chore: fix derps"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4759, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}