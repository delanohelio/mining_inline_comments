{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkxMTQ0MzQw", "number": 6271, "title": "chore: minor follow-ups to failing on backup corruption", "bodyText": "Description\nFollow up to #6164\nTesting done\nNon-functional changes\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-09-22T19:20:26Z", "url": "https://github.com/confluentinc/ksql/pull/6271", "merged": true, "mergeCommit": {"oid": "1d72c263387f868674bac9249dedad27e528fab8"}, "closed": true, "closedAt": "2020-09-24T17:50:51Z", "author": {"login": "stevenpyzhang"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLfDfGAFqTQ5Mzg2NzEzMQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdMEBd8gBqjM4MDQxNTk4NzA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzODY3MTMx", "url": "https://github.com/confluentinc/ksql/pull/6271#pullrequestreview-493867131", "createdAt": "2020-09-22T21:41:16Z", "commit": {"oid": "466d479a095a4f34079bae927bd79ae6aa6e14d6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMTo0MToxNlrOHWNYRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMTo0MToxNlrOHWNYRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA0OTkyNg==", "bodyText": "Would be good to use the same message here as the one in the LOG.warn().", "url": "https://github.com/confluentinc/ksql/pull/6271#discussion_r493049926", "createdAt": "2020-09-22T21:41:16Z", "author": {"login": "spena"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/CommandTopicBackupImpl.java", "diffHunk": "@@ -152,17 +152,18 @@ public void writeRecord(final ConsumerRecord<byte[], byte[]> record) {\n \n   void writeCommandToBackup(final ConsumerRecord<CommandId, Command> record) {\n     if (corruptionDetected) {\n-      LOG.warn(\"Failure to write command topic data to backup. \"\n-          + \"Corruption detected in command topic.\");\n-      return;\n+      throw new KsqlServerException(\n+          \"Failed to write record due to out of sync command topic and backup file: \" + record);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "466d479a095a4f34079bae927bd79ae6aa6e14d6"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzODY4OTk0", "url": "https://github.com/confluentinc/ksql/pull/6271#pullrequestreview-493868994", "createdAt": "2020-09-22T21:44:37Z", "commit": {"oid": "466d479a095a4f34079bae927bd79ae6aa6e14d6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMTo0NDozN1rOHWNeHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMTo0NDozN1rOHWNeHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA1MTQyMw==", "bodyText": "Throw the exception here, otherwise the first time it will only log.", "url": "https://github.com/confluentinc/ksql/pull/6271#discussion_r493051423", "createdAt": "2020-09-22T21:44:37Z", "author": {"login": "spena"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/CommandTopicBackupImpl.java", "diffHunk": "@@ -152,17 +152,18 @@ public void writeRecord(final ConsumerRecord<byte[], byte[]> record) {\n \n   void writeCommandToBackup(final ConsumerRecord<CommandId, Command> record) {\n     if (corruptionDetected) {\n-      LOG.warn(\"Failure to write command topic data to backup. \"\n-          + \"Corruption detected in command topic.\");\n-      return;\n+      throw new KsqlServerException(\n+          \"Failed to write record due to out of sync command topic and backup file: \" + record);\n     }\n \n     if (isRestoring()) {\n       if (isRecordInLatestReplay(record)) {\n         // Ignore backup because record was already replayed\n         return;\n       } else {\n-        LOG.info(\"Previous command topic backup does not match the new command topic data.\");\n+        LOG.warn(\"Backup is out of sync with the current command topic. \"\n+            + \"Backups will not work until the previous command topic is \"\n+            + \"restored or all backup files are deleted.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "466d479a095a4f34079bae927bd79ae6aa6e14d6"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ddf629eeb7b9106098ce9dd5cc4c3c2c371a2e25", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/ddf629eeb7b9106098ce9dd5cc4c3c2c371a2e25", "committedDate": "2020-09-23T19:33:04Z", "message": "chore: minor follow-ups to failing on backup corruption"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "466d479a095a4f34079bae927bd79ae6aa6e14d6", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/466d479a095a4f34079bae927bd79ae6aa6e14d6", "committedDate": "2020-09-22T19:19:09Z", "message": "chore: minor follow-ups to failing on backup corruption"}, "afterCommit": {"oid": "6bf2b0db2570fbedbaffc789be496bdf6e2e91df", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/6bf2b0db2570fbedbaffc789be496bdf6e2e91df", "committedDate": "2020-09-23T22:56:00Z", "message": "sergio comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1NTY2MjE3", "url": "https://github.com/confluentinc/ksql/pull/6271#pullrequestreview-495566217", "createdAt": "2020-09-24T13:25:10Z", "commit": {"oid": "6bf2b0db2570fbedbaffc789be496bdf6e2e91df"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1398e92eb7394fa0153de7852820065df2b87b04", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/1398e92eb7394fa0153de7852820065df2b87b04", "committedDate": "2020-09-24T16:45:20Z", "message": "sergio comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6bf2b0db2570fbedbaffc789be496bdf6e2e91df", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/6bf2b0db2570fbedbaffc789be496bdf6e2e91df", "committedDate": "2020-09-23T22:56:00Z", "message": "sergio comments"}, "afterCommit": {"oid": "1398e92eb7394fa0153de7852820065df2b87b04", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/1398e92eb7394fa0153de7852820065df2b87b04", "committedDate": "2020-09-24T16:45:20Z", "message": "sergio comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4668, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}