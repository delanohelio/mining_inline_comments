{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU5NzY4MTAz", "number": 4232, "title": "feat: native map/array constructors", "bodyText": "BREAKING CHANGE: the old syntax for creating arrays using the\nbuiltin AS_ARRAY function will no longer work\nDescription\nFollow-up on #4120 - this PR creates maps and arrays natively instead of going through the UDF path. This has the benefit of custom syntax and stricter type checking.\nTesting done\n\nQTT\nUnit Tests\n\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-01-07T00:19:13Z", "url": "https://github.com/confluentinc/ksql/pull/4232", "merged": true, "mergeCommit": {"oid": "3ecfaadfb6de91afc106d7fece74811de2d015bf"}, "closed": true, "closedAt": "2020-01-17T18:55:33Z", "author": {"login": "agavra"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb4A8MRAFqTMzOTE1Nzc1NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb7SyAFABqjI5NTkwMzYzMTc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5MTU3NzU1", "url": "https://github.com/confluentinc/ksql/pull/4232#pullrequestreview-339157755", "createdAt": "2020-01-07T10:39:57Z", "commit": {"oid": "fc6cff1f3b319a603999c9e2b0ed591d12b1b22b"}, "state": "COMMENTED", "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxMDozOTo1N1rOFa1yNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxMDo0OTo1OFrOFa2Bbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzY4ODUwMw==", "bodyText": "If this is a customer facing error message, then I think it could be better worded and I don't think we need exclamation marks ;) . Maybe something like:\n\nArray constructor can not be empty. Please supply at least one element.\n\nYou could even link to the github issue that will add support for empty/all-null arrays so that people can upvote it.", "url": "https://github.com/confluentinc/ksql/pull/4232#discussion_r363688503", "createdAt": "2020-01-07T10:39:57Z", "author": {"login": "big-andy-coates"}, "path": "ksql-execution/src/main/java/io/confluent/ksql/execution/util/ExpressionTypeManager.java", "diffHunk": "@@ -331,6 +333,83 @@ public Void visitSubscriptExpression(\n       return null;\n     }\n \n+    @Override\n+    public Void visitCreateArrayExpression(\n+        final CreateArrayExpression exp,\n+        final ExpressionTypeContext context\n+    ) {\n+      if (exp.getValues().isEmpty()) {\n+        throw new KsqlException(\"Cannot extract type from empty array!\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fc6cff1f3b319a603999c9e2b0ed591d12b1b22b"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzY4ODYwMA==", "bodyText": "Again with the exclamation marks ;)\nIf this is customer facing, which as a KsqlException I'm assuming it is, then maybe something like:\n\nCan not construct array with all NULL elements.\n\nYou could even link to the github issue that will add support for empty/all-null arrays so that people can upvote it.\nCan the user work around this by casting one of the NULLs to a type?  Maybe include this in the error message and add a QTT test case.\nWhat about for INSERT VALUES where the required array type is known.... can we support all nulls then?  How about empty arrays?", "url": "https://github.com/confluentinc/ksql/pull/4232#discussion_r363688600", "createdAt": "2020-01-07T10:40:14Z", "author": {"login": "big-andy-coates"}, "path": "ksql-execution/src/main/java/io/confluent/ksql/execution/util/ExpressionTypeManager.java", "diffHunk": "@@ -331,6 +333,83 @@ public Void visitSubscriptExpression(\n       return null;\n     }\n \n+    @Override\n+    public Void visitCreateArrayExpression(\n+        final CreateArrayExpression exp,\n+        final ExpressionTypeContext context\n+    ) {\n+      if (exp.getValues().isEmpty()) {\n+        throw new KsqlException(\"Cannot extract type from empty array!\");\n+      }\n+\n+      final List<SqlType> sqlTypes = exp\n+          .getValues()\n+          .stream()\n+          .map(val -> {\n+            process(val, context);\n+            return context.getSqlType();\n+          })\n+          .filter(Objects::nonNull)\n+          .distinct()\n+          .collect(Collectors.toList());\n+\n+      if (sqlTypes.size() == 0) {\n+        throw new KsqlException(\"Cannot extract type from array of nulls!\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fc6cff1f3b319a603999c9e2b0ed591d12b1b22b"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzY4OTE1OQ==", "bodyText": "It would be useful if this message called out what the type of each element was, as it may not be clear to the user which element has a different type.\nIf/when we support casting of array elements, (see other comments), then we may want to also call this out as an option in the error message.", "url": "https://github.com/confluentinc/ksql/pull/4232#discussion_r363689159", "createdAt": "2020-01-07T10:41:43Z", "author": {"login": "big-andy-coates"}, "path": "ksql-execution/src/main/java/io/confluent/ksql/execution/util/ExpressionTypeManager.java", "diffHunk": "@@ -331,6 +333,83 @@ public Void visitSubscriptExpression(\n       return null;\n     }\n \n+    @Override\n+    public Void visitCreateArrayExpression(\n+        final CreateArrayExpression exp,\n+        final ExpressionTypeContext context\n+    ) {\n+      if (exp.getValues().isEmpty()) {\n+        throw new KsqlException(\"Cannot extract type from empty array!\");\n+      }\n+\n+      final List<SqlType> sqlTypes = exp\n+          .getValues()\n+          .stream()\n+          .map(val -> {\n+            process(val, context);\n+            return context.getSqlType();\n+          })\n+          .filter(Objects::nonNull)\n+          .distinct()\n+          .collect(Collectors.toList());\n+\n+      if (sqlTypes.size() == 0) {\n+        throw new KsqlException(\"Cannot extract type from array of nulls!\");\n+      }\n+\n+      if (sqlTypes.size() != 1) {\n+        throw new KsqlException(\n+            \"Invalid array expression! All values must be of the same type.\" + exp);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fc6cff1f3b319a603999c9e2b0ed591d12b1b22b"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzY4OTIzNQ==", "bodyText": "If this is a customer facing error message, then I think it could be better worded and I don't think we need exclamation marks ;) . Maybe something like:\n\nMap constructor can not be empty. Please supply at least key-value pair.\n\nYou could even link to the github issue that will add support for empty/all-null maps so that people can upvote it.", "url": "https://github.com/confluentinc/ksql/pull/4232#discussion_r363689235", "createdAt": "2020-01-07T10:41:55Z", "author": {"login": "big-andy-coates"}, "path": "ksql-execution/src/main/java/io/confluent/ksql/execution/util/ExpressionTypeManager.java", "diffHunk": "@@ -331,6 +333,83 @@ public Void visitSubscriptExpression(\n       return null;\n     }\n \n+    @Override\n+    public Void visitCreateArrayExpression(\n+        final CreateArrayExpression exp,\n+        final ExpressionTypeContext context\n+    ) {\n+      if (exp.getValues().isEmpty()) {\n+        throw new KsqlException(\"Cannot extract type from empty array!\");\n+      }\n+\n+      final List<SqlType> sqlTypes = exp\n+          .getValues()\n+          .stream()\n+          .map(val -> {\n+            process(val, context);\n+            return context.getSqlType();\n+          })\n+          .filter(Objects::nonNull)\n+          .distinct()\n+          .collect(Collectors.toList());\n+\n+      if (sqlTypes.size() == 0) {\n+        throw new KsqlException(\"Cannot extract type from array of nulls!\");\n+      }\n+\n+      if (sqlTypes.size() != 1) {\n+        throw new KsqlException(\n+            \"Invalid array expression! All values must be of the same type.\" + exp);\n+      }\n+\n+      context.setSqlType(SqlArray.of(sqlTypes.get(0)));\n+      return null;\n+    }\n+\n+    @Override\n+    public Void visitCreateMapExpression(\n+        final CreateMapExpression exp,\n+        final ExpressionTypeContext context\n+    ) {\n+      if (exp.getMap().isEmpty()) {\n+        throw new KsqlException(\"Cannot extract type from empty map!\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fc6cff1f3b319a603999c9e2b0ed591d12b1b22b"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzY4OTY1Ng==", "bodyText": "Wording of error is a little strange. Maybe something like \"Only STRING keys are supported in maps\"?  Might also be useful to call out which keys are not strings and what there type is, as this may not be obvious.", "url": "https://github.com/confluentinc/ksql/pull/4232#discussion_r363689656", "createdAt": "2020-01-07T10:43:05Z", "author": {"login": "big-andy-coates"}, "path": "ksql-execution/src/main/java/io/confluent/ksql/execution/util/ExpressionTypeManager.java", "diffHunk": "@@ -331,6 +333,83 @@ public Void visitSubscriptExpression(\n       return null;\n     }\n \n+    @Override\n+    public Void visitCreateArrayExpression(\n+        final CreateArrayExpression exp,\n+        final ExpressionTypeContext context\n+    ) {\n+      if (exp.getValues().isEmpty()) {\n+        throw new KsqlException(\"Cannot extract type from empty array!\");\n+      }\n+\n+      final List<SqlType> sqlTypes = exp\n+          .getValues()\n+          .stream()\n+          .map(val -> {\n+            process(val, context);\n+            return context.getSqlType();\n+          })\n+          .filter(Objects::nonNull)\n+          .distinct()\n+          .collect(Collectors.toList());\n+\n+      if (sqlTypes.size() == 0) {\n+        throw new KsqlException(\"Cannot extract type from array of nulls!\");\n+      }\n+\n+      if (sqlTypes.size() != 1) {\n+        throw new KsqlException(\n+            \"Invalid array expression! All values must be of the same type.\" + exp);\n+      }\n+\n+      context.setSqlType(SqlArray.of(sqlTypes.get(0)));\n+      return null;\n+    }\n+\n+    @Override\n+    public Void visitCreateMapExpression(\n+        final CreateMapExpression exp,\n+        final ExpressionTypeContext context\n+    ) {\n+      if (exp.getMap().isEmpty()) {\n+        throw new KsqlException(\"Cannot extract type from empty map!\");\n+      }\n+\n+      final boolean anyNonStringKeys = exp.getMap()\n+          .keySet()\n+          .stream()\n+          .map(key -> {\n+            process(key, context);\n+            return context.getSqlType();\n+          })\n+          .anyMatch(type -> !SqlTypes.STRING.equals(type));\n+      if (anyNonStringKeys) {\n+        throw new KsqlException(\"Cannot support non-string keys on maps:\" + exp);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fc6cff1f3b319a603999c9e2b0ed591d12b1b22b"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzY5MDA1NQ==", "bodyText": "As with ARRAYs, it might help the user if the error included the types of the values, so that they could more easily see where the issue is., e.g. a UDF that returns a type different to what they thought.\nMaybe add details of how the user could use CAST to fix the issue?", "url": "https://github.com/confluentinc/ksql/pull/4232#discussion_r363690055", "createdAt": "2020-01-07T10:44:06Z", "author": {"login": "big-andy-coates"}, "path": "ksql-execution/src/main/java/io/confluent/ksql/execution/util/ExpressionTypeManager.java", "diffHunk": "@@ -331,6 +333,83 @@ public Void visitSubscriptExpression(\n       return null;\n     }\n \n+    @Override\n+    public Void visitCreateArrayExpression(\n+        final CreateArrayExpression exp,\n+        final ExpressionTypeContext context\n+    ) {\n+      if (exp.getValues().isEmpty()) {\n+        throw new KsqlException(\"Cannot extract type from empty array!\");\n+      }\n+\n+      final List<SqlType> sqlTypes = exp\n+          .getValues()\n+          .stream()\n+          .map(val -> {\n+            process(val, context);\n+            return context.getSqlType();\n+          })\n+          .filter(Objects::nonNull)\n+          .distinct()\n+          .collect(Collectors.toList());\n+\n+      if (sqlTypes.size() == 0) {\n+        throw new KsqlException(\"Cannot extract type from array of nulls!\");\n+      }\n+\n+      if (sqlTypes.size() != 1) {\n+        throw new KsqlException(\n+            \"Invalid array expression! All values must be of the same type.\" + exp);\n+      }\n+\n+      context.setSqlType(SqlArray.of(sqlTypes.get(0)));\n+      return null;\n+    }\n+\n+    @Override\n+    public Void visitCreateMapExpression(\n+        final CreateMapExpression exp,\n+        final ExpressionTypeContext context\n+    ) {\n+      if (exp.getMap().isEmpty()) {\n+        throw new KsqlException(\"Cannot extract type from empty map!\");\n+      }\n+\n+      final boolean anyNonStringKeys = exp.getMap()\n+          .keySet()\n+          .stream()\n+          .map(key -> {\n+            process(key, context);\n+            return context.getSqlType();\n+          })\n+          .anyMatch(type -> !SqlTypes.STRING.equals(type));\n+      if (anyNonStringKeys) {\n+        throw new KsqlException(\"Cannot support non-string keys on maps:\" + exp);\n+      }\n+\n+      final List<SqlType> sqlTypes = exp.getMap()\n+          .values()\n+          .stream()\n+          .map(val -> {\n+            process(val, context);\n+            return context.getSqlType();\n+          })\n+          .distinct()\n+          .collect(Collectors.toList());\n+\n+      if (sqlTypes.size() != 1) {\n+        throw new KsqlException(\n+            \"Invalid map expression! All values must be of the same type. \" + exp);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fc6cff1f3b319a603999c9e2b0ed591d12b1b22b"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzY5MDE1OA==", "bodyText": "Maybe something like:\n\nCan not construct MAP with all NULL values.\n\nYou could even link to the github issue that will add support for empty/all-null arrays so that people can upvote it.\nCan the user work around this by casting one of the NULLs to a type?  Maybe include this in the error message and add a QTT test case.\nWhat about for INSERT VALUES where the required map type is known.... can we support all nulls then?  How about empty maps?", "url": "https://github.com/confluentinc/ksql/pull/4232#discussion_r363690158", "createdAt": "2020-01-07T10:44:23Z", "author": {"login": "big-andy-coates"}, "path": "ksql-execution/src/main/java/io/confluent/ksql/execution/util/ExpressionTypeManager.java", "diffHunk": "@@ -331,6 +333,83 @@ public Void visitSubscriptExpression(\n       return null;\n     }\n \n+    @Override\n+    public Void visitCreateArrayExpression(\n+        final CreateArrayExpression exp,\n+        final ExpressionTypeContext context\n+    ) {\n+      if (exp.getValues().isEmpty()) {\n+        throw new KsqlException(\"Cannot extract type from empty array!\");\n+      }\n+\n+      final List<SqlType> sqlTypes = exp\n+          .getValues()\n+          .stream()\n+          .map(val -> {\n+            process(val, context);\n+            return context.getSqlType();\n+          })\n+          .filter(Objects::nonNull)\n+          .distinct()\n+          .collect(Collectors.toList());\n+\n+      if (sqlTypes.size() == 0) {\n+        throw new KsqlException(\"Cannot extract type from array of nulls!\");\n+      }\n+\n+      if (sqlTypes.size() != 1) {\n+        throw new KsqlException(\n+            \"Invalid array expression! All values must be of the same type.\" + exp);\n+      }\n+\n+      context.setSqlType(SqlArray.of(sqlTypes.get(0)));\n+      return null;\n+    }\n+\n+    @Override\n+    public Void visitCreateMapExpression(\n+        final CreateMapExpression exp,\n+        final ExpressionTypeContext context\n+    ) {\n+      if (exp.getMap().isEmpty()) {\n+        throw new KsqlException(\"Cannot extract type from empty map!\");\n+      }\n+\n+      final boolean anyNonStringKeys = exp.getMap()\n+          .keySet()\n+          .stream()\n+          .map(key -> {\n+            process(key, context);\n+            return context.getSqlType();\n+          })\n+          .anyMatch(type -> !SqlTypes.STRING.equals(type));\n+      if (anyNonStringKeys) {\n+        throw new KsqlException(\"Cannot support non-string keys on maps:\" + exp);\n+      }\n+\n+      final List<SqlType> sqlTypes = exp.getMap()\n+          .values()\n+          .stream()\n+          .map(val -> {\n+            process(val, context);\n+            return context.getSqlType();\n+          })\n+          .distinct()\n+          .collect(Collectors.toList());\n+\n+      if (sqlTypes.size() != 1) {\n+        throw new KsqlException(\n+            \"Invalid map expression! All values must be of the same type. \" + exp);\n+      }\n+\n+      if (sqlTypes.get(0) == null) {\n+        throw new KsqlException(\"Maps do not accept null values!\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fc6cff1f3b319a603999c9e2b0ed591d12b1b22b"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzY5MjEzMQ==", "bodyText": "Can we add some JSON tests that cover the negative cases please:\n\nempty array\nall nulls\nelements of different types.\n\nI know this is tested elsewhere, but such tests test what the actual error message users will see is.", "url": "https://github.com/confluentinc/ksql/pull/4232#discussion_r363692131", "createdAt": "2020-01-07T10:49:15Z", "author": {"login": "big-andy-coates"}, "path": "ksql-functional-tests/src/test/resources/query-validation-tests/asarray.json", "diffHunk": "@@ -7,7 +7,7 @@\n       \"name\": \"construct a list from two elements\",\n       \"statements\": [\n         \"CREATE STREAM TEST (a INT, b INT) WITH (kafka_topic='test_topic', value_format='JSON');\",\n-        \"CREATE STREAM OUTPUT AS SELECT as_array(a, b, 3) as l FROM TEST;\"\n+        \"CREATE STREAM OUTPUT AS SELECT ARRAY[a, b, 3] as l FROM TEST;\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fc6cff1f3b319a603999c9e2b0ed591d12b1b22b"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzY5MjM5OA==", "bodyText": "Can we add some JSON tests that cover the negative cases please:\n\nempty constructor\nall nulls\nnon-string keys\nvalues of different types.\n\nI know this is tested elsewhere, but such tests test what the actual error message users will see is.", "url": "https://github.com/confluentinc/ksql/pull/4232#discussion_r363692398", "createdAt": "2020-01-07T10:49:58Z", "author": {"login": "big-andy-coates"}, "path": "ksql-functional-tests/src/test/resources/query-validation-tests/asmap.json", "diffHunk": "@@ -3,6 +3,19 @@\n     \"Tests covering map creation\"\n   ],\n   \"tests\": [\n+    {\n+      \"name\": \"create map from named tuples\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fc6cff1f3b319a603999c9e2b0ed591d12b1b22b"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "522f267c187faba71aabe50c03306dc9a66406ee", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/522f267c187faba71aabe50c03306dc9a66406ee", "committedDate": "2020-01-07T21:10:26Z", "message": "feat: improve error messages"}, "afterCommit": {"oid": "a22eff5a55d3979b44882c71cd532be9ddd31327", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/a22eff5a55d3979b44882c71cd532be9ddd31327", "committedDate": "2020-01-07T21:21:08Z", "message": "feat: improve error messages"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a22eff5a55d3979b44882c71cd532be9ddd31327", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/a22eff5a55d3979b44882c71cd532be9ddd31327", "committedDate": "2020-01-07T21:21:08Z", "message": "feat: improve error messages"}, "afterCommit": {"oid": "841a14d02977d865beef46137eaab0a21d6fe055", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/841a14d02977d865beef46137eaab0a21d6fe055", "committedDate": "2020-01-13T18:58:55Z", "message": "feat: improve error messages"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzODc3MjM0", "url": "https://github.com/confluentinc/ksql/pull/4232#pullrequestreview-343877234", "createdAt": "2020-01-16T12:29:59Z", "commit": {"oid": "841a14d02977d865beef46137eaab0a21d6fe055"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxMjozMDowMFrOFeXzYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxMjozMDozMFrOFeX0DA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM5MTU4NQ==", "bodyText": "nit: consider changing 'the NULL' to 'a NULL'.  There could be multiple nulls and only one needs to be none-null", "url": "https://github.com/confluentinc/ksql/pull/4232#discussion_r367391585", "createdAt": "2020-01-16T12:30:00Z", "author": {"login": "big-andy-coates"}, "path": "ksql-execution/src/main/java/io/confluent/ksql/execution/util/ExpressionTypeManager.java", "diffHunk": "@@ -331,6 +334,94 @@ public Void visitSubscriptExpression(\n       return null;\n     }\n \n+    @Override\n+    public Void visitCreateArrayExpression(\n+        final CreateArrayExpression exp,\n+        final ExpressionTypeContext context\n+    ) {\n+      if (exp.getValues().isEmpty()) {\n+        throw new KsqlException(\n+            \"Array constructor cannot be empty. Please supply at least one element \"\n+                + \"(see https://github.com/confluentinc/ksql/issues/4239).\");\n+      }\n+\n+      final List<SqlType> sqlTypes = exp\n+          .getValues()\n+          .stream()\n+          .map(val -> {\n+            process(val, context);\n+            return context.getSqlType();\n+          })\n+          .filter(Objects::nonNull)\n+          .collect(Collectors.toList());\n+\n+      if (sqlTypes.size() == 0) {\n+        throw new KsqlException(\"Cannot construct an array with all NULL elements \"\n+            + \"(see https://github.com/confluentinc/ksql/issues/4239). As a workaround, you may \"\n+            + \"cast the NULL value to a desired type.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "841a14d02977d865beef46137eaab0a21d6fe055"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM5MTc1Ng==", "bodyText": "Can we link in a github issue to track this second part please?", "url": "https://github.com/confluentinc/ksql/pull/4232#discussion_r367391756", "createdAt": "2020-01-16T12:30:30Z", "author": {"login": "big-andy-coates"}, "path": "ksql-execution/src/main/java/io/confluent/ksql/execution/util/ExpressionTypeManager.java", "diffHunk": "@@ -331,6 +333,83 @@ public Void visitSubscriptExpression(\n       return null;\n     }\n \n+    @Override\n+    public Void visitCreateArrayExpression(\n+        final CreateArrayExpression exp,\n+        final ExpressionTypeContext context\n+    ) {\n+      if (exp.getValues().isEmpty()) {\n+        throw new KsqlException(\"Cannot extract type from empty array!\");\n+      }\n+\n+      final List<SqlType> sqlTypes = exp\n+          .getValues()\n+          .stream()\n+          .map(val -> {\n+            process(val, context);\n+            return context.getSqlType();\n+          })\n+          .filter(Objects::nonNull)\n+          .distinct()\n+          .collect(Collectors.toList());\n+\n+      if (sqlTypes.size() == 0) {\n+        throw new KsqlException(\"Cannot extract type from array of nulls!\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzY4ODYwMA=="}, "originalCommit": {"oid": "fc6cff1f3b319a603999c9e2b0ed591d12b1b22b"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzODgwMTU2", "url": "https://github.com/confluentinc/ksql/pull/4232#pullrequestreview-343880156", "createdAt": "2020-01-16T12:35:52Z", "commit": {"oid": "841a14d02977d865beef46137eaab0a21d6fe055"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxMjozNTo1M1rOFeX8LQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxMjozNzowN1rOFeX-Gw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM5MzgzNw==", "bodyText": "super nit: can we call this valueTypes and the other keyTypes to make it clear?", "url": "https://github.com/confluentinc/ksql/pull/4232#discussion_r367393837", "createdAt": "2020-01-16T12:35:53Z", "author": {"login": "big-andy-coates"}, "path": "ksql-execution/src/main/java/io/confluent/ksql/execution/util/ExpressionTypeManager.java", "diffHunk": "@@ -331,6 +334,94 @@ public Void visitSubscriptExpression(\n       return null;\n     }\n \n+    @Override\n+    public Void visitCreateArrayExpression(\n+        final CreateArrayExpression exp,\n+        final ExpressionTypeContext context\n+    ) {\n+      if (exp.getValues().isEmpty()) {\n+        throw new KsqlException(\n+            \"Array constructor cannot be empty. Please supply at least one element \"\n+                + \"(see https://github.com/confluentinc/ksql/issues/4239).\");\n+      }\n+\n+      final List<SqlType> sqlTypes = exp\n+          .getValues()\n+          .stream()\n+          .map(val -> {\n+            process(val, context);\n+            return context.getSqlType();\n+          })\n+          .filter(Objects::nonNull)\n+          .collect(Collectors.toList());\n+\n+      if (sqlTypes.size() == 0) {\n+        throw new KsqlException(\"Cannot construct an array with all NULL elements \"\n+            + \"(see https://github.com/confluentinc/ksql/issues/4239). As a workaround, you may \"\n+            + \"cast the NULL value to a desired type.\");\n+      }\n+\n+      if (new HashSet<>(sqlTypes).size() != 1) {\n+        throw new KsqlException(\n+            String.format(\n+                \"Cannot construct an array with mismatching types (%s) from expression %s.\",\n+                sqlTypes,\n+                exp));\n+      }\n+\n+      context.setSqlType(SqlArray.of(sqlTypes.get(0)));\n+      return null;\n+    }\n+\n+    @Override\n+    public Void visitCreateMapExpression(\n+        final CreateMapExpression exp,\n+        final ExpressionTypeContext context\n+    ) {\n+      if (exp.getMap().isEmpty()) {\n+        throw new KsqlException(\"Map constructor cannot be empty. Please supply at least one key \"\n+            + \"value pair (see https://github.com/confluentinc/ksql/issues/4239).\");\n+      }\n+\n+      final List<SqlType> gkeyTypes = exp.getMap()\n+          .keySet()\n+          .stream()\n+          .map(key -> {\n+            process(key, context);\n+            return context.getSqlType();\n+          })\n+          .collect(Collectors.toList());\n+\n+      if (gkeyTypes.stream().anyMatch(type -> !SqlTypes.STRING.equals(type))) {\n+        throw new KsqlException(\"Only STRING keys are supported in maps but got: \" + gkeyTypes);\n+      }\n+\n+      final List<SqlType> sqlTypes = exp.getMap()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "841a14d02977d865beef46137eaab0a21d6fe055"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM5NDMzMQ==", "bodyText": "Second part you've covered above. Lets just make sure its captured in an issue, maybe linking to it from the error.\nStill think the error message could be improve to:\n| Can not construct MAP with all NULL values.\nAnd add the trick of using CAST.", "url": "https://github.com/confluentinc/ksql/pull/4232#discussion_r367394331", "createdAt": "2020-01-16T12:37:07Z", "author": {"login": "big-andy-coates"}, "path": "ksql-execution/src/main/java/io/confluent/ksql/execution/util/ExpressionTypeManager.java", "diffHunk": "@@ -331,6 +333,83 @@ public Void visitSubscriptExpression(\n       return null;\n     }\n \n+    @Override\n+    public Void visitCreateArrayExpression(\n+        final CreateArrayExpression exp,\n+        final ExpressionTypeContext context\n+    ) {\n+      if (exp.getValues().isEmpty()) {\n+        throw new KsqlException(\"Cannot extract type from empty array!\");\n+      }\n+\n+      final List<SqlType> sqlTypes = exp\n+          .getValues()\n+          .stream()\n+          .map(val -> {\n+            process(val, context);\n+            return context.getSqlType();\n+          })\n+          .filter(Objects::nonNull)\n+          .distinct()\n+          .collect(Collectors.toList());\n+\n+      if (sqlTypes.size() == 0) {\n+        throw new KsqlException(\"Cannot extract type from array of nulls!\");\n+      }\n+\n+      if (sqlTypes.size() != 1) {\n+        throw new KsqlException(\n+            \"Invalid array expression! All values must be of the same type.\" + exp);\n+      }\n+\n+      context.setSqlType(SqlArray.of(sqlTypes.get(0)));\n+      return null;\n+    }\n+\n+    @Override\n+    public Void visitCreateMapExpression(\n+        final CreateMapExpression exp,\n+        final ExpressionTypeContext context\n+    ) {\n+      if (exp.getMap().isEmpty()) {\n+        throw new KsqlException(\"Cannot extract type from empty map!\");\n+      }\n+\n+      final boolean anyNonStringKeys = exp.getMap()\n+          .keySet()\n+          .stream()\n+          .map(key -> {\n+            process(key, context);\n+            return context.getSqlType();\n+          })\n+          .anyMatch(type -> !SqlTypes.STRING.equals(type));\n+      if (anyNonStringKeys) {\n+        throw new KsqlException(\"Cannot support non-string keys on maps:\" + exp);\n+      }\n+\n+      final List<SqlType> sqlTypes = exp.getMap()\n+          .values()\n+          .stream()\n+          .map(val -> {\n+            process(val, context);\n+            return context.getSqlType();\n+          })\n+          .distinct()\n+          .collect(Collectors.toList());\n+\n+      if (sqlTypes.size() != 1) {\n+        throw new KsqlException(\n+            \"Invalid map expression! All values must be of the same type. \" + exp);\n+      }\n+\n+      if (sqlTypes.get(0) == null) {\n+        throw new KsqlException(\"Maps do not accept null values!\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzY5MDE1OA=="}, "originalCommit": {"oid": "fc6cff1f3b319a603999c9e2b0ed591d12b1b22b"}, "originalPosition": 83}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzODgxNTU3", "url": "https://github.com/confluentinc/ksql/pull/4232#pullrequestreview-343881557", "createdAt": "2020-01-16T12:38:45Z", "commit": {"oid": "841a14d02977d865beef46137eaab0a21d6fe055"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxMjozODo0NVrOFeYAjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxMjo0NTo0NVrOFeYLCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM5NDk1OQ==", "bodyText": "might want to rename this test file... it's currently asarray.json and AS_ARRAY no longer exists ;) . How about arrays.json :p", "url": "https://github.com/confluentinc/ksql/pull/4232#discussion_r367394959", "createdAt": "2020-01-16T12:38:45Z", "author": {"login": "big-andy-coates"}, "path": "ksql-functional-tests/src/test/resources/query-validation-tests/asarray.json", "diffHunk": "@@ -7,7 +7,7 @@\n       \"name\": \"construct a list from two elements\",\n       \"statements\": [\n         \"CREATE STREAM TEST (a INT, b INT) WITH (kafka_topic='test_topic', value_format='JSON');\",\n-        \"CREATE STREAM OUTPUT AS SELECT as_array(a, b, 3) as l FROM TEST;\"\n+        \"CREATE STREAM OUTPUT AS SELECT ARRAY[a, b, 3] as l FROM TEST;\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "841a14d02977d865beef46137eaab0a21d6fe055"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM5NTM2Mg==", "bodyText": "likewise, consider renaming this test file.", "url": "https://github.com/confluentinc/ksql/pull/4232#discussion_r367395362", "createdAt": "2020-01-16T12:39:53Z", "author": {"login": "big-andy-coates"}, "path": "ksql-functional-tests/src/test/resources/query-validation-tests/asmap.json", "diffHunk": "@@ -3,6 +3,19 @@\n     \"Tests covering map creation\"\n   ],\n   \"tests\": [\n+    {\n+      \"name\": \"create map from named tuples\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "841a14d02977d865beef46137eaab0a21d6fe055"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM5NzY0MQ==", "bodyText": "I don't think we're fully testing the coercer with this test as the 1 from ARRAY[ARRAY[1]] will default to a IntegerLiteral and the type is ARRAY<ARRAY<INT>>.\nWhat happens if you make it ARRAY<ARRAY<BIGINT>>?\nSame goes for the map test below.", "url": "https://github.com/confluentinc/ksql/pull/4232#discussion_r367397641", "createdAt": "2020-01-16T12:45:45Z", "author": {"login": "big-andy-coates"}, "path": "ksql-functional-tests/src/test/resources/rest-query-validation-tests/insert-values.json", "diffHunk": "@@ -226,14 +226,38 @@\n       \"name\": \"should handle arbitrary expressions\",\n       \"statements\": [\n         \"CREATE STREAM TEST (I INT, A ARRAY<INT>) WITH (kafka_topic='test_topic', value_format='JSON');\",\n-        \"INSERT INTO TEST (I, A) VALUES (-1, AS_ARRAY(1, 1 + 1, 3));\"\n+        \"INSERT INTO TEST (I, A) VALUES (-1, ARRAY[1, 1 + 1, 3]);\"\n       ],\n       \"inputs\": [\n       ],\n       \"outputs\": [\n         {\"topic\": \"test_topic\", \"key\": null, \"value\": {\"I\": -1, \"A\": [1, 2, 3]}}\n       ]\n     },\n+    {\n+      \"name\": \"should handle arbitrary nested expressions\",\n+      \"statements\": [\n+        \"CREATE STREAM TEST (I INT, A ARRAY<ARRAY<INT>>) WITH (kafka_topic='test_topic', value_format='JSON');\",\n+        \"INSERT INTO TEST (I, A) VALUES (-1, ARRAY[ARRAY[1]]);\"\n+      ],\n+      \"inputs\": [\n+      ],\n+      \"outputs\": [\n+        {\"topic\": \"test_topic\", \"key\": null, \"value\": {\"I\": -1, \"A\": [[1]]}}\n+      ]\n+    },", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "841a14d02977d865beef46137eaab0a21d6fe055"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74d5d9436b449194b36d00f8fa969892b0df269e", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/74d5d9436b449194b36d00f8fa969892b0df269e", "committedDate": "2020-01-17T17:36:20Z", "message": "feat: native map/array constructors\n\nBREAKING CHANGE: the old syntax for creating arrays using the builtin\nAS_ARRAY function will no longer work"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "911761ae0337c61aa0ffb3fd95ae61a0bc4f0ac1", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/911761ae0337c61aa0ffb3fd95ae61a0bc4f0ac1", "committedDate": "2020-01-17T17:36:20Z", "message": "feat: improve error messages"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79dff2ffe287a7fff2893d6e584652a3baeec219", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/79dff2ffe287a7fff2893d6e584652a3baeec219", "committedDate": "2020-01-17T18:09:13Z", "message": "fix: andys comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e1896e082ada55830e13083daaf2ac4197deac34", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/e1896e082ada55830e13083daaf2ac4197deac34", "committedDate": "2020-01-16T20:52:09Z", "message": "fix: andys comments"}, "afterCommit": {"oid": "79dff2ffe287a7fff2893d6e584652a3baeec219", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/79dff2ffe287a7fff2893d6e584652a3baeec219", "committedDate": "2020-01-17T18:09:13Z", "message": "fix: andys comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 190, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}