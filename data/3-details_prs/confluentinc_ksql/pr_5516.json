{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI1NTQyOTk0", "number": 5516, "title": "feat: reload TLS certificate without restarting server", "bodyText": "Description\nImplements the equivalent functionality the ksqlDB server used to inherit from rest-utils (confluentinc/rest-utils#156) in Vert.x. When a change to the specified watch location is detected, the Vert.x HttpServers are recreated in order to reload the certificates. It's necessary to recreate rather than simply restart the servers because Vert.x only loads TLS certs at the time that the KeyStoreHelper is created, which is only when servers are created.\nThis PR also ports over the TRUST_STORE_TYPE and KEY_STORE_TYPE configs which were missed in the rest-utils -> Vert.x migration.\nTesting done\nUnit + manual tests.\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-05-31T00:51:17Z", "url": "https://github.com/confluentinc/ksql/pull/5516", "merged": true, "mergeCommit": {"oid": "a5920b0f31fe2f32adcfe8cd03e1f2bd14c1368e"}, "closed": true, "closedAt": "2020-06-08T17:36:40Z", "author": {"login": "vcrfxia"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcmgqVAAH2gAyNDI1NTQyOTk0OjgzZTYwN2ExNmZmYTJiYWVhNjk2Mjk3MzcwODcxOTU0NDU4ZTE4NjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcpT3afAFqTQyNjQ1ODM5OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "83e607a16ffa2baea696297370871954458e1864", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/83e607a16ffa2baea696297370871954458e1864", "committedDate": "2020-05-31T00:38:24Z", "message": "feat: implement auto cert reload"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dafa8e05e4e300853f37495f15dbc82282b5d948", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/dafa8e05e4e300853f37495f15dbc82282b5d948", "committedDate": "2020-05-31T00:45:52Z", "message": "chore: checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ffaf29d8bac086c29b2352412ae422cc0745836", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/0ffaf29d8bac086c29b2352412ae422cc0745836", "committedDate": "2020-05-31T00:51:06Z", "message": "chore: minor rename"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxNDg3NDQ5", "url": "https://github.com/confluentinc/ksql/pull/5516#pullrequestreview-421487449", "createdAt": "2020-05-31T11:58:23Z", "commit": {"oid": "0ffaf29d8bac086c29b2352412ae422cc0745836"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0zMVQxMTo1ODoyM1rOGc4iNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0zMVQxMjowMjoyOFrOGc4jeg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjkzOTU3NQ==", "bodyText": "As a general design principle best not to rely on statics as they pollute the global namespace.", "url": "https://github.com/confluentinc/ksql/pull/5516#discussion_r432939575", "createdAt": "2020-05-31T11:58:23Z", "author": {"login": "purplefox"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/FileWatcher.java", "diffHunk": "@@ -0,0 +1,128 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"); you may not use\n+ * this file except in compliance with the License.  You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.api.server;\n+\n+import java.io.IOException;\n+import java.nio.file.FileSystems;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.StandardWatchEventKinds;\n+import java.nio.file.WatchEvent;\n+import java.nio.file.WatchKey;\n+import java.nio.file.WatchService;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.ThreadFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+// reference:\n+// https://gist.github.com/danielflower/f54c2fe42d32356301c68860a4ab21ed\n+// https://github.com/confluentinc/rest-utils/blob/master/core/src/main/java/io/confluent/rest/FileWatcher.java\n+public class FileWatcher implements Runnable {\n+\n+  private static final Logger log = LoggerFactory.getLogger(FileWatcher.class);\n+  private static final ExecutorService executor = Executors.newFixedThreadPool(1,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ffaf29d8bac086c29b2352412ae422cc0745836"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjkzOTY1Mg==", "bodyText": "Also you probably don't need a custom executor at all - you can use a Vert.x worker thread for this.", "url": "https://github.com/confluentinc/ksql/pull/5516#discussion_r432939652", "createdAt": "2020-05-31T11:59:28Z", "author": {"login": "purplefox"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/FileWatcher.java", "diffHunk": "@@ -0,0 +1,128 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"); you may not use\n+ * this file except in compliance with the License.  You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.api.server;\n+\n+import java.io.IOException;\n+import java.nio.file.FileSystems;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.StandardWatchEventKinds;\n+import java.nio.file.WatchEvent;\n+import java.nio.file.WatchKey;\n+import java.nio.file.WatchService;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.ThreadFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+// reference:\n+// https://gist.github.com/danielflower/f54c2fe42d32356301c68860a4ab21ed\n+// https://github.com/confluentinc/rest-utils/blob/master/core/src/main/java/io/confluent/rest/FileWatcher.java\n+public class FileWatcher implements Runnable {\n+\n+  private static final Logger log = LoggerFactory.getLogger(FileWatcher.class);\n+  private static final ExecutorService executor = Executors.newFixedThreadPool(1,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjkzOTU3NQ=="}, "originalCommit": {"oid": "0ffaf29d8bac086c29b2352412ae422cc0745836"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjkzOTg2Ng==", "bodyText": "I think this is more complex than it needs to be. Instead of individually starting and stopping each http server in each ServerVerticle I think it would be simpler just to add a restart() method to Server which simply stopped the Server and started it again, e.g.:\npublic void restart() {\n  stop();\n  start();\n}\n\nI haven't tried this, but seems like it should work (?)", "url": "https://github.com/confluentinc/ksql/pull/5516#discussion_r432939866", "createdAt": "2020-05-31T12:01:56Z", "author": {"login": "purplefox"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/Server.java", "diffHunk": "@@ -324,4 +345,28 @@ private static HttpServerOptions createHttpServerOptions(final KsqlRestConfig ks\n     return listeners;\n   }\n \n+  private static void configureTlsCertReload(\n+      final KsqlRestConfig config,\n+      final Set<ServerVerticle> serverVerticles\n+  ) {\n+    if (config.getBoolean(KsqlRestConfig.SSL_KEYSTORE_RELOAD_CONFIG)) {\n+      final Path watchLocation;\n+      if (!config.getString(KsqlRestConfig.SSL_KEYSTORE_WATCH_LOCATION_CONFIG).isEmpty()) {\n+        watchLocation = Paths.get(\n+            config.getString(KsqlRestConfig.SSL_KEYSTORE_WATCH_LOCATION_CONFIG));\n+      } else {\n+        watchLocation = Paths.get(config.getString(SslConfigs.SSL_KEYSTORE_LOCATION_CONFIG));\n+      }\n+\n+      try {\n+        FileWatcher.onFileChange(\n+            watchLocation,\n+            () -> serverVerticles.forEach(ServerVerticle::restartServer)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ffaf29d8bac086c29b2352412ae422cc0745836"}, "originalPosition": 93}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjkzOTg5OA==", "bodyText": "As previous comment, seems overcomplex - just stopped and starting the Server should do the trick?", "url": "https://github.com/confluentinc/ksql/pull/5516#discussion_r432939898", "createdAt": "2020-05-31T12:02:28Z", "author": {"login": "purplefox"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/ServerVerticle.java", "diffHunk": "@@ -99,10 +100,39 @@ public void stop(final Promise<Void> stopPromise) {\n     }\n   }\n \n+  // Creates a new server, rather than simply stopping and restarting, in order to reload TLS certs\n+  public void restartServer() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ffaf29d8bac086c29b2352412ae422cc0745836"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e0c36561b67102e733c4c49028096a9c9344d49", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/4e0c36561b67102e733c4c49028096a9c9344d49", "committedDate": "2020-06-01T17:46:17Z", "message": "chore: use Vert.x worker rather than executor service"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48929a97b9e8af4de25959ae6736edba13e4e619", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/48929a97b9e8af4de25959ae6736edba13e4e619", "committedDate": "2020-06-01T18:36:55Z", "message": "chore: move logic for restarting server from ServerVerticle to Server"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2849468643afe4d8f385c886cf39bd2bcf9b7189", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/2849468643afe4d8f385c886cf39bd2bcf9b7189", "committedDate": "2020-06-01T19:01:37Z", "message": "test: client trust store should always be valid"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5e0821cbf9649ee7af891c55e44b9638fc870c3", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/d5e0821cbf9649ee7af891c55e44b9638fc870c3", "committedDate": "2020-06-02T03:48:09Z", "message": "chore: findbugs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87917ea54b026c88c93eff9a3b92fd0f6e1a4f7d", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/87917ea54b026c88c93eff9a3b92fd0f6e1a4f7d", "committedDate": "2020-06-02T21:19:38Z", "message": "fix: use separate thread for file watcher"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ff1082b15566cc52fb7aed1006efd40a199aa30", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/7ff1082b15566cc52fb7aed1006efd40a199aa30", "committedDate": "2020-06-04T16:24:03Z", "message": "test: prevent cert reload test from affecting other TLS tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7221eadf30d50666a81b461924636aa5b5aecd7d", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/7221eadf30d50666a81b461924636aa5b5aecd7d", "committedDate": "2020-06-04T16:24:47Z", "message": "Merge branch 'master' into auto-cert-reload"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c700eb993b23c0367232456fe6b2c33680cfedec", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/c700eb993b23c0367232456fe6b2c33680cfedec", "committedDate": "2020-06-04T16:29:26Z", "message": "test: add logging to debug potential flakiness with shouldReloadCert()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b23542f9b62de47fa3535694231b8d991bd22490", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/b23542f9b62de47fa3535694231b8d991bd22490", "committedDate": "2020-06-04T19:12:50Z", "message": "test: update assertion to be more informative on failure"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1MTYzMjU4", "url": "https://github.com/confluentinc/ksql/pull/5516#pullrequestreview-425163258", "createdAt": "2020-06-05T09:59:11Z", "commit": {"oid": "b23542f9b62de47fa3535694231b8d991bd22490"}, "state": "APPROVED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwOTo1OToxMVrOGfoRuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxMDowODo0NFrOGfolOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTgxODkzNg==", "bodyText": "Is there any need to interrupt the thread here? If shutdown() is called from this same thread then you set the shutdown flag which means the run() method will return exit ok.", "url": "https://github.com/confluentinc/ksql/pull/5516#discussion_r435818936", "createdAt": "2020-06-05T09:59:11Z", "author": {"login": "purplefox"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/FileWatcher.java", "diffHunk": "@@ -0,0 +1,140 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"); you may not use\n+ * this file except in compliance with the License.  You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.api.server;\n+\n+import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;\n+import java.io.IOException;\n+import java.nio.file.FileSystems;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.StandardWatchEventKinds;\n+import java.nio.file.WatchEvent;\n+import java.nio.file.WatchKey;\n+import java.nio.file.WatchService;\n+import java.util.Objects;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+// reference:\n+// https://gist.github.com/danielflower/f54c2fe42d32356301c68860a4ab21ed\n+// https://github.com/confluentinc/rest-utils/blob/master/core/src/main/java/io/confluent/rest/FileWatcher.java\n+/**\n+ * Watches a file and calls a callback when it is changed.\n+ */\n+public class FileWatcher implements Runnable {\n+\n+  private static final Logger log = LoggerFactory.getLogger(FileWatcher.class);\n+\n+  public interface Callback {\n+    void run() throws Exception;\n+  }\n+\n+  private volatile boolean shutdown;\n+  private final WatchService watchService;\n+  private final Path file;\n+  private final Callback callback;\n+  private Thread thread;\n+\n+  @SuppressFBWarnings(\n+      value = \"NP_NULL_ON_SOME_PATH_FROM_RETURN_VALUE\",\n+      justification = \"Null check on file.getParent() is present\"\n+  )\n+  public FileWatcher(final Path file, final Callback callback) throws IOException {\n+    this.file = Objects.requireNonNull(file);\n+    Objects.requireNonNull(file.getParent(), \"Watch location must have parent\");\n+    this.watchService = FileSystems.getDefault().newWatchService();\n+    // Listen to both CREATE and MODIFY to reload, which handles delete then create.\n+    file.getParent().register(watchService,\n+        StandardWatchEventKinds.ENTRY_CREATE,\n+        StandardWatchEventKinds.ENTRY_MODIFY);\n+    this.callback = Objects.requireNonNull(callback);\n+  }\n+\n+  /**\n+   * Starts the file watcher in a separate thread\n+   */\n+  public synchronized void start() {\n+    log.info(\"Starting file watcher to watch for changes: \" + file);\n+    thread = new Thread(this);\n+    thread.start();\n+  }\n+\n+  /**\n+   * Stops watching the file and closes the watch service\n+   */\n+  public synchronized void shutdown() {\n+    shutdown = true;\n+    log.info(\"Stopped watching for TLS cert changes.\");\n+    if (thread != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b23542f9b62de47fa3535694231b8d991bd22490"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTgxOTY3NQ==", "bodyText": "I don't think the startFileWatcher flag is necessary if you don't interrupt the watcher thread (see previous comment). This means you can simplify things and have a simple start/stop method as before and always create a new filewatcher in start().", "url": "https://github.com/confluentinc/ksql/pull/5516#discussion_r435819675", "createdAt": "2020-06-05T10:00:24Z", "author": {"login": "purplefox"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/Server.java", "diffHunk": "@@ -89,6 +93,10 @@ public Server(final Vertx vertx, final KsqlRestConfig config, final Endpoints en\n   }\n \n   public synchronized void start() {\n+    start(true);\n+  }\n+\n+  private synchronized void start(final boolean startFileWatcher) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b23542f9b62de47fa3535694231b8d991bd22490"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTgxOTgwNg==", "bodyText": "As above, parameter is unnecessary", "url": "https://github.com/confluentinc/ksql/pull/5516#discussion_r435819806", "createdAt": "2020-06-05T10:00:39Z", "author": {"login": "purplefox"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/Server.java", "diffHunk": "@@ -156,12 +166,19 @@ public synchronized void start() {\n   }\n \n   public synchronized void stop() {\n+    stop(true);\n+  }\n+\n+  private synchronized void stop(final boolean stopFileWatcher) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b23542f9b62de47fa3535694231b8d991bd22490"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTgyMTAwNA==", "bodyText": "You can avoid this if FileWatcher extends Thread", "url": "https://github.com/confluentinc/ksql/pull/5516#discussion_r435821004", "createdAt": "2020-06-05T10:02:50Z", "author": {"login": "purplefox"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/FileWatcher.java", "diffHunk": "@@ -0,0 +1,140 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"); you may not use\n+ * this file except in compliance with the License.  You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.api.server;\n+\n+import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;\n+import java.io.IOException;\n+import java.nio.file.FileSystems;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.StandardWatchEventKinds;\n+import java.nio.file.WatchEvent;\n+import java.nio.file.WatchKey;\n+import java.nio.file.WatchService;\n+import java.util.Objects;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+// reference:\n+// https://gist.github.com/danielflower/f54c2fe42d32356301c68860a4ab21ed\n+// https://github.com/confluentinc/rest-utils/blob/master/core/src/main/java/io/confluent/rest/FileWatcher.java\n+/**\n+ * Watches a file and calls a callback when it is changed.\n+ */\n+public class FileWatcher implements Runnable {\n+\n+  private static final Logger log = LoggerFactory.getLogger(FileWatcher.class);\n+\n+  public interface Callback {\n+    void run() throws Exception;\n+  }\n+\n+  private volatile boolean shutdown;\n+  private final WatchService watchService;\n+  private final Path file;\n+  private final Callback callback;\n+  private Thread thread;\n+\n+  @SuppressFBWarnings(\n+      value = \"NP_NULL_ON_SOME_PATH_FROM_RETURN_VALUE\",\n+      justification = \"Null check on file.getParent() is present\"\n+  )\n+  public FileWatcher(final Path file, final Callback callback) throws IOException {\n+    this.file = Objects.requireNonNull(file);\n+    Objects.requireNonNull(file.getParent(), \"Watch location must have parent\");\n+    this.watchService = FileSystems.getDefault().newWatchService();\n+    // Listen to both CREATE and MODIFY to reload, which handles delete then create.\n+    file.getParent().register(watchService,\n+        StandardWatchEventKinds.ENTRY_CREATE,\n+        StandardWatchEventKinds.ENTRY_MODIFY);\n+    this.callback = Objects.requireNonNull(callback);\n+  }\n+\n+  /**\n+   * Starts the file watcher in a separate thread\n+   */\n+  public synchronized void start() {\n+    log.info(\"Starting file watcher to watch for changes: \" + file);\n+    thread = new Thread(this);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b23542f9b62de47fa3535694231b8d991bd22490"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTgyMTY4Nw==", "bodyText": "Doesn't need to be synchronized if we don't have a thread member and shutdown is volatile", "url": "https://github.com/confluentinc/ksql/pull/5516#discussion_r435821687", "createdAt": "2020-06-05T10:04:16Z", "author": {"login": "purplefox"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/FileWatcher.java", "diffHunk": "@@ -0,0 +1,140 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"); you may not use\n+ * this file except in compliance with the License.  You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.api.server;\n+\n+import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;\n+import java.io.IOException;\n+import java.nio.file.FileSystems;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.StandardWatchEventKinds;\n+import java.nio.file.WatchEvent;\n+import java.nio.file.WatchKey;\n+import java.nio.file.WatchService;\n+import java.util.Objects;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+// reference:\n+// https://gist.github.com/danielflower/f54c2fe42d32356301c68860a4ab21ed\n+// https://github.com/confluentinc/rest-utils/blob/master/core/src/main/java/io/confluent/rest/FileWatcher.java\n+/**\n+ * Watches a file and calls a callback when it is changed.\n+ */\n+public class FileWatcher implements Runnable {\n+\n+  private static final Logger log = LoggerFactory.getLogger(FileWatcher.class);\n+\n+  public interface Callback {\n+    void run() throws Exception;\n+  }\n+\n+  private volatile boolean shutdown;\n+  private final WatchService watchService;\n+  private final Path file;\n+  private final Callback callback;\n+  private Thread thread;\n+\n+  @SuppressFBWarnings(\n+      value = \"NP_NULL_ON_SOME_PATH_FROM_RETURN_VALUE\",\n+      justification = \"Null check on file.getParent() is present\"\n+  )\n+  public FileWatcher(final Path file, final Callback callback) throws IOException {\n+    this.file = Objects.requireNonNull(file);\n+    Objects.requireNonNull(file.getParent(), \"Watch location must have parent\");\n+    this.watchService = FileSystems.getDefault().newWatchService();\n+    // Listen to both CREATE and MODIFY to reload, which handles delete then create.\n+    file.getParent().register(watchService,\n+        StandardWatchEventKinds.ENTRY_CREATE,\n+        StandardWatchEventKinds.ENTRY_MODIFY);\n+    this.callback = Objects.requireNonNull(callback);\n+  }\n+\n+  /**\n+   * Starts the file watcher in a separate thread\n+   */\n+  public synchronized void start() {\n+    log.info(\"Starting file watcher to watch for changes: \" + file);\n+    thread = new Thread(this);\n+    thread.start();\n+  }\n+\n+  /**\n+   * Stops watching the file and closes the watch service\n+   */\n+  public synchronized void shutdown() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b23542f9b62de47fa3535694231b8d991bd22490"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTgyMjg4Mw==", "bodyText": "Probably should log at error unless this is expected in normal operation?", "url": "https://github.com/confluentinc/ksql/pull/5516#discussion_r435822883", "createdAt": "2020-06-05T10:06:31Z", "author": {"login": "purplefox"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/FileWatcher.java", "diffHunk": "@@ -0,0 +1,140 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"); you may not use\n+ * this file except in compliance with the License.  You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.api.server;\n+\n+import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;\n+import java.io.IOException;\n+import java.nio.file.FileSystems;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.StandardWatchEventKinds;\n+import java.nio.file.WatchEvent;\n+import java.nio.file.WatchKey;\n+import java.nio.file.WatchService;\n+import java.util.Objects;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+// reference:\n+// https://gist.github.com/danielflower/f54c2fe42d32356301c68860a4ab21ed\n+// https://github.com/confluentinc/rest-utils/blob/master/core/src/main/java/io/confluent/rest/FileWatcher.java\n+/**\n+ * Watches a file and calls a callback when it is changed.\n+ */\n+public class FileWatcher implements Runnable {\n+\n+  private static final Logger log = LoggerFactory.getLogger(FileWatcher.class);\n+\n+  public interface Callback {\n+    void run() throws Exception;\n+  }\n+\n+  private volatile boolean shutdown;\n+  private final WatchService watchService;\n+  private final Path file;\n+  private final Callback callback;\n+  private Thread thread;\n+\n+  @SuppressFBWarnings(\n+      value = \"NP_NULL_ON_SOME_PATH_FROM_RETURN_VALUE\",\n+      justification = \"Null check on file.getParent() is present\"\n+  )\n+  public FileWatcher(final Path file, final Callback callback) throws IOException {\n+    this.file = Objects.requireNonNull(file);\n+    Objects.requireNonNull(file.getParent(), \"Watch location must have parent\");\n+    this.watchService = FileSystems.getDefault().newWatchService();\n+    // Listen to both CREATE and MODIFY to reload, which handles delete then create.\n+    file.getParent().register(watchService,\n+        StandardWatchEventKinds.ENTRY_CREATE,\n+        StandardWatchEventKinds.ENTRY_MODIFY);\n+    this.callback = Objects.requireNonNull(callback);\n+  }\n+\n+  /**\n+   * Starts the file watcher in a separate thread\n+   */\n+  public synchronized void start() {\n+    log.info(\"Starting file watcher to watch for changes: \" + file);\n+    thread = new Thread(this);\n+    thread.start();\n+  }\n+\n+  /**\n+   * Stops watching the file and closes the watch service\n+   */\n+  public synchronized void shutdown() {\n+    shutdown = true;\n+    log.info(\"Stopped watching for TLS cert changes.\");\n+    if (thread != null) {\n+      thread.interrupt();\n+    }\n+    try {\n+      watchService.close();\n+    } catch (IOException e) {\n+      log.info(\"Error closing watch service\", e);\n+    }\n+  }\n+\n+  @Override\n+  public void run() {\n+    try {\n+      while (!shutdown) {\n+        try {\n+          handleNextWatchNotification();\n+        } catch (InterruptedException e) {\n+          throw e;\n+        } catch (Exception e) {\n+          log.info(\"Watch service caught exception, will continue:\" + e);\n+        }\n+      }\n+    } catch (InterruptedException e) {\n+      log.info(\"Ending watch due to interrupt\");\n+    }\n+  }\n+\n+  @SuppressWarnings(\"unchecked\")\n+  @SuppressFBWarnings(\n+      value = \"NP_NULL_ON_SOME_PATH_FROM_RETURN_VALUE\",\n+      justification = \"Null check on file.getParent() is present above\"\n+  )\n+  private void handleNextWatchNotification() throws InterruptedException {\n+    // wait for key to be signalled\n+    final WatchKey key = watchService.take();\n+    log.info(\"Watch Key notified\");\n+    for (WatchEvent<?> event : key.pollEvents()) {\n+      final WatchEvent.Kind<?> kind = event.kind();\n+      if (kind == StandardWatchEventKinds.OVERFLOW) {\n+        log.debug(\"Watch event is OVERFLOW\");\n+        continue;\n+      }\n+      final WatchEvent<Path> ev = (WatchEvent<Path>)event;\n+      final Path changed = file.getParent().resolve(ev.context());\n+      log.debug(\"Watch file change: \" + ev.context() + \"=>\" + changed);\n+      // use Path.equals rather than Files.isSameFile to handle updated symlinks\n+      if (Files.exists(changed) && changed.equals(file)) {\n+        log.info(\"Change event for watched file: \" + file);\n+        try {\n+          callback.run();\n+        } catch (Exception e) {\n+          log.warn(\"Hit error callback on file change\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b23542f9b62de47fa3535694231b8d991bd22490"}, "originalPosition": 132}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTgyMzkyOQ==", "bodyText": "I think it would be good to test reloading the server more than once - i.e. changing the cert more than once, as there might be a bug in the filewatcher/reloading that only manifests after the reload has been done once.", "url": "https://github.com/confluentinc/ksql/pull/5516#discussion_r435823929", "createdAt": "2020-06-05T10:08:44Z", "author": {"login": "purplefox"}, "path": "ksqldb-rest-app/src/test/java/io/confluent/ksql/api/TlsTest.java", "diffHunk": "@@ -49,18 +61,82 @@ protected KsqlRestConfig createServerConfig() {\n     config.put(SslConfigs.SSL_TRUSTSTORE_PASSWORD_CONFIG, trustStorePassword);\n     config.put(KsqlRestConfig.VERTICLE_INSTANCES, 4);\n \n+    config.put(KsqlRestConfig.SSL_KEYSTORE_RELOAD_CONFIG, true);\n+\n     return new KsqlRestConfig(config);\n   }\n \n   @Override\n   protected WebClientOptions createClientOptions() {\n+    // for this test file, the client must use a different trust store location than the server\n+    // since the client store should always be valid even when the server store is loaded with an\n+    // invalid cert\n+    String clientTrustStorePath = ServerKeyStore.clientKeyStoreProps()\n+        .get(SslConfigs.SSL_TRUSTSTORE_LOCATION_CONFIG);\n+    String clientTrustStorePassword = ServerKeyStore.clientKeyStoreProps()\n+        .get(SslConfigs.SSL_TRUSTSTORE_PASSWORD_CONFIG);\n+\n     return new WebClientOptions().setSsl(true).\n         setUseAlpn(true).\n         setProtocolVersion(HttpVersion.HTTP_2).\n-        setTrustAll(true).\n+        setTrustStoreOptions(\n+            new JksOptions().setPath(clientTrustStorePath).setPassword(clientTrustStorePassword)).\n         setVerifyHost(false).\n         setDefaultHost(\"localhost\").\n         setDefaultPort(server.getListeners().get(0).getPort());\n   }\n \n+  @Test\n+  public void shouldReloadCert() throws Exception {\n+    JsonObject requestBody = new JsonObject().put(\"sql\", DEFAULT_PULL_QUERY);\n+\n+    // Given: sanity check that a query succeeds\n+    HttpResponse<Buffer> response = sendRequest(\"/query-stream\", requestBody.toBuffer());\n+    assertThat(response.statusCode(), is(200));\n+    assertThat(response.statusMessage(), is(\"OK\"));\n+\n+    try {\n+      // When: load expired key store\n+      ServerKeyStore.loadExpiredServerKeyStore();\n+      assertThatEventually(\n+          \"Should fail to execute query with expired key store\",\n+          () -> {\n+            // re-create client since server port changes on restart\n+            this.client = createClient();\n+\n+            try {\n+              // this should fail\n+              sendRequest(\"/query-stream\", requestBody.toBuffer());\n+              return \"error: request should have failed but did not\";\n+            } catch (Exception e) {\n+              assertThat(e,\n+                  instanceOf(ExecutionException.class)); // thrown from CompletableFuture.get()\n+              return e.getMessage();\n+            }\n+          },\n+          containsString(\"javax.net.ssl.SSLHandshakeException: Failed to create SSL connection\"),\n+          TimeUnit.SECONDS.toMillis(1),\n+          TimeUnit.SECONDS.toMillis(1)\n+      );\n+    } finally { // restore cert regardless of failure above so as to not affect other tests\n+      // When: load valid store\n+      ServerKeyStore.loadValidServerKeyStore();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b23542f9b62de47fa3535694231b8d991bd22490"}, "originalPosition": 99}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "195827043ce599aef515799b64574fe1d3abae76", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/195827043ce599aef515799b64574fe1d3abae76", "committedDate": "2020-06-05T17:46:35Z", "message": "refactor: file watcher extends thread"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a1d13695028acd42f4a7b9920457446304f962c", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/7a1d13695028acd42f4a7b9920457446304f962c", "committedDate": "2020-06-05T17:47:42Z", "message": "fix: configure cert reload before deploying instances"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2NDU4Mzk5", "url": "https://github.com/confluentinc/ksql/pull/5516#pullrequestreview-426458399", "createdAt": "2020-06-08T17:25:41Z", "commit": {"oid": "7a1d13695028acd42f4a7b9920457446304f962c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxNzoyNTo0MVrOGgok6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxNzoyNTo0MVrOGgok6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg3MjQyNA==", "bodyText": "Hey @purplefox , now that FileWatcher extends Thread, do you think it makes sense to get rid of this shutdown() method and instead call interrupt() to terminate the file watcher? I'm wondering whether it's canonical to have a \"clean\" shutdown method like this, or if interrupt() is understood to be used for that purpose.", "url": "https://github.com/confluentinc/ksql/pull/5516#discussion_r436872424", "createdAt": "2020-06-08T17:25:41Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/FileWatcher.java", "diffHunk": "@@ -0,0 +1,129 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"); you may not use\n+ * this file except in compliance with the License.  You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.api.server;\n+\n+import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;\n+import java.io.IOException;\n+import java.nio.file.FileSystems;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.StandardWatchEventKinds;\n+import java.nio.file.WatchEvent;\n+import java.nio.file.WatchKey;\n+import java.nio.file.WatchService;\n+import java.util.Objects;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+// reference:\n+// https://gist.github.com/danielflower/f54c2fe42d32356301c68860a4ab21ed\n+// https://github.com/confluentinc/rest-utils/blob/master/core/src/main/java/io/confluent/rest/FileWatcher.java\n+/**\n+ * Watches a file and calls a callback when it is changed.\n+ */\n+public class FileWatcher extends Thread {\n+\n+  private static final Logger log = LoggerFactory.getLogger(FileWatcher.class);\n+\n+  public interface Callback {\n+    void run() throws Exception;\n+  }\n+\n+  private volatile boolean shutdown;\n+  private final WatchService watchService;\n+  private final Path file;\n+  private final Callback callback;\n+\n+  @SuppressFBWarnings(\n+      value = \"NP_NULL_ON_SOME_PATH_FROM_RETURN_VALUE\",\n+      justification = \"Null check on file.getParent() is present\"\n+  )\n+  public FileWatcher(final Path file, final Callback callback) throws IOException {\n+    this.file = Objects.requireNonNull(file);\n+    Objects.requireNonNull(file.getParent(), \"Watch location must have parent\");\n+    this.watchService = FileSystems.getDefault().newWatchService();\n+    // Listen to both CREATE and MODIFY to reload, which handles delete then create.\n+    file.getParent().register(watchService,\n+        StandardWatchEventKinds.ENTRY_CREATE,\n+        StandardWatchEventKinds.ENTRY_MODIFY);\n+    this.callback = Objects.requireNonNull(callback);\n+  }\n+\n+  /**\n+   * Closes the file watcher\n+   */\n+  public void shutdown() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a1d13695028acd42f4a7b9920457446304f962c"}, "originalPosition": 68}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4695, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}