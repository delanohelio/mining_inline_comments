{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA1MzM2NDQx", "number": 5105, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNzozNjowOFrOD0WeGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNzo1OTo0MFrOD0XKAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2MjIwNjk5OnYy", "diffSide": "RIGHT", "path": "docs-md/developer-guide/ksqldb-reference/show-queries.md", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNzozNjowOFrOGJQNbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNzozNjowOFrOGJQNbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM1NTk0OA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            * `Push`: these queries run on every single node in the cluster.\n          \n          \n            \n            * `Push`: these queries run on every node in the cluster.", "url": "https://github.com/confluentinc/ksql/pull/5105#discussion_r412355948", "createdAt": "2020-04-21T17:36:08Z", "author": {"login": "JimGalasyn"}, "path": "docs-md/developer-guide/ksqldb-reference/show-queries.md", "diffHunk": "@@ -30,15 +30,21 @@ Query Status\n * `ERROR`: the query has entered an error state.\r\n * `UNRESPONSIVE`: the host running the query returned an error when requesting the query status.\r\n \r\n+Query Type\r\n+-----------\r\n+\r\n+* `Push`: these queries run on every single node in the cluster.\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31faf6777c164960f10dfbe4ae1f74445e73d426"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2MjMwNTM4OnYy", "diffSide": "RIGHT", "path": "docs-md/developer-guide/ksqldb-reference/show-queries.md", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNzo1NjozNlrOGJRHYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQyMTo1OTozMVrOGKNnkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM3MDc4NA==", "bodyText": "cc @AlanConfluent can you review this section? I think we're standardizing on:\n\npersistent queries run on every node and materialize new state\npush queries are owned by the client and are terminated when the session ends (I don't think we should document that they only run on a single node, that's not the key characteristic)", "url": "https://github.com/confluentinc/ksql/pull/5105#discussion_r412370784", "createdAt": "2020-04-21T17:56:36Z", "author": {"login": "agavra"}, "path": "docs-md/developer-guide/ksqldb-reference/show-queries.md", "diffHunk": "@@ -30,15 +30,21 @@ Query Status\n * `ERROR`: the query has entered an error state.\r\n * `UNRESPONSIVE`: the host running the query returned an error when requesting the query status.\r\n \r\n+Query Type\r\n+-----------\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31faf6777c164960f10dfbe4ae1f74445e73d426"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM2MjA2NQ==", "bodyText": "Yes, I think the definitions you stated here are good ones.  The lifetime I think is one of the most important qualities from a client's perspective as well as the state materialized by persistent queries.  You could call out that persistent queries run until explicitly terminated, that might be too verbose for this purpose.", "url": "https://github.com/confluentinc/ksql/pull/5105#discussion_r413362065", "createdAt": "2020-04-22T21:59:31Z", "author": {"login": "AlanConfluent"}, "path": "docs-md/developer-guide/ksqldb-reference/show-queries.md", "diffHunk": "@@ -30,15 +30,21 @@ Query Status\n * `ERROR`: the query has entered an error state.\r\n * `UNRESPONSIVE`: the host running the query returned an error when requesting the query status.\r\n \r\n+Query Type\r\n+-----------\r", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM3MDc4NA=="}, "originalCommit": {"oid": "31faf6777c164960f10dfbe4ae1f74445e73d426"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2MjMwODYxOnYy", "diffSide": "RIGHT", "path": "ksqldb-common/src/main/java/io/confluent/ksql/util/KsqlConstants.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNzo1NzoxM1rOGJRJNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNzo1NzoxM1rOGJRJNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM3MTI1NQ==", "bodyText": "see the documentation comment above", "url": "https://github.com/confluentinc/ksql/pull/5105#discussion_r412371255", "createdAt": "2020-04-21T17:57:13Z", "author": {"login": "agavra"}, "path": "ksqldb-common/src/main/java/io/confluent/ksql/util/KsqlConstants.java", "diffHunk": "@@ -46,6 +46,11 @@ private KsqlConstants() {\n   public static final String DEFAULT_AVRO_SCHEMA_FULL_NAME =\n       AVRO_SCHEMA_NAMESPACE + \".\" + AVRO_SCHEMA_NAME;\n \n+  public enum KsqlQueryType {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31faf6777c164960f10dfbe4ae1f74445e73d426"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2MjMxMTY5OnYy", "diffSide": "RIGHT", "path": "ksqldb-engine/src/main/java/io/confluent/ksql/engine/KsqlEngine.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNzo1Nzo1OFrOGJRLIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNzo1Nzo1OFrOGJRLIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM3MTc0NQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                return ImmutableList.copyOf(new ArrayList<>(allLiveQueries));\n          \n          \n            \n                return ImmutableList.copyOf(allLiveQueries);\n          \n      \n    \n    \n  \n\nthe new ArrayList is not necesasry, copyOf takes an Iterable", "url": "https://github.com/confluentinc/ksql/pull/5105#discussion_r412371745", "createdAt": "2020-04-21T17:57:58Z", "author": {"login": "agavra"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/engine/KsqlEngine.java", "diffHunk": "@@ -128,10 +130,16 @@ public int numberOfLiveQueries() {\n     return primaryContext.getPersistentQuery(queryId);\n   }\n \n+  @Override\n   public List<PersistentQueryMetadata> getPersistentQueries() {\n     return ImmutableList.copyOf(primaryContext.getPersistentQueries().values());\n   }\n \n+  @Override\n+  public List<QueryMetadata> getAllLiveQueries() {\n+    return ImmutableList.copyOf(new ArrayList<>(allLiveQueries));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31faf6777c164960f10dfbe4ae1f74445e73d426"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2MjMxODc2OnYy", "diffSide": "RIGHT", "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/execution/ListQueriesExecutor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNzo1OTozMVrOGJRPlg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNzo1OTozMVrOGJRPlg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM3Mjg4Ng==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                          System.out.println(\"what is being returned\");", "url": "https://github.com/confluentinc/ksql/pull/5105#discussion_r412372886", "createdAt": "2020-04-21T17:59:31Z", "author": {"login": "agavra"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/execution/ListQueriesExecutor.java", "diffHunk": "@@ -100,19 +100,36 @@ private ListQueriesExecutor() { }\n   private static Map<QueryId, RunningQuery> getLocalSimple(\n       final KsqlExecutionContext executionContext\n   ) {\n-    return executionContext\n-        .getPersistentQueries()\n+    final Map<QueryId, RunningQuery> persistentQueries =  executionContext\n+        .getAllLiveQueries()\n         .stream()\n         .collect(Collectors.toMap(\n-            PersistentQueryMetadata::getQueryId,\n-            q -> new RunningQuery(\n-                q.getStatementString(),\n-                ImmutableSet.of(q.getSinkName().text()),\n-                ImmutableSet.of(q.getResultTopic().getKafkaTopicName()),\n-                q.getQueryId(),\n-                QueryStatusCount.fromStreamsStateCounts(\n-                    Collections.singletonMap(KafkaStreams.State.valueOf(q.getState()), 1)))\n+            QueryMetadata::getQueryId,\n+            q -> {\n+              if (q instanceof PersistentQueryMetadata) {\n+                System.out.println(\"getting local\");\n+                final PersistentQueryMetadata persistentQuery = (PersistentQueryMetadata) q;\n+                return new RunningQuery(\n+                    q.getStatementString(),\n+                    ImmutableSet.of(persistentQuery.getSinkName().text()),\n+                    ImmutableSet.of(persistentQuery.getResultTopic().getKafkaTopicName()),\n+                    q.getQueryId(),\n+                    QueryStatusCount.fromStreamsStateCounts(\n+                        Collections.singletonMap(KafkaStreams.State.valueOf(q.getState()), 1)),\n+                    q.getQueryType());\n+              }\n+              System.out.println(\"what is being returned\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31faf6777c164960f10dfbe4ae1f74445e73d426"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2MjMxOTM4OnYy", "diffSide": "RIGHT", "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/execution/ListQueriesExecutor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNzo1OTo0MFrOGJRP8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNzo1OTo0MFrOGJRP8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM3Mjk3Ng==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            System.out.println(\"getting local\");", "url": "https://github.com/confluentinc/ksql/pull/5105#discussion_r412372976", "createdAt": "2020-04-21T17:59:40Z", "author": {"login": "agavra"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/execution/ListQueriesExecutor.java", "diffHunk": "@@ -100,19 +100,36 @@ private ListQueriesExecutor() { }\n   private static Map<QueryId, RunningQuery> getLocalSimple(\n       final KsqlExecutionContext executionContext\n   ) {\n-    return executionContext\n-        .getPersistentQueries()\n+    final Map<QueryId, RunningQuery> persistentQueries =  executionContext\n+        .getAllLiveQueries()\n         .stream()\n         .collect(Collectors.toMap(\n-            PersistentQueryMetadata::getQueryId,\n-            q -> new RunningQuery(\n-                q.getStatementString(),\n-                ImmutableSet.of(q.getSinkName().text()),\n-                ImmutableSet.of(q.getResultTopic().getKafkaTopicName()),\n-                q.getQueryId(),\n-                QueryStatusCount.fromStreamsStateCounts(\n-                    Collections.singletonMap(KafkaStreams.State.valueOf(q.getState()), 1)))\n+            QueryMetadata::getQueryId,\n+            q -> {\n+              if (q instanceof PersistentQueryMetadata) {\n+                System.out.println(\"getting local\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31faf6777c164960f10dfbe4ae1f74445e73d426"}, "originalPosition": 37}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3586, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}