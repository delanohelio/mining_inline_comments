{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg4MjEwMDMx", "number": 4777, "title": "fix: add transfer-encoding:chunked header if Jetty omits this", "bodyText": "Description\nFixes #4760\nIf the request contains a connection:close header, it appears Jetty sends back a response without content-length set. Vert.x doesn't like this as it expects content-length to be set for all non chunked responses.\nThis works around the issue by adding transfer-encoding:chunked if Jetty omits this.\nNote that the ksql CLI doesn't seem to send connection:close so this issue only seems to affect the reproducer.\nTesting done\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-03-14T08:02:02Z", "url": "https://github.com/confluentinc/ksql/pull/4777", "merged": true, "mergeCommit": {"oid": "fba15be104e3081575735cc7960850aed83ad250"}, "closed": true, "closedAt": "2020-03-16T09:59:43Z", "author": {"login": "purplefox"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcNgMnDAH2gAyMzg4MjEwMDMxOmUzMmQzYjRiMzIwYjIyNzk2NmE5NTdiZTMzNGEzMTI1NmNiMGUxNzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcOJ2eSAH2gAyMzg4MjEwMDMxOmE3MWY2NTRjNWZiMmJkNjk1ZWQxOTlkMTg5NmI4YmJmOWEwMzk0OTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e32d3b4b320b227966a957be334a31256cb0e176", "author": {"user": {"login": "purplefox", "name": "Tim Fox"}}, "url": "https://github.com/confluentinc/ksql/commit/e32d3b4b320b227966a957be334a31256cb0e176", "committedDate": "2020-03-14T07:57:50Z", "message": "fix: add transfer-encoding:chunked header if Jetty omits this in response with no content-length"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0OTI2NzA1", "url": "https://github.com/confluentinc/ksql/pull/4777#pullrequestreview-374926705", "createdAt": "2020-03-16T05:56:07Z", "commit": {"oid": "e32d3b4b320b227966a957be334a31256cb0e176"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQwNTo1NjowN1rOF2mS4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQwNTo1NjowN1rOF2mS4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjc5NDg1MQ==", "bodyText": "Is the response actually formatted as if it were a chunked response (length of current chunk followed by carriage return, newline, content, etc.)? It's not, right? Then how come this workaround doesn't result in issues decoding the server response from the client that made the request?", "url": "https://github.com/confluentinc/ksql/pull/4777#discussion_r392794851", "createdAt": "2020-03-16T05:56:07Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/ProxyHandler.java", "diffHunk": "@@ -134,7 +134,18 @@ private static void responseHandler(final HttpClientResponse clientResponse,\n     Pipe.pipe(clientResponse, serverResponse, () -> {\n       final MultiMap trailers = clientResponse.trailers();\n       serverResponse.trailers().setAll(trailers);\n-    });\n+    }, () -> checkFirstWrite(clientResponse, serverResponse));\n+  }\n+\n+  // Vert.x requires that content-length is set if not chunked but Jetty sometimes sends\n+  // response with no content-length and not chunked, so we workaround this by adding a\n+  // tranfer encoding response header with chunked in this case\n+  private static void checkFirstWrite(final HttpClientResponse clientResponse,\n+      final HttpServerResponse serverResponse) {\n+    if (clientResponse.getHeader(\"content-length\") == null\n+        && clientResponse.getHeader(\"transfer-encoding\") == null) {\n+      serverResponse.putHeader(\"transfer-encoding\", \"chunked\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e32d3b4b320b227966a957be334a31256cb0e176"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a71f654c5fb2bd695ed199d1896b8bbf9a039494", "author": {"user": {"login": "purplefox", "name": "Tim Fox"}}, "url": "https://github.com/confluentinc/ksql/commit/a71f654c5fb2bd695ed199d1896b8bbf9a039494", "committedDate": "2020-03-16T08:29:40Z", "message": "added test"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 13, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}