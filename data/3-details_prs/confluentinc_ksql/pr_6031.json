{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY4MTY3OTE4", "number": 6031, "title": "feat: DistributingExecutor fails DDL statement if CommandRunner DEGRADED", "bodyText": "Description\nStack on top of #6012\nChanges the DistributingExecutor to take a Supplier so that it can check the status of the CommandRunner and not to produce to the command topic if the status is DEGRADED.\nTesting done\nMake sure unit tests all still pass after refactor\nTried issuing DDL with server in DEGRADE state\nksql> create stream test_query as select * from test;\nFailed to handle Ksql Statement.\nThe server has encountered an incompatible entry in its log and cannot process further statements.\nThis is most likely due to the service being rolled back to an earlier version.\n\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-08-14T20:22:06Z", "url": "https://github.com/confluentinc/ksql/pull/6031", "merged": true, "mergeCommit": {"oid": "62b6d9ae4af4a0e239558cb3eb68ce92b1cebcc5"}, "closed": true, "closedAt": "2020-08-20T05:54:24Z", "author": {"login": "stevenpyzhang"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-vdu2AH2gAyNDY4MTY3OTE4OjA5MzU2ZThiMzc3MjVhMWMyYzhkOTQ4ZjBjNmEzMjZjMTE2ZDI2MDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdAo540AH2gAyNDY4MTY3OTE4OjM0YTE4NGRiZDM2ODJmODA2NTc0OTFlYzkxODliMGU2YzNkZmNhMzM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "09356e8b37725a1c2c8d948f0c6a326c116d2602", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/09356e8b37725a1c2c8d948f0c6a326c116d2602", "committedDate": "2020-08-14T07:27:24Z", "message": "feat: move deserialization to CommandRunner and introduce DEGRADED to CommandRunnerStatus"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4a89dc0c605613399acba33a42b1f7038479f584", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/4a89dc0c605613399acba33a42b1f7038479f584", "committedDate": "2020-08-14T20:19:51Z", "message": "chore: refactor DistributingExecutor to use CommandRunner instead of CommandQueue"}, "afterCommit": {"oid": "4332b8774bbc2bbc2f7fbfd5e17bfb6087848107", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/4332b8774bbc2bbc2f7fbfd5e17bfb6087848107", "committedDate": "2020-08-15T22:21:43Z", "message": "chore: refactor DistributingExecutor to use CommandRunner instead of CommandQueue"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4332b8774bbc2bbc2f7fbfd5e17bfb6087848107", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/4332b8774bbc2bbc2f7fbfd5e17bfb6087848107", "committedDate": "2020-08-15T22:21:43Z", "message": "chore: refactor DistributingExecutor to use CommandRunner instead of CommandQueue"}, "afterCommit": {"oid": "90927a56961e4a253466e3c8701a7d2ef61bcce1", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/90927a56961e4a253466e3c8701a7d2ef61bcce1", "committedDate": "2020-08-15T22:56:41Z", "message": "chore: refactor DistributingExecutor to use CommandRunner instead of CommandQueue"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "90927a56961e4a253466e3c8701a7d2ef61bcce1", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/90927a56961e4a253466e3c8701a7d2ef61bcce1", "committedDate": "2020-08-15T22:56:41Z", "message": "chore: refactor DistributingExecutor to use CommandRunner instead of CommandQueue"}, "afterCommit": {"oid": "ca1d143caf7c474773be66c6447f200b7ca23fa0", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/ca1d143caf7c474773be66c6447f200b7ca23fa0", "committedDate": "2020-08-17T05:43:26Z", "message": "chore: refactor DistributingExecutor to use CommandRunner instead of CommandQueue"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4OTI4NjU0", "url": "https://github.com/confluentinc/ksql/pull/6031#pullrequestreview-468928654", "createdAt": "2020-08-18T01:16:16Z", "commit": {"oid": "ca1d143caf7c474773be66c6447f200b7ca23fa0"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwMToxNjoxNlrOHB_9Kw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwMToxOToyNVrOHCAAWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg1ODQ3NQ==", "bodyText": "can we abstract this out as a Supplier<Boolean> instead?", "url": "https://github.com/confluentinc/ksql/pull/6031#discussion_r471858475", "createdAt": "2020-08-18T01:16:16Z", "author": {"login": "rodesai"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/computation/DistributingExecutor.java", "diffHunk": "@@ -61,14 +62,15 @@\n \n   public DistributingExecutor(\n       final KsqlConfig ksqlConfig,\n-      final CommandQueue commandQueue,\n+      final CommandRunner commandRunner,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca1d143caf7c474773be66c6447f200b7ca23fa0"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg1OTI4OA==", "bodyText": "I'd drop the references to CommandRunner or command topic here as they are implementation details of the server that we shouldn't leak in the error message. How about something like:\nFailed to process KSQL statement. The server has encountered an incompatible entry in its log and cannot process further statements. This is most likely due to the service being rolled back to an earlier version.", "url": "https://github.com/confluentinc/ksql/pull/6031#discussion_r471859288", "createdAt": "2020-08-18T01:19:25Z", "author": {"login": "rodesai"}, "path": "ksqldb-rest-model/src/main/java/io/confluent/ksql/rest/DefaultErrorMessages.java", "diffHunk": "@@ -19,6 +19,15 @@\n \n public class DefaultErrorMessages implements ErrorMessages {\n \n+  static String COMMAND_RUNNER_DEGRADED_ERROR_MESSAGE =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca1d143caf7c474773be66c6447f200b7ca23fa0"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f5ce5f5a60329dcebf3027cceca1d13eee1ed5c", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/4f5ce5f5a60329dcebf3027cceca1d13eee1ed5c", "committedDate": "2020-08-18T18:54:06Z", "message": "rohan comment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ca1d143caf7c474773be66c6447f200b7ca23fa0", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/ca1d143caf7c474773be66c6447f200b7ca23fa0", "committedDate": "2020-08-17T05:43:26Z", "message": "chore: refactor DistributingExecutor to use CommandRunner instead of CommandQueue"}, "afterCommit": {"oid": "5ba66a381eae1774462249b17e1c0c9f11468275", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/5ba66a381eae1774462249b17e1c0c9f11468275", "committedDate": "2020-08-18T19:20:17Z", "message": "rohan comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dae4eee5a9625404ccdcb8b742ab35400792e226", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/dae4eee5a9625404ccdcb8b742ab35400792e226", "committedDate": "2020-08-18T20:16:25Z", "message": "fix test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5ba66a381eae1774462249b17e1c0c9f11468275", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/5ba66a381eae1774462249b17e1c0c9f11468275", "committedDate": "2020-08-18T19:20:17Z", "message": "rohan comment"}, "afterCommit": {"oid": "b668a51f897aeefecf2b07d269bb59c6a6c2a0a9", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/b668a51f897aeefecf2b07d269bb59c6a6c2a0a9", "committedDate": "2020-08-18T20:16:42Z", "message": "rohan comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwMTY3NzU5", "url": "https://github.com/confluentinc/ksql/pull/6031#pullrequestreview-470167759", "createdAt": "2020-08-19T06:46:58Z", "commit": {"oid": "b668a51f897aeefecf2b07d269bb59c6a6c2a0a9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5aba943a40f9126bcda43d0b774b2846ca98538", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/d5aba943a40f9126bcda43d0b774b2846ca98538", "committedDate": "2020-08-19T17:46:40Z", "message": "more feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5110d66e3416abb4bc92582590e59a3e601b2b45", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/5110d66e3416abb4bc92582590e59a3e601b2b45", "committedDate": "2020-08-19T20:28:05Z", "message": "pass deserializer to queuedcommand for command"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b846bea62a7af8997cd873b259ac9c36e79bf90b", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/b846bea62a7af8997cd873b259ac9c36e79bf90b", "committedDate": "2020-08-19T20:36:33Z", "message": "chore: refactor DistributingExecutor to use CommandRunner instead of CommandQueue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86ff9377b48962bff665351418e64120b1e65561", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/86ff9377b48962bff665351418e64120b1e65561", "committedDate": "2020-08-19T20:36:34Z", "message": "rohan comment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b668a51f897aeefecf2b07d269bb59c6a6c2a0a9", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/b668a51f897aeefecf2b07d269bb59c6a6c2a0a9", "committedDate": "2020-08-18T20:16:42Z", "message": "rohan comment"}, "afterCommit": {"oid": "86ff9377b48962bff665351418e64120b1e65561", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/86ff9377b48962bff665351418e64120b1e65561", "committedDate": "2020-08-19T20:36:34Z", "message": "rohan comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34a184dbd3682f80657491ec9189b0e6c3dfca33", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/34a184dbd3682f80657491ec9189b0e6c3dfca33", "committedDate": "2020-08-20T04:56:40Z", "message": "Merge branch 'master' into distributing-executor-check-degraded"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4696, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}