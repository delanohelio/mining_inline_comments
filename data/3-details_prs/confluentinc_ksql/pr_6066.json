{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcxMjA3NjUx", "number": 6066, "title": "fix: Use a SandboxedPersistentQueryMetadata to not interact with KafkStreams", "bodyText": "Description\nThe RequestValidator validates every request made to KSQL using sandboxed classes that prevents modifying real data or metadata, such as creating/deleting topics, schema, etc. Even the queries running in the system are copied to prevent they're deleted during the TERMINATE validation. However, the internal KafkaStreams of the copied QueryMetadata is altered. The streams is closed which includes closing the original KafkaStreams.\nThis PR sandboxes the PersistentQueryMetadata to prevent terminating the KafkaStreams during the request validation process.\nTesting done\nAdded unit tests.\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-08-20T19:51:52Z", "url": "https://github.com/confluentinc/ksql/pull/6066", "merged": true, "mergeCommit": {"oid": "e000b419ac84d7ee25f47aae62758dce01fbe3de"}, "closed": true, "closedAt": "2020-08-25T16:48:08Z", "author": {"login": "spena"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdA4C9UgFqTQ3MjAzMDQ2Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCOX5BgBqjM2ODgwMDMyNTY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyMDMwNDY3", "url": "https://github.com/confluentinc/ksql/pull/6066#pullrequestreview-472030467", "createdAt": "2020-08-20T22:35:09Z", "commit": {"oid": "3a1b5e317febc08973f8cf72296d42f8bfdad421"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyMDgyMDgx", "url": "https://github.com/confluentinc/ksql/pull/6066#pullrequestreview-472082081", "createdAt": "2020-08-21T01:14:08Z", "commit": {"oid": "3a1b5e317febc08973f8cf72296d42f8bfdad421"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQwMToxNDowOFrOHEYRFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQwMToxNDozNlrOHEYRog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM1Mzk0MQ==", "bodyText": "it seems like stop/start aren't going to do anything except call the close callback - can we just override them to do nothing except for call the close callback?\nalso note #6068 I refactor this class a bit to make the close/stop a little clearer.", "url": "https://github.com/confluentinc/ksql/pull/6066#discussion_r474353941", "createdAt": "2020-08-21T01:14:08Z", "author": {"login": "agavra"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/util/QueryMetadata.java", "diffHunk": "@@ -297,16 +309,16 @@ protected void doClose(final boolean cleanUp) {\n     closeKafkaStreams();\n \n     if (cleanUp) {\n-      kafkaStreams.cleanUp();\n+      cleanUpKafkaStreams();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a1b5e317febc08973f8cf72296d42f8bfdad421"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM1NDA4Mg==", "bodyText": "can we add test coverage here for what should/shouldn't happen? we have test coverage for the sandbox, but not that on validation we don't actually affect the KS app", "url": "https://github.com/confluentinc/ksql/pull/6066#discussion_r474354082", "createdAt": "2020-08-21T01:14:36Z", "author": {"login": "agavra"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/engine/EngineContext.java", "diffHunk": "@@ -111,7 +112,7 @@ EngineContext createSandbox(final ServiceContext serviceContext) {\n     persistentQueries.forEach((queryId, query) ->\n         sandBox.persistentQueries.put(\n             query.getQueryId(),\n-            query.copyWith(sandBox::unregisterQuery)));\n+            SandboxedPersistentQueryMetadata.of(query, sandBox::unregisterQuery)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a1b5e317febc08973f8cf72296d42f8bfdad421"}, "originalPosition": 13}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3a1b5e317febc08973f8cf72296d42f8bfdad421", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/3a1b5e317febc08973f8cf72296d42f8bfdad421", "committedDate": "2020-08-20T19:44:57Z", "message": "fix: Use a SandboxedPersistentQueryMetadata to not interact with KafkaStreams"}, "afterCommit": {"oid": "8f103b7860906255a88e0ffc4fc16e5eecee7bd1", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/8f103b7860906255a88e0ffc4fc16e5eecee7bd1", "committedDate": "2020-08-24T16:47:24Z", "message": "fix: address Almog's feedback\n\n- override only start/stop methods\n- add test case for not start/stop/close streams in ksqlengine sandbox"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "72f804fee4259abcfa00af61646d5dfaa5280955", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/72f804fee4259abcfa00af61646d5dfaa5280955", "committedDate": "2020-08-25T01:38:43Z", "message": "fix: Use a SandboxedPersistentQueryMetadata to not interact with KafkaStreams"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df11076df91f98e18b3002d0cd92631b5a954998", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/df11076df91f98e18b3002d0cd92631b5a954998", "committedDate": "2020-08-25T01:39:15Z", "message": "fix: address Almog's feedback\n\n- override only start/stop methods\n- add test case for not start/stop/close streams in ksqlengine sandbox"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8656d550d769b4622d6d2daf9c292728174968b4", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/8656d550d769b4622d6d2daf9c292728174968b4", "committedDate": "2020-08-24T21:48:24Z", "message": "fix: use last command sequence number on TestKsqlRestApp"}, "afterCommit": {"oid": "d5e4f73d3c8b59449ccf9c8f652ba5a9ac8d2ae6", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/d5e4f73d3c8b59449ccf9c8f652ba5a9ac8d2ae6", "committedDate": "2020-08-25T01:39:15Z", "message": "fix: use last command sequence number on TestKsqlRestApp"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6081eaf8f72f4e8b625371872931621c8e9b7660", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/6081eaf8f72f4e8b625371872931621c8e9b7660", "committedDate": "2020-08-25T03:09:42Z", "message": "fix: use last command sequence number on TestKsqlRestApp"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d5e4f73d3c8b59449ccf9c8f652ba5a9ac8d2ae6", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/d5e4f73d3c8b59449ccf9c8f652ba5a9ac8d2ae6", "committedDate": "2020-08-25T01:39:15Z", "message": "fix: use last command sequence number on TestKsqlRestApp"}, "afterCommit": {"oid": "6081eaf8f72f4e8b625371872931621c8e9b7660", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/6081eaf8f72f4e8b625371872931621c8e9b7660", "committedDate": "2020-08-25T03:09:42Z", "message": "fix: use last command sequence number on TestKsqlRestApp"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4718, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}