{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkwNTMxNDY5", "number": 4814, "title": "feat: use describeTopics() for Kafka healtcheck probe", "bodyText": "Description\nWhat behavior do you want to change, why, how does your patch achieve the changes?\nUse a faster connectivity check for Kafka health check. The new approach uses the describeTopics() call to get metadata information from the KSQL command topic. If the describe does not fail, then Kafka is considered healthy.\nTesting done\nDescribe the testing strategy. Unit and integration tests are expected for any behavior changes.\nUnit tests\nManual test\nHealthy\nsergio@pop-os:~/Development/ksql$ curl -X \"GET\" \"http://localhost:8088/healthcheck\" -H \"Content-Type: application/vnd.ksql.v1+json; charset=utf-8\" | jq .\n{\n  \"isHealthy\": true,\n  \"details\": {\n    \"metastore\": {\n      \"isHealthy\": true\n    },\n    \"kafka\": {\n      \"isHealthy\": true\n    }\n  }\n}\n\nKafka not healthy\n$ curl -X \"GET\" \"http://localhost:8088/healthcheck\" -H \"Content-Type: application/vnd.ksql.v1+json; charset=utf-8\" | jq .\n{\n  \"isHealthy\": false,\n  \"details\": {\n    \"metastore\": {\n      \"isHealthy\": true\n    },\n    \"kafka\": {\n      \"isHealthy\": false\n    }\n  }\n}\n\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-03-18T16:13:25Z", "url": "https://github.com/confluentinc/ksql/pull/4814", "merged": true, "mergeCommit": {"oid": "578d0d543bce685ca6e253a8c6f9bcfbf191093d"}, "closed": true, "closedAt": "2020-03-20T19:34:05Z", "author": {"login": "spena"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcPAR-ngBqjMxNDM1Njg0MzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcPkwWCABqjMxNTA0NDE0ODc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1fe896fded87d1b4165e642b061d5a9847a7fea1", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/1fe896fded87d1b4165e642b061d5a9847a7fea1", "committedDate": "2020-03-18T16:10:28Z", "message": "feat: use describeTopics() for Kafka healtcheck probe"}, "afterCommit": {"oid": "76d8381e3b66ca8786849eaaf4fff6830ab1cb7b", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/76d8381e3b66ca8786849eaaf4fff6830ab1cb7b", "committedDate": "2020-03-18T23:53:44Z", "message": "feat: use describeTopics() for Kafka healtcheck probe"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3MzE3ODE1", "url": "https://github.com/confluentinc/ksql/pull/4814#pullrequestreview-377317815", "createdAt": "2020-03-18T23:56:18Z", "commit": {"oid": "76d8381e3b66ca8786849eaaf4fff6830ab1cb7b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQyMzo1NjoxOFrOF4a54g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQyMzo1NjoxOFrOF4a54g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDcwNTM3OA==", "bodyText": "@rodesai @vcrfxia If Kafka is not available, this get() will wait for a couple of minutes. Do you think we should have a lower timeout? configurable timeout for healthchecks? or the default 2-3 mins is good?", "url": "https://github.com/confluentinc/ksql/pull/4814#discussion_r394705378", "createdAt": "2020-03-18T23:56:18Z", "author": {"login": "spena"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/healthcheck/HealthCheckAgent.java", "diffHunk": "@@ -82,13 +94,47 @@ public String getName() {\n     }\n \n     @Override\n-    public HealthCheckResponseDetail check(\n-        final SimpleKsqlClient ksqlClient,\n-        final URI serverEndpoint\n-    ) {\n+    public HealthCheckResponseDetail check(final HealthCheckAgent healthCheckAgent) {\n       final RestResponse<KsqlEntityList> response =\n-          ksqlClient.makeKsqlRequest(serverEndpoint, ksqlStatement);\n+          healthCheckAgent.ksqlClient\n+              .makeKsqlRequest(healthCheckAgent.serverEndpoint, ksqlStatement);\n       return new HealthCheckResponseDetail(response.isSuccessful());\n     }\n   }\n+\n+  private static class KafkaBrokerCheck implements Check {\n+    private final String name;\n+\n+    KafkaBrokerCheck(final String name) {\n+      this.name = Objects.requireNonNull(name, \"name\");\n+    }\n+\n+    @Override\n+    public String getName() {\n+      return name;\n+    }\n+\n+    @SuppressFBWarnings(\"RV_RETURN_VALUE_IGNORED_NO_SIDE_EFFECT\")\n+    @Override\n+    public HealthCheckResponseDetail check(final HealthCheckAgent healthCheckAgent) {\n+      final String commandTopic = ReservedInternalTopics.commandTopic(healthCheckAgent.ksqlConfig);\n+      boolean isHealthy;\n+\n+      try {\n+        healthCheckAgent.serviceContext\n+            .getAdminClient()\n+            .describeTopics(Collections.singletonList(commandTopic))\n+            .all()\n+            .get();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76d8381e3b66ca8786849eaaf4fff6830ab1cb7b"}, "originalPosition": 105}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3MDk2NDkw", "url": "https://github.com/confluentinc/ksql/pull/4814#pullrequestreview-377096490", "createdAt": "2020-03-18T17:43:07Z", "commit": {"oid": "1fe896fded87d1b4165e642b061d5a9847a7fea1"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxNzo0NToyMFrOF4QO3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxNzo0NToyMFrOF4QO3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDUzMDUyNA==", "bodyText": "@spena somehow I accidentally deleted your comment: \"I marked authorization errors as healthy, but I am unsure if that is a desired result in this situation for healthcheck.\"\nI think this is fine - it makes sense to be defensive against a user misconfiguring acls.", "url": "https://github.com/confluentinc/ksql/pull/4814#discussion_r394530524", "createdAt": "2020-03-18T17:45:20Z", "author": {"login": "rodesai"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/healthcheck/HealthCheckAgent.java", "diffHunk": "@@ -82,13 +94,46 @@ public String getName() {\n     }\n \n     @Override\n-    public HealthCheckResponseDetail check(\n-        final SimpleKsqlClient ksqlClient,\n-        final URI serverEndpoint\n-    ) {\n+    public HealthCheckResponseDetail check(final HealthCheckAgent healthCheckAgent) {\n       final RestResponse<KsqlEntityList> response =\n-          ksqlClient.makeKsqlRequest(serverEndpoint, ksqlStatement);\n+          healthCheckAgent.ksqlClient\n+              .makeKsqlRequest(healthCheckAgent.serverEndpoint, ksqlStatement);\n       return new HealthCheckResponseDetail(response.isSuccessful());\n     }\n   }\n+\n+  private static class KafkaBrokerCheck implements Check {\n+    private final String name;\n+\n+    KafkaBrokerCheck(final String name) {\n+      this.name = Objects.requireNonNull(name, \"name\");\n+    }\n+\n+    @Override\n+    public String getName() {\n+      return name;\n+    }\n+\n+    @SuppressFBWarnings(\"RV_RETURN_VALUE_IGNORED_NO_SIDE_EFFECT\")\n+    @Override\n+    public HealthCheckResponseDetail check(final HealthCheckAgent healthCheckAgent) {\n+      final String commandTopic = ReservedInternalTopics.commandTopic(healthCheckAgent.ksqlConfig);\n+      boolean isHealthy;\n+\n+      try {\n+        healthCheckAgent.serviceContext\n+            .getAdminClient()\n+            .describeTopics(Collections.singletonList(commandTopic))\n+            .values();\n+\n+        isHealthy = true;\n+      } catch (final KsqlTopicAuthorizationException e) {\n+        isHealthy = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1fe896fded87d1b4165e642b061d5a9847a7fea1"}, "originalPosition": 108}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "76d8381e3b66ca8786849eaaf4fff6830ab1cb7b", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/76d8381e3b66ca8786849eaaf4fff6830ab1cb7b", "committedDate": "2020-03-18T23:53:44Z", "message": "feat: use describeTopics() for Kafka healtcheck probe"}, "afterCommit": {"oid": "3d7cbf6b7fd0ff4d91c89b91dc4dd3f70dba4d24", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/3d7cbf6b7fd0ff4d91c89b91dc4dd3f70dba4d24", "committedDate": "2020-03-20T14:45:19Z", "message": "fix: set timeout to 30s when describing topics"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3d7cbf6b7fd0ff4d91c89b91dc4dd3f70dba4d24", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/3d7cbf6b7fd0ff4d91c89b91dc4dd3f70dba4d24", "committedDate": "2020-03-20T14:45:19Z", "message": "fix: set timeout to 30s when describing topics"}, "afterCommit": {"oid": "c0b0130ac0213c593ed4845bd3443850e0a72498", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/c0b0130ac0213c593ed4845bd3443850e0a72498", "committedDate": "2020-03-20T15:18:15Z", "message": "fix: set timeout to 30s when describing topics"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c0b0130ac0213c593ed4845bd3443850e0a72498", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/c0b0130ac0213c593ed4845bd3443850e0a72498", "committedDate": "2020-03-20T15:18:15Z", "message": "fix: set timeout to 30s when describing topics"}, "afterCommit": {"oid": "3f4926ef48db02c0cabef45c2d31e45ef8765df7", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/3f4926ef48db02c0cabef45c2d31e45ef8765df7", "committedDate": "2020-03-20T16:01:41Z", "message": "fix: set timeout to 30s when describing topics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81a49c6d605f4bebb4937c790f2357f8971c0579", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/81a49c6d605f4bebb4937c790f2357f8971c0579", "committedDate": "2020-03-20T18:19:08Z", "message": "feat: use describeTopics() for Kafka healtcheck probe"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b3be5b6ad6f1657860e2d0fd0cead24470b7404f", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/b3be5b6ad6f1657860e2d0fd0cead24470b7404f", "committedDate": "2020-03-20T18:19:09Z", "message": "fix: set timeout to 30s when describing topics"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3f4926ef48db02c0cabef45c2d31e45ef8765df7", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/3f4926ef48db02c0cabef45c2d31e45ef8765df7", "committedDate": "2020-03-20T16:01:41Z", "message": "fix: set timeout to 30s when describing topics"}, "afterCommit": {"oid": "b3be5b6ad6f1657860e2d0fd0cead24470b7404f", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/b3be5b6ad6f1657860e2d0fd0cead24470b7404f", "committedDate": "2020-03-20T18:19:09Z", "message": "fix: set timeout to 30s when describing topics"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 29, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}