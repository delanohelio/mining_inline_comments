{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkwOTg3OTAy", "number": 4822, "title": "fix: Stop PARTITION BY and UDTFs that fail from terminating the query", "bodyText": "Description\nStacked on top of #4821 and #4816, (both now merged)\nPARTITION BY was recently enhanced to support any expression, rather than just column references.  If the expression expression results in an error, e.g. a UDF that throws an exception, this exception was not being handled - resulting in the query being terminated.\nUDTFs were recently introduced. If a UDTF throws an exception, or an exception occurs extracting a UDTFs parameters, e.g. if a parameter is a UDF that throws, then the exception was not being handled - resulting in the query being terminated.\nAll these exceptions are now handled by logging the error to the processing logger and continuing.\nTesting done\nQTT and unit tests added to cover the new exception handling and logging\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-03-19T12:57:29Z", "url": "https://github.com/confluentinc/ksql/pull/4822", "merged": true, "mergeCommit": {"oid": "522fe84f407b56dbc82309db4a6502d0c9b8fc38"}, "closed": true, "closedAt": "2020-03-24T09:38:14Z", "author": {"login": "big-andy-coates"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcO8LhvgH2gAyMzkwOTg3OTAyOjNhZWQwOTgyOWYxMzlhODlmODdkZjk5ZmQzYWE5ZDRkYTI5NGU2YzM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcQinY8AH2gAyMzkwOTg3OTAyOjQwMmU1M2ZjNTI0YmJhYjkzMGU3MDU3NDJlZmVjZjg0MTgyNzkxMTY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3aed09829f139a89f87df99fd3aa9d4da294e6c3", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/3aed09829f139a89f87df99fd3aa9d4da294e6c3", "committedDate": "2020-03-18T19:07:55Z", "message": "refactor: easier access/mocking of processing logger\n\nThis commit all the steps needed to access a processing logger into the query builder, (which already knows the query id)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9515d06b874f073f94cf2f7a9276c8f88382be43", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/9515d06b874f073f94cf2f7a9276c8f88382be43", "committedDate": "2020-03-19T10:06:46Z", "message": "refactor: have ProcessingLogger.error accept object not function\n\nThis makes it easier to add unit tests that test _what_ is being logged."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc2d8b3f9526d44a0e8702491f14bd8d481be83d", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/bc2d8b3f9526d44a0e8702491f14bd8d481be83d", "committedDate": "2020-03-19T10:23:39Z", "message": "refactor: remove KsqlQueryBuilder.getProcessingLogContext\n\nAs its only used in tests now - fixed tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4fbcaaa307a5356cd6296c199b6bd2c4f5a0de1", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/d4fbcaaa307a5356cd6296c199b6bd2c4f5a0de1", "committedDate": "2020-03-19T11:40:31Z", "message": "chore: fix spotbugs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "063f66d0793207a46c9005c606f23ecd2bb369e8", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/063f66d0793207a46c9005c606f23ecd2bb369e8", "committedDate": "2020-03-19T12:55:47Z", "message": "fix: PARTITION BY and UDTFs that fail from terminating the query\n\n`PARTITION BY` was recently enhanced to support any expression, rather than just column references.  If the expression expression results in an error, e.g. a UDF that throws an exception, this exception was not being handled - resulting in the query being terminated.\n\nUDTFs were recently introduced. If a UDTF throws an exception, or an exception occurs extracting a UDTFs parameters, e.g. if a parameter is a UDF that throws, then the exception was not being handled - resulting in the query being terminated.\n\nAll these exceptions are now handled by logging the error to the processing logger and continuing."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f3f72d5052f790e59c9d881a5bdb2d2e4349ab5", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/0f3f72d5052f790e59c9d881a5bdb2d2e4349ab5", "committedDate": "2020-03-20T12:10:00Z", "message": "chore: fix immutability test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e27c6878e495151daace9faab225fc035b9efd8", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/9e27c6878e495151daace9faab225fc035b9efd8", "committedDate": "2020-03-20T14:22:29Z", "message": "chore: merge from master\n\nConflicting files\nksqldb-common/src/main/java/io/confluent/ksql/errors/ProductionExceptionHandlerUtil.java\nksqldb-common/src/main/java/io/confluent/ksql/logging/processing/ProcessingLogger.java\nksqldb-execution/src/main/java/io/confluent/ksql/execution/transform/select/SelectValueMapper.java\nksqldb-execution/src/main/java/io/confluent/ksql/execution/transform/sqlpredicate/SqlPredicate.java\nksqldb-execution/src/main/java/io/confluent/ksql/logging/processing/RecordProcessingError.java\nksqldb-execution/src/test/java/io/confluent/ksql/execution/transform/select/SelectValueMapperTest.java\nksqldb-execution/src/test/java/io/confluent/ksql/execution/transform/sqlpredicate/SqlPredicateTest.java\nksqldb-serde/src/main/java/io/confluent/ksql/logging/processing/DeserializationError.java\nksqldb-streams/src/main/java/io/confluent/ksql/execution/streams/GroupByParamsFactory.java\nksqldb-streams/src/main/java/io/confluent/ksql/execution/streams/timestamp/LoggingTimestampExtractor.java\nksqldb-streams/src/test/java/io/confluent/ksql/execution/streams/GroupByParamsFactoryTest.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "792ddbe1bff3dbdfe5feb241842e1a40968e75cf", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/792ddbe1bff3dbdfe5feb241842e1a40968e75cf", "committedDate": "2020-03-20T14:44:11Z", "message": "chore: fix UDTF tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "681a071a00cebc959720fb005016b466f2fbe9c7", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/681a071a00cebc959720fb005016b466f2fbe9c7", "committedDate": "2020-03-20T14:53:33Z", "message": "chore: implement remaining todos"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e36e8163b0eb1023534614cb98ea49750f85eaa", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/8e36e8163b0eb1023534614cb98ea49750f85eaa", "committedDate": "2020-03-20T17:51:38Z", "message": "chore: merge from master\n\nConflicting files\nksqldb-streams/src/main/java/io/confluent/ksql/execution/streams/StreamSelectKeyBuilder.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5774a1fb3d7057701088ba7bbb6c055f5f70db2a", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/5774a1fb3d7057701088ba7bbb6c055f5f70db2a", "committedDate": "2020-03-23T11:16:27Z", "message": "chore: fix up tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5e91b83ebd9d3322121401039340a872850be26", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/a5e91b83ebd9d3322121401039340a872850be26", "committedDate": "2020-03-23T16:20:56Z", "message": "chore: merge from master\n\nConflicting files\nksqldb-execution/src/main/java/io/confluent/ksql/execution/transform/sqlpredicate/SqlPredicate.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83a61a5f04262dd5df4d0d38a26f52acd6670490", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/83a61a5f04262dd5df4d0d38a26f52acd6670490", "committedDate": "2020-03-23T17:18:02Z", "message": "Merge branch 'master' into evaluator_logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f0988ad668a988398aa9156f21447e62b8ab1ec", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/5f0988ad668a988398aa9156f21447e62b8ab1ec", "committedDate": "2020-03-23T17:28:12Z", "message": "chore: handle null values"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5NjU2MTE5", "url": "https://github.com/confluentinc/ksql/pull/4822#pullrequestreview-379656119", "createdAt": "2020-03-23T17:25:34Z", "commit": {"oid": "a5e91b83ebd9d3322121401039340a872850be26"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxNzoyNTozNFrOF6QE4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxNzoyNzoyOVrOF6QKBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYyNTEyMg==", "bodyText": "get with the times! (\ud83d\ude09 update your file template)", "url": "https://github.com/confluentinc/ksql/pull/4822#discussion_r396625122", "createdAt": "2020-03-23T17:25:34Z", "author": {"login": "agavra"}, "path": "ksqldb-engine/src/test/java/io/confluent/ksql/function/udf/ThrowingUdtf.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Copyright 2019 Confluent Inc.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a5e91b83ebd9d3322121401039340a872850be26"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYyNjQzNg==", "bodyText": "I think there's an existing configuration about whether to hard-fail on error or log-and-continue. If there is, we should respect that, and if there isn't we should add one so people can control if they want their application skipping events", "url": "https://github.com/confluentinc/ksql/pull/4822#discussion_r396626436", "createdAt": "2020-03-23T17:27:29Z", "author": {"login": "agavra"}, "path": "ksqldb-execution/src/main/java/io/confluent/ksql/execution/codegen/ExpressionMetadata.java", "diffHunk": "@@ -62,16 +64,35 @@ public Expression getExpression() {\n     return expression;\n   }\n \n-  public Object evaluate(final GenericRow row) {\n+  /**\n+   * Evaluate the expression against the supplied {@code row}.\n+   *\n+   * <p>On error the supplied {@code logger} is called with the details of the error and the method\n+   * return {@code null}.\n+   *\n+   * @param row the row of data to evaluate the expression against.\n+   * @param defaultValue the value to return if an exception is thrown.\n+   * @param logger an optional logger to log errors to. If not supplied the method throws on error.\n+   * @param errorMsg called to get the text for the logged error.\n+   * @return the result of the evaluation.\n+   */\n+  public Object evaluate(\n+      final GenericRow row,\n+      final Object defaultValue,\n+      final ProcessingLogger logger,\n+      final Supplier<String> errorMsg\n+  ) {\n     try {\n       return expressionEvaluator.evaluate(getParameters(row));\n     } catch (final InvocationTargetException e) {\n-      throw new KsqlException(e.getCause().getMessage(), e.getCause());\n+      logger.error(RecordProcessingError.recordProcessingError(errorMsg.get(), e.getCause(), row));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a5e91b83ebd9d3322121401039340a872850be26"}, "originalPosition": 43}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f4dacab2119de71c50b8baa41ba6dad73b0603c", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/9f4dacab2119de71c50b8baa41ba6dad73b0603c", "committedDate": "2020-03-23T18:19:38Z", "message": "Update cr date"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "402e53fc524bbab930e705742efecf8418279116", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/402e53fc524bbab930e705742efecf8418279116", "committedDate": "2020-03-23T18:28:40Z", "message": "Merge branch 'master' into evaluator_logging"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 38, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}