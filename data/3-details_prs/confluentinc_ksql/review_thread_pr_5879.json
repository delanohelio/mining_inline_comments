{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU2NDc4MzIx", "number": 5879, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMDozNzozNVrOER9WmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMDo0MToxOVrOER9a2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3MjY2NDU3OnYy", "diffSide": "RIGHT", "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/CommandTopicBackupImpl.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMDozNzozNVrOG29CjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMDo1Mjo0MFrOG29bwA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI3NjM2NQ==", "bodyText": "nit: can we de-dup this code from enforceStreamStateDirAvailability() in KsqlServerMain? Not required if it's annoying to de-dup (especially since we're trying to keep this patch small in order to cherry-pick) but it's weird to me that we have the same code in two places.", "url": "https://github.com/confluentinc/ksql/pull/5879#discussion_r460276365", "createdAt": "2020-07-24T20:37:35Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/CommandTopicBackupImpl.java", "diffHunk": "@@ -222,4 +225,50 @@ private BackupReplayFile newReplayFile() {\n         ? Optional.of(new BackupReplayFile(latestBakFile))\n         : Optional.empty();\n   }\n+\n+  private void ensureDirectoryExists(final File backupsDir) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9d54734a6827bf92e54e82697463128dcd22d48"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI4MjgxNg==", "bodyText": "Right, I see it. But I have the extra step to restrict the permissions to the KSQL server user only. I'd like to do that in the state directory too, but I don't know why the directory is not too restrictive. I'd rather investigate more and do it in another follow-up PR.", "url": "https://github.com/confluentinc/ksql/pull/5879#discussion_r460282816", "createdAt": "2020-07-24T20:52:40Z", "author": {"login": "spena"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/CommandTopicBackupImpl.java", "diffHunk": "@@ -222,4 +225,50 @@ private BackupReplayFile newReplayFile() {\n         ? Optional.of(new BackupReplayFile(latestBakFile))\n         : Optional.empty();\n   }\n+\n+  private void ensureDirectoryExists(final File backupsDir) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI3NjM2NQ=="}, "originalCommit": {"oid": "e9d54734a6827bf92e54e82697463128dcd22d48"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3MjY3MjQ1OnYy", "diffSide": "RIGHT", "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/CommandTopicBackupImpl.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMDo0MDoyMlrOG29HNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMDo1MDo0MFrOG29YTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI3NzU1Ng==", "bodyText": "Does it make sense to explicitly set permissions here? I see we don't do that for the Kafka Streams state directory. I'm in favor of consistency unless there's a good reason to deviate.", "url": "https://github.com/confluentinc/ksql/pull/5879#discussion_r460277556", "createdAt": "2020-07-24T20:40:22Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/CommandTopicBackupImpl.java", "diffHunk": "@@ -222,4 +222,50 @@ private BackupReplayFile newReplayFile() {\n         ? Optional.of(new BackupReplayFile(latestBakFile))\n         : Optional.empty();\n   }\n+\n+  private void ensureDirectoryExists(final File backupsDir) {\n+    if (!backupsDir.exists()) {\n+      if (!backupsDir.mkdirs()) {\n+        throw new KsqlServerException(\"Couldn't create the backups directory: \"\n+            + backupsDir.getPath()\n+            + \"\\n Make sure the directory exists and is readable/writable for KSQL server \"\n+            + \"\\n or its parent directory is readable/writable by KSQL server\"\n+            + \"\\n or change it to a readable/writable directory by setting '\"\n+            + KsqlConfig.KSQL_METASTORE_BACKUP_LOCATION\n+            + \"' config in the properties file.\"\n+        );\n+      }\n+\n+      try {\n+        Files.setPosixFilePermissions(backupsDir.toPath(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c9d5ed792e162fdeacd047499dfe8d7b643abafa"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI4MTkzNA==", "bodyText": "I'd like to keep the metastore directory restricted from other uses to access the data. By default, the directory created has drwxrwxr-x which is opened to any user in the system. It's up to the user to specify a directory that has restricted permissions only to the required users, but if KSQL creates it automatically, then I set those here too.\nI don't know why the streams state directory is not protected. We might want to do that. I won't do it in this patch until I understand their reason.", "url": "https://github.com/confluentinc/ksql/pull/5879#discussion_r460281934", "createdAt": "2020-07-24T20:50:40Z", "author": {"login": "spena"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/CommandTopicBackupImpl.java", "diffHunk": "@@ -222,4 +222,50 @@ private BackupReplayFile newReplayFile() {\n         ? Optional.of(new BackupReplayFile(latestBakFile))\n         : Optional.empty();\n   }\n+\n+  private void ensureDirectoryExists(final File backupsDir) {\n+    if (!backupsDir.exists()) {\n+      if (!backupsDir.mkdirs()) {\n+        throw new KsqlServerException(\"Couldn't create the backups directory: \"\n+            + backupsDir.getPath()\n+            + \"\\n Make sure the directory exists and is readable/writable for KSQL server \"\n+            + \"\\n or its parent directory is readable/writable by KSQL server\"\n+            + \"\\n or change it to a readable/writable directory by setting '\"\n+            + KsqlConfig.KSQL_METASTORE_BACKUP_LOCATION\n+            + \"' config in the properties file.\"\n+        );\n+      }\n+\n+      try {\n+        Files.setPosixFilePermissions(backupsDir.toPath(),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI3NzU1Ng=="}, "originalCommit": {"oid": "c9d5ed792e162fdeacd047499dfe8d7b643abafa"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3MjY3NTQ0OnYy", "diffSide": "RIGHT", "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/CommandTopicBackupImpl.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMDo0MToxOVrOG29I8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMDo0NzozNlrOG29TPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI3ODAwMA==", "bodyText": "Why do we need execute permissions? I see we have a similar check for the Kafka Streams state directory so I assume there's good reason. Curious what it is.", "url": "https://github.com/confluentinc/ksql/pull/5879#discussion_r460278000", "createdAt": "2020-07-24T20:41:19Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/CommandTopicBackupImpl.java", "diffHunk": "@@ -222,4 +222,50 @@ private BackupReplayFile newReplayFile() {\n         ? Optional.of(new BackupReplayFile(latestBakFile))\n         : Optional.empty();\n   }\n+\n+  private void ensureDirectoryExists(final File backupsDir) {\n+    if (!backupsDir.exists()) {\n+      if (!backupsDir.mkdirs()) {\n+        throw new KsqlServerException(\"Couldn't create the backups directory: \"\n+            + backupsDir.getPath()\n+            + \"\\n Make sure the directory exists and is readable/writable for KSQL server \"\n+            + \"\\n or its parent directory is readable/writable by KSQL server\"\n+            + \"\\n or change it to a readable/writable directory by setting '\"\n+            + KsqlConfig.KSQL_METASTORE_BACKUP_LOCATION\n+            + \"' config in the properties file.\"\n+        );\n+      }\n+\n+      try {\n+        Files.setPosixFilePermissions(backupsDir.toPath(),\n+            PosixFilePermissions.fromString(\"rwx------\"));\n+      } catch (final IOException e) {\n+        throw new KsqlServerException(String.format(\n+            \"Couldn't set POSIX permissions on the backups directory: %s. Error = %s\",\n+            backupsDir.getPath(), e.getMessage()));\n+      }\n+    }\n+\n+    if (!backupsDir.isDirectory()) {\n+      throw new KsqlServerException(backupsDir.getPath()\n+          + \" is not a directory.\"\n+          + \"\\n Make sure the directory exists and is readable/writable for KSQL server \"\n+          + \"\\n or its parent directory is readable/writable by KSQL server\"\n+          + \"\\n or change it to a readable/writable directory by setting '\"\n+          + KsqlConfig.KSQL_METASTORE_BACKUP_LOCATION\n+          + \"' config in the properties file.\"\n+      );\n+    }\n+\n+    if (!backupsDir.canWrite() || !backupsDir.canRead() || !backupsDir.canExecute()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c9d5ed792e162fdeacd047499dfe8d7b643abafa"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI4MDYzOQ==", "bodyText": "Directories need to have execute permissions in order to create files in it. By default, a new directory has rwx. If you remove the x, then you get a permissions denied.\n$ mkdir /tmp/dir\n$ chmod a-x /tmp/dir\n$ ls -dl /tmp/dir\ndrw-rw-r-- 2 sergio sergio 4096 Jul 24 15:46 /tmp/dir\n$ echo file > /tmp/dir/file\nbash: /tmp/dir/file: Permission denied\n$", "url": "https://github.com/confluentinc/ksql/pull/5879#discussion_r460280639", "createdAt": "2020-07-24T20:47:36Z", "author": {"login": "spena"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/CommandTopicBackupImpl.java", "diffHunk": "@@ -222,4 +222,50 @@ private BackupReplayFile newReplayFile() {\n         ? Optional.of(new BackupReplayFile(latestBakFile))\n         : Optional.empty();\n   }\n+\n+  private void ensureDirectoryExists(final File backupsDir) {\n+    if (!backupsDir.exists()) {\n+      if (!backupsDir.mkdirs()) {\n+        throw new KsqlServerException(\"Couldn't create the backups directory: \"\n+            + backupsDir.getPath()\n+            + \"\\n Make sure the directory exists and is readable/writable for KSQL server \"\n+            + \"\\n or its parent directory is readable/writable by KSQL server\"\n+            + \"\\n or change it to a readable/writable directory by setting '\"\n+            + KsqlConfig.KSQL_METASTORE_BACKUP_LOCATION\n+            + \"' config in the properties file.\"\n+        );\n+      }\n+\n+      try {\n+        Files.setPosixFilePermissions(backupsDir.toPath(),\n+            PosixFilePermissions.fromString(\"rwx------\"));\n+      } catch (final IOException e) {\n+        throw new KsqlServerException(String.format(\n+            \"Couldn't set POSIX permissions on the backups directory: %s. Error = %s\",\n+            backupsDir.getPath(), e.getMessage()));\n+      }\n+    }\n+\n+    if (!backupsDir.isDirectory()) {\n+      throw new KsqlServerException(backupsDir.getPath()\n+          + \" is not a directory.\"\n+          + \"\\n Make sure the directory exists and is readable/writable for KSQL server \"\n+          + \"\\n or its parent directory is readable/writable by KSQL server\"\n+          + \"\\n or change it to a readable/writable directory by setting '\"\n+          + KsqlConfig.KSQL_METASTORE_BACKUP_LOCATION\n+          + \"' config in the properties file.\"\n+      );\n+    }\n+\n+    if (!backupsDir.canWrite() || !backupsDir.canRead() || !backupsDir.canExecute()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI3ODAwMA=="}, "originalCommit": {"oid": "c9d5ed792e162fdeacd047499dfe8d7b643abafa"}, "originalPosition": 67}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2984, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}