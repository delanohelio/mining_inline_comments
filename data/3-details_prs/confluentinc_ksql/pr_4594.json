{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc3MzI2NjIx", "number": 4594, "title": "chore: support PROTOBUF for PRINT TOPIC", "bodyText": "fixes #4516\nDescription\nAdds support for PRINT TOPIC for protobuf topics\nTesting done\nUnit testing and manual:\nksql> PRINT print_proto FROM BEGINNING;\nKey format: UNDEFINED\nValue format: PROTOBUF\nrowtime: 2/19/20 9:40:02 AM PST, key: <null>, value: COL1: \"a\" COL2: 2 COL3: \"c\"\n^CTopic printing ceased\n\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-02-19T18:38:04Z", "url": "https://github.com/confluentinc/ksql/pull/4594", "merged": true, "mergeCommit": {"oid": "55cc0d02445cfd3d143b84f93318a29f08937c56"}, "closed": true, "closedAt": "2020-02-25T18:55:57Z", "author": {"login": "agavra"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcGkhNYgBqjMwNjE1NzIyMTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcH10l_ABqjMwNzAzOTc2NTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b0ee3473c66aaf3e4e28af447fa06663e948feb9", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/b0ee3473c66aaf3e4e28af447fa06663e948feb9", "committedDate": "2020-02-19T18:32:56Z", "message": "chore: support PROTOBUF for PRINT TOPIC"}, "afterCommit": {"oid": "b48ec0ed0d518649ab121728fbfe35994c31a6df", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/b48ec0ed0d518649ab121728fbfe35994c31a6df", "committedDate": "2020-02-21T19:02:21Z", "message": "chore: support PROTOBUF for PRINT TOPIC"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0MDQzOTEz", "url": "https://github.com/confluentinc/ksql/pull/4594#pullrequestreview-364043913", "createdAt": "2020-02-25T10:47:31Z", "commit": {"oid": "b48ec0ed0d518649ab121728fbfe35994c31a6df"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxODgwOTQy", "url": "https://github.com/confluentinc/ksql/pull/4594#pullrequestreview-361880942", "createdAt": "2020-02-20T13:01:08Z", "commit": {"oid": "b0ee3473c66aaf3e4e28af447fa06663e948feb9"}, "state": "APPROVED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxMzowMTowOVrOFsSabw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxNDozNTo1MFrOFuIaBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTk4MzM0Mw==", "bodyText": "nit: generally avoid logging and throwing - it's an anti-pattern.  Why isn't it sufficient just to throw here? Does the calling code not log it?", "url": "https://github.com/confluentinc/ksql/pull/4594#discussion_r381983343", "createdAt": "2020-02-20T13:01:09Z", "author": {"login": "big-andy-coates"}, "path": "ksql-engine/src/main/java/io/confluent/ksql/engine/InsertValuesExecutor.java", "diffHunk": "@@ -453,6 +456,7 @@ private static SqlType columnType(final ColumnName column, final LogicalSchema s\n         }\n       }\n \n+      LOG.error(\"Could not serialize row.\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0ee3473c66aaf3e4e28af447fa06663e948feb9"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzkxNDkyNg==", "bodyText": "This call to format seems completely superfluous.  This method now calls deserialize on the deserializer and then immediately passes the result back  to format on the same deserializer.  Why not just have deserialize return the formatted result?\nIn the case of the new protobuf format, all we need to do is pass a factory method to the constructor of the PROTOBUF enum that wraps the KafkaProtobufDeserializer instance in one that applies the format, in a similar way to newJsonDeserializer.\n   private static Deserializer<?> newProtobufDeserializer(final SchemaRegistryClient srClient) {\n\n    final Printer printer = TextFormat.printer();\n    final KafkaProtobufDeserializer<?> inner = new KafkaProtobufDeserializer<>(srClient);\n    \n    return (Deserializer<Object>) (topic, data) -> {\n      final Message msg = inner.deserialize(topic, data);\n      if (msg == null) {\n        return null;\n      }\n      \n      return printer.shortDebugString(msg);\n    };\n  }\n\n...\n\n enum Format {\n    AVRO(0, KafkaAvroDeserializer::new),\n    PROTOBUF(0, RecordFormatter::newAvroDeserializer),\n    JSON(RecordFormatter::newJsonDeserializer),\n ...\n } \nThis avoids the need to complicate the code with another function call on all deserializers...", "url": "https://github.com/confluentinc/ksql/pull/4594#discussion_r383914926", "createdAt": "2020-02-25T14:33:04Z", "author": {"login": "big-andy-coates"}, "path": "ksql-rest-app/src/main/java/io/confluent/ksql/rest/server/resources/streaming/RecordFormatter.java", "diffHunk": "@@ -248,7 +251,7 @@ String format(final Bytes bytes) {\n     ) {\n       try {\n         final Object result = deserializer.deserializer.deserialize(topicName, bytes.get());\n-        return Optional.of(result == null ? \"<null>\" : result.toString());\n+        return Optional.of(result == null ? \"<null>\" : deserializer.format(result));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b48ec0ed0d518649ab121728fbfe35994c31a6df"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzkxNTc2OQ==", "bodyText": "Off-topic, but just wanted to check you have it on your radar to split out a SR_JSON out of the JSON format?", "url": "https://github.com/confluentinc/ksql/pull/4594#discussion_r383915769", "createdAt": "2020-02-25T14:34:33Z", "author": {"login": "big-andy-coates"}, "path": "ksql-rest-app/src/main/java/io/confluent/ksql/rest/server/resources/streaming/RecordFormatter.java", "diffHunk": "@@ -257,39 +260,59 @@ String format(final Bytes bytes) {\n \n   enum WindowSchema {\n \n-    SESSION(SessionWindowedDeserializer::new),\n+    SESSION(WindowSchema::newSessionWindowedDeserializer),\n     HOPPING(WindowSchema::newTimeWindowedDeserializer),\n     TUMBLING(WindowSchema::newTimeWindowedDeserializer);\n \n-    private final Function<Deserializer<?>, Deserializer<?>> mapper;\n+    private final Function<NamedDeserializer, Deserializer<?>> mapper;\n \n-    WindowSchema(final Function<Deserializer<?>, Deserializer<?>> mapper) {\n+    WindowSchema(final Function<NamedDeserializer, Deserializer<?>> mapper) {\n       this.mapper = requireNonNull(mapper, \"mapper\");\n     }\n \n     public NamedDeserializer wrap(final NamedDeserializer inner) {\n \n       final String name = name() + \"(\" + inner.name + \")\";\n \n-      final Deserializer<?> deserializer = mapper.apply(inner.deserializer);\n+      final Deserializer<?> deserializer = mapper.apply(inner);\n \n-      return new NamedDeserializer(name, inner.doNotWrap, deserializer);\n+      return new NamedDeserializer(name, inner.doNotWrap, deserializer, inner::format);\n     }\n \n-    private static Deserializer<?> newTimeWindowedDeserializer(final Deserializer<?> inner) {\n-      final TimeWindowedDeserializer<?> windowedDeser = new TimeWindowedDeserializer<>(inner);\n+    private static Deserializer<?> newSessionWindowedDeserializer(\n+        final NamedDeserializer inner\n+    ) {\n+      final SessionWindowedDeserializer<?> sessionDeser\n+          = new SessionWindowedDeserializer<>(inner.deserializer);\n+\n+      return (topic, data) -> {\n+        final Windowed<?> windowed = sessionDeser.deserialize(topic, data);\n+        return \"[\" + inner.format(windowed.key())\n+            + \"@\" + windowed.window().start() + \"/\" + windowed.window().end() + \"]\";\n+      };\n+    }\n+\n+    private static Deserializer<?> newTimeWindowedDeserializer(\n+        final NamedDeserializer inner\n+    ) {\n+      final TimeWindowedDeserializer<?> windowedDeser\n+          = new TimeWindowedDeserializer<>(inner.deserializer);\n \n       return (topic, data) -> {\n         final Windowed<?> windowed = windowedDeser.deserialize(topic, data);\n \n         // Exclude window end time for time-windowed as the end time is not in the serialized data:\n-        return \"[\" + windowed.key() + \"@\" + windowed.window().start() + \"/-]\";\n+        return \"[\" + inner.format(windowed.key()) + \"@\" + windowed.window().start() + \"/-]\";\n       };\n     }\n   }\n \n   enum Format {\n-    AVRO(0, KafkaAvroDeserializer::new),\n+    AVRO(0, KafkaAvroDeserializer::new, Object::toString),\n+    PROTOBUF(\n+        0,\n+        KafkaProtobufDeserializer::new,\n+            o -> TextFormat.printer().shortDebugString((Message) o)),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b48ec0ed0d518649ab121728fbfe35994c31a6df"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzkxNjE0Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void shouldNotExcludeAvroOnValidProtobuf() {\n          \n          \n            \n                public void shouldNotExcludeProtobufOnValidProtobuf() {", "url": "https://github.com/confluentinc/ksql/pull/4594#discussion_r383916142", "createdAt": "2020-02-25T14:35:10Z", "author": {"login": "big-andy-coates"}, "path": "ksql-rest-app/src/test/java/io/confluent/ksql/rest/server/resources/streaming/RecordFormatterTest.java", "diffHunk": "@@ -526,6 +547,95 @@ public void shouldFormatValidSessionWindowedAvro() {\n       assertThat(formatted, is(\"[{\\\"str1\\\": \\\"My first string\\\"}@1534567890123/1534567899999]\"));\n     }\n \n+    @Test\n+    public void shouldExcludeProtobufNoSchema() {\n+      // Given:\n+      // not: givenProtoSchemaRegistered();\n+\n+      // When:\n+      deserializers.format(SERIALIZED_PROTOBUF_RECORD);\n+\n+      // Then:\n+      assertThat(deserializers.getPossibleFormats(), not(hasItem(\"PROTOBUF\")));\n+    }\n+\n+    @Test\n+    public void shouldNotExcludeAvroOnValidProtobuf() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b48ec0ed0d518649ab121728fbfe35994c31a6df"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzkxNjM5NQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void shouldNotExcludeTimeWindowedProtobufOnValidTimeWindowedAvro() {\n          \n          \n            \n                public void shouldNotExcludeTimeWindowedProtobufOnValidTimeWindowedProtobuf() {", "url": "https://github.com/confluentinc/ksql/pull/4594#discussion_r383916395", "createdAt": "2020-02-25T14:35:36Z", "author": {"login": "big-andy-coates"}, "path": "ksql-rest-app/src/test/java/io/confluent/ksql/rest/server/resources/streaming/RecordFormatterTest.java", "diffHunk": "@@ -526,6 +547,95 @@ public void shouldFormatValidSessionWindowedAvro() {\n       assertThat(formatted, is(\"[{\\\"str1\\\": \\\"My first string\\\"}@1534567890123/1534567899999]\"));\n     }\n \n+    @Test\n+    public void shouldExcludeProtobufNoSchema() {\n+      // Given:\n+      // not: givenProtoSchemaRegistered();\n+\n+      // When:\n+      deserializers.format(SERIALIZED_PROTOBUF_RECORD);\n+\n+      // Then:\n+      assertThat(deserializers.getPossibleFormats(), not(hasItem(\"PROTOBUF\")));\n+    }\n+\n+    @Test\n+    public void shouldNotExcludeAvroOnValidProtobuf() {\n+      // Given:\n+      givenProtoSchemaRegistered();\n+\n+      // When:\n+      deserializers.format(SERIALIZED_PROTOBUF_RECORD);\n+\n+      // Then:\n+      assertThat(deserializers.getPossibleFormats(), hasItems(\n+          \"PROTOBUF\"\n+      ));\n+    }\n+\n+    @Test\n+    public void shouldFormatValidProtobuf() {\n+      // Given:\n+      givenProtoSchemaRegistered();\n+\n+      // When:\n+      final String formatted = deserializers.format(SERIALIZED_PROTOBUF_RECORD);\n+\n+      // Then:\n+      assertThat(formatted, is(\"str1: \\\"My first string\\\" str2: \\\"My second string\\\"\"));\n+    }\n+\n+    @Test\n+    public void shouldNotExcludeTimeWindowedProtobufOnValidTimeWindowedAvro() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b48ec0ed0d518649ab121728fbfe35994c31a6df"}, "originalPosition": 102}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzkxNjU0OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void shouldNotExcludeSessionWindowedProtobufOnValidTimeWindowedAvro() {\n          \n          \n            \n                public void shouldNotExcludeSessionWindowedProtobufOnValidTimeWindowedProtobuf() {", "url": "https://github.com/confluentinc/ksql/pull/4594#discussion_r383916549", "createdAt": "2020-02-25T14:35:50Z", "author": {"login": "big-andy-coates"}, "path": "ksql-rest-app/src/test/java/io/confluent/ksql/rest/server/resources/streaming/RecordFormatterTest.java", "diffHunk": "@@ -526,6 +547,95 @@ public void shouldFormatValidSessionWindowedAvro() {\n       assertThat(formatted, is(\"[{\\\"str1\\\": \\\"My first string\\\"}@1534567890123/1534567899999]\"));\n     }\n \n+    @Test\n+    public void shouldExcludeProtobufNoSchema() {\n+      // Given:\n+      // not: givenProtoSchemaRegistered();\n+\n+      // When:\n+      deserializers.format(SERIALIZED_PROTOBUF_RECORD);\n+\n+      // Then:\n+      assertThat(deserializers.getPossibleFormats(), not(hasItem(\"PROTOBUF\")));\n+    }\n+\n+    @Test\n+    public void shouldNotExcludeAvroOnValidProtobuf() {\n+      // Given:\n+      givenProtoSchemaRegistered();\n+\n+      // When:\n+      deserializers.format(SERIALIZED_PROTOBUF_RECORD);\n+\n+      // Then:\n+      assertThat(deserializers.getPossibleFormats(), hasItems(\n+          \"PROTOBUF\"\n+      ));\n+    }\n+\n+    @Test\n+    public void shouldFormatValidProtobuf() {\n+      // Given:\n+      givenProtoSchemaRegistered();\n+\n+      // When:\n+      final String formatted = deserializers.format(SERIALIZED_PROTOBUF_RECORD);\n+\n+      // Then:\n+      assertThat(formatted, is(\"str1: \\\"My first string\\\" str2: \\\"My second string\\\"\"));\n+    }\n+\n+    @Test\n+    public void shouldNotExcludeTimeWindowedProtobufOnValidTimeWindowedAvro() {\n+      // Given:\n+      givenProtoSchemaRegistered();\n+\n+      // When:\n+      deserializers.format(SERIALIZED_TIME_WINDOWED_PROTOBUF_RECORD);\n+\n+      // Then:\n+      assertThat(deserializers.getPossibleFormats(), hasItems(\n+          \"TUMBLING(PROTOBUF)\", \"HOPPING(PROTOBUF)\"\n+      ));\n+    }\n+\n+    @Test\n+    public void shouldFormatValidTimeWindowedProtobuf() {\n+      // Given:\n+      givenProtoSchemaRegistered();\n+\n+      // When:\n+      final String formatted = deserializers.format(SERIALIZED_TIME_WINDOWED_PROTOBUF_RECORD);\n+\n+      assertThat(formatted, is(\"[str1: \\\"My first string\\\" str2: \\\"My second string\\\"@1234567890123/-]\"));\n+    }\n+\n+    @Test\n+    public void shouldNotExcludeSessionWindowedProtobufOnValidTimeWindowedAvro() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b48ec0ed0d518649ab121728fbfe35994c31a6df"}, "originalPosition": 127}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "254cc9bcefa576cc21ec99ccc497dc58b29184ce", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/254cc9bcefa576cc21ec99ccc497dc58b29184ce", "committedDate": "2020-02-25T17:34:02Z", "message": "chore: support PROTOBUF for PRINT TOPIC"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f2dc7a95ccc0dd65deb5c22de605977c3a73a4e", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/1f2dc7a95ccc0dd65deb5c22de605977c3a73a4e", "committedDate": "2020-02-25T17:45:42Z", "message": "fix: andys comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b48ec0ed0d518649ab121728fbfe35994c31a6df", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/b48ec0ed0d518649ab121728fbfe35994c31a6df", "committedDate": "2020-02-21T19:02:21Z", "message": "chore: support PROTOBUF for PRINT TOPIC"}, "afterCommit": {"oid": "1f2dc7a95ccc0dd65deb5c22de605977c3a73a4e", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/1f2dc7a95ccc0dd65deb5c22de605977c3a73a4e", "committedDate": "2020-02-25T17:45:42Z", "message": "fix: andys comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4845, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}