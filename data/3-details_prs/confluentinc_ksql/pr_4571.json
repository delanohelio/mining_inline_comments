{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc1NjEyMDUw", "number": 4571, "title": "refactor: add SessionProperties to executors", "bodyText": "Description\nModifies the StatementExecutor interface by wrapping the mutableScopedProperties in a SessionProperties object. KsqlResource will create SessionProperty objects and pass them to RequestValidator and RequestHandler.\nThis provides more information in the executors when processing requests (can also add additional parameters if necessary in the future)\nThe motivation for this PR is here #4572\nAlso, moved discovery of remote hosts from Persistent Queries in HeartbeatAgent to a generic utility function.\nTesting done\nOnly refactor change, update function calls so build can pass.\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-02-14T23:19:47Z", "url": "https://github.com/confluentinc/ksql/pull/4571", "merged": true, "mergeCommit": {"oid": "d7bc85a82a99c8332ffcce5cd1fd7969d8abb182"}, "closed": true, "closedAt": "2020-02-20T19:25:58Z", "author": {"login": "stevenpyzhang"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcEYFtMABqjMwNDA0MjMyMDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcGPej1gBqjMwNTc2NTA4MTc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6930e96600a110e24d6f59e5e7622c46847c9275", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/6930e96600a110e24d6f59e5e7622c46847c9275", "committedDate": "2020-02-14T23:14:01Z", "message": "refactor: add SessionProperties to executors"}, "afterCommit": {"oid": "ff1b8c1fdb3d8d84e4169d59d89660c93d8ba03a", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/ff1b8c1fdb3d8d84e4169d59d89660c93d8ba03a", "committedDate": "2020-02-14T23:25:35Z", "message": "refactor: add SessionProperties to executors"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ff1b8c1fdb3d8d84e4169d59d89660c93d8ba03a", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/ff1b8c1fdb3d8d84e4169d59d89660c93d8ba03a", "committedDate": "2020-02-14T23:25:35Z", "message": "refactor: add SessionProperties to executors"}, "afterCommit": {"oid": "dc8df2ac5f8ea2ed2631b9c10a20bc60187ea7bc", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/dc8df2ac5f8ea2ed2631b9c10a20bc60187ea7bc", "committedDate": "2020-02-15T00:20:43Z", "message": "checkstyle errors"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dc8df2ac5f8ea2ed2631b9c10a20bc60187ea7bc", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/dc8df2ac5f8ea2ed2631b9c10a20bc60187ea7bc", "committedDate": "2020-02-15T00:20:43Z", "message": "checkstyle errors"}, "afterCommit": {"oid": "4f4b005dedf4074fc97792796bc75f5996ca0f17", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/4f4b005dedf4074fc97792796bc75f5996ca0f17", "committedDate": "2020-02-15T00:54:26Z", "message": "checkstyle errors"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNDk2Nzg1", "url": "https://github.com/confluentinc/ksql/pull/4571#pullrequestreview-360496785", "createdAt": "2020-02-18T16:42:23Z", "commit": {"oid": "4f4b005dedf4074fc97792796bc75f5996ca0f17"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNjo0MjoyM1rOFrJ61A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNzoyNTo0NFrOFrLhAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDc5NTYwNA==", "bodyText": "Is HashedMap a real class? Isn't HashMap?\nBtw, being the requirement that the passed parameter is mutable, it is better to create the HashMap in the SessionProperties class. The reason is that I could pass a Collections.singletonMap here, which will break the contract of the getMutableScopedProperties() method later.", "url": "https://github.com/confluentinc/ksql/pull/4571#discussion_r380795604", "createdAt": "2020-02-18T16:42:23Z", "author": {"login": "spena"}, "path": "ksql-rest-app/src/main/java/io/confluent/ksql/rest/server/resources/KsqlResource.java", "diffHunk": "@@ -195,7 +216,11 @@ public Response terminateCluster(\n       final KsqlEntityList entities = handler.execute(\n           securityContext,\n           TERMINATE_CLUSTER,\n-          request.getStreamsProperties()\n+              new SessionProperties(\n+                  new HashedMap<>(request.getStreamsProperties()),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f4b005dedf4074fc97792796bc75f5996ca0f17"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDgxNzc5OQ==", "bodyText": "Is this example accurate on the mutable properties? If expect the returned value can be mutable and affect the values of the wrapped scope properties, then is fine.\nSessionProperties sm1 = new SessionProperties(...);\n\nMap<String, String> sm1 = s1.getMutableScopedProperties();\nsm1.put(\"k1\", \"v1\");\n\n// This will print \"v1\"\nSystem.out.println(sm1.get(\"k1\"));\n\n// This will print \"v1\"\nSystem.out.println(s1.getScopeProperties().get(\"k1\"));", "url": "https://github.com/confluentinc/ksql/pull/4571#discussion_r380817799", "createdAt": "2020-02-18T17:18:39Z", "author": {"login": "spena"}, "path": "ksql-rest-model/src/main/java/io/confluent/ksql/rest/SessionProperties.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"; you may not use\n+ * this file except in compliance with the License. You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.rest;\n+\n+import io.confluent.ksql.util.KsqlHostInfo;\n+\n+import java.net.URL;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+public class SessionProperties {\n+  \n+  private final Map<String, Object> mutableScopedProperties;\n+  private final KsqlHostInfo ksqlHostInfo;\n+  private final URL localUrl;\n+\n+  public SessionProperties(\n+          final Map<String, Object> mutableScopedProperties,\n+          final KsqlHostInfo ksqlHostInfo,\n+          final URL localUrl) {\n+    this.mutableScopedProperties = \n+        Objects.requireNonNull(mutableScopedProperties, \"mutableScopedProperties\");\n+    this.ksqlHostInfo = Objects.requireNonNull(ksqlHostInfo, \"ksqlHostInfo\");\n+    this.localUrl = Objects.requireNonNull(localUrl, \"localUrl\");\n+  }\n+\n+  public Map<String, Object> getMutableScopedProperties() {\n+    return mutableScopedProperties;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f4b005dedf4074fc97792796bc75f5996ca0f17"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDgxOTQ5MA==", "bodyText": "Tip: If we expect this class to grow in the future when passing more parameters to the executor, then we could create it as a Builder pattern. Not necessary to do it in this PR, feel free to do it here or later.", "url": "https://github.com/confluentinc/ksql/pull/4571#discussion_r380819490", "createdAt": "2020-02-18T17:21:30Z", "author": {"login": "spena"}, "path": "ksql-rest-model/src/main/java/io/confluent/ksql/rest/SessionProperties.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"; you may not use\n+ * this file except in compliance with the License. You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.rest;\n+\n+import io.confluent.ksql.util.KsqlHostInfo;\n+\n+import java.net.URL;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+public class SessionProperties {\n+  \n+  private final Map<String, Object> mutableScopedProperties;\n+  private final KsqlHostInfo ksqlHostInfo;\n+  private final URL localUrl;\n+\n+  public SessionProperties(\n+          final Map<String, Object> mutableScopedProperties,\n+          final KsqlHostInfo ksqlHostInfo,\n+          final URL localUrl) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f4b005dedf4074fc97792796bc75f5996ca0f17"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDgyMTc2Mg==", "bodyText": "Doesn't hostInfo.equals(localHost) work? I see KsqlHostInfo has the equals() implemented.", "url": "https://github.com/confluentinc/ksql/pull/4571#discussion_r380821762", "createdAt": "2020-02-18T17:25:44Z", "author": {"login": "spena"}, "path": "ksql-rest-app/src/main/java/io/confluent/ksql/rest/util/DiscoverRemoteHostsUtil.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"; you may not use\n+ * this file except in compliance with the License. You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.rest.util;\n+\n+import io.confluent.ksql.util.KsqlHostInfo;\n+import io.confluent.ksql.util.PersistentQueryMetadata;\n+import io.confluent.ksql.util.QueryMetadata;\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import org.apache.kafka.streams.state.HostInfo;\n+import org.apache.kafka.streams.state.StreamsMetadata;\n+\n+public final class DiscoverRemoteHostsUtil {\n+\n+  private DiscoverRemoteHostsUtil() {}\n+\n+  public static Set<HostInfo> getRemoteHosts(\n+      final List<PersistentQueryMetadata> currentQueries, \n+      final KsqlHostInfo localHost\n+  ) {\n+    return currentQueries.stream()\n+        .map(QueryMetadata::getAllMetadata)\n+        .filter(Objects::nonNull)\n+        .flatMap(Collection::stream)\n+        .filter(streamsMetadata -> streamsMetadata != StreamsMetadata.NOT_AVAILABLE)\n+        .map(StreamsMetadata::hostInfo)\n+        .filter(hostInfo -> !(hostInfo.host().equals(localHost.host())\n+            && hostInfo.port() == (localHost.port())))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f4b005dedf4074fc97792796bc75f5996ca0f17"}, "originalPosition": 44}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4f4b005dedf4074fc97792796bc75f5996ca0f17", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/4f4b005dedf4074fc97792796bc75f5996ca0f17", "committedDate": "2020-02-15T00:54:26Z", "message": "checkstyle errors"}, "afterCommit": {"oid": "e9c652563e81ebbf1d6c64a5dfa0ee6391a8f0cb", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/e9c652563e81ebbf1d6c64a5dfa0ee6391a8f0cb", "committedDate": "2020-02-18T20:21:10Z", "message": "checkstyle errors"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e9c652563e81ebbf1d6c64a5dfa0ee6391a8f0cb", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/e9c652563e81ebbf1d6c64a5dfa0ee6391a8f0cb", "committedDate": "2020-02-18T20:21:10Z", "message": "checkstyle errors"}, "afterCommit": {"oid": "815a37dd39ecb5a031babaff570e635c79ff01df", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/815a37dd39ecb5a031babaff570e635c79ff01df", "committedDate": "2020-02-18T21:48:35Z", "message": "checkstyle errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f40eb51beba5f550f35b811cad5ae9f8d8cbef4a", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/f40eb51beba5f550f35b811cad5ae9f8d8cbef4a", "committedDate": "2020-02-19T18:40:39Z", "message": "refactor: add SessionProperties to executors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da71c464ab9bf9625bdc28cffb087bfbe7922e34", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/da71c464ab9bf9625bdc28cffb087bfbe7922e34", "committedDate": "2020-02-19T18:40:39Z", "message": "checkstyle errors"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "815a37dd39ecb5a031babaff570e635c79ff01df", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/815a37dd39ecb5a031babaff570e635c79ff01df", "committedDate": "2020-02-18T21:48:35Z", "message": "checkstyle errors"}, "afterCommit": {"oid": "da71c464ab9bf9625bdc28cffb087bfbe7922e34", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/da71c464ab9bf9625bdc28cffb087bfbe7922e34", "committedDate": "2020-02-19T18:40:39Z", "message": "checkstyle errors"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxNTE4NzQ2", "url": "https://github.com/confluentinc/ksql/pull/4571#pullrequestreview-361518746", "createdAt": "2020-02-19T23:40:11Z", "commit": {"oid": "da71c464ab9bf9625bdc28cffb087bfbe7922e34"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQyMzo0MDoxMVrOFr7rWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQyMzo0MDoxMVrOFr7rWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTYxMDg0Mw==", "bodyText": "javadoc please :) what belongs in this? when is it refreshed? where should it be used?  also make sure to javadoc the parameters, whats the ksqlHostInfo - is that me? is that the caller?", "url": "https://github.com/confluentinc/ksql/pull/4571#discussion_r381610843", "createdAt": "2020-02-19T23:40:11Z", "author": {"login": "agavra"}, "path": "ksql-rest-model/src/main/java/io/confluent/ksql/rest/SessionProperties.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"; you may not use\n+ * this file except in compliance with the License. You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.rest;\n+\n+import io.confluent.ksql.util.KsqlHostInfo;\n+\n+import java.net.URL;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+public class SessionProperties {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "da71c464ab9bf9625bdc28cffb087bfbe7922e34"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4451f3917e331c2916039a9319c0875064065b9", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/f4451f3917e331c2916039a9319c0875064065b9", "committedDate": "2020-02-20T18:31:28Z", "message": "javadocs"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "548a5942720d8de1a63c677f5e4fc5074cdb0c43", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/548a5942720d8de1a63c677f5e4fc5074cdb0c43", "committedDate": "2020-02-20T18:22:15Z", "message": "javadocs"}, "afterCommit": {"oid": "f4451f3917e331c2916039a9319c0875064065b9", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/f4451f3917e331c2916039a9319c0875064065b9", "committedDate": "2020-02-20T18:31:28Z", "message": "javadocs"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 30, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}