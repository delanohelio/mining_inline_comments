{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE3ODEzMDcx", "number": 6587, "title": "feat: Extend CAST to ARRAY, MAP and STRUCT", "bodyText": "Description\nfixes: #2632 (null handling)\nfixes: #6584 (cast array, map, struct)\nOverhaul the CAST code to fix issues with null handling, (all most all CAST calls with null values resulting in NPE) and extend it to support casting structured types, e.g. cast ARRAY<INT> to ARRAY<BIGINT>.  Or MAP<STRING, INT> to MAP<STRING, STRING>. etc.\nSTRUCTs can also be cast.  Any field that existings in both the struct types will be cast.  For example:\nCAST(Struct(F0 := '10', F1 := true) AS Struct<F0 INT, F2 INT>)\nWill result in Struct(F0 := 10, F2 = null).\nTesting done\nUsual.\nCastEvaluatorTest has extensive tests to ensure:\n\nUnsupported casts fail early\nSupported casts succeed and output code that:\n\nCompiles!\nCan handle nulls without throwing NPE\nreturns data of the correct type.\n\n\n\ncast.json has more functional testing around testing the actual result of a cast.\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-11-09T14:43:32Z", "url": "https://github.com/confluentinc/ksql/pull/6587", "merged": true, "mergeCommit": {"oid": "bfee1c1d4d6a4d6279b14bd419984239cdba0470"}, "closed": true, "closedAt": "2020-11-10T12:55:27Z", "author": {"login": "big-andy-coates"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZ0SQogH2gAyNTE3ODEzMDcxOmY3Yzc3OGNhYjMxYjAxZGViZjFmY2I0NzlmMWI0MDRkNTk4YTVhZGU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbI46uAH2gAyNTE3ODEzMDcxOmZkMmM4MTFlZWU5ODg4ZjRlYTVhYmY3NjE3ODE2NzlmMDNkNmI0Y2I=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f7c778cab31b01debf1fcb479f1b404d598a5ade", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/f7c778cab31b01debf1fcb479f1b404d598a5ade", "committedDate": "2020-11-06T10:20:21Z", "message": "fix: extend CAST to structured types\n\nfixes: https://github.com/confluentinc/ksql/issues/6584\n\nExtend CAST to the structured types `ARRAY`, `MAP` and `STRUCT`."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d791ae76e2e22f937b41ed27f1081094b1b15c6", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/0d791ae76e2e22f937b41ed27f1081094b1b15c6", "committedDate": "2020-11-06T13:39:46Z", "message": "test: extend test coverage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6633d29ffd35be34f7386e0dfd858bcb2c9d1741", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/6633d29ffd35be34f7386e0dfd858bcb2c9d1741", "committedDate": "2020-11-06T14:01:41Z", "message": "refactor: refactor cast evaluator\n\nClean up the code."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cfa09516cbee230c662a96f3bb2e00f4d9cebee7", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/cfa09516cbee230c662a96f3bb2e00f4d9cebee7", "committedDate": "2020-11-09T14:31:20Z", "message": "fix: fix null handling and extend to array, map, struct"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2MzI3MzUx", "url": "https://github.com/confluentinc/ksql/pull/6587#pullrequestreview-526327351", "createdAt": "2020-11-09T14:46:17Z", "commit": {"oid": "cfa09516cbee230c662a96f3bb2e00f4d9cebee7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxNDo0NjoxOFrOHvyKvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxNDo0NjoxOFrOHvyKvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg2NzA2OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            | STRING | BOOLEAN | Any string that exactly matches `true`, case-insensitive, will be converted to `true`. Any other value will be converted to `false`. |\n          \n          \n            \n            | STRING | BOOLEAN | Any string that exactly matches `true`, case-insensitive, is converted to `true`. Any other value is converted to `false`. |", "url": "https://github.com/confluentinc/ksql/pull/6587#discussion_r519867069", "createdAt": "2020-11-09T14:46:18Z", "author": {"login": "JimGalasyn"}, "path": "docs/developer-guide/ksqldb-reference/scalar-functions.md", "diffHunk": "@@ -40,6 +40,26 @@ CREATE TABLE AGG AS\n    GROUP BY ID;\n ```\n \n+### CAST\n+\n+Since: -\n+\n+```sql\n+CAST(COL0 AS BIGINT)\n+```\n+\n+Converts one type to another. The following casts are supported:\n+\n+| from | to | notes |\n+|------|----|-------|\n+| ANY  | STRING | Converts the type to its string representation. |\n+| STRING | BOOLEAN | Any string that exactly matches `true`, case-insensitive, will be converted to `true`. Any other value will be converted to `false`. |", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfa09516cbee230c662a96f3bb2e00f4d9cebee7"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fdd7ecde0f05a429fea795b57299fe4ce63c3880", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/fdd7ecde0f05a429fea795b57299fe4ce63c3880", "committedDate": "2020-11-09T14:46:39Z", "message": "Update docs/developer-guide/ksqldb-reference/scalar-functions.md\n\nCo-authored-by: Jim Galasyn <jim.galasyn@confluent.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2MzI4MzQx", "url": "https://github.com/confluentinc/ksql/pull/6587#pullrequestreview-526328341", "createdAt": "2020-11-09T14:47:13Z", "commit": {"oid": "cfa09516cbee230c662a96f3bb2e00f4d9cebee7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxNDo0NzoxM1rOHvyNnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxNDo0NzoxM1rOHvyNnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg2NzgwNw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            | STRUCT | STRUCT | Convert between structs of different field types. Only fields that existing in the target STRUCT type will be copied across. Any fields in the target type that do not exist in the source will be set to `NULL` |\n          \n          \n            \n            | STRUCT | STRUCT | Convert between structs of different field types. Only fields that exist in the target STRUCT type are copied across. Any fields in the target type that don't exist in the source are set to `NULL` |", "url": "https://github.com/confluentinc/ksql/pull/6587#discussion_r519867807", "createdAt": "2020-11-09T14:47:13Z", "author": {"login": "JimGalasyn"}, "path": "docs/developer-guide/ksqldb-reference/scalar-functions.md", "diffHunk": "@@ -40,6 +40,26 @@ CREATE TABLE AGG AS\n    GROUP BY ID;\n ```\n \n+### CAST\n+\n+Since: -\n+\n+```sql\n+CAST(COL0 AS BIGINT)\n+```\n+\n+Converts one type to another. The following casts are supported:\n+\n+| from | to | notes |\n+|------|----|-------|\n+| ANY  | STRING | Converts the type to its string representation. |\n+| STRING | BOOLEAN | Any string that exactly matches `true`, case-insensitive, will be converted to `true`. Any other value will be converted to `false`. |\n+| STRING | INT, BIGINT, DECIMAL, DOUBLE | Converts string representation of numbers to number types. Conversion will fail if text does not contain a number or the number does not fit in the indicated type. |\n+| INT, BIGINT, DECIMAL, DOUBLE | INT, BIGINT, DECIMAL, DOUBLE | Convert between numeric types. Conversion can result in rounding |\n+| ARRAY | ARRAY | Convert between arrays of different element types |   \n+| MAP | MAP | Convert between maps of different key and value types |   \n+| STRUCT | STRUCT | Convert between structs of different field types. Only fields that existing in the target STRUCT type will be copied across. Any fields in the target type that do not exist in the source will be set to `NULL` |", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfa09516cbee230c662a96f3bb2e00f4d9cebee7"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2MzI4Nzcy", "url": "https://github.com/confluentinc/ksql/pull/6587#pullrequestreview-526328772", "createdAt": "2020-11-09T14:47:36Z", "commit": {"oid": "cfa09516cbee230c662a96f3bb2e00f4d9cebee7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxNDo0NzozNlrOHvyO5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxNDo0NzozNlrOHvyO5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg2ODEzNQ==", "bodyText": "Since 0.14.0?", "url": "https://github.com/confluentinc/ksql/pull/6587#discussion_r519868135", "createdAt": "2020-11-09T14:47:36Z", "author": {"login": "JimGalasyn"}, "path": "docs/developer-guide/ksqldb-reference/scalar-functions.md", "diffHunk": "@@ -40,6 +40,26 @@ CREATE TABLE AGG AS\n    GROUP BY ID;\n ```\n \n+### CAST\n+\n+Since: -", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfa09516cbee230c662a96f3bb2e00f4d9cebee7"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2MzMwMzQw", "url": "https://github.com/confluentinc/ksql/pull/6587#pullrequestreview-526330340", "createdAt": "2020-11-09T14:49:13Z", "commit": {"oid": "cfa09516cbee230c662a96f3bb2e00f4d9cebee7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxNDo0OToxM1rOHvyTeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxNDo0OToxM1rOHvyTeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg2OTMwNA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            | STRING | INT, BIGINT, DECIMAL, DOUBLE | Converts string representation of numbers to number types. Conversion will fail if text does not contain a number or the number does not fit in the indicated type. |\n          \n          \n            \n            | STRING | INT, BIGINT, DECIMAL, DOUBLE | Converts string representation of numbers to number types. Conversion fails if text doesn't contain a number or the number doesn't fit in the indicated type. |", "url": "https://github.com/confluentinc/ksql/pull/6587#discussion_r519869304", "createdAt": "2020-11-09T14:49:13Z", "author": {"login": "JimGalasyn"}, "path": "docs/developer-guide/ksqldb-reference/scalar-functions.md", "diffHunk": "@@ -40,6 +40,26 @@ CREATE TABLE AGG AS\n    GROUP BY ID;\n ```\n \n+### CAST\n+\n+Since: -\n+\n+```sql\n+CAST(COL0 AS BIGINT)\n+```\n+\n+Converts one type to another. The following casts are supported:\n+\n+| from | to | notes |\n+|------|----|-------|\n+| ANY  | STRING | Converts the type to its string representation. |\n+| STRING | BOOLEAN | Any string that exactly matches `true`, case-insensitive, will be converted to `true`. Any other value will be converted to `false`. |\n+| STRING | INT, BIGINT, DECIMAL, DOUBLE | Converts string representation of numbers to number types. Conversion will fail if text does not contain a number or the number does not fit in the indicated type. |", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfa09516cbee230c662a96f3bb2e00f4d9cebee7"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2MzMwOTkz", "url": "https://github.com/confluentinc/ksql/pull/6587#pullrequestreview-526330993", "createdAt": "2020-11-09T14:49:52Z", "commit": {"oid": "cfa09516cbee230c662a96f3bb2e00f4d9cebee7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f835553fc4fe70d758eb70e95030e838c4eb60a", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/9f835553fc4fe70d758eb70e95030e838c4eb60a", "committedDate": "2020-11-09T14:51:38Z", "message": "test: historical plans"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "017c7cbbd893a19e8526f47af980372e337e974c", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/017c7cbbd893a19e8526f47af980372e337e974c", "committedDate": "2020-11-09T14:51:49Z", "message": "Merge branch 'cast' of github.com:big-andy-coates/ksql into cast"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7a7bb166a3ab6e112bd7e5c5364772d6225b3dc", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/b7a7bb166a3ab6e112bd7e5c5364772d6225b3dc", "committedDate": "2020-11-09T14:54:33Z", "message": "chore: jim's requested changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NDczNDQ2", "url": "https://github.com/confluentinc/ksql/pull/6587#pullrequestreview-526473446", "createdAt": "2020-11-09T17:11:32Z", "commit": {"oid": "b7a7bb166a3ab6e112bd7e5c5364772d6225b3dc"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxNzoxMTozMlrOHv4-Qg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxNzozMTo0NlrOHv5zXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTk3ODU2Mg==", "bodyText": "f0 is a VARCHAR. Shouldn't it be an ARRAY<INT>?", "url": "https://github.com/confluentinc/ksql/pull/6587#discussion_r519978562", "createdAt": "2020-11-09T17:11:32Z", "author": {"login": "spena"}, "path": "ksqldb-functional-tests/src/test/resources/query-validation-tests/cast.json", "diffHunk": "@@ -14,6 +14,19 @@\n         \"message\": \"Invalid Select: Cast of STRING to ARRAY<INTEGER> is not supported\"\n       }\n     },\n+    {\n+      \"name\": \"array to string\",\n+      \"statements\": [\n+        \"CREATE STREAM TEST (f0 VARCHAR) WITH (kafka_topic='test_topic', value_format='JSON');\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7a7bb166a3ab6e112bd7e5c5364772d6225b3dc"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTk4ODg3OA==", "bodyText": "Should it be good to have a unit test for this?", "url": "https://github.com/confluentinc/ksql/pull/6587#discussion_r519988878", "createdAt": "2020-11-09T17:27:08Z", "author": {"login": "spena"}, "path": "ksqldb-execution/src/main/java/io/confluent/ksql/execution/codegen/helpers/LambdaUtil.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"); you may not use\n+ * this file except in compliance with the License.  You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.execution.codegen.helpers;\n+\n+/**\n+ * Functions to help with generating code to work around the fact that the script engine doesn't\n+ * support lambdas.\n+ */\n+public final class LambdaUtil {\n+\n+  private LambdaUtil() {\n+  }\n+\n+  /**\n+   * Generate code to build a {@link java.util.function.Function}.\n+   *\n+   * @param argName the name of the single argument the  {@code lambdaBody} expects.\n+   * @param argType the type of the single argument the {@code lambdaBody} expects.\n+   * @param lambdaBody the body of the lambda. It will find the n\n+   * @return code to instantiate the function.\n+   */\n+  public static String function(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7a7bb166a3ab6e112bd7e5c5364772d6225b3dc"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTk5MjE1Nw==", "bodyText": "Unit tests? Seems useful to know what the returned code is.", "url": "https://github.com/confluentinc/ksql/pull/6587#discussion_r519992157", "createdAt": "2020-11-09T17:31:46Z", "author": {"login": "spena"}, "path": "ksqldb-execution/src/main/java/io/confluent/ksql/execution/codegen/helpers/NullSafe.java", "diffHunk": "@@ -0,0 +1,101 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"); you may not use\n+ * this file except in compliance with the License.  You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.execution.codegen.helpers;\n+\n+import java.util.function.Function;\n+\n+/**\n+ * Helper functions around null handling\n+ */\n+public final class NullSafe {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7a7bb166a3ab6e112bd7e5c5364772d6225b3dc"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b62e3d5d7eb62d07963b03aef12df2aa2d62601", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/1b62e3d5d7eb62d07963b03aef12df2aa2d62601", "committedDate": "2020-11-10T10:17:50Z", "message": "chore: review changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd2c811eee9888f4ea5abf761781679f03d6b4cb", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/fd2c811eee9888f4ea5abf761781679f03d6b4cb", "committedDate": "2020-11-10T12:54:36Z", "message": "refactor: inline method"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4605, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}