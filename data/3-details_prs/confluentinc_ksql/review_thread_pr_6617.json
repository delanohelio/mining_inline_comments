{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIxNjQ0MDcx", "number": 6617, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxMjo1MjoxMFrOE5eTiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNjo1ODo0N1rOE5lTtA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4NzAwODExOnYy", "diffSide": "LEFT", "path": "docs/developer-guide/syntax-reference.md", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxMjo1MjoxMFrOHz9TcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxMjo1MjoxMFrOHz9TcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI0MzgyNA==", "bodyText": "Removed, as 0.7.1 was a long time ago. This should really of been in the upgrade notes, not the main docs.", "url": "https://github.com/confluentinc/ksql/pull/6617#discussion_r524243824", "createdAt": "2020-11-16T12:52:10Z", "author": {"login": "big-andy-coates"}, "path": "docs/developer-guide/syntax-reference.md", "diffHunk": "@@ -241,24 +241,11 @@ statement by using the syntax `ARRAY<ElementType>`. For example,\n `ARRAY<INT>` defines an array of integers.\n \n Also, you can output an array from a query by using a SELECT statement.\n-The following example creates an array from a stream named `s1`. \n+The following example creates an array from a stream named `s1` using\n+the [`ARRAY` constructor function](ksqldb-reference/scalar-functions.md#array).\n \n ```sql\n-SELECT ARRAY[1, 2] FROM s1 EMIT CHANGES;\n-```\n-\n-Starting in version 0.7.1, the built-in AS_ARRAY function syntax for\n-creating arrays doesn't work. Replace AS_ARRAY with the ARRAY constructor\n-syntax. For example, replace this legacy query:\n-\n-```sql\n-CREATE STREAM OUTPUT AS SELECT cube_explode(as_array(col1, col2)) VAL1, ABS(col3) VAL2 FROM TEST;\n-```\n-\n-With this query:\n-\n-```sql\n-CREATE STREAM OUTPUT AS SELECT cube_explode(array[col1, col2]) VAL1, ABS(col3) VAL2 FROM TEST;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "037563b07a2e0911f27b184f5f62f20453fbf82e"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4NzAxMTc3OnYy", "diffSide": "RIGHT", "path": "ksqldb-common/src/main/java/io/confluent/ksql/util/DecimalUtil.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxMjo1Mjo0NFrOHz9VzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxMjo1Mjo0NFrOHz9VzA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI0NDQyOA==", "bodyText": "Bug fix: fixes issues where value has a negative scale.", "url": "https://github.com/confluentinc/ksql/pull/6617#discussion_r524244428", "createdAt": "2020-11-16T12:52:44Z", "author": {"login": "big-andy-coates"}, "path": "ksqldb-common/src/main/java/io/confluent/ksql/util/DecimalUtil.java", "diffHunk": "@@ -268,15 +268,18 @@ private static void ensureMax(final BigDecimal value, final int precision, final\n   }\n \n   public static SqlType fromValue(final BigDecimal value) {\n-    final BigDecimal bigDecimalZero = BigDecimal.ZERO;\n+    // SqlDecimal does not support negative scale:\n+    final BigDecimal decimal = value.scale() < 0\n+        ? value.setScale(0, BigDecimal.ROUND_UNNECESSARY)\n+        : value;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "037563b07a2e0911f27b184f5f62f20453fbf82e"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4ODExNTUxOnYy", "diffSide": "RIGHT", "path": "ksqldb-functional-tests/src/test/resources/query-validation-tests/create_array.json", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNjo1MDo0MFrOH0H1NQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNTo0ODowM1rOH071dw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQxNjMwOQ==", "bodyText": "nit: let's add a postcondition to ensure the type of the array at the end (same goes for the other tests)", "url": "https://github.com/confluentinc/ksql/pull/6617#discussion_r524416309", "createdAt": "2020-11-16T16:50:40Z", "author": {"login": "agavra"}, "path": "ksqldb-functional-tests/src/test/resources/query-validation-tests/create_array.json", "diffHunk": "@@ -54,14 +54,27 @@\n       }\n     },\n     {\n-      \"name\": \"construct a list from mismatching elements\",\n+      \"name\": \"construct a list from compatible mismatching elements\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "037563b07a2e0911f27b184f5f62f20453fbf82e"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI2ODM0Mw==", "bodyText": "The historical plan will capture this, but I'll add anyway", "url": "https://github.com/confluentinc/ksql/pull/6617#discussion_r525268343", "createdAt": "2020-11-17T15:48:03Z", "author": {"login": "big-andy-coates"}, "path": "ksqldb-functional-tests/src/test/resources/query-validation-tests/create_array.json", "diffHunk": "@@ -54,14 +54,27 @@\n       }\n     },\n     {\n-      \"name\": \"construct a list from mismatching elements\",\n+      \"name\": \"construct a list from compatible mismatching elements\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQxNjMwOQ=="}, "originalCommit": {"oid": "037563b07a2e0911f27b184f5f62f20453fbf82e"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4ODE0ODM2OnYy", "diffSide": "RIGHT", "path": "ksqldb-execution/src/main/java/io/confluent/ksql/execution/util/CoercionUtil.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNjo1NzoxN1rOH0IJEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNjo1NzoxN1rOH0IJEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQyMTM5Mg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * <p>Coercion is performed in order. So the type type of the first non-null expression drives the\n          \n          \n            \n               * <p>Coercion is performed in order. So the type of the first non-null expression drives the", "url": "https://github.com/confluentinc/ksql/pull/6617#discussion_r524421392", "createdAt": "2020-11-16T16:57:17Z", "author": {"login": "agavra"}, "path": "ksqldb-execution/src/main/java/io/confluent/ksql/execution/util/CoercionUtil.java", "diffHunk": "@@ -91,32 +91,65 @@ private CoercionUtil() {\n    *\n    * <p>Any non-literal expressions that don't match the common type, but which can be coerced, will\n    * be wrapped in an explicit {@code CAST} to convert them to the required type.\n+   *\n+   * <p>Coercion is performed in order. So the type type of the first non-null expression drives the", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc5b157c9a34e8454bc225f7045048714e62861c"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4ODE1NTQwOnYy", "diffSide": "RIGHT", "path": "ksqldb-execution/src/main/java/io/confluent/ksql/execution/util/CoercionUtil.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNjo1ODo0N1rOH0INbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNTo0NzoyNVrOH07zkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQyMjUwOA==", "bodyText": "is there a way to specify a DOUBLE with a string, or do they always get cast to decimals?", "url": "https://github.com/confluentinc/ksql/pull/6617#discussion_r524422508", "createdAt": "2020-11-16T16:58:47Z", "author": {"login": "agavra"}, "path": "ksqldb-execution/src/main/java/io/confluent/ksql/execution/util/CoercionUtil.java", "diffHunk": "@@ -307,14 +340,50 @@ private static void validateStringCanBeCoercedToBoolean(final String value) {\n         final String value, \n         final SqlType targetType\n     ) {\n+      Preconditions.checkArgument(targetType.baseType().isNumber());\n+\n       try {\n-        final BigDecimal result = new BigDecimal(value.trim());\n-        return Optional.of(resolveCommonNumericType(result, targetType));\n+        final SqlType sourceType = getStringNumericType(value);\n+\n+        if (sourceType.baseType() == SqlBaseType.DOUBLE\n+            || targetType.baseType() == SqlBaseType.DOUBLE\n+        ) {\n+          return Optional.of(SqlTypes.DOUBLE);\n+        }\n+\n+        if (sourceType.baseType() == SqlBaseType.DECIMAL\n+            || targetType.baseType() == SqlBaseType.DECIMAL\n+        ) {\n+          return Optional.of(DecimalUtil.widen(sourceType, targetType));\n+        }\n+\n+        return Optional.of(sourceType.baseType().canImplicitlyCast(targetType.baseType())\n+            ? targetType\n+            : sourceType);\n       } catch (final NumberFormatException e) {\n         throw invalidSyntaxException(value, targetType);\n       }\n     }\n \n+    private static SqlType getStringNumericType(final String value) {\n+      final BigDecimal result = new BigDecimal(value.trim());\n+\n+      final boolean containsDpOrScientific = value.contains(\".\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc5b157c9a34e8454bc225f7045048714e62861c"}, "originalPosition": 106}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI2Nzg1Nw==", "bodyText": "Always get cast to decimal.", "url": "https://github.com/confluentinc/ksql/pull/6617#discussion_r525267857", "createdAt": "2020-11-17T15:47:25Z", "author": {"login": "big-andy-coates"}, "path": "ksqldb-execution/src/main/java/io/confluent/ksql/execution/util/CoercionUtil.java", "diffHunk": "@@ -307,14 +340,50 @@ private static void validateStringCanBeCoercedToBoolean(final String value) {\n         final String value, \n         final SqlType targetType\n     ) {\n+      Preconditions.checkArgument(targetType.baseType().isNumber());\n+\n       try {\n-        final BigDecimal result = new BigDecimal(value.trim());\n-        return Optional.of(resolveCommonNumericType(result, targetType));\n+        final SqlType sourceType = getStringNumericType(value);\n+\n+        if (sourceType.baseType() == SqlBaseType.DOUBLE\n+            || targetType.baseType() == SqlBaseType.DOUBLE\n+        ) {\n+          return Optional.of(SqlTypes.DOUBLE);\n+        }\n+\n+        if (sourceType.baseType() == SqlBaseType.DECIMAL\n+            || targetType.baseType() == SqlBaseType.DECIMAL\n+        ) {\n+          return Optional.of(DecimalUtil.widen(sourceType, targetType));\n+        }\n+\n+        return Optional.of(sourceType.baseType().canImplicitlyCast(targetType.baseType())\n+            ? targetType\n+            : sourceType);\n       } catch (final NumberFormatException e) {\n         throw invalidSyntaxException(value, targetType);\n       }\n     }\n \n+    private static SqlType getStringNumericType(final String value) {\n+      final BigDecimal result = new BigDecimal(value.trim());\n+\n+      final boolean containsDpOrScientific = value.contains(\".\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQyMjUwOA=="}, "originalCommit": {"oid": "cc5b157c9a34e8454bc225f7045048714e62861c"}, "originalPosition": 106}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2415, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}