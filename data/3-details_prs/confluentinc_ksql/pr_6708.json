{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMxMjM3OTk3", "number": 6708, "title": "feat: support table joins on key format mismatch", "bodyText": "Description\nstacked on #6609 - which will not be merged until this PR is approved, don't review first two commits!\nfixes #6229 and also remove the code around \"required formats\". This means that we will always chose the first \"preferred\" format using the algoirthm outlined in #6393 but removing the restriction that tables are not re-partitioned.\nTesting done\nQTT testing\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-12-02T19:22:28Z", "url": "https://github.com/confluentinc/ksql/pull/6708", "merged": true, "mergeCommit": {"oid": "989e52b241dc906289ac1607a4049ee1704a346a"}, "closed": true, "closedAt": "2020-12-04T22:28:19Z", "author": {"login": "agavra"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdiUAghgBqjQwNjQxMTA2MjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdi-G_ygBqjQwNzQ0MzAwOTY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "514d31b588b8cf994c45ffe0a0d649db7da765f0", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/514d31b588b8cf994c45ffe0a0d649db7da765f0", "committedDate": "2020-12-02T19:17:39Z", "message": "chore: historical tests"}, "afterCommit": {"oid": "720caeea709281faa22b97fc902facbc81bad41a", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/720caeea709281faa22b97fc902facbc81bad41a", "committedDate": "2020-12-02T19:49:08Z", "message": "test: some more tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0MjUxMTQ5", "url": "https://github.com/confluentinc/ksql/pull/6708#pullrequestreview-544251149", "createdAt": "2020-12-03T18:21:35Z", "commit": {"oid": "720caeea709281faa22b97fc902facbc81bad41a"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxODoyMTozNlrOH-qzpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMDozOTozOFrOH-xdqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ3NTEwOQ==", "bodyText": "The PR description says\n\nThis still doesn't fully address what #6017 (klip-33) outlines because it prefers the left instead of the right source to maintain some compatibility with previous code. It would be backwards compatible to change this as this is done at logical plan and not the physical plan.\n\nbut this javadoc seems to describe exactly what's in KLIP 33. From the changes in this PR, it looks like the PR description is out of date and needs to be updated?", "url": "https://github.com/confluentinc/ksql/pull/6708#discussion_r535475109", "createdAt": "2020-12-03T18:21:36Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/planner/plan/JoinNode.java", "diffHunk": "@@ -112,48 +112,18 @@ public JoinNode(\n   /**\n    * Determines the key format of the join.\n    *\n-   * <p>Avoids repartitioning tables for now. Instead choosing to repartition the stream side.\n-   * This is different to what is proposed in KLIP-33. Issue #6229 will look to implement\n-   * repartitioning tables.\n-   *\n-   * <p>For now, the left key format is the preferred join key format unless either:\n-   * <ul>\n-   *   <li>The right source is not already being repartitioned and the left source is.</li>\n-   *   <li>The right source is a table.</li>\n-   * </ul>\n-   * In which case, the right key format it used.\n-   *\n-   * <p>An exception is currently thrown if both sides are tables and their key formats differ.\n+   * <p>For now, the left key format is the preferred join key format unless the\n+   * right source is not already being repartitioned and the left source is.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "720caeea709281faa22b97fc902facbc81bad41a"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ3ODYwMA==", "bodyText": "This change is backwards incompatible, right? As in, existing queries will continue running as before but if the same join statements were to be re-issued, a different topology would result. I think we should call this out in the PR description so it appears in the changelog.", "url": "https://github.com/confluentinc/ksql/pull/6708#discussion_r535478600", "createdAt": "2020-12-03T18:26:10Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-functional-tests/src/test/resources/query-validation-tests/joins.json", "diffHunk": "@@ -2250,14 +2250,20 @@\n         \"topics\" : {\n           \"topics\" : [\n             {\n-              \"name\" : \"_confluent-ksql-some.ksql.service.idquery_CSAS_OUTPUT_0-Join-repartition\",\n-              \"keyFormat\" : {\"format\" : \"KAFKA\"},\n-              \"valueFormat\" : {\"format\" : \"JSON\"}\n+              \"name\": \"_confluent-ksql-some.ksql.service.idquery_CSAS_OUTPUT_0-RightSourceKeyed-SelectKey-repartition\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "720caeea709281faa22b97fc902facbc81bad41a"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU4MjYwMA==", "bodyText": "This topic should also go away with #6650 -- it makes sense that all internal topics should be Avro formatted in this case.", "url": "https://github.com/confluentinc/ksql/pull/6708#discussion_r535582600", "createdAt": "2020-12-03T20:38:16Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-functional-tests/src/test/resources/query-validation-tests/multi-joins.json", "diffHunk": "@@ -1227,41 +1238,41 @@\n       ],\n       \"post\": {\n         \"topics\": {\n-          \"topics\" : [\n+          \"topics\": [\n             {\n-              \"name\" : \"_confluent-ksql-some.ksql.service.idquery_CSAS_OUTPUT_0-L_Join-left-repartition\",\n-              \"keyFormat\" : {\"format\" : \"JSON_SR\", \"features\": [\"UNWRAP_SINGLES\"]},\n-              \"valueFormat\" : {\"format\" : \"JSON\"}\n+              \"name\": \"_confluent-ksql-some.ksql.service.idquery_CSAS_OUTPUT_0-KafkaTopic_Right-Reduce-changelog\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "720caeea709281faa22b97fc902facbc81bad41a"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU4NDE2OA==", "bodyText": "nit: can we order these topics in a more readable fashion? Previously it was repartition topics first, then changelogs, ordered from left to right.", "url": "https://github.com/confluentinc/ksql/pull/6708#discussion_r535584168", "createdAt": "2020-12-03T20:39:38Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-functional-tests/src/test/resources/query-validation-tests/multi-joins.json", "diffHunk": "@@ -1227,41 +1238,41 @@\n       ],\n       \"post\": {\n         \"topics\": {\n-          \"topics\" : [\n+          \"topics\": [", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "720caeea709281faa22b97fc902facbc81bad41a"}, "originalPosition": 52}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c3edbd030581d197a6ab6598404d3f4334195cb", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/2c3edbd030581d197a6ab6598404d3f4334195cb", "committedDate": "2020-12-04T16:56:43Z", "message": "chore: set key schema name to avoid conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd17e9870be6da4a221a960bc1e5cffe8397783a", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/bd17e9870be6da4a221a960bc1e5cffe8397783a", "committedDate": "2020-12-04T16:57:25Z", "message": "temp commit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92b8f46cff5adf998aa578f11ac4fa19a611acb7", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/92b8f46cff5adf998aa578f11ac4fa19a611acb7", "committedDate": "2020-12-04T16:59:37Z", "message": "feat: support table joins on key format mismatch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5e61037c8b0b4561fb27a7de5cf9daf79d7b431", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/b5e61037c8b0b4561fb27a7de5cf9daf79d7b431", "committedDate": "2020-12-04T16:59:42Z", "message": "chore: historical tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "53eb7c96d9b23634b332c156bfcef990a6396d65", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/53eb7c96d9b23634b332c156bfcef990a6396d65", "committedDate": "2020-12-04T16:59:42Z", "message": "test: some more tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f7a963e0743946963be38a95180f853d2b89c28", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/4f7a963e0743946963be38a95180f853d2b89c28", "committedDate": "2020-12-04T18:25:45Z", "message": "chore: rebase"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "720caeea709281faa22b97fc902facbc81bad41a", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/720caeea709281faa22b97fc902facbc81bad41a", "committedDate": "2020-12-02T19:49:08Z", "message": "test: some more tests"}, "afterCommit": {"oid": "4f7a963e0743946963be38a95180f853d2b89c28", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/4f7a963e0743946963be38a95180f853d2b89c28", "committedDate": "2020-12-04T18:25:45Z", "message": "chore: rebase"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "856cebe0f43295bd5366969f7831cb780d4ceeb2", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/856cebe0f43295bd5366969f7831cb780d4ceeb2", "committedDate": "2020-12-04T20:01:07Z", "message": "chore: historical tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "942bc66d124dfbdbb3f2c896077d15fcaa0f24b8", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/942bc66d124dfbdbb3f2c896077d15fcaa0f24b8", "committedDate": "2020-12-04T20:52:17Z", "message": "test: improve CLI test pull query"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e2e1f070e37cf97373ef394d8ece6171a5f4d700", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/e2e1f070e37cf97373ef394d8ece6171a5f4d700", "committedDate": "2020-12-04T20:03:40Z", "message": "test: improve CLI test pull query"}, "afterCommit": {"oid": "942bc66d124dfbdbb3f2c896077d15fcaa0f24b8", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/942bc66d124dfbdbb3f2c896077d15fcaa0f24b8", "committedDate": "2020-12-04T20:52:17Z", "message": "test: improve CLI test pull query"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4564, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}