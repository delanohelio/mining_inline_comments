{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE4NzI5NjI0", "number": 5374, "title": "feat: expose JMX metric that classifies an error state", "bodyText": "Description\nThis PR introduces JMX metrics that drill query errors down into more specific categories: UNKNOWN, USER and SYSTEM (open to better names) when an uncaught error is raised from KafkaStreams.\nReview Guide\nThere's a lot in this PR, I can split it up if it helps the review but it's not that many lines of code so I figured it's digestible with a little guide:\n\nQueryError a throwable paired with a classification of that error (see above)\nErrorStateListener extends StateListener to add an additional method that reacts to QueryError when its raised\nQueryErrorClassifier classifies exceptions; it also supports chaining so we can easily introduce other ones\nMissingTopicClassifier will check if any required topics are missing, and if so classifies the error as USER\nI moved registering the uncaught exceptions into the QueryMetadata where I have more information than in the KafkaStreamsBuilder\nThe rest is wiring\n\nTesting done\nCaused a failure by deleting a necessary topic (foo) and then deleting the kafka streams local dir to trigger a faster error. In the logs:\n[2020-05-15 10:47:35,201] ERROR Unhandled exception caught in streams thread _confluent-ksql-def\nault_query_CTAS_COUNTS_0-8d6e554e-a19b-4c68-abe7-eca385fc9630-StreamThread-3. (io.confluent.ksql\n.engine.KsqlEngine:43)\norg.apache.kafka.streams.errors.ProcessorStateException: task directory [/tmp/kafka-streams/_con\nfluent-ksql-default_query_CTAS_COUNTS_0/0_0] doesn't exist and couldn't be created\n...\n[2020-05-15 10:47:35,880] WARN Query _confluent-ksql-default_query_CTAS_COUNTS_0 requires topic Aggregate-GroupBy-repartition which cannot be found. (io.confluent.ksql.query.MissingTopicClassifier:54)\n\nI used jconsole to make sure that the JMX MBean metrics were properly set. Here's a picture of it below:\n\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-05-15T18:05:00Z", "url": "https://github.com/confluentinc/ksql/pull/5374", "merged": true, "mergeCommit": {"oid": "52271bf6ccbfdb26e83e5c30c2e11db0c72e8efc"}, "closed": true, "closedAt": "2020-05-18T22:17:33Z", "author": {"login": "agavra"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABchpIfhABqjMzNDI3MTE1OTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcilo1mAH2gAyNDE4NzI5NjI0OjQ1YmMyNjgzOWRjNTZiNTc5ZmJjYmU4MDE3ZDljNjM2YTU1YWFiMWM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "007dd53141be0c5cda52ca358c46eb2c29662dd5", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/007dd53141be0c5cda52ca358c46eb2c29662dd5", "committedDate": "2020-05-15T17:49:15Z", "message": "feat: expose QueryError with more detailed information"}, "afterCommit": {"oid": "e49463697330a757784193ebc871aa10e080e1ba", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/e49463697330a757784193ebc871aa10e080e1ba", "committedDate": "2020-05-15T21:31:07Z", "message": "feat: expose QueryError with more detailed information"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e49463697330a757784193ebc871aa10e080e1ba", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/e49463697330a757784193ebc871aa10e080e1ba", "committedDate": "2020-05-15T21:31:07Z", "message": "feat: expose QueryError with more detailed information"}, "afterCommit": {"oid": "f5b48daee8bc26f4d67a81968870b65819f8aa37", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/f5b48daee8bc26f4d67a81968870b65819f8aa37", "committedDate": "2020-05-18T16:42:58Z", "message": "feat: expose QueryError with more detailed information"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3cfff4b631356caeb279b88567c8aab71a93d332", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/3cfff4b631356caeb279b88567c8aab71a93d332", "committedDate": "2020-05-18T18:31:24Z", "message": "feat: expose QueryError with more detailed information"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f5b48daee8bc26f4d67a81968870b65819f8aa37", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/f5b48daee8bc26f4d67a81968870b65819f8aa37", "committedDate": "2020-05-18T16:42:58Z", "message": "feat: expose QueryError with more detailed information"}, "afterCommit": {"oid": "3cfff4b631356caeb279b88567c8aab71a93d332", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/3cfff4b631356caeb279b88567c8aab71a93d332", "committedDate": "2020-05-18T18:31:24Z", "message": "feat: expose QueryError with more detailed information"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzODY1Njc4", "url": "https://github.com/confluentinc/ksql/pull/5374#pullrequestreview-413865678", "createdAt": "2020-05-18T19:08:18Z", "commit": {"oid": "3cfff4b631356caeb279b88567c8aab71a93d332"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxOTowODoxOFrOGXEEqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxOTozNTowOVrOGXE4Pg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgzNzE2Mw==", "bodyText": "meant to omit this?", "url": "https://github.com/confluentinc/ksql/pull/5374#discussion_r426837163", "createdAt": "2020-05-18T19:08:18Z", "author": {"login": "rodesai"}, "path": "config/ksql-server.properties", "diffHunk": "@@ -56,7 +56,7 @@ ksql.logging.processing.stream.auto.create=true\n #------ External service config -------\n \n # The set of Kafka brokers to bootstrap Kafka cluster information from:\n-bootstrap.servers=localhost:9092\n+bootstrap.servers=localhost:29092", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3cfff4b631356caeb279b88567c8aab71a93d332"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg1MDM2Ng==", "bodyText": "this is currently not used right?", "url": "https://github.com/confluentinc/ksql/pull/5374#discussion_r426850366", "createdAt": "2020-05-18T19:35:09Z", "author": {"login": "rodesai"}, "path": "ksqldb-common/src/main/java/io/confluent/ksql/query/QueryErrorClassifier.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"; you may not use\n+ * this file except in compliance with the License. You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.query;\n+\n+import io.confluent.ksql.query.QueryError.Type;\n+\n+public interface QueryErrorClassifier {\n+\n+  QueryErrorClassifier DEFAULT_CLASSIFIER = e -> Type.UNKNOWN;\n+\n+  /**\n+   * Classifies this error with a specific type\n+   *\n+   * @param e the error\n+   * @return the classification\n+   */\n+  Type classify(Throwable e);\n+\n+  /**\n+   * Chains two classifiers so that:\n+   * <ol>\n+   *   <li>If they classify the error in the same way, return that classification</li>\n+   *   <li>If they classify the error differently and exactly one is classified as\n+   *       {@link Type#UNKNOWN}, return the other classification.</li>\n+   *   <li>If they classify the error differently and neither is classified as\n+   *       {@link Type#UNKNOWN}, return {@link Type#UNKNOWN}</li>\n+   * </ol>\n+   *\n+   * @param other the other classifier to chain\n+   * @return a {@code QueryErrorClassifier} that chains both\n+   */\n+  default QueryErrorClassifier and(QueryErrorClassifier other) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3cfff4b631356caeb279b88567c8aab71a93d332"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45bc26839dc56b579fbcbe8017d9c636a55aab1c", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/45bc26839dc56b579fbcbe8017d9c636a55aab1c", "committedDate": "2020-05-18T20:10:36Z", "message": "chore: fix properties file"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4770, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}