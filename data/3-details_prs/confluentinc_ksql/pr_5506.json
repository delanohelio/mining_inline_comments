{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI0Nzc0NDkx", "number": 5506, "title": "fix: allow dynamic construction of an ARRAY of STRUCTS with duplicate values #5436", "bodyText": "Description\nWhat behavior do you want to change, why, how does your patch achieve the changes?\nError was occuring when user wants to create an array of structs with duplicate values. This patch fixes this by using a mutable hash map and then making an immutable hash map copy from that, since the immutable hash map builder did not check for duplicates but will fail once we try to build it.\nTesting done\nDescribe the testing strategy. Unit and integration tests are expected for any behavior changes.\nA new unit test was created in the create-struct.json that checks for this specific test case of duplicate values.\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-05-28T22:43:29Z", "url": "https://github.com/confluentinc/ksql/pull/5506", "merged": true, "mergeCommit": {"oid": "0b1162cc94bef391531bdc33b726aede4b3aab04"}, "closed": true, "closedAt": "2020-05-29T18:37:29Z", "author": {"login": "nae701"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcl1KWMgH2gAyNDI0Nzc0NDkxOjgxYjIxNTI5Yzg3MzJiZGQzNWQ3YTYxNjQxN2YyYzUxODg0OTY3OWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcmFm_VgFqTQyMTEzNTcwNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "81b21529c8732bdd35d7a616417f2c518849679c", "author": {"user": null}, "url": "https://github.com/confluentinc/ksql/commit/81b21529c8732bdd35d7a616417f2c518849679c", "committedDate": "2020-05-28T21:57:33Z", "message": "fixed issue 5436"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44d2ceba76b56175eda61ff80c751694fc713e68", "author": {"user": null}, "url": "https://github.com/confluentinc/ksql/commit/44d2ceba76b56175eda61ff80c751694fc713e68", "committedDate": "2020-05-28T22:10:59Z", "message": "Merge branch 'master' of github.com:confluentinc/ksql"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwNTQzODcx", "url": "https://github.com/confluentinc/ksql/pull/5506#pullrequestreview-420543871", "createdAt": "2020-05-28T22:48:11Z", "commit": {"oid": "44d2ceba76b56175eda61ff80c751694fc713e68"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQyMjo0ODoxMVrOGcJSiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQyMjo1NDoxOVrOGcJaxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE2NTUxNQ==", "bodyText": "nit: probably don't want to be committing this!", "url": "https://github.com/confluentinc/ksql/pull/5506#discussion_r432165515", "createdAt": "2020-05-28T22:48:11Z", "author": {"login": "agavra"}, "path": "config/ksql-server.properties", "diffHunk": "@@ -56,7 +56,7 @@ ksql.logging.processing.stream.auto.create=true\n #------ External service config -------\n \n # The set of Kafka brokers to bootstrap Kafka cluster information from:\n-bootstrap.servers=localhost:9092\n+bootstrap.servers=localhost:29092", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44d2ceba76b56175eda61ff80c751694fc713e68"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE2NTkwMA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private final HashMap<CreateStructExpression, String> structToSchemaName =\n          \n          \n            \n                private final Map<CreateStructExpression, String> structToSchemaName =\n          \n      \n    \n    \n  \n\nnit: generally good practice to use the interface instead of the implementation when declaring variables. That way you don't leak any implementation details and have the freedom to change it down the line. In this case it doesn't matter so much, but a good practice to follow.", "url": "https://github.com/confluentinc/ksql/pull/5506#discussion_r432165900", "createdAt": "2020-05-28T22:49:24Z", "author": {"login": "agavra"}, "path": "ksqldb-execution/src/main/java/io/confluent/ksql/execution/codegen/CodeGenSpec.java", "diffHunk": "@@ -101,9 +101,8 @@ public String getStructSchemaName(final CreateStructExpression createStructExpre\n     private final Map<ColumnName, String> columnRefToName = new HashMap<>();\n     private final ImmutableListMultimap.Builder<FunctionName, String> functionNameBuilder =\n         ImmutableListMultimap.builder();\n-    private final ImmutableMap.Builder<CreateStructExpression, String> structToSchemaName =\n-        ImmutableMap.builder();\n-\n+    private final HashMap<CreateStructExpression, String> structToSchemaName =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44d2ceba76b56175eda61ff80c751694fc713e68"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE2NzEzMg==", "bodyText": "I think we should flip the semantics of the if statement here and instead return early if the structToSchemaName already contains the entry - that way we wont be incrementing structSchemaCount or adding the unnecessary argument to the argumentBuilder.", "url": "https://github.com/confluentinc/ksql/pull/5506#discussion_r432167132", "createdAt": "2020-05-28T22:52:54Z", "author": {"login": "agavra"}, "path": "ksqldb-execution/src/main/java/io/confluent/ksql/execution/codegen/CodeGenSpec.java", "diffHunk": "@@ -125,7 +124,9 @@ void addFunction(final FunctionName functionName, final Kudf function) {\n \n     void addStructSchema(final CreateStructExpression struct, final Schema schema) {\n       final String structSchemaName = CodeGenUtil.schemaName(structSchemaCount++);\n-      structToSchemaName.put(struct, structSchemaName);\n+      if (!structToSchemaName.containsKey(struct)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44d2ceba76b56175eda61ff80c751694fc713e68"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE2NzYyMA==", "bodyText": "I forgot to tell you offline, but whenever you add a new test to the QTT (QueryTranslationTest) suite you need to run PlannedTestGeneratorTest manually (and remove the @Ignore annotation) to generate historical plans. These historical plans don't change across versions so we make sure that future versions running the old code will not deviate in behavior.", "url": "https://github.com/confluentinc/ksql/pull/5506#discussion_r432167620", "createdAt": "2020-05-28T22:54:19Z", "author": {"login": "agavra"}, "path": "ksqldb-functional-tests/src/test/resources/query-validation-tests/create-struct.json", "diffHunk": "@@ -86,6 +86,19 @@\n         \"message\": \"Duplicate field names found in STRUCT\"\n       }\n     },\n+    {\n+      \"name\": \"duplicate structs in array\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44d2ceba76b56175eda61ff80c751694fc713e68"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb74ffd1f1ba2b3afc48da629fda3fb1fc9cd2bd", "author": {"user": null}, "url": "https://github.com/confluentinc/ksql/commit/bb74ffd1f1ba2b3afc48da629fda3fb1fc9cd2bd", "committedDate": "2020-05-28T23:58:59Z", "message": "fix issue 5436 v2"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxMTA1ODE2", "url": "https://github.com/confluentinc/ksql/pull/5506#pullrequestreview-421105816", "createdAt": "2020-05-29T16:27:50Z", "commit": {"oid": "bb74ffd1f1ba2b3afc48da629fda3fb1fc9cd2bd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxNjoyNzo1MFrOGcjvpA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxNjoyNzo1MFrOGcjvpA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjU5ODk0OA==", "bodyText": "let's move the if branch one line up (to make sure that we don't unnecessarily increment structSchemaCount)", "url": "https://github.com/confluentinc/ksql/pull/5506#discussion_r432598948", "createdAt": "2020-05-29T16:27:50Z", "author": {"login": "agavra"}, "path": "ksqldb-execution/src/main/java/io/confluent/ksql/execution/codegen/CodeGenSpec.java", "diffHunk": "@@ -125,6 +124,9 @@ void addFunction(final FunctionName functionName, final Kudf function) {\n \n     void addStructSchema(final CreateStructExpression struct, final Schema schema) {\n       final String structSchemaName = CodeGenUtil.schemaName(structSchemaCount++);\n+      if (structToSchemaName.containsKey(struct)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb74ffd1f1ba2b3afc48da629fda3fb1fc9cd2bd"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f887e2552fcf0f02f067c080ae5b05f275a913a", "author": {"user": null}, "url": "https://github.com/confluentinc/ksql/commit/0f887e2552fcf0f02f067c080ae5b05f275a913a", "committedDate": "2020-05-29T16:56:39Z", "message": "historical plans added"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "16747bd2cd9c2dd0df8f3c930de897d93efd2694", "author": {"user": null}, "url": "https://github.com/confluentinc/ksql/commit/16747bd2cd9c2dd0df8f3c930de897d93efd2694", "committedDate": "2020-05-29T17:03:41Z", "message": "added ignore back to PlannedTestGenerator"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxMTM1NzA2", "url": "https://github.com/confluentinc/ksql/pull/5506#pullrequestreview-421135706", "createdAt": "2020-05-29T17:07:19Z", "commit": {"oid": "16747bd2cd9c2dd0df8f3c930de897d93efd2694"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4690, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}