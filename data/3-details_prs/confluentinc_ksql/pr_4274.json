{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYxNjQwNDgw", "number": 4274, "title": "fix: Include functional tests jar in docker images", "bodyText": "Description\nFixes #3989\nWe need to include the functional tests jar in the docker image. Instead of creating two new modules that will build the two images for server and cli respectively, we decided to build a single image for both server and cli that will be called ksqldb.\nThis PR adds a new module that is used only for building the ksqldb docker image. (The actual name of the image (ksqldb) will be assigned by the jenkins tool.)\nTesting done\nTried the docker image and am able to run server, cli and testing tool.\n\nBuild local image:\n\nmvn -Pdocker package -DskipTests -Dspotbugs.skip -Dcheckstyle.skip  -Ddockerfile.skip=false -Dskip.docker.build=false -Ddocker.upstream-tag=master-latest -Ddocker.tag=local.build -Ddocker.upstream-registry='368821881613.dkr.ecr.us-west-2.amazonaws.com/' -pl :ksql-docker -am -T 4\n\n\nTry server\n\ndocker exec -it ksqldb-server bash\n> ksql\n\n\nTry cli\n\ndocker exec -it ksqldb-server ksql http://ksqldb-server:8088\n\n\nSteps for testing tool (followed with modifications from here: https://docs.confluent.io/current/ksql/docs/developer-guide/ksql-testing-tool.html)\n\na. Open terminal into container:\ndocker exec -it ksqldb-server bash\n\nb. Create files input.json, output.json, statement.json and copy into container\ndocker cp input.json ksqldb-server:.\n\nc. Copy test jars into `/usr/share/java/ksql-rest-app/\nwget https://repo1.maven.org/maven2/junit/junit/4.12/junit-4.12.jar\nwget https://repo1.maven.org/maven2/org/hamcrest/hamcrest-all/1.3/hamcrest-all-1.3.jar\n\nd. Run testing tool:\nksql-test-runner -s statements.sql -i input.json -o output.json\n\ne. Output is:\n\t>>>>> Test failed: Invalid key value for topic test_topic.\nExpected KeyType: STRING\nActual KeyType: INTEGER, key: 0.\n\nTried same steps with image created from jenkins script.\nTried quickstart (https://ksqldb.io/quickstart.html), currently fails due to : #4400 .\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\nDocs for using the testing tool with docker image need to get created/updated!\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-01-10T22:04:10Z", "url": "https://github.com/confluentinc/ksql/pull/4274", "merged": true, "mergeCommit": {"oid": "2559b2fdddda664fc354627835fe269c063dd54b"}, "closed": true, "closedAt": "2020-01-29T20:00:55Z", "author": {"login": "vpapavas"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb5IZGSAFqTM0MTQ4OTYxMQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb_Kx43AH2gAyMzYxNjQwNDgwOjIwOTFiNWI5ZjdlNWI3ZjBkMDQ3ZmRkYThlNGVlMzUyOWNhZTAyMjY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxNDg5NjEx", "url": "https://github.com/confluentinc/ksql/pull/4274#pullrequestreview-341489611", "createdAt": "2020-01-11T00:52:59Z", "commit": {"oid": "963e70cf9d4f05f4466662f70c785619d47dd6f4"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMVQwMDo1Mjo1OVrOFcjXrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMVQwMDo1NDozOFrOFcjYmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ4Mzk1MQ==", "bodyText": "What's this dockerfile? Can we keep the old one with all the instructions on how to build and run it locally? Also this one uses the local image, which probably shouldn't be checked in.", "url": "https://github.com/confluentinc/ksql/pull/4274#discussion_r365483951", "createdAt": "2020-01-11T00:52:59Z", "author": {"login": "agavra"}, "path": "ksql-docker/docker-compose.yml", "diffHunk": "@@ -0,0 +1,51 @@\n+version: '2'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "963e70cf9d4f05f4466662f70c785619d47dd6f4"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ4NDAxMw==", "bodyText": "do we need to specify the version here?", "url": "https://github.com/confluentinc/ksql/pull/4274#discussion_r365484013", "createdAt": "2020-01-11T00:53:23Z", "author": {"login": "agavra"}, "path": "ksql-docker/pom.xml", "diffHunk": "@@ -0,0 +1,96 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<!--\n+  ~ Copyright 2018 Confluent Inc.\n+  ~\n+  ~ Licensed under the Confluent Community License (the \"License\"); you may not use\n+  ~ this file except in compliance with the License.  You may obtain a copy of the\n+  ~ License at\n+  ~\n+  ~ http://www.confluent.io/confluent-community-license\n+  ~\n+  ~ Unless required by applicable law or agreed to in writing, software\n+  ~ distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+  ~ WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+  ~ specific language governing permissions and limitations under the License.\n+  -->\n+\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n+  xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+  xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+  <modelVersion>4.0.0</modelVersion>\n+\n+  <parent>\n+    <artifactId>ksql-parent</artifactId>\n+    <groupId>io.confluent.ksql</groupId>\n+    <version>5.5.0-SNAPSHOT</version>\n+  </parent>\n+\n+  <artifactId>ksql-docker</artifactId>\n+\n+  <properties>\n+    <air.main.basedir>${project.parent.basedir}</air.main.basedir>\n+    <main-class>io.confluent.ksql.rest.server.KsqlRestApplication</main-class>\n+    <cli.skip-execute>false</cli.skip-execute>\n+    <cli.main-class>${main-class}</cli.main-class>\n+    <docker.skip-build>${skip.docker.build}</docker.skip-build>\n+    <docker.skip-test>${skip.docker.test}</docker.skip-test>\n+  </properties>\n+\n+  <dependencies>\n+    <dependency>\n+      <groupId>io.confluent.ksql</groupId>\n+      <artifactId>ksql-rest-app</artifactId>\n+    </dependency>\n+\n+    <dependency>\n+      <groupId>io.confluent.ksql</groupId>\n+      <artifactId>ksql-cli</artifactId>\n+    </dependency>\n+\n+    <dependency>\n+      <groupId>io.confluent.ksql</groupId>\n+      <artifactId>ksql-functional-tests</artifactId>\n+      <version>${project.version}</version>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "963e70cf9d4f05f4466662f70c785619d47dd6f4"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ4NDE4NQ==", "bodyText": "\ud83e\udd14 is this true for both the CLI and the Rest App? Can you test that the image works with our existing docker tutorials, and if not then see what we need to change? I think you asked this question, but is this main-class necessary (can we remove it)?", "url": "https://github.com/confluentinc/ksql/pull/4274#discussion_r365484185", "createdAt": "2020-01-11T00:54:38Z", "author": {"login": "agavra"}, "path": "ksql-docker/pom.xml", "diffHunk": "@@ -0,0 +1,96 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<!--\n+  ~ Copyright 2018 Confluent Inc.\n+  ~\n+  ~ Licensed under the Confluent Community License (the \"License\"); you may not use\n+  ~ this file except in compliance with the License.  You may obtain a copy of the\n+  ~ License at\n+  ~\n+  ~ http://www.confluent.io/confluent-community-license\n+  ~\n+  ~ Unless required by applicable law or agreed to in writing, software\n+  ~ distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+  ~ WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+  ~ specific language governing permissions and limitations under the License.\n+  -->\n+\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n+  xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+  xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+  <modelVersion>4.0.0</modelVersion>\n+\n+  <parent>\n+    <artifactId>ksql-parent</artifactId>\n+    <groupId>io.confluent.ksql</groupId>\n+    <version>5.5.0-SNAPSHOT</version>\n+  </parent>\n+\n+  <artifactId>ksql-docker</artifactId>\n+\n+  <properties>\n+    <air.main.basedir>${project.parent.basedir}</air.main.basedir>\n+    <main-class>io.confluent.ksql.rest.server.KsqlRestApplication</main-class>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "963e70cf9d4f05f4466662f70c785619d47dd6f4"}, "originalPosition": 32}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "963e70cf9d4f05f4466662f70c785619d47dd6f4", "author": {"user": {"login": "vpapavas", "name": "Vicky Papavasileiou"}}, "url": "https://github.com/confluentinc/ksql/commit/963e70cf9d4f05f4466662f70c785619d47dd6f4", "committedDate": "2020-01-10T21:46:44Z", "message": "rename module"}, "afterCommit": {"oid": "9ef345e1ce1451e93ee798221ea63f51c23b45df", "author": {"user": {"login": "vpapavas", "name": "Vicky Papavasileiou"}}, "url": "https://github.com/confluentinc/ksql/commit/9ef345e1ce1451e93ee798221ea63f51c23b45df", "committedDate": "2020-01-14T00:12:41Z", "message": "merged #4260"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyMjM0NzUz", "url": "https://github.com/confluentinc/ksql/pull/4274#pullrequestreview-342234753", "createdAt": "2020-01-14T00:51:54Z", "commit": {"oid": "c77ad0f5645b451aaa4d0fc4ee6c296b15462d0a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7fab1d89714f8f21a4c5e5b34fab70e04eae89ad", "author": {"user": {"login": "vpapavas", "name": "Vicky Papavasileiou"}}, "url": "https://github.com/confluentinc/ksql/commit/7fab1d89714f8f21a4c5e5b34fab70e04eae89ad", "committedDate": "2020-01-28T21:48:05Z", "message": "build new server image with functional tests jar\n\nremoved not needed files\n\nrename module\n\nremove docker compose file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f230fcd3338d9a48aec99ca07e381b51acced2a5", "author": {"user": {"login": "vpapavas", "name": "Vicky Papavasileiou"}}, "url": "https://github.com/confluentinc/ksql/commit/f230fcd3338d9a48aec99ca07e381b51acced2a5", "committedDate": "2020-01-28T21:48:09Z", "message": "merged #4260"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1cb912bc1b430ed098d13bf9986a76580ab359a6", "author": {"user": {"login": "vpapavas", "name": "Vicky Papavasileiou"}}, "url": "https://github.com/confluentinc/ksql/commit/1cb912bc1b430ed098d13bf9986a76580ab359a6", "committedDate": "2020-01-28T21:48:09Z", "message": "addressed comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c77ad0f5645b451aaa4d0fc4ee6c296b15462d0a", "author": {"user": {"login": "vpapavas", "name": "Vicky Papavasileiou"}}, "url": "https://github.com/confluentinc/ksql/commit/c77ad0f5645b451aaa4d0fc4ee6c296b15462d0a", "committedDate": "2020-01-14T00:46:04Z", "message": "addressed comments"}, "afterCommit": {"oid": "1cb912bc1b430ed098d13bf9986a76580ab359a6", "author": {"user": {"login": "vpapavas", "name": "Vicky Papavasileiou"}}, "url": "https://github.com/confluentinc/ksql/commit/1cb912bc1b430ed098d13bf9986a76580ab359a6", "committedDate": "2020-01-28T21:48:09Z", "message": "addressed comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2091b5b9f7e5b7f0d047fdda8e4ee3529cae0226", "author": {"user": {"login": "vpapavas", "name": "Vicky Papavasileiou"}}, "url": "https://github.com/confluentinc/ksql/commit/2091b5b9f7e5b7f0d047fdda8e4ee3529cae0226", "committedDate": "2020-01-29T19:05:42Z", "message": "added missing dependencies"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 69, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}