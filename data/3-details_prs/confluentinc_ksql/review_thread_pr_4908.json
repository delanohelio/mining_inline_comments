{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk0NDU3OTY2", "number": 4908, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQyMzowMjoyMFrODr3XSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwNjowMToxMVrODr7ycA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3MzIyNDQwOnYy", "diffSide": "RIGHT", "path": "ksqldb-streams/src/main/java/io/confluent/ksql/execution/streams/materialization/ks/KsStateStore.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQyMzowMjoyMFrOF8diVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwMTozMToyOFrOF8gLEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk0MjgwNw==", "bodyText": "could we remove this altogether and let it error inside .store()?", "url": "https://github.com/confluentinc/ksql/pull/4908#discussion_r398942807", "createdAt": "2020-03-26T23:02:20Z", "author": {"login": "vinothchandar"}, "path": "ksqldb-streams/src/main/java/io/confluent/ksql/execution/streams/materialization/ks/KsStateStore.java", "diffHunk": "@@ -69,15 +72,14 @@ LogicalSchema schema() {\n   }\n \n   <T> T store(final QueryableStoreType<T> queryableStoreType) {\n-    awaitRunning();\n-\n     try {\n       if (ksqlConfig.getBoolean(KsqlConfig.KSQL_QUERY_PULL_ENABLE_STANDBY_READS)) {\n         // True flag allows queries on standby and replica state stores\n         return kafkaStreams.store(\n             StoreQueryParameters.fromNameAndType(stateStoreName, queryableStoreType)\n                 .enableStaleStores());\n       } else {\n+        awaitRunning();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c51d15ba7a1d896184a53e3a15e265f5f56489d1"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk4NjAwMA==", "bodyText": "Done", "url": "https://github.com/confluentinc/ksql/pull/4908#discussion_r398986000", "createdAt": "2020-03-27T01:31:28Z", "author": {"login": "vpapavas"}, "path": "ksqldb-streams/src/main/java/io/confluent/ksql/execution/streams/materialization/ks/KsStateStore.java", "diffHunk": "@@ -69,15 +72,14 @@ LogicalSchema schema() {\n   }\n \n   <T> T store(final QueryableStoreType<T> queryableStoreType) {\n-    awaitRunning();\n-\n     try {\n       if (ksqlConfig.getBoolean(KsqlConfig.KSQL_QUERY_PULL_ENABLE_STANDBY_READS)) {\n         // True flag allows queries on standby and replica state stores\n         return kafkaStreams.store(\n             StoreQueryParameters.fromNameAndType(stateStoreName, queryableStoreType)\n                 .enableStaleStores());\n       } else {\n+        awaitRunning();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk0MjgwNw=="}, "originalCommit": {"oid": "c51d15ba7a1d896184a53e3a15e265f5f56489d1"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3MzIyODkyOnYy", "diffSide": "RIGHT", "path": "ksqldb-streams/src/main/java/io/confluent/ksql/execution/streams/materialization/ks/KsStateStore.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQyMzowNDoyM1rOF8dlBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwMTozMTozNlrOF8gLNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk0MzQ5Mg==", "bodyText": "This busy loop could ultimately hold up threads on the server, for tables that may not be rebalancing too.. (Thread.yield() is just a hint).  Let's fail fast? Now that we have the standby routing, looping until RUNNING may not be necessary at all", "url": "https://github.com/confluentinc/ksql/pull/4908#discussion_r398943492", "createdAt": "2020-03-26T23:04:23Z", "author": {"login": "vinothchandar"}, "path": "ksqldb-streams/src/main/java/io/confluent/ksql/execution/streams/materialization/ks/KsStateStore.java", "diffHunk": "@@ -93,6 +95,7 @@ LogicalSchema schema() {\n   }\n \n   private void awaitRunning() {\n+    LOG.debug(\"Waiting for streams thread to be in RUNNING state\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c51d15ba7a1d896184a53e3a15e265f5f56489d1"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk4NjAzOQ==", "bodyText": "Done", "url": "https://github.com/confluentinc/ksql/pull/4908#discussion_r398986039", "createdAt": "2020-03-27T01:31:36Z", "author": {"login": "vpapavas"}, "path": "ksqldb-streams/src/main/java/io/confluent/ksql/execution/streams/materialization/ks/KsStateStore.java", "diffHunk": "@@ -93,6 +95,7 @@ LogicalSchema schema() {\n   }\n \n   private void awaitRunning() {\n+    LOG.debug(\"Waiting for streams thread to be in RUNNING state\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk0MzQ5Mg=="}, "originalCommit": {"oid": "c51d15ba7a1d896184a53e3a15e265f5f56489d1"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3Mzk0NjQzOnYy", "diffSide": "RIGHT", "path": "ksqldb-streams/src/test/java/io/confluent/ksql/execution/streams/materialization/ks/KsStateStoreTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwNTo1OToyNVrOF8kHSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwNTo1OToyNVrOF8kHSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTA1MDU3MA==", "bodyText": "fix test name?", "url": "https://github.com/confluentinc/ksql/pull/4908#discussion_r399050570", "createdAt": "2020-03-27T05:59:25Z", "author": {"login": "vinothchandar"}, "path": "ksqldb-streams/src/test/java/io/confluent/ksql/execution/streams/materialization/ks/KsStateStoreTest.java", "diffHunk": "@@ -96,43 +82,21 @@ public void shouldThrowNPEs() {\n     new NullPointerTester()\n         .setDefault(KafkaStreams.class, kafkaStreams)\n         .setDefault(LogicalSchema.class, SCHEMA)\n-        .setDefault(Supplier.class, clock)\n         .setDefault(KsqlConfig.class, ksqlConfig)\n         .testConstructors(KsStateStore.class, Visibility.PACKAGE);\n   }\n \n   @Test\n   public void shouldAwaitRunning() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12d925677fa0fdb1327497ca03529868ab27456f"}, "originalPosition": 79}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3Mzk0OTI4OnYy", "diffSide": "LEFT", "path": "ksqldb-streams/src/test/java/io/confluent/ksql/execution/streams/materialization/ks/KsStateStoreTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwNjowMToxMVrOF8kI7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwNjowMToxMVrOF8kI7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTA1MDk5MQ==", "bodyText": "can't understand this change fully", "url": "https://github.com/confluentinc/ksql/pull/4908#discussion_r399050991", "createdAt": "2020-03-27T06:01:11Z", "author": {"login": "vinothchandar"}, "path": "ksqldb-streams/src/test/java/io/confluent/ksql/execution/streams/materialization/ks/KsStateStoreTest.java", "diffHunk": "@@ -144,24 +108,20 @@ public void shouldThrowIfNotRunningAfterFailedToGetStore() {\n     when(kafkaStreams.store(any())).thenThrow(new IllegalStateException());\n \n     // When:\n-    expectedException.expect(NotRunningException.class);\n-    expectedException.expectMessage(\"The query was not in a running state. state: NOT_RUNNING\");\n+    expectedException.expect(MaterializationException.class);\n+    expectedException.expectMessage(\"State store currently unavailable: someStore\");\n \n     // When:\n     store.store(QueryableStoreTypes.sessionStore());\n   }\n \n   @Test\n   public void shouldGetStoreOnceRunning() {\n-    // Given:\n-    when(kafkaStreams.state()).thenReturn(State.RUNNING);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12d925677fa0fdb1327497ca03529868ab27456f"}, "originalPosition": 130}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3670, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}